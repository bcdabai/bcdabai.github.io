<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【STM32】| 01——常用外设 | USART - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【STM32】| 01——常用外设 | USART" />
<meta property="og:description" content="系列文章目录
【STM32】| 01——常用外设 | USART
失败了也挺可爱，成功了就超帅。 文章目录 前言1. 基础理论1.1 并行通信和串行通信1.2 同步通信和异步通信1.3 单工/半双工/全双工1.4 电平信号(RS232/TTL)和差分信号(RS485)1.5 端口(COM) 2. 串口理论2.1 串口物理连接2.1.1 多个单片机之间串口连接2.1.2 单片机和其他设备连接 2.2 串口数据信号2.3 MCU串口外设 3. 串口实践3.1 串口查询式收发3.1.1 Cubemx配置3.1.2 编写发送代码3.1.3 编写接收代码3.1.4 查询式收发的应用场景 3.2 串口中断式收发3.2.1 Cubemx配置3.2.2 使用串口中断式发送3.2.3 使用串口中断式接收3.2.4 中断式收发应用场景 3.3 串口DMA收发3.3.1 Cubemx配置3.3.2 串口DMA(DMA正常模式)接收/发送3.3.3 串口DMA(DMA循环模式)接收/发送 3.4 串口空闲中断接收不定长数据3.4.1 查询式(阻塞)接收 &#43; IDLE3.4.2 中断式接收 &#43; IDLE3.4.3 DMA接收 &#43; IDLE 3.5 环形缓冲区 前言 本文描述串口相关原理、配置及使用
如基础收发功能、串口&#43;DMA&#43;IDEL接收一帧数据、防止数据丢失加入环形缓冲区等
环境：stm32f103zet6 keil HAL库
1. 基础理论 串口能干吗 可以用来通信。串口通信是我们常用的设备通信方式。下面先从涉及的相关概念说起
1.1 并行通信和串行通信 一般通信方式可以分为两类
1、串行通信 如串口、SPI、IIC等
2、并行通信 如SRAM等" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/541c49ce757022f4f0647f3b999d7402/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-12T23:44:17+08:00" />
<meta property="article:modified_time" content="2024-01-12T23:44:17+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【STM32】| 01——常用外设 | USART</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><strong>系列文章目录</strong><br> <a href="https://blog.csdn.net/weixin_43822014/article/details/130740821?spm=1001.2014.3001.5501">【STM32】| 01——常用外设 | USART</a></p> 
<hr> 
<table><tbody><tr><td bgcolor="#D1EEEE"><font color="#FF1493" size="1" face="微软雅黑">失败了也挺可爱，成功了就超帅。</font> </td></tr></tbody></table> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_9" rel="nofollow">前言</a></li><li><a href="#1__13" rel="nofollow">1. 基础理论</a></li><li><ul><li><a href="#11__15" rel="nofollow">1.1 并行通信和串行通信</a></li><li><a href="#12__20" rel="nofollow">1.2 同步通信和异步通信</a></li><li><a href="#13__23" rel="nofollow">1.3 单工/半双工/全双工</a></li><li><a href="#14_RS232TTLRS485_28" rel="nofollow">1.4 电平信号(RS232/TTL)和差分信号(RS485)</a></li><li><a href="#15_COM_33" rel="nofollow">1.5 端口(COM)</a></li></ul> 
  </li><li><a href="#2__40" rel="nofollow">2. 串口理论</a></li><li><ul><li><a href="#21__43" rel="nofollow">2.1 串口物理连接</a></li><li><ul><li><a href="#211__47" rel="nofollow">2.1.1 多个单片机之间串口连接</a></li><li><a href="#212__50" rel="nofollow">2.1.2 单片机和其他设备连接</a></li></ul> 
   </li><li><a href="#22__69" rel="nofollow">2.2 串口数据信号</a></li><li><a href="#23_MCU_89" rel="nofollow">2.3 MCU串口外设</a></li></ul> 
  </li><li><a href="#3__108" rel="nofollow">3. 串口实践</a></li><li><ul><li><a href="#31__110" rel="nofollow">3.1 串口查询式收发</a></li><li><ul><li><a href="#311_Cubemx_112" rel="nofollow">3.1.1 Cubemx配置</a></li><li><a href="#312__120" rel="nofollow">3.1.2 编写发送代码</a></li><li><a href="#313__127" rel="nofollow">3.1.3 编写接收代码</a></li><li><a href="#314__130" rel="nofollow">3.1.4 查询式收发的应用场景</a></li></ul> 
   </li><li><a href="#32__149" rel="nofollow">3.2 串口中断式收发</a></li><li><ul><li><a href="#321_Cubemx_150" rel="nofollow">3.2.1 Cubemx配置</a></li><li><a href="#322__153" rel="nofollow">3.2.2 使用串口中断式发送</a></li><li><a href="#323__168" rel="nofollow">3.2.3 使用串口中断式接收</a></li><li><a href="#324__172" rel="nofollow">3.2.4 中断式收发应用场景</a></li></ul> 
   </li><li><a href="#33_DMA_176" rel="nofollow">3.3 串口DMA收发</a></li><li><ul><li><a href="#331_Cubemx_177" rel="nofollow">3.3.1 Cubemx配置</a></li><li><a href="#332_DMADMA_181" rel="nofollow">3.3.2 串口DMA(DMA正常模式)接收/发送</a></li><li><a href="#333_DMADMA_184" rel="nofollow">3.3.3 串口DMA(DMA循环模式)接收/发送</a></li></ul> 
   </li><li><a href="#34__195" rel="nofollow">3.4 串口空闲中断接收不定长数据</a></li><li><ul><li><a href="#341___IDLE_204" rel="nofollow">3.4.1 查询式(阻塞)接收 + IDLE</a></li><li><a href="#342___IDLE_208" rel="nofollow">3.4.2 中断式接收 + IDLE</a></li><li><a href="#343_DMA__IDLE_220" rel="nofollow">3.4.3 DMA接收 + IDLE</a></li></ul> 
   </li><li><a href="#35__230" rel="nofollow">3.5 环形缓冲区</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_9"></a>前言</h2> 
<p>本文描述串口相关原理、配置及使用<br> 如基础收发功能、串口+DMA+IDEL接收一帧数据、防止数据丢失加入环形缓冲区等<br> 环境：stm32f103zet6 keil HAL库</p> 
<h2><a id="1__13"></a>1. 基础理论</h2> 
<p>串口能干吗 可以用来通信。串口通信是我们常用的设备通信方式。下面先从涉及的相关概念说起</p> 
<h3><a id="11__15"></a>1.1 并行通信和串行通信</h3> 
<p>一般通信方式可以分为两类<br> 1、串行通信 如串口、SPI、IIC等<br> 2、并行通信 如SRAM等<br> <img src="https://images2.imgbox.com/3b/c4/NQLBWJHX_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="12__20"></a>1.2 同步通信和异步通信</h3> 
<p><img src="https://images2.imgbox.com/72/6b/jqZ0PZyE_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="13__23"></a>1.3 单工/半双工/全双工</h3> 
<p>根据数据传输方向可以分为这三种<br> <img src="https://images2.imgbox.com/57/16/PD2MpdAu_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="14_RS232TTLRS485_28"></a>1.4 电平信号(RS232/TTL)和差分信号(RS485)</h3> 
<p>他们都用于串口。TTL、RS232/485都算电器上标准 都是基于串口的 这里简单大概介绍详细的可自行看下哦<br> <img src="https://images2.imgbox.com/62/ed/4qyRpB3H_o.png" alt="在这里插入图片描述"><br> TTL应用：单片机连接电脑通过串口助手通信：单片机如果没板载 串口转TTL的芯片的话 就需要通过 单片机串口接 USB转TLL然后插到电脑上<br> 其他也需要相应的转换器或板载转换芯片</p> 
<h3><a id="15_COM_33"></a>1.5 端口(COM)</h3> 
<p>一般我们指物理接口 比如DB9<br> 当我们用串口助手 时需要选择 COM几<br> 因为电脑识别到串口设备后显示为端口 COM几<br> USB-TTL/RS232/485 都会识别为端口</p> 
<h2><a id="2__40"></a>2. 串口理论</h2> 
<p>串口通信是串行通信的一种。也是全双工异步通信。</p> 
<h3><a id="21__43"></a>2.1 串口物理连接</h3> 
<p>串口接线 中有最多 5根 TX/RX/RTS/CTS/GND<br> 一般我们只用 TX/RX/GND 3根<br> 其他两根用作流控：即通信过程中 握手</p> 
<h4><a id="211__47"></a>2.1.1 多个单片机之间串口连接</h4> 
<p>MCU通常带有串口功能 直接使用串口对应引脚连接就可以<br> <img src="https://images2.imgbox.com/38/9a/tjPSoY2G_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="212__50"></a>2.1.2 单片机和其他设备连接</h4> 
<p>串口和电脑连接<br> <mark>1、单片机板载USB转串口 如板载CH340芯片等</mark><br> <img src="https://images2.imgbox.com/3b/4e/GMeaJdbL_o.png" alt="在这里插入图片描述"></p> 
<p><mark>2、单片机通过外部USB转TTL 连接电脑</mark></p> 
<p><img src="https://images2.imgbox.com/f3/71/rU2vI0yZ_o.png" alt="在这里插入图片描述"><br> 单片机和传感器串口连接<br> <mark>1、单片机连接输出RS485信号的传感器</mark><br> <img src="https://images2.imgbox.com/4f/f6/NKm6mU67_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/bb/e1/Gw34fZwE_o.png" alt="在这里插入图片描述"><br> 以上列举了几种<br> 总结<br> 单片机（TTL）串口连接 RS232/485需要进行相应转换</p> 
<h3><a id="22__69"></a>2.2 串口数据信号</h3> 
<p>串口数据按照以下方式 每次传输一字节数据 数据按一位一位传输 从数据低位到高位。<br> 1个起始位+8个数据位+1个校验位(有/无)+停止位<br> <mark>下图是串口数据帧组成</mark></p> 
<p><img src="https://images2.imgbox.com/31/7f/Io66U2dv_o.png" alt="在这里插入图片描述"><br> 奇校验：数据位中1的个数为奇数 该位为1 反之为0<br> 如数据位 00101101 4个1偶数 奇校验该位为1 偶校验该位为0</p> 
<p><mark>用逻辑分析仪抓取串口实际波形</mark><br> <img src="https://images2.imgbox.com/8c/f0/jtJfKGQ4_o.png" alt="在这里插入图片描述"></p> 
<p>还有传输最重要的参数 那就是传输速度。<br> <mark>串口的传输速度称为波特率 只有在相同波特率下才可以通信</mark>。<br> <img src="https://images2.imgbox.com/e1/e2/k36IkGSr_o.png" alt="在这里插入图片描述"></p> 
<p>所以我们在使用串口时需要配置它的波特率 数据位停止位 校验位这几个参数。</p> 
<h3><a id="23_MCU_89"></a>2.3 MCU串口外设</h3> 
<p>不同厂商的都大同小异 我这里以stm32为例<br> 我们通过看查 STM32参考手册 去看串口详细描述即功能框图<br> 通过看查我们可以了解到 stm32 USART外设 通用同步异步串口收发器<br> 也就是说这个串口也可以同步用也可以异步全双工 它还有其他额外功能<br> 比如 支持IRDA SIR(串行红外)、智能卡模拟还有一些检测校验等。<br> 下面我们详细看下他的功能框图</p> 
<p><img src="https://images2.imgbox.com/42/ae/frV0Z59O_o.png" alt="在这里插入图片描述" width="400"></p> 
<p><img src="https://images2.imgbox.com/82/d8/ZeVBSpJa_o.png" alt="在这里插入图片描述"></p> 
<p>发送一个数据 先给到发送数据寄存器 通过移位寄存器一位一位送走<br> 接收一个数据从接收数据寄存器获取<br> 具体一些含义通过阅读相关寄存器描述可以很清楚了解这里就步多说了<br> 总的来说 我们使用这个串口外设时候有很多功能 比如发送完成会产生中断<br> 接收也可以 空闲检测等等这些在一些数据处理或应用中极其有用。<br> 多读参考手册 多翻寄存器 对底层了解清楚那么遇到一些问题就很容易解决</p> 
<h2><a id="3__108"></a>3. 串口实践</h2> 
<p>主要讲述 HAL库所以 使用Cubemx生成 记录如何配置以及使用起来</p> 
<h3><a id="31__110"></a>3.1 串口查询式收发</h3> 
<h4><a id="311_Cubemx_112"></a>3.1.1 Cubemx配置</h4> 
<p>新建好对应芯片工程后<br> <mark>首先配置时钟系统 使用HSE外部晶振 系统时钟设置为最高 STM32F103 72MHZ</mark><img src="https://images2.imgbox.com/3a/89/LE2gcjT4_o.gif" alt="请添加图片描述"></p> 
<p><mark>开始配置串口 我们用串口1</mark><br> 我们可以看到配置波特率 停止位 校验位 数据位选项 然后<br> 软件自动帮我们配置了串口1默认引脚<br> <img src="https://images2.imgbox.com/1c/89/TMeF9hon_o.gif" alt="请添加图片描述"></p> 
<h4><a id="312__120"></a>3.1.2 编写发送代码</h4> 
<p>可以通过 functions选项看查usart HAL库函数API<br> <img src="https://images2.imgbox.com/b7/55/hkWHp3BX_o.gif" alt="请添加图片描述"></p> 
<p><mark>每秒发送程序运行次数</mark><br> <img src="https://images2.imgbox.com/89/d4/USKuXLqL_o.gif" alt="请添加图片描述"></p> 
<h4><a id="313__127"></a>3.1.3 编写接收代码</h4> 
<p>可以看到虽然我有时一次发送了好几个字节 实际串口一直是一个一个接收发送的<br> <img src="https://images2.imgbox.com/2d/85/WEouNMye_o.gif" alt="请添加图片描述"></p> 
<h4><a id="314__130"></a>3.1.4 查询式收发的应用场景</h4> 
<p>查询式发送：发送数据/重定向printf (调用printf即可在串口助手显示相关内容 如输出调试信息等)<br> 查询式接收：我们一般不用这种方式接收数据 因为需要阻塞等待接收/不断检测接收 影响程序执行 占用资源<br> 查询式缺点：实时性差</p> 
<p>所以一般没特殊要求的话 发送采用查询式发送 接收采用中断式</p> 
<p><mark>重定向printf方法</mark><br> 1、使用 MicroLIB 库<br> 引入微型C标准库 头文件添加 stdio.h 重定义 fputc 即可<br> <img src="https://images2.imgbox.com/7a/c5/WXsyQFKo_o.png" alt="在这里插入图片描述" width="400"><br> 效果<br> <img src="https://images2.imgbox.com/41/ef/oRbfWvfb_o.gif" alt="请添加图片描述"></p> 
<p>2、不用微库 使用自定义kprintf 格式化输出<br> <img src="https://images2.imgbox.com/fc/c7/WXTyaUWu_o.gif" alt="请添加图片描述"></p> 
<h3><a id="32__149"></a>3.2 串口中断式收发</h3> 
<h4><a id="321_Cubemx_150"></a>3.2.1 Cubemx配置</h4> 
<p>只需要在串口配置界面 勾选串口全局中断就好<br> <img src="https://images2.imgbox.com/16/cd/gT9aeSi6_o.png" alt="在这里插入图片描述" width="300"></p> 
<h4><a id="322__153"></a>3.2.2 使用串口中断式发送</h4> 
<p>调用HAL库提供的 中断发送函数即可</p> 
<p><mark>1S发送一个字符1</mark><br> <img src="https://images2.imgbox.com/46/b7/rQuD97GX_o.png" alt="在这里插入图片描述"></p> 
<p><mark>分析下中断发送执行流程</mark><br> 调用串口中断发送函数 才会使能 发送中断 触发中断后(第一次进入串口中断) 它先失能串口发送中断 使能发送完成中断 再进一次串口中断 执行发送完成回调函数<br> <img src="https://images2.imgbox.com/d5/c0/4Mt7S7UJ_o.png" alt="请添加图片描述"><br> debug验证<br> 观察右侧串口SR C1寄存器 发送相关位 TXE TC TXEIE TCIE<br> 变化<br> <img src="https://images2.imgbox.com/f7/99/WZb4afQP_o.gif" alt="在这里插入图片描述"></p> 
<h4><a id="323__168"></a>3.2.3 使用串口中断式接收</h4> 
<p><img src="https://images2.imgbox.com/ad/bd/o6pml1T1_o.png" alt="在这里插入图片描述" width="400"><br> 接收流程就不分析了 和发送一样只不过 是接收中断</p> 
<h4><a id="324__172"></a>3.2.4 中断式收发应用场景</h4> 
<p>接收数据需要实时的所以 一般我们用中断接收 接收数据可满足正常接收数据需求<br> 如果使用中断发送 发送一个数据也频繁进入中断影响系统开销</p> 
<h3><a id="33_DMA_176"></a>3.3 串口DMA收发</h3> 
<h4><a id="331_Cubemx_177"></a>3.3.1 Cubemx配置</h4> 
<p><mark>DMA TX/RX 配置正常模式</mark><br> DMA接收发送需要执行完一次(执行完会清除相应位)调用一次<br> <img src="https://images2.imgbox.com/2a/91/H5xiyP1N_o.png" alt="在这里插入图片描述" width="400"></p> 
<h4><a id="332_DMADMA_181"></a>3.3.2 串口DMA(DMA正常模式)接收/发送</h4> 
<p><img src="https://images2.imgbox.com/69/c8/nXyw0Nzs_o.gif" alt="请添加图片描述"></p> 
<h4><a id="333_DMADMA_184"></a>3.3.3 串口DMA(DMA循环模式)接收/发送</h4> 
<p>这里只用RX DMA通道配置为循环 (发送配置为循环会一直发送 没接收也会一直发送)<br> <mark>DMA RX配置为循环模式</mark><br> 这样只需调用一次 DMA接收 就可以一直触发dma接收<br> <img src="https://images2.imgbox.com/ca/0e/soMw2lZO_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/ec/27/B6QbtKIB_o.gif" alt="请添加图片描述"></p> 
<h3><a id="34__195"></a>3.4 串口空闲中断接收不定长数据</h3> 
<p>前面介绍的几种接收都是 接收固定长度 当我们数据帧不确定长度时候 就需要通过空闲中断去实现接收不定长数据了(一帧一帧数据肯定有间隔的 使能IDLE即可检测串口空闲 从而实现接受不定长数据)</p> 
<p>先看看寄存器 IDLE位描述<br> <img src="https://images2.imgbox.com/8b/31/ZhwMLEHX_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/c1/27/6YkYBTQJ_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="341___IDLE_204"></a>3.4.1 查询式(阻塞)接收 + IDLE</h4> 
<p><img src="https://images2.imgbox.com/ee/c2/fN0UoNOe_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/97/28/XO1cOTtD_o.gif" alt="请添加图片描述"></p> 
<h4><a id="342___IDLE_208"></a>3.4.2 中断式接收 + IDLE</h4> 
<p><img src="https://images2.imgbox.com/c5/31/tFXpfzrv_o.png" alt="在这里插入图片描述"><br> 接收到数据会调用这个函数<br> <img src="https://images2.imgbox.com/7f/90/Oy1QyTQi_o.png" alt="在这里插入图片描述"><br> 运行效果<br> <img src="https://images2.imgbox.com/a3/20/KX1h6zPP_o.gif" alt="请添加图片描述"><br> 程序运行流程(通过debug演示程序如何调用执行的)<br> <img src="https://images2.imgbox.com/47/a5/dbPV6yiA_o.png" alt="在这里插入图片描述" width="500"></p> 
<p><img src="https://images2.imgbox.com/1f/f4/Eg187eH3_o.gif" alt="在这里插入图片描述"></p> 
<h4><a id="343_DMA__IDLE_220"></a>3.4.3 DMA接收 + IDLE</h4> 
<p><img src="https://images2.imgbox.com/a8/d6/EVcKLbR1_o.png" alt="在这里插入图片描述"><br> 串口DMA IDLE和 中断IDLE 中断调用流程类似 不同在于 在串口中断处理函数里 做了DMA相关操作<br> <img src="https://images2.imgbox.com/5c/08/7OL0W72i_o.png" alt="在这里插入图片描述" width="400"></p> 
<p>运行效果<br> 这里DMA RX配置为正常模式 所以需要在接收回调里 再次调用 准备下次DMA接收(如果DMA配置为循环模式 只需调用一次即可)<br> <img src="https://images2.imgbox.com/1e/20/1OxerzMv_o.gif" alt="请添加图片描述"></p> 
<h3><a id="35__230"></a>3.5 环形缓冲区</h3>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ee7bf9f5b2cfa6a63c8ab50a64095828/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">JavaWeb-HTTP</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7c4ea43af34afd8542aa0163c7a916c2/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">DNS解析和主从复制</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>