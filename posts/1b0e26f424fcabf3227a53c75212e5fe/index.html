<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>零基础熟悉mmdetection3d数据提取、模型搭建过程 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="零基础熟悉mmdetection3d数据提取、模型搭建过程" />
<meta property="og:description" content="本图文从介绍配置文件开始，逐步构建一个新的配置文件，并依次构建相关模型，最终使用一条点云数据简单走了一下处理流程关于mmdetection3d的安装，参考官方文档安装 — MMDetection3D 1.0.0rc4 文档 1、读取配置文件 1.1 mmdetection3d配置文件的组成 官方文档:教程 1: 学习配置文件 — MMDetection3D 1.0.0rc4 文档
在mmdetection3d中，主要思想是通过继承默认配置来实现自定义模型，当然，也可以将模型的所有配置写在一个文件里，按需使用。
配置文件存放于mmdetection3d/config目录下，其中**_base_目录为mmdetection3d自带的基础配置，即原始配置，从_base_**目录的组成来看，mmdetection3d将配置文件分为四种，分别是：数据集 (dataset)，模型 (model)，训练策略 (schedule) 和运行时的默认设置 (default runtime)
下面基于一个配置文件的部分内容，解释一下该怎么看
# configs/centerpoint/centerpoint_01voxel_second_secfpn_4x8_cyclic_20e_nus.py _base_ = [ &#39;../_base_/datasets/nus-3d.py&#39;, &#39;../_base_/models/centerpoint_01voxel_second_secfpn_nus.py&#39;, # 继承了这个模型的基础文件 &#39;../_base_/schedules/cyclic_20e.py&#39;, &#39;../_base_/default_runtime.py&#39; ] model = dict( pts_voxel_layer=dict(point_cloud_range=point_cloud_range), pts_bbox_head=dict(bbox_coder=dict(pc_range=point_cloud_range[:2])), # model training and testing settings train_cfg=dict(pts=dict(point_cloud_range=point_cloud_range)), test_cfg=dict(pts=dict(pc_range=point_cloud_range[:2]))) 可以看出，在centerpoint_01voxel_second_secfpn_4x8_cyclic_20e_nus.py这个文件中，model部分只有一小段内容，这是因为继承了centerpoint_01voxel_second_secfpn_nus.py，只是在继承文件的基础上来修改或添加某些特定字段
为了方便说明，来一份简化版的配置文件
# configs/_base_/models/centerpoint_01voxel_second_secfpn_nus.py model = dict( type=&#39;CenterPoint&#39;, pts_voxel_layer=dict( max_num_points=10, voxel_size=voxel_size, max_voxels=(90000, 120000)), pts_voxel_encoder=dict(type=&#39;HardSimpleVFE&#39;, num_features=5), pts_middle_encoder=dict(), pts_backbone=dict(), pts_neck=dict(), pts_bbox_head=dict(), # model training and testing settings train_cfg=dict(), test_cfg=dict()) 为了查看具体网络是怎么实现的，我们首先从model最开始出发，根据配置文件，第一个字段为type，上述例子中使用了CenterPoint，我们需要在mmdetection3d/mmdet3d/models/detectors/__init__." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/1b0e26f424fcabf3227a53c75212e5fe/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-01T16:29:48+08:00" />
<meta property="article:modified_time" content="2023-03-01T16:29:48+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">零基础熟悉mmdetection3d数据提取、模型搭建过程</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <ul><li>本图文从介绍配置文件开始，逐步构建一个新的配置文件，并依次构建相关模型，最终使用一条点云数据简单走了一下处理流程</li><li>关于mmdetection3d的安装，参考官方文档<a href="https://mmdetection3d.readthedocs.io/zh_CN/latest/getting_started.html#id2" rel="nofollow">安装 — MMDetection3D 1.0.0rc4 文档</a></li></ul> 
</blockquote> 
<h3><a id="1_3"></a>1、读取配置文件</h3> 
<h4><a id="11_mmdetection3d_5"></a>1.1 mmdetection3d配置文件的组成</h4> 
<p>官方文档:<a href="https://mmdetection3d.readthedocs.io/zh_CN/latest/tutorials/config.html" rel="nofollow">教程 1: 学习配置文件 — MMDetection3D 1.0.0rc4 文档</a></p> 
<p>在mmdetection3d中，主要思想是通过继承默认配置来实现自定义模型，当然，也可以将模型的所有配置写在一个文件里，按需使用。</p> 
<p>配置文件存放于<strong>mmdetection3d/config</strong>目录下，其中**_base_<strong>目录为mmdetection3d自带的基础配置，即原始配置，从</strong>_base_**目录的组成来看，mmdetection3d将配置文件分为四种，分别是：数据集 (dataset)，模型 (model)，训练策略 (schedule) 和运行时的默认设置 (default runtime)</p> 
<p>下面基于一个配置文件的部分内容，解释一下该怎么看</p> 
<pre><code class="prism language-python"><span class="token comment"># configs/centerpoint/centerpoint_01voxel_second_secfpn_4x8_cyclic_20e_nus.py</span>
_base_ <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'../_base_/datasets/nus-3d.py'</span><span class="token punctuation">,</span>
    <span class="token string">'../_base_/models/centerpoint_01voxel_second_secfpn_nus.py'</span><span class="token punctuation">,</span> <span class="token comment"># 继承了这个模型的基础文件</span>
    <span class="token string">'../_base_/schedules/cyclic_20e.py'</span><span class="token punctuation">,</span> <span class="token string">'../_base_/default_runtime.py'</span>
<span class="token punctuation">]</span>
model <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>
    pts_voxel_layer<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>point_cloud_range<span class="token operator">=</span>point_cloud_range<span class="token punctuation">)</span><span class="token punctuation">,</span>
    pts_bbox_head<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>bbox_coder<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>pc_range<span class="token operator">=</span>point_cloud_range<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment"># model training and testing settings</span>
    train_cfg<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>pts<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>point_cloud_range<span class="token operator">=</span>point_cloud_range<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    test_cfg<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>pts<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>pc_range<span class="token operator">=</span>point_cloud_range<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>可以看出，在centerpoint_01voxel_second_secfpn_4x8_cyclic_20e_nus.py这个文件中，model部分只有一小段内容，这是因为继承了centerpoint_01voxel_second_secfpn_nus.py，只是在继承文件的基础上来修改或添加某些特定字段</p> 
<p>为了方便说明，来一份简化版的配置文件</p> 
<pre><code class="prism language-python"><span class="token comment"># configs/_base_/models/centerpoint_01voxel_second_secfpn_nus.py</span>
model <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>
    <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'CenterPoint'</span><span class="token punctuation">,</span>
    pts_voxel_layer<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span> 
        max_num_points<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> voxel_size<span class="token operator">=</span>voxel_size<span class="token punctuation">,</span> max_voxels<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">90000</span><span class="token punctuation">,</span> <span class="token number">120000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    pts_voxel_encoder<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'HardSimpleVFE'</span><span class="token punctuation">,</span> num_features<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    pts_middle_encoder<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    pts_backbone<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    pts_neck<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    pts_bbox_head<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment"># model training and testing settings</span>
    train_cfg<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    test_cfg<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>为了查看具体网络是怎么实现的，我们首先从model最开始出发，根据配置文件，第一个字段为type，上述例子中使用了CenterPoint，我们需要在<strong>mmdetection3d/mmdet3d/models/detectors/__init__.py</strong>中，找到CenterPoint，看一下是从哪里引入的，如下图所示，这样一来，我们找到了实现网络的具体位置，路径为:<strong>mmdetection3d/mmdet3d/models/detectors/centerpoint.py</strong></p> 
<p><img src="https://images2.imgbox.com/8f/c6/5TzQZNaC_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/44/5d/Jh38WTzJ_o.png" alt="在这里插入图片描述"></p> 
<p>再往下走，有一句：<code>python pts_voxel_layer=dict( max_num_points=10, voxel_size=voxel_size, max_voxels=(90000, 120000)), </code></p> 
<p>我们在<strong>mmdetection3d/mmdet3d/models/detectors/centerpoint.py</strong>中的__init__方法中，找到对应初始化字段<strong>pts_voxel_layer</strong></p> 
<p><img src="https://images2.imgbox.com/f7/2c/SWKPOsKu_o.png" alt="在这里插入图片描述"></p> 
<p>但是我们在此发现，这里并没有使用这个字段，这是因为CenterPoint类继承了<strong>MVXTwoStageDetector</strong>类，我们顺藤摸瓜，查看<strong>MVXTwoStageDetector</strong>类，发现这个类使用了<strong>pts_voxel_layer</strong>字段，并且给出了使用过程。<code>Voxelization(**pts_voxel_layer)</code>为封装好的一个体素化函数，它返回一组能表示体素的参数，这里我们不关心具体实现。另外，根据上图可以看出，init方法里所有的字段与配置文件中的字段是对应着顺下来的，也就是说，我们可以从centerpoint类里顺藤摸瓜，找到所有配置的具体实现</p> 
<p><img src="https://images2.imgbox.com/9e/63/PEHOvz1i_o.png" alt="在这里插入图片描述"></p> 
<p>至此，第一行分析完毕，再往下走，是一句<code>pts_voxel_encoder=dict(type='HardSimpleVFE', num_features=5)</code>，分析方法与上面相同。</p> 
<h4><a id="12_base_77"></a>1.2 使用base配置文件构建自己的配置文件</h4> 
<p>这部分我们继承基础配置文件，构建一个简单的配置文件，以便接下来使用</p> 
<ol><li> <p>首先，我们在configs目录下创建一个文件夹，用于保存自己的配置文件，并新建一个my_config.py文件</p> </li><li> <p>在新建的配置文件中，写入以下内容</p> <pre><code class="prism language-python">_base_ <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'../_base_/datasets/nus-3d-mini.py'</span><span class="token punctuation">,</span> <span class="token comment"># 这里我继承了基础文件中的nus-3d.py构建了一个mini版本，主要就是修改了一下数据集路径</span>
    <span class="token string">'../_base_/schedules/schedule_2x.py'</span><span class="token punctuation">,</span>
    <span class="token string">'../_base_/default_runtime.py'</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
voxel_size <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">]</span>
norm_cfg <span class="token operator">=</span> <span class="token boolean">None</span>
DOUBLE_FLIP <span class="token operator">=</span> <span class="token boolean">False</span>
<span class="token comment"># 为了简单演示，这里只实现了体素构造层和编码层</span>
model <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>
    <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"MY_MODEL"</span><span class="token punctuation">,</span>
    voxel_layer<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
        max_num_points<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span>
        point_cloud_range<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">39.68</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">69.12</span><span class="token punctuation">,</span> <span class="token number">39.68</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        voxel_size<span class="token operator">=</span>voxel_size<span class="token punctuation">,</span>
        max_voxels<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">16000</span><span class="token punctuation">,</span> <span class="token number">40000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    voxel_encoder<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'VoxelFeatureExtractorV3'</span><span class="token punctuation">,</span>
        num_input_features<span class="token operator">=</span><span class="token number">4</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    train_cfg<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    test_cfg<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
data <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>
    samples_per_gpu<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
    workers_per_gpu<span class="token operator">=</span><span class="token number">4</span>
<span class="token punctuation">)</span>
</code></pre> </li></ol> 
<h4><a id="13__116"></a>1.3 根据配置文件搭建网络</h4> 
<p>接下来要做的，是根据我们配置文件中的model部分，开始搭建网络，具体步骤如下：</p> 
<ul><li> <p>在<strong>mmdet3d/models/detectors</strong>目录下，创建一个py文件，这里取名为my_model.py</p> </li><li> <p>构造一个类，<strong>类名要和配置文件中的type一致，当然也可以在注册的时候用import … as …来替换</strong>:</p> <pre><code class="prism language-python"><span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span>builder <span class="token keyword">import</span> DETECTORS <span class="token comment"># 引入构造器</span>

<span class="token decorator annotation punctuation">@DETECTORS<span class="token punctuation">.</span>register_module</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 注册，这一句必须要有</span>
<span class="token keyword">class</span> <span class="token class-name">MY_MODEL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>
</code></pre> </li><li> <p><strong>在mmdet3d/models/detectors/_<em>init</em>_.py中注册</strong>：</p> <p><img src="https://images2.imgbox.com/ad/d1/L1nHPRjB_o.png" alt="在这里插入图片描述"></p> </li><li> <p>在此例中，便于理解，我们就不继承任何文件了，仅写出初始化方法</p> </li><li> <p>接下来要做的，是要在init方法中定义相关参数并给出相应实现</p> <pre><code class="prism language-python"><span class="token keyword">from</span> mmcv<span class="token punctuation">.</span>ops <span class="token keyword">import</span> Voxelization <span class="token comment"># 引入mmcv中的体素化方法</span>
<span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">import</span> builder	<span class="token comment"># 引入构造器</span>
<span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span>builder <span class="token keyword">import</span> DETECTORS

<span class="token decorator annotation punctuation">@DETECTORS<span class="token punctuation">.</span>register_module</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">my_model</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> voxel_layer<span class="token punctuation">,</span> voxel_encoder<span class="token punctuation">,</span> train_cfg<span class="token punctuation">,</span> test_cfg<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>voxel_layer <span class="token operator">=</span> Voxelization<span class="token punctuation">(</span><span class="token operator">**</span>voxel_layer<span class="token punctuation">)</span> <span class="token comment"># 这一层是mmcv自带的，在3.4中会再介绍一下</span>
        self<span class="token punctuation">.</span>voxel_encoder <span class="token operator">=</span> builder<span class="token punctuation">.</span>build_voxel_encoder<span class="token punctuation">(</span>voxel_encoder<span class="token punctuation">)</span> <span class="token comment"># 这里表示这个层是需要我们自己构造的</span>

</code></pre> </li><li> <p>再一步，是实现我们的voxel_encoder层，我们在<strong>mmdet3d/models/voxel_encoders</strong>目录下，新建一个文件也好，直接写在现有文件里也行，这里我写在了voxel_encoder.py文件下</p> <pre><code class="prism language-python"><span class="token decorator annotation punctuation">@VOXEL_ENCODERS<span class="token punctuation">.</span>register_module</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 注册为体素编码层</span>
<span class="token keyword">class</span> <span class="token class-name">VoxelFeatureExtractorV3</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>
            self<span class="token punctuation">,</span> num_input_features<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> norm_cfg<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"VoxelFeatureExtractorV3"</span>
    <span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>VoxelFeatureExtractorV3<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name
        self<span class="token punctuation">.</span>num_input_features <span class="token operator">=</span> num_input_features

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> features<span class="token punctuation">,</span> num_voxels<span class="token punctuation">,</span> coors<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        	features: 输入的体素
        	num_voxels: 体素数目
        """</span>
        points_mean <span class="token operator">=</span> features<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span> self<span class="token punctuation">.</span>num_input_features<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>
            dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> keepdim<span class="token operator">=</span><span class="token boolean">False</span>
        <span class="token punctuation">)</span> <span class="token operator">/</span> num_voxels<span class="token punctuation">.</span>type_as<span class="token punctuation">(</span>features<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> points_mean<span class="token punctuation">.</span>contiguous<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> </li><li> <p>再一步，是在<strong>mmdet3d/models/voxel_encoders/__init__.py</strong>文件中，引入写好的VoxelFeatureExtractorV3，这样，我们就能在配置文件中，使用<code>voxel_encoder=dict(type='VoxelFeatureExtractorV3', num_input_features=4)</code>来调用我们的体素编码模块了<br> <img src="https://images2.imgbox.com/fe/b2/MF2Tzjit_o.png" alt="在这里插入图片描述"></p> </li><li> <p>关于根据配置文件的model部分搭建网络就写到这里，有时间的话我会补充更多细节</p> </li></ul> 
<h3><a id="2_188"></a>2、构建模型</h3> 
<blockquote> 
 <p>此部分，我们使用jupyter notebook逐步、分解的从数据抓取开始，演示一下数据在我们搭建的网络中的运行流程</p> 
</blockquote> 
<h4><a id="21__192"></a>2.1 读取配置文件</h4> 
<p>在真正的训练过程中，是通过传入的参数，根据配置文件路径导入整个参数的，相关代码位于tools/train.py。这里为简便期间，我们直接使用路径读取配置文件</p> 
<pre><code class="prism language-python"><span class="token comment"># 读取配置文件</span>
<span class="token keyword">from</span> mmcv <span class="token keyword">import</span> Config

config_file <span class="token operator">=</span> <span class="token string">"/home/wistful/work/mmdetection3d/configs/my_config/my_config.py"</span>
cfg <span class="token operator">=</span> Config<span class="token punctuation">.</span>fromfile<span class="token punctuation">(</span>config_file<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"cfg type:"</span><span class="token punctuation">,</span><span class="token builtin">type</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"cfg.model type:"</span><span class="token punctuation">,</span><span class="token builtin">type</span><span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>model<span class="token punctuation">)</span><span class="token punctuation">)</span>
cfg<span class="token punctuation">.</span>model  <span class="token comment"># 打印模型部分</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/69/09/ed4sEXcY_o.png" alt="image-20230301104254130"></p> 
<p>可以看出，打印出来的模型结构，与我们配置文件中的一样。其中，cfg和cfg.model等等的数据类型在此就不介绍了</p> 
<h4><a id="22__212"></a>2.2 读取数据</h4> 
<pre><code class="prism language-python"><span class="token comment"># 取数据</span>
<span class="token keyword">from</span> mmdet3d<span class="token punctuation">.</span>datasets <span class="token keyword">import</span> build_dataset

datasets <span class="token operator">=</span> <span class="token punctuation">[</span>build_dataset<span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>data<span class="token punctuation">.</span>train<span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"datastes type:"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token punctuation">(</span>datasets<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"datastes[0] type"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token punctuation">(</span>datasets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"datastes[0][0] type"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token punctuation">(</span>datasets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

datasets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/c6/3b/Jr9VL45V_o.png" alt="在这里插入图片描述"></p> 
<p>这里，就不再解释相关内容了，只需要明白datasets为一个长度1的列表，datasets[0]为一个nuscenes数据集类型，datasets[0][i]是nuscenes数据集的所有内容，每一项包含了四部分内容：‘img_metas’, ‘points’, ‘gt_bboxes_3d’, ‘gt_labels_3d’</p> 
<p>实际上，在真正训练或测试过程中，还需要一个data_loader迭代器，方便我们去<strong>多线程</strong>地读取数据，并且可以实现<strong>batch</strong>以及<strong>shuffle</strong>的读取等，mmdet已经帮我们实现了，这里我们由于只需要一条数据模拟一下流程，就不构造data_loader了</p> 
<h4><a id="23__234"></a>2.3 构造模型</h4> 
<pre><code class="prism language-python"><span class="token comment"># 构建模型</span>
<span class="token keyword">from</span> mmdet3d<span class="token punctuation">.</span>models <span class="token keyword">import</span> build_model
model <span class="token operator">=</span> build_model<span class="token punctuation">(</span>
    cfg<span class="token punctuation">.</span>model<span class="token punctuation">,</span>
    train_cfg<span class="token operator">=</span>cfg<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'train_cfg'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    test_cfg<span class="token operator">=</span>cfg<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'test_cfg'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
model
</code></pre> 
<p><img src="https://images2.imgbox.com/00/4c/1WJ6kgHj_o.png" alt="在这里插入dsda 图片描述"></p> 
<h4><a id="3_249"></a>3、运行流程</h4> 
<h4><a id="31_voxel_layer___250"></a>3.1 voxel_layer：点云 -&gt; 体素</h4> 
<pre><code class="prism language-python"><span class="token comment"># 示例文件配置中，第一步是voxel_layer层，将点云编码为体素</span>

voxel_layer <span class="token operator">=</span> model<span class="token punctuation">.</span>voxel_layer
<span class="token comment"># 取点云数据</span>
points <span class="token operator">=</span> datasets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'points'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data
<span class="token comment"># 将点云数据送入 voxel_layer</span>
voxels_out<span class="token punctuation">,</span> coors_out<span class="token punctuation">,</span> num_points_per_voxel_out <span class="token operator">=</span> voxel_layer<span class="token punctuation">(</span>points<span class="token punctuation">)</span>
</code></pre> 
<p>上述代码中，<code>voxel_layer(points)</code>执行的是<code>self.voxel_layer = Voxelization(**voxel_layer)</code>，Voxelization的输入输出大家可以去具体看一下</p> 
<p>我们再使用<code>voxel_layer.parameters</code>打印一下参数，得到下面输出：</p> 
<p><img src="https://images2.imgbox.com/0f/4a/QvVGWhbi_o.png" alt="在这里插入图片描述"></p> 
<p>现在再来回想一下我们自定义的配置文件，这里再放一下：</p> 
<pre><code class="prism language-python">voxel_size <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">]</span>
model <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>
    <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"MY_MODEL"</span><span class="token punctuation">,</span>
    voxel_layer<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
        max_num_points<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span>
        point_cloud_range<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">39.68</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">69.12</span><span class="token punctuation">,</span> <span class="token number">39.68</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        voxel_size<span class="token operator">=</span>voxel_size<span class="token punctuation">,</span>
        max_voxels<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">16000</span><span class="token punctuation">,</span> <span class="token number">40000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    voxel_encoder<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'VoxelFeatureExtractorV3'</span><span class="token punctuation">,</span>
        num_input_features<span class="token operator">=</span><span class="token number">4</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    train_cfg<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    test_cfg<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>可以看出，voxel_layer层传入的参数是我们配置文件中的内容，根据前面提到过的Voxelization的输入输出，可以看到，forward部分只缺一个points input，即点云。在本节刚开始的代码块中，<code>voxels_out, coors_out, num_points_per_voxel_out = voxel_layer(points)</code>执行的便是将点云转换为体素操作，我们输出前后形状来看一下：</p> 
<p><img src="https://images2.imgbox.com/76/7b/GEBdsGLs_o.png" alt="在这里插入图片描述"></p> 
<p>即将自定范围内的点云，按照自定体素大小[0.1,0.1,0.1]，每块体素最多保留32个点，最终将32242个点，转换为了6051个体素，每个体素包含的点不一样，但都记录下来了。</p> 
<h4><a id="32_voxel_encoder_296"></a>3.2 voxel_encoder：体素编码</h4> 
<p>这一层，主要是将上一层(voxel_layer)的输出进行encoder，往上翻到1.3，我们给出了相应实现，这里实现较为简单，即求每个体素中的平均点。我们现在这里记一下实现中的forward函数：<code>def forward(self, features, num_voxels, coors=None)</code></p> 
<p>我们先打印一下这一层的参数</p> 
<p><img src="https://images2.imgbox.com/72/59/Hv2HGqay_o.png" alt="在这里插入图片描述"></p> 
<p>发现没有输出，这是因为我们没有定义相关方法，我们在VoxelFeatureExtractorV3类中加一个方法：</p> 
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        s <span class="token operator">=</span> self<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__ <span class="token operator">+</span> <span class="token string">'('</span>
        s <span class="token operator">+=</span> <span class="token string">'num_input_features='</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>num_input_features<span class="token punctuation">)</span>
        s <span class="token operator">+=</span> <span class="token string">')'</span>
        <span class="token keyword">return</span> s
</code></pre> 
<p>再次执行就有输出了，参数也是与配置文件相同。下面代码将上一层的输出传递到这一层</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch

voxel_encoder <span class="token operator">=</span> model<span class="token punctuation">.</span>voxel_encoder
<span class="token keyword">print</span><span class="token punctuation">(</span>voxel_encoder<span class="token punctuation">.</span>parameters<span class="token punctuation">)</span>
voxel_encoder_inputs <span class="token operator">=</span> voxels_out  <span class="token comment"># 将上一层的输出作为输入</span>
num_voxels <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>voxels_out<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 这里只用一条数据作为演示，所以要转一下tensor</span>
voxel_encoder_result <span class="token operator">=</span> voxel_encoder<span class="token punctuation">(</span>voxel_encoder_inputs<span class="token punctuation">,</span> num_voxels<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"voxel_encoder output shape:"</span><span class="token punctuation">,</span> voxel_encoder_result<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/89/15/QjMFa0w8_o.png" alt="在这里插入图片描述"></p> 
<p>我们的配置文件和网络只给出了两个基础层的定义和实现，剩下的几层（neck、backbone…）都大同小异，都是这么个流程，完整的流程还会有损失函数的计算、反向更新等等，这一步是写在模型的forward里，此篇就不再详解了</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/118a043b73be866fe2ee833c1e5debfb/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【Flutter入门到进阶】Flutter基础篇---介绍与环境</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e1996f8e46d4250acbb87ef1d67045bb/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">jetpack compose系列（入门基础案例讲解）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>