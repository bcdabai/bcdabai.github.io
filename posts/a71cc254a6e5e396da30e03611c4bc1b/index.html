<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>RabbitMQ（九）死信队列 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="RabbitMQ（九）死信队列" />
<meta property="og:description" content="目录 一、简介1.1 定义1.2 何时进入死信队列？1.3 死信消息的变化1.4 死信队列的应用场景1.5 死信消息的生命周期 二、代码实现2.1 死信队列的配置步骤2.2 配置类2.3 配置文件2.4 生产者2.5 业务消费者2.6 死信消费者2.7 测试结果 三、总结四、补充4.1 启动报错 inequivalent arg &#39;x-dead-letter-exchange&#39; RabbitMQ 是流行的开源消息队列中间件，使用 erlang 语言开发，由于其社区活跃度高，维护更新较快，深得很多企业的喜爱。
一、简介 1.1 定义 死信队列（Dead Letter Queue，简称 DLX）是 RabbitMQ 中一种特殊的队列，用于处理无法正常被消费者消费的消息。当消息在原始队列中因为 达到最大重试次数、过期、或者 满足特定条件 时，可以 将这些消息重新路由到一个预定义的死信队列中 进行进一步处理或记录。
1.2 何时进入死信队列？ 当发生以下情况，业务队列中的消息会进入死信队列：
消息被否定确认：使用 channel.basicNack 或 channel.basicReject，并且此时 requeue 属性被设置为 false。消息过期：消息在队列的存活时间超过设置的 TTL 时间。消息溢出：队列中的消息数量已经超过最大队列长度。 当发生以上三种情况后，该消息将成为 死信。死信消息会被 RabbitMQ 进行特殊处理：
如果配置了死信队列，那么该消息将会被丢进死信队列中；如果没有配置，则该消息将会被丢弃。 1.3 死信消息的变化 那么 死信 被丢到死信队列后，会发生什么变化呢？
如果队列配置了 x-dead-letter-routing-key 的话，“死信” 的路由键会被替换成该参数对应的值。如果没有配置，则保留该消息原有的路由键。 举个例子：
原有队列的路由键是 RoutingKey1，有以下两种情况：
如果配置队列的 x-dead-letter-routing-key 参数值为 RoutingKey2，则该消息成为 “死信” 后，会将路由键更改为 RoutingKey2，从而进入死信交换机中的死信队列。如果没有配置 x-dead-letter-routing-key 参数，则该消息成为 “死信” 后，路由键不会更改，也不会进入死信队列。 当配置了 x-dead-letter-routing-key 参数后，消息成为 “死信” 后，会在消息的 Header 中添加很多奇奇怪怪的字段，我们可以在死信队列的消费端通过以下方式进行打印：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/a71cc254a6e5e396da30e03611c4bc1b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-09T11:31:59+08:00" />
<meta property="article:modified_time" content="2024-01-09T11:31:59+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">RabbitMQ（九）死信队列</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><ul><li><a href="#_6" rel="nofollow">一、简介</a></li><li><ul><li><a href="#11__8" rel="nofollow">1.1 定义</a></li><li><a href="#12__12" rel="nofollow">1.2 何时进入死信队列？</a></li><li><a href="#13__25" rel="nofollow">1.3 死信消息的变化</a></li><li><a href="#14__68" rel="nofollow">1.4 死信队列的应用场景</a></li><li><a href="#15__74" rel="nofollow">1.5 死信消息的生命周期</a></li></ul> 
   </li><li><a href="#_86" rel="nofollow">二、代码实现</a></li><li><ul><li><a href="#21__88" rel="nofollow">2.1 死信队列的配置步骤</a></li><li><a href="#22__109" rel="nofollow">2.2 配置类</a></li><li><a href="#23__225" rel="nofollow">2.3 配置文件</a></li><li><a href="#24__265" rel="nofollow">2.4 生产者</a></li><li><a href="#25__304" rel="nofollow">2.5 业务消费者</a></li><li><a href="#26__353" rel="nofollow">2.6 死信消费者</a></li><li><a href="#27__394" rel="nofollow">2.7 测试结果</a></li></ul> 
   </li><li><a href="#_422" rel="nofollow">三、总结</a></li><li><a href="#_433" rel="nofollow">四、补充</a></li><li><ul><li><a href="#41__inequivalent_arg_xdeadletterexchange_435" rel="nofollow">4.1 启动报错 inequivalent arg 'x-dead-letter-exchange'</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<p><img src="https://images2.imgbox.com/fc/4d/EYkS0UBK_o.png" alt="在这里插入图片描述"></p> 
<p><code>RabbitMQ</code> 是流行的开源消息队列中间件，使用 erlang 语言开发，由于其社区活跃度高，维护更新较快，深得很多企业的喜爱。</p> 
<h3><a id="_6"></a>一、简介</h3> 
<h4><a id="11__8"></a>1.1 定义</h4> 
<p><code>死信队列</code>（Dead Letter Queue，简称 DLX）是 RabbitMQ 中一种特殊的队列，<strong>用于处理无法正常被消费者消费的消息</strong>。当消息在原始队列中因为 <strong>达到最大重试次数</strong>、<strong>过期</strong>、或者 <strong>满足特定条件</strong> 时，可以 <strong>将这些消息重新路由到一个预定义的死信队列中</strong> 进行进一步处理或记录。</p> 
<h4><a id="12__12"></a>1.2 何时进入死信队列？</h4> 
<p>当发生以下情况，业务队列中的消息会进入死信队列：</p> 
<ol><li><code>消息被否定确认</code>：使用 <code>channel.basicNack</code> 或 <code>channel.basicReject</code>，并且此时 <code>requeue</code> 属性被设置为 <code>false</code>。</li><li><code>消息过期</code>：消息在队列的存活时间超过设置的 TTL 时间。</li><li><code>消息溢出</code>：队列中的消息数量已经超过最大队列长度。</li></ol> 
<p>当发生以上三种情况后，该消息将成为 <code>死信</code>。死信消息会被 RabbitMQ 进行特殊处理：</p> 
<ul><li>如果配置了死信队列，那么该消息将会被丢进死信队列中；</li><li>如果没有配置，则该消息将会被丢弃。</li></ul> 
<h4><a id="13__25"></a>1.3 死信消息的变化</h4> 
<p>那么 <code>死信</code> 被丢到死信队列后，会发生什么变化呢？</p> 
<ul><li>如果队列配置了 <code>x-dead-letter-routing-key</code> 的话，“死信” 的路由键会被替换成该参数对应的值。</li><li>如果没有配置，则保留该消息原有的路由键。</li></ul> 
<p><strong>举个例子：</strong></p> 
<p>原有队列的路由键是 <code>RoutingKey1</code>，有以下两种情况：</p> 
<ul><li>如果配置队列的 <code>x-dead-letter-routing-key</code> 参数值为 <code>RoutingKey2</code>，则该消息成为 “死信” 后，会将路由键更改为 <code>RoutingKey2</code>，从而进入死信交换机中的死信队列。</li><li>如果没有配置 <code>x-dead-letter-routing-key</code> 参数，则该消息成为 “死信” 后，路由键不会更改，也不会进入死信队列。</li></ul> 
<p><img src="https://images2.imgbox.com/c8/b8/KbNBMkJC_o.png" alt="在这里插入图片描述"></p> 
<p>当配置了 <code>x-dead-letter-routing-key</code> 参数后，消息成为 “死信” 后，会在消息的 <code>Header</code> 中添加很多奇奇怪怪的字段，我们可以在死信队列的消费端通过以下方式进行打印：</p> 
<pre><code class="prism language-java">log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"死信消息properties: {}"</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>日志内容如下：</p> 
<pre><code class="prism language-java"><span class="token number">2024</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">07</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">19.745</span>  <span class="token constant">INFO</span> <span class="token number">11776</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>ntContainer#<span class="token number">3</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span>d<span class="token punctuation">.</span>receiver<span class="token punctuation">.</span></span>DeadLetterMessageReceiver</span>   <span class="token operator">:</span>消息properties<span class="token operator">:</span> <span class="token class-name">MessageProperties</span> <span class="token punctuation">[</span>headers<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>x<span class="token operator">-</span>first<span class="token operator">-</span>death<span class="token operator">-</span>exchange<span class="token operator">=</span>demo<span class="token punctuation">.</span>simple<span class="token punctuation">.</span>business<span class="token punctuation">.</span>exchange<span class="token punctuation">,</span> x<span class="token operator">-</span>death<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>reason<span class="token operator">=</span>rejected<span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> exchange<span class="token operator">=</span>demo<span class="token punctuation">.</span>simple<span class="token punctuation">.</span>business<span class="token punctuation">.</span>exchange<span class="token punctuation">,</span> time<span class="token operator">=</span><span class="token class-name">Sun</span> <span class="token class-name">Jan</span> <span class="token number">07</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">19</span> <span class="token class-name">CST</span> <span class="token number">2024</span><span class="token punctuation">,</span> routing<span class="token operator">-</span>keys<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> queue<span class="token operator">=</span>demo<span class="token punctuation">.</span>simple<span class="token punctuation">.</span>business<span class="token punctuation">.</span>queuea<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> x<span class="token operator">-</span>first<span class="token operator">-</span>death<span class="token operator">-</span>reason<span class="token operator">=</span>rejected<span class="token punctuation">,</span> x<span class="token operator">-</span>first<span class="token operator">-</span>death<span class="token operator">-</span>queue<span class="token operator">=</span>demo<span class="token punctuation">.</span>simple<span class="token punctuation">.</span>business<span class="token punctuation">.</span>queuea<span class="token punctuation">}</span><span class="token punctuation">,</span> contentType<span class="token operator">=</span>text<span class="token operator">/</span>plain<span class="token punctuation">,</span> contentEncoding<span class="token operator">=</span><span class="token constant">UTF</span><span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">,</span> contentLength<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> receivedDeliveryMode<span class="token operator">=</span><span class="token constant">PERSISTENT</span><span class="token punctuation">,</span> priority<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> redelivered<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">,</span> receivedExchange<span class="token operator">=</span>demo<span class="token punctuation">.</span>simple<span class="token punctuation">.</span>deadletter<span class="token punctuation">.</span>exchange<span class="token punctuation">,</span> receivedRoutingKey<span class="token operator">=</span>demo<span class="token punctuation">.</span>simple<span class="token punctuation">.</span>deadletter<span class="token punctuation">.</span>queuea<span class="token punctuation">.</span>routingkey<span class="token punctuation">,</span> deliveryTag<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> consumerTag<span class="token operator">=</span>amq<span class="token punctuation">.</span>ctag<span class="token operator">-</span><span class="token class-name">RPfmKjM8Lau9X7Fl0CtbEA</span><span class="token punctuation">,</span> consumerQueue<span class="token operator">=</span>demo<span class="token punctuation">.</span>simple<span class="token punctuation">.</span>deadletter<span class="token punctuation">.</span>queuea<span class="token punctuation">]</span>
</code></pre> 
<p>格式化后：</p> 
<p><img src="https://images2.imgbox.com/7e/f2/yshVQEfF_o.png" alt="在这里插入图片描述"></p> 
<p>Header 中看起来有很多信息，实际上并不多，只是值比较长而已。下面就简单说明一下 Header 中的值：</p> 
<table><thead><tr><th align="left">字段名</th><th>含义</th></tr></thead><tbody><tr><td align="left"><code>x-first-death-exchange</code></td><td>第一次成为死信时的交换机名称。</td></tr><tr><td align="left"><code>x-first-death-reason</code></td><td>第一次成为死信的原因：<br><code>rejected</code>：消息在进入队列时被队列拒绝。<br><code>expired</code>：消息过期。<br><code>maxlen</code>：队列内消息数量超过队列最大容量。</td></tr><tr><td align="left"><code>x-first-death-queue</code></td><td>第一次成为死信时的队列名称。</td></tr><tr><td align="left"><code>x-death</code></td><td>历史被投入死信交换机的信息列表，同一个消息每进入一次死信交换机，这个数组的信息就会被更新。</td></tr></tbody></table> 
<h4><a id="14__68"></a>1.4 死信队列的应用场景</h4> 
<p>通过上面的信息，我们已经知道如何使用死信队列了，那么死信队列一般在什么场景下使用呢？</p> 
<p>死信队列 <strong>一般用在较为重要的业务队列中，确保未被正确消费的消息不被丢弃</strong>，一般发生消费异常可能原因主要是消息信息本身存在错误导致处理异常，处理过程中参数校验异常，或者因网络波动导致的查询异常等等。当发生异常时，当然 <strong>不能每次通过日志来获取原消息，然后让运维帮忙重新投递消息</strong> （没错，以前很多人这么干的 = =）。通过配置死信队列，<strong>可以让未正确处理的消息暂存到另一个队列中</strong>，待后续排查清楚问题后，<strong>编写相应的处理代码来处理死信消息</strong>，这样比手工恢复数据要好得多。</p> 
<h4><a id="15__74"></a>1.5 死信消息的生命周期</h4> 
<p>死信消息的生命周期如下：</p> 
<ol><li>业务消息被 <strong>投入业务队列</strong>；</li><li>消费者 <strong>消费业务队列的消息</strong>，由于处理过程中 <strong>发生异常</strong>，于是 <strong>进行了 <code>Nack</code> 或 <code>Reject</code> 操作</strong>；</li><li>被 <code>Nack</code> 或 <code>Reject</code> 的消息由 RabbitMQ <strong>投递到死信交换机中</strong>；</li><li>死信交换机将消息 <strong>投入相应的死信队列</strong>；</li><li>死信队列的消费者 <strong>消费死信消息</strong>。</li></ol> 
<hr> 
<h3><a id="_86"></a>二、代码实现</h3> 
<h4><a id="21__88"></a>2.1 死信队列的配置步骤</h4> 
<p>死信队列的配置可以分为以下三步：</p> 
<ol><li><strong>配置业务队列</strong>，绑定到业务交换机上；</li><li>为业务队列 <strong>配置死信交换机</strong>、路由键；</li><li>为死信交换机 <strong>配置死信队列</strong>。</li></ol> 
<blockquote> 
 <p><strong>注意：</strong></p> 
 <p>并不是直接声明一个公共的死信队列，然后所有死信消息就会自己进入死信队列中了。而是为每个需要使用死信的业务队列配置一个死信交换机，这里同一个项目的死信交换机可以共用一个，然后每个业务队列分配一个单独的路由键。</p> 
</blockquote> 
<p>有了死信交换机和路由键后，接下来就像配置业务队列一样，<strong>配置死信队列，并绑定在死信交换机上</strong>。看到这里，大家应该可以明白：</p> 
<ul><li><strong>死信队列</strong> 并不是什么特殊的队列，<strong>只不过是绑定在死信交换机上的队列</strong>。</li><li><strong>死信交换机</strong> 也不是什么特殊的交换机，<strong>只不过是用来接收死信队列的交换机</strong>。</li></ul> 
<p>所以死信交换机可以为任何类型【Direct、Fanout、Topic】。一般来说，因为开发过程中会为每个业务队列分配一个独有的路由 key，并对应的配置一个死信队列进行监听。</p> 
<p>有了前面的这些描述后，我们接下来实战操作一下。</p> 
<h4><a id="22__109"></a>2.2 配置类</h4> 
<p>配置类中声明了两个交换机：</p> 
<ul><li><code>业务交换机（广播）</code>，绑定了两个业务队列： 
  <ul><li>业务队列A；</li><li>业务队列B。</li></ul> </li><li><code>死信交换机（直连）</code>，绑定了两个死信队列，并配置了相应的路由键： 
  <ul><li>死信队列A；</li><li>死信队列B。</li></ul> </li></ul> 
<p><strong>RabbitMQConfig.java</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * &lt;p&gt; @Title RabbitMQOrderConfig
 * &lt;p&gt; @Description RabbitMQ配置
 *
 * @author ACGkaka
 * @date 2023/12/22 14:05
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RabbitMQConfig</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/** 业务队列 */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">BUSINESS_EXCHANGE_NAME</span> <span class="token operator">=</span> <span class="token string">"demo.simple.business.exchange"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">BUSINESS_QUEUEA_NAME</span> <span class="token operator">=</span> <span class="token string">"demo.simple.business.queuea"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">BUSINESS_QUEUEB_NAME</span> <span class="token operator">=</span> <span class="token string">"demo.simple.business.queueb"</span><span class="token punctuation">;</span>
    <span class="token comment">/** 死信队列 */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEAD_LETTER_EXCHANGE</span> <span class="token operator">=</span> <span class="token string">"demo.simple.deadletter.exchange"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEAD_LETTER_QUEUEA_ROUTING_KEY</span> <span class="token operator">=</span> <span class="token string">"demo.simple.deadletter.queuea.routingkey"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEAD_LETTER_QUEUEB_ROUTING_KEY</span> <span class="token operator">=</span> <span class="token string">"demo.simple.deadletter.queueb.routingkey"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEAD_LETTER_QUEUEA_NAME</span> <span class="token operator">=</span> <span class="token string">"demo.simple.deadletter.queuea"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEAD_LETTER_QUEUEB_NAME</span> <span class="token operator">=</span> <span class="token string">"demo.simple.deadletter.queueb"</span><span class="token punctuation">;</span>

    <span class="token comment">// 声明业务交换机（广播）</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">FanoutExchange</span> <span class="token function">businessExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FanoutExchange</span><span class="token punctuation">(</span><span class="token constant">BUSINESS_EXCHANGE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 声明死信交换机（直连）</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">DirectExchange</span> <span class="token function">deadLetterExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DirectExchange</span><span class="token punctuation">(</span><span class="token constant">DEAD_LETTER_EXCHANGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 声明业务队列A</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">businessQueueA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 声明当前队列绑定的死信交换机</span>
        args<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"x-dead-letter-exchange"</span><span class="token punctuation">,</span> <span class="token constant">DEAD_LETTER_EXCHANGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 声明当前队列绑定的死信路由键</span>
        args<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"x-dead-letter-routing-key"</span><span class="token punctuation">,</span> <span class="token constant">DEAD_LETTER_QUEUEA_ROUTING_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">QueueBuilder</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token constant">BUSINESS_QUEUEA_NAME</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withArguments</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 声明业务队列B</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">businessQueueB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 声明当前队列绑定的死信交换机</span>
        args<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"x-dead-letter-exchange"</span><span class="token punctuation">,</span> <span class="token constant">DEAD_LETTER_EXCHANGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 声明当前队列绑定的死信路由键</span>
        args<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"x-dead-letter-routing-key"</span><span class="token punctuation">,</span> <span class="token constant">DEAD_LETTER_QUEUEB_ROUTING_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">QueueBuilder</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token constant">BUSINESS_QUEUEB_NAME</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withArguments</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 声明死信队列A</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">deadLetterQueueA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token constant">DEAD_LETTER_QUEUEA_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 声明死信队列B</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">deadLetterQueueB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token constant">DEAD_LETTER_QUEUEB_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 声明业务队列A绑定关系</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">businessBindingA</span><span class="token punctuation">(</span><span class="token class-name">Queue</span> businessQueueA<span class="token punctuation">,</span> <span class="token class-name">FanoutExchange</span> businessExchange<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>businessQueueA<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>businessExchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 声明业务队列B绑定关系</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">businessBindingB</span><span class="token punctuation">(</span><span class="token class-name">Queue</span> businessQueueB<span class="token punctuation">,</span> <span class="token class-name">FanoutExchange</span> businessExchange<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>businessQueueB<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>businessExchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 声明死信队列A绑定关系</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">deadLetterBindingA</span><span class="token punctuation">(</span><span class="token class-name">Queue</span> deadLetterQueueA<span class="token punctuation">,</span> <span class="token class-name">DirectExchange</span> deadLetterExchange<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>deadLetterQueueA<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>deadLetterExchange<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token constant">DEAD_LETTER_QUEUEA_ROUTING_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 声明死信队列B绑定关系</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">deadLetterBindingB</span><span class="token punctuation">(</span><span class="token class-name">Queue</span> deadLetterQueueB<span class="token punctuation">,</span> <span class="token class-name">DirectExchange</span> deadLetterExchange<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>deadLetterQueueB<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>deadLetterExchange<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token constant">DEAD_LETTER_QUEUEB_ROUTING_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="23__225"></a>2.3 配置文件</h4> 
<p><strong>application.yml</strong></p> 
<pre><code class="prism language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8081</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> springboot<span class="token punctuation">-</span>rabbitmq<span class="token punctuation">-</span>dead<span class="token punctuation">-</span>letter
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token comment"># 此处不建议单独配置host和port，单独配置不支持连接RabbitMQ集群</span>
    <span class="token key atrule">addresses</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">5672</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> guest
    <span class="token key atrule">password</span><span class="token punctuation">:</span> guest
    <span class="token comment"># 虚拟host 可以不设置，使用server默认host</span>
    <span class="token key atrule">virtual-host</span><span class="token punctuation">:</span> /
    <span class="token comment"># 是否开启发送端消息抵达队列的确认</span>
    <span class="token key atrule">publisher-returns</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment"># 发送方确认机制，默认为NONE，即不进行确认；SIMPLE：同步等待消息确认；CORRELATED：异步确认</span>
    <span class="token key atrule">publisher-confirm-type</span><span class="token punctuation">:</span> correlated
    <span class="token comment"># 消费者监听相关配置</span>
    <span class="token key atrule">listener</span><span class="token punctuation">:</span>
      <span class="token key atrule">simple</span><span class="token punctuation">:</span>
        <span class="token key atrule">acknowledge-mode</span><span class="token punctuation">:</span> manual <span class="token comment"># 确认模式，默认auto，自动确认；manual：手动确认</span>
        <span class="token key atrule">default-requeue-rejected</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 消费端抛出异常后消息是否返回队列，默认值为true</span>
        <span class="token key atrule">prefetch</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment"># 限制每次发送一条数据</span>
        <span class="token key atrule">concurrency</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment"># 同一个队列启动几个消费者</span>
        <span class="token key atrule">max-concurrency</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment"># 启动消费者最大数量</span>
        <span class="token comment"># 重试机制</span>
        <span class="token key atrule">retry</span><span class="token punctuation">:</span>
          <span class="token comment"># 开启消费者(程序出现异常)重试机制，默认开启并一直重试</span>
          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token comment"># 最大重试次数</span>
          <span class="token key atrule">max-attempts</span><span class="token punctuation">:</span> <span class="token number">3</span>
          <span class="token comment"># 重试间隔时间(毫秒)</span>
          <span class="token key atrule">initial-interval</span><span class="token punctuation">:</span> <span class="token number">3000</span>
</code></pre> 
<h4><a id="24__265"></a>2.4 生产者</h4> 
<p>为了方便测试，写一个简单的消息生产者，通过controller层来生产消息。</p> 
<p><strong>SendMessageController.java</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">RabbitMQConfig</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RabbitTemplate</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * &lt;p&gt; @Title SendMessageController
 * &lt;p&gt; @Description 推送消息接口
 *
 * @author ACGkaka
 * @date 2023/1/12 15:23
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SendMessageController</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 使用 RabbitTemplate，这提供了接收/发送等方法。
     */</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/sendMessage"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token class-name">RabbitMQConfig</span><span class="token punctuation">.</span><span class="token constant">BUSINESS_EXCHANGE_NAME</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"OK"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="25__304"></a>2.5 业务消费者</h4> 
<p>接下来是业务队列的消费端代码</p> 
<p><strong>BusinessMessageReceiver.java</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">RabbitMQConfig</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">Channel</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Message</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RabbitListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * &lt;p&gt; @Title BusinessMessageReceiver
 * &lt;p&gt; @Description RabbitMQ业务队列消费端
 *
 * @author ACGkaka
 * @date 2024/1/7 17:43
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BusinessMessageReceiver</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token class-name">RabbitMQConfig</span><span class="token punctuation">.</span><span class="token constant">BUSINESS_QUEUEA_NAME</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receiveA</span><span class="token punctuation">(</span><span class="token class-name">String</span> body<span class="token punctuation">,</span> <span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"业务队列A收到消息: {}"</span><span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>body<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"deadletter"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"dead letter exception"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"业务队列A消息消费发生异常，error msg: {}"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            channel<span class="token punctuation">.</span><span class="token function">basicReject</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token class-name">RabbitMQConfig</span><span class="token punctuation">.</span><span class="token constant">BUSINESS_QUEUEB_NAME</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receiveB</span><span class="token punctuation">(</span><span class="token class-name">String</span> body<span class="token punctuation">,</span> <span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"业务队列B收到消息: {}"</span><span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="26__353"></a>2.6 死信消费者</h4> 
<p>接下来是死信队列的消费端代码</p> 
<p><strong>DeadLetterMessageReceiver.java</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">RabbitMQConfig</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">Channel</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Message</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RabbitListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * &lt;p&gt; @Title DeadLetterMessageReceiver
 * &lt;p&gt; @Description RabbitMQ死信队列消费端
 *
 * @author ACGkaka
 * @date 2024/1/7 18:14
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeadLetterMessageReceiver</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token class-name">RabbitMQConfig</span><span class="token punctuation">.</span><span class="token constant">DEAD_LETTER_QUEUEA_NAME</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receiveA</span><span class="token punctuation">(</span><span class="token class-name">String</span> body<span class="token punctuation">,</span> <span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"死信队列A收到消息: {}"</span><span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token class-name">RabbitMQConfig</span><span class="token punctuation">.</span><span class="token constant">DEAD_LETTER_QUEUEB_NAME</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receiveB</span><span class="token punctuation">(</span><span class="token class-name">String</span> body<span class="token punctuation">,</span> <span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"死信队列B收到消息: {}"</span><span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="27__394"></a>2.7 测试结果</h4> 
<p><strong>消费正常消息，请求结果：</strong></p> 
<p>请求地址：http://localhost:8081/sendMessage?message=Hello</p> 
<p><img src="https://images2.imgbox.com/57/82/WdkSpo9c_o.png" alt="在这里插入图片描述"></p> 
<p>从日志可以看到：<strong>两个业务队列成功消费</strong>。</p> 
<p><img src="https://images2.imgbox.com/74/6f/jOb11QnH_o.png" alt="在这里插入图片描述"></p> 
<p><strong>消费错误消息，请求结果：</strong></p> 
<p>请求地址：http://localhost:8081/sendMessage?message=deadletter</p> 
<p><img src="https://images2.imgbox.com/b1/26/Uqyeh1uo_o.png" alt="在这里插入图片描述"></p> 
<p>从日志可以看到：业务队列A和B都收到了消息，但是 <strong>业务队列A消费发生异常</strong>，然后消息就被 <strong>转到了死信队列</strong>，<strong>死信队列消费端成功消费</strong>。</p> 
<p><img src="https://images2.imgbox.com/af/33/800ATj9I_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<h3><a id="_422"></a>三、总结</h3> 
<p>死信队列其实并没有什么神秘的地方，不过是绑定在死信交换机上的普通队列，而死信交换机也只是一个普通的交换机，不过是用来专门处理死信的交换机。</p> 
<p><code>死信消息</code> 时 RabbitMQ 为我们做的一层保障，其实我们 <strong>也可以不使用死信队列</strong>，而是 <strong>在消息消费异常的时候，将消息主动投递到另一个交换机中</strong>，当你明白了这些之后，这些 Exchange 和 Queue 想怎样配合就可以怎样配合。比如：</p> 
<ul><li>从死信队列拉取消息，然后发送邮件、短信、钉钉通知来通知开发人员关注。</li><li>或者将消息重新投递到一个队列然后设置过期时间，来进行延时消费等等。</li></ul> 
<hr> 
<h3><a id="_433"></a>四、补充</h3> 
<h4><a id="41__inequivalent_arg_xdeadletterexchange_435"></a>4.1 启动报错 inequivalent arg ‘x-dead-letter-exchange’</h4> 
<p>如果之前已经存在队列，添加死信队列后可能会报错：</p> 
<p><strong><font color="red">reply-code=406, reply-text=PRECONDITION_FAILED - inequivalent arg ‘x-dead-letter-exchange’ for queue ‘MY_QUEUE’ in vhost ‘/’: received the value ‘MY_DEAD_LETTER_EXCHANGE’ of type ‘longstr’ but current is none</font></strong></p> 
<p><strong>完整报错信息：</strong></p> 
<pre><code class="prism language-java"><span class="token class-name">Caused</span> by<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span>ShutdownSignalException</span><span class="token operator">:</span> channel error<span class="token punctuation">;</span> protocol method<span class="token operator">:</span> #method<span class="token generics"><span class="token punctuation">&lt;</span>channel<span class="token punctuation">.</span>close<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>reply<span class="token operator">-</span>code<span class="token operator">=</span><span class="token number">406</span><span class="token punctuation">,</span> reply<span class="token operator">-</span>text<span class="token operator">=</span><span class="token constant">PRECONDITION_FAILED</span> <span class="token operator">-</span> inequivalent arg 'x<span class="token operator">-</span>dead<span class="token operator">-</span>letter<span class="token operator">-</span>exchange' <span class="token keyword">for</span> queue '<span class="token constant">MY_QUEUE</span>' in vhost <span class="token char">'/'</span><span class="token operator">:</span> received the value '<span class="token constant">MY_DEAD_LETTER_EXCHANGE</span>' of type 'longstr' but current is none<span class="token punctuation">,</span> <span class="token keyword">class</span><span class="token operator">-</span>id<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> method<span class="token operator">-</span>id<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
        at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span>ChannelN</span><span class="token punctuation">.</span><span class="token function">asyncShutdown</span><span class="token punctuation">(</span><span class="token class-name">ChannelN</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">517</span><span class="token punctuation">)</span>
        at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span>ChannelN</span><span class="token punctuation">.</span><span class="token function">processAsync</span><span class="token punctuation">(</span><span class="token class-name">ChannelN</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">341</span><span class="token punctuation">)</span>
        at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span>AMQChannel</span><span class="token punctuation">.</span><span class="token function">handleCompleteInboundCommand</span><span class="token punctuation">(</span><span class="token class-name">AMQChannel</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">185</span><span class="token punctuation">)</span>
        at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span>AMQChannel</span><span class="token punctuation">.</span><span class="token function">handleFrame</span><span class="token punctuation">(</span><span class="token class-name">AMQChannel</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">117</span><span class="token punctuation">)</span>
        at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span>AMQConnection</span><span class="token punctuation">.</span><span class="token function">readFrame</span><span class="token punctuation">(</span><span class="token class-name">AMQConnection</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">742</span><span class="token punctuation">)</span>
        at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span>AMQConnection</span><span class="token punctuation">.</span>access$<span class="token function">300</span><span class="token punctuation">(</span><span class="token class-name">AMQConnection</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">47</span><span class="token punctuation">)</span>
        at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span>AMQConnection</span>$<span class="token class-name">MainLoop</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">AMQConnection</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">669</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>修复方案：</strong></p> 
<p>将之前已经存在的队列删除后重启应用即可。</p> 
<p>整理完毕，完结撒花~ 🌻</p> 
<p><br><br><br><br></p> 
<p>参考地址：</p> 
<p>1.【RabbitMQ】一文带你搞定RabbitMQ死信队列，https://cloud.tencent.com/developer/article/1463065</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/11a7b58fd0397cdbbbfbc09852883166/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">消息队列-RockMQ-定时延时发送消息</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/14d7038a7bfdc36a430f26d0a32dde82/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">GitHub 上传超过 100M 文件方法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>