<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>C# .Net通过pythonnet调用python pyd文件 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="C# .Net通过pythonnet调用python pyd文件" />
<meta property="og:description" content="开发环境：windows， python310， dotnet 6.0
说明：python文件编译成pyd。
1.新建控制台应用程序
2.添加nuget包
3.C#调用代码
using Python.Runtime; Runtime.PythonDLL= @&#34;D:\Programs\Python\Python310\python310.dll&#34;; PythonEngine.Initialize(); using (Py.GIL()) { dynamic np = Py.Import(&#34;PythonTest&#34;); var dd = np.cal(&#34;aa&#34;); Console.ReadLine(); } 调试可以看到python脚本返回的代码。
注意：请将PythonDLL路径改为自己的python安装路径；PythonTest为编译好的pyd文件，请将该文件复制到控制台程序debug目录，或者复制到控制台程序里面，将其属性复制到输出目录改为始终复制。
4.附录python脚本
def cal(param): return f&#39;this is from python program, and the parameter is {param}&#39; ******************************************2022-10-13 更新*************************************************
对于简单的py文件上面的方法可以很容易执行，但是对于引用外部package，比如pandas, numpy等等，我们调用的时候会抛出异常 “未找到相应的模块”。仔细一想就会知道，我们只打包了单个py文件，它所依赖的package当然会找不到。下面就是来解决这个问题。
我所测试的环境python版本变成了python 3.8.10。
我们只需要将下面代码放在using(Py.GIL())之前就可以：
string pathToVirtualEnv = @&#34;D:\Programs\Python\Python3.8.10&#34;; Environment.SetEnvironmentVariable(&#34;PATH&#34;, pathToVirtualEnv, EnvironmentVariableTarget.Process); Environment.SetEnvironmentVariable(&#34;PYTHONHOME&#34;, pathToVirtualEnv, EnvironmentVariableTarget.Process); Environment.SetEnvironmentVariable(&#34;PYTHONPATH&#34;, $&#34;{pathToVirtualEnv}\\Lib\\site-packages;{pathToVirtualEnv}\\Lib&#34;, EnvironmentVariableTarget.Process); Runtime.PythonDLL= @&#34;D:\Programs\Python\Python3.8.10\python38.dll&#34;; PythonEngine.PythonHome = pathToVirtualEnv; PythonEngine.PythonPath = PythonEngine." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/1996546ffd95e20942cad82290951268/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-29T14:05:40+08:00" />
<meta property="article:modified_time" content="2023-05-29T14:05:40+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">C# .Net通过pythonnet调用python pyd文件</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>开发环境：windows， python310， dotnet 6.0</p> 
<p>说明：<a class="link-info" href="https://blog.csdn.net/The_Moon_/article/details/127256378" title="python文件编译成pyd">python文件编译成pyd</a>。</p> 
<p>1.新建控制台应用程序</p> 
<p>2.添加nuget包</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/ef/2e/S95FAcse_o.png"></p> 
<p></p> 
<p>3.C#调用代码</p> 
<pre><code class="language-cs">using Python.Runtime;

Runtime.PythonDLL= @"D:\Programs\Python\Python310\python310.dll";
PythonEngine.Initialize();
using (Py.GIL())
{
    dynamic np = Py.Import("PythonTest");
    var dd = np.cal("aa");
    Console.ReadLine();
}</code></pre> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/6d/e9/VhibktgU_o.png"></p> 
<p> 调试可以看到python脚本返回的代码。</p> 
<p><span style="background-color:#fefcd8;">注意：请将PythonDLL路径改为自己的python安装路径；PythonTest为编译好的pyd文件，请将该文件复制到控制台程序debug目录，或者复制到控制台程序里面，将其属性复制到输出目录改为始终复制。</span></p> 
<p>4.附录python脚本</p> 
<pre><code class="language-python">def cal(param):
    return f'this is from python program, and the parameter is {param}'</code></pre> 
<p><span style="color:#ff9900;">******************************************2022-10-13 更新*************************************************</span></p> 
<p><span style="color:#ff9900;">对于简单的py文件上面的方法可以很容易执行，但是对于引用外部package，比如pandas, numpy等等，我们调用的时候会抛出异常 “未找到相应的模块”。仔细一想就会知道，我们只打包了单个py文件，它所依赖的package当然会找不到。下面就是来解决这个问题。</span></p> 
<p><span style="color:#ff9900;">我所测试的环境python版本变成了python 3.8.10。</span></p> 
<p><span style="color:#ff9900;">我们只需要将下面代码放在using(Py.GIL())之前就可以：</span></p> 
<pre><code class="language-cs">string pathToVirtualEnv = @"D:\Programs\Python\Python3.8.10";
Environment.SetEnvironmentVariable("PATH", pathToVirtualEnv, EnvironmentVariableTarget.Process);
Environment.SetEnvironmentVariable("PYTHONHOME", pathToVirtualEnv, EnvironmentVariableTarget.Process);
Environment.SetEnvironmentVariable("PYTHONPATH", $"{pathToVirtualEnv}\\Lib\\site-packages;{pathToVirtualEnv}\\Lib", EnvironmentVariableTarget.Process);

Runtime.PythonDLL= @"D:\Programs\Python\Python3.8.10\python38.dll";
PythonEngine.PythonHome = pathToVirtualEnv;
PythonEngine.PythonPath = PythonEngine.PythonPath + ";" + Environment.GetEnvironmentVariable("PYTHONPATH", EnvironmentVariableTarget.Process);
PythonEngine.Initialize();</code></pre> 
<p><span style="color:#ff9900;">在你执行的过程中如果抛出找不到对应包的异常，你需要在PyCharm里面执行pip install &lt;package-name&gt;。这个命令会将package安装在我们的python安装目录下的Lib\site-package下。</span></p> 
<p><span style="color:#ff9900;">当然你也可以使用指定的路径，具体方法可以参考下面的链接：</span></p> 
<p><span style="color:#ff9900;"><a href="https://github.com/pythonnet/pythonnet/issues/1348" title="Setting Virtual Environment while Embedding Python in C#">Setting Virtual Environment while Embedding Python in C#</a></span></p> 
<p><span style="color:#ff9900;"><a class="link-info" href="https://github.com/pythonnet/pythonnet/wiki/Using-Python.NET-with-Virtual-Environments" title="Using Python.NET with Virtual Environments">Using Python.NET with Virtual Environments</a></span></p> 
<p><span style="color:#ff9900;">不管哪一种，最重要的是需要在代码里配置PYTHONPATH, 让我们的程序可以有地方去找package。</span></p> 
<p><span style="color:#ff9900;">比如.net core项目，我复制了python安装包的<strong>DLLs, Lib文件夹和python38.dll</strong>文件到bin\\dubug\\net6.0\\python\python3.8。</span></p> 
<p><span style="color:#ff9900;">只需要将上面代码的pathToVirtualEnv改成新的路径即可：</span></p> 
<pre><code class="language-cs">//string pathToVirtualEnv = @"D:\Programs\Python\Python3.8.10"
string pathToVirtualEnv = Path.Combine(Path.GetDirectoryName(System.Reflection.Assembly.GetEntryAssembly().Location), "Python\\Python3.8");</code></pre> 
<hr> 
<hr> 
<p>踩了不少坑，目前稳定运行在生产环境，代码贴出来，可以直接用。</p> 
<p>1. ICallPyService， 定义接口</p> 
<pre><code class="language-cs">    /// &lt;summary&gt;
    /// 调用python模块服务
    /// &lt;/summary&gt;
    public interface ICallPyService
    {
        /// &lt;summary&gt;
        /// 执行方法
        /// &lt;/summary&gt;
        /// &lt;param name="model"&gt;参数model&lt;/param&gt;
        /// &lt;returns&gt;PyObject&lt;/returns&gt;
        public string Exec(ModuleInfoModel model);

        public void ShutDown();
    }</code></pre> 
<p>2. ModuleInfoModel ，定义了调用pyhton代码的基础信息。</p> 
<pre><code class="language-cs">    /// &lt;summary&gt;
	/// 模块信息
	/// &lt;/summary&gt;
	public class ModuleInfoModel
	{
		/// &lt;summary&gt;
		/// 初始化
		/// &lt;/summary&gt;
		public ModuleInfoModel()
		{
			Params = new List&lt;ParamInfo&gt;();
		}

		/// &lt;summary&gt;
		/// 导入的模块名
		/// &lt;/summary&gt;
		public string ModuleName { get; set; }

		/// &lt;summary&gt;
		/// 调用的模块方法
		/// &lt;/summary&gt;
		public string MethodName { get; set; }

		/// &lt;summary&gt;
		/// 参数列表
		/// &lt;/summary&gt;
		public List&lt;ParamInfo&gt; Params { get; set; }
	}</code></pre> 
<p>3. ParamInfo， python参数定义（sort是为了定义参数顺序）</p> 
<pre><code class="language-cs">    /// &lt;summary&gt;
    /// 参数信息
    /// &lt;/summary&gt;
    public class ParamInfo
    {

        /// &lt;summary&gt;
        /// 参数顺序
        /// &lt;/summary&gt;
        public int Sort { get; set; }

        /// &lt;summary&gt;
        /// 参数值
        /// &lt;/summary&gt;
        public object Value { get; set; }
    }</code></pre> 
<p>4. CallPyService，接口实现</p> 
<pre><code class="language-cs">    /// &lt;summary&gt;
    /// python service
    /// &lt;/summary&gt;
    public class CallPyService: ICallPyService
    {
        private static string _pythonPath;

        /// &lt;summary&gt;
        /// 初始化
        /// &lt;/summary&gt;
        public CallPyService()
        {
            if (!App.GetOptions&lt;PythonInfoOptions&gt;().IsLinux)
            {
                _pythonPath = Path.Combine(Path.GetDirectoryName(System.Reflection.Assembly.GetEntryAssembly().Location), Path.Combine("Python", "Python3.8"));
                Environment.SetEnvironmentVariable("PATH", _pythonPath, EnvironmentVariableTarget.Process);
                Environment.SetEnvironmentVariable("PYTHONHOME", _pythonPath, EnvironmentVariableTarget.Process);
                Environment.SetEnvironmentVariable("PYTHONPATH", $"{Path.Combine(_pythonPath, "Lib", "site-packages")};{Path.Combine(_pythonPath, "Lib")}", EnvironmentVariableTarget.Process);
                Environment.SetEnvironmentVariable("PYTHONNET_PYDLL", $"{Path.Combine(_pythonPath, "python38.dll")}", EnvironmentVariableTarget.Process);
            }
        }

        /// &lt;summary&gt;
        /// 执行python模型算法
        /// &lt;/summary&gt;
        /// &lt;param name="model"&gt;&lt;/param&gt;
        /// &lt;returns&gt;PyObject&lt;/returns&gt;
        public string Exec(ModuleInfoModel model)
        {
            Init();
            string result;
            using (var gil = Py.GIL())
            {
                PyObject func = Py.Import(model.ModuleName);
                dynamic json = Py.Import("orjson");
                PyObject[] pyParams = model.Params.OrderBy(o =&gt; o.Sort).Select(o =&gt; (PyObject)EvalObject(o.Value, json)).ToArray();
                PyObject data = func.InvokeMethod(model.MethodName, pyParams);
                data = json.dumps(data, option: json.OPT_SERIALIZE_NUMPY).decode();
                result = data.ToString();
            }
            return result;
        }

        private static void Init()
        {
            lock (_lockObj)
            {
                if (!PythonEngine.IsInitialized)
                {
                    if (!App.GetOptions&lt;PythonInfoOptions&gt;().IsLinux)
                    {
                        PythonEngine.PythonHome = _pythonPath;
                        PythonEngine.PythonPath = PythonEngine.PythonPath + ";" + Environment.GetEnvironmentVariable("PYTHONPATH", EnvironmentVariableTarget.Process);
                    }
                    else
                    {
                        Runtime.PythonDLL = App.GetOptions&lt;PythonInfoOptions&gt;().LinuxPythonDLL;
                    }
                    PythonEngine.Initialize();
                    PythonEngine.BeginAllowThreads();
                }
            }
        }

        /// &lt;summary&gt;
        /// 
        /// &lt;/summary&gt;
        public void ShutDown()
        {
            PythonEngine.Shutdown();
        }

        /// &lt;summary&gt;
        /// 将C#对象转成PyObject
        /// &lt;/summary&gt;
        /// &lt;param name="value"&gt;object&lt;/param&gt;
        /// &lt;param name="orjson"&gt;orjson&lt;/param&gt;
        /// &lt;returns&gt;PyObject&lt;/returns&gt;
        private PyObject EvalObject(object value, dynamic orjson)
        {
            if (value == null || value.ToString() == "None")
            {
                return PyObject.None;
            }
            return orjson.loads(JsonConvert.SerializeObject(value));
        }
    }</code></pre> 
<p>上面封装成了服务，所以不管是接口还是其他地方直接调用都很方便。后面因为打包成了docker，部署到linux，所以加了linux相关初始化的东西（主要就是路径区别），用不到Linux系统的可以自己修改代码，删掉无用信息。</p> 
<p>另外，服务实现了ShutDown，因为执行完python代码后，内存好像没释放，如果需要，可以手动调用ShutDown来释放内存（多线程要不要执行，至少要确保所有脚本都执行完了）。</p> 
<p>转载请注明出处，谢谢！</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5eee07cb48be49e3e71eea07e158b7b6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">I/O 端口</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f79b2165fc580e8b4fd2a382429c25f6/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">仿牛客网项目（二）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>