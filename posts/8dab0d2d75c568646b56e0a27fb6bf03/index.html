<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>mybatis缓存详解 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="mybatis缓存详解" />
<meta property="og:description" content="mybatis的缓存 mybatis的一级缓存是Session级别的缓存。一级缓存的作用域默认是一个SqlSession。Mybatis默认开启一级缓存。
在同一个SqlSession中，执行相同的查询SQL，第一次会去数据库进行查询，并把对象放入缓存中，第二次以后是直接去缓存中取。当执行SQL查询中间发生了事务提交的操作，都会把当前SqlSession的缓存清空。
两条SQL的下列五个值相同，即可以认为是相同的SQL。
StatementId&#43;Offset&#43;Limit&#43;Sql&#43;Params CacheKey cacheKey = new CacheKey(); //MappedStatement的id // id 就是Sql语句的所在位置 包名 &#43; 类名 &#43; SQL名称 cacheKey.update(ms.getId()); // offset 就是 0 cacheKey.update(rowBounds.getOffset()); // limit 就是 Integer.MAXVALUE cacheKey.update(rowBounds.getLimit()); // 具体的SQL语句 cacheKey.update(boundSql.getSql()); //后面是update了sql中带的参数 cacheKey.update(value); ... 如果以上的sqlSession与sql都是同一个，那么在第二次查询的时候就会是一级缓存，而不是执行数据库查询
具体的实现如下
@Test //	@Transactional public void testMybatis2(){ SqlSession sqlSession = factory.openSession(); SysQuartzJobLogMapper sysQuartzJobLogMapper1 = sqlSession.getMapper(SysQuartzJobLogMapper.class); SysQuartzJobLogMapper sysQuartzJobLogMapper2 = sqlSession.getMapper(SysQuartzJobLogMapper.class); List&lt;Map&lt;String, Object&gt;&gt; jobLogsById = sysQuartzJobLogMapper1.getJobLogsById(new Page&lt;&gt;(1, 10), &#34;23dedbb5-af24-11ec-a42d-0894ef72d9c4&#34;); System.out.println(jobLogsById.size() &#43; &#34;==&gt;&#34; &#43; jobLogsById); /*try { Thread." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/8dab0d2d75c568646b56e0a27fb6bf03/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-01T08:30:00+08:00" />
<meta property="article:modified_time" content="2023-05-01T08:30:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">mybatis缓存详解</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="mybatis_1"></a>mybatis的缓存</h3> 
<blockquote> 
 <p>mybatis的一级缓存是Session级别的缓存。一级缓存的作用域默认是一个SqlSession。Mybatis默认开启一级缓存。</p> 
</blockquote> 
<blockquote> 
 <p>在同一个SqlSession中，执行相同的查询SQL，第一次会去数据库进行查询，并把对象放入缓存中，第二次以后是直接去缓存中取。当执行SQL查询中间发生了事务提交的操作，都会把当前SqlSession的缓存清空。</p> 
</blockquote> 
<blockquote> 
 <p>两条SQL的下列五个值相同，即可以认为是相同的SQL。</p> 
</blockquote> 
<pre><code class="prism language-sql">StatementId<span class="token operator">+</span><span class="token keyword">Offset</span><span class="token operator">+</span><span class="token keyword">Limit</span><span class="token operator">+</span><span class="token keyword">Sql</span><span class="token operator">+</span>Params
</code></pre> 
<pre><code class="prism language-sql">CacheKey cacheKey <span class="token operator">=</span> new CacheKey<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//MappedStatement的id</span>
<span class="token comment">// id 就是Sql语句的所在位置 包名 + 类名 + SQL名称</span>
cacheKey<span class="token punctuation">.</span><span class="token keyword">update</span><span class="token punctuation">(</span>ms<span class="token punctuation">.</span>getId<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// offset 就是 0</span>
cacheKey<span class="token punctuation">.</span><span class="token keyword">update</span><span class="token punctuation">(</span>rowBounds<span class="token punctuation">.</span>getOffset<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// limit 就是 Integer.MAXVALUE</span>
cacheKey<span class="token punctuation">.</span><span class="token keyword">update</span><span class="token punctuation">(</span>rowBounds<span class="token punctuation">.</span>getLimit<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 具体的SQL语句</span>
cacheKey<span class="token punctuation">.</span><span class="token keyword">update</span><span class="token punctuation">(</span>boundSql<span class="token punctuation">.</span>getSql<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//后面是update了sql中带的参数</span>
cacheKey<span class="token punctuation">.</span><span class="token keyword">update</span><span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

</code></pre> 
<blockquote> 
 <p>如果以上的sqlSession与sql都是同一个，那么在第二次查询的时候就会是一级缓存，而不是执行数据库查询</p> 
</blockquote> 
<blockquote> 
 <p>具体的实现如下</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token comment">//	@Transactional</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testMybatis2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token class-name">SqlSession</span> sqlSession <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">SysQuartzJobLogMapper</span> sysQuartzJobLogMapper1 <span class="token operator">=</span> sqlSession<span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token class-name">SysQuartzJobLogMapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">SysQuartzJobLogMapper</span> sysQuartzJobLogMapper2 <span class="token operator">=</span> sqlSession<span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token class-name">SysQuartzJobLogMapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> jobLogsById <span class="token operator">=</span> sysQuartzJobLogMapper1<span class="token punctuation">.</span><span class="token function">getJobLogsById</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"23dedbb5-af24-11ec-a42d-0894ef72d9c4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jobLogsById<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"==&gt;"</span> <span class="token operator">+</span> jobLogsById<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">/*try {
			Thread.sleep(10000);
		} catch (InterruptedException e) {
			e.printStackTrace();
		}*/</span>
		<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> jobLogsById2 <span class="token operator">=</span> sysQuartzJobLogMapper2<span class="token punctuation">.</span><span class="token function">getJobLogsById</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"23dedbb5-af24-11ec-a42d-0894ef72d9c4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jobLogsById2<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"==&gt;"</span> <span class="token operator">+</span> jobLogsById2<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/13/c2/GztSDAGv_o.png" alt="image-20220409123130647"></p> 
<p>注意⚠️：从截图中可以看出来，打印sql执行只打印了一次，而第二次直接输出结果，说明是直接从缓存中查出来的，这里还需要注意的是使用的sqlSeeion来获取的相关mapper。</p> 
<blockquote> 
 <p>如果使用的是springbean的方式来获取mapper</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token comment">//	@Transactional</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testMybatis2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token comment">/*SqlSession sqlSession = factory.openSession();
		SysQuartzJobLogMapper sysQuartzJobLogMapper1 = sqlSession.getMapper(SysQuartzJobLogMapper.class);
		SysQuartzJobLogMapper sysQuartzJobLogMapper2 = sqlSession.getMapper(SysQuartzJobLogMapper.class);*/</span>

		<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> jobLogsById <span class="token operator">=</span> sysQuartzJobLogMapper<span class="token punctuation">.</span><span class="token function">getJobLogsById</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"23dedbb5-af24-11ec-a42d-0894ef72d9c4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jobLogsById<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"==&gt;"</span> <span class="token operator">+</span> jobLogsById<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">/*try {
			Thread.sleep(10000);
		} catch (InterruptedException e) {
			e.printStackTrace();
		}*/</span>
		<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> jobLogsById2 <span class="token operator">=</span> sysQuartzJobLogMapper<span class="token punctuation">.</span><span class="token function">getJobLogsById</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"23dedbb5-af24-11ec-a42d-0894ef72d9c4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jobLogsById2<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"==&gt;"</span> <span class="token operator">+</span> jobLogsById2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/b6/bb/WtFjSrIs_o.png" alt="image-20220409124143863"></p> 
<p>注意⚠️：可以从执行结果来看，这里其实用到的是同一个sql，导致mybatis一级缓存失效的原因是两个SqlSession，可以发现这里是创建了两个SqlSession。</p> 
<p>然后如果在这个测试类上加入@Transactional注解的时候发现他又可以使用一级缓存了。</p> 
<blockquote> 
 <p>原因分析</p> 
</blockquote> 
<blockquote> 
 <p><strong>结论</strong>：Spring将MyBatis的DefaultSqlSession类替换成了SqlSessionTemplate。</p> 
 <p>MyBatis的一级缓存是基于SqlSession来实现的，对应MyBatis中sqlSession接口的默认实现类是DefaultSqlSession，如果执行的SQL相同时，并且使用的是同一个SqlSession对象，那么就会触发对应的缓存机制。</p> 
 <p>但是在Spring整合MyBatis后，Spring使用MyBatis不再是直接调用MyBatis中的信息，而是通过调用调用mybatis-spring.jar中的类，继而达到间接调用MyBatis的效果。但在mybatis-spring.jar中，引入了一个SqlSessionTemplate类，它和Spring的事务管理器共同配合，创建对应的SqlSession连接。</p> 
 <p>即在没有添加@Transactional注解的情况下，每调用一次查询SQL，就会通过SqlSessionTemplate去创建sqlSession，即相当于新创建一次连接，故而每次查询在调试结果看来就是一级缓存失效。</p> 
</blockquote> 
<blockquote> 
 <p>除此之外如果是在mysql中操作删除或者更新数据，那么就会造成两次获取到的数据不一致</p> 
</blockquote> 
<p>并且在我看来这个一级缓存是没什么意义的，因为一般不会在同一个方法中会调用某个方法两次。</p> 
<blockquote> 
 <p>mybatis的二级缓存，针对的是mapper，或者也可以说是sqlFactory</p> 
</blockquote> 
<p>首先说一下他的配置</p> 
<p>在配置文件中加入这句话</p> 
<pre><code class="prism language-xml">mybatis-plus.configuration.cache-enabled=true
</code></pre> 
<p>然后在你想要开启二级缓存的mapper中加入</p> 
<pre><code class="prism language-xml">	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>cache</span><span class="token punctuation">/&gt;</span></span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1e6c3f5829f4b0ca5ca2db65afffc93e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">2021-06-02 Multisim 14.0 74LS160异步21进制74LS161组成61进制160与161的区别154显示193加减</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/344412c3f4e62710fd820c9827366a7e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">诛仙422单机版局域网联机方法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>