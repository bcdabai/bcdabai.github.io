<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>go-prometheus业务监控指标实战(一) - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="go-prometheus业务监控指标实战(一)" />
<meta property="og:description" content="go-prometheus业务监控指标实战(一) prometheus简介 Prometheus 是一个使用go语言编写的开源系统监控和告警工具包，其开发者和用户社区非常活跃，在GitHub现在是一个独立的开源项目，prometheus生态非常丰富，已经衍生出很多工具包，其中大部分都是用go语言编写的。主要有 Prometheus Server 作为服务端，用来存储时间序列数据。Exporter 用来监控 HAProxy，StatsD，Graphite 等特殊的监控目标，并向 Prometheus 提供标准格式的监控样本数据。alartmanager 用来处理告警。除此之外，官方还提供了各种语言的sdk进行接入，python,java,go等
参考学习资料 官方文档
中文文档
go_client文档
代码地址 gitee
prometheus安装 安装说明 版本：prometheus-2.35.0机器：ubuntu虚拟机，通过静态ip 192.168.64.2 和本机相连
使用静态ip端口占用，默认是9090 安装 下载-地址(不同操作系统包不同) wget https://github.com/prometheus/prometheus/releases/download/v2.35.0/prometheus-2.35.0.linux-amd64.tar.gz 解压 tar -zxvf prometheus-2.35.0.linux-amd64.tar.gz 当前目录结构 配置文件 prometheus.yml 主要关注这一块，job_name即任务名，不重复就行，默认prometheus会有一个任务就是，监控当前自己这个server实例的信息，监控指标的采集方式就是通过 targets 中配置的url地址 path默认是 /metrics
启动 ./prometheus --config.file=prometheus.yml 验证 http://192.168.64.2:9090/metrics 可正常访问，该页面为prometheus采集监控指标的urlhttp://192.168.64.2:9090/ 可以访问到prometheus提供的web界面 如果出现访问不通的情况，可以检查是否是防火墙拦截的相应端口，如果你使用的是云服务器，查看一下是否是安全组没有开对应端口的策略
web界面简单介绍 此处标识当前这台 server 采集了哪几个job，就是在上面prometheus.yml 配置文件中进行配置的
此界面可以对采集到的监控指标进行图表绘制
模型-指标类型介绍 模型 Prometheus 所有采集的监控数据均以指标（metric）的形式保存在内置的时间序列数据库当中（TSDB）：属于同一指标名称，同一标签集合的、有时间戳标记的数据流。除了存储的时间序列，Prometheus 还可以根据查询请求产生临时的、衍生的时间序列作为返回结果。
在时间序列中的每一个点称为一个样本（sample），样本由以下三部分组成
指标（metric）：指标名称和描述当前样本特征的 labelsets；时间戳（timestamp）：一个精确到毫秒的时间戳；样本值（value）： 一个 folat64 的浮点型数据表示当前样本的值。 指标类型 Prometheus 的客户端库中提供了四种核心的指标类型。但这些类型只是在客户端库（客户端可以根据不同的数据类型调用不同的 API 接口）和在线协议中，实际在 Prometheus server 中并不对指标类型进行区分，而是简单地把这些指标统一视为无类型的时间序列。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/9af0a60cb7780d66f4afff68ca29f65c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-06-04T19:32:46+08:00" />
<meta property="article:modified_time" content="2022-06-04T19:32:46+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">go-prometheus业务监控指标实战(一)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="goprometheus_0"></a>go-prometheus业务监控指标实战(一)</h2> 
<h3><a id="prometheus_1"></a>prometheus简介</h3> 
<blockquote> 
 <p>Prometheus 是一个使用go语言编写的开源系统监控和告警工具包，其开发者和用户社区非常活跃，在<a href="https://github.com/prometheus">GitHub</a>现在是一个独立的开源项目，prometheus生态非常丰富，已经衍生出很多工具包，其中大部分都是用go语言编写的。主要有 <a href="https://github.com/prometheus/prometheus">Prometheus Server</a> 作为服务端，用来存储时间序列数据。<a href="https://github.com/prometheus/node_exporter">Exporter</a> 用来监控 HAProxy，StatsD，Graphite 等特殊的监控目标，并向 Prometheus 提供标准格式的监控样本数据。<a href="https://github.com/prometheus/alertmanager">alartmanager</a> 用来处理告警。除此之外，官方还提供了各种语言的sdk进行接入，python,java,go等</p> 
</blockquote> 
<h4><a id="_3"></a>参考学习资料</h4> 
<p><a href="https://prometheus.io/docs/introduction/overview/" rel="nofollow">官方文档</a><br> <a href="https://prometheus.fuckcloudnative.io/di-yi-zhang-jie-shao/overview" rel="nofollow">中文文档</a><br> <a href="https://pkg.go.dev/github.com/prometheus/client_golang" rel="nofollow">go_client文档</a></p> 
<h4><a id="_7"></a>代码地址</h4> 
<p><a href="https://gitee.com/qzcsu/go-web-study/tree/prometheus/" rel="nofollow">gitee</a></p> 
<h3><a id="prometheus_9"></a>prometheus安装</h3> 
<h4><a id="_10"></a>安装说明</h4> 
<ul><li>版本：prometheus-2.35.0</li><li>机器：ubuntu虚拟机，通过静态ip 192.168.64.2 和本机相连<br> <img src="https://images2.imgbox.com/b9/e6/LPvPltAi_o.png" alt="在这里插入图片描述"></li><li>使用静态ip</li><li>端口占用，默认是9090</li></ul> 
<h4><a id="_17"></a>安装</h4> 
<h5><a id="httpsprometheusiodownload_18"></a>下载-<a href="https://prometheus.io/download/" rel="nofollow">地址</a>(不同操作系统包不同)</h5> 
<pre><code class="prism language-bash"><span class="token function">wget</span> https://github.com/prometheus/prometheus/releases/download/v2.35.0/prometheus-2.35.0.linux-amd64.tar.gz
</code></pre> 
<h5><a id="_22"></a>解压</h5> 
<pre><code class="prism language-bash"><span class="token function">tar</span> -zxvf prometheus-2.35.0.linux-amd64.tar.gz
</code></pre> 
<h5><a id="_26"></a>当前目录结构</h5> 
<p><img src="https://images2.imgbox.com/4e/fd/VVaElWew_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_prometheusyml_28"></a>配置文件 prometheus.yml</h5> 
<p><img src="https://images2.imgbox.com/95/ae/CRRSwQF8_o.png" alt="在这里插入图片描述"><br> 主要关注这一块，job_name即任务名，不重复就行，默认prometheus会有一个任务就是，监控当前自己这个server实例的信息，监控指标的采集方式就是通过 targets 中配置的url地址 path默认是 /metrics</p> 
<h5><a id="_32"></a>启动</h5> 
<pre><code class="prism language-bash">./prometheus --config.file<span class="token operator">=</span>prometheus.yml
</code></pre> 
<h5><a id="_36"></a>验证</h5> 
<ol><li>http://192.168.64.2:9090/metrics 可正常访问，该页面为prometheus采集监控指标的url</li><li>http://192.168.64.2:9090/ 可以访问到prometheus提供的web界面</li></ol> 
<p><strong>如果出现访问不通的情况，可以检查是否是防火墙拦截的相应端口，如果你使用的是云服务器，查看一下是否是安全组没有开对应端口的策略</strong></p> 
<h5><a id="web_42"></a>web界面简单介绍</h5> 
<p>此处标识当前这台 server 采集了哪几个job，就是在上面prometheus.yml 配置文件中进行配置的<br> <img src="https://images2.imgbox.com/d7/8b/OZ8BOpPp_o.png" alt="在这里插入图片描述"><br> 此界面可以对采集到的监控指标进行图表绘制<br> <img src="https://images2.imgbox.com/e8/91/ii5urUvb_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_48"></a>模型-指标类型介绍</h3> 
<h4><a id="_49"></a>模型</h4> 
<blockquote> 
 <p>Prometheus 所有采集的监控数据均以指标（metric）的形式保存在内置的时间序列数据库当中（TSDB）：属于同一指标名称，同一标签集合的、有时间戳标记的数据流。除了存储的时间序列，Prometheus 还可以根据查询请求产生临时的、衍生的时间序列作为返回结果。</p> 
</blockquote> 
<p>在时间序列中的每一个点称为一个样本（sample），样本由以下三部分组成</p> 
<ul><li>指标（metric）：指标名称和描述当前样本特征的 labelsets；</li><li>时间戳（timestamp）：一个精确到毫秒的时间戳；</li><li>样本值（value）： 一个 folat64 的浮点型数据表示当前样本的值。</li></ul> 
<h4><a id="_56"></a>指标类型</h4> 
<p>Prometheus 的客户端库中提供了四种核心的指标类型。但这些类型只是在客户端库（客户端可以根据不同的数据类型调用不同的 API 接口）和在线协议中，实际在 Prometheus server 中并不对指标类型进行区分，而是简单地把这些指标统一视为无类型的时间序列。</p> 
<h5><a id="Counter__58"></a>Counter 计数器</h5> 
<p>Counter 类型代表一种样本数据单调递增的指标，即只增不减。除非监控系统发生了重置。例如，你可以使用 counter 类型的指标来表示服务的请求数、已完成的任务数、错误发生的次数等。不要将 counter 类型应用于样本数据非单调递增的指标，例如：当前运行的进程数量（应该用 Gauge 类型）。</p> 
<h5><a id="Gauge__60"></a>Gauge 仪表盘</h5> 
<p>Gauge 类型代表一种样本数据可以任意变化的指标，即可增可减。Gauge 通常用于像温度或者内存使用率这种指标数据，也可以表示能随时增加或减少的“总数”，例如：当前并发请求的数量。</p> 
<h5><a id="Histogram__62"></a>Histogram 直方图</h5> 
<p>在大多数情况下人们都倾向于使用某些量化指标的平均值，例如 CPU 的平均使用率、页面的平均响应时间。这种方式的问题很明显，以系统 API 调用的平均响应时间为例：如果大多数 API 请求都维持在 100ms 的响应时间范围内，而个别请求的响应时间需要 5s，那么就会导致某些 WEB 页面的响应时间落到中位数的情况，而这种现象被称为长尾问题。<br> 为了区分是平均的慢还是长尾的慢，最简单的方式就是按照请求延迟的范围进行分组。例如，统计延迟在 0~10ms 之间的请求数有多少而 10~20ms 之间的请求数又有多少。通过这种方式可以快速分析系统慢的原因。Histogram 和 Summary 都是为了能够解决这样问题的存在，通过 Histogram 和 Summary 类型的监控指标，我们可以快速了解监控样本的分布情况。<br> Histogram 在一段时间范围内对数据进行采样（通常是请求持续时间或响应大小等），并将其计入可配置的存储桶（bucket）中，后续可通过指定区间筛选样本，也可以统计样本总数，最后一般将数据展示为直方图。<br> Histogram 类型的样本会提供三种指标（假设指标名称为 &lt;metrices_name&gt;）：</p> 
<ul><li>样本的值分布在 bucket 中的数量，命名为 &lt;metrices_name&gt;_bucket{le=“&lt;上边界&gt;”}。解释的更通俗易懂一点，这个值表示指标值小于等于上边界的所有样本数量。 请求响应时间 &lt;=0.005 秒 的请求次数。</li><li>所有样本值的大小总和，命名为 &lt;metrices_name&gt;_sum：所有请求响应时间总和</li><li>样本总数，命名为 &lt;metrices_name&gt;_count。值和 &lt;metrices_name&gt;_bucket{le=“+Inf”} 相同。所有请求次数</li></ul> 
<h5><a id="Summary__71"></a>Summary 摘要</h5> 
<p>与 Histogram 类型类似，用于表示一段时间内的数据采样结果（通常是请求持续时间或响应大小等），但它直接存储了分位数（通过客户端计算，然后展示出来），而不是通过区间来计算。Summary 类型的样本也会提供三种指标（假设指标名称为 ）：</p> 
<ul><li>样本值的分位数分布情况，命名为 &lt;metrices_name&gt;{quantile=“0.5”} 请求中有 50% 的请求响应时间值是</li><li>所有样本值的大小总和，命名为 &lt;metrices_name&gt;_sum 所有请求响应时间总和</li><li>样本总数，命名为 &lt;metrices_name&gt;_count 请求的总数</li></ul> 
<p>Histogram 与 Summary 的异同：<br> 它们都包含了 &lt;metrices_name&gt;_sum 和 &lt;metrices_name&gt;_count 指标<br> Histogram 需要通过 &lt;metrices_name&gt;_bucket 来计算分位数，而 Summary 则直接存储了分位数的值。</p> 
<h3><a id="go_sdk_81"></a>go sdk实战</h3> 
<h4><a id="_82"></a>准备工作</h4> 
<ol><li>在Prometheus配置文件中添加新的job配置本机地址<br> <img src="https://images2.imgbox.com/e8/74/zGAIBdGC_o.png" alt="在这里插入图片描述"></li><li>重启Prometheus</li><li>查看是否job监控成功<br> <img src="https://images2.imgbox.com/85/a2/cjt1kVjd_o.png" alt="在这里插入图片描述"></li><li>实际是从web服务的这个path中获取监控指标信息<br> <img src="https://images2.imgbox.com/f2/1b/KW6nlnET_o.png" alt="在这里插入图片描述"></li></ol> 
<h4><a id="1_Counter_nameagelabel_91"></a>案例1 Counter 统计班级人数，每个人有name和age两个属性(label)</h4> 
<h5><a id="maingo_92"></a>main.go</h5> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"net/http"</span>

	qzPro <span class="token string">"gitee.com/qzcsu/go-web-study/service/prometheus"</span>
	<span class="token string">"github.com/prometheus/client_golang/prometheus"</span>
	<span class="token string">"github.com/prometheus/client_golang/prometheus/promhttp"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	prometheus<span class="token punctuation">.</span><span class="token function">MustRegister</span><span class="token punctuation">(</span>qzPro<span class="token punctuation">.</span>CommonCounter<span class="token punctuation">,</span> qzPro<span class="token punctuation">.</span>FuncCounter<span class="token punctuation">,</span> qzPro<span class="token punctuation">.</span>VecCounter<span class="token punctuation">)</span>
	http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">"/common_counter"</span><span class="token punctuation">,</span> qzPro<span class="token punctuation">.</span>DealCommCounter<span class="token punctuation">)</span>
	http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">"/vec_counter"</span><span class="token punctuation">,</span> qzPro<span class="token punctuation">.</span>DealVecCounter<span class="token punctuation">)</span>
	http<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span><span class="token string">"/metrics"</span><span class="token punctuation">,</span> promhttp<span class="token punctuation">.</span><span class="token function">Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token string">":8090"</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre> 
<h5><a id="span_id__constants_goserviceprometheusconstantsgospan_113"></a><span id="constants_go">service/prometheus/constants.go</span></h5> 
<pre><code class="prism language-go"><span class="token comment">// service/prometheus/constants.go</span>
<span class="token keyword">package</span> prometheus

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"net/http"</span>
	<span class="token string">"strconv"</span>
	
	<span class="token string">"gitee.com/qzcsu/go-web-study/utils/randomutil"</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
	namePrefix <span class="token operator">=</span> <span class="token string">"the_number_of_student"</span>
	subSys     <span class="token operator">=</span> <span class="token string">"client_golang"</span>
	nameSpace  <span class="token operator">=</span> <span class="token string">"prometheus_demo"</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span><span class="token string">"小明"</span><span class="token punctuation">,</span> <span class="token string">"小红"</span><span class="token punctuation">,</span> <span class="token string">"小花"</span><span class="token punctuation">}</span>
<span class="token keyword">var</span> ages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int64</span><span class="token punctuation">{<!-- --></span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">GetParamNum</span><span class="token punctuation">(</span>req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token builtin">int64</span> <span class="token punctuation">{<!-- --></span>
	err <span class="token operator">:=</span> req<span class="token punctuation">.</span><span class="token function">ParseForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"parse form err"</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token number">0</span>
	<span class="token punctuation">}</span>
	numStr <span class="token operator">:=</span> req<span class="token punctuation">.</span>Form<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"num"</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"numStr:[%v]\n"</span><span class="token punctuation">,</span> numStr<span class="token punctuation">)</span>
	num<span class="token punctuation">,</span> err <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseInt</span><span class="token punctuation">(</span>numStr<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"parse int err :%v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token number">0</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> num
<span class="token punctuation">}</span>

<span class="token comment">// randData随机获取一个元素，并且将本次请求的随机元素统计到countStrMap</span>
<span class="token keyword">func</span> <span class="token function">getCurRandomStrMap</span><span class="token punctuation">(</span>countStrMap <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int64</span><span class="token punctuation">,</span> randData <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
	index <span class="token operator">:=</span> randomutil<span class="token punctuation">.</span><span class="token function">RandomNum</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>randData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	randVal <span class="token operator">:=</span> randData<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
	countStrMap<span class="token punctuation">[</span>randVal<span class="token punctuation">]</span> <span class="token operator">=</span> countStrMap<span class="token punctuation">[</span>randVal<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span>
	<span class="token keyword">return</span> randVal
<span class="token punctuation">}</span>

<span class="token comment">// randData随机获取一个元素，并且将本次请求的随机元素统计到countIntMap</span>
<span class="token keyword">func</span> <span class="token function">getCurRandomIntMap</span><span class="token punctuation">(</span>countIntMap <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int64</span><span class="token punctuation">]</span><span class="token builtin">int64</span><span class="token punctuation">,</span> randData <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
	index <span class="token operator">:=</span> randomutil<span class="token punctuation">.</span><span class="token function">RandomNum</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>randData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	randVal <span class="token operator">:=</span> randData<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
	countIntMap<span class="token punctuation">[</span>randVal<span class="token punctuation">]</span> <span class="token operator">=</span> countIntMap<span class="token punctuation">[</span>randVal<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span>
	<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> randVal<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="serviceprometheuscoutergo_167"></a>service/prometheus/couter.go</h5> 
<pre><code class="prism language-go"><span class="token comment">// service/prometheus/couter.go</span>
<span class="token keyword">package</span> prometheus

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"net/http"</span>
	<span class="token string">"sync/atomic"</span>
	<span class="token string">"time"</span>

	<span class="token string">"github.com/prometheus/client_golang/prometheus"</span>

	<span class="token string">"gitee.com/qzcsu/go-web-study/utils/randomutil"</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> counterNamePrefix <span class="token operator">=</span> namePrefix <span class="token operator">+</span> <span class="token string">"_counter"</span>

<span class="token comment">// CommonCounter 普通的计数器</span>
<span class="token keyword">var</span> commonCounterTotalCount <span class="token builtin">int64</span>
<span class="token keyword">var</span> CommonCounter <span class="token operator">=</span> prometheus<span class="token punctuation">.</span><span class="token function">NewCounter</span><span class="token punctuation">(</span>
	prometheus<span class="token punctuation">.</span>CounterOpts<span class="token punctuation">{<!-- --></span>
		Subsystem<span class="token punctuation">:</span> subSys<span class="token punctuation">,</span>
		Namespace<span class="token punctuation">:</span> nameSpace<span class="token punctuation">,</span>
		Help<span class="token punctuation">:</span>      <span class="token string">"desc the metric"</span><span class="token punctuation">,</span>
		Name<span class="token punctuation">:</span>      fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%s:%s"</span><span class="token punctuation">,</span> counterNamePrefix<span class="token punctuation">,</span> <span class="token string">"common"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token comment">//ConstLabels: map[string]string{"name":"555"}, // 每个打点必定会带这个label</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

<span class="token comment">// 有自己的计算函数的计数器，但是要保证递增，只有在客户端来拉去这个指标的时候才会触发这个函数计算获取最新的指标值</span>
<span class="token keyword">var</span> funcCounterTotalCount <span class="token builtin">int64</span>
<span class="token keyword">var</span> FuncCounter <span class="token operator">=</span> prometheus<span class="token punctuation">.</span><span class="token function">NewCounterFunc</span><span class="token punctuation">(</span>prometheus<span class="token punctuation">.</span>CounterOpts<span class="token punctuation">{<!-- --></span>
	Subsystem<span class="token punctuation">:</span> subSys<span class="token punctuation">,</span>
	Namespace<span class="token punctuation">:</span> nameSpace<span class="token punctuation">,</span>
	Name<span class="token punctuation">:</span>      fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%s:%s"</span><span class="token punctuation">,</span> counterNamePrefix<span class="token punctuation">,</span> <span class="token string">"func"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">float64</span> <span class="token punctuation">{<!-- --></span>
	delta <span class="token operator">:=</span> randomutil<span class="token punctuation">.</span><span class="token function">RandomNum</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">// 模拟随机增长步长 0|1|2</span>
	newNum <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">AddInt64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>funcCounterTotalCount<span class="token punctuation">,</span> delta<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token function">float64</span><span class="token punctuation">(</span>newNum<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// VecCounter 带有 "name", "age" 标签的计数器</span>
<span class="token keyword">var</span> vecCounterTotalCount <span class="token builtin">int64</span>
<span class="token keyword">var</span> VecCounter <span class="token operator">=</span> prometheus<span class="token punctuation">.</span><span class="token function">NewCounterVec</span><span class="token punctuation">(</span>
	prometheus<span class="token punctuation">.</span>CounterOpts<span class="token punctuation">{<!-- --></span>
		Subsystem<span class="token punctuation">:</span> subSys<span class="token punctuation">,</span>
		Namespace<span class="token punctuation">:</span> nameSpace<span class="token punctuation">,</span>
		Name<span class="token punctuation">:</span>      fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%s:%s"</span><span class="token punctuation">,</span> counterNamePrefix<span class="token punctuation">,</span> <span class="token string">"vec"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"age"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">DealCommCounter</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	dealCount <span class="token operator">:=</span> <span class="token function">GetParamNum</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
	<span class="token keyword">var</span> curDealCount <span class="token builtin">int64</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		ticker <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTicker</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
			<span class="token operator">&lt;-</span>ticker<span class="token punctuation">.</span>C
			CommonCounter<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			curDealCount<span class="token operator">++</span>
			atomic<span class="token punctuation">.</span><span class="token function">AddInt64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>commonCounterTotalCount<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"commonCounterTotalCount:%v,curDealCount:%v\n"</span><span class="token punctuation">,</span> commonCounterTotalCount<span class="token punctuation">,</span> curDealCount<span class="token punctuation">)</span>
			<span class="token keyword">if</span> curDealCount <span class="token operator">==</span> dealCount <span class="token punctuation">{<!-- --></span>
				fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"DealCounter结束"</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"DealCommCounter done !!!"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">DealVecCounter</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	dealCount <span class="token operator">:=</span> <span class="token function">GetParamNum</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
	<span class="token keyword">var</span> curDealCount <span class="token builtin">int64</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		ticker <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTicker</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
		thisNameMap <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int64</span><span class="token punctuation">)</span>
		thisAgeMap <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int64</span><span class="token punctuation">]</span><span class="token builtin">int64</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
			<span class="token operator">&lt;-</span>ticker<span class="token punctuation">.</span>C
			nameStr <span class="token operator">:=</span> <span class="token function">getCurRandomStrMap</span><span class="token punctuation">(</span>thisNameMap<span class="token punctuation">,</span> names<span class="token punctuation">)</span>
			ageStr <span class="token operator">:=</span> <span class="token function">getCurRandomIntMap</span><span class="token punctuation">(</span>thisAgeMap<span class="token punctuation">,</span> ages<span class="token punctuation">)</span>
			VecCounter<span class="token punctuation">.</span><span class="token function">With</span><span class="token punctuation">(</span>prometheus<span class="token punctuation">.</span>Labels<span class="token punctuation">{<!-- --></span><span class="token string">"name"</span><span class="token punctuation">:</span> nameStr<span class="token punctuation">,</span> <span class="token string">"age"</span><span class="token punctuation">:</span> ageStr<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			curDealCount<span class="token operator">++</span>
			atomic<span class="token punctuation">.</span><span class="token function">AddInt64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>vecCounterTotalCount<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"vecCounterTotalCount:%v,curDealCount:%v, nameMap:%v, ageMap:%v\n"</span><span class="token punctuation">,</span> vecCounterTotalCount<span class="token punctuation">,</span> curDealCount<span class="token punctuation">,</span> thisNameMap<span class="token punctuation">,</span> thisAgeMap<span class="token punctuation">)</span>
			<span class="token keyword">if</span> curDealCount <span class="token operator">==</span> dealCount <span class="token punctuation">{<!-- --></span>
				fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"DealVecCounter结束"</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"DealVecCounter done !!!"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_262"></a>测试</h5> 
<ul><li>http请求访问触发打点统计，由请求参数num决定本次请求要增加的打点总数，每次打点会睡眠3s</li><li>vec_counter每次请求都会带上label，label的name和age取值来源于以下两个数组的随机取值，定义在constant.go中 
  <ul><li>var names = []string{“小明”, “小红”, “小花”}</li><li>var ages = []int64{20, 21, 22, 23, 24, 25}</li></ul> </li><li>http://localhost:8090/vec_counter?num=10 带tag的打点</li><li>http://localhost:8090/common_counter?num=10</li><li>http://localhost:8090/metrics 可查看对应指标现在的打点次数</li><li>metric的命名为 namespace_subsystem_name 本次测试的 nameSpace=prometheus_demo，subsystem=client_golang，name=the_number_of_people_couter:[common|func|vec]</li></ul> 
<p>分别访问http://localhost:8090/vec_counter?num=10 和 http://localhost:8090/common_counter?num=10 一次 然后浏览器查看指标 http://localhost:8090/metrics 查看指标<img src="https://images2.imgbox.com/f3/1d/lj38nGnB_o.png" alt="在这里插入图片描述"><br> prometheus_demo_client_golang_the_number_of_people_counter:func 值为4的原因是每次来查询一下metrics 则会触发一下查询函数，mock的函数中每次访问可能增加0,1,2的步长</p> 
<h4><a id="2_Gague_nameage_276"></a>案例2 Gague 模拟班级人员流动情况，每个人都有name,age属性</h4> 
<h5><a id="maingo_277"></a>main.go</h5> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"net/http"</span>

	qzPro <span class="token string">"gitee.com/qzcsu/go-web-study/service/prometheus"</span>
	<span class="token string">"github.com/prometheus/client_golang/prometheus"</span>
	<span class="token string">"github.com/prometheus/client_golang/prometheus/promhttp"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	prometheus<span class="token punctuation">.</span><span class="token function">MustRegister</span><span class="token punctuation">(</span>qzPro<span class="token punctuation">.</span>CommonCounter<span class="token punctuation">,</span> qzPro<span class="token punctuation">.</span>FuncCounter<span class="token punctuation">,</span> qzPro<span class="token punctuation">.</span>VecCounter<span class="token punctuation">,</span> qzPro<span class="token punctuation">.</span>CommonGauge<span class="token punctuation">,</span> qzPro<span class="token punctuation">.</span>FuncGauge<span class="token punctuation">,</span> qzPro<span class="token punctuation">.</span>VecGauge<span class="token punctuation">)</span>
	http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">"/common_counter"</span><span class="token punctuation">,</span> qzPro<span class="token punctuation">.</span>DealCommCounter<span class="token punctuation">)</span>
	http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">"/vec_counter"</span><span class="token punctuation">,</span> qzPro<span class="token punctuation">.</span>DealVecCounter<span class="token punctuation">)</span>
	http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">"/common_gauge"</span><span class="token punctuation">,</span> qzPro<span class="token punctuation">.</span>DealCommGauge<span class="token punctuation">)</span>
	http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">"/vec_gauge"</span><span class="token punctuation">,</span> qzPro<span class="token punctuation">.</span>DealVecGauge<span class="token punctuation">)</span>
	http<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span><span class="token string">"/metrics"</span><span class="token punctuation">,</span> promhttp<span class="token punctuation">.</span><span class="token function">Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token string">":8090"</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre> 
<h5><a id="serviceprometheusconstantsgo_300"></a>service/prometheus/constants.go</h5> 
<p><a href="#constants_go" rel="nofollow">见上</a></p> 
<h5><a id="serviceprometheusgaguego_302"></a>service/prometheus/gague.go</h5> 
<pre><code class="prism language-bash">package prometheus

<span class="token function">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"net/http"</span>
	<span class="token string">"sync/atomic"</span>
	<span class="token string">"time"</span>

	<span class="token string">"github.com/prometheus/client_golang/prometheus"</span>

	<span class="token string">"gitee.com/qzcsu/go-web-study/utils/randomutil"</span>
<span class="token punctuation">)</span>

const GaugeNamePrefix <span class="token operator">=</span> namePrefix + <span class="token string">"_gauge"</span>

// CommonGauge 普通的仪表盘
var commonGaugeTotalCount int64
var CommonGauge <span class="token operator">=</span> prometheus.NewGauge<span class="token punctuation">(</span>
	prometheus.GaugeOpts<span class="token punctuation">{<!-- --></span>
		Subsystem: subSys,
		Namespace: nameSpace,
		Help:      <span class="token string">"desc the metric"</span>,
		Name:      fmt.Sprintf<span class="token punctuation">(</span><span class="token string">"%s:%s"</span>, GaugeNamePrefix, <span class="token string">"common"</span><span class="token punctuation">)</span>,
	<span class="token punctuation">}</span>,
<span class="token punctuation">)</span>

// 有自己的计算函数的仪表盘，只有在客户端来拉去这个指标的时候才会触发这个函数计算获取最新的指标值
var funcGaugeTotalCount int64
var FuncGauge <span class="token operator">=</span> prometheus.NewGaugeFunc<span class="token punctuation">(</span>prometheus.GaugeOpts<span class="token punctuation">{<!-- --></span>
	Subsystem: subSys,
	Namespace: nameSpace,
	Name:      fmt.Sprintf<span class="token punctuation">(</span><span class="token string">"%s:%s"</span>, GaugeNamePrefix, <span class="token string">"func"</span><span class="token punctuation">)</span>,
<span class="token punctuation">}</span>, func<span class="token punctuation">(</span><span class="token punctuation">)</span> float64 <span class="token punctuation">{<!-- --></span>
	deltaVal :<span class="token operator">=</span> randomutil.RandomNum<span class="token punctuation">(</span><span class="token number">0</span>, <span class="token number">5</span><span class="token punctuation">)</span> // 模拟变动步长
	idx :<span class="token operator">=</span> randomutil.RandomNum<span class="token punctuation">(</span><span class="token number">0</span>, <span class="token number">3</span><span class="token punctuation">)</span>      // 模拟增加还是减少 <span class="token number">0</span>减少，1和2增加，整体保持一个增长趋势图会好看点
	var newNum int64
	<span class="token keyword">if</span> idx <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
		newNum <span class="token operator">=</span> atomic.AddInt64<span class="token punctuation">(</span><span class="token operator">&amp;</span>funcGaugeTotalCount, -deltaVal<span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		newNum <span class="token operator">=</span> atomic.AddInt64<span class="token punctuation">(</span><span class="token operator">&amp;</span>funcGaugeTotalCount, deltaVal<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token builtin class-name">return</span> float64<span class="token punctuation">(</span>newNum<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

// VecGauge 带有 <span class="token string">"name"</span>, <span class="token string">"age"</span> 标签的仪表盘
var vecGaugeTotalCount int64
var VecGauge <span class="token operator">=</span> prometheus.NewGaugeVec<span class="token punctuation">(</span>
	prometheus.GaugeOpts<span class="token punctuation">{<!-- --></span>
		Subsystem: subSys,
		Namespace: nameSpace,
		Name:      fmt.Sprintf<span class="token punctuation">(</span><span class="token string">"%s:%s"</span>, GaugeNamePrefix, <span class="token string">"vec"</span><span class="token punctuation">)</span>,
	<span class="token punctuation">}</span>, <span class="token punctuation">[</span><span class="token punctuation">]</span>string<span class="token punctuation">{<!-- --></span><span class="token string">"name"</span>, <span class="token string">"age"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

func DealCommGauge<span class="token punctuation">(</span>w http.ResponseWriter, req *http.Request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	dealCount :<span class="token operator">=</span> GetParamNum<span class="token punctuation">(</span>req<span class="token punctuation">)</span>
	var curDealCount int64
	go <span class="token function-name function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		ticker :<span class="token operator">=</span> time.NewTicker<span class="token punctuation">(</span><span class="token number">3</span> * time.Second<span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
			<span class="token operator">&lt;</span>-ticker.C
			idx :<span class="token operator">=</span> randomutil.RandomNum<span class="token punctuation">(</span><span class="token number">0</span>, <span class="token number">3</span><span class="token punctuation">)</span>      // 模拟变动步长
			deltaVal :<span class="token operator">=</span> randomutil.RandomNum<span class="token punctuation">(</span><span class="token number">0</span>, <span class="token number">5</span><span class="token punctuation">)</span> // 模拟增加还是减少 <span class="token number">0</span>减少，1和2增加
			<span class="token keyword">if</span> idx <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
				CommonGauge.Sub<span class="token punctuation">(</span>float64<span class="token punctuation">(</span>deltaVal<span class="token punctuation">))</span>
				atomic.AddInt64<span class="token punctuation">(</span><span class="token operator">&amp;</span>commonCounterTotalCount, -deltaVal<span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
				CommonGauge.Add<span class="token punctuation">(</span>float64<span class="token punctuation">(</span>deltaVal<span class="token punctuation">))</span>
				atomic.AddInt64<span class="token punctuation">(</span><span class="token operator">&amp;</span>commonCounterTotalCount, deltaVal<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			curDealCount++
			atomic.AddInt64<span class="token punctuation">(</span><span class="token operator">&amp;</span>commonGaugeTotalCount, <span class="token number">1</span><span class="token punctuation">)</span>
			fmt.Printf<span class="token punctuation">(</span><span class="token string">"commonGaugeTotalCount:%v,curDealCount:%v<span class="token entity" title="\n">\n</span>"</span>, commonGaugeTotalCount, curDealCount<span class="token punctuation">)</span>
			<span class="token keyword">if</span> curDealCount <span class="token operator">==</span> dealCount <span class="token punctuation">{<!-- --></span>
				fmt.Println<span class="token punctuation">(</span><span class="token string">"DealCounter结束"</span><span class="token punctuation">)</span>
				<span class="token builtin class-name">return</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt.Fprintf<span class="token punctuation">(</span>w, <span class="token string">"DealCommGauge done !!!"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

func DealVecGauge<span class="token punctuation">(</span>w http.ResponseWriter, req *http.Request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	dealCount :<span class="token operator">=</span> GetParamNum<span class="token punctuation">(</span>req<span class="token punctuation">)</span>
	var curDealCount int64
	go <span class="token function-name function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		ticker :<span class="token operator">=</span> time.NewTicker<span class="token punctuation">(</span><span class="token number">3</span> * time.Second<span class="token punctuation">)</span>
		thisNameMap :<span class="token operator">=</span> make<span class="token punctuation">(</span>map<span class="token punctuation">[</span>string<span class="token punctuation">]</span>int64<span class="token punctuation">)</span>
		thisAgeMap :<span class="token operator">=</span> make<span class="token punctuation">(</span>map<span class="token punctuation">[</span>int64<span class="token punctuation">]</span>int64<span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
			<span class="token operator">&lt;</span>-ticker.C
			idx :<span class="token operator">=</span> randomutil.RandomNum<span class="token punctuation">(</span><span class="token number">0</span>, <span class="token number">3</span><span class="token punctuation">)</span>
			deltaVal :<span class="token operator">=</span> randomutil.RandomNum<span class="token punctuation">(</span><span class="token number">0</span>, <span class="token number">5</span><span class="token punctuation">)</span>
			nameStr :<span class="token operator">=</span> getCurRandomStrMap<span class="token punctuation">(</span>thisNameMap, names<span class="token punctuation">)</span>
			ageStr :<span class="token operator">=</span> getCurRandomIntMap<span class="token punctuation">(</span>thisAgeMap, ages<span class="token punctuation">)</span>
			<span class="token keyword">if</span> idx <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
				VecGauge.With<span class="token punctuation">(</span>prometheus.Labels<span class="token punctuation">{<!-- --></span><span class="token string">"name"</span><span class="token builtin class-name">:</span> nameStr, <span class="token string">"age"</span><span class="token builtin class-name">:</span> ageStr<span class="token punctuation">}</span><span class="token punctuation">)</span>.Sub<span class="token punctuation">(</span>float64<span class="token punctuation">(</span>deltaVal<span class="token punctuation">))</span>
				atomic.AddInt64<span class="token punctuation">(</span><span class="token operator">&amp;</span>vecGaugeTotalCount, -deltaVal<span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
				VecGauge.With<span class="token punctuation">(</span>prometheus.Labels<span class="token punctuation">{<!-- --></span><span class="token string">"name"</span><span class="token builtin class-name">:</span> nameStr, <span class="token string">"age"</span><span class="token builtin class-name">:</span> ageStr<span class="token punctuation">}</span><span class="token punctuation">)</span>.Add<span class="token punctuation">(</span>float64<span class="token punctuation">(</span>deltaVal<span class="token punctuation">))</span>
				atomic.AddInt64<span class="token punctuation">(</span><span class="token operator">&amp;</span>vecGaugeTotalCount, deltaVal<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			curDealCount++
			atomic.AddInt64<span class="token punctuation">(</span><span class="token operator">&amp;</span>vecGaugeTotalCount, <span class="token number">1</span><span class="token punctuation">)</span>
			fmt.Printf<span class="token punctuation">(</span><span class="token string">"vecGaugeTotalCount:%v,curDealCount:%v, nameMap:%v, ageMap:%v<span class="token entity" title="\n">\n</span>"</span>, vecGaugeTotalCount, curDealCount, thisNameMap, thisAgeMap<span class="token punctuation">)</span>
			<span class="token keyword">if</span> curDealCount <span class="token operator">==</span> dealCount <span class="token punctuation">{<!-- --></span>
				fmt.Println<span class="token punctuation">(</span><span class="token string">"DealVecCounter结束"</span><span class="token punctuation">)</span>
				<span class="token builtin class-name">return</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt.Fprintf<span class="token punctuation">(</span>w, <span class="token string">"DealVecGauge done !!!"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre> 
<h5><a id="_419"></a>测试</h5> 
<ul><li>同Counter一样，gague每次打点处理都是定时器3秒一次</li><li>同样测试的是三个函数 gague、gagueFunc、gagueVec</li><li>gague由于是可增加可减少，因此用了随机函 idx := randomutil.RandomNum(0, 3) 生成 0,1,2来模拟增减，0为减，1,2为增加，因此大概率上是为正累加。使用另外一个函数模拟变动步长deltaVal := randomutil.RandomNum(0, 5)。</li><li>三个metric 
  <ul><li>prometheus_demo_client_golang_the_number_of_people_gauge:common</li><li>prometheus_demo_client_golang_the_number_of_people_gauge:func</li><li>prometheus_demo_client_golang_the_number_of_people_gauge:vec</li></ul> </li></ul> 
<ol><li>先访问 http://localhost:8090/vec_gauge?num=10</li><li>在访问 http://localhost:8090/common_gauge?num=10</li><li>最后验证 http://localhost:8090/metrics<br> <img src="https://images2.imgbox.com/c5/11/5LQ033MV_o.png" alt="在这里插入图片描述"></li></ol> 
<h3><a id="grafana_432"></a>grafana配置指标面板</h3> 
<h4><a id="grafana__433"></a>grafana 安装</h4> 
<h5><a id="_434"></a>下载</h5> 
<pre><code class="prism language-bash"><span class="token function">wget</span> https://dl.grafana.com/enterprise/release/grafana-enterprise-8.5.1.linux-amd64.tar.gz
</code></pre> 
<h5><a id="_439"></a>解压</h5> 
<pre><code class="prism language-bash"><span class="token function">tar</span> -zxvf grafana-enterprise-8.5.1.linux-amd64.tar.gz
</code></pre> 
<h5><a id="_444"></a>当前目录结构</h5> 
<p><img src="https://images2.imgbox.com/0b/d2/V5q8lkZO_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_446"></a>启动</h5> 
<pre><code class="prism language-bash">/home/ubuntu/soft/grafana-8.5.1/bin/grafana-server
</code></pre> 
<h5><a id="_451"></a>访问</h5> 
<p>http://192.168.64.2:3000/ 初始密码和用户名都是 admin，首次登录后会强制要求修改初始密码。<br> <img src="https://images2.imgbox.com/b9/19/o6gnmIv9_o.png" alt="在这里插入图片描述"><br> 登录进来的初始面板<br> <img src="https://images2.imgbox.com/e2/23/RjzYDZyC_o.png" alt="在这里插入图片描述"><br> 添加metric数据源，grafana支持很多种数据源图形的配置，这里我们选择Prometheus<br> <img src="https://images2.imgbox.com/73/48/cbdWokAJ_o.png" alt="在这里插入图片描述"><br> 只需配置这两项就行了<br> <img src="https://images2.imgbox.com/08/cb/AU24Scm2_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/39/61/RA66L1Hi_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/d2/4b/zQLgdqCs_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_464"></a>指标配置</h4> 
<h5><a id="dashboard_465"></a>创建dashboard</h5> 
<p><img src="https://images2.imgbox.com/a5/27/jX2K6KAa_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_467"></a>创建面板</h5> 
<p><img src="https://images2.imgbox.com/20/8d/hwdo1TwW_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="CounterGague_commonfunc_469"></a>Counter和Gague common和func指标配置方式</h5> 
<p><img src="https://images2.imgbox.com/dd/14/oLOfj3bu_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="dashboard_471"></a>dashboard上的基本操作</h5> 
<p><img src="https://images2.imgbox.com/6c/7a/VP6OtEpl_o.png" alt="![在这里插入图片描述](https://img-blog.csdnimg.cn/c9e4042743c24906887685072e922240.pn"></p> 
<h5><a id="CounterGague_vec_474"></a>Counter和Gague vec指标配置方式</h5> 
<h6><a id="name_475"></a>按照name分组</h6> 
<p>在当前的dashboard上增加新的面板,新增两个query<br> <img src="https://images2.imgbox.com/ed/e1/9vWc7sg0_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/fa/62/u3XWGJpq_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="age_479"></a>同样按照age配置分组</h5> 
<p><img src="https://images2.imgbox.com/92/28/E6OYaZqT_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_483"></a>图形样例</h4> 
<h5><a id="counter_commonvec500_484"></a>counter common与vec访问500次图像</h5> 
<p>http://localhost:8090/common_counter?num=500<br> http://localhost:8090/vec_counter?num=500<br> <img src="https://images2.imgbox.com/ee/cb/YLxvuq1n_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="gague_commonvec500_488"></a>gague common与vec访问500次图像</h5> 
<p>http://localhost:8090/common_gague?num=500<br> http://localhost:8090/vec_gague?num=500<br> <img src="https://images2.imgbox.com/5c/4f/mkUUicgf_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_493"></a>总结</h3> 
<h4><a id="_494"></a>遇到的问题</h4> 
<ol><li>Prometheus 机器时钟与实际上报的时间不符合。</li></ol> 
<ul><li>原因：Prometheus server机器的时钟与本地的时钟不一致</li><li>解决：使用 sudo hwclock -s 将时钟对齐</li></ul> 
<h5><a id="_498"></a>展望</h5> 
<blockquote> 
 <p>本文主播介绍了Prometheus的基本概念以及数据模型和指标，描述了安装使用过程，并使用go_client 的两个案例来说明 Counter和Gague的使用。并且结合Grafana配置出炫酷的图形。</p> 
</blockquote> 
<blockquote> 
 <p>接下来还会将 Histogram和Summary的案例进行补齐。并且结合Prometheus 实现一个配置告警功能实现自动告警机制</p> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e0ebf9cbaf8105adc86d07eb49c5f3b6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【数据压缩实验五--JPEG】</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/11ba8125b3312b6afd62e777660170fc/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">printf和println和print区别</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>