<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>将微信小程序页面转为图片 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="将微信小程序页面转为图片" />
<meta property="og:description" content="最近做项目遇到一个需求，那就是要将某个页面转为图片然后传给后端，我仔细找了一圈，发现官方那个Api也就是wx.canvasToTempFilePath生成的图片很有可能为空，太坑了，于是我放弃用它了，选择了用wxml2canvas。
安装wxml2canvas npm init npm install wxml2canvas --save --production npm init 是npm初始化，这个时候根据编译器终端一路回车最终会生成一个package.json文件
–production 是减少安装与业务无关的包，减少项目的体积。如果没有构建npm，需要我们工具-构建npm,或者勾选中
如果你没看到这一项也别急，我们高级版本的微信开发者工具默认支持npm，默认就构建了。然后我们要在utils文件夹下新建index.js，这个文件作用就是为了将页面转为图片的，其代码如下：
//此js文件主要用于将页面转图片 import Util from &#39;./util&#39; const imageMode = [ &#39;scaleToFill&#39;, &#39;aspectFit&#39;, &#39;aspectFill&#39;, &#39;widthFix&#39;, &#39;top&#39;, &#39;bottom&#39;, &#39;center&#39;, &#39;left&#39;, &#39;right&#39;, &#39;top left&#39;, &#39;top right&#39;, &#39;bottom left&#39;, &#39;bottom right&#39;, ] class Wxml2Canvas { constructor(options = {}) { this.device = (wx.getSystemInfoSync &amp;&amp; wx.getSystemInfoSync()) || {} if (!options.zoom) { this.zoom = this.device.windowWidth / 375 } else { this.zoom = options." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/0b20c56f95f1e3ea77aa97e36cb16a77/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-17T10:39:11+08:00" />
<meta property="article:modified_time" content="2023-08-17T10:39:11+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">将微信小程序页面转为图片</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>最近做项目遇到一个需求，那就是要将某个页面转为图片然后传给后端，我仔细找了一圈，发现官方那个Api也就是wx.canvasToTempFilePath生成的图片很有可能为空，太坑了，于是我放弃用它了，选择了用wxml2canvas。</p> 
<h3><a id="wxml2canvas_2"></a>安装wxml2canvas</h3> 
<pre><code class="prism language-javascript">npm init
npm install wxml2canvas <span class="token operator">--</span>save <span class="token operator">--</span>production
</code></pre> 
<p>npm init 是npm初始化，这个时候根据编译器终端一路回车最终会生成一个package.json文件<br> –production 是减少安装与业务无关的包，减少项目的体积。如果没有构建npm，需要我们工具-构建npm,或者勾选中<br> <img src="https://images2.imgbox.com/2f/2e/flvBSHdA_o.png" alt="在这里插入图片描述"><br> 如果你没看到这一项也别急，我们高级版本的微信开发者工具默认支持npm，默认就构建了。然后我们要在utils文件夹下新建index.js，这个文件作用就是为了将页面转为图片的，其代码如下：</p> 
<pre><code class="prism language-javascript"><span class="token comment">//此js文件主要用于将页面转图片</span>

<span class="token keyword">import</span> Util <span class="token keyword">from</span> <span class="token string">'./util'</span>

<span class="token keyword">const</span> imageMode <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">'scaleToFill'</span><span class="token punctuation">,</span>
  <span class="token string">'aspectFit'</span><span class="token punctuation">,</span>
  <span class="token string">'aspectFill'</span><span class="token punctuation">,</span>
  <span class="token string">'widthFix'</span><span class="token punctuation">,</span>
  <span class="token string">'top'</span><span class="token punctuation">,</span>
  <span class="token string">'bottom'</span><span class="token punctuation">,</span>
  <span class="token string">'center'</span><span class="token punctuation">,</span>
  <span class="token string">'left'</span><span class="token punctuation">,</span>
  <span class="token string">'right'</span><span class="token punctuation">,</span>
  <span class="token string">'top left'</span><span class="token punctuation">,</span>
  <span class="token string">'top right'</span><span class="token punctuation">,</span>
  <span class="token string">'bottom left'</span><span class="token punctuation">,</span>
  <span class="token string">'bottom right'</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>

<span class="token keyword">class</span> <span class="token class-name">Wxml2Canvas</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>device <span class="token operator">=</span> <span class="token punctuation">(</span>wx<span class="token punctuation">.</span>getSystemInfoSync <span class="token operator">&amp;&amp;</span> wx<span class="token punctuation">.</span><span class="token function">getSystemInfoSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>zoom<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>zoom <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>device<span class="token punctuation">.</span>windowWidth <span class="token operator">/</span> <span class="token number">375</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>zoom <span class="token operator">=</span> options<span class="token punctuation">.</span>zoom <span class="token operator">||</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>element <span class="token operator">=</span> options<span class="token punctuation">.</span>element
    <span class="token keyword">this</span><span class="token punctuation">.</span>object <span class="token operator">=</span> options<span class="token punctuation">.</span>obj
    <span class="token keyword">this</span><span class="token punctuation">.</span>width <span class="token operator">=</span> options<span class="token punctuation">.</span>width <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>zoom <span class="token operator">||</span> <span class="token number">0</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>height <span class="token operator">=</span> options<span class="token punctuation">.</span>height <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>zoom <span class="token operator">||</span> <span class="token number">0</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>destZoom <span class="token operator">=</span> options<span class="token punctuation">.</span>destZoom <span class="token operator">||</span> <span class="token number">3</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>destWidth <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>width <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>destZoom
    <span class="token keyword">this</span><span class="token punctuation">.</span>destHeight <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>height <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>destZoom
    <span class="token keyword">this</span><span class="token punctuation">.</span>translateX <span class="token operator">=</span> options<span class="token punctuation">.</span>translateX <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>zoom <span class="token operator">||</span> <span class="token number">0</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>translateY <span class="token operator">=</span> options<span class="token punctuation">.</span>translateY <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>zoom <span class="token operator">||</span> <span class="token number">0</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>gradientBackground <span class="token operator">=</span> options<span class="token punctuation">.</span>gradientBackground <span class="token operator">||</span> <span class="token keyword">null</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>background <span class="token operator">=</span> options<span class="token punctuation">.</span>background <span class="token operator">||</span> <span class="token string">'#ffffff'</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>finishDraw <span class="token operator">=</span> options<span class="token punctuation">.</span>finish <span class="token operator">||</span> <span class="token keyword">function</span> <span class="token function">finish</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>errorHandler <span class="token operator">=</span> options<span class="token punctuation">.</span>error <span class="token operator">||</span> <span class="token keyword">function</span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>progress <span class="token operator">=</span> options<span class="token punctuation">.</span>progress <span class="token operator">||</span> <span class="token keyword">function</span> <span class="token function">progress</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>textAlign <span class="token operator">=</span> options<span class="token punctuation">.</span>textAlign <span class="token operator">||</span> <span class="token string">'left'</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>fullText <span class="token operator">=</span> options<span class="token punctuation">.</span>fullText <span class="token operator">||</span> <span class="token boolean">false</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>font <span class="token operator">=</span> options<span class="token punctuation">.</span>font <span class="token operator">||</span> <span class="token string">'14px PingFang SC'</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">draw</span><span class="token punctuation">(</span><span class="token parameter">data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> that</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> self <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> data
    <span class="token keyword">this</span><span class="token punctuation">.</span>fef <span class="token operator">=</span> that

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">progress</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_preloadImage</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>list<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">progress</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span><span class="token function">_draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        self<span class="token punctuation">.</span><span class="token function">errorHandler</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">measureWidth</span><span class="token punctuation">(</span><span class="token parameter">text<span class="token punctuation">,</span> font</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>font<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>font <span class="token operator">=</span> font
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">measureText</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span>width <span class="token operator">||</span> <span class="token number">0</span>
  <span class="token punctuation">}</span>

  <span class="token function">_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>progressPercent <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">// 绘制进度百分比</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ref <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>allPic <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>screenList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>asyncList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>imgUrl <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>progressPercent <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>distance <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">progress</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx <span class="token operator">=</span> wx<span class="token punctuation">.</span><span class="token function">createCanvasContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>element<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>obj<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>font <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>font
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">setTextBaseline</span><span class="token punctuation">(</span><span class="token string">'top'</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">setStrokeStyle</span><span class="token punctuation">(</span><span class="token string">'white'</span><span class="token punctuation">)</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>debug <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>device<span class="token punctuation">.</span>platform <span class="token operator">===</span> <span class="token string">'devtools'</span> <span class="token operator">?</span> <span class="token boolean">true</span> <span class="token operator">:</span> <span class="token boolean">false</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_drawBakcground</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">_drawBakcground</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>gradientBackground<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">let</span> line <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>gradientBackground<span class="token punctuation">.</span>line <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>height<span class="token punctuation">]</span>
      <span class="token keyword">let</span> color <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>gradientBackground<span class="token punctuation">.</span>color <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token string">'#fff'</span><span class="token punctuation">,</span> <span class="token string">'#fff'</span><span class="token punctuation">]</span>
      <span class="token keyword">let</span> style <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">fill</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> line<span class="token punctuation">,</span> color <span class="token punctuation">}</span> <span class="token punctuation">}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_drawRectToCanvas</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>width<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>height<span class="token punctuation">,</span> style<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">let</span> style <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">fill</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>background <span class="token punctuation">}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_drawRectToCanvas</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>width<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>height<span class="token punctuation">,</span> style<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">_draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> self <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">let</span> list <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>list <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">let</span> all <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span>

    list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'wxml'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        count <span class="token operator">+=</span> <span class="token number">3</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        count <span class="token operator">+=</span> <span class="token number">1</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>distance <span class="token operator">=</span> <span class="token number">60</span> <span class="token operator">/</span> <span class="token punctuation">(</span>count <span class="token operator">||</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// 进度条的间距</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>progressPercent <span class="token operator">=</span> <span class="token number">30</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>asyncList <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>delay <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    list <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>delay <span class="token operator">!=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token function">drawList</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span>

    Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>all<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">results</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        index <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token function">drawList</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>asyncList<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>

        Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>all<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">results</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          self<span class="token punctuation">.</span><span class="token function">progress</span><span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span>
          self<span class="token punctuation">.</span><span class="token function">_saveCanvasToImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span><span class="token function">errorHandler</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">function</span> <span class="token function">drawList</span><span class="token punctuation">(</span><span class="token parameter">list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> noDelay</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        all<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">let</span> attr <span class="token operator">=</span> item<span class="token punctuation">.</span>style
          item<span class="token punctuation">.</span>progress <span class="token operator">=</span> self<span class="token punctuation">.</span>distance
          <span class="token keyword">if</span> <span class="token punctuation">(</span>noDelay<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            item<span class="token punctuation">.</span>delay <span class="token operator">=</span> <span class="token number">0</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'radius-image'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            self<span class="token punctuation">.</span><span class="token function">_drawCircle</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> attr<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">,</span> <span class="token string">'image'</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'text'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            self<span class="token punctuation">.</span><span class="token function">_drawText</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> attr<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'line'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            self<span class="token punctuation">.</span><span class="token function">_drawLine</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> attr<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'circle'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            self<span class="token punctuation">.</span><span class="token function">_drawCircle</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> attr<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'rect'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            self<span class="token punctuation">.</span><span class="token function">_drawRect</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> attr<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'image'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            self<span class="token punctuation">.</span><span class="token function">_drawRect</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> attr<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">,</span> <span class="token string">'image'</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'wxml'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            self<span class="token punctuation">.</span><span class="token function">_drawWxml</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> attr<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">_saveCanvasToImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> self <span class="token operator">=</span> <span class="token keyword">this</span>

    <span class="token comment">// 延时保存有两个原因，一个是等待绘制delay的元素，另一个是安卓上样式会错乱</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        self<span class="token punctuation">.</span><span class="token function">progress</span><span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">)</span>

        <span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
          <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
          <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
          <span class="token literal-property property">width</span><span class="token operator">:</span> self<span class="token punctuation">.</span>width<span class="token punctuation">,</span>
          <span class="token literal-property property">height</span><span class="token operator">:</span> self<span class="token punctuation">.</span>height<span class="token punctuation">,</span>
          <span class="token literal-property property">canvasId</span><span class="token operator">:</span> self<span class="token punctuation">.</span>element<span class="token punctuation">,</span>
          <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            self<span class="token punctuation">.</span><span class="token function">progress</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>imgUrl <span class="token operator">=</span> res<span class="token punctuation">.</span>tempFilePath
            self<span class="token punctuation">.</span><span class="token function">finishDraw</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>imgUrl<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token function-variable function">fail</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            self<span class="token punctuation">.</span><span class="token function">errorHandler</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
              <span class="token literal-property property">errcode</span><span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span>
              <span class="token literal-property property">errmsg</span><span class="token operator">:</span> <span class="token string">'save canvas error'</span><span class="token punctuation">,</span>
              <span class="token literal-property property">e</span><span class="token operator">:</span> res<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>destZoom <span class="token operator">!==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          obj<span class="token punctuation">.</span>destWidth <span class="token operator">=</span> self<span class="token punctuation">.</span>destWidth
          obj<span class="token punctuation">.</span>destHeight <span class="token operator">=</span> self<span class="token punctuation">.</span>destHeight
        <span class="token punctuation">}</span>

        wx<span class="token punctuation">.</span><span class="token function">canvasToTempFilePath</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> self<span class="token punctuation">.</span>object<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      self<span class="token punctuation">.</span>device<span class="token punctuation">.</span>system<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'iOS'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> <span class="token number">300</span> <span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">_preloadImage</span><span class="token punctuation">(</span><span class="token parameter">list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> self <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">let</span> all <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span>

    list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>url <span class="token operator">&amp;&amp;</span> self<span class="token punctuation">.</span><span class="token function">_findPicIndex</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>url<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 避免重复下载同一图片</span>
        self<span class="token punctuation">.</span>allPic<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
          <span class="token literal-property property">url</span><span class="token operator">:</span> item<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
          <span class="token literal-property property">local</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        all<span class="token punctuation">[</span>count<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 非http(s)域名的就不下载了</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>
            <span class="token operator">!</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^http</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>url<span class="token punctuation">)</span> <span class="token operator">||</span>
            <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^http:\/\/(tmp)|(usr)\/</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>url<span class="token punctuation">)</span> <span class="token operator">||</span>
            <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^http:\/\/127\.0\.0\.1</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
          <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>isBase64<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token keyword">let</span> fileManager <span class="token operator">=</span> wx<span class="token punctuation">.</span><span class="token function">getFileSystemManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

              fileManager<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                <span class="token literal-property property">filePath</span><span class="token operator">:</span> item<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
                <span class="token literal-property property">data</span><span class="token operator">:</span> item<span class="token punctuation">.</span>isBase64<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">data:image\/(.*);base64,</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token literal-property property">encoding</span><span class="token operator">:</span> <span class="token string">'base64'</span><span class="token punctuation">,</span>
                <span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                  <span class="token function">imageInfo</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token function">fail</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                  <span class="token function">reject</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
              <span class="token function">imageInfo</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">function</span> <span class="token function">imageInfo</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              wx<span class="token punctuation">.</span><span class="token function">getImageInfo</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                <span class="token literal-property property">src</span><span class="token operator">:</span> url<span class="token punctuation">,</span>
                <span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                  <span class="token keyword">let</span> index <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token function">_findPicIndex</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    self<span class="token punctuation">.</span>allPic<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>local <span class="token operator">=</span> url
                    self<span class="token punctuation">.</span>allPic<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>width <span class="token operator">=</span> res<span class="token punctuation">.</span>width
                    self<span class="token punctuation">.</span>allPic<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>height <span class="token operator">=</span> res<span class="token punctuation">.</span>height
                  <span class="token punctuation">}</span>
                  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">tempFilePath</span><span class="token operator">:</span> url <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token function">fail</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                  <span class="token function">reject</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            wx<span class="token punctuation">.</span><span class="token function">downloadFile</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
              <span class="token literal-property property">url</span><span class="token operator">:</span> item<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^https?</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">'https'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                wx<span class="token punctuation">.</span><span class="token function">getImageInfo</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                  <span class="token literal-property property">src</span><span class="token operator">:</span> res<span class="token punctuation">.</span>tempFilePath<span class="token punctuation">,</span>
                  <span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">img</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">let</span> index <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token function">_findPicIndex</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                      self<span class="token punctuation">.</span>allPic<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>local <span class="token operator">=</span> res<span class="token punctuation">.</span>tempFilePath
                      self<span class="token punctuation">.</span>allPic<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>width <span class="token operator">=</span> img<span class="token punctuation">.</span>width
                      self<span class="token punctuation">.</span>allPic<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>height <span class="token operator">=</span> img<span class="token punctuation">.</span>height
                    <span class="token punctuation">}</span>
                    <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
                  <span class="token punctuation">}</span><span class="token punctuation">,</span>
                  <span class="token function">fail</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">reject</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
                  <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
              <span class="token function-variable function">fail</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">errcode</span><span class="token operator">:</span> <span class="token number">1001</span><span class="token punctuation">,</span> <span class="token literal-property property">errmsg</span><span class="token operator">:</span> <span class="token string">'download pic error'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>all<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">results</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">results</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">reject</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">_findPicIndex</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>allPic<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">pic</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> pic<span class="token punctuation">.</span>url <span class="token operator">===</span> url<span class="token punctuation">)</span>
    <span class="token keyword">return</span> index
  <span class="token punctuation">}</span>

  <span class="token function">_drawRect</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> style<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">,</span> isImage<span class="token punctuation">,</span> isWxml</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> zoom <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>zoom
    <span class="token keyword">let</span> leftOffset <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">let</span> topOffset <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">let</span> width <span class="token operator">=</span> style<span class="token punctuation">.</span>width
    <span class="token keyword">let</span> height <span class="token operator">=</span> style<span class="token punctuation">.</span>height
    <span class="token keyword">let</span> imgWidth <span class="token operator">=</span> style<span class="token punctuation">.</span>width
    <span class="token keyword">let</span> imgHeight <span class="token operator">=</span> style<span class="token punctuation">.</span>height
    <span class="token keyword">let</span> mode <span class="token operator">=</span> <span class="token keyword">null</span>

    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      item<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_resetPositionX</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> style<span class="token punctuation">)</span>
      item<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_resetPositionY</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> style<span class="token punctuation">)</span>

      <span class="token keyword">let</span> url
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isImage<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_findPicIndex</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          url <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>allPic<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>local
          imgWidth <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>allPic<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>width
          imgHeight <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>allPic<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>height
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          url <span class="token operator">=</span> item<span class="token punctuation">.</span>url
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      style<span class="token punctuation">.</span>padding <span class="token operator">=</span> style<span class="token punctuation">.</span>padding <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isWxml <span class="token operator">===</span> <span class="token string">'inline-wxml'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        item<span class="token punctuation">.</span>x <span class="token operator">=</span> item<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>style<span class="token punctuation">.</span>padding<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> style<span class="token punctuation">.</span>padding<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span>
        item<span class="token punctuation">.</span>y <span class="token operator">=</span> item<span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>style<span class="token punctuation">.</span>padding<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> style<span class="token punctuation">.</span>padding<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      leftOffset <span class="token operator">=</span>
        item<span class="token punctuation">.</span>x <span class="token operator">+</span> style<span class="token punctuation">.</span>width <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>style<span class="token punctuation">.</span>padding<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> style<span class="token punctuation">.</span>padding<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isWxml<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        width <span class="token operator">=</span> width <span class="token operator">*</span> zoom
        height <span class="token operator">=</span> height <span class="token operator">*</span> zoom
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        style<span class="token punctuation">.</span>dataset <span class="token operator">&amp;&amp;</span>
        style<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>mode <span class="token operator">&amp;&amp;</span>
        imageMode<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>style<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>mode<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mode <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
          <span class="token literal-property property">type</span><span class="token operator">:</span> style<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>mode<span class="token punctuation">,</span>
          <span class="token literal-property property">width</span><span class="token operator">:</span> imgWidth<span class="token punctuation">,</span>
          <span class="token literal-property property">height</span><span class="token operator">:</span> imgHeight<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_drawRectToCanvas</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>x<span class="token punctuation">,</span> item<span class="token punctuation">.</span>y<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> style<span class="token punctuation">,</span> url<span class="token punctuation">,</span> mode<span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_updateProgress</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>progress<span class="token punctuation">)</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
          leftOffset<span class="token punctuation">,</span>
          topOffset<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      reject <span class="token operator">&amp;&amp;</span>
        <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
          <span class="token literal-property property">errcode</span><span class="token operator">:</span> isImage <span class="token operator">?</span> <span class="token number">1003</span> <span class="token operator">:</span> <span class="token number">1002</span><span class="token punctuation">,</span>
          <span class="token literal-property property">errmsg</span><span class="token operator">:</span> isImage <span class="token operator">?</span> <span class="token string">'drawImage error'</span> <span class="token operator">:</span> <span class="token string">'drawRect error'</span><span class="token punctuation">,</span>
          e<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">_drawRectToCanvas</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> style<span class="token punctuation">,</span> url<span class="token punctuation">,</span> mode</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> <span class="token punctuation">{<!-- --></span> fill<span class="token punctuation">,</span> border<span class="token punctuation">,</span> boxShadow <span class="token punctuation">}</span> <span class="token operator">=</span> style
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_drawBoxShadow</span><span class="token punctuation">(</span>boxShadow<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 真机上填充渐变色时，没有阴影，先画个相等大小的纯色矩形来实现阴影</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>fill <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> fill <span class="token operator">!==</span> <span class="token string">'string'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>debug<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">setFillStyle</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>color <span class="token operator">||</span> <span class="token string">'#ffffff'</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 开发者工具有bug，先不裁剪</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>mode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_resetImageByMode</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> mode<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_setFill</span><span class="token punctuation">(</span>fill<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_drawBorder</span><span class="token punctuation">(</span>border<span class="token punctuation">,</span> style<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">border</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">let</span> fixBorder <span class="token operator">=</span> border<span class="token punctuation">.</span>width
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">strokeRect</span><span class="token punctuation">(</span>
        x <span class="token operator">-</span> fixBorder <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>
        y <span class="token operator">-</span> fixBorder <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>
        width <span class="token operator">+</span> fixBorder<span class="token punctuation">,</span>
        height <span class="token operator">+</span> fixBorder<span class="token punctuation">,</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">_resetImageByMode</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> mode</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> self <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">let</span> offsetX <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">let</span> offsetY <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">let</span> imgWidth <span class="token operator">=</span> mode<span class="token punctuation">.</span>width
    <span class="token keyword">let</span> imgHeight <span class="token operator">=</span> mode<span class="token punctuation">.</span>height

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>mode<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">case</span> <span class="token string">'scaleToFill'</span><span class="token operator">:</span>
        imgWidth <span class="token operator">=</span> width
        imgHeight <span class="token operator">=</span> height
        self<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token string">'widthFix'</span><span class="token operator">:</span>
        height <span class="token operator">=</span> width <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>imgWidth <span class="token operator">||</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>imgHeight <span class="token operator">||</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token string">'aspectFit'</span><span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>imgWidth <span class="token operator">&gt;</span> imgHeight<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">let</span> realHeight <span class="token operator">=</span> width <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>imgWidth <span class="token operator">||</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>imgHeight <span class="token operator">||</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          offsetY <span class="token operator">=</span> <span class="token operator">-</span><span class="token punctuation">(</span>height <span class="token operator">-</span> realHeight<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
          imgWidth <span class="token operator">=</span> width
          imgHeight <span class="token operator">=</span> realHeight
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">let</span> realWidth <span class="token operator">=</span> height <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>imgHeight <span class="token operator">||</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>imgWidth <span class="token operator">||</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          offsetX <span class="token operator">=</span> <span class="token operator">-</span><span class="token punctuation">(</span>width <span class="token operator">-</span> realWidth<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
          imgWidth <span class="token operator">=</span> realWidth
          imgHeight <span class="token operator">=</span> height
        <span class="token punctuation">}</span>

        <span class="token function">_clip</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token string">'aspectFill'</span><span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>imgWidth <span class="token operator">&gt;</span> imgHeight<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">let</span> realWidth <span class="token operator">=</span> imgWidth <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>imgHeight <span class="token operator">||</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>height <span class="token operator">||</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          offsetX <span class="token operator">=</span> <span class="token punctuation">(</span>realWidth <span class="token operator">-</span> width<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
          imgWidth <span class="token operator">=</span> realWidth
          imgHeight <span class="token operator">=</span> height
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">let</span> realHeight <span class="token operator">=</span> imgHeight <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>imgWidth <span class="token operator">||</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>width <span class="token operator">||</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          offsetY <span class="token operator">=</span> <span class="token punctuation">(</span>realHeight <span class="token operator">-</span> height<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
          imgWidth <span class="token operator">=</span> width
          imgHeight <span class="token operator">=</span> realHeight
        <span class="token punctuation">}</span>

        <span class="token function">_clip</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token string">'top left'</span><span class="token operator">:</span>
        <span class="token function">_clip</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token string">'top'</span><span class="token operator">:</span>
        offsetX <span class="token operator">=</span> <span class="token punctuation">(</span>mode<span class="token punctuation">.</span>width <span class="token operator">-</span> width<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
        <span class="token function">_clip</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token string">'top right'</span><span class="token operator">:</span>
        offsetX <span class="token operator">=</span> mode<span class="token punctuation">.</span>width <span class="token operator">-</span> width
        <span class="token function">_clip</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token string">'left'</span><span class="token operator">:</span>
        offsetY <span class="token operator">=</span> <span class="token punctuation">(</span>mode<span class="token punctuation">.</span>height <span class="token operator">-</span> height<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
        <span class="token function">_clip</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token string">'center'</span><span class="token operator">:</span>
        offsetX <span class="token operator">=</span> <span class="token punctuation">(</span>mode<span class="token punctuation">.</span>width <span class="token operator">-</span> width<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
        offsetY <span class="token operator">=</span> <span class="token punctuation">(</span>mode<span class="token punctuation">.</span>height <span class="token operator">-</span> height<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
        <span class="token function">_clip</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token string">'right'</span><span class="token operator">:</span>
        offsetX <span class="token operator">=</span> mode<span class="token punctuation">.</span>width <span class="token operator">-</span> width
        offsetY <span class="token operator">=</span> <span class="token punctuation">(</span>mode<span class="token punctuation">.</span>height <span class="token operator">-</span> height<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
        <span class="token function">_clip</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token string">'bottom left'</span><span class="token operator">:</span>
        offsetY <span class="token operator">=</span> mode<span class="token punctuation">.</span>height <span class="token operator">-</span> height
        <span class="token function">_clip</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token string">'bottom'</span><span class="token operator">:</span>
        offsetX <span class="token operator">=</span> <span class="token punctuation">(</span>mode<span class="token punctuation">.</span>width <span class="token operator">-</span> width<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
        offsetY <span class="token operator">=</span> mode<span class="token punctuation">.</span>height <span class="token operator">-</span> height
        <span class="token function">_clip</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token string">'bottom right'</span><span class="token operator">:</span>
        offsetX <span class="token operator">=</span> mode<span class="token punctuation">.</span>width <span class="token operator">-</span> width
        offsetY <span class="token operator">=</span> mode<span class="token punctuation">.</span>height <span class="token operator">-</span> height
        <span class="token function">_clip</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
        imgWidth <span class="token operator">=</span> width
        imgHeight <span class="token operator">=</span> height
        <span class="token keyword">break</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">_clip</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      self<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      self<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      self<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">rect</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span>
      self<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">clip</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      self<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> x <span class="token operator">-</span> offsetX<span class="token punctuation">,</span> y <span class="token operator">-</span> offsetY<span class="token punctuation">,</span> imgWidth<span class="token punctuation">,</span> imgHeight<span class="token punctuation">)</span>
      self<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">closePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      self<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">_drawText</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> style<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">,</span> type<span class="token punctuation">,</span> isWxml</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> zoom <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>zoom
    <span class="token keyword">let</span> leftOffset <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">let</span> topOffset <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      style<span class="token punctuation">.</span>fontSize <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_parseNumber</span><span class="token punctuation">(</span>style<span class="token punctuation">.</span>fontSize<span class="token punctuation">)</span>
      <span class="token keyword">let</span> fontSize <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span><span class="token punctuation">(</span>style<span class="token punctuation">.</span>fontSize <span class="token operator">||</span> <span class="token number">14</span><span class="token punctuation">)</span> <span class="token operator">*</span> zoom<span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">setTextBaseline</span><span class="token punctuation">(</span><span class="token string">'top'</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>font <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>
        style<span class="token punctuation">.</span>fontWeight <span class="token operator">?</span> style<span class="token punctuation">.</span>fontWeight <span class="token operator">:</span> <span class="token string">'normal'</span>
      <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>fontSize<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>style<span class="token punctuation">.</span>fontFamily <span class="token operator">||</span> <span class="token string">'PingFang SC'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">setFillStyle</span><span class="token punctuation">(</span>style<span class="token punctuation">.</span>color <span class="token operator">||</span> <span class="token string">'#454545'</span><span class="token punctuation">)</span>

      <span class="token keyword">let</span> text <span class="token operator">=</span> item<span class="token punctuation">.</span>text <span class="token operator">||</span> <span class="token string">''</span>
      <span class="token keyword">let</span> textWidth <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">measureWidth</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> style<span class="token punctuation">.</span>font <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>font<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span>
      <span class="token keyword">let</span> lineHeight <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getLineHeight</span><span class="token punctuation">(</span>style<span class="token punctuation">)</span>
      <span class="token keyword">let</span> textHeight <span class="token operator">=</span>
        Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>textWidth <span class="token operator">/</span> <span class="token punctuation">(</span>style<span class="token punctuation">.</span>width <span class="token operator">||</span> textWidth<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> lineHeight
      <span class="token keyword">let</span> width <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span><span class="token punctuation">(</span>style<span class="token punctuation">.</span>width <span class="token operator">||</span> textWidth<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">!</span>isWxml <span class="token operator">?</span> zoom <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">let</span> whiteSpace <span class="token operator">=</span> style<span class="token punctuation">.</span>whiteSpace <span class="token operator">||</span> <span class="token string">'wrap'</span>
      <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">0</span>
      <span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token number">0</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> style<span class="token punctuation">.</span>padding <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        style<span class="token punctuation">.</span>padding <span class="token operator">=</span> Util<span class="token punctuation">.</span><span class="token function">transferPadding</span><span class="token punctuation">(</span>style<span class="token punctuation">.</span>padding<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      item<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_resetPositionX</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> style<span class="token punctuation">)</span>
      item<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_resetPositionY</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> style<span class="token punctuation">,</span> textHeight<span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_drawBoxShadow</span><span class="token punctuation">(</span>style<span class="token punctuation">.</span>boxShadow<span class="token punctuation">)</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>style<span class="token punctuation">.</span>background <span class="token operator">||</span> style<span class="token punctuation">.</span>border<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_drawTextBackgroud</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> style<span class="token punctuation">,</span> textWidth<span class="token punctuation">,</span> textHeight<span class="token punctuation">,</span> isWxml<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 行内文本</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'inline-text'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        width <span class="token operator">=</span> item<span class="token punctuation">.</span>maxWidth
        <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>leftOffset <span class="token operator">+</span> textWidth <span class="token operator">&gt;</span> width<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 如果上一个行内元素换行了，这个元素要继续在后面补足一行</span>
          <span class="token keyword">let</span> lineNum <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>textWidth <span class="token operator">/</span> width<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
          <span class="token keyword">let</span> length <span class="token operator">=</span> text<span class="token punctuation">.</span>length
          <span class="token keyword">let</span> singleLength <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>length <span class="token operator">/</span> lineNum<span class="token punctuation">)</span>
          <span class="token keyword">let</span> widthOffset <span class="token operator">=</span> item<span class="token punctuation">.</span>leftOffset <span class="token operator">?</span> item<span class="token punctuation">.</span>leftOffset <span class="token operator">-</span> item<span class="token punctuation">.</span>originX <span class="token operator">:</span> <span class="token number">0</span>
          <span class="token keyword">let</span> <span class="token punctuation">{<!-- --></span>
            <span class="token literal-property property">endIndex</span><span class="token operator">:</span> currentIndex<span class="token punctuation">,</span>
            single<span class="token punctuation">,</span>
            singleWidth<span class="token punctuation">,</span>
          <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getTextSingleLine</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> width<span class="token punctuation">,</span> singleLength<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> widthOffset<span class="token punctuation">)</span>
          x <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_resetTextPositionX</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> style<span class="token punctuation">,</span> singleWidth<span class="token punctuation">)</span>
          y <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_resetTextPositionY</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> style<span class="token punctuation">)</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">fillText</span><span class="token punctuation">(</span>single<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
          leftOffset <span class="token operator">=</span> x <span class="token operator">+</span> singleWidth
          topOffset <span class="token operator">=</span> y

          <span class="token comment">// 去除第一行补的内容，然后重置</span>
          text <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>currentIndex<span class="token punctuation">,</span> text<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
          currentIndex <span class="token operator">=</span> <span class="token number">0</span>
          lineNum <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>textWidth <span class="token operator">/</span> width<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
          textWidth <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">measureWidth</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> style<span class="token punctuation">.</span>font <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>font<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span>
          item<span class="token punctuation">.</span>x <span class="token operator">=</span> item<span class="token punctuation">.</span>originX <span class="token comment">// 还原换行后的x</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> lineNum<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">let</span> <span class="token punctuation">{<!-- --></span> endIndex<span class="token punctuation">,</span> single<span class="token punctuation">,</span> singleWidth <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getTextSingleLine</span><span class="token punctuation">(</span>
              text<span class="token punctuation">,</span>
              width<span class="token punctuation">,</span>
              singleLength<span class="token punctuation">,</span>
              currentIndex<span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
            currentIndex <span class="token operator">=</span> endIndex
            <span class="token keyword">if</span> <span class="token punctuation">(</span>single<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              x <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_resetTextPositionX</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> style<span class="token punctuation">,</span> singleWidth<span class="token punctuation">,</span> width<span class="token punctuation">)</span>
              y <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_resetTextPositionY</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> style<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">fillText</span><span class="token punctuation">(</span>single<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">===</span> lineNum <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                leftOffset <span class="token operator">=</span> x <span class="token operator">+</span> singleWidth
                topOffset <span class="token operator">=</span> lineHeight <span class="token operator">*</span> lineNum
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>

          <span class="token keyword">let</span> last <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>currentIndex<span class="token punctuation">,</span> length<span class="token punctuation">)</span>
          <span class="token keyword">let</span> lastWidth <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">measureWidth</span><span class="token punctuation">(</span>last<span class="token punctuation">)</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>last<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            x <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_resetTextPositionX</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> style<span class="token punctuation">,</span> lastWidth<span class="token punctuation">,</span> width<span class="token punctuation">)</span>
            y <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_resetTextPositionY</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> style<span class="token punctuation">,</span> lineNum <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">fillText</span><span class="token punctuation">(</span>last<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
            leftOffset <span class="token operator">=</span> x <span class="token operator">+</span> lastWidth
            topOffset <span class="token operator">=</span> lineHeight <span class="token operator">*</span> <span class="token punctuation">(</span>lineNum <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          x <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_resetTextPositionX</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> style<span class="token punctuation">,</span> textWidth<span class="token punctuation">,</span> width<span class="token punctuation">)</span>
          y <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_resetTextPositionY</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> style<span class="token punctuation">)</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">fillText</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>text<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
          leftOffset <span class="token operator">=</span> x <span class="token operator">+</span> textWidth
          topOffset <span class="token operator">=</span> lineHeight
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// block文本，如果文本长度超过宽度换行</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>width <span class="token operator">&amp;&amp;</span> textWidth <span class="token operator">&gt;</span> width <span class="token operator">&amp;&amp;</span> whiteSpace <span class="token operator">!==</span> <span class="token string">'nowrap'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">let</span> lineNum <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>textWidth <span class="token operator">/</span> width<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
          <span class="token keyword">let</span> length <span class="token operator">=</span> text<span class="token punctuation">.</span>length
          <span class="token keyword">let</span> singleLength <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>length <span class="token operator">/</span> lineNum<span class="token punctuation">)</span>
          <span class="token keyword">let</span> currentIndex <span class="token operator">=</span> <span class="token number">0</span>

          <span class="token comment">// lineClamp参数限制最多行数</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>style<span class="token punctuation">.</span>lineClamp <span class="token operator">&amp;&amp;</span> lineNum <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&gt;</span> style<span class="token punctuation">.</span>lineClamp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            lineNum <span class="token operator">=</span> style<span class="token punctuation">.</span>lineClamp <span class="token operator">-</span> <span class="token number">1</span>
          <span class="token punctuation">}</span>

          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> lineNum<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">let</span> <span class="token punctuation">{<!-- --></span> endIndex<span class="token punctuation">,</span> single<span class="token punctuation">,</span> singleWidth <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getTextSingleLine</span><span class="token punctuation">(</span>
              text<span class="token punctuation">,</span>
              width<span class="token punctuation">,</span>
              singleLength<span class="token punctuation">,</span>
              currentIndex<span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
            currentIndex <span class="token operator">=</span> endIndex
            x <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_resetTextPositionX</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> style<span class="token punctuation">,</span> singleWidth<span class="token punctuation">,</span> width<span class="token punctuation">)</span>
            y <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_resetTextPositionY</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> style<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">fillText</span><span class="token punctuation">(</span>single<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>

          <span class="token comment">// 换行后剩余的文字，超过一行则截断增加省略号</span>
          <span class="token keyword">let</span> last <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>currentIndex<span class="token punctuation">,</span> length<span class="token punctuation">)</span>
          <span class="token keyword">let</span> lastWidth <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">measureWidth</span><span class="token punctuation">(</span>last<span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>lastWidth <span class="token operator">&gt;</span> width<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">let</span> <span class="token punctuation">{<!-- --></span> single<span class="token punctuation">,</span> singleWidth <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getTextSingleLine</span><span class="token punctuation">(</span>
              last<span class="token punctuation">,</span>
              width<span class="token punctuation">,</span>
              singleLength<span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
            lastWidth <span class="token operator">=</span> singleWidth
            last <span class="token operator">=</span> single<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> single<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'...'</span>
          <span class="token punctuation">}</span>

          x <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_resetTextPositionX</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> style<span class="token punctuation">,</span> lastWidth<span class="token punctuation">,</span> width<span class="token punctuation">)</span>
          y <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_resetTextPositionY</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> style<span class="token punctuation">,</span> lineNum<span class="token punctuation">)</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">fillText</span><span class="token punctuation">(</span>last<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          x <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_resetTextPositionX</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> style<span class="token punctuation">,</span> textWidth<span class="token punctuation">,</span> width<span class="token punctuation">)</span>
          y <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_resetTextPositionY</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> style<span class="token punctuation">)</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">fillText</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>text<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>

      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_updateProgress</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>progress<span class="token punctuation">)</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
          leftOffset<span class="token punctuation">,</span>
          topOffset<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      reject <span class="token operator">&amp;&amp;</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">errcode</span><span class="token operator">:</span> <span class="token number">1004</span><span class="token punctuation">,</span> <span class="token literal-property property">errmsg</span><span class="token operator">:</span> <span class="token string">'drawText error'</span><span class="token punctuation">,</span> <span class="token literal-property property">e</span><span class="token operator">:</span> e <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">_drawTextBackgroud</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> style<span class="token punctuation">,</span> textWidth<span class="token punctuation">,</span> textHeight<span class="token punctuation">,</span> isWxml</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>style<span class="token punctuation">.</span>width<span class="token punctuation">)</span> <span class="token keyword">return</span>
    <span class="token keyword">let</span> zoom <span class="token operator">=</span> isWxml <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>zoom
    <span class="token keyword">let</span> width <span class="token operator">=</span> style<span class="token punctuation">.</span>width <span class="token operator">||</span> textWidth
    <span class="token keyword">let</span> height <span class="token operator">=</span> style<span class="token punctuation">.</span>height <span class="token operator">||</span> textHeight
    <span class="token keyword">let</span> rectStyle <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">fill</span><span class="token operator">:</span> style<span class="token punctuation">.</span>background<span class="token punctuation">,</span>
      <span class="token literal-property property">border</span><span class="token operator">:</span> style<span class="token punctuation">.</span>border<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    style<span class="token punctuation">.</span>padding <span class="token operator">=</span> style<span class="token punctuation">.</span>padding <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
    width <span class="token operator">+=</span> <span class="token punctuation">(</span>style<span class="token punctuation">.</span>padding<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>style<span class="token punctuation">.</span>padding<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span>
    height <span class="token operator">+=</span> <span class="token punctuation">(</span>style<span class="token punctuation">.</span>padding<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>style<span class="token punctuation">.</span>padding<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span>
    width <span class="token operator">=</span> width <span class="token operator">*</span> zoom
    height <span class="token operator">=</span> height <span class="token operator">*</span> zoom
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_drawRectToCanvas</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>x<span class="token punctuation">,</span> item<span class="token punctuation">.</span>y<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> rectStyle<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">_drawCircle</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> style<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">,</span> isImage<span class="token punctuation">,</span> isWxml</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> zoom <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>zoom
    <span class="token keyword">let</span> r <span class="token operator">=</span> style<span class="token punctuation">.</span>r
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      item<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_resetPositionX</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> style<span class="token punctuation">)</span>
      item<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_resetPositionY</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> style<span class="token punctuation">)</span>

      <span class="token keyword">let</span> url
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isImage<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_findPicIndex</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          url <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>allPic<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>local
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          url <span class="token operator">=</span> item<span class="token punctuation">.</span>url
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isWxml<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        r <span class="token operator">=</span> r <span class="token operator">*</span> zoom
      <span class="token punctuation">}</span>

      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_drawCircleToCanvas</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>x<span class="token punctuation">,</span> item<span class="token punctuation">.</span>y<span class="token punctuation">,</span> r<span class="token punctuation">,</span> style<span class="token punctuation">,</span> url<span class="token punctuation">)</span>

      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_updateProgress</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>progress<span class="token punctuation">)</span>
      resolve <span class="token operator">&amp;&amp;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      reject <span class="token operator">&amp;&amp;</span>
        <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
          <span class="token literal-property property">errcode</span><span class="token operator">:</span> isImage <span class="token operator">?</span> <span class="token number">1006</span> <span class="token operator">:</span> <span class="token number">1005</span><span class="token punctuation">,</span>
          <span class="token literal-property property">errmsg</span><span class="token operator">:</span> isImage <span class="token operator">?</span> <span class="token string">'drawCircleImage error'</span> <span class="token operator">:</span> <span class="token string">'drawCircle error'</span><span class="token punctuation">,</span>
          e<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">_drawCircleToCanvas</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> r<span class="token punctuation">,</span> style<span class="token punctuation">,</span> url</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> <span class="token punctuation">{<!-- --></span> fill<span class="token punctuation">,</span> border<span class="token punctuation">,</span> boxShadow <span class="token punctuation">}</span> <span class="token operator">=</span> style

    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_drawBoxShadow</span><span class="token punctuation">(</span>boxShadow<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 真机上填充渐变色时，没有阴影，先画个相等大小的纯色矩形来实现阴影</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fill <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> fill <span class="token operator">!==</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>url <span class="token operator">&amp;&amp;</span> res<span class="token punctuation">.</span>color<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">setFillStyle</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>color <span class="token operator">||</span> <span class="token string">'#ffffff'</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">arc</span><span class="token punctuation">(</span>x <span class="token operator">+</span> r<span class="token punctuation">,</span> y <span class="token operator">+</span> r<span class="token punctuation">,</span> r<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">closePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">arc</span><span class="token punctuation">(</span>x <span class="token operator">+</span> r<span class="token punctuation">,</span> y <span class="token operator">+</span> r<span class="token punctuation">,</span> r<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">clip</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> r <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> r <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">closePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_setFill</span><span class="token punctuation">(</span>fill<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">arc</span><span class="token punctuation">(</span>x <span class="token operator">+</span> r<span class="token punctuation">,</span> y <span class="token operator">+</span> r<span class="token punctuation">,</span> r<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">closePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_drawBorder</span><span class="token punctuation">(</span>border<span class="token punctuation">,</span> style<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">border</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">arc</span><span class="token punctuation">(</span>x <span class="token operator">+</span> r<span class="token punctuation">,</span> y <span class="token operator">+</span> r<span class="token punctuation">,</span> r <span class="token operator">+</span> border<span class="token punctuation">.</span>width <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">stroke</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">closePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">_drawLine</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> style<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">,</span> isWxml</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> zoom <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>zoom
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">let</span> x1 <span class="token operator">=</span> item<span class="token punctuation">.</span>x <span class="token operator">*</span> zoom <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>translateX
      <span class="token keyword">let</span> y1 <span class="token operator">=</span> item<span class="token punctuation">.</span>y <span class="token operator">*</span> zoom <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>translateY
      <span class="token keyword">let</span> x2 <span class="token operator">=</span> item<span class="token punctuation">.</span>x2 <span class="token operator">*</span> zoom <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>translateX
      <span class="token keyword">let</span> y2 <span class="token operator">=</span> item<span class="token punctuation">.</span>y2 <span class="token operator">*</span> zoom <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>translateY
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_drawLineToCanvas</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> style<span class="token punctuation">)</span>

      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_updateProgress</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>progress<span class="token punctuation">)</span>
      resolve <span class="token operator">&amp;&amp;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      reject <span class="token operator">&amp;&amp;</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">errcode</span><span class="token operator">:</span> <span class="token number">1007</span><span class="token punctuation">,</span> <span class="token literal-property property">errmsg</span><span class="token operator">:</span> <span class="token string">'drawLine error'</span><span class="token punctuation">,</span> e <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">_drawLineToCanvas</span><span class="token punctuation">(</span><span class="token parameter">x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> style</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> <span class="token punctuation">{<!-- --></span> stroke<span class="token punctuation">,</span> dash<span class="token punctuation">,</span> boxShadow <span class="token punctuation">}</span> <span class="token operator">=</span> style

    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stroke<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_setStroke</span><span class="token punctuation">(</span>stroke<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_drawBoxShadow</span><span class="token punctuation">(</span>boxShadow<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>dash<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">let</span> dash <span class="token operator">=</span> <span class="token punctuation">[</span>style<span class="token punctuation">.</span>dash<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">5</span><span class="token punctuation">,</span> style<span class="token punctuation">.</span>dash<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">5</span><span class="token punctuation">]</span>
      <span class="token keyword">let</span> offset <span class="token operator">=</span> style<span class="token punctuation">.</span>dash<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">0</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">setLineDash</span><span class="token punctuation">(</span>dash<span class="token punctuation">,</span> offset <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">setLineWidth</span><span class="token punctuation">(</span><span class="token punctuation">(</span>style<span class="token punctuation">.</span>width <span class="token operator">||</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>zoom<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span>x2<span class="token punctuation">,</span> y2<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">stroke</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 废弃，合并到_drawRect</span>
  <span class="token function">_drawImage</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> style<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">,</span> isWxml</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> zoom <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>zoom
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      item<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_resetPositionX</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> style<span class="token punctuation">)</span>
      item<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_resetPositionY</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> style<span class="token punctuation">)</span>
      item<span class="token punctuation">.</span>x <span class="token operator">=</span> item<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token punctuation">(</span>style<span class="token punctuation">.</span>padding<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span>
      item<span class="token punctuation">.</span>y <span class="token operator">=</span> item<span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token punctuation">(</span>style<span class="token punctuation">.</span>padding<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span>

      <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_findPicIndex</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
      <span class="token keyword">let</span> url <span class="token operator">=</span> index <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>allPic<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>local <span class="token operator">:</span> item<span class="token punctuation">.</span>url
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_drawImageToCanvas</span><span class="token punctuation">(</span>
        url<span class="token punctuation">,</span>
        item<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
        item<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
        style<span class="token punctuation">.</span>width <span class="token operator">*</span> zoom<span class="token punctuation">,</span>
        style<span class="token punctuation">.</span>height <span class="token operator">*</span> zoom<span class="token punctuation">,</span>
        style<span class="token punctuation">,</span>
      <span class="token punctuation">)</span>

      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_updateProgress</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>progress<span class="token punctuation">)</span>
      resolve <span class="token operator">&amp;&amp;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      reject <span class="token operator">&amp;&amp;</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">errcode</span><span class="token operator">:</span> <span class="token number">1012</span><span class="token punctuation">,</span> <span class="token literal-property property">errmsg</span><span class="token operator">:</span> <span class="token string">'drawRect error'</span><span class="token punctuation">,</span> e <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 废弃，合并到_drawRect</span>
  <span class="token function">_drawImageToCanvas</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> style</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> <span class="token punctuation">{<!-- --></span> fill<span class="token punctuation">,</span> border<span class="token punctuation">,</span> boxShadow <span class="token punctuation">}</span> <span class="token operator">=</span> style
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_drawBoxShadow</span><span class="token punctuation">(</span>boxShadow<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_drawBorder</span><span class="token punctuation">(</span>border<span class="token punctuation">,</span> style<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">border</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">let</span> fixBorder <span class="token operator">=</span> border<span class="token punctuation">.</span>width
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">strokeRect</span><span class="token punctuation">(</span>
        x <span class="token operator">-</span> fixBorder <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>
        y <span class="token operator">-</span> fixBorder <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>
        width <span class="token operator">+</span> fixBorder<span class="token punctuation">,</span>
        height <span class="token operator">+</span> fixBorder<span class="token punctuation">,</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">_drawWxml</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> style<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> self <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">let</span> all <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getWxml</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> style<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">results</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 上 -&gt; 下</span>
        <span class="token keyword">let</span> sorted <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token function">_sortListByTop</span><span class="token punctuation">(</span>results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">let</span> progress <span class="token operator">=</span> <span class="token number">0</span>
        Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>sorted<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          count <span class="token operator">+=</span> sorted<span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">.</span>length
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        progress <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>distance <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>count <span class="token operator">||</span> <span class="token number">1</span><span class="token punctuation">)</span>

        all <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_drawWxmlBlock</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> sorted<span class="token punctuation">,</span> all<span class="token punctuation">,</span> progress<span class="token punctuation">,</span> results<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        all <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_drawWxmlInline</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> sorted<span class="token punctuation">,</span> all<span class="token punctuation">,</span> progress<span class="token punctuation">,</span> results<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>all<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">results</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            resolve <span class="token operator">&amp;&amp;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            reject <span class="token operator">&amp;&amp;</span> <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      reject <span class="token operator">&amp;&amp;</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">errcode</span><span class="token operator">:</span> <span class="token number">1008</span><span class="token punctuation">,</span> <span class="token literal-property property">errmsg</span><span class="token operator">:</span> <span class="token string">'drawWxml error'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">_drawWxmlBlock</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> sorted<span class="token punctuation">,</span> all<span class="token punctuation">,</span> progress<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> self <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token comment">// 用来限定位置范围，取相对位置</span>
    <span class="token keyword">let</span> limitLeft <span class="token operator">=</span> results <span class="token operator">?</span> results<span class="token punctuation">.</span>left <span class="token operator">:</span> <span class="token number">0</span>
    <span class="token keyword">let</span> limitTop <span class="token operator">=</span> results <span class="token operator">?</span> results<span class="token punctuation">.</span>top <span class="token operator">:</span> <span class="token number">0</span>
    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>sorted<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">top<span class="token punctuation">,</span> topIndex</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 左 -&gt; 右</span>
      <span class="token keyword">let</span> list <span class="token operator">=</span> sorted<span class="token punctuation">[</span>top<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> a<span class="token punctuation">.</span>left <span class="token operator">-</span> b<span class="token punctuation">.</span>left
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

      list <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token parameter">sub</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> sub<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>type <span class="token operator">&amp;&amp;</span> sub<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>type<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'inline'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span>

      list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">sub<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        all<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve2<span class="token punctuation">,</span> reject2</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          sub <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token function">_transferWxmlStyle</span><span class="token punctuation">(</span>sub<span class="token punctuation">,</span> item<span class="token punctuation">,</span> limitLeft<span class="token punctuation">,</span> limitTop<span class="token punctuation">)</span>
          sub<span class="token punctuation">.</span>progress <span class="token operator">=</span> progress
          <span class="token keyword">let</span> type <span class="token operator">=</span> sub<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>type
          <span class="token keyword">if</span> <span class="token punctuation">(</span>sub<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>delay<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
              <span class="token function">drawWxmlItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> sub<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>delay<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">drawWxmlItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">function</span> <span class="token function">drawWxmlItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'text'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              self<span class="token punctuation">.</span><span class="token function">_drawWxmlText</span><span class="token punctuation">(</span>sub<span class="token punctuation">,</span> resolve2<span class="token punctuation">,</span> reject2<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'image'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              self<span class="token punctuation">.</span><span class="token function">_drawWxmlImage</span><span class="token punctuation">(</span>sub<span class="token punctuation">,</span> resolve2<span class="token punctuation">,</span> reject2<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'radius-image'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              self<span class="token punctuation">.</span><span class="token function">_drawWxmlCircleImage</span><span class="token punctuation">(</span>sub<span class="token punctuation">,</span> resolve2<span class="token punctuation">,</span> reject2<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'background-image'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              self<span class="token punctuation">.</span><span class="token function">_drawWxmlBackgroundImage</span><span class="token punctuation">(</span>sub<span class="token punctuation">,</span> resolve2<span class="token punctuation">,</span> reject2<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> all
  <span class="token punctuation">}</span>

  <span class="token function">_drawWxmlInline</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> sorted<span class="token punctuation">,</span> all<span class="token punctuation">,</span> progress<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> self <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">let</span> topOffset <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">let</span> leftOffset <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">let</span> lastTop <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">let</span> limitLeft <span class="token operator">=</span> results <span class="token operator">?</span> results<span class="token punctuation">.</span>left <span class="token operator">:</span> <span class="token number">0</span>
    <span class="token keyword">let</span> limitTop <span class="token operator">=</span> results <span class="token operator">?</span> results<span class="token punctuation">.</span>top <span class="token operator">:</span> <span class="token number">0</span>
    <span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve2<span class="token punctuation">,</span> reject2</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">let</span> maxWidth <span class="token operator">=</span> <span class="token number">0</span>
      <span class="token keyword">let</span> minLeft <span class="token operator">=</span> <span class="token number">Infinity</span>
      <span class="token keyword">let</span> maxRight <span class="token operator">=</span> <span class="token number">0</span>

      <span class="token comment">// 找出同一top下的最小left和最大right，得到最大的宽度，用于换行</span>
      Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>sorted<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">top</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">let</span> inlineList <span class="token operator">=</span> sorted<span class="token punctuation">[</span>top<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>
          <span class="token punctuation">(</span><span class="token parameter">sub</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> sub<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>type <span class="token operator">&amp;&amp;</span> sub<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>type<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'inline'</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        inlineList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">sub</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>sub<span class="token punctuation">.</span>left <span class="token operator">&lt;</span> minLeft<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            minLeft <span class="token operator">=</span> sub<span class="token punctuation">.</span>left
          <span class="token punctuation">}</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>sub<span class="token punctuation">.</span>right <span class="token operator">&gt;</span> maxRight<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            maxRight <span class="token operator">=</span> sub<span class="token punctuation">.</span>right
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      maxWidth <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>maxRight <span class="token operator">-</span> minLeft <span class="token operator">||</span> self<span class="token punctuation">.</span>width<span class="token punctuation">)</span>

      Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>sorted<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">top<span class="token punctuation">,</span> topIndex</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 左 -&gt; 右</span>
        <span class="token keyword">let</span> list <span class="token operator">=</span> sorted<span class="token punctuation">[</span>top<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span> a<span class="token punctuation">.</span>left <span class="token operator">-</span> b<span class="token punctuation">.</span>left
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token comment">// 换行的行内元素left放到后面，version2.0.6后无法获取高度，改用bottom值来判断是否换行了</span>
        <span class="token keyword">let</span> position <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> len <span class="token operator">=</span> list<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> list<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>bottom <span class="token operator">&gt;</span> list<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>bottom<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              position <span class="token operator">=</span> i
              <span class="token keyword">break</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>position <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>position<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">let</span> inlineList <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>
          <span class="token punctuation">(</span><span class="token parameter">sub</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> sub<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>type <span class="token operator">&amp;&amp;</span> sub<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>type<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'inline'</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">let</span> originLeft <span class="token operator">=</span> inlineList<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">?</span> inlineList<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>left <span class="token operator">:</span> <span class="token number">0</span>
        <span class="token comment">// 换行后和top不相等时，认为是换行了，要清除左边距；当左偏移量大于最大宽度时，也要清除左边距; 当左偏移小于左边距时，也要清除</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>
          Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>topOffset <span class="token operator">+</span> lastTop <span class="token operator">-</span> top<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">2</span> <span class="token operator">||</span>
          leftOffset <span class="token operator">-</span> originLeft <span class="token operator">-</span> limitLeft <span class="token operator">&gt;=</span> maxWidth <span class="token operator">||</span>
          leftOffset <span class="token operator">&lt;=</span> originLeft <span class="token operator">-</span> limitLeft <span class="token operator">-</span> <span class="token number">2</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          leftOffset <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token punctuation">}</span>

        lastTop <span class="token operator">=</span> <span class="token operator">+</span>top
        topOffset <span class="token operator">=</span> <span class="token number">0</span>

        inlineList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">sub<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          sub <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token function">_transferWxmlStyle</span><span class="token punctuation">(</span>sub<span class="token punctuation">,</span> item<span class="token punctuation">,</span> limitLeft<span class="token punctuation">,</span> limitTop<span class="token punctuation">)</span>
          sub<span class="token punctuation">.</span>progress <span class="token operator">=</span> progress
          <span class="token keyword">let</span> type <span class="token operator">=</span> sub<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>type
          <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'inline-text'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">let</span> drawRes <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token function">_drawWxmlInlineText</span><span class="token punctuation">(</span>sub<span class="token punctuation">,</span> leftOffset<span class="token punctuation">,</span> maxWidth<span class="token punctuation">)</span>
            leftOffset <span class="token operator">=</span> drawRes<span class="token punctuation">.</span>leftOffset
            topOffset <span class="token operator">=</span> drawRes<span class="token punctuation">.</span>topOffset
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'inline-image'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">let</span> drawRes <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token function">_drawWxmlImage</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
            leftOffset <span class="token operator">=</span> drawRes<span class="token punctuation">.</span>leftOffset <span class="token operator">||</span> <span class="token number">0</span>
            topOffset <span class="token operator">=</span> drawRes<span class="token punctuation">.</span>topOffset <span class="token operator">||</span> <span class="token number">0</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token function">resolve2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    all<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    <span class="token keyword">return</span> all
  <span class="token punctuation">}</span>

  <span class="token function">_drawWxmlInlineText</span><span class="token punctuation">(</span><span class="token parameter">sub<span class="token punctuation">,</span> leftOffset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> maxWidth</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> text <span class="token operator">=</span> sub<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>text <span class="token operator">||</span> <span class="token string">''</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sub<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>maxlength <span class="token operator">&amp;&amp;</span> text<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> sub<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>maxlength<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      text <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> sub<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>maxlength<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'...'</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> textData <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
      text<span class="token punctuation">,</span>
      <span class="token literal-property property">originX</span><span class="token operator">:</span> sub<span class="token punctuation">.</span>left<span class="token punctuation">,</span>
      <span class="token literal-property property">x</span><span class="token operator">:</span> leftOffset <span class="token operator">?</span> leftOffset <span class="token operator">:</span> sub<span class="token punctuation">.</span>left<span class="token punctuation">,</span>
      <span class="token literal-property property">y</span><span class="token operator">:</span> sub<span class="token punctuation">.</span>top<span class="token punctuation">,</span>
      <span class="token literal-property property">progress</span><span class="token operator">:</span> sub<span class="token punctuation">.</span>progress<span class="token punctuation">,</span>
      <span class="token literal-property property">leftOffset</span><span class="token operator">:</span> leftOffset<span class="token punctuation">,</span>
      <span class="token literal-property property">maxWidth</span><span class="token operator">:</span> maxWidth<span class="token punctuation">,</span> <span class="token comment">// 行内元素的最大宽度，取决于limit的宽度</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>sub<span class="token punctuation">.</span>backgroundColor <span class="token operator">!==</span> <span class="token string">'rgba(0, 0, 0, 0)'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      sub<span class="token punctuation">.</span>background <span class="token operator">=</span> sub<span class="token punctuation">.</span>backgroundColor
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      sub<span class="token punctuation">.</span>background <span class="token operator">=</span> <span class="token string">'rgba(0, 0, 0, 0)'</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>sub<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>background<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      sub<span class="token punctuation">.</span>background <span class="token operator">=</span> sub<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>background
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_drawText</span><span class="token punctuation">(</span>textData<span class="token punctuation">,</span> sub<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'inline-text'</span><span class="token punctuation">,</span> <span class="token string">'wxml'</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> res
  <span class="token punctuation">}</span>

  <span class="token function">_drawWxmlText</span><span class="token punctuation">(</span><span class="token parameter">sub<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> text <span class="token operator">=</span> sub<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>text <span class="token operator">||</span> <span class="token string">''</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sub<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>maxlength <span class="token operator">&amp;&amp;</span> text<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> sub<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>maxlength<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      text <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> sub<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>maxlength<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'...'</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> textData <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
      text<span class="token punctuation">,</span>
      <span class="token literal-property property">x</span><span class="token operator">:</span> sub<span class="token punctuation">.</span>left<span class="token punctuation">,</span>
      <span class="token literal-property property">y</span><span class="token operator">:</span> sub<span class="token punctuation">.</span>top<span class="token punctuation">,</span>
      <span class="token literal-property property">progress</span><span class="token operator">:</span> sub<span class="token punctuation">.</span>progress<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sub<span class="token punctuation">.</span>backgroundColor <span class="token operator">!==</span> <span class="token string">'rgba(0, 0, 0, 0)'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      sub<span class="token punctuation">.</span>background <span class="token operator">=</span> sub<span class="token punctuation">.</span>backgroundColor
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      sub<span class="token punctuation">.</span>background <span class="token operator">=</span> <span class="token string">'rgba(0, 0, 0, 0)'</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>sub<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>background<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      sub<span class="token punctuation">.</span>background <span class="token operator">=</span> sub<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>background
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_drawText</span><span class="token punctuation">(</span>textData<span class="token punctuation">,</span> sub<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">,</span> <span class="token string">'text'</span><span class="token punctuation">,</span> <span class="token string">'wxml'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">_drawWxmlImage</span><span class="token punctuation">(</span><span class="token parameter">sub<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> imageData <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">url</span><span class="token operator">:</span> sub<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
      <span class="token literal-property property">x</span><span class="token operator">:</span> sub<span class="token punctuation">.</span>left<span class="token punctuation">,</span>
      <span class="token literal-property property">y</span><span class="token operator">:</span> sub<span class="token punctuation">.</span>top<span class="token punctuation">,</span>
      <span class="token literal-property property">progress</span><span class="token operator">:</span> sub<span class="token punctuation">.</span>progress<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_drawRect</span><span class="token punctuation">(</span>
      imageData<span class="token punctuation">,</span>
      sub<span class="token punctuation">,</span>
      resolve<span class="token punctuation">,</span>
      reject<span class="token punctuation">,</span>
      <span class="token string">'image'</span><span class="token punctuation">,</span>
      <span class="token string">'inline-wxml'</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">return</span> res
  <span class="token punctuation">}</span>

  <span class="token function">_drawWxmlCircleImage</span><span class="token punctuation">(</span><span class="token parameter">sub<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> imageData <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">url</span><span class="token operator">:</span> sub<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
      <span class="token literal-property property">x</span><span class="token operator">:</span> sub<span class="token punctuation">.</span>left<span class="token punctuation">,</span>
      <span class="token literal-property property">y</span><span class="token operator">:</span> sub<span class="token punctuation">.</span>top<span class="token punctuation">,</span>
      <span class="token literal-property property">progress</span><span class="token operator">:</span> sub<span class="token punctuation">.</span>progress<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    sub<span class="token punctuation">.</span>r <span class="token operator">=</span> sub<span class="token punctuation">.</span>width <span class="token operator">/</span> <span class="token number">2</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_drawCircle</span><span class="token punctuation">(</span>imageData<span class="token punctuation">,</span> sub<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">'wxml'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">_drawWxmlBackgroundImage</span><span class="token punctuation">(</span><span class="token parameter">sub<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> url <span class="token operator">=</span> sub<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>url
    <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_findPicIndex</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    url <span class="token operator">=</span> index <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>allPic<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>local <span class="token operator">:</span> url
    <span class="token keyword">let</span> size <span class="token operator">=</span> sub<span class="token punctuation">.</span>backgroundSize<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">px</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>

    <span class="token keyword">let</span> imageData <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">url</span><span class="token operator">:</span> url<span class="token punctuation">,</span>
      <span class="token literal-property property">x</span><span class="token operator">:</span> sub<span class="token punctuation">.</span>left<span class="token punctuation">,</span>
      <span class="token literal-property property">y</span><span class="token operator">:</span> sub<span class="token punctuation">.</span>top<span class="token punctuation">,</span>
      <span class="token literal-property property">progress</span><span class="token operator">:</span> sub<span class="token punctuation">.</span>progress<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_drawRect</span><span class="token punctuation">(</span>imageData<span class="token punctuation">,</span> sub<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">,</span> <span class="token string">'image'</span><span class="token punctuation">,</span> <span class="token string">'wxml'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">_getWxml</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> style</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> self <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">let</span> query
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      query <span class="token operator">=</span> wx<span class="token punctuation">.</span><span class="token function">createSelectorQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>obj<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      query <span class="token operator">=</span> wx<span class="token punctuation">.</span><span class="token function">createSelectorQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 会触发两次，要限制</span>
      <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span>
      query
        <span class="token punctuation">.</span><span class="token function">selectAll</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>item<span class="token punctuation">.</span>class<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">fields</span><span class="token punctuation">(</span>
          <span class="token punctuation">{<!-- --></span>
            <span class="token literal-property property">dataset</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token literal-property property">rect</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token literal-property property">computedStyle</span><span class="token operator">:</span> <span class="token punctuation">[</span>
              <span class="token string">'width'</span><span class="token punctuation">,</span>
              <span class="token string">'height'</span><span class="token punctuation">,</span>
              <span class="token string">'font'</span><span class="token punctuation">,</span>
              <span class="token string">'fontSize'</span><span class="token punctuation">,</span>
              <span class="token string">'fontFamily'</span><span class="token punctuation">,</span>
              <span class="token string">'fontWeight'</span><span class="token punctuation">,</span>
              <span class="token string">'fontStyle'</span><span class="token punctuation">,</span>
              <span class="token string">'textAlign'</span><span class="token punctuation">,</span>
              <span class="token string">'color'</span><span class="token punctuation">,</span>
              <span class="token string">'lineHeight'</span><span class="token punctuation">,</span>
              <span class="token string">'border'</span><span class="token punctuation">,</span>
              <span class="token string">'borderColor'</span><span class="token punctuation">,</span>
              <span class="token string">'borderStyle'</span><span class="token punctuation">,</span>
              <span class="token string">'borderWidth'</span><span class="token punctuation">,</span>
              <span class="token string">'verticalAlign'</span><span class="token punctuation">,</span>
              <span class="token string">'boxShadow'</span><span class="token punctuation">,</span>
              <span class="token string">'background'</span><span class="token punctuation">,</span>
              <span class="token string">'backgroundColor'</span><span class="token punctuation">,</span>
              <span class="token string">'backgroundImage'</span><span class="token punctuation">,</span>
              <span class="token string">'backgroundPosition'</span><span class="token punctuation">,</span>
              <span class="token string">'backgroundSize'</span><span class="token punctuation">,</span>
              <span class="token string">'paddingLeft'</span><span class="token punctuation">,</span>
              <span class="token string">'paddingTop'</span><span class="token punctuation">,</span>
              <span class="token string">'paddingRight'</span><span class="token punctuation">,</span>
              <span class="token string">'paddingBottom'</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>count<span class="token operator">++</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token keyword">let</span> formated <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token function">_formatImage</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
              <span class="token keyword">let</span> list <span class="token operator">=</span> formated<span class="token punctuation">.</span>list
              res <span class="token operator">=</span> formated<span class="token punctuation">.</span>res

              self
                <span class="token punctuation">.</span><span class="token function">_preloadImage</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
                  <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
                  reject <span class="token operator">&amp;&amp;</span>
                    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                      <span class="token literal-property property">errcode</span><span class="token operator">:</span> <span class="token number">1009</span><span class="token punctuation">,</span>
                      <span class="token literal-property property">errmsg</span><span class="token operator">:</span> <span class="token string">'drawWxml preLoadImage error'</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">let</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>item<span class="token punctuation">.</span>limit<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">top</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">width</span><span class="token operator">:</span> self<span class="token punctuation">.</span>width <span class="token operator">/</span> self<span class="token punctuation">.</span>zoom <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      query
        <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>item<span class="token punctuation">.</span>limit<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">fields</span><span class="token punctuation">(</span>
          <span class="token punctuation">{<!-- --></span>
            <span class="token literal-property property">dataset</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token literal-property property">rect</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">_getLineHeight</span><span class="token punctuation">(</span><span class="token parameter">style</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> zoom <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>zoom
    <span class="token keyword">if</span> <span class="token punctuation">(</span>style<span class="token punctuation">.</span>dataset <span class="token operator">&amp;&amp;</span> style<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      zoom <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> lineHeight
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isNaN</span><span class="token punctuation">(</span>style<span class="token punctuation">.</span>lineHeight<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> style<span class="token punctuation">.</span>lineHeight <span class="token operator">&gt;</span> style<span class="token punctuation">.</span>fontSize<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      lineHeight <span class="token operator">=</span> style<span class="token punctuation">.</span>lineHeight
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      style<span class="token punctuation">.</span>lineHeight <span class="token operator">=</span> <span class="token punctuation">(</span>style<span class="token punctuation">.</span>lineHeight <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">''</span>
      lineHeight <span class="token operator">=</span> <span class="token operator">+</span>style<span class="token punctuation">.</span>lineHeight<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'px'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
      lineHeight <span class="token operator">=</span> lineHeight <span class="token operator">?</span> lineHeight <span class="token operator">:</span> <span class="token punctuation">(</span>style<span class="token punctuation">.</span>fontSize <span class="token operator">||</span> <span class="token number">14</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.2</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> lineHeight <span class="token operator">*</span> zoom
  <span class="token punctuation">}</span>

  <span class="token function">_formatImage</span><span class="token punctuation">(</span><span class="token parameter">res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    res<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">let</span> dataset <span class="token operator">=</span> item<span class="token punctuation">.</span>dataset
      <span class="token keyword">let</span> uid <span class="token operator">=</span> Util<span class="token punctuation">.</span><span class="token function">getUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">let</span> filename <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>wx<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">USER_DATA_PATH</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>uid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.png</span><span class="token template-punctuation string">`</span></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token punctuation">(</span>dataset<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'image'</span> <span class="token operator">||</span> dataset<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'radius-image'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        dataset<span class="token punctuation">.</span>url
      <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">let</span> sub <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
          <span class="token literal-property property">url</span><span class="token operator">:</span> dataset<span class="token punctuation">.</span>base64 <span class="token operator">?</span> filename <span class="token operator">:</span> dataset<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
          <span class="token literal-property property">isBase64</span><span class="token operator">:</span> dataset<span class="token punctuation">.</span>base64 <span class="token operator">?</span> dataset<span class="token punctuation">.</span>url <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>

        res<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>dataset <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>res<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>dataset<span class="token punctuation">,</span> sub<span class="token punctuation">)</span>
        list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
        dataset<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'background-image'</span> <span class="token operator">&amp;&amp;</span>
        item<span class="token punctuation">.</span>backgroundImage<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'url'</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">let</span> url <span class="token operator">=</span> item<span class="token punctuation">.</span>backgroundImage
          <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">url\((\"|\')?</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(\"|\')?\)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
        <span class="token keyword">let</span> sub <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
          <span class="token literal-property property">url</span><span class="token operator">:</span> dataset<span class="token punctuation">.</span>base64 <span class="token operator">?</span> filename <span class="token operator">:</span> url<span class="token punctuation">,</span>
          <span class="token literal-property property">isBase64</span><span class="token operator">:</span> dataset<span class="token punctuation">.</span>base64 <span class="token operator">?</span> url <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
        res<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>dataset <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>res<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>dataset<span class="token punctuation">,</span> sub<span class="token punctuation">)</span>
        list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span> list<span class="token punctuation">,</span> res <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">_updateProgress</span><span class="token punctuation">(</span><span class="token parameter">distance</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>progressPercent <span class="token operator">+=</span> distance
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">progress</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>progressPercent<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">_sortListByTop</span><span class="token punctuation">(</span><span class="token parameter">list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> sorted <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

    <span class="token comment">// 粗略地认为2px相差的元素在同一行</span>
    list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">let</span> top <span class="token operator">=</span> item<span class="token punctuation">.</span>top
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sorted<span class="token punctuation">[</span>top<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sorted<span class="token punctuation">[</span>top <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          top <span class="token operator">=</span> top <span class="token operator">-</span> <span class="token number">2</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sorted<span class="token punctuation">[</span>top <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          top <span class="token operator">=</span> top <span class="token operator">-</span> <span class="token number">1</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sorted<span class="token punctuation">[</span>top <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          top <span class="token operator">=</span> top <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sorted<span class="token punctuation">[</span>top <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          top <span class="token operator">=</span> top <span class="token operator">+</span> <span class="token number">2</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          sorted<span class="token punctuation">[</span>top<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      sorted<span class="token punctuation">[</span>top<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> sorted
  <span class="token punctuation">}</span>

  <span class="token function">_parseNumber</span><span class="token punctuation">(</span><span class="token parameter">number</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">isNaN</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token operator">+</span><span class="token punctuation">(</span>number <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'px'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">:</span> number
  <span class="token punctuation">}</span>

  <span class="token function">_transferWxmlStyle</span><span class="token punctuation">(</span><span class="token parameter">sub<span class="token punctuation">,</span> item<span class="token punctuation">,</span> limitLeft<span class="token punctuation">,</span> limitTop</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> leftFix <span class="token operator">=</span> <span class="token operator">+</span>sub<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>left <span class="token operator">||</span> <span class="token number">0</span>
    <span class="token keyword">let</span> topFix <span class="token operator">=</span> <span class="token operator">+</span>sub<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>top <span class="token operator">||</span> <span class="token number">0</span>

    sub<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_parseNumber</span><span class="token punctuation">(</span>sub<span class="token punctuation">.</span>width<span class="token punctuation">)</span>
    sub<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_parseNumber</span><span class="token punctuation">(</span>sub<span class="token punctuation">.</span>height<span class="token punctuation">)</span>
    sub<span class="token punctuation">.</span>left <span class="token operator">=</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_parseNumber</span><span class="token punctuation">(</span>sub<span class="token punctuation">.</span>left<span class="token punctuation">)</span> <span class="token operator">-</span>
      limitLeft <span class="token operator">+</span>
      <span class="token punctuation">(</span>leftFix <span class="token operator">+</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>x <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>zoom
    sub<span class="token punctuation">.</span>top <span class="token operator">=</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_parseNumber</span><span class="token punctuation">(</span>sub<span class="token punctuation">.</span>top<span class="token punctuation">)</span> <span class="token operator">-</span>
      limitTop <span class="token operator">+</span>
      <span class="token punctuation">(</span>topFix <span class="token operator">+</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>y <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>zoom

    <span class="token keyword">let</span> padding <span class="token operator">=</span> sub<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>padding <span class="token operator">||</span> <span class="token string">'0 0 0 0'</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> padding <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      padding <span class="token operator">=</span> Util<span class="token punctuation">.</span><span class="token function">transferPadding</span><span class="token punctuation">(</span>padding<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> paddingTop <span class="token operator">=</span>
      <span class="token function">Number</span><span class="token punctuation">(</span>sub<span class="token punctuation">.</span>paddingTop<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'px'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">Number</span><span class="token punctuation">(</span>padding<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> paddingRight <span class="token operator">=</span>
      <span class="token function">Number</span><span class="token punctuation">(</span>sub<span class="token punctuation">.</span>paddingRight<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'px'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">Number</span><span class="token punctuation">(</span>padding<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> paddingBottom <span class="token operator">=</span>
      <span class="token function">Number</span><span class="token punctuation">(</span>sub<span class="token punctuation">.</span>paddingBottom<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'px'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">Number</span><span class="token punctuation">(</span>padding<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> paddingLeft <span class="token operator">=</span>
      <span class="token function">Number</span><span class="token punctuation">(</span>sub<span class="token punctuation">.</span>paddingLeft<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'px'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">Number</span><span class="token punctuation">(</span>padding<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    sub<span class="token punctuation">.</span>padding <span class="token operator">=</span> <span class="token punctuation">[</span>paddingTop<span class="token punctuation">,</span> paddingRight<span class="token punctuation">,</span> paddingBottom<span class="token punctuation">,</span> paddingLeft<span class="token punctuation">]</span>

    <span class="token keyword">return</span> sub
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 支持负值绘制，从右边计算
   * @param {*} item
   * @param {*} style
   */</span>
  <span class="token function">_resetPositionX</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> style</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> zoom <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>zoom
    <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>style<span class="token punctuation">.</span>dataset <span class="token operator">&amp;&amp;</span> style<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      zoom <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 通过wxml获取的不需要重置坐标</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>x <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> item<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      x <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>width <span class="token operator">+</span> item<span class="token punctuation">.</span>x <span class="token operator">*</span> zoom <span class="token operator">-</span> style<span class="token punctuation">.</span>width <span class="token operator">*</span> zoom
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      x <span class="token operator">=</span> item<span class="token punctuation">.</span>x <span class="token operator">*</span> zoom
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>style<span class="token punctuation">.</span>borderWidth<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      x <span class="token operator">+=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>style<span class="token punctuation">.</span>borderWidth<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> x <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>translateX
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 支持负值绘制，从底部计算
   * @param {*} item
   * @param {*} style
   */</span>
  <span class="token function">_resetPositionY</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> style<span class="token punctuation">,</span> textHeight</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> zoom <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>zoom
    <span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>style<span class="token punctuation">.</span>dataset <span class="token operator">&amp;&amp;</span> style<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      zoom <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      y <span class="token operator">=</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>height <span class="token operator">+</span>
        item<span class="token punctuation">.</span>y <span class="token operator">*</span> zoom <span class="token operator">-</span>
        <span class="token punctuation">(</span>textHeight <span class="token operator">?</span> textHeight <span class="token operator">:</span> style<span class="token punctuation">.</span>height <span class="token operator">*</span> zoom<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      y <span class="token operator">=</span> item<span class="token punctuation">.</span>y <span class="token operator">*</span> zoom
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>style<span class="token punctuation">.</span>borderWidth<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      y <span class="token operator">+=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>style<span class="token punctuation">.</span>borderWidth<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> y <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>translateY
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 文字的padding、text-align
   * @param {*} item
   * @param {*} style
   * @param {*} textWidth
   */</span>
  <span class="token function">_resetTextPositionX</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> style<span class="token punctuation">,</span> textWidth<span class="token punctuation">,</span> width</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> textAlign <span class="token operator">=</span> style<span class="token punctuation">.</span>textAlign <span class="token operator">||</span> <span class="token string">'left'</span>
    <span class="token keyword">let</span> x <span class="token operator">=</span> item<span class="token punctuation">.</span>x
    <span class="token keyword">if</span> <span class="token punctuation">(</span>textAlign <span class="token operator">===</span> <span class="token string">'center'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      x <span class="token operator">=</span> <span class="token punctuation">(</span>width <span class="token operator">-</span> textWidth<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">+</span> item<span class="token punctuation">.</span>x
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>textAlign <span class="token operator">===</span> <span class="token string">'right'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      x <span class="token operator">=</span> width <span class="token operator">-</span> textWidth <span class="token operator">+</span> item<span class="token punctuation">.</span>x
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> left <span class="token operator">=</span> style<span class="token punctuation">.</span>padding <span class="token operator">?</span> style<span class="token punctuation">.</span>padding<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token number">0</span>

    <span class="token keyword">return</span> x <span class="token operator">+</span> left <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>translateX
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 文字的padding、text-align
   * @param {*} item
   * @param {*} style
   * @param {*} textWidth
   */</span>
  <span class="token function">_resetTextPositionY</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> style<span class="token punctuation">,</span> lineNum <span class="token operator">=</span> <span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> zoom <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>zoom
    <span class="token keyword">if</span> <span class="token punctuation">(</span>style<span class="token punctuation">.</span>dataset <span class="token operator">&amp;&amp;</span> style<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      zoom <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> lineHeight <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getLineHeight</span><span class="token punctuation">(</span>style<span class="token punctuation">)</span>
    <span class="token keyword">let</span> fontSize <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span><span class="token punctuation">(</span>style<span class="token punctuation">.</span>fontSize <span class="token operator">||</span> <span class="token number">14</span><span class="token punctuation">)</span> <span class="token operator">*</span> zoom<span class="token punctuation">)</span>

    <span class="token keyword">let</span> blockLineHeightFix <span class="token operator">=</span>
      <span class="token punctuation">(</span><span class="token punctuation">(</span>style<span class="token punctuation">.</span>dataset <span class="token operator">&amp;&amp;</span> style<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'inline'</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span>
        <span class="token operator">?</span> <span class="token number">0</span>
        <span class="token operator">:</span> <span class="token punctuation">(</span>lineHeight <span class="token operator">-</span> fontSize<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>

    <span class="token keyword">let</span> top <span class="token operator">=</span> style<span class="token punctuation">.</span>padding <span class="token operator">?</span> style<span class="token punctuation">.</span>padding<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token number">0</span>

    <span class="token comment">// y + lineheight偏移 + 行数 + paddingTop + 整体画布位移</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      item<span class="token punctuation">.</span>y <span class="token operator">+</span> blockLineHeightFix <span class="token operator">+</span> lineNum <span class="token operator">*</span> lineHeight <span class="token operator">+</span> top <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>translateY
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 当文本超过宽度时，计算每一行应该绘制的文本
   * @param {*} text
   * @param {*} width
   * @param {*} singleLength
   * @param {*} currentIndex
   * @param {*} widthOffset
   */</span>
  <span class="token function">_getTextSingleLine</span><span class="token punctuation">(</span>
    <span class="token parameter">text<span class="token punctuation">,</span>
    width<span class="token punctuation">,</span>
    singleLength<span class="token punctuation">,</span>
    currentIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    widthOffset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
  <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> offset <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">let</span> endIndex <span class="token operator">=</span> currentIndex <span class="token operator">+</span> singleLength <span class="token operator">+</span> offset
    <span class="token keyword">let</span> single <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>currentIndex<span class="token punctuation">,</span> endIndex<span class="token punctuation">)</span>
    <span class="token keyword">let</span> singleWidth <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">measureWidth</span><span class="token punctuation">(</span>single<span class="token punctuation">)</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>widthOffset <span class="token operator">+</span> singleWidth<span class="token punctuation">)</span> <span class="token operator">&gt;</span> width<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      offset<span class="token operator">--</span>
      endIndex <span class="token operator">=</span> currentIndex <span class="token operator">+</span> singleLength <span class="token operator">+</span> offset
      single <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>currentIndex<span class="token punctuation">,</span> endIndex<span class="token punctuation">)</span>
      singleWidth <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">measureWidth</span><span class="token punctuation">(</span>single<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
      endIndex<span class="token punctuation">,</span>
      single<span class="token punctuation">,</span>
      singleWidth<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">_drawBorder</span><span class="token punctuation">(</span><span class="token parameter">border<span class="token punctuation">,</span> style<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> zoom <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>zoom
    <span class="token keyword">if</span> <span class="token punctuation">(</span>style<span class="token punctuation">.</span>dataset <span class="token operator">&amp;&amp;</span> style<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      zoom <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
    border <span class="token operator">=</span> Util<span class="token punctuation">.</span><span class="token function">transferBorder</span><span class="token punctuation">(</span>border<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>border <span class="token operator">&amp;&amp;</span> border<span class="token punctuation">.</span>width<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 空白阴影，清空掉边框的阴影</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_drawBoxShadow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>border<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">setLineWidth</span><span class="token punctuation">(</span>border<span class="token punctuation">.</span>width <span class="token operator">*</span> zoom<span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>border<span class="token punctuation">.</span>style <span class="token operator">===</span> <span class="token string">'dashed'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">let</span> dash <span class="token operator">=</span> style<span class="token punctuation">.</span>dash <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
          <span class="token keyword">let</span> offset <span class="token operator">=</span> dash<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">0</span>
          <span class="token keyword">let</span> array <span class="token operator">=</span> <span class="token punctuation">[</span>dash<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">5</span><span class="token punctuation">,</span> dash<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">5</span><span class="token punctuation">]</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">setLineDash</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> offset<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">setStrokeStyle</span><span class="token punctuation">(</span>border<span class="token punctuation">.</span>color<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      callback <span class="token operator">&amp;&amp;</span> <span class="token function">callback</span><span class="token punctuation">(</span>border<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">_drawBoxShadow</span><span class="token punctuation">(</span><span class="token parameter">boxShadow<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    boxShadow <span class="token operator">=</span> Util<span class="token punctuation">.</span><span class="token function">transferBoxShadow</span><span class="token punctuation">(</span>boxShadow<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>boxShadow<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">setShadow</span><span class="token punctuation">(</span>
        boxShadow<span class="token punctuation">.</span>offsetX<span class="token punctuation">,</span>
        boxShadow<span class="token punctuation">.</span>offsetY<span class="token punctuation">,</span>
        boxShadow<span class="token punctuation">.</span>blur<span class="token punctuation">,</span>
        boxShadow<span class="token punctuation">.</span>color<span class="token punctuation">,</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">setShadow</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'#ffffff'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    callback <span class="token operator">&amp;&amp;</span> <span class="token function">callback</span><span class="token punctuation">(</span>boxShadow <span class="token operator">||</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">_setFill</span><span class="token punctuation">(</span><span class="token parameter">fill<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fill<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> fill <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">setFillStyle</span><span class="token punctuation">(</span>fill<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">let</span> line <span class="token operator">=</span> fill<span class="token punctuation">.</span>line
        <span class="token keyword">let</span> color <span class="token operator">=</span> fill<span class="token punctuation">.</span>color
        <span class="token keyword">let</span> grd <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">createLinearGradient</span><span class="token punctuation">(</span>
          line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          line<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          line<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          line<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        grd<span class="token punctuation">.</span><span class="token function">addColorStop</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> color<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        grd<span class="token punctuation">.</span><span class="token function">addColorStop</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> color<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">setFillStyle</span><span class="token punctuation">(</span>grd<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      callback <span class="token operator">&amp;&amp;</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">_setStroke</span><span class="token punctuation">(</span><span class="token parameter">stroke<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stroke<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> stroke <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">setStrokeStyle</span><span class="token punctuation">(</span>stroke<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">let</span> line <span class="token operator">=</span> stroke<span class="token punctuation">.</span>line
        <span class="token keyword">let</span> color <span class="token operator">=</span> stroke<span class="token punctuation">.</span>color
        <span class="token keyword">let</span> grd <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">createLinearGradient</span><span class="token punctuation">(</span>
          line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          line<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          line<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          line<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        grd<span class="token punctuation">.</span><span class="token function">addColorStop</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> color<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        grd<span class="token punctuation">.</span><span class="token function">addColorStop</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> color<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">setStrokeStyle</span><span class="token punctuation">(</span>grd<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      callback <span class="token operator">&amp;&amp;</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> Wxml2Canvas

</code></pre> 
<h3><a id="wxml2canvas_1599"></a>wxml2canvas使用</h3> 
<p>我们来看个demo，如下图，我的test文件夹下有个img文件夹，里面的test图片就是我的测试图片<br> <img src="https://images2.imgbox.com/25/43/PXZLnn3P_o.png" alt="在这里插入图片描述"><br> 我们的页面有文本有图片，需要将这些所有的内容合起来转为一张大图传给后端，这里需要注意的几个点是：wxml里canvas-id=“canvas1"一定要与new Wxml2Canvas方法里的element相对应，然后canvas的宽高设为100vw和100vh这样生成的图片不会变小了。根元素设置限定范围limit，比如我这里根元素class为my_canvas，那就应该是limit: ‘.my_canvas’,然后每个要单独绘制的元素class都有一个类名my_draw_canvas我们也要与之匹配。然后文本的话text要设置 data-type=“text” data-text=“我是pages/test/test.wxml页面”，其中data-text是文本内容。如果是图片的话，image标签要设置data-type=“image” data-url=”./img/test.jpg"，其中data-url是图片地址。这里我用到了wx.getFileSystemManager().readFile将图片临时地址转为base64， 下面是我这个demo的源码：</p> 
<pre><code class="prism language-javascript"><span class="token comment">//test.wxml</span>
<span class="token operator">&lt;</span>view<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>view  id<span class="token operator">=</span><span class="token string">"my_canvas"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"my_canvas box"</span> <span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>text <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"my_draw_canvas tips"</span> data<span class="token operator">-</span>type<span class="token operator">=</span><span class="token string">"text"</span> data<span class="token operator">-</span>text<span class="token operator">=</span><span class="token string">"我是pages/test/test.wxml页面"</span><span class="token operator">&gt;</span>我是pages<span class="token operator">/</span>test<span class="token operator">/</span>test<span class="token punctuation">.</span>wxml页面<span class="token operator">&lt;</span><span class="token operator">/</span>text<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>text <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"my_draw_canvas explain"</span> data<span class="token operator">-</span>type<span class="token operator">=</span><span class="token string">"text"</span> data<span class="token operator">-</span>text<span class="token operator">=</span><span class="token string">"测试wxml2canvas转图片功能"</span><span class="token operator">&gt;</span>测试wxml2canvas转图片功能<span class="token operator">&lt;</span><span class="token operator">/</span>text<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>image <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"my_draw_canvas img"</span> data<span class="token operator">-</span>type<span class="token operator">=</span><span class="token string">"image"</span> data<span class="token operator">-</span>url<span class="token operator">=</span><span class="token string">"./img/test.jpg"</span> src<span class="token operator">=</span><span class="token string">"./img/test.jpg"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>image<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>view<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>button type<span class="token operator">=</span><span class="token string">"primary"</span>  <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"btn"</span> bindtap<span class="token operator">=</span><span class="token string">"drawImage1"</span><span class="token operator">&gt;</span>点我进行转换<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>

  <span class="token operator">&lt;</span>view <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"result"</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>text<span class="token operator">&gt;</span>下面是用canvas生成的图片：<span class="token operator">&lt;</span><span class="token operator">/</span>text<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>image <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"resultImg"</span> style<span class="token operator">=</span><span class="token string">"width:100vw;height:100vh"</span>  src<span class="token operator">=</span><span class="token string">"{<!-- -->{FinallySign}}"</span> mode<span class="token operator">=</span><span class="token string">""</span><span class="token operator">/</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>view<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>view<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>canvas canvas<span class="token operator">-</span>id<span class="token operator">=</span><span class="token string">"canvas1"</span> style<span class="token operator">=</span><span class="token string">"width:100vw;height:100vh"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>canvas<span class="token operator">&gt;</span>

<span class="token comment">//test.wxss</span>
<span class="token punctuation">.</span>box<span class="token punctuation">{<!-- --></span>
    text<span class="token operator">-</span>align<span class="token operator">:</span> center<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span>box <span class="token punctuation">.</span>img<span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">height</span><span class="token operator">:</span> 100vh<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span>box <span class="token punctuation">.</span>tips<span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">display</span><span class="token operator">:</span> inline<span class="token operator">-</span>block<span class="token punctuation">;</span>
    <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token number">100</span><span class="token operator">%</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span>btn<span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">width</span><span class="token operator">:</span><span class="token number">60</span><span class="token operator">%</span><span class="token punctuation">;</span>
    <span class="token literal-property property">margin</span><span class="token operator">:</span>30rpx auto<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span>result<span class="token punctuation">{<!-- --></span>
  
    text<span class="token operator">-</span>align<span class="token operator">:</span> center<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span>result text<span class="token punctuation">{<!-- --></span>
    margin<span class="token operator">-</span>bottom<span class="token operator">:</span>50rpx<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span>result <span class="token punctuation">.</span>resultImg<span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">width</span><span class="token operator">:</span><span class="token number">100</span><span class="token operator">%</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//test.js</span>
<span class="token comment">// pages/test.js</span>

<span class="token keyword">import</span> Wxml2Canvas <span class="token keyword">from</span> <span class="token string">'../../src/index'</span><span class="token punctuation">;</span>

<span class="token function">Page</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 页面的初始数据
     */</span>
    <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token literal-property property">FinallySign</span><span class="token operator">:</span><span class="token string">''</span><span class="token punctuation">,</span>
        <span class="token literal-property property">imageWidth</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token comment">//画在画布上的图片的宽度</span>
        <span class="token literal-property property">imageHeight</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token comment">//画在画布上的图片的高度</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">drawImage1</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">let</span> that <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> drawMyImage  <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Wxml2Canvas</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">// width: 340,</span>
            <span class="token comment">// height: 210,</span>
            <span class="token literal-property property">width</span><span class="token operator">:</span> that<span class="token punctuation">.</span>data<span class="token punctuation">.</span>imageWidth <span class="token operator">*</span> <span class="token number">2</span> <span class="token punctuation">,</span>
            <span class="token literal-property property">height</span><span class="token operator">:</span> that<span class="token punctuation">.</span>data<span class="token punctuation">.</span>imageHeight <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token string">'px'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">element</span><span class="token operator">:</span> <span class="token string">'canvas1'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">background</span><span class="token operator">:</span> <span class="token string">'#f0f0f0'</span><span class="token punctuation">,</span>
            <span class="token function">progress</span> <span class="token punctuation">(</span><span class="token parameter">percent</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function">finish</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"生成的图片地址"</span><span class="token punctuation">,</span>url<span class="token punctuation">)</span>
                wx<span class="token punctuation">.</span><span class="token function">getFileSystemManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                    <span class="token literal-property property">filePath</span><span class="token operator">:</span> url<span class="token punctuation">,</span>
                    <span class="token literal-property property">encoding</span><span class="token operator">:</span> <span class="token string">'base64'</span><span class="token punctuation">,</span>
                    <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
                      <span class="token keyword">let</span> MyImageBase64 <span class="token operator">=</span> <span class="token string">'data:image/jpg;base64,'</span> <span class="token operator">+</span> res<span class="token punctuation">.</span>data
                      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'MyImageBase64'</span><span class="token punctuation">,</span> MyImageBase64<span class="token punctuation">)</span>
                      that<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                        <span class="token literal-property property">FinallySign</span><span class="token operator">:</span> MyImageBase64<span class="token punctuation">,</span>
                      <span class="token punctuation">}</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                  <span class="token punctuation">}</span><span class="token punctuation">)</span>

             
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function">error</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"生成的图片失败"</span><span class="token punctuation">,</span>res<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token literal-property property">list</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
                <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'wxml'</span><span class="token punctuation">,</span>
                <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'.my_canvas .my_draw_canvas'</span><span class="token punctuation">,</span> <span class="token comment">//.my_draw_canvas每个要绘制元素的类名</span>
                <span class="token literal-property property">limit</span><span class="token operator">:</span> <span class="token string">'.my_canvas'</span><span class="token punctuation">,</span> <span class="token comment">//my_canvas根元素类名</span>
                <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">0</span>
            <span class="token punctuation">}</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>

        drawMyImage<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span>that<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">/**
     * 生命周期函数--监听页面显示
     */</span>
    <span class="token function">onShow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">const</span> that <span class="token operator">=</span> <span class="token keyword">this</span>
        <span class="token keyword">const</span> query <span class="token operator">=</span> wx<span class="token punctuation">.</span><span class="token function">createSelectorQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>

    query
      <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'#my_canvas'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">fields</span><span class="token punctuation">(</span>
        <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 选择需要生成canvas的范围</span>
          <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token literal-property property">node</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token literal-property property">scrollOffset</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">let</span> width <span class="token operator">=</span> data<span class="token punctuation">.</span>width
          <span class="token keyword">let</span> height <span class="token operator">=</span> data<span class="token punctuation">.</span>height
          that<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            <span class="token literal-property property">imageWidth</span><span class="token operator">:</span> width<span class="token punctuation">,</span>
            <span class="token literal-property property">imageHeight</span><span class="token operator">:</span> height<span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

 
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre> 
<p>下面附上github地址：</p> 
<blockquote> 
 <p><a href="https://gitcode.net/mirrors/liudongyun1215/wxml2canvas?utm_source=csdn_github_accelerator" rel="nofollow">https://gitcode.net/mirrors/liudongyun1215/wxml2canvas?utm_source=csdn_github_accelerator</a></p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/71/76/riPESILP_o.png" alt="请添加图片描述"><br> <img src="https://images2.imgbox.com/97/54/TfQiEJg7_o.png" alt="请添加图片描述"><br> <img src="https://images2.imgbox.com/a3/55/he5Ec6N6_o.png" alt="请添加图片描述"><br> <img src="https://images2.imgbox.com/80/65/jqgv7zgi_o.png" alt="请添加图片描述"><br> <img src="https://images2.imgbox.com/39/15/ByauZniu_o.png" alt="请添加图片描述"><br> <img src="https://images2.imgbox.com/a9/37/8KSsLkTZ_o.png" alt="请添加图片描述"><br> <img src="https://images2.imgbox.com/ad/e1/1S4DEyn5_o.png" alt="请添加图片描述"><br> <img src="https://images2.imgbox.com/63/95/cflCTKPo_o.png" alt="请添加图片描述"><br> <img src="https://images2.imgbox.com/80/2c/2dRGgqUQ_o.png" alt="请添加图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/787383781a7178bf027b95c5a67679ea/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">CS使用&#43;后渗透</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8586013bb3c459292ff389061fbacb99/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">解决@MapKey is required</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>