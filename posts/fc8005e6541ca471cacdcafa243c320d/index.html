<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ES 数据插入异常原因分析 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ES 数据插入异常原因分析" />
<meta property="og:description" content="24-01-23.15:50:18.635 [I/O dispatcher 1] WARN org.elasticsearch.client.RestClient - request [HEAD http://localhost:9200/alarm_msg?ignore_throttled=false&amp;include_type_name=true&amp;ignore_unavailable=false&amp;expand_wildcards=open&amp;allow_no_indices=true] returned 1 warnings: [299 Elasticsearch-7.17.13-2b211dbb8bfdecaf7f5b44d356bdfe54b1050c13 &#34;[ignore_throttled] parameter is deprecated because frozen indices have been deprecated. Consider cold or frozen tiers in place of frozen indices.&#34;]
Exception in thread &#34;I/O dispatcher 1&#34; java.lang.AssertionError
at org.elasticsearch.client.Response.assertWarningValue(Response.java:193)
at org.elasticsearch.client.Response.extractWarningValueFromWarningHeader(Response.java:183)
at org.elasticsearch.client.Response.getWarnings(Response.java:205)
at org.elasticsearch.client.RestClient$1.completed(RestClient.java:546)
at org.elasticsearch.client.RestClient$1.completed(RestClient.java:537)
Springboot 执行 ES 单元测试时发生上述异常 , 看提示应该是因为使用了 ignore_throttled 过期参数导致的，但是我的查询并没有使用这个字段，那它是从哪里来的呢？
先 debug 查看异常处代码 Response.assertWarningValue
private static final Pattern WARNING_HEADER_PATTERN = Pattern." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/fc8005e6541ca471cacdcafa243c320d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-23T18:58:00+08:00" />
<meta property="article:modified_time" content="2024-01-23T18:58:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ES 数据插入异常原因分析</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <blockquote> 
 <p>24-01-23.15:50:18.635 [I/O dispatcher 1] WARN  org.elasticsearch.client.RestClient  - request [HEAD http://localhost:9200/alarm_msg?ignore_throttled=false&amp;include_type_name=true&amp;ignore_unavailable=false&amp;expand_wildcards=open&amp;allow_no_indices=true] returned 1 warnings: [299 Elasticsearch-7.17.13-2b211dbb8bfdecaf7f5b44d356bdfe54b1050c13 "[ignore_throttled] parameter is deprecated because frozen indices have been deprecated. Consider cold or frozen tiers in place of frozen indices."]<br> Exception in thread "I/O dispatcher 1" java.lang.AssertionError<br>     at org.elasticsearch.client.Response.assertWarningValue(Response.java:193)<br>     at org.elasticsearch.client.Response.extractWarningValueFromWarningHeader(Response.java:183)<br>     at org.elasticsearch.client.Response.getWarnings(Response.java:205)<br>     at org.elasticsearch.client.RestClient$1.completed(RestClient.java:546)<br>     at org.elasticsearch.client.RestClient$1.completed(RestClient.java:537)</p> 
</blockquote> 
<p>        Springboot 执行 ES 单元测试时发生上述异常 , 看提示应该是因为使用了 ignore_throttled 过期参数导致的，但是我的查询并没有使用这个字段，那它是从哪里来的呢？</p> 
<p>先 debug 查看异常处代码 Response.assertWarningValue</p> 
<p><img alt="" height="1190" src="https://images2.imgbox.com/fa/60/HGDaIfEv_o.png" width="1200"></p> 
<pre><code class="language-java">private static final Pattern WARNING_HEADER_PATTERN = Pattern.compile(
            "299 " + // warn code
            "Elasticsearch-\\d+\\.\\d+\\.\\d+(?:-(?:alpha|beta|rc)\\d+)?(?:-SNAPSHOT)?-(?:[a-f0-9]{7}|Unknown) " + // warn agent
            "\"((?:\t| |!|[\\x23-\\x5B]|[\\x5D-\\x7E]|[\\x80-\\xFF]|\\\\|\\\\\")*)\"( " + // quoted warning value, captured
            // quoted RFC 1123 date format
            "\"" + // opening quote
            "(?:Mon|Tue|Wed|Thu|Fri|Sat|Sun), " + // weekday
            "\\d{2} " + // 2-digit day
            "(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) " + // month
            "\\d{4} " + // 4-digit year
            "\\d{2}:\\d{2}:\\d{2} " + // (two-digit hour):(two-digit minute):(two-digit second)
            "GMT" + // GMT
            "\")?");

private static boolean assertWarningValue(final String s, final String warningValue) {
        final Matcher matcher = WARNING_HEADER_PATTERN.matcher(s);
        final boolean matches = matcher.matches();
        assert matches;
        return matcher.group(1).equals(warningValue);
}</code></pre> 
<p>这段代码是从 es 请求的响应中提取告警信息，判断是否符合断言，该正则表达式分为三部分</p> 
<blockquote> 
 <p>1、299 Elasticsearch-xxx...</p> 
 <p>2、捕获的告警信息</p> 
 <p>3、时间（可有可无）</p> 
</blockquote> 
<p>对比运行时异常信息发现，<span style="color:#fe2c24;">299 Elasticsearch-7.17.13-2b211dbb8bfdecaf7f5b44d356bdfe54b1050c13 不在 WARNING_HEADER_PATTERN 约束的版本内</span>，导致匹配失败，分析下我使用的版本信息 </p> 
<blockquote> 
 <ul><li> <pre>maven 依赖信息
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-dependencies&lt;/artifactId&gt;
    &lt;version&gt;2.2.6.RELEASE&lt;/version&gt;
    &lt;type&gt;pom&lt;/type&gt;
    &lt;scope&gt;import&lt;/scope&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.data&lt;/groupId&gt;
    &lt;artifactId&gt;spring-data-elasticsearch&lt;/artifactId&gt;
    &lt;version&gt;3.2.6.RELEASE&lt;/version&gt;
&lt;/dependency&gt;</pre> </li><li>ES  版本 <span style="color:#fe2c24;">7.17.13</span></li></ul> 
</blockquote> 
<p>查看官网各版本对应关系：<br>  <a href="https://docs.spring.io/spring-data/elasticsearch/docs/5.1.x/reference/html/#preface.requirements" rel="nofollow" title="Spring Data Elasticsearch - Reference Documentation">Spring Data Elasticsearch - Reference Documentation</a></p> 
<p><img alt="" height="1106" src="https://images2.imgbox.com/02/87/Jr3FynRe_o.png" width="1200"><span title="点击并拖拽以改变尺寸">​</span></p> 
<p>升级 springboot 版本为 2.7.10</p> 
<p><img alt="" height="357" src="https://images2.imgbox.com/03/84/0Q7sanF0_o.png" width="524"><span title="点击并拖拽以改变尺寸">​</span></p> 
<p>再次执行单元测试通过，没有异常信息，数据正常插入ES</p> 
<p></p> 
<p><span style="color:#fe2c24;">注：</span>[ignore_throttled] parameter is deprecated because frozen indices have been deprecated. Consider cold or frozen tiers in place of frozen indices. 是什么 ？</p> 
<blockquote> 
 <p><span id="cke_bm_58499C"> </span><span style="color:#0d0016;">什么是 <code>ignore_throttled ？</code></span></p> 
 <ul><li><code>ignore_throttled=<span style="color:#fe2c24;">true </span></code><span style="color:#fe2c24;">会忽略被限制的分片并继续执行搜索操作，可能导致搜索结果的不完整性</span>（分片受到资源限制或负载高，且无法及时响应搜索请求，这些被限制的分片将会被忽略）;而 <code>ignore_throttled=<span style="color:#fe2c24;">false </span></code><span style="color:#fe2c24;">会等待被限制的分片完成操作并返回完整的结果，确保搜索结果的完整性和准确性</span>，但可能会增加搜索请求的响应时间。</li><li> <code>ignore_throttled </code>参数在版本6.4.0中开始被废弃（deprecated），并且在版本7.0.0中完全移除（removed），建议使用默认值<code>false</code></li><li>在 7.0 版本中，可以使用 search.allow_partial_results（true/false 用于控制搜索操作是否允许返回部分结果） 替代 ignore_throttled 参数 ignore_throttled</li></ul> 
 <p></p> 
 <p><span id="cke_bm_59639C"> </span><span style="color:#0d0016;">为什么在高版本中不需要<code>ignore_throttled了？</code></span></p> 
 <ul><li>改进索引策略：高版本的Elasticsearch引入了改进的索引策略，其中包括更好的分片管理和负载均衡机制。这些改进使得Elasticsearch能够更好地处理高负载和资源限制的情况，而不需要显式地忽略被限制的分片。</li><li>自适应限速（Adaptive Throttling）：较高版本的Elasticsearch引入了自适应限速机制，它根据系统的负载情况自动调整操作的速度。自适应限速能够更智能地应对资源限制和负载情况，而无需开发人员手动设置忽略被限制的分片。</li><li>保证结果的完整性：忽略被限制的分片可能会导致搜索结果的不完整性，因为被限制的分片可能包含一部分数据。为了确保搜索结果的准确性和完整性，建议不忽略被限制的分片，而是等待它们完成操作并返回完整的结果。</li></ul> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/bd15fd3c4e1652076dc642aa88439f51/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Mybatis----缓存</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/808d8fb88fe80a26b2f57aced7a09ce7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">C# winform 代码反编译，如何防护？套壳？混淆？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>