<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>VUE&#43;servlet上传多文件实践 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="VUE&#43;servlet上传多文件实践" />
<meta property="og:description" content="前言： 网上有很多使用el-upload上传多个文件的文章，但是百度了一下，要么就是代码贴的不完整，要么就是完全不能使用的。找了一圈，最后竟然找不到一个可用的。所以最后只能选择自己造轮子了。
一：我的方案 1.1 现成的方案：
网上通用的方案是放弃本身的action上传，通过指定http-request方法。这样点击提交后就不会发起action请求。然后通过form表单的方式拼接参数，添加文件然后进行请求。
我尝试了这种方式，发现后台无法正常的接受前端发过来的请求，发过来的请求都是只包含文件名，但是不包含文件内容。所以只能无奈放弃这种方案了。
1.2 我的方案：
我的方案是这样的，支持多文件上传，这样多文件，点击上传的时候会触发多次action请求。
在成功回调里面计数，如果成功的次数等于待上传的个数，那就是成功，否则是失败。
二：实现-VUE部分 首先是布局的部分，就是正常的使用el-upload上传。
&lt;template&gt; &lt;div class=&#34;login-view&#34;&gt; &lt;div class=&#34;login-form&#34;&gt; ...无用代码略过 &lt;el-form ref=&#34;form&#34; label-position=&#34;left&#34; :model=&#34;form&#34; class=&#34;el-form&#34;&gt; &lt;el-form-item label=&#34;上传文件:&#34; prop=&#34;excelFile&#34;&gt; &lt;el-upload class=&#34;el-upload&#34; ref=&#34;upload&#34; multiple :action=&#34;this.SERVE_URL &#43; &#39;upload_img&#39;&#34; name=&#34;excelFile&#34; drag :data=&#34;upData&#34; :on-change=&#34;onUploadChange&#34; :file-list=&#34;fileList&#34; :on-error=&#34;uploadFalse&#34; :on-success=&#34;uploadSuccess&#34; :auto-upload=&#34;false&#34; &gt; &lt;i class=&#34;el-icon-upload&#34;&gt;&lt;/i&gt; &lt;div class=&#34;el-upload__text&#34;&gt;将文件拖到此处，或&lt;em&gt;点击上传&lt;/em&gt;&lt;/div&gt; &lt;!-- &lt;el-button slot=&#34;trigger&#34; size=&#34;small&#34; &gt;选取文件&lt;/el-button&gt; --&gt; &lt;/el-upload&gt; &lt;/el-form-item&gt; &lt;/el-form&gt; &lt;div class=&#34;button-view&#34;&gt; &lt;!-- &lt;p&gt;头像: &lt;input type=&#34;file&#34; id=&#34;files&#34; ref=&#34;refFile&#34; multiple=&#34;multiple&#34; v-on:change=&#34;fileLoad&#34; /&gt;&lt;/p&gt; --&gt; &lt;button @click=&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/275d38662c8de27d229828b02d18030b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-13T10:36:55+08:00" />
<meta property="article:modified_time" content="2023-07-13T10:36:55+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">VUE&#43;servlet上传多文件实践</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h3>前言：</h3> 
<p>网上有很多使用el-upload上传多个文件的文章，但是百度了一下，要么就是代码贴的不完整，要么就是完全不能使用的。找了一圈，最后竟然找不到一个可用的。所以最后只能选择自己造轮子了。</p> 
<p></p> 
<h3>一：我的方案</h3> 
<p><strong>1.1 现成的方案：</strong></p> 
<p>网上通用的方案是放弃本身的action上传，通过指定http-request方法。这样点击提交后就不会发起action请求。然后通过form表单的方式拼接参数，添加文件然后进行请求。</p> 
<p>我尝试了这种方式，发现后台无法正常的接受前端发过来的请求，发过来的请求都是只包含文件名，但是不包含文件内容。所以只能无奈放弃这种方案了。</p> 
<p></p> 
<p><strong>1.2 我的方案：</strong></p> 
<p>我的方案是这样的，支持多文件上传，这样多文件，点击上传的时候会触发多次action请求。</p> 
<p>在成功回调里面计数，如果成功的次数等于待上传的个数，那就是成功，否则是失败。</p> 
<p></p> 
<p></p> 
<h3>二：实现-VUE部分</h3> 
<p></p> 
<p><strong>首先是布局的部分，就是正常的使用el-upload上传。</strong></p> 
<pre><code>&lt;template&gt;
  &lt;div class="login-view"&gt;
    &lt;div class="login-form"&gt;
     ...无用代码略过

      &lt;el-form ref="form" label-position="left" :model="form" class="el-form"&gt;
        &lt;el-form-item label="上传文件:" prop="excelFile"&gt;
          &lt;el-upload
            class="el-upload"
            ref="upload"
            multiple
            :action="this.SERVE_URL + 'upload_img'"
            name="excelFile"
            drag
            :data="upData"
            :on-change="onUploadChange"
            :file-list="fileList"
            :on-error="uploadFalse"
            :on-success="uploadSuccess"
            :auto-upload="false"
          &gt;
            &lt;i class="el-icon-upload"&gt;&lt;/i&gt;
            &lt;div class="el-upload__text"&gt;将文件拖到此处，或&lt;em&gt;点击上传&lt;/em&gt;&lt;/div&gt;
            &lt;!-- &lt;el-button slot="trigger" size="small" &gt;选取文件&lt;/el-button&gt; --&gt;
          &lt;/el-upload&gt;
        &lt;/el-form-item&gt;
      &lt;/el-form&gt;
      &lt;div class="button-view"&gt;
        &lt;!-- &lt;p&gt;头像: &lt;input type="file" id="files" ref="refFile" multiple="multiple" v-on:change="fileLoad" /&gt;&lt;/p&gt; --&gt;
        &lt;button @click="submitUpload"&gt;提交&lt;/button&gt;
        &lt;button @click="closePage"&gt;关闭&lt;/button&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;</code></pre> 
<p>几个参数详细解释下，方便小白理解：</p> 
<p>1.multiple代表支持多文件上传，选择了这个选项后，点击提交如果有多个文件，会触发多次action的请求。</p> 
<p>2.action是上传的服务器地址接口名。</p> 
<p>3.on-change代表选择文件后的回调方法，请注意，不仅仅是选择文件后，上传成功时也会触发这个方法。</p> 
<p>4.file-list对应的是文件清单</p> 
<p>5.on-success代表上传成功时回调的接口</p> 
<p>6.au-upload="false"代表不自动上传</p> 
<p></p> 
<p><strong>然后是js部分：</strong></p> 
<pre><code>&lt;script&gt;

export default {
  components: {},
  props: {},
  data() {
    return {
      baseUrl: this.SERVE_URL + 'upload_img',
      isJump: false,
      accountInfo: {},
      imageUrl: '',
      imageFile: {},
      form: {},
      fileList: [],//等待上传的集合
      uploadSucessList: []//上传成功的集合
    }
  },
  computed: {
    upData: function () {
      return this.form
    }
  },
  created() {
    var accountInfo = this.$route.params
    this.accountInfo = accountInfo
  },

  mounted() {},
  methods: {
    onUploadChange(file) {
      if (file.status != 'ready') {
        return
      }
      this.fileList.push(file)
    },
    //文件上传成功触发
    uploadSuccess(response) {
      console.log(response)

      if (response.data.status == 200) {
        this.uploadSucessList = this.uploadSucessList.concat(response.data.imgList)
        if (this.uploadSucessList.length == this.fileList.length) {
          this.requestRegister(this.uploadSucessList)
        }
      } else {
        this.$message({
          message: '导入失败',
          type: 'error'
        })
      }
    },
    //文件上传失败触发
    uploadFalse() {
      this.$message({
        message: '文件上传失败！',
        type: 'error'
      })
    },

    //表单取消
    onCancel() {
      this.$refs.form.resetFields()
    },
    requestRegister(imgUrlList) {
       //注册新用户的逻辑
      debugger
      var that = this
      var imgUrl = '';
      imgUrlList.forEach(function (img) {
        imgUrl = imgUrl + img.imgUrl+";"
      })
       this.accountInfo.imgUrl = imgUrl
      const data = {
        accountInfo: JSON.stringify(this.accountInfo)
      }     
      //这里
      console.log('account:' + JSON.stringify(data))
      //请求登录
      this.$apis.user
        .requestSet(data)
        .then(response =&gt; {
          debugger
          console.log(response.message)
          this.$message({
            message: response.message
          })
          setTimeout(() =&gt; {
            that.$router.go(-1)
          }, 1000)
        })
        .catch(err =&gt; {
          console.log(err)
        })
        .finally(() =&gt; {
          this.showLoading = false
        })
    },
    //表单提交
    submitUpload() {
      if (this.fileList.length == 0) {
        this.requestRegister([])
        return
      }
      //触发组件的action
      this.$refs.upload.submit() //主要是这里
    },
    closePage() {
      this.$router.go(-1)
    }
  }
}
&lt;/script&gt;</code></pre> 
<p></p> 
<p></p> 
<p><strong>最后是CSS部分：</strong></p> 
<pre><code>&lt;style lang="scss" scoped&gt;
.login-view {
  width: 100%;
  height: 100%;
  box-sizing: border-box;
  text-align: center;
  // background-color: rgb(51, 51, 51);
  background-color: #fff;
  display: flex;
  flex-direction: column;
  justify-content: center;
  justify-items: center;
  align-items: center;
}
.login-form {
  display: flex;
  flex-direction: column;
  justify-content: left;
  justify-items: left;
  width: 50%;
  border: 1px solid #000;
  padding: 50px;
  p {
    display: flex;
    flex-direction: row;
    justify-content: left;
    label {
      width: 100px;
      text-align: right;
    }
    input {
      width: 400px;
    }
    b {
      width: 100%;
    }
  }
  .el-form {
    padding-left: 30px;
    margin-top: 10px;
  }
  .avatar-uploader el-upload {
    border: 1px dashed #d9d9d9;
    border-radius: 6px;
    cursor: pointer;
    position: relative;
    overflow: hidden;
  }
  .avatar-uploader .el-upload:hover {
    border-color: #409eff;
  }
  .avatar-uploader-icon {
    font-size: 28px;
    color: #8c939d;
    width: 178px;
    height: 178px;
    line-height: 178px;
    text-align: center;
  }
  .avatar {
    width: 178px;
    height: 178px;
    display: block;
  }
}
.button-view {
  display: flex;
  flex-direction: row;
  padding-left: 20%;
  padding-right: 20%;
  width: 100%;
  align-content: flex-start;
  justify-content: space-between;
  align-items: flex-start;
  button {
    font-size: 15px;
    padding: 10px 30px 10px 30px;
  }
}
&lt;/style&gt;
</code></pre> 
<p></p> 
<h3>三：实现后台部分</h3> 
<p>后台我使用的是comons-fileupload框架。</p> 
<p>核心代码如下，想看完整代码可以直接跳到第四章。</p> 
<p>request转换成FileItem对象</p> 
<pre><code>  public List&lt;FileItem&gt; readAllParams(HttpServletRequest request) throws Exception {
        DiskFileItemFactory factory = new DiskFileItemFactory();
        ServletFileUpload upload = new ServletFileUpload(factory);
        List&lt;FileItem&gt; fileItems = upload.parseRequest(request);
        return fileItems;
    }</code></pre> 
<p></p> 
<p>保存图片到本地，并返回生成的链接。（我图片直接放到了项目目录下了）</p> 
<pre><code> public JSONObject saveImage(ImageModel imageModel, String realPath) throws Exception {
        JSONObject data = new JSONObject();

        String path = realPath + "img/";
        String url = Config.SERVE_URL_RELEASE + "/img/";
        if (realPath.contains("out")) {
            //开发环境
            path = realPath + "img/";
            url = Config.SERVE_URL_DEBUG + "/img/";
        }
        if (imageModel.fileItems.size() &gt; 0) {
            for (ImgFile imgFile : imageModel.fileItems) {
                imgFile.imgPath = path + imgFile.imgName;
                imgFile.imgUrl = url + imgFile.imgName;
                File saveImgFile = new File(imgFile.imgPath);
                if (!saveImgFile.getParentFile().exists()) {
                    saveImgFile.getParentFile().mkdirs();
                }
                imgFile.fileItem.write(saveImgFile);
            }
            JSONArray imgList = new JSONArray();
            for (ImgFile imgFile : imageModel.fileItems) {
                JSONObject imgJson = new JSONObject();
                imgJson.put("imgName", imgFile.imgName);
                imgJson.put("imgPath", imgFile.imgPath);
                imgJson.put("imgUrl", imgFile.imgUrl);
                imgList.add(imgJson);
            }
            data.put("status", 200);
            data.put("imgList", imgList);
        } else {
            data.put("status", 500);
        }
        return data;
    }</code></pre> 
<p></p> 
<p></p> 
<h3>四：代码完整链接</h3> 
<p>项目地址：</p> 
<p><a href="https://github.com/aa5279aa/StaffManagerWeb" title="GitHub - aa5279aa/StaffManagerWeb: 员工管理系统">GitHub - aa5279aa/StaffManagerWeb: 员工管理系统</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b4d9aafb42447c667cccfa9ca3018d4f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">el-cascader级联选择器那些事</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a0804f4113d9f9a2d6b899daa7ab2964/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">SQL运行顺序</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>