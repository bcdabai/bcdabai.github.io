<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【Oracle RAC】JDBC连接oracle RAC数据库配置 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【Oracle RAC】JDBC连接oracle RAC数据库配置" />
<meta property="og:description" content="问题描述 生产上线系统，未能及时识别到Oracle数据库是RAC环境，上线时，Druid数据源配置按照单实例数据库配置，导致系统无法建立数据库连接，系统无法启动。
补充说明：数据连接池使用的是Alibaba的Druid。
临时解决方案 将原有数据库整库导出，在备机上创建单实例数据库，将生产库导入备机，之后启动系统，正常运行。 一个原则：保证业务能够正常实施！
最终解决方案 按照真实环境部署一套Rac测试环境，修改jdbc.url进行测试！
普通配置：
jdbc.url=jdbc\:oracle\:thin\:@127.0.0.1\:1521\:svr_name RAC下的url配置：
jdbc.url=jdbc\:oracle\:thin\:@(DESCRIPTION = (ADDRESS = (PROTOCOL = TCP)(HOST = host_ip1)(PORT = 1521)) (ADDRESS = (PROTOCOL = TCP)(HOST = host_ip2)(PORT = 1521)) (LOAD_BALANCE = yes)(failover=on)(connect_data= (service_name = oratest))) 其中：
host_ip1、host_ip2为你的rac数据库的两个甚至多个节点的ip地址（据说配置到/etc/hosts下也可以为服务id）
service_name 为你的数据库实例名
RAC特性 RAC 同时具备HA(High Availiablity) 和LB(LoadBalance)，而其高可用性的基础就是Failover(故障转移).。它指集群中任何一个节点的故障都不会影响用户的使用，连接到故障节点的用户会被自动转移到健康节点，从用户感受而言， 是感觉不到这种切换。
Oracle 10g RAC 的Failover 可以分为3种：
Client-Side Connect time FailoverTAFService-Side TAF Client-Side Connect time Failover 第一种Client-Side Connect time Failover的特点：只在建立连接那一时刻起作用。也就是说，这种Failover方式只在发起连接时才会去感知节点故障，如果节点没有反应，则自动尝试地址列表中的下一个地址。一旦连接建立之后，节点出现故障都不会做处理，从客户端的表现就是会话断开了，用户程序必须重新建立连接。启用这种Failover的方法就是在客户端的tnsnames.ora中添加FAILOVER=ON 条目，这个参数默认就是ON，所以即使不添加这个条目，客户端也会获得这种Failover能力。
TAF 第二种TAF的特点：建立连接以后，应用系统运行过程中，如果某个实例发生故障，连接到这个实例上的用户会被自动迁移到其他的健康实例上。对于应用程序而言，这个迁移过程是透明的，不需要用户的介入，当然，这种透明要是有引导的，因为用户的未提交事务会回滚。 相对于Client-Side Connect Time Failover的用户程序中断，抛出连接错误，用户必须重启应用程序，TAF 这种方式在提高HA上有了很大的进步。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/62f7085ae19628445c9b33ec21f25dba/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-10-10T15:09:14+08:00" />
<meta property="article:modified_time" content="2018-10-10T15:09:14+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【Oracle RAC】JDBC连接oracle RAC数据库配置</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div class="iteye-blog-content-contain" style="font-size:14px;"> 
 <h5 id="问题描述">问题描述</h5> 
 <p>生产上线系统，未能及时识别到Oracle数据库是RAC环境，上线时，Druid数据源配置按照单实例数据库配置，导致系统无法建立数据库连接，系统无法启动。</p> 
 <p><strong>补充说明</strong>：数据连接池使用的是<code>Alibaba的Druid</code>。</p> 
 <h5 id="临时解决方案">临时解决方案</h5> 
 <p>将原有数据库整库导出，在备机上创建单实例数据库，将生产库导入备机，之后启动系统，正常运行。 <br><strong>一个原则</strong>：保证业务能够正常实施！</p> 
 <h5 id="最终解决方案">最终解决方案</h5> 
 <p>按照真实环境部署一套Rac测试环境，修改<code>jdbc.url</code>进行测试！</p> 
 <p>普通配置：</p> 
 <pre class="prettyprint">jdbc.url=jdbc\:oracle\:thin\:@127.0.0.1\:1521\:svr_name</pre> 
 <p><code>RAC下的<code>url</code>配置：</code></p> 
 <pre class="prettyprint">jdbc.url=jdbc\:oracle\:thin\:@(DESCRIPTION = (ADDRESS = (PROTOCOL = TCP)(HOST = host_ip1)(PORT = 1521)) (ADDRESS = (PROTOCOL = TCP)(HOST = host_ip2)(PORT = 1521)) (LOAD_BALANCE = yes)(failover=on)(connect_data= (service_name = oratest)))</pre> 
 <p>其中：</p> 
 <blockquote> 
  <p><code>host_ip1</code>、<code>host_ip2</code>为你的rac数据库的两个甚至多个节点的ip地址（据说配置到<code>/etc/hosts</code>下也可以为服务id）</p> 
  <p><code>service_name</code> 为你的数据库实例名</p> 
 </blockquote> 
 <h5 id="rac特性">RAC特性</h5> 
 <p>RAC 同时具备<code>HA(High Availiablity)</code> 和<code>LB(LoadBalance)</code>，而其高可用性的基础就是<code>Failover</code>(故障转移).。它指集群中任何一个节点的故障都不会影响用户的使用，连接到故障节点的用户会被自动转移到健康节点，从用户感受而言， 是感觉不到这种切换。</p> 
 <p>Oracle 10g RAC 的<code>Failover</code> 可以分为3种：</p> 
 <blockquote> 
  <ol><li>Client-Side Connect time Failover</li><li>TAF</li><li>Service-Side TAF</li></ol> 
 </blockquote> 
 <h6 id="client-side-connect-time-failover">Client-Side Connect time Failover</h6> 
 <p>第一种<code>Client-Side Connect time Failover</code>的特点：只在建立连接那一时刻起作用。也就是说，这种Failover方式只在发起连接时才会去感知节点故障，如果节点没有反应，则自动尝试地址列表中的下一个地址。一旦连接建立之后，节点出现故障都不会做处理，从客户端的表现就是会话断开了，用户程序必须重新建立连接。启用这种Failover的方法就是在客户端的<code>tnsnames.ora</code>中添加<code>FAILOVER=ON</code> 条目，这个参数默认就是ON，所以即使不添加这个条目，客户端也会获得这种Failover能力。</p> 
 <h6 id="taf">TAF</h6> 
 <p>第二种<code>TAF</code>的特点：建立连接以后，应用系统运行过程中，如果某个实例发生故障，连接到这个实例上的用户会被自动迁移到其他的健康实例上。对于应用程序而言，这个迁移过程是透明的，不需要用户的介入，当然，这种透明要是有引导的，因为用户的未提交事务会回滚。 相对于<code>Client-Side Connect Time Failover</code>的用户程序中断，抛出连接错误，用户必须重启应用程序，TAF 这种方式在提高HA上有了很大的进步。</p> 
 <p><strong>启用方式</strong> <br> 只需要在客户端的<code>tnsnames.ora</code>中添加<code>FAILOVER_MODE</code>配置项。 <br><strong><em>1. METHOD: </em></strong> 用户定义何时创建到其实例的连接，有BASIC 和 PRECONNECT 两种可选值。</p> 
 <blockquote> 
  <p>BASIC： 是指在感知到节点故障时才创建到其他实例的连接。 <br> PRECONNECT: 是在最初建立连接时就同时建立到所有实例的连接，当发生故障时，立刻就可以切换到其他链路上。</p> 
 </blockquote> 
 <p><strong>两种方法比较：</strong> BASIC方式在Failover时会有时间延迟，PRECONNECT方式虽然没有时间延迟，但是建立多个冗余连接会消耗更多资源，两者就是是用时间换资源和用资源换时间的区别。 <br><strong><em>2. TYPE：</em></strong> 用于定义发生故障时对完成的SQL 语句如何处理，其中有2种类型：<code>session</code> 和<code>select</code>.</p> 
 <p>这2种方式对于未提交的事务都会自动回滚，<strong>区别之处在于对select 语句的处理</strong>：</p> 
 <blockquote> 
  <p>对于select，用户正在执行的select语句会被转移到新的实例上，在新的节点上继续返回后续结果集，而已经返回的记录集则抛弃。假设用户正在节点1上执行查询，整个结果集共有100条记录，现在已从节点1上返回10条记录，这时节点1宕机，用户连接被转移到节点2上，继续返回剩下的90条记录，而已经从节点1返回的10条记录不会重复返回给用户，对于用户而言，感受不到这种切换。</p> 
 </blockquote> 
 <p>=====</p> 
 <blockquote> 
  <p>如果是session模式，则需要重新执行查询语句。</p> 
 </blockquote> 
 <p>显然为了实现select 方式，Oracle 必须为每个session保存更多的内容，包括游标，用户上下文等，需要更多的资源也是用资源换时间的方案。</p> 
 <p><strong><em>3. DELAY 和 RETRIES: </em></strong>这2个参数分别代表重试间隔时间和重试次数。 <br><strong>示例：</strong></p> 
 <pre class="prettyprint">(
    FAILOVER_MODE=
        (TYPE=session)
        (METHOD=basic)
        (RETRIES=180)
        (DELAY=5)
 )</pre> 
 <h6 id="service-sidetaf">Service-SideTAF</h6> 
 <p>Service-SideTAF可以看作是TAF的一种变种，首先Service-SideTAF也是TAF，所有TAF的特点它都有，其次这种TAF是在服务器上配置的，而不像TAF是在客户端配置的。</p> 
 <h3 id="引用">引用</h3> 
 <p><a href="https://www.linuxidc.com/Linux/2011-05/36003.htm" rel="nofollow">Oracle RAC Failover 详解</a></p> 
 <p>--------------------- 作者：光阴迷客 来源：CSDN 原文：https://blog.csdn.net/changqing5818/article/details/80867962?utm_source=copy 版权声明：本文为博主原创文章，转载请附上博文链接！</p> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7a9db19cd73314ae61fecbe3a24f439b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">spring中过滤器（filter）、拦截器（interceptor）和切面（aop）的执行顺序</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f89ecf7ce76a5c942215385fde393257/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">传球游戏</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>