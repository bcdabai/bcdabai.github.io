<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Spring boot 过滤器实现防XSS攻击 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Spring boot 过滤器实现防XSS攻击" />
<meta property="og:description" content="文章目录 背景参考资料上代码过滤器配置可配置不过滤地址主要过滤器代码xss具体过滤规则注意扫描该包（或者加starter也行）关于富文本框 gitee代码仓库 背景 框架中添加xss攻击过滤器类，防止脚本攻击，能够做到引入包即可使用。
参考资料 这里主要参考renren-fast官方提供的开源项目的xss攻击进行改造。
参考io/renren/common/xss包下面类
三方包 hutool-http，参考博客api里面提供了xss所需的标签替换等功能
上代码 过滤器配置 /** * Filter配置 * * @author lirui */ @Configuration public class FilterConfig { /** * 注册过滤器 * * @param url 提供可不拦截接口 * 实现配置不过滤部分接口，部分接口需要不做过滤 * @return */ @Bean public FilterRegistrationBean xssFilterRegistration(XssIgnoreFilterUrl url) { FilterRegistrationBean registration = getFilterRegistrationBean(url); return registration; } private FilterRegistrationBean getFilterRegistrationBean(XssIgnoreFilterUrl url) { FilterRegistrationBean registration = new FilterRegistrationBean(); //指定发起请求时过滤 registration.setDispatcherTypes(DispatcherType.REQUEST); registration.setFilter(new XssFilter(Objects.isNull(url) ? null : url.getUrls())); //默认所有接口 registration." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/fb16e1ce5ad3b5a85868c9a69ada7a9c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-03-18T11:18:38+08:00" />
<meta property="article:modified_time" content="2021-03-18T11:18:38+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Spring boot 过滤器实现防XSS攻击</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-kimbie-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_1" rel="nofollow">背景</a></li><li><a href="#_4" rel="nofollow">参考资料</a></li><li><a href="#_11" rel="nofollow">上代码</a></li><li><ul><li><a href="#_13" rel="nofollow">过滤器配置</a></li><li><a href="#_51" rel="nofollow">可配置不过滤地址</a></li><li><a href="#_81" rel="nofollow">主要过滤器代码</a></li><li><a href="#xss_160" rel="nofollow">xss具体过滤规则</a></li><li><a href="#starter_184" rel="nofollow">注意扫描该包（或者加starter也行）</a></li><li><a href="#_187" rel="nofollow">关于富文本框</a></li></ul> 
  </li><li><a href="#gitee_191" rel="nofollow">gitee代码仓库</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>背景</h2> 
<p>框架中添加xss攻击过滤器类，防止脚本攻击，能够做到引入包即可使用。</p> 
<h2><a id="_4"></a>参考资料</h2> 
<p>这里主要参考<a href="https://www.renren.io/guide" rel="nofollow">renren-fast</a>官方提供的开源项目的xss攻击进行改造。</p> 
<blockquote> 
 <p>参考io/renren/common/xss包下面类</p> 
</blockquote> 
<p>三方包 <a href="https://mvnrepository.com/artifact/cn.hutool/hutool-http/5.6.0" rel="nofollow">hutool-http</a>，<a href="https://www.cnblogs.com/SceneryHao/articles/10969100.html" rel="nofollow">参考博客api</a>里面提供了xss所需的标签替换等功能</p> 
<h2><a id="_11"></a>上代码</h2> 
<h3><a id="_13"></a>过滤器配置</h3> 
<pre><code>/**
 * Filter配置
 *
 * @author lirui
 */
@Configuration
public class FilterConfig {

    /**
     * 注册过滤器
     *
     * @param url 提供可不拦截接口
     *            实现配置不过滤部分接口，部分接口需要不做过滤
     * @return
     */
    @Bean
    public FilterRegistrationBean xssFilterRegistration(XssIgnoreFilterUrl url) {
        FilterRegistrationBean registration = getFilterRegistrationBean(url);
        return registration;
    }

    private FilterRegistrationBean getFilterRegistrationBean(XssIgnoreFilterUrl url) {
        FilterRegistrationBean registration = new FilterRegistrationBean();
        //指定发起请求时过滤
        registration.setDispatcherTypes(DispatcherType.REQUEST);
        registration.setFilter(new XssFilter(Objects.isNull(url) ? null : url.getUrls()));
        //默认所有接口
        registration.addUrlPatterns("/*");
        registration.setName("xssFilter");
        //设置最后执行，防止有其他过滤器对值需要修改等操作，保证最后过滤字符即可
        registration.setOrder(Integer.MAX_VALUE);
        return registration;
    }
}
</code></pre> 
<h3><a id="_51"></a>可配置不过滤地址</h3> 
<pre><code>/**
 * xss忽略过滤地址
 *
 * @author LiRui
 * @version 1.0
 */
@Configuration
@ConfigurationProperties(prefix = "xss.ignore")
public class XssIgnoreFilterUrl {
    private Set&lt;String&gt; urls;

    public Set&lt;String&gt; getUrls() {
        return urls;
    }

    public void setUrls(Set&lt;String&gt; urls) {
        this.urls = urls;
    }
}

//yml配置
xss:
  ignore:
    urls:
      - /xss/form
</code></pre> 
<h3><a id="_81"></a>主要过滤器代码</h3> 
<pre><code>/**
 * XSS过滤
 *
 * @author lirui
 */
public class XssFilter implements Filter {

    private Set&lt;String&gt; excludedUris;

    public XssFilter() {
    }

    public XssFilter(Set&lt;String&gt; excludedUris) {
        this.excludedUris = excludedUris;
    }

    /**
     * 是否排除
     *
     * @param uri
     * @return
     */
    private boolean isExcludedUri(String uri) {
        if (CollectionUtils.isEmpty(excludedUris)) {
            return false;
        }
        for (String ex : excludedUris) {
            if (match(ex, uri)) {
                return true;
            }
        }
        return false;
    }

    /**
     * 地址匹配
     *
     * @param patternPath
     * @param requestPath
     * @return
     */
    public static boolean match(String patternPath, String requestPath) {
        if (StringUtils.isEmpty(patternPath) || StringUtils.isEmpty(requestPath)) {
            return false;
        }
        PathMatcher matcher = new AntPathMatcher();
        return matcher.match(patternPath, requestPath);
    }


    @Override
    public void init(FilterConfig config) throws ServletException {
    }

    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
            throws IOException, ServletException {
        //可配置多个字符串过滤
        XssHttpServletRequestWrapper xssRequest = new XssHttpServletRequestWrapper(
                (HttpServletRequest) request, new HTMLFilter());
        String url = xssRequest.getServletPath();
        if (isExcludedUri(url)) {
            chain.doFilter(request, response);
            return;
        }
        chain.doFilter(xssRequest, response);
    }

    @Override
    public void destroy() {
    }
}
</code></pre> 
<blockquote> 
 <p>这里注意match方法，用的Spring包的地址匹配工具，通过匹配地址是否需要过滤</p> 
</blockquote> 
<h3><a id="xss_160"></a>xss具体过滤规则</h3> 
<p>代码较多我就不贴，最后我会上传到gtee仓库。主要注意，renren-fast中如果存在&lt;或者&gt; 单个的，就会自动在求前面或者最后面进行添加另一符号。在过滤时就会删除前面或者后面内容，具体的可以自己试试renrenfast的代码，内容用&lt;或者&gt;一个符号加内容测试就明白了我的意思。 源代码中我将这段代码注释：</p> 
<pre><code>            //自动补充&lt;,&gt; 注释允许传递&lt;&gt;符号
//            s = regexReplace(P_BODY_TO_END, "&lt;$1&gt;", s);
//            s = regexReplace(P_XML_CONTENT, "$1&lt;$2", s);
</code></pre> 
<p>遇到这种标签，源码中返回的是xxxx，根据业务需求直接返回“”.使用hutool三方包调整代码（仓库中的代码没修改，需要同样需求的自己copy）:</p> 
<pre><code>return HtmlUtil.cleanHtmlTag(HtmlKit.getTextFromHtml(s));
//getTextFromHtml方法源码
  public static String getTextFromHtml(String htmlStr) {
        if (htmlStr == null) {
            return "";
        } else {
            htmlStr = delHtmlLabel(htmlStr);
            htmlStr = htmlStr.replaceAll("&amp;nbsp;", "");
            return htmlStr;
        }
    }
</code></pre> 
<h3><a id="starter_184"></a>注意扫描该包（或者加starter也行）</h3> 
<p>@SpringBootApplication(scanBasePackages = {“com.web”})</p> 
<h3><a id="_187"></a>关于富文本框</h3> 
<p>开放不做过滤接口配置主要是考虑富文本框的问题，看了很多文章其实主要是处理js脚本，尽量在前端做一次符号转义，然后后端xss攻击过滤器还是需要开启保证安全。</p> 
<h2><a id="gitee_191"></a>gitee代码仓库</h2> 
<p><a href="https://gitee.com/l502387174/xss-filter" rel="nofollow">仓库地址</a></p> 
<p>common是过滤器相关源码，web为自己测试的代码</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d014b4ca7459dfaed0b1aca53ee3ac84/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">elementui el-table去除鼠标触摸变色效果</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d18cbcafa1b301963be90d5022005d22/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">决策树信息增益|信息增益比率|基尼指数实例</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>