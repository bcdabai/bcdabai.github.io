<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>openwrt 框架分析 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="openwrt 框架分析" />
<meta property="og:description" content="转：openwrt 框架分析link.
阅读目录
openwrt目录结构
main Makefile
第一个逻辑
第二逻辑
目录变量
kernel 编译：
生成firmware
处理vmlinux: Image/BuildKernel
制作squashfs，生成.bin: $(call Image/mkfs/squashfs)
OpenWrt是一个典型的嵌入式Linux工程，了解OpenWrt的Makefile的工作过程对提高嵌入式Linux工程的开发能力有极其重要意义。
OpenWrt的主Makefile文件只有100行，可以简单分为三部分，117行为前导部分，1931为首次执行部分，33~101为再次执行部分。
前导部分
CURDIR为make默认变量，默认值为当前目录。
前导部分主要把变量TOPDIR赋值为当前目录，把变量LC_ALL、LANG赋值为C，并使用变量延伸指示符export，把上述三个变量延伸到下层Makefile。
使用文件使用指示符include引入 ( T O P D I R ) / i n c l u d e / h o s t . m k 。 在 O p e n W r t 的 主 M a k e f i l e 文 件 使 用 了 多 次 i n c l u d e 指 示 符 ， 说 明 主 M a k e f i l e 文 件 被 拆 分 成 多 个 文 件 ， 被 拆 分 的 文 件 放 在 不 同 的 目 录 。 拆 分 的 目 的 是 明 确 各 部 分 的 功 能 ， 而 且 增 加 其 灵 活 性 。 在 前 导 部 分 比 较 费 解 的 是 使 用 w o r l d 目 标 ， 在 m a k e f i l e 中 基 本 规 则 为 ： T A R G E T S : P R E R E Q U I S I T E S C O M M A N D ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/be781dc70d4a23017f3f43bcd627bf1e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-07-23T17:22:42+08:00" />
<meta property="article:modified_time" content="2019-07-23T17:22:42+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">openwrt 框架分析</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>转：openwrt 框架分析<a href="https://www.cnblogs.com/Malphite/p/9037095.html" rel="nofollow">link</a>.<br> 阅读目录</p> 
<p>openwrt目录结构<br> main Makefile<br> 第一个逻辑<br> 第二逻辑<br> 目录变量<br> kernel 编译：<br> 生成firmware<br> 处理vmlinux: Image/BuildKernel<br> 制作squashfs，生成.bin: $(call Image/mkfs/squashfs)</p> 
<p>OpenWrt是一个典型的嵌入式Linux工程，了解OpenWrt的Makefile的工作过程对提高嵌入式Linux工程的开发能力有极其重要意义。<br> OpenWrt的主Makefile文件只有100行，可以简单分为三部分，1<sub>17行为前导部分，19</sub>31为首次执行部分，33~101为再次执行部分。<br> 前导部分<br> CURDIR为make默认变量，默认值为当前目录。<br> 前导部分主要把变量TOPDIR赋值为当前目录，把变量LC_ALL、LANG赋值为C，并使用变量延伸指示符export，把上述三个变量延伸到下层Makefile。<br> 使用文件使用指示符include引入<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         T 
        
       
         O 
        
       
         P 
        
       
         D 
        
       
         I 
        
       
         R 
        
       
         ) 
        
       
         / 
        
       
         i 
        
       
         n 
        
       
         c 
        
       
         l 
        
       
         u 
        
       
         d 
        
       
         e 
        
       
         / 
        
       
         h 
        
       
         o 
        
       
         s 
        
       
         t 
        
       
         . 
        
       
         m 
        
       
         k 
        
       
         。 
        
       
         在 
        
       
         O 
        
       
         p 
        
       
         e 
        
       
         n 
        
       
         W 
        
       
         r 
        
       
         t 
        
       
         的 
        
       
         主 
        
       
         M 
        
       
         a 
        
       
         k 
        
       
         e 
        
       
         f 
        
       
         i 
        
       
         l 
        
       
         e 
        
       
         文 
        
       
         件 
        
       
         使 
        
       
         用 
        
       
         了 
        
       
         多 
        
       
         次 
        
       
         i 
        
       
         n 
        
       
         c 
        
       
         l 
        
       
         u 
        
       
         d 
        
       
         e 
        
       
         指 
        
       
         示 
        
       
         符 
        
       
         ， 
        
       
         说 
        
       
         明 
        
       
         主 
        
       
         M 
        
       
         a 
        
       
         k 
        
       
         e 
        
       
         f 
        
       
         i 
        
       
         l 
        
       
         e 
        
       
         文 
        
       
         件 
        
       
         被 
        
       
         拆 
        
       
         分 
        
       
         成 
        
       
         多 
        
       
         个 
        
       
         文 
        
       
         件 
        
       
         ， 
        
       
         被 
        
       
         拆 
        
       
         分 
        
       
         的 
        
       
         文 
        
       
         件 
        
       
         放 
        
       
         在 
        
       
         不 
        
       
         同 
        
       
         的 
        
       
         目 
        
       
         录 
        
       
         。 
        
       
         拆 
        
       
         分 
        
       
         的 
        
       
         目 
        
       
         的 
        
       
         是 
        
       
         明 
        
       
         确 
        
       
         各 
        
       
         部 
        
       
         分 
        
       
         的 
        
       
         功 
        
       
         能 
        
       
         ， 
        
       
         而 
        
       
         且 
        
       
         增 
        
       
         加 
        
       
         其 
        
       
         灵 
        
       
         活 
        
       
         性 
        
       
         。 
        
       
         在 
        
       
         前 
        
       
         导 
        
       
         部 
        
       
         分 
        
       
         比 
        
       
         较 
        
       
         费 
        
       
         解 
        
       
         的 
        
       
         是 
        
       
         使 
        
       
         用 
        
       
         w 
        
       
         o 
        
       
         r 
        
       
         l 
        
       
         d 
        
       
         目 
        
       
         标 
        
       
         ， 
        
       
         在 
        
       
         m 
        
       
         a 
        
       
         k 
        
       
         e 
        
       
         f 
        
       
         i 
        
       
         l 
        
       
         e 
        
       
         中 
        
       
         基 
        
       
         本 
        
       
         规 
        
       
         则 
        
       
         为 
        
       
         ： 
        
       
         T 
        
       
         A 
        
       
         R 
        
       
         G 
        
       
         E 
        
       
         T 
        
       
         S 
        
       
         : 
        
       
         P 
        
       
         R 
        
       
         E 
        
       
         R 
        
       
         E 
        
       
         Q 
        
       
         U 
        
       
         I 
        
       
         S 
        
       
         I 
        
       
         T 
        
       
         E 
        
       
         S 
        
       
         C 
        
       
         O 
        
       
         M 
        
       
         M 
        
       
         A 
        
       
         N 
        
       
         D 
        
       
         . 
        
       
         . 
        
       
         . 
        
       
         即 
        
       
         m 
        
       
         a 
        
       
         k 
        
       
         e 
        
       
         f 
        
       
         i 
        
       
         l 
        
       
         e 
        
       
         规 
        
       
         则 
        
       
         由 
        
       
         目 
        
       
         标 
        
       
         、 
        
       
         依 
        
       
         赖 
        
       
         、 
        
       
         命 
        
       
         令 
        
       
         三 
        
       
         部 
        
       
         分 
        
       
         组 
        
       
         成 
        
       
         ， 
        
       
         在 
        
       
         O 
        
       
         p 
        
       
         e 
        
       
         n 
        
       
         W 
        
       
         r 
        
       
         t 
        
       
         的 
        
       
         主 
        
       
         M 
        
       
         a 
        
       
         k 
        
       
         e 
        
       
         f 
        
       
         i 
        
       
         l 
        
       
         e 
        
       
         文 
        
       
         件 
        
       
         的 
        
       
         第 
        
       
         一 
        
       
         个 
        
       
         目 
        
       
         标 
        
       
         w 
        
       
         o 
        
       
         r 
        
       
         l 
        
       
         d 
        
       
         没 
        
       
         有 
        
       
         依 
        
       
         赖 
        
       
         和 
        
       
         命 
        
       
         令 
        
       
         。 
        
       
         它 
        
       
         主 
        
       
         要 
        
       
         起 
        
       
         到 
        
       
         指 
        
       
         示 
        
       
         当 
        
       
         m 
        
       
         a 
        
       
         k 
        
       
         e 
        
       
         命 
        
       
         令 
        
       
         不 
        
       
         带 
        
       
         目 
        
       
         标 
        
       
         时 
        
       
         所 
        
       
         要 
        
       
         执 
        
       
         行 
        
       
         的 
        
       
         目 
        
       
         标 
        
       
         ， 
        
       
         没 
        
       
         有 
        
       
         设 
        
       
         定 
        
       
         依 
        
       
         赖 
        
       
         和 
        
       
         命 
        
       
         令 
        
       
         部 
        
       
         分 
        
       
         表 
        
       
         明 
        
       
         此 
        
       
         目 
        
       
         标 
        
       
         在 
        
       
         此 
        
       
         后 
        
       
         将 
        
       
         会 
        
       
         有 
        
       
         其 
        
       
         他 
        
       
         依 
        
       
         赖 
        
       
         关 
        
       
         系 
        
       
         或 
        
       
         命 
        
       
         令 
        
       
         。 
        
       
         w 
        
       
         o 
        
       
         r 
        
       
         l 
        
       
         d 
        
       
         目 
        
       
         标 
        
       
         的 
        
       
         命 
        
       
         令 
        
       
         需 
        
       
         要 
        
       
         进 
        
       
         一 
        
       
         步 
        
       
         参 
        
       
         考 
        
       
      
        (TOPDIR)/include/host.mk。在OpenWrt的主Makefile文件使用了多次include指示符，说明主Makefile文件被拆分成多个文件，被拆分的文件放在不同的目录。拆分的目的是明确各部分的功能，而且增加其灵活性。 在前导部分比较费解的是使用world目标，在makefile中基本规则为： TARGETS : PREREQUISITES COMMAND ... 即makefile规则由目标、依赖、命令三部分组成，在OpenWrt的主Makefile文件的第一个目标world没有依赖和命令。它主要起到指示当make命令不带目标时所要执行的目标，没有设定依赖和命令部分表明此目标在此后将会有其他依赖关系或命令。world目标的命令需要进一步参考 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit" style="margin-right: 0.13889em;">T</span><span class="mord mathit" style="margin-right: 0.02778em;">O</span><span class="mord mathit" style="margin-right: 0.13889em;">P</span><span class="mord mathit" style="margin-right: 0.02778em;">D</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit" style="margin-right: 0.00773em;">R</span><span class="mclose">)</span><span class="mord">/</span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mord mathit">c</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">u</span><span class="mord mathit">d</span><span class="mord mathit">e</span><span class="mord">/</span><span class="mord mathit">h</span><span class="mord mathit">o</span><span class="mord mathit">s</span><span class="mord mathit">t</span><span class="mord">.</span><span class="mord mathit">m</span><span class="mord mathit" style="margin-right: 0.03148em;">k</span><span class="mord cjk_fallback">。</span><span class="mord cjk_fallback">在</span><span class="mord mathit" style="margin-right: 0.02778em;">O</span><span class="mord mathit">p</span><span class="mord mathit">e</span><span class="mord mathit">n</span><span class="mord mathit" style="margin-right: 0.13889em;">W</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord mathit">t</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">主</span><span class="mord mathit" style="margin-right: 0.10903em;">M</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.03148em;">k</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right: 0.10764em;">f</span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">e</span><span class="mord cjk_fallback">文</span><span class="mord cjk_fallback">件</span><span class="mord cjk_fallback">使</span><span class="mord cjk_fallback">用</span><span class="mord cjk_fallback">了</span><span class="mord cjk_fallback">多</span><span class="mord cjk_fallback">次</span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mord mathit">c</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">u</span><span class="mord mathit">d</span><span class="mord mathit">e</span><span class="mord cjk_fallback">指</span><span class="mord cjk_fallback">示</span><span class="mord cjk_fallback">符</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">说</span><span class="mord cjk_fallback">明</span><span class="mord cjk_fallback">主</span><span class="mord mathit" style="margin-right: 0.10903em;">M</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.03148em;">k</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right: 0.10764em;">f</span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">e</span><span class="mord cjk_fallback">文</span><span class="mord cjk_fallback">件</span><span class="mord cjk_fallback">被</span><span class="mord cjk_fallback">拆</span><span class="mord cjk_fallback">分</span><span class="mord cjk_fallback">成</span><span class="mord cjk_fallback">多</span><span class="mord cjk_fallback">个</span><span class="mord cjk_fallback">文</span><span class="mord cjk_fallback">件</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">被</span><span class="mord cjk_fallback">拆</span><span class="mord cjk_fallback">分</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">文</span><span class="mord cjk_fallback">件</span><span class="mord cjk_fallback">放</span><span class="mord cjk_fallback">在</span><span class="mord cjk_fallback">不</span><span class="mord cjk_fallback">同</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">目</span><span class="mord cjk_fallback">录</span><span class="mord cjk_fallback">。</span><span class="mord cjk_fallback">拆</span><span class="mord cjk_fallback">分</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">目</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">是</span><span class="mord cjk_fallback">明</span><span class="mord cjk_fallback">确</span><span class="mord cjk_fallback">各</span><span class="mord cjk_fallback">部</span><span class="mord cjk_fallback">分</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">功</span><span class="mord cjk_fallback">能</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">而</span><span class="mord cjk_fallback">且</span><span class="mord cjk_fallback">增</span><span class="mord cjk_fallback">加</span><span class="mord cjk_fallback">其</span><span class="mord cjk_fallback">灵</span><span class="mord cjk_fallback">活</span><span class="mord cjk_fallback">性</span><span class="mord cjk_fallback">。</span><span class="mord cjk_fallback">在</span><span class="mord cjk_fallback">前</span><span class="mord cjk_fallback">导</span><span class="mord cjk_fallback">部</span><span class="mord cjk_fallback">分</span><span class="mord cjk_fallback">比</span><span class="mord cjk_fallback">较</span><span class="mord cjk_fallback">费</span><span class="mord cjk_fallback">解</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">是</span><span class="mord cjk_fallback">使</span><span class="mord cjk_fallback">用</span><span class="mord mathit" style="margin-right: 0.02691em;">w</span><span class="mord mathit">o</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">d</span><span class="mord cjk_fallback">目</span><span class="mord cjk_fallback">标</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">在</span><span class="mord mathit">m</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.03148em;">k</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right: 0.10764em;">f</span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">e</span><span class="mord cjk_fallback">中</span><span class="mord cjk_fallback">基</span><span class="mord cjk_fallback">本</span><span class="mord cjk_fallback">规</span><span class="mord cjk_fallback">则</span><span class="mord cjk_fallback">为</span><span class="mord cjk_fallback">：</span><span class="mord mathit" style="margin-right: 0.13889em;">T</span><span class="mord mathit">A</span><span class="mord mathit" style="margin-right: 0.00773em;">R</span><span class="mord mathit">G</span><span class="mord mathit" style="margin-right: 0.05764em;">E</span><span class="mord mathit" style="margin-right: 0.13889em;">T</span><span class="mord mathit" style="margin-right: 0.05764em;">S</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.88888em; vertical-align: -0.19444em;"></span><span class="mord mathit" style="margin-right: 0.13889em;">P</span><span class="mord mathit" style="margin-right: 0.00773em;">R</span><span class="mord mathit" style="margin-right: 0.05764em;">E</span><span class="mord mathit" style="margin-right: 0.00773em;">R</span><span class="mord mathit" style="margin-right: 0.05764em;">E</span><span class="mord mathit">Q</span><span class="mord mathit" style="margin-right: 0.10903em;">U</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit" style="margin-right: 0.05764em;">S</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit" style="margin-right: 0.13889em;">T</span><span class="mord mathit" style="margin-right: 0.05764em;">E</span><span class="mord mathit" style="margin-right: 0.05764em;">S</span><span class="mord mathit" style="margin-right: 0.07153em;">C</span><span class="mord mathit" style="margin-right: 0.02778em;">O</span><span class="mord mathit" style="margin-right: 0.10903em;">M</span><span class="mord mathit" style="margin-right: 0.10903em;">M</span><span class="mord mathit">A</span><span class="mord mathit" style="margin-right: 0.10903em;">N</span><span class="mord mathit" style="margin-right: 0.02778em;">D</span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mord cjk_fallback">即</span><span class="mord mathit">m</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.03148em;">k</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right: 0.10764em;">f</span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">e</span><span class="mord cjk_fallback">规</span><span class="mord cjk_fallback">则</span><span class="mord cjk_fallback">由</span><span class="mord cjk_fallback">目</span><span class="mord cjk_fallback">标</span><span class="mord cjk_fallback">、</span><span class="mord cjk_fallback">依</span><span class="mord cjk_fallback">赖</span><span class="mord cjk_fallback">、</span><span class="mord cjk_fallback">命</span><span class="mord cjk_fallback">令</span><span class="mord cjk_fallback">三</span><span class="mord cjk_fallback">部</span><span class="mord cjk_fallback">分</span><span class="mord cjk_fallback">组</span><span class="mord cjk_fallback">成</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">在</span><span class="mord mathit" style="margin-right: 0.02778em;">O</span><span class="mord mathit">p</span><span class="mord mathit">e</span><span class="mord mathit">n</span><span class="mord mathit" style="margin-right: 0.13889em;">W</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord mathit">t</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">主</span><span class="mord mathit" style="margin-right: 0.10903em;">M</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.03148em;">k</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right: 0.10764em;">f</span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">e</span><span class="mord cjk_fallback">文</span><span class="mord cjk_fallback">件</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">第</span><span class="mord cjk_fallback">一</span><span class="mord cjk_fallback">个</span><span class="mord cjk_fallback">目</span><span class="mord cjk_fallback">标</span><span class="mord mathit" style="margin-right: 0.02691em;">w</span><span class="mord mathit">o</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">d</span><span class="mord cjk_fallback">没</span><span class="mord cjk_fallback">有</span><span class="mord cjk_fallback">依</span><span class="mord cjk_fallback">赖</span><span class="mord cjk_fallback">和</span><span class="mord cjk_fallback">命</span><span class="mord cjk_fallback">令</span><span class="mord cjk_fallback">。</span><span class="mord cjk_fallback">它</span><span class="mord cjk_fallback">主</span><span class="mord cjk_fallback">要</span><span class="mord cjk_fallback">起</span><span class="mord cjk_fallback">到</span><span class="mord cjk_fallback">指</span><span class="mord cjk_fallback">示</span><span class="mord cjk_fallback">当</span><span class="mord mathit">m</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.03148em;">k</span><span class="mord mathit">e</span><span class="mord cjk_fallback">命</span><span class="mord cjk_fallback">令</span><span class="mord cjk_fallback">不</span><span class="mord cjk_fallback">带</span><span class="mord cjk_fallback">目</span><span class="mord cjk_fallback">标</span><span class="mord cjk_fallback">时</span><span class="mord cjk_fallback">所</span><span class="mord cjk_fallback">要</span><span class="mord cjk_fallback">执</span><span class="mord cjk_fallback">行</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">目</span><span class="mord cjk_fallback">标</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">没</span><span class="mord cjk_fallback">有</span><span class="mord cjk_fallback">设</span><span class="mord cjk_fallback">定</span><span class="mord cjk_fallback">依</span><span class="mord cjk_fallback">赖</span><span class="mord cjk_fallback">和</span><span class="mord cjk_fallback">命</span><span class="mord cjk_fallback">令</span><span class="mord cjk_fallback">部</span><span class="mord cjk_fallback">分</span><span class="mord cjk_fallback">表</span><span class="mord cjk_fallback">明</span><span class="mord cjk_fallback">此</span><span class="mord cjk_fallback">目</span><span class="mord cjk_fallback">标</span><span class="mord cjk_fallback">在</span><span class="mord cjk_fallback">此</span><span class="mord cjk_fallback">后</span><span class="mord cjk_fallback">将</span><span class="mord cjk_fallback">会</span><span class="mord cjk_fallback">有</span><span class="mord cjk_fallback">其</span><span class="mord cjk_fallback">他</span><span class="mord cjk_fallback">依</span><span class="mord cjk_fallback">赖</span><span class="mord cjk_fallback">关</span><span class="mord cjk_fallback">系</span><span class="mord cjk_fallback">或</span><span class="mord cjk_fallback">命</span><span class="mord cjk_fallback">令</span><span class="mord cjk_fallback">。</span><span class="mord mathit" style="margin-right: 0.02691em;">w</span><span class="mord mathit">o</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">d</span><span class="mord cjk_fallback">目</span><span class="mord cjk_fallback">标</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">命</span><span class="mord cjk_fallback">令</span><span class="mord cjk_fallback">需</span><span class="mord cjk_fallback">要</span><span class="mord cjk_fallback">进</span><span class="mord cjk_fallback">一</span><span class="mord cjk_fallback">步</span><span class="mord cjk_fallback">参</span><span class="mord cjk_fallback">考</span></span></span></span></span>(TOPDIR)/include/toplevel.mk和主Makefile文件的再次执行部分。<br> 首次执行部分<br> OPENWRT_BUILD是区分首次执行与再次执行的变量。在首次执行时使用强制赋值指示符override把OPENWRT_BUILD赋值为1，并使用变量延伸指示符export把OPENWRT_BUILD延伸。在OPENWRT_BUILD使用强制赋值指示符override意味着make命令行可能引入OPENWRT_BUILD参数。<br> 引入<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         T 
        
       
         O 
        
       
         P 
        
       
         D 
        
       
         I 
        
       
         R 
        
       
         ) 
        
       
         / 
        
       
         i 
        
       
         n 
        
       
         c 
        
       
         l 
        
       
         u 
        
       
         d 
        
       
         e 
        
       
         / 
        
       
         d 
        
       
         e 
        
       
         b 
        
       
         u 
        
       
         g 
        
       
         . 
        
       
         m 
        
       
         k 
        
       
         、 
        
       
      
        (TOPDIR)/include/debug.mk、 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit" style="margin-right: 0.13889em;">T</span><span class="mord mathit" style="margin-right: 0.02778em;">O</span><span class="mord mathit" style="margin-right: 0.13889em;">P</span><span class="mord mathit" style="margin-right: 0.02778em;">D</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit" style="margin-right: 0.00773em;">R</span><span class="mclose">)</span><span class="mord">/</span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mord mathit">c</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">u</span><span class="mord mathit">d</span><span class="mord mathit">e</span><span class="mord">/</span><span class="mord mathit">d</span><span class="mord mathit">e</span><span class="mord mathit">b</span><span class="mord mathit">u</span><span class="mord mathit" style="margin-right: 0.03588em;">g</span><span class="mord">.</span><span class="mord mathit">m</span><span class="mord mathit" style="margin-right: 0.03148em;">k</span><span class="mord cjk_fallback">、</span></span></span></span></span>(TOPDIR)/include/depends.mk、<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         T 
        
       
         O 
        
       
         P 
        
       
         D 
        
       
         I 
        
       
         R 
        
       
         ) 
        
       
         / 
        
       
         i 
        
       
         n 
        
       
         c 
        
       
         l 
        
       
         u 
        
       
         d 
        
       
         e 
        
       
         / 
        
       
         t 
        
       
         o 
        
       
         p 
        
       
         l 
        
       
         e 
        
       
         v 
        
       
         e 
        
       
         l 
        
       
         . 
        
       
         m 
        
       
         k 
        
       
         三 
        
       
         个 
        
       
         文 
        
       
         件 
        
       
         ， 
        
       
         由 
        
       
         于 
        
       
         T 
        
       
         O 
        
       
         P 
        
       
         D 
        
       
         I 
        
       
         R 
        
       
         是 
        
       
         固 
        
       
         定 
        
       
         的 
        
       
         ， 
        
       
         所 
        
       
         以 
        
       
         三 
        
       
         个 
        
       
         文 
        
       
         件 
        
       
         也 
        
       
         是 
        
       
         固 
        
       
         定 
        
       
         的 
        
       
         。 
        
       
         其 
        
       
         中 
        
       
      
        (TOPDIR)/include/toplevel.mk三个文件，由于TOPDIR是固定的，所以三个文件也是固定的。其中 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit" style="margin-right: 0.13889em;">T</span><span class="mord mathit" style="margin-right: 0.02778em;">O</span><span class="mord mathit" style="margin-right: 0.13889em;">P</span><span class="mord mathit" style="margin-right: 0.02778em;">D</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit" style="margin-right: 0.00773em;">R</span><span class="mclose">)</span><span class="mord">/</span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mord mathit">c</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">u</span><span class="mord mathit">d</span><span class="mord mathit">e</span><span class="mord">/</span><span class="mord mathit">t</span><span class="mord mathit">o</span><span class="mord mathit">p</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right: 0.03588em;">v</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord">.</span><span class="mord mathit">m</span><span class="mord mathit" style="margin-right: 0.03148em;">k</span><span class="mord cjk_fallback">三</span><span class="mord cjk_fallback">个</span><span class="mord cjk_fallback">文</span><span class="mord cjk_fallback">件</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">由</span><span class="mord cjk_fallback">于</span><span class="mord mathit" style="margin-right: 0.13889em;">T</span><span class="mord mathit" style="margin-right: 0.02778em;">O</span><span class="mord mathit" style="margin-right: 0.13889em;">P</span><span class="mord mathit" style="margin-right: 0.02778em;">D</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit" style="margin-right: 0.00773em;">R</span><span class="mord cjk_fallback">是</span><span class="mord cjk_fallback">固</span><span class="mord cjk_fallback">定</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">所</span><span class="mord cjk_fallback">以</span><span class="mord cjk_fallback">三</span><span class="mord cjk_fallback">个</span><span class="mord cjk_fallback">文</span><span class="mord cjk_fallback">件</span><span class="mord cjk_fallback">也</span><span class="mord cjk_fallback">是</span><span class="mord cjk_fallback">固</span><span class="mord cjk_fallback">定</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">。</span><span class="mord cjk_fallback">其</span><span class="mord cjk_fallback">中</span></span></span></span></span>(TOPDIR)/include/toplevel.mk的135行%::有效解释首次执行时world目标的规则。<br> 再次执行部分<br> <a href="http://xn--rules-ep5hr13f.mk" rel="nofollow">引入rules.mk</a>、<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         I 
        
       
         N 
        
       
         C 
        
       
         L 
        
       
         U 
        
       
         D 
        
        
        
          E 
         
        
          D 
         
        
       
         I 
        
       
         R 
        
       
         ) 
        
       
         / 
        
       
         d 
        
       
         e 
        
       
         p 
        
       
         e 
        
       
         n 
        
       
         d 
        
       
         s 
        
       
         . 
        
       
         m 
        
       
         k 
        
       
         、 
        
       
      
        (INCLUDE_DIR)/depends.mk、 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit" style="margin-right: 0.10903em;">N</span><span class="mord mathit" style="margin-right: 0.07153em;">C</span><span class="mord mathit">L</span><span class="mord mathit" style="margin-right: 0.10903em;">U</span><span class="mord mathit" style="margin-right: 0.02778em;">D</span><span class="mord"><span class="mord mathit" style="margin-right: 0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.05764em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight" style="margin-right: 0.02778em;">D</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit" style="margin-right: 0.00773em;">R</span><span class="mclose">)</span><span class="mord">/</span><span class="mord mathit">d</span><span class="mord mathit">e</span><span class="mord mathit">p</span><span class="mord mathit">e</span><span class="mord mathit">n</span><span class="mord mathit">d</span><span class="mord mathit">s</span><span class="mord">.</span><span class="mord mathit">m</span><span class="mord mathit" style="margin-right: 0.03148em;">k</span><span class="mord cjk_fallback">、</span></span></span></span></span>(INCLUDE_DIR)/subdir.mk、target/Makefile、package/Makefile、tools/Makefile、toolchain/Makefile七个文件，rules.mk没有目录名，<a href="http://xn--Makefilerules-v50upuy7gkrprjjo1c6r8f0db4y5f9w5fvccgh.mk" rel="nofollow">即引入与主Makefile文件目录相同的rules.mk</a>。在rules.mk定义了INCLUDE_DIR为<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         T 
        
       
         O 
        
       
         P 
        
       
         D 
        
       
         I 
        
       
         R 
        
       
         ) 
        
       
         / 
        
       
         i 
        
       
         n 
        
       
         c 
        
       
         l 
        
       
         u 
        
       
         d 
        
       
         e 
        
       
         ， 
        
       
         所 
        
       
         以 
        
       
      
        (TOPDIR)/include，所以 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit" style="margin-right: 0.13889em;">T</span><span class="mord mathit" style="margin-right: 0.02778em;">O</span><span class="mord mathit" style="margin-right: 0.13889em;">P</span><span class="mord mathit" style="margin-right: 0.02778em;">D</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit" style="margin-right: 0.00773em;">R</span><span class="mclose">)</span><span class="mord">/</span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mord mathit">c</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">u</span><span class="mord mathit">d</span><span class="mord mathit">e</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">所</span><span class="mord cjk_fallback">以</span></span></span></span></span>(INCLUDE_DIR)/depends.mk实际上与首次执行时引入的<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         T 
        
       
         O 
        
       
         P 
        
       
         D 
        
       
         I 
        
       
         R 
        
       
         ) 
        
       
         / 
        
       
         i 
        
       
         n 
        
       
         c 
        
       
         l 
        
       
         u 
        
       
         d 
        
       
         e 
        
       
         / 
        
       
         d 
        
       
         e 
        
       
         p 
        
       
         e 
        
       
         n 
        
       
         d 
        
       
         s 
        
       
         . 
        
       
         m 
        
       
         k 
        
       
         是 
        
       
         同 
        
       
         一 
        
       
         个 
        
       
         文 
        
       
         件 
        
       
         。 
        
       
         四 
        
       
         个 
        
       
         子 
        
       
         目 
        
       
         录 
        
       
         下 
        
       
         的 
        
       
         M 
        
       
         a 
        
       
         k 
        
       
         e 
        
       
         f 
        
       
         i 
        
       
         l 
        
       
         e 
        
       
         实 
        
       
         际 
        
       
         上 
        
       
         是 
        
       
         不 
        
       
         能 
        
       
         独 
        
       
         立 
        
       
         执 
        
       
         行 
        
       
         。 
        
       
         主 
        
       
         要 
        
       
         利 
        
       
         用 
        
       
      
        (TOPDIR)/include/depends.mk是同一个文件。 四个子目录下的Makefile实际上是不能独立执行。主要利用 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit" style="margin-right: 0.13889em;">T</span><span class="mord mathit" style="margin-right: 0.02778em;">O</span><span class="mord mathit" style="margin-right: 0.13889em;">P</span><span class="mord mathit" style="margin-right: 0.02778em;">D</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit" style="margin-right: 0.00773em;">R</span><span class="mclose">)</span><span class="mord">/</span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mord mathit">c</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">u</span><span class="mord mathit">d</span><span class="mord mathit">e</span><span class="mord">/</span><span class="mord mathit">d</span><span class="mord mathit">e</span><span class="mord mathit">p</span><span class="mord mathit">e</span><span class="mord mathit">n</span><span class="mord mathit">d</span><span class="mord mathit">s</span><span class="mord">.</span><span class="mord mathit">m</span><span class="mord mathit" style="margin-right: 0.03148em;">k</span><span class="mord cjk_fallback">是</span><span class="mord cjk_fallback">同</span><span class="mord cjk_fallback">一</span><span class="mord cjk_fallback">个</span><span class="mord cjk_fallback">文</span><span class="mord cjk_fallback">件</span><span class="mord cjk_fallback">。</span><span class="mord cjk_fallback">四</span><span class="mord cjk_fallback">个</span><span class="mord cjk_fallback">子</span><span class="mord cjk_fallback">目</span><span class="mord cjk_fallback">录</span><span class="mord cjk_fallback">下</span><span class="mord cjk_fallback">的</span><span class="mord mathit" style="margin-right: 0.10903em;">M</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.03148em;">k</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right: 0.10764em;">f</span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">e</span><span class="mord cjk_fallback">实</span><span class="mord cjk_fallback">际</span><span class="mord cjk_fallback">上</span><span class="mord cjk_fallback">是</span><span class="mord cjk_fallback">不</span><span class="mord cjk_fallback">能</span><span class="mord cjk_fallback">独</span><span class="mord cjk_fallback">立</span><span class="mord cjk_fallback">执</span><span class="mord cjk_fallback">行</span><span class="mord cjk_fallback">。</span><span class="mord cjk_fallback">主</span><span class="mord cjk_fallback">要</span><span class="mord cjk_fallback">利</span><span class="mord cjk_fallback">用</span></span></span></span></span>(INCLUDE_DIR)/subdir.mk动态建立规则，诸如<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         t 
        
       
         o 
        
       
         o 
        
       
         l 
        
       
         c 
        
       
         h 
        
       
         a 
        
       
         i 
        
       
         n 
        
       
         / 
        
       
         s 
        
       
         t 
        
       
         a 
        
       
         m 
        
       
         p 
        
       
         − 
        
       
         i 
        
       
         n 
        
       
         s 
        
       
         t 
        
       
         a 
        
       
         l 
        
       
         l 
        
       
         ) 
        
       
         目 
        
       
         标 
        
       
         是 
        
       
         靠 
        
       
      
        (toolchain/stamp-install)目标是靠 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit">t</span><span class="mord mathit">o</span><span class="mord mathit">o</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">c</span><span class="mord mathit">h</span><span class="mord mathit">a</span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mord">/</span><span class="mord mathit">s</span><span class="mord mathit">t</span><span class="mord mathit">a</span><span class="mord mathit">m</span><span class="mord mathit">p</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mord mathit">s</span><span class="mord mathit">t</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mclose">)</span><span class="mord cjk_fallback">目</span><span class="mord cjk_fallback">标</span><span class="mord cjk_fallback">是</span><span class="mord cjk_fallback">靠</span></span></span></span></span>(INCLUDE_DIR)/subdir.mk的stampfile函数动态建立。在package/Makefile动态建立了<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         p 
        
       
         a 
        
       
         c 
        
       
         k 
        
       
         a 
        
       
         g 
        
       
         e 
        
       
         / 
        
       
         s 
        
       
         t 
        
       
         a 
        
       
         m 
        
       
         p 
        
       
         − 
        
       
         p 
        
       
         r 
        
       
         e 
        
       
         r 
        
       
         e 
        
       
         q 
        
       
         ) 
        
       
         、 
        
       
      
        (package/ stamp-prereq)、 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit">p</span><span class="mord mathit">a</span><span class="mord mathit">c</span><span class="mord mathit" style="margin-right: 0.03148em;">k</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.03588em;">g</span><span class="mord mathit">e</span><span class="mord">/</span><span class="mord mathit">s</span><span class="mord mathit">t</span><span class="mord mathit">a</span><span class="mord mathit">m</span><span class="mord mathit">p</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathit">p</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right: 0.03588em;">q</span><span class="mclose">)</span><span class="mord cjk_fallback">、</span></span></span></span></span>(package/ stamp-cleanup)、<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         p 
        
       
         a 
        
       
         c 
        
       
         k 
        
       
         a 
        
       
         g 
        
       
         e 
        
       
         / 
        
       
         s 
        
       
         t 
        
       
         a 
        
       
         m 
        
       
         p 
        
       
         − 
        
       
         c 
        
       
         o 
        
       
         m 
        
       
         p 
        
       
         i 
        
       
         l 
        
       
         e 
        
       
         ) 
        
       
         、 
        
       
      
        (package/ stamp-compile)、 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit">p</span><span class="mord mathit">a</span><span class="mord mathit">c</span><span class="mord mathit" style="margin-right: 0.03148em;">k</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.03588em;">g</span><span class="mord mathit">e</span><span class="mord">/</span><span class="mord mathit">s</span><span class="mord mathit">t</span><span class="mord mathit">a</span><span class="mord mathit">m</span><span class="mord mathit">p</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathit">c</span><span class="mord mathit">o</span><span class="mord mathit">m</span><span class="mord mathit">p</span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">e</span><span class="mclose">)</span><span class="mord cjk_fallback">、</span></span></span></span></span>(package/ stamp-install)、<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         p 
        
       
         a 
        
       
         c 
        
       
         k 
        
       
         a 
        
       
         g 
        
       
         e 
        
       
         / 
        
       
         s 
        
       
         t 
        
       
         a 
        
       
         m 
        
       
         p 
        
       
         − 
        
       
         r 
        
       
         o 
        
       
         o 
        
       
         t 
        
       
         f 
        
       
         s 
        
       
         − 
        
       
         p 
        
       
         r 
        
       
         e 
        
       
         p 
        
       
         a 
        
       
         r 
        
       
         e 
        
       
         ) 
        
       
         目 
        
       
         标 
        
       
         。 
        
       
         定 
        
       
         义 
        
       
         一 
        
       
         些 
        
       
         使 
        
       
         用 
        
       
         变 
        
       
         量 
        
       
         命 
        
       
         名 
        
       
         的 
        
       
         目 
        
       
         标 
        
       
         ， 
        
       
         其 
        
       
         变 
        
       
         量 
        
       
         的 
        
       
         赋 
        
       
         值 
        
       
         位 
        
       
         置 
        
       
         在 
        
       
      
        (package/ stamp-rootfs-prepare)目标。 定义一些使用变量命名的目标，其变量的赋值位置在 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit">p</span><span class="mord mathit">a</span><span class="mord mathit">c</span><span class="mord mathit" style="margin-right: 0.03148em;">k</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.03588em;">g</span><span class="mord mathit">e</span><span class="mord">/</span><span class="mord mathit">s</span><span class="mord mathit">t</span><span class="mord mathit">a</span><span class="mord mathit">m</span><span class="mord mathit">p</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.88888em; vertical-align: -0.19444em;"></span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord mathit">o</span><span class="mord mathit">o</span><span class="mord mathit">t</span><span class="mord mathit" style="margin-right: 0.10764em;">f</span><span class="mord mathit">s</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathit">p</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord mathit">e</span><span class="mord mathit">p</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord mathit">e</span><span class="mclose">)</span><span class="mord cjk_fallback">目</span><span class="mord cjk_fallback">标</span><span class="mord cjk_fallback">。</span><span class="mord cjk_fallback">定</span><span class="mord cjk_fallback">义</span><span class="mord cjk_fallback">一</span><span class="mord cjk_fallback">些</span><span class="mord cjk_fallback">使</span><span class="mord cjk_fallback">用</span><span class="mord cjk_fallback">变</span><span class="mord cjk_fallback">量</span><span class="mord cjk_fallback">命</span><span class="mord cjk_fallback">名</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">目</span><span class="mord cjk_fallback">标</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">其</span><span class="mord cjk_fallback">变</span><span class="mord cjk_fallback">量</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">赋</span><span class="mord cjk_fallback">值</span><span class="mord cjk_fallback">位</span><span class="mord cjk_fallback">置</span><span class="mord cjk_fallback">在</span></span></span></span></span>(INCLUDE_DIR)/subdir.mk的stampfile函数中。目标只有依赖关系，可能说明其工作顺序，在<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         I 
        
       
         N 
        
       
         C 
        
       
         L 
        
       
         U 
        
       
         D 
        
        
        
          E 
         
        
          D 
         
        
       
         I 
        
       
         R 
        
       
         ) 
        
       
         / 
        
       
         s 
        
       
         u 
        
       
         b 
        
       
         d 
        
       
         i 
        
       
         r 
        
       
         . 
        
       
         m 
        
       
         k 
        
       
         的 
        
       
         s 
        
       
         t 
        
       
         a 
        
       
         m 
        
       
         p 
        
       
         f 
        
       
         i 
        
       
         l 
        
       
         e 
        
       
         函 
        
       
         数 
        
       
         中 
        
       
         有 
        
       
         进 
        
       
         一 
        
       
         步 
        
       
         说 
        
       
         明 
        
       
         其 
        
       
         目 
        
       
         标 
        
       
         执 
        
       
         行 
        
       
         的 
        
       
         命 
        
       
         令 
        
       
         ， 
        
       
         并 
        
       
         为 
        
       
         目 
        
       
         标 
        
       
         建 
        
       
         立 
        
       
         一 
        
       
         个 
        
       
         空 
        
       
         文 
        
       
         件 
        
       
         ， 
        
       
         即 
        
       
         使 
        
       
         用 
        
       
         变 
        
       
         量 
        
       
         命 
        
       
         名 
        
       
         的 
        
       
         目 
        
       
         标 
        
       
         为 
        
       
         真 
        
       
         实 
        
       
         的 
        
       
         文 
        
       
         件 
        
       
         。 
        
       
         定 
        
       
         义 
        
       
         一 
        
       
         些 
        
       
         使 
        
       
         用 
        
       
         固 
        
       
         定 
        
       
         的 
        
       
         目 
        
       
         标 
        
       
         规 
        
       
         则 
        
       
         。 
        
       
         其 
        
       
         中 
        
       
         ： 
        
       
         c 
        
       
         l 
        
       
         e 
        
       
         a 
        
       
         n 
        
       
         是 
        
       
         清 
        
       
         除 
        
       
         编 
        
       
         译 
        
       
         结 
        
       
         果 
        
       
         的 
        
       
         目 
        
       
         标 
        
       
         ， 
        
       
         清 
        
       
         除 
        
       
      
        (INCLUDE_DIR)/subdir.mk的stampfile函数中有进一步说明其目标执行的命令，并为目标建立一个空文件，即使用变量命名的目标为真实的文件。 定义一些使用固定的目标规则。 其中：clean是清除编译结果的目标，清除 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit" style="margin-right: 0.10903em;">N</span><span class="mord mathit" style="margin-right: 0.07153em;">C</span><span class="mord mathit">L</span><span class="mord mathit" style="margin-right: 0.10903em;">U</span><span class="mord mathit" style="margin-right: 0.02778em;">D</span><span class="mord"><span class="mord mathit" style="margin-right: 0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.05764em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight" style="margin-right: 0.02778em;">D</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit" style="margin-right: 0.00773em;">R</span><span class="mclose">)</span><span class="mord">/</span><span class="mord mathit">s</span><span class="mord mathit">u</span><span class="mord mathit">b</span><span class="mord mathit">d</span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord">.</span><span class="mord mathit">m</span><span class="mord mathit" style="margin-right: 0.03148em;">k</span><span class="mord cjk_fallback">的</span><span class="mord mathit">s</span><span class="mord mathit">t</span><span class="mord mathit">a</span><span class="mord mathit">m</span><span class="mord mathit">p</span><span class="mord mathit" style="margin-right: 0.10764em;">f</span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">e</span><span class="mord cjk_fallback">函</span><span class="mord cjk_fallback">数</span><span class="mord cjk_fallback">中</span><span class="mord cjk_fallback">有</span><span class="mord cjk_fallback">进</span><span class="mord cjk_fallback">一</span><span class="mord cjk_fallback">步</span><span class="mord cjk_fallback">说</span><span class="mord cjk_fallback">明</span><span class="mord cjk_fallback">其</span><span class="mord cjk_fallback">目</span><span class="mord cjk_fallback">标</span><span class="mord cjk_fallback">执</span><span class="mord cjk_fallback">行</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">命</span><span class="mord cjk_fallback">令</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">并</span><span class="mord cjk_fallback">为</span><span class="mord cjk_fallback">目</span><span class="mord cjk_fallback">标</span><span class="mord cjk_fallback">建</span><span class="mord cjk_fallback">立</span><span class="mord cjk_fallback">一</span><span class="mord cjk_fallback">个</span><span class="mord cjk_fallback">空</span><span class="mord cjk_fallback">文</span><span class="mord cjk_fallback">件</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">即</span><span class="mord cjk_fallback">使</span><span class="mord cjk_fallback">用</span><span class="mord cjk_fallback">变</span><span class="mord cjk_fallback">量</span><span class="mord cjk_fallback">命</span><span class="mord cjk_fallback">名</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">目</span><span class="mord cjk_fallback">标</span><span class="mord cjk_fallback">为</span><span class="mord cjk_fallback">真</span><span class="mord cjk_fallback">实</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">文</span><span class="mord cjk_fallback">件</span><span class="mord cjk_fallback">。</span><span class="mord cjk_fallback">定</span><span class="mord cjk_fallback">义</span><span class="mord cjk_fallback">一</span><span class="mord cjk_fallback">些</span><span class="mord cjk_fallback">使</span><span class="mord cjk_fallback">用</span><span class="mord cjk_fallback">固</span><span class="mord cjk_fallback">定</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">目</span><span class="mord cjk_fallback">标</span><span class="mord cjk_fallback">规</span><span class="mord cjk_fallback">则</span><span class="mord cjk_fallback">。</span><span class="mord cjk_fallback">其</span><span class="mord cjk_fallback">中</span><span class="mord cjk_fallback">：</span><span class="mord mathit">c</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">e</span><span class="mord mathit">a</span><span class="mord mathit">n</span><span class="mord cjk_fallback">是</span><span class="mord cjk_fallback">清</span><span class="mord cjk_fallback">除</span><span class="mord cjk_fallback">编</span><span class="mord cjk_fallback">译</span><span class="mord cjk_fallback">结</span><span class="mord cjk_fallback">果</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">目</span><span class="mord cjk_fallback">标</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">清</span><span class="mord cjk_fallback">除</span></span></span></span></span>(BUILD_DIR) $(BIN_DIR) <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         B 
        
       
         U 
        
       
         I 
        
       
         L 
        
        
        
          D 
         
        
          L 
         
        
       
         O 
        
        
        
          G 
         
        
          D 
         
        
       
         I 
        
       
         R 
        
       
         ) 
        
       
         三 
        
       
         个 
        
       
         目 
        
       
         录 
        
       
         的 
        
       
         用 
        
       
         意 
        
       
         是 
        
       
         十 
        
       
         分 
        
       
         明 
        
       
         确 
        
       
         。 
        
       
         暂 
        
       
         时 
        
       
         不 
        
       
         知 
        
       
         道 
        
       
         为 
        
       
         什 
        
       
         么 
        
       
         执 
        
       
         行 
        
       
         m 
        
       
         a 
        
       
         k 
        
       
         e 
        
       
         t 
        
       
         a 
        
       
         r 
        
       
         g 
        
       
         e 
        
       
         t 
        
       
         / 
        
       
         l 
        
       
         i 
        
       
         n 
        
       
         u 
        
       
         x 
        
       
         / 
        
       
         c 
        
       
         l 
        
       
         e 
        
       
         a 
        
       
         n 
        
       
         。 
        
       
         d 
        
       
         i 
        
       
         r 
        
       
         c 
        
       
         l 
        
       
         e 
        
       
         a 
        
       
         n 
        
       
         是 
        
       
         删 
        
       
         除 
        
       
         所 
        
       
         有 
        
       
         编 
        
       
         译 
        
       
         过 
        
       
         程 
        
       
         产 
        
       
         生 
        
       
         的 
        
       
         目 
        
       
         录 
        
       
         和 
        
       
         文 
        
       
         件 
        
       
         的 
        
       
         目 
        
       
         标 
        
       
         ， 
        
       
         执 
        
       
         行 
        
       
         d 
        
       
         i 
        
       
         r 
        
       
         c 
        
       
         l 
        
       
         e 
        
       
         a 
        
       
         n 
        
       
         目 
        
       
         标 
        
       
         依 
        
       
         赖 
        
       
         于 
        
       
         c 
        
       
         l 
        
       
         e 
        
       
         a 
        
       
         n 
        
       
         ， 
        
       
         因 
        
       
         此 
        
       
         将 
        
       
         执 
        
       
         行 
        
       
         c 
        
       
         l 
        
       
         e 
        
       
         a 
        
       
         n 
        
       
         目 
        
       
         标 
        
       
         所 
        
       
         执 
        
       
         行 
        
       
         的 
        
       
         命 
        
       
         令 
        
       
         ， 
        
       
         然 
        
       
         后 
        
       
         删 
        
       
         除 
        
       
      
        (BUILD_LOG_DIR)三个目录的用意是十分明确。暂时不知道为什么执行make target/linux/clean。 dirclean是删除所有编译过程产生的目录和文件的目标，执行dirclean目标依赖于clean，因此将执行clean目标所执行的命令，然后删除 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit" style="margin-right: 0.05017em;">B</span><span class="mord mathit" style="margin-right: 0.10903em;">U</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit">L</span><span class="mord"><span class="mord mathit" style="margin-right: 0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.02778em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight">L</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathit" style="margin-right: 0.02778em;">O</span><span class="mord"><span class="mord mathit">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight" style="margin-right: 0.02778em;">D</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit" style="margin-right: 0.00773em;">R</span><span class="mclose">)</span><span class="mord cjk_fallback">三</span><span class="mord cjk_fallback">个</span><span class="mord cjk_fallback">目</span><span class="mord cjk_fallback">录</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">用</span><span class="mord cjk_fallback">意</span><span class="mord cjk_fallback">是</span><span class="mord cjk_fallback">十</span><span class="mord cjk_fallback">分</span><span class="mord cjk_fallback">明</span><span class="mord cjk_fallback">确</span><span class="mord cjk_fallback">。</span><span class="mord cjk_fallback">暂</span><span class="mord cjk_fallback">时</span><span class="mord cjk_fallback">不</span><span class="mord cjk_fallback">知</span><span class="mord cjk_fallback">道</span><span class="mord cjk_fallback">为</span><span class="mord cjk_fallback">什</span><span class="mord cjk_fallback">么</span><span class="mord cjk_fallback">执</span><span class="mord cjk_fallback">行</span><span class="mord mathit">m</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.03148em;">k</span><span class="mord mathit">e</span><span class="mord mathit">t</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord mathit" style="margin-right: 0.03588em;">g</span><span class="mord mathit">e</span><span class="mord mathit">t</span><span class="mord">/</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mord mathit">u</span><span class="mord mathit">x</span><span class="mord">/</span><span class="mord mathit">c</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">e</span><span class="mord mathit">a</span><span class="mord mathit">n</span><span class="mord cjk_fallback">。</span><span class="mord mathit">d</span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord mathit">c</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">e</span><span class="mord mathit">a</span><span class="mord mathit">n</span><span class="mord cjk_fallback">是</span><span class="mord cjk_fallback">删</span><span class="mord cjk_fallback">除</span><span class="mord cjk_fallback">所</span><span class="mord cjk_fallback">有</span><span class="mord cjk_fallback">编</span><span class="mord cjk_fallback">译</span><span class="mord cjk_fallback">过</span><span class="mord cjk_fallback">程</span><span class="mord cjk_fallback">产</span><span class="mord cjk_fallback">生</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">目</span><span class="mord cjk_fallback">录</span><span class="mord cjk_fallback">和</span><span class="mord cjk_fallback">文</span><span class="mord cjk_fallback">件</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">目</span><span class="mord cjk_fallback">标</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">执</span><span class="mord cjk_fallback">行</span><span class="mord mathit">d</span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord mathit">c</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">e</span><span class="mord mathit">a</span><span class="mord mathit">n</span><span class="mord cjk_fallback">目</span><span class="mord cjk_fallback">标</span><span class="mord cjk_fallback">依</span><span class="mord cjk_fallback">赖</span><span class="mord cjk_fallback">于</span><span class="mord mathit">c</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">e</span><span class="mord mathit">a</span><span class="mord mathit">n</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">因</span><span class="mord cjk_fallback">此</span><span class="mord cjk_fallback">将</span><span class="mord cjk_fallback">执</span><span class="mord cjk_fallback">行</span><span class="mord mathit">c</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">e</span><span class="mord mathit">a</span><span class="mord mathit">n</span><span class="mord cjk_fallback">目</span><span class="mord cjk_fallback">标</span><span class="mord cjk_fallback">所</span><span class="mord cjk_fallback">执</span><span class="mord cjk_fallback">行</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">命</span><span class="mord cjk_fallback">令</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">然</span><span class="mord cjk_fallback">后</span><span class="mord cjk_fallback">删</span><span class="mord cjk_fallback">除</span></span></span></span></span>(STAGING_DIR) $(STAGING_DIR_HOST) $(STAGING_DIR_TOOLCHAIN) $(TOOLCHAIN_DIR) $(BUILD_DIR_HOST) <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         B 
        
       
         U 
        
       
         I 
        
       
         L 
        
        
        
          D 
         
        
          D 
         
        
       
         I 
        
        
        
          R 
         
        
          T 
         
        
       
         O 
        
       
         O 
        
       
         L 
        
       
         C 
        
       
         H 
        
       
         A 
        
       
         I 
        
       
         N 
        
       
         ) 
        
       
         目 
        
       
         录 
        
       
         ， 
        
       
         以 
        
       
         及 
        
       
         删 
        
       
         除 
        
       
      
        (BUILD_DIR_TOOLCHAIN)目录，以及删除 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit" style="margin-right: 0.05017em;">B</span><span class="mord mathit" style="margin-right: 0.10903em;">U</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit">L</span><span class="mord"><span class="mord mathit" style="margin-right: 0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.02778em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight" style="margin-right: 0.02778em;">D</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord"><span class="mord mathit" style="margin-right: 0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.00773em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight" style="margin-right: 0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathit" style="margin-right: 0.02778em;">O</span><span class="mord mathit" style="margin-right: 0.02778em;">O</span><span class="mord mathit">L</span><span class="mord mathit" style="margin-right: 0.07153em;">C</span><span class="mord mathit" style="margin-right: 0.08125em;">H</span><span class="mord mathit">A</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit" style="margin-right: 0.10903em;">N</span><span class="mclose">)</span><span class="mord cjk_fallback">目</span><span class="mord cjk_fallback">录</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">以</span><span class="mord cjk_fallback">及</span><span class="mord cjk_fallback">删</span><span class="mord cjk_fallback">除</span></span></span></span></span>(TMP_DIR)目录。上述目录的变量均在rules.mk定义。好像删除staging_dir目录就意味着删除staging_dir目录下的所有子目录，不知道为什么要强调删除$(STAGING_DIR_HOST) $(STAGING_DIR_TOOLCHAIN) <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         T 
        
       
         O 
        
       
         O 
        
       
         L 
        
       
         C 
        
       
         H 
        
       
         A 
        
       
         I 
        
        
        
          N 
         
        
          D 
         
        
       
         I 
        
       
         R 
        
       
         ) 
        
       
         目 
        
       
         录 
        
       
         。 
        
       
         同 
        
       
         样 
        
       
         删 
        
       
         除 
        
       
         b 
        
       
         u 
        
       
         i 
        
       
         l 
        
       
         d 
        
        
        
          e 
         
        
          d 
         
        
       
         i 
        
       
         r 
        
       
         目 
        
       
         录 
        
       
         就 
        
       
         意 
        
       
         味 
        
       
         着 
        
       
         删 
        
       
         除 
        
       
         b 
        
       
         u 
        
       
         i 
        
       
         l 
        
       
         d 
        
        
        
          e 
         
        
          d 
         
        
       
         i 
        
       
         r 
        
       
         目 
        
       
         录 
        
       
         下 
        
       
         的 
        
       
         所 
        
       
         有 
        
       
         子 
        
       
         目 
        
       
         录 
        
       
         ， 
        
       
         不 
        
       
         知 
        
       
         道 
        
       
         为 
        
       
         什 
        
       
         么 
        
       
         要 
        
       
         强 
        
       
         调 
        
       
         删 
        
       
         除 
        
       
      
        (TOOLCHAIN_DIR)目录。同样删除builde_dir目录就意味着删除builde_dir目录下的所有子目录，不知道为什么要强调删除 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit" style="margin-right: 0.13889em;">T</span><span class="mord mathit" style="margin-right: 0.02778em;">O</span><span class="mord mathit" style="margin-right: 0.02778em;">O</span><span class="mord mathit">L</span><span class="mord mathit" style="margin-right: 0.07153em;">C</span><span class="mord mathit" style="margin-right: 0.08125em;">H</span><span class="mord mathit">A</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord"><span class="mord mathit" style="margin-right: 0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.10903em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight" style="margin-right: 0.02778em;">D</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit" style="margin-right: 0.00773em;">R</span><span class="mclose">)</span><span class="mord cjk_fallback">目</span><span class="mord cjk_fallback">录</span><span class="mord cjk_fallback">。</span><span class="mord cjk_fallback">同</span><span class="mord cjk_fallback">样</span><span class="mord cjk_fallback">删</span><span class="mord cjk_fallback">除</span><span class="mord mathit">b</span><span class="mord mathit">u</span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">d</span><span class="mord"><span class="mord mathit">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord cjk_fallback">目</span><span class="mord cjk_fallback">录</span><span class="mord cjk_fallback">就</span><span class="mord cjk_fallback">意</span><span class="mord cjk_fallback">味</span><span class="mord cjk_fallback">着</span><span class="mord cjk_fallback">删</span><span class="mord cjk_fallback">除</span><span class="mord mathit">b</span><span class="mord mathit">u</span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">d</span><span class="mord"><span class="mord mathit">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord cjk_fallback">目</span><span class="mord cjk_fallback">录</span><span class="mord cjk_fallback">下</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">所</span><span class="mord cjk_fallback">有</span><span class="mord cjk_fallback">子</span><span class="mord cjk_fallback">目</span><span class="mord cjk_fallback">录</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">不</span><span class="mord cjk_fallback">知</span><span class="mord cjk_fallback">道</span><span class="mord cjk_fallback">为</span><span class="mord cjk_fallback">什</span><span class="mord cjk_fallback">么</span><span class="mord cjk_fallback">要</span><span class="mord cjk_fallback">强</span><span class="mord cjk_fallback">调</span><span class="mord cjk_fallback">删</span><span class="mord cjk_fallback">除</span></span></span></span></span>(BUILD_DIR_TOOLCHAIN)目录。<br> tmp/.prereq_packages目标是对所需软件包的预处理。目标依赖于.config，即执行make menuconfig后将会进行一次所需软件包的预处理。不知什么原因在编译前删除tmp目录，执行时无法建立tmp/.prereq_packages文件。<br> prereq应该是预请求目标，在OpenWrt执行Makefile时好像都要先执行prereq目标。<br> prepare应该是准备目标，是world依赖的一个伪目标。依赖于文件.config和$(tools/stamp-install) <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         t 
        
       
         o 
        
       
         o 
        
       
         l 
        
       
         c 
        
       
         h 
        
       
         a 
        
       
         i 
        
       
         n 
        
       
         / 
        
       
         s 
        
       
         t 
        
       
         a 
        
       
         m 
        
       
         p 
        
       
         − 
        
       
         i 
        
       
         n 
        
       
         s 
        
       
         t 
        
       
         a 
        
       
         l 
        
       
         l 
        
       
         ) 
        
       
         目 
        
       
         标 
        
       
         。 
        
       
         w 
        
       
         o 
        
       
         r 
        
       
         l 
        
       
         d 
        
       
         就 
        
       
         是 
        
       
         编 
        
       
         译 
        
       
         的 
        
       
         目 
        
       
         标 
        
       
         。 
        
       
         依 
        
       
         赖 
        
       
         于 
        
       
         p 
        
       
         r 
        
       
         e 
        
       
         p 
        
       
         a 
        
       
         r 
        
       
         e 
        
       
         为 
        
       
         目 
        
       
         标 
        
       
         和 
        
       
         前 
        
       
         面 
        
       
         提 
        
       
         到 
        
       
         的 
        
       
         变 
        
       
         量 
        
       
         命 
        
       
         名 
        
       
         目 
        
       
         标 
        
       
         。 
        
       
         采 
        
       
         用 
        
       
         取 
        
       
         消 
        
       
         隐 
        
       
         含 
        
       
         规 
        
       
         则 
        
       
         方 
        
       
         式 
        
       
         执 
        
       
         行 
        
       
         p 
        
       
         a 
        
       
         c 
        
       
         k 
        
       
         a 
        
       
         g 
        
       
         e 
        
       
         / 
        
       
         i 
        
       
         n 
        
       
         d 
        
       
         e 
        
       
         x 
        
       
         目 
        
       
         标 
        
       
         。 
        
       
         p 
        
       
         a 
        
       
         c 
        
       
         k 
        
       
         a 
        
       
         g 
        
       
         e 
        
       
         / 
        
       
         i 
        
       
         n 
        
       
         d 
        
       
         e 
        
       
         x 
        
       
         目 
        
       
         标 
        
       
         在 
        
       
         p 
        
       
         a 
        
       
         c 
        
       
         k 
        
       
         a 
        
       
         g 
        
       
         e 
        
       
         / 
        
       
         M 
        
       
         a 
        
       
         k 
        
       
         e 
        
       
         f 
        
       
         i 
        
       
         l 
        
       
         e 
        
       
         的 
        
       
         92 
        
       
         行 
        
       
         定 
        
       
         义 
        
       
         。 
        
       
         p 
        
       
         a 
        
       
         c 
        
       
         k 
        
       
         a 
        
       
         g 
        
       
         e 
        
       
         / 
        
       
         s 
        
       
         y 
        
       
         m 
        
       
         l 
        
       
         i 
        
       
         n 
        
       
         k 
        
       
         s 
        
       
         和 
        
       
         p 
        
       
         a 
        
       
         c 
        
       
         k 
        
       
         a 
        
       
         g 
        
       
         e 
        
       
         / 
        
       
         s 
        
       
         y 
        
       
         m 
        
       
         l 
        
       
         i 
        
       
         n 
        
       
         k 
        
       
         s 
        
       
         − 
        
       
         i 
        
       
         n 
        
       
         s 
        
       
         t 
        
       
         a 
        
       
         l 
        
       
         l 
        
       
         是 
        
       
         更 
        
       
         新 
        
       
         或 
        
       
         安 
        
       
         装 
        
       
         软 
        
       
         件 
        
       
         包 
        
       
         来 
        
       
         源 
        
       
         的 
        
       
         目 
        
       
         标 
        
       
         ， 
        
       
         使 
        
       
         用 
        
       
      
        (toolchain/stamp-install)目标。 world就是编译的目标。依赖于prepare为目标和前面提到的变量命名目标。采用取消隐含规则方式执行package/index目标。package/index目标在package/Makefile的92行定义。 package/symlinks和package/symlinks-install是更新或安装软件包来源的目标，使用 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit">t</span><span class="mord mathit">o</span><span class="mord mathit">o</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">c</span><span class="mord mathit">h</span><span class="mord mathit">a</span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mord">/</span><span class="mord mathit">s</span><span class="mord mathit">t</span><span class="mord mathit">a</span><span class="mord mathit">m</span><span class="mord mathit">p</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mord mathit">s</span><span class="mord mathit">t</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mclose">)</span><span class="mord cjk_fallback">目</span><span class="mord cjk_fallback">标</span><span class="mord cjk_fallback">。</span><span class="mord mathit" style="margin-right: 0.02691em;">w</span><span class="mord mathit">o</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">d</span><span class="mord cjk_fallback">就</span><span class="mord cjk_fallback">是</span><span class="mord cjk_fallback">编</span><span class="mord cjk_fallback">译</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">目</span><span class="mord cjk_fallback">标</span><span class="mord cjk_fallback">。</span><span class="mord cjk_fallback">依</span><span class="mord cjk_fallback">赖</span><span class="mord cjk_fallback">于</span><span class="mord mathit">p</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord mathit">e</span><span class="mord mathit">p</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord mathit">e</span><span class="mord cjk_fallback">为</span><span class="mord cjk_fallback">目</span><span class="mord cjk_fallback">标</span><span class="mord cjk_fallback">和</span><span class="mord cjk_fallback">前</span><span class="mord cjk_fallback">面</span><span class="mord cjk_fallback">提</span><span class="mord cjk_fallback">到</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">变</span><span class="mord cjk_fallback">量</span><span class="mord cjk_fallback">命</span><span class="mord cjk_fallback">名</span><span class="mord cjk_fallback">目</span><span class="mord cjk_fallback">标</span><span class="mord cjk_fallback">。</span><span class="mord cjk_fallback">采</span><span class="mord cjk_fallback">用</span><span class="mord cjk_fallback">取</span><span class="mord cjk_fallback">消</span><span class="mord cjk_fallback">隐</span><span class="mord cjk_fallback">含</span><span class="mord cjk_fallback">规</span><span class="mord cjk_fallback">则</span><span class="mord cjk_fallback">方</span><span class="mord cjk_fallback">式</span><span class="mord cjk_fallback">执</span><span class="mord cjk_fallback">行</span><span class="mord mathit">p</span><span class="mord mathit">a</span><span class="mord mathit">c</span><span class="mord mathit" style="margin-right: 0.03148em;">k</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.03588em;">g</span><span class="mord mathit">e</span><span class="mord">/</span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mord mathit">d</span><span class="mord mathit">e</span><span class="mord mathit">x</span><span class="mord cjk_fallback">目</span><span class="mord cjk_fallback">标</span><span class="mord cjk_fallback">。</span><span class="mord mathit">p</span><span class="mord mathit">a</span><span class="mord mathit">c</span><span class="mord mathit" style="margin-right: 0.03148em;">k</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.03588em;">g</span><span class="mord mathit">e</span><span class="mord">/</span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mord mathit">d</span><span class="mord mathit">e</span><span class="mord mathit">x</span><span class="mord cjk_fallback">目</span><span class="mord cjk_fallback">标</span><span class="mord cjk_fallback">在</span><span class="mord mathit">p</span><span class="mord mathit">a</span><span class="mord mathit">c</span><span class="mord mathit" style="margin-right: 0.03148em;">k</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.03588em;">g</span><span class="mord mathit">e</span><span class="mord">/</span><span class="mord mathit" style="margin-right: 0.10903em;">M</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.03148em;">k</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right: 0.10764em;">f</span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">e</span><span class="mord cjk_fallback">的</span><span class="mord">9</span><span class="mord">2</span><span class="mord cjk_fallback">行</span><span class="mord cjk_fallback">定</span><span class="mord cjk_fallback">义</span><span class="mord cjk_fallback">。</span><span class="mord mathit">p</span><span class="mord mathit">a</span><span class="mord mathit">c</span><span class="mord mathit" style="margin-right: 0.03148em;">k</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.03588em;">g</span><span class="mord mathit">e</span><span class="mord">/</span><span class="mord mathit">s</span><span class="mord mathit" style="margin-right: 0.03588em;">y</span><span class="mord mathit">m</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mord mathit" style="margin-right: 0.03148em;">k</span><span class="mord mathit">s</span><span class="mord cjk_fallback">和</span><span class="mord mathit">p</span><span class="mord mathit">a</span><span class="mord mathit">c</span><span class="mord mathit" style="margin-right: 0.03148em;">k</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.03588em;">g</span><span class="mord mathit">e</span><span class="mord">/</span><span class="mord mathit">s</span><span class="mord mathit" style="margin-right: 0.03588em;">y</span><span class="mord mathit">m</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mord mathit" style="margin-right: 0.03148em;">k</span><span class="mord mathit">s</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.69444em; vertical-align: 0em;"></span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mord mathit">s</span><span class="mord mathit">t</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord cjk_fallback">是</span><span class="mord cjk_fallback">更</span><span class="mord cjk_fallback">新</span><span class="mord cjk_fallback">或</span><span class="mord cjk_fallback">安</span><span class="mord cjk_fallback">装</span><span class="mord cjk_fallback">软</span><span class="mord cjk_fallback">件</span><span class="mord cjk_fallback">包</span><span class="mord cjk_fallback">来</span><span class="mord cjk_fallback">源</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">目</span><span class="mord cjk_fallback">标</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">使</span><span class="mord cjk_fallback">用</span></span></span></span></span>(SCRIPT_DIR)/feeds脚本文件完成。<br> package/symlinks-clean是清除软件包来源的目标，也是使用$(SCRIPT_DIR)/feeds脚本文件完成。<br> 最后使用伪目标.PHONY说明clean dirclean prereq prepare world package/symlinks package/symlinks-install package/symlinks-clean属于伪目标。通过伪目标说明可以知道可以执行的目标。</p> 
<p>本篇的主要目的是想通过分析Makefile，了解openwrt编译过程。着重关注以下几点：</p> 
<p>openwrt目录结构<br> 主Makefile的解析过程，各子目录的目标生成。<br> kernel编译过程<br> firmware的生成过程<br> 软件包的编译过程<br> 回到顶部<br> openwrt目录结构<br> 官方源下载速度太慢，我从github上clone了openwrt的代码仓库。</p> 
<p>git clone <a href="https://github.com/openwrt-mirror/openwrt.git">https://github.com/openwrt-mirror/openwrt.git</a></p> 
<p>openwrt目录结构</p> 
<p>上图是openwrt目录结构，其中第一行是原始目录，第二行是编译过程中生成的目录。各目录的作用是：</p> 
<p>tools - 编译时需要一些工具， tools里包含了获取和编译这些工具的命令。里面是一些Makefile，有的可能还有patch。每个Makefile里都有一句:$(eval $(call HostBuild))，表示编译这个工具是为了在主机上使用的。</p> 
<p>toolchain - 包含一些命令去获取kernel headers, C library, bin-utils, compiler, debugger</p> 
<p>target - 各平台在这个目录里定义了firmware和kernel的编译过程。</p> 
<p>package - 包含针对各个软件包的Makefile。openwrt定义了一套Makefile模板，各软件包参照这个模板定义了自己的信息，如软件包的版本、下载地址、编译方式、安装地址等。</p> 
<p>include - openwrt的Makefile都存放在这里。</p> 
<p>scripts - 一些perl脚本，用于软件包管理。</p> 
<p>dl - 软件包下载后都放到这个目录里</p> 
<p>build_dir - 软件包都解压到build_dir/里，然后在此编译</p> 
<p>staging_dir - 最终安装目录。tools, toolchain被安装到这里，rootfs也会放到这里。</p> 
<p>feeds -</p> 
<p>bin - 编译完成之后，firmware和各ipk会放到此目录下。</p> 
<p>OpenWrt Development Guide</p> 
<p>回到顶部<br> main Makefile<br> openwrt根目录下的Makefile是执行make命令时的入口。从这里开始分析。</p> 
<p>world:</p> 
<p>ifndef ($(OPENWRT_BUILD),1)</p> 
<h2><a id="_93"></a>第一个逻辑</h2> 
<p>…<br> else</p> 
<h2><a id="_96"></a>第二个逻辑</h2> 
<p>…<br> endif<br> 上面这段是主Makefile的结构，可以得知：</p> 
<p>执行make时，若无任何目标指定，则默认目标是world<br> 执行make时，无参数指定，则会进入第一个逻辑。如果执行命令make OPENWRT_BUILD=1，则直接进入第二个逻辑。<br> 编译时一般直接使用make V=s -j 5这样的命令，不会指定OPENWRT_BUILD变量，显然这里OPENWRT_BUILD用于标记当前openwrt BSP是否已经编译过，因此第一次编译当然应该执行第一个逻辑，同时令OPENWRT_BUILD为1，标示openwrt BSP已经编译过了。</p> 
<p>第一个逻辑<br> override OPENWRT_BUILD=1<br> export OPENWRT_BUILD<br> 更改了OPENWRT_BUILD变量的值。这里起到的作用是下次执行make时，因为已经编译过，会进入到第二逻辑中。</p> 
<p>第一个逻辑中会include <a href="http://toplevel.mk" rel="nofollow">toplevel.mk</a>，该文件中的 “%::” 用于解释world目标的规则：</p> 
<p>prereq:: prepare-tmpinfo .config<br> @+$(MAKE) -r -s tmp/.prereq-build <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         P 
        
       
         R 
        
       
         E 
        
        
        
          P 
         
        
          M 
         
        
       
         K 
        
       
         ) 
        
       
         @ 
        
       
         + 
        
       
      
        (PREP_MK) @+ 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit" style="margin-right: 0.13889em;">P</span><span class="mord mathit" style="margin-right: 0.00773em;">R</span><span class="mord mathit" style="margin-right: 0.05764em;">E</span><span class="mord"><span class="mord mathit" style="margin-right: 0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight" style="margin-right: 0.10903em;">M</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathit" style="margin-right: 0.07153em;">K</span><span class="mclose">)</span><span class="mord">@</span><span class="mord">+</span></span></span></span></span>(NO_TRACE_MAKE) -r -s $@</p> 
<p>%::<br> @+$(PREP_MK) <span class="katex--inline">KaTeX parse error: Expected 'EOF', got '\ ' at position 34: … -s prereq @( \̲ ̲ cp .config tm…</span>(_R)WARNING: your configuration is out of sync. Please run make menuconfig, oldconfig or defconfig!<span class="katex--inline">KaTeX parse error: Expected 'EOF', got '\n' at position 5: (_N)\̲n̲" &gt;&amp;2; \ fi \…</span>(ULIMIT_FIX) $(SUBMAKE) -r $@<br> 执行 make V=s 时，上面这段规则简化为：</p> 
<p>prereq:: prepare-tmpinfo .config<br> @make -r -s tmp/.prereq-build<br> @make V=ss -r -s prereq</p> 
<p>%::<br> @make V=s -r -s prereq<br> @make -w -r world<br> 可见其中最终又执行了prereq和world目标，这两个目标都会进入到第二逻辑中。</p> 
<p>第二逻辑<br> 首先就引入了target, package, tools, toolchain这四个关键目录里的Makefile文件</p> 
<p>include target/Makefile<br> include package/Makefile<br> include tools/Makefile<br> include toolchain/Makefile<br> 这些子目录里的Makefile使用include/subdir.mk里定义的两个函数来动态生成规则，这两个函数是subdir和stampfile</p> 
<p>stampfile<br> 拿target/Makefile举例：</p> 
<p>(eval(call stampfile,$(curdir),target,prereq,.config))</p> 
<p>会生成规则：</p> 
<p>target/stamp-prereq:=$(STAGING_DIR)/stamp/.target_prereq</p> 
<p><span class="katex--display">KaTeX parse error: Can't use function '$' in math mode at position 24: …stamp-prereq): $̲(TMP_DIR)/.buil…</span>(target/stamp-prereq) target .config || <br> make <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          t 
         
        
          a 
         
        
          r 
         
        
          g 
         
        
          e 
         
        
          t 
         
        
          / 
         
        
          f 
         
        
          l 
         
        
          a 
         
        
          g 
         
        
          s 
         
        
          − 
         
        
          p 
         
        
          r 
         
        
          e 
         
        
          r 
         
        
          e 
         
        
          q 
         
        
          ) 
         
        
          t 
         
        
          a 
         
        
          r 
         
        
          g 
         
        
          e 
         
        
          t 
         
        
          / 
         
        
          p 
         
        
          r 
         
        
          e 
         
        
          r 
         
        
          e 
         
        
          q 
         
        
          @ 
         
        
          m 
         
        
          k 
         
        
          d 
         
        
          i 
         
        
          r 
         
        
          − 
         
        
          p 
         
        
       
         (target/flags-prereq) target/prereq @mkdir -p 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit">t</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord mathit" style="margin-right: 0.03588em;">g</span><span class="mord mathit">e</span><span class="mord mathit">t</span><span class="mord">/</span><span class="mord mathit" style="margin-right: 0.10764em;">f</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.03588em;">g</span><span class="mord mathit">s</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathit">p</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right: 0.03588em;">q</span><span class="mclose">)</span><span class="mord mathit">t</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord mathit" style="margin-right: 0.03588em;">g</span><span class="mord mathit">e</span><span class="mord mathit">t</span><span class="mord">/</span><span class="mord mathit">p</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right: 0.03588em;">q</span><span class="mord">@</span><span class="mord mathit">m</span><span class="mord mathit" style="margin-right: 0.03148em;">k</span><span class="mord mathit">d</span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.19444em;"></span><span class="mord mathit">p</span></span></span></span></span></span><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          d 
         
        
          i 
         
        
          r 
         
        
          n 
         
        
          a 
         
        
          m 
         
        
          e 
         
        
       
         (dirname 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit">d</span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord mathit">n</span><span class="mord mathit">a</span><span class="mord mathit">m</span><span class="mord mathit">e</span></span></span></span></span></span>(target/stamp-prereq))<br> @touch $$(target/stamp-prereq)</p> 
<p><span class="katex--display">KaTeX parse error: Can't use function '$' in math mode at position 5: (if $̲(call debug,tar…</span>(target/stamp-prereq))</p> 
<p>.PRECIOUS: $$(target/stamp-prereq) # work around a make bug</p> 
<p>target//clean:=target/stamp-prereq/clean<br> target/stamp-prereq/clean: FORCE<br> @rm -f $$(target/stamp-prereq)<br> 所以可以简单的看作：(eval(call stampfile,(curdir),target,prereq,.config))生成了目标(target/stamp-prereq)</p> 
<p>对于target分别生成了：(target/stamp-preq)，(target/stamp-copile)， $(target/stamp-install)<br> toolchain : $(toolchain/stamp-install)<br> package : (package/stamp-preq),(package/stamp-cleanup), (package/stamp-compile),(package/stamp-install)<br> tools : $(tools/stamp-install)<br> OpenWrt的主Makefile工作过程</p> 
<p>subdir<br> subdir这个函数写了一大堆东西，看起来很复杂 。</p> 
<p>$(call subdir, target) 会遍历下的子目录，执行 make -C 操作。这样就切入子目录中去了。</p> 
<p>目录变量<br> 几个重要的目录路径：</p> 
<p>KERNEL_BUILD_DIR</p> 
<p>build_dir/target-mipsel_24kec+dsp_uClibc-0.9.33.2/linux-ramips_mt7620a/linux-3.14.18</p> 
<p>LINUX_DIR</p> 
<p>build_dir/target-mipsel_24kec+dsp_uClibc-0.9.33.2/linux-ramips_mt7620a/linux-3.14.18</p> 
<p>KDIR</p> 
<p>build_dir/target-mipsel_24kec+dsp_uClibc-0.9.33.2/linux-ramips_mt7620a</p> 
<p>BIN_DIR</p> 
<p>bin/ramips<br> <a href="http://xn--Makefilerules-ij1up4bf85b2se.mk" rel="nofollow">Makefile中包含了rules.mk</a>, target.mk等.mk文件，这些文件中定义了许多变量，有些是路径相关的，有些是软件相关的。这些变量在整个Makefile工程中经常被用到，</p> 
<p>TARGET_ROOTFS_DIR</p> 
<p>build_dir/target-mipsel_24kec+dsp_uClibc-0.9.33.2</p> 
<p>BUILD_DIR</p> 
<p>build_dir/target-mipsel_24kec+dsp_uClibc-0.9.33.2</p> 
<p>STAGING_DIR_HOST</p> 
<p>staging_dir/toolchain-mipsel_24kec+dsp_gcc-4.8-linaro_uClibc-0.9.33.2</p> 
<p>TARGET_DIR</p> 
<p>build_dir/target-mipsel_24kec+dsp_uClibc-0.9.33.2/root-ramips</p> 
<p>回到顶部<br> kernel 编译：<br> target/linux/ramips/Makefile: $(eval $(call BuildTarget))</p> 
<p>target/linux/Makefile : export TARGET_BUILD=1</p> 
<p>根目录中Makefile：include target/Makefile --&gt;<br> target/Makefile中：<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         c 
        
       
         u 
        
       
         r 
        
       
         d 
        
       
         i 
        
       
         r 
        
       
         ) 
        
       
         / 
        
       
         b 
        
       
         u 
        
       
         i 
        
       
         l 
        
       
         d 
        
       
         d 
        
       
         i 
        
       
         r 
        
       
         s 
        
       
         : 
        
       
         = 
        
       
         l 
        
       
         i 
        
       
         n 
        
       
         u 
        
       
         x 
        
       
         s 
        
       
         d 
        
       
         k 
        
       
         i 
        
       
         m 
        
       
         a 
        
       
         g 
        
       
         e 
        
       
         b 
        
       
         u 
        
       
         i 
        
       
         l 
        
       
         d 
        
       
         e 
        
       
         r 
        
       
         t 
        
       
         o 
        
       
         o 
        
       
         l 
        
       
         c 
        
       
         h 
        
       
         a 
        
       
         i 
        
       
         n 
        
       
         − 
        
       
         − 
        
       
         &amp;gt; 
        
       
         t 
        
       
         a 
        
       
         r 
        
       
         g 
        
       
         e 
        
       
         t 
        
       
         / 
        
       
         l 
        
       
         i 
        
       
         n 
        
       
         u 
        
       
         x 
        
       
         中 
        
       
         M 
        
       
         a 
        
       
         k 
        
       
         e 
        
       
         f 
        
       
         i 
        
       
         l 
        
       
         e 
        
       
         : 
        
       
         @ 
        
       
         + 
        
       
      
        (curdir)/builddirs:=linux sdk imagebuilder toolchain --&amp;gt; target/linux中Makefile: @+ 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit">c</span><span class="mord mathit">u</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord mathit">d</span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mclose">)</span><span class="mord">/</span><span class="mord mathit">b</span><span class="mord mathit">u</span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">d</span><span class="mord mathit">d</span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord mathit">s</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">:</span></span><span class="base"><span class="strut" style="height: 0.36687em; vertical-align: 0em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.88888em; vertical-align: -0.19444em;"></span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mord mathit">u</span><span class="mord mathit">x</span><span class="mord mathit">s</span><span class="mord mathit">d</span><span class="mord mathit" style="margin-right: 0.03148em;">k</span><span class="mord mathit">i</span><span class="mord mathit">m</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.03588em;">g</span><span class="mord mathit">e</span><span class="mord mathit">b</span><span class="mord mathit">u</span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">d</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord mathit">t</span><span class="mord mathit">o</span><span class="mord mathit">o</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">c</span><span class="mord mathit">h</span><span class="mord mathit">a</span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.66666em; vertical-align: -0.08333em;"></span><span class="mord">−</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathit">t</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord mathit" style="margin-right: 0.03588em;">g</span><span class="mord mathit">e</span><span class="mord mathit">t</span><span class="mord">/</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mord mathit">u</span><span class="mord mathit">x</span><span class="mord cjk_fallback">中</span><span class="mord mathit" style="margin-right: 0.10903em;">M</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.03148em;">k</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right: 0.10764em;">f</span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">e</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.77777em; vertical-align: -0.08333em;"></span><span class="mord">@</span><span class="mord">+</span></span></span></span></span>(NO_TRACE_MAKE) -C $(BOARD) $@ --&gt;显然这里BOARD是ramips<br> target/linux/ramips中Makefile: include $(INCLUDE_DIR)/target.mk<br> include/target.mk中如下内容:</p> 
<p>ifeq ($(TARGET_BUILD),1)<br> include <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         I 
        
       
         N 
        
       
         C 
        
       
         L 
        
       
         U 
        
       
         D 
        
        
        
          E 
         
        
          D 
         
        
       
         I 
        
       
         R 
        
       
         ) 
        
       
         / 
        
       
         k 
        
       
         e 
        
       
         r 
        
       
         n 
        
       
         e 
        
       
         l 
        
       
         − 
        
       
         b 
        
       
         u 
        
       
         i 
        
       
         l 
        
       
         d 
        
       
         . 
        
       
         m 
        
       
         k 
        
       
         B 
        
       
         u 
        
       
         i 
        
       
         l 
        
       
         d 
        
       
         T 
        
       
         a 
        
       
         r 
        
       
         g 
        
       
         e 
        
       
         t 
        
       
         ? 
        
       
         = 
        
       
      
        (INCLUDE_DIR)/kernel-build.mk BuildTarget?= 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit" style="margin-right: 0.10903em;">N</span><span class="mord mathit" style="margin-right: 0.07153em;">C</span><span class="mord mathit">L</span><span class="mord mathit" style="margin-right: 0.10903em;">U</span><span class="mord mathit" style="margin-right: 0.02778em;">D</span><span class="mord"><span class="mord mathit" style="margin-right: 0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.05764em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight" style="margin-right: 0.02778em;">D</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit" style="margin-right: 0.00773em;">R</span><span class="mclose">)</span><span class="mord">/</span><span class="mord mathit" style="margin-right: 0.03148em;">k</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord mathit">n</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.88888em; vertical-align: -0.19444em;"></span><span class="mord mathit">b</span><span class="mord mathit">u</span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">d</span><span class="mord">.</span><span class="mord mathit">m</span><span class="mord mathit" style="margin-right: 0.03148em;">k</span><span class="mord mathit" style="margin-right: 0.05017em;">B</span><span class="mord mathit">u</span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">d</span><span class="mord mathit" style="margin-right: 0.13889em;">T</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord mathit" style="margin-right: 0.03588em;">g</span><span class="mord mathit">e</span><span class="mord mathit">t</span><span class="mclose">?</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span></span></span></span></span>(BuildKernel)<br> endif<br> BuildKernel是include/kernel-build.mk定义的一个多行变量，其中描述了如何编译内核, 主要关注其中install规则的依赖链：</p> 
<p>$(KERNEL_BUILD_DIR)/symtab.h: FORCE<br> rm -f $(KERNEL_BUILD_DIR)/symtab.h<br> touch <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         K 
        
       
         E 
        
       
         R 
        
       
         N 
        
       
         E 
        
        
        
          L 
         
        
          B 
         
        
       
         U 
        
       
         I 
        
       
         L 
        
        
        
          D 
         
        
          D 
         
        
       
         I 
        
       
         R 
        
       
         ) 
        
       
         / 
        
       
         s 
        
       
         y 
        
       
         m 
        
       
         t 
        
       
         a 
        
       
         b 
        
       
         . 
        
       
         h 
        
       
         + 
        
       
      
        (KERNEL_BUILD_DIR)/symtab.h + 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit" style="margin-right: 0.07153em;">K</span><span class="mord mathit" style="margin-right: 0.05764em;">E</span><span class="mord mathit" style="margin-right: 0.00773em;">R</span><span class="mord mathit" style="margin-right: 0.10903em;">N</span><span class="mord mathit" style="margin-right: 0.05764em;">E</span><span class="mord"><span class="mord mathit">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight" style="margin-right: 0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathit" style="margin-right: 0.10903em;">U</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit">L</span><span class="mord"><span class="mord mathit" style="margin-right: 0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.02778em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight" style="margin-right: 0.02778em;">D</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit" style="margin-right: 0.00773em;">R</span><span class="mclose">)</span><span class="mord">/</span><span class="mord mathit">s</span><span class="mord mathit" style="margin-right: 0.03588em;">y</span><span class="mord mathit">m</span><span class="mord mathit">t</span><span class="mord mathit">a</span><span class="mord mathit">b</span><span class="mord">.</span><span class="mord mathit">h</span><span class="mord">+</span></span></span></span></span>(MAKE) $(KERNEL_MAKEOPTS) vmlinux<br> …</p> 
<p>$(LINUX_DIR)/.image: $(STAMP_CONFIGURED) $(if <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         C 
        
       
         O 
        
       
         N 
        
       
         F 
        
       
         I 
        
        
        
          G 
         
        
          S 
         
        
       
         T 
        
       
         R 
        
       
         I 
        
        
        
          P 
         
        
          K 
         
        
       
         E 
        
       
         R 
        
       
         N 
        
       
         E 
        
        
        
          L 
         
        
          E 
         
        
       
         X 
        
       
         P 
        
       
         O 
        
       
         R 
        
       
         T 
        
       
         S 
        
       
         ) 
        
       
         , 
        
       
      
        (CONFIG_STRIP_KERNEL_EXPORTS), 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit" style="margin-right: 0.07153em;">C</span><span class="mord mathit" style="margin-right: 0.02778em;">O</span><span class="mord mathit" style="margin-right: 0.10903em;">N</span><span class="mord mathit" style="margin-right: 0.13889em;">F</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord"><span class="mord mathit">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight" style="margin-right: 0.05764em;">S</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathit" style="margin-right: 0.13889em;">T</span><span class="mord mathit" style="margin-right: 0.00773em;">R</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord"><span class="mord mathit" style="margin-right: 0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight" style="margin-right: 0.07153em;">K</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathit" style="margin-right: 0.05764em;">E</span><span class="mord mathit" style="margin-right: 0.00773em;">R</span><span class="mord mathit" style="margin-right: 0.10903em;">N</span><span class="mord mathit" style="margin-right: 0.05764em;">E</span><span class="mord"><span class="mord mathit">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight" style="margin-right: 0.05764em;">E</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathit" style="margin-right: 0.07847em;">X</span><span class="mord mathit" style="margin-right: 0.13889em;">P</span><span class="mord mathit" style="margin-right: 0.02778em;">O</span><span class="mord mathit" style="margin-right: 0.00773em;">R</span><span class="mord mathit" style="margin-right: 0.13889em;">T</span><span class="mord mathit" style="margin-right: 0.05764em;">S</span><span class="mclose">)</span><span class="mpunct">,</span></span></span></span></span>(KERNEL_BUILD_DIR)/symtab.h) FORCE<br> $(Kernel/CompileImage)<br> $(Kernel/CollectDebug)<br> touch $$@</p> 
<p>install: <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         L 
        
       
         I 
        
       
         N 
        
       
         U 
        
        
        
          X 
         
        
          D 
         
        
       
         I 
        
       
         R 
        
       
         ) 
        
       
         / 
        
       
         . 
        
       
         i 
        
       
         m 
        
       
         a 
        
       
         g 
        
       
         e 
        
       
         + 
        
       
      
        (LINUX_DIR)/.image + 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit">L</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit" style="margin-right: 0.10903em;">N</span><span class="mord mathit" style="margin-right: 0.10903em;">U</span><span class="mord"><span class="mord mathit" style="margin-right: 0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.07847em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight" style="margin-right: 0.02778em;">D</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit" style="margin-right: 0.00773em;">R</span><span class="mclose">)</span><span class="mord">/</span><span class="mord">.</span><span class="mord mathit">i</span><span class="mord mathit">m</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.03588em;">g</span><span class="mord mathit">e</span><span class="mord">+</span></span></span></span></span>(MAKE) -C image compile install TARGET_BUILD=</p> 
<ol><li> <p>触发make vmlinux命令生成vmlinux： install --&gt; $(LINUX_DIR)/.image --&gt; <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
       
        
         
         
           ( 
          
         
           K 
          
         
           E 
          
         
           R 
          
         
           N 
          
         
           E 
          
          
          
            L 
           
          
            B 
           
          
         
           U 
          
         
           I 
          
         
           L 
          
          
          
            D 
           
          
            D 
           
          
         
           I 
          
         
           R 
          
         
           ) 
          
         
           / 
          
         
           s 
          
         
           y 
          
         
           m 
          
         
           t 
          
         
           a 
          
         
           b 
          
         
           . 
          
         
           h 
          
         
           − 
          
         
           − 
          
         
           &amp;gt; 
          
         
           ‘ 
          
         
        
          (KERNEL_BUILD_DIR)/symtab.h --&amp;gt; ` 
         
        
      </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit" style="margin-right: 0.07153em;">K</span><span class="mord mathit" style="margin-right: 0.05764em;">E</span><span class="mord mathit" style="margin-right: 0.00773em;">R</span><span class="mord mathit" style="margin-right: 0.10903em;">N</span><span class="mord mathit" style="margin-right: 0.05764em;">E</span><span class="mord"><span class="mord mathit">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight" style="margin-right: 0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathit" style="margin-right: 0.10903em;">U</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit">L</span><span class="mord"><span class="mord mathit" style="margin-right: 0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.02778em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight" style="margin-right: 0.02778em;">D</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit" style="margin-right: 0.00773em;">R</span><span class="mclose">)</span><span class="mord">/</span><span class="mord mathit">s</span><span class="mord mathit" style="margin-right: 0.03588em;">y</span><span class="mord mathit">m</span><span class="mord mathit">t</span><span class="mord mathit">a</span><span class="mord mathit">b</span><span class="mord">.</span><span class="mord mathit">h</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.66666em; vertical-align: -0.08333em;"></span><span class="mord">−</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.69444em; vertical-align: 0em;"></span><span class="mord">‘</span></span></span></span></span>(MAKE) $(KERNEL_MAKEOPTS) vmlinux`</p> </li><li> <p>对vmlinux做objcopy, strip操作: $(LINUX_DIR)/.image --&gt; $(Kernel/CompileImage) --&gt; $(call Kernel/CompileImage/Default) --&gt; $(call Kernel/CompileImage/Default)</p> <p>$(KERNEL_CROSS)objcopy -O binary $(OBJCOPY_STRIP) -S $(LINUX_DIR)/vmlinux <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
       
        
         
         
           ( 
          
         
           L 
          
         
           I 
          
         
           N 
          
         
           U 
          
          
          
            X 
           
          
            K 
           
          
         
           E 
          
         
           R 
          
         
           N 
          
         
           E 
          
         
           L 
          
         
           ) 
          
         
        
          (LINUX_KERNEL) 
         
        
      </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit">L</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit" style="margin-right: 0.10903em;">N</span><span class="mord mathit" style="margin-right: 0.10903em;">U</span><span class="mord"><span class="mord mathit" style="margin-right: 0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.07847em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight" style="margin-right: 0.07153em;">K</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathit" style="margin-right: 0.05764em;">E</span><span class="mord mathit" style="margin-right: 0.00773em;">R</span><span class="mord mathit" style="margin-right: 0.10903em;">N</span><span class="mord mathit" style="margin-right: 0.05764em;">E</span><span class="mord mathit">L</span><span class="mclose">)</span></span></span></span></span>(1)<br> –&gt; build_dir/target-mipsel_24kec+dsp_uClibc-0.9.33.2/linux-ramips_mt7620a/vmlinux</p> <p>$(KERNEL_CROSS)objcopy $(OBJCOPY_STRIP) -S $(LINUX_DIR)/vmlinux <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
       
        
         
         
           ( 
          
         
           K 
          
         
           E 
          
         
           R 
          
         
           N 
          
         
           E 
          
          
          
            L 
           
          
            B 
           
          
         
           U 
          
         
           I 
          
         
           L 
          
          
          
            D 
           
          
            D 
           
          
         
           I 
          
         
           R 
          
         
           ) 
          
         
           / 
          
         
           v 
          
         
           m 
          
         
           l 
          
         
           i 
          
         
           n 
          
         
           u 
          
         
           x 
          
         
        
          (KERNEL_BUILD_DIR)/vmlinux 
         
        
      </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit" style="margin-right: 0.07153em;">K</span><span class="mord mathit" style="margin-right: 0.05764em;">E</span><span class="mord mathit" style="margin-right: 0.00773em;">R</span><span class="mord mathit" style="margin-right: 0.10903em;">N</span><span class="mord mathit" style="margin-right: 0.05764em;">E</span><span class="mord"><span class="mord mathit">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight" style="margin-right: 0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathit" style="margin-right: 0.10903em;">U</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit">L</span><span class="mord"><span class="mord mathit" style="margin-right: 0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.02778em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight" style="margin-right: 0.02778em;">D</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit" style="margin-right: 0.00773em;">R</span><span class="mclose">)</span><span class="mord">/</span><span class="mord mathit" style="margin-right: 0.03588em;">v</span><span class="mord mathit">m</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mord mathit">u</span><span class="mord mathit">x</span></span></span></span></span>(1).elf<br> –&gt; build_dir/target-mipsel_24kec+dsp_uClibc-0.9.33.2/linux-ramips_mt7620a/vmlinux.elf</p> <p>$(CP) $(LINUX_DIR)/vmlinux $(KERNEL_BUILD_DIR)/vmlinux.debug<br> –&gt; build_dir/target-mipsel_24kec+dsp_uClibc-0.9.33.2/linux-ramips_mt7620a/vmlinux.debug<br> 回到顶部<br> 生成firmware<br> firmware由kernel和rootfs两个部分组成，要对两个部分先分别处理，然后再合并成一个.bin文件。先看一下这个流程。</p> </li></ol> 
<p>“target/linux/ramips/image/Makefile” 文件中的最后一句：$(eval $(call BuildImage))，将BuildImage展开在这里。BuildImage定义在 include/image.mk 文件中，其中定义了数个目标的规则。</p> 
<p>define BuildImage</p> 
<pre><code>compile: compile-targets FORCE
	**$(call Build/Compile)**

install: compile install-targets FORCE
	...
	$(call Image/BuildKernel) ## 处理vmlinux
	...
	$(call Image/mkfs/squashfs) ## 生成squashfs，并与vmlinux合并成一个.bin文件
	...
</code></pre> 
<p>endef<br> 处理vmlinux: Image/BuildKernel<br> target/linux/ramips/image/Makefile:</p> 
<p>define Image/BuildKernel<br> cp $(KDIR)/vmlinux.elf <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         B 
        
       
         I 
        
        
        
          N 
         
        
          D 
         
        
       
         I 
        
       
         R 
        
       
         ) 
        
       
         / 
        
       
      
        (BIN_DIR)/ 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit" style="margin-right: 0.05017em;">B</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord"><span class="mord mathit" style="margin-right: 0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.10903em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight" style="margin-right: 0.02778em;">D</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit" style="margin-right: 0.00773em;">R</span><span class="mclose">)</span><span class="mord">/</span></span></span></span></span>(VMLINUX).elf<br> cp $(KDIR)/vmlinux <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         B 
        
       
         I 
        
        
        
          N 
         
        
          D 
         
        
       
         I 
        
       
         R 
        
       
         ) 
        
       
         / 
        
       
      
        (BIN_DIR)/ 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit" style="margin-right: 0.05017em;">B</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord"><span class="mord mathit" style="margin-right: 0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.10903em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight" style="margin-right: 0.02778em;">D</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit" style="margin-right: 0.00773em;">R</span><span class="mclose">)</span><span class="mord">/</span></span></span></span></span>(VMLINUX).bin<br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         c 
        
       
         a 
        
       
         l 
        
       
         l 
        
       
         C 
        
       
         o 
        
       
         m 
        
       
         p 
        
       
         r 
        
       
         e 
        
       
         s 
        
       
         s 
        
       
         L 
        
       
         z 
        
       
         m 
        
       
         a 
        
       
         , 
        
       
      
        (call CompressLzma, 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit">c</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit" style="margin-right: 0.07153em;">C</span><span class="mord mathit">o</span><span class="mord mathit">m</span><span class="mord mathit">p</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord mathit">e</span><span class="mord mathit">s</span><span class="mord mathit">s</span><span class="mord mathit">L</span><span class="mord mathit" style="margin-right: 0.04398em;">z</span><span class="mord mathit">m</span><span class="mord mathit">a</span><span class="mpunct">,</span></span></span></span></span>(KDIR)/vmlinux,$(KDIR)/vmlinux.bin.lzma)<br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         c 
        
       
         a 
        
       
         l 
        
       
         l 
        
       
         M 
        
       
         k 
        
       
         I 
        
       
         m 
        
       
         a 
        
       
         g 
        
       
         e 
        
       
         , 
        
       
         l 
        
       
         z 
        
       
         m 
        
       
         a 
        
       
         , 
        
       
      
        (call MkImage,lzma, 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit">c</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit" style="margin-right: 0.10903em;">M</span><span class="mord mathit" style="margin-right: 0.03148em;">k</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit">m</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.03588em;">g</span><span class="mord mathit">e</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit" style="margin-right: 0.04398em;">z</span><span class="mord mathit">m</span><span class="mord mathit">a</span><span class="mpunct">,</span></span></span></span></span>(KDIR)/vmlinux.bin.lzma,$(KDIR)/uImage.lzma)<br> cp $(KDIR)/uImage.lzma <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         B 
        
       
         I 
        
        
        
          N 
         
        
          D 
         
        
       
         I 
        
       
         R 
        
       
         ) 
        
       
         / 
        
       
      
        (BIN_DIR)/ 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit" style="margin-right: 0.05017em;">B</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord"><span class="mord mathit" style="margin-right: 0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.10903em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight" style="margin-right: 0.02778em;">D</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit" style="margin-right: 0.00773em;">R</span><span class="mclose">)</span><span class="mord">/</span></span></span></span></span>(UIMAGE).bin<br> ifneq ($(CONFIG_TARGET_ROOTFS_INITRAMFS),)<br> cp $(KDIR)/vmlinux-initramfs.elf <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         B 
        
       
         I 
        
        
        
          N 
         
        
          D 
         
        
       
         I 
        
       
         R 
        
       
         ) 
        
       
         / 
        
       
      
        (BIN_DIR)/ 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit" style="margin-right: 0.05017em;">B</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord"><span class="mord mathit" style="margin-right: 0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.10903em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight" style="margin-right: 0.02778em;">D</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit" style="margin-right: 0.00773em;">R</span><span class="mclose">)</span><span class="mord">/</span></span></span></span></span>(VMLINUX)-initramfs.elf<br> cp $(KDIR)/vmlinux-initramfs <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         B 
        
       
         I 
        
        
        
          N 
         
        
          D 
         
        
       
         I 
        
       
         R 
        
       
         ) 
        
       
         / 
        
       
      
        (BIN_DIR)/ 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit" style="margin-right: 0.05017em;">B</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord"><span class="mord mathit" style="margin-right: 0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.10903em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight" style="margin-right: 0.02778em;">D</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit" style="margin-right: 0.00773em;">R</span><span class="mclose">)</span><span class="mord">/</span></span></span></span></span>(VMLINUX)-initramfs.bin<br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         c 
        
       
         a 
        
       
         l 
        
       
         l 
        
       
         C 
        
       
         o 
        
       
         m 
        
       
         p 
        
       
         r 
        
       
         e 
        
       
         s 
        
       
         s 
        
       
         L 
        
       
         z 
        
       
         m 
        
       
         a 
        
       
         , 
        
       
      
        (call CompressLzma, 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit">c</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit" style="margin-right: 0.07153em;">C</span><span class="mord mathit">o</span><span class="mord mathit">m</span><span class="mord mathit">p</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord mathit">e</span><span class="mord mathit">s</span><span class="mord mathit">s</span><span class="mord mathit">L</span><span class="mord mathit" style="margin-right: 0.04398em;">z</span><span class="mord mathit">m</span><span class="mord mathit">a</span><span class="mpunct">,</span></span></span></span></span>(KDIR)/vmlinux-initramfs,$(KDIR)/vmlinux-initramfs.bin.lzma)<br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         c 
        
       
         a 
        
       
         l 
        
       
         l 
        
       
         M 
        
       
         k 
        
       
         I 
        
       
         m 
        
       
         a 
        
       
         g 
        
       
         e 
        
       
         , 
        
       
         l 
        
       
         z 
        
       
         m 
        
       
         a 
        
       
         , 
        
       
      
        (call MkImage,lzma, 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit">c</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit" style="margin-right: 0.10903em;">M</span><span class="mord mathit" style="margin-right: 0.03148em;">k</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit">m</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.03588em;">g</span><span class="mord mathit">e</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit" style="margin-right: 0.04398em;">z</span><span class="mord mathit">m</span><span class="mord mathit">a</span><span class="mpunct">,</span></span></span></span></span>(KDIR)/vmlinux-initramfs.bin.lzma,$(KDIR)/uImage-initramfs.lzma)<br> cp $(KDIR)/uImage-initramfs.lzma <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         B 
        
       
         I 
        
        
        
          N 
         
        
          D 
         
        
       
         I 
        
       
         R 
        
       
         ) 
        
       
         / 
        
       
      
        (BIN_DIR)/ 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit" style="margin-right: 0.05017em;">B</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord"><span class="mord mathit" style="margin-right: 0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.10903em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight" style="margin-right: 0.02778em;">D</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit" style="margin-right: 0.00773em;">R</span><span class="mclose">)</span><span class="mord">/</span></span></span></span></span>(UIMAGE)-initramfs.bin<br> endif<br> $(call Image/Build/Initramfs)<br> endef<br> lzma压缩内核<br> build_dir/target-mipsel_24kec+dsp_uClibc-0.9.33.2/linux-ramips_mt7620a/ 目录中:</p> 
<p>lzma e vmlinux -lc1 -lp2 -pb2 vmlinux.bin.lzma<br> MkImage<br> build_dir/target-mipsel_24kec+dsp_uClibc-0.9.33.2/linux-ramips_mt7620a/ 目录中：</p> 
<p>mkimage -A mips -O linux -T kernel -C lzma -a 0x80000000 -e 0x80000000 -n “MIPS OpenWrt Linux-3.14.18” -d vmlinux.bin.lzma uImage.lzma<br> copy<br> VMLINUX:=<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         I 
        
       
         M 
        
        
        
          G 
         
        
          P 
         
        
       
         R 
        
       
         E 
        
       
         F 
        
       
         I 
        
       
         X 
        
       
         ) 
        
       
         − 
        
       
         v 
        
       
         m 
        
       
         l 
        
       
         i 
        
       
         n 
        
       
         u 
        
       
         x 
        
       
         − 
        
       
         − 
        
       
         &amp;gt; 
        
       
         o 
        
       
         p 
        
       
         e 
        
       
         n 
        
       
         w 
        
       
         r 
        
       
         t 
        
       
         − 
        
       
         r 
        
       
         a 
        
       
         m 
        
       
         i 
        
       
         p 
        
       
         s 
        
       
         − 
        
       
         m 
        
       
         t 
        
       
         7620 
        
       
         a 
        
       
         − 
        
       
         v 
        
       
         m 
        
       
         l 
        
       
         i 
        
       
         n 
        
       
         u 
        
       
         x 
        
       
         U 
        
       
         I 
        
       
         M 
        
       
         A 
        
       
         G 
        
       
         E 
        
       
         : 
        
       
         = 
        
       
      
        (IMG_PREFIX)-vmlinux --&amp;gt; openwrt-ramips-mt7620a-vmlinux UIMAGE:= 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit" style="margin-right: 0.10903em;">M</span><span class="mord"><span class="mord mathit">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight" style="margin-right: 0.13889em;">P</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathit" style="margin-right: 0.00773em;">R</span><span class="mord mathit" style="margin-right: 0.05764em;">E</span><span class="mord mathit" style="margin-right: 0.13889em;">F</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit" style="margin-right: 0.07847em;">X</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.77777em; vertical-align: -0.08333em;"></span><span class="mord mathit" style="margin-right: 0.03588em;">v</span><span class="mord mathit">m</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mord mathit">u</span><span class="mord mathit">x</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.66666em; vertical-align: -0.08333em;"></span><span class="mord">−</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.80952em; vertical-align: -0.19444em;"></span><span class="mord mathit">o</span><span class="mord mathit">p</span><span class="mord mathit">e</span><span class="mord mathit">n</span><span class="mord mathit" style="margin-right: 0.02691em;">w</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord mathit">t</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.85396em; vertical-align: -0.19444em;"></span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord mathit">a</span><span class="mord mathit">m</span><span class="mord mathit">i</span><span class="mord mathit">p</span><span class="mord mathit">s</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.72777em; vertical-align: -0.08333em;"></span><span class="mord mathit">m</span><span class="mord mathit">t</span><span class="mord">7</span><span class="mord">6</span><span class="mord">2</span><span class="mord">0</span><span class="mord mathit">a</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.69444em; vertical-align: 0em;"></span><span class="mord mathit" style="margin-right: 0.03588em;">v</span><span class="mord mathit">m</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mord mathit">u</span><span class="mord mathit">x</span><span class="mord mathit" style="margin-right: 0.10903em;">U</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit" style="margin-right: 0.10903em;">M</span><span class="mord mathit">A</span><span class="mord mathit">G</span><span class="mord mathit" style="margin-right: 0.05764em;">E</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">:</span></span><span class="base"><span class="strut" style="height: 0.36687em; vertical-align: 0em;"></span><span class="mrel">=</span></span></span></span></span>(IMG_PREFIX)-uImage --&gt; openwrt-ramips-mt7620a-uImage<br> cp $(KDIR)/uImage.lzma <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         B 
        
       
         I 
        
        
        
          N 
         
        
          D 
         
        
       
         I 
        
       
         R 
        
       
         ) 
        
       
         / 
        
       
      
        (BIN_DIR)/ 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit" style="margin-right: 0.05017em;">B</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord"><span class="mord mathit" style="margin-right: 0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.10903em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight" style="margin-right: 0.02778em;">D</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit" style="margin-right: 0.00773em;">R</span><span class="mclose">)</span><span class="mord">/</span></span></span></span></span>(UIMAGE).bin<br> 把uImage.lzma复制到bin/ramips/目录下：<br> cp $(KDIR)/uImage.lzma bin/ramips/openwrt-ramips-mt7620a-uImage</p> 
<p>制作squashfs，生成.bin: $(call Image/mkfs/squashfs)<br> define Image/mkfs/squashfs<br> @mkdir -p $(TARGET_DIR)/overlay<br> $(STAGING_DIR_HOST)/bin/mksquashfs4 $(TARGET_DIR) $(KDIR)/root.squashfs -nopad -noappend -root-owned -comp $(SQUASHFSCOMP) $(SQUASHFSOPT) -processors $(if <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         C 
        
       
         O 
        
       
         N 
        
       
         F 
        
       
         I 
        
        
        
          G 
         
        
          P 
         
        
       
         K 
        
        
        
          G 
         
        
          B 
         
        
       
         U 
        
       
         I 
        
       
         L 
        
        
        
          D 
         
        
          J 
         
        
       
         O 
        
       
         B 
        
       
         S 
        
       
         ) 
        
       
         , 
        
       
      
        (CONFIG_PKG_BUILD_JOBS), 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit" style="margin-right: 0.07153em;">C</span><span class="mord mathit" style="margin-right: 0.02778em;">O</span><span class="mord mathit" style="margin-right: 0.10903em;">N</span><span class="mord mathit" style="margin-right: 0.13889em;">F</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord"><span class="mord mathit">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight" style="margin-right: 0.13889em;">P</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathit" style="margin-right: 0.07153em;">K</span><span class="mord"><span class="mord mathit">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight" style="margin-right: 0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathit" style="margin-right: 0.10903em;">U</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit">L</span><span class="mord"><span class="mord mathit" style="margin-right: 0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.02778em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight" style="margin-right: 0.09618em;">J</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathit" style="margin-right: 0.02778em;">O</span><span class="mord mathit" style="margin-right: 0.05017em;">B</span><span class="mord mathit" style="margin-right: 0.05764em;">S</span><span class="mclose">)</span><span class="mpunct">,</span></span></span></span></span>(CONFIG_PKG_BUILD_JOBS),1)<br> $(call Image/Build,squashfs)<br> endif<br> mkdir -p $(TARGET_DIR)/overlay<br> mkdir -p build_dir/target-mipsel_24kec+dsp_uClibc-0.9.33.2/root-ramips/overlay</p> 
<p>mksquashfs4<br> $(STAGING_DIR_HOST)/bin/mksquashfs4 $(TARGET_DIR) $(KDIR)/root.squashfs -nopad -noappend -root-owned -comp $(SQUASHFSCOMP) $(SQUASHFSOPT) -processors $(if <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         C 
        
       
         O 
        
       
         N 
        
       
         F 
        
       
         I 
        
        
        
          G 
         
        
          P 
         
        
       
         K 
        
        
        
          G 
         
        
          B 
         
        
       
         U 
        
       
         I 
        
       
         L 
        
        
        
          D 
         
        
          J 
         
        
       
         O 
        
       
         B 
        
       
         S 
        
       
         ) 
        
       
         , 
        
       
      
        (CONFIG_PKG_BUILD_JOBS), 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit" style="margin-right: 0.07153em;">C</span><span class="mord mathit" style="margin-right: 0.02778em;">O</span><span class="mord mathit" style="margin-right: 0.10903em;">N</span><span class="mord mathit" style="margin-right: 0.13889em;">F</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord"><span class="mord mathit">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight" style="margin-right: 0.13889em;">P</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathit" style="margin-right: 0.07153em;">K</span><span class="mord"><span class="mord mathit">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight" style="margin-right: 0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathit" style="margin-right: 0.10903em;">U</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit">L</span><span class="mord"><span class="mord mathit" style="margin-right: 0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.02778em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight" style="margin-right: 0.09618em;">J</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathit" style="margin-right: 0.02778em;">O</span><span class="mord mathit" style="margin-right: 0.05017em;">B</span><span class="mord mathit" style="margin-right: 0.05764em;">S</span><span class="mclose">)</span><span class="mpunct">,</span></span></span></span></span>(CONFIG_PKG_BUILD_JOBS),1)<br> 制作squashfs文件系统，生成root.squashfs:</p> 
<p>mksquashfs4 root-ramips root.squashfs -nopad -noappend -root-owned -comp gzip -b 256k -p ‘/dev d 755 0 0’ -p ‘/dev/console c 600 0 0 5 1’ -processors 1<br> $(call Image/Build,squashfs)<br> 在 target/linux/ramips/image/Makefile 中：</p> 
<p>define Image/Build<br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         c 
        
       
         a 
        
       
         l 
        
       
         l 
        
       
         I 
        
       
         m 
        
       
         a 
        
       
         g 
        
       
         e 
        
       
         / 
        
       
         B 
        
       
         u 
        
       
         i 
        
       
         l 
        
       
         d 
        
       
         / 
        
       
      
        (call Image/Build/ 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit">c</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit">m</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.03588em;">g</span><span class="mord mathit">e</span><span class="mord">/</span><span class="mord mathit" style="margin-right: 0.05017em;">B</span><span class="mord mathit">u</span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">d</span><span class="mord">/</span></span></span></span></span>(1))<br> dd if=<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         K 
        
       
         D 
        
       
         I 
        
       
         R 
        
       
         ) 
        
       
         / 
        
       
         r 
        
       
         o 
        
       
         o 
        
       
         t 
        
       
         . 
        
       
      
        (KDIR)/root. 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit" style="margin-right: 0.07153em;">K</span><span class="mord mathit" style="margin-right: 0.02778em;">D</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit" style="margin-right: 0.00773em;">R</span><span class="mclose">)</span><span class="mord">/</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord mathit">o</span><span class="mord mathit">o</span><span class="mord mathit">t</span><span class="mord">.</span></span></span></span></span>(1) of=<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         B 
        
       
         I 
        
        
        
          N 
         
        
          D 
         
        
       
         I 
        
       
         R 
        
       
         ) 
        
       
         / 
        
       
      
        (BIN_DIR)/ 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit" style="margin-right: 0.05017em;">B</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord"><span class="mord mathit" style="margin-right: 0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.10903em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight" style="margin-right: 0.02778em;">D</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit" style="margin-right: 0.00773em;">R</span><span class="mclose">)</span><span class="mord">/</span></span></span></span></span>(IMG_PREFIX)-root.$(1) bs=128k conv=sync<br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         c 
        
       
         a 
        
       
         l 
        
       
         l 
        
       
         I 
        
       
         m 
        
       
         a 
        
       
         g 
        
       
         e 
        
       
         / 
        
       
         B 
        
       
         u 
        
       
         i 
        
       
         l 
        
       
         d 
        
       
         / 
        
       
         P 
        
       
         r 
        
       
         o 
        
       
         f 
        
       
         i 
        
       
         l 
        
       
         e 
        
       
         / 
        
       
      
        (call Image/Build/Profile/ 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit">c</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit">m</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.03588em;">g</span><span class="mord mathit">e</span><span class="mord">/</span><span class="mord mathit" style="margin-right: 0.05017em;">B</span><span class="mord mathit">u</span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">d</span><span class="mord">/</span><span class="mord mathit" style="margin-right: 0.13889em;">P</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord mathit">o</span><span class="mord mathit" style="margin-right: 0.10764em;">f</span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">e</span><span class="mord">/</span></span></span></span></span>(PROFILE),<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         1 
        
       
         ) 
        
       
         ) 
        
       
         e 
        
       
         n 
        
       
         d 
        
       
         e 
        
       
         f 
        
       
         d 
        
       
         d 
        
       
         i 
        
       
         f 
        
       
         = 
        
       
         ( 
        
       
         K 
        
       
         D 
        
       
         I 
        
       
         R 
        
       
         ) 
        
       
         / 
        
       
         r 
        
       
         o 
        
       
         o 
        
       
         t 
        
       
         . 
        
       
         s 
        
       
         q 
        
       
         u 
        
       
         a 
        
       
         s 
        
       
         h 
        
       
         f 
        
       
         s 
        
       
         o 
        
       
         f 
        
       
         = 
        
       
         ( 
        
       
         B 
        
       
         I 
        
        
        
          N 
         
        
          D 
         
        
       
         I 
        
       
         R 
        
       
         ) 
        
       
         / 
        
       
      
        (1)) endef dd if=(KDIR)/root.squashfsof=(BIN_DIR)/ 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span><span class="mclose">)</span><span class="mord mathit">e</span><span class="mord mathit">n</span><span class="mord mathit">d</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right: 0.10764em;">f</span><span class="mord mathit">d</span><span class="mord mathit">d</span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right: 0.10764em;">f</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit" style="margin-right: 0.07153em;">K</span><span class="mord mathit" style="margin-right: 0.02778em;">D</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit" style="margin-right: 0.00773em;">R</span><span class="mclose">)</span><span class="mord">/</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord mathit">o</span><span class="mord mathit">o</span><span class="mord mathit">t</span><span class="mord">.</span><span class="mord mathit">s</span><span class="mord mathit" style="margin-right: 0.03588em;">q</span><span class="mord mathit">u</span><span class="mord mathit">a</span><span class="mord mathit">s</span><span class="mord mathit">h</span><span class="mord mathit" style="margin-right: 0.10764em;">f</span><span class="mord mathit">s</span><span class="mord mathit">o</span><span class="mord mathit" style="margin-right: 0.10764em;">f</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit" style="margin-right: 0.05017em;">B</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord"><span class="mord mathit" style="margin-right: 0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.10903em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight" style="margin-right: 0.02778em;">D</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit" style="margin-right: 0.00773em;">R</span><span class="mclose">)</span><span class="mord">/</span></span></span></span></span>(IMG_PREFIX)-root.squashfs bs=128k conv=sync<br> dd if=build_dir/target-mipsel_24kec+dsp_uClibc-0.9.33.2/linux-ramips_mt7620a/root.squashfs of=bin/ramips/openwrt-ramips-mt7620-root.squashfs bs=128k conv=sync</p> 
<p>(callImage/Build/Profile/(PROFILE),squashfs)<br> target/linux/ramips/mt7620a/profiles/00-default.mk, 中调用 Profile 函数：$(eval $(call Profile,Default))</p> 
<p>include/target.mk 中定义了 Profile 函数， 其中令 PROFILE=Default</p> 
<p>define Image/Build/Profile/Default<br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         c 
        
       
         a 
        
       
         l 
        
       
         l 
        
       
         I 
        
       
         m 
        
       
         a 
        
       
         g 
        
       
         e 
        
       
         / 
        
       
         B 
        
       
         u 
        
       
         i 
        
       
         l 
        
       
         d 
        
       
         / 
        
       
         P 
        
       
         r 
        
       
         o 
        
       
         f 
        
       
         i 
        
       
         l 
        
       
         e 
        
       
         / 
        
       
         M 
        
       
         T 
        
       
         7620 
        
       
         a 
        
       
         , 
        
       
      
        (call Image/Build/Profile/MT7620a, 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit">c</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit">m</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.03588em;">g</span><span class="mord mathit">e</span><span class="mord">/</span><span class="mord mathit" style="margin-right: 0.05017em;">B</span><span class="mord mathit">u</span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">d</span><span class="mord">/</span><span class="mord mathit" style="margin-right: 0.13889em;">P</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord mathit">o</span><span class="mord mathit" style="margin-right: 0.10764em;">f</span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">e</span><span class="mord">/</span><span class="mord mathit" style="margin-right: 0.10903em;">M</span><span class="mord mathit" style="margin-right: 0.13889em;">T</span><span class="mord">7</span><span class="mord">6</span><span class="mord">2</span><span class="mord">0</span><span class="mord mathit">a</span><span class="mpunct">,</span></span></span></span></span>(1))<br> …<br> endef<br> 规则依赖序列如下：</p> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         c 
        
       
         a 
        
       
         l 
        
       
         l 
        
       
         I 
        
       
         m 
        
       
         a 
        
       
         g 
        
       
         e 
        
       
         / 
        
       
         B 
        
       
         u 
        
       
         i 
        
       
         l 
        
       
         d 
        
       
         / 
        
       
         P 
        
       
         r 
        
       
         o 
        
       
         f 
        
       
         i 
        
       
         l 
        
       
         e 
        
       
         / 
        
       
      
        (call Image/Build/Profile/ 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit">c</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit">m</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.03588em;">g</span><span class="mord mathit">e</span><span class="mord">/</span><span class="mord mathit" style="margin-right: 0.05017em;">B</span><span class="mord mathit">u</span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">d</span><span class="mord">/</span><span class="mord mathit" style="margin-right: 0.13889em;">P</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord mathit">o</span><span class="mord mathit" style="margin-right: 0.10764em;">f</span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">e</span><span class="mord">/</span></span></span></span></span>(PROFILE),squashfs)<br> –&gt; $(call BuildFirmware/Default8M/squashfs,squashfs,mt7620a,MT7620a)<br> –&gt; $(call BuildFirmware/OF,squashfs,mt7620a,MT7620a,8060928)<br> –&gt; $(call MkImageLzmaDtb,mt7620a,MT7620a)<br> –&gt; $(call PatchKernelLzmaDtb,mt7620a,MT7620a)<br> –&gt; <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         c 
        
       
         a 
        
       
         l 
        
       
         l 
        
       
         M 
        
       
         k 
        
       
         I 
        
       
         m 
        
       
         a 
        
       
         g 
        
       
         e 
        
       
         , 
        
       
         l 
        
       
         z 
        
       
         m 
        
       
         a 
        
       
         , 
        
       
      
        (call MkImage,lzma, 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit">c</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit" style="margin-right: 0.10903em;">M</span><span class="mord mathit" style="margin-right: 0.03148em;">k</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit">m</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.03588em;">g</span><span class="mord mathit">e</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit" style="margin-right: 0.04398em;">z</span><span class="mord mathit">m</span><span class="mord mathit">a</span><span class="mpunct">,</span></span></span></span></span>(KDIR)/vmlinux-mt7620a.bin.lzma,$(KDIR)/vmlinux-mt7620a.uImage)<br> –&gt; $(call MkImageSysupgrade/squashfs,squashfs,mt7620a,8060928)<br> 其中的主要步骤：</p> 
<p>复制： cp (KDIR)/vmlinux(KDIR)/vmlinux-mt7620a<br> 生成dtb文件：(LINUXDIR)/scripts/dtc/dtc-Odtb-o(KDIR)/MT7620a.dtb …/dts/MT7620a.dts<br> 将内核与dtb文件合并：(STAGINGDIRHOST)/bin/patch-dtb(KDIR)/vmlinux-mt7620a <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         K 
        
       
         D 
        
       
         I 
        
       
         R 
        
       
         ) 
        
       
         / 
        
       
         M 
        
       
         T 
        
       
         使 
        
       
         用 
        
       
         l 
        
       
         z 
        
       
         m 
        
       
         a 
        
       
         压 
        
       
         缩 
        
       
         ： 
        
       
         ( 
        
       
         c 
        
       
         a 
        
       
         l 
        
       
         l 
        
       
         C 
        
       
         o 
        
       
         m 
        
       
         p 
        
       
         r 
        
       
         e 
        
       
         s 
        
       
         s 
        
       
         L 
        
       
         z 
        
       
         m 
        
       
         a 
        
       
         , 
        
       
         ( 
        
       
         K 
        
       
         D 
        
       
         I 
        
       
         R 
        
       
         ) 
        
       
         / 
        
       
         v 
        
       
         m 
        
       
         l 
        
       
         i 
        
       
         n 
        
       
         u 
        
       
         x 
        
       
         − 
        
       
         m 
        
       
         t 
        
       
         7620 
        
       
         a 
        
       
         , 
        
       
      
        (KDIR)/MT 使用lzma压缩：(callCompressLzma,(KDIR)/vmlinux-mt7620a, 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathit" style="margin-right: 0.07153em;">K</span><span class="mord mathit" style="margin-right: 0.02778em;">D</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit" style="margin-right: 0.00773em;">R</span><span class="mclose">)</span><span class="mord">/</span><span class="mord mathit" style="margin-right: 0.10903em;">M</span><span class="mord mathit" style="margin-right: 0.13889em;">T</span><span class="mord cjk_fallback">使</span><span class="mord cjk_fallback">用</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit" style="margin-right: 0.04398em;">z</span><span class="mord mathit">m</span><span class="mord mathit">a</span><span class="mord cjk_fallback">压</span><span class="mord cjk_fallback">缩</span><span class="mord cjk_fallback">：</span><span class="mopen">(</span><span class="mord mathit">c</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit" style="margin-right: 0.07153em;">C</span><span class="mord mathit">o</span><span class="mord mathit">m</span><span class="mord mathit">p</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord mathit">e</span><span class="mord mathit">s</span><span class="mord mathit">s</span><span class="mord mathit">L</span><span class="mord mathit" style="margin-right: 0.04398em;">z</span><span class="mord mathit">m</span><span class="mord mathit">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mopen">(</span><span class="mord mathit" style="margin-right: 0.07153em;">K</span><span class="mord mathit" style="margin-right: 0.02778em;">D</span><span class="mord mathit" style="margin-right: 0.07847em;">I</span><span class="mord mathit" style="margin-right: 0.00773em;">R</span><span class="mclose">)</span><span class="mord">/</span><span class="mord mathit" style="margin-right: 0.03588em;">v</span><span class="mord mathit">m</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mord mathit">u</span><span class="mord mathit">x</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.83888em; vertical-align: -0.19444em;"></span><span class="mord mathit">m</span><span class="mord mathit">t</span><span class="mord">7</span><span class="mord">6</span><span class="mord">2</span><span class="mord">0</span><span class="mord mathit">a</span><span class="mpunct">,</span></span></span></span></span>(KDIR)/vmlinux-mt7620a.bin.lzma)<br> 将lzma压缩后的文件经过mkimage工具处理，即在头部添加uboot可识别的信息。<br> 接下来就是合并生成firmware固件了：</p> 
<p>MkImageSysupgrade/squashfs, squashfs, mt7620a,8060928</p> 
<p>cat vmlinux-mt7620a.uImage root.squashfs &gt; openwrt-ramips-mt7620-mt7620a-squashfs-sysupgrade.bin<br> –&gt; 制作squashfs bin文档, 并确认它的大小 &lt; 8060928 才是有效的，否则报错。</p> 
<p>总结： 整个流程下来，其实最烦索的还是对内核生成文件vmlinux的操作，经过了objcopy, patch-dtb, lzma, mkimage 等过程生成一个uImage，再与mksquashfs工具制作的文件系统rootfs.squashfs合并。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0fd957522a1c12ca101351a24ea64e11/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【Android工程师与智能家居产品的第一次接触③】SmartConfig一键配网在硬件端的具体实现|ESP8266一键配网在Arduino的具体实现|玉念聿辉</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/28c24a2bcf0cccd67cb7929bcef2b7e1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">基于STM32的DMX512开发笔记</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>