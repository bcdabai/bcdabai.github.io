<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>spring cloud Hystix熔断机制--基本熔断配置和Fegin client熔断配置 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="spring cloud Hystix熔断机制--基本熔断配置和Fegin client熔断配置" />
<meta property="og:description" content="所谓的熔断机制和日常生活中见到电路保险丝是非常相似的，当出现了问题之后，保险丝会自动烧断，以保护我们的电器， 那么如果换到了程序之中呢？
当现在服务的提供方出现了问题之后整个的程序将出现错误的信息显示，而这个时候如果不想出现这样的错误信息，而希望替换为一个错误时的内容。
一个服务变慢了，后续的其他调用者服务跟着不能用了，这就是雪崩效应
对于熔断技术的实现需要考虑以下几种情况：
· 出现错误之后可以 fallback 错误的处理信息；
· 如果要结合 Feign 一起使用的时候还需要在 Feign（客户端）进行熔断的配置。
一、基于ribbon的Hystrix 基本配置 1、复制项目重命名为springcloud-moveServer-hystrix修改调用方 pom.xml 配置文件，追加 Hystrix 配置类： &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-hystrix&lt;/artifactId&gt; &lt;/dependency&gt; 2.修改程序 controller package com.pupeiyuan.controller; import java.util.ArrayList; import java.util.List; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.beans.factory.annotation.Qualifier; import org.springframework.beans.factory.annotation.Value; import org.springframework.cloud.context.config.annotation.RefreshScope; import org.springframework.web.bind.annotation.GetMapping; import org.springframework.web.bind.annotation.PathVariable; import org.springframework.web.bind.annotation.RestController; import org.springframework.web.client.RestTemplate; import com.netflix.appinfo.InstanceInfo; import com.netflix.discovery.EurekaClient; import com.netflix.hystrix.contrib.javanica.annotation.HystrixCommand; import com.pupeiyuan.bean.NhReportStatusHistory; @RestController @RefreshScope public class ConfigClientController { //spring 提供用于访问rest接口的模板对象 @Autowired @Qualifier(value = &#34;remoteRestTemplate&#34;) private RestTemplate restTemplate; @HystrixCommand(fallbackMethod = &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/7c0e9589c1feab6a27d7b238f6ecb428/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-08-11T09:48:52+08:00" />
<meta property="article:modified_time" content="2020-08-11T09:48:52+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">spring cloud Hystix熔断机制--基本熔断配置和Fegin client熔断配置</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>所谓的熔断机制和日常生活中见到电路保险丝是非常相似的，当出现了问题之后，保险丝会自动烧断，以保护我们的电器， 那么如果换到了程序之中呢？</p> 
<p>当现在服务的提供方出现了问题之后整个的程序将出现错误的信息显示，而这个时候如果不想出现这样的错误信息，而希望替换为一个错误时的内容。</p> 
<p><img alt="" height="473" src="https://images2.imgbox.com/ab/2b/cfQ0obCH_o.png" width="878"></p> 
<p><strong>一个服务变慢了，后续的其他调用者服务跟着不能用了，这就是雪崩效应</strong></p> 
<p> 对于熔断技术的实现需要考虑以下几种情况：</p> 
<p> · 出现错误之后可以 fallback 错误的处理信息；</p> 
<p> · 如果要结合 Feign 一起使用的时候还需要在 Feign（客户端）进行熔断的配置。</p> 
<h3 id="h2_1"><strong>一、基于ribbon的Hystrix 基本配置</strong></h3> 
<h4 id="h3_2"><strong>1、复制项目重命名为springcloud-moveServer-hystrix修改调用方 pom.xml 配置文件，追加 Hystrix 配置类：</strong></h4> 
<pre><code class="language-XML">&lt;dependency&gt; 
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; 
    &lt;artifactId&gt;spring-cloud-starter-hystrix&lt;/artifactId&gt; 
&lt;/dependency&gt;</code></pre> 
<p> </p> 
<h4 id="h3_4">2.修改程序 controller</h4> 
<pre><code class="language-java">package com.pupeiyuan.controller;

import java.util.ArrayList;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.cloud.context.config.annotation.RefreshScope;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.client.RestTemplate;

import com.netflix.appinfo.InstanceInfo;
import com.netflix.discovery.EurekaClient;
import com.netflix.hystrix.contrib.javanica.annotation.HystrixCommand;
import com.pupeiyuan.bean.NhReportStatusHistory;

@RestController
@RefreshScope
public class ConfigClientController {

     //spring 提供用于访问rest接口的模板对象
    @Autowired
    @Qualifier(value = "remoteRestTemplate")
    private RestTemplate restTemplate;
    @HystrixCommand(fallbackMethod = "findByIdFallback")
      @GetMapping("/balance/{id}")
      public List&lt;NhReportStatusHistory&gt; getBalance(@PathVariable Long id) {
          return this.restTemplate.getForObject("http://MULTIPLE/getDate/"+id, List.class);
            
      }
    public List&lt;NhReportStatusHistory&gt; findByIdFallback(Long id) {
        NhReportStatusHistory nhreportstatushistory = new NhReportStatusHistory();
        nhreportstatushistory.setId("000000000000");
        List&lt;NhReportStatusHistory&gt; list = new ArrayList&lt;&gt;();
        list.add(nhreportstatushistory);
        return list;
      }
}</code></pre> 
<p>这里需要注意的是，fallback方法的参数和类型要和原方法保持一致，否则会出现异常</p> 
<h4 id="h3_5">3、在主类之中启动熔断处理</h4> 
<pre><code class="language-java">package com.pupeiyuan.config;


import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;
import org.springframework.boot.builder.SpringApplicationBuilder;
import org.springframework.boot.web.support.SpringBootServletInitializer;
import org.springframework.cloud.client.circuitbreaker.EnableCircuitBreaker;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;
import org.springframework.cloud.client.loadbalancer.LoadBalanced;
import org.springframework.cloud.context.config.annotation.RefreshScope;
import org.springframework.cloud.netflix.feign.EnableFeignClients;
import org.springframework.cloud.netflix.ribbon.RibbonClient;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.ComponentScan;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.FilterType;
import org.springframework.web.client.RestTemplate;

import feign.Logger;

@Configuration
//扫描bean
@ComponentScan(basePackages = "com.pupeiyuan.*")
//不用自动配置数据源
@EnableDiscoveryClient
@SpringBootApplication(exclude=DataSourceAutoConfiguration.class)
@EnableFeignClients(basePackages="com.pupeiyuan.feignClient")
@EnableCircuitBreaker
public class MainApplication extends SpringBootServletInitializer {

    @Bean
    Logger.Level feignLoggerLevel() {
        return Logger.Level.FULL;
    }
     //相当于xml中的bean标签 用于调用当前方法获取到指定的对象
    @Bean(name="remoteRestTemplate")
    @LoadBalanced
    public RestTemplate getRestTemplate(){
        return new RestTemplate();
    }
    @Override
    protected SpringApplicationBuilder configure(SpringApplicationBuilder builder) {
        return builder.sources(MainApplication.class);
    }
}</code></pre> 
<p> </p> 
<p>到此，一个简单基于ribbon的Hystix熔断机制就配置好了。</p> 
<p> </p> 
<h3 id="h2_6"><strong>二、基于Feign client的Hystrix 配置</strong></h3> 
<h4 id="h3_7"><strong>1、复制项目重命名为springcloud-moveServer-hystrix修改调用方 pom.xml 配置文件，追加 Hystrix 配置类：</strong></h4> 
<pre><code class="language-XML">        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-hystrix&lt;/artifactId&gt;
        &lt;/dependency&gt;</code></pre> 
<h4 id="h3_8">2、增加配置启用</h4> 
<pre><code>feign.hystrix.enabled=true</code></pre> 
<h4 id="h3_9">3、启动类增加注解</h4> 
<pre><code>@EnableCircuitBreaker</code></pre> 
<h4 id="h3_10">4、增加FeignClient2业务接口，并配置fallback </h4> 
<pre><code class="language-java">package com.pupeiyuan.feignClient;

import java.util.List;

import org.springframework.cloud.netflix.feign.FeignClient;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;

import com.config.FeignConfiguration;
import com.pupeiyuan.bean.NhReportStatusHistory;

import feign.Param;
import feign.RequestLine;

@FeignClient(name = "MULTIPLE",configuration = FeignConfiguration.class,fallback=HystrixClientFallback.class)
public interface FeignClient2 {

    @RequestMapping(value = "/getDate/{id}", method = RequestMethod.GET)
    public List&lt;NhReportStatusHistory&gt; dataList(@PathVariable("id") Long id);
}</code></pre> 
<h4 id="h3_11">5.增加HystrixClientFallback类</h4> 
<pre><code class="language-java">package com.pupeiyuan.feignClient;

import java.util.ArrayList;
import java.util.List;

import org.springframework.stereotype.Component;

import com.pupeiyuan.bean.NhReportStatusHistory;

@Component
public class HystrixClientFallback implements FeignClient2{

    @Override
    public List&lt;NhReportStatusHistory&gt; dataList(Long id) {
        NhReportStatusHistory nhreportstatushistory = new NhReportStatusHistory();
        nhreportstatushistory.setId("99999999999999");
        List&lt;NhReportStatusHistory&gt; list = new ArrayList&lt;&gt;();
        list.add(nhreportstatushistory);
        return list;
    }

}</code></pre> 
<p> </p> 
<p>演示如下，停调multiple服务，请求结果</p> 
<p><img alt="" src="https://images2.imgbox.com/ba/9b/EgDgtCbR_o.png"></p> 
<p> </p> 
<p>请求健康状态接口显示断路器已经在打开状态</p> 
<p><img alt="" height="498" src="https://images2.imgbox.com/01/bd/vAYj0zZy_o.png" width="1177"></p> 
<p> </p> 
<h3 id="h2_12">三、如何禁用单个FegionClient的Hystrix的支持</h3> 
<p>在自定义Feign Client配置文件FeignConfiguration.java中新增配置即可</p> 
<pre><code class="language-java">package com.pupeiyuan.feignClientConfig;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Scope;

import feign.Contract;
import feign.Feign;
import feign.Logger;
@Configuration
public class FeignConfiguration {

    @Bean
    public Contract feignContract() {
        //这里可以配置默认配置
        return new feign.Contract.Default();
    }

    @Bean
    Logger.Level feignLoggerLevel() {
        return Logger.Level.FULL;
    }
    
    @Bean
    @Scope("prototype")
    public Feign.Builder feignBuilder() {
        return Feign.builder();
    }
}</code></pre> 
<p>使用这个feign client配置文件的feign client都不会启用熔断器</p> 
<p><img alt="fcd432e307bd4d52f899ac1dec3bd5cd7ce.png" src="https://images2.imgbox.com/9d/bd/IxoIJULu_o.png"></p> 
<p><img alt="" height="270" src="https://images2.imgbox.com/22/0a/IIv7GUzS_o.png" width="730"></p> 
<h3 id="h2_13">四、Feign使用fallbackFactory属性打印fallback异常</h3> 
<h4 id="h3_14">1、基本配置略</h4> 
<h4 id="h3_15">2、配置UserFeignClient </h4> 
<p> </p> 
<pre><code class="language-java">@FeignClient(name = "microservice-provider-user",  fallbackFactory = HystrixClientFallbackFactory.class)
public interface UserFeignClient {
    // @GetMapping("/sample/{id}")
    @RequestMapping(method = RequestMethod.GET, value = "/sample/{id}")
    public User findById(@PathVariable("id") Long id);
}</code></pre> 
<p> </p> 
<p>注意：配置了fallbackFactory ，如果同时设置fallback和fallbackfactory不可以有冲突，只能设置一个，fallbackFactory 是fallback的一个升级版</p> 
<h4 id="h3_16">3、fallbackFactory 的类设置HystrixClientFallbackFactory</h4> 
<p> </p> 
<pre><code class="language-java">@Component
public class HystrixClientFallbackFactory implements FallbackFactory&lt;UserFeignClient&gt; {
    private static final Logger logger = LoggerFactory.getLogger(HystrixClientFallbackFactory.class);

    @Override
    public UserFeignClient create(Throwable arg0) {
        HystrixClientFallbackFactory.logger.info("fallback reason was:{}", arg0.getMessage());
        return new UserFeignClientWithFactory() {
            @Override
            public User findById(Long id) {
                User user = new User();
                user.setId(-1L);
                return user;
            }
        };
    }
}</code></pre> 
<p> </p> 
<h4 id="h3_17">4、UserFeignClientWithFactory设置</h4> 
<pre><code class="language-java">public interface UserFeignClientWithFactory extends UserFeignClient {

}</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/652d463271eb73e8ddd2ffe3c8eff27c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">深入分析Druid存储结构</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9698ef2a4029e6a3ce090fcec7217c7e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">OrbitControls.js:16 Uncaught ReferenceError: THREE is not defined     at OrbitControls.js:</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>