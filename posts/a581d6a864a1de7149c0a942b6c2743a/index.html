<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux AP3216C驱动 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Linux AP3216C驱动" />
<meta property="og:description" content="Linux AP3216C驱动 1. 介绍2. 代码3. 设备树4. 运行 AP3216C是一个近距离环境光传感器，包含了光强传感器（ALS:AmbientLight Sensor），接近传感器（PS: Proximity Sensor），还有一个红外LED（IR LED）。
1. 介绍 AP3216C是通过IIC进行操作的，操作地址为0x1E，芯片有多种工作模式使用，详细的寄存器操作可以阅读芯片手册。我这里利用IIC子系统和IIO子系统进行开发，向应用层提供的sysfs接口。
2. 代码 // SPDX-License-Identifier: GPL-2.0-only #include &lt;linux/kernel.h&gt; #include &lt;linux/module.h&gt; #include &lt;linux/device.h&gt; #include &lt;linux/i2c.h&gt; #include &lt;linux/regmap.h&gt; #include &lt;linux/iio/iio.h&gt; #include &lt;linux/iio/sysfs.h&gt; #include &lt;linux/iio/buffer.h&gt; #include &lt;linux/iio/trigger.h&gt; #include &lt;linux/iio/triggered_buffer.h&gt; #include &lt;linux/iio/trigger_consumer.h&gt; #define AP3216C_REGMAP_NAME	&#34;ap3216c_regmap&#34; #define AP3216C_DRV_NAME	&#34;ap3216c&#34; #define AP3216C_SYSTEMCONG	0x00	/* System Configuration */ #define AP3216C_INTSTATUS	0X01	/* Interrupt Status */ #define AP3216C_INTCLEAR	0X02	/* INT Clear Manner */ #define AP3216C_IRDATALOW	0x0A	/* IR Data Low */ #define AP3216C_IRDATAHIGH	0x0B	/* IR Data High */ #define AP3216C_ALSDATALOW	0x0C	/* ALS Data Low */ #define AP3216C_ALSDATAHIGH	0X0D	/* ALS Data High */ #define AP3216C_PSDATALOW	0X0E	/* PS Data Low */ #define AP3216C_PSDATAHIGH	0X0F	/* PS Data High */ #define AP3216C_ALSCONFIG	0X10	/* ALS Configuration */ #define AP3216C_PSCONFIG	0X20	/* PS Configuration */ #define AP3216C_PSLEDCONFIG 0X21	/* PS LED Driver */ enum ap3216c_idx { AP3216C_ALS, AP3216C_PS, AP3216C_IR, }; struct ap3216c_data { struct i2c_client *client; struct iio_dev *indio_dev; struct mutex lock; struct regmap *regmap; }; static const struct regmap_config ap3216c_regmap_config = { ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/a581d6a864a1de7149c0a942b6c2743a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-26T23:41:22+08:00" />
<meta property="article:modified_time" content="2022-11-26T23:41:22+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux AP3216C驱动</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>Linux AP3216C驱动</h4> 
 <ul><li><a href="#1__4" rel="nofollow">1. 介绍</a></li><li><a href="#2__6" rel="nofollow">2. 代码</a></li><li><a href="#3__370" rel="nofollow">3. 设备树</a></li><li><a href="#4__380" rel="nofollow">4. 运行</a></li></ul> 
</div> 
<p></p> 
<p>AP3216C是一个近距离环境光传感器，包含了光强传感器（ALS:AmbientLight Sensor），接近传感器（PS: Proximity Sensor），还有一个红外LED（IR LED）。</p> 
<h2><a id="1__4"></a>1. 介绍</h2> 
<p>AP3216C是通过IIC进行操作的，操作地址为0x1E，芯片有多种工作模式使用，详细的寄存器操作可以阅读芯片手册。我这里利用IIC子系统和IIO子系统进行开发，向应用层提供的sysfs接口。</p> 
<h2><a id="2__6"></a>2. 代码</h2> 
<pre><code class="prism language-c"><span class="token comment">// SPDX-License-Identifier: GPL-2.0-only</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/device.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/i2c.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/regmap.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/iio/iio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/iio/sysfs.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/iio/buffer.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/iio/trigger.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/iio/triggered_buffer.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/iio/trigger_consumer.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AP3216C_REGMAP_NAME</span>	<span class="token string">"ap3216c_regmap"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AP3216C_DRV_NAME</span>	<span class="token string">"ap3216c"</span></span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AP3216C_SYSTEMCONG</span>	<span class="token expression"><span class="token number">0x00</span>	</span><span class="token comment">/* System Configuration */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AP3216C_INTSTATUS</span>	<span class="token expression"><span class="token number">0X01</span>	</span><span class="token comment">/* Interrupt Status */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AP3216C_INTCLEAR</span>	<span class="token expression"><span class="token number">0X02</span>	</span><span class="token comment">/* INT Clear Manner */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AP3216C_IRDATALOW</span>	<span class="token expression"><span class="token number">0x0A</span>	</span><span class="token comment">/* IR Data Low */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AP3216C_IRDATAHIGH</span>	<span class="token expression"><span class="token number">0x0B</span>	</span><span class="token comment">/* IR Data High */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AP3216C_ALSDATALOW</span>	<span class="token expression"><span class="token number">0x0C</span>	</span><span class="token comment">/* ALS Data Low */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AP3216C_ALSDATAHIGH</span>	<span class="token expression"><span class="token number">0X0D</span>	</span><span class="token comment">/* ALS Data High */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AP3216C_PSDATALOW</span>	<span class="token expression"><span class="token number">0X0E</span>	</span><span class="token comment">/* PS Data Low */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AP3216C_PSDATAHIGH</span>	<span class="token expression"><span class="token number">0X0F</span>	</span><span class="token comment">/* PS Data High */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AP3216C_ALSCONFIG</span>	<span class="token expression"><span class="token number">0X10</span>	</span><span class="token comment">/* ALS Configuration */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AP3216C_PSCONFIG</span>	<span class="token expression"><span class="token number">0X20</span>	</span><span class="token comment">/* PS Configuration */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AP3216C_PSLEDCONFIG</span> <span class="token expression"><span class="token number">0X21</span>	</span><span class="token comment">/* PS LED Driver */</span></span>

<span class="token keyword">enum</span> <span class="token class-name">ap3216c_idx</span> <span class="token punctuation">{<!-- --></span>
	AP3216C_ALS<span class="token punctuation">,</span>
	AP3216C_PS<span class="token punctuation">,</span>
	AP3216C_IR<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">ap3216c_data</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">i2c_client</span> <span class="token operator">*</span>client<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">iio_dev</span> <span class="token operator">*</span>indio_dev<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">mutex</span> lock<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">regmap</span> <span class="token operator">*</span>regmap<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">regmap_config</span> ap3216c_regmap_config <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span>name <span class="token operator">=</span> AP3216C_REGMAP_NAME<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>reg_bits <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>val_bits <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> ap3216c_scan_masks<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token function">BIT</span><span class="token punctuation">(</span>AP3216C_ALS<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token function">BIT</span><span class="token punctuation">(</span>AP3216C_PS<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token function">BIT</span><span class="token punctuation">(</span>AP3216C_IR<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token number">0</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">iio_chan_spec</span> ap3216c_channels<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">/* ALS */</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">.</span>type <span class="token operator">=</span> IIO_INTENSITY<span class="token punctuation">,</span>
		<span class="token punctuation">.</span>modified <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
		<span class="token punctuation">.</span>channel2 <span class="token operator">=</span> IIO_MOD_LIGHT_BOTH<span class="token punctuation">,</span>
		<span class="token punctuation">.</span>info_mask_separate <span class="token operator">=</span> <span class="token function">BIT</span><span class="token punctuation">(</span>IIO_CHAN_INFO_RAW<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token function">BIT</span><span class="token punctuation">(</span>IIO_CHAN_INFO_SCALE<span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">.</span>scan_index <span class="token operator">=</span> AP3216C_ALS<span class="token punctuation">,</span>
		<span class="token punctuation">.</span>scan_type <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
			<span class="token punctuation">.</span>sign <span class="token operator">=</span> <span class="token char">'u'</span><span class="token punctuation">,</span>
			<span class="token punctuation">.</span>realbits <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">,</span>
			<span class="token punctuation">.</span>storagebits <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">,</span>
			<span class="token punctuation">.</span>endianness <span class="token operator">=</span> IIO_LE<span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>

	<span class="token comment">/* PS */</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">.</span>type <span class="token operator">=</span> IIO_PROXIMITY<span class="token punctuation">,</span>
		<span class="token punctuation">.</span>info_mask_separate <span class="token operator">=</span> <span class="token function">BIT</span><span class="token punctuation">(</span>IIO_CHAN_INFO_RAW<span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">.</span>scan_index <span class="token operator">=</span> AP3216C_PS<span class="token punctuation">,</span>
		<span class="token punctuation">.</span>scan_type <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
			<span class="token punctuation">.</span>sign <span class="token operator">=</span> <span class="token char">'u'</span><span class="token punctuation">,</span>
			<span class="token punctuation">.</span>realbits <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span>
			<span class="token punctuation">.</span>storagebits <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">,</span>
			<span class="token punctuation">.</span>endianness <span class="token operator">=</span> IIO_LE<span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>

	<span class="token comment">/* IR */</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">.</span>type <span class="token operator">=</span> IIO_INTENSITY<span class="token punctuation">,</span>
		<span class="token punctuation">.</span>modified <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
		<span class="token punctuation">.</span>channel2 <span class="token operator">=</span> IIO_MOD_LIGHT_IR<span class="token punctuation">,</span>
		<span class="token punctuation">.</span>info_mask_separate <span class="token operator">=</span> <span class="token function">BIT</span><span class="token punctuation">(</span>IIO_CHAN_INFO_RAW<span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">.</span>scan_index <span class="token operator">=</span> AP3216C_IR<span class="token punctuation">,</span>
		<span class="token punctuation">.</span>scan_type <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
			<span class="token punctuation">.</span>sign <span class="token operator">=</span> <span class="token char">'u'</span><span class="token punctuation">,</span>
			<span class="token punctuation">.</span>realbits <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span>
			<span class="token punctuation">.</span>storagebits <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">,</span>
			<span class="token punctuation">.</span>endianness <span class="token operator">=</span> IIO_LE<span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ap3216c_read_als</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ap3216c_data</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>val<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> reg<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>

	ret <span class="token operator">=</span> <span class="token function">regmap_bulk_read</span><span class="token punctuation">(</span>data<span class="token operator">-&gt;</span>regmap<span class="token punctuation">,</span> AP3216C_ALSDATALOW<span class="token punctuation">,</span> reg<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>

	<span class="token operator">*</span>val <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>reg<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> reg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ap3216c_read_ps</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ap3216c_data</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>val<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> reg<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>

	ret <span class="token operator">=</span> <span class="token function">regmap_bulk_read</span><span class="token punctuation">(</span>data<span class="token operator">-&gt;</span>regmap<span class="token punctuation">,</span> AP3216C_PSDATALOW<span class="token punctuation">,</span> reg<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>

	<span class="token operator">*</span>val <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>reg<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0X3F</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>reg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0X0F</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ap3216c_read_ir</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ap3216c_data</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>val<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> reg<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>

	ret <span class="token operator">=</span> <span class="token function">regmap_bulk_read</span><span class="token punctuation">(</span>data<span class="token operator">-&gt;</span>regmap<span class="token punctuation">,</span> AP3216C_IRDATALOW<span class="token punctuation">,</span> reg<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>

	<span class="token operator">*</span>val <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>reg<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>reg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0X03</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">AP3216C_SCALE</span><span class="token expression"><span class="token punctuation">(</span>range<span class="token punctuation">)</span>  <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span>range <span class="token operator">*</span> <span class="token number">1000000</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">65535</span><span class="token punctuation">)</span></span></span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> ap3216c_als_scale<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token function">AP3216C_SCALE</span><span class="token punctuation">(</span><span class="token number">23360</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">AP3216C_SCALE</span><span class="token punctuation">(</span><span class="token number">5840</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
										<span class="token function">AP3216C_SCALE</span><span class="token punctuation">(</span><span class="token number">1460</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">AP3216C_SCALE</span><span class="token punctuation">(</span><span class="token number">365</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ap3216c_read_als_scale</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ap3216c_data</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>val<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> reg<span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>	

	ret <span class="token operator">=</span> <span class="token function">regmap_read</span><span class="token punctuation">(</span>data<span class="token operator">-&gt;</span>regmap<span class="token punctuation">,</span> AP3216C_ALSCONFIG<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reg<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>

	<span class="token operator">*</span>val <span class="token operator">=</span> ap3216c_als_scale<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>reg <span class="token operator">&amp;</span> <span class="token number">0X30</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ap3216c_write_als_scale</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ap3216c_data</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token keyword">int</span> val<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> i<span class="token punctuation">,</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	

	<span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token function">ARRAY_SIZE</span><span class="token punctuation">(</span>ap3216c_als_scale<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ap3216c_als_scale<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> val<span class="token punctuation">)</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token function">ARRAY_SIZE</span><span class="token punctuation">(</span>ap3216c_als_scale<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{<!-- --></span>
		ret <span class="token operator">=</span> <span class="token function">regmap_write</span><span class="token punctuation">(</span>data<span class="token operator">-&gt;</span>regmap<span class="token punctuation">,</span> AP3216C_ALSCONFIG<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
		
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ap3216c_read_raw</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">iio_dev</span> <span class="token operator">*</span>indio_dev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">iio_chan_spec</span> <span class="token keyword">const</span> <span class="token operator">*</span>chan<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>val<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>val2<span class="token punctuation">,</span> <span class="token keyword">long</span> mask<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">ap3216c_data</span> <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token function">iio_priv</span><span class="token punctuation">(</span>indio_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>

	<span class="token keyword">switch</span> <span class="token punctuation">(</span>mask<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">case</span> IIO_CHAN_INFO_RAW<span class="token operator">:</span>
		<span class="token keyword">switch</span> <span class="token punctuation">(</span>chan<span class="token operator">-&gt;</span>type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">case</span> IIO_INTENSITY<span class="token operator">:</span>
			<span class="token keyword">switch</span> <span class="token punctuation">(</span>chan<span class="token operator">-&gt;</span>channel2<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">case</span> IIO_MOD_LIGHT_BOTH<span class="token operator">:</span>
				<span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>data<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
				ret <span class="token operator">=</span> <span class="token function">ap3216c_read_als</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>data<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
					<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
				ret <span class="token operator">=</span> IIO_VAL_INT<span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> IIO_MOD_LIGHT_IR<span class="token operator">:</span>
				<span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>data<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
				ret <span class="token operator">=</span> <span class="token function">ap3216c_read_ir</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>data<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
					<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
				ret <span class="token operator">=</span> IIO_VAL_INT<span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">default</span><span class="token operator">:</span>
				ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> IIO_PROXIMITY<span class="token operator">:</span>
			<span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>data<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
			ret <span class="token operator">=</span> <span class="token function">ap3216c_read_ps</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>data<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
				<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
			ret <span class="token operator">=</span> IIO_VAL_INT<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">default</span><span class="token operator">:</span>
			ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token keyword">case</span> IIO_CHAN_INFO_SCALE<span class="token operator">:</span>
		<span class="token keyword">switch</span> <span class="token punctuation">(</span>chan<span class="token operator">-&gt;</span>type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">case</span> IIO_INTENSITY<span class="token operator">:</span>
			<span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>data<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
			ret <span class="token operator">=</span> <span class="token function">ap3216c_read_als_scale</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> val2<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>data<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
				<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
			<span class="token operator">*</span>val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			ret <span class="token operator">=</span> IIO_VAL_INT_PLUS_MICRO<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">default</span><span class="token operator">:</span>
			ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token keyword">default</span><span class="token operator">:</span>
		ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">iio_info</span> ap3216c_info <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span>read_raw <span class="token operator">=</span> ap3216c_read_raw<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ap3216c_init</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ap3216c_data</span> <span class="token operator">*</span>data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev <span class="token operator">=</span> <span class="token operator">&amp;</span>data<span class="token operator">-&gt;</span>client<span class="token operator">-&gt;</span>dev<span class="token punctuation">;</span>
	<span class="token keyword">int</span> als<span class="token punctuation">,</span> ps<span class="token punctuation">,</span> ir<span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>

	ret <span class="token operator">=</span> <span class="token function">regmap_write</span><span class="token punctuation">(</span>data<span class="token operator">-&gt;</span>regmap<span class="token punctuation">,</span> AP3216C_SYSTEMCONG<span class="token punctuation">,</span> <span class="token number">0x04</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// reset ap3216c</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
	
	<span class="token function">mdelay</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &gt;=10ms</span>

	ret <span class="token operator">=</span> <span class="token function">regmap_write</span><span class="token punctuation">(</span>data<span class="token operator">-&gt;</span>regmap<span class="token punctuation">,</span> AP3216C_SYSTEMCONG<span class="token punctuation">,</span> <span class="token number">0x03</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ALS and PS+IR functions once</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>

	ret <span class="token operator">=</span> <span class="token function">ap3216c_write_als_scale</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> ap3216c_als_scale<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 23360 lux / Resolution bit</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>

	ret <span class="token operator">=</span> <span class="token function">regmap_write</span><span class="token punctuation">(</span>data<span class="token operator">-&gt;</span>regmap<span class="token punctuation">,</span> AP3216C_PSLEDCONFIG<span class="token punctuation">,</span> <span class="token number">0x13</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// LED 1 pulse, LED driver ratio 100%</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>

	<span class="token function">ap3216c_read_als</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>als<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ap3216c_read_ps</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ap3216c_read_ir</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ir<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">dev_info</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"ALS=%d, PS=%d, IR=%d\n"</span><span class="token punctuation">,</span> als<span class="token punctuation">,</span> ps<span class="token punctuation">,</span> ir<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ap3216c_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">i2c_client</span> <span class="token operator">*</span>client<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">i2c_device_id</span> <span class="token operator">*</span>id<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">iio_dev</span> <span class="token operator">*</span>indio_dev<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">ap3216c_data</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>

	indio_dev <span class="token operator">=</span> <span class="token function">devm_iio_device_alloc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>client<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>indio_dev<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>

	indio_dev<span class="token operator">-&gt;</span>name <span class="token operator">=</span> AP3216C_DRV_NAME<span class="token punctuation">;</span>
	indio_dev<span class="token operator">-&gt;</span>info <span class="token operator">=</span> <span class="token operator">&amp;</span>ap3216c_info<span class="token punctuation">;</span>
	indio_dev<span class="token operator">-&gt;</span>modes <span class="token operator">=</span> INDIO_DIRECT_MODE<span class="token punctuation">;</span>
	indio_dev<span class="token operator">-&gt;</span>channels <span class="token operator">=</span> ap3216c_channels<span class="token punctuation">;</span>
	indio_dev<span class="token operator">-&gt;</span>num_channels <span class="token operator">=</span> <span class="token function">ARRAY_SIZE</span><span class="token punctuation">(</span>ap3216c_channels<span class="token punctuation">)</span><span class="token punctuation">;</span>
	indio_dev<span class="token operator">-&gt;</span>available_scan_masks <span class="token operator">=</span> ap3216c_scan_masks<span class="token punctuation">;</span>

	data <span class="token operator">=</span> <span class="token function">iio_priv</span><span class="token punctuation">(</span>indio_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
	data<span class="token operator">-&gt;</span>indio_dev <span class="token operator">=</span> indio_dev<span class="token punctuation">;</span>
	data<span class="token operator">-&gt;</span>client <span class="token operator">=</span> client<span class="token punctuation">;</span>
	<span class="token function">mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>data<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">i2c_set_clientdata</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> indio_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>

	data<span class="token operator">-&gt;</span>regmap <span class="token operator">=</span> <span class="token function">devm_regmap_init_i2c</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ap3216c_regmap_config<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>data<span class="token operator">-&gt;</span>regmap<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">dev_err</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>client<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"regmap initialization failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>data<span class="token operator">-&gt;</span>regmap<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	ret <span class="token operator">=</span> <span class="token function">ap3216c_init</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token function">iio_device_register</span><span class="token punctuation">(</span>indio_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ap3216c_remove</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">i2c_client</span> <span class="token operator">*</span>client<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">iio_dev</span> <span class="token operator">*</span>indio_dev <span class="token operator">=</span> <span class="token function">i2c_get_clientdata</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">iio_device_unregister</span><span class="token punctuation">(</span>indio_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> ap3216c_of_match<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>compatible <span class="token operator">=</span> <span class="token string">"lsc,ap3216c"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">MODULE_DEVICE_TABLE</span><span class="token punctuation">(</span>of<span class="token punctuation">,</span> ap3216c_of_match<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">i2c_device_id</span> ap3216c_id<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">{<!-- --></span> <span class="token string">"ap3216c"</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">MODULE_DEVICE_TABLE</span><span class="token punctuation">(</span>i2c<span class="token punctuation">,</span> ap3216c_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">i2c_driver</span> ap3216c_driver <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span>driver <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
		<span class="token punctuation">.</span>name	<span class="token operator">=</span> <span class="token string">"ap3216c"</span><span class="token punctuation">,</span>
		<span class="token punctuation">.</span>of_match_table <span class="token operator">=</span> <span class="token function">of_match_ptr</span><span class="token punctuation">(</span>ap3216c_of_match<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>probe	    <span class="token operator">=</span> ap3216c_probe<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>remove		<span class="token operator">=</span> ap3216c_remove<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>id_table	<span class="token operator">=</span> ap3216c_id<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">module_i2c_driver</span><span class="token punctuation">(</span>ap3216c_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"Sonboy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_DESCRIPTION</span><span class="token punctuation">(</span><span class="token string">"Driver for AP3216C"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<h2><a id="3__370"></a>3. 设备树</h2> 
<p>这里示例，只需要i2c设备下添加我们的子设备。</p> 
<pre><code class="prism language-bash"><span class="token operator">&amp;</span>i2c <span class="token punctuation">{<!-- --></span>
	ap3216c@1e <span class="token punctuation">{<!-- --></span>
		compatible <span class="token operator">=</span> <span class="token string">"lsc,ap3216c"</span><span class="token punctuation">;</span>
		reg <span class="token operator">=</span> <span class="token operator">&lt;</span>0x1e<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h2><a id="4__380"></a>4. 运行</h2> 
<p>加载驱动打印如下信息，驱动加载成功。<br> <img src="https://images2.imgbox.com/f0/fa/K8l7QxoY_o.png" alt="在这里插入图片描述"><br> 进入<code>/sys/bus/iio/devices/iio:device0</code>目录，你的不一定是iio:device0。有如下文件，操作这些文件即可操作设备。<br> <img src="https://images2.imgbox.com/e4/9c/T0PWzE1s_o.png" alt="在这里插入图片描述"></p> 
<p>源码获取：</p> 
<pre><code class="prism language-bash"><span class="token function">git</span> clone https://github.com/Sonboy97/linux-drivers.git
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/aa9499240d51ffec9ed69502b6d94365/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【一包通刷】晶晨S905L3A/B_完美AI语音线刷包_打开ADB_ROOT权限</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/dcefb65122b6e1c814a96315fab2b129/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Android中SQLite数据库查询详解</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>