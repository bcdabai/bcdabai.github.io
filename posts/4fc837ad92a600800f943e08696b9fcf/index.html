<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>达梦数据库JDBC连接池断开自动重连设置 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="达梦数据库JDBC连接池断开自动重连设置" />
<meta property="og:description" content="一、场景 在网络状况不是非常良好，经常会出现暂时性的拥塞或者断开的情况，而且当我们重启数据库时也会发生类似的情况。所以需要配置中间件的连接池来实现连接测试以及自动重连，通过重新配置连接池，成功解决了这个问题。下面会给出一份数据源配置参数详单和一份推荐的数据源配置项。
二、连接池配置参数 1. initialSize：连接池启动时创建的初始化连接数量 2. maxActive：连接池中可同时连接的最大的连接数 3. maxIdle：连接池中最大的空闲的连接数，超过的空闲连接将被释放，如果设置为负数表示不限（maxIdle不能设置太小，因为假如在高负载的情况下，连接的打开时间比关闭的时间快，会引起连接池中idle的个数上升超过maxIdle，而造成频繁的连接销毁和创建) 4. minIdle：连接池中最小的空闲的连接数，低于这个数量会被创建新的连接（该参数越接近maxIdle，性能越好，因为连接的创建和销毁，都是需要消耗资源的；但是不能太大，因为在机器很空闲的时候，也会创建低于minidle个数的连接） 5. maxWait：最大等待时间，当没有可用连接时，连接池等待连接释放的最大时间，超过该时间限制会抛出异常，如果设置-1表示无限等待（默认为无限，调整为60000ms，避免因线程池不够用，而导致请求被无限制挂起） 6. poolPreparedStatements：开启池的prepared（默认是false） 7. maxOpenPreparedStatements：开启池的prepared 后的同时最大连接数（默认无限制） 8. minEvictableIdleTimeMillis：连接池中连接，在时间段内一直空闲， 被逐出连接池的时间（默认为30分钟，可以适当做调整，需要和后端服务端的策略配置相关） 9. removeAbandonedTimeout：超过时间限制，回收没有用(废弃)的连接（默认为 300秒，调整为180） 10. removeAbandoned：超过removeAbandonedTimeout时间后，是否进 行没用连接（废弃）的回收（默认为false，调整为true) 11. testOnBorrow：在进行borrowObject进行处理时，对拿到的connection进行validateObject校验 12. testOnReturn：在进行returnObject对返回的connection进行validateObject校验 13. testWhileIdle：重点，GenericObjectPool中针对pool管理，起了一个Evict的TimerTask定时线程进行控制(可通过设置参数timeBetweenEvictionRunsMillis&gt;0),定时对线程池中的链接进行validateObject校验，对无效的链接进行关闭后，会调用ensureMinIdle，适当建立链接保证最小的minIdle连接数。 14. timeBetweenEvictionRunsMillis：设置的Evict线程的时间，单位ms，大于0才会开启evict检查线程 15. validateQuery：用来做连接检查的sql 16. validateQueryTimeout：检查查询超时时间 17. numTestsPerEvictionRun：代表每次检查链接的数量，建议设置和maxActive一样大，这样每次可以有效检查所有的链接. 三、断开自动重连机制 在出现网络中断和重启数据库时，连接池中的现有连接会失效，而如果不把这些连接进行回收（销毁），当应用取到这些链接时，就会报错。那么解决办法就来了，可以得空的时候，对连接池进行检查，看他们是不是失效了。
1、主动式 设置sql validate相关参数
testWhileIdle=true //闲时检查（空闲连接） validationQuery=select 1 //检查手段（查询） timeBetweenEvictionRunsMillis= 30000 //多长时间检查一次 这里之所以不选择设置testOnBorrow和testOnReturn是因为这两个对性能的影响比较大，每次取链接时或者放回连接时先对连接进行验证会消耗很多资源。
当设置了testWhileIdle或者testOnBorrow/testOnReturn时必须设置validationQuery才会生效。
2、设置合理的超时时间 minEvictableIdleTimeMillis=600000(空闲链接不被回收的最长时间) //有效期 有部分资料说removeAbandoned、removeAbandonedTimeout、logAbandoned这三个参数是用来断开自动重连的。从实际测试来看removeAbandoned是用来避免某些查询长时间不能返回或者某些情况下卡会话了，由于达梦数据库是默认不设置超时自动断开的，所以根据实际情况可以在连接池设置超时自动断开。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/4fc837ad92a600800f943e08696b9fcf/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-04-06T17:35:34+08:00" />
<meta property="article:modified_time" content="2021-04-06T17:35:34+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">达梦数据库JDBC连接池断开自动重连设置</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>一、场景</h2> 
<p style="text-indent:33px;">在网络状况不是非常良好，经常会出现暂时性的拥塞或者断开的情况，而且当我们重启数据库时也会发生类似的情况。所以需要配置中间件的连接池来实现连接测试以及自动重连，通过重新配置连接池，成功解决了这个问题。下面会给出一份数据源配置参数详单和一份推荐的数据源配置项。</p> 
<h2>二、连接池配置参数</h2> 
<pre><code class="language-TypeScript">1.  initialSize：连接池启动时创建的初始化连接数量
2.  maxActive：连接池中可同时连接的最大的连接数
3.  maxIdle：连接池中最大的空闲的连接数，超过的空闲连接将被释放，如果设置为负数表示不限（maxIdle不能设置太小，因为假如在高负载的情况下，连接的打开时间比关闭的时间快，会引起连接池中idle的个数上升超过maxIdle，而造成频繁的连接销毁和创建)
4.  minIdle：连接池中最小的空闲的连接数，低于这个数量会被创建新的连接（该参数越接近maxIdle，性能越好，因为连接的创建和销毁，都是需要消耗资源的；但是不能太大，因为在机器很空闲的时候，也会创建低于minidle个数的连接）
5.  maxWait：最大等待时间，当没有可用连接时，连接池等待连接释放的最大时间，超过该时间限制会抛出异常，如果设置-1表示无限等待（默认为无限，调整为60000ms，避免因线程池不够用，而导致请求被无限制挂起）
6.  poolPreparedStatements：开启池的prepared（默认是false）
7.  maxOpenPreparedStatements：开启池的prepared 后的同时最大连接数（默认无限制）
8.  minEvictableIdleTimeMillis：连接池中连接，在时间段内一直空闲， 被逐出连接池的时间（默认为30分钟，可以适当做调整，需要和后端服务端的策略配置相关）
9.  removeAbandonedTimeout：超过时间限制，回收没有用(废弃)的连接（默认为 300秒，调整为180）
10. removeAbandoned：超过removeAbandonedTimeout时间后，是否进 行没用连接（废弃）的回收（默认为false，调整为true)
11. testOnBorrow：在进行borrowObject进行处理时，对拿到的connection进行validateObject校验
12. testOnReturn：在进行returnObject对返回的connection进行validateObject校验
13. testWhileIdle：重点，GenericObjectPool中针对pool管理，起了一个Evict的TimerTask定时线程进行控制(可通过设置参数timeBetweenEvictionRunsMillis&gt;0),定时对线程池中的链接进行validateObject校验，对无效的链接进行关闭后，会调用ensureMinIdle，适当建立链接保证最小的minIdle连接数。
14. timeBetweenEvictionRunsMillis：设置的Evict线程的时间，单位ms，大于0才会开启evict检查线程
15. validateQuery：用来做连接检查的sql
16. validateQueryTimeout：检查查询超时时间
17. numTestsPerEvictionRun：代表每次检查链接的数量，建议设置和maxActive一样大，这样每次可以有效检查所有的链接.</code></pre> 
<h3>三、断开自动重连机制</h3> 
<p style="text-indent:33px;">在出现网络中断和重启数据库时，连接池中的现有连接会失效，而如果不把这些连接进行回收（销毁），当应用取到这些链接时，就会报错。那么解决办法就来了，可以得空的时候，对连接池进行检查，看他们是不是失效了。</p> 
<h4>1、主动式</h4> 
<p style="text-indent:33px;">设置sql validate相关参数</p> 
<pre><code class="language-java">testWhileIdle=true                   //闲时检查（空闲连接）
validationQuery=select 1             //检查手段（查询）
timeBetweenEvictionRunsMillis= 30000 //多长时间检查一次</code></pre> 
<p style="text-indent:33px;">这里之所以不选择设置testOnBorrow和testOnReturn是因为这两个对性能的影响比较大，每次取链接时或者放回连接时先对连接进行验证会消耗很多资源。</p> 
<p style="text-indent:33px;">当设置了testWhileIdle或者testOnBorrow/testOnReturn时必须设置validationQuery才会生效。</p> 
<h4>2、设置合理的超时时间</h4> 
<pre><code class="language-java">minEvictableIdleTimeMillis=600000(空闲链接不被回收的最长时间)        //有效期</code></pre> 
<p style="text-indent:33px;">有部分资料说removeAbandoned、removeAbandonedTimeout、logAbandoned这三个参数是用来断开自动重连的。从实际测试来看removeAbandoned是用来避免某些查询长时间不能返回或者某些情况下卡会话了，由于达梦数据库是默认不设置超时自动断开的，所以根据实际情况可以在连接池设置超时自动断开。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/bf0953c710c8dcd09f640aadfad33b9e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">PageHelper.startPage()不生效</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/de6463bf057eeaf4f706332f7bd6c83d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">aliyun-oss-spring-boot-starter导入无效</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>