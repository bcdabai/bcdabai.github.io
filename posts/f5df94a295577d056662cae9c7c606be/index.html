<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Pytorch：基于转置卷积解码的卷积自编码网络 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Pytorch：基于转置卷积解码的卷积自编码网络" />
<meta property="og:description" content="Pytorch: 图像自编码器-卷积自编码网络(转置卷积解码)和图像去噪 Copyright: Jingmin Wei, Pattern Recognition and Intelligent System, School of Artificial and Intelligence, Huazhong University of Science and Technology
Pytorch教程专栏链接
文章目录 Pytorch: 图像自编码器-卷积自编码网络(转置卷积解码)和图像去噪Reference介绍数据预处理数据集构建基于转置卷积编码的网络构建网络训练和预测评价去噪效果 本教程不商用，仅供学习和参考交流使用，如需转载，请联系本人。
Reference Sparse Auto-Encoders
Convolutional Auto-Encoders
Stacked Auto-Encoders(Denoising)
介绍 利用卷积自编码网络去噪，利用其进行图像的编码和解码，是因为卷积操作在提取图像的信息上有较好的效果，而且可以对图像中隐藏的空间信息等内容进行较好的提取。该网络可以用于去噪，分割等。
在网络的输入图像带有噪声，而输出图像则为原始的去噪图像。在编码器阶段，会经过多个卷积、池化、激活和 BN 层操作，逐渐降低每个特征映射尺寸，如此降低至 24 × 24 24\times24 24×24 ，即图像缩小为原来的 1 16 \frac{1}{16} 161​ 。而解码器阶段，则通过多个转置卷积，激活和 BN 层操作，逐渐将其解码为原始图像大小并且包含 3 3 3 通道，即 3 × 96 × 96 3\times96\times96 3×96×96 的图像。
import numpy as np import pandas as pd import matplotlib." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/f5df94a295577d056662cae9c7c606be/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-11T15:07:14+08:00" />
<meta property="article:modified_time" content="2022-03-11T15:07:14+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Pytorch：基于转置卷积解码的卷积自编码网络</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h4><a id="Pytorch__0"></a>Pytorch: 图像自编码器-卷积自编码网络(转置卷积解码)和图像去噪</h4> 
<p><strong>Copyright: Jingmin Wei, Pattern Recognition and Intelligent System, School of Artificial and Intelligence, Huazhong University of Science and Technology</strong></p> 
<p><strong><a href="https://blog.csdn.net/weixin_44979150/category_11618935.html">Pytorch教程专栏链接</a></strong></p> 
<hr> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><ul><li><a href="#Pytorch__0" rel="nofollow">Pytorch: 图像自编码器-卷积自编码网络(转置卷积解码)和图像去噪</a></li><li><ul><li><a href="#Reference_14" rel="nofollow">Reference</a></li><li><a href="#_22" rel="nofollow">介绍</a></li><li><a href="#_63" rel="nofollow">数据预处理</a></li><li><a href="#_167" rel="nofollow">数据集构建</a></li><li><a href="#_225" rel="nofollow">基于转置卷积编码的网络构建</a></li><li><a href="#_379" rel="nofollow">网络训练和预测</a></li><li><a href="#_439" rel="nofollow">评价去噪效果</a></li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<hr> 
<p><strong>本教程不商用，仅供学习和参考交流使用，如需转载，请联系本人。</strong></p> 
<h5><a id="Reference_14"></a>Reference</h5> 
<p><a href="https://proceedings.mlr.press/v15/coates11a.html" rel="nofollow">Sparse Auto-Encoders</a></p> 
<p><a href="https://link.springer.com/chapter/10.1007/978-3-642-21735-7_7" rel="nofollow">Convolutional Auto-Encoders</a></p> 
<p><a href="https://www.jmlr.org/papers/volume11/vincent10a/vincent10a.pdf?ref=https://githubhelp.com" rel="nofollow">Stacked Auto-Encoders(Denoising)</a></p> 
<h5><a id="_22"></a>介绍</h5> 
<p>利用卷积自编码网络去噪，利用其进行图像的编码和解码，是因为卷积操作在提取图像的信息上有较好的效果，而且可以对图像中隐藏的空间信息等内容进行较好的提取。该网络可以用于去噪，分割等。</p> 
<p>在网络的输入图像带有噪声，而输出图像则为原始的去噪图像。在编码器阶段，会经过多个卷积、池化、激活和 BN 层操作，逐渐降低每个特征映射尺寸，如此降低至 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         24 
        
       
         × 
        
       
         24 
        
       
      
        24\times24 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.72777em; vertical-align: -0.08333em;"></span><span class="mord">2</span><span class="mord">4</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">2</span><span class="mord">4</span></span></span></span></span> ，即图像缩小为原来的 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          1 
         
        
          16 
         
        
       
      
        \frac{1}{16} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.19011em; vertical-align: -0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.845108em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">6</span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.394em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.345em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span> 。而解码器阶段，则通过多个转置卷积，激活和 BN 层操作，逐渐将其解码为原始图像大小并且包含 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         3 
        
       
      
        3 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">3</span></span></span></span></span> 通道，即 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         3 
        
       
         × 
        
       
         96 
        
       
         × 
        
       
         96 
        
       
      
        3\times96\times96 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.72777em; vertical-align: -0.08333em;"></span><span class="mord">3</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.72777em; vertical-align: -0.08333em;"></span><span class="mord">9</span><span class="mord">6</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">9</span><span class="mord">6</span></span></span></span></span> 的图像。</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> train_test_split
<span class="token keyword">from</span> skimage<span class="token punctuation">.</span>util <span class="token keyword">import</span> random_noise
<span class="token keyword">from</span> skimage<span class="token punctuation">.</span>measure <span class="token keyword">import</span> compare_psnr
<span class="token keyword">from</span> skimage<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> peak_signal_noise_ratio
<span class="token keyword">import</span> hiddenlayer <span class="token keyword">as</span> hl

<span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">as</span> Data
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>optim <span class="token keyword">as</span> optim
<span class="token keyword">from</span> torchvision <span class="token keyword">import</span> transforms
<span class="token keyword">from</span> torchvision<span class="token punctuation">.</span>datasets <span class="token keyword">import</span> STL10
</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># 模型加载选择GPU</span>
device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">"cuda"</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">"cpu"</span><span class="token punctuation">)</span>
<span class="token comment"># device = torch.device('cpu')</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>device<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>device_count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>get_device_name<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>cuda
1
NVIDIA GeForce RTX 3070
</code></pre> 
<h5><a id="_63"></a>数据预处理</h5> 
<p>使用到的图像数据集为 - STL10 ，包含三种类型的数据，分别是带有标签的训练集和验证集，分别包含 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         5000 
        
       
      
        5000 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">5</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span></span></span></span></span> 和 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         8000 
        
       
      
        8000 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">8</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span></span></span></span></span> 张图像，共 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         10 
        
       
      
        10 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">1</span><span class="mord">0</span></span></span></span></span> 类数据。还有一个类型包含 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         10 
        
       
      
        10 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">1</span><span class="mord">0</span></span></span></span></span> 万张无标签图像，均为 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         96 
        
       
         × 
        
       
         96 
        
       
      
        96\times96 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.72777em; vertical-align: -0.08333em;"></span><span class="mord">9</span><span class="mord">6</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">9</span><span class="mord">6</span></span></span></span></span> 的 RGB 图像，可以用于无监督学习。</p> 
<p>虽然可以直接用 torchvision.datasets.STL10() 下载，但是数据大小仅 2.5GB ，且为二进制。所以最好直接到本身网址：https://cs.stanford.edu/~acoates/stl10/ 下载，并保存到指定文件夹后解压。</p> 
<p>为了节省时间并提高训练速度，在搭建 的网络中只使用 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         5000 
        
       
      
        5000 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">5</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span></span></span></span></span> 张图片，其中 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         4000 
        
       
      
        4000 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">4</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span></span></span></span></span> 张作为训练集，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         1000 
        
       
      
        1000 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span></span></span></span></span> 张作为验证集。</p> 
<p>首先对数据预处理，定义一个从 .bin 文件中读取数据的函数，并对数据进行增强。</p> 
<p>我们首先把文件和数据上传至服务器(我用的是 MistGPU，有关使用方式请自行在官网查询)。注意，带空格的文件夹如果无法识别，可以加上双引号。</p> 
<pre><code class="prism language-shell"><span class="token comment"># 传输代码文件到服务器端</span>
<span class="token function">scp</span> <span class="token string">"E:\\Jupyter WorkSpace\\PytorchLearn\\torch_autoencoder_conv(transpose).ipynb"</span> mist@gpu193.mistgpu.xyz:/home/mist/
<span class="token comment"># 传输数据到服务器端</span>
<span class="token function">scp</span> <span class="token string">"E:\\Jupyter WorkSpace\\PytorchLearn\\data\\stl10_binary.tar.gz"</span> mist@gpu193.mistgpu.xyz:/home/mist/data/
<span class="token comment">#  z解压文件</span>
<span class="token function">cd</span> ~/data
<span class="token function">tar</span> xf stl10_binary.tar.gz <span class="token comment"># 解压到当前目录下</span>
</code></pre> 
<p>然后打开 MistGPU ，继续运行代码。</p> 
<pre><code class="prism language-python"><span class="token comment"># 定义一个将bin文件处理为图像数据的函数</span>
<span class="token keyword">def</span> <span class="token function">read_image</span><span class="token punctuation">(</span>data_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>data_path<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        datal <span class="token operator">=</span> np<span class="token punctuation">.</span>fromfile<span class="token punctuation">(</span>f<span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
        <span class="token comment"># 图像[num, channels, width, height]</span>
        images <span class="token operator">=</span> np<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>datal<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">96</span><span class="token punctuation">,</span> <span class="token number">96</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># 转为RGB</span>
        images <span class="token operator">=</span> np<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>images<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 图像标准化到0-1</span>
    <span class="token keyword">return</span> images <span class="token operator">/</span> <span class="token number">255.0</span>
</code></pre> 
<p>上述函数处理后，第一位表示图像的数量，后面表示图像的 RGB 像素值(方便 matplotlib 可视化)。</p> 
<p>用该函数读取 STL10 数据的训练数据集 train_X.bin 程序如下：</p> 
<pre><code class="prism language-python"><span class="token comment"># 读取训练集，5000张96*96*3的图像</span>
data_path <span class="token operator">=</span> <span class="token string">'./data/stl10_binary/train_X.bin'</span>
images <span class="token operator">=</span> read_image<span class="token punctuation">(</span>data_path<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'images.shape:'</span><span class="token punctuation">,</span> images<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
</code></pre> 
<pre><code>images.shape: (5000, 96, 96, 3)
</code></pre> 
<p>接下来定义一张为图像数据添加高斯噪声的函数，为每一张图像都添加随机噪声。</p> 
<pre><code class="prism language-python"><span class="token comment"># 为数据添加高斯噪声</span>
<span class="token keyword">def</span> <span class="token function">gaussian_noise</span><span class="token punctuation">(</span>images<span class="token punctuation">,</span> sigma<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># sigma: 噪声标准差</span>
    sigma2 <span class="token operator">=</span> sigma<span class="token operator">**</span><span class="token number">2</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment"># 噪声方差</span>
    images_noisy <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>images<span class="token punctuation">)</span> <span class="token comment"># 0矩阵初始化</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>images<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        image <span class="token operator">=</span> images<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token comment"># 添加噪声</span>
        image_noise <span class="token operator">=</span> random_noise<span class="token punctuation">(</span>image<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'gaussian'</span><span class="token punctuation">,</span> var<span class="token operator">=</span>sigma2<span class="token punctuation">,</span> clip<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        images_noisy<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> image_noise
    <span class="token keyword">return</span> images_noisy
</code></pre> 
<pre><code class="prism language-python">images_noise <span class="token operator">=</span> gaussian_noise<span class="token punctuation">(</span>images<span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'images_noise:'</span><span class="token punctuation">,</span> images_noise<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'~'</span><span class="token punctuation">,</span> images_noise<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>images_noise: 0.0 ~ 1.0
</code></pre> 
<p>以上代码通过 random_noise 为每张图像添加指定方差为 sigma2 的图像噪声，并且将像素值范围处理到 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         0 
        
       
         − 
        
       
         1 
        
       
      
        0-1 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.72777em; vertical-align: -0.08333em;"></span><span class="mord">0</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">1</span></span></span></span></span> 之间。从输出可知，所有像素值最大为 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         1 
        
       
      
        1 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">1</span></span></span></span></span> ，最小为 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         0 
        
       
      
        0 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">0</span></span></span></span></span> 。</p> 
<p>下面可视化其中部分图像，对比添加噪声前后的内容</p> 
<pre><code class="prism language-python"><span class="token comment"># 可视化其中部分原图像和高斯噪声图</span>
plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>images<span class="token punctuation">[</span>i<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> i<span class="token operator">+</span><span class="token number">37</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>images_noise<span class="token punctuation">[</span>i<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>​<br> <img src="https://images2.imgbox.com/3d/dc/RgcO3Rr6_o.png" alt="在这里插入图片描述"></p> 
<p>​</p> 
<h5><a id="_167"></a>数据集构建</h5> 
<p>接下来对图像切分为训练集和验证集，并进行图像增强和数据类型标准化，处理为张量格式：</p> 
<pre><code class="prism language-python"><span class="token comment"># 转为[num, channels, height, width]</span>
data_Y <span class="token operator">=</span> np<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>images<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 原图作为Labels</span>
data_X <span class="token operator">=</span> np<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>images_noise<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 噪声图作为Inputs</span>
<span class="token comment"># 分割为训练集和验证集</span>
X_train<span class="token punctuation">,</span> X_val<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> y_val <span class="token operator">=</span> train_test_split<span class="token punctuation">(</span>data_X<span class="token punctuation">,</span> data_Y<span class="token punctuation">,</span> test_size<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">123</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># 转为张量数据</span>
X_train <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>X_train<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
X_val <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>X_val<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
y_train <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>y_train<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
y_val <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>y_val<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
<span class="token comment"># 将X, Y转化为数据集</span>
train_data <span class="token operator">=</span> Data<span class="token punctuation">.</span>TensorDataset<span class="token punctuation">(</span>X_train<span class="token punctuation">,</span> y_train<span class="token punctuation">)</span>
val_data <span class="token operator">=</span> Data<span class="token punctuation">.</span>TensorDataset<span class="token punctuation">(</span>X_val<span class="token punctuation">,</span> y_val<span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'X_train.shape:'</span><span class="token punctuation">,</span> X_train<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'X_val.shape:'</span><span class="token punctuation">,</span> X_val<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'y_train.shape:'</span><span class="token punctuation">,</span> y_train<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'y_val.shape:'</span><span class="token punctuation">,</span> y_val<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
</code></pre> 
<pre><code>X_train.shape: torch.Size([4000, 3, 96, 96])
X_val.shape: torch.Size([1000, 3, 96, 96])
y_train.shape: torch.Size([4000, 3, 96, 96])
y_val.shape: torch.Size([1000, 3, 96, 96])
</code></pre> 
<p>接下来使用 Data.Dataloader() 方法将二者处理为数据加载器，每个 batch 包含 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         32 
        
       
      
        32 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">3</span><span class="mord">2</span></span></span></span></span> 张图像。</p> 
<pre><code class="prism language-python"><span class="token comment"># 定义训练集和验证集的数据加载器</span>
train_loader <span class="token operator">=</span> Data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>
    dataset<span class="token operator">=</span>train_data<span class="token punctuation">,</span> <span class="token comment"># 使用的数据集</span>
    batch_size<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token comment"># 批处理样本大小</span>
    shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token comment"># 每次训练迭代时都打乱数据</span>
    num_workers<span class="token operator">=</span><span class="token number">0</span> <span class="token comment"># windows上只能0个进程，linux可设置为4</span>
<span class="token punctuation">)</span>
val_loader <span class="token operator">=</span> Data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>
    dataset<span class="token operator">=</span>val_data<span class="token punctuation">,</span>
    batch_size<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span>
    shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    num_workers<span class="token operator">=</span><span class="token number">0</span>
<span class="token punctuation">)</span>
</code></pre> 
<h5><a id="_225"></a>基于转置卷积编码的网络构建</h5> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">Denoise_AutoEncoders</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>Denoise_AutoEncoders<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 定义Encoder编码层</span>
        self<span class="token punctuation">.</span>Encoder <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> out_channels<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># [, 64, 96, 96]</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># [, 64, 96, 96]</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># [, 64, 96, 96]</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># [, 64, 48, 48]</span>
            nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># [, 128, 48, 48]</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># [, 128, 48, 48]</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># [, 256, 48, 48]</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># [, 256, 24, 24]</span>
            nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        <span class="token comment"># 定义Decoder解码层，使用转置卷积</span>
        self<span class="token punctuation">.</span>Decoder <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>ConvTranspose2d<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span> out_channels<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># [, 256, 24, 24]</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>ConvTranspose2d<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> output_padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># [, 128, 48, 48]</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>ConvTranspose2d<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># [, 64, 48, 48]</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>ConvTranspose2d<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># [, 32, 48, 48]</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>ConvTranspose2d<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># [, 32, 48, 48]</span>
            nn<span class="token punctuation">.</span>ConvTranspose2d<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> output_padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># [, 16, 96, 96]</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>ConvTranspose2d<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># [, 3, 96, 96]</span>
            nn<span class="token punctuation">.</span>Sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        encoder <span class="token operator">=</span> self<span class="token punctuation">.</span>Encoder<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        decoder <span class="token operator">=</span> self<span class="token punctuation">.</span>Decoder<span class="token punctuation">(</span>encoder<span class="token punctuation">)</span>
        <span class="token keyword">return</span> encoder<span class="token punctuation">,</span> decoder
</code></pre> 
<p>上述网络定义了一个卷积自编码器。在编码层，卷积核大小均为 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         3 
        
       
         × 
        
       
         3 
        
       
      
        3\times3 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.72777em; vertical-align: -0.08333em;"></span><span class="mord">3</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">3</span></span></span></span></span> ，激活函数为 ReLU，采用最大值池化，并使用了 Batch Normalization 。编码后，尺寸从 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         96 
        
       
         × 
        
       
         96 
        
       
      
        96\times96 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.72777em; vertical-align: -0.08333em;"></span><span class="mord">9</span><span class="mord">6</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">9</span><span class="mord">6</span></span></span></span></span> 缩小为 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         24 
        
       
         × 
        
       
         24 
        
       
      
        24\times24 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.72777em; vertical-align: -0.08333em;"></span><span class="mord">2</span><span class="mord">4</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">2</span><span class="mord">4</span></span></span></span></span> ，并且通道数从 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         3 
        
       
      
        3 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">3</span></span></span></span></span> 增加到 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         256 
        
       
      
        256 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">2</span><span class="mord">5</span><span class="mord">6</span></span></span></span></span> 。</p> 
<p>在解码层，操作相反，对特征映射做转置卷积，从而放大了特征映射，从 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         24 
        
       
         × 
        
       
         24 
        
       
      
        24\times24 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.72777em; vertical-align: -0.08333em;"></span><span class="mord">2</span><span class="mord">4</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">2</span><span class="mord">4</span></span></span></span></span> 放大到 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         96 
        
       
         × 
        
       
         96 
        
       
      
        96\times96 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.72777em; vertical-align: -0.08333em;"></span><span class="mord">9</span><span class="mord">6</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">9</span><span class="mord">6</span></span></span></span></span> ，并且通道从 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         256 
        
       
      
        256 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">2</span><span class="mord">5</span><span class="mord">6</span></span></span></span></span> 逐渐过渡为 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         3 
        
       
      
        3 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">3</span></span></span></span></span> ，对应着原始 RGB 的通道数。</p> 
<p>接下来定义一个网络实体：</p> 
<pre><code class="prism language-python"><span class="token comment"># 定义网络对象</span>
DAEmodel <span class="token operator">=</span> Denoise_AutoEncoders<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">from</span> torchsummary <span class="token keyword">import</span> summary
summary<span class="token punctuation">(</span>DAEmodel<span class="token punctuation">,</span> input_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">96</span><span class="token punctuation">,</span> <span class="token number">96</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>----------------------------------------------------------------
        Layer (type)               Output Shape         Param #
================================================================
            Conv2d-1           [-1, 64, 96, 96]           1,792
              ReLU-2           [-1, 64, 96, 96]               0
       BatchNorm2d-3           [-1, 64, 96, 96]             128
            Conv2d-4           [-1, 64, 96, 96]          36,928
              ReLU-5           [-1, 64, 96, 96]               0
       BatchNorm2d-6           [-1, 64, 96, 96]             128
            Conv2d-7           [-1, 64, 96, 96]          36,928
              ReLU-8           [-1, 64, 96, 96]               0
         MaxPool2d-9           [-1, 64, 48, 48]               0
      BatchNorm2d-10           [-1, 64, 48, 48]             128
           Conv2d-11          [-1, 128, 48, 48]          73,856
             ReLU-12          [-1, 128, 48, 48]               0
      BatchNorm2d-13          [-1, 128, 48, 48]             256
           Conv2d-14          [-1, 128, 48, 48]         147,584
             ReLU-15          [-1, 128, 48, 48]               0
      BatchNorm2d-16          [-1, 128, 48, 48]             256
           Conv2d-17          [-1, 256, 48, 48]         295,168
             ReLU-18          [-1, 256, 48, 48]               0
        MaxPool2d-19          [-1, 256, 24, 24]               0
      BatchNorm2d-20          [-1, 256, 24, 24]             512
  ConvTranspose2d-21          [-1, 128, 24, 24]         295,040
             ReLU-22          [-1, 128, 24, 24]               0
      BatchNorm2d-23          [-1, 128, 24, 24]             256
  ConvTranspose2d-24          [-1, 128, 48, 48]         147,584
             ReLU-25          [-1, 128, 48, 48]               0
      BatchNorm2d-26          [-1, 128, 48, 48]             256
  ConvTranspose2d-27           [-1, 64, 48, 48]          73,792
             ReLU-28           [-1, 64, 48, 48]               0
      BatchNorm2d-29           [-1, 64, 48, 48]             128
  ConvTranspose2d-30           [-1, 32, 48, 48]          18,464
             ReLU-31           [-1, 32, 48, 48]               0
      BatchNorm2d-32           [-1, 32, 48, 48]              64
  ConvTranspose2d-33           [-1, 32, 48, 48]           9,248
  ConvTranspose2d-34           [-1, 16, 96, 96]           4,624
             ReLU-35           [-1, 16, 96, 96]               0
      BatchNorm2d-36           [-1, 16, 96, 96]              32
  ConvTranspose2d-37            [-1, 3, 96, 96]             435
          Sigmoid-38            [-1, 3, 96, 96]               0
================================================================
Total params: 1,143,587
Trainable params: 1,143,587
Non-trainable params: 0
----------------------------------------------------------------
Input size (MB): 0.11
Forward/backward pass size (MB): 80.86
Params size (MB): 4.36
Estimated Total Size (MB): 85.33
----------------------------------------------------------------


/usr/local/lib/python3.6/dist-packages/torch/nn/functional.py:718: UserWarning: Named tensors and all their associated APIs are an experimental feature and subject to change. Please do not use them for anything important until they are released as stable. (Triggered internally at  /home/mist/pytorch/c10/core/TensorImpl.h:1156.)
  return torch.max_pool2d(input, kernel_size, stride, padding, dilation, ceil_mode)
</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># 输出网络结构</span>
<span class="token keyword">from</span> torchviz <span class="token keyword">import</span> make_dot

x <span class="token operator">=</span> torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">96</span><span class="token punctuation">,</span> <span class="token number">96</span><span class="token punctuation">)</span><span class="token punctuation">.</span>requires_grad_<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span>
y <span class="token operator">=</span> DAEmodel<span class="token punctuation">(</span>x<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span>
myDAENet_vis <span class="token operator">=</span> make_dot<span class="token punctuation">(</span>y<span class="token punctuation">,</span> params<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>DAEmodel<span class="token punctuation">.</span>named_parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
myDAENet_vis
</code></pre> 
<p>​<br> <img src="https://images2.imgbox.com/a0/2a/ZCGgkJ8F_o.png" alt="在这里插入图片描述"></p> 
<p>​</p> 
<h5><a id="_379"></a>网络训练和预测</h5> 
<p>定义优化算法为 Adam，损失函数采用均方误差，并可视化损失大小的变化。</p> 
<pre><code class="prism language-python">LR <span class="token operator">=</span> <span class="token number">0.0003</span>
optimizer <span class="token operator">=</span> optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>DAEmodel<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>LR<span class="token punctuation">)</span> <span class="token comment"># Adam优化器</span>
loss_fuc <span class="token operator">=</span> nn<span class="token punctuation">.</span>MSELoss<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span> <span class="token comment"># 损失函数</span>

<span class="token comment"># 使用Hiddenlayer可视化</span>
historyl <span class="token operator">=</span> hl<span class="token punctuation">.</span>History<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 使用Canvas</span>
canvasl <span class="token operator">=</span> hl<span class="token punctuation">.</span>Canvas<span class="token punctuation">(</span><span class="token punctuation">)</span>
train_num <span class="token operator">=</span> <span class="token number">0</span>
val_num <span class="token operator">=</span> <span class="token number">0</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># 对模型迭代训练，对所有数据训练epoch轮</span>
<span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    train_loss_epoch <span class="token operator">=</span> <span class="token number">0</span>
    val_loss_epoch <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token comment"># 对训练加载器的数据迭代优化</span>
    DAEmodel<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> step<span class="token punctuation">,</span> <span class="token punctuation">(</span>b_x<span class="token punctuation">,</span> b_y<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>train_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
        b_x<span class="token punctuation">,</span> b_y <span class="token operator">=</span> b_x<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">,</span> b_y<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        _<span class="token punctuation">,</span> output <span class="token operator">=</span> DAEmodel<span class="token punctuation">(</span>b_x<span class="token punctuation">)</span>
        loss <span class="token operator">=</span> loss_fuc<span class="token punctuation">(</span>output<span class="token punctuation">,</span> b_y<span class="token punctuation">)</span> <span class="token comment"># 均方根误差</span>
        optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 清空过往梯度</span>
        loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 梯度反向传播</span>
        optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 根据梯度更新参数</span>
        train_loss_epoch <span class="token operator">+=</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> b_x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        train_num <span class="token operator">=</span> train_num <span class="token operator">+</span> b_x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token comment"># 对验证加载器的数据进行模型验证</span>
    DAEmodel<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> step<span class="token punctuation">,</span> <span class="token punctuation">(</span>b_x<span class="token punctuation">,</span> b_y<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>val_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
        b_x<span class="token punctuation">,</span> b_y <span class="token operator">=</span> b_x<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">,</span> b_y<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        _<span class="token punctuation">,</span> output <span class="token operator">=</span> DAEmodel<span class="token punctuation">(</span>b_x<span class="token punctuation">)</span>
        loss <span class="token operator">=</span> loss_fuc<span class="token punctuation">(</span>output<span class="token punctuation">,</span> b_y<span class="token punctuation">)</span>
        val_loss_epoch <span class="token operator">+=</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> b_x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        val_num <span class="token operator">=</span> val_num <span class="token operator">+</span> b_x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token comment"># 计算一个epoch的损失</span>
    train_loss <span class="token operator">=</span> train_loss_epoch <span class="token operator">/</span> train_num
    val_loss <span class="token operator">=</span> val_loss_epoch <span class="token operator">/</span> val_num
    <span class="token comment"># 保存每个epoch的输出loss</span>
    historyl<span class="token punctuation">.</span>log<span class="token punctuation">(</span>epoch<span class="token punctuation">,</span> train_loss<span class="token operator">=</span>train_loss<span class="token punctuation">,</span> val_loss<span class="token operator">=</span>val_loss<span class="token punctuation">)</span>
    <span class="token comment"># 可视化网络训练过程</span>
    <span class="token keyword">with</span> canvasl<span class="token punctuation">:</span>
        canvasl<span class="token punctuation">.</span>draw_plot<span class="token punctuation">(</span><span class="token punctuation">[</span>historyl<span class="token punctuation">[</span><span class="token string">'train_loss'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> historyl<span class="token punctuation">[</span><span class="token string">'val_loss'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p>​<br> <img src="https://images2.imgbox.com/82/f1/3VKh109Q_o.png" alt="在这里插入图片描述"></p> 
<p>​</p> 
<h5><a id="_439"></a>评价去噪效果</h5> 
<p>下面针对验证集中的一张图像使用训练好的降噪器去噪，并与原始图像对比效果</p> 
<pre><code class="prism language-python"><span class="token comment"># 输入</span>
imageindex <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment"># 图像索引</span>
im <span class="token operator">=</span> X_val<span class="token punctuation">[</span>imageindex<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
im <span class="token operator">=</span> im<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
im_nose <span class="token operator">=</span> np<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>im<span class="token punctuation">.</span>data<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
im_nose <span class="token operator">=</span> im_nose<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># 网络去噪结果</span>
DAEmodel<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
_<span class="token punctuation">,</span> output <span class="token operator">=</span> DAEmodel<span class="token punctuation">(</span>im<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
im_de <span class="token operator">=</span> np<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>output<span class="token punctuation">.</span>data<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
im_de <span class="token operator">=</span> im_de<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># 标签(无噪声图像)</span>
im <span class="token operator">=</span> y_val<span class="token punctuation">[</span>imageindex<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
im_or <span class="token operator">=</span> im<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
im_or <span class="token operator">=</span> np<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>im_or<span class="token punctuation">.</span>data<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
im_or <span class="token operator">=</span> im_or<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># 计算去噪后的PSNR</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'加噪后的PSNR:'</span><span class="token punctuation">,</span> peak_signal_noise_ratio<span class="token punctuation">(</span>im_or<span class="token punctuation">,</span> im_nose<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'dB'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'去噪后的PSNR:'</span><span class="token punctuation">,</span> peak_signal_noise_ratio<span class="token punctuation">(</span>im_or<span class="token punctuation">,</span> im_de<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'dB'</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>加噪后的PSNR: 19.41260585144029 dB
去噪后的PSNR: 24.97685547084317 dB
</code></pre> 
<p>上述代码是对降噪前后的图像分别计算出 PSNR，即峰值信噪比，值越大说明两个图像之间越相似，可用于表示去噪效果。</p> 
<p>接下来对原始图像、带噪图像和去噪图像分别可视化：</p> 
<pre><code class="prism language-python"><span class="token comment"># 结果可视化</span>
plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>im_or<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Original Image'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>im_nose<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Noise Image $\sigma$=30'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>im_de<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Denoising Image'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>​<br> <img src="https://images2.imgbox.com/44/68/ZhcfK8V1_o.png" alt="在这里插入图片描述"></p> 
<p>​</p> 
<p>从图中可以看出，去噪效果显著，已经看不到图像的噪声点了，而且去噪图像非常平滑，和原始图像很相近。</p> 
<p>下面针对整个验证数据集使用降噪器，计算出所有图像降噪前后的 PSNR 提升大小的均值，来衡量多张数据上的降噪情况。</p> 
<pre><code class="prism language-python"><span class="token comment"># 计算整个验证集去噪后的PSNR提升的均值</span>
PSNR_val <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
DAEmodel<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>X_val<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    imageindex <span class="token operator">=</span> i
    <span class="token comment"># 输入</span>
    im <span class="token operator">=</span> X_val<span class="token punctuation">[</span>imageindex<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
    im <span class="token operator">=</span> im<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    im_nose <span class="token operator">=</span> np<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>im<span class="token punctuation">.</span>data<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    im_nose <span class="token operator">=</span> im_nose<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
    <span class="token comment"># 去噪</span>
    _<span class="token punctuation">,</span> output <span class="token operator">=</span> DAEmodel<span class="token punctuation">(</span>im<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    im_de <span class="token operator">=</span> np<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>output<span class="token punctuation">.</span>data<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    im_de <span class="token operator">=</span> im_de<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
    <span class="token comment"># 输出</span>
    im <span class="token operator">=</span> y_val<span class="token punctuation">[</span>imageindex<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
    im_or <span class="token operator">=</span> im<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    im_or <span class="token operator">=</span> np<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>im_or<span class="token punctuation">.</span>data<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    im_or <span class="token operator">=</span> im_or<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
    <span class="token comment"># 计算去噪后的PSNR</span>
    PSNR_val<span class="token punctuation">.</span>append<span class="token punctuation">(</span>peak_signal_noise_ratio<span class="token punctuation">(</span>im_or<span class="token punctuation">,</span> im_de<span class="token punctuation">)</span> <span class="token operator">-</span> peak_signal_noise_ratio<span class="token punctuation">(</span>im_or<span class="token punctuation">,</span> im_nose<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'PSNR的平均提升量为:'</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>PSNR_val<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'dB'</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>PSNR的平均提升量为: 5.813400503195555 dB
</code></pre> 
<p>可知，峰值信噪比提升了 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         5.81 
        
       
         d 
        
       
         B 
        
       
      
        5.81dB 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.69444em; vertical-align: 0em;"></span><span class="mord">5</span><span class="mord">.</span><span class="mord">8</span><span class="mord">1</span><span class="mord mathdefault">d</span><span class="mord mathdefault" style="margin-right: 0.05017em;">B</span></span></span></span></span> ，去噪的效果非常显著。</p> 
<p>受于训练时间和设备的约束，并没有使用更多的图像以及不同类型的噪声训练，所以得到的降噪器还有一定的局限性，但是从降噪后的图像已经反映出了基于卷积神经网络的降噪自编码器在图像去噪方面的有效性。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/15ebdbef2947c01848a12cc515c94c59/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">el-cascader 最后一级id及回显</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7525690bfa638ef912ec91a9081de701/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Urp相机堆栈关于后处理抗锯齿设置的问题</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>