<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Python银行信贷风控建模实战（xgb&#43;lgb） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Python银行信贷风控建模实战（xgb&#43;lgb）" />
<meta property="og:description" content="目录
一、数据读取及预处理
1、数据读取
2、数据预处理
二、模型构建及评估
三、划重点
少走10年弯路
一、数据读取及预处理 1、数据读取 数据来源某比赛网站（下图仅为部分字段），数据集中包含银行借贷订单的金额、利息、账期、担保等基本信息，还有历史授信情况，数据类型同样包含数值型、类别型、日期等变量，同时存在缺失问题，适合初学者入门练习。文末获取数据
2、数据预处理 （1）无效特征剔除：数据集中存在部分无效数据，唯一值数量仅为1、不包含有效信息，可以直接剔除；
（2）日期、编码剔除：如下图，部分日期为脏数据，为方便处理直接剔除日期字段
（4）类别型变量处理：使用xgb时特征输入需要为数值型，所以复制一份xgb建模数据集对类别型变量使用目标编码、即使用训练集（避免穿越）每类类别型变量对应的y均值进行编码；而对于lgb可以直接转为category类型输入。
（5）FM交叉特征：针对lgb，数据集中存在部分类别型变量可以衍生二阶交叉特征、后续测试效果
def init_data(): df_fea=pd.read_excel(&#39;原始数据/trainX.xlsx&#39;) df_y=pd.read_excel(&#39;原始数据/trainY.xlsx&#39;) df=pd.concat([df_fea.drop([&#39;id&#39;],axis=1),df_y.drop([&#39;id&#39;],axis=1)],axis=1) return df df=init_data() def drop_useless_col(data): df_sta=data.nunique(dropna=False).to_frame() df_sta.columns=[&#39;unique_cnt&#39;] drop_col=list(df_sta[df_sta.unique_cnt&lt;2].index) return data[[col for col in data.columns if col not in drop_col]] def data_pred(data): df=data.copy() df=df.pipe(drop_useless_col) drop_col=[&#39;jieju_next_anew_pricing_dt&#39;] drop_tmp=[&#39;kehu_tm_dpst_early_open_acct_dt&#39;,&#39;kehu_open_cust_tm&#39;,&#39;kehu_open_cust_dt&#39;] return df[[col for col in df.columns if col not in drop_col&#43;drop_tmp]] df_pre=df.pipe(data_pred) from itertools import combinations def combine(df_pre,cate_col): df=df_pre.copy() comb=list(combinations(cate_col,2)) cate_col_add=[] for col1,col2 in comb: df[col1&#43;&#39;_&#39;&#43;col2]=df[col1]." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/e9f64e1976c6e7ba8a29e4465c3b46d0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-28T09:51:44+08:00" />
<meta property="article:modified_time" content="2023-11-28T09:51:44+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Python银行信贷风控建模实战（xgb&#43;lgb）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="%E4%B8%80%E3%80%81%E6%95%B0%E6%8D%AE%E8%AF%BB%E5%8F%96%E5%8F%8A%E9%A2%84%E5%A4%84%E7%90%86-toc" style="margin-left:80px;"><a href="#%E4%B8%80%E3%80%81%E6%95%B0%E6%8D%AE%E8%AF%BB%E5%8F%96%E5%8F%8A%E9%A2%84%E5%A4%84%E7%90%86" rel="nofollow">一、数据读取及预处理</a></p> 
<p id="1%E3%80%81%E6%95%B0%E6%8D%AE%E8%AF%BB%E5%8F%96-toc" style="margin-left:120px;"><a href="#1%E3%80%81%E6%95%B0%E6%8D%AE%E8%AF%BB%E5%8F%96" rel="nofollow">1、数据读取</a></p> 
<p id="2%E3%80%81%E6%95%B0%E6%8D%AE%E9%A2%84%E5%A4%84%E7%90%86-toc" style="margin-left:120px;"><a href="#2%E3%80%81%E6%95%B0%E6%8D%AE%E9%A2%84%E5%A4%84%E7%90%86" rel="nofollow">2、数据预处理</a></p> 
<p id="%E4%BA%8C%E3%80%81%E6%A8%A1%E5%9E%8B%E6%9E%84%E5%BB%BA%E5%8F%8A%E8%AF%84%E4%BC%B0-toc" style="margin-left:80px;"><a href="#%E4%BA%8C%E3%80%81%E6%A8%A1%E5%9E%8B%E6%9E%84%E5%BB%BA%E5%8F%8A%E8%AF%84%E4%BC%B0" rel="nofollow">二、模型构建及评估</a></p> 
<p id="%E4%BA%8C%E3%80%81%E5%88%92%E9%87%8D%E7%82%B9-toc" style="margin-left:80px;"><a href="#%E4%BA%8C%E3%80%81%E5%88%92%E9%87%8D%E7%82%B9" rel="nofollow">三、划重点</a></p> 
<p id="%E5%B0%91%E8%B5%B010%E5%B9%B4%E5%BC%AF%E8%B7%AF-toc" style="margin-left:120px;"><a href="#%E5%B0%91%E8%B5%B010%E5%B9%B4%E5%BC%AF%E8%B7%AF" rel="nofollow">少走10年弯路</a></p> 
<hr id="hr-toc"> 
<p></p> 
<h4 id="%E4%B8%80%E3%80%81%E6%95%B0%E6%8D%AE%E8%AF%BB%E5%8F%96%E5%8F%8A%E9%A2%84%E5%A4%84%E7%90%86"><strong>一、数据读取及预处理</strong></h4> 
<h5 id="1%E3%80%81%E6%95%B0%E6%8D%AE%E8%AF%BB%E5%8F%96"><strong>1、数据读取</strong></h5> 
<p>        数据来源某比赛网站（下图仅为部分字段），数据集中包含银行借贷订单的金额、利息、账期、担保等基本信息，还有历史授信情况，数据类型同样包含数值型、类别型、日期等变量，同时存在缺失问题，适合初学者入门练习。<span style="color:#be191c;">文末获取数据</span></p> 
<p class="img-center"><img alt="" height="211" src="https://images2.imgbox.com/19/00/71IS8AOQ_o.png" width="673"></p> 
<p class="img-center"><img alt="" height="355" src="https://images2.imgbox.com/4f/c1/groTjS3i_o.png" width="506"></p> 
<p class="img-center"><img alt="" height="366" src="https://images2.imgbox.com/ed/34/WTTgIsyc_o.png" width="490"></p> 
<h5 id="2%E3%80%81%E6%95%B0%E6%8D%AE%E9%A2%84%E5%A4%84%E7%90%86"><strong>2、数据预处理</strong></h5> 
<p>        （1）无效特征剔除：数据集中存在部分无效数据，唯一值数量仅为1、不包含有效信息，可以直接剔除；</p> 
<p>        （2）日期、编码剔除：如下图，部分日期为脏数据，为方便处理直接剔除日期字段</p> 
<p class="img-center"><img alt="" height="259" src="https://images2.imgbox.com/e9/c6/r4oysX6k_o.png" width="617"></p> 
<p>        （4）类别型变量处理：使用xgb时特征输入需要为数值型，所以复制一份xgb建模数据集对类别型变量使用目标编码、即使用训练集（避免穿越）每类类别型变量对应的y均值进行编码；而对于lgb可以直接转为category类型输入。</p> 
<p>        （5）FM交叉特征：针对lgb，数据集中存在部分类别型变量可以衍生二阶交叉特征、后续测试效果</p> 
<p class="img-center"><img alt="" height="247" src="https://images2.imgbox.com/99/2a/J8Y8Kr2f_o.png" width="634"></p> 
<pre><code class="language-python">def init_data():
    df_fea=pd.read_excel('原始数据/trainX.xlsx')
    df_y=pd.read_excel('原始数据/trainY.xlsx')
    df=pd.concat([df_fea.drop(['id'],axis=1),df_y.drop(['id'],axis=1)],axis=1)
    
    return df

df=init_data()
def drop_useless_col(data):
    df_sta=data.nunique(dropna=False).to_frame()
    df_sta.columns=['unique_cnt']
    drop_col=list(df_sta[df_sta.unique_cnt&lt;2].index)
    
    return data[[col for col in data.columns if col not in drop_col]]

def data_pred(data):
    df=data.copy()
    df=df.pipe(drop_useless_col)
    
    drop_col=['jieju_next_anew_pricing_dt']
    drop_tmp=['kehu_tm_dpst_early_open_acct_dt','kehu_open_cust_tm','kehu_open_cust_dt']
    
    return df[[col for col in df.columns if col not in drop_col+drop_tmp]]
    
df_pre=df.pipe(data_pred)
from itertools import combinations
def combine(df_pre,cate_col):
    df=df_pre.copy()
    comb=list(combinations(cate_col,2))
    cate_col_add=[]
    for col1,col2 in comb:
        df[col1+'_'+col2]=df[col1].astype('string').str.cat(df[col2],sep='&amp;')
        cate_col_add.append(col1+'_'+col2)
    df[cate_col+cate_col_add]=df[cate_col+cate_col_add].astype('category')
    return df,cate_col_add

df_pre_comb,cate_col_add=df_pre.pipe(combine,cate_col)
def get_xgb_data(df_pre,y='jieju_dubil_status_desc',fea_list=cate_col+float_col):
    df=df_pre.copy()
    cate_col=df.select_dtypes(include=['category','string','object'])
    map_dict={}
    for col in cate_col:
        col_map=df.groupby([col])[y].mean().to_dict()
        df[col]=df[col].map(col_map)
        map_dict[col]=col_map
    df[fea_list]=df[fea_list].astype('float')
    return df,map_dict
    
df_xgb,map_dict=get_xgb_data(df_pre,fea_list=cate_col+float_col)</code></pre> 
<h4 id="%E4%BA%8C%E3%80%81%E6%A8%A1%E5%9E%8B%E6%9E%84%E5%BB%BA%E5%8F%8A%E8%AF%84%E4%BC%B0"><strong>二、模型构建及评估</strong></h4> 
<p>        分别使用lgb、xgb构建二分类模型，其中lgb分别训练是否添加FM交叉特征版本用于对比，使用ks、auc进行评估</p> 
<p class="img-center"><img alt="" height="135" src="https://images2.imgbox.com/51/4e/djcQUGc7_o.png" width="452"></p> 
<pre><code class="language-python">def init_params(model_select='lgb'):
    params_xgb={
        'objective':'binary:logistic',
        'eval_metric':'auc',
#        'silent':0,
        'nthread':4,
        'n_estimators':500,
        'eta':0.02,
#        'num_leaves':10,
        'max_depth':4,
        'min_child_weight':20,
        'scale_pos_weight':1,
        'gamma':0,
        'reg_alpha':0,
        'reg_lambda':0,
        'subsample':0.8,
        'colsample_bytree':0.8,
        'seed':123
    }
    params_lgb={
        'boosting_type': 'gbdt', 
        'objective': 'binary',
        'metric':'auc',
        'n_jobs': 4,
        'n_estimators':500,
        'learning_rate': 0.03, 
        'max_depth':4, 
        'num_leaves': 12, 
        'max_bin':255,
        'subsample_for_bin':100000, # 构建直方图的样本量
        'min_split_gain':0,
        'min_child_samples':30,
        'colsample_bytree': 0.8,
        'subsample': 0.8, 
        'subsample_freq': 1,   # 每 k 次迭代执行bagging      
        'feature_fraction_seed':2,
        'bagging_seed': 1,
        'reg_alpha':0,
        'reg_lambda':0,
        'scale_pos_weight':1, # 等价于is_unbalance=False
        'silent':True,
        'random_state':1,
        'verbose':-1, # 控制模型训练过程的输出信息，-1为不输出信息
     }
    if model_select=='xgb':
        return params_xgb
    elif model_select=='lgb':
        return params_lgb

def ks_auc_value(y_value,df,model):
    y_pred=model.predict_proba(df)[:,1]
    fpr,tpr,thresholds= roc_curve(list(y_value),list(y_pred))
    ks=max(tpr-fpr)
    auc= roc_auc_score(list(y_value),list(y_pred))
    return ks,auc
    
def model_train_sklearn(model_label,train,y_name,model_var,model_select='lgb',params=None):
    
    if params is None:
        params=init_params(model_select)
    x_train,x_test, y_train, y_test =train_test_split(train[model_var],train[y_name],test_size=0.2, random_state=123)

    if model_select=='xgb':
        model=XGBClassifier(**params)
    elif model_select=='lgb':
        model=lgb.LGBMClassifier(**params)
    
    model.fit(x_train,y_train,eval_set=[(x_train, y_train),(x_test, y_test)],verbose=False) # 调参时设verbose=False
    train_ks,train_auc=ks_auc_value(y_train,x_train,model)
    test_ks,test_auc=ks_auc_value(y_test,x_test,model)
    
#     model_sklearn=model.fit(train[model_var],train[y_name])  # 全集数据训练
    all_ks,all_auc=ks_auc_value(train[y_name],train[model_var],model)
    
    dic={
        'model_label':model_label,
        'train_good':(y_train.count()-y_train.sum()),'train_bad':y_train.sum(),
        'test_good':(y_test.count()-y_test.sum()),'test_bad':y_test.sum(),
        'all_good':train[train[y_name]==0].shape[0],'all_bad':train[train[y_name]==1].shape[0],
        'train_ks':train_ks,'train_auc':train_auc,
        'test_ks':test_ks,'test_auc':test_auc,
        'all_ks':all_ks,'all_auc':all_auc,
    }
    return dic,model</code></pre> 
<h4 id="%E4%BA%8C%E3%80%81%E5%88%92%E9%87%8D%E7%82%B9">三、划重点</h4> 
<h5 id="%E5%B0%91%E8%B5%B010%E5%B9%B4%E5%BC%AF%E8%B7%AF"><a name="t12"></a><a name="t11"></a>少走10年弯路</h5> 
<p><strong><strong>        </strong></strong>关注威信公众号 <span style="color:#be191c;">Python风控模型与数据分析</span>，回复 <span style="color:#be191c;">银行风控实战</span> 获取本篇数据及代码</p> 
<p>        还有更多理论、代码分享等你来拿</p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fd4fc88e092f70427ffff8217e3de2ab/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">现代控制理论 --如何将连续系统离散化？</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3897801762f92cd10412c430e3175682/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">现代控制理论 -- 能控性、能观性</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>