<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ZYNQ CAN总线之CAN ID过滤器分析 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ZYNQ CAN总线之CAN ID过滤器分析" />
<meta property="og:description" content="ZYNQ CAN 总线学习总结
参考链接：
https://www.uisrc.com/portal.php?mod=view&amp;aid=73
CAN基础知识总结 帧的种类 通信是通过以下 5 种类型的帧进行的。
• 数据帧
• 遥控帧
• 错误帧
• 过载帧
• 帧间隔
另外，数据帧和遥控帧有标准格式和扩展格式两种格式。标准格式有 11 个位的标识符（Identifier: 以下称 ID），扩展格式有 29 个位的 ID。
各种帧的用途如表 7 所示，各种帧的构成如图 11～图 15 所示
波特率 根据CAN规范，位时间被分成4个时间段：同步段（Sync_Seg）、传播时间段（Prop_Seg）、相位缓冲段1（Phase_Seg1）和相位缓冲段2（Phase_Seg2）
每个段由具体、可编程数量的时间份额（time quanta）组成，时间份额是位时间的基本时间单元，它的长度（tq）由CAN控制器的系统时钟（fcan）和波特率预分频器BRP定义：tq=BRP/fcan
CAN模块的系统时钟fcan是其CAN模块时钟（CAN_CLK）输入的频率。
其中位同步时间占用1个Tscl；时间段2占用(Tseg1&#43;1)个Tscl；时间段2占用(Tseg2&#43;1)个Tscl,所以CAN控制器的位时间(TBit)就是：TBit=Tseg1&#43;Tseg2&#43;Tsync=(TSEG1&#43;TSEG2&#43;3）*Tscl，那么CAN的波特率 (CANbps)就是1/TBit。
但是这样计算出的值是一个理论值。在实际的网络通信中由于存在传输的延时、不同节点的晶体的误差等因素，使得网络CAN的波特率的计算变得复杂起来。CAN在技术上便引入了重同步的概念，以更好的解决这些问题。这样重同步带来的结果就是要么时间段1(Tseg1)增加TSJW（同步跳转宽度SJW&#43;1），要么时间段减少TSJW
CAN有波特率的值四以下几个元素决定：
A． 最小时间段Tscl；
B． 时间段1 TSEG1；
C． 时间段2 TSEG2；
D． 同步跳转宽度 SJW
那么Tscl又是怎么计算的呢？这是总总线时序寄存器中的预分频寄存器BRP派上了用场，Tscl＝（BRP&#43;1）/FVBP。FVBP为微处理器的外设时钟。
而TSEG1与TSEG2又是怎么划分的呢？TSEG1与TSEG2的长度决定了CAN数据的采样点，这种方式允许宽范围的数据传输延迟和晶体的误差。其中TSEG1用来调整数据传输延迟时间造成的误差，而TSEG2则用来调整不同点节点晶体频率的误差。但是他们由于过于灵活，而使初次接触CAN的人有点无所适从。TSEG1与TSEG2的是分大体遵循以下规则： Tseg2≥Tscl2，Tseg2≥2TSJW，Tseg1≥Tseg2
总的来说，对于CAN的波特率计算问题，把握一个大的方向就行了，其计算公式可了规结为： BitRate = Fpclk/( (BRP&#43;1) * ((Tseg1&#43;1)&#43;(Tseg2&#43;1)&#43;1)
采样时间 除了波特率之外，CAN接口还有1个重要的参数就是单bit数据的采样时间。采样时间通常用采样点时间位于整个bit时间内的百分比来表示。
(Sync_Seg&#43; Prog_Seg&#43; Phase_Seg1)/( Sync_Seg&#43; Prog_Seg&#43; Phase_Seg1&#43; Phase_Seg2) 如下图所示，采样点位置为(1&#43;1&#43;4)/(1&#43;1&#43;4&#43;2)=75%。 与采样时间相关的有如下几个重要参数。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/ff745f2d4a0a3088540c546a4acb2965/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-31T15:34:40+08:00" />
<meta property="article:modified_time" content="2023-08-31T15:34:40+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ZYNQ CAN总线之CAN ID过滤器分析</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>ZYNQ CAN 总线学习总结</p> 
<p>参考链接：<br> <a href="https://www.uisrc.com/portal.php?mod=view&amp;aid=73" rel="nofollow">https://www.uisrc.com/portal.php?mod=view&amp;aid=73</a></p> 
<h3><a id="CAN_6"></a>CAN基础知识总结</h3> 
<p><img src="https://images2.imgbox.com/29/c2/bJAWmvuk_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_9"></a>帧的种类</h4> 
<p>通信是通过以下 5 种类型的帧进行的。<br> • 数据帧<br> • 遥控帧<br> • 错误帧<br> • 过载帧<br> • 帧间隔<br> 另外，数据帧和遥控帧有标准格式和扩展格式两种格式。标准格式有 11 个位的标识符（Identifier: 以下称 ID），扩展格式有 29 个位的 ID。<br> 各种帧的用途如表 7 所示，各种帧的构成如图 11～图 15 所示<br> <img src="https://images2.imgbox.com/bd/47/R0oUKIn5_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/8e/d4/D576qelN_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_22"></a>波特率</h4> 
<p>根据CAN规范，位时间被分成4个时间段：同步段（Sync_Seg）、传播时间段（Prop_Seg）、相位缓冲段1（Phase_Seg1）和相位缓冲段2（Phase_Seg2）</p> 
<p>每个段由具体、可编程数量的时间份额（time quanta）组成，时间份额是位时间的基本时间单元，它的长度（tq）由CAN控制器的系统时钟（fcan）和波特率预分频器BRP定义：tq=BRP/fcan<br> CAN模块的系统时钟fcan是其CAN模块时钟（CAN_CLK）输入的频率。<br> <img src="https://images2.imgbox.com/29/ce/CEdycT1R_o.png" alt="在这里插入图片描述"></p> 
<p>其中位同步时间占用1个Tscl；时间段2占用(Tseg1+1)个Tscl；时间段2占用(Tseg2+1)个Tscl,所以CAN控制器的位时间(TBit)就是：TBit=Tseg1+Tseg2+Tsync=(TSEG1+TSEG2+3）*Tscl，那么CAN的波特率 (CANbps)就是1/TBit。<br> 但是这样计算出的值是一个理论值。在实际的网络通信中由于存在传输的延时、不同节点的晶体的误差等因素，使得网络CAN的波特率的计算变得复杂起来。CAN在技术上便引入了重同步的概念，以更好的解决这些问题。这样重同步带来的结果就是要么时间段1(Tseg1)增加TSJW（同步跳转宽度SJW+1），要么时间段减少TSJW</p> 
<p>CAN有波特率的值四以下几个元素决定：<br> A． 最小时间段Tscl；<br> B． 时间段1 TSEG1；<br> C． 时间段2 TSEG2；<br> D． 同步跳转宽度 SJW<br> 那么Tscl又是怎么计算的呢？这是总总线时序寄存器中的预分频寄存器BRP派上了用场，Tscl＝（BRP+1）/FVBP。FVBP为微处理器的外设时钟。<br> 而TSEG1与TSEG2又是怎么划分的呢？TSEG1与TSEG2的长度决定了CAN数据的采样点，这种方式允许宽范围的数据传输延迟和晶体的误差。其中TSEG1用来调整数据传输延迟时间造成的误差，而TSEG2则用来调整不同点节点晶体频率的误差。但是他们由于过于灵活，而使初次接触CAN的人有点无所适从。TSEG1与TSEG2的是分大体遵循以下规则： Tseg2≥Tscl2，Tseg2≥2TSJW，Tseg1≥Tseg2<br> 总的来说，对于CAN的波特率计算问题，把握一个大的方向就行了，其计算公式可了规结为： BitRate = Fpclk/( (BRP+1) * ((Tseg1+1)+(Tseg2+1)+1)</p> 
<h4><a id="_42"></a>采样时间</h4> 
<p>除了波特率之外，CAN接口还有1个重要的参数就是单bit数据的采样时间。采样时间通常用采样点时间位于整个bit时间内的百分比来表示。</p> 
<pre><code>   (Sync_Seg+ Prog_Seg+ Phase_Seg1)/( Sync_Seg+ Prog_Seg+ Phase_Seg1+ Phase_Seg2)
  如下图所示，采样点位置为(1+1+4)/(1+1+4+2)=75%。 
</code></pre> 
<p><img src="https://images2.imgbox.com/49/73/YNDKgi5b_o.png" alt="在这里插入图片描述"></p> 
<p>与采样时间相关的有如下几个重要参数。<br> <img src="https://images2.imgbox.com/e8/e3/H0hevMWr_o.png" alt="在这里插入图片描述"></p> 
<p>确定Prog_Seg、Phase_Seg1、Phase_Seg2 、SJW的值需要遵循如下几个原则：</p> 
<p>Sync_Seg、Prog_Seg、Phase_Seg1和 Phase_Seg2的总和在8~25之间。<br> Phase_Seg2应该取Phase_Seg1和信息处理时间二者中的最大值。<br> SJW取Phase_Seg1和4中的最小值。<br> Phase_Seg2≥SJW，Phase_Seg1≥SJW。<br> Phase_Seg1+Phase_Seg2为偶数时Phase_Seg1=Phase_Seg2 ，Phase_Seg1+ Phase_Seg2为奇数时Phase_Seg1+1=Phase_Seg2。</p> 
<p>广州周立功作为国内CAN产品的领先者，使用了CiA CANopen的建议值，即采样时间为87.5%，SJW=1 tq。因此，我们以此作为CAN接口的设计参考标准。</p> 
<h3><a id="ZYNQCAN_65"></a>ZYNQ系列CAN控制器</h3> 
<p><img src="https://images2.imgbox.com/4a/1f/bwXefk5z_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/13/df/EQo4abBe_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/e7/08/PdPx5oNG_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="Message_Format_75"></a><strong>Message Format</strong></h4> 
<p>The same message format is used for RxFIFO and Tx (FIFO and HPB). Each message includes four words (16 bytes). Software must read and write all four words regardless of the actual number of data bytes and valid fields in the message.<br> The message words, fields and structure are shown in Table 18-2. The details of each field are in<br> Table 18-3.</p> 
<p><img src="https://images2.imgbox.com/35/02/Z960812P_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="Bit_Field_Details_84"></a><strong>Bit Field Details</strong></h4> 
<p>Writes<br> If a bit field or data byte is not required, then write zeros. Software should write the default values . shown in Table 18-3 for unused functions.<br> Reads<br> Data starts at byte 0 and continues for the number of counts in DLC. Software should read both data words, but the only valid bytes are determined by DLC.<br> Table 18-3 provides bit descriptions for the identifier word bits, the DLC word bits, and data word 1 and data word 2 bits.</p> 
<p><img src="https://images2.imgbox.com/15/d9/OQ8dgxg7_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/2f/8d/GJvUTJwH_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="ZYNQ_CANCAN_ID_95"></a>ZYNQ CAN总线之CAN ID过滤器分析与设置</h3> 
<p>CAN报文标识符：并不代表节点的地址， 而是和报文的内容有关 发送者以广播的形式发送消息 ，节点在接收报文时根据标识符（CAN ID）决定是否需要该报文， 如果需要则拷贝到SRAM中 不需要则丢弃实现硬件过滤 节省CPU开销。</p> 
<p>详细介绍参考 ug585–page566, Rx Message Filtering</p> 
<p>下面对其进行翻译整理：<br> 要筛选Rx消息，请配置并启用最多四个带有接受掩码和ID寄存器的接受过滤器，以确定是在RxFIFO中存储消息，还是确认并丢弃它们。验收过滤按以下顺序进行：<br> 1.传入的标识符被接受过滤器掩码寄存器中的位屏蔽。<br> 2.验收过滤器ID寄存器也被验收过滤器掩码寄存器中的位屏蔽。<br> 3.并对这两个结果值进行了比较。<br> 4.如果这两个值都相等，则该消息将存储在RxFIFO中。<br> 5.验收过滤器由每个已定义的过滤器进行处理。如果传入的标识符通过任何接受过滤器，则该消息将存储在RxFIFO中。</p> 
<p><strong>验收过滤器启用</strong><br> 验收过滤器寄存器（AFR）定义了要使用哪些验收过滤器。它包括对应于四个接受过滤器的四个启用位。每个验收过滤器ID寄存器（AFIR）和验收过滤器掩码寄存器（AFMR）对都与使用验收过滤器（UAF）位相关联。<br> 当UAF位为1时，使用相应的验收滤波器对进行验收滤波。<br> 当UAF位为0时，对应的验收过滤器对不用于验收过滤。<br> 要在正常模式下修改接受滤波器对，该寄存器中相应的UAF位必须首先设置为0。修改接受过滤器后，必须将相应的UAF位设置为1，才能启用过滤器。<br> CAN中的UAF位。AFR寄存器启用Rx接受过滤器：<br> 如果所有UAF位都设置为0，那么所有接收到的消息都存储在RxFIFO中。<br> 如果在接收CAN消息时，UAF位从1更改为0，则该消息将不会存储在RxFIFO中。</p> 
<p><strong>如果任何已启用的过滤器（最多4个）满足此等式，那么Rx消息将存储在RxFIFO：<br> If (AFMR &amp; Message_ID) == (AFMR &amp; AFIR) then Capture Message<br> 每个验收过滤器都是独立启用的。过滤器是由CAN.AFR寄存器选择。<br> • Set can.AFR[UAF4] = 1 to enable AFMR4 and AFID4.<br> • Set can.AFR[UAF3] = 1 to enable AFMR3 and AFID3.<br> • Set can.AFR[UAF2] = 1 to enable AFMR2 and AFID2.<br> • Set can.AFR[UAF1] = 1 to enable AFMR1 and AFID1.</strong></p> 
<p>如果所有 can.AFR[UAFx] 被设置为0，然后所有接收到的消息都存储在RxFIFO中。UAF位在传入消息开始时由硬件进行采样。</p> 
<p><strong>验收过滤器掩码</strong><br> 验收过滤器掩码寄存器（AFMR）包含用于验收过滤的掩码位。将消息帧的传入消息标识符部分与存储在接受过滤器ID寄存器中的消息标识符进行比较。掩码位定义存储在接受过滤器ID寄存器中的哪些标识符位与传入的消息标识符进行比较。有四个afmr。这些寄存器被存储在一个存储器中。如果内存未初始化，从AFMR返回‘X。断言软件重置或硬件重置不会清除寄存器内容。这些寄存器只有在CAN.AFR =0 和CAN,SR=0 时可以被读取和写入。<br> 控制AFMRs的条件如下：<br> <strong>Extended Frames</strong><br> All bit fields (AMID [28:18], AMSRR, AMIDE, AMID [17:0] and AMRTR) need to be defined.<br> <strong>Standard Frames</strong><br> Only AMID [28:18], AMSRR and AMIDE need to be defined. AMID [17:0] and AMRTR should be written as 0.</p> 
<p><strong>验收过滤器标识符</strong><br> 验收过滤器ID寄存器（AFIR）包含用于接受过滤的标识符位。有四个验收过滤器ID寄存器。这些寄存器可以从中读取和写入到。只有当SR中对应的UAF位为0，而SR中的ACFBSY位为0时，才应该写入这些寄存器。<br> AFIRs的使用符合以下条件：<br> <strong>Extended Frames</strong><br> All the bit fields (AIID [28…18], AISRR, AIIDE, AIID [17:0] and AIRTR) must be defined.<br> <strong>Standard Frames</strong><br> Only AIID [28:18], AISRR and AIIDE need to be defined. AIID [17:0] and AIRTR should be written with 0.</p> 
<p>用户必须确保对标准帧和扩展帧的IDE位进行正确的编程。如果用户将AMIR中的IDE位设置为0，则认为它仅是一个标准的帧ID检查。</p> 
<p>Example: Program Acceptance Filter<br> 每个验收过滤器都有自己的掩码，CAN.AFMR{1、2、3、4}，和ID寄存器，CAN,AFIR{1,2,3,4}.</p> 
<pre><code class="prism language-c"><span class="token number">1.</span> Disable acceptance filters<span class="token punctuation">.</span> Write <span class="token number">0</span> to the can<span class="token punctuation">.</span>AFR <span class="token keyword">register</span><span class="token punctuation">.</span>
<span class="token number">2.</span> Wait <span class="token keyword">for</span> filter to be not busy<span class="token punctuation">.</span> Poll on can<span class="token punctuation">.</span>SR<span class="token punctuation">[</span>ACFBSY<span class="token punctuation">]</span> <span class="token keyword">for</span> <span class="token number">0.</span>
<span class="token number">3.</span> Write a filter mask and ID<span class="token punctuation">.</span> Write to a pair of AFMR and AFIR <span class="token function">registers</span> <span class="token punctuation">(</span>refer to the example 
below<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token number">4.</span> Write additional filter masks and IDs<span class="token punctuation">.</span> Go to step <span class="token number">2.</span>
<span class="token number">5.</span> Enable one or more Filters<span class="token punctuation">.</span> To enable all filters<span class="token punctuation">,</span> write <span class="token number">0x0000</span>_000F to the can<span class="token punctuation">.</span>AFR <span class="token keyword">register</span><span class="token punctuation">.</span>
</code></pre> 
<p><strong>Program the AFMR and AFIR Registers</strong><br> The valid fields for sending Tx messages to the controller are summarized in Table 18-5. These fields are described in section 18.2.2 Message Format.<br> <img src="https://images2.imgbox.com/60/f4/pe0O2T0z_o.png" alt="在这里插入图片描述"><br> 在AFMR掩码寄存器中，通过向位字段写入一个1，从而为传入的Rx CAN消息的每个字段启用（解除掩码）的比较函数。在AFIR寄存器中，写入要与即将到来的Tx CAN消息进行比较的值。</p> 
<p><strong>示例：为标准帧的AFMR和AFIR进行编程</strong></p> 
<p>本示例为标准帧设置接受过滤器。帧ID号显示为0x5DF，但可以设置为应用程序所需的值。</p> 
<pre><code class="prism language-c"><span class="token number">1.</span> Configure filter mask <span class="token keyword">for</span> standard frames<span class="token punctuation">.</span> Write <span class="token number">0xFFF8</span>_0000 to the can<span class="token punctuation">.</span>AFMR <span class="token keyword">register</span><span class="token operator">:</span>
a<span class="token punctuation">.</span> Enable the compare <span class="token keyword">for</span> the standard message ID<span class="token punctuation">,</span> <span class="token punctuation">[</span>AMIDE<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1.</span>
b<span class="token punctuation">.</span> Compare all bits in the standard message ID<span class="token punctuation">,</span> <span class="token punctuation">[</span>AMIDH<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x7FF.</span>
c<span class="token punctuation">.</span> Enable the compare <span class="token keyword">for</span> substitute remote transmission request<span class="token punctuation">,</span> <span class="token punctuation">[</span>AMSRR<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1.</span>
d<span class="token punctuation">.</span> Zero<span class="token operator">-</span>out the extended frame bits<span class="token punctuation">,</span> <span class="token punctuation">[</span>AMIDL<span class="token punctuation">,</span> AMRTR<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.</span>
<span class="token number">2.</span> Configure filter ID <span class="token keyword">for</span> standard frames<span class="token punctuation">.</span> Write <span class="token number">0xABC0</span>_0000 to the can<span class="token punctuation">.</span>AFIR <span class="token keyword">register</span><span class="token operator">:</span>
a<span class="token punctuation">.</span> Select the standard frame message mode<span class="token punctuation">,</span> <span class="token punctuation">[</span>AIIDE<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.</span>
b<span class="token punctuation">.</span> Program the standard message ID<span class="token punctuation">,</span> <span class="token punctuation">[</span>AIIDH<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x55E.</span>
c<span class="token punctuation">.</span> Disable substitute remote transmission request<span class="token punctuation">,</span> <span class="token punctuation">[</span>AISRR<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.</span> 
d<span class="token punctuation">.</span> Zero<span class="token operator">-</span>out extended frame bits<span class="token punctuation">,</span> <span class="token punctuation">[</span>AIIDL<span class="token punctuation">,</span> AIRTR<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.</span>
</code></pre> 
<p><strong>示例：为扩展帧的AFMR和AFIR进行编程</strong></p> 
<p>本示例为扩展帧设置接受过滤器。帧ID号显示为0x5DF，但可以设置为应用程序所需的值。</p> 
<pre><code class="prism language-c"><span class="token number">1.</span> Configure filter mask <span class="token keyword">for</span> extended frames<span class="token punctuation">.</span> Write <span class="token number">0xFFFF</span>_FFFF to the can<span class="token punctuation">.</span>AFMR <span class="token keyword">register</span><span class="token operator">:</span>
a<span class="token punctuation">.</span> Enable the substitute remote transmission request mask <span class="token keyword">for</span> frame<span class="token punctuation">,</span> <span class="token punctuation">[</span>AMSRR<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1.</span>
b<span class="token punctuation">.</span> Compare all bits in the compare <span class="token keyword">for</span> the standard message ID<span class="token punctuation">,</span> <span class="token punctuation">[</span>AMIDH<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x7FF.</span>
c<span class="token punctuation">.</span> Enable the extended frame<span class="token punctuation">,</span> <span class="token punctuation">[</span>AMIDE<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1.</span>
d<span class="token punctuation">.</span> Extended ID<span class="token punctuation">,</span> <span class="token punctuation">[</span>AMIDL<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x3FFFF</span>
e<span class="token punctuation">.</span> Remote transmission request bit <span class="token keyword">for</span> extended frame<span class="token punctuation">,</span> <span class="token punctuation">[</span>AMRTR<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1.</span>
<span class="token number">2.</span> Configure filter ID <span class="token keyword">for</span> extended frames<span class="token punctuation">.</span> Write <span class="token number">0xABDF</span>_9BDE to the can<span class="token punctuation">.</span>AFIR <span class="token keyword">register</span><span class="token operator">:</span>
a<span class="token punctuation">.</span> Standard ID<span class="token punctuation">,</span> <span class="token punctuation">[</span>AIIDH<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x55E.</span>
b<span class="token punctuation">.</span> Remote transmission request bit <span class="token keyword">for</span> standard frame<span class="token punctuation">,</span> <span class="token punctuation">[</span>AISRR<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1.</span>
c<span class="token punctuation">.</span> Select standard<span class="token operator">/</span>extended frame<span class="token punctuation">,</span> <span class="token punctuation">[</span>AIIDE<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1.</span>
d<span class="token punctuation">.</span> Extended ID<span class="token punctuation">,</span> <span class="token punctuation">[</span>AIIDL<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">3</span>CDEF<span class="token punctuation">.</span>
e<span class="token punctuation">.</span> Remote transmission request bit <span class="token keyword">for</span> extended frame<span class="token punctuation">,</span> <span class="token punctuation">[</span>AIRTR<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
</code></pre> 
<h4><a id="_199"></a>总结：</h4> 
<p>设置代码如下：</p> 
<pre><code class="prism language-c">	<span class="token comment">/*
	 * Enable individual acceptance filters.
	 * 下面函数的设置顺序不能改变
	 */</span>
	<span class="token function">XCanPs_AcceptFilterDisable</span><span class="token punctuation">(</span>CanInstancePtr<span class="token punctuation">,</span> XCANPS_AFR_UAF_ALL_MASK<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span> FALSE <span class="token operator">==</span>  <span class="token function">XCanPs_IsAcceptFilterBusy</span><span class="token punctuation">(</span>CanInstancePtr<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token function">XCanPs_AcceptFilterSet</span><span class="token punctuation">(</span>CanInstancePtr<span class="token punctuation">,</span> XCANPS_AFR_UAF1_MASK<span class="token punctuation">,</span> u32 MaskValue<span class="token punctuation">,</span> u32 IdValue<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//If (AFMR &amp; Message_ID) == (AFMR &amp; AFIR) then Capture Message</span>
	<span class="token punctuation">}</span>
	
	<span class="token function">XCanPs_AcceptFilterEnable</span><span class="token punctuation">(</span>CanInstancePtr<span class="token punctuation">,</span> XCANPS_AFR_UAF1_MASK<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>需要注意的问题：</p> 
<pre><code class="prism language-c">according to the sources <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> the values <span class="token keyword">for</span> the filters need to be generated through the XCANPS_IDR_<span class="token operator">*</span> macros rather than passed in literally<span class="token punctuation">.</span>  So I would try changes along the following lines<span class="token operator">:</span>
Your example<span class="token operator">:</span>
s32 res1 <span class="token operator">=</span> <span class="token function">XCanPs_AcceptFilterSet</span><span class="token punctuation">(</span>CanInstPtr<span class="token punctuation">,</span> XCANPS_AFR_UAF1_MASK<span class="token punctuation">,</span> <span class="token number">0x7ff</span><span class="token punctuation">,</span> <span class="token number">0x200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Change to<span class="token operator">:</span>
s32 res1 <span class="token operator">=</span> <span class="token function">XCanPs_AcceptFilterSet</span><span class="token punctuation">(</span>CanInstPtr<span class="token punctuation">,</span> XCANPS_AFR_UAF1_MASK<span class="token punctuation">,</span>
                                                           <span class="token number">0x7ff</span> <span class="token operator">&lt;&lt;</span> XCANPS_IDR_ID1_SHIFT<span class="token punctuation">,</span>
                                                           <span class="token number">0x200</span> <span class="token operator">&lt;&lt;</span> XCANPS_IDR_ID1_SHIFT<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>参考链接：<br> <a href="https://github.com/Xilinx/embeddedsw/blob/master/XilinxProcessorIPLib/drivers/canps/src/xcanps.c#L688">https://github.com/Xilinx/embeddedsw/blob/master/XilinxProcessorIPLib/drivers/canps/src/xcanps.c#L688</a><br> <a href="https://support.xilinx.com/s/question/0D52E00006iHj5bSAC/can-filtering-on-zynq-ultrascale-1085-r5-baremetal?language=en_US" rel="nofollow">https://support.xilinx.com/s/question/0D52E00006iHj5bSAC/can-filtering-on-zynq-ultrascale-1085-r5-baremetal?language=en_US</a></p> 
<h3><a id="ZYNQ_CAN__235"></a>ZYNQ CAN 中断设置问题总结</h3> 
<h4><a id="_237"></a>中断使能问题</h4> 
<p>调试发现，用 XCANPS_IXR_ALL 函数可以进入中断，但是 XCANPS_IXR_RXOK_MASK 不可以进入中断。</p> 
<pre><code class="prism language-c">	<span class="token comment">// 只使能接受中断</span>
	<span class="token comment">// 调试发现，用 XCANPS_IXR_ALL 可以使能中断，但是 XCANPS_IXR_RXOK_MASK 不可以使能中断</span>
	<span class="token function">XCanPs_IntrEnable</span><span class="token punctuation">(</span>CanInstancePtr<span class="token punctuation">,</span> XCANPS_IXR_ALL<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//	XCanPs_IntrEnable(CanInstancePtr, XCANPS_IXR_RXOK_MASK | XCANPS_HANDLER_EVENT | XCANPS_IXR_RXUFLW_MASK);</span>
	<span class="token function">XCanPs_IntrEnable</span><span class="token punctuation">(</span>CanInstancePtr<span class="token punctuation">,</span> XCANPS_IXR_RXOK_MASK <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">XCanPs_IntrDisable</span><span class="token punctuation">(</span>CanInstancePtr<span class="token punctuation">,</span> XCANPS_IXR_TXOK_MASK <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//	XCanPs_IntrDisable(CanInstancePtr, XCANPS_IXR_TXOK_MASK | XCANPS_IXR_RXNEMP_MASK</span>
<span class="token comment">//			| XCANPS_IXR_TXFLL_MASK | XCANPS_IXR_TXFWMEMP_MASK);</span>
</code></pre> 
<p>用调试助手发送：<br> <img src="https://images2.imgbox.com/d9/66/adLRVPHw_o.png" alt="在这里插入图片描述"><br> 接收数据如下：<br> <img src="https://images2.imgbox.com/3e/09/a1c0qxjU_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/55/a7/4DD3YTw3_o.png" alt="在这里插入图片描述"></p> 
<p>0X0284F0F0对应二进制：<br> 001010-0001-11-00-1111-0000-1111-00000<br> 1-0100-0011-1001-1110000111100000 – &gt; 1439E1E0<br> 说明收到的第1个word顺序不变。<br> 接收到的数据中第三个和第四个word中，每个u32 中高低字节相反。</p> 
<p>接受的中断状态寄存器：</p> 
<p><img src="https://images2.imgbox.com/55/8d/76gaSMsj_o.png" alt="在这里插入图片描述"><br> 对应得中断分别是：<br> <img src="https://images2.imgbox.com/c4/55/pMvFzrkC_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/60/83/1gdW2UVN_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/f6/89/5y8mhUXP_o.png" alt="在这里插入图片描述"><br> 只有如下中断是有效的：<br> Receive FIFO Not Empty Interrupt<br> 但想要的是如下中断：<br> <img src="https://images2.imgbox.com/f3/08/bIGQE27Y_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_275"></a>中断状态寄存器：</h4> 
<p><img src="https://images2.imgbox.com/54/68/9MEbmSPk_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/af/fe/0oxsagcv_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/8b/82/jDHY9Dud_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/08/bb/jfEVrAl9_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/d2/e8/Q3bQjwev_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/1a/13/7KRRyVeA_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/3f/f5/ROkhKX18_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/cd/5a/JDeLGxlr_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/ab/9b/sgAtxqmv_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/82/ea/I1TwxfZe_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/d7/9b/IHsL7C3m_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/1d/30/jBRLp4mC_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/ee/06/GV20WsTy_o.png" alt="在这里插入图片描述"><br> 在这里插入图片描述</p> 
<p><img src="https://images2.imgbox.com/fa/f4/Xt9joZNU_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/0a/df/SsbU2He0_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/82/38/BT2XksUM_o.png" alt="在这里插入图片描述"><br> 查看状态寄存器：<br> <img src="https://images2.imgbox.com/bf/41/jlAkCbU1_o.png" alt="在这里插入图片描述"><br> XCANPS_SR_ESTAT_MASK(ESTAT)，bit 8:7, 状态为01，表明异常状态。<br> 01: Indicates Error Active State.</p> 
<p>当设置如下过滤条件时：</p> 
<pre><code class="prism language-c">	<span class="token function">XCanPs_AcceptFilterSet</span><span class="token punctuation">(</span>CanInstancePtr<span class="token punctuation">,</span> XCANPS_AFR_UAF1_MASK<span class="token punctuation">,</span> <span class="token number">0xFFE7FFFE</span><span class="token punctuation">,</span> <span class="token number">0</span>b0010100001000011110000000000000 <span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<p>发送帧ID 0284xxxx 都可以接受到，似乎ID2的18bit没有起到作用。后来发现，原因在于AFMR和AFIR中的第20bit-IDE位置1才会被视作扩展帧，开始此位一直被设置为0，所以ID2被忽略了。</p> 
<p><img src="https://images2.imgbox.com/0c/9b/Gvnq0L2F_o.png" alt="在这里插入图片描述"><br> 这里的一个new message 是16个字节，FIFO容量为64*16字节。</p> 
<h4><a id="_320"></a>程序稳定性</h4> 
<p>硬件不连接CAN 控制器，程序容易卡在某个地方。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9490b6b120625998eabb7a705da5f6c2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Elasticsearch 7.6 - API高阶操作篇</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/da971cc92159fd02c0cfcaa255f027b9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">13.108.Spark 优化、Spark优化与hive的区别、SparkSQL启动参数调优、四川任务优化实践：执行效率提升50%以上</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>