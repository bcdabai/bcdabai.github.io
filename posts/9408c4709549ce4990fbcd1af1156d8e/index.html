<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>V4L2简介 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="V4L2简介" />
<meta property="og:description" content="http://work-blog.readthedocs.org/en/latest/v4l2%20intro.html
第一章 V4L2简介 1.1、什么是v4l2 V4L2（Video4Linux的缩写）是Linux下关于视频采集相关设备的驱动框架，为驱动和应用程序提供了一套统一的接口规范。
V4L2支持的设备十分广泛，但是其中只有很少一部分在本质上是真正的视频设备：
Video capture device ： 从摄像头等设备上获取视频数据。对很多人来讲，video capture是V4L2的基本应用。设备名称为/dev/video,主设备号81，子设备号0~63Video output device ： 将视频数据编码为模拟信号输出。与video capture设备名相同。Video overlay device ： 将同步锁相视频数据（如TV）转换为VGA信号，或者将抓取的视频数据直接存放到视频卡的显存中。Video output overlay device ：也被称为OSD(On-Screen Display)VBI device ： 提供对VBI（Vertical Blanking Interval）数据的控制，发送VBI数据或抓取VBI数据。设备名/dev/vbi0~vbi31,主设备号81,子设备号224~255Radio device ： FM/AM发送和接收设备。设备名/dev/radio0~radio63,主设备号81，子设备号64~127 V4L2在Linux系统中的结构图如下：
V4L2简单框图
1.2、从应用层看V4L2 从V4L2简单框图可以看出,V4L2是一个字符设备，而V4L2的大部分功能都是通过设备文件的ioctl导出的。
**可以将这些ioctl分类如下**：
Query Capability:查询设备支持的功能，只有VIDIOC_QUERY_CAP一个。优先级相关：包括VIDIOC_G_PRIORITY,VIDIOC_S_PRIORITY,设置优先级。capture相关：视频捕获相关Ioctl。 capture ioctl list ID 描述 VIDIOC_ENUM_FMT 枚举设备所支持的所有数据格式 VIDIOC_S_FMT 设置数据格式 VIDIOC_G_FMT 获取数据格式 VIDIOC_TRY_FMT 与VIDIOC_S_FMT一样，但不会改变设备的状态 VIDIOC_REQBUFS 向设备请求视频缓冲区，即初始化视频缓冲区 VIDIOC_QUERYBUF 查询缓冲区的状态 VIDIOC_QBUF 从设备获取一帧视频数据 VIDIOC_DQBUF 将视频缓冲区归回给设备， VIDIOC_OVERLAY 开始或者停止overlay VIDIOC_G_FBUF 获取video overlay设备或OSD设备的framebuffer参数 VIDIOC_S_FBUF 设置framebuffer参数 VIDIOC_STREAMON 开始流I/O操作，capture or output device VIDIOC_STREAMOFF 关闭流I/O操作 TV视频标准： TV Standard ID 描述 VIDIOC_ENUMSTD 枚举设备支持的所有标准 VIDIOC_G_STD 获取当前正在使用的标准 VIDIOC_S_STD 设置视频标准 VIDIOC_QUERYSTD 有的设备支持自动侦测输入源的视频标准，此时使用此ioctl查询侦测到的视频标准 input/output： Input / Output ID 描述 VIDIOC_ENUMINPUT 枚举所有input端口 VIDIOC_G_INPUT 获取当前正在使用的input端口 VIDIOC_S_INPUT 设置将要使用的input端口 VIDIOC_ENUMOUTPUT 枚举所有output端口 VIDIOC_G_OUTPUT 获取当前正在使用的output端口 VIDIOC_S_OUTPUT 设置将要使用的output端口 VIDIOC_ENUMAUDIO 枚举所有audio input端口 VIDIOC_G_AUDIO 获取当前正在使用的audio input端口 VIDIOC_S_AUDIO 设置将要使用的audio input端口 VIDIOC_ENUMAUDOUT 枚举所有audio output端口 VIDIOC_G_AUDOUT 获取当前正在使用的audio output端口 VIDIOC_S_AUDOUT 设置将要使用的audio output端口 controls：设备特定的控制，例如设置对比度，亮度 controls ID 描述 VIDIOC_QUERYCTRL 查询指定control的详细信息 VIDIOC_G_CTRL 获取指定control的值 VIDIOC_S_CTRL 设置指定control的值 VIDIOC_G_EXT_CTRLS 获取多个control的值 VIDIOC_S_EXT_CTRLS 设置多个control的值 VIDIOC_TRY_EXT_CTRLS 与VIDIOC_S_EXT_CTRLS相同，但是不改变设备状态 VIDIOC_QUERYMENU 查询menu 其他杂项： controls ID 描述 VIDIOC_G_MODULATOR VIDIOC_S_MODULATOR VIDIOC_G_CROP VIDIOC_S_CROP VIDIOC_G_SELECTION VIDIOC_S_SELECTION VIDIOC_CROPCAP VIDIOC_G_ENC_INDEX VIDIOC_ENCODER_CMD VIDIOC_TRY_ENCODER_CMD VIDIOC_DECODER_CMD VIDIOC_TRY_DECODER_CMD VIDIOC_G_PARM VIDIOC_S_PARM VIDIOC_G_TUNER VIDIOC_S_TUNER VIDIOC_G_FREQUENCY VIDIOC_S_FREQUENCY VIDIOC_G_SLICED_VBI_CAP VIDIOC_LOG_STATUS VIDIOC_DBG_G_CHIP_IDENT VIDIOC_S_HW_FREQ_SEEK VIDIOC_ENUM_FRAMESIZES VIDIOC_ENUM_FRAMEINTERVALS VIDIOC_ENUM_DV_PRESETS VIDIOC_S_DV_PRESET VIDIOC_G_DV_PRESET VIDIOC_QUERY_DV_PRESET VIDIOC_S_DV_TIMINGS VIDIOC_G_DV_TIMINGS VIDIOC_DQEVENT VIDIOC_SUBSCRIBE_EVENT VIDIOC_UNSUBSCRIBE_EVENT VIDIOC_CREATE_BUFS VIDIOC_PREPARE_BUF v4l2设备的基本操作流程如下：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/9408c4709549ce4990fbcd1af1156d8e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2015-10-13T18:24:51+08:00" />
<meta property="article:modified_time" content="2015-10-13T18:24:51+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">V4L2简介</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2 style="margin:0px; padding:0.7em 0px 0.3em; font-size:1.8em; font-family:'segoe UI',sans-serif; letter-spacing:-0.159999996423721px; line-height:24px"> http://work-blog.readthedocs.org/en/latest/v4l2%20intro.html<br> </h2> 
<h2 style="margin:0px; padding:0.7em 0px 0.3em; font-size:1.8em; font-family:'segoe UI',sans-serif; letter-spacing:-0.159999996423721px; line-height:24px"> 第一章 V4L2简介<a target="_blank" class="headerlink" href="http://work-blog.readthedocs.org/en/latest/v4l2%20intro.html#v4l2" rel="nofollow noopener noreferrer" title="Permalink to this headline" style="visibility:hidden; font-size:1em; margin-left:6px; padding:0px 4px; color:black!important"></a></h2> 
<div class="section" id="id1" style="font-family:'segoe UI',sans-serif; font-size:16px; letter-spacing:-0.159999996423721px; line-height:24px"> 
 <h3 style="margin:1.3em 0px 0.2em; font-size:1.35em; padding:0px">1.1、什么是v4l2<a target="_blank" class="headerlink" href="http://work-blog.readthedocs.org/en/latest/v4l2%20intro.html#id1" rel="nofollow noopener noreferrer" title="Permalink to this headline" style="visibility:hidden; font-size:1em; margin-left:6px; padding:0px 4px; color:black!important"></a></h3> 
 <p style="margin-top:0.8em; margin-bottom:0.5em">V4L2（Video4Linux的缩写）是Linux下关于视频采集相关设备的驱动框架，为驱动和应用程序提供了一套统一的接口规范。</p> 
 <p style="margin-top:0.8em; margin-bottom:0.5em">V4L2支持的设备十分广泛，但是其中只有很少一部分在本质上是真正的视频设备：</p> 
 <ul class="simple"><li><strong>Video capture device</strong> ： 从摄像头等设备上获取视频数据。对很多人来讲，video capture是V4L2的基本应用。设备名称为/dev/video,主设备号81，子设备号0~63</li><li><strong>Video output device</strong> ： 将视频数据编码为模拟信号输出。与video capture设备名相同。</li><li><strong>Video overlay device</strong> ： 将同步锁相视频数据（如TV）转换为VGA信号，或者将抓取的视频数据直接存放到视频卡的显存中。</li><li><strong>Video output overlay device</strong> ：也被称为OSD(On-Screen Display)</li><li><strong>VBI device</strong> ： 提供对VBI（Vertical Blanking Interval）数据的控制，发送VBI数据或抓取VBI数据。设备名/dev/vbi0~vbi31,主设备号81,子设备号224~255</li><li><strong>Radio device</strong> ： FM/AM发送和接收设备。设备名/dev/radio0~radio63,主设备号81，子设备号64~127</li></ul> 
 <p style="margin-top:0.8em; margin-bottom:0.5em">V4L2在Linux系统中的结构图如下：</p> 
 <div class="figure" id="fig-v4l2-arch"> 
  <img alt="_images/V4L2框图.png" src="https://images2.imgbox.com/f7/e2/kYw458gF_o.png" style="border:0px"> 
  <p class="caption" style="margin-top:0.8em; margin-bottom:0.5em; text-align:inherit; padding-left:20px"> V4L2简单框图</p> 
 </div> 
</div> 
<div class="section" id="id2" style="font-family:'segoe UI',sans-serif; font-size:16px; letter-spacing:-0.159999996423721px; line-height:24px"> 
 <h3 style="margin:1.3em 0px 0.2em; font-size:1.35em; padding:0px">1.2、从应用层看V4L2<a target="_blank" class="headerlink" href="http://work-blog.readthedocs.org/en/latest/v4l2%20intro.html#id2" rel="nofollow noopener noreferrer" title="Permalink to this headline" style="visibility:hidden; font-size:1em; margin-left:6px; padding:0px 4px; color:black!important"></a></h3> 
 <p style="margin-top:0.8em; margin-bottom:0.5em">从<a target="_blank" class="reference internal" href="http://work-blog.readthedocs.org/en/latest/v4l2%20intro.html#fig-v4l2-arch" rel="nofollow noopener noreferrer" style="color:rgb(34,68,102)">V4L2简单框图</a>可以看出,V4L2是一个字符设备，而V4L2的大部分功能都是通过设备文件的ioctl导出的。</p> 
 <p style="margin-top:0.8em; margin-bottom:0.5em"><a target="_blank" href="http://work-blog.readthedocs.org/en/latest/v4l2%20intro.html#id3" rel="nofollow noopener noreferrer" style="color:rgb(34,68,102)"><span class="problematic" id="id4">**</span></a>可以将这些ioctl分类如下**：</p> 
 <ol class="arabic simple" style=""><li>Query Capability:查询设备支持的功能，只有VIDIOC_QUERY_CAP一个。</li><li>优先级相关：包括VIDIOC_G_PRIORITY,VIDIOC_S_PRIORITY,设置优先级。</li><li>capture相关：视频捕获相关Ioctl。</li></ol> 
 <blockquote> 
  <div class="wy-table-responsive"> 
   <table border="1" class="docutils" style="border-collapse:collapse; margin:0px -0.5em; border:0px"><caption style="background-color:rgb(238,238,238)"> 
     <strong>capture ioctl list</strong> 
    </caption><colgroup><col width="12%"><col width="88%"></colgroup><thead><tr class="row-odd"><th class="head" style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> ID</th><th class="head" style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> 描述</th></tr></thead><tbody><tr class="row-even"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_ENUM_FMT</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> 枚举设备所支持的所有数据格式</td></tr><tr class="row-odd"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_S_FMT</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> 设置数据格式</td></tr><tr class="row-even"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_G_FMT</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> 获取数据格式</td></tr><tr class="row-odd"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_TRY_FMT</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> 与VIDIOC_S_FMT一样，但不会改变设备的状态</td></tr><tr class="row-even"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_REQBUFS</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> 向设备请求视频缓冲区，即初始化视频缓冲区</td></tr><tr class="row-odd"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_QUERYBUF</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> 查询缓冲区的状态</td></tr><tr class="row-even"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_QBUF</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> 从设备获取一帧视频数据</td></tr><tr class="row-odd"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_DQBUF</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> 将视频缓冲区归回给设备，</td></tr><tr class="row-even"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_OVERLAY</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> 开始或者停止overlay</td></tr><tr class="row-odd"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_G_FBUF</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> 获取video overlay设备或OSD设备的framebuffer参数</td></tr><tr class="row-even"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_S_FBUF</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> 设置framebuffer参数</td></tr><tr class="row-odd"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_STREAMON</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> 开始流I/O操作，capture or output device</td></tr><tr class="row-even"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_STREAMOFF</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> 关闭流I/O操作</td></tr></tbody></table> 
  </div> 
 </blockquote> 
 <ol class="arabic simple" start="4" style=""><li>TV视频标准：</li></ol> 
 <blockquote> 
  <div class="wy-table-responsive"> 
   <table border="1" class="docutils" style="border-collapse:collapse; margin:0px -0.5em; border:0px"><caption style="background-color:rgb(238,238,238)"> 
     <strong>TV Standard</strong> 
    </caption><colgroup><col width="12%"><col width="88%"></colgroup><thead><tr class="row-odd"><th class="head" style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> ID</th><th class="head" style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> 描述</th></tr></thead><tbody><tr class="row-even"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_ENUMSTD</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> 枚举设备支持的所有标准</td></tr><tr class="row-odd"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_G_STD</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> 获取当前正在使用的标准</td></tr><tr class="row-even"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_S_STD</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> 设置视频标准</td></tr><tr class="row-odd"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_QUERYSTD</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> 有的设备支持自动侦测输入源的视频标准，此时使用此ioctl查询侦测到的视频标准</td></tr></tbody></table> 
  </div> 
 </blockquote> 
 <ol class="arabic simple" start="5" style=""><li>input/output：</li></ol> 
 <blockquote> 
  <div class="wy-table-responsive"> 
   <table border="1" class="docutils" style="border-collapse:collapse; margin:0px -0.5em; border:0px"><caption style="background-color:rgb(238,238,238)"> 
     <strong>Input / Output</strong> 
    </caption><colgroup><col width="12%"><col width="88%"></colgroup><thead><tr class="row-odd"><th class="head" style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> ID</th><th class="head" style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> 描述</th></tr></thead><tbody><tr class="row-even"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_ENUMINPUT</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> 枚举所有input端口</td></tr><tr class="row-odd"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_G_INPUT</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> 获取当前正在使用的input端口</td></tr><tr class="row-even"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_S_INPUT</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> 设置将要使用的input端口</td></tr><tr class="row-odd"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_ENUMOUTPUT</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> 枚举所有output端口</td></tr><tr class="row-even"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_G_OUTPUT</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> 获取当前正在使用的output端口</td></tr><tr class="row-odd"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_S_OUTPUT</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> 设置将要使用的output端口</td></tr><tr class="row-even"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_ENUMAUDIO</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> 枚举所有audio input端口</td></tr><tr class="row-odd"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_G_AUDIO</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> 获取当前正在使用的audio input端口</td></tr><tr class="row-even"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_S_AUDIO</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> 设置将要使用的audio input端口</td></tr><tr class="row-odd"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_ENUMAUDOUT</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> 枚举所有audio output端口</td></tr><tr class="row-even"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_G_AUDOUT</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> 获取当前正在使用的audio output端口</td></tr><tr class="row-odd"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_S_AUDOUT</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> 设置将要使用的audio output端口</td></tr></tbody></table> 
  </div> 
 </blockquote> 
 <ol class="arabic simple" start="6" style=""><li>controls：设备特定的控制，例如设置对比度，亮度</li></ol> 
 <blockquote> 
  <div class="wy-table-responsive"> 
   <table border="1" class="docutils" style="border-collapse:collapse; margin:0px -0.5em; border:0px"><caption style="background-color:rgb(238,238,238)"> 
     <strong>controls</strong> 
    </caption><colgroup><col width="12%"><col width="88%"></colgroup><thead><tr class="row-odd"><th class="head" style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> ID</th><th class="head" style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> 描述</th></tr></thead><tbody><tr class="row-even"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_QUERYCTRL</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> 查询指定control的详细信息</td></tr><tr class="row-odd"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_G_CTRL</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> 获取指定control的值</td></tr><tr class="row-even"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_S_CTRL</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> 设置指定control的值</td></tr><tr class="row-odd"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_G_EXT_CTRLS</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> 获取多个control的值</td></tr><tr class="row-even"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_S_EXT_CTRLS</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> 设置多个control的值</td></tr><tr class="row-odd"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_TRY_EXT_CTRLS</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> 与VIDIOC_S_EXT_CTRLS相同，但是不改变设备状态</td></tr><tr class="row-even"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_QUERYMENU</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> 查询menu</td></tr></tbody></table> 
  </div> 
 </blockquote> 
 <ol class="arabic simple" start="7" style=""><li>其他杂项：</li></ol> 
 <blockquote> 
  <div class="wy-table-responsive"> 
   <table border="1" class="docutils" style="border-collapse:collapse; margin:0px -0.5em; border:0px"><caption style="background-color:rgb(238,238,238)"> 
     <strong>controls</strong> 
    </caption><colgroup><col width="12%"><col width="88%"></colgroup><thead><tr class="row-odd"><th class="head" style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> ID</th><th class="head" style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> 描述</th></tr></thead><tbody><tr class="row-even"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_G_MODULATOR</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)">  </td></tr><tr class="row-odd"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_S_MODULATOR</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)">  </td></tr><tr class="row-even"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_G_CROP</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)">  </td></tr><tr class="row-odd"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_S_CROP</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)">  </td></tr><tr class="row-even"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_G_SELECTION</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)">  </td></tr><tr class="row-odd"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_S_SELECTION</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)">  </td></tr><tr class="row-even"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_CROPCAP</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)">  </td></tr><tr class="row-odd"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_G_ENC_INDEX</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)">  </td></tr><tr class="row-even"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_ENCODER_CMD</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)">  </td></tr><tr class="row-odd"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_TRY_ENCODER_CMD</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)">  </td></tr><tr class="row-even"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_DECODER_CMD</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)">  </td></tr><tr class="row-odd"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_TRY_DECODER_CMD</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)">  </td></tr><tr class="row-even"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_G_PARM</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)">  </td></tr><tr class="row-odd"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_S_PARM</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)">  </td></tr><tr class="row-even"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_G_TUNER</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)">  </td></tr><tr class="row-odd"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_S_TUNER</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)">  </td></tr><tr class="row-even"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_G_FREQUENCY</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)">  </td></tr><tr class="row-odd"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_S_FREQUENCY</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)">  </td></tr><tr class="row-even"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_G_SLICED_VBI_CAP</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)">  </td></tr><tr class="row-odd"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_LOG_STATUS</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)">  </td></tr><tr class="row-even"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_DBG_G_CHIP_IDENT</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)">  </td></tr><tr class="row-odd"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_S_HW_FREQ_SEEK</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)">  </td></tr><tr class="row-even"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_ENUM_FRAMESIZES</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)">  </td></tr><tr class="row-odd"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_ENUM_FRAMEINTERVALS</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)">  </td></tr><tr class="row-even"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_ENUM_DV_PRESETS</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)">  </td></tr><tr class="row-odd"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_S_DV_PRESET</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)">  </td></tr><tr class="row-even"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_G_DV_PRESET</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)">  </td></tr><tr class="row-odd"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_QUERY_DV_PRESET</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)">  </td></tr><tr class="row-even"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_S_DV_TIMINGS</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)">  </td></tr><tr class="row-odd"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_G_DV_TIMINGS</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)">  </td></tr><tr class="row-even"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_DQEVENT</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)">  </td></tr><tr class="row-odd"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_SUBSCRIBE_EVENT</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)">  </td></tr><tr class="row-even"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_UNSUBSCRIBE_EVENT</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)">  </td></tr><tr class="row-odd"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_CREATE_BUFS</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)">  </td></tr><tr class="row-even"><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)"> VIDIOC_PREPARE_BUF</td><td style="padding:1px 8px 1px 5px; border-width:0px 0px 1px; border-bottom-style:solid; border-bottom-color:rgb(170,170,170)">  </td></tr></tbody></table> 
  </div> 
 </blockquote> 
 <p style="margin-top:0.8em; margin-bottom:0.5em">v4l2设备的基本操作流程如下：</p> 
 <ol class="arabic simple" style=""><li><a target="_blank" href="http://work-blog.readthedocs.org/en/latest/v4l2%20intro.html#id5" rel="nofollow noopener noreferrer" style="color:rgb(34,68,102)"><span class="problematic" id="id6">**</span></a>打开设备**，例如 <tt class="docutils literal" style="font-family:Consolas,'Deja Vu Sans Mono','Bitstream Vera Sans Mono',monospace; font-size:0.95em; letter-spacing:0.01em; border-bottom-width:1px; border-bottom-style:solid; border-bottom-color:rgb(221,221,221); color:rgb(51,51,51); background-color:rgb(242,242,242)"><span class="pre">fd</span> <span class="pre">=</span> <span class="pre">open("/dev/video0",0)</span></tt></li><li><strong>查询设备能力</strong>. 例如:</li></ol> 
 <blockquote> 
  <div class="highlight-c"> 
   <div class="highlight" style="background:rgb(238,255,204)"> 
    <pre style="overflow-x:auto; overflow-y:hidden; font-family:Consolas,'Deja Vu Sans Mono','Bitstream Vera Sans Mono',monospace; font-size:0.95em; letter-spacing:0.015em; line-height:18.2399997711182px; padding:0.5em; border:1px solid rgb(204,204,204); background-color:rgb(248,248,248)"><span class="k" style="color:rgb(0,112,32); font-weight:bold">struct</span> <span class="n">capability</span> <span class="n">cap</span><span class="p">;</span>
<span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="n">VIDIOC_QUERYCAP</span><span class="p">,</span><span class="o" style="color:rgb(102,102,102)">&amp;</span><span class="n">cap</span><span class="p">)</span>
</pre> 
   </div> 
  </div> 
 </blockquote> 
 <ol class="arabic simple" start="3" style=""><li><strong>设置优先级(可选)</strong>.</li><li><a target="_blank" href="http://work-blog.readthedocs.org/en/latest/v4l2%20intro.html#id7" rel="nofollow noopener noreferrer" style="color:rgb(34,68,102)"><span class="problematic" id="id8">**</span></a>配置设备**。包括：</li></ol> 
 <blockquote> 
  <ul class="simple"><li>视频输入源的视频标准，VIDIOC_*_STD</li><li>视频数据的格式 , VIDIOC_*_FMT</li><li>视频输入端口, VIDIOC_*_INPUT</li><li>视频输出端口，VIDIOC_*_OUTPUT</li><li></ul> 
 </blockquote> 
 <ol class="arabic" start="5" style=""><li> <p class="first" style="margin-bottom:0.5em; margin-top:0px!important"><a target="_blank" href="http://work-blog.readthedocs.org/en/latest/v4l2%20intro.html#id9" rel="nofollow noopener noreferrer" style="color:rgb(34,68,102)"><span class="problematic" id="id10">**</span></a>启动设备开始I/O操作**。V4L2支持一下三种I/O方式：</p> 
   <ul class="simple"><li><a target="_blank" href="http://work-blog.readthedocs.org/en/latest/v4l2%20intro.html#id11" rel="nofollow noopener noreferrer" style="color:rgb(34,68,102)"><span class="problematic" id="id12">**</span></a>Read/Write**：通过调用设备节点文件的Read/Write函数，与设备交互数据。打开设备后，默认使用的是此方法。</li><li><a target="_blank" href="http://work-blog.readthedocs.org/en/latest/v4l2%20intro.html#id13" rel="nofollow noopener noreferrer" style="color:rgb(34,68,102)"><span class="problematic" id="id14">**</span></a>Stream I/O**：流操作，只传递数据缓冲区指针，不拷贝数据。使用此方法，需要调用VIDIOC_REQBUFS ioctl来通知设备。流操作I/O有两种方式memory map和user buffer。（具体区别后面章节介绍）</li><li><strong>overlay</strong> ： 也可以理解为memory to memory 传输。将数据从内存拷贝到显存中。overlay设备独有的。</li></ul> <p style="margin-top:0.8em; margin-bottom:0.5em">对于Capture device可以以如下方式启动设备：</p> 
   <ul class="simple"><li>调用VIDIOC_REQBUFS ioctl来分配缓冲区队列；</li><li>调用VIDIOC_STREAMON ioctl通知设备开始stream IO</li><li>调用VIDIOC_QBUF ioctl从设备获取一帧视频数据；</li><li>使用完数据后，调用VIDIOC_DQBUF将缓冲区还给设备，以便设备填充下一帧数据。</li></ul> </li><li> <p class="first" style="margin-bottom:0.5em; margin-top:0px!important"><strong>释放资源并关闭设备。</strong></p> </li></ol> 
</div> 
<div class="section" id="id15" style="font-family:'segoe UI',sans-serif; font-size:16px; letter-spacing:-0.159999996423721px; line-height:24px"> 
 <h3 style="margin:1.3em 0px 0.2em; font-size:1.35em; padding:0px">1.3、从驱动层看V4L2<a target="_blank" class="headerlink" href="http://work-blog.readthedocs.org/en/latest/v4l2%20intro.html#id15" rel="nofollow noopener noreferrer" title="Permalink to this headline" style="visibility:hidden; font-size:1em; margin-left:6px; padding:0px 4px; color:black!important"></a></h3> 
 <p style="margin-top:0.8em; margin-bottom:0.5em">在驱动层，V4L2为驱动编写者做了很多工作。只需要实现硬件相关的代码，并且注册相关设备即可。</p> 
 <p style="margin-top:0.8em; margin-bottom:0.5em">硬件相关代码的编写，除了编写具体硬件的控制代码外，最主要的就是将代码与V4L2框架绑定。绑定主要分为以下两个部分：</p> 
 <ul class="simple"><li>关系绑定：也就是要将我们自己的结构体，与V4L2框架中相关连的结构体绑定在一起。</li><li>iocontrol等函数绑定：将V4L2所定义的空的函数指针，与自己的函数绑定在一起。</li></ul> 
 <div class="section" id="id16"> 
  <h4 style="margin:1em 0px -0.3em; font-size:1.2em">3.1 关系绑定<a target="_blank" class="headerlink" href="http://work-blog.readthedocs.org/en/latest/v4l2%20intro.html#id16" rel="nofollow noopener noreferrer" title="Permalink to this headline" style="visibility:hidden; font-size:1em; margin-left:6px; padding:0px 4px; color:black!important"></a></h4> 
  <p style="margin-top:0.8em; margin-bottom:0.5em">提到关系绑定，就必须介绍下V4L2几个重要结构体。</p> 
  <ul class="simple"><li>struct video_device：主要的任务就是负责向内核注册字符设备</li><li>struct v4l2_device：一个硬件设备可能包含多个子设备，比如一个电视卡除了有capture设备，可能还有VBI设备或者FM tunner。而v4l2_device就是所有这些设备的根节点，负责管理所有的子设备。</li><li>struct v4l2_subdev：子设备，负责实现具体的功能。</li></ul> 
  <p style="margin-top:0.8em; margin-bottom:0.5em">v4l2_device,v4l2_subdev可以看作所有设备和子设备的基类。我们在编写自己的驱动时，往往需要继承这些设备基类，添加一些自己的数据成员。例如第三章要讲到的soc_camera_host结构体，就是继承v4l2_device，并添加了互斥锁、子设备列表等成员变量。</p> 
  <div class="figure" id="fig-v4l2intro"> 
   <img alt="_images/v4l2-intro.png" src="https://images2.imgbox.com/09/fa/ZwtaYQ78_o.png" style="border:0px; width:20cm"> 
   <p class="caption" style="margin-top:0.8em; margin-bottom:0.5em; text-align:inherit; padding-left:20px"> v4l2 framework 简略版</p> 
  </div> 
  <p style="margin-top:0.8em; margin-bottom:0.5em"><strong>绑定的基本流程</strong></p> 
  <ul><li> <p class="first" style="margin-bottom:0.5em; margin-top:0px!important">根据需要”重载”v4l2_device或v4l2_subdev结构体，添加需要的结构体成员。例如 ：</p> 
    <blockquote> 
     <ul><li> <p class="first" style="margin-bottom:0.5em; margin-top:0px!important">linux/include/media/soc_camera.h文件中soc_camera_host重载了v4l2_device：</p> 
       <blockquote> 
        <div class="highlight-c"> 
         <div class="highlight" style="background:rgb(238,255,204)"> 
          <pre style="overflow-x:auto; overflow-y:hidden; font-family:Consolas,'Deja Vu Sans Mono','Bitstream Vera Sans Mono',monospace; font-size:0.95em; letter-spacing:0.015em; line-height:18.2399997711182px; padding:0.5em; border:1px solid rgb(204,204,204); background-color:rgb(248,248,248)"><span class="k" style="color:rgb(0,112,32); font-weight:bold">struct</span> <span class="n">soc_camera_host</span> <span class="p">{<!-- --></span>
<span class="hll" style="background-color:rgb(255,255,204)"><span class="k" style="color:rgb(0,112,32); font-weight:bold">struct</span> <span class="n">v4l2_device</span> <span class="n">v4l2_dev</span><span class="p">;</span>
</span><span class="k" style="color:rgb(0,112,32); font-weight:bold">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
<span class="k" style="color:rgb(0,112,32); font-weight:bold">struct</span> <span class="n">mutex</span> <span class="n">host_lock</span><span class="p">;</span>         <span class="cm" style="color:rgb(64,128,144)">/* Protect during probing */</span>
<span class="kt" style="color:rgb(144,32,0)">unsigned</span> <span class="kt" style="color:rgb(144,32,0)">char</span> <span class="n">nr</span><span class="p">;</span>               <span class="cm" style="color:rgb(64,128,144)">/* Host number */</span>
<span class="kt" style="color:rgb(144,32,0)">void</span> <span class="o" style="color:rgb(102,102,102)">*</span><span class="n">priv</span><span class="p">;</span>
<span class="k" style="color:rgb(0,112,32); font-weight:bold">const</span> <span class="kt" style="color:rgb(144,32,0)">char</span> <span class="o" style="color:rgb(102,102,102)">*</span><span class="n">drv_name</span><span class="p">;</span>
<span class="k" style="color:rgb(0,112,32); font-weight:bold">struct</span> <span class="n">soc_camera_host_ops</span> <span class="o" style="color:rgb(102,102,102)">*</span><span class="n">ops</span><span class="p">;</span>
<span class="p">};</span>
</pre> 
         </div> 
        </div> 
       </blockquote> </li><li> <p class="first" style="margin-bottom:0.5em; margin-top:0px!important">linux/drivers/media/video/Ml86v7667.c中ml86v7667_priv结构体”重载”了v4l2_subdev：</p> 
       <blockquote> 
        <div class="highlight-c"> 
         <div class="highlight" style="background:rgb(238,255,204)"> 
          <pre style="overflow-x:auto; overflow-y:hidden; font-family:Consolas,'Deja Vu Sans Mono','Bitstream Vera Sans Mono',monospace; font-size:0.95em; letter-spacing:0.015em; line-height:18.2399997711182px; padding:0.5em; border:1px solid rgb(204,204,204); background-color:rgb(248,248,248)">  <span class="k" style="color:rgb(0,112,32); font-weight:bold">struct</span> <span class="n">ml86v7667_priv</span> <span class="p">{<!-- --></span>
<span class="hll" style="background-color:rgb(255,255,204)">      <span class="k" style="color:rgb(0,112,32); font-weight:bold">struct</span> <span class="n">v4l2_subdev</span>                <span class="n">sd</span><span class="p">;</span>
</span>      <span class="k" style="color:rgb(0,112,32); font-weight:bold">struct</span> <span class="n">v4l2_ctrl_handler</span>  <span class="n">hdl</span><span class="p">;</span>
      <span class="n">v4l2_std_id</span>                       <span class="n">std</span><span class="p">;</span>
  <span class="p">};</span>
</pre> 
         </div> 
        </div> 
       </blockquote> </li></ul> 
    </blockquote> </li><li> <p class="first" style="margin-bottom:0.5em; margin-top:0px!important">v4l2_device与V4L2框架的绑定：通过调用v4l2_device_register函数实现。例如，上面提到的soc_camera_host的绑定：</p> 
    <blockquote> 
     <div class="highlight-c"> 
      <div class="highlight" style="background:rgb(238,255,204)"> 
       <pre style="overflow-x:auto; overflow-y:hidden; font-family:Consolas,'Deja Vu Sans Mono','Bitstream Vera Sans Mono',monospace; font-size:0.95em; letter-spacing:0.015em; line-height:18.2399997711182px; padding:0.5em; border:1px solid rgb(204,204,204); background-color:rgb(248,248,248)"><span class="kt" style="color:rgb(144,32,0)">int</span> <span class="nf" style="color:rgb(6,40,126)">soc_camera_host_register</span><span class="p">(</span><span class="k" style="color:rgb(0,112,32); font-weight:bold">struct</span> <span class="n">soc_camera_host</span> <span class="o" style="color:rgb(102,102,102)">*</span><span class="n">ici</span><span class="p">)</span>
<span class="p">{<!-- --></span>
      <span class="k" style="color:rgb(0,112,32); font-weight:bold">struct</span> <span class="n">soc_camera_host</span> <span class="o" style="color:rgb(102,102,102)">*</span><span class="n">ix</span><span class="p">;</span>
      <span class="kt" style="color:rgb(144,32,0)">int</span> <span class="n">ret</span><span class="p">;</span>

      <span class="k" style="color:rgb(0,112,32); font-weight:bold">if</span> <span class="p">(</span><span class="o" style="color:rgb(102,102,102)">!</span><span class="n">ici</span> <span class="o" style="color:rgb(102,102,102)">||</span> <span class="o" style="color:rgb(102,102,102)">!</span><span class="n">ici</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">ops</span> <span class="o" style="color:rgb(102,102,102)">||</span>
        <span class="o" style="color:rgb(102,102,102)">!</span><span class="n">ici</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">ops</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">try_fmt</span> <span class="o" style="color:rgb(102,102,102)">||</span>
        <span class="o" style="color:rgb(102,102,102)">!</span><span class="n">ici</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">ops</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">set_fmt</span> <span class="o" style="color:rgb(102,102,102)">||</span>
        <span class="o" style="color:rgb(102,102,102)">!</span><span class="n">ici</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">ops</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">set_bus_param</span> <span class="o" style="color:rgb(102,102,102)">||</span>
        <span class="o" style="color:rgb(102,102,102)">!</span><span class="n">ici</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">ops</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">querycap</span> <span class="o" style="color:rgb(102,102,102)">||</span>
        <span class="p">((</span><span class="o" style="color:rgb(102,102,102)">!</span><span class="n">ici</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">ops</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">init_videobuf</span> <span class="o" style="color:rgb(102,102,102)">||</span>
        <span class="o" style="color:rgb(102,102,102)">!</span><span class="n">ici</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">ops</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">reqbufs</span><span class="p">)</span> <span class="o" style="color:rgb(102,102,102)">&amp;&amp;</span>
        <span class="o" style="color:rgb(102,102,102)">!</span><span class="n">ici</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">ops</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">init_videobuf2</span><span class="p">)</span> <span class="o" style="color:rgb(102,102,102)">||</span>
        <span class="o" style="color:rgb(102,102,102)">!</span><span class="n">ici</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">ops</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">add</span> <span class="o" style="color:rgb(102,102,102)">||</span>
        <span class="o" style="color:rgb(102,102,102)">!</span><span class="n">ici</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">ops</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">remove</span> <span class="o" style="color:rgb(102,102,102)">||</span>
        <span class="o" style="color:rgb(102,102,102)">!</span><span class="n">ici</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">ops</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">poll</span> <span class="o" style="color:rgb(102,102,102)">||</span>
        <span class="o" style="color:rgb(102,102,102)">!</span><span class="n">ici</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">)</span>
          <span class="k" style="color:rgb(0,112,32); font-weight:bold">return</span> <span class="o" style="color:rgb(102,102,102)">-</span><span class="n">EINVAL</span><span class="p">;</span>

      <span class="k" style="color:rgb(0,112,32); font-weight:bold">if</span> <span class="p">(</span><span class="o" style="color:rgb(102,102,102)">!</span><span class="n">ici</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">ops</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">set_crop</span><span class="p">)</span>
          <span class="n">ici</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">ops</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">set_crop</span> <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">default_s_crop</span><span class="p">;</span>
      <span class="k" style="color:rgb(0,112,32); font-weight:bold">if</span> <span class="p">(</span><span class="o" style="color:rgb(102,102,102)">!</span><span class="n">ici</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">ops</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">get_crop</span><span class="p">)</span>
          <span class="n">ici</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">ops</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">get_crop</span> <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">default_g_crop</span><span class="p">;</span>
      <span class="k" style="color:rgb(0,112,32); font-weight:bold">if</span> <span class="p">(</span><span class="o" style="color:rgb(102,102,102)">!</span><span class="n">ici</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">ops</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">cropcap</span><span class="p">)</span>
          <span class="n">ici</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">ops</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">cropcap</span> <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">default_cropcap</span><span class="p">;</span>
      <span class="k" style="color:rgb(0,112,32); font-weight:bold">if</span> <span class="p">(</span><span class="o" style="color:rgb(102,102,102)">!</span><span class="n">ici</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">ops</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">set_parm</span><span class="p">)</span>
          <span class="n">ici</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">ops</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">set_parm</span> <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">default_s_parm</span><span class="p">;</span>
      <span class="k" style="color:rgb(0,112,32); font-weight:bold">if</span> <span class="p">(</span><span class="o" style="color:rgb(102,102,102)">!</span><span class="n">ici</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">ops</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">get_parm</span><span class="p">)</span>
          <span class="n">ici</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">ops</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">get_parm</span> <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">default_g_parm</span><span class="p">;</span>
      <span class="k" style="color:rgb(0,112,32); font-weight:bold">if</span> <span class="p">(</span><span class="o" style="color:rgb(102,102,102)">!</span><span class="n">ici</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">ops</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">enum_fsizes</span><span class="p">)</span>
          <span class="n">ici</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">ops</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">enum_fsizes</span> <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">default_enum_fsizes</span><span class="p">;</span>

      <span class="n">mutex_lock</span><span class="p">(</span><span class="o" style="color:rgb(102,102,102)">&amp;</span><span class="n">list_lock</span><span class="p">);</span>
      <span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="o" style="color:rgb(102,102,102)">&amp;</span><span class="n">hosts</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{<!-- --></span>
          <span class="k" style="color:rgb(0,112,32); font-weight:bold">if</span> <span class="p">(</span><span class="n">ix</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">nr</span> <span class="o" style="color:rgb(102,102,102)">==</span> <span class="n">ici</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">nr</span><span class="p">)</span> <span class="p">{<!-- --></span>
              <span class="n">ret</span> <span class="o" style="color:rgb(102,102,102)">=</span> <span class="o" style="color:rgb(102,102,102)">-</span><span class="n">EBUSY</span><span class="p">;</span>
              <span class="k" style="color:rgb(0,112,32); font-weight:bold">goto</span> <span class="n">edevreg</span><span class="p">;</span>
          <span class="p">}</span>
      <span class="p">}</span>

<span class="hll" style="background-color:rgb(255,255,204)">      <span class="n">ret</span> <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">v4l2_device_register</span><span class="p">(</span><span class="n">ici</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="o" style="color:rgb(102,102,102)">&amp;</span><span class="n">ici</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
</span>      <span class="k" style="color:rgb(0,112,32); font-weight:bold">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o" style="color:rgb(102,102,102)">&lt;</span> <span class="mi" style="color:rgb(32,128,80)">0</span><span class="p">)</span>
          <span class="k" style="color:rgb(0,112,32); font-weight:bold">goto</span> <span class="n">edevreg</span><span class="p">;</span>

      <span class="n">list_add_tail</span><span class="p">(</span><span class="o" style="color:rgb(102,102,102)">&amp;</span><span class="n">ici</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o" style="color:rgb(102,102,102)">&amp;</span><span class="n">hosts</span><span class="p">);</span>
      <span class="n">mutex_unlock</span><span class="p">(</span><span class="o" style="color:rgb(102,102,102)">&amp;</span><span class="n">list_lock</span><span class="p">);</span>

      <span class="n">mutex_init</span><span class="p">(</span><span class="o" style="color:rgb(102,102,102)">&amp;</span><span class="n">ici</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
      <span class="n">scan_add_host</span><span class="p">(</span><span class="n">ici</span><span class="p">);</span>

      <span class="k" style="color:rgb(0,112,32); font-weight:bold">return</span> <span class="mi" style="color:rgb(32,128,80)">0</span><span class="p">;</span>

      <span class="nl" style="color:rgb(0,32,112); font-weight:bold">edevreg:</span>
      <span class="n">mutex_unlock</span><span class="p">(</span><span class="o" style="color:rgb(102,102,102)">&amp;</span><span class="n">list_lock</span><span class="p">);</span>
      <span class="k" style="color:rgb(0,112,32); font-weight:bold">return</span> <span class="n">ret</span><span class="p">;</span>
  <span class="p">}</span>
</pre> 
      </div> 
     </div> 
    </blockquote> </li><li> <p class="first" style="margin-bottom:0.5em; margin-top:0px!important">v4l2_subdev与v4l2_device的绑定：通过v4l2_device_register_subdev函数，将subdev注册到根节点上。例如：</p> 
    <blockquote> 
     <div class="highlight-c"> 
      <div class="highlight" style="background:rgb(238,255,204)"> 
       <pre style="overflow-x:auto; overflow-y:hidden; font-family:Consolas,'Deja Vu Sans Mono','Bitstream Vera Sans Mono',monospace; font-size:0.95em; letter-spacing:0.015em; line-height:18.2399997711182px; padding:0.5em; border:1px solid rgb(204,204,204); background-color:rgb(248,248,248)"><span class="k" style="color:rgb(0,112,32); font-weight:bold">static</span> <span class="kt" style="color:rgb(144,32,0)">int</span> <span class="nf" style="color:rgb(6,40,126)">soc_camera_platform_probe</span><span class="p">(</span><span class="k" style="color:rgb(0,112,32); font-weight:bold">struct</span> <span class="n">platform_device</span> <span class="o" style="color:rgb(102,102,102)">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{<!-- --></span>
    <span class="k" style="color:rgb(0,112,32); font-weight:bold">struct</span> <span class="n">soc_camera_host</span> <span class="o" style="color:rgb(102,102,102)">*</span><span class="n">ici</span><span class="p">;</span>
    <span class="k" style="color:rgb(0,112,32); font-weight:bold">struct</span> <span class="n">soc_camera_platform_priv</span> <span class="o" style="color:rgb(102,102,102)">*</span><span class="n">priv</span><span class="p">;</span>
    <span class="k" style="color:rgb(0,112,32); font-weight:bold">struct</span> <span class="n">soc_camera_platform_info</span> <span class="o" style="color:rgb(102,102,102)">*</span><span class="n">p</span> <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">pdev</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
    <span class="k" style="color:rgb(0,112,32); font-weight:bold">struct</span> <span class="n">soc_camera_device</span> <span class="o" style="color:rgb(102,102,102)">*</span><span class="n">icd</span><span class="p">;</span>
    <span class="kt" style="color:rgb(144,32,0)">int</span> <span class="n">ret</span><span class="p">;</span>

    <span class="k" style="color:rgb(0,112,32); font-weight:bold">if</span> <span class="p">(</span><span class="o" style="color:rgb(102,102,102)">!</span><span class="n">p</span><span class="p">)</span>
	<span class="k" style="color:rgb(0,112,32); font-weight:bold">return</span> <span class="o" style="color:rgb(102,102,102)">-</span><span class="n">EINVAL</span><span class="p">;</span>

    <span class="k" style="color:rgb(0,112,32); font-weight:bold">if</span> <span class="p">(</span><span class="o" style="color:rgb(102,102,102)">!</span><span class="n">p</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">icd</span><span class="p">)</span> <span class="p">{<!-- --></span>
	    <span class="n">dev_err</span><span class="p">(</span><span class="o" style="color:rgb(102,102,102)">&amp;</span><span class="n">pdev</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		    <span class="s" style="color:rgb(64,112,160)">"Platform has not set soc_camera_device pointer!</span><span class="se" style="color:rgb(64,112,160); font-weight:bold">\n</span><span class="s" style="color:rgb(64,112,160)">"</span><span class="p">);</span>
	    <span class="k" style="color:rgb(0,112,32); font-weight:bold">return</span> <span class="o" style="color:rgb(102,102,102)">-</span><span class="n">EINVAL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">priv</span> <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k" style="color:rgb(0,112,32); font-weight:bold">sizeof</span><span class="p">(</span><span class="o" style="color:rgb(102,102,102)">*</span><span class="n">priv</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
    <span class="k" style="color:rgb(0,112,32); font-weight:bold">if</span> <span class="p">(</span><span class="o" style="color:rgb(102,102,102)">!</span><span class="n">priv</span><span class="p">)</span>
	    <span class="k" style="color:rgb(0,112,32); font-weight:bold">return</span> <span class="o" style="color:rgb(102,102,102)">-</span><span class="n">ENOMEM</span><span class="p">;</span>

    <span class="n">icd</span> <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">p</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">icd</span><span class="p">;</span>

    <span class="cm" style="color:rgb(64,128,144)">/* soc-camera convention: control's drvdata points to the subdev */</span>
    <span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="o" style="color:rgb(102,102,102)">&amp;</span><span class="n">priv</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">subdev</span><span class="p">);</span>
    <span class="cm" style="color:rgb(64,128,144)">/* Set the control device reference */</span>
    <span class="n">icd</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">control</span> <span class="o" style="color:rgb(102,102,102)">=</span> <span class="o" style="color:rgb(102,102,102)">&amp;</span><span class="n">pdev</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">dev</span><span class="p">;</span>

    <span class="n">ici</span> <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">to_soc_camera_host</span><span class="p">(</span><span class="n">icd</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">parent</span><span class="p">);</span>

    <span class="n">v4l2_subdev_init</span><span class="p">(</span><span class="o" style="color:rgb(102,102,102)">&amp;</span><span class="n">priv</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">subdev</span><span class="p">,</span> <span class="o" style="color:rgb(102,102,102)">&amp;</span><span class="n">platform_subdev_ops</span><span class="p">);</span>
    <span class="n">v4l2_set_subdevdata</span><span class="p">(</span><span class="o" style="color:rgb(102,102,102)">&amp;</span><span class="n">priv</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">subdev</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
    <span class="n">strncpy</span><span class="p">(</span><span class="n">priv</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">subdev</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o" style="color:rgb(102,102,102)">&amp;</span><span class="n">pdev</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">V4L2_SUBDEV_NAME_SIZE</span><span class="p">);</span>

    <span class="n">ret</span> <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">v4l2_device_register_subdev</span><span class="p">(</span><span class="o" style="color:rgb(102,102,102)">&amp;</span><span class="n">ici</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="o" style="color:rgb(102,102,102)">&amp;</span><span class="n">priv</span><span class="o" style="color:rgb(102,102,102)">-&gt;</span><span class="n">subdev</span><span class="p">);</span>
    <span class="k" style="color:rgb(0,112,32); font-weight:bold">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
	    <span class="k" style="color:rgb(0,112,32); font-weight:bold">goto</span> <span class="n">evdrs</span><span class="p">;</span>

    <span class="k" style="color:rgb(0,112,32); font-weight:bold">return</span> <span class="n">ret</span><span class="p">;</span>

  <span class="nl" style="color:rgb(0,32,112); font-weight:bold">evdrs:</span>
    <span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb" style="color:rgb(0,112,32)">NULL</span><span class="p">);</span>
    <span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
    <span class="k" style="color:rgb(0,112,32); font-weight:bold">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</pre> 
      </div> 
     </div> 
    </blockquote> </li><li> <p class="first" style="margin-bottom:0.5em; margin-top:0px!important">video_device与v4l2_device的绑定：将v4l2_device的地址赋值给video_device的v4l2_dev即可。</p> </li></ul> 
  <div class="imagebox" style="min-height:25px; border:1px solid rgb(119,119,119); padding:4px 4px 4px 40px; margin:5px; font-size:14px; background-color:rgb(238,238,238)">
    此步不一定必要。只要有办法通过文件节点file(struct file)找到v4l2_device即可。 
  </div> 
 </div> 
 <div class="section" id="id17"> 
  <h4 style="margin:1em 0px -0.3em; font-size:1.2em">3.2 函数绑定<a target="_blank" class="headerlink" href="http://work-blog.readthedocs.org/en/latest/v4l2%20intro.html#id17" rel="nofollow noopener noreferrer" title="Permalink to this headline" style="visibility:hidden; font-size:1em; margin-left:6px; padding:0px 4px; color:black!important"></a></h4> 
  <p style="margin-top:0.8em; margin-bottom:0.5em">在<a target="_blank" class="reference internal" href="http://work-blog.readthedocs.org/en/latest/v4l2%20intro.html#fig-v4l2intro" rel="nofollow noopener noreferrer" style="color:rgb(34,68,102)">v4l2 framework 简略版</a>图中，绿色的方框都是需要我们绑定并实现的。</p> 
  <p style="margin-top:0.8em; margin-bottom:0.5em">其中v4l2_file_operations和v4l2_ioctl_ops是必须实现的。而v4l2_subdev_ops下的八类ops中，v4l2_subdev_core_ops是必须实现的，其余需要根据设备类型选择实现的。比如video capture类设备需要实现v4l2_subdev_core_ops, v4l2_subdev_video_ops。</p> 
  <ul class="simple"><li>v4l2_file_operations：实现文件类操作，比如open,close,read,write,mmap等。但是ioctl是不需要实现的，一般都是用video_ioctl2代替。例如linux/drivers/media/video/soc_camera.c文件中soc_camera_fops的实现：</li></ul> 
  <div class="highlight-c"> 
   <div class="highlight" style="background:rgb(238,255,204)"> 
    <pre style="overflow-x:auto; overflow-y:hidden; font-family:Consolas,'Deja Vu Sans Mono','Bitstream Vera Sans Mono',monospace; font-size:0.95em; letter-spacing:0.015em; line-height:18.2399997711182px; padding:0.5em; border:1px solid rgb(204,204,204); background-color:rgb(248,248,248)"><span class="k" style="color:rgb(0,112,32); font-weight:bold">static</span> <span class="k" style="color:rgb(0,112,32); font-weight:bold">struct</span> <span class="n">v4l2_file_operations</span> <span class="n">soc_camera_fops</span> <span class="o" style="color:rgb(102,102,102)">=</span> <span class="p">{<!-- --></span>
    <span class="p">.</span><span class="n">owner</span>          <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
    <span class="p">.</span><span class="n">open</span>           <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">soc_camera_open</span><span class="p">,</span>
    <span class="p">.</span><span class="n">release</span>        <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">soc_camera_close</span><span class="p">,</span>
<span class="hll" style="background-color:rgb(255,255,204)">    <span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">video_ioctl2</span><span class="p">,</span>
</span>    <span class="p">.</span><span class="n">read</span>           <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">soc_camera_read</span><span class="p">,</span>
    <span class="p">.</span><span class="n">mmap</span>           <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">soc_camera_mmap</span><span class="p">,</span>
    <span class="p">.</span><span class="n">poll</span>           <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">soc_camera_poll</span><span class="p">,</span>
<span class="p">};</span>
</pre> 
   </div> 
  </div> 
  <ul class="simple"><li>v4l2_ioctl_ops：V4L2导出给应用层使用的所有ioctl都是在这个地方实现的。但不必全部实现，只实现自己相关的ioctl即可。例如linux/drivers/media/video/soc_camera.c中soc_camera_ioctl_ops的实现：</li></ul> 
  <div class="highlight-c"> 
   <div class="highlight" style="background:rgb(238,255,204)"> 
    <pre style="overflow-x:auto; overflow-y:hidden; font-family:Consolas,'Deja Vu Sans Mono','Bitstream Vera Sans Mono',monospace; font-size:0.95em; letter-spacing:0.015em; line-height:18.2399997711182px; padding:0.5em; border:1px solid rgb(204,204,204); background-color:rgb(248,248,248)"><span class="k" style="color:rgb(0,112,32); font-weight:bold">static</span> <span class="k" style="color:rgb(0,112,32); font-weight:bold">const</span> <span class="k" style="color:rgb(0,112,32); font-weight:bold">struct</span> <span class="n">v4l2_ioctl_ops</span> <span class="n">soc_camera_ioctl_ops</span> <span class="o" style="color:rgb(102,102,102)">=</span> <span class="p">{<!-- --></span>
    <span class="p">.</span><span class="n">vidioc_querycap</span>         <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">soc_camera_querycap</span><span class="p">,</span>
    <span class="p">.</span><span class="n">vidioc_try_fmt_vid_cap</span>  <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">soc_camera_try_fmt_vid_cap</span><span class="p">,</span>
    <span class="p">.</span><span class="n">vidioc_g_fmt_vid_cap</span>    <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">soc_camera_g_fmt_vid_cap</span><span class="p">,</span>
    <span class="p">.</span><span class="n">vidioc_s_fmt_vid_cap</span>    <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">soc_camera_s_fmt_vid_cap</span><span class="p">,</span>
    <span class="p">.</span><span class="n">vidioc_enum_fmt_vid_cap</span> <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">soc_camera_enum_fmt_vid_cap</span><span class="p">,</span>
    <span class="p">.</span><span class="n">vidioc_enum_input</span>       <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">soc_camera_enum_input</span><span class="p">,</span>
    <span class="p">.</span><span class="n">vidioc_g_input</span>          <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">soc_camera_g_input</span><span class="p">,</span>
    <span class="p">.</span><span class="n">vidioc_s_input</span>          <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">soc_camera_s_input</span><span class="p">,</span>
    <span class="p">.</span><span class="n">vidioc_s_std</span>            <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">soc_camera_s_std</span><span class="p">,</span>
    <span class="p">.</span><span class="n">vidioc_g_std</span>            <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">soc_camera_g_std</span><span class="p">,</span>
    <span class="p">.</span><span class="n">vidioc_enum_framesizes</span>  <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">soc_camera_enum_fsizes</span><span class="p">,</span>
    <span class="p">.</span><span class="n">vidioc_reqbufs</span>          <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">soc_camera_reqbufs</span><span class="p">,</span>
    <span class="p">.</span><span class="n">vidioc_querybuf</span>         <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">soc_camera_querybuf</span><span class="p">,</span>
    <span class="p">.</span><span class="n">vidioc_qbuf</span>             <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">soc_camera_qbuf</span><span class="p">,</span>
    <span class="p">.</span><span class="n">vidioc_dqbuf</span>            <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">soc_camera_dqbuf</span><span class="p">,</span>
    <span class="p">.</span><span class="n">vidioc_create_bufs</span>      <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">soc_camera_create_bufs</span><span class="p">,</span>
    <span class="p">.</span><span class="n">vidioc_prepare_buf</span>      <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">soc_camera_prepare_buf</span><span class="p">,</span>
    <span class="p">.</span><span class="n">vidioc_streamon</span>         <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">soc_camera_streamon</span><span class="p">,</span>
    <span class="p">.</span><span class="n">vidioc_streamoff</span>        <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">soc_camera_streamoff</span><span class="p">,</span>
    <span class="p">.</span><span class="n">vidioc_cropcap</span>          <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">soc_camera_cropcap</span><span class="p">,</span>
    <span class="p">.</span><span class="n">vidioc_g_crop</span>           <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">soc_camera_g_crop</span><span class="p">,</span>
    <span class="p">.</span><span class="n">vidioc_s_crop</span>           <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">soc_camera_s_crop</span><span class="p">,</span>
    <span class="p">.</span><span class="n">vidioc_g_parm</span>           <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">soc_camera_g_parm</span><span class="p">,</span>
    <span class="p">.</span><span class="n">vidioc_s_parm</span>           <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">soc_camera_s_parm</span><span class="p">,</span>
    <span class="p">.</span><span class="n">vidioc_g_chip_ident</span>     <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">soc_camera_g_chip_ident</span><span class="p">,</span>
<span class="cp" style="color:rgb(0,112,32)">#ifdef CONFIG_VIDEO_ADV_DEBUG</span>
    <span class="p">.</span><span class="n">vidioc_g_register</span>       <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">soc_camera_g_register</span><span class="p">,</span>
    <span class="p">.</span><span class="n">vidioc_s_register</span>       <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">soc_camera_s_register</span><span class="p">,</span>
<span class="cp" style="color:rgb(0,112,32)">#endif</span>
<span class="p">};</span>
</pre> 
   </div> 
  </div> 
  <ul><li> 
    <dl class="first docutils" style="margin-bottom:15px; margin-top:0px!important"> 
     
       v4l2_subdev_ops：v4l2_subdev有可能需要实现的ops的总合。分为8类，core,audio,video,vbi,tuner......等。例如， 
      
     <dd style="margin-top:3px; margin-bottom:10px; margin-left:30px"> 
      <p class="first last" style="margin-bottom:0.5em; margin-top:0px!important">linuxdriversmediavideosoc_camera_platform.c中platform_subdev_ops的实现</p> 
     </dd> 
    </dl> </li></ul> 
  <div class="highlight-c"> 
   <div class="highlight" style="background:rgb(238,255,204)"> 
    <pre style="overflow-x:auto; overflow-y:hidden; font-family:Consolas,'Deja Vu Sans Mono','Bitstream Vera Sans Mono',monospace; font-size:0.95em; letter-spacing:0.015em; line-height:18.2399997711182px; padding:0.5em; border:1px solid rgb(204,204,204); background-color:rgb(248,248,248)"><span class="k" style="color:rgb(0,112,32); font-weight:bold">static</span> <span class="k" style="color:rgb(0,112,32); font-weight:bold">struct</span> <span class="n">v4l2_subdev_video_ops</span> <span class="n">platform_subdev_video_ops</span> <span class="o" style="color:rgb(102,102,102)">=</span> <span class="p">{<!-- --></span>
    <span class="p">.</span><span class="n">s_stream</span>       <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">soc_camera_platform_s_stream</span><span class="p">,</span>
    <span class="p">.</span><span class="n">enum_mbus_fmt</span>  <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">soc_camera_platform_enum_fmt</span><span class="p">,</span>
    <span class="p">.</span><span class="n">cropcap</span>        <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">soc_camera_platform_cropcap</span><span class="p">,</span>
    <span class="p">.</span><span class="n">g_crop</span>         <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">soc_camera_platform_g_crop</span><span class="p">,</span>
    <span class="p">.</span><span class="n">try_mbus_fmt</span>   <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">soc_camera_platform_fill_fmt</span><span class="p">,</span>
    <span class="p">.</span><span class="n">g_mbus_fmt</span>     <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">soc_camera_platform_fill_fmt</span><span class="p">,</span>
    <span class="p">.</span><span class="n">s_mbus_fmt</span>     <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">soc_camera_platform_fill_fmt</span><span class="p">,</span>
    <span class="p">.</span><span class="n">g_mbus_config</span>  <span class="o" style="color:rgb(102,102,102)">=</span> <span class="n">soc_camera_platform_g_mbus_config</span><span class="p">,</span>
<span class="p">};</span>

<span class="k" style="color:rgb(0,112,32); font-weight:bold">static</span> <span class="k" style="color:rgb(0,112,32); font-weight:bold">struct</span> <span class="n">v4l2_subdev_ops</span> <span class="n">platform_subdev_ops</span> <span class="o" style="color:rgb(102,102,102)">=</span> <span class="p">{<!-- --></span>
    <span class="p">.</span><span class="n">core</span>   <span class="o" style="color:rgb(102,102,102)">=</span> <span class="o" style="color:rgb(102,102,102)">&amp;</span><span class="n">platform_subdev_core_ops</span><span class="p">,</span>
    <span class="p">.</span><span class="n">video</span>  <span class="o" style="color:rgb(102,102,102)">=</span> <span class="o" style="color:rgb(102,102,102)">&amp;</span><span class="n">platform_subdev_video_ops</span><span class="p">,</span>
<span class="p">};</span>
</pre> 
   </div> 
  </div> 
  <p style="margin-top:0.8em; margin-bottom:0.5em">函数绑定只是将驱动所实现的函数赋值给相关的变量即可。</p> 
 </div> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4b08361bdbbad8535f14f4c1280bf979/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">H5之js拼接select与input的级联</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0aa38b513641ad167cd63050ea3cc4a5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【iOS】AVFoundation架构下的原生二维码和条形码扫描</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>