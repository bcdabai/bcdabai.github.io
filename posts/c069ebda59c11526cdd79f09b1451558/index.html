<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【C&#43;&#43;】基于多设计模式下的同步&amp;异步日志系统 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【C&#43;&#43;】基于多设计模式下的同步&amp;异步日志系统" />
<meta property="og:description" content="✍作者：阿润021
📖专栏：C&#43;&#43;
文章目录 一、项目介绍二、项目实现准备工作1.日志系统技术实现策略2.相关技术知识补充2.1 不定参函数设计2.2 设计模式 三、日志项目框架设计1.模块划分2.各模块关系图 四、详细代码实现1.实用工具类设计2.日志等级类设计3.日志消息类设计4.日志输出格式化模块5.日志落地模块(简单工厂模式)6.日志器类(Logger)设计（建造者模式）7. 双缓冲区异步任务处理器（AsyncLooper）设计8.异步日志器(AsyncLogger)设计9.单例日志器管理类设计（单例模式）10.日志宏&amp;全局接口设计（代理模式） 五、项目测试参考资料 一、项目介绍 简介
本项目主要实现一个日志系统，它可以根据不同的级别、配置和策略，以同步或异步的方式，将日志信息可靠地写入控制台文件或滚动文件中，同时支持多线程并发写日志和扩展不同的日志落地目标地模式。
开发环境：
• CentOS 7
• vscode/vim
• g&#43;&#43;/gdb
• Makefile
核心技术
1.类层次设计：如继承和多态的应用
2.C&#43;&#43;11：如多线程、auto、智能指针、右值引⽤等
3. 双缓冲区设计：实现异步日志器
4. 生产消费模型：
5. 多线程：实现并发输出日志
6. 设计模式：单例日志管理器类设计、⼯⼚模式、代理模式、模板等
环境搭建
本项目不依赖其他任何第三⽅库， 只需要安装好CentOS/Ubuntu &#43; vscode/vim环境即可开发。
测试结果展示：
为什么需要日志系统？
• 生产环境的产品为了保证其稳定性及安全性是不允许开发⼈员附加调试器去排查问题， 可以借助日志志系统来打印⼀些日志帮助开发⼈员解决问题
• 上线客户端的产品出现bug无法复现并解决， 可以借助⽇志系统打印⽇志并上传到服务端帮助开发⼈员进⾏分析
• 对于⼀些⾼频操作（如定时器、心跳包）在少量调试次数下可能⽆法触发我们想要的⾏为，通过断点的暂停⽅式，我们不得不重复操作⼏⼗次、上百次甚⾄更多，导致排查问题效率是⾮常低下， 可以借助打印⽇志的⽅式查问题
• 在分布式、多线程/多进程代码中， 出现bug⽐较难以定位， 可以借助⽇志系统打印log帮助定位bug
• 帮助首次接触项目代码的新开发人员理解代码的运⾏流程
二、项目实现准备工作 1.日志系统技术实现策略 日志系统的技术实现主要包括三种类型:
利用printf、std::cout等输出函数将⽇志信息打印到控制台
对于⼤型商业化项目， 为了放便排查问题，我们⼀般会将⽇志输出到⽂件或者是数据库系统⽅便查询和分析日志， 主要分为同步日志和异步日志方式:
1&gt; 同步写日志
2&gt; 异步写日志
同步写日志
同步⽇志是指当输出⽇志时，必须等待⽇志输出语句执⾏完毕后，才能执⾏后⾯的业务逻辑语句，⽇志输出语句与程序的业务逻辑语句将在同⼀个线程运⾏。每次调⽤⼀次打印⽇志API就对应⼀次系统调⽤write写⽇志⽂件。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/c069ebda59c11526cdd79f09b1451558/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-02T17:42:07+08:00" />
<meta property="article:modified_time" content="2023-08-02T17:42:07+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【C&#43;&#43;】基于多设计模式下的同步&amp;异步日志系统</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>✍<strong>作者</strong>：<a href="https://blog.csdn.net/weixin_62676865?spm=1011.2415.3001.5343"><strong>阿润021</strong></a><br> 📖<strong>专栏</strong>：<a href="https://blog.csdn.net/weixin_62676865/category_12161651.html?spm=1001.2014.3001.5482"><strong>C++</strong></a></p> 
</blockquote> 
<hr> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_5" rel="nofollow">一、项目介绍</a></li><li><a href="#_41" rel="nofollow">二、项目实现准备工作</a></li><li><ul><li><a href="#1_42" rel="nofollow">1.日志系统技术实现策略</a></li><li><a href="#2_64" rel="nofollow">2.相关技术知识补充</a></li><li><ul><li><a href="#21__65" rel="nofollow">2.1 不定参函数设计</a></li><li><a href="#22__116" rel="nofollow">2.2 设计模式</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_529" rel="nofollow">三、日志项目框架设计</a></li><li><ul><li><a href="#1_533" rel="nofollow">1.模块划分</a></li><li><a href="#2_582" rel="nofollow">2.各模块关系图</a></li></ul> 
  </li><li><a href="#_585" rel="nofollow">四、详细代码实现</a></li><li><ul><li><a href="#1_588" rel="nofollow">1.实用工具类设计</a></li><li><a href="#2_673" rel="nofollow">2.日志等级类设计</a></li><li><a href="#3_727" rel="nofollow">3.日志消息类设计</a></li><li><a href="#4_775" rel="nofollow">4.日志输出格式化模块</a></li><li><a href="#5_1052" rel="nofollow">5.日志落地模块(简单工厂模式)</a></li><li><a href="#6Logger_1178" rel="nofollow">6.日志器类(Logger)设计（建造者模式）</a></li><li><a href="#7_AsyncLooper_1543" rel="nofollow">7. 双缓冲区异步任务处理器（AsyncLooper）设计</a></li><li><a href="#8AsyncLogger_1709" rel="nofollow">8.异步日志器(AsyncLogger)设计</a></li><li><a href="#9_1747" rel="nofollow">9.单例日志器管理类设计（单例模式）</a></li><li><a href="#10_1831" rel="nofollow">10.日志宏&amp;全局接口设计（代理模式）</a></li></ul> 
  </li><li><a href="#_1866" rel="nofollow">五、项目测试</a></li><li><a href="#_1908" rel="nofollow">参考资料</a></li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="_5"></a>一、项目介绍</h2> 
<blockquote> 
 <p>简介</p> 
</blockquote> 
<p>本项目主要实现一个日志系统，它可以根据不同的级别、配置和策略，以同步或异步的方式，将日志信息可靠地写入控制台文件或滚动文件中，同时支持多线程并发写日志和扩展不同的日志落地目标地模式。</p> 
<blockquote> 
 <p><strong>开发环境</strong>：<br> • CentOS 7<br> • vscode/vim<br> • g++/gdb<br> • Makefile</p> 
</blockquote> 
<blockquote> 
 <p>核心技术</p> 
</blockquote> 
<p>1.类层次设计：如继承和多态的应用<br> 2.C++11：如多线程、auto、智能指针、右值引⽤等<br> 3. 双缓冲区设计：实现异步日志器<br> 4. 生产消费模型：<br> 5. 多线程：实现并发输出日志<br> 6. 设计模式：单例日志管理器类设计、⼯⼚模式、代理模式、模板等</p> 
<blockquote> 
 <p>环境搭建</p> 
</blockquote> 
<p>本项目不依赖其他任何第三⽅库， 只需要安装好CentOS/Ubuntu + vscode/vim环境即可开发。<br> <strong>测试结果展示：</strong><br> <img src="https://images2.imgbox.com/c1/a3/UAhmyinr_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p><strong>为什么需要日志系统？</strong></p> 
</blockquote> 
<p>• 生产环境的产品为了保证其稳定性及安全性是不允许开发⼈员附加调试器去排查问题， 可以借助日志志系统来打印⼀些日志帮助开发⼈员解决问题</p> 
<p>• 上线客户端的产品出现bug无法复现并解决， 可以借助⽇志系统打印⽇志并上传到服务端帮助开发⼈员进⾏分析</p> 
<p>• 对于⼀些⾼频操作（如定时器、心跳包）在少量调试次数下可能⽆法触发我们想要的⾏为，通过断点的暂停⽅式，我们不得不重复操作⼏⼗次、上百次甚⾄更多，导致排查问题效率是⾮常低下， 可以借助打印⽇志的⽅式查问题</p> 
<p>• 在分布式、多线程/多进程代码中， 出现bug⽐较难以定位， 可以借助⽇志系统打印log帮助定位bug</p> 
<p>• 帮助首次接触项目代码的新开发人员理解代码的运⾏流程</p> 
<h2><a id="_41"></a>二、项目实现准备工作</h2> 
<h3><a id="1_42"></a>1.日志系统技术实现策略</h3> 
<p><mark>日志系统的技术实现主要包括三种类型</mark>:</p> 
<ol><li> <p>利用printf、std::cout等输出函数将⽇志信息打印到控制台</p> </li><li> <p>对于⼤型商业化项目， 为了放便排查问题，我们⼀般会将⽇志输出到⽂件或者是数据库系统⽅便查询和分析日志， 主要分为同步日志和异步日志方式:<br> 1&gt; 同步写日志<br> 2&gt; 异步写日志</p> </li></ol> 
<blockquote> 
 <p><strong>同步写日志</strong></p> 
</blockquote> 
<p>同步⽇志是指当输出⽇志时，必须等待⽇志输出语句执⾏完毕后，才能执⾏后⾯的业务逻辑语句，⽇志输出语句与程序的业务逻辑语句将在同⼀个线程运⾏。每次调⽤⼀次打印⽇志API就对应⼀次系统调⽤write写⽇志⽂件。<br> <img src="https://images2.imgbox.com/19/18/HLbOxaOc_o.png" alt="在这里插入图片描述"><br> 但是在⾼并发场景下，随着⽇志数量不断增加，同步⽇志系统容易产⽣系统瓶颈：<br> • ⼀⽅⾯，⼤量的⽇志打印陷⼊等量的write系统调⽤，有⼀定系统开销.<br> • 另⼀⽅⾯，使得打印⽇志的进程附带了⼤量同步的磁盘IO，影响程序性能</p> 
<blockquote> 
 <p><strong>异步写日志</strong></p> 
</blockquote> 
<p>异步日志是指在进行日志输出时，日志输出语句与业务逻辑语句并不是在同⼀个线程中运⾏，而是有专⻔的线程⽤于进行日志输出操作。业务线程只需要将⽇志放到⼀个内存缓冲区中不用等待即可继续执执后续业务逻辑（作为日志的生产者），而日志的落地操作交给单独的日志线程去完成（作为日志的消费者）, 这是⼀个典型的生产-消费模型。<br> <img src="https://images2.imgbox.com/b0/40/9i5yxuTK_o.png" alt="在这里插入图片描述"><br> 这样做的好处是即使⽇志没有真的地完成输出也不会影响程序的主业务，可以提⾼程序的性能：<br> • 主线程调⽤⽇志打印接⼝成为⾮阻塞操作<br> • 同步的磁盘IO从主线程中剥离出来交给单独的线程完成</p> 
<h3><a id="2_64"></a>2.相关技术知识补充</h3> 
<h4><a id="21__65"></a>2.1 不定参函数设计</h4> 
<p>在初学C语⾔的时候，我们都⽤过printf函数进⾏打印。其中printf函数就是⼀个不定参函数，在函数内部可以根据格式化字符串中格式化字符分别获取不同的参数进⾏数据的格式化。<br> 而这种不定参函数在实际的使⽤中也⾮常多⻅，在这⾥简单做⼀介绍：</p> 
<p><strong>C⻛格不定参函数</strong></p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdarg&gt;</span></span>
<span class="token keyword">void</span> <span class="token function">printNum</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 va_list al<span class="token punctuation">;</span>
 <span class="token function">va_start</span><span class="token punctuation">(</span>al<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//让al指向n参数之后的第⼀个可变参数</span>
 <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token function">va_arg</span><span class="token punctuation">(</span>al<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//从可变参数中取出⼀个整形参数</span>
 std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> num <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token function">va_end</span><span class="token punctuation">(</span>al<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//清空可变参数列表--其实是将al置空</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
 <span class="token function">printNum</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span><span class="token number">22</span><span class="token punctuation">,</span><span class="token number">33</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">printNum</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">44</span><span class="token punctuation">,</span><span class="token number">55</span><span class="token punctuation">,</span><span class="token number">66</span><span class="token punctuation">,</span><span class="token number">77</span><span class="token punctuation">,</span><span class="token number">88</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>C++⻛格不定参函数</strong></p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdarg&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;functional&gt;</span></span>
<span class="token keyword">void</span> <span class="token function">xprintf</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>Args<span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token function">xprintf</span><span class="token punctuation">(</span><span class="token keyword">const</span> T <span class="token operator">&amp;</span>value<span class="token punctuation">,</span> Args <span class="token operator">&amp;&amp;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> value <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token function">xprintf</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>Args<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
 <span class="token function">xprintf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
 <span class="token function">xprintf</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">xprintf</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">,</span> <span class="token number">666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">xprintf</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">,</span> <span class="token string">"法外狂徒"</span><span class="token punctuation">,</span> <span class="token number">666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="22__116"></a>2.2 设计模式</h4> 
<p>设计模式是前辈们对代码开发经验的总结，是解决特定问题的⼀系列套路。它不是语法规定，⽽是⼀套⽤来提⾼代码可复⽤性、可维护性、可读性、稳健性以及安全性的解决⽅案。</p> 
<blockquote> 
 <p><strong>六大原则：</strong><br> 从整体上来理解六⼤设计原则，可以简要的概括为⼀句话，⽤抽象构建框架，⽤实现扩展细节，具体到每⼀条设计原则，则对应⼀条注意事项：<br> • 单⼀职责原则告诉我们实现类要职责单⼀；<br> • ⾥⽒替换原则告诉我们不要破坏继承体系；<br> • 依赖倒置原则告诉我们要⾯向接⼝编程；<br> • 接⼝隔离原则告诉我们在设计接⼝的时候要精简单⼀；<br> • 迪⽶特法则告诉我们要降低耦合；<br> • 开闭原则是总纲，告诉我们要对扩展开放，对修改关闭</p> 
</blockquote> 
<blockquote> 
 <p><strong>单例模式</strong></p> 
</blockquote> 
<p>⼀个类只能创建⼀个对象，即单例模式，该设计模式可以保证系统中该类只有⼀个实例，并提供⼀个访问它的全局访问点，该实例被所有程序模块共享。⽐如在某个服务器程序中，该服务器的配置信息存放在⼀个⽂件中，这些配置数据由⼀个单例对象统⼀读取，然后服务进程中的其他对象再通过这个单例对象获取这些配置信息，这种⽅式简化了在复杂环境下的配置管理。<br> <mark>单例模式有两种实现模式：饿汉模式和懒汉模式</mark></p> 
<p>• 饿汉模式: 程序启动时就会创建⼀个唯⼀的实例对象。 因为单例对象已经确定， 所以⽐较适⽤于多线程环境中， 多线程获取单例对象不需要加锁， 可以有效的避免资源竞争， 提⾼性能。</p> 
<pre><code class="prism language-cpp"><span class="token comment">// 饿汉模式</span>
<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">private</span><span class="token operator">:</span>
 <span class="token keyword">static</span> Singleton _eton<span class="token punctuation">;</span>
<span class="token keyword">private</span><span class="token operator">:</span>
 <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
 <span class="token operator">~</span><span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token keyword">public</span><span class="token operator">:</span>
 <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token keyword">const</span> Singleton<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
 Singleton<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> Singleton<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
 <span class="token keyword">static</span> T<span class="token operator">&amp;</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
 <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">return</span> _eton<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
Singleton Singleton<span class="token double-colon punctuation">::</span>_eton<span class="token punctuation">;</span>
</code></pre> 
<p>懒汉模式:第⼀次使⽤要使⽤单例对象的时候创建实例对象。如果单例对象构造特别耗时或者耗费济源(加载插件、加载⽹络资源等)， 可以选择懒汉模式， 在第⼀次使⽤的时候才创建对象。</p> 
<p>注：这里介绍的是《Effective C++》⼀书作者 Scott Meyers 提出的⼀种更加优雅简便的单例模式</p> 
<pre><code class="prism language-cpp"><span class="token comment">// 懒汉模式</span>
<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span> 
<span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">{<!-- --></span> 
<span class="token keyword">private</span><span class="token operator">:</span>
 <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
 <span class="token operator">~</span><span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token keyword">public</span><span class="token operator">:</span> 
 <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token keyword">const</span> Singleton<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
 Singleton<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> Singleton<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
 <span class="token keyword">static</span> T<span class="token operator">&amp;</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
 <span class="token punctuation">{<!-- --></span> 
 <span class="token keyword">static</span> Singleton _eton<span class="token punctuation">;</span>
 <span class="token keyword">return</span> _eton<span class="token punctuation">;</span> 
 <span class="token punctuation">}</span> 
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p><strong>⼯⼚模式</strong><br> ⼯⼚模式是⼀种创建型设计模式， 它提供了⼀种创建对象的最佳⽅式。在⼯⼚模式中，我们创建对象时不会对上层暴露创建逻辑，⽽是通过使⽤⼀个共同结构来指向新创建的对象，以此实现创建-使⽤的分离。</p> 
</blockquote> 
<p><mark>工厂模式可以分为: 简单工厂模式、 ⼯⼚⽅法模式、抽象⼯⼚模式</mark></p> 
<p><strong>简单⼯⼚模式</strong>: 简单⼯⼚模式实现由⼀个⼯⼚对象通过类型决定创建出来指定产品类的实例。假设有个⼯⼚能⽣产出⽔果，当客⼾需要产品的时候明确告知⼯⼚⽣产哪类⽔果，⼯⼚需要接收⽤⼾提供的类别信息，当新增产品的时候，⼯⼚内部去添加新产品的⽣产⽅式。</p> 
<pre><code class="prism language-cpp"><span class="token comment">//简单⼯⼚模式：通过参数控制可以⽣产任何产品</span>
<span class="token comment">// 优点：简单粗暴，直观易懂。使⽤⼀个⼯⼚⽣产同⼀等级结构下的任意产品</span>
<span class="token comment">// 缺点：</span>
<span class="token comment">// 1. 所有东西⽣产在⼀起，产品太多会导致代码量庞⼤</span>
<span class="token comment">// 2. 开闭原则遵循(开放拓展，关闭修改)的不是太好，要新增产品就必须修改⼯⼚⽅法。</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>
<span class="token keyword">class</span> <span class="token class-name">Fruit</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
 <span class="token function">Fruit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
 <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Apple</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Fruit</span></span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
 <span class="token function">Apple</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
 <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"我是⼀个苹果"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Banana</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Fruit</span></span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
 <span class="token function">Banana</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
 <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"我是⼀个⾹蕉"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">FruitFactory</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
 <span class="token keyword">static</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Fruit<span class="token operator">&gt;</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">==</span> <span class="token string">"苹果"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>Apple<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>name <span class="token operator">==</span> <span class="token string">"⾹蕉"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>Banana<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">shared_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>Fruit<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
 std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Fruit<span class="token operator">&gt;</span> fruit <span class="token operator">=</span> <span class="token class-name">FruitFactory</span><span class="token double-colon punctuation">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"苹果"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 fruit<span class="token operator">-&gt;</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 fruit <span class="token operator">=</span> <span class="token class-name">FruitFactory</span><span class="token double-colon punctuation">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"⾹蕉"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 fruit<span class="token operator">-&gt;</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这个模式的结构和管理产品对象的⽅式⼗分简单， 但是它的扩展性⾮常差，当我们需要新增产品的时候，就需要去修改⼯⼚类新增⼀个类型的产品创建逻辑，违背了开闭原则。</p> 
<p><strong>⼯⼚⽅法模式</strong>: 在简单⼯⼚模式下新增多个⼯⼚，多个产品，每个产品对应⼀个⼯⼚。假设现在有A、B 两种产品，则开两个⼯⼚，⼯⼚ A 负责⽣产产品 A，⼯⼚ B 负责⽣产产品 B，⽤⼾只知道产品的⼯⼚名，⽽不知道具体的产品信息，⼯⼚不需要再接收客⼾的产品类别，⽽只负责⽣产产品。</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>
<span class="token comment">//⼯⼚⽅法：定义⼀个创建对象的接⼝，但是由⼦类来决定创建哪种对象，使⽤多个⼯⼚分别⽣产指定</span>
的固定产品
<span class="token comment">// 优点： </span>
<span class="token comment">// 1. 减轻了⼯⼚类的负担，将某类产品的⽣产交给指定的⼯⼚来进⾏</span>
<span class="token comment">// 2. 开闭原则遵循较好，添加新产品只需要新增产品的⼯⼚即可，不需要修改原先的⼯⼚类</span>
<span class="token comment">// 缺点：对于某种可以形成⼀组产品族的情况处理较为复杂,需要创建⼤量的⼯⼚类.</span>
<span class="token keyword">class</span> <span class="token class-name">Fruit</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
 <span class="token function">Fruit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
 <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Apple</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Fruit</span></span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
 <span class="token function">Apple</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
 <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"我是⼀个苹果"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">private</span><span class="token operator">:</span>
 std<span class="token double-colon punctuation">::</span>string _color<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Banana</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Fruit</span></span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
 <span class="token function">Banana</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
 <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"我是⼀个⾹蕉"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">FruitFactory</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
 <span class="token keyword">virtual</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Fruit<span class="token operator">&gt;</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">AppleFactory</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">FruitFactory</span></span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
 <span class="token keyword">virtual</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Fruit<span class="token operator">&gt;</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>Apple<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">BananaFactory</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">FruitFactory</span></span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
 <span class="token keyword">virtual</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Fruit<span class="token operator">&gt;</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>Banana<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
 std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>FruitFactory<span class="token operator">&gt;</span> <span class="token function">factory</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">AppleFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 fruit <span class="token operator">=</span> factory<span class="token operator">-&gt;</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 fruit<span class="token operator">-&gt;</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 factory<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">BananaFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 fruit <span class="token operator">=</span> factory<span class="token operator">-&gt;</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 fruit<span class="token operator">-&gt;</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>⼯⼚⽅法模式每次增加⼀个产品时，都需要增加⼀个具体产品类和⼯⼚类，这会使得系统中类的个数成倍增加，在⼀定程度上增加了系统的耦合度。</p> 
<p><strong>抽象⼯⼚模式</strong>: ⼯⼚⽅法模式通过引⼊⼯⼚等级结构，解决了简单⼯⼚模式中⼯⼚类职责太重的问题，但由于⼯⼚⽅法模式中的每个⼯⼚只⽣产⼀类产品，可能会导致系统中存在⼤量的⼯⼚类，势必会增加系统的开销。此时，我们可以考虑将⼀些相关的产品组成⼀个产品族（位于不同产品等级结构中功能相关联的产品组成的家族），由同⼀个⼯⼚来统⼀⽣产，这就是抽象⼯⼚模式的基本思想。</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>
<span class="token comment">//抽象⼯⼚：围绕⼀个超级⼯⼚创建其他⼯⼚。每个⽣成的⼯⼚按照⼯⼚模式提供对象。</span>
<span class="token comment">// 思想：将⼯⼚抽象成两层，抽象⼯⼚ &amp; 具体⼯⼚⼦类， 在⼯⼚⼦类种⽣产不同类型的⼦产品</span>
<span class="token keyword">class</span> <span class="token class-name">Fruit</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
 <span class="token function">Fruit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
 <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Apple</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Fruit</span></span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
 <span class="token function">Apple</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
 <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"我是⼀个苹果"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">private</span><span class="token operator">:</span>
 std<span class="token double-colon punctuation">::</span>string _color<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Banana</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Fruit</span></span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
 <span class="token function">Banana</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
 <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"我是⼀个⾹蕉"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Animal</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
 <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">voice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Lamp</span><span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Animal</span></span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
 <span class="token keyword">void</span> <span class="token function">voice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"咩咩咩\n"</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Dog</span><span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Animal</span></span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
 <span class="token keyword">void</span> <span class="token function">voice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"汪汪汪\n"</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Factory</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
 <span class="token keyword">virtual</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Fruit<span class="token operator">&gt;</span> <span class="token function">getFruit</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>name<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token keyword">virtual</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Animal<span class="token operator">&gt;</span> <span class="token function">getAnimal</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>name<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">FruitFactory</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Factory</span></span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
 <span class="token keyword">virtual</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Animal<span class="token operator">&gt;</span> <span class="token function">getAnimal</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">shared_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>Animal<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">virtual</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Fruit<span class="token operator">&gt;</span> <span class="token function">getFruit</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">==</span> <span class="token string">"苹果"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>Apple<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>name <span class="token operator">==</span> <span class="token string">"⾹蕉"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>Banana<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">shared_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>Fruit<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">AnimalFactory</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Factory</span></span> <span class="token punctuation">{<!-- --></span>
 
 <span class="token keyword">public</span><span class="token operator">:</span>
 <span class="token keyword">virtual</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Fruit<span class="token operator">&gt;</span> <span class="token function">getFruit</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">shared_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>Fruit<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">virtual</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Animal<span class="token operator">&gt;</span> <span class="token function">getAnimal</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">==</span> <span class="token string">"⼩⽺"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>Lamp<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>name <span class="token operator">==</span> <span class="token string">"⼩狗"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>Dog<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">shared_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>Animal<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">FactoryProducer</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
 <span class="token keyword">static</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Factory<span class="token operator">&gt;</span> <span class="token function">getFactory</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">==</span> <span class="token string">"动物"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>AnimalFactory<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>FruitFactory<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
 std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Factory<span class="token operator">&gt;</span> fruit_factory <span class="token operator">=</span> <span class="token class-name">FactoryProducer</span><span class="token double-colon punctuation">::</span><span class="token function">getFactory</span><span class="token punctuation">(</span>"⽔
果"<span class="token punctuation">)</span><span class="token punctuation">;</span>
 std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Fruit<span class="token operator">&gt;</span> fruit <span class="token operator">=</span> fruit_factory<span class="token operator">-&gt;</span><span class="token function">getFruit</span><span class="token punctuation">(</span><span class="token string">"苹果"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 fruit<span class="token operator">-&gt;</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 fruit <span class="token operator">=</span> fruit_factory<span class="token operator">-&gt;</span><span class="token function">getFruit</span><span class="token punctuation">(</span><span class="token string">"⾹蕉"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 fruit<span class="token operator">-&gt;</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Factory<span class="token operator">&gt;</span> animal_factory <span class="token operator">=</span> <span class="token class-name">FactoryProducer</span><span class="token double-colon punctuation">::</span><span class="token function">getFactory</span><span class="token punctuation">(</span>"动
物"<span class="token punctuation">)</span><span class="token punctuation">;</span>
 std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Animal<span class="token operator">&gt;</span> animal <span class="token operator">=</span> animal_factory<span class="token operator">-&gt;</span><span class="token function">getAnimal</span><span class="token punctuation">(</span><span class="token string">"⼩⽺"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 animal<span class="token operator">-&gt;</span><span class="token function">voice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 animal <span class="token operator">=</span> animal_factory<span class="token operator">-&gt;</span><span class="token function">getAnimal</span><span class="token punctuation">(</span><span class="token string">"⼩狗"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 animal<span class="token operator">-&gt;</span><span class="token function">voice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>抽象⼯⼚模式适⽤于⽣产多个⼯⼚系列产品衍⽣的设计模式，增加新的产品等级结构复杂，需要对原有系统进⾏较⼤的修改，甚⾄需要修改抽象层代码，违背了“开闭原则”。</p> 
<blockquote> 
 <p><strong>建造者模式</strong></p> 
</blockquote> 
<p>建造者模式是⼀种创建型设计模式， 使⽤多个简单的对象⼀步⼀步构建成⼀个复杂的对象，能够将⼀个复杂的对象的构建与它的表⽰分离，提供⼀种创建对象的最佳⽅式。主要⽤于解决对象的构建过于复杂的问题。</p> 
<p>建造者模式主要基于四个核⼼类实现：<br> • 抽象产品类：<br> • 具体产品类：⼀个具体的产品对象类<br> • 抽象Builder类：创建⼀个产品对象所需的各个部件的抽象接⼝<br> • 具体产品的Builder类：实现抽象接⼝，构建各个部件<br> • 指挥者Director类：统⼀组建过程，提供给调⽤者使⽤，通过指挥者来构造产品<br> <mark>在这个项目中我们用不到指挥者类</mark></p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>
<span class="token comment">/*抽象电脑类*/</span>
<span class="token keyword">class</span> <span class="token class-name">Computer</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
 <span class="token keyword">using</span> ptr <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Computer<span class="token operator">&gt;</span><span class="token punctuation">;</span>
 <span class="token function">Computer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
 <span class="token keyword">void</span> <span class="token function">setBoard</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>board<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>_board <span class="token operator">=</span> board<span class="token punctuation">;</span><span class="token punctuation">}</span>
 <span class="token keyword">void</span> <span class="token function">setDisplay</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>display<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>_display <span class="token operator">=</span> display<span class="token punctuation">;</span><span class="token punctuation">}</span>
 <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">setOs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 std<span class="token double-colon punctuation">::</span>string <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 std<span class="token double-colon punctuation">::</span>string computer <span class="token operator">=</span> <span class="token string">"Computer:{\n"</span><span class="token punctuation">;</span>
 computer <span class="token operator">+=</span> <span class="token string">"\tboard="</span> <span class="token operator">+</span> _board <span class="token operator">+</span> <span class="token string">",\n"</span><span class="token punctuation">;</span> 
 computer <span class="token operator">+=</span> <span class="token string">"\tdisplay="</span> <span class="token operator">+</span> _display <span class="token operator">+</span> <span class="token string">",\n"</span><span class="token punctuation">;</span> 
 computer <span class="token operator">+=</span> <span class="token string">"\tOs="</span> <span class="token operator">+</span> _os <span class="token operator">+</span> <span class="token string">",\n"</span><span class="token punctuation">;</span> 
 computer <span class="token operator">+=</span> <span class="token string">"}\n"</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> computer<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">protected</span><span class="token operator">:</span>
 std<span class="token double-colon punctuation">::</span>string _board<span class="token punctuation">;</span>
 std<span class="token double-colon punctuation">::</span>string _display<span class="token punctuation">;</span>
 std<span class="token double-colon punctuation">::</span>string _os<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">/*具体产品类*/</span>
<span class="token keyword">class</span> <span class="token class-name">MacBook</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Computer</span></span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
 <span class="token keyword">using</span> ptr <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>MacBook<span class="token operator">&gt;</span><span class="token punctuation">;</span>
 <span class="token function">MacBook</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
 <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">setOs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 _os <span class="token operator">=</span> <span class="token string">"Max Os X12"</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">/*抽象建造者类：包含创建⼀个产品对象的各个部件的抽象接⼝*/</span>
<span class="token keyword">class</span> <span class="token class-name">Builder</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
 <span class="token keyword">using</span> ptr <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Builder<span class="token operator">&gt;</span><span class="token punctuation">;</span>
 <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">buildBoard</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>board<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">buildDisplay</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>display<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">buildOs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token keyword">virtual</span> Computer<span class="token double-colon punctuation">::</span>ptr <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">/*具体产品的具体建造者类：实现抽象接⼝，构建和组装各个部件*/</span>
<span class="token keyword">class</span> <span class="token class-name">MacBookBuilder</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Builder</span></span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
 <span class="token keyword">using</span> ptr <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>MacBookBuilder<span class="token operator">&gt;</span><span class="token punctuation">;</span>
 <span class="token function">MacBookBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token function">_computer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">MacBook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
 <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">buildBoard</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>board<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 _computer<span class="token operator">-&gt;</span><span class="token function">setBoard</span><span class="token punctuation">(</span>board<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">buildDisplay</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>display<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 _computer<span class="token operator">-&gt;</span><span class="token function">setDisplay</span><span class="token punctuation">(</span>display<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">buildOs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 _computer<span class="token operator">-&gt;</span><span class="token function">setOs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">virtual</span> Computer<span class="token double-colon punctuation">::</span>ptr <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">return</span> _computer<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">private</span><span class="token operator">:</span>
 Computer<span class="token double-colon punctuation">::</span>ptr _computer<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">/*指挥者类，提供给调⽤者使⽤，通过指挥者来构造复杂产品*/</span>
<span class="token keyword">class</span> <span class="token class-name">Director</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
 <span class="token function">Director</span><span class="token punctuation">(</span>Builder<span class="token operator">*</span> builder<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">_builder</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
 <span class="token keyword">void</span> <span class="token function">construct</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>board<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>display<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 _builder<span class="token operator">-&gt;</span><span class="token function">buildBoard</span><span class="token punctuation">(</span>board<span class="token punctuation">)</span><span class="token punctuation">;</span>
 _builder<span class="token operator">-&gt;</span><span class="token function">buildDisplay</span><span class="token punctuation">(</span>display<span class="token punctuation">)</span><span class="token punctuation">;</span>
 _builder<span class="token operator">-&gt;</span><span class="token function">buildOs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">private</span><span class="token operator">:</span>
 Builder<span class="token double-colon punctuation">::</span>ptr _builder<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
 Builder <span class="token operator">*</span>buidler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">MackBookBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>Director<span class="token operator">&gt;</span> <span class="token function">pd</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Director</span><span class="token punctuation">(</span>buidler<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 pd<span class="token operator">-&gt;</span><span class="token function">construct</span><span class="token punctuation">(</span><span class="token string">"英特尔主板"</span><span class="token punctuation">,</span> <span class="token string">"VOC显⽰器"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 Computer<span class="token double-colon punctuation">::</span>ptr computer <span class="token operator">=</span> buidler<span class="token operator">-&gt;</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> computer<span class="token operator">-&gt;</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p><strong>代理模式</strong></p> 
</blockquote> 
<p>代理模式指代理控制对其他对象的访问， 也就是代理对象控制对原对象的引⽤。在某些情况下，⼀个对象不适合或者不能直接被引⽤访问，⽽代理对象可以在客⼾端和⽬标对象之间起到中介的作⽤。<br> 代理模式的结构包括⼀个是真正的你要访问的对象(⽬标类)、⼀个是代理对象。⽬标对象与代理对象实现同⼀个接口，先访问代理类再通过代理类访问⽬标对象。代理模式分为静态代理、动态代理：</p> 
<p>• 静态代理指的是，在编译时就已经确定好了代理类和被代理类的关系。也就是说，在编译时就已经确定了代理类要代理的是哪个被代理类。<br> • 动态代理指的是，在运⾏时才动态⽣成代理类，并将其与被代理类绑定。这意味着，在运⾏时才能确定代理类要代理的是哪个被代理类。</p> 
<p>以租房为例，房东将房⼦租出去，但是要租房⼦出去，需要发布招租启⽰， 带⼈看房，负责维修，这些⼯作中有些操作并⾮房东能完成，因此房东为了图省事，将房⼦委托给中介进⾏租赁。 代理模式实现：</p> 
<pre><code class="prism language-cpp"><span class="token comment">/*房东要把⼀个房⼦通过中介租出去理解代理模式*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token keyword">class</span> <span class="token class-name">RentHouse</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
 <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">rentHouse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">/*房东类：将房⼦租出去*/</span>
<span class="token keyword">class</span> <span class="token class-name">Landlord</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">RentHouse</span></span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span> 
 <span class="token keyword">void</span> <span class="token function">rentHouse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"将房⼦租出去\n"</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">/*中介代理类：对租房⼦进⾏功能加强，实现租房以外的其他功能*/</span>
<span class="token keyword">class</span> <span class="token class-name">Intermediary</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">RentHouse</span></span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
 <span class="token keyword">void</span> <span class="token function">rentHouse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"发布招租启⽰\n"</span><span class="token punctuation">;</span>
 std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"带⼈看房\n"</span><span class="token punctuation">;</span>
 _landlord<span class="token punctuation">.</span><span class="token function">rentHouse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"负责租后维修\n"</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">private</span><span class="token operator">:</span>
 Landlord _landlord<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
 Intermediary intermediary<span class="token punctuation">;</span>
 intermediary<span class="token punctuation">.</span><span class="token function">rentHouse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="_529"></a>三、日志项目框架设计</h2> 
<p>本项⽬实现的是⼀个多⽇志器⽇志系统，主要实现的功能是让程序员能够轻松的将程序运⾏⽇志信息落地到指定的位置，且⽀持同步与异步两种⽅式的⽇志落地方式。<br> 项⽬的框架设计将项⽬分为以下⼏个模块来实现。</p> 
<h3><a id="1_533"></a>1.模块划分</h3> 
<blockquote> 
 <p>⽇志等级模块：对输出⽇志的等级进⾏划分，以便于控制⽇志的输出，并提供等级枚举转字符串功能。<br> ◦ OFF：关闭<br> ◦ DEBUG：调试，调试时的关键信息输出。<br> ◦ INFO：提⽰，普通的提⽰型⽇志信息。<br> ◦ WARN：警告，不影响运⾏，但是需要注意⼀下的⽇志。<br> ◦ ERROR：错误，程序运⾏出现错误的⽇志<br> ◦ FATAL：致命，⼀般是代码异常导致程序⽆法继续推进运⾏的⽇志</p> 
</blockquote> 
<blockquote> 
 <p>⽇志消息模块：中间存储⽇志输出所需的各项要素信息<br> ◦ 时间：描述本条⽇志的输出时间。<br> ◦ 线程ID：描述本条⽇志是哪个线程输出的。<br> ◦ ⽇志等级：描述本条⽇志的等级。<br> ◦ ⽇志数据：本条⽇志的有效载荷数据。<br> ◦ ⽇志⽂件名：描述本条⽇志在哪个源码⽂件中输出的。<br> ◦ ⽇志⾏号：描述本条⽇志在源码⽂件的哪⼀⾏输出的。</p> 
</blockquote> 
<blockquote> 
 <p>⽇志消息格式化模块：设置⽇志输出格式，并提供对⽇志消息进⾏格式化功能。<br> ◦ 系统的默认⽇志输出格式：%d{%H:%M:%S}%T[%t]%T[%p]%T[%c]%T%f:%l%T%m%n<br> ◦ -&gt; 13:26:32 [2343223321] [FATAL] [root] main.c:76 套接字创建失败\n<br> ◦ %d{%H:%M:%S}：表⽰⽇期时间，花括号中的内容表⽰⽇期时间的格式。<br> ◦ %T：表⽰制表符缩进。<br> ◦ %t：表⽰线程ID<br> ◦ %p：表⽰⽇志级别<br> ◦ %c：表⽰⽇志器名称，不同的开发组可以创建⾃⼰的⽇志器进⾏⽇志输出，⼩组之间互不影响。<br> ◦ %f：表⽰⽇志输出时的源代码⽂件名。<br> ◦ %l：表⽰⽇志输出时的源代码⾏号。<br> ◦ %m：表⽰给与的⽇志有效载荷数据<br> ◦ %n：表⽰换⾏<br> ◦ 设计思想：设计不同的⼦类，不同的⼦类从⽇志消息中取出不同的数据进⾏处理。</p> 
</blockquote> 
<blockquote> 
 <p>⽇志消息落地模块：决定了⽇志的落地⽅向，可以是标准输出，也可以是⽇志⽂件，也可以滚动⽂件输出…<br> ◦ 标准输出：表⽰将⽇志进⾏标准输出的打印。<br> ◦ ⽇志⽂件输出：表⽰将⽇志写⼊指定的⽂件末尾。<br> ◦ 滚动⽂件输出：当前以⽂件⼤⼩进⾏控制，当⼀个⽇志⽂件⼤⼩达到指定⼤⼩，则切换下⼀个⽂件进⾏输出<br> ◦ 后期，也可以扩展远程⽇志输出，创建客⼾端，将⽇志消息发送给远程的⽇志分析服务器。<br> ◦ 设计思想：设计不同的⼦类，不同的⼦类控制不同的⽇志落地⽅向。</p> 
</blockquote> 
<blockquote> 
 <p>⽇志器模块：<br> 此模块是对以上⼏个模块的整合模块，⽤⼾通过⽇志器进⾏⽇志的输出，有效降低⽤⼾的使⽤难度。<br> ◦ 包含有：⽇志消息落地模块对象，⽇志消息格式化模块对象，⽇志输出等级</p> 
</blockquote> 
<blockquote> 
 <p>⽇志器管理模块：<br> ◦ 为了降低项⽬开发的⽇志耦合，不同的项⽬组可以有⾃⼰的⽇志器来控制输出格式以及落地⽅向，因此本项⽬是⼀个多⽇志器的⽇志系统。<br> ◦ 管理模块就是对创建的所有⽇志器进⾏统⼀管理。并提供⼀个默认⽇志器提供标准输出的⽇志输出。</p> 
</blockquote> 
<blockquote> 
 <p>• 异步线程模块：<br> ◦ 实现对⽇志的异步输出功能，⽤⼾只需要将输出⽇志任务放⼊任务池，异步线程负责⽇志的落地输出功能，以此提供更加⾼效的⾮阻塞⽇志输出。</p> 
</blockquote> 
<h3><a id="2_582"></a>2.各模块关系图</h3> 
<p>日志系统 1.写入指定位置 2.不同写入方式 3.多输出策略<br> <img src="https://images2.imgbox.com/b6/da/3epNuDDY_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_585"></a>四、详细代码实现</h2> 
<p><mark>注意：由于此日志项目是多次迭代后完成的，从0开始描述迭代过程太冗长，故只介绍最终版本的实现思路</mark></p> 
<h3><a id="1_588"></a>1.实用工具类设计</h3> 
<p>有一些我们会经常在项目用的零碎的功能接口，我们提前在一个类中实现。<br> • 获取系统时间<br> • 判断文件是否存在<br> • 获取文件的所在目录路径<br> • 创建一个目录</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_M_UTIL_H_</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_M_UTIL_H_</span></span>

<span class="token comment">//实用工具类的实现</span>
<span class="token comment">// 1.获取系统时间</span>
<span class="token comment">// 2.判断文件是否存在</span>
<span class="token comment">// 3.获取文件所在路径</span>
<span class="token comment">// 4.创建目录</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;ctime&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/stat.h&gt;</span></span>

<span class="token keyword">namespace</span> HUE 
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">namespace</span> util
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">class</span> <span class="token class-name">Date</span> 
        <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">public</span><span class="token operator">:</span>
            <span class="token keyword">static</span> size_t <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token punctuation">(</span>size_t<span class="token punctuation">)</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
  
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        
        <span class="token keyword">class</span> <span class="token class-name">File</span>
        <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">public</span><span class="token operator">:</span>
           <span class="token keyword">static</span> <span class="token keyword">bool</span> <span class="token function">exists</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>pathname<span class="token punctuation">)</span>
           <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">struct</span> <span class="token class-name">stat</span> st<span class="token punctuation">;</span> <span class="token comment">//跨平台</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">stat</span><span class="token punctuation">(</span>pathname<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>st<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>

           <span class="token keyword">static</span> std<span class="token double-colon punctuation">::</span>string <span class="token function">path</span> <span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>pathname<span class="token punctuation">)</span>
           <span class="token punctuation">{<!-- --></span>
                size_t pos <span class="token operator">=</span> pathname<span class="token punctuation">.</span><span class="token function">find_last_of</span><span class="token punctuation">(</span><span class="token string">"/\\"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>pos <span class="token operator">==</span> std<span class="token double-colon punctuation">::</span>string<span class="token double-colon punctuation">::</span>npos<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">"."</span><span class="token punctuation">;</span>

                <span class="token keyword">return</span> pathname<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>pos<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>

           <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">createDirectory</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>pathname<span class="token punctuation">)</span>
           <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// ./abc/bcd/a.txt</span>
                size_t pos <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> idx <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//标定查找的起始位置</span>

                <span class="token keyword">while</span><span class="token punctuation">(</span>idx <span class="token operator">&lt;</span> pathname<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    pos <span class="token operator">=</span> pathname<span class="token punctuation">.</span><span class="token function">find_first_of</span><span class="token punctuation">(</span><span class="token string">"/\\"</span><span class="token punctuation">,</span>idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>pos <span class="token operator">==</span> std<span class="token double-colon punctuation">::</span>string<span class="token double-colon punctuation">::</span>npos<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token function">mkdir</span><span class="token punctuation">(</span>pathname<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                std<span class="token double-colon punctuation">::</span>string parent_dir <span class="token operator">=</span> pathname<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>pos<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//截取目录路径</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">exists</span><span class="token punctuation">(</span>parent_dir<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">)</span> 
                <span class="token punctuation">{<!-- --></span>
                    idx <span class="token operator">=</span> pos<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">mkdir</span><span class="token punctuation">(</span>parent_dir<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                idx <span class="token operator">=</span> pos<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
           <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
  
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> 

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> 
<h3><a id="2_673"></a>2.日志等级类设计</h3> 
<p>我们将日志等级封装成一个类，定义出日志系统所包含的所以日志等级：<br> • UNKONW＝０<br> • OFF 关闭所有⽇志输出<br> • DRBUG 进⾏debug时候打印⽇志的等级<br> • INFO 打印⼀些⽤⼾提⽰信息<br> • WARN 打印警告信息<br> • ERROR 打印错误信息<br> • FATAL 打印致命信息- 导致程序崩溃的信息</p> 
<p>这里的思想是：每一个项目中都会设置一个默认的日志输出等级，只有输出的日志等级大于等于默认限制等级的时候才可以进行输出<br> <img src="https://images2.imgbox.com/7c/ea/b1lp6wFx_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-cpp"><span class="token comment">//1.定义枚举类，枚举出日志等级</span>
<span class="token comment">//2.提供转换接口：将枚举准换为对应字符串</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_M_LEVEL_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_M_LEVEL_H</span></span>

<span class="token keyword">namespace</span> HUE 
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">class</span> <span class="token class-name">LogLevel</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span><span class="token operator">:</span>

        <span class="token keyword">enum</span> <span class="token keyword">class</span> <span class="token class-name">value</span>
        <span class="token punctuation">{<!-- --></span>
            UNKNOW <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
            DEBUG<span class="token punctuation">,</span>
            INFO<span class="token punctuation">,</span>
            WARN<span class="token punctuation">,</span>
            ERROR<span class="token punctuation">,</span>
            FATAL<span class="token punctuation">,</span>
            OFF
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

       <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">toString</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>value level<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>level<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> LogLevel<span class="token double-colon punctuation">::</span>value<span class="token double-colon punctuation">::</span>DEBUG<span class="token operator">:</span> <span class="token keyword">return</span> <span class="token string">"DEBUG"</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> LogLevel<span class="token double-colon punctuation">::</span>value<span class="token double-colon punctuation">::</span>INFO<span class="token operator">:</span> <span class="token keyword">return</span> <span class="token string">"INFO"</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> LogLevel<span class="token double-colon punctuation">::</span>value<span class="token double-colon punctuation">::</span>WARN<span class="token operator">:</span> <span class="token keyword">return</span> <span class="token string">"WARN"</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> LogLevel<span class="token double-colon punctuation">::</span>value<span class="token double-colon punctuation">::</span>ERROR<span class="token operator">:</span> <span class="token keyword">return</span> <span class="token string">"ERROR"</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> LogLevel<span class="token double-colon punctuation">::</span>value<span class="token double-colon punctuation">::</span>FATAL<span class="token operator">:</span> <span class="token keyword">return</span> <span class="token string">"FATAL"</span><span class="token punctuation">;</span>   
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token string">"UNKNOW"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> 
<h3><a id="3_727"></a>3.日志消息类设计</h3> 
<p>我们⽇志消息类主要是封装⼀条完整的⽇志消息所需的内容，其中包括⽇志等级、对应的logger name、打印⽇志源⽂件的位置信息（包括⽂件名和⾏号）、线程ID、时间戳信息、具体的⽇志信息等内容。<br> <img src="https://images2.imgbox.com/60/b4/FT17blas_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_M_MSG_H_</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_M_MSG_H_</span></span>
<span class="token comment">//⽇志消息类主要是封装⼀条完整的⽇志消息所需的内容，其中包括</span>
<span class="token comment">//⽇志等级、对应的logger name、打印⽇志源⽂件的位置信息（包括⽂件名和⾏号）、线程ID、时间戳信息、具体的⽇志信息等内容</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">"level.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">"util.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;thread&gt;</span></span>


<span class="token keyword">namespace</span> HUE
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">LogMsg</span>
    <span class="token punctuation">{<!-- --></span>
        time_t _ctime<span class="token punctuation">;</span> <span class="token comment">//日志产生的时间戳</span>
        LogLevel<span class="token double-colon punctuation">::</span>value _level<span class="token punctuation">;</span> <span class="token comment">//日志等级</span>
        size_t _line<span class="token punctuation">;</span><span class="token comment">//行号</span>
        std<span class="token double-colon punctuation">::</span>thread<span class="token double-colon punctuation">::</span>id _tid<span class="token punctuation">;</span><span class="token comment">//线程ID</span>
        std<span class="token double-colon punctuation">::</span>string _file<span class="token punctuation">;</span><span class="token comment">//源文件名</span>
        std<span class="token double-colon punctuation">::</span>string _logger<span class="token punctuation">;</span><span class="token comment">//日志器名称</span>
        std<span class="token double-colon punctuation">::</span>string _payload<span class="token punctuation">;</span> <span class="token comment">//有效消息数据</span>


        <span class="token function">LogMsg</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>value level<span class="token punctuation">,</span>
            size_t line<span class="token punctuation">,</span>
            <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string file<span class="token punctuation">,</span>
            <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string logger<span class="token punctuation">,</span>
            <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string msg<span class="token punctuation">)</span>
            <span class="token operator">:</span><span class="token function">_ctime</span><span class="token punctuation">(</span>util<span class="token double-colon punctuation">::</span><span class="token class-name">Date</span><span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">,</span><span class="token function">_level</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span>
            <span class="token punctuation">,</span><span class="token function">_line</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span>
            <span class="token punctuation">,</span><span class="token function">_tid</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">,</span><span class="token function">_file</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
            <span class="token punctuation">,</span><span class="token function">_logger</span><span class="token punctuation">(</span>logger<span class="token punctuation">)</span>
            <span class="token punctuation">,</span><span class="token function">_payload</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

    <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> 
<h3><a id="4_775"></a>4.日志输出格式化模块</h3> 
<p>我们可以让用户自定义输出内容,通过对日志消息进行格式化，组织称为指定格式的字符串。</p> 
<p>我们的设计思想就是：<br> 1.抽象一个格式化子项基类<br> 2.基于基类，派生出不同的格式化子项子类<br> 比如说：主体消息、日志等级、时间子项、文件名、行号等等。<br> 这样我们就可以在父类中定义父类指针的数组，用来指向不同的格式化子项子类对象嘛！<br> <img src="https://images2.imgbox.com/dd/a3/uKSml3Me_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>字符串解析设计 — 循环处理</p> 
</blockquote> 
<p>我们规定字符串处理是一个循环的过程<br> while（）{<!-- --><br> 1.处理原始字符串<br> 2.原始字符串处理结束后，遇到%，则处理一个格式化字符串嘛<br> }<br> <img src="https://images2.imgbox.com/0a/13/wOQSN83s_o.png" alt="在这里插入图片描述"><br> 在处理过程中，我们需要将处理得到的信息保存下来，创建对应的格式化子项对象，添加到item成员数组中。</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_M_FMT_H_</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_M_FMT_H_</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"level.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"logmsg.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ctime&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cassert&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sstream&gt;</span></span>

<span class="token keyword">namespace</span> HUE
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 抽象格式化子项基类</span>
    <span class="token keyword">class</span> <span class="token class-name">FromatIem</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token keyword">using</span> ptr <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>FromatIem<span class="token operator">&gt;</span><span class="token punctuation">;</span>
        <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">format</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>ostream <span class="token operator">&amp;</span>out<span class="token punctuation">,</span><span class="token keyword">const</span> LogMsg <span class="token operator">&amp;</span>msg<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 派生格式化子项子类 -- 消息 等级 时间 文件名 行号 线程ID 日志器名 制表符 换行 其他</span>

    <span class="token keyword">class</span> <span class="token class-name">LevelFormatItem</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">FromatIem</span></span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token keyword">void</span> <span class="token function">format</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>ostream <span class="token operator">&amp;</span>out<span class="token punctuation">,</span><span class="token keyword">const</span> LogMsg <span class="token operator">&amp;</span>msg<span class="token punctuation">)</span> <span class="token keyword">override</span>
        <span class="token punctuation">{<!-- --></span>
            out <span class="token operator">&lt;&lt;</span> <span class="token class-name">LogLevel</span><span class="token double-colon punctuation">::</span><span class="token function">toString</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>_level<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">class</span> <span class="token class-name">TimeFormatItem</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">FromatIem</span></span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">TimeFormatItem</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>fmt <span class="token operator">=</span> <span class="token string">"%H:%M:%S"</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">_time_fmt</span><span class="token punctuation">(</span>fmt<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">format</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>ostream <span class="token operator">&amp;</span>out<span class="token punctuation">,</span><span class="token keyword">const</span> LogMsg <span class="token operator">&amp;</span>msg<span class="token punctuation">)</span> <span class="token keyword">override</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">struct</span> <span class="token class-name">tm</span> t<span class="token punctuation">;</span>
            <span class="token function">localtime_r</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">.</span>_ctime<span class="token punctuation">,</span> <span class="token operator">&amp;</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">char</span> tmp<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token function">strftime</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">,</span> _time_fmt<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>

            out <span class="token operator">&lt;&lt;</span> tmp<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token keyword">private</span><span class="token operator">:</span>
        std<span class="token double-colon punctuation">::</span>string _time_fmt<span class="token punctuation">;</span> <span class="token comment">// 格式 %H：%M：％S</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">class</span> <span class="token class-name">FileFormatItem</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">FromatIem</span></span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token keyword">void</span> <span class="token function">format</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>ostream <span class="token operator">&amp;</span>out<span class="token punctuation">,</span><span class="token keyword">const</span> LogMsg <span class="token operator">&amp;</span>msg<span class="token punctuation">)</span> <span class="token keyword">override</span>
        <span class="token punctuation">{<!-- --></span>
            out <span class="token operator">&lt;&lt;</span> msg<span class="token punctuation">.</span>_file<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">class</span> <span class="token class-name">LineFormatItem</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">FromatIem</span></span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token keyword">void</span> <span class="token function">format</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>ostream <span class="token operator">&amp;</span>out<span class="token punctuation">,</span><span class="token keyword">const</span> LogMsg <span class="token operator">&amp;</span>msg<span class="token punctuation">)</span> <span class="token keyword">override</span>
        <span class="token punctuation">{<!-- --></span>
            out <span class="token operator">&lt;&lt;</span> msg<span class="token punctuation">.</span>_line<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">class</span> <span class="token class-name">ThreadFormatItem</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">FromatIem</span></span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token keyword">void</span> <span class="token function">format</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>ostream <span class="token operator">&amp;</span>out<span class="token punctuation">,</span><span class="token keyword">const</span> LogMsg <span class="token operator">&amp;</span>msg<span class="token punctuation">)</span> <span class="token keyword">override</span>
        <span class="token punctuation">{<!-- --></span>
            out <span class="token operator">&lt;&lt;</span> msg<span class="token punctuation">.</span>_tid<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">class</span> <span class="token class-name">LoggerFormatItem</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">FromatIem</span></span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token keyword">void</span> <span class="token function">format</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>ostream <span class="token operator">&amp;</span>out<span class="token punctuation">,</span><span class="token keyword">const</span> LogMsg <span class="token operator">&amp;</span>msg<span class="token punctuation">)</span> <span class="token keyword">override</span>
        <span class="token punctuation">{<!-- --></span>
            out <span class="token operator">&lt;&lt;</span> msg<span class="token punctuation">.</span>_logger<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">class</span> <span class="token class-name">MsgFormatItem</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">FromatIem</span></span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token keyword">void</span> <span class="token function">format</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>ostream <span class="token operator">&amp;</span>out<span class="token punctuation">,</span><span class="token keyword">const</span> LogMsg <span class="token operator">&amp;</span>msg<span class="token punctuation">)</span> <span class="token keyword">override</span>
        <span class="token punctuation">{<!-- --></span>
            out <span class="token operator">&lt;&lt;</span> msg<span class="token punctuation">.</span>_payload<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">class</span> <span class="token class-name">TabFormatItem</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">FromatIem</span></span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token keyword">void</span> <span class="token function">format</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>ostream <span class="token operator">&amp;</span>out<span class="token punctuation">,</span><span class="token keyword">const</span> LogMsg <span class="token operator">&amp;</span>msg<span class="token punctuation">)</span> <span class="token keyword">override</span>
        <span class="token punctuation">{<!-- --></span>
            out <span class="token operator">&lt;&lt;</span> <span class="token string">"\t"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">class</span> <span class="token class-name">NLineFormatItem</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">FromatIem</span></span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token keyword">void</span> <span class="token function">format</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>ostream <span class="token operator">&amp;</span>out<span class="token punctuation">,</span> <span class="token keyword">const</span> LogMsg <span class="token operator">&amp;</span>msg<span class="token punctuation">)</span> <span class="token keyword">override</span>
        <span class="token punctuation">{<!-- --></span>
            out <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 其他字符：</span>
    <span class="token keyword">class</span> <span class="token class-name">OtherFormatItem</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">FromatIem</span></span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">OtherFormatItem</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>str<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">_str</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">format</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>ostream <span class="token operator">&amp;</span>out<span class="token punctuation">,</span><span class="token keyword">const</span> LogMsg <span class="token operator">&amp;</span>msg<span class="token punctuation">)</span> <span class="token keyword">override</span>
        <span class="token punctuation">{<!-- --></span>
            out <span class="token operator">&lt;&lt;</span> _str<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token keyword">private</span><span class="token operator">:</span>
        std<span class="token double-colon punctuation">::</span>string _str<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">/*
         %d 时间
         %t 线程ID
         %c 日志器名称
         %f 源码文件名
         %l 源码行号
         %p 日志级别
         %T 制表符缩进
         %m 主体消息
         %n 换行符
    */</span>

    <span class="token keyword">class</span> <span class="token class-name">Formatter</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token keyword">using</span> ptr <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Formatter<span class="token operator">&gt;</span><span class="token punctuation">;</span>
        <span class="token function">Formatter</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>pattern <span class="token operator">=</span> <span class="token string">"[%d{%H:%M:%S}][%t][%c][%f:%l][%p]%T%m%n"</span><span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token function">_pattern</span><span class="token punctuation">(</span>pattern<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">parsePattern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 对msg进行格式化</span>
        <span class="token keyword">void</span> <span class="token function">format</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>ostream <span class="token operator">&amp;</span>out<span class="token punctuation">,</span> <span class="token keyword">const</span> LogMsg <span class="token operator">&amp;</span>msg<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&amp;</span>item <span class="token operator">:</span> _items<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                item<span class="token operator">-&gt;</span><span class="token function">format</span><span class="token punctuation">(</span>out<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 按照顺序把信息从msg取出来</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        std<span class="token double-colon punctuation">::</span>string <span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">const</span> LogMsg <span class="token operator">&amp;</span>msg<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            std<span class="token double-colon punctuation">::</span>stringstream ss<span class="token punctuation">;</span>
            <span class="token function">format</span><span class="token punctuation">(</span>ss<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> ss<span class="token punctuation">.</span><span class="token function">str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token comment">// 对格式化规则字符串进行解析</span>
        <span class="token keyword">bool</span> <span class="token function">parsePattern</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
           <span class="token comment">//1.对格式化规则字符串进行解析</span>
            <span class="token comment">//ab%%cd[%d{%H:%M:%S}][%p][%f:%l]%T%m%n</span>

            std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&gt;&gt;</span>fmt_order<span class="token punctuation">;</span>
            size_t pos <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

            std<span class="token double-colon punctuation">::</span>string key<span class="token punctuation">,</span>val<span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>pos <span class="token operator">&lt;</span>_pattern<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//1. 判断处理原始字符串，是否为%,否为原始字符</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>_pattern<span class="token punctuation">[</span>pos<span class="token punctuation">]</span> <span class="token operator">!=</span><span class="token char">'%'</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    val<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>_pattern<span class="token punctuation">[</span>pos<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//能走下来代表pos位置为%,%%处理称为一个原始%字符</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>_pattern<span class="token punctuation">[</span>pos<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span><span class="token char">'%'</span> <span class="token operator">&amp;&amp;</span> pos<span class="token operator">+</span><span class="token number">1</span> <span class="token operator">&lt;</span> _pattern<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    val<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token char">'%'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> pos<span class="token operator">+=</span><span class="token number">2</span><span class="token punctuation">;</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//能走下来代表%后面是个格式化字符,代表原始字符串处理完毕</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>val<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                fmt_order<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">make_pair</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                val<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">//格式化字符处理 </span>
                pos<span class="token operator">+=</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//这一步之后，pos指向格式化字符位置</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>pos <span class="token operator">==</span> _pattern<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"%之后，没有对应的格式化字符！\n"</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                key <span class="token operator">=</span> _pattern<span class="token punctuation">[</span>pos<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token comment">//+1此时pos指向格式化字符后的位置</span>
                pos<span class="token operator">+=</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>pos<span class="token operator">&lt;</span>_pattern<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> _pattern<span class="token punctuation">[</span>pos<span class="token punctuation">]</span> <span class="token operator">==</span><span class="token char">'{'</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    pos<span class="token operator">+=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//此时pos指向子规则的起始位置</span>
                    <span class="token keyword">while</span><span class="token punctuation">(</span>pos<span class="token operator">&lt;</span>_pattern<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> _pattern<span class="token punctuation">[</span>pos<span class="token punctuation">]</span> <span class="token operator">!=</span><span class="token char">'}'</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        val<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>_pattern<span class="token punctuation">[</span>pos<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">//如果是走到了末尾跳出循环，则代表没有遇到 },格式错误</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>pos <span class="token operator">==</span> _pattern<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"子规则{}匹配出错！\n"</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    pos <span class="token operator">+=</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//因为此时pos指向的 }位置，需要向后走一步，更新位置</span>
                <span class="token punctuation">}</span>   
                
                fmt_order<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">make_pair</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                key<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                val<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
            <span class="token comment">//2.根据解析得到的数据初始化格式化子项数组成员</span>

            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&amp;</span>it<span class="token operator">:</span>fmt_order<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                _items<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token function">createItem</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span>first<span class="token punctuation">,</span>it<span class="token punctuation">.</span>second<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 跟进不同的格式化字符创建不同的格式化子项对象</span>
        FromatIem<span class="token double-colon punctuation">::</span>ptr <span class="token function">createItem</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>key<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>val<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token string">"d"</span><span class="token punctuation">)</span> <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>TimeFormatItem<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token string">"t"</span><span class="token punctuation">)</span> <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>ThreadFormatItem<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token string">"c"</span><span class="token punctuation">)</span> <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>LoggerFormatItem<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token string">"f"</span><span class="token punctuation">)</span> <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>FileFormatItem<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token string">"l"</span><span class="token punctuation">)</span> <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>LineFormatItem<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token string">"p"</span><span class="token punctuation">)</span> <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>LevelFormatItem<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token string">"T"</span><span class="token punctuation">)</span> <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>TabFormatItem<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token string">"m"</span><span class="token punctuation">)</span> <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>MsgFormatItem<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token string">"n"</span><span class="token punctuation">)</span> <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>NLineFormatItem<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token string">""</span><span class="token punctuation">)</span>  <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>OtherFormatItem<span class="token operator">&gt;</span></span></span> <span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"没有对应的格式化字符：%"</span><span class="token operator">&lt;&lt;</span>key<span class="token operator">&lt;&lt;</span>std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token keyword">private</span><span class="token operator">:</span>
        std<span class="token double-colon punctuation">::</span>string _pattern<span class="token punctuation">;</span> <span class="token comment">// 格式化规则字符串</span>
        std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>FromatIem<span class="token double-colon punctuation">::</span>ptr<span class="token operator">&gt;</span> _items<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> 
<h3><a id="5_1052"></a>5.日志落地模块(简单工厂模式)</h3> 
<p>日志落地类主要负责将格式化后的日志消息字符串，输出到指定位置。<br> <img src="https://images2.imgbox.com/05/6e/ESKJaQKg_o.png" alt="在这里插入图片描述"></p> 
<p>它主要包括以下内容：<br> • Formatter⽇志格式化器：主要是负责格式化⽇志消息<br> • mutex互斥锁：保证多线程⽇志落地过程中的线程安全，避免出现交叉输出的情况。<br> 这个类⽀持可扩展，其成员函数log设置为纯虚函数，当我们需要增加⼀个log输出⽬标， 可以增加⼀个类继承⾃该类并重写log⽅法实现具体的落地⽇志逻辑。</p> 
<p>⽬前实现了三个不同⽅向上的⽇志落地：<br> • 标准输出：StdoutSink<br> • 固定⽂件：FileSink<br> • 滚动⽂件：RollSink</p> 
<blockquote> 
 <p>滚动⽇志⽂件输出的必要性：<br> ▪ 由于机器磁盘空间有限， 我们不可能⼀直⽆限地向⼀个⽂件中增加数据<br> ▪ 如果⼀个⽇志⽂件体积太⼤，⼀⽅⾯是不好打开，另⼀⽅⾯是即时打开了由于包含数据巨⼤，也不利于查找我们需要的信息<br> ▪ 所以实际开发中会对单个⽇志⽂件的⼤⼩也会做⼀些控制，即当⼤⼩超过某个⼤⼩时（如1GB），我们就重新创建⼀个新的⽇志⽂件来滚动写⽇志。 对于那些过期的⽇志， ⼤部分企业内部都有专⻔的运维⼈员去定时清理过期的⽇志，或者设置系统定时任务，定时清理过期⽇志。</p> 
</blockquote> 
<blockquote> 
 <p>⽇志⽂件的滚动思想</p> 
</blockquote> 
<p>⽇志⽂件滚动的条件有两个:⽂件⼤⼩ 和 时间。我们可以选择：<br> ▪ ⽇志⽂件在⼤于 1GB 的时候会更换新的⽂件<br> ▪ 每天定点滚动⼀个⽇志⽂件</p> 
<p>本项⽬基于⽂件⼤⼩的判断滚动⽣成新的⽂件:</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__M_SINK_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__M_SINK_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"util.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"message.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"formatter.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;mutex&gt;</span></span>
<span class="token keyword">namespace</span> bitlog<span class="token punctuation">{<!-- --></span>
<span class="token keyword">class</span> <span class="token class-name">LogSink</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
 <span class="token keyword">using</span> ptr <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>LogSink<span class="token operator">&gt;</span><span class="token punctuation">;</span>
 <span class="token function">LogSink</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
 <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">LogSink</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
 <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">StdoutSink</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">LogSink</span></span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
 <span class="token keyword">using</span> ptr <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>StdoutSink<span class="token operator">&gt;</span><span class="token punctuation">;</span>
 <span class="token function">StdoutSink</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
 <span class="token keyword">void</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 std<span class="token double-colon punctuation">::</span>cout<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">FileSink</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">LogSink</span></span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
 <span class="token keyword">using</span> ptr <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>FileSink<span class="token operator">&gt;</span><span class="token punctuation">;</span>
 <span class="token function">FileSink</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>filename<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">_filename</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 util<span class="token double-colon punctuation">::</span>file<span class="token double-colon punctuation">::</span><span class="token function">create_directory</span><span class="token punctuation">(</span>util<span class="token double-colon punctuation">::</span>file<span class="token double-colon punctuation">::</span><span class="token function">path</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 _ofs<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>_filename<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>ios<span class="token double-colon punctuation">::</span>binary <span class="token operator">|</span> std<span class="token double-colon punctuation">::</span>ios<span class="token double-colon punctuation">::</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">assert</span><span class="token punctuation">(</span>_ofs<span class="token punctuation">.</span><span class="token function">is_open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span><span class="token function">file</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token keyword">return</span> _filename<span class="token punctuation">;</span> <span class="token punctuation">}</span>
 <span class="token keyword">void</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 _ofs<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>data<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>_ofs<span class="token punctuation">.</span><span class="token function">good</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"⽇志输出⽂件失败！\n"</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">private</span><span class="token operator">:</span>
 std<span class="token double-colon punctuation">::</span>string _filename<span class="token punctuation">;</span>
 std<span class="token double-colon punctuation">::</span>ofstream _ofs<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">RollSink</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">LogSink</span></span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
 <span class="token keyword">using</span> ptr <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>RollSink<span class="token operator">&gt;</span><span class="token punctuation">;</span>
 <span class="token function">RollSink</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>basename<span class="token punctuation">,</span> size_t max_fsize<span class="token punctuation">)</span><span class="token operator">:</span>
 <span class="token function">_basename</span><span class="token punctuation">(</span>basename<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_max_fsize</span><span class="token punctuation">(</span>max_fsize<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_cur_fsize</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
 util<span class="token double-colon punctuation">::</span>file<span class="token double-colon punctuation">::</span><span class="token function">create_directory</span><span class="token punctuation">(</span>util<span class="token double-colon punctuation">::</span>file<span class="token double-colon punctuation">::</span><span class="token function">path</span><span class="token punctuation">(</span>basename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">void</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token function">initLogFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 _ofs<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>_ofs<span class="token punctuation">.</span><span class="token function">good</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"⽇志输出⽂件失败！\n"</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 _cur_fsize <span class="token operator">+=</span> len<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">private</span><span class="token operator">:</span>
 <span class="token keyword">void</span> <span class="token function">initLogFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>_ofs<span class="token punctuation">.</span><span class="token function">is_open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span> <span class="token operator">||</span> _cur_fsize <span class="token operator">&gt;=</span> _max_fsize<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 _ofs<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 std<span class="token double-colon punctuation">::</span>string name <span class="token operator">=</span> <span class="token function">createFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 _ofs<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>ios<span class="token double-colon punctuation">::</span>binary <span class="token operator">|</span> std<span class="token double-colon punctuation">::</span>ios<span class="token double-colon punctuation">::</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">assert</span><span class="token punctuation">(</span>_ofs<span class="token punctuation">.</span><span class="token function">is_open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 _cur_fsize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> 
 std<span class="token double-colon punctuation">::</span>string <span class="token function">createFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 time_t t <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">struct</span> <span class="token class-name">tm</span> lt<span class="token punctuation">;</span>
 <span class="token function">localtime_r</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">,</span> <span class="token operator">&amp;</span>lt<span class="token punctuation">)</span><span class="token punctuation">;</span>
 std<span class="token double-colon punctuation">::</span>stringstream ss<span class="token punctuation">;</span>
 ss <span class="token operator">&lt;&lt;</span> _basename<span class="token punctuation">;</span>
 ss <span class="token operator">&lt;&lt;</span> lt<span class="token punctuation">.</span>tm_year <span class="token operator">+</span> <span class="token number">1900</span><span class="token punctuation">;</span>
ss <span class="token operator">&lt;&lt;</span> lt<span class="token punctuation">.</span>tm_mon <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
 ss <span class="token operator">&lt;&lt;</span> lt<span class="token punctuation">.</span>tm_mday<span class="token punctuation">;</span>
 ss <span class="token operator">&lt;&lt;</span> lt<span class="token punctuation">.</span>tm_hour<span class="token punctuation">;</span>
 ss <span class="token operator">&lt;&lt;</span> lt<span class="token punctuation">.</span>tm_min<span class="token punctuation">;</span>
 ss <span class="token operator">&lt;&lt;</span> lt<span class="token punctuation">.</span>tm_sec<span class="token punctuation">;</span>
 ss <span class="token operator">&lt;&lt;</span> <span class="token string">".log"</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> ss<span class="token punctuation">.</span><span class="token function">str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">private</span><span class="token operator">:</span>
 std<span class="token double-colon punctuation">::</span>string _basename<span class="token punctuation">;</span>
 std<span class="token double-colon punctuation">::</span>ofstream _ofs<span class="token punctuation">;</span>
 size_t _max_fsize<span class="token punctuation">;</span>
 size_t _cur_fsize<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">SinkFactory</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
 <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">SinkType</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>Args<span class="token operator">&gt;</span>
 <span class="token keyword">static</span> LogSink<span class="token double-colon punctuation">::</span>ptr <span class="token function">create</span><span class="token punctuation">(</span>Args <span class="token operator">&amp;&amp;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>SinkType<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>Args<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> 
<h3><a id="6Logger_1178"></a>6.日志器类(Logger)设计（建造者模式）</h3> 
<p>在日志器模块里，我们需要对前面所有模块进行整合，向外提供接口完成不同等级的日志的输出.</p> 
<p>⽇志器主要是⽤来和前端交互， 当我们需要使⽤⽇志系统打印log的时候， 只需要创建Logger对象，调⽤该对象debug、info、warn、error、fatal等⽅法输出⾃⼰想打印的⽇志即可，⽀持解析可变参数列表和输出格式， 即可以做到像使⽤printf函数⼀样打印⽇志。</p> 
<p>当前⽇志系统⽀持同步⽇志 &amp; 异步⽇志两种模式，两个不同的⽇志器唯⼀不同的地⽅在于他们在⽇志的落地⽅式上有所不同：<br> 1.同步⽇志器：直接对⽇志消息进⾏输出。<br> 2.异步⽇志器：将⽇志消息放⼊缓冲区，由异步线程进⾏输出。</p> 
<p><mark>因此⽇志器类在设计的时候先设计出⼀个Logger基类，在Logger基类的基础上，继承出SyncLogger同步⽇志器和AsyncLogger异步⽇志器。<br> 且因为⽇志器模块是对前边多个模块的整合，想要创建⼀个⽇志器，需要设置⽇志器名称，设置⽇志输出等级，设置⽇志器类型，设置⽇志输出格式，设置落地⽅向，且落地⽅向有可能存在多个，整个⽇志器的创建过程较为复杂，为了保持良好的代码⻛格，编写出优雅的代码，因此⽇志器的创建这⾥采⽤了建造者模式来进⾏创建</mark>。<br> 详见代码（show the code）：</p> 
<pre><code class="prism language-cpp"><span class="token comment">/*日志器模块
    1.抽象日志器基类
    2.派生出不同的子类（同步日志器类&amp;异步日志器类）
*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_M_LOGGER_H_</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_M_LOGGER_H_</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_GNU_SOURCE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_GNU_SOURCE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"util.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"level.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"format.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sink.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"looper.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;atomic&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;mutex&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdarg&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unordered_map&gt;</span></span>

<span class="token keyword">namespace</span> HUE
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">class</span> <span class="token class-name">Logger</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token keyword">using</span> ptr <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Logger<span class="token operator">&gt;</span><span class="token punctuation">;</span>
        <span class="token function">Logger</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>logger_name<span class="token punctuation">,</span> LogLevel<span class="token double-colon punctuation">::</span>value level<span class="token punctuation">,</span> Formatter<span class="token double-colon punctuation">::</span>ptr <span class="token operator">&amp;</span>formatter<span class="token punctuation">,</span>
               std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>LogSink<span class="token double-colon punctuation">::</span>ptr<span class="token operator">&gt;</span> <span class="token operator">&amp;</span>sinks<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">_logger_name</span><span class="token punctuation">(</span>logger_name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_limit_level</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_formatter</span><span class="token punctuation">(</span>formatter<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_sinks</span><span class="token punctuation">(</span>sinks<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sinks<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> _logger_name<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 完成构造日志消息对象过程并进行初始化，得到格式化后的日志消息字符串--进行落地输出</span>
        <span class="token keyword">void</span> <span class="token function">debug</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>file<span class="token punctuation">,</span> size_t line<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 通过传入的参数构造出一个日志消息对象，进行日志的格式化，最终落地</span>
            <span class="token comment">// 1.判断当前的日志是否达到了输出等级</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>value<span class="token double-colon punctuation">::</span>DEBUG <span class="token operator">&lt;</span> _limit_level<span class="token punctuation">)</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token comment">// 2.对fmt格式化字符串和不定参进行字符串组织，得到一个新的日志消息字符串</span>
            va_list ap<span class="token punctuation">;</span>
            <span class="token function">va_start</span><span class="token punctuation">(</span>ap<span class="token punctuation">,</span> fmt<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取地址</span>
            <span class="token keyword">char</span> <span class="token operator">*</span>res<span class="token punctuation">;</span>
            <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">vasprintf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>res<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ap<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"vasprintf failed!\n"</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">va_end</span><span class="token punctuation">(</span>ap<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将ap指针置空</span>

            <span class="token function">serialize</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>value<span class="token double-colon punctuation">::</span>DEBUG<span class="token punctuation">,</span> file<span class="token punctuation">,</span> line<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">free</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 防止内存 泄漏，res动态申请的空间</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">info</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>file<span class="token punctuation">,</span> size_t line<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 通过传入的参数构造出一个日志消息对象，进行日志的格式化，最终落地</span>
            <span class="token comment">// 1.判断当前的日志是否达到了输出等级</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>value<span class="token double-colon punctuation">::</span>INFO <span class="token operator">&lt;</span> _limit_level<span class="token punctuation">)</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token comment">// 2.对fmt格式化字符串和不定参进行字符串组织，得到一个新的日志消息字符串</span>
            va_list ap<span class="token punctuation">;</span>
            <span class="token function">va_start</span><span class="token punctuation">(</span>ap<span class="token punctuation">,</span> fmt<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取地址</span>
            <span class="token keyword">char</span> <span class="token operator">*</span>res<span class="token punctuation">;</span>
            <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">vasprintf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>res<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ap<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"vasprintf failed!\n"</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">va_end</span><span class="token punctuation">(</span>ap<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将ap指针置空</span>

            <span class="token function">serialize</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>value<span class="token double-colon punctuation">::</span>INFO<span class="token punctuation">,</span> file<span class="token punctuation">,</span> line<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">free</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 防止内存 泄漏，res动态申请的空间</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">warn</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>file<span class="token punctuation">,</span> size_t line<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 通过传入的参数构造出一个日志消息对象，进行日志的格式化，最终落地</span>
            <span class="token comment">// 1.判断当前的日志是否达到了输出等级</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>value<span class="token double-colon punctuation">::</span>WARN <span class="token operator">&lt;</span> _limit_level<span class="token punctuation">)</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token comment">// 2.对fmt格式化字符串和不定参进行字符串组织，得到一个新的日志消息字符串</span>
            va_list ap<span class="token punctuation">;</span>
            <span class="token function">va_start</span><span class="token punctuation">(</span>ap<span class="token punctuation">,</span> fmt<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取地址</span>
            <span class="token keyword">char</span> <span class="token operator">*</span>res<span class="token punctuation">;</span>
            <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">vasprintf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>res<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ap<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"vasprintf failed!\n"</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">va_end</span><span class="token punctuation">(</span>ap<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将ap指针置空</span>

            <span class="token function">serialize</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>value<span class="token double-colon punctuation">::</span>WARN<span class="token punctuation">,</span> file<span class="token punctuation">,</span> line<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">free</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 防止内存 泄漏，res动态申请的空间</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>file<span class="token punctuation">,</span> size_t line<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 通过传入的参数构造出一个日志消息对象，进行日志的格式化，最终落地</span>
            <span class="token comment">// 1.判断当前的日志是否达到了输出等级</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>value<span class="token double-colon punctuation">::</span>ERROR <span class="token operator">&lt;</span> _limit_level<span class="token punctuation">)</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token comment">// 2.对fmt格式化字符串和不定参进行字符串组织，得到一个新的日志消息字符串</span>
            va_list ap<span class="token punctuation">;</span>
            <span class="token function">va_start</span><span class="token punctuation">(</span>ap<span class="token punctuation">,</span> fmt<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取地址</span>
            <span class="token keyword">char</span> <span class="token operator">*</span>res<span class="token punctuation">;</span>
            <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">vasprintf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>res<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ap<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"vasprintf failed!\n"</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">va_end</span><span class="token punctuation">(</span>ap<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将ap指针置空</span>

            <span class="token function">serialize</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>value<span class="token double-colon punctuation">::</span>ERROR<span class="token punctuation">,</span> file<span class="token punctuation">,</span> line<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">free</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 防止内存 泄漏，res动态申请的空间</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">fatal</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>file<span class="token punctuation">,</span> size_t line<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 通过传入的参数构造出一个日志消息对象，进行日志的格式化，最终落地</span>
            <span class="token comment">// 1.判断当前的日志是否达到了输出等级</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>value<span class="token double-colon punctuation">::</span>FATAL <span class="token operator">&lt;</span> _limit_level<span class="token punctuation">)</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token comment">// 2.对fmt格式化字符串和不定参进行字符串组织，得到一个新的日志消息字符串</span>
            va_list ap<span class="token punctuation">;</span>
            <span class="token function">va_start</span><span class="token punctuation">(</span>ap<span class="token punctuation">,</span> fmt<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取地址</span>
            <span class="token keyword">char</span> <span class="token operator">*</span>res<span class="token punctuation">;</span>
            <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">vasprintf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>res<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ap<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"vasprintf failed!\n"</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">va_end</span><span class="token punctuation">(</span>ap<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将ap指针置空</span>

            <span class="token function">serialize</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>value<span class="token double-colon punctuation">::</span>FATAL<span class="token punctuation">,</span> file<span class="token punctuation">,</span> line<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">free</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 防止内存 泄漏，res动态申请的空间</span>
        <span class="token punctuation">}</span>

    <span class="token keyword">protected</span><span class="token operator">:</span>
        <span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>value level<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>file<span class="token punctuation">,</span> size_t line<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>str<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 3.构造LogMsg对象</span>
            LogMsg <span class="token function">msg</span><span class="token punctuation">(</span>level<span class="token punctuation">,</span> line<span class="token punctuation">,</span> file<span class="token punctuation">,</span> _logger_name<span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 4.通过格式化工具对LogMsg进行格式化，得到格式化后的日志字符串</span>
            std<span class="token double-colon punctuation">::</span>stringstream ss<span class="token punctuation">;</span>
            _formatter<span class="token operator">-&gt;</span><span class="token function">format</span><span class="token punctuation">(</span>ss<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 5.进行日志落地</span>
            <span class="token function">log</span><span class="token punctuation">(</span>ss<span class="token punctuation">.</span><span class="token function">str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ss<span class="token punctuation">.</span><span class="token function">str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 抽象接口完成实际的落地输出 -- 不同的日志器会有不同的实际落地实现方式</span>
        <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">protected</span><span class="token operator">:</span>
        std<span class="token double-colon punctuation">::</span>mutex _mutex<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>string _logger_name<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span>LogLevel<span class="token double-colon punctuation">::</span>value<span class="token operator">&gt;</span> _limit_level<span class="token punctuation">;</span> <span class="token comment">// 原子性 --- 线程安全</span>
        Formatter<span class="token double-colon punctuation">::</span>ptr _formatter<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>LogSink<span class="token double-colon punctuation">::</span>ptr<span class="token operator">&gt;</span> _sinks<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">class</span> <span class="token class-name">SyncLogger</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Logger</span></span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">SyncLogger</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>logger_name<span class="token punctuation">,</span> LogLevel<span class="token double-colon punctuation">::</span>value level<span class="token punctuation">,</span> Formatter<span class="token double-colon punctuation">::</span>ptr <span class="token operator">&amp;</span>formatter<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>LogSink<span class="token double-colon punctuation">::</span>ptr<span class="token operator">&gt;</span> <span class="token operator">&amp;</span>sinks<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">Logger</span><span class="token punctuation">(</span>logger_name<span class="token punctuation">,</span> level<span class="token punctuation">,</span> formatter<span class="token punctuation">,</span> sinks<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

    <span class="token keyword">protected</span><span class="token operator">:</span>
        <span class="token comment">// 同步日志器，是将日志直接通过落地模块句柄进行日志落地</span>
        <span class="token keyword">void</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_sinks<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&amp;</span>sink <span class="token operator">:</span> _sinks<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                sink<span class="token operator">-&gt;</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 异步日志器</span>
    <span class="token keyword">class</span> <span class="token class-name">AsyncLogger</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Logger</span></span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">AsyncLogger</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>logger_name<span class="token punctuation">,</span>
                    LogLevel<span class="token double-colon punctuation">::</span>value level<span class="token punctuation">,</span>
                    Formatter<span class="token double-colon punctuation">::</span>ptr <span class="token operator">&amp;</span>formatter<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>LogSink<span class="token double-colon punctuation">::</span>ptr<span class="token operator">&gt;</span> <span class="token operator">&amp;</span>sinks<span class="token punctuation">,</span>
                    AsyncType looper_type<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">Logger</span><span class="token punctuation">(</span>logger_name<span class="token punctuation">,</span> level<span class="token punctuation">,</span> formatter<span class="token punctuation">,</span> sinks<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                             <span class="token function">_looper</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>AsyncLooper<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>AsyncLogger<span class="token double-colon punctuation">::</span>reallog<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>placeholders<span class="token double-colon punctuation">::</span>_1<span class="token punctuation">)</span><span class="token punctuation">,</span> looper_type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

        <span class="token comment">// 将数据写入缓冲区</span>
        <span class="token keyword">void</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _looper<span class="token operator">-&gt;</span><span class="token function">push</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 设计一个实际落地函数（将缓冲区的数据落地）</span>
        <span class="token keyword">void</span> <span class="token function">reallog</span><span class="token punctuation">(</span>Buffer <span class="token operator">&amp;</span>buf<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_sinks<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&amp;</span>sink <span class="token operator">:</span> _sinks<span class="token punctuation">)</span>   <span class="token punctuation">{<!-- --></span>
                sink<span class="token operator">-&gt;</span><span class="token function">log</span><span class="token punctuation">(</span>buf<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>buf<span class="token punctuation">.</span><span class="token function">readAbleSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token keyword">private</span><span class="token operator">:</span>
        AsyncLooper<span class="token double-colon punctuation">::</span>ptr _looper<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">enum</span> <span class="token class-name">LoggerType</span>
    <span class="token punctuation">{<!-- --></span>
        LOGGER_SYNC<span class="token punctuation">,</span>
        LOGGER_ASYNC
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">/*使用建造者模式去建造日志器，而不是让用户直接去构造日志器，简化用户操作*/</span>
    <span class="token comment">/*
        1.抽象一个日志器建造者类(完成日志器对象所需零部件的构建 &amp; 日志器的构建)
            1.1 设置日志器类型
            1.2 将不同类型日志器的创建放到同一个日志器建造者类中完成
    */</span>
    <span class="token keyword">class</span> <span class="token class-name">LoggerBuilder</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">LoggerBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">_logger_type</span><span class="token punctuation">(</span>LoggerType<span class="token double-colon punctuation">::</span>LOGGER_SYNC<span class="token punctuation">)</span><span class="token punctuation">,</span>
                          <span class="token function">_limit_level</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>value<span class="token double-colon punctuation">::</span>DEBUG<span class="token punctuation">)</span><span class="token punctuation">,</span>
                          <span class="token function">_looper_type</span><span class="token punctuation">(</span>AsyncType<span class="token double-colon punctuation">::</span>ASYNC_SAFE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">buildLoggerType</span><span class="token punctuation">(</span>LoggerType type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> _logger_type <span class="token operator">=</span> type<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">buildEnableUnSafeAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>_looper_type <span class="token operator">=</span> AsyncType<span class="token double-colon punctuation">::</span>ASYNC_UNSAFE<span class="token punctuation">;</span><span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">buildLoggerName</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> _logger_name <span class="token operator">=</span> name<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">buildLoggerLevel</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>value level<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> _limit_level <span class="token operator">=</span> level<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">buildFormatter</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>pattern<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _formatter <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>Formatter<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>pattern<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">SinkType</span><span class="token punctuation">,</span> <span class="token keyword">typename</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> Args<span class="token operator">&gt;</span>
        <span class="token keyword">void</span> <span class="token function">buildSink</span><span class="token punctuation">(</span>Args <span class="token operator">&amp;&amp;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>args<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            LogSink<span class="token double-colon punctuation">::</span>ptr psink <span class="token operator">=</span> SinkFactory<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">create</span><span class="token generic class-name"><span class="token operator">&lt;</span>SinkType<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>Args<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 进行完美转发</span>
            _sinks<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>psink<span class="token punctuation">)</span><span class="token punctuation">;</span>                                                         <span class="token comment">// 添加到日志器数组中</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">virtual</span> Logger<span class="token double-colon punctuation">::</span>ptr <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">protected</span><span class="token operator">:</span>
        AsyncType _looper_type<span class="token punctuation">;</span>
        LoggerType _logger_type<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>string _logger_name<span class="token punctuation">;</span>
        LogLevel<span class="token double-colon punctuation">::</span>value _limit_level<span class="token punctuation">;</span>
        Formatter<span class="token double-colon punctuation">::</span>ptr _formatter<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>LogSink<span class="token double-colon punctuation">::</span>ptr<span class="token operator">&gt;</span> _sinks<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">/*
        2.派生出具体的建造者类 --- 局部日志器的建造者 &amp; 全局日志器的建造者
        （后面添加全局单例管理器之后，将日志器添加全局管理）
    */</span>
    <span class="token keyword">class</span> <span class="token class-name">LocalLoggerBuilder</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">LoggerBuilder</span></span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        Logger<span class="token double-colon punctuation">::</span>ptr <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">override</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">assert</span><span class="token punctuation">(</span>_logger_name<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 必须有日志器名称</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_formatter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                _formatter <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>Formatter<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_sinks<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token generic-function"><span class="token function">buildSink</span><span class="token generic class-name"><span class="token operator">&lt;</span>StdoutSink<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_logger_type <span class="token operator">==</span> LoggerType<span class="token double-colon punctuation">::</span>LOGGER_ASYNC<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>AsyncLogger<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>_logger_name<span class="token punctuation">,</span>_limit_level<span class="token punctuation">,</span>_formatter<span class="token punctuation">,</span>_sinks<span class="token punctuation">,</span>_looper_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>SyncLogger<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>_logger_name<span class="token punctuation">,</span> _limit_level<span class="token punctuation">,</span> _formatter<span class="token punctuation">,</span> _sinks<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">class</span> <span class="token class-name">LoggerManager</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span><span class="token operator">:</span>
            <span class="token keyword">static</span> LoggerManager<span class="token operator">&amp;</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token comment">//C++11针对静态局部变量在编译层面实现线程安全</span>
                <span class="token comment">//当静态局部变量在没有构造完成之前，其他的线程进入就会阻塞</span>
                <span class="token keyword">static</span> LoggerManager eton<span class="token punctuation">;</span>
                <span class="token keyword">return</span> eton<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">void</span> <span class="token function">addLogger</span><span class="token punctuation">(</span>Logger<span class="token double-colon punctuation">::</span>ptr <span class="token operator">&amp;</span>logger<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">hasLogger</span><span class="token punctuation">(</span>logger<span class="token operator">-&gt;</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token punctuation">;</span>
                std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                _loggers<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">make_pair</span><span class="token punctuation">(</span>logger<span class="token operator">-&gt;</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>logger<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">bool</span> <span class="token function">hasLogger</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>name<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">auto</span> it <span class="token operator">=</span> _loggers<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>it <span class="token operator">==</span> _loggers<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            Logger<span class="token double-colon punctuation">::</span>ptr <span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>name<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword">auto</span> it <span class="token operator">=</span> _loggers<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>it <span class="token operator">==</span> _loggers<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> <span class="token class-name">Logger</span><span class="token double-colon punctuation">::</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> it<span class="token operator">-&gt;</span>second<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            Logger<span class="token double-colon punctuation">::</span>ptr <span class="token function">rootLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> _root_logger<span class="token punctuation">;</span> 
            <span class="token punctuation">}</span>

        <span class="token keyword">private</span><span class="token operator">:</span>
            <span class="token function">LoggerManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>HUE<span class="token double-colon punctuation">::</span>LoggerBuilder<span class="token operator">&gt;</span> <span class="token function">builder</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HUE</span><span class="token double-colon punctuation">::</span><span class="token function">LocalLoggerBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                builder<span class="token operator">-&gt;</span><span class="token function">buildLoggerName</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                _root_logger <span class="token operator">=</span> builder<span class="token operator">-&gt;</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
                _loggers<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">make_pair</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">,</span>_root_logger<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">private</span><span class="token operator">:</span>
            std<span class="token double-colon punctuation">::</span>mutex _mutex<span class="token punctuation">;</span>
            Logger<span class="token double-colon punctuation">::</span>ptr _root_logger<span class="token punctuation">;</span><span class="token comment">//默认日志器</span>
            std<span class="token double-colon punctuation">::</span>unordered_map<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token punctuation">,</span>Logger<span class="token double-colon punctuation">::</span>ptr<span class="token operator">&gt;</span> _loggers<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">//设计一个全局日志器的建造者--在局部的基础上增加一个功能：将日志器添加到单例对象里</span>
    <span class="token keyword">class</span> <span class="token class-name">GlobalLoggerBuilder</span><span class="token operator">:</span><span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">LoggerBuilder</span></span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span><span class="token operator">:</span>
            Logger<span class="token double-colon punctuation">::</span>ptr <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">override</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">assert</span><span class="token punctuation">(</span>_logger_name<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 必须有日志器名称</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>_formatter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    _formatter <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>Formatter<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>_sinks<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token generic-function"><span class="token function">buildSink</span><span class="token generic class-name"><span class="token operator">&lt;</span>StdoutSink<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                Logger<span class="token double-colon punctuation">::</span>ptr logger<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>_logger_type <span class="token operator">==</span> LoggerType<span class="token double-colon punctuation">::</span>LOGGER_ASYNC<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//这里要是return了就没有把句柄添加到管理器中了</span>
                    logger <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>AsyncLogger<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>_logger_name<span class="token punctuation">,</span>_limit_level<span class="token punctuation">,</span>_formatter<span class="token punctuation">,</span>_sinks<span class="token punctuation">,</span>_looper_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                    logger <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>SyncLogger<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>_logger_name<span class="token punctuation">,</span> _limit_level<span class="token punctuation">,</span> _formatter<span class="token punctuation">,</span> _sinks<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">LoggerManager</span><span class="token double-colon punctuation">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLogger</span><span class="token punctuation">(</span>logger<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> logger<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> 
<h3><a id="7_AsyncLooper_1543"></a>7. 双缓冲区异步任务处理器（AsyncLooper）设计</h3> 
<p>设计思想：异步处理线程 + 双缓冲区数据池</p> 
<p>因为我们前面完成的是同步日志器的功能，就是直接将日志消息进行格式化写入文件。所有接下来我们要完成的就是异步日志器的实现。<br> 实现思想：为了避免因为写日志的过程阻塞，导致业务线程在写日志的时候影响效率，我们异步的思想就是不让业务线程去进行日志的实际落地操作，而是将日志消息放入缓冲区（一块我们指定的内存）中，接下来有一个专门的异步线程，去针对缓冲区中的数据进行处理（实际的落地操作）。<br> <img src="https://images2.imgbox.com/3b/73/1XpPwiOM_o.png" alt="在这里插入图片描述"><br> 我们采用环形队列来减少内存开辟消耗，同时因为多线程并发，所以缓冲区的操作必须保证线程安全 — 读写加锁</p> 
<blockquote> 
 <p>问题1</p> 
</blockquote> 
<p>因为这个缓冲区的操作会涉及到多线程，因此缓冲区的操作必须保证线程安全<br> 线程安全实现：对缓冲区的读写加锁<br> 又因为写日志操作中，在实际开发中，并不会分配太多的资源，所以工作线程只需要有一个日志器就可以。<br> 这里面涉及的锁冲突：生产者与生产者的互斥&amp;生产者与消费者的互斥</p> 
<blockquote> 
 <p>问题2： 锁冲突较为严重，因为所有线程之间都存在互斥关系</p> 
</blockquote> 
<p>我们采用双缓冲区的设计：1.减少空间频繁申请释放 2.减少生产者消费者锁冲突次数<br> <img src="https://images2.imgbox.com/02/c3/IMIcPpty_o.png" alt="在这里插入图片描述"><br> 对单个缓冲区设计思想：<br> <img src="https://images2.imgbox.com/98/3b/LgYsYIFl_o.png" alt="在这里插入图片描述"><br> 优势：避免了空间的频繁申请释放，且尽可能的减少了⽣产者与消费者之间锁冲突的概率，提⾼了任务处理效率。</p> 
<p>在任务池的设计中，有很多备选⽅案，⽐如循环队列等等，但是不管是哪⼀种都会涉及到锁冲突的情况，因为在⽣产者与消费者模型中，任何两个⻆⾊之间都具有互斥关系，因此每⼀次的任务添加与取出都有可能涉及锁的冲突，⽽双缓冲区不同，双缓冲区是处理器将⼀个缓冲区中的任务全部处理完毕后，然后交换两个缓冲区，重新对新的缓冲区中的任务进⾏处理，虽然同时多线程写⼊也会冲突，但是冲突并不会像每次只处理⼀条的时候频繁（减少了⽣产者与消费者之间的锁冲突），且不涉及到空间的频繁申请释放所带来的消耗。<br> <img src="https://images2.imgbox.com/e1/2b/CdvbYbye_o.png" alt="在这里插入图片描述"><br> buffer.hpp</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;thread&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;mutex&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;atomic&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;condition_variable&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;functional&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cassert&gt;</span></span>
<span class="token keyword">namespace</span> bitlog<span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BUFFER_DEFAULT_SIZE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BUFFER_INCREMENT_SIZE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BUFFER_THRESHOLD_SIZE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">10</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span></span></span>
<span class="token keyword">class</span> <span class="token class-name">Buffer</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
 <span class="token function">Buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token function">_reader_idx</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_writer_idx</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_v</span><span class="token punctuation">(</span>BUFFER_DEFAULT_SIZE<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
 <span class="token keyword">bool</span> <span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> _reader_idx <span class="token operator">==</span> _writer_idx<span class="token punctuation">;</span> <span class="token punctuation">}</span>
 size_t <span class="token function">readAbleSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> _writer_idx <span class="token operator">-</span> _reader_idx<span class="token punctuation">;</span> <span class="token punctuation">}</span>
 size_t <span class="token function">writeAbleSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> _v<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> _writer_idx<span class="token punctuation">;</span> <span class="token punctuation">}</span>
 <span class="token keyword">void</span> <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> _reader_idx <span class="token operator">=</span> _writer_idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
 <span class="token keyword">void</span> <span class="token function">swap</span><span class="token punctuation">(</span>Buffer <span class="token operator">&amp;</span>buf<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 _v<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>buf<span class="token punctuation">.</span>_v<span class="token punctuation">)</span><span class="token punctuation">;</span>
 std<span class="token double-colon punctuation">::</span><span class="token function">swap</span><span class="token punctuation">(</span>_reader_idx<span class="token punctuation">,</span> buf<span class="token punctuation">.</span>_reader_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
 std<span class="token double-colon punctuation">::</span><span class="token function">swap</span><span class="token punctuation">(</span>_writer_idx<span class="token punctuation">,</span> buf<span class="token punctuation">.</span>_writer_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">void</span> <span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
 <span class="token function">assert</span><span class="token punctuation">(</span>len <span class="token operator">&lt;=</span> <span class="token function">writeAbleSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">ensureEnoughSpace</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
 std<span class="token double-colon punctuation">::</span><span class="token function">copy</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> data<span class="token operator">+</span>len<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_v<span class="token punctuation">[</span>_writer_idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 _writer_idx <span class="token operator">+=</span> len<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> <span class="token operator">&amp;</span>_v<span class="token punctuation">[</span>_reader_idx<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
 <span class="token keyword">void</span> <span class="token function">pop</span><span class="token punctuation">(</span>size_t len<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
 _reader_idx <span class="token operator">+=</span> len<span class="token punctuation">;</span> 
 <span class="token function">assert</span><span class="token punctuation">(</span>_reader_idx <span class="token operator">&lt;=</span> _writer_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">protected</span><span class="token operator">:</span>
 <span class="token keyword">void</span> <span class="token function">ensureEnoughSpace</span><span class="token punctuation">(</span>size_t len<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;=</span> <span class="token function">writeAbleSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token comment">/*每次增⼤1M⼤⼩*/</span>
 size_t new_capacity<span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>_v<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> BUFFER_THRESHOLD_SIZE<span class="token punctuation">)</span>
 new_capacity <span class="token operator">=</span> _v<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> len<span class="token punctuation">;</span>
 <span class="token keyword">else</span>
 new_capacity <span class="token operator">=</span> _v<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> BUFFER_INCREMENT_SIZE <span class="token operator">+</span> len<span class="token punctuation">;</span>
 _v<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>new_capacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">private</span><span class="token operator">:</span>
 size_t _reader_idx<span class="token punctuation">;</span>
 size_t _writer_idx<span class="token punctuation">;</span>
 std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">&gt;</span> _v<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>looper.hpp</p> 
<pre><code class="prism language-cpp"><span class="token comment">/*实现异步工作器*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_M_LOOPER_H_</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_M_LOOPER_H_</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">"buffer.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;mutex&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;condition_variable&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;atomic&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;functional&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;memory&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;thread&gt;</span></span>

<span class="token keyword">namespace</span> HUE
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">using</span> Fucntor <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span>Buffer <span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token keyword">enum</span> <span class="token keyword">class</span> <span class="token class-name">AsyncType</span><span class="token punctuation">{<!-- --></span>
        ASYNC_SAFE<span class="token punctuation">,</span><span class="token comment">//安全状态，表示缓冲区满了则阻塞，避免资源耗尽的风险</span>
        ASYNC_UNSAFE <span class="token comment">//不考虑资源耗尽的问题，无限扩容，常用于测试</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">class</span> <span class="token class-name">AsyncLooper</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span><span class="token operator">:</span>
            <span class="token keyword">using</span> ptr <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>AsyncLooper<span class="token operator">&gt;</span><span class="token punctuation">;</span>
            <span class="token function">AsyncLooper</span><span class="token punctuation">(</span><span class="token keyword">const</span> Fucntor <span class="token operator">&amp;</span>cb<span class="token punctuation">,</span>AsyncType looper_type <span class="token operator">=</span>AsyncType<span class="token double-colon punctuation">::</span>ASYNC_SAFE<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">_stop</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">_thread</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">thread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>AsyncLooper<span class="token double-colon punctuation">::</span>threadEntry<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">_callBack</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

            <span class="token operator">~</span><span class="token function">AsyncLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
            <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                 _stop <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                 _cond_con<span class="token punctuation">.</span><span class="token function">notify_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//唤醒所有的工作线程</span>
                 _thread<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待工作线程的退出</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">void</span> <span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span>size_t len<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token comment">//1.无限扩容 - 非安全    2.固定大小 - 生产缓冲区中数据满了就阻塞</span>
                std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//条件变量空值，若缓冲区剩余空间大小大于数据长度，则可以添加数据</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>_looper_type <span class="token operator">==</span> AsyncType<span class="token double-colon punctuation">::</span>ASYNC_SAFE<span class="token punctuation">)</span>
                    _cond_pro<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lock<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token keyword">return</span> _pro_buf<span class="token punctuation">.</span><span class="token function">writeAbleSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span>len<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//能走下来说明可以向缓冲区中添加数据</span>
                _pro_buf<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//唤醒消费者对缓冲区中的数据进行处理</span>
                _cond_con<span class="token punctuation">.</span><span class="token function">notify_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">private</span><span class="token operator">:</span>
            <span class="token comment">//线程入口函数--对消费缓冲区中的数据进行处理，处理完毕后，初始化缓冲区，交换缓冲区</span>
            <span class="token keyword">void</span> <span class="token function">threadEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                     <span class="token comment">//为互斥锁设置一个生命周期，当缓冲区交换完毕后解锁（并不对数据的处理过程加锁保护）</span>
                    <span class="token punctuation">{<!-- --></span>
                     <span class="token comment">//1.判断生产缓冲区有没有数据，有则交换，无则阻塞</span>
                    std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//退出标志被设置，且生产缓冲区已无数据，此时退出，否则有可能造成生产缓冲区中有数据但没被完全处理</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>_stop <span class="token operator">&amp;&amp;</span> _pro_buf<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token comment">//若退出前被唤醒或者有数据被唤醒，则返回真，继续向下运行，否则重新休眠 </span>
                    _cond_con<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lock<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token keyword">return</span> _stop <span class="token operator">||</span><span class="token operator">!</span> _pro_buf<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    _con_buf<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>_pro_buf<span class="token punctuation">)</span><span class="token punctuation">;</span> 
                     <span class="token comment">//2.唤醒生产者</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>_looper_type <span class="token operator">==</span> AsyncType<span class="token double-colon punctuation">::</span>ASYNC_SAFE<span class="token punctuation">)</span>
                        _cond_pro<span class="token punctuation">.</span><span class="token function">notify_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                     <span class="token comment">//3.被唤醒后，对消费缓冲区进行数据处理 </span>
                     <span class="token function">_callBack</span><span class="token punctuation">(</span>_con_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
                     <span class="token comment">//4.初始化消费缓冲区</span>
                     _con_buf<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">private</span><span class="token operator">:</span>
            Fucntor _callBack<span class="token punctuation">;</span><span class="token comment">//具体对缓冲区数据进行处理的回调函数，由异步工作器使用者进行传入</span>
        <span class="token keyword">private</span><span class="token operator">:</span>
            AsyncType _looper_type<span class="token punctuation">;</span>
            <span class="token keyword">bool</span> _stop<span class="token punctuation">;</span><span class="token comment">//工作器停止标志</span>
            Buffer _pro_buf<span class="token punctuation">;</span> <span class="token comment">//生产缓冲区</span>
            Buffer _con_buf<span class="token punctuation">;</span><span class="token comment">//消费缓冲区</span>
            std<span class="token double-colon punctuation">::</span>mutex _mutex<span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>condition_variable _cond_pro<span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>condition_variable _cond_con<span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>thread _thread<span class="token punctuation">;</span><span class="token comment">//异步工作器对应的工作线程</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> 
<h3><a id="8AsyncLogger_1709"></a>8.异步日志器(AsyncLogger)设计</h3> 
<p>这里异步工作器使用双缓冲区思想：外界将任务数据，添加到输入缓冲区中，异步线程对处理缓冲区中的数据进行处理，若处理缓冲区中没有了数据则交换缓冲区。</p> 
<p>异步⽇志器类继承⾃⽇志器类， 并在同步⽇志器类上拓展了异步消息处理器。当我们需要异步输出⽇志的时候， 需要创建异步⽇志器和消息处理器， 调⽤异步⽇志器的log、error、info、fatal等函数输出不同级别⽇志。<br> • log函数为重写Logger类的函数， 主要实现将⽇志数据加⼊异步队列缓冲区中<br> • realLog函数主要由异步线程进⾏调⽤(是为异步消息处理器设置的回调函数)，完成⽇志的实际落地⼯作。</p> 
<p>实现脑图：<br> <img src="https://images2.imgbox.com/18/f1/7aFd7n1e_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">AsyncLogger</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Logger</span></span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
 <span class="token keyword">using</span> ptr <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>AsyncLogger<span class="token operator">&gt;</span><span class="token punctuation">;</span>
 <span class="token function">AsyncLogger</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>name<span class="token punctuation">,</span> 
 Formatter<span class="token double-colon punctuation">::</span>ptr formatter<span class="token punctuation">,</span> 
 std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>LogSink<span class="token double-colon punctuation">::</span>ptr<span class="token operator">&gt;</span> <span class="token operator">&amp;</span>sinks<span class="token punctuation">,</span> 
 LogLevel<span class="token double-colon punctuation">::</span>value level <span class="token operator">=</span> LogLevel<span class="token double-colon punctuation">::</span>value<span class="token double-colon punctuation">::</span>DEBUG<span class="token punctuation">)</span><span class="token operator">:</span> 
 <span class="token function">Logger</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> formatter<span class="token punctuation">,</span> sinks<span class="token punctuation">,</span> level<span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token function">_looper</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>AsyncLooper<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
 std<span class="token double-colon punctuation">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>AsyncLogger<span class="token double-colon punctuation">::</span>backendLogIt<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> 
std<span class="token double-colon punctuation">::</span>placeholders<span class="token double-colon punctuation">::</span>_1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token class-name">LogLevel</span><span class="token double-colon punctuation">::</span><span class="token function">toString</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">"异步⽇志器: "</span><span class="token operator">&lt;&lt;</span>name<span class="token operator">&lt;&lt;</span>"创建成
功<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n"<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">protected</span><span class="token operator">:</span>
 <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 _looper<span class="token operator">-&gt;</span><span class="token function">push</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">void</span> <span class="token function">realLog</span><span class="token punctuation">(</span>Buffer <span class="token operator">&amp;</span>msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>_sinks<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
 <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&amp;</span>it <span class="token operator">:</span> _sinks<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 it<span class="token operator">-&gt;</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">readAbleSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">protected</span><span class="token operator">:</span>
 AsyncLooper<span class="token double-colon punctuation">::</span>ptr _looper<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="9_1747"></a>9.单例日志器管理类设计（单例模式）</h3> 
<p>⽇志的输出，我们希望能够在任意位置都可以进⾏，但是当我们创建了⼀个⽇志器之后，就会受到⽇志器所在作⽤域的访问属性限制。<br> 因此，为了突破访问区域的限制，我们创建⼀个⽇志器管理类，且这个类是⼀个单例类，这样的话，我们就可以在任意位置来通过管理器单例获取到指定的⽇志器来进⾏⽇志输出了。<br> 基于单例⽇志器管理器的设计思想，我们对于⽇志器建造者类进⾏继承，继承出⼀个全局⽇志器建造者类，实现⼀个⽇志器在创建完毕后，直接将其添加到单例的⽇志器管理器中，以便于能够在任何位置通过⽇志器名称能够获取到指定的⽇志器进⾏⽇志输出。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">loggerManager</span><span class="token punctuation">{<!-- --></span>
 <span class="token keyword">private</span><span class="token operator">:</span>
 std<span class="token double-colon punctuation">::</span>mutex _mutex<span class="token punctuation">;</span>
 Logger<span class="token double-colon punctuation">::</span>ptr _root_logger<span class="token punctuation">;</span>
 std<span class="token double-colon punctuation">::</span>unordered_map<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token punctuation">,</span> Logger<span class="token double-colon punctuation">::</span>ptr<span class="token operator">&gt;</span> _loggers<span class="token punctuation">;</span>
 <span class="token keyword">private</span><span class="token operator">:</span>
 <span class="token function">loggerManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> 
 std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>LocalLoggerBuilder<span class="token operator">&gt;</span> <span class="token function">slb</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">LocalLoggerBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 slb<span class="token operator">-&gt;</span><span class="token function">buildLoggerName</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 slb<span class="token operator">-&gt;</span><span class="token function">buildLoggerType</span><span class="token punctuation">(</span>Logger<span class="token double-colon punctuation">::</span>Type<span class="token double-colon punctuation">::</span>LOGGER_SYNC<span class="token punctuation">)</span><span class="token punctuation">;</span>
 _root_logger <span class="token operator">=</span> slb<span class="token operator">-&gt;</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 _loggers<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">make_pair</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">,</span> _root_logger<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token function">loggerManager</span><span class="token punctuation">(</span><span class="token keyword">const</span> loggerManager<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
 loggerManager <span class="token operator">&amp;</span><span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> loggerManager<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
 <span class="token keyword">static</span> loggerManager<span class="token operator">&amp;</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">static</span> loggerManager lm<span class="token punctuation">;</span>
 <span class="token keyword">return</span> lm<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">bool</span> <span class="token function">hasLogger</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">auto</span> it <span class="token operator">=</span> _loggers<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>it <span class="token operator">==</span> _loggers<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">void</span> <span class="token function">addLogger</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>name<span class="token punctuation">,</span> <span class="token keyword">const</span> Logger<span class="token double-colon punctuation">::</span>ptr logger<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
 _loggers<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">make_pair</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> logger<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 Logger<span class="token double-colon punctuation">::</span>ptr <span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">auto</span> it <span class="token operator">=</span> _loggers<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>it <span class="token operator">==</span> _loggers<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">return</span> <span class="token class-name">Logger</span><span class="token double-colon punctuation">::</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">return</span> it<span class="token operator">-&gt;</span>second<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 Logger<span class="token double-colon punctuation">::</span>ptr <span class="token function">rootLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> _root_logger<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">GlobalLoggerBuilder</span><span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> Logger<span class="token double-colon punctuation">::</span><span class="token class-name">Builder</span></span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
 <span class="token keyword">virtual</span> Logger<span class="token double-colon punctuation">::</span>ptr <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>_logger_name<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"⽇志器名称不能为空！！"</span><span class="token punctuation">;</span>
 <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token function">assert</span><span class="token punctuation">(</span>loggerManager<span class="token double-colon punctuation">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasLogger</span><span class="token punctuation">(</span>_logger_name<span class="token punctuation">)</span> <span class="token operator">==</span> 
<span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>_formatter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"当前⽇志器："</span> <span class="token operator">&lt;&lt;</span> _logger_name <span class="token operator">&lt;&lt;</span><span class="token punctuation">;</span>
 std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">" 未检测到⽇志格式，默认设置为"</span><span class="token punctuation">;</span>
 std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> "<span class="token punctuation">[</span> <span class="token operator">%</span>d<span class="token punctuation">{<!-- --></span><span class="token operator">%</span>H<span class="token operator">:</span><span class="token operator">%</span>M<span class="token operator">:</span><span class="token operator">%</span>S<span class="token punctuation">}</span><span class="token operator">%</span>T<span class="token operator">%</span>t<span class="token operator">%</span>T<span class="token punctuation">[</span><span class="token operator">%</span>p<span class="token punctuation">]</span><span class="token operator">%</span>T<span class="token punctuation">[</span><span class="token operator">%</span>c<span class="token punctuation">]</span><span class="token operator">%</span>T<span class="token operator">%</span>f<span class="token operator">:</span><span class="token operator">%</span>l<span class="token operator">%</span>T<span class="token operator">%</span>m<span class="token operator">%</span>n 
<span class="token punctuation">]</span><span class="token operator">!</span>\n"<span class="token punctuation">;</span>
 _formatter <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>Formatter<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>_sinks<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"当前⽇志器："</span> <span class="token operator">&lt;&lt;</span> _logger_name <span class="token operator">&lt;&lt;</span><span class="token punctuation">;</span>
 std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">" 未检测到落地⽅向，默认设置为标准输出!\n"</span><span class="token punctuation">;</span>
 _sinks<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>StdoutSink<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 Logger<span class="token double-colon punctuation">::</span>ptr lp<span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>_logger_type <span class="token operator">==</span> Logger<span class="token double-colon punctuation">::</span>Type<span class="token double-colon punctuation">::</span>LOGGER_ASYNC<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 lp <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>AsyncLogger<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>_logger_name<span class="token punctuation">,</span>_formatter<span class="token punctuation">,</span> 
_sinks<span class="token punctuation">,</span> _level<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
 lp <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>SyncLogger<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>_logger_name<span class="token punctuation">,</span> _formatter<span class="token punctuation">,</span> 
_sinks<span class="token punctuation">,</span> _level<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 loggerManager<span class="token double-colon punctuation">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLogger</span><span class="token punctuation">(</span>_logger_name<span class="token punctuation">,</span> lp<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> lp<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="10_1831"></a>10.日志宏&amp;全局接口设计（代理模式）</h3> 
<p>我们最后提供全局接口和一些宏函数，对日志系统的接口进行使用便捷性优化。<br> 这里使用代理模式通过全局函数或宏函数来代理Logger类的log、debug、info、warn、error、fatal等接口，以便于控制源码⽂件名称和⾏号的输出控制，简化⽤⼾操作。<br> 当仅需标准输出⽇志的时候可以通过主⽇志器来打印⽇志。 且操作时只需要通过宏函数直接进⾏输出即可。</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_M_HUELOG_H_</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_M_HUELOG_H_</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">"logger.hpp"</span></span>

<span class="token keyword">namespace</span> HUE<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//1.提供获取指定日志器的全局接口(避免用户自己操作单例对象)</span>
    Logger<span class="token double-colon punctuation">::</span>ptr <span class="token function">getlogger</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>name<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> HUE<span class="token double-colon punctuation">::</span><span class="token class-name">LoggerManager</span><span class="token double-colon punctuation">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    Logger<span class="token double-colon punctuation">::</span>ptr <span class="token function">rootLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> HUE<span class="token double-colon punctuation">::</span><span class="token class-name">LoggerManager</span><span class="token double-colon punctuation">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rootLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//2.使用宏函数对日志器的接口进行代理(代理模式)</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">debug</span><span class="token expression"><span class="token punctuation">(</span>fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token function">debug</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">,</span><span class="token constant">__LINE__</span><span class="token punctuation">,</span>fmt<span class="token punctuation">,</span></span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span></span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">info</span><span class="token expression"><span class="token punctuation">(</span>fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token function">info</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">,</span><span class="token constant">__LINE__</span><span class="token punctuation">,</span>fmt<span class="token punctuation">,</span></span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span></span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">warn</span><span class="token expression"><span class="token punctuation">(</span>fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token function">warn</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">,</span><span class="token constant">__LINE__</span><span class="token punctuation">,</span>fmt<span class="token punctuation">,</span></span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span></span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">error</span><span class="token expression"><span class="token punctuation">(</span>fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">,</span><span class="token constant">__LINE__</span><span class="token punctuation">,</span>fmt<span class="token punctuation">,</span></span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span></span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">fatal</span><span class="token expression"><span class="token punctuation">(</span>fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token function">fatal</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">,</span><span class="token constant">__LINE__</span><span class="token punctuation">,</span>fmt<span class="token punctuation">,</span></span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span></span></span>

    <span class="token comment">//3.提供宏函数，直接通过默认日志器进行日志的标准输出打印(不用获取日志器了)</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">DEBUG</span><span class="token expression"><span class="token punctuation">(</span>fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token class-name">HUE</span><span class="token double-colon punctuation">::</span><span class="token function">rootLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">debug</span><span class="token punctuation">(</span>fmt<span class="token punctuation">,</span></span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span></span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">INFO</span><span class="token expression"><span class="token punctuation">(</span>fmt<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>  <span class="token class-name">HUE</span><span class="token double-colon punctuation">::</span><span class="token function">rootLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">info</span><span class="token punctuation">(</span>fmt<span class="token punctuation">,</span></span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span></span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">WARN</span><span class="token expression"><span class="token punctuation">(</span>fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>  <span class="token class-name">HUE</span><span class="token double-colon punctuation">::</span><span class="token function">rootLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">warn</span><span class="token punctuation">(</span>fmt<span class="token punctuation">,</span></span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span></span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ERROR</span><span class="token expression"><span class="token punctuation">(</span>fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token class-name">HUE</span><span class="token double-colon punctuation">::</span><span class="token function">rootLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">error</span><span class="token punctuation">(</span>fmt<span class="token punctuation">,</span></span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span></span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">FATAL</span><span class="token expression"><span class="token punctuation">(</span>fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>  <span class="token class-name">HUE</span><span class="token double-colon punctuation">::</span><span class="token function">rootLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">fatal</span><span class="token punctuation">(</span>fmt<span class="token punctuation">,</span></span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span></span></span>
<span class="token punctuation">}</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> 
<h2><a id="_1866"></a>五、项目测试</h2> 
<p>在完成项目编写之后，我们需要测试⼀个日志器中包含有所有的落地方向，观察是否每个方向都正常落地，分别测试同步方式和异步方式落地后数据是否正常。</p> 
<p>因为不同的测试环境所呈现的测试数据差异巨大，所以<strong>这里先介绍一下我的测试环境：</strong><br> 1.我使用的腾讯云轻量级服务器，它的配置是：<br> CentOS7，2G RAM ，CPU 2核心 ，40G ROM<br> <img src="https://images2.imgbox.com/76/fe/hfVzMAwB_o.png" alt="在这里插入图片描述"><br> 这里会测试：同步下的单线程/多线程，异步下的单线程/多线程情况下，对100万条日志进行滚动文件输出，对比二者在不同情况下的性能差异</p> 
<p>主要的测试方法是：每秒能打印日志数 = 打印日志条数 / 总的打印日志消耗时间<br> 主要测试要素：同步/异步 &amp; 单线程/多线程<br> • 100w+条指定长度的日志输出所耗时间<br> • 每秒可以输出多少条日志<br> • 每秒可以输出多少MB日志</p> 
<p>注意：异步测试输出，我们启动非安全模式，纯内存写入（不考虑实际落地时间）<br> <mark>下面是我编写的测试工具类</mark><br> <img src="https://images2.imgbox.com/bd/f3/7XLZ2mlf_o.png" alt="在这里插入图片描述"><br> 1.同步日志单线程输出测试：<br> <img src="https://images2.imgbox.com/26/e9/WrvYri4x_o.png" alt="在这里插入图片描述"></p> 
<p>2.同步日志多线程输出测试：<br> <img src="https://images2.imgbox.com/ea/23/ujdaP7Qq_o.png" alt="在这里插入图片描述"><br> 3.异步日志单线程输出测试：<br> <img src="https://images2.imgbox.com/8a/6b/xVajhZr9_o.png" alt="在这里插入图片描述"><br> 4.异步日志多线程输出测试：<br> <img src="https://images2.imgbox.com/98/6d/4Az4VgjS_o.png" alt="在这里插入图片描述"><br> <mark>我们能够通过上边的测试看出来，⼀些情况</mark>：<br> 在单线程情况下，异步效率看起来还没有同步⾼，这个我们得了解，现在的IO操作在⽤⼾态都会有缓冲区进行缓冲区，因此我们当前测试⽤例看起来的同步其实⼤多时候也是在操作内存，只有在缓冲区满了才会涉及到阻塞写磁盘操作，⽽异步单线程效率看起来低，也有⼀个很重要的原因就是单线程同步操作中不存在锁冲突，⽽单线程异步⽇志操作存在⼤量的锁冲突，因此性能也会有⼀定的降低。</p> 
<p>但是，我们也要看到限制同步⽇志效率的最⼤原因是磁盘性能，打⽇志的线程多少并⽆明显区别，线程多了反⽽会降低，因为增加了磁盘的读写争抢，⽽对于异步⽇志的限制，并⾮磁盘的性能，⽽是cpu的处理性能，打⽇志并不会因为落地⽽阻塞，因此在多线程打⽇志的情况下性能有了显著的提高。</p> 
<hr> 
<p>最后说一下，这个日志器系统在简单整理之后我们只需要将项目实现放到logs文件夹里，在使用时我们只需要包含一个全局接口的mylog.h头文件即可。<br> <img src="https://images2.imgbox.com/07/f0/mjljjT3d_o.png" alt="在这里插入图片描述"><br> <strong>扩展方向：</strong><br> <mark>sink类型扩展</mark><br> ◦ ⽀持按⼩时按天滚动⽂件<br> ◦ ⽀持将log通过⽹络传输落地到⽇志服务器(tcp/udp)<br> ◦ ⽀持在控制台通过⽇志等级渲染不同颜⾊输出⽅便定位<br> ◦ ⽀持落地⽇志到数据库<br> ◦ ⽀持配置服务器地址，将⽇志落地到远程服务器<br> <mark>实现⽇志服务器负责存储⽇志并提供检索、分析、展示等功能</mark></p> 
<h2><a id="_1908"></a>参考资料</h2> 
<p>https://www.imangodoc.com/174918.html<br> https://blog.csdn.net/w1014074794/article/details/125074038<br> https://zhuanlan.zhihu.com/p/472569975<br> https://zhuanlan.zhihu.com/p/460476053<br> https://gitee.com/davidditao/DDlog<br> https://www.cnblogs.com/ailumiyana/p/9519614.html<br> https://gitee.com/lqk1949/plog/<br> https://www.cnblogs.com/horacle/p/15494358.html<br> https://blog.csdn.net/qq_29220369/article/details/127314390</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8a9f8e5f7d8a92b1ec22d00518f0d6a2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【vue3 $refs和特殊attr：ref 】获取子组件实例 &amp; 规范获取Dom元素；（统称模板引用）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/43ce80da145c0fc61538b45e2168bcc1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">python批量修改word文档，替换word文档文字</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>