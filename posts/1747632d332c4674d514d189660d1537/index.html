<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android 动态广播注册流程(广播1) - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android 动态广播注册流程(广播1)" />
<meta property="og:description" content="Android 动态广播注册流程 1. 动态广播注册的流程2. 新建一个动态广播接收者3. App部分的registerReceiver4. system_server侧的广播注册5. 总结一下 1. 动态广播注册的流程 先看一下大致文件和流程如下（activity中动态注册广播）：
2. 新建一个动态广播接收者 广播好久之前就准备写了，最近有时间就先把广播这部分写完
这篇文章就先将动态广播注册的流程
先看一下，在一个activity中注册一个亮屏的动态广播
//新建一个BroadcastReceiver，用于接收广播 public BroadcastReceiver mDynamicReceiver = new BroadcastReceiver() { @Override public void onReceive(Context context, Intent intent) { //onReceive是广播处理的时候的接收方法 Log.e(&#34;yunhen&#34;, &#34;MyReceiver dynamic intent = &#34; &#43; intent.getAction()); } }; //在需要注册广播的时候调用，写下类似下面的代码 //新建一个IntentFilter，意图过滤器 IntentFilter filter = new IntentFilter(); //增加亮屏的行为action filter.addAction(Intent.ACTION_SCREEN_ON); //注册广播，广播接受者是mDynamicReceiver，意图过滤器是filter mContext.registerReceiver(mDynamicReceiver, filter); 3. App部分的registerReceiver activity中的registerReceiver，其调用的是ContextWrapper的registerReceiver //ContextWrapper.java public Intent registerReceiver(@Nullable BroadcastReceiver receiver, IntentFilter filter) { return mBase.registerReceiver(receiver, filter); } 1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/1747632d332c4674d514d189660d1537/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-10T20:23:05+08:00" />
<meta property="article:modified_time" content="2023-06-10T20:23:05+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android 动态广播注册流程(广播1)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>Android 动态广播注册流程</h4> 
 <ul><li><a href="#1__3" rel="nofollow">1. 动态广播注册的流程</a></li><li><a href="#2__9" rel="nofollow">2. 新建一个动态广播接收者</a></li><li><a href="#3_AppregisterReceiver_37" rel="nofollow">3. App部分的registerReceiver</a></li><li><a href="#4_system_server_395" rel="nofollow">4. system_server侧的广播注册</a></li><li><a href="#5__710" rel="nofollow">5. 总结一下</a></li></ul> 
</div> 
<p></p> 
<h2><a id="1__3"></a>1. 动态广播注册的流程</h2> 
<p>先看一下大致文件和流程如下（activity中动态注册广播）：<br> <img src="https://images2.imgbox.com/5d/e5/z5kOdq9q_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="2__9"></a>2. 新建一个动态广播接收者</h2> 
<p>广播好久之前就准备写了，最近有时间就先把广播这部分写完</p> 
<p>这篇文章就先将动态广播注册的流程</p> 
<p>先看一下，在一个activity中注册一个亮屏的动态广播</p> 
<pre><code class="prism language-java">    <span class="token comment">//新建一个BroadcastReceiver，用于接收广播</span>
    <span class="token keyword">public</span> BroadcastReceiver mDynamicReceiver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BroadcastReceiver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onReceive</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> Intent intent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//onReceive是广播处理的时候的接收方法</span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"yunhen"</span><span class="token punctuation">,</span> <span class="token string">"MyReceiver dynamic intent = "</span> <span class="token operator">+</span> intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

	<span class="token comment">//在需要注册广播的时候调用，写下类似下面的代码</span>
	<span class="token comment">//新建一个IntentFilter，意图过滤器</span>
	IntentFilter filter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntentFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//增加亮屏的行为action</span>
	filter<span class="token punctuation">.</span><span class="token function">addAction</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>ACTION_SCREEN_ON<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//注册广播，广播接受者是mDynamicReceiver，意图过滤器是filter</span>
	mContext<span class="token punctuation">.</span><span class="token function">registerReceiver</span><span class="token punctuation">(</span>mDynamicReceiver<span class="token punctuation">,</span> filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h2><a id="3_AppregisterReceiver_37"></a>3. App部分的registerReceiver</h2> 
<ol><li>activity中的registerReceiver，其调用的是ContextWrapper的registerReceiver</li></ol> 
<pre><code class="prism language-java"><span class="token comment">//ContextWrapper.java</span>
    <span class="token keyword">public</span> Intent <span class="token function">registerReceiver</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> BroadcastReceiver receiver<span class="token punctuation">,</span> IntentFilter filter<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> mBase<span class="token punctuation">.</span><span class="token function">registerReceiver</span><span class="token punctuation">(</span>receiver<span class="token punctuation">,</span> filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>1.1) 至于mBase就是ContextImpl，这个又是在哪里设置的呢？<br> 一个是在构造函数里面设置，一个是调用<code>attachBaseContext</code>设置，<br> 如果是activity的mBase则是调用<code>attachBaseContext</code>设置</p> 
<pre><code class="prism language-java"><span class="token comment">//ContextWrapper.java</span>
    <span class="token keyword">public</span> <span class="token function">ContextWrapper</span><span class="token punctuation">(</span>Context base<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mBase <span class="token operator">=</span> base<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">attachBaseContext</span><span class="token punctuation">(</span>Context base<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mBase <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Base context already set"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mBase <span class="token operator">=</span> base<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>1.2) 在ActivityThread.java的performLaunchActivity(启动应用时发出的LaunchActivityItem会执行activity生命周期的内容)<br> 会新建new ContextImpl，并进行mBase赋值<br> //新建new ContextImpl流程<br> <code>ActivityThread.java</code>: performLaunchActivity-&gt;createBaseContextForActivity<br> <code>ContextImpl.java</code>: -&gt;createActivityContext-&gt;new ContextImpl</p> 
<p>得到ContextImpl之后通过activity.attach进行mBase下一步赋值</p> 
<pre><code class="prism language-java"><span class="token comment">//ActivityThread.java</span>
<span class="token keyword">private</span> Activity <span class="token function">performLaunchActivity</span><span class="token punctuation">(</span>ActivityClientRecord r<span class="token punctuation">,</span> Intent customIntent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">//...</span>
<span class="token comment">//创建ContextImpl</span>
ContextImpl appContext <span class="token operator">=</span> <span class="token function">createBaseContextForActivity</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//...</span>
<span class="token comment">//将ContextImpl的mOuterContext设置成activity</span>
appContext<span class="token punctuation">.</span><span class="token function">setOuterContext</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//将appContext赋值给Activity(Activity是ContextWrapper的子类)的mBase对象，</span>
<span class="token comment">//在这里上面2个(mBase/mOuterContext)是一样的</span>
activity<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>appContext<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">getInstrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>token<span class="token punctuation">,</span>
        r<span class="token punctuation">.</span>ident<span class="token punctuation">,</span> app<span class="token punctuation">,</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">,</span> r<span class="token punctuation">.</span>activityInfo<span class="token punctuation">,</span> title<span class="token punctuation">,</span> r<span class="token punctuation">.</span>parent<span class="token punctuation">,</span>
        r<span class="token punctuation">.</span>embeddedID<span class="token punctuation">,</span> r<span class="token punctuation">.</span>lastNonConfigurationInstances<span class="token punctuation">,</span> config<span class="token punctuation">,</span>
        r<span class="token punctuation">.</span>referrer<span class="token punctuation">,</span> r<span class="token punctuation">.</span>voiceInteractor<span class="token punctuation">,</span> window<span class="token punctuation">,</span> r<span class="token punctuation">.</span>configCallback<span class="token punctuation">,</span>
        r<span class="token punctuation">.</span>assistToken<span class="token punctuation">,</span> r<span class="token punctuation">.</span>shareableActivityToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//...</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> ContextImpl <span class="token function">createBaseContextForActivity</span><span class="token punctuation">(</span>ActivityClientRecord r<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">final</span> <span class="token keyword">int</span> displayId <span class="token operator">=</span> ActivityClient<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDisplayId</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//此处在ActivityThread将this传入ContextImpl的mMainThread</span>
    ContextImpl appContext <span class="token operator">=</span> ContextImpl<span class="token punctuation">.</span><span class="token function">createActivityContext</span><span class="token punctuation">(</span>
            <span class="token keyword">this</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>packageInfo<span class="token punctuation">,</span> r<span class="token punctuation">.</span>activityInfo<span class="token punctuation">,</span> r<span class="token punctuation">.</span>token<span class="token punctuation">,</span> displayId<span class="token punctuation">,</span> r<span class="token punctuation">.</span>overrideConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//...</span>
    <span class="token keyword">return</span> appContext<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//ContextImpl.java</span>
<span class="token keyword">static</span> ContextImpl <span class="token function">createActivityContext</span><span class="token punctuation">(</span>ActivityThread mainThread<span class="token punctuation">,</span>
        LoadedApk packageInfo<span class="token punctuation">,</span> ActivityInfo activityInfo<span class="token punctuation">,</span> IBinder activityToken<span class="token punctuation">,</span> <span class="token keyword">int</span> displayId<span class="token punctuation">,</span>
        Configuration overrideConfiguration<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>packageInfo <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"packageInfo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    String<span class="token punctuation">[</span><span class="token punctuation">]</span> splitDirs <span class="token operator">=</span> packageInfo<span class="token punctuation">.</span><span class="token function">getSplitResDirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//这里是LoadedApk的getClassLoader</span>
    ClassLoader classLoader <span class="token operator">=</span> packageInfo<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>packageInfo<span class="token punctuation">.</span><span class="token function">getApplicationInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">requestsIsolatedSplitLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Trace<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span>Trace<span class="token punctuation">.</span>TRACE_TAG_RESOURCES<span class="token punctuation">,</span> <span class="token string">"SplitDependencies"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            classLoader <span class="token operator">=</span> packageInfo<span class="token punctuation">.</span><span class="token function">getSplitClassLoader</span><span class="token punctuation">(</span>activityInfo<span class="token punctuation">.</span>splitName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            splitDirs <span class="token operator">=</span> packageInfo<span class="token punctuation">.</span><span class="token function">getSplitPaths</span><span class="token punctuation">(</span>activityInfo<span class="token punctuation">.</span>splitName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NameNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Nothing above us can handle a NameNotFoundException, better crash.</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>Trace<span class="token punctuation">.</span>TRACE_TAG_RESOURCES<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">final</span> String attributionTag<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>activityInfo<span class="token punctuation">.</span>attributionTags <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> activityInfo<span class="token punctuation">.</span>attributionTags<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        attributionTag <span class="token operator">=</span> activityInfo<span class="token punctuation">.</span>attributionTags<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        attributionTag <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//新建new ContextImpl，注意传入参数mainThread、classLoader等，还有createActivityContext函数的一些resources初始化</span>
	<span class="token comment">//传入的UserHandle user是null</span>
    ContextImpl context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ContextImpl</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> mainThread<span class="token punctuation">,</span> packageInfo<span class="token punctuation">,</span> ContextParams<span class="token punctuation">.</span>EMPTY<span class="token punctuation">,</span>
            attributionTag<span class="token punctuation">,</span> null<span class="token punctuation">,</span> activityInfo<span class="token punctuation">.</span>splitName<span class="token punctuation">,</span> activityToken<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> classLoader<span class="token punctuation">,</span>
            null<span class="token punctuation">)</span><span class="token punctuation">;</span>
    context<span class="token punctuation">.</span>mContextType <span class="token operator">=</span> CONTEXT_TYPE_ACTIVITY<span class="token punctuation">;</span>
    context<span class="token punctuation">.</span>mIsConfigurationBasedContext <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token comment">// Clamp display ID to DEFAULT_DISPLAY if it is INVALID_DISPLAY.</span>
    displayId <span class="token operator">=</span> <span class="token punctuation">(</span>displayId <span class="token operator">!=</span> Display<span class="token punctuation">.</span>INVALID_DISPLAY<span class="token punctuation">)</span> <span class="token operator">?</span> displayId <span class="token operator">:</span> Display<span class="token punctuation">.</span>DEFAULT_DISPLAY<span class="token punctuation">;</span>

    <span class="token keyword">final</span> CompatibilityInfo compatInfo <span class="token operator">=</span> <span class="token punctuation">(</span>displayId <span class="token operator">==</span> Display<span class="token punctuation">.</span>DEFAULT_DISPLAY<span class="token punctuation">)</span>
            <span class="token operator">?</span> packageInfo<span class="token punctuation">.</span><span class="token function">getCompatibilityInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">:</span> CompatibilityInfo<span class="token punctuation">.</span>DEFAULT_COMPATIBILITY_INFO<span class="token punctuation">;</span>

    <span class="token keyword">final</span> ResourcesManager resourcesManager <span class="token operator">=</span> ResourcesManager<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the base resources for which all configuration contexts for this Activity</span>
    <span class="token comment">// will be rebased upon.</span>
    context<span class="token punctuation">.</span><span class="token function">setResources</span><span class="token punctuation">(</span>resourcesManager<span class="token punctuation">.</span><span class="token function">createBaseTokenResources</span><span class="token punctuation">(</span>activityToken<span class="token punctuation">,</span>
            packageInfo<span class="token punctuation">.</span><span class="token function">getResDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            splitDirs<span class="token punctuation">,</span>
            packageInfo<span class="token punctuation">.</span><span class="token function">getOverlayDirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            packageInfo<span class="token punctuation">.</span><span class="token function">getOverlayPaths</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            packageInfo<span class="token punctuation">.</span><span class="token function">getApplicationInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sharedLibraryFiles<span class="token punctuation">,</span>
            displayId<span class="token punctuation">,</span>
            overrideConfiguration<span class="token punctuation">,</span>
            compatInfo<span class="token punctuation">,</span>
            classLoader<span class="token punctuation">,</span>
            packageInfo<span class="token punctuation">.</span><span class="token function">getApplication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null <span class="token operator">?</span> null
                    <span class="token operator">:</span> packageInfo<span class="token punctuation">.</span><span class="token function">getApplication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLoaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    context<span class="token punctuation">.</span>mDisplay <span class="token operator">=</span> resourcesManager<span class="token punctuation">.</span><span class="token function">getAdjustedDisplay</span><span class="token punctuation">(</span>displayId<span class="token punctuation">,</span>
            context<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> context<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>1.3) 进行mBase赋值的流程<br> <code>ActivityThread.java</code>: performLaunchActivity<br> <code>Activity.java</code>: -&gt;attach-&gt;attachBaseContext<br> <code>attachBaseContext</code>: Activity/ContextThemeWrapper/ContextWrapper (extends继承关系)<br> 最终在ContextWrapper中设置mBase为activity的ContextImpl</p> 
<p>得到ContextImpl之后通过activity.attach进行mBase下一步赋值</p> 
<pre><code class="prism language-java"><span class="token comment">//Activity.java</span>
    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">attach</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> ActivityThread aThread<span class="token punctuation">,</span>
            Instrumentation instr<span class="token punctuation">,</span> IBinder token<span class="token punctuation">,</span> <span class="token keyword">int</span> ident<span class="token punctuation">,</span>
            Application application<span class="token punctuation">,</span> Intent intent<span class="token punctuation">,</span> ActivityInfo info<span class="token punctuation">,</span>
            CharSequence title<span class="token punctuation">,</span> Activity parent<span class="token punctuation">,</span> String id<span class="token punctuation">,</span>
            NonConfigurationInstances lastNonConfigurationInstances<span class="token punctuation">,</span>
            Configuration config<span class="token punctuation">,</span> String referrer<span class="token punctuation">,</span> IVoiceInteractor voiceInteractor<span class="token punctuation">,</span>
            Window window<span class="token punctuation">,</span> ActivityConfigCallback activityConfigCallback<span class="token punctuation">,</span> IBinder assistToken<span class="token punctuation">,</span>
            IBinder shareableActivityToken<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">attachBaseContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//...</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">attachBaseContext</span><span class="token punctuation">(</span>Context newBase<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">attachBaseContext</span><span class="token punctuation">(</span>newBase<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newBase <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            newBase<span class="token punctuation">.</span><span class="token function">setAutofillClient</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            newBase<span class="token punctuation">.</span><span class="token function">setContentCaptureOptions</span><span class="token punctuation">(</span><span class="token function">getContentCaptureOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token comment">//ContextThemeWrapper.java</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">attachBaseContext</span><span class="token punctuation">(</span>Context newBase<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">attachBaseContext</span><span class="token punctuation">(</span>newBase<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token comment">//ContextWrapper.java</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">attachBaseContext</span><span class="token punctuation">(</span>Context base<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mBase <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Base context already set"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mBase <span class="token operator">=</span> base<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<ol start="2"><li>ContextImpl的动态注册广播流程registerReceiver</li></ol> 
<p>2.1) ContextImpl</p> 
<pre><code class="prism language-java"><span class="token comment">//ContextImpl.java</span>
    <span class="token comment">//我们调用的是只有2个参数的registerReceiver，第一个参数是BroadcastReceiver接受者</span>
	<span class="token comment">//第二个参数是filter过滤器(需要接收哪个广播)</span>
    <span class="token keyword">public</span> Intent <span class="token function">registerReceiver</span><span class="token punctuation">(</span>BroadcastReceiver receiver<span class="token punctuation">,</span> IntentFilter filter<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//将广播权限broadcastPermission设置成null，</span>
        <span class="token comment">//scheduler调度动态广播的线程设置成null</span>
        <span class="token keyword">return</span> <span class="token function">registerReceiver</span><span class="token punctuation">(</span>receiver<span class="token punctuation">,</span> filter<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> Intent <span class="token function">registerReceiver</span><span class="token punctuation">(</span>BroadcastReceiver receiver<span class="token punctuation">,</span> IntentFilter filter<span class="token punctuation">,</span>
            String broadcastPermission<span class="token punctuation">,</span> Handler scheduler<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//userId当前的用户id</span>
		<span class="token comment">//传入mOuterContext</span>
        <span class="token comment">//flags是0</span>
        <span class="token keyword">return</span> <span class="token function">registerReceiverInternal</span><span class="token punctuation">(</span>receiver<span class="token punctuation">,</span> <span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                filter<span class="token punctuation">,</span> broadcastPermission<span class="token punctuation">,</span> scheduler<span class="token punctuation">,</span> <span class="token function">getOuterContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> Intent <span class="token function">registerReceiverInternal</span><span class="token punctuation">(</span>BroadcastReceiver receiver<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">,</span>
            IntentFilter filter<span class="token punctuation">,</span> String broadcastPermission<span class="token punctuation">,</span>
            Handler scheduler<span class="token punctuation">,</span> Context context<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//IIntentReceiver rd才是系统system_server需要发送广播到app的接口对象</span>
        IIntentReceiver rd <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token comment">//receiver如果接受者不为null，则会新建IIntentReceiver rd</span>
        <span class="token comment">//我们例子里面是存在receiver的，至于不存在receiver的情况也是有使用场景的，这个就后面点讲</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>receiver <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//在本例中LoadedApk mPackageInfo不为null，context也不为null</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mPackageInfo <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> context <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//传入的广播调度器scheduler是null</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>scheduler <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//那就直接使用主线程ActivityThread的handler(mH)作为调度器</span>
                    scheduler <span class="token operator">=</span> mMainThread<span class="token punctuation">.</span><span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//从mPackageInfo中取得IIntentReceiver，并将该receiver放入LoadedApk mPackageInfo的mReceivers中</span>
				<span class="token comment">//LoadedApk的mReceivers(可以作为检测app注册多少个广播的其中一个插装的地方)</span>
                <span class="token comment">//这里我们先记住LoadedApk.ReceiverDispatcher.mIIntentReceiver这个东西，后面分发广播的时候有用到</span>
                <span class="token comment">//registered = true代表是注册接受者</span>
                rd <span class="token operator">=</span> mPackageInfo<span class="token punctuation">.</span><span class="token function">getReceiverDispatcher</span><span class="token punctuation">(</span>
                    receiver<span class="token punctuation">,</span> context<span class="token punctuation">,</span> scheduler<span class="token punctuation">,</span>
                    mMainThread<span class="token punctuation">.</span><span class="token function">getInstrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//如果mPackageInfo或者context有一个为null</span>
                <span class="token comment">//scheduler为null的时候直接使用主线程mMainThread</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>scheduler <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    scheduler <span class="token operator">=</span> mMainThread<span class="token punctuation">.</span><span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//此处直接new一个LoadedApk.ReceiverDispatcher得到mIIntentReceiver，赋值给IIntentReceiver rd(这种没有记录在LoadedApk的mReceivers)</span>
                rd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LoadedApk<span class="token punctuation">.</span>ReceiverDispatcher</span><span class="token punctuation">(</span>
                        receiver<span class="token punctuation">,</span> context<span class="token punctuation">,</span> scheduler<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIIntentReceiver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//实际调用的是AMS的registerReceiverWithFeature</span>
            <span class="token keyword">final</span> Intent intent <span class="token operator">=</span> ActivityManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerReceiverWithFeature</span><span class="token punctuation">(</span>
                    mMainThread<span class="token punctuation">.</span><span class="token function">getApplicationThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mBasePackageName<span class="token punctuation">,</span> <span class="token function">getAttributionTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    AppOpsManager<span class="token punctuation">.</span><span class="token function">toReceiverId</span><span class="token punctuation">(</span>receiver<span class="token punctuation">)</span><span class="token punctuation">,</span> rd<span class="token punctuation">,</span> filter<span class="token punctuation">,</span> broadcastPermission<span class="token punctuation">,</span> userId<span class="token punctuation">,</span>
                    flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>intent <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//如果intent不为null，设置mExtras的ClassLoader</span>
                intent<span class="token punctuation">.</span><span class="token function">setExtrasClassLoader</span><span class="token punctuation">(</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// TODO: determine at registration time if caller is</span>
                <span class="token comment">// protecting themselves with signature permission</span>
                <span class="token comment">// 设置注册的是否保护的广播，还有AttributionSource</span>
                intent<span class="token punctuation">.</span><span class="token function">prepareToEnterProcess</span><span class="token punctuation">(</span>ActivityThread<span class="token punctuation">.</span><span class="token function">isProtectedBroadcast</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token function">getAttributionSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> intent<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> e<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token comment">//LoadedApk.java</span>
    <span class="token keyword">public</span> IIntentReceiver <span class="token function">getReceiverDispatcher</span><span class="token punctuation">(</span>BroadcastReceiver r<span class="token punctuation">,</span>
            Context context<span class="token punctuation">,</span> Handler handler<span class="token punctuation">,</span>
            Instrumentation instrumentation<span class="token punctuation">,</span> <span class="token keyword">boolean</span> registered<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mReceivers<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            LoadedApk<span class="token punctuation">.</span>ReceiverDispatcher rd <span class="token operator">=</span> null<span class="token punctuation">;</span>
            ArrayMap<span class="token generics function"><span class="token punctuation">&lt;</span>BroadcastReceiver<span class="token punctuation">,</span> LoadedApk<span class="token punctuation">.</span>ReceiverDispatcher<span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>registered<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//从mReceivers取出对于该context的ReceiverDispatcher map</span>
                map <span class="token operator">=</span> mReceivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//从map取出对于该BroadcastReceiver的ReceiverDispatcher</span>
                    <span class="token comment">//注意: 一个BroadcastReceiver对应一个ReceiverDispatcher</span>
                    rd <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//如果没有BroadcastReceiver对应的ReceiverDispatcher</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rd <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//根据BroadcastReceiver r新建一个ReceiverDispatcher</span>
                rd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReceiverDispatcher</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> context<span class="token punctuation">,</span> handler<span class="token punctuation">,</span>
                        instrumentation<span class="token punctuation">,</span> registered<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//此处registered是true</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>registered<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//将ReceiverDispatcher rd放入map中，而map是存储在mReceivers中的</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayMap</span><span class="token generics function"><span class="token punctuation">&lt;</span>BroadcastReceiver<span class="token punctuation">,</span> LoadedApk<span class="token punctuation">.</span>ReceiverDispatcher<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        mReceivers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> rd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                rd<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            rd<span class="token punctuation">.</span>mForgotten <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment">//获取mIIntentReceiver</span>
            <span class="token keyword">return</span> rd<span class="token punctuation">.</span><span class="token function">getIIntentReceiver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

	<span class="token function">ReceiverDispatcher</span><span class="token punctuation">(</span>BroadcastReceiver receiver<span class="token punctuation">,</span> Context context<span class="token punctuation">,</span>
			Handler activityThread<span class="token punctuation">,</span> Instrumentation instrumentation<span class="token punctuation">,</span>
			<span class="token keyword">boolean</span> registered<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>activityThread <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token string">"Handler must not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//传递给AMS的就是mIIntentReceiver(IIntentReceiver.Stub对象，实现了IIntentReceiver接口)</span>
		mIIntentReceiver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InnerReceiver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token operator">!</span>registered<span class="token punctuation">)</span><span class="token punctuation">;</span>
		mReceiver <span class="token operator">=</span> receiver<span class="token punctuation">;</span>
		mContext <span class="token operator">=</span> context<span class="token punctuation">;</span>
		mActivityThread <span class="token operator">=</span> activityThread<span class="token punctuation">;</span>
		mInstrumentation <span class="token operator">=</span> instrumentation<span class="token punctuation">;</span>
		mRegistered <span class="token operator">=</span> registered<span class="token punctuation">;</span>
		mLocation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntentReceiverLeaked</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
		mLocation<span class="token punctuation">.</span><span class="token function">fillInStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//返回mIIntentReceiver</span>
	IIntentReceiver <span class="token function">getIIntentReceiver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> mIIntentReceiver<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p>2.2) 扩展：mReceivers广播泄露</p> 
<p>这种泄露比较常见(registerReceiver、unregisterReceiver没有成对使用)，日志如类似<br> <code>*** has leaked IntentReceiver *** that was originally registered here. Are you missing a call to unregisterReceiver()</code></p> 
<p>具体判断的地方是LoadedApk的removeContextRegistrations</p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">removeContextRegistrations</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span>
            String who<span class="token punctuation">,</span> String what<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> reportRegistrationLeaks <span class="token operator">=</span> StrictMode<span class="token punctuation">.</span><span class="token function">vmRegistrationLeaksEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mReceivers<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">//在进入这个函数之前mReceivers中这个context的内容需要情况，不然就属于没有成对出现的泄露问题</span>
		ArrayMap<span class="token generics function"><span class="token punctuation">&lt;</span>BroadcastReceiver<span class="token punctuation">,</span> LoadedApk<span class="token punctuation">.</span>ReceiverDispatcher<span class="token punctuation">&gt;</span></span> rmap <span class="token operator">=</span>
                    mReceivers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rmap <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> rmap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//取出每一个ReceiverDispatcher rd，打印日志，是不是忘记调用unregisterReceiver啦？</span>
                    <span class="token comment">//这样可能会导致泄露哦</span>
                    LoadedApk<span class="token punctuation">.</span>ReceiverDispatcher rd <span class="token operator">=</span> rmap<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    IntentReceiverLeaked leak <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntentReceiverLeaked</span><span class="token punctuation">(</span>
                            what <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> who <span class="token operator">+</span> <span class="token string">" has leaked IntentReceiver "</span>
                            <span class="token operator">+</span> rd<span class="token punctuation">.</span><span class="token function">getIntentReceiver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" that was "</span> <span class="token operator">+</span>
                            <span class="token string">"originally registered here. Are you missing a "</span> <span class="token operator">+</span>
                            <span class="token string">"call to unregisterReceiver()?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    leak<span class="token punctuation">.</span><span class="token function">setStackTrace</span><span class="token punctuation">(</span>rd<span class="token punctuation">.</span><span class="token function">getLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    Slog<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>ActivityThread<span class="token punctuation">.</span>TAG<span class="token punctuation">,</span> leak<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> leak<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>reportRegistrationLeaks<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        StrictMode<span class="token punctuation">.</span><span class="token function">onIntentReceiverLeaked</span><span class="token punctuation">(</span>leak<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//系统代码手动帮我们调用了unregisterReceiver的方法，挺好的</span>
                        <span class="token comment">//不过我们自己的逻辑不建议托管给系统</span>
                        ActivityManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unregisterReceiver</span><span class="token punctuation">(</span>
                                rd<span class="token punctuation">.</span><span class="token function">getIIntentReceiver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">throw</span> e<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//这个是BroadcastReceiver setDebugUnregister设置了mDebugUnregister的时候才会有作用</span>
            <span class="token comment">//mUnregisteredReceivers是用于判断一个BroadcastReceiver是否存在多次调用unregisterReceiver的情况</span>
            <span class="token comment">//调试功能用，输出类似"Originally unregistered here"的日志，也挺有用的</span>
            mUnregisteredReceivers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h2><a id="4_system_server_395"></a>4. system_server侧的广播注册</h2> 
<ol><li>从上面的<code>registerReceiverWithFeature</code>接着分析，先看一下传入的参数</li></ol> 
<pre><code class="prism language-java"><span class="token comment">//ActivityManagerService.java</span>
    <span class="token comment">//ContextImpl(registerReceiver/registerReceiverWithFeature) -&gt; AMS registerReceiverWithFeature</span>
	<span class="token comment">//本例中的caller: mMainThread.getApplicationThread()应用的ApplicationThread</span>
    <span class="token comment">//callerPackage: 是调用者的包名</span>
    <span class="token comment">//callerFeatureId: 是getAttributionTag返回的attributionTag</span>
    <span class="token comment">//receiverId: 是获取的call name + id的string(如果是PendingIntent的话，得到的是PendingIntentRecord的lastTag)</span>
    <span class="token comment">//receiver: 就是LoadedApk.ReceiverDispatcher用户接受广播的地方</span>
    <span class="token comment">//filter: 是意图过滤器</span>
    <span class="token comment">//permission: 是发送这个广播需要的权限，一般不设置，</span>
    <span class="token comment">//如果设置了如VpnManagerService注册广播有使用NETWORK_STACK，则发送者需要有这个权限才能发送到VpnManagerService的接受者</span>
    <span class="token comment">//userId: 是用户的组别id，如USER_OWNER/USER_SYSTEM(0)、USER_ALL(-1)、USER_CURRENT(-2)、USER_CURRENT_OR_SELF(-3)、USER_NULL(-10000)</span>
    <span class="token comment">//而这里是activity的Process.myUserHandle()-&gt;Os.getuid()，此处是0</span>
    <span class="token comment">//flags: 此处默认是0</span>
    <span class="token keyword">public</span> Intent <span class="token function">registerReceiverWithFeature</span><span class="token punctuation">(</span>IApplicationThread caller<span class="token punctuation">,</span> String callerPackage<span class="token punctuation">,</span>
            String callerFeatureId<span class="token punctuation">,</span> String receiverId<span class="token punctuation">,</span> IIntentReceiver receiver<span class="token punctuation">,</span>
            IntentFilter filter<span class="token punctuation">,</span> String permission<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
</code></pre> 
<ol start="2"><li>权限判断，callerApp、instantApp等的初始化</li></ol> 
<pre><code class="prism language-java">        <span class="token comment">//uid是Isolated的应用是不能调用registerReceiverWithFeature的</span>
        <span class="token function">enforceNotIsolatedCaller</span><span class="token punctuation">(</span><span class="token string">"registerReceiver"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//stickyIntents粘性广播的意图</span>
        ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Intent<span class="token punctuation">&gt;</span></span> stickyIntents <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token comment">//callerApp调用者</span>
        ProcessRecord callerApp <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token comment">//visibleToInstantApps是否允许发送到InstantApps即时app</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> visibleToInstantApps
                <span class="token operator">=</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> Context<span class="token punctuation">.</span>RECEIVER_VISIBLE_TO_INSTANT_APPS<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">//调用者的uid和pid</span>
        <span class="token keyword">int</span> callingUid<span class="token punctuation">;</span>
        <span class="token keyword">int</span> callingPid<span class="token punctuation">;</span>
        <span class="token comment">//是否instantApp(即时app)，在安装的时候就已经确定，PMS识别安装带有INSTALL_INSTANT_APP flag的应用</span>
        <span class="token keyword">boolean</span> instantApp<span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>caller <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//如果存在caller(IApplicationThread)，则从mProcessList中取出caller对应的callerApp</span>
                callerApp <span class="token operator">=</span> <span class="token function">getRecordForAppLOSP</span><span class="token punctuation">(</span>caller<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>callerApp <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SecurityException</span><span class="token punctuation">(</span>
                            <span class="token string">"Unable to find app for caller "</span> <span class="token operator">+</span> caller
                            <span class="token operator">+</span> <span class="token string">" (pid="</span> <span class="token operator">+</span> Binder<span class="token punctuation">.</span><span class="token function">getCallingPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token operator">+</span> <span class="token string">") when registering receiver "</span> <span class="token operator">+</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>callerApp<span class="token punctuation">.</span>info<span class="token punctuation">.</span>uid <span class="token operator">!=</span> SYSTEM_UID
                        <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>callerApp<span class="token punctuation">.</span><span class="token function">getPkgList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>callerPackage<span class="token punctuation">)</span>
                        <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token string">"android"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>callerPackage<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SecurityException</span><span class="token punctuation">(</span><span class="token string">"Given caller package "</span> <span class="token operator">+</span> callerPackage
                            <span class="token operator">+</span> <span class="token string">" is not running in process "</span> <span class="token operator">+</span> callerApp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//通过callerApp取得callingUid、callingPid</span>
                callingUid <span class="token operator">=</span> callerApp<span class="token punctuation">.</span>info<span class="token punctuation">.</span>uid<span class="token punctuation">;</span>
                callingPid <span class="token operator">=</span> callerApp<span class="token punctuation">.</span><span class="token function">getPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//否则callerPackage设置为null, callingUid、callingPid设置成binder调用者的uid和pid</span>
                <span class="token comment">//如MonkeyNetworkMonitor.java中 am.registerReceiverWithFeature(null, null,</span>
                callerPackage <span class="token operator">=</span> null<span class="token punctuation">;</span>
                callingUid <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">getCallingUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                callingPid <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">getCallingPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// Android Instant App 正是这一理念的集中体现——这是一种用户无需安装即可运行 Android 应用的全新方式</span>
            <span class="token comment">// 由于不需要事先安装应用，Instant App 能在任何场合直接抵达用户。“瞬间抵达用户” 这个概念</span>
            <span class="token comment">// Android Instant App 需要由大小不超过 4MB 的可通过 URL 寻址的模块构建而成。</span>
            <span class="token comment">// 如果应用大小超过 4MB，开发者就需要将应用重构为可下载的、响应 URL 导航独立运行的较小的模块</span>
            instantApp <span class="token operator">=</span> <span class="token function">isInstantApp</span><span class="token punctuation">(</span>callerApp<span class="token punctuation">,</span> callerPackage<span class="token punctuation">,</span> callingUid<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//多用户广播动态注册，如果是callingUid、userId同一个用户组，则直接返回userId</span>
            userId <span class="token operator">=</span> mUserController<span class="token punctuation">.</span><span class="token function">handleIncomingUser</span><span class="token punctuation">(</span>callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                    ALLOW_FULL_ONLY<span class="token punctuation">,</span> <span class="token string">"registerReceiver"</span><span class="token punctuation">,</span> callerPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="3"><li>获取filter的action，看一下是否粘性广播stickyIntents(粘性广播这个东西也很有意思，经常听到)，<br> 获取其filter对应的所有所有粘性广播allSticky<br> <code>粘性广播：只要该粘性广播发送过(就算是之前发送的)，注册接收粘性广播的时候可以马上收到该广播，不用担心注册在发送广播之前就收不到的问题</code></li></ol> 
<pre><code class="prism language-java">            <span class="token comment">//遍历IntentFilter中包含的所有action</span>
            Iterator<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">&gt;</span></span> actions <span class="token operator">=</span> filter<span class="token punctuation">.</span><span class="token function">actionsIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>actions <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">&gt;</span></span> noAction <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                noAction<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//如果没有action，则放入一个null的noAction到actions中，确保actions不为null</span>
                actions <span class="token operator">=</span> noAction<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// Collect stickies of users</span>
            <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> userIds <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> UserHandle<span class="token punctuation">.</span>USER_ALL<span class="token punctuation">,</span> UserHandle<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span>callingUid<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

            <span class="token comment">//遍历所有的action</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>actions<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                String action <span class="token operator">=</span> actions<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> id <span class="token operator">:</span> userIds<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//遍历mStickyBroadcasts已经发送了的粘性广播列表stickies</span>
                    ArrayMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Intent<span class="token punctuation">&gt;</span></span><span class="token operator">&gt;</span> stickies <span class="token operator">=</span> mStickyBroadcasts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>stickies <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//获取这个动态注册接受者action的粘性广播</span>
                        ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Intent<span class="token punctuation">&gt;</span></span> intents <span class="token operator">=</span> stickies<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//如果系统发送过这个action的粘性广播</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>intents <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>stickyIntents <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                stickyIntents <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics function"><span class="token punctuation">&lt;</span>Intent<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token comment">//则将粘性广播intents全部放入stickyIntents</span>
                            stickyIntents<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>intents<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//粘性广播的列表，默认是null</span>
        ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Intent<span class="token punctuation">&gt;</span></span> allSticky <span class="token operator">=</span> null<span class="token punctuation">;</span>

        <span class="token comment">//如果之前已经发送过这个action的粘性广播，则stickyIntents不为null，否则为null</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stickyIntents <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//获取内容解析器ContentResolver</span>
            <span class="token keyword">final</span> ContentResolver resolver <span class="token operator">=</span> mContext<span class="token punctuation">.</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Look for any matching sticky broadcasts...</span>
            <span class="token comment">//遍历粘性广播的Intent：stickyIntents</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> N <span class="token operator">=</span> stickyIntents<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//遍历粘性广播的Intent</span>
                Intent intent <span class="token operator">=</span> stickyIntents<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// Don't provided intents that aren't available to instant apps.</span>
                <span class="token comment">//如果是instantApp，而且没有单独设置接受粘性广播FLAG_RECEIVER_VISIBLE_TO_INSTANT_APPS</span>
                <span class="token comment">//则默认是处理粘性广播的</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>instantApp <span class="token operator">&amp;&amp;</span>
                        <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> Intent<span class="token punctuation">.</span>FLAG_RECEIVER_VISIBLE_TO_INSTANT_APPS<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// If intent has scheme "content", it will need to acccess</span>
                <span class="token comment">// provider that needs to lock mProviderMap in ActivityThread</span>
                <span class="token comment">// and also it may need to wait application response, so we</span>
                <span class="token comment">// cannot lock ActivityManagerService here.</span>
                <span class="token comment">//匹配一下注册广播的filter，是否和intent一致，如果大于0则表示匹配成功</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>filter<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>resolver<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> TAG<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>allSticky <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        allSticky <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics function"><span class="token punctuation">&lt;</span>Intent<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">//如果匹配成功则将该粘性广播intent保存在allSticky</span>
                    allSticky<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> 
<ol start="4"><li>如果receiver == null，而且其注册的是粘性广播，那么将粘性广播的Intent返回给app，<br> 如获取粘性广播的一些信息（比如电池信息），可以将receiver设为空，可以在注册的时候获取<code>一次</code>信息，<br> 这种使用场景不会有后续监听</li></ol> 
<pre><code class="prism language-java">        <span class="token comment">// The first sticky in the list is returned directly back to the client.</span>
        <span class="token comment">//取得匹配成功后的第一个粘性广播sticky</span>
        Intent sticky <span class="token operator">=</span> allSticky <span class="token operator">!=</span> null <span class="token operator">?</span> allSticky<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span> <span class="token string">"Register receiver "</span> <span class="token operator">+</span> filter <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> sticky<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 判断receiver是否为空，如果为空则直接返回找到的对应Sticky Intent。</span>
        <span class="token comment">// 正常情况下receiver是不为空的，但是有时候为了获取粘性广播的一些信息（比如电池信息），可以将receiver设为空，</span>
        <span class="token comment">// 只为了从返回的Sticky Intent中获取这些信息。</span>
        <span class="token comment">// 这时的注册广播可以写成这种形式：mBatteryBroadcast = mContext.registerReceiver(null, new IntentFilter(Intent.ACTION_BATTERY_CHANGED));</span>
        <span class="token comment">// 但是注意，这种形式只能在注册的时候获得一次信息，而不会有后续的继续监听。</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>receiver <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//只在粘性广播这种注册方式才有价值，用于单次更新</span>
            <span class="token keyword">return</span> sticky<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// SafetyNet logging for b/177931370. If any process other than system_server tries to</span>
        <span class="token comment">// listen to this broadcast action, then log it.</span>
        <span class="token comment">//非system_server系统进程</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>callingPid <span class="token operator">!=</span> Process<span class="token punctuation">.</span><span class="token function">myPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//如果filter包含了SNOOZE_WARNING、SNOOZE_RAPID，则输入日志</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>filter<span class="token punctuation">.</span><span class="token function">hasAction</span><span class="token punctuation">(</span><span class="token string">"com.android.server.net.action.SNOOZE_WARNING"</span><span class="token punctuation">)</span>
                    <span class="token operator">||</span> filter<span class="token punctuation">.</span><span class="token function">hasAction</span><span class="token punctuation">(</span><span class="token string">"com.android.server.net.action.SNOOZE_RAPID"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                EventLog<span class="token punctuation">.</span><span class="token function">writeEvent</span><span class="token punctuation">(</span><span class="token number">0x534e4554</span><span class="token punctuation">,</span> <span class="token string">"177931370"</span><span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> 
<ol start="5"><li>构建接受者列表ReceiverList rl， mRegisteredReceivers 保存了所有动态注册的receiver.asBinder<br> 使用IntentFilter filter, 构建接受者列表ReceiverList rl构建BroadcastFilter bf广播过滤器，<br> 并把bf到<code>mReceiverResolver</code>中去，该变量用于在broadcastIntentLocked分发广播的时候, 查询符合条件的动态注册的广播<br> 这里注意：<code>mReceiverResolver</code>就是动态广播最终存放的地方，后面发送广播的时候就从这里找到动态注册的接受者</li></ol> 
<pre><code class="prism language-java">        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            IApplicationThread thread<span class="token punctuation">;</span>
            <span class="token comment">// 取得callerApp的IApplicationThread应用线程</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>callerApp <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>thread <span class="token operator">=</span> callerApp<span class="token punctuation">.</span><span class="token function">getThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> null
                    <span class="token operator">||</span> thread<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> caller<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Original caller already died</span>
                <span class="token comment">//如果callerApp没有IApplicationThread(或者caller和callerApp的IApplicationThread不一致)，</span>
                <span class="token comment">// 则代表进程之前已经死掉了</span>
                <span class="token keyword">return</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//获取这个接受者receiver，是否已经保存在AMS的mRegisteredReceivers动态注册者列表里面</span>
            ReceiverList rl <span class="token operator">=</span> mRegisteredReceivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>receiver<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//如果之前没有注册过(没有在mRegisteredReceivers中)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rl <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//如果ReceiverList rl是null，则新建一个ReceiverList</span>
                <span class="token comment">//传入参数是: AMS, callerApp, callingPid, callingUid, userId, receiver(接受者)</span>
                rl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReceiverList</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> callerApp<span class="token punctuation">,</span> callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span>
                        userId<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>rl<span class="token punctuation">.</span>app <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//如果callerApp不为null，获取一下当前mReceivers</span>
                    <span class="token keyword">final</span> <span class="token keyword">int</span> totalReceiversForApp <span class="token operator">=</span> rl<span class="token punctuation">.</span>app<span class="token punctuation">.</span>mReceivers<span class="token punctuation">.</span><span class="token function">numberOfReceivers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//一个进程最多1000个接受者(动态)</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>totalReceiversForApp <span class="token operator">&gt;=</span> MAX_RECEIVERS_ALLOWED_PER_APP<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Too many receivers, total of "</span>
                                <span class="token operator">+</span> totalReceiversForApp <span class="token operator">+</span> <span class="token string">", registered for pid: "</span>
                                <span class="token operator">+</span> rl<span class="token punctuation">.</span>pid <span class="token operator">+</span> <span class="token string">", callerPackage: "</span> <span class="token operator">+</span> callerPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">//将ReceiverList rl添加到mReceivers(ProcessReceiverRecord.java)中去(有点循环的感觉)</span>
                    rl<span class="token punctuation">.</span>app<span class="token punctuation">.</span>mReceivers<span class="token punctuation">.</span><span class="token function">addReceiver</span><span class="token punctuation">(</span>rl<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//callerApp == null的情况, 如MonkeyNetworkMonitor</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//持有receiver的进程死亡之后会回调ReceiverList rl的binderDied</span>
                        <span class="token comment">//binderDied会设置linkedToDeath = false;和调用AMS的unregisterReceiver(receiver),里面会有</span>
                        <span class="token comment">// rl.receiver.asBinder().unlinkToDeath(rl, 0);的操作</span>
                        receiver<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">linkToDeath</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">return</span> sticky<span class="token punctuation">;</span>receivers <span class="token operator">=</span> collectReceiverComponents
                    <span class="token punctuation">}</span>
                    <span class="token comment">//设置有死亡监听</span>
                    rl<span class="token punctuation">.</span>linkedToDeath <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//将以receiver为key,ReceiverList rl为value,保存在mRegisteredReceivers中</span>
                <span class="token comment">//mRegisteredReceivers保存了所有的动态注册的receiver</span>
                mRegisteredReceivers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>receiver<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rl<span class="token punctuation">.</span>uid <span class="token operator">!=</span> callingUid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>
                        <span class="token string">"Receiver requested to register for uid "</span> <span class="token operator">+</span> callingUid
                        <span class="token operator">+</span> <span class="token string">" was previously registered for uid "</span> <span class="token operator">+</span> rl<span class="token punctuation">.</span>uid
                        <span class="token operator">+</span> <span class="token string">" callerPackage is "</span> <span class="token operator">+</span> callerPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rl<span class="token punctuation">.</span>pid <span class="token operator">!=</span> callingPid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>
                        <span class="token string">"Receiver requested to register for pid "</span> <span class="token operator">+</span> callingPid
                        <span class="token operator">+</span> <span class="token string">" was previously registered for pid "</span> <span class="token operator">+</span> rl<span class="token punctuation">.</span>pid
                        <span class="token operator">+</span> <span class="token string">" callerPackage is "</span> <span class="token operator">+</span> callerPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rl<span class="token punctuation">.</span>userId <span class="token operator">!=</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>
                        <span class="token string">"Receiver requested to register for user "</span> <span class="token operator">+</span> userId
                        <span class="token operator">+</span> <span class="token string">" was previously registered for user "</span> <span class="token operator">+</span> rl<span class="token punctuation">.</span>userId
                        <span class="token operator">+</span> <span class="token string">" callerPackage is "</span> <span class="token operator">+</span> callerPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// ReceiverList rl接收列表 (ReceiverList extends ArrayList&lt;BroadcastFilter&gt;),它的元素是BroadcastFilter bf</span>
            <span class="token comment">// BroadcastFilter bf广播过滤器</span>
            <span class="token comment">// 上面只是把广播接收着receiver的一些信息保存在ReceiverList rl中，但是还没有把它和filter关联起来，</span>
            <span class="token comment">// 这里就创建一个BroadcastFilter(bf)来把广播接收器列表rl和filter关联起来</span>
            BroadcastFilter bf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BroadcastFilter</span><span class="token punctuation">(</span>filter<span class="token punctuation">,</span> rl<span class="token punctuation">,</span> callerPackage<span class="token punctuation">,</span> callerFeatureId<span class="token punctuation">,</span>
                    receiverId<span class="token punctuation">,</span> permission<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> instantApp<span class="token punctuation">,</span> visibleToInstantApps<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//如果ReceiverList rl已经包含这个filter，则不再加入</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rl<span class="token punctuation">.</span><span class="token function">containsFilter</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Receiver with filter "</span> <span class="token operator">+</span> filter
                        <span class="token operator">+</span> <span class="token string">" already registered for pid "</span> <span class="token operator">+</span> rl<span class="token punctuation">.</span>pid
                        <span class="token operator">+</span> <span class="token string">", callerPackage is "</span> <span class="token operator">+</span> callerPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//如果ReceiverList rl之前没添加过BroadcastFilter(bf)，则加入接收列表中</span>
                rl<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>bf<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bf<span class="token punctuation">.</span><span class="token function">debugCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"==&gt; For Dynamic broadcast"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//同时添加bf到mReceiverResolver中去</span>
                <span class="token comment">//该变量用于在broadcastIntentLocked分发广播的时候, 查询符合条件的动态注册的广播</span>
                mReceiverResolver<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span>bf<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
</code></pre> 
<ol start="6"><li>最后就是粘性广播发送的地方, 将所有满足条件的粘性广播allSticky，发送给BroadcastFilter bf(我们认为是IIntentReceiver receiver就行了)</li></ol> 
<pre><code class="prism language-java">            <span class="token comment">// Enqueue broadcasts for all existing stickies that match</span>
            <span class="token comment">// this filter.</span>
            <span class="token comment">// 粘性广播的处理：如果allSticky不为空，</span>
            <span class="token comment">// 广播接受者注册的广播的是粘性广播。</span>
            <span class="token comment">// 所以就将这个粘性广播添加到mParallelBroadcasts平行队列中等待调度（具体的可参考后面广播发送流程的最后几步）。</span>
            <span class="token comment">// 最后再返回sticky</span>
            <span class="token comment">// （如果非粘性的，则为空；反之，sticky不为空，附带着粘性广播里的一些数据）。</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>allSticky <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                ArrayList receivers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//BroadcastFilter bf才是实际的接受者，接受者receivers只有一个BroadcastFilter bf，</span>
                <span class="token comment">//也就是单发给BroadcastFilter bf</span>
                receivers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>bf<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">final</span> <span class="token keyword">int</span> stickyCount <span class="token operator">=</span> allSticky<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//遍历匹配成功的粘性广播列表allSticky</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> stickyCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    Intent intent <span class="token operator">=</span> allSticky<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//取出intent对应的广播队列</span>
                    BroadcastQueue queue <span class="token operator">=</span> <span class="token function">broadcastQueueForIntent</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//新建BroadcastRecord广播记录对象,_initialSticky = true, 粘性广播</span>
                    <span class="token comment">//包含receivers(BroadcastFilter bf)</span>
                    <span class="token comment">//_timeoutExempt = false</span>
                    BroadcastRecord r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BroadcastRecord</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> null<span class="token punctuation">,</span>
                            null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> OP_NONE<span class="token punctuation">,</span> null<span class="token punctuation">,</span> receivers<span class="token punctuation">,</span>
                            null<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span>
                            <span class="token boolean">false</span> <span class="token comment">/* only PRE_BOOT_COMPLETED should be exempt, no stickies */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//粘性广播接受者注册后, 马上之前发送过的粘性广播构建的BroadcastRecord r,就放入mParallelBroadcasts中</span>
                    queue<span class="token punctuation">.</span><span class="token function">enqueueParallelBroadcastLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//这里会马上处理刚才的平行广播队列,也就是达到注册了之后马上执行的效果</span>
                    queue<span class="token punctuation">.</span><span class="token function">scheduleBroadcastsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> sticky<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h2><a id="5__710"></a>5. 总结一下</h2> 
<ol><li>动态广播注册其实最终构建的是BroadcastFilter bf，并放入mReceiverResolver中去</li><li>粘性广播注册的时候就会收到之前已经发送的粘性广播</li><li>粘性广播注册可以不传入IIntentReceiver receiver，而获取一次信息</li><li>广播分发通过LoadedApk.ReceiverDispatcher.getIIntentReceiver获得的IIntentReceiver对象来实现的</li><li>APP进程的mReceivers就是正常注册的时候ReceiverDispatcher保存的地方，<br> 配合mUnregisteredReceivers可以查看广播泄露相关信息</li><li>Activity的mBase就是ContextImpl，通过createBaseContextForActivity创建</li><li>广播处理如果没有特殊设定广播处理的Handler，默认在ActivityThread的主线程(mH)中执行，<br> 主线程卡住会导致广播处理的延迟(超时发生广播anr)</li></ol>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b0256aed055dcd59dac9dc96dda48e07/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Lua的闭包详解</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/be8d7550dda127e1eb3a8bac44d1b826/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Android 静态广播注册流程(广播2)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>