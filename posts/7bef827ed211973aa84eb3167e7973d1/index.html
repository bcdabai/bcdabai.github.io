<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux驱动之 自动创建设备节点class_create、device_create - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Linux驱动之 自动创建设备节点class_create、device_create" />
<meta property="og:description" content="Linux驱动之自动创建设备文件节点学习记录：
Linux为系统上的每个设备都创建一种称为节点的特殊文件。与设备的所有通信都通过设备节点完成。
每个节点都有唯一的数值对供Linux内核标识它。
数值对包括一个主设备号和一个次设备号。类的设备被划分到同样的主设备号下。次设备号用于标识主设备组下的某个特定设备。
上节课利用了mknod命令手动创建设备节点，
实际上Linux内核为我们提供了一组函数，可以用来在模块加载的时候自动在/dev目录下创建相应设备节点，并在卸载模块时删除该节点。
内核中定义了struct class结构体，一个struct class结构体类型变量对应一个类，内核同时提供了class_create()函数，可以用它来创建一个类，这个类存放于sysfs下面，创建了这个类，再调用device_create()函数来在/dev目录下创建相应的设备节点。
这样，加载模块的时候，用户空间中的udev会自动响应device_create(…)函数，去/sysfs下寻找对应的类从而创建设备节点。
数据结构定义： #define NEWCHRDEV_CNT	1	/* 设备号个数 */ #define NEWCHRDEV_NAME	&#34;hello&#34;	/* 名字 */ /* newchrdev设备结构体 */ struct newchr_dev{ dev_t devid;	/* 设备号 */ struct cdev cdev;	/* cdev */ struct class *class;	/* 类 */ struct device *device;	/* 设备 */ int major;	/* 主设备号	*/ int minor;	/* 次设备号 */ }; struct newchr_dev chr_hello;	/* 设备chr_hello */ class_create /* * @description	: 创建一个class类型的对象 * @param - owner	: THIS_MODULE * @param - name	: 类名字 * @return : 成功,返回struct class的指针;其他 失败 */ struct class *class_create(struct module *owner, const char *name) 定义一个struct class的指针变量接受返回值，然后通过IS_ERR()判断是否失败，如果成功这个宏返回0，失败返回非0值（可以通过PTR_ERR()来获得失败返回的错误码）" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/7bef827ed211973aa84eb3167e7973d1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-04-24T23:37:32+08:00" />
<meta property="article:modified_time" content="2021-04-24T23:37:32+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux驱动之 自动创建设备节点class_create、device_create</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>Linux驱动之自动创建设备文件节点学习记录：</p> 
<p>Linux为系统上的每个设备都创建一种称为<mark>节点</mark>的特殊文件。与设备的所有通信都通过设备节点完成。<br> 每个节点都有唯一的数值对供Linux内核标识它。<br> 数值对包括一个主设备号和一个次设备号。类的设备被划分到同样的主设备号下。次设备号用于标识主设备组下的某个特定设备。</p> 
<p>上节课利用了mknod命令手动创建设备节点，<br> 实际上Linux内核为我们提供了一组函数，可以用来在模块加载的时候自动在/dev目录下创建相应设备节点，并在卸载模块时删除该节点。<br> 内核中定义了<mark>struct class结构体</mark>，一个struct class结构体类型变量对应一个类，内核同时提供了<mark>class_create()函数</mark>，可以用它来<mark>创建一个类</mark>，这个类存放于sysfs下面，创建了这个类，再<mark>调用device_create()函数来在/dev目录下创建相应的设备节点。</mark><br> 这样，加载模块的时候，用户空间中的udev会自动响应device_create(…)函数，去/sysfs下寻找对应的类从而创建设备节点。</p> 
<h5><a id="_11"></a>数据结构定义：</h5> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NEWCHRDEV_CNT</span>	<span class="token expression"><span class="token number">1</span>			</span><span class="token comment">/* 设备号个数 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NEWCHRDEV_NAME</span>	<span class="token string">"hello"</span>		<span class="token comment">/* 名字 */</span></span>

<span class="token comment">/* newchrdev设备结构体 */</span>
<span class="token keyword">struct</span> <span class="token class-name">newchr_dev</span><span class="token punctuation">{<!-- --></span>
	<span class="token class-name">dev_t</span> devid<span class="token punctuation">;</span>			<span class="token comment">/* 设备号 	 */</span>
	<span class="token keyword">struct</span> <span class="token class-name">cdev</span> cdev<span class="token punctuation">;</span>		<span class="token comment">/* cdev 	*/</span>
	<span class="token keyword">struct</span> <span class="token class-name">class</span> <span class="token operator">*</span>class<span class="token punctuation">;</span>		<span class="token comment">/* 类 		*/</span>
	<span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>device<span class="token punctuation">;</span>	 <span class="token comment">/* 设备 	 */</span>
	<span class="token keyword">int</span> major<span class="token punctuation">;</span>				<span class="token comment">/* 主设备号	  */</span>
	<span class="token keyword">int</span> minor<span class="token punctuation">;</span>				<span class="token comment">/* 次设备号   */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">newchr_dev</span> chr_hello<span class="token punctuation">;</span>	<span class="token comment">/* 设备chr_hello */</span>
</code></pre> 
<h5><a id="class_create_27"></a>class_create</h5> 
<pre><code class="prism language-c"><span class="token comment">/*
 * @description		: 创建一个class类型的对象
 * @param - owner	: THIS_MODULE
 * @param - name	: 类名字
 * @return 			: 成功,返回struct class的指针;其他 失败
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">class</span> <span class="token operator">*</span><span class="token function">class_create</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>owner<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span>
</code></pre> 
<p>定义一个struct class的指针变量接受返回值，然后通过IS_ERR()判断是否失败，如果成功这个宏返回0，失败返回非0值（可以通过PTR_ERR()来获得失败返回的错误码）</p> 
<pre><code class="prism language-c">	<span class="token keyword">int</span> result<span class="token punctuation">;</span>
	chr_hello<span class="token punctuation">.</span>class <span class="token operator">=</span> <span class="token function">class_create</span><span class="token punctuation">(</span>THIS_MODULE<span class="token punctuation">,</span> <span class="token string">"hlocls"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//生成hlocls设备类</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>chr_hello<span class="token punctuation">.</span>class<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"class_create() failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		result <span class="token operator">=</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>chr_hello<span class="token punctuation">.</span>class<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> result<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="device_create_47"></a>device_create</h5> 
<pre><code class="prism language-c"><span class="token comment">/*
 * @description		: 生成设备节点并导出到用户空间
 * @param - class	: 指向该设备应注册到的struct class的指针（上一个函数）
 * @param - parent	: 指向此新设备的父struct设备的指针（如果有），没有填NULL
 * @param - devt	: 要添加的char设备的dev_t
 * @param - drvdata	: 要添加到设备中以进行回调的数据（如果有），没有填NULL
 * @param - fmt		: 设备名称的字符串
 * @return 			: 成功,返回struct device指针;其他 失败
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span><span class="token function">device_create</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">class</span> <span class="token operator">*</span>class<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>parent<span class="token punctuation">,</span> <span class="token class-name">dev_t</span> devt<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>drvdata<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
</code></pre> 
<p>定义一个struct device的指针变量接受返回值，然后通过IS_ERR()判断是否失败，如果成功这个宏返回0，失败返回非0值（可以通过PTR_ERR()来获得失败返回的错误码）</p> 
<pre><code class="prism language-c">	chr_hello<span class="token punctuation">.</span>device <span class="token operator">=</span> <span class="token function">device_create</span><span class="token punctuation">(</span>chr_hello<span class="token punctuation">.</span>class<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> chr_hello<span class="token punctuation">.</span>devid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> NEWCHRDEV_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>chr_hello<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"device_create() failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		result <span class="token operator">=</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>chr_hello<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> result<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="alloc_chrdev_region_69"></a>alloc_chrdev_region</h5> 
<pre><code class="prism language-c"><span class="token comment">/*
 * @description	     : 注册一个范围（)的设备号
 * @param - dev		 : cdev结构体地址
 * @param - baseminor: 起始的次设备号
 * @param -	count 	 ：次设备号个数
 * @param -	name	 ：设备名称
 * @return 			 : 成功返回0,失败返回错误码（负数）
 */</span>		
<span class="token keyword">int</span> <span class="token function">alloc_chrdev_region</span><span class="token punctuation">(</span><span class="token class-name">dev_t</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> baseminor<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> count<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span>
</code></pre> 
<h5><a id="file_operations_81"></a>file_operations</h5> 
<pre><code class="prism language-c"><span class="token comment">/* 设备操作函数 */</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> chr_hello_ops <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>	
	<span class="token punctuation">.</span>open <span class="token operator">=</span> hello_open<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>release <span class="token operator">=</span> hello_release<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>open、release对应应用层的open（）、close（）函数。实现比较简单，直接返回0即可。<br> 其中read、write、unloched_ioctrl 函数的实现需要涉及到用户空间和内存空间的数据拷贝。<br> 在Linux操作系统中，用户空间和内核空间是相互独立的。也就是说内核空间是不能直接访问用户空间内存地址，同理用户空间也不能直接访问内核空间内存地址。<br> 如果想实现，将用户空间的数据拷贝到内核空间或将内核空间数据拷贝到用户空间，就必须借助内核给我们提供的接口来完成。<br> 下一篇文章实现read、write接口。</p> 
<h3><a id="vim_helloc_95"></a>vim hello.c</h3> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kdev_t.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/cdev.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/uaccess.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NEWCHRDEV_CNT</span>	<span class="token expression"><span class="token number">1</span>			</span><span class="token comment">/* 设备号个数 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NEWCHRDEV_NAME</span>	<span class="token string">"hello"</span>		<span class="token comment">/* 名字 */</span></span>

<span class="token comment">/* newchrdev设备结构体 */</span>
<span class="token keyword">struct</span> <span class="token class-name">newchr_dev</span><span class="token punctuation">{<!-- --></span>
	<span class="token class-name">dev_t</span> devid<span class="token punctuation">;</span>			<span class="token comment">/* 设备号 	 */</span>
	<span class="token keyword">struct</span> <span class="token class-name">cdev</span> cdev<span class="token punctuation">;</span>		<span class="token comment">/* cdev 	*/</span>
	<span class="token keyword">struct</span> <span class="token class-name">class</span> <span class="token operator">*</span>class<span class="token punctuation">;</span>		<span class="token comment">/* 类 		*/</span>
	<span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>device<span class="token punctuation">;</span>	 <span class="token comment">/* 设备 	 */</span>
	<span class="token keyword">int</span> major<span class="token punctuation">;</span>				<span class="token comment">/* 主设备号	  */</span>
	<span class="token keyword">int</span> minor<span class="token punctuation">;</span>				<span class="token comment">/* 次设备号   */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">newchr_dev</span> chr_hello<span class="token punctuation">;</span>	<span class="token comment">/* 设备hello */</span>

<span class="token comment">/*
 * @description		: 打开设备
 * @param - inode 	: 传递给驱动的inode
 * @param - filp 	: 设备文件，file结构体有个叫做private_data的成员变量
 * 					  一般在open的时候将private_data指向设备结构体。
 * @return 			: 0 成功;其他 失败
 */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">hello_open</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filep<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"hello_open()\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*
 * @description		: 关闭/释放设备
 * @param - filp 	: 要关闭的设备文件(文件描述符)
 * @return 			: 0 成功;其他 失败
 */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">hello_release</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filep<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"hello_release()\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 设备操作函数 */</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> chr_hello_ops <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>	
	<span class="token punctuation">.</span>open <span class="token operator">=</span> hello_open<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>release <span class="token operator">=</span> hello_release<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/* 
 * @description	: 驱动入口函数
 * @param 		: 无
 * @return 		: 0 成功;其他 失败
 */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">hello_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"chrdev_hello init!\r \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/* 注册字符设备驱动 */</span>
	<span class="token comment">/* 1、创建设备号 */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>chr_hello<span class="token punctuation">.</span>major<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>		<span class="token comment">/*  定义了设备号 */</span>
		chr_hello<span class="token punctuation">.</span>devid <span class="token operator">=</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>chr_hello<span class="token punctuation">.</span>major<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">/* 据定义设备号申请注册 */</span>
		result <span class="token operator">=</span> <span class="token function">register_chrdev_region</span><span class="token punctuation">(</span>chr_hello<span class="token punctuation">.</span>devid<span class="token punctuation">,</span> NEWCHRDEV_CNT<span class="token punctuation">,</span> NEWCHRDEV_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>result <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"register_chrdev fail \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
			<span class="token keyword">goto</span> out_err_1<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>			<span class="token comment">/* 没有定义设备号,自动分配*/</span>
		result <span class="token operator">=</span> <span class="token function">alloc_chrdev_region</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chr_hello<span class="token punctuation">.</span>devid<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> NEWCHRDEV_CNT<span class="token punctuation">,</span> NEWCHRDEV_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">/* 申请设备号 */</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>result <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"alloc_chrdev_region fail \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//自动分配设备号错误</span>
			<span class="token keyword">goto</span> out_err_1<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		chr_hello<span class="token punctuation">.</span>major <span class="token operator">=</span> <span class="token function">MAJOR</span><span class="token punctuation">(</span>chr_hello<span class="token punctuation">.</span>devid<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">/* MAJOR宏获取分配号的主设备号 */</span>
		chr_hello<span class="token punctuation">.</span>minor <span class="token operator">=</span> <span class="token function">MINOR</span><span class="token punctuation">(</span>chr_hello<span class="token punctuation">.</span>devid<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">/* MINOR宏获取分配号的次设备号 */</span>
	<span class="token punctuation">}</span>
	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"chr_hello major=%d,minor=%d\r\n"</span><span class="token punctuation">,</span>chr_hello<span class="token punctuation">.</span>major<span class="token punctuation">,</span> chr_hello<span class="token punctuation">.</span>minor<span class="token punctuation">)</span><span class="token punctuation">;</span>	
	
	<span class="token comment">/* 2、初始化cdev */</span>
	chr_hello<span class="token punctuation">.</span>cdev<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">;</span>
	<span class="token function">cdev_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chr_hello<span class="token punctuation">.</span>cdev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>chr_hello_ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/* 3、添加一个cdev */</span>
	<span class="token function">cdev_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chr_hello<span class="token punctuation">.</span>cdev<span class="token punctuation">,</span> chr_hello<span class="token punctuation">.</span>devid<span class="token punctuation">,</span> NEWCHRDEV_CNT<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* 4、创建类 */</span>
	chr_hello<span class="token punctuation">.</span>class <span class="token operator">=</span> <span class="token function">class_create</span><span class="token punctuation">(</span>THIS_MODULE<span class="token punctuation">,</span> <span class="token string">"hlocls"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//生成hlocls设备类</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>chr_hello<span class="token punctuation">.</span>class<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"class_create() failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		result <span class="token operator">=</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>chr_hello<span class="token punctuation">.</span>class<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">goto</span> out_err_2<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/* 5、创建设备 */</span>
	chr_hello<span class="token punctuation">.</span>device <span class="token operator">=</span> <span class="token function">device_create</span><span class="token punctuation">(</span>chr_hello<span class="token punctuation">.</span>class<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> chr_hello<span class="token punctuation">.</span>devid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> NEWCHRDEV_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>chr_hello<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"device_create() failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		result <span class="token operator">=</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>chr_hello<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">goto</span> out_err_3<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> result<span class="token punctuation">;</span> 
<span class="token comment">//释放已申请的资源返回</span>
out_err_3<span class="token operator">:</span>
	<span class="token function">device_destroy</span><span class="token punctuation">(</span>chr_hello<span class="token punctuation">.</span>class<span class="token punctuation">,</span> chr_hello<span class="token punctuation">.</span>devid<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/*  删除device */</span>	
out_err_2<span class="token operator">:</span>
	<span class="token function">class_destroy</span><span class="token punctuation">(</span>chr_hello<span class="token punctuation">.</span>class<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/*  删除class */</span>
	<span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>chr_hello<span class="token punctuation">.</span>devid<span class="token punctuation">,</span> NEWCHRDEV_CNT<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 注销设备号 */</span>
	<span class="token function">cdev_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chr_hello<span class="token punctuation">.</span>cdev<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/*  删除cdev */</span>
out_err_1<span class="token operator">:</span>
	<span class="token keyword">return</span> 	result<span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
<span class="token comment">/*
 * @description	: 驱动出口函数
 * @param 		: 无
 * @return 		: 无
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">hello_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"chrdev_hello exit!\r \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/* 注销字符设备驱动 */</span>
	<span class="token function">device_destroy</span><span class="token punctuation">(</span>chr_hello<span class="token punctuation">.</span>class<span class="token punctuation">,</span> chr_hello<span class="token punctuation">.</span>devid<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/*  删除device */</span>
	<span class="token function">class_destroy</span><span class="token punctuation">(</span>chr_hello<span class="token punctuation">.</span>class<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/*  删除class */</span>
	<span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>chr_hello<span class="token punctuation">.</span>devid<span class="token punctuation">,</span> NEWCHRDEV_CNT<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 注销设备号 */</span>
	<span class="token function">cdev_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chr_hello<span class="token punctuation">.</span>cdev<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/*  删除cdev */</span>
	<span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//modinfo  name.ko</span>
<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//遵循GPL协议</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"CJX"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_DESCRIPTION</span><span class="token punctuation">(</span><span class="token string">"Just for Demon"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>hello_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>hello_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//cat proc/devices</span>

</code></pre> 
<h4><a id="makeinsmod_237"></a>make、insmod</h4> 
<pre><code class="prism language-c">root@ubuntu16<span class="token operator">:</span><span class="token operator">/</span>home<span class="token operator">/</span>cxx<span class="token operator">/</span>driver<span class="token operator">/</span><span class="token number">5</span>_class# 
root@ubuntu16<span class="token operator">:</span><span class="token operator">/</span>home<span class="token operator">/</span>cxx<span class="token operator">/</span>driver<span class="token operator">/</span><span class="token number">5</span>_class# make
<span class="token string">"1st"</span>
make <span class="token operator">-</span>C <span class="token operator">/</span>lib<span class="token operator">/</span>modules<span class="token operator">/</span><span class="token number">4.15</span><span class="token number">.0</span><span class="token operator">-</span><span class="token number">142</span><span class="token operator">-</span>generic<span class="token operator">/</span>build M<span class="token operator">=</span><span class="token operator">/</span>home<span class="token operator">/</span>cxx<span class="token operator">/</span>driver<span class="token operator">/</span><span class="token number">5</span>_class modules
make<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">:</span> Entering directory <span class="token string">'/usr/src/linux-headers-4.15.0-142-generic'</span>
<span class="token string">"2nd"</span>
  CC <span class="token punctuation">[</span>M<span class="token punctuation">]</span>  <span class="token operator">/</span>home<span class="token operator">/</span>cxx<span class="token operator">/</span>driver<span class="token operator">/</span><span class="token number">5</span>_class<span class="token operator">/</span>hello<span class="token punctuation">.</span>o
  Building modules<span class="token punctuation">,</span> stage <span class="token number">2.</span>
<span class="token string">"2nd"</span>
  MODPOST <span class="token number">1</span> modules
  CC      <span class="token operator">/</span>home<span class="token operator">/</span>cxx<span class="token operator">/</span>driver<span class="token operator">/</span><span class="token number">5</span>_class<span class="token operator">/</span>hello<span class="token punctuation">.</span>mod<span class="token punctuation">.</span>o
  LD <span class="token punctuation">[</span>M<span class="token punctuation">]</span>  <span class="token operator">/</span>home<span class="token operator">/</span>cxx<span class="token operator">/</span>driver<span class="token operator">/</span><span class="token number">5</span>_class<span class="token operator">/</span>hello<span class="token punctuation">.</span>ko
make<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">:</span> Leaving directory <span class="token string">'/usr/src/linux-headers-4.15.0-142-generic'</span>
root@ubuntu16<span class="token operator">:</span><span class="token operator">/</span>home<span class="token operator">/</span>cxx<span class="token operator">/</span>driver<span class="token operator">/</span><span class="token number">5</span>_class# ls
a<span class="token punctuation">.</span>out  app_cdev<span class="token punctuation">.</span>c  hello<span class="token punctuation">.</span>c  hello<span class="token punctuation">.</span>ko  hello<span class="token punctuation">.</span>mod<span class="token punctuation">.</span>c  hello<span class="token punctuation">.</span>mod<span class="token punctuation">.</span>o  hello<span class="token punctuation">.</span>o  Makefile  modules<span class="token punctuation">.</span>order  Module<span class="token punctuation">.</span>symvers
root@ubuntu16<span class="token operator">:</span><span class="token operator">/</span>home<span class="token operator">/</span>cxx<span class="token operator">/</span>driver<span class="token operator">/</span><span class="token number">5</span>_class# lsmod <span class="token operator">|</span> grep hello
root@ubuntu16<span class="token operator">:</span><span class="token operator">/</span>home<span class="token operator">/</span>cxx<span class="token operator">/</span>driver<span class="token operator">/</span><span class="token number">5</span>_class#
root@ubuntu16<span class="token operator">:</span><span class="token operator">/</span>home<span class="token operator">/</span>cxx<span class="token operator">/</span>driver<span class="token operator">/</span><span class="token number">5</span>_class# dmesg <span class="token operator">-</span>c
root@ubuntu16<span class="token operator">:</span><span class="token operator">/</span>home<span class="token operator">/</span>cxx<span class="token operator">/</span>driver<span class="token operator">/</span><span class="token number">5</span>_class# insmod hello<span class="token punctuation">.</span>ko
</code></pre> 
<h4><a id="app_cdevc_259"></a>app_cdev.c</h4> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> fd<span class="token punctuation">;</span>
	fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/hello"</span><span class="token punctuation">,</span>O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>fd<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open fail \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"cdev_hello open success\n "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="aout_280"></a>./a.out</h4> 
<pre><code class="prism language-c">root@ubuntu16<span class="token operator">:</span><span class="token operator">/</span>home<span class="token operator">/</span>cxx<span class="token operator">/</span>driver<span class="token operator">/</span><span class="token number">5</span>_class# gcc app_cdev<span class="token punctuation">.</span>c 
root@ubuntu16<span class="token operator">:</span><span class="token operator">/</span>home<span class="token operator">/</span>cxx<span class="token operator">/</span>driver<span class="token operator">/</span><span class="token number">5</span>_class# <span class="token punctuation">.</span><span class="token operator">/</span>a<span class="token punctuation">.</span>out 
cdev_hello open success
 root@ubuntu16<span class="token operator">:</span><span class="token operator">/</span>home<span class="token operator">/</span>cxx<span class="token operator">/</span>driver<span class="token operator">/</span><span class="token number">5</span>_class# dmesg
<span class="token punctuation">[</span><span class="token number">48973.889676</span><span class="token punctuation">]</span> <span class="token function">hello_open</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">48973.889714</span><span class="token punctuation">]</span> <span class="token function">hello_release</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
root@ubuntu16<span class="token operator">:</span><span class="token operator">/</span>home<span class="token operator">/</span>cxx<span class="token operator">/</span>driver<span class="token operator">/</span><span class="token number">5</span>_class# 
</code></pre> 
<h4><a id="_290"></a>查看节点文件生成：</h4> 
<pre><code class="prism language-c">cxx@ubuntu16<span class="token operator">:</span><span class="token operator">~</span>$ 
cxx@ubuntu16<span class="token operator">:</span><span class="token operator">~</span>$ dmesg 
<span class="token punctuation">[</span> <span class="token number">3303.145506</span><span class="token punctuation">]</span> hello_init 
cxx@ubuntu16<span class="token operator">:</span><span class="token operator">~</span>$ 
cxx@ubuntu16<span class="token operator">:</span><span class="token operator">~</span>$ cd <span class="token operator">/</span>dev<span class="token operator">/</span>
cxx@ubuntu16<span class="token operator">:</span><span class="token operator">/</span>dev$ 
cxx@ubuntu16<span class="token operator">:</span><span class="token operator">/</span>dev$ ls <span class="token operator">-</span>l <span class="token operator">|</span> grep hello 
crw<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>  <span class="token number">1</span> root root    <span class="token number">222</span><span class="token punctuation">,</span>   <span class="token number">0</span> Apr <span class="token number">24</span> <span class="token number">23</span><span class="token operator">:</span><span class="token number">04</span> hello <span class="token comment">//设备节点文件</span>
cxx@ubuntu16<span class="token operator">:</span><span class="token operator">/</span>dev$ cd <span class="token operator">/</span>sys<span class="token operator">/</span>class<span class="token operator">/</span>
cxx@ubuntu16<span class="token operator">:</span><span class="token operator">/</span>sys<span class="token operator">/</span>class$ ls <span class="token operator">-</span>l <span class="token operator">|</span>grep hlocls 
drwxr<span class="token operator">-</span>xr<span class="token operator">-</span>x <span class="token number">2</span> root root <span class="token number">0</span> Apr <span class="token number">24</span> <span class="token number">23</span><span class="token operator">:</span><span class="token number">04</span> hlocls <span class="token comment">//创建的类</span>
cxx@ubuntu16<span class="token operator">:</span><span class="token operator">/</span>sys<span class="token operator">/</span>class$ 
</code></pre> 
<h5><a id="modinfo_helloko_305"></a>modinfo hello.ko</h5> 
<pre><code class="prism language-c">root@ubuntu16<span class="token operator">:</span><span class="token operator">/</span>home<span class="token operator">/</span>cxx<span class="token operator">/</span>driver<span class="token operator">/</span>class# modinfo hello<span class="token punctuation">.</span>ko
filename<span class="token operator">:</span>       <span class="token operator">/</span>home<span class="token operator">/</span>cxx<span class="token operator">/</span>driver<span class="token operator">/</span>class<span class="token operator">/</span>hello<span class="token punctuation">.</span>ko
license<span class="token operator">:</span>        GPL
description<span class="token operator">:</span>    Just <span class="token keyword">for</span> Demon
author<span class="token operator">:</span>         CJX
srcversion<span class="token operator">:</span>     <span class="token number">80</span>CCDA080F5EC6D49A43853
depends<span class="token operator">:</span>        
retpoline<span class="token operator">:</span>      Y
name<span class="token operator">:</span>           hello
vermagic<span class="token operator">:</span>       <span class="token number">4.15</span><span class="token number">.0</span><span class="token operator">-</span><span class="token number">142</span><span class="token operator">-</span>generic SMP mod_unload 
root@ubuntu16<span class="token operator">:</span><span class="token operator">/</span>home<span class="token operator">/</span>cxx<span class="token operator">/</span>driver<span class="token operator">/</span>class# 
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4ca2167ed162f1e5616abdede308af2d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">《Python程序设计》题目集</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b6a38623a34f550d90ba5e3d7ec24c7a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Leetcode No.62 不同路径</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>