<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>é¡¹ç›®å®æˆ˜ â€” æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆ4ï¼‰{æ¶ˆæ¯æŒä¹…åŒ–} - ç¼–ç¨‹å¤§ç™½çš„åšå®¢</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="é¡¹ç›®å®æˆ˜ â€” æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆ4ï¼‰{æ¶ˆæ¯æŒä¹…åŒ–}" />
<meta property="og:description" content="ç›®å½•
ä¸€ã€æ¶ˆæ¯å­˜å‚¨æ ¼å¼è®¾è®¡
ğŸ… 1ã€queue_data.txtï¼šä¿å­˜æ¶ˆæ¯çš„å†…å®¹
ğŸ… 2ã€queue_stat.txtï¼šä¿å­˜æ¶ˆæ¯çš„ç»Ÿè®¡ä¿¡æ¯
äºŒã€æ¶ˆæ¯åºåˆ—åŒ–
ä¸‰ã€è‡ªå®šä¹‰å¼‚å¸¸ç±»
å››ã€åˆ›å»ºMessageFileMangerç±»
ğŸ… 1ã€çº¦å®šæ¶ˆæ¯æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•å’Œæ–‡ä»¶åå­—
ğŸ… 2ã€é˜Ÿåˆ—çš„ç»Ÿè®¡ä¿¡æ¯
ğŸ… 3ã€åˆ›å»ºé˜Ÿåˆ—å¯¹åº”çš„ç›®å½•å’ŒåŠŸèƒ½
ğŸ… 4ã€å®ç°åˆ é™¤é˜Ÿåˆ—çš„æ–‡ä»¶å’Œç›®å½•
ğŸ… 5ã€æ£€æŸ¥é˜Ÿåˆ—çš„ç›®å½•å’Œæ–‡ä»¶æ˜¯å¦éƒ½å­˜åœ¨
ğŸ… 6ã€æŠŠæ¶ˆæ¯å†™å…¥åˆ°æ–‡ä»¶ä¸­
ğŸ… 7ã€åˆ é™¤æ–‡ä»¶ä¸­çš„æ¶ˆæ¯
ğŸ… 8ã€å°†ç¡¬ç›˜ä¸­çš„æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­
ğŸ… 9ã€å®ç°æ¶ˆæ¯æ–‡ä»¶çš„åƒåœ¾å›æ”¶
ğŸˆ æ£€æµ‹æ˜¯å¦è¦è¿›è¡ŒGC
ğŸˆ æ„é€ æ–°ç›®å½•
ğŸˆ è¿›è¡ŒGCæ“ä½œ
äº”ã€æµ‹è¯•MessageFileManagerç±»
ğŸ… 1ã€â€œå‡†å¤‡å·¥ä½œâ€å’Œâ€œæ”¶å°¾å·¥ä½œâ€
ğŸ… 2ã€æµ‹è¯•åˆ›å»ºæ–‡ä»¶æ˜¯å¦å­˜åœ¨
ğŸ… 3ã€æµ‹è¯•writetStatå’ŒreadStatæ˜¯å¦èƒ½å¤Ÿé€šè¿‡
ğŸ… 4ã€æµ‹è¯•sendMessage
ğŸ… 5ã€æµ‹è¯•åˆ é™¤æ¶ˆæ¯
ğŸ… 6ã€æµ‹è¯•åƒåœ¾å›æ”¶
å…­ã€å°ç»“
ä¸€ã€æ¶ˆæ¯å­˜å‚¨æ ¼å¼è®¾è®¡ å¯¹äºæ¶ˆæ¯ï¼Œå¹¶ä¸æ‰“ç®—å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼š
ï¼ˆ1ï¼‰æ¶ˆæ¯æ“ä½œå¹¶ä¸ä¼šæ¶‰åŠåˆ°å¤æ‚çš„å¢åˆ æ”¹æŸ¥
ï¼ˆ2ï¼‰æ¶ˆæ¯çš„æ•°é‡å¯èƒ½ä¼šéå¸¸å¤šï¼Œæ•°æ®åº“çš„è®¿é—®æ•ˆç‡å¹¶ä¸é«˜
æ‰€ä»¥ï¼Œæˆ‘ä»¬ç›´æ¥æŠŠæ¶ˆæ¯å­˜å‚¨åœ¨æ–‡ä»¶ä¸­ã€‚
é‚£ä¹ˆæ¶ˆæ¯è¦å¦‚ä½•åœ¨æ–‡ä»¶ä¸­å­˜å‚¨å‘¢ï¼Ÿ
é¦–å…ˆæ¶ˆæ¯ï¼Œå®ƒæ˜¯ä¾é™„äºé˜Ÿåˆ—çš„ï¼Œæ‰€ä»¥åœ¨å­˜å‚¨çš„æ—¶å€™ï¼Œå°±æŠŠæ¶ˆæ¯æŒ‰ç…§é˜Ÿåˆ—çš„ç»´åº¦å±•å¼€ã€‚
æˆ‘ä»¬ä¼šå°†é˜Ÿåˆ—å­˜å‚¨åœ¨å’Œæ•°æ®åº“åŒçº§çš„dataç›®å½•ä¸­ï¼Œåœ¨dataä¸­åˆ›å»ºä¸€äº›å­ç›®å½•ï¼Œå­ç›®å½•çš„åå­—å°±æ˜¯é˜Ÿåˆ—åã€‚
ç„¶ååœ¨æ¯ä¸ªé˜Ÿåˆ—çš„å­ç›®å½•ä¸‹é¢ï¼Œå†åˆ†é…ä¸¤ä¸ªæ–‡ä»¶ï¼Œç”¨æ¥å­˜å‚¨æ¶ˆæ¯ã€‚ä¸»è¦æ˜¯ä»¥ä¸‹ä¸¤ä¸ªæ–‡ä»¶ã€‚
ğŸ… 1ã€queue_data.txtï¼šä¿å­˜æ¶ˆæ¯çš„å†…å®¹ Messageæ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶æ ¼å¼çš„æ–‡ä»¶ï¼ŒåŒ…å«è‹¥å¹²ä¸ªæ¶ˆæ¯ï¼Œæ¯ä¸ªæ¶ˆæ¯éƒ½ä»¥äºŒè¿›åˆ¶çš„æ–¹å¼å­˜å‚¨ï¼Œæ¯ä¸ªæ¶ˆæ¯éƒ½ç”±è¿™å‡ ä¸ªéƒ¨åˆ†æ„æˆï¼šMessageå¯¹è±¡åºåˆ—åŒ–ä¹‹åã€‚
Messagå¯¹è±¡ï¼Œä¼šåˆ†åˆ«å†å†…å­˜å’Œç¡¬ç›˜ä¸Šéƒ½è®°å½•ä¸€ä»½ã€‚å†…å­˜ä¸­çš„è¡£æœå‘¢ä¼šè®°å½•offsetBeginå’ŒoffsetEndã€‚è¿™æ ·å°±å¯ä»¥æ‰¾åˆ°å†…å­˜ä¸­çš„Messageå¯¹è±¡ï¼Œèƒ½å¤Ÿæ‰¾åˆ°å¯¹åº”çš„ç¡¬ç›˜ä¸Šçš„messageå¯¹è±¡ã€‚
å…³äºisValidï¼šæ˜¯ç”¨æ¥æ ‡è¯†å½“å‰æ¶ˆæ¯åœ¨æ–‡ä»¶ä¸­æ˜¯å¦æœ‰æ•ˆï¼Œä¸º1å°±æ˜¯æœ‰æ•ˆçš„æ¶ˆæ¯ï¼Œä¸º0å°±æ˜¯æ— æ•ˆçš„æ¶ˆæ¯ã€‚å½“ä¸º0æ—¶å°±ç›¸å½“äºé€»è¾‘ä¸Šçš„åˆ é™¤æ¶ˆæ¯åŠŸèƒ½ã€‚ä½†æ˜¯ï¼Œéšç€æ—¶é—´çš„æ¨ç§»ï¼Œæ¶ˆæ¯çš„å¢å¤šï¼Œé‚£ä¹ˆè¯¥æ¶ˆæ¯å¯èƒ½å°±ä¼šå¤§éƒ¨åˆ†éƒ½æ˜¯æ— æ•ˆçš„æ¶ˆæ¯ï¼Œé’ˆå¯¹è¿™ç§æƒ…å†µï¼Œå°±éœ€è¦å¯¹å½“å‰æ¶ˆæ¯çš„æ–‡ä»¶ï¼Œè¿›è¡Œåƒåœ¾å›æ”¶ã€‚
ä»¥ä¸‹æ˜¯æœ¬ç¨‹åºä¸­å®ç°çš„åƒåœ¾å›æ”¶åŠŸèƒ½ï¼šÂ åƒåœ¾å›æ”¶ï¼ˆGCï¼‰ï¼šä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼Œé’ˆå¯¹æ¶ˆæ¯æ•°æ®æ–‡ä»¶ä¸­çš„åƒåœ¾å›æ”¶è¿›è¡Œå›æ”¶ã€‚ç›´æ¥éå†åŸæœ‰çš„æ¶ˆæ¯æ•°æ®æ–‡ä»¶ï¼ŒæŠŠæœ‰æ•ˆçš„æ•°æ®æ‹·è´åˆ°ä¸€ä¸ªæ–°çš„æ–‡ä»¶ä¸­ï¼Œç„¶åæŠŠä¹‹å‰çš„æ—§æ–‡ä»¶éƒ½åˆ é™¤æ‰ï¼ˆé€»è¾‘åˆ é™¤ï¼‰ã€‚
ä½œå‡ºçº¦å®šï¼ˆå¯ä»¥ä¸æŒ‰è¿™ä¸ªæ¥ï¼‰ï¼Œå½“æ€»æ¶ˆæ¯æ•°ç›®è¶…è¿‡äº†2000ï¼Œå¹¶ä¸”æœ‰æ•ˆçš„æ¶ˆæ¯æ•°ç›®ä½äºæ€»æ•°ç›®çš„50%ï¼Œå°±å‡ºå‘ä¸€æ¬¡åƒåœ¾å›æ”¶ã€‚
å¯¹äºRabbitMQè§£å†³åƒåœ¾å›æ”¶çš„æ–¹å¼å¦‚ä¸‹ï¼š
å¦‚æœæŸä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œæ¶ˆæ¯å¾ˆå¤šï¼Œéƒ½æ˜¯æœ‰æ•ˆæ¶ˆæ¯ï¼Œå°±ä¼šå¯¼è‡´æ•´ä¸ªæ¶ˆæ¯çš„æ•°æ®æ–‡ä»¶ç‰¹åˆ«ç­”ï¼Œåç»­é’ˆå¯¹æ–‡ä»¶çš„å„ç§æ“ä½œï¼Œæˆæœ¬å°±ä¼šå¾ˆé«˜ã€‚RabbitMQè§£å†³æ–¹æ¡ˆå¦‚ä¸‹ï¼š
æ–‡ä»¶æ‹†åˆ†ï¼šå½“å•ä¸ªæ–‡ä»¶é•¿åº¦è¾¾åˆ°ä¸€å®šé˜ˆå€¼ä»¥åï¼Œå°±ä¼šæ‹†åˆ†æˆä¸¤ä¸ªæ–‡ä»¶ï¼ˆæ‹†åˆ†æ¬¡æ•°è¶Šå¤šæ–‡ä»¶å°±è¶Šå¤šï¼‰
æ–‡ä»¶åˆå¹¶ï¼šæ¯ä¸ªå•ç‹¬çš„æ–‡ä»¶éƒ½ä¼šè¿›è¡ŒGCï¼Œå¦‚æœGCä¹‹åï¼Œå°±ä¼šå‘ç°æ–‡ä»¶å˜å°å¾ˆå¤šï¼Œå½“å°åˆ°ä¸€å®šç¨‹åº¦ï¼Œå°±ä¼šå’Œå…¶ä»–æ–‡ä»¶åˆå¹¶ã€‚
è¿™æ ·å°±ä¼šå†æ¶ˆæ¯ç‰¹åˆ«å¤šçš„æ—¶å€™ï¼Œä¹Ÿèƒ½ä¿è¯æ€§èƒ½ä¸Šçš„åŠæ—¶å“åº”ã€‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/6aeec33f7546e85cbaa423c461b6c08d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-06T20:32:21+08:00" />
<meta property="article:modified_time" content="2023-08-06T20:32:21+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="ç¼–ç¨‹å¤§ç™½çš„åšå®¢" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">ç¼–ç¨‹å¤§ç™½çš„åšå®¢</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">é¡¹ç›®å®æˆ˜ â€” æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆ4ï¼‰{æ¶ˆæ¯æŒä¹…åŒ–}</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>ç›®å½•</strong></p> 
<p id="%C2%A0%E4%B8%80%E3%80%81%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8%E6%A0%BC%E5%BC%8F%E8%AE%BE%E8%AE%A1-toc" style="margin-left:0px;"><a href="#%C2%A0%E4%B8%80%E3%80%81%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8%E6%A0%BC%E5%BC%8F%E8%AE%BE%E8%AE%A1" rel="nofollow">Â ä¸€ã€æ¶ˆæ¯å­˜å‚¨æ ¼å¼è®¾è®¡</a></p> 
<p id="%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%F0%9F%8D%85%201%E3%80%81queue_data.txt%EF%BC%9A%E4%BF%9D%E5%AD%98%E6%B6%88%E6%81%AF%E7%9A%84%E5%86%85%E5%AE%B9-toc" style="margin-left:40px;"><a href="#%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%F0%9F%8D%85%201%E3%80%81queue_data.txt%EF%BC%9A%E4%BF%9D%E5%AD%98%E6%B6%88%E6%81%AF%E7%9A%84%E5%86%85%E5%AE%B9" rel="nofollow">Â  Â  Â  Â ğŸ… 1ã€queue_data.txtï¼šä¿å­˜æ¶ˆæ¯çš„å†…å®¹</a></p> 
<p id="%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%F0%9F%8D%85%202%E3%80%81queue_stat.txt%EF%BC%9A%E4%BF%9D%E5%AD%98%E6%B6%88%E6%81%AF%E7%9A%84%E7%BB%9F%E8%AE%A1%E4%BF%A1%E6%81%AF-toc" style="margin-left:40px;"><a href="#%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%F0%9F%8D%85%202%E3%80%81queue_stat.txt%EF%BC%9A%E4%BF%9D%E5%AD%98%E6%B6%88%E6%81%AF%E7%9A%84%E7%BB%9F%E8%AE%A1%E4%BF%A1%E6%81%AF" rel="nofollow">Â  Â  Â  Â  ğŸ… 2ã€queue_stat.txtï¼šä¿å­˜æ¶ˆæ¯çš„ç»Ÿè®¡ä¿¡æ¯</a></p> 
<p id="%E4%BA%8C%E3%80%81%E6%B6%88%E6%81%AF%E5%BA%8F%E5%88%97%E5%8C%96-toc" style="margin-left:0px;"><a href="#%E4%BA%8C%E3%80%81%E6%B6%88%E6%81%AF%E5%BA%8F%E5%88%97%E5%8C%96" rel="nofollow">äºŒã€æ¶ˆæ¯åºåˆ—åŒ–</a></p> 
<p id="%E4%B8%89%E3%80%81%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E5%B8%B8%E7%B1%BB-toc" style="margin-left:0px;"><a href="#%E4%B8%89%E3%80%81%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E5%B8%B8%E7%B1%BB" rel="nofollow">ä¸‰ã€è‡ªå®šä¹‰å¼‚å¸¸ç±»</a></p> 
<p id="%E5%9B%9B%E3%80%81%E5%88%9B%E5%BB%BAMessageFileManger%E7%B1%BB-toc" style="margin-left:0px;"><a href="#%E5%9B%9B%E3%80%81%E5%88%9B%E5%BB%BAMessageFileManger%E7%B1%BB" rel="nofollow">å››ã€åˆ›å»ºMessageFileMangerç±»</a></p> 
<p id="%F0%9F%8D%85%201%E3%80%81%E7%BA%A6%E5%AE%9A%E6%B6%88%E6%81%AF%E6%96%87%E4%BB%B6%E6%89%80%E5%9C%A8%E7%9A%84%E7%9B%AE%E5%BD%95%E5%92%8C%E6%96%87%E4%BB%B6%E5%90%8D%E5%AD%97-toc" style="margin-left:40px;"><a href="#%F0%9F%8D%85%201%E3%80%81%E7%BA%A6%E5%AE%9A%E6%B6%88%E6%81%AF%E6%96%87%E4%BB%B6%E6%89%80%E5%9C%A8%E7%9A%84%E7%9B%AE%E5%BD%95%E5%92%8C%E6%96%87%E4%BB%B6%E5%90%8D%E5%AD%97" rel="nofollow">ğŸ… 1ã€çº¦å®šæ¶ˆæ¯æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•å’Œæ–‡ä»¶åå­—</a></p> 
<p id="%C2%A0%F0%9F%8D%85%202%E3%80%81%E9%98%9F%E5%88%97%E7%9A%84%E7%BB%9F%E8%AE%A1%E4%BF%A1%E6%81%AF-toc" style="margin-left:40px;"><a href="#%C2%A0%F0%9F%8D%85%202%E3%80%81%E9%98%9F%E5%88%97%E7%9A%84%E7%BB%9F%E8%AE%A1%E4%BF%A1%E6%81%AF" rel="nofollow">Â ğŸ… 2ã€é˜Ÿåˆ—çš„ç»Ÿè®¡ä¿¡æ¯</a></p> 
<p id="%F0%9F%8D%85%203%E3%80%81%E5%88%9B%E5%BB%BA%E9%98%9F%E5%88%97%E5%AF%B9%E5%BA%94%E7%9A%84%E7%9B%AE%E5%BD%95%E5%92%8C%E5%8A%9F%E8%83%BD-toc" style="margin-left:40px;"><a href="#%F0%9F%8D%85%203%E3%80%81%E5%88%9B%E5%BB%BA%E9%98%9F%E5%88%97%E5%AF%B9%E5%BA%94%E7%9A%84%E7%9B%AE%E5%BD%95%E5%92%8C%E5%8A%9F%E8%83%BD" rel="nofollow">ğŸ… 3ã€åˆ›å»ºé˜Ÿåˆ—å¯¹åº”çš„ç›®å½•å’ŒåŠŸèƒ½</a></p> 
<p id="%F0%9F%8D%85%204%E3%80%81%E5%AE%9E%E7%8E%B0%E5%88%A0%E9%99%A4%E9%98%9F%E5%88%97%E7%9A%84%E6%96%87%E4%BB%B6%E5%92%8C%E7%9B%AE%E5%BD%95-toc" style="margin-left:40px;"><a href="#%F0%9F%8D%85%204%E3%80%81%E5%AE%9E%E7%8E%B0%E5%88%A0%E9%99%A4%E9%98%9F%E5%88%97%E7%9A%84%E6%96%87%E4%BB%B6%E5%92%8C%E7%9B%AE%E5%BD%95" rel="nofollow">ğŸ… 4ã€å®ç°åˆ é™¤é˜Ÿåˆ—çš„æ–‡ä»¶å’Œç›®å½•</a></p> 
<p id="%F0%9F%8D%85%205%E3%80%81%E6%A3%80%E6%9F%A5%E9%98%9F%E5%88%97%E7%9A%84%E7%9B%AE%E5%BD%95%E5%92%8C%E6%96%87%E4%BB%B6%E6%98%AF%E5%90%A6%E9%83%BD%E5%AD%98%E5%9C%A8-toc" style="margin-left:40px;"><a href="#%F0%9F%8D%85%205%E3%80%81%E6%A3%80%E6%9F%A5%E9%98%9F%E5%88%97%E7%9A%84%E7%9B%AE%E5%BD%95%E5%92%8C%E6%96%87%E4%BB%B6%E6%98%AF%E5%90%A6%E9%83%BD%E5%AD%98%E5%9C%A8" rel="nofollow">ğŸ… 5ã€æ£€æŸ¥é˜Ÿåˆ—çš„ç›®å½•å’Œæ–‡ä»¶æ˜¯å¦éƒ½å­˜åœ¨</a></p> 
<p id="%F0%9F%8D%85%206%E3%80%81%E6%8A%8A%E6%B6%88%E6%81%AF%E5%86%99%E5%85%A5%E5%88%B0%E6%96%87%E4%BB%B6%E4%B8%AD-toc" style="margin-left:40px;"><a href="#%F0%9F%8D%85%206%E3%80%81%E6%8A%8A%E6%B6%88%E6%81%AF%E5%86%99%E5%85%A5%E5%88%B0%E6%96%87%E4%BB%B6%E4%B8%AD" rel="nofollow">ğŸ… 6ã€æŠŠæ¶ˆæ¯å†™å…¥åˆ°æ–‡ä»¶ä¸­</a></p> 
<p id="%F0%9F%8D%85%207%E3%80%81%E5%88%A0%E9%99%A4%E6%96%87%E4%BB%B6%E4%B8%AD%E7%9A%84%E6%B6%88%E6%81%AF-toc" style="margin-left:40px;"><a href="#%F0%9F%8D%85%207%E3%80%81%E5%88%A0%E9%99%A4%E6%96%87%E4%BB%B6%E4%B8%AD%E7%9A%84%E6%B6%88%E6%81%AF" rel="nofollow">ğŸ… 7ã€åˆ é™¤æ–‡ä»¶ä¸­çš„æ¶ˆæ¯</a></p> 
<p id="%F0%9F%8D%85%208%E3%80%81%E5%B0%86%E7%A1%AC%E7%9B%98%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E5%88%B0%E5%86%85%E5%AD%98%E4%B8%AD-toc" style="margin-left:40px;"><a href="#%F0%9F%8D%85%208%E3%80%81%E5%B0%86%E7%A1%AC%E7%9B%98%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E5%88%B0%E5%86%85%E5%AD%98%E4%B8%AD" rel="nofollow">ğŸ… 8ã€å°†ç¡¬ç›˜ä¸­çš„æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­</a></p> 
<p id="%F0%9F%8D%85%209%E3%80%81%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E6%96%87%E4%BB%B6%E7%9A%84%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6-toc" style="margin-left:40px;"><a href="#%F0%9F%8D%85%209%E3%80%81%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E6%96%87%E4%BB%B6%E7%9A%84%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6" rel="nofollow">ğŸ… 9ã€å®ç°æ¶ˆæ¯æ–‡ä»¶çš„åƒåœ¾å›æ”¶</a></p> 
<p id="%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%F0%9F%8E%88%20%E6%A3%80%E6%B5%8B%E6%98%AF%E5%90%A6%E8%A6%81%E8%BF%9B%E8%A1%8CGC-toc" style="margin-left:80px;"><a href="#%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%F0%9F%8E%88%20%E6%A3%80%E6%B5%8B%E6%98%AF%E5%90%A6%E8%A6%81%E8%BF%9B%E8%A1%8CGC" rel="nofollow">Â Â Â Â Â Â Â Â ğŸˆ æ£€æµ‹æ˜¯å¦è¦è¿›è¡ŒGC</a></p> 
<p id="%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%F0%9F%8E%88%20%E6%9E%84%E9%80%A0%E6%96%B0%E7%9B%AE%E5%BD%95-toc" style="margin-left:80px;"><a href="#%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%F0%9F%8E%88%20%E6%9E%84%E9%80%A0%E6%96%B0%E7%9B%AE%E5%BD%95" rel="nofollow">Â  Â  Â  Â  ğŸˆ æ„é€ æ–°ç›®å½•</a></p> 
<p id="%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%F0%9F%8E%88%20%E8%BF%9B%E8%A1%8CGC%E6%93%8D%E4%BD%9C-toc" style="margin-left:80px;"><a href="#%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%F0%9F%8E%88%20%E8%BF%9B%E8%A1%8CGC%E6%93%8D%E4%BD%9C" rel="nofollow">Â  Â  Â  Â  ğŸˆ è¿›è¡ŒGCæ“ä½œ</a></p> 
<p id="%E4%BA%94%E3%80%81%E6%B5%8B%E8%AF%95MessageFileManager%E7%B1%BB-toc" style="margin-left:0px;"><a href="#%E4%BA%94%E3%80%81%E6%B5%8B%E8%AF%95MessageFileManager%E7%B1%BB" rel="nofollow">äº”ã€æµ‹è¯•MessageFileManagerç±»</a></p> 
<p id="%F0%9F%8D%85%201%E3%80%81%E2%80%9C%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C%E2%80%9D%E5%92%8C%E2%80%9C%E6%94%B6%E5%B0%BE%E5%B7%A5%E4%BD%9C%E2%80%9D-toc" style="margin-left:40px;"><a href="#%F0%9F%8D%85%201%E3%80%81%E2%80%9C%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C%E2%80%9D%E5%92%8C%E2%80%9C%E6%94%B6%E5%B0%BE%E5%B7%A5%E4%BD%9C%E2%80%9D" rel="nofollow">ğŸ… 1ã€â€œå‡†å¤‡å·¥ä½œâ€å’Œâ€œæ”¶å°¾å·¥ä½œâ€</a></p> 
<p id="%F0%9F%8D%85%202%E3%80%81%E6%B5%8B%E8%AF%95%E5%88%9B%E5%BB%BA%E6%96%87%E4%BB%B6%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8-toc" style="margin-left:40px;"><a href="#%F0%9F%8D%85%202%E3%80%81%E6%B5%8B%E8%AF%95%E5%88%9B%E5%BB%BA%E6%96%87%E4%BB%B6%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8" rel="nofollow">ğŸ… 2ã€æµ‹è¯•åˆ›å»ºæ–‡ä»¶æ˜¯å¦å­˜åœ¨</a></p> 
<p id="%C2%A0%F0%9F%8D%85%203%E3%80%81%E6%B5%8B%E8%AF%95writetStat%E5%92%8CreadStat%E6%98%AF%E5%90%A6%E8%83%BD%E5%A4%9F%E9%80%9A%E8%BF%87-toc" style="margin-left:40px;"><a href="#%C2%A0%F0%9F%8D%85%203%E3%80%81%E6%B5%8B%E8%AF%95writetStat%E5%92%8CreadStat%E6%98%AF%E5%90%A6%E8%83%BD%E5%A4%9F%E9%80%9A%E8%BF%87" rel="nofollow">Â ğŸ… 3ã€æµ‹è¯•writetStatå’ŒreadStatæ˜¯å¦èƒ½å¤Ÿé€šè¿‡</a></p> 
<p id="%C2%A0%F0%9F%8D%85%204%E3%80%81%E6%B5%8B%E8%AF%95sendMessage-toc" style="margin-left:40px;"><a href="#%C2%A0%F0%9F%8D%85%204%E3%80%81%E6%B5%8B%E8%AF%95sendMessage" rel="nofollow">Â ğŸ… 4ã€æµ‹è¯•sendMessage</a></p> 
<p id="%F0%9F%8D%85%205%E3%80%81%E6%B5%8B%E8%AF%95%E5%88%A0%E9%99%A4%E6%B6%88%E6%81%AF-toc" style="margin-left:40px;"><a href="#%F0%9F%8D%85%205%E3%80%81%E6%B5%8B%E8%AF%95%E5%88%A0%E9%99%A4%E6%B6%88%E6%81%AF" rel="nofollow">ğŸ… 5ã€æµ‹è¯•åˆ é™¤æ¶ˆæ¯</a></p> 
<p id="%F0%9F%8D%85%206%E3%80%81%E6%B5%8B%E8%AF%95%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6-toc" style="margin-left:40px;"><a href="#%F0%9F%8D%85%206%E3%80%81%E6%B5%8B%E8%AF%95%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6" rel="nofollow">ğŸ… 6ã€æµ‹è¯•åƒåœ¾å›æ”¶</a></p> 
<p id="%E5%85%AD%E3%80%81%E5%B0%8F%E7%BB%93-toc" style="margin-left:0px;"><a href="#%E5%85%AD%E3%80%81%E5%B0%8F%E7%BB%93" rel="nofollow">å…­ã€å°ç»“</a></p> 
<hr id="hr-toc"> 
<p></p> 
<p></p> 
<p><img alt="" src="https://images2.imgbox.com/7c/32/r4F3FqIq_o.png"></p> 
<p></p> 
<h2 id="%C2%A0%E4%B8%80%E3%80%81%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8%E6%A0%BC%E5%BC%8F%E8%AE%BE%E8%AE%A1">Â ä¸€ã€æ¶ˆæ¯å­˜å‚¨æ ¼å¼è®¾è®¡</h2> 
<blockquote> 
 <p>å¯¹äºæ¶ˆæ¯ï¼Œå¹¶ä¸æ‰“ç®—å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼š</p> 
 <p>Â Â Â Â Â Â Â Â ï¼ˆ1ï¼‰æ¶ˆæ¯æ“ä½œå¹¶ä¸ä¼šæ¶‰åŠåˆ°å¤æ‚çš„å¢åˆ æ”¹æŸ¥</p> 
 <p>Â Â Â Â Â Â Â Â ï¼ˆ2ï¼‰æ¶ˆæ¯çš„æ•°é‡å¯èƒ½ä¼šéå¸¸å¤šï¼Œæ•°æ®åº“çš„è®¿é—®æ•ˆç‡å¹¶ä¸é«˜</p> 
</blockquote> 
<p>Â æ‰€ä»¥ï¼Œæˆ‘ä»¬ç›´æ¥æŠŠæ¶ˆæ¯å­˜å‚¨åœ¨æ–‡ä»¶ä¸­ã€‚</p> 
<p>é‚£ä¹ˆæ¶ˆæ¯è¦å¦‚ä½•åœ¨æ–‡ä»¶ä¸­å­˜å‚¨å‘¢ï¼Ÿ</p> 
<p>é¦–å…ˆæ¶ˆæ¯ï¼Œå®ƒæ˜¯ä¾é™„äºé˜Ÿåˆ—çš„ï¼Œæ‰€ä»¥åœ¨å­˜å‚¨çš„æ—¶å€™ï¼Œå°±æŠŠæ¶ˆæ¯æŒ‰ç…§é˜Ÿåˆ—çš„ç»´åº¦å±•å¼€ã€‚</p> 
<p>æˆ‘ä»¬ä¼šå°†é˜Ÿåˆ—å­˜å‚¨åœ¨å’Œæ•°æ®åº“åŒçº§çš„dataç›®å½•ä¸­ï¼Œåœ¨dataä¸­åˆ›å»ºä¸€äº›å­ç›®å½•ï¼Œå­ç›®å½•çš„åå­—å°±æ˜¯é˜Ÿåˆ—åã€‚<img alt="" height="783" src="https://images2.imgbox.com/23/ec/A53GNZoJ_o.png" width="1200"></p> 
<p></p> 
<p>ç„¶ååœ¨æ¯ä¸ªé˜Ÿåˆ—çš„å­ç›®å½•ä¸‹é¢ï¼Œå†åˆ†é…ä¸¤ä¸ªæ–‡ä»¶ï¼Œç”¨æ¥å­˜å‚¨æ¶ˆæ¯ã€‚ä¸»è¦æ˜¯ä»¥ä¸‹ä¸¤ä¸ªæ–‡ä»¶ã€‚</p> 
<hr> 
<h3 id="%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%F0%9F%8D%85%201%E3%80%81queue_data.txt%EF%BC%9A%E4%BF%9D%E5%AD%98%E6%B6%88%E6%81%AF%E7%9A%84%E5%86%85%E5%AE%B9"><strong>Â  Â  Â </strong> Â ğŸ… 1ã€queue_data.txtï¼šä¿å­˜æ¶ˆæ¯çš„å†…å®¹</h3> 
<p>Â Â Â Â Â Â Â Â Messageæ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶æ ¼å¼çš„æ–‡ä»¶ï¼ŒåŒ…å«è‹¥å¹²ä¸ªæ¶ˆæ¯ï¼Œæ¯ä¸ªæ¶ˆæ¯éƒ½ä»¥äºŒè¿›åˆ¶çš„æ–¹å¼å­˜å‚¨ï¼Œæ¯ä¸ªæ¶ˆæ¯éƒ½ç”±è¿™å‡ ä¸ªéƒ¨åˆ†æ„æˆï¼šMessageå¯¹è±¡åºåˆ—åŒ–ä¹‹åã€‚</p> 
<p>Â  Â Â Â Â Â Â Messagå¯¹è±¡ï¼Œä¼šåˆ†åˆ«å†å†…å­˜å’Œç¡¬ç›˜ä¸Šéƒ½è®°å½•ä¸€ä»½ã€‚å†…å­˜ä¸­çš„è¡£æœå‘¢ä¼šè®°å½•offsetBeginå’ŒoffsetEndã€‚è¿™æ ·å°±å¯ä»¥æ‰¾åˆ°å†…å­˜ä¸­çš„Messageå¯¹è±¡ï¼Œèƒ½å¤Ÿæ‰¾åˆ°å¯¹åº”çš„ç¡¬ç›˜ä¸Šçš„messageå¯¹è±¡ã€‚</p> 
<p><img alt="" height="720" src="https://images2.imgbox.com/ba/ba/qShQCYKP_o.png" width="1200"></p> 
<p>Â Â Â Â Â Â Â Â å…³äºi<strong>sValidï¼š</strong>æ˜¯ç”¨æ¥æ ‡è¯†å½“å‰æ¶ˆæ¯åœ¨æ–‡ä»¶ä¸­æ˜¯å¦æœ‰æ•ˆï¼Œä¸º1å°±æ˜¯æœ‰æ•ˆçš„æ¶ˆæ¯ï¼Œä¸º0å°±æ˜¯æ— æ•ˆçš„æ¶ˆæ¯ã€‚å½“ä¸º0æ—¶å°±ç›¸å½“äºé€»è¾‘ä¸Šçš„åˆ é™¤æ¶ˆæ¯åŠŸèƒ½ã€‚ä½†æ˜¯ï¼Œéšç€æ—¶é—´çš„æ¨ç§»ï¼Œæ¶ˆæ¯çš„å¢å¤šï¼Œé‚£ä¹ˆè¯¥æ¶ˆæ¯å¯èƒ½å°±ä¼šå¤§éƒ¨åˆ†éƒ½æ˜¯æ— æ•ˆçš„æ¶ˆæ¯ï¼Œé’ˆå¯¹è¿™ç§æƒ…å†µï¼Œå°±éœ€è¦å¯¹å½“å‰æ¶ˆæ¯çš„æ–‡ä»¶ï¼Œè¿›è¡Œ<strong>åƒåœ¾å›æ”¶ã€‚</strong></p> 
<blockquote> 
 <p>ä»¥ä¸‹æ˜¯æœ¬ç¨‹åºä¸­å®ç°çš„åƒåœ¾å›æ”¶åŠŸèƒ½ï¼šÂ  Â </p> 
 <p><strong>Â  åƒåœ¾å›æ”¶ï¼ˆGCï¼‰ï¼š</strong>ä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼Œé’ˆå¯¹æ¶ˆæ¯æ•°æ®æ–‡ä»¶ä¸­çš„åƒåœ¾å›æ”¶è¿›è¡Œå›æ”¶ã€‚ç›´æ¥éå†åŸæœ‰çš„æ¶ˆæ¯æ•°æ®æ–‡ä»¶ï¼ŒæŠŠæœ‰æ•ˆçš„æ•°æ®æ‹·è´åˆ°ä¸€ä¸ªæ–°çš„æ–‡ä»¶ä¸­ï¼Œç„¶åæŠŠä¹‹å‰çš„æ—§æ–‡ä»¶éƒ½åˆ é™¤æ‰ï¼ˆé€»è¾‘åˆ é™¤ï¼‰ã€‚</p> 
 <p>ä½œå‡ºçº¦å®šï¼ˆå¯ä»¥ä¸æŒ‰è¿™ä¸ªæ¥ï¼‰ï¼Œå½“æ€»æ¶ˆæ¯æ•°ç›®è¶…è¿‡äº†2000ï¼Œå¹¶ä¸”æœ‰æ•ˆçš„æ¶ˆæ¯æ•°ç›®ä½äºæ€»æ•°ç›®çš„50%ï¼Œå°±å‡ºå‘ä¸€æ¬¡åƒåœ¾å›æ”¶ã€‚</p> 
</blockquote> 
<blockquote> 
 <p>Â å¯¹äºRabbitMQè§£å†³åƒåœ¾å›æ”¶çš„æ–¹å¼å¦‚ä¸‹ï¼š</p> 
 <p>Â å¦‚æœæŸä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œæ¶ˆæ¯å¾ˆå¤šï¼Œéƒ½æ˜¯æœ‰æ•ˆæ¶ˆæ¯ï¼Œå°±ä¼šå¯¼è‡´æ•´ä¸ªæ¶ˆæ¯çš„æ•°æ®æ–‡ä»¶ç‰¹åˆ«ç­”ï¼Œåç»­é’ˆå¯¹æ–‡ä»¶çš„å„ç§æ“ä½œï¼Œæˆæœ¬å°±ä¼šå¾ˆé«˜ã€‚RabbitMQè§£å†³æ–¹æ¡ˆå¦‚ä¸‹ï¼š</p> 
 <p>Â  Â  æ–‡ä»¶æ‹†åˆ†ï¼šå½“å•ä¸ªæ–‡ä»¶é•¿åº¦è¾¾åˆ°ä¸€å®šé˜ˆå€¼ä»¥åï¼Œå°±ä¼šæ‹†åˆ†æˆä¸¤ä¸ªæ–‡ä»¶ï¼ˆæ‹†åˆ†æ¬¡æ•°è¶Šå¤šæ–‡ä»¶å°±è¶Šå¤šï¼‰</p> 
 <p>Â  Â  æ–‡ä»¶åˆå¹¶ï¼šæ¯ä¸ªå•ç‹¬çš„æ–‡ä»¶éƒ½ä¼šè¿›è¡ŒGCï¼Œå¦‚æœGCä¹‹åï¼Œå°±ä¼šå‘ç°æ–‡ä»¶å˜å°å¾ˆå¤šï¼Œå½“å°åˆ°ä¸€å®šç¨‹åº¦ï¼Œå°±ä¼šå’Œå…¶ä»–æ–‡ä»¶åˆå¹¶ã€‚</p> 
 <p>è¿™æ ·å°±ä¼šå†æ¶ˆæ¯ç‰¹åˆ«å¤šçš„æ—¶å€™ï¼Œä¹Ÿèƒ½ä¿è¯æ€§èƒ½ä¸Šçš„åŠæ—¶å“åº”ã€‚</p> 
</blockquote> 
<hr> 
<h3 id="%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%F0%9F%8D%85%202%E3%80%81queue_stat.txt%EF%BC%9A%E4%BF%9D%E5%AD%98%E6%B6%88%E6%81%AF%E7%9A%84%E7%BB%9F%E8%AE%A1%E4%BF%A1%E6%81%AF">Â  Â  Â  Â  ğŸ… 2ã€queue_stat.txtï¼šä¿å­˜æ¶ˆæ¯çš„ç»Ÿè®¡ä¿¡æ¯</h3> 
<p>Â Â Â Â Â Â Â Â ä½¿ç”¨è¿™ä¸ªæ–‡ä»¶ï¼Œæ¥ä¿å­˜æ¶ˆæ¯çš„ç»Ÿè®¡ä¿¡æ¯ã€‚</p> 
<p>Â Â Â Â Â Â Â Â åªå­˜ä¸€è¡Œæ•°æ®ï¼Œæ–‡æœ¬æ ¼å¼ã€‚ç„¶åä¸€è¡ŒåŒ…æ‹¬ä¸¤åˆ—ï¼šä¸¤è€…ä½¿ç”¨ \t æ¥åˆ†å‰²ï¼Œå½¢å¦‚2000\t500</p> 
<p>Â  Â  Â  Â  Â Â Â Â Â Â Â Â ç¬¬ä¸€åˆ—æ˜¯queue_data.txtä¸­æ€»çš„æ¶ˆæ¯çš„æ•°ç›®</p> 
<p>Â  Â  Â  Â Â Â Â Â Â Â Â Â  ç¬¬äºŒåˆ—æ˜¯queue_data.txtä¸­æœ‰æ•ˆæ¶ˆæ¯çš„æ•°ç›®ã€‚</p> 
<p></p> 
<hr> 
<h2 id="%E4%BA%8C%E3%80%81%E6%B6%88%E6%81%AF%E5%BA%8F%E5%88%97%E5%8C%96">äºŒã€æ¶ˆæ¯åºåˆ—åŒ–</h2> 
<p>æ¶ˆæ¯åºåˆ—åŒ–ï¼šæŠŠä¸€ä¸ªå¯¹è±¡ï¼ˆç»“æ„åŒ–æ•°æ®ï¼‰è½¬æˆä¸€ä¸ªå­—ç¬¦ä¸²/å­—èŠ‚æ•°ç»„ã€‚</p> 
<p>åœ¨åºåˆ—åŒ–ä¹‹åï¼Œå¯¹è±¡çš„ä¿¡æ¯æ˜¯ä¸ä¼šä¸¢å¤±çš„ï¼Œè¿™æ ·å°±ä¼šæ–¹ä¾¿ä¸å­˜å‚¨å’Œä¼ è¾“ï¼ˆåœ¨æ–‡ä»¶ä¸­å­˜å‚¨æ—¶ï¼Œåªèƒ½ä»¥å­—ç¬¦ä¸²/äºŒè¿›åˆ¶æ•°æ®çš„æ–¹å¼å­˜å‚¨å¯¹è±¡ï¼‰ã€‚åé¢éœ€è¦ç”¨çš„æ—¶å€™ï¼Œå°±å†ååºåˆ—åŒ–ã€‚</p> 
<p>ç”±äºæ¶ˆæ¯çš„bodyæ˜¯äºŒè¿›åˆ¶æ•°æ®ï¼Œæ‰€ä»¥è¿™é‡Œä¸ä¼šä½¿ç”¨JSONè¿›è¡Œåºåˆ—åŒ–ã€‚</p> 
<blockquote> 
 <p>é’ˆå¯¹äºŒè¿›åˆ¶åºåˆ—åŒ–ï¼Œæœ‰å¾ˆå¤šè§£å†³æ–¹æ¡ˆï¼šÂ Â Â Â Â Â Â Â </p> 
 <p>Â  Â  Â  Â  ï¼ˆ1ï¼‰Javaæ ‡å‡†åº“ä¸­æä¾›äº†åºåˆ—åŒ–çš„æ–¹æ¡ˆï¼šObjectInputStream å’ŒÂ ObjectOutputStream</p> 
 <p>Â  Â  Â  Â  ï¼ˆ2ï¼‰Hession</p> 
 <p>Â  Â  Â  Â  ï¼ˆ3ï¼‰protobuffer</p> 
 <p>Â  Â  Â  Â  ï¼ˆ4ï¼‰thrift</p> 
</blockquote> 
<p>è¿™é‡Œä½¿ç”¨ç¬¬ä¸€ç§ï¼Œè¿™æ ·å°±ä¸ç”¨å†å¼•å…¥é¢å¤–çš„ä¾èµ–ã€‚</p> 
<p>åœ¨commenä¸­åˆ›å»ºä¸€ä¸ªBinaryToolï¼Œå› ä¸ºåé¢å®¢æˆ·ç«¯è¿˜ä¼šç”¨åˆ°è¿™ä¸ªç±»ï¼Œæ‰€ä»¥æ”¾åœ¨å…¬å…±çš„åŒ…ä¸­ã€‚</p> 
<p><img alt="" height="710" src="https://images2.imgbox.com/35/bd/B0im6e3J_o.png" width="1200"></p> 
<pre><code class="language-java">
/*
* åºåˆ—åŒ–å’Œååºåˆ—åŒ–
* å®ç°Serializableæ¥å£æ‰èƒ½è®©è¿™ä¸ªå¯¹è±¡è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–
* */
public class BinaryTool {
    //    æŠŠä¸€ä¸ªå¯¹è±¡åºåˆ—åŒ–æˆä¸€ä¸ªå­—èŠ‚æ•°ç»„
    public static byte[] toBytes(Object object) throws IOException {
//        è¿™ä¸ªæµå¯¹è±¡ç›¸å½“äºä¸€ä¸ªè¾¹é•¿çš„å­—èŠ‚æ•°ç»„
//        å°±å¯ä»¥æŠŠobjectåºåˆ—åŒ–çš„æ•°ç»„é€æ¸å†™å…¥åˆ°byteArrayOutputStreamä¸­ï¼Œç„¶åç»Ÿä¸€è½¬æˆbyte[]
        try (ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream()) {
            try (ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteArrayOutputStream)) {
//                æ­¤å¤„çš„writeObjectå°±ä¼šæŠŠè¯¥å¯¹è±¡è¿›è¡Œåºåˆ—åŒ–ï¼Œç”ŸæˆäºŒè¿›åˆ¶å­—èŠ‚æ•°æ®ï¼Œå°±ä¼šå†™å…¥åˆ°ObjectOutputStreamä¸­
//                ç”±äºObjectOutputStreamåˆå…³è”åˆ°äº†ByteArrayOutputStreamï¼Œæœ€ç»ˆç»“æœå°±å†™å…¥åˆ°ByteArrayOutputStreamé‡Œé¢äº†
                objectOutputStream.writeObject(object);
            }
//            è¯¥æ“ä½œå°±æ˜¯æŠŠbyteArrayOutputStreamä¸­æŒæœ‰çš„äºŒè¿›åˆ¶æ•°æ®å–å‡ºæ¥ï¼Œè½¬æˆbyte[]
            return byteArrayOutputStream.toByteArray();
        }
    }

    //  æŠŠä¸€ä¸ªå­—èŠ‚æ•°ç»„ï¼Œååºåˆ—åŒ–æˆä¸€ä¸ªå¯¹è±¡
    public static Object fromBytes(byte[] data) throws IOException, ClassNotFoundException {
        Object object = null;
        try (ByteArrayInputStream byteArrayInputStream = new ByteArrayInputStream(data)) {
            try (ObjectInputStream objectInputStream = new ObjectInputStream(byteArrayInputStream)) {
//                æ­¤å¤„çš„readObject,å°±æ˜¯ä»dataçš„byte[]ä¸­è¯»å–æ•°æ®å¹¶ä¸”è¿›è¡Œååºåˆ—åŒ–
                object = objectInputStream.readObject();
            }
        }
        return object;
    }
}</code></pre> 
<p></p> 
<hr> 
<h2 id="%E4%B8%89%E3%80%81%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E5%B8%B8%E7%B1%BB">ä¸‰ã€è‡ªå®šä¹‰å¼‚å¸¸ç±»</h2> 
<p>Â <img alt="" height="227" src="https://images2.imgbox.com/f8/93/hxENJEkZ_o.png" width="574"></p> 
<p>è‡ªå®šä¹‰ä¸€ä¸ªå¼‚å¸¸ç±»ï¼Œå¦‚æœæ˜¯mqçš„ä¸šåŠ¡é€»è¾‘ä¸­å‡ºçš„å¼‚å¸¸ï¼Œå°±æŠ›å‡ºè¿™ä¸ªå¼‚å¸¸ç±»</p> 
<pre><code class="language-java">/*
*è‡ªå®šä¹‰å¼‚å¸¸ç±»
*/
public class MqException extends Exception{
    public MqException(String reason){
        super(reason);
    }
}</code></pre> 
<p></p> 
<hr> 
<p></p> 
<h2 id="%E5%9B%9B%E3%80%81%E5%88%9B%E5%BB%BAMessageFileManger%E7%B1%BB">å››ã€åˆ›å»ºMessageFileMangerç±»</h2> 
<p><img alt="" height="570" src="https://images2.imgbox.com/20/0a/LGb1Phxd_o.png" width="1200"></p> 
<p>Â å¯¹ç¡¬ç›˜ä¸Šçš„æ¶ˆæ¯è¿›è¡Œç®¡ç†çš„ç±»ã€‚</p> 
<hr> 
<h3 id="%F0%9F%8D%85%201%E3%80%81%E7%BA%A6%E5%AE%9A%E6%B6%88%E6%81%AF%E6%96%87%E4%BB%B6%E6%89%80%E5%9C%A8%E7%9A%84%E7%9B%AE%E5%BD%95%E5%92%8C%E6%96%87%E4%BB%B6%E5%90%8D%E5%AD%97">ğŸ… 1ã€çº¦å®šæ¶ˆæ¯æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•å’Œæ–‡ä»¶åå­—</h3> 
<pre><code class="language-java">//è¿™é‡Œçš„init()æ–¹æ³•æš‚æ—¶ä¸ç”¨ï¼Œåªæ˜¯åˆ—åœ¨è¿™ï¼Œåé¢å¯èƒ½æ‰©å±• 
public void init(){
//        åç»­æ‰©å±•
    }

//    çº¦å®šçš„é‚£ä¸ªæ¶ˆæ¯æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•å’Œæ–‡ä»¶å

//    ç”¨æ¥è·å–åˆ°æŒ‡å®šé˜Ÿåˆ—å¯¹åº”çš„æ¶ˆæ¯æ–‡ä»¶æ‰€åœ¨çš„è·¯å¾„
    private  String getQueueDir(String queueName){
        return "./data/" + queueName;
    }

//    ç”¨æ¥è·å–è¯¥é˜Ÿåˆ—çš„æ¶ˆæ¯æ•°æ®æ–‡ä»¶è·¯å¾„
    private String getQueueDataPath(String queueName){
        return getQueueDir(queueName) + "/queue_data.txt";
    }

//    ç”¨æ¥è·å–è¯¥é˜Ÿåˆ—åˆ—çš„æ¶ˆæ¯ç»Ÿè®¡æ–‡ä»¶è·¯å¾„
    private String getQueueStatPath(String queueName){
        return getQueueDir(queueName) + "/queue_stat.txt";
    }</code></pre> 
<hr> 
<h3 id="%C2%A0%F0%9F%8D%85%202%E3%80%81%E9%98%9F%E5%88%97%E7%9A%84%E7%BB%9F%E8%AE%A1%E4%BF%A1%E6%81%AF">Â ğŸ… 2ã€é˜Ÿåˆ—çš„ç»Ÿè®¡ä¿¡æ¯</h3> 
<p>å®šä¹‰ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œæ¥è¡¨ç¤ºè¯¥é˜Ÿåˆ—çš„ç»Ÿè®¡ä¿¡æ¯ï¼š</p> 
<pre><code class="language-java">//    å®šä¹‰ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œæ¥è¡¨ç¤ºè¯¥é˜Ÿåˆ—çš„ç»Ÿè®¡ä¿¡æ¯
    static public class Stat{
//        ç›´æ¥å®šä¹‰æˆpublic
        public int totalCount; //æ€»æ¶ˆæ¯æ•°é‡
        public int validCount;//æœ‰æ•ˆæ¶ˆæ¯çš„æ•°é‡
    }</code></pre> 
<p>ç„¶åå®ç°æ¶ˆæ¯ç»Ÿè®¡çš„è¯»å†™åŠŸèƒ½ï¼š</p> 
<pre><code class="language-java">private Stat readStat(String queueName){
//        ç”±äºå½“å‰çš„æ¶ˆæ¯ç»Ÿè®¡æ–‡ä»¶æ˜¯æ–‡æœ¬æ–‡ä»¶ï¼Œç›´æ¥ä½¿ç”¨scannerè¯»å–æ–‡ä»¶å†…å®¹
        Stat stat = new Stat();
        try (InputStream inputStream = new FileInputStream(getQueueStatPath(queueName))) {
            Scanner scanner = new Scanner(inputStream);
            stat.totalCount = scanner.nextInt();
            stat.validCount = scanner.nextInt();
            return stat;
        } catch (IOException e) {
            e.printStackTrace();
        }
        return null;
    }

    private void writeStat(String queueName,Stat stat){
//      ä½¿ç”¨PrinWriteæ¥å†™
//        OutputStreamæ‰“å¼€æ–‡ä»¶ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œä¼šç›´æ¥æŠŠæºæ–‡ä»¶æ¸…ç©ºï¼Œæ–°æ•°æ®ä¼šè¦†ç›–åŸæ•°æ®
//        è¿™é‡Œç›´æ¥è¦†ç›–å°±å¯ä»¥äº†
        try (OutputStream outputStream = new FileOutputStream(getQueueStatPath(queueName))) {
            PrintWriter printWriter = new PrintWriter(outputStream);
            printWriter.write(stat.totalCount + "\t" + stat.validCount);
            printWriter.flush();
        } catch (IOException e) {
            e.printStackTrace();
        }
    }</code></pre> 
<hr> 
<h3 id="%F0%9F%8D%85%203%E3%80%81%E5%88%9B%E5%BB%BA%E9%98%9F%E5%88%97%E5%AF%B9%E5%BA%94%E7%9A%84%E7%9B%AE%E5%BD%95%E5%92%8C%E5%8A%9F%E8%83%BD">ğŸ… 3ã€åˆ›å»ºé˜Ÿåˆ—å¯¹åº”çš„ç›®å½•å’ŒåŠŸèƒ½</h3> 
<pre><code class="language-java">//    åˆ›å»ºé˜Ÿåˆ—å¯¹åº”çš„æ–‡ä»¶å’Œç›®å½•
    public void createQueueFiles(String queueName) throws IOException {
//        1.åˆ›å»ºé˜Ÿåˆ—å¯¹åº”çš„æ¶ˆæ¯ç›®å½•
        File baseDir = new File(getQueueDir(queueName));
        if (!baseDir.exists()){
//            ä¸å­˜åœ¨ï¼Œå°±åˆ›å»ºè¿™ä¸ªç›®å½•
            boolean ok = baseDir.mkdirs();
            if (!ok){
                throw  new IOException("åˆ›å»ºç›®å½•å¤±è´¥ï¼baseDir = " + baseDir.getAbsolutePath());
            }
        }

//        2.åˆ›å»ºé˜Ÿåˆ—æ•°æ®æ–‡ä»¶
        File queueDataFile = new File(getQueueDataPath(queueName));
        if (!queueDataFile.exists()){
            boolean ok = queueDataFile.createNewFile();
            if (!ok){
                throw new IOException("åˆ›å»ºæ–‡ä»¶å¤±è´¥ï¼queueDataFile = " + queueDataFile.getAbsolutePath());
            }
        }
//       3.åˆ›å»ºæ¶ˆæ¯ç»Ÿè®¡æ–‡ä»¶
        File queueStatFile = new File(getQueueStatPath(queueName));
        if (!queueStatFile.exists()){
            boolean ok = queueStatFile.createNewFile();
            if (!ok){
                throw new IOException("åˆ›å»ºæ–‡ä»¶å¤±è´¥ï¼queueStatFile = " + queueStatFile.getAbsolutePath());
            }
        }

//        4.ç»™æ¶ˆæ¯ç»Ÿè®¡æ–‡ä»¶ï¼Œè®¾å®šåˆå§‹å€¼ 0\t0
        Stat stat = new Stat();
        stat.totalCount = 0;
        stat.validCount = 0;
        writeStat(queueName,stat);
    }</code></pre> 
<hr> 
<h3 id="%F0%9F%8D%85%204%E3%80%81%E5%AE%9E%E7%8E%B0%E5%88%A0%E9%99%A4%E9%98%9F%E5%88%97%E7%9A%84%E6%96%87%E4%BB%B6%E5%92%8C%E7%9B%AE%E5%BD%95">ğŸ… 4ã€å®ç°åˆ é™¤é˜Ÿåˆ—çš„æ–‡ä»¶å’Œç›®å½•</h3> 
<pre><code class="language-java">//    å®ç°åˆ é™¤é˜Ÿåˆ—çš„æ–‡ä»¶å’Œç›®å½•
    public void destroyQueueFiles(String queueName) throws IOException {
//        å…ˆåˆ é™¤æ–‡ä»¶ï¼Œåœ¨åˆ é™¤ç›®å½•
        File queueDataFile = new File(getQueueDataPath(queueName));
        boolean ok1 = queueDataFile.delete();
        File queueStatFile = new File(getQueueStatPath(queueName));
        boolean ok2 = queueStatFile.delete();
        File baseDir = new File(getQueueDir(queueName));
        boolean ok3 = baseDir.delete();
        if (!ok1 || !ok2 || !ok3){
//            æœ‰ä»»æ„ä¸€ä¸ªåˆ é™¤å¤±è´¥ï¼Œå°±ç®—æ•´ä½“åˆ é™¤å¤±è´¥
            throw new IOException("åˆ é™¤é˜Ÿåˆ—ç›®å½•å’Œæ–‡ä»¶å¤±è´¥ï¼baseDir = " + baseDir.getAbsolutePath());
        }
    }
</code></pre> 
<hr> 
<h3 id="%F0%9F%8D%85%205%E3%80%81%E6%A3%80%E6%9F%A5%E9%98%9F%E5%88%97%E7%9A%84%E7%9B%AE%E5%BD%95%E5%92%8C%E6%96%87%E4%BB%B6%E6%98%AF%E5%90%A6%E9%83%BD%E5%AD%98%E5%9C%A8">ğŸ… 5ã€æ£€æŸ¥é˜Ÿåˆ—çš„ç›®å½•å’Œæ–‡ä»¶æ˜¯å¦éƒ½å­˜åœ¨</h3> 
<p>åç»­æœ‰ç”Ÿäº§è€…ç»™brocker serverç”Ÿäº§æ¶ˆæ¯äº†ï¼Œè¿™ä¸ªæ¶ˆæ¯å°±å¯èƒ½éœ€è¦è®°å½•åˆ°æ–‡ä»¶ä¸Šï¼ˆå–å†³æ¶ˆæ¯æ˜¯å¦è¦æŒä¹…åŒ–ï¼‰ã€‚ä½†æ˜¯åˆ¤æ–­æ˜¯å¦è¦æŒä¹…åŒ–ä¹‹å‰ï¼Œéœ€è¦æ£€æŸ¥é˜Ÿåˆ—ä¸­çš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€‚</p> 
<pre><code class="language-java">//    æ£€æŸ¥é˜Ÿåˆ—çš„ç›®å½•å’Œæ–‡ä»¶æ˜¯å¦å­˜åœ¨
    public boolean checkFileExists(String queueName){
//        åˆ¤æ–­é˜Ÿåˆ—çš„æ•°æ®æ–‡ä»¶å’Œç»Ÿè®¡æ–‡ä»¶æ˜¯å¦éƒ½å­˜åœ¨
        File queueDataFile = new File(getQueueDataPath(queueName));
        if (!queueDataFile.exists()){
            return false;
        }
        File queueStatFile = new File(getQueueStatPath(queueName));
        if (!queueStatFile.exists()){
            return false;
        }
        return true;
    }</code></pre> 
<hr> 
<h3 id="%F0%9F%8D%85%206%E3%80%81%E6%8A%8A%E6%B6%88%E6%81%AF%E5%86%99%E5%85%A5%E5%88%B0%E6%96%87%E4%BB%B6%E4%B8%AD">ğŸ… 6ã€æŠŠæ¶ˆæ¯å†™å…¥åˆ°æ–‡ä»¶ä¸­</h3> 
<blockquote> 
 <p>æŠŠä¸€ä¸ªæ–°çš„æ¶ˆæ¯ï¼Œæ”¾åˆ°é˜Ÿåˆ—å¯¹åº”çš„æ–‡ä»¶ä¸­ã€‚ä¸»è¦åŒ…å«ä»¥ä¸‹ä¸‰æ­¥ï¼š</p> 
 <p>ï¼ˆ1ï¼‰æ£€æŸ¥å†™å…¥çš„é˜Ÿåˆ—æ˜¯å¦å­˜åœ¨ï¼›</p> 
 <p>ï¼ˆ2ï¼‰æŠŠMessageå¯¹è±¡è¿›è¡Œåºåˆ—åŒ–ï¼Œè½¬æˆäºŒè¿›åˆ¶çš„å­—èŠ‚æ•°ç»„ï¼›</p> 
 <p>ï¼ˆ3ï¼‰è·å–åˆ°å½“å‰æ•°æ®çš„æ–‡ä»¶é•¿åº¦ï¼Œä½¿ç”¨[offsetBegin,offsetEnd]ã€‚æŠŠæ–°çš„Messageæ•°æ®ï¼Œå†™å…¥åˆ°é˜Ÿåˆ—æ•°æ®æ–‡ä»¶çš„æœ«å°¾ï¼Œæ­¤æ—¶ï¼Œ</p> 
 <p>Â  <strong>Â Messageå¯¹è±¡çš„offsetBeginï¼Œå°±æ˜¯å½“å‰æ–‡ä»¶é•¿åº¦ +4</strong></p> 
 <p><strong>Â Â Â offsetEndå°±æ˜¯å½“å‰æ–‡ä»¶é•¿åº¦ + 4 + messageè‡ªèº«é•¿åº¦</strong></p> 
 <p><img alt="" height="418" src="https://images2.imgbox.com/8e/72/S4BXUbvw_o.png" width="1200"></p> 
 <p>ï¼ˆ4ï¼‰å†™å…¥æ¶ˆæ¯åˆ°æ•°æ®æ–‡ä»¶ï¼Œè¿½åŠ åˆ°æ•°æ®æ–‡ä»¶æœ«å°¾</p> 
 <p>ï¼ˆ5ï¼‰æ›´æ–°æ¶ˆæ¯ç»Ÿè®¡æ–‡ä»¶</p> 
</blockquote> 
<blockquote> 
 <p>å†™å…¥æ–‡ä»¶æ—¶çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼š</p> 
 <p>* å¦‚æœä¸¤ä¸ªçº¿ç¨‹ï¼Œæ˜¯å¾€åŒä¸€ä¸ªé˜Ÿåˆ—ä¸­å†™æ¶ˆæ¯ï¼Œæ­¤æ—¶å°±éœ€è¦é˜»å¡ç­‰å¾…ï¼›</p> 
 <p>å‡è®¾ç°åœ¨æœ‰ä¸¤ä¸ªçº¿ç¨‹t1,t2ã€‚å¦‚æœæ²¡æœ‰åŠ é”ï¼Œé‚£ä¹ˆä»–ä»¬çš„ç›®çš„å°±æ˜¯å°†ä¸€ä¸ªmessageå†™å…¥åˆ°104~124ä¹‹é—´å»ã€‚ä½†æ˜¯ï¼Œæ­¤æ—¶å¯èƒ½å°±ä¼šå¯¼è‡´t1è®¡ç®—é•¿åº¦ä»¥åï¼Œæ²¡æœ‰è¿›è¡Œå†™æ–‡ä»¶ï¼›t2å°±å¼€å§‹è®¡ç®—é•¿åº¦äº†ï¼Œå¹¶ä¸”æ‰§è¡Œäº†å†™æ–‡ä»¶æ“ä½œï¼Œå†™å®Œä»¥åï¼Œt1æ‰å¼€å§‹å†™ï¼Œä½†æ˜¯æ­¤æ—¶t1å°±ä¸æ˜¯ä»104å†™äº†ï¼Œè€Œæ˜¯ä»124å¼€å§‹å†™ã€‚è¿™æ ·ä¼šå¯¼è‡´queue_dataå¤šå‡ºä¸€æ®µã€‚</p> 
 <p>Â <img alt="" height="891" src="https://images2.imgbox.com/7c/89/lOfggQTN_o.png" width="1198"></p> 
 <p>Â æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å°±éœ€è¦å¯¹é˜Ÿåˆ—è¿›è¡ŒåŠ é”ã€‚</p> 
 <p>* å¦‚æœä¸¤ä¸ªçº¿ç¨‹ï¼Œéœ€è¦å¾€ä¸åŒçš„é˜Ÿåˆ—ä¸­äº›æ¶ˆæ¯ï¼Œæ­¤æ—¶å°±ä¸éœ€è¦é˜»å¡ç­‰å¾…ã€‚</p> 
</blockquote> 
<p>æ€»ä½“ä»£ç å¦‚ä¸‹ï¼š</p> 
<pre><code class="language-java">//    è¯¥æ–¹æ³•ç”¨äºæŠŠä¸€ä¸ªæ–°çš„æ¶ˆæ¯,æ”¾åˆ°é˜Ÿåˆ—å¯¹åº”çš„æ–‡ä»¶ä¸­
//    queueè¡¨ç¤ºè¦æŠŠæ¶ˆæ¯å†™å…¥çš„é˜Ÿåˆ—ï¼Œmessageåˆ™æ˜¯è¦å†™çš„æ¶ˆæ¯
    public void sendMessage(MSGQueue queue, Message message) throws MqException, IOException {
//        1ã€æ£€æŸ¥è¦å†™å…¥çš„é˜Ÿåˆ—æ˜¯å¦å­˜åœ¨
//        å¦‚æœä¸å­˜åœ¨
        if (!checkFileExists(queue.getName())){
            throw new MqException("[MessageFileManager] é˜Ÿåˆ—å¯¹åº”çš„æ–‡ä»¶ä¸å­˜åœ¨ï¼queueName = " + queue.getName());
        }

//        2ã€æŠŠMessageå¯¹è±¡è¿›è¡Œåºåˆ—åŒ–ï¼Œè½¬æˆäºŒè¿›åˆ¶çš„å­—èŠ‚æ•°ç»„
        byte[] messageBinary = BinaryTool.toBytes(message);

//        è¿™ä¸ªé”æ˜¯,å½“æœ‰ä¸¤ä¸ªå¯¹è±¡é’ˆå¯¹åŒä¸€ä¸ªå¯¹è±¡æ“ä½œæ—¶,é”æ‰ä¼šæœ‰æ•ˆ
        synchronized (queue){
//        3ã€å…ˆè·å–åˆ°å½“å‰çš„é˜Ÿåˆ—æ•°æ®æ–‡ä»¶é•¿åº¦ï¼Œä½¿ç”¨[offsetBegin,offsetEnd]
//        æŠŠæ–°çš„Messageæ•°æ®ï¼Œå†™å…¥åˆ°é˜Ÿåˆ—æ•°æ®æ–‡ä»¶çš„æœ«å°¾ï¼Œæ­¤æ—¶Messageå¯¹è±¡çš„offsetBegin,å°±æ˜¯å½“å‰æ–‡ä»¶é•¿åº¦+4
//        offsetEndå°±æ˜¯å½“å‰æ–‡ä»¶é•¿åº¦ + 4 + messageè‡ªèº«é•¿åº¦
            File queueDataFile = new File(getQueueDataPath(queue.getName()));
//        è·å–åˆ°æ–‡ä»¶çš„é•¿åº¦ï¼šqueueDataFile.length();å•ä½å­—èŠ‚
            message.setOffsetBegin(queueDataFile.length() + 4);
            message.setOffsetEnd(queueDataFile.length() + 4 + messageBinary.length);

//        4.å†™å…¥æ¶ˆæ¯åˆ°æ•°æ®æ–‡ä»¶,è¿½åŠ åˆ°æ•°æ®æ–‡ä»¶æœ«å°¾
            try(OutputStream outputStream = new FileOutputStream(queueDataFile,true)){
                try(DataOutputStream dataOutputStream = new DataOutputStream(outputStream)){
//                å…ˆå†™å½“å‰æ¶ˆæ¯çš„é•¿åº¦ï¼Œå æ®4ä¸ªå­—èŠ‚
//                writeInt()æ–¹æ³•ç”¨äºå°†ç»™å®šçš„æ•´æ•°å€¼ä½œä¸º4ä¸ªå­—èŠ‚(å³32ä½)å†™å…¥åŸºæœ¬DataOutputStreamï¼Œå¹¶ä¸”æˆåŠŸæ‰§è¡Œæ—¶å˜é‡è®¡æ•°å™¨åŠ 4ã€‚
                    dataOutputStream.writeInt(messageBinary.length);
//                å†™å…¥æ¶ˆæ¯æœ¬ä½“
                    dataOutputStream.write(messageBinary);
                }
            }

//        5.æ›´æ–°æ¶ˆæ¯ç»Ÿè®¡æ–‡ä»¶
            Stat stat = readStat(queue.getName());
            stat.totalCount += 1;
            stat.validCount += 1;
            writeStat(queue.getName(),stat);
        }
    }</code></pre> 
<hr> 
<h3 id="%F0%9F%8D%85%207%E3%80%81%E5%88%A0%E9%99%A4%E6%96%87%E4%BB%B6%E4%B8%AD%E7%9A%84%E6%B6%88%E6%81%AF">ğŸ… 7ã€åˆ é™¤æ–‡ä»¶ä¸­çš„æ¶ˆæ¯</h3> 
<blockquote> 
 <p>è¿™é‡Œå°±æ˜¯é€»è¾‘åˆ é™¤ï¼šå°†isValidè®¾ç½®ä¸º0.</p> 
 <p>ä¸»è¦åˆ†ä¸º3æ­¥ï¼š</p> 
 <p>Â  Â  Â  Â  ï¼ˆ1ï¼‰æŠŠæ–‡ä»¶ä¸­éœ€è¦åˆ é™¤çš„ä¸€æ®µæ•°æ®è¯»å‡ºæ¥ï¼Œ</p> 
 <p>Â  Â  Â  Â  ï¼ˆ2ï¼‰è¿˜åŸå›Messageå¯¹è±¡ï¼ˆååºåˆ—åŒ–ï¼‰ï¼›</p> 
 <p>Â  Â  Â  Â  ï¼ˆ3ï¼‰æŠŠisValidæ”¹ä¸º0ï¼›</p> 
 <p>Â  Â  Â  Â  ï¼ˆ4ï¼‰å°†ä¸Šé¢çš„æ•°æ®åˆå†™å›åˆ°æ–‡ä»¶ã€‚</p> 
 <p>Â  Â  Â  Â  ï¼ˆ5ï¼‰æ›´æ–°ç»Ÿè®¡æ–‡ä»¶</p> 
 <p>è¿™é‡Œçš„messageå¯¹è±¡ï¼Œå¿…é¡»è¦åŒ…å«offsetBeginå’ŒoffsetEndã€‚å› ä¸ºè¿™é‡Œæ˜¯å¯¹æ–‡ä»¶ä¸­æŒ‡å®šçš„ä½ç½®è¿›è¡Œè¯»å†™çš„ï¼ˆæŠŠè¿™ä¸ªéšæœºè®¿é—®ï¼‰ã€‚éšæœºè®¿é—®ç”¨åˆ°çš„ç±»RandomAcessFileã€‚</p> 
 <p>å…³äºRandomAcessFile.seek()æ˜¯ç”¨äºè®¾ç½®æ–‡ä»¶æŒ‡é’ˆï¼ˆç›¸å½“äºå…‰æ ‡ï¼‰ä½ç½®ï¼Œè®¾ç½®åï¼Œå…‰æ ‡ä¼šä»å½“å‰æŒ‡é’ˆçš„ä¸‹ä¸€ä½è¯»å–åˆ°æˆ–å†™å…¥åˆ°ã€‚Â </p> 
</blockquote> 
<pre><code class="language-java">//    åˆ é™¤æ¶ˆæ¯çš„æ–¹æ³•
    public void deleteMessage(MSGQueue queue,Message message) throws IOException,ClassNotFoundException{
        synchronized (queue){
            try(RandomAccessFile randomAccessFile = new RandomAccessFile(getQueueDataPath(queue.getName()),"rw")){
//            1.å…ˆä»æ–‡ä»¶ä¸­è¯»å–å¯¹åº”çš„Messageæ•°æ®
                byte[] bufferSrc = new byte[(int)(message.getOffsetEnd() - message.getOffsetBegin())];
                randomAccessFile.seek(message.getOffsetBegin());
                randomAccessFile.read(bufferSrc);
//            2.æŠŠå½“å‰è¯»å‡ºæ¥çš„äºŒè¿›åˆ¶æ•°æ®,è½¬å›æˆMessageå¯¹è±¡
                Message diskMessage = (Message) BinaryTool.fromBytes(bufferSrc);
//            3.æŠŠisValidè®¾ç½®ä¸ºæ— æ•ˆ
                diskMessage.setIsValid((byte) 0x0);
//            4.é‡æ–°å†™å…¥æ–‡ä»¶
                byte[] buffserDest = BinaryTool.toBytes(diskMessage);
//        è¿™é‡Œè¿˜éœ€è¦è®¾ç½®å…‰æ ‡çš„ä½ç½®,å› ä¸º,ä¸Šé¢çš„å…‰æ ‡å·²ç»éšç€è¯»å‡ºæ•°æ®è€Œå‘ç”Ÿäº†æ”¹å˜,å·²ç»èµ°åˆ°äº†ä¸‹ä¸€æ¡messageçš„offsetBegin,
//            è¿™é‡Œä¸ºäº†é‡æ–°å†™å…¥æ•°æ®åˆ°æ–‡ä»¶ä¸­,å°±éœ€è¦å°†å…‰æ ‡ç§»åˆ°å¯¹åº”çš„ä½ç½®ä¸Šé¢
                randomAccessFile.seek(message.getOffsetBegin());
                randomAccessFile.write(buffserDest);
//            5.ç»Ÿè®¡æ–‡ä»¶-1
//            å› ä¸ºæœ‰ä¸€æ¡æ•°æ®æ— æ•ˆäº†
                Stat stat = readStat(queue.getName());
                if (stat.validCount &gt; 0){
                    stat.validCount -= 1;
                }
                writeStat(queue.getName(),stat);
            }
        }
    }</code></pre> 
<hr> 
<h3 id="%F0%9F%8D%85%208%E3%80%81%E5%B0%86%E7%A1%AC%E7%9B%98%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E5%88%B0%E5%86%85%E5%AD%98%E4%B8%AD">ğŸ… 8ã€å°†ç¡¬ç›˜ä¸­çš„æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­</h3> 
<blockquote> 
 <p>å°†æ•°æ®ä»æ–‡ä»¶ä¸­,è¯»å–å‡ºæ‰€æœ‰çš„æ¶ˆæ¯å†…å®¹,åŠ è½½åˆ°å†…å­˜å½“ä¸­(æ”¾åˆ°ä¸€ä¸ªé“¾è¡¨ä¸­)ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šåœ¨ç¨‹åºå¯åŠ¨çš„æ—¶å€™è°ƒç”¨ï¼Œä¸»è¦åˆä»¥ä¸‹å‡ æ­¥</p> 
 <p>Â Â Â Â Â Â Â Â 1.è¯»å–å½“å‰æ¶ˆæ¯çš„é•¿åº¦ï¼›</p> 
 <p>Â  Â  Â  Â  2.æŒ‰ç…§è¯¥é•¿åº¦ï¼Œè¯»å–æ¶ˆæ¯å†…å®¹ï¼›</p> 
 <p>Â  Â  Â  Â  3.å°†è¯»å–åˆ°çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œååºåˆ—åŒ–å›Messageå¯¹è±¡</p> 
 <p>Â  Â  Â  Â  4.åˆ¤æ–­æ¶ˆæ¯å¯¹è±¡æ˜¯ä¸æ˜¯æ— æ•ˆå¯¹è±¡</p> 
 <p>Â  Â  Â  Â  4.å°†æœ‰æ•ˆçš„Messageå¯¹è±¡æ’å…¥åˆ°é“¾è¡¨ä¸­</p> 
</blockquote> 
<pre><code class="language-java">//   å°†æ•°æ®ä»æ–‡ä»¶ä¸­,è¯»å–å‡ºæ‰€æœ‰çš„æ¶ˆæ¯å†…å®¹,åŠ è½½åˆ°å†…å­˜å½“ä¸­(æ”¾åˆ°ä¸€ä¸ªé“¾è¡¨ä¸­)
//    ç”±äºè¯¥æ–¹æ³•å®åœ¨ç¨‹åºå¯åŠ¨æ—¶è°ƒç”¨, æ­¤æ—¶æœåŠ¡å™¨è¿˜ä¸èƒ½å¤„ç†è¯·æ±‚,ä¸æ¶‰åŠçº¿ç¨‹æ“ä½œæ–‡ä»¶.
    public LinkedList&lt;Message&gt; loadAllMessageFromQueue(String queueName) throws IOException,MqException,ClassNotFoundException {
        LinkedList&lt;Message&gt; messages = new LinkedList&lt;&gt;();
        try(InputStream inputStream = new FileInputStream(getQueueDataPath(queueName))){
            try(DataInputStream dataInputStream = new DataInputStream(inputStream)){
//               è¯¥å˜é‡è®°å½•å½“å‰æ–‡ä»¶å…‰æ ‡ä½ç½®,åˆå§‹ä½ç½®ä¸º0
                long currentOffset = 0;
//                ä¸€ä¸ªæ–‡ä»¶ä¸­åŒ…å«äº†å¾ˆå¤šæ¶ˆæ¯,è¿™é‡Œè¦å¾ªç¯è¯»å–
                while (true){
//                    1.è¯»å–å½“å‰æ¶ˆæ¯çš„é•¿åº¦,è¿™é‡Œå¯èƒ½ä¼šè¯»åˆ°æ–‡ä»¶æœ«å°¾
//                    reaIn()æ–¹æ³•è¯»åˆ°æ–‡ä»¶æœ«å°¾ï¼Œä¼šæŠ›å‡ºEOFExceptionå¼‚å¸¸
//                    readInt()è¯»å–å‡º4ä¸ªå­—èŠ‚
                    int messageSize = dataInputStream.readInt();
//                    2.æŒ‰ç…§è¿™ä¸ªé•¿åº¦,è¯»å–æ¶ˆæ¯å†…å®¹
//                    bufferæ˜¯ä¸€ä¸ªç››æ”¾æ¶ˆæ¯å®¹å™¨,å’Œæ¶ˆæ¯çš„é•¿åº¦ä¸€èˆ¬å¤§å°
                    byte[] buffer = new byte[messageSize];
                    int actualSize = dataInputStream.read(buffer);
                    if (messageSize != actualSize){
//                        å¦‚æœä¸åŒ¹é…ï¼Œè¯´æ˜æ–‡ä»¶æœ‰é—®é¢˜ï¼Œæ ¼å¼é”™ä¹±äº†
                        throw new MqException("[MessageFileManager] æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼queueName = " + queueName);
                    }
//                    3.å°†è¯»å–åˆ°çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œååºåˆ—åŒ–å›Messageå¯¹è±¡
                    Message message = (Message) BinaryTool.fromBytes(buffer);
                    //                  4.åˆ¤å®šè¿™ä¸ªæ¶ˆæ¯å¯¹è±¡æ˜¯ä¸æ˜¯æ— æ•ˆå¯¹è±¡
                    if(message.getIsValid() != 0x1){
//                        æ— æ•ˆæ•°æ®ï¼Œç›´æ¥è·³è¿‡
//                        è™½ç„¶æ¶ˆæ¯æ˜¯æ— æ•ˆæ¶ˆæ¯ï¼Œä½†æ˜¯offsetè¦æ›´æ–°
                        currentOffset += (4 + messageSize);
                        continue;
                    }
//                    æœ‰æ•ˆæ•°æ®ï¼Œåˆ™éœ€è¦æŠŠè¿™ä¸ªMessageå¯¹è±¡åŠ å…¥åˆ°é“¾è¡¨ä¸­ï¼ŒåŠ å…¥å‰è¿˜éœ€è¦å¡«å†™offsetBeginå’ŒoffsetEnd;
//                    è¿›è¡Œoffsetçš„æ—¶å€™ï¼Œéœ€è¦çŸ¥é“å½“å‰å…‰æ ‡çš„ä½ç½®ï¼Œç”±äºå½“ä¸‹ä½¿ç”¨çš„DataInputStreamå¹¶ä¸æ–¹ä¾¿è®¡ç®—å…‰æ ‡ä½ç½®
//                    å› æ­¤è¿™é‡Œæ‰‹åŠ¨è®¡ç®—æ–‡ä»¶å…‰æ ‡ä½ç½®
                    message.setOffsetBegin(currentOffset + 4);
                    message.setOffsetEnd(currentOffset + 4 + messageSize);
                    currentOffset += (4 + messageSize);
                    messages.add(message);
                }
            } catch (EOFException e){
                System.out.println("[MessageFileManager]æ¢å¤Messageæ•°æ®å®Œæˆ");
            }
        }
        return messages;
    }</code></pre> 
<hr> 
<h3 id="%F0%9F%8D%85%209%E3%80%81%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E6%96%87%E4%BB%B6%E7%9A%84%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6">ğŸ… 9ã€å®ç°æ¶ˆæ¯æ–‡ä»¶çš„åƒåœ¾å›æ”¶</h3> 
<blockquote> 
 <p><strong>ä¸ºä»€ä¹ˆè¦å®ç°åƒåœ¾å›æ”¶ï¼Ÿï¼ˆGCï¼‰</strong></p> 
 <p>Â Â Â Â Â Â Â Â ç”±äºå½“å‰ä¼šä¸åœçš„å¾€æ¶ˆæ¯æ–‡ä»¶ä¸­å†™å…¥æ–°æ¶ˆæ¯ï¼Œè€Œä¸”åˆ é™¤ä¹Ÿåªæ˜¯é€»è¾‘åˆ é™¤ï¼ˆisValidï¼‰ï¼Œè¿™æ ·å°±å¯èƒ½å¯¼è‡´æ¶ˆæ¯æ–‡ä»¶è¶Šæ¥è¶Šå¤§ï¼Œå¹¶ä¸”é‡Œé¢åˆåŒ…å«äº†å¤§é‡çš„æ— æ•ˆæ¶ˆæ¯ã€‚</p> 
</blockquote> 
<blockquote> 
 <p><strong>æ­¤å¤„çš„åƒåœ¾å›æ”¶ï¼Œä½¿ç”¨çš„æ˜¯å¤åˆ¶ç®—æ³•ï¼š</strong></p> 
 <p>Â  Â  Â  Â  åˆ¤æ–­ï¼Œå½“æ–‡ä»¶ä¸­æ¶ˆæ¯æ€»æ•°è¶…è¿‡äº†2000ï¼Œå¹¶ä¸”æœ‰æ•ˆæ¶ˆæ¯çš„æ•°ç›®ä¸è¶³50%æ—¶ï¼Œå°±è§¦å‘åƒåœ¾å›æ”¶ã€‚ç„¶åå°†æ–‡ä»¶ä¸­æœ‰æ•ˆçš„æ¶ˆæ¯å¤åˆ¶å‡ºæ¥ï¼Œå•ç‹¬å†™å…¥åˆ°ä¸€ä¸ªæ–°çš„æ–‡ä»¶ä¸­ï¼Œåˆ é™¤æ—§æ–‡ä»¶ï¼Œä½¿ç”¨æ–°æ–‡ä»¶ä»£æ›¿ã€‚</p> 
</blockquote> 
<h4 id="%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%F0%9F%8E%88%20%E6%A3%80%E6%B5%8B%E6%98%AF%E5%90%A6%E8%A6%81%E8%BF%9B%E8%A1%8CGC">Â Â Â Â Â Â Â Â ğŸˆ æ£€æµ‹æ˜¯å¦è¦è¿›è¡ŒGC</h4> 
<p>æ£€æŸ¥å½“å‰æ˜¯å¦è¦é’ˆå¯¹è¯¥é˜Ÿåˆ—çš„æ¶ˆæ¯æ•°æ®æ–‡ä»¶è¿›è¡ŒGCï¼Œåˆ¤æ–­æ˜¯å¦è¦GCï¼Œæ ¹æ®æ€»æ¶ˆæ¯æ•°ç›®å’Œæœ‰æ•ˆæ¶ˆæ¯æ•°ç›®åˆ¤æ–­ã€‚</p> 
<pre><code class="language-java">//    æ£€æŸ¥å½“å‰æ˜¯å¦è¦é’ˆå¯¹è¯¥é˜Ÿåˆ—çš„æ¶ˆæ¯æ•°æ®æ–‡ä»¶è¿›è¡ŒGC
    public boolean checkGC(String queueName){
//        åˆ¤æ–­æ˜¯å¦è¦GC,æ ¹æ®æ€»æ¶ˆæ¯æ•°ç›®å’Œæœ‰æ•ˆæ¶ˆæ¯æ•°ç›®ï¼Œè¿™ä¸¤ä¸ªå€¼éƒ½æ˜¯åœ¨æ¶ˆæ¯ç»Ÿè®¡æ–‡ä»¶ä¸­å®ç°çš„ã€‚
        Stat stat = readStat(queueName);
        if (stat.totalCount &gt; 2000 &amp;&amp; (double)stat.validCount / (double) stat.totalCount &lt; 0.5){
            return  true;
        }
        return false;
    }</code></pre> 
<h4 id="%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%F0%9F%8E%88%20%E6%9E%84%E9%80%A0%E6%96%B0%E7%9B%AE%E5%BD%95">Â  Â  Â  Â  ğŸˆ æ„é€ æ–°ç›®å½•</h4> 
<p>æ„é€ ä¸€ä¸ªæ–°ç›®å½•ï¼Œæ”¾ç½®æœ‰æ•ˆçš„å¤åˆ¶ä¿¡æ¯ã€‚</p> 
<pre><code class="language-java">//    æ„é€ ä¸€ä¸ªç›®å½•ç»“æ„æ”¾ç½®å¤åˆ¶çš„ä¿¡æ¯
    private String getQueueDataNewPath(String queueName){
        return getQueueDir(queueName) + "/queue_data_new.txt";
    }
</code></pre> 
<h4 id="%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%F0%9F%8E%88%20%E8%BF%9B%E8%A1%8CGC%E6%93%8D%E4%BD%9C">Â  Â  Â  Â  ğŸˆ è¿›è¡ŒGCæ“ä½œ</h4> 
<p>æ‰§è¡Œæ¶ˆæ¯æ•°æ®æ–‡ä»¶çš„åƒåœ¾å›æ”¶æ“ä½œï¼Œä½¿ç”¨å¤åˆ¶ç®—æ³•å®Œæˆï¼Œä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š</p> 
<blockquote> 
 <p>Â  Â  Â  Â  ï¼ˆ1ï¼‰åˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶queue_data_new.txt</p> 
 <p>Â  Â  Â  Â  ï¼ˆ2ï¼‰ä»æ—§æ–‡ä»¶ä¸­è¯»å–å‡ºæ‰€æœ‰çš„æœ‰æ•ˆæ¶ˆæ¯å¯¹è±¡</p> 
 <p>Â  Â  Â  Â  ï¼ˆ3ï¼‰æŠŠæœ‰æ•ˆæ¶ˆæ¯å†™å…¥åˆ°queue_data_new.txt</p> 
 <p>Â  Â  Â  Â  ï¼ˆ4ï¼‰åˆ å‡ºæ—§çš„æ–‡ä»¶ï¼Œå¹¶æŠŠæ–°çš„æ–‡ä»¶é‡å‘½åï¼ˆqueue_data_new.txt =&gt; queue_data.txtï¼‰</p> 
 <p>Â  Â  Â  Â  ï¼ˆ5ï¼‰æ›´æ–°ç»Ÿè®¡æ–‡ä»¶</p> 
</blockquote> 
<pre><code class="language-java">public void gc(MSGQueue queue) throws MqException, IOException, ClassNotFoundException {
//        è¿›è¡Œgcçš„æ—¶å€™ï¼Œæ˜¯é’ˆå¯¹æ¶ˆæ¯æ•°æ®æ–‡ä»¶ä½œå‡ºæ•´ä½“æ€§çš„ä¸€ä¸ªæ“ä½œï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œ
//        è¿›è¡ŒåŠ é”æ“ä½œï¼Œè®©å…¶ä»–çº¿ç¨‹ä¸èƒ½å¯¹è¯¥é˜Ÿåˆ—çš„æ¶ˆæ¯æ–‡ä»¶ä½œå‡ºä»»ä½•ä¿®æ”¹
        synchronized (queue) {
            // ç”±äº gc æ“ä½œå¯èƒ½æ¯”è¾ƒè€—æ—¶, æ­¤å¤„ç»Ÿè®¡ä¸€ä¸‹æ‰§è¡Œæ¶ˆè€—çš„æ—¶é—´.
            long gcBegin = System.currentTimeMillis();

            // 1. åˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶
            File queueDataNewFile = new File(getQueueDataNewPath(queue.getName()));
            if (queueDataNewFile.exists()) {
                // æ­£å¸¸æƒ…å†µä¸‹, è¿™ä¸ªæ–‡ä»¶ä¸åº”è¯¥å­˜åœ¨. å¦‚æœå­˜åœ¨, å°±æ˜¯æ„å¤–~~ è¯´æ˜ä¸Šæ¬¡ gc äº†ä¸€åŠ, ç¨‹åºæ„å¤–å´©æºƒäº†.
                throw new MqException("[MessageFileManager] gc æ—¶å‘ç°è¯¥é˜Ÿåˆ—çš„ queue_data_new å·²ç»å­˜åœ¨! queueName=" + queue.getName());
            }
            boolean ok = queueDataNewFile.createNewFile();
            if (!ok) {
                throw new MqException("[MessageFileManager] åˆ›å»ºæ–‡ä»¶å¤±è´¥! queueDataNewFile=" + queueDataNewFile.getAbsolutePath());
            }

            // 2. ä»æ—§çš„æ–‡ä»¶ä¸­, è¯»å–å‡ºæ‰€æœ‰çš„æœ‰æ•ˆæ¶ˆæ¯å¯¹è±¡äº†. (è¿™ä¸ªé€»è¾‘ç›´æ¥è°ƒç”¨ä¸Šè¿°æ–¹æ³•å³å¯, ä¸å¿…é‡æ–°å†™äº†)
            LinkedList&lt;Message&gt; messages = loadAllMessageFromQueue(queue.getName());

            // 3. æŠŠæœ‰æ•ˆæ¶ˆæ¯, å†™å…¥åˆ°æ–°çš„æ–‡ä»¶ä¸­.
            try (OutputStream outputStream = new FileOutputStream(queueDataNewFile)) {
                try (DataOutputStream dataOutputStream = new DataOutputStream(outputStream)) {
                    for (Message message : messages) {
                        byte[] buffer = BinaryTool.toBytes(message);
                        // å…ˆå†™å››ä¸ªå­—èŠ‚æ¶ˆæ¯çš„é•¿åº¦
                        dataOutputStream.writeInt(buffer.length);
                        dataOutputStream.write(buffer);
                    }
                }
            }

            // 4. åˆ é™¤æ—§çš„æ•°æ®æ–‡ä»¶, å¹¶ä¸”æŠŠæ–°çš„æ–‡ä»¶è¿›è¡Œé‡å‘½å
            File queueDataOldFile = new File(getQueueDataPath(queue.getName()));
            ok = queueDataOldFile.delete();
            if (!ok) {
                throw new MqException("[MessageFileManager] åˆ é™¤æ—§çš„æ•°æ®æ–‡ä»¶å¤±è´¥! queueDataOldFile=" + queueDataOldFile.getAbsolutePath());
            }
            // æŠŠ queue_data_new.txt =&gt; queue_data.txt
            ok = queueDataNewFile.renameTo(queueDataOldFile);
            if (!ok) {
                throw new MqException("[MessageFileManager] æ–‡ä»¶é‡å‘½åå¤±è´¥! queueDataNewFile=" + queueDataNewFile.getAbsolutePath()
                        + ", queueDataOldFile=" + queueDataOldFile.getAbsolutePath());
            }

            // 5. æ›´æ–°ç»Ÿè®¡æ–‡ä»¶
            Stat stat = readStat(queue.getName());
            stat.totalCount = messages.size();
            stat.validCount = messages.size();
            writeStat(queue.getName(), stat);

            long gcEnd = System.currentTimeMillis();
            System.out.println("[MessageFileManager] gc æ‰§è¡Œå®Œæ¯•! queueName=" + queue.getName() + ", time="
                    + (gcEnd - gcBegin) + "ms");
        }
    }</code></pre> 
<p></p> 
<hr> 
<h2 id="%E4%BA%94%E3%80%81%E6%B5%8B%E8%AF%95MessageFileManager%E7%B1%BB">äº”ã€æµ‹è¯•MessageFileManagerç±»</h2> 
<hr> 
<h3 id="%F0%9F%8D%85%201%E3%80%81%E2%80%9C%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C%E2%80%9D%E5%92%8C%E2%80%9C%E6%94%B6%E5%B0%BE%E5%B7%A5%E4%BD%9C%E2%80%9D">ğŸ… 1ã€â€œå‡†å¤‡å·¥ä½œâ€å’Œâ€œæ”¶å°¾å·¥ä½œâ€</h3> 
<p>åˆ›å»ºMessagefileManagerTestsÂ </p> 
<p><img alt="" height="814" src="https://images2.imgbox.com/fd/2e/Rb2Ph69h_o.png" width="1200"></p> 
<p></p> 
<pre><code class="language-java">@SpringBootTest
public class MessageFileManagerTests {
    private MessageFileManger messageFileManger = new MessageFileManger();

    private static final String queueName1 = "testQueue1";
    private static final String queueName2 = "testQueue2";

//  æ¯ä¸ªç”¨ä¾‹æ‰§è¡Œä¹‹å‰çš„å‡†å¤‡å·¥ä½œ
    @BeforeEach
    public void setUp() throws IOException {
//        å‡†å¤‡é˜¶æ®µï¼Œåˆ›å»ºå‡ºä¸¤ä¸ªé˜Ÿåˆ—ï¼Œä»¥å¤‡åç”¨
        messageFileManger.createQueueFiles(queueName1);
        messageFileManger.createQueueFiles(queueName2);

    }


//    æ¯ä¸ªç”¨ä¾‹æ‰§è¡Œä¹‹åçš„æ”¶å°¾å·¥ä½œ
    @AfterEach
    public void tearDown() throws IOException {
//        æ”¶å°¾é˜¶æ®µï¼ŒæŠŠåˆ›å»ºå‡ºçš„é˜Ÿåˆ—é”€æ¯æ‰
        messageFileManger.destroyQueueFiles(queueName1);
        messageFileManger.destroyQueueFiles(queueName2);
    }
}</code></pre> 
<p></p> 
<hr> 
<h3 id="%F0%9F%8D%85%202%E3%80%81%E6%B5%8B%E8%AF%95%E5%88%9B%E5%BB%BA%E6%96%87%E4%BB%B6%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8">ğŸ… 2ã€æµ‹è¯•åˆ›å»ºæ–‡ä»¶æ˜¯å¦å­˜åœ¨</h3> 
<pre><code class="language-java">@Test
    public void testCreateFiles(){
//        åˆ›å»ºé˜Ÿåˆ—æ–‡ä»¶åœ¨å‡†å¤‡å·¥ä½œå·²ç»æ‰§è¡Œè¿‡äº†ï¼Œè¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†éªŒè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        File queueDataFile1 = new File("./data/" + queueName1 + "/queue_data.txt");
//        assertEquals(é¢„æœŸå€¼ï¼Œå®é™…å€¼)
        Assertions.assertEquals(true,queueDataFile1.isFile());
        File queueStatFile1 = new File("./data/" + queueName1 + "/queue_stat.txt");
        Assertions.assertEquals(true,queueStatFile1.isFile());

        File queueDataFile2 = new File("./data/" + queueName2 + "/queue_data.txt");
        Assertions.assertEquals(true,queueDataFile2.isFile());
        File queueStatFile2 = new File("./data/" + queueName2 + "/queue_stat.txt");
        Assertions.assertEquals(true,queueStatFile2.isFile());
    }</code></pre> 
<p><img alt="" height="439" src="https://images2.imgbox.com/d3/8b/LzxaNNK1_o.png" width="1200"></p> 
<p>è¿™é‡Œä¸ºäº†æ–¹ä¾¿æŸ¥çœ‹æ–‡ä»¶æ˜¯å¦åˆ›å»ºï¼Œå°±æŠŠæ”¶å°¾å·¥ä½œæ³¨é‡Šæ‰äº†</p> 
<p>Â <img alt="" height="327" src="https://images2.imgbox.com/a4/01/T5XFeVnH_o.png" width="860"></p> 
<p></p> 
<hr> 
<h3 id="%C2%A0%F0%9F%8D%85%203%E3%80%81%E6%B5%8B%E8%AF%95writetStat%E5%92%8CreadStat%E6%98%AF%E5%90%A6%E8%83%BD%E5%A4%9F%E9%80%9A%E8%BF%87">Â ğŸ… 3ã€æµ‹è¯•writetStatå’ŒreadStatæ˜¯å¦èƒ½å¤Ÿé€šè¿‡</h3> 
<pre><code class="language-java">@Test
    public void testReadWriteStat(){
        MessageFileManger.Stat stat = new MessageFileManger.Stat();
        stat.totalCount = 100;
        stat.validCount =50;

//        ç”±äºwriteStatå’ŒreadStatæ˜¯ç§æœ‰æ–¹æ³•ï¼Œæ­¤å¤„å°±éœ€è¦ä½¿ç”¨åå°„çš„æ–¹å¼
//        ä½¿ç”¨Springå°è£…å¥½çš„åå°„çš„å·¥å…·ç±»
        ReflectionTestUtils.invokeMethod(messageFileManger,"writeStat", queueName1,stat);

//        å†™å…¥å®Œæ¯•ä¹‹åï¼Œè°ƒç”¨è¯»å–ï¼ŒéªŒè¯è¯»å–çš„ç»“æœå’Œå†™å…¥çš„æ•°æ®æ˜¯ä¸€è‡´çš„
        MessageFileManger.Stat newStat = ReflectionTestUtils.invokeMethod(messageFileManger,"readStat",queueName1);
        Assertions.assertEquals(100,newStat.totalCount);
        Assertions.assertEquals(50,newStat.validCount);

        System.out.println("writetStatå’ŒreadStatæµ‹è¯•é€šè¿‡");
    }
</code></pre> 
<p><img alt="" height="330" src="https://images2.imgbox.com/89/2e/FxO5xbBo_o.png" width="1200"></p> 
<p></p> 
<hr> 
<h3 id="%C2%A0%F0%9F%8D%85%204%E3%80%81%E6%B5%8B%E8%AF%95sendMessage">Â ğŸ… 4ã€æµ‹è¯•sendMessage</h3> 
<p>æ„é€ åˆ›å»ºqueueå’Œmessageçš„æ–¹æ³•ï¼š</p> 
<pre><code class="language-java"> private MSGQueue createTestQueue(String queueName){
        MSGQueue queue = new MSGQueue();
        queue.setName(queueName);
        queue.setDurable(true);    //æ˜¯å¦è¦æŒä¹…åŒ–
        return queue;
    }

</code></pre> 
<pre><code class="language-java">//    æ„é€ å‡ºä¸€æ¡æ¶ˆæ¯
    private Message createTestMessage(String content){
        Message message = Message.createMessageWithId("testRoutingKey",null,content.getBytes());
        return message;
    }</code></pre> 
<p>æµ‹è¯•sendMessageï¼š</p> 
<pre><code class="language-java">@Test
    public void testSendMessage() throws IOException, MqException, ClassNotFoundException {
//        æ„é€ å‡ºæ¶ˆæ¯ï¼Œå¹¶ä¸”æ„é€ å‡ºé˜Ÿåˆ—
        Message message = createTestMessage("testMessage");
//       åˆ›å»ºqueueå¯¹è±¡
        MSGQueue queue = createTestQueue(queueName1);

//      è°ƒç”¨å‘é€æ¶ˆæ¯çš„æ–¹æ³•
        messageFileManger.sendMessage(queue,message);

//       æ£€æŸ¥statæ–‡ä»¶
        MessageFileManger.Stat stat = ReflectionTestUtils.invokeMethod(messageFileManger,"readStat",queueName1);
        Assertions.assertEquals(1,stat.totalCount);
        Assertions.assertEquals(1,stat.validCount);

//        æ£€æŸ¥æ–‡ä»¶,æŠŠæ¶ˆæ¯è¯»å‡ºæ¥
        LinkedList&lt;Message&gt; messages = messageFileManger.loadAllMessageFromQueue(queueName1);
        Assertions.assertEquals(1,messages.size());
        Message curMessage = messages.get(0);
        Assertions.assertEquals(message.getMessageId(), curMessage.getMessageId());
        Assertions.assertEquals(message.getDeliverMode(),curMessage.getDeliverMode());

//      æ¯”è¾ƒä¸¤ä¸ªå­—èŠ‚æ•°ç»„çš„å†…å®¹æ˜¯å¦ç›¸åŒï¼Œä¸èƒ½ç›´æ¥ä½¿ç”¨asserEquals
        Assertions.assertArrayEquals(message.getBody(),curMessage.getBody());

        System.out.println("message = "+ curMessage);
    }</code></pre> 
<p>Â <img alt="" height="600" src="https://images2.imgbox.com/ca/2f/MGZmwHEY_o.png" width="1200"></p> 
<p>æ„é€ 100æ¡æ¶ˆæ¯ï¼ŒÂ å¹¶ä¸”è¯»å–å‡ºæ¥</p> 
<pre><code class="language-java"> @Test
    public void testLoadAllMessageFromQueue() throws IOException, MqException, ClassNotFoundException {
//      å¾€é˜Ÿåˆ—ä¸­æ’å…¥100æ¡æ¶ˆæ¯ï¼ŒéªŒè¯100æ¡æ¶ˆæ¯ä»æ–‡ä»¶ä¸­è¯»å–ä¹‹åï¼Œæ˜¯å¦å’Œæœ€åˆæ˜¯ä¸€è‡´çš„
        MSGQueue queue = createTestQueue(queueName1);
        List&lt;Message&gt; expectedMessages = new LinkedList&lt;&gt;();
        for (int i = 0; i &lt; 100; i++) {
            Message message = createTestMessage("testMessge" + 1);
            messageFileManger.sendMessage(queue,message);
            expectedMessages.add(message);
        }

//        è¯»å–æ‰€æœ‰æ¶ˆæ¯
        LinkedList&lt;Message&gt; actualMessages = messageFileManger.loadAllMessageFromQueue(queueName1);
        Assertions.assertEquals(expectedMessages.size(),actualMessages.size());
        for (int i = 0; i &lt; expectedMessages.size(); i++) {
            Message expectedMessage = expectedMessages.get(i);
            Message actualMessage = actualMessages.get(i);
            System.out.println("[" + i + "]actualMessage = " + actualMessages);

            Assertions.assertEquals(expectedMessage.getMessageId(),actualMessage.getMessageId());
            Assertions.assertEquals(expectedMessage.getRoutingKey(),actualMessage.getRoutingKey());
            Assertions.assertEquals(expectedMessage.getDeliverMode(),actualMessage.getDeliverMode());
            Assertions.assertArrayEquals(expectedMessage.getBody(),actualMessage.getBody());
            Assertions.assertEquals(0x1,actualMessage.getIsValid());
        }
    }</code></pre> 
<p>Â <img alt="" height="522" src="https://images2.imgbox.com/c3/13/2SaIoqPV_o.png" width="1200"></p> 
<hr> 
<p></p> 
<h3 id="%F0%9F%8D%85%205%E3%80%81%E6%B5%8B%E8%AF%95%E5%88%A0%E9%99%A4%E6%B6%88%E6%81%AF">ğŸ… 5ã€æµ‹è¯•åˆ é™¤æ¶ˆæ¯</h3> 
<pre><code class="language-java">//    æµ‹è¯•åˆ é™¤æ¶ˆæ¯
    @Test
    public void testDeleteMessage() throws IOException, MqException, ClassNotFoundException {
        // åˆ›å»ºé˜Ÿåˆ—, å†™å…¥ 10 ä¸ªæ¶ˆæ¯. åˆ é™¤å…¶ä¸­çš„å‡ ä¸ªæ¶ˆæ¯. å†æŠŠæ‰€æœ‰æ¶ˆæ¯è¯»å–å‡ºæ¥, åˆ¤å®šæ˜¯å¦ç¬¦åˆé¢„æœŸ.
        MSGQueue queue = createTestQueue(queueName1);
        List&lt;Message&gt; expectedMessages = new LinkedList&lt;&gt;();
        for (int i = 0; i &lt; 10; i++) {
            Message message = createTestMessage("testMessage" + i);
            messageFileManager.sendMessage(queue, message);
            expectedMessages.add(message);
        }

        // åˆ é™¤å…¶ä¸­çš„ä¸‰ä¸ªæ¶ˆæ¯
        messageFileManager.deleteMessage(queue, expectedMessages.get(7));
        messageFileManager.deleteMessage(queue, expectedMessages.get(8));
        messageFileManager.deleteMessage(queue, expectedMessages.get(9));

        // å¯¹æ¯”è¿™é‡Œçš„å†…å®¹æ˜¯å¦æ­£ç¡®.
        LinkedList&lt;Message&gt; actualMessages = messageFileManager.loadAllMessageFromQueue(queueName1);
        Assertions.assertEquals(7, actualMessages.size());
        for (int i = 0; i &lt; actualMessages.size(); i++) {
            Message expectedMessage = expectedMessages.get(i);
            Message actualMessage = actualMessages.get(i);
            System.out.println("[" + i + "] actualMessage=" + actualMessage);

            Assertions.assertEquals(expectedMessage.getMessageId(), actualMessage.getMessageId());
            Assertions.assertEquals(expectedMessage.getRoutingKey(), actualMessage.getRoutingKey());
            Assertions.assertEquals(expectedMessage.getDeliverMode(), actualMessage.getDeliverMode());
            Assertions.assertArrayEquals(expectedMessage.getBody(), actualMessage.getBody());
            Assertions.assertEquals(0x1, actualMessage.getIsValid());
        }
    }</code></pre> 
<p><img alt="" height="587" src="https://images2.imgbox.com/48/b1/90cx0Ime_o.png" width="1200"></p> 
<p></p> 
<h3 id="%F0%9F%8D%85%206%E3%80%81%E6%B5%8B%E8%AF%95%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6">ğŸ… 6ã€æµ‹è¯•åƒåœ¾å›æ”¶</h3> 
<pre><code class="language-java"> @Test
    public void testGC() throws IOException, MqException, ClassNotFoundException {
        // å…ˆå¾€é˜Ÿåˆ—ä¸­å†™ 100 ä¸ªæ¶ˆæ¯. è·å–åˆ°æ–‡ä»¶å¤§å°.
        // å†æŠŠ 100 ä¸ªæ¶ˆæ¯ä¸­çš„ä¸€åŠ, éƒ½ç»™åˆ é™¤æ‰(æ¯”å¦‚æŠŠä¸‹æ ‡ä¸ºå¶æ•°çš„æ¶ˆæ¯éƒ½åˆ é™¤)
        // å†æ‰‹åŠ¨è°ƒç”¨ gc æ–¹æ³•, æ£€æµ‹å¾—åˆ°çš„æ–°çš„æ–‡ä»¶çš„å¤§å°æ˜¯å¦æ¯”ä¹‹å‰ç¼©å°äº†.
        MSGQueue queue = createTestQueue(queueName1);
        List&lt;Message&gt; expectedMessages = new LinkedList&lt;&gt;();
        for (int i = 0; i &lt; 100; i++) {
            Message message = createTestMessage("testMessage" + i);
            messageFileManager.sendMessage(queue, message);
            expectedMessages.add(message);
        }

        // è·å– gc å‰çš„æ–‡ä»¶å¤§å°
        File beforeGCFile = new File("./data/" + queueName1 + "/queue_data.txt");
        long beforeGCLength = beforeGCFile.length();

        // åˆ é™¤å¶æ•°ä¸‹æ ‡çš„æ¶ˆæ¯
        for (int i = 0; i &lt; 100; i += 2) {
            messageFileManager.deleteMessage(queue, expectedMessages.get(i));
        }

        // æ‰‹åŠ¨è°ƒç”¨ gc
        messageFileManager.gc(queue);

        // é‡æ–°è¯»å–æ–‡ä»¶, éªŒè¯æ–°çš„æ–‡ä»¶çš„å†…å®¹æ˜¯ä¸æ˜¯å’Œä¹‹å‰çš„å†…å®¹åŒ¹é…
        LinkedList&lt;Message&gt; actualMessages = messageFileManager.loadAllMessageFromQueue(queueName1);
        Assertions.assertEquals(50, actualMessages.size());
        for (int i = 0; i &lt; actualMessages.size(); i++) {
            // æŠŠä¹‹å‰æ¶ˆæ¯å¶æ•°ä¸‹æ ‡çš„åˆ äº†, å‰©ä¸‹çš„å°±æ˜¯å¥‡æ•°ä¸‹æ ‡çš„å…ƒç´ äº†.
            // actual ä¸­çš„ 0 å¯¹åº” expected çš„ 1
            // actual ä¸­çš„ 1 å¯¹åº” expected çš„ 3
            // actual ä¸­çš„ 2 å¯¹åº” expected çš„ 5
            // actual ä¸­çš„ i å¯¹åº” expected çš„ 2 * i + 1
            Message expectedMessage = expectedMessages.get(2 * i + 1);
            Message actualMessage = actualMessages.get(i);

            Assertions.assertEquals(expectedMessage.getMessageId(), actualMessage.getMessageId());
            Assertions.assertEquals(expectedMessage.getRoutingKey(), actualMessage.getRoutingKey());
            Assertions.assertEquals(expectedMessage.getDeliverMode(), actualMessage.getDeliverMode());
            Assertions.assertArrayEquals(expectedMessage.getBody(), actualMessage.getBody());
            Assertions.assertEquals(0x1, actualMessage.getIsValid());
        }
        // è·å–æ–°çš„æ–‡ä»¶çš„å¤§å°
        File afterGCFile = new File("./data/" + queueName1 + "/queue_data.txt");
        long afterGCLength = afterGCFile.length();
        System.out.println("before: " + beforeGCLength);
        System.out.println("after: " + afterGCLength);
        Assertions.assertTrue(beforeGCLength &gt; afterGCLength);
    }</code></pre> 
<p><img alt="" height="486" src="https://images2.imgbox.com/db/71/pujK8vKT_o.png" width="1200"></p> 
<p></p> 
<h2 id="%E5%85%AD%E3%80%81%E5%B0%8F%E7%BB%93">å…­ã€å°ç»“</h2> 
<blockquote> 
 <p>MessageFileManagerä¸»è¦æ˜¯è´Ÿè´£ç®¡ç†æ¶ˆæ¯åœ¨æ–‡ä»¶ä¸­çš„å­˜å‚¨ï¼š</p> 
 <p>Â  Â  Â  Â  ï¼ˆ1ï¼‰è®¾è®¡äº†ç›®å½•ç»“æ„å’Œæ–‡ä»¶æ ¼å¼</p> 
 <p>Â  Â  Â  Â  ï¼ˆ2ï¼‰å®ç°äº†ç›®å½•åˆ›å»ºå’Œåˆ é™¤</p> 
 <p>Â  Â  Â  Â  ï¼ˆ3ï¼‰å®ç°äº†ç»Ÿè®¡æ–‡ä»¶çš„è¯»å†™</p> 
 <p>Â  Â  Â  Â  ï¼ˆ4ï¼‰å®ç°äº†æ¶ˆæ¯çš„å†™å…¥</p> 
 <p>Â  Â  Â  Â  ï¼ˆ5ï¼‰å®ç°äº†æ¶ˆæ¯çš„åˆ é™¤</p> 
 <p>Â Â Â Â Â Â Â Â ï¼ˆ6ï¼‰å®ç°äº†åŠ è½½æ‰€æœ‰æ¶ˆæ¯</p> 
 <p>Â Â Â Â Â Â Â Â ï¼ˆ7ï¼‰åƒåœ¾å›æ”¶</p> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/779a0f01eaffe12d8305df8af16d5b62/" rel="prev">
			<span class="pager__subtitle">Â«&thinsp;Previous</span>
			<p class="pager__title">CentOS å®‰è£… Jenkins</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/69482344f4bfa1eb222994ff91c3d290/" rel="next">
			<span class="pager__subtitle">Next&thinsp;Â»</span>
			<p class="pager__title">æ ‘è“æ´¾æ˜¯aarch64(64ä½ARMæ¶æ„)ï¼Œæ“ä½œç³»ç»Ÿæ˜¯32ä½çš„ï¼Œåœ¨è£…Miniconda3é‡åˆ°è¿™ä¸ªé”™è¯¯Miniconda3-py37_4.9.2-Linux-aarch64.sh: line 398:</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 ç¼–ç¨‹å¤§ç™½çš„åšå®¢.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>