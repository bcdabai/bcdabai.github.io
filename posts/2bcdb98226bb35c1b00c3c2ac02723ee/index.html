<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>mysql集群MHA高可用配置详解 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="mysql集群MHA高可用配置详解" />
<meta property="og:description" content="mysql集群MHA高可用配置详解 一：mysql概述1.1：什么是MHA1.2：MHA的组成1.3：MHA特点1.4：MHA的由来 二：MHA配置2.1：实验环境介绍2.2：实验架构图2.3：实验目的2.4：实验步骤2.4.1：所有节点上安装环境包和node组件2.4.2：配置所有节点之间的无密码认证2.4.3：MHA的配置2.4.4：故障模拟 2.5：实验验证 一：mysql概述 1.1：什么是MHA 日本DeNA公司 youshimaton（现就职于 Facebook公司）开发一套优秀的作为MySQL高可用性环境下故障切换和主从提升的高可用软件支持故障切换在MySQL故障切换过程中，MHA能做到在0~30秒之内自动完成数据库的故障切换操作，并且在进行故障切换的过程中，MHA能在最大程度上保证数据的一致性，以达到真正意义上的高可用MHA还提供在线主库切换的功能，能够安全地切换当前运行的主库到一个新的主库中(通过将从库提升为主库),大概0.5-2秒内即可完成 1.2：MHA的组成 MHA Manager（管理节点）
用来接收外部信号，监控下方数据节点的工作状态MHA Node（数据节点）
工作的单位，负责具体的工作 1.3：MHA特点 自动故障切换过程中，MHA试图从宕机的主服务器上保持二进制日志，最大程度的保证数据不丢失使用半同步复制，可以大大降低数据丢失的风险目前MHA支持一主多从架构，至少三台服务器，即一主两从 1.4：MHA的由来 传统的mysql主从架构存在的问题
单点故障 master只有一台，所以当出现单点故障的时候，整个服务器群集就会瘫痪掉
为了解决这种情况，我们需要在主服务器宕机的时候，重新建立一台主服务器，负责监控等工作
二：MHA配置 2.1：实验环境介绍 VMware软件
一台centos7作为MHA
三台centos7作为mysql服务器
搭建好mysql主从复制环境（主从复制参见之前的博客）
2.2：实验架构图 2.3：实验目的 通过MHA监控MySQL数据库，在故障时自动进行切换，不影响业务
当主库失效时，备选主库自动成为主库
2.4：实验步骤 2.4.1：所有节点上安装环境包和node组件 安装环境包，以manager为例 [root@mha ~]# yum install epel-release --nogpgcheck -y [root@mha ~]# yum install -y perl-DBD-MySQL \ perl-Config-Tiny \ perl-Log-Dispatch \ perl-Parallel-ForkManager \ perl-ExtUtils-CBuilder \ perl-ExtUtils-MakeMaker \ perl-CPAN 安装node组件，以salve为例 [root@slave01 ~]# ls anaconda-ks.cfg 公共 视频 文档 音乐 initial-setup-ks." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/2bcdb98226bb35c1b00c3c2ac02723ee/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-09-08T11:53:47+08:00" />
<meta property="article:modified_time" content="2020-09-08T11:53:47+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">mysql集群MHA高可用配置详解</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>mysql集群MHA高可用配置详解</h4> 
 <ul><li><a href="#mysql_1" rel="nofollow">一：mysql概述</a></li><li><ul><li><a href="#11MHA_2" rel="nofollow">1.1：什么是MHA</a></li><li><a href="#12MHA_8" rel="nofollow">1.2：MHA的组成</a></li><li><a href="#13MHA_13" rel="nofollow">1.3：MHA特点</a></li><li><a href="#14MHA_17" rel="nofollow">1.4：MHA的由来</a></li></ul> 
  </li><li><a href="#MHA_21" rel="nofollow">二：MHA配置</a></li><li><ul><li><a href="#21_22" rel="nofollow">2.1：实验环境介绍</a></li><li><a href="#22_30" rel="nofollow">2.2：实验架构图</a></li><li><a href="#23_32" rel="nofollow">2.3：实验目的</a></li><li><a href="#24_35" rel="nofollow">2.4：实验步骤</a></li><li><ul><li><a href="#241node_36" rel="nofollow">2.4.1：所有节点上安装环境包和node组件</a></li><li><a href="#242_91" rel="nofollow">2.4.2：配置所有节点之间的无密码认证</a></li><li><a href="#243MHA_121" rel="nofollow">2.4.3：MHA的配置</a></li><li><a href="#244_292" rel="nofollow">2.4.4：故障模拟</a></li></ul> 
   </li><li><a href="#25_303" rel="nofollow">2.5：实验验证</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="mysql_1"></a>一：mysql概述</h2> 
<h3><a id="11MHA_2"></a>1.1：什么是MHA</h3> 
<ul><li>日本DeNA公司 youshimaton（现就职于 Facebook公司）开发</li><li>一套优秀的作为MySQL高可用性环境下故障切换和主从提升的高可用软件</li><li>支持故障切换</li><li>在MySQL故障切换过程中，MHA能做到在0~30秒之内自动完成数据库的故障切换操作，并且在进行故障切换的过程中，MHA能在最大程度上保证数据的一致性，以达到真正意义上的高可用</li><li>MHA还提供在线主库切换的功能，能够安全地切换当前运行的主库到一个新的主库中(通过将从库提升为主库),大概0.5-2秒内即可完成</li></ul> 
<h3><a id="12MHA_8"></a>1.2：MHA的组成</h3> 
<ul><li>MHA Manager（管理节点）<br> 用来接收外部信号，监控下方数据节点的工作状态</li><li>MHA Node（数据节点）<br> 工作的单位，负责具体的工作</li></ul> 
<h3><a id="13MHA_13"></a>1.3：MHA特点</h3> 
<ul><li>自动故障切换过程中，MHA试图从宕机的主服务器上保持二进制日志，最大程度的保证数据不丢失</li><li>使用半同步复制，可以大大降低数据丢失的风险</li><li>目前MHA支持一主多从架构，至少三台服务器，即一主两从</li></ul> 
<h3><a id="14MHA_17"></a>1.4：MHA的由来</h3> 
<p>传统的mysql主从架构存在的问题<br> 单点故障 master只有一台，所以当出现单点故障的时候，整个服务器群集就会瘫痪掉<br> 为了解决这种情况，我们需要在主服务器宕机的时候，重新建立一台主服务器，负责监控等工作</p> 
<h2><a id="MHA_21"></a>二：MHA配置</h2> 
<h3><a id="21_22"></a>2.1：实验环境介绍</h3> 
<p>VMware软件</p> 
<p>一台centos7作为MHA</p> 
<p>三台centos7作为mysql服务器</p> 
<p>搭建好mysql主从复制环境（主从复制参见之前的博客）</p> 
<h3><a id="22_30"></a>2.2：实验架构图</h3> 
<p><img src="https://images2.imgbox.com/98/46/hYsExOqw_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="23_32"></a>2.3：实验目的</h3> 
<p>通过MHA监控MySQL数据库，在故障时自动进行切换，不影响业务<br> 当主库失效时，备选主库自动成为主库</p> 
<h3><a id="24_35"></a>2.4：实验步骤</h3> 
<h4><a id="241node_36"></a>2.4.1：所有节点上安装环境包和node组件</h4> 
<ul><li>安装环境包，以manager为例</li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@mha ~<span class="token punctuation">]</span><span class="token comment"># yum install epel-release --nogpgcheck -y</span>
<span class="token punctuation">[</span>root@mha ~<span class="token punctuation">]</span><span class="token comment"># yum install -y perl-DBD-MySQL \</span>
perl-Config-Tiny \
perl-Log-Dispatch \
perl-Parallel-ForkManager \
perl-ExtUtils-CBuilder \
perl-ExtUtils-MakeMaker \
perl-CPAN
</code></pre> 
<ul><li>安装node组件，以salve为例</li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@slave01 ~<span class="token punctuation">]</span><span class="token comment"># ls</span>
anaconda-ks.cfg   公共  视频  文档  音乐
initial-setup-ks.cfg  mha4mysql-node-0.57.tar.gz  模板  图片  下载  桌面
<span class="token punctuation">[</span>root@slave01 ~<span class="token punctuation">]</span><span class="token comment"># tar zxvf mha4mysql-node-0.57</span>
<span class="token punctuation">[</span>root@slave01 ~<span class="token punctuation">]</span><span class="token comment"># cd mha4mysql-node-0.57/</span>
<span class="token punctuation">[</span>root@slave01 mha4mysql-node-0.57<span class="token punctuation">]</span><span class="token comment"># ls</span>
AUTHORS  blib     debian  lib       Makefile.PL  META.yml     MYMETA.yml  README  t
bin      COPYING  inc     Makefile  MANIFEST     MYMETA.json  pm_to_blib  rpm
<span class="token punctuation">[</span>root@slave01 mha4mysql-node-0.57<span class="token punctuation">]</span><span class="token comment"># perl Makefile.PL </span>
<span class="token punctuation">[</span>root@slave01 mha4mysql-node-0.57<span class="token punctuation">]</span><span class="token comment"># make &amp;&amp; make install</span>
</code></pre> 
<ul><li>在MHA-manager节点上安装manager组件</li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@mha ~<span class="token punctuation">]</span><span class="token comment"># ls</span>
anaconda-ks.cfg       mha4mysql-manager-0.57         mha4mysql-node-0.57         公共  视频  文档  音乐
initial-setup-ks.cfg  mha4mysql-manager-0.57.tar.gz  mha4mysql-node-0.57.tar.gz  模板  图片  下载  桌面
<span class="token punctuation">[</span>root@mha ~<span class="token punctuation">]</span><span class="token comment"># tar zxvf mha4mysql-manager-0.57.tar.gz </span>
<span class="token punctuation">[</span>root@mha ~<span class="token punctuation">]</span><span class="token comment"># cd mha4mysql-manager-0.57/</span>
<span class="token punctuation">[</span>root@mha mha4mysql-manager-0.57<span class="token punctuation">]</span><span class="token comment"># ls</span>
AUTHORS  blib     debian  lib       Makefile.PL  META.yml     MYMETA.yml  README  samples  tests
bin      COPYING  inc     Makefile  MANIFEST     MYMETA.json  pm_to_blib  rpm     t
<span class="token punctuation">[</span>root@mha mha4mysql-manager-0.57<span class="token punctuation">]</span><span class="token comment"># perl Makefile.PL </span>
<span class="token punctuation">[</span>root@mha mha4mysql-manager-0.57<span class="token punctuation">]</span><span class="token comment"># make &amp;&amp; make install</span>
</code></pre> 
<ul><li> <p>manager安装后在/usr/local/bin 下面会生成几个工具，主要包括以下几个：<br> masterha_check_ssh 检查MHA的SSH配置状况<br> masterha_check_repl 检查MySQL的复制状况<br> masterha_manager 启动manager的脚本<br> masterha_check_status 检查MHA的运行状态<br> masterha_master_monitor 检查master是否宕机<br> masterha_master_swith 控制故障切换<br> masterha_conf_host 添加或删除配置的server信息<br> masterha_stop 关闭manager</p> </li><li> <p>node安装后也会在/usr/local/bin 下面生成几个工具（这些工具通常由MHA-manager的脚本触发，无须人为操作）<br> save_binary_logs 保存和复制master的二进制日志<br> apply_diff_relay_log 识别差别中继日志事件并将其差异的事件应用于其他slave<br> purge_relay_log 清除中继日志<br> filter_mysqlbinlog</p> </li></ul> 
<h4><a id="242_91"></a>2.4.2：配置所有节点之间的无密码认证</h4> 
<ul><li>在manager上配置到所有数据库节点的无密码认证（192.168.209.134）</li></ul> 
<pre><code class="prism language-bash">ssh-keygen -t rsa //一路回车
ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.209.145
ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.209.146
ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.209.147
</code></pre> 
<ul><li>在master上配置到slave01和slave02的无密码认证（192.168.209.145）</li></ul> 
<pre><code class="prism language-bash">ssh-keygen -t rsa //一路回车
ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.209.146
ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.209.147
</code></pre> 
<ul><li>在slave01上配置到master和slave02的无密码认证（192.168.209.146）</li></ul> 
<pre><code class="prism language-bash">ssh-keygen -t rsa //一路回车
ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.209.145
ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.209.147
</code></pre> 
<ul><li>在slave02上配置到master和slave01的无密码认证（192.168.209.147）</li></ul> 
<pre><code class="prism language-bash">ssh-keygen -t rsa //一路回车
ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.209.145
ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.209.146
</code></pre> 
<h4><a id="243MHA_121"></a>2.4.3：MHA的配置</h4> 
<ul><li>优化执行路径</li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@mha ~<span class="token punctuation">]</span><span class="token comment"># cp -ra /root/mha4mysql-manager-0.57/samples/scripts /usr/local/bin</span>
//copy后会有四个执行文件
master_ip_failover 自动切换VIP管理的脚本
master_ip_online_change   在线切换VIP
power_manager 故障发生后关闭主机的脚本
send_report 故障发生后发送报警的脚本
<span class="token punctuation">[</span>root@mha ~<span class="token punctuation">]</span><span class="token comment"># cp /usr/local/bin/scripts/master_ip_failover /usr/local/bin</span>
</code></pre> 
<ul><li>修改master_ip_failover脚本</li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@mha ~<span class="token punctuation">]</span><span class="token comment"># vim /usr/local/bin/master_ip_failover</span>
<span class="token comment">#!/usr/bin/env perl</span>
use strict<span class="token punctuation">;</span>
use warnings FATAL <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'all'</span><span class="token punctuation">;</span>

use Getopt::Long<span class="token punctuation">;</span>

my <span class="token punctuation">(</span>
<span class="token variable">$command</span>, <span class="token variable">$ssh_user</span>, <span class="token variable">$orig_master_host</span>, <span class="token variable">$orig_master_ip</span>,
<span class="token variable">$orig_master_port</span>, <span class="token variable">$new_master_host</span>, <span class="token variable">$new_master_ip</span>, <span class="token variable">$new_master_port</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">#############################添加内容部分#########################################</span>
my <span class="token variable">$vip</span> <span class="token operator">=</span> <span class="token string">'192.168.209.200'</span><span class="token punctuation">;</span>
my <span class="token variable">$brdc</span> <span class="token operator">=</span> <span class="token string">'192.168.209.255'</span><span class="token punctuation">;</span>
my <span class="token variable">$ifdev</span> <span class="token operator">=</span> <span class="token string">'ens33'</span><span class="token punctuation">;</span>
my <span class="token variable">$key</span> <span class="token operator">=</span> <span class="token string">'1'</span><span class="token punctuation">;</span>
my <span class="token variable">$ssh_start_vip</span> <span class="token operator">=</span> <span class="token string">"/sbin/ifconfig ens33:<span class="token variable">$key</span> <span class="token variable">$vip</span>"</span><span class="token punctuation">;</span>
my <span class="token variable">$ssh_stop_vip</span> <span class="token operator">=</span> <span class="token string">"/sbin/ifconfig ens33:<span class="token variable">$key</span> down"</span><span class="token punctuation">;</span>
my <span class="token variable">$exit_code</span> <span class="token operator">=</span> 0<span class="token punctuation">;</span>
<span class="token comment">#my $ssh_start_vip = "/usr/sbin/ip addr add $vip/24 brd $brdc dev $ifdev label $ifdev:$key;/usr/sbin/arping -q -A -c 1 -I $ifdev $vip;iptables -F;";</span>
<span class="token comment">#my $ssh_stop_vip = "/usr/sbin/ip addr del $vip/24 dev $ifdev label $ifdev:$key";</span>
<span class="token comment">##################################################################################</span>
GetOptions<span class="token punctuation">(</span>
<span class="token string">'command=s'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> \<span class="token variable">$command</span>,
<span class="token string">'ssh_user=s'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> \<span class="token variable">$ssh_user</span>,
<span class="token string">'orig_master_host=s'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> \<span class="token variable">$orig_master_host</span>,
<span class="token string">'orig_master_ip=s'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> \<span class="token variable">$orig_master_ip</span>,
<span class="token string">'orig_master_port=i'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> \<span class="token variable">$orig_master_port</span>,
<span class="token string">'new_master_host=s'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> \<span class="token variable">$new_master_host</span>,
<span class="token string">'new_master_ip=s'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> \<span class="token variable">$new_master_ip</span>,
<span class="token string">'new_master_port=i'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> \<span class="token variable">$new_master_port</span>,
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">exit</span> <span class="token operator">&amp;</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

sub main <span class="token punctuation">{<!-- --></span>

print <span class="token string">"\n\nIN SCRIPT TEST====<span class="token variable">$ssh_stop_vip</span>==<span class="token variable">$ssh_start_vip</span>===\n\n"</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$command</span> eq <span class="token string">"stop"</span> <span class="token operator">||</span> <span class="token variable">$command</span> eq <span class="token string">"stopssh"</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

my <span class="token variable">$exit_code</span> <span class="token operator">=</span> 1<span class="token punctuation">;</span>
<span class="token function">eval</span> <span class="token punctuation">{<!-- --></span>
print <span class="token string">"Disabling the VIP on old master: <span class="token variable">$orig_master_host</span> \n"</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>stop_vip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$exit_code</span> <span class="token operator">=</span> 0<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$@</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
warn <span class="token string">"Got Error: <span class="token variable">$@</span>\n"</span><span class="token punctuation">;</span>
<span class="token keyword">exit</span> <span class="token variable">$exit_code</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">exit</span> <span class="token variable">$exit_code</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
elsif <span class="token punctuation">(</span> <span class="token variable">$command</span> eq <span class="token string">"start"</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

my <span class="token variable">$exit_code</span> <span class="token operator">=</span> 10<span class="token punctuation">;</span>
<span class="token function">eval</span> <span class="token punctuation">{<!-- --></span>
print <span class="token string">"Enabling the VIP - <span class="token variable">$vip</span> on the new master - <span class="token variable">$new_master_host</span> \n"</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>start_vip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$exit_code</span> <span class="token operator">=</span> 0<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$@</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
warn <span class="token variable">$@</span><span class="token punctuation">;</span>
<span class="token keyword">exit</span> <span class="token variable">$exit_code</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">exit</span> <span class="token variable">$exit_code</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
elsif <span class="token punctuation">(</span> <span class="token variable">$command</span> eq <span class="token string">"status"</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
print <span class="token string">"Checking the Status of the script.. OK \n"</span><span class="token punctuation">;</span>
<span class="token keyword">exit</span> 0<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">&amp;</span>usage<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">exit</span> 1<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
sub start_vip<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token variable"><span class="token variable">`</span><span class="token function">ssh</span> $ssh_user\@$new_master_host \" $ssh_start_vip \"<span class="token variable">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment"># A simple system call that disable the VIP on the old_master</span>
sub stop_vip<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token variable"><span class="token variable">`</span><span class="token function">ssh</span> $ssh_user\@$orig_master_host \" $ssh_stop_vip \"<span class="token variable">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

sub usage <span class="token punctuation">{<!-- --></span>
print
<span class="token string">"Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>修改配置文件app1.cnf</li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@mha ~<span class="token punctuation">]</span><span class="token comment"># mkdir /etc/masterha</span>
<span class="token punctuation">[</span>root@mha ~<span class="token punctuation">]</span><span class="token comment"># cp /root/mha4mysql-manager-0.57/samples/conf/app1.cnf /etc/masterha</span>
<span class="token punctuation">[</span>root@mha ~<span class="token punctuation">]</span><span class="token comment"># vim /etc/masterha/app1.cnf </span>
<span class="token punctuation">[</span>server default<span class="token punctuation">]</span>
manager_log<span class="token operator">=</span>/var/log/masterha/app1/manager.log
manager_workdir<span class="token operator">=</span>/var/log/masterha/app1
master_binlog_dir<span class="token operator">=</span>/usr/local/mysql/data
master_ip_failover_script<span class="token operator">=</span>/usr/local/bin/master_ip_failover
master_ip_online_change_script<span class="token operator">=</span>/usr/local/bin/scripts/master_ip_online_change
user<span class="token operator">=</span>mha
password<span class="token operator">=</span>123123
ping_interval<span class="token operator">=</span>1
remote_workdir<span class="token operator">=</span>/tmp
repl_user<span class="token operator">=</span>myslave
repl_password<span class="token operator">=</span>123123
report_script<span class="token operator">=</span>/usr/local/send_report
secondary_check_script<span class="token operator">=</span>/usr/local/bin/masterha_secondary_check -s 192.168.209.146 -s 192.168.209.147
shutdown_script<span class="token operator">=</span><span class="token string">""</span>
ssh_user<span class="token operator">=</span>root

<span class="token punctuation">[</span>server1<span class="token punctuation">]</span>
hostname<span class="token operator">=</span>192.168.209.145
port<span class="token operator">=</span>3306

<span class="token punctuation">[</span>server2<span class="token punctuation">]</span>
candidate_master<span class="token operator">=</span>1
check_repl_delay<span class="token operator">=</span>0
hostname<span class="token operator">=</span>192.168.209.146
port<span class="token operator">=</span>3306

<span class="token punctuation">[</span>server3<span class="token punctuation">]</span>
hostname<span class="token operator">=</span>192.168.209.147
port<span class="token operator">=</span>3306
</code></pre> 
<ul><li>测试ssh无密码认证，如果正常，最后会输出successfully</li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@mha ~<span class="token punctuation">]</span><span class="token comment"># masterha_check_ssh -conf=/etc/masterha/app1.cnf</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
Tue Sep  8 10:23:15 2020 - <span class="token punctuation">[</span>info<span class="token punctuation">]</span> All SSH connection tests passed successfully.
</code></pre> 
<ul><li>测试mysql的主从复制，如果正常，最后会输出healthy is ok</li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@mha ~<span class="token punctuation">]</span><span class="token comment"># masterha_check_repl -conf=/etc/masterha/app1.cnf</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
MySQL Replication Health is OK.
</code></pre> 
<p>注意：第一次配置需在master上手动开启虚拟VIP<br> ifconfig ens33:1 192.168.209.200/24</p> 
<ul><li>启动MHA</li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@mha ~<span class="token punctuation">]</span><span class="token comment"># nohup masterha_manager --conf=/etc/masterha/app1.cnf --remove_dead_master_conf --ignore_last_failover &lt; /dev/null &gt; /var/log/masterha/app1/manager.log 2&gt;&amp;1 &amp;</span>
</code></pre> 
<ul><li>查看MHA的状态或者日志文件</li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@mha ~<span class="token punctuation">]</span><span class="token comment"># masterha_check_status --conf=/etc/masterha/app1.cnf</span>
app1 <span class="token punctuation">(</span>pid:8454<span class="token punctuation">)</span> is running<span class="token punctuation">(</span>0:PING_OK<span class="token punctuation">)</span>, master:192.168.209.145
<span class="token punctuation">[</span>root@mha ~<span class="token punctuation">]</span><span class="token comment"># cat /var/log/masterha/app1/manager.log</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
</code></pre> 
<h4><a id="244_292"></a>2.4.4：故障模拟</h4> 
<ul><li>启动监控观察日志记录</li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@mha ~<span class="token punctuation">]</span><span class="token comment"># tailf /var/log/masterha/app1/manager.log</span>
</code></pre> 
<ul><li>关闭master</li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># pkill -9 mysqld </span>
</code></pre> 
<h3><a id="25_303"></a>2.5：实验验证</h3> 
<p>在从服务器上（slave01）查看VIP有没有自动切换过来</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@slave01 ~<span class="token punctuation">]</span><span class="token comment"># ifconfig</span>
ens33: flags<span class="token operator">=</span>4163<span class="token operator">&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class="token operator">&gt;</span>  mtu 1500
        inet 192.168.209.146  netmask 255.255.255.0  broadcast 192.168.209.255
        inet6 fe80::eefc:1727:92ef:63f2  prefixlen 64  scopeid 0x20<span class="token operator">&lt;</span>link<span class="token operator">&gt;</span>
        ether 00:0c:29:1c:67:bb  txqueuelen 1000  <span class="token punctuation">(</span>Ethernet<span class="token punctuation">)</span>
        RX packets 1809  bytes 215257 <span class="token punctuation">(</span>210.2 KiB<span class="token punctuation">)</span>
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 1242  bytes 271843 <span class="token punctuation">(</span>265.4 KiB<span class="token punctuation">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

ens33:1: flags<span class="token operator">=</span>4163<span class="token operator">&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class="token operator">&gt;</span>  mtu 1500
        inet 192.168.209.200  netmask 255.255.255.0  broadcast 192.168.209.255
        ether 00:0c:29:1c:67:bb  txqueuelen 1000  <span class="token punctuation">(</span>Ethernet<span class="token punctuation">)</span>
</code></pre> 
<p>可以看到自动切换成功<br> 在manager上查看日志记录</p> 
<pre><code>----- Failover Report -----

app1: MySQL Master failover 192.168.209.145(192.168.209.145:3306) to 192.168.209.146(192.168.209.146:3306) succeeded

Master 192.168.209.145(192.168.209.145:3306) is down!

Check MHA Manager logs at mha:/var/log/masterha/app1/manager.log for details.

Started automated(non-interactive) failover.
Invalidated master IP address on 192.168.209.145(192.168.209.145:3306)
The latest slave 192.168.209.146(192.168.209.146:3306) has all relay logs for recovery.
Selected 192.168.209.146(192.168.209.146:3306) as a new master.
192.168.209.146(192.168.209.146:3306): OK: Applying all logs succeeded.
192.168.209.146(192.168.209.146:3306): OK: Activated master IP address.
192.168.209.147(192.168.209.147:3306): This host has the latest relay log events.
Generating relay diff files from the latest slave succeeded.
192.168.209.147(192.168.209.147:3306): OK: Applying all logs succeeded. Slave started, replicating from 192.168.209.146(192.168.209.146:3306)
192.168.209.146(192.168.209.146:3306): Resetting slave info succeeded.
Master failover to 192.168.209.146(192.168.209.146:3306) completed successfully.
</code></pre> 
<p>至此整个实验配置完成！</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/59b1288b925e8a5e90f4dda6adff65c1/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">spark的转换算子2</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ed1facdc47c9a43406b117e578135660/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">RC.exe命令行将.rc文件编译为.res文件,解决error RC2144 : PRIMARY LANGUAGE ID not a number报错</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>