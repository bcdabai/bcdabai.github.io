<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>关于内网使用Nginx正向代理发送极光推送 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="关于内网使用Nginx正向代理发送极光推送" />
<meta property="og:description" content="关于内网使用Nginx正向代理发送极光推送 一 业务场景二 使用极光前的准备工作三 配置nginx.conf四 极光推送部分代码结束语 一 业务场景 微信支付返回交易信息到内网的系统，信息由内网系统处理后访问极光提供的API https://api.jpush.cn/v3/push 由此来完成消息的推送。内网系统不能直接访问外网，准备使用nginx做正向代理访问极光的API。 二 使用极光前的准备工作 1 下载极光的jar包添加到项目中 2 服务器安装nginx 由于管网的文档很详细，以上两步自行解决。 三 配置nginx.conf 1 服务器IP 假设nginx IP为 33.33.33.33 2 极光IP 极光域名 api.jpush.cn 的IP是动态变化的，官方建议是开放域名访问，最要不要在hosts里绑定IP。 官方有几个固定IP 113.31.138.48 113.31.138.47 183.232.57.12 但是不保证固定不变，并且如果有变动也只会主动通知极光的VIP。 所以你可以用固定的IP，也可以ping一下 api.jpush.cn 得到IP。 我就使用的 113.31.138.48 PS：使用极光V3接口（只支持https请求）要开放443端口（），使用V2接口要开放80端口，但是后者已经不再维护了，所以不建议使用。 3 配置hosts view /etc/hosts 在hosts文件解析域名 113.31.138.48 api.jpush.cn 保存 4 配置nginx.conf nginx.conf一版在默认目录 /etc/niginx/ 下 http { log_format main &#39;$remote_addr - $remote_user [$time_local] &#34;$request&#34; &#39; &#39;$status $body_bytes_sent &#34;$http_referer&#34; &#39; &#39;&#34;$http_user_agent&#34; &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/12f814e2b452ab5dbc4e34c83a2de247/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-05-28T22:00:31+08:00" />
<meta property="article:modified_time" content="2019-05-28T22:00:31+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">关于内网使用Nginx正向代理发送极光推送</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>关于内网使用Nginx正向代理发送极光推送</h4> 
 <ul><li><a href="#__2" rel="nofollow">一 业务场景</a></li><li><a href="#__4" rel="nofollow">二 使用极光前的准备工作</a></li><li><a href="#_nginxconf_8" rel="nofollow">三 配置nginx.conf</a></li><li><a href="#__66" rel="nofollow">四 极光推送部分代码</a></li><li><ul><li><a href="#_82" rel="nofollow">结束语</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="__2"></a>一 业务场景</h2> 
<pre><code>微信支付返回交易信息到内网的系统，信息由内网系统处理后访问极光提供的API https://api.jpush.cn/v3/push 由此来完成消息的推送。内网系统不能直接访问外网，准备使用nginx做正向代理访问极光的API。
</code></pre> 
<h2><a id="__4"></a>二 使用极光前的准备工作</h2> 
<pre><code>1 下载极光的jar包添加到项目中
2 服务器安装nginx
由于管网的文档很详细，以上两步自行解决。
</code></pre> 
<h2><a id="_nginxconf_8"></a>三 配置nginx.conf</h2> 
<pre><code>1 服务器IP
	假设nginx IP为 33.33.33.33
2 极光IP
	极光域名 api.jpush.cn 的IP是动态变化的，官方建议是开放域名访问，最要不要在hosts里绑定IP。
	官方有几个固定IP 
	113.31.138.48
	113.31.138.47
	183.232.57.12
	但是不保证固定不变，并且如果有变动也只会主动通知极光的VIP。
	所以你可以用固定的IP，也可以ping一下  api.jpush.cn 得到IP。
	我就使用的 113.31.138.48 
	PS：使用极光V3接口（只支持https请求）要开放443端口（），使用V2接口要开放80端口，但是后者已经不再维护了，所以不建议使用。
3 配置hosts
	view /etc/hosts 在hosts文件解析域名 
	113.31.138.48  api.jpush.cn
	保存
4 配置nginx.conf
	nginx.conf一版在默认目录  /etc/niginx/  下
</code></pre> 
<pre><code>http {
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;
    keepalive_timeout   65;
    types_hash_max_size 2048;

    include             /etc/nginx/mime.types;
    default_type        application/octet-stream;

    # Load modular configuration files from the /etc/nginx/conf.d directory.
    # See http://nginx.org/en/docs/ngx_core_module.html#include
    # for more information.
    include /etc/nginx/conf.d/*.conf;
   
    server {
        listen       443;
        # Load configuration files for the default server block.
        include /etc/nginx/default.d/*.conf;
        
        location /v3 {
    	proxy_pass https://api.jpush.cn;
        }
    }
}
</code></pre> 
<p>其他的没有需求的话就不用管，最基础的在server 里面监听 443端口，<br> 然后配置一个location /v3 来匹配请求<br> 然后将 <a href="https://api.jpush.cn" rel="nofollow">https://api.jpush.cn</a> 赋给 proxy_pass<br> 重启nginx nginx -s reload<br> 你能ping通极光，基本用这个配置就可以了。</p> 
<h2><a id="__66"></a>四 极光推送部分代码</h2> 
<p>1 使用HttpProxy来代理<br> 2 使用构造器 public JPushClient(String masterSecret, String appKey, HttpProxy proxy, ClientConfig conf)来实例化client<br> 3 实例化 ClientConfig，来配置要访问的IP</p> 
<pre><code>HttpProxy httpProxy = new HttpProxy("33.33.33.33", 443)
ClientConfig clientConfig = ClientConfig.getInstance();
 clientConfig.setPushHostName("http://33.33.33.33");//这个必须设置，如果不设置会出现 400 bad request
JPushClient jPushClient = new JPushClient(masterSecret, appKey, httpProxy, clientConfig);
PushPayload pushPayload = buildPushObject_all_alias_alert(alias, total);
...
配置要推送的消息，看官方文档...
...

</code></pre> 
<h3><a id="_82"></a>结束语</h3> 
<pre><code>基本上极光推送的坑就在这个设置hostname上了，clientConfig.setPushHostName("http://33.33.33.33")
在网上查了许久，论坛也看了，并没有给出有效的办法，极光官方也只是强调域名的问题，nginx配置没有问题，就是代理不出去，报错400 bad request。 最后试着配置一下config结果就访问成功了，所以使用nginx代理访问一定要配置clientConfig.setPushHostName("服务器IP")！ 重要的事情说三遍！！！
关于极光推送，有不对的地方、有什么好的建议或者想讨论的朋友欢迎留言~~~~
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/50eea88dffd0f91e282d9c9f56a14536/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Bi-lstm&#43;CRF实现NER（随机生成词向量）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c139c22972cf335701e77abaf130c16a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">解决mybatis IN语句拼接sql过长</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>