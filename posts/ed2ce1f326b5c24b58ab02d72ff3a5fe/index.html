<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Reids实战—黑马点评（三）秒杀篇 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Reids实战—黑马点评（三）秒杀篇" />
<meta property="og:description" content="Reids实战—黑马点评（三）秒杀篇 来自黑马的redis课程的笔记
【黑马程序员Redis入门到实战教程，深度透析redis底层原理&#43;redis分布式锁&#43;企业解决方案&#43;黑马点评实战项目】
目录 Reids实战—黑马点评（三）秒杀篇一、全局唯一ID小结 二、实现优惠券秒杀下单三、超卖问题3.1 问题描述3.2 乐观锁和悲观锁3.3 乐观锁实现3.3.1 版本号法3.3.2 CAS（Compare And Swap） 3.4 小结 四、一人一单4.1 添加功能4.2 并发问题4.3 字符串问题4.4 Spring事务问题4.4.1 锁在事务内4.4.2 事务不生效 4.5 集群模式下的一人一单问题 五、分布式锁5.1 分布式锁概述5.2 基于redis实现分布式锁5.2.1 锁误删5.2.2 Lua脚本保证命令原子性 5.3 小结 六、Redisson6.1 使用Redisson分布式锁6.2 Redisson分布式锁原理6.2.1 可重入原理6.2.2 可重试原理6.2.3 解决超时释放6.2.4 保证主从一致6.2.5 小结 七、redis优化秒杀八、Redis消息队列实现异步秒杀8.1 基于List结构模拟消息队列8.2 PubSub发布订阅模式8.3 基于Stream结构的消息队列8.3.1 基本使用8.3.2 消费者组8.3.3 改造秒杀业务8.3.4 小结 一、全局唯一ID 每一个订单都需要不同的ID，如何做到ID唯一？
如果似乎用自增：
id规律明显（安全问题）受单表数据量限制 为了解决这些问题，我们有了全局ID生成器，这是一种生成全局唯一ID（或者叫分布式唯一ID）的工具，所生成的ID满足以下特征：
唯一性高可用高性能递增性安全性（复杂递增） 唯一性和递增性我们可以用redis自增来实现，恰好，redis本身就满足高可用、高性能，安全性如何解决？
方案：
用Long（数值效率比字符串高）类型，一个Long类型占64位（Java中），我们可以在这些bit位上做文章。
首先：从左数第一位，是符号位，我们的id永远为正数，所以让它永远为0。接下来的31位，用来存时间戳，保证安全性的同时，让id基本不可能重复。最后的32位，我们存普通的递增值。这个方案，理论上可以保证68年都不会有id重复。
为了避免最后的自增值超出redis自增限制，我们可以每天新建一个key用于自增（例如，yyyy:MM:dd），不仅解决了问题，还方便统计。
实现：
@Component public class RedisIdWorker { private StringRedisTemplate stringRedisTemplate; // 起始的时间戳值 private static final Long BEGIN_TIMESTAMP = 1640995200L; public RedisIdWorker (StringRedisTemplate stringRedisTemplate) { this." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/ed2ce1f326b5c24b58ab02d72ff3a5fe/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-26T18:40:28+08:00" />
<meta property="article:modified_time" content="2023-02-26T18:40:28+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Reids实战—黑马点评（三）秒杀篇</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Reids_0"></a>Reids实战—黑马点评（三）秒杀篇</h2> 
<p>来自黑马的redis课程的笔记</p> 
<p><a href="https://www.bilibili.com/video/BV1cr4y1671t" rel="nofollow">【黑马程序员Redis入门到实战教程，深度透析redis底层原理+redis分布式锁+企业解决方案+黑马点评实战项目】</a></p> 
<p><img src="https://images2.imgbox.com/47/bc/zbjtc2T5_o.jpg" alt="在这里插入图片描述"><br> </p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#Reids_0" rel="nofollow">Reids实战—黑马点评（三）秒杀篇</a></li><li><ul><li><a href="#ID_9" rel="nofollow">一、全局唯一ID</a></li><li><ul><li><a href="#_132" rel="nofollow">小结</a></li></ul> 
   </li><li><a href="#_145" rel="nofollow">二、实现优惠券秒杀下单</a></li><li><a href="#_165" rel="nofollow">三、超卖问题</a></li><li><ul><li><a href="#31__167" rel="nofollow">3.1 问题描述</a></li><li><a href="#32__182" rel="nofollow">3.2 乐观锁和悲观锁</a></li><li><a href="#33__192" rel="nofollow">3.3 乐观锁实现</a></li><li><ul><li><a href="#331__198" rel="nofollow">3.3.1 版本号法</a></li><li><a href="#332_CASCompare_And_Swap_205" rel="nofollow">3.3.2 CAS（Compare And Swap）</a></li></ul> 
    </li><li><a href="#34__214" rel="nofollow">3.4 小结</a></li></ul> 
   </li><li><a href="#_225" rel="nofollow">四、一人一单</a></li><li><ul><li><a href="#41__227" rel="nofollow">4.1 添加功能</a></li><li><a href="#42__238" rel="nofollow">4.2 并发问题</a></li><li><a href="#43__267" rel="nofollow">4.3 字符串问题</a></li><li><a href="#44_Spring_287" rel="nofollow">4.4 Spring事务问题</a></li><li><ul><li><a href="#441__293" rel="nofollow">4.4.1 锁在事务内</a></li><li><a href="#442__305" rel="nofollow">4.4.2 事务不生效</a></li></ul> 
    </li><li><a href="#45__345" rel="nofollow">4.5 集群模式下的一人一单问题</a></li></ul> 
   </li><li><a href="#_360" rel="nofollow">五、分布式锁</a></li><li><ul><li><a href="#51__364" rel="nofollow">5.1 分布式锁概述</a></li><li><a href="#52_redis_375" rel="nofollow">5.2 基于redis实现分布式锁</a></li><li><ul><li><a href="#521__383" rel="nofollow">5.2.1 锁误删</a></li><li><a href="#522_Lua_399" rel="nofollow">5.2.2 Lua脚本保证命令原子性</a></li></ul> 
    </li><li><a href="#53__507" rel="nofollow">5.3 小结</a></li></ul> 
   </li><li><a href="#Redisson_519" rel="nofollow">六、Redisson</a></li><li><ul><li><a href="#61_Redisson_535" rel="nofollow">6.1 使用Redisson分布式锁</a></li><li><a href="#62_Redisson_592" rel="nofollow">6.2 Redisson分布式锁原理</a></li><li><ul><li><a href="#621__599" rel="nofollow">6.2.1 可重入原理</a></li><li><a href="#622__627" rel="nofollow">6.2.2 可重试原理</a></li><li><a href="#623__731" rel="nofollow">6.2.3 解决超时释放</a></li><li><a href="#624__855" rel="nofollow">6.2.4 保证主从一致</a></li><li><a href="#625__875" rel="nofollow">6.2.5 小结</a></li></ul> 
   </li></ul> 
   </li><li><a href="#redis_890" rel="nofollow">七、redis优化秒杀</a></li><li><a href="#Redis_917" rel="nofollow">八、Redis消息队列实现异步秒杀</a></li><li><ul><li><a href="#81_List_929" rel="nofollow">8.1 基于List结构模拟消息队列</a></li><li><a href="#82_PubSub_935" rel="nofollow">8.2 PubSub发布订阅模式</a></li><li><a href="#83_Stream_943" rel="nofollow">8.3 基于Stream结构的消息队列</a></li><li><ul><li><a href="#831__945" rel="nofollow">8.3.1 基本使用</a></li><li><a href="#832__973" rel="nofollow">8.3.2 消费者组</a></li><li><a href="#833__991" rel="nofollow">8.3.3 改造秒杀业务</a></li><li><a href="#834__1065" rel="nofollow">8.3.4 小结</a></li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="ID_9"></a>一、全局唯一ID</h3> 
<p>每一个订单都需要不同的ID，如何做到ID唯一？</p> 
<p>如果似乎用自增：</p> 
<ul><li>id规律明显（安全问题）</li><li>受单表数据量限制</li></ul> 
<p>为了解决这些问题，我们有了<strong>全局ID生成器</strong>，这是一种生成全局唯一ID（或者叫分布式唯一ID）的工具，所生成的ID满足以下特征：</p> 
<ul><li>唯一性</li><li>高可用</li><li>高性能</li><li>递增性</li><li>安全性（复杂递增）</li></ul> 
<p>唯一性和递增性我们可以用redis自增来实现，恰好，redis本身就满足高可用、高性能，安全性如何解决？</p> 
<p>方案：</p> 
<p><img src="https://images2.imgbox.com/2e/d2/IFgP8UxN_o.jpg" alt="在这里插入图片描述"></p> 
<p>用Long（数值效率比字符串高）类型，一个Long类型占64位（Java中），我们可以在这些bit位上做文章。</p> 
<p>首先：从左数第一位，是符号位，我们的id永远为正数，所以让它永远为0。接下来的31位，用来存时间戳，保证安全性的同时，让id基本不可能重复。最后的32位，我们存普通的递增值。这个方案，理论上可以保证68年都不会有id重复。</p> 
<p>为了避免最后的自增值超出redis自增限制，我们可以每天新建一个key用于自增（例如，yyyy:MM:dd），不仅解决了问题，还方便统计。</p> 
<p>实现：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisIdWorker</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>
    <span class="token comment">// 起始的时间戳值</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Long</span> <span class="token constant">BEGIN_TIMESTAMP</span> <span class="token operator">=</span> <span class="token number">1640995200L</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">RedisIdWorker</span> <span class="token punctuation">(</span><span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>stringRedisTemplate <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
    * @param “业务key前缀“
    * */</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">nextId</span><span class="token punctuation">(</span><span class="token class-name">String</span> keyPrefix<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">LocalDateTime</span> now <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span>  nowSecond <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">toEpochSecond</span><span class="token punctuation">(</span><span class="token class-name">ZoneOffset</span><span class="token punctuation">.</span><span class="token constant">UTC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> timestamp <span class="token operator">=</span> nowSecond <span class="token operator">-</span> <span class="token constant">BEGIN_TIMESTAMP</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> data <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">"yyyy:MM:dd"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> count <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token string">"incr:"</span> <span class="token operator">+</span> keyPrefix <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 位运算提高效率</span>
        <span class="token keyword">return</span> timestamp <span class="token operator">&lt;&lt;</span> <span class="token number">32</span> <span class="token operator">|</span> count<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>起始的时间戳的值可以这样计算：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">timeTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">LocalDateTime</span> time <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">2022</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> epochSecond <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">toEpochSecond</span><span class="token punctuation">(</span><span class="token class-name">ZoneOffset</span><span class="token punctuation">.</span><span class="token constant">UTC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>epochSecond<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>测试：</p> 
<pre><code class="prism language-java"><span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">idTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">CountDownLatch</span> latch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Runnable</span> task <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            redisIdWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token string">"order"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">300</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        executorService<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 必须阻塞 如果不阻塞，则程序结束时，我们的任务还没有结束</span>
    latch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> end <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>end <span class="token operator">-</span> begin<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>收获的小技巧：</p> 
<ol><li> <p>LocalDateTime的使用</p> <pre><code class="prism language-java"><span class="token comment">// 使用of可以快速获取指定时间的LocalDateTime对象</span>
<span class="token class-name">LocalDateTime</span> time <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">2022</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 使用toEpochSecond可以快速获取相应时间的时间戳</span>
<span class="token keyword">long</span> epochSecond <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">toEpochSecond</span><span class="token punctuation">(</span><span class="token class-name">ZoneOffset</span><span class="token punctuation">.</span><span class="token constant">UTC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 使用format方法快速格式化时间</span>
<span class="token class-name">LocalDateTime</span> now <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> data <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">"yyyy:MM:dd"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> </li><li> <p>并发包的小技巧</p> <pre><code class="prism language-java"><span class="token comment">// 快速创建线程池，但是阿里的Java开发规范不建议这样做</span>
<span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 快速创建一个任务，使用lambda表达式</span>
<span class="token class-name">Runnable</span> task <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
    ……
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 提交任务</span>
executorService<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> </li><li> <p>位运算</p> <p>更好的利用bit位来处理信息</p> </li></ol> 
<h4><a id="_132"></a>小结</h4> 
<p><img src="https://images2.imgbox.com/80/5c/LXLgtTqf_o.jpg" alt="在这里插入图片描述"></p> 
<p>uuid效率较低，且不满足自增性。</p> 
<p>Redis自增，就是刚刚的方案，很常用。</p> 
<p>雪花算法，类似于刚刚的方案，区别在于雪花算法的最后32位是以机器时间为基准，Redis是自增。</p> 
<p>数据库自增，也就是数据库版本的Redis方案，效率不如Redis。</p> 
<h3><a id="_145"></a>二、实现优惠券秒杀下单</h3> 
<p><img src="https://images2.imgbox.com/32/40/kJY8DGhP_o.png" alt=""></p> 
<p>按照流程图，实现非常简单，但会出现非常多的问题（详见后文）。</p> 
<p>小收获：</p> 
<p>使用lambdaUpdate</p> 
<pre><code class="prism language-java"><span class="token comment">// 减库存操作</span>
<span class="token function">lambdaUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">"stock = stock -1"</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">SeckillVoucher</span><span class="token operator">::</span><span class="token function">getVoucherId</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="_165"></a>三、超卖问题</h3> 
<h4><a id="31__167"></a>3.1 问题描述</h4> 
<p>在刚刚的流程中，是有很多问题隐患的，比如，经典的<strong>超卖问题</strong>。</p> 
<p>在并发量较高的情况下，假如剩余最后一张票，在购买最后一张票的线程还未扣减库存时，其他线程进入，查询库存，都会查到还有余票的结果，此时再进行库存判断，并扣减库存，就会发生超卖。</p> 
<p><img src="https://images2.imgbox.com/6c/fe/3qsw4SaV_o.png" alt="在这里插入图片描述"></p> 
<p>如何解决超卖问题？</p> 
<p>最简单的方法就是上锁，同一时间只让一个线程去执行查库存-&gt;扣减库存的操作。</p> 
<h4><a id="32__182"></a>3.2 乐观锁和悲观锁</h4> 
<p>加锁的话有两种锁可以加：</p> 
<p>悲观锁：比较悲观，认为线程安全问题一定会发生，因此操作数据前先获取锁，确保线程串行执行。（如synchronized、Lock）</p> 
<p>乐观锁：比较乐观，认为线程安全问题不一定发生，所以不加锁，而是在更新数据时去判断数据有没有被其他线程修改。若没有则更新，反之重试或异常。</p> 
<h4><a id="33__192"></a>3.3 乐观锁实现</h4> 
<p>悲观锁的解决方案较为简单，即在可能出问题的代码上加synchronized或Lock锁住。我们介绍一下乐观锁的解决方案：</p> 
<p>常见两种方法：</p> 
<h5><a id="331__198"></a>3.3.1 版本号法</h5> 
<p>每次更新数据时，更新版本号，并判断版本号是否被修改。</p> 
<p><img src="https://images2.imgbox.com/6d/92/ufHsV4BL_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="332_CASCompare_And_Swap_205"></a>3.3.2 CAS（Compare And Swap）</h5> 
<p>以数据本身为版本号</p> 
<p><img src="https://images2.imgbox.com/0e/3c/PXnI1W7U_o.png" alt=""></p> 
<h4><a id="34__214"></a>3.4 小结</h4> 
<p>秒杀场景下，悲观锁性能较差，乐观锁成功率较低。</p> 
<p>小优化：更新库存时，不用判断库存是否和查询到的库存相同，只需要库存大于零即可，这样成功率大大提高。</p> 
<p><img src="https://images2.imgbox.com/99/69/QXjODSfs_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_225"></a>四、一人一单</h3> 
<h4><a id="41__227"></a>4.1 添加功能</h4> 
<p>某些业务我们需要用户只能购买一单，于是我们多加一个用户是否已经购买的判断：</p> 
<p><img src="https://images2.imgbox.com/a2/71/pPd6T4H8_o.png" alt="在这里插入图片描述"></p> 
<p>从ThreadLocal中取出当前用户的id，根据用户和商品id查询用户是否已经有订单存在，若存在则失败。</p> 
<p><img src="https://images2.imgbox.com/2a/de/nxf1VPU1_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="42__238"></a>4.2 并发问题</h4> 
<p>按照刚刚的业务流程，正常用户单线程操作的情况下是没有问题的，但是若是恶意用户，同时开多个线程访问我们的接口，则可能出现这样一种情况：</p> 
<p>若多个线程同时进入该方法，在任一线程未保存订单前，都进行查询用户是否下单，得到的count都是0，拿到这个0后，再去判断是否一人一单则都会成功，都会下单，造成了一人多单的问题。</p> 
<p>解决：给该方法加锁，因为涉及两个表的写操作，我们添加事务。</p> 
<p><img src="https://images2.imgbox.com/c7/2e/sFtq8Kjg_o.png" alt="在这里插入图片描述"></p> 
<p>写完过后以看，这不成了悲观锁嘛！里面的乐观锁还拿来干嘛呢？</p> 
<p>经过思考：我们只需要限制单个用户的并发操作，只需要锁住userId即可，于是我们不再锁整个方法。</p> 
<p>该方法改进为：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">createVoucherOrder</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Long</span> userid <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span><span class="token punctuation">(</span>userid<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="43__267"></a>4.3 字符串问题</h4> 
<p>接着我们会发现锁不住，因为我们toString方法会创建一个新的字符串，不同的线程的userid.toString()出来的字符串不是同一个对象。</p> 
<p>解决：使用intern方法</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">createVoucherOrder</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Long</span> userid <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span><span class="token punctuation">(</span>userid<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>使用intern方法，该方法会从JVM常量池中找equals为true的字符串，意味着不同的线程都是同一个字符串。</p> 
<h4><a id="44_Spring_287"></a>4.4 Spring事务问题</h4> 
<p>spring的声明式事务是基于AOP实现的，意味着方法结束后才会提交事务。</p> 
<h5><a id="441__293"></a>4.4.1 锁在事务内</h5> 
<p>当synchronized在该方法内时，会出现这么一种情况：锁释放了，但事务未提交，事务未提交时，下一个线程进来，读到的是数据库未修改的快照，仍然会发生一人多单的问题，所以我们要在调用该方法处添加锁，或是使用编程式事务。</p> 
<pre><code class="prism language-java"><span class="token keyword">synchronized</span> <span class="token punctuation">(</span>userid<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token function">createVoucherOrder</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="442__305"></a>4.4.2 事务不生效</h5> 
<p>正是因为spring事务是通过aop实现，而aop是通过动态代理实现。当我们直接调用该方法时，默认是this.createVoucherOrder(voucherId)，使用的是this调用，而不是使用代理对象来调用，只有通过代理对象来调用，事务才会生效。</p> 
<ol><li> <p>引入依赖</p> <pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.aspectj<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>aspectjweaver<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> </li><li> <p>暴露代理对象</p> <p>启动类上添加@EnableAspectJAutoProxy(exposeProxy = true)注解</p> <pre><code class="prism language-java"><span class="token annotation punctuation">@MapperScan</span><span class="token punctuation">(</span><span class="token string">"com.hmdp.mapper"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableAspectJAutoProxy</span><span class="token punctuation">(</span>exposeProxy <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HmDianPingApplication</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">HmDianPingApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p>获取代理对象，并使用代理对象调用方法</p> <pre><code class="prism language-java"><span class="token keyword">synchronized</span> <span class="token punctuation">(</span>userid<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 确保事务生效</span>
	<span class="token class-name">IVoucherOrderService</span> proxy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IVoucherOrderService</span><span class="token punctuation">)</span> <span class="token class-name">AopContext</span><span class="token punctuation">.</span><span class="token function">currentProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	proxy<span class="token punctuation">.</span><span class="token function">createVoucherOrder</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> </li></ol> 
<h4><a id="45__345"></a>4.5 集群模式下的一人一单问题</h4> 
<p>通过刚刚的几波操作，可以说是基本解决了单机部署情况下的一人一单问题，若是集群部署，仍然会有问题。</p> 
<p>可以开两个服务debug一下：</p> 
<p>（小坑：Intellij Idea 2022.3.1版本，断点调试打断点后，需要等待断点上的“√”出现才能启动服务，不然断点无效，多个服务建议多选并同时启动，不然要等上一个服务启动到“√”出现才能启动下一个服务。）</p> 
<p><img src="https://images2.imgbox.com/11/32/As13QTGa_o.png" alt="在这里插入图片描述"></p> 
<p>我们的 锁 锁的是userid，锁的是jvm常量池中的userid字符串。若是多个jvm，不是同一个常量池，自然就锁不住了。</p> 
<h3><a id="_360"></a>五、分布式锁</h3> 
<p>解决集群情况下的并发问题，则需要一个多个进程能都使用的锁。</p> 
<h4><a id="51__364"></a>5.1 分布式锁概述</h4> 
<p>分布式锁：满足分布式系统或集群模式下多进程可见并互斥的锁。</p> 
<p><img src="https://images2.imgbox.com/95/1e/lPaDKaEL_o.png" alt="在这里插入图片描述"></p> 
<p>分布式锁可以借助第三方中间件简单的实现：</p> 
<p><img src="https://images2.imgbox.com/8c/d1/pwKEZBwm_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="52_redis_375"></a>5.2 基于redis实现分布式锁</h4> 
<p>通过redis的setnx命令可以轻松实现简单的互斥锁，因为redis是单线程的，不会存在并发问题。</p> 
<p><img src="https://images2.imgbox.com/1a/fc/lKe2eOEv_o.png" alt="在这里插入图片描述"></p> 
<p>通过set key value nx ex 10 来保证原子性，防止在设置ttl值前宕机，发生死锁。这是一种非阻塞的锁，拿不到锁立即返回false，没有重试机制。</p> 
<h5><a id="521__383"></a>5.2.1 锁误删</h5> 
<p>若只是简单的使用setnx和del来获取和释放锁，则会出现一些问题，例如，拿到锁的线程业务阻塞了，它的锁超时释放了，此时另一个线程拿到锁，在另一个线程还未释放锁时，它的业务完成，并删掉了另一个线程的锁。这样一来，第三个线程又能拿到锁。</p> 
<p><img src="https://images2.imgbox.com/56/33/2OkRfj5U_o.png" alt="在这里插入图片描述"></p> 
<p>所以我们需要有一种机制，防止锁的误删：</p> 
<p><img src="https://images2.imgbox.com/4c/78/yMikUtA6_o.png" alt="在这里插入图片描述"></p> 
<p>在释放锁时，再判断一下锁是否是自己的。</p> 
<p>具体方案：在设置该锁的value时，我们使用threadid，因为在多个JVM中，threadid有可能相同，于是我们在threadid前拼接一个UUID。这样就保证了误删锁的情况不会再发生。</p> 
<h5><a id="522_Lua_399"></a>5.2.2 Lua脚本保证命令原子性</h5> 
<p>避免锁的误删后，我们的分布式锁就比较健壮了。但在某些极端场景下，仍会出现误删问题：</p> 
<p>在释放锁时，会先判断是否是当前的锁（在redis中获取该锁的value），此时，因为一些原因（如GC）阻塞了，下一个线程拿到锁，此时阻塞结束，由于已经做过判断，上一个线程会把下一个线程拿到的锁误删，此时第三个线程又能拿到锁了。</p> 
<p><img src="https://images2.imgbox.com/7a/32/A2aExBiC_o.png" alt="在这里插入图片描述"></p> 
<p>解决方案：将判断和释放锁封装成一个原子操作。</p> 
<p>使用Lua脚本可以完美解决这个问题。</p> 
<p>在lua脚本中，可以直接使用redis.call()方法来编写redis命令，在redis中使用EVAL调用。有如下好处：</p> 
<ol><li>减少网络开销。可以将多个请求通过脚本的形式一次发送，减少网络时延。</li><li>原子操作。Redis会将整个脚本作为一个整体执行，中间不会被其他请求插入。因此在脚本运行过程中无需担心会出现竞态条件，无需使用事务。</li><li>复用。客户端发送的脚本会永久存在redis中，这样其他客户端可以复用这一脚本，而不需要使用代码完成相同的逻辑。</li></ol> 
<p><img src="https://images2.imgbox.com/53/c5/N9Y1HUmH_o.png" alt="在这里插入图片描述"></p> 
<p>注意：lua语言中，数组下标是从1开始。</p> 
<p>了解lua脚本后，我们就可以开始编写lua脚本了。</p> 
<p><img src="https://images2.imgbox.com/c7/c9/k2c2DSC3_o.png" alt="在这里插入图片描述"></p> 
<p>根据需求：</p> 
<p><img src="https://images2.imgbox.com/00/07/45CFZA6V_o.png" alt="在这里插入图片描述"></p> 
<p>简写：</p> 
<p><img src="https://images2.imgbox.com/04/fb/rLGnBci7_o.png" alt="在这里插入图片描述"></p> 
<p>接下来就是使用Java的redis客户端嗲用Lua脚本：</p> 
<p>使用execute方法：</p> 
<p><img src="https://images2.imgbox.com/73/28/4dX31w8L_o.png" alt="在这里插入图片描述"></p> 
<p>于是，我们写出了简单且健壮的分布式锁：</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>hmdp<span class="token punctuation">.</span>utils</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span><span class="token class-name">UUID</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">BooleanUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ClassPathResource</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">StringRedisTemplate</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span>script<span class="token punctuation">.</span></span><span class="token class-name">DefaultRedisScript</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collections</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleRedisLock</span> <span class="token keyword">implements</span> <span class="token class-name">ILock</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>
	<span class="token comment">// Lua脚本</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token constant">UNLOCK_SCRIPT</span><span class="token punctuation">;</span>
    <span class="token comment">// 锁的名字 key一般为业务名</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> key<span class="token punctuation">;</span>
	<span class="token comment">// 锁前缀</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">KEY_PREFIX</span> <span class="token operator">=</span> <span class="token string">"lock:"</span><span class="token punctuation">;</span>
    <span class="token comment">// 该区分不同的JVM</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ID_PREFIX</span> <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token comment">// 初始化Lua脚本</span>
    <span class="token keyword">static</span> <span class="token punctuation">{<!-- --></span>
        <span class="token constant">UNLOCK_SCRIPT</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">UNLOCK_SCRIPT</span><span class="token punctuation">.</span><span class="token function">setLocation</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span><span class="token string">"unlock.lua"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">UNLOCK_SCRIPT</span><span class="token punctuation">.</span><span class="token function">setResultType</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	
    <span class="token comment">// 初始化key</span>
    <span class="token keyword">public</span> <span class="token class-name">SimpleRedisLock</span><span class="token punctuation">(</span><span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>stringRedisTemplate <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> <span class="token constant">KEY_PREFIX</span> <span class="token operator">+</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @param timeoutSec 锁持有的时长 过期自动释放 
     * @return
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeoutSec<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> threadId <span class="token operator">=</span> <span class="token constant">ID_PREFIX</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Boolean</span> success <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> threadId <span class="token operator">+</span> <span class="token string">""</span><span class="token punctuation">,</span> timeoutSec<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">BooleanUtil</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 释放锁
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token constant">UNLOCK_SCRIPT</span><span class="token punctuation">,</span>
                <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token constant">ID_PREFIX</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="53__507"></a>5.3 小结</h4> 
<p><img src="https://images2.imgbox.com/80/37/NN9o5da8_o.png" alt="在这里插入图片描述"></p> 
<p>编码收获：</p> 
<ol><li>读取文件，若该文件是不变的，则在static代码块中初始化一次就好了。</li><li>ClassPathResource()类快速获取Resource目录下的资源。</li></ol> 
<h3><a id="Redisson_519"></a>六、Redisson</h3> 
<p>现在我们基于String类型的setnx实现的分布式锁已经足够健壮，但仍有不足：</p> 
<p><img src="https://images2.imgbox.com/cb/10/wZcNBweV_o.png" alt="在这里插入图片描述"></p> 
<p>要解决这些问题，我们的基础版redis分布式锁就不好发力了。</p> 
<p>但Redisson轻松解决：</p> 
<p><img src="https://images2.imgbox.com/b2/59/SdE3NFMg_o.png" alt="在这里插入图片描述"></p> 
<p>Redisson中不仅有分布式锁，分布式锁只是它的一个子集 。</p> 
<h4><a id="61_Redisson_535"></a>6.1 使用Redisson分布式锁</h4> 
<ol><li> <p>引依赖</p> <pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.19.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> </li><li> <p>配置</p> <p>如果使用yaml来配置，则会将redis的配置覆盖。我们使用redisson只是作为分布式锁使用，所以单独配置：</p> <pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedissonConfig</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RedissonClient</span> <span class="token function">redissonClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 单点配置，也可以用useClusterServers添加集群地址</span>
        config<span class="token punctuation">.</span><span class="token function">useSingleServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token string">"redis://192.168.0.122:6379"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Redisson</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p>使用</p> <pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleVoucherOrder</span><span class="token punctuation">(</span><span class="token class-name">VoucherOrder</span> voucherOrder<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Long</span> userid <span class="token operator">=</span> voucherOrder<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建锁对象</span>
    <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">"order:"</span> <span class="token operator">+</span> userid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 尝试获取锁</span>
    <span class="token keyword">boolean</span> isLock <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 是否拿到锁</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"不能重复下单！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        proxy<span class="token punctuation">.</span><span class="token function">createVoucherOrder</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <p>非常简单。</p> <p>也可以携带参数</p> </li></ol> 
<p><img src="https://images2.imgbox.com/df/f4/1Bk9fG2B_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="62_Redisson_592"></a>6.2 Redisson分布式锁原理</h4> 
<p>redisson的分布式锁是如何解决这四个问题？</p> 
<p><img src="https://images2.imgbox.com/ee/cc/4e1po9zm_o.png" alt=""></p> 
<h5><a id="621__599"></a>6.2.1 可重入原理</h5> 
<p>我们的基础版锁是不可重入的</p> 
<p><img src="https://images2.imgbox.com/84/7a/Wb6Gqq3k_o.png" alt=""></p> 
<p>redisson使用Hash结构轻松解决了这个问题</p> 
<p><img src="https://images2.imgbox.com/d2/a3/fojHg5HQ_o.png" alt="在这里插入图片描述"></p> 
<p>每重入一次，value+1，每次释放锁，value-1，value为0，则释放锁。非常巧妙</p> 
<p>其底层都是lua脚本，保证命令原子性：</p> 
<p>获取锁：</p> 
<p><img src="https://images2.imgbox.com/5d/69/TwMJabui_o.png" alt="在这里插入图片描述"></p> 
<p>释放锁：</p> 
<p><img src="https://images2.imgbox.com/c3/46/wIz5nPD6_o.png" alt="在这里插入图片描述"></p> 
<p>源码中lua脚本是写死了放在代码中的，可以去查看，和这些大差不差，释放锁的时候会发布一个释放信号（后文）。</p> 
<h5><a id="622__627"></a>6.2.2 可重试原理</h5> 
<p>我们基础版的redis是一个非阻塞式的锁，没有任何重试机制。redisson用PubSub模式解决了这个问题。</p> 
<p>我们从redis源码中探究：</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 参数分别是等待时间，锁ttl，时间单位。我们不指定ttl时，默认为-1。  
 **/</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> waitTime<span class="token punctuation">,</span> <span class="token keyword">long</span> leaseTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">long</span> time <span class="token operator">=</span> unit<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> current <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> threadId <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 执行获取锁的方法，会返回锁的ttl，获取锁失败会返回null</span>
    <span class="token class-name">Long</span> ttl <span class="token operator">=</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> leaseTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 成功获取锁</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ttl <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// 获取失败，准备重试，先检查重试等待时间是否还有剩余</span>
    time <span class="token operator">-=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> current<span class="token punctuation">;</span>
    <span class="token comment">// 过期，获取锁失败，返回false</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">acquireFailed</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// 还可以重试，准备重试</span>
    current <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 订阅锁的释放信号</span>
    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RedissonLockEntry</span><span class="token punctuation">&gt;</span></span> subscribeFuture <span class="token operator">=</span> <span class="token function">subscribe</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 等待锁释放，获取信号</span>
        subscribeFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 超时 失败</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TimeoutException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>subscribeFuture<span class="token punctuation">.</span><span class="token function">completeExceptionally</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RedisTimeoutException</span><span class="token punctuation">(</span>
            <span class="token string">"Unable to acquire subscription lock after "</span> <span class="token operator">+</span> time <span class="token operator">+</span> <span class="token string">"ms. "</span> <span class="token operator">+</span>
            <span class="token string">"Try to increase 'subscriptionsPerConnection' and/or 'subscriptionConnectionPoolSize' parameters."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            subscribeFuture<span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> ex<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ex <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">unsubscribe</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">acquireFailed</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">// 异常 失败</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ExecutionException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">acquireFailed</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// 获取锁释放信号成功</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 再次判断等待时间是否过期</span>
        time <span class="token operator">-=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> current<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">acquireFailed</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token comment">// 没有过期 尝试获取锁</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">long</span> currentTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ttl <span class="token operator">=</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> leaseTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 获取锁成功</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ttl <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
			<span class="token comment">// 失败 检查等待时间是否过期</span>
            time <span class="token operator">-=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> currentTime<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">acquireFailed</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 未过期 准备重试 </span>
            currentTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 等待释放锁的信号</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ttl <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> ttl <span class="token operator">&lt;</span> time<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                commandExecutor<span class="token punctuation">.</span><span class="token function">getNow</span><span class="token punctuation">(</span>subscribeFuture<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span>ttl<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                commandExecutor<span class="token punctuation">.</span><span class="token function">getNow</span><span class="token punctuation">(</span>subscribeFuture<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span>time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
			<span class="token comment">// 获得锁释放信号 再次检查等待时间</span>
            time <span class="token operator">-=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> currentTime<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">acquireFailed</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 无论获取锁成功或失败，都要解除订阅</span>
        <span class="token function">unsubscribe</span><span class="token punctuation">(</span>commandExecutor<span class="token punctuation">.</span><span class="token function">getNow</span><span class="token punctuation">(</span>subscribeFuture<span class="token punctuation">)</span><span class="token punctuation">,</span> threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//        return get(tryLockAsync(waitTime, leaseTime, unit));</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>相比我们基础版redis分布式锁，有很多优点，例如：</p> 
<ul><li>重试并不是无休止的重试，而是使用发布订阅模式，等待一个锁的释放信号再去重试，节约内存，性能。</li><li>非常严谨，每次获取锁前，都要先判断重试等待时间是否过期。</li></ul> 
<h5><a id="623__731"></a>6.2.3 解决超时释放</h5> 
<p>虽然锁超时释放可以解决业务异常带来的死锁问题，但是业务超时引发的自动释放也会产生线程安全问题。redisson使用看门狗机制解决了这个问题。</p> 
<p>从redis源码中探究：</p> 
<p>首先看获取锁的源码</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">tryAcquireAsync</span><span class="token punctuation">(</span><span class="token keyword">long</span> waitTime<span class="token punctuation">,</span> <span class="token keyword">long</span> leaseTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span> <span class="token keyword">long</span> threadId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 参数和之前一致</span>
    <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> ttlRemainingFuture<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>leaseTime <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ttlRemainingFuture <span class="token operator">=</span> <span class="token function">tryLockInnerAsync</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> leaseTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> threadId<span class="token punctuation">,</span> <span class="token class-name">RedisCommands</span><span class="token punctuation">.</span><span class="token constant">EVAL_LONG</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 默认情况 leaseTime为 -1 ，这个时候，redisson使用了一个变量internalLockLeaseTime，实际上是30 * 1000毫秒，也就是30秒</span>
        <span class="token comment">// 该方法会执行lua脚本，尝试获取锁，若获取成功，返回null，获取失败，返回ttl</span>
        ttlRemainingFuture <span class="token operator">=</span> <span class="token function">tryLockInnerAsync</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> internalLockLeaseTime<span class="token punctuation">,</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">,</span> threadId<span class="token punctuation">,</span> <span class="token class-name">RedisCommands</span><span class="token punctuation">.</span><span class="token constant">EVAL_LONG</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">CompletionStage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> f <span class="token operator">=</span> ttlRemainingFuture<span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span>ttlRemaining <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 判断是否获取成功</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ttlRemaining <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 获取成功 刚才提到 默认情况下，leaseTime为 -1 所以这里走else分支</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>leaseTime <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                internalLockLeaseTime <span class="token operator">=</span> unit<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span>leaseTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 续约 该方法就是解决超时释放的关键</span>
                <span class="token function">scheduleExpirationRenewal</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 返回lua脚本返回的ttl或是nil</span>
        <span class="token keyword">return</span> ttlRemaining<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CompletableFutureWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>再来看最关键的续约的方法</p> 
<pre><code class="prism language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">scheduleExpirationRenewal</span><span class="token punctuation">(</span><span class="token keyword">long</span> threadId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 用来存线程对应的锁</span>
    <span class="token class-name">ExpirationEntry</span> entry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExpirationEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果是重入的锁，则无法放入这个map，放入这个map的锁才有资格续约，会获取一个旧的entry，意思就是每一把锁在这个map中有且仅有一条记录</span>
    <span class="token class-name">ExpirationEntry</span> oldEntry <span class="token operator">=</span> <span class="token constant">EXPIRATION_RENEWAL_MAP</span><span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span><span class="token function">getEntryName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 判断是否是重入的锁</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEntry <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 是重入的锁，只做记录</span>
        oldEntry<span class="token punctuation">.</span><span class="token function">addThreadId</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 不是重入的锁，记录并开始续约任务</span>
        entry<span class="token punctuation">.</span><span class="token function">addThreadId</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 续约 核心方法</span>
            <span class="token function">renewExpiration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 线程终止，取消续约任务</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">cancelExpirationRenewal</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>看看redisson是如何巧妙地续约的：</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">renewExpiration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 获取当前锁的信息</span>
    <span class="token class-name">ExpirationEntry</span> ee <span class="token operator">=</span> <span class="token constant">EXPIRATION_RENEWAL_MAP</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token function">getEntryName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 没有记录 不用续约</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ee <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
   	<span class="token comment">// 定时任务续约</span>
    <span class="token class-name">Timeout</span> task <span class="token operator">=</span> commandExecutor<span class="token punctuation">.</span><span class="token function">getConnectionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newTimeout</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TimerTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Timeout</span> timeout<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 检查是否需要续约</span>
            <span class="token class-name">ExpirationEntry</span> ent <span class="token operator">=</span> <span class="token constant">EXPIRATION_RENEWAL_MAP</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token function">getEntryName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ent <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">Long</span> threadId <span class="token operator">=</span> ent<span class="token punctuation">.</span><span class="token function">getFirstThreadId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>threadId <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 执行lua脚本续约，每次执行，都会重置有效期为30秒，续约成功返回ture 续约失败返回false</span>
            <span class="token class-name">CompletionStage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> <span class="token function">renewExpirationAsync</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            future<span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 异常 移除续约map</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Can't update lock {} expiration"</span><span class="token punctuation">,</span> <span class="token function">getRawName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token constant">EXPIRATION_RENEWAL_MAP</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token function">getEntryName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 续约成功 继续续约</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">renewExpiration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 失败 取消定时任务 可以通过EXPIRATION_RENEWAL_MAP.get(getEntryName())快速获取定时任务并取消掉</span>
                    <span class="token function">cancelExpirationRenewal</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 每隔10秒重置一次</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> internalLockLeaseTime <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    ee<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>redisson相比我们的基础版redis，利用看门狗机制，解决了因为业务阻塞而导致锁超时释放的安全问题。有以下优点：</p> 
<ul><li>维护一个可以存锁信息和定时任务的EXPIRATION_RENEWAL_MAP，可以快速的找到对应的锁，进行续约或是取消续约操作。</li><li>每10秒钟重置一次，若业务没有完成就无限重置，不会因为业务阻塞而超时释放，若是业务异常或宕机，则会马上取消掉定时任务，让锁超时释放，避免导致死锁。</li></ul> 
<h5><a id="624__855"></a>6.2.4 保证主从一致</h5> 
<p>普通redis分布式锁：</p> 
<p><img src="https://images2.imgbox.com/a3/b2/inX7u7FR_o.png" alt="在这里插入图片描述"></p> 
<p>假如在未同步时，主节点故障，从节点成为主节点后，数据不一致，锁丢失了，有线程安全隐患。</p> 
<p>相比普通的redis分布式锁，redisson是如何保证主从一致性的呢？</p> 
<p>redisson让每一个redis都是主节点 ，并在这些节点后面跟上从节点</p> 
<p><img src="https://images2.imgbox.com/f5/18/bLYYjCLi_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/2e/e7/accCW1xL_o.png" alt="在这里插入图片描述"></p> 
<p>即使某个节点宕机，造成了数据不一致，锁也不会失效，因为redisson的连锁，需要在每一个节点上都能获取锁，才算成功。</p> 
<h5><a id="625__875"></a>6.2.5 小结</h5> 
<p>单体redisson原理：</p> 
<p><img src="https://images2.imgbox.com/68/d1/6d2uvcJR_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/ae/fb/Tag5Zgf9_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/b4/83/FxkmZzlH_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="redis_890"></a>七、redis优化秒杀</h3> 
<p>之前的业务流程，我们是按顺序同步执行的，其中包含了很多数据库的读写操作，并且还花了很多时间来保证线程安全，现在我们使用lua脚本保证一部分的线程安全（例如超卖问题就不用考虑了），再用java的阻塞队列来让耗时操作异步执行。</p> 
<p><img src="https://images2.imgbox.com/c1/63/WKnebtxa_o.png" alt="在这里插入图片描述"></p> 
<p>redis执行lua脚本是单线程的，所以线程安全。</p> 
<p>我们需要做几件事：</p> 
<ul><li>新增秒杀优惠券的同时，将优惠券库存存入redis。</li><li>利用lua脚本判断库存，一人一单。</li><li>如果有购买资格，则生成订单id返回，并将用户id等订单信息传入阻塞队列。</li><li>开启线程任务，不断从阻塞队列中获取信息，操作数据库，保存订单。</li></ul> 
<p>做完后，会有一些问题：</p> 
<p><img src="https://images2.imgbox.com/d6/53/zDCmZhMz_o.png" alt="在这里插入图片描述"></p> 
<p>由于阻塞队列是javautil包下的，占用的是jvm的内存，会受jvm内存的限制。</p> 
<p>当阻塞队列中还有未处理订单，或是处理订单异常等订单丢失的情况时，会导致数据不一致。</p> 
<h3><a id="Redis_917"></a>八、Redis消息队列实现异步秒杀</h3> 
<p>为了解决以上问题，我们引入第三方的消息队列。好处就是不会受JVM内存限制。当然redis消息队列不好玩，一般都是用专门的mq中间件（rabbitmq，rocketmq，kafka等）。</p> 
<p>redis提供了三种不同的实现消息队列的方式：</p> 
<ol><li>list：基于list结构模拟消息队列。</li><li>PubSub：发布订阅模式，基本的点对点消息模型。</li><li>stream：比较完善的消息队列模型。（功能强大但复杂的一批）</li></ol> 
<p><img src="https://images2.imgbox.com/4a/92/LrqDBbVT_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="81_List_929"></a>8.1 基于List结构模拟消息队列</h4> 
<p>就是利用LPUSH、RPOP这些命令，只要出入口不一致即可。但要模拟阻塞队列，就需要LPUSH、BRPOP这些阻塞的命令了。</p> 
<h4><a id="82_PubSub_935"></a>8.2 PubSub发布订阅模式</h4> 
<p><img src="https://images2.imgbox.com/e2/0c/5iDJQHO4_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/49/f6/bqBbuizU_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="83_Stream_943"></a>8.3 基于Stream结构的消息队列</h4> 
<h5><a id="831__945"></a>8.3.1 基本使用</h5> 
<p>发消息：</p> 
<p><img src="https://images2.imgbox.com/62/80/gEY7ZMWW_o.png" alt="在这里插入图片描述"></p> 
<p>读消息：</p> 
<p><img src="https://images2.imgbox.com/fe/bf/2lh4cFMM_o.png" alt=""></p> 
<p>阻塞地读消息：</p> 
<p><img src="https://images2.imgbox.com/fe/f3/pHUyukyj_o.png" alt="在这里插入图片描述"></p> 
<p>这就是stream结构地基本使用。</p> 
<p>问题：</p> 
<p>我们是使用ID来指定读取地消息，当ID为0时，代表从第一个消息开始读，当ID为“$”时，代表读取最新消息，若在处理某条消息时，有n（n&gt;1）条消息进入队列，当那条消息处理完，下次读取只会读取最新地一条，会漏掉中间地消息，造成消息漏读。</p> 
<p><img src="https://images2.imgbox.com/3f/86/JWLd9cQo_o.png" alt=""></p> 
<h5><a id="832__973"></a>8.3.2 消费者组</h5> 
<p><img src="https://images2.imgbox.com/7b/6f/HWvexMiU_o.png" alt="在这里插入图片描述"></p> 
<p>消费者组不仅可以加快消息地处理速度，还有一定的数据保护措施。但不得不吐槽，真的麻烦，想要保证数据安全，有时候不得不手动ACK。</p> 
<p>创建消费者组：</p> 
<p><img src="https://images2.imgbox.com/9b/85/u1Lw7IJ4_o.png" alt="在这里插入图片描述"></p> 
<p>读消息：</p> 
<p><img src="https://images2.imgbox.com/0b/00/lDmm7frE_o.png" alt="在这里插入图片描述"></p> 
<p>这里比较特别的是ID可以取值为“&gt;”。</p> 
<h5><a id="833__991"></a>8.3.3 改造秒杀业务</h5> 
<pre><code class="prism language-java"><span class="token comment">// 在类初始化完毕后，就开始监听队列</span>
<span class="token annotation punctuation">@PostConstruct</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Runnable</span> task <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> queueName <span class="token operator">=</span> <span class="token string">"stream.orders"</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 1. 获取消息队列中的订单消息</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MapRecord</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>
                    <span class="token class-name">Consumer</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"g1"</span><span class="token punctuation">,</span> <span class="token string">"c1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token class-name">StreamReadOptions</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">block</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token class-name">StreamOffset</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> <span class="token class-name">ReadOffset</span><span class="token punctuation">.</span><span class="token function">lastConsumed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 2. 判断消息是否获取成功</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>list <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> list<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 2.1 获取失败 下一轮循环</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 获取消息</span>
                <span class="token class-name">MapRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> record <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> value <span class="token operator">=</span> record<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">fillBeanWithMap</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 3. 获取成功 下单</span>
                <span class="token function">handleVoucherOrder</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 4. ACK确认</span>
                stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">acknowledge</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> <span class="token string">"g1"</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"处理消息异常"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 异常，从pending-list中取出消息重试</span>
                <span class="token function">handlePendingList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token constant">SECKILL_ORDER_EXECUTOR</span><span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>异常消息重试：</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handlePendingList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> queueName <span class="token operator">=</span> <span class="token string">"stream.orders"</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 1. 获取pending-list中的订单消息</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MapRecord</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>
                    <span class="token class-name">Consumer</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"g1"</span><span class="token punctuation">,</span> <span class="token string">"c1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token class-name">StreamReadOptions</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token class-name">StreamOffset</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> <span class="token class-name">ReadOffset</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 2. 判断消息是否获取成功</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>list <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> list<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 2.1 获取失败 下一轮循环</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 获取消息</span>
            <span class="token class-name">MapRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> record <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> value <span class="token operator">=</span> record<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">fillBeanWithMap</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 3. 获取成功 下单</span>
            <span class="token function">handleVoucherOrder</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 4. ACK确认</span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">acknowledge</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> <span class="token string">"g1"</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"处理pending-list消息异常"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="834__1065"></a>8.3.4 小结</h5> 
<p><img src="https://images2.imgbox.com/7e/0a/vJtCWJsM_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d7827276fcd8653cbd27006ca99b4b03/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">黑盒测试的常用方法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/cf8ed802e00d26369d217851e8a749ad/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">CentOS上安装docker-compose</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>