<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Hive--实现随机抽数 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Hive--实现随机抽数" />
<meta property="og:description" content="1.背景 在大规模数据量的数据分析及建模任务中，往往针对全量数据进行挖掘分析时会十分耗时和占用集群资源，因此一般情况下只需要抽取一小部分数据进行分析及建模操作。
Hive提供了数据取样（SAMPLING）的功能，能够根据一定的规则进行数据抽样，目前支持数据块抽样，分桶抽样和随机抽样，具体如下所示：
2.随机方法 1.数据块抽样（tablesample()函数） a.tablesample(n percent) 根据hive表数据的大小按比例抽取数据，并保存到新的hive表中。如：抽取原hive表中10%的数据
b.tablesample(n M) 指定抽样数据的大小，单位为M。
c.tablesample(n rows) 指定抽样数据的行数，其中n代表每个map任务均取n行数据，map数量可通过hive表的简单查询语句确认（关键词：number of mappers: x)
select
*
from bi_gamecenter_dev.dim_date
tablesample(10 percent)
-- 注意：测试过程中发现，select语句不能带where条件且不支持子查询，可通过新建中间表或使用随机抽样解决
2.分桶抽样 hive中分桶其实就是根据某一个字段Hash取模，放入指定数据的桶中，比如将表table_1按照ID分成100个桶，其算法是hash(id) % 100，这样，hash(id) % 100 = 0的数据被放到第一个桶中，hash(id) % 100 = 1的记录被放到第二个桶中。创建分桶表的关键语句为：CLUSTER BY语句。
分桶抽样语法：
TABLESAMPLE (BUCKET x OUT OF y [ON colname])
其中x是要抽样的桶编号，桶编号从1开始，colname表示抽样的列，y表示桶的数量。
例如：将表随机分成10组，抽取其中的第一个桶的数据
select
*
from bi_quickgame.dim_qg_fb_cls
tablesample(bucket 1 out of 10 on rand())
3.随机抽样（rand()函数） 1.使用rand()函数进行随机抽样，limit关键字限制抽样返回的数据，其中rand函数前的distribute和sort关键字可以保证数据在mapper和reducer阶段是随机分布的
-- 每月随机抽取5天
-- 直接关联这个结果就可以了
select
cal_dt
,month_id" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/95fc58aa0e7d4b6bcfeedd6ca74bb677/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-27T16:09:27+08:00" />
<meta property="article:modified_time" content="2022-05-27T16:09:27+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Hive--实现随机抽数</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2 id="hive实现随机-1.背景">1.背景</h2> 
<p>在大规模数据量的数据分析及建模任务中，往往针对全量数据进行挖掘分析时会十分耗时和占用集群资源，因此一般情况下只需要抽取一小部分数据进行分析及建模操作。</p> 
<p>Hive提供了数据取样（SAMPLING）的功能，能够根据一定的规则进行数据抽样，目前支持数据块抽样，分桶抽样和随机抽样，具体如下所示：</p> 
<h2 id="hive实现随机-2.随机方法"><br> 2.随机方法</h2> 
<h3 id="hive实现随机-1.数据块抽样（tablesample()函数）">1.数据块抽样（tablesample()函数）</h3> 
<p>a.tablesample(n percent) 根据hive表数据的大小按比例抽取数据，并保存到新的hive表中。如：抽取原hive表中10%的数据</p> 
<p>b.tablesample(n M) 指定抽样数据的大小，单位为M。</p> 
<p>c.tablesample(n rows) 指定抽样数据的行数，其中n代表每个map任务均取n行数据，map数量可通过hive表的简单查询语句确认（关键词：number of mappers: x)</p> 
<p></p> 
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td> <p><code>select</code></p> <p><code>*</code></p> <p><code>from</code> <code>bi_gamecenter_dev.dim_date</code></p> <p><code>tablesample(10 percent)</code></p> <p><code>-- 注意：测试过程中发现，select语句不能带where条件且不支持子查询，可通过新建中间表或使用随机抽样解决</code></p> </td></tr></tbody></table> 
<p></p> 
<h3 id="hive实现随机-2.分桶抽样">2.分桶抽样</h3> 
<p></p> 
<p>hive中分桶其实就是根据某一个字段Hash取模，放入指定数据的桶中，比如将表table_1按照ID分成100个桶，其算法是hash(id) % 100，这样，hash(id) % 100 = 0的数据被放到第一个桶中，hash(id) % 100 = 1的记录被放到第二个桶中。创建分桶表的关键语句为：CLUSTER BY语句。</p> 
<p></p> 
<p>分桶抽样语法：<br> TABLESAMPLE (BUCKET x OUT OF y [ON colname])<br> 其中x是要抽样的桶编号，桶编号从1开始，colname表示抽样的列，y表示桶的数量。<br> 例如：将表随机分成10组，抽取其中的第一个桶的数据</p> 
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td> <p><code>select</code></p> <p><code>*</code></p> <p><code>from</code> <code>bi_quickgame.dim_qg_fb_cls</code></p> <p><code>tablesample(bucket 1 </code><code>out</code> <code>of</code> <code>10 </code><code>on</code> <code>rand())</code></p> </td></tr></tbody></table> 
<h3 id="hive实现随机-3.随机抽样（rand()函数）"><br> 3.随机抽样（rand()函数）</h3> 
<p>1.使用rand()函数进行随机抽样，limit关键字限制抽样返回的数据，其中rand函数前的distribute和sort关键字可以保证数据在mapper和reducer阶段是随机分布的</p> 
<p></p> 
<p></p> 
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td> <p><code>--  每月随机抽取5天</code></p> <p><code>-- 直接关联这个结果就可以了</code></p> <p><code>select</code></p> <p><code>cal_dt</code></p> <p><code>,month_id</code></p> <p><code>from</code></p> <p><code>(</code></p> <p><code>    </code><code>select</code></p> <p><code>    </code><code>cal_dt</code></p> <p><code>    </code><code>,month_id</code></p> <p><code>    </code><code>,row_number() over(partition </code><code>by</code> <code>month_id </code><code>order</code> <code>by</code> <code>rand_order </code><code>asc</code><code>) </code><code>as</code> <code>row_rank</code></p> <p><code>    </code><code>from</code></p> <p><code>    </code><code>(</code></p> <p><code>        </code><code>select</code></p> <p><code>        </code><code>*</code></p> <p><code>        </code><code>, rand()  </code><code>as</code> <code>rand_order</code></p> <p><code>        </code><code>from</code></p> <p><code>        </code><code>bi_gamecenter_dev.dim_date</code></p> <p><code>        </code><code>where</code></p> <p><code>        </code><code>cal_dt &gt;= </code><code>'2020-01-01'</code></p> <p><code>        </code><code>and</code> <code>cal_dt &lt;= </code><code>'2020-07-19'</code></p> <p><code>    </code><code>)a</code></p> <p><code>)b</code></p> <p><code>where</code></p> <p><code>row_rank &lt;= 5</code></p> </td></tr></tbody></table> 
<p></p> 
<p>2.使用order 关键词</p> 
<p>select * from table_name where col=xxx order by rand() limit num;</p> 
<p>因为order by 只能在一个reduce里面执行，为全局排序，所以可能会导致数据倾斜。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/948aff8bbd3e601031d0328e29729dfc/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">CodeMirror自定义关键词添加class</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f9d03df4e0c184b8a2d4b3aee217e2b7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Ubuntu18.04上下载安装使用sogou输入法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>