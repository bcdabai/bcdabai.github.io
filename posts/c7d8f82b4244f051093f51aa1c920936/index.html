<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>golang入门笔记——Hertz - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="golang入门笔记——Hertz" />
<meta property="og:description" content="文章目录 Hertz介绍应用层路由层协议层传输层HZ脚手架 Hertz的使用一个简单的案例：利用Hertz监听8080端口并编写/ping的get处理函数Hertz和gin一样，提供了分组路由的功能Hertz路由的匹配优先级：静态路由&gt;命名路由&gt;通配路由参数绑定：Bind、Validate、BindAndValidate用于参数绑定和校验中间件HTTP ClientHertz代码生成工具Hertz的一些基本函数 Hertz介绍 Hertz是字节跳动研发的企业级微服务HTTP框架，具有高易用性、易扩展、低时延等特点。是基于自研网络库Netpoll开发的内部框架Hertz。Hertz框架整体上满足：
1.极致性能优化的问题性
2.面对未来不可控需求的扩展能力，Hertz采用了4层分层设计（应用层、路由层、协议层、传输层），保证各个层级功能内聚，同时通过层级之间的接口达到灵活扩展的目标。整体框架如下图：
应用层 主要包括与用户直接交互的易用的API，主要包括Server、Client和一些其他通用抽象。Hertz框架最具特点的是处理函数（HandlerFunc）多了一个context上下文，这是在大量的实践过程中发现的，业务方通常需要一个标准的上下文在RPC Client或者日志、Tracing等组件间传递，但由于请求上下文（RequestContext）生命周期局限于一次HTTP请求之内而以上提到的场景往往存在异步的传递和处理， 导致如果直接传递请求上下文，会导致出现一些数据不一致的问题。因此最终增加了一个标准的上下文入参，从根本上解决各种因为上下文生命周期不一致的异常问题，处理函数的格式为：
type HandlerFunc func(c context.Context,ctx *app.RequestContext)
路由层 Hertz在设计路由时，给了用户极高的自由度去注册路由，支持的路由有：支持静态路由、参数路由的注册；支持按优先级匹配，支持路由回溯，支持尾斜线重定向。例如：
1.优先级匹配，如/a/b和/:c/b，同时满足时，优先匹配/a/b
2.路由回溯，如注册/a/b和/:c/d，当匹配/a/d时仍然能够匹配上/:c/d
3.支持尾斜线重定向，如注册/a/b，当匹配/a/b/时重定向到/a/b上
协议层 协议层负责不同协议的实现和扩展。Hertz支持协议的扩展，用户只需要实现下面的接口便可以按照自己的需求在引擎上扩展协议，同时也支持通过ALPN协议协商的方式注册。Hertz首批只开源了 HTTP1 实现，未来会陆续开源 HTTP2、QUIC 等实现。协议层扩展提供的灵活性甚至可以超越 HTTP 协议的范畴，用户完全可以按需注册任意符合自身需求的协议层实现，并且加入到Hertz的引擎中来，同时，也能够无缝享受到传输层带来的极致性能。
传输层 传输层负责底层的网络库的抽象和实现
Hertz支持底层网络库的扩展。Hertz原生完美匹配Netpoll，在时延方面有很多深度的优化，Netpoll对TLS能力的支持有待完善，为此Hertz底层同时支持基于Golang标准网络库的实现适配，同时支持网络库的一键切换，用户可根据自己的需求选择合适的网络库进行替换。如果用户有更加高效的网络库或其他网络库需求，也完全可以根据需求自行扩展。
BIO:
go func(){ for{ conn,_:=listener.Accept() go func(){ conn.Read(request) handle... conn.Write(response) } } } NIO:
go func(){ for{ readableConns,_:=Monitor(conns) //监听器，有足够的数据之后再去唤醒 for conn:=range readableConns{ go func(){ conn.Read(request) handle... conn.Write(response) } } } } go net是“BIO”，需要用户来管理buffer.
go net存下全部Header，减少系统调用次数，能够复用内存，能够多次读
type Conn interface{ Read(b []byte)(n int,err error) Write(b []byte)(n int,err error) ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/c7d8f82b4244f051093f51aa1c920936/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-15T21:22:54+08:00" />
<meta property="article:modified_time" content="2023-09-15T21:22:54+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">golang入门笔记——Hertz</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#Hertz_1" rel="nofollow">Hertz介绍</a></li><li><ul><li><a href="#_9" rel="nofollow">应用层</a></li><li><a href="#_13" rel="nofollow">路由层</a></li><li><a href="#_18" rel="nofollow">协议层</a></li><li><a href="#_20" rel="nofollow">传输层</a></li><li><a href="#HZ_145" rel="nofollow">HZ脚手架</a></li></ul> 
  </li><li><a href="#Hertz_149" rel="nofollow">Hertz的使用</a></li><li><ul><li><a href="#Hertz8080pingget_151" rel="nofollow">一个简单的案例：利用Hertz监听8080端口并编写/ping的get处理函数</a></li><li><a href="#Hertzgin_173" rel="nofollow">Hertz和gin一样，提供了分组路由的功能</a></li><li><a href="#Hertz_190" rel="nofollow">Hertz路由的匹配优先级：静态路由&gt;命名路由&gt;通配路由</a></li><li><a href="#BindValidateBindAndValidate_202" rel="nofollow">参数绑定：Bind、Validate、BindAndValidate用于参数绑定和校验</a></li><li><a href="#_265" rel="nofollow">中间件</a></li><li><a href="#HTTP_Client_281" rel="nofollow">HTTP Client</a></li><li><a href="#Hertz_309" rel="nofollow">Hertz代码生成工具</a></li><li><a href="#Hertz_402" rel="nofollow">Hertz的一些基本函数</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="Hertz_1"></a>Hertz介绍</h2> 
<p>Hertz是字节跳动研发的企业级微服务HTTP框架，具有高易用性、易扩展、低时延等特点。是基于自研网络库Netpoll开发的内部框架Hertz。Hertz框架整体上满足：<br> 1.极致性能优化的问题性<br> 2.面对未来不可控需求的扩展能力，Hertz采用了4层分层设计（应用层、路由层、协议层、传输层），保证各个层级功能内聚，同时通过层级之间的接口达到灵活扩展的目标。整体框架如下图：</p> 
<p><img src="https://images2.imgbox.com/c3/11/OxevZ0b3_o.png" alt="image.png"></p> 
<h3><a id="_9"></a>应用层</h3> 
<p>主要包括与用户直接交互的易用的API，主要包括Server、Client和一些其他通用抽象。Hertz框架最具特点的是处理函数（HandlerFunc）多了一个context上下文，这是在大量的实践过程中发现的，业务方通常需要一个标准的上下文在RPC Client或者日志、Tracing等组件间传递，但由于请求上下文（RequestContext）生命周期局限于一次HTTP请求之内而以上提到的场景往往存在异步的传递和处理， 导致如果直接传递请求上下文，会导致出现一些数据不一致的问题。因此最终增加了一个标准的上下文入参，从根本上解决各种因为上下文生命周期不一致的异常问题，处理函数的格式为：<br> <code>type HandlerFunc func(c context.Context,ctx *app.RequestContext)</code></p> 
<h3><a id="_13"></a>路由层</h3> 
<p>Hertz在设计路由时，给了用户极高的自由度去注册路由，支持的路由有：支持静态路由、参数路由的注册；支持按优先级匹配，支持路由回溯，支持尾斜线重定向。例如：<br> 1.优先级匹配，如/a/b和/:c/b，同时满足时，优先匹配/a/b<br> 2.路由回溯，如注册/a/b和/:c/d，当匹配/a/d时仍然能够匹配上/:c/d<br> 3.支持尾斜线重定向，如注册/a/b，当匹配/a/b/时重定向到/a/b上</p> 
<h3><a id="_18"></a>协议层</h3> 
<p>协议层负责不同协议的实现和扩展。Hertz支持协议的扩展，用户只需要实现下面的接口便可以按照自己的需求在引擎上扩展协议，同时也支持通过ALPN协议协商的方式注册。Hertz首批只开源了 HTTP1 实现，未来会陆续开源 HTTP2、QUIC 等实现。协议层扩展提供的灵活性甚至可以超越 HTTP 协议的范畴，用户完全可以按需注册任意符合自身需求的协议层实现，并且加入到Hertz的引擎中来，同时，也能够无缝享受到传输层带来的极致性能。</p> 
<h3><a id="_20"></a>传输层</h3> 
<p>传输层负责底层的网络库的抽象和实现<br> Hertz支持底层网络库的扩展。Hertz原生完美匹配Netpoll，在时延方面有很多深度的优化，Netpoll对TLS能力的支持有待完善，为此Hertz底层同时支持基于Golang标准网络库的实现适配，同时支持网络库的一键切换，用户可根据自己的需求选择合适的网络库进行替换。如果用户有更加高效的网络库或其他网络库需求，也完全可以根据需求自行扩展。</p> 
<p>BIO:</p> 
<pre><code class="prism language-go"><span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	<span class="token keyword">for</span><span class="token punctuation">{<!-- --></span>
		conn<span class="token punctuation">,</span><span class="token boolean">_</span><span class="token operator">:=</span>listener<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			conn<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
			handle<span class="token operator">...</span>
			conn<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>NIO:</p> 
<pre><code class="prism language-go"><span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	<span class="token keyword">for</span><span class="token punctuation">{<!-- --></span>
		readableConns<span class="token punctuation">,</span><span class="token boolean">_</span><span class="token operator">:=</span><span class="token function">Monitor</span><span class="token punctuation">(</span>conns<span class="token punctuation">)</span> <span class="token comment">//监听器，有足够的数据之后再去唤醒</span>
		<span class="token keyword">for</span> conn<span class="token operator">:=</span><span class="token keyword">range</span> readableConns<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
				conn<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
				handle<span class="token operator">...</span>
				conn<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>go net是“BIO”，需要用户来管理buffer.<br> go net存下全部Header，减少系统调用次数，能够复用内存，能够多次读</p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> Conn <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span>
	<span class="token function">Read</span><span class="token punctuation">(</span>b <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">,</span>err <span class="token builtin">error</span><span class="token punctuation">)</span>
	<span class="token function">Write</span><span class="token punctuation">(</span>b <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">,</span>err <span class="token builtin">error</span><span class="token punctuation">)</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-go"><span class="token keyword">type</span> Reader <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span>
	<span class="token function">Peek</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span><span class="token builtin">error</span><span class="token punctuation">)</span>
	<span class="token function">Discard</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>discarded <span class="token builtin">int</span><span class="token punctuation">,</span>err <span class="token builtin">error</span><span class="token punctuation">)</span>
	<span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token builtin">error</span>
	<span class="token function">Size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token builtin">int</span>
	<span class="token function">Read</span><span class="token punctuation">(</span>b <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span><span class="token punctuation">(</span>l <span class="token builtin">int</span><span class="token punctuation">,</span>err <span class="token builtin">error</span><span class="token punctuation">)</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
<span class="token keyword">type</span> Writer <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span>
	<span class="token function">Write</span><span class="token punctuation">(</span>p <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span>
	<span class="token function">Size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token builtin">int</span>
	<span class="token function">Flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token builtin">error</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>go net的优点：1.流式友好 2.小包性能高（连接上绑定一块内存，一旦超过就涉及buffer的申请和回收）</p> 
<p>netpoll是“NIO”，网络库管理buffer<br> netpoll存下全部Header，拷贝出完整的Body<br> netpoll with nocopy peek<br> 分配足够大的buffer<br> 限制最大buffer size<br> <img src="https://images2.imgbox.com/2a/c2/6NOixtnO_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> Conn <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span>
	net<span class="token punctuation">.</span>Conn
	Reader
	Writer
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-go"><span class="token keyword">type</span> Reader <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span>
	<span class="token function">Peek</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span><span class="token builtin">error</span><span class="token punctuation">)</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
<span class="token keyword">type</span> Writer <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span>
	<span class="token function">Malloc</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>buf <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span>err <span class="token builtin">error</span><span class="token punctuation">)</span>
	<span class="token function">Flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token builtin">error</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>netpoll的优点：1.中大包性能高（底层进行buffer的管理） 2.时延低</p> 
<p>netpoll在Header解析的优化：<br> 针对协议相关的Headers快速解析：</p> 
<pre><code>1.通过Header key首字母快速筛除掉完全不可能的key
2.解析对应value到独立字段
3.使用byte slice管理对应header存储，方便复用
优点：
1.核心字段快速解析
2.使用byte slice存储
3.额外存储到成员变量中
缺点：
1.普通header性能较低
2.没有map结构
</code></pre> 
<p>Header key规范化：aaa-bbb–&gt;Aaa-Bbb</p> 
<pre><code>优点：
超高的转换效率，比net.http提高40倍
缺点：
额外的内存开销，变更困难
</code></pre> 
<p>热点资源池化：<br> <img src="https://images2.imgbox.com/fe/77/nUX3qaqA_o.png" alt="在这里插入图片描述"><br> 请求来的时候，request从请求池当中拿一个RequestContext</p> 
<pre><code>优点：
	1.减少了内存分配
	2.提高了内存复用
	3.降低了GC压力
	4.性能提升
缺点：
	1.额外的Reset逻辑
	2.请求内有效
	3.问题定位难度增加
</code></pre> 
<h3><a id="HZ_145"></a>HZ脚手架</h3> 
<p>用户可以提供一个IDL，利用命令行工具Hz，一键生成项目脚手架。Hz也支持基于IDL的更新能力，能够基于IDL变动智能地更新项目代码。Hz支持Thrift和Protobuf两种IDL定义。</p> 
<h2><a id="Hertz_149"></a>Hertz的使用</h2> 
<h3><a id="Hertz8080pingget_151"></a>一个简单的案例：利用Hertz监听8080端口并编写/ping的get处理函数</h3> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
   <span class="token string">"context"</span>
   <span class="token string">"github.com/cloudwego/hertz/pkg/app"</span>
   <span class="token string">"github.com/cloudwego/hertz/pkg/app/server"</span>
   <span class="token string">"github.com/cloudwego/hertz/pkg/common/utils"</span>
   <span class="token string">"net/http"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   h <span class="token operator">:=</span> server<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">WithHostPorts</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1:8080"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   h<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/ping"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> ctx <span class="token operator">*</span>app<span class="token punctuation">.</span>RequestContext<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      ctx<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> utils<span class="token punctuation">.</span>H<span class="token punctuation">{<!-- --></span><span class="token string">"ping"</span><span class="token punctuation">:</span> <span class="token string">"pong"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
   h<span class="token punctuation">.</span><span class="token function">Spin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="Hertzgin_173"></a>Hertz和gin一样，提供了分组路由的功能</h3> 
<pre><code class="prism language-go">v1 <span class="token operator">:=</span> h<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token string">"/v1"</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
   v1<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> ctx <span class="token operator">*</span>app<span class="token punctuation">.</span>RequestContext<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span>
v2 <span class="token operator">:=</span> h<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token string">"/v2"</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
   v2<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> ctx <span class="token operator">*</span>app<span class="token punctuation">.</span>RequestContext<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

   <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="Hertz_190"></a>Hertz路由的匹配优先级：静态路由&gt;命名路由&gt;通配路由</h3> 
<pre><code class="prism language-go">h<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/herz/:version"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> ctx <span class="token operator">*</span>app<span class="token punctuation">.</span>RequestContext<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>
h<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/herz/*action"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> ctx <span class="token operator">*</span>app<span class="token punctuation">.</span>RequestContext<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="BindValidateBindAndValidate_202"></a>参数绑定：Bind、Validate、BindAndValidate用于参数绑定和校验</h3> 
<p><img src="https://images2.imgbox.com/b1/f0/x6dwEG3c_o.png" alt="image.png"></p> 
<p>参数校验：</p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> InfoRequest <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
		Name         <span class="token builtin">string</span>   <span class="token string">`vd:"($!='Alice'||(Age)$==18) &amp;&amp; regexp('\w')"`</span>
		Age          <span class="token builtin">int</span>      <span class="token string">`vd:"$&gt;0"`</span>
		Email        <span class="token builtin">string</span>   <span class="token string">`vd:"email($)"`</span>
		Phone1       <span class="token builtin">string</span>   <span class="token string">`vd:"phone($)"`</span>
		OtherPhones  <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token string">`vd:"range($, phone(#v,'CN'))"`</span>
		<span class="token operator">*</span>InfoRequest <span class="token string">`vd:"?"`</span>
		Info1        <span class="token operator">*</span>InfoRequest <span class="token string">`vd:"?"`</span>
		Info2        <span class="token operator">*</span>InfoRequest <span class="token string">`vd:"-"`</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p>自定义验证函数：</p> 
<pre><code class="prism language-go"><span class="token keyword">import</span> <span class="token string">"github.com/cloudwego/hertz/pkg/app/server/binding"</span>

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    binding<span class="token punctuation">.</span><span class="token function">MustRegValidateFunc</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>args <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"the args must be one"</span><span class="token punctuation">)</span>
       <span class="token punctuation">}</span>
       s<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span>
       <span class="token keyword">if</span> s <span class="token operator">==</span> <span class="token string">"123"</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"the args can not be 123"</span><span class="token punctuation">)</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">return</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>参数绑定优先级：<br> path &gt; form &gt; query &gt; cookie &gt; header &gt; json &gt; raw_body</p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> Args <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
   Query      <span class="token builtin">string</span>   <span class="token string">`query:"query"vd:"$!='Hertz'"`</span>
   QuerySlice <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token string">`query:"queryslice"`</span>
   Path       <span class="token builtin">string</span>   <span class="token string">`path:"path"`</span>
   Header     <span class="token builtin">string</span>   <span class="token string">`header:"header"`</span>
   Form       <span class="token builtin">string</span>   <span class="token string">`form:"form"`</span>
   Json       <span class="token builtin">string</span>   <span class="token string">`json:"json"`</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
h <span class="token operator">:=</span> server<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">WithHostPorts</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1:8080"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
h<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span><span class="token string">"v:path/bind"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> ctx <span class="token operator">*</span>app<span class="token punctuation">.</span>RequestContext<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token keyword">var</span> arg Args
   err <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">BindAndValidate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>arg<span class="token punctuation">)</span>
   <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre> 
<h3><a id="_265"></a>中间件</h3> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">MyMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span> app<span class="token punctuation">.</span>HandlerFunc <span class="token punctuation">{<!-- --></span>
   <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> ctx <span class="token operator">*</span>app<span class="token punctuation">.</span>RequestContext<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"pre-handle"</span><span class="token punctuation">)</span>
      ctx<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
      fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"post-handle"</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   h <span class="token operator">:=</span> server<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">WithHostPorts</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1:8080"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   h<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="token function">MyMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="HTTP_Client_281"></a>HTTP Client</h3> 
<p>Hertz提供了HTTP Client来模拟用户的请求</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
   <span class="token string">"context"</span>
   <span class="token string">"fmt"</span>
   <span class="token string">"github.com/cloudwego/hertz/pkg/app/client"</span>
   <span class="token string">"github.com/cloudwego/hertz/pkg/protocol"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   c<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">NewClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span>
   <span class="token punctuation">}</span>
   status<span class="token punctuation">,</span> body<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token string">"http://baidu.com"</span><span class="token punctuation">)</span>
   fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"status:%v body:%v"</span><span class="token punctuation">,</span> status<span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token keyword">var</span> postArgs protocol<span class="token punctuation">.</span>Args
   postArgs<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"arg"</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span>
   status<span class="token punctuation">,</span> body<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">Post</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token string">"http://baidu.com"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>postArgs<span class="token punctuation">)</span>
   fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"status:%v body:%v"</span><span class="token punctuation">,</span> status<span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="Hertz_309"></a>Hertz代码生成工具</h3> 
<pre><code class="prism language-go"><span class="token keyword">go</span> install github<span class="token punctuation">.</span>com<span class="token operator">/</span>cloudwego<span class="token operator">/</span>hertz<span class="token operator">/</span>cmd<span class="token operator">/</span>hz@latest
</code></pre> 
<pre><code class="prism language-bash"><span class="token comment">#hz生成用例代码</span>
hz new <span class="token parameter variable">-module</span> example
</code></pre> 
<p>编写IDL</p> 
<pre><code>namespace go hello.example

struct HelloReq{
    1:string Name (api.query="name");
}

struct HelloResp{
    1:string RespBody;
}

service HelloService{
    HelloResp HelloMethod(1:HelloReq request)(api.get="/hello")
}
</code></pre> 
<p>利用hz工具生成代码</p> 
<p><code>hz new -module mod_name -idl idl/hello.thrift</code></p> 
<p>生成的代码目录结构</p> 
<p><img src="https://images2.imgbox.com/8f/2a/AY258JUr_o.png" alt="image.png"></p> 
<p>生成的主要代码：<br> biz/handler/hello/example/hello_service.go</p> 
<pre><code>// Code generated by hertz generator.

package example

import (
   "context"

   "github.com/cloudwego/hertz/pkg/app"
   "github.com/cloudwego/hertz/pkg/protocol/consts"
   example "hertz-demo/biz/model/hello/example"
)

// HelloMethod .
// @router /hello [GET]
func HelloMethod(ctx context.Context, c *app.RequestContext) {
   var err error
   var req example.HelloReq
   err = c.BindAndValidate(&amp;req)
   if err != nil {
      c.String(consts.StatusBadRequest, err.Error())
      return
   }

   resp := new(example.HelloResp)

   c.JSON(consts.StatusOK, resp)
}
</code></pre> 
<p>biz/router/hello/example/hello.go</p> 
<pre><code>// Code generated by hertz generator. DO NOT EDIT.

package Example

import (
   "github.com/cloudwego/hertz/pkg/app/server"
   example "hertz-demo/biz/handler/hello/example"
)

/*
 This file will register all the routes of the services in the master idl.
 And it will update automatically when you use the "update" command for the idl.
 So don't modify the contents of the file, or your code will be deleted when it is updated.
*/

// Register register routes based on the IDL 'api.${HTTP Method}' annotation.
func Register(r *server.Hertz) {

   root := r.Group("/", rootMw()...)
   root.GET("/hello", append(_hellomethodMw(), example.HelloMethod)...)
}
</code></pre> 
<h3><a id="Hertz_402"></a>Hertz的一些基本函数</h3> 
<p>请求和cors跨域中间件</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	h <span class="token operator">:=</span> server<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	
	h<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/user/:name"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> ctx <span class="token operator">*</span>app<span class="token punctuation">.</span>RequestContext<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		fpath <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">FullPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token function">println</span><span class="token punctuation">(</span>fpath<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token comment">//请求 http://localhost:8888/user/zyj 会打印/user/:name</span>

	h<span class="token punctuation">.</span><span class="token function">NoRoute</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> ctx <span class="token operator">*</span>app<span class="token punctuation">.</span>RequestContext<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">println</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">FullPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token comment">//任何不符合匹配规则的uri请求都会返回空</span>

	h<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/user/:name"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> ctx <span class="token operator">*</span>app<span class="token punctuation">.</span>RequestContext<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		name <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span>
		<span class="token function">println</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token comment">//Param获取Param参数</span>

	h<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/user"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> ctx <span class="token operator">*</span>app<span class="token punctuation">.</span>RequestContext<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		name <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span>
		<span class="token function">println</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token comment">//获取的是Query参数，即？后面的参数</span>
	<span class="token comment">//DefaultQuery获取不到Query参数给一个默认值</span>
	
	h<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>cors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>cors<span class="token punctuation">.</span>Config<span class="token punctuation">{<!-- --></span> <span class="token comment">//跨域中间件</span>
		AllowAllOrigins<span class="token punctuation">:</span>  <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//允许所有origin的请求</span>
		AllowMethods<span class="token punctuation">:</span>     <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span><span class="token string">"GET"</span><span class="token punctuation">,</span> <span class="token string">"PUT"</span><span class="token punctuation">,</span> <span class="token string">"POST"</span><span class="token punctuation">,</span> <span class="token string">"DELETE"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">//允许的方法</span>
		AllowHeaders<span class="token punctuation">:</span>     <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span><span class="token string">"Origin"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">//允许的头部</span>
		ExposeHeaders<span class="token punctuation">:</span>    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span><span class="token string">"Content-Length"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">//暴漏的头部信息</span>
		AllowCredentials<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>	<span class="token comment">//允许携带证书</span>
		AllowWildcard<span class="token punctuation">:</span>    <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//允许使用通配符匹配</span>
		AllowOriginFunc<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>origin <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//自定义处理源的函数</span>
 			<span class="token keyword">return</span> origin <span class="token operator">==</span> <span class="token string">"https://github.com"</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		MaxAge<span class="token punctuation">:</span> <span class="token number">12</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Hour<span class="token punctuation">,</span>  <span class="token comment">//请求缓存的最长时间</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token function">register</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span>
	h<span class="token punctuation">.</span><span class="token function">Spin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>header处理</p> 
<pre><code class="prism language-go">	h<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/header"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> ctx <span class="token operator">*</span>app<span class="token punctuation">.</span>RequestContext<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		ctx<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"hertz1"</span><span class="token punctuation">,</span> <span class="token string">"value1"</span><span class="token punctuation">)</span>
		ctx<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">SetContentTypeBytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"application/x-www-form-urlencoded"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//设置内容类型</span>
		ctx<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"application/json;charset=utf-8"</span><span class="token punctuation">)</span>
		hertz <span class="token operator">:=</span> ctx<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">GetAll</span><span class="token punctuation">(</span><span class="token string">"hertz1"</span><span class="token punctuation">)</span>
		<span class="token function">println</span><span class="token punctuation">(</span>hertz<span class="token punctuation">)</span>
		contentType2 <span class="token operator">:=</span> ctx<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">ContentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>contentType2<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p>接收form-data</p> 
<pre><code class="prism language-go">	h<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span><span class="token string">"/form_data"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> ctx <span class="token operator">*</span>app<span class="token punctuation">.</span>RequestContext<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		data <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">PostForm</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p>上传文件处理：</p> 
<pre><code class="prism language-go">	<span class="token comment">//多文件</span>
	h<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span><span class="token string">"/multifile"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> ctx <span class="token operator">*</span>app<span class="token punctuation">.</span>RequestContext<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		form<span class="token punctuation">,</span> err <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">MultipartForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		name <span class="token operator">:=</span> form<span class="token punctuation">.</span>Value<span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
		file <span class="token operator">:=</span> form<span class="token punctuation">.</span>File<span class="token punctuation">[</span><span class="token string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>Filename<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	<span class="token comment">//单文件</span>
	h<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span><span class="token string">"/user"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> ctx <span class="token operator">*</span>app<span class="token punctuation">.</span>RequestContext<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		file<span class="token punctuation">,</span> err <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">FormFile</span><span class="token punctuation">(</span><span class="token string">"file"</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>Filename<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p>session存储</p> 
<pre><code class="prism language-go">	store <span class="token operator">:=</span> cookie<span class="token punctuation">.</span><span class="token function">NewStore</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"secret"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	h<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>sessions<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"mysession"</span><span class="token punctuation">,</span> store<span class="token punctuation">)</span><span class="token punctuation">)</span>
	h<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/incr"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> ctx <span class="token operator">*</span>app<span class="token punctuation">.</span>RequestContext<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		session <span class="token operator">:=</span> sessions<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
		<span class="token keyword">var</span> count <span class="token builtin">int</span>
		v <span class="token operator">:=</span> session<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"count"</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> v <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			count <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
			count<span class="token operator">++</span>
		<span class="token punctuation">}</span>
		session<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"count"</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span>
		<span class="token boolean">_</span> <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">Save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		ctx<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> utils<span class="token punctuation">.</span>H<span class="token punctuation">{<!-- --></span><span class="token string">"count"</span><span class="token punctuation">:</span> count<span class="token punctuation">}</span><span class="token punctuation">)</span>

	<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p>gzip压缩</p> 
<pre><code class="prism language-go">	h<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>gzip<span class="token punctuation">.</span><span class="token function">Gzip</span><span class="token punctuation">(</span>
		gzip<span class="token punctuation">.</span>DefaultCompression<span class="token punctuation">,</span>
		gzip<span class="token punctuation">.</span><span class="token function">WithExcludedExtensions</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span><span class="token string">".pdf"</span><span class="token punctuation">,</span> <span class="token string">".mp4"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//pdf和mp4不压缩</span>
	<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/312d0c444c561b728846e82a5bfbd7ac/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">可重入函数与不可重入函数介绍</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/100312319aa816fffce1f49491d037ba/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">MacBook苹果电脑重装、降级系统</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>