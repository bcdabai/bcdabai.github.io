<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>iOS阿里云对象存储 OSS文件的上传/下载的实现 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="iOS阿里云对象存储 OSS文件的上传/下载的实现" />
<meta property="og:description" content="之前的项目中，图片语音等资源文件都是直接上传数据流给服务器，然后服务器进行处理和存储。最近的这个项目，服务器直接开的OSS，然后客户端直接使用阿里云提供的上传下载功能来上传和下载资源。 阿里云对图片的处理做的很到位，尺寸在获取图片时可自定义。 首先在项目中导入阿里云OSS的库，直接在pod中加上如下代码：
pod &#39;AliyunOSSiOS&#39; 如果不是用pod的话，可点击此链接前往下载：https://help.aliyun.com/document_detail/32173.html 我们可以封装一个OSS的工具类，专门用来管理文件的上传和下载。OSS的初始化和配置代码：
//以下参数服务器端可提供 #define ACCKEY @&#34;Mt5jQPnQQECHqTEST&#34; #define ACCSECRET @&#34;2QgUjalQoBsdLn2iYFpqW0TEST&#34; #define ENDPOINT @&#34;http://oss-cn-hangzhou.aliyuncs.com&#34; #import &#34;BZHttpFileHelper.h&#34; #import &lt;AliyunOSSiOS/OSSService.h&gt; @interface BZHttpFileHelper () @property(nonatomic,strong) OSSClient * client; @end @implementation BZHttpFileHelper &#43;(instancetype)fileHelperShareInstance{ static BZHttpFileHelper * fileHelper = nil; static dispatch_once_t onceToken; dispatch_once(&amp;onceToken, ^{ fileHelper = [[BZHttpFileHelper alloc] init]; [fileHelper initAliClient]; }); return fileHelper; } -(void)initAliClient{ id&lt;OSSCredentialProvider&gt; credential = [[OSSPlainTextAKSKPairCredentialProvider alloc] initWithPlainTextAccessKey:ACCKEY secretKey:ACCSECRET]; OSSClientConfiguration * conf = [OSSClientConfiguration new]; // 网络请求遇到异常失败后的重试次数 conf." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/d0e439edbeb35f52a8b23efedad03940/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-06-21T13:48:22+08:00" />
<meta property="article:modified_time" content="2018-06-21T13:48:22+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">iOS阿里云对象存储 OSS文件的上传/下载的实现</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>之前的项目中，图片语音等资源文件都是直接上传数据流给服务器，然后服务器进行处理和存储。最近的这个项目，服务器直接开的OSS，然后客户端直接使用阿里云提供的上传下载功能来上传和下载资源。 <br> 阿里云对图片的处理做的很到位，尺寸在获取图片时可自定义。 <br> 首先在项目中导入阿里云OSS的库，直接在pod中加上如下代码：</p> 
<pre class="prettyprint"><code class=" hljs bash">pod <span class="hljs-string">'AliyunOSSiOS'</span></code></pre> 
<p>如果不是用pod的话，可点击此链接前往下载：<a href="https://help.aliyun.com/document_detail/32173.html" rel="nofollow">https://help.aliyun.com/document_detail/32173.html</a> <br> 我们可以封装一个OSS的工具类，专门用来管理文件的上传和下载。OSS的初始化和配置代码：</p> 
<pre class="prettyprint"><code class=" hljs objectivec"><span class="hljs-comment">//以下参数服务器端可提供</span>
<span class="hljs-preprocessor">#define ACCKEY @"Mt5jQPnQQECHqTEST"</span>
<span class="hljs-preprocessor">#define ACCSECRET @"2QgUjalQoBsdLn2iYFpqW0TEST"</span>
<span class="hljs-preprocessor">#define ENDPOINT @"http://oss-cn-hangzhou.aliyuncs.com"</span>

<span class="hljs-preprocessor">#import <span class="hljs-title">"BZHttpFileHelper.h"</span></span>
<span class="hljs-preprocessor">#import <span class="hljs-title">&lt;AliyunOSSiOS/OSSService.h&gt;</span></span>

<span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">BZHttpFileHelper</span> ()</span>

<span class="hljs-keyword">@property</span>(<span class="hljs-keyword">nonatomic</span>,<span class="hljs-keyword">strong</span>) OSSClient * client;

<span class="hljs-keyword">@end</span>

<span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">BZHttpFileHelper</span></span>
+(instancetype)fileHelperShareInstance{
    <span class="hljs-keyword">static</span> BZHttpFileHelper * fileHelper = <span class="hljs-literal">nil</span>;
    <span class="hljs-keyword">static</span> <span class="hljs-built_in">dispatch_once_t</span> onceToken;
    <span class="hljs-built_in">dispatch_once</span>(&amp;onceToken, ^{
        fileHelper = [[BZHttpFileHelper alloc] init];
        [fileHelper initAliClient];
    });
    <span class="hljs-keyword">return</span> fileHelper;
}

-(<span class="hljs-keyword">void</span>)initAliClient{
    <span class="hljs-keyword">id</span>&lt;OSSCredentialProvider&gt; credential = [[OSSPlainTextAKSKPairCredentialProvider alloc] initWithPlainTextAccessKey:ACCKEY                                                                                                    secretKey:ACCSECRET];

    OSSClientConfiguration * conf = [OSSClientConfiguration new];

    <span class="hljs-comment">// 网络请求遇到异常失败后的重试次数</span>
    conf<span class="hljs-variable">.maxRetryCount</span> = <span class="hljs-number">3</span>;

    <span class="hljs-comment">// 网络请求的超时时间</span>
    conf<span class="hljs-variable">.timeoutIntervalForRequest</span> =<span class="hljs-number">30</span>;

    <span class="hljs-comment">// 允许资源传输的最长时间</span>
    conf<span class="hljs-variable">.timeoutIntervalForResource</span> =<span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span>;

    <span class="hljs-comment">// 你的阿里地址前面通常是这种格式 ：http://oss……</span>
    <span class="hljs-keyword">self</span><span class="hljs-variable">.client</span> = [[OSSClient alloc] initWithEndpoint:ENDPOINT credentialProvider:credential];
}</code></pre> 
<p>文件上传,将文件转换为NSData即可直接上传：</p> 
<pre class="prettyprint"><code class=" hljs objectivec">-(<span class="hljs-keyword">void</span>)uploadAmr:(NSData *)amrData amrName:(<span class="hljs-built_in">NSString</span> *)amrName callback:(<span class="hljs-keyword">void</span> (^)(<span class="hljs-built_in">BOOL</span>))callback{
    OSSPutObjectRequest * put = [OSSPutObjectRequest new];
    put<span class="hljs-variable">.bucketName</span> = @<span class="hljs-string">"test"</span>;
    put<span class="hljs-variable">.objectKey</span> = amrName;
    put<span class="hljs-variable">.uploadingData</span> = amrData; <span class="hljs-comment">// 直接上传NSData</span>
    put<span class="hljs-variable">.uploadProgress</span> = ^(int64_t bytesSent,int64_t totalByteSent, int64_t totalBytesExpectedToSend) {
        <span class="hljs-built_in">NSLog</span>(@<span class="hljs-string">"%lld, %lld, %lld"</span>, bytesSent, totalByteSent, totalBytesExpectedToSend);
    };

    OSSTask * putTask = [<span class="hljs-keyword">self</span><span class="hljs-variable">.client</span> putObject:put];

    <span class="hljs-comment">// 上传阿里云</span>
    [putTask continueWithBlock:^<span class="hljs-keyword">id</span>(OSSTask *task) {
        <span class="hljs-keyword">if</span> (!task<span class="hljs-variable">.error</span>) {
            <span class="hljs-built_in">NSLog</span>(@<span class="hljs-string">"upload object success!"</span>);
            <span class="hljs-keyword">if</span> (callback) {
                callback(<span class="hljs-literal">YES</span>);
            }
        } <span class="hljs-keyword">else</span> {

            <span class="hljs-built_in">NSLog</span>(@<span class="hljs-string">"upload object failed, error: %@"</span> , task<span class="hljs-variable">.error</span>);
            <span class="hljs-keyword">if</span> (callback) {
                callback(<span class="hljs-literal">NO</span>);
            }
            <span class="hljs-built_in">dispatch_async</span>(dispatch_get_main_queue(), ^{
                <span class="hljs-built_in">UIWindow</span> * window = [[[<span class="hljs-built_in">UIApplication</span> sharedApplication] delegate] window];
                [window makeToast:@<span class="hljs-string">"文件上传失败"</span> duration:<span class="hljs-number">1.5</span> position:CSToastPositionCenter];
            });
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;
    }];
}</code></pre> 
<p>文件下载：</p> 
<pre class="prettyprint"><code class=" hljs objectivec">-(<span class="hljs-keyword">void</span>)downloadFile:(<span class="hljs-built_in">NSString</span> *)filename callback:(<span class="hljs-keyword">void</span> (^)(NSData *, <span class="hljs-built_in">BOOL</span>))callback{
    OSSGetObjectRequest * request = [OSSGetObjectRequest new];
    request<span class="hljs-variable">.bucketName</span> = @<span class="hljs-string">"savemoney"</span>;
    request<span class="hljs-variable">.objectKey</span> = filename;
    OSSTask * getTask = [<span class="hljs-keyword">self</span><span class="hljs-variable">.client</span> getObject:request];
    [getTask continueWithBlock:^<span class="hljs-keyword">id</span>(OSSTask *task) {
        <span class="hljs-keyword">if</span> (!task<span class="hljs-variable">.error</span>) {
            <span class="hljs-built_in">NSLog</span>(@<span class="hljs-string">"download object success!"</span>);
            OSSGetObjectResult * getResult = task<span class="hljs-variable">.result</span>;
            <span class="hljs-keyword">if</span> (callback) {
                callback(getResult<span class="hljs-variable">.downloadedData</span>,<span class="hljs-literal">YES</span>);
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-built_in">NSLog</span>(@<span class="hljs-string">"download object failed, error: %@"</span> ,task<span class="hljs-variable">.error</span>);
            <span class="hljs-keyword">if</span> (callback) {
                callback(<span class="hljs-literal">nil</span>,<span class="hljs-literal">NO</span>);
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;
    }];
}</code></pre> 
<p>上传时文件名是我们定义的，下载的时候只要拿这个文件名即可下载。 <br> 所以用了OSS之后，上传图片等文件的步骤是我们客户端先将文件上传到OSS，然后将文件名通过接口给服务器，服务器存储文件名，在需要文件的地方服务器给我们文件名，我们再去OSS上取。 <br> 也可参考阿里云OSS的开发文档：<a href="https://help.aliyun.com/document_detail/32055.html?spm=a2c4g.11186623.6.726.oKF88C" rel="nofollow">https://help.aliyun.com/document_detail/32055.html?spm=a2c4g.11186623.6.726.oKF88C</a>。 <br> 最后说一下图片的加载，我们可以按照自己需要的格式来读取图片，可以写一个NSURL的分类，来返回不同的图片的路径。 <br> 因为服务器存的是文件名，读取原图片cdn域名+文件名，可用下面的代码来获取图片完整路径：</p> 
<pre class="prettyprint"><code class=" hljs objectivec">+(<span class="hljs-built_in">NSURL</span> *)photourlWithUrlString:(<span class="hljs-built_in">NSString</span> *)url{
    <span class="hljs-comment">//原图</span>
    <span class="hljs-keyword">return</span> [<span class="hljs-built_in">NSURL</span> URLWithString:[<span class="hljs-built_in">NSString</span> stringWithFormat:@<span class="hljs-string">"http://savemcdn.dewtip.com/%@"</span>,url]];
}

+(<span class="hljs-built_in">NSURL</span> *)s_photourlWithUrlString:(<span class="hljs-built_in">NSString</span> *)url{
<span class="hljs-comment">//120*120的图片</span>
    <span class="hljs-keyword">return</span> [<span class="hljs-built_in">NSURL</span> URLWithString:[<span class="hljs-built_in">NSString</span> stringWithFormat:@<span class="hljs-string">"http://savemcdn.dewtip.com/%@?x-oss-process=image/resize,w_120,h_120"</span>,url]];
}

+(<span class="hljs-built_in">NSURL</span> *)s_chatPhotourlWithUrlString:(<span class="hljs-built_in">NSString</span> *)url{
<span class="hljs-comment">//</span>
    <span class="hljs-keyword">return</span> [<span class="hljs-built_in">NSURL</span> URLWithString:[<span class="hljs-built_in">NSString</span> stringWithFormat:@<span class="hljs-string">"http://savemcdn.dewtip.com/%@?x-oss-process=image/resize,m_lfit,h_200,w_200"</span>,url]];
}</code></pre> 
<p>更多图片样式及处理可参考官方文档：<a href="https://www.alibabacloud.com/help/zh/doc-detail/48884.htm?spm=a2c63.p38356.b99.427.75926010lb0FXv" rel="nofollow">https://www.alibabacloud.com/help/zh/doc-detail/48884.htm?spm=a2c63.p38356.b99.427.75926010lb0FXv</a> <br> OSS对图片处理的支持确实很到位，用起来很方便。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/cd806f132ded8577bdf708da596cfa3d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">P2P技术原理及应用</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d3ddd5a96ca740ab46ec5e4bd3468513/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">分布式CAP定理，为什么不能同时满足三个特性？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>