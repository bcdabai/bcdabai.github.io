<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>前端Rust开发WebAssembly与Swc插件快速入门 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="前端Rust开发WebAssembly与Swc插件快速入门" />
<meta property="og:description" content="前言 现代前端对速度的追求已经进入二进制工具时代，Rust 开发成为每个人的必修课。
一般我们将常见的前端 Rust 开发分为以下几类，难度由上至下递增：
开发 wasm 。
开发 swc 插件。
开发代码处理工具。
我们将默认读者具备最简单的 Rust 知识，进行快速入门介绍。
正文 开发 wasm 意义 开发 wasm 的意义在于利用浏览器运行 wasm 的优势，在 wasm 中进行大量复杂的计算、音视频、图像处理等，当你有此类需求，可以优先考虑使用 Rust 开发 wasm 分发至浏览器。
初始化 我们使用 wasm-pack 构建 wasm ，参考 wasm-pack &gt; Quickstart 得到一个模板起始项目。
实战 case 使用 tsify 支持输出结构体的 TypeScript 类型，实现一个简单的加法运算：
# Cargo.toml 确保你含有这些依赖 [dependencies] serde = { version = &#34;1.0.163&#34;, features = [&#34;derive&#34;] } tsify = &#34;0.4.5&#34; use wasm_bindgen::prelude::*; use serde::{Serialize, Deserialize}; use tsify::Tsify; #[derive(Tsify, Serialize, Deserialize)] #[tsify(into_wasm_abi, from_wasm_abi)] pub struct Rect { pub width: u32, pub height: u32 } #[wasm_bindgen] pub fn plus(mut rect: Rect) -&gt; Rect { rect." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/e66728ae55f81772f90dc94e4ce04184/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-04T15:48:27+08:00" />
<meta property="article:modified_time" content="2023-06-04T15:48:27+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">前端Rust开发WebAssembly与Swc插件快速入门</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>前言</h3> 
<p>现代前端对速度的追求已经进入二进制工具时代，Rust 开发成为每个人的必修课。</p> 
<p>一般我们将常见的前端 Rust 开发分为以下几类，难度由上至下递增：</p> 
<ol><li> <p>开发 wasm 。</p> </li><li> <p>开发 swc 插件。</p> </li><li> <p>开发代码处理工具。</p> </li></ol> 
<p>我们将默认读者具备最简单的 Rust 知识，进行快速入门介绍。</p> 
<h3><a id="_14"></a>正文</h3> 
<h4><a id="_wasm_16"></a>开发 wasm</h4> 
<h5><a id="_18"></a>意义</h5> 
<p>开发 wasm 的意义在于利用浏览器运行 wasm 的优势，在 wasm 中进行大量复杂的计算、音视频、图像处理等，当你有此类需求，可以优先考虑使用 Rust 开发 wasm 分发至浏览器。</p> 
<h5><a id="_22"></a>初始化</h5> 
<p>我们使用 <a href="https://github.com/rustwasm/wasm-pack">wasm-pack</a> 构建 wasm ，参考 <a href="https://rustwasm.github.io/wasm-pack/book/quickstart.html" rel="nofollow">wasm-pack &gt; Quickstart</a> 得到一个模板起始项目。</p> 
<h5><a id="_case_26"></a>实战 case</h5> 
<p>使用 <a href="https://github.com/madonoharu/tsify">tsify</a> 支持输出结构体的 TypeScript 类型，实现一个简单的加法运算：</p> 
<pre><code class="prism language-yml"><span class="token comment"># Cargo.toml 确保你含有这些依赖</span>
<span class="token punctuation">[</span>dependencies<span class="token punctuation">]</span>
serde = <span class="token punctuation">{<!-- --></span> version = "1.0.163"<span class="token punctuation">,</span> features = <span class="token punctuation">[</span><span class="token string">"derive"</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
tsify = "0.4.5"
</code></pre> 
<pre><code class="prism language-rust"><span class="token keyword">use</span> <span class="token namespace">wasm_bindgen<span class="token punctuation">::</span>prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">serde<span class="token punctuation">::</span></span><span class="token punctuation">{<!-- --></span><span class="token class-name">Serialize</span><span class="token punctuation">,</span> <span class="token class-name">Deserialize</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">tsify<span class="token punctuation">::</span></span><span class="token class-name">Tsify</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Tsify, Serialize, Deserialize)]</span>
<span class="token attribute attr-name">#[tsify(into_wasm_abi, from_wasm_abi)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Rect</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">pub</span> width<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> height<span class="token punctuation">:</span> <span class="token keyword">u32</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[wasm_bindgen]</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">plus</span><span class="token punctuation">(</span><span class="token keyword">mut</span> rect<span class="token punctuation">:</span> <span class="token class-name">Rect</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Rect</span> <span class="token punctuation">{<!-- --></span>
    rect<span class="token punctuation">.</span>width <span class="token operator">+=</span> rect<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
    rect
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_56"></a>构建</h5> 
<pre><code class="prism language-bash">  <span class="token comment"># dev</span>
  wasm-pack build --verbose --out-dir pkg --out-name index --dev
  <span class="token comment"># release</span>
  wasm-pack build --verbose --out-dir pkg --out-name index --release
</code></pre> 
<p>这将在当前目录的 <code>pkg/*</code> 下生成 wasm 产物与 <code>index.js</code> 等胶水代码，导入 <code>index.js</code> 便即开即用，非常方便。</p> 
<h5><a id="_wasm_67"></a>运行 wasm</h5> 
<p>为了支持直接导入 <code>.wasm</code> 文件，我们需要 webpack 5 的 <code>asyncWebAssembly</code> 特性支持，此处以在 Umi 4 项目中调试为例，创建一个 Umi 4 Simple 模板项目：</p> 
<pre><code class="prism language-bash">  <span class="token function">pnpm</span> create umi wasm-demo
</code></pre> 
<p>参考 <a href="https://umijs.org/docs/introduce/faq#%E6%80%8E%E4%B9%88%E7%94%A8-webassembly" rel="nofollow">FAQ &gt; 怎么用 WebAssembly</a> 配置开启 wasm 支持：</p> 
<pre><code class="prism language-ts"><span class="token comment">// .umirc.ts</span>
 
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">chainWebpack</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    config<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'experiments'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
      <span class="token operator">...</span>config<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'experiments'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      asyncWebAssembly<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
 
    <span class="token keyword">const</span> <span class="token constant">REG</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.wasm$</span><span class="token regex-delimiter">/</span></span>
 
    config<span class="token punctuation">.</span>module<span class="token punctuation">.</span><span class="token function">rule</span><span class="token punctuation">(</span><span class="token string">'asset'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>exclude<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">REG</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    config<span class="token punctuation">.</span>module
      <span class="token punctuation">.</span><span class="token function">rule</span><span class="token punctuation">(</span><span class="token string">'wasm'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token constant">REG</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>exclude<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">node_modules</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token string">'webassembly/async'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>之后便可在项目中直接导入刚刚打包好，在 <code>pkg/*</code> 的 wasm 即开即用：</p> 
<pre><code class="prism language-ts"><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> wasm <span class="token keyword">from</span> <span class="token string">'./path/to/pkg'</span>
<span class="token keyword">const</span> ret <span class="token operator">=</span> wasm<span class="token punctuation">.</span><span class="token function">plus</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  width<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  height<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// { width: 3, height: 2 }</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ret: '</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>注：</p> 
<ol><li> <p>由于 wasm 文件可能较大，当你需要优化时，可将使用 <code>.wasm</code> 的组件手动 <code>React.lazy(() =&gt; import('./Component'))</code> 拆包，之后在 <code>useEffect</code> 中懒加载 <code>await import('./path/to/pkg')</code> 。</p> </li><li> <p>对于非 Umi 4 的 webpack 5 项目，请自行开启 <code>experiments.asyncWebAssembly</code> 即可一键支持 wasm 导入。</p> </li></ol> 
<h5><a id="_120"></a>缺点</h5> 
<p>由于当下浏览器和 PC 设备性能已足够强大，更多场合下，运行 wasm 进行数据计算，传递数据花费的时间将 <strong>远远超出使用 JavaScript 进行同逻辑计算的时间</strong> 。</p> 
<p>所以除音视频场景外，<strong>你很可能不需要 wasm</strong> ，而是优先考虑使用 Worker 等优化策略。</p> 
<h4><a id="_swc__126"></a>开发 swc 插件</h4> 
<h5><a id="_127"></a>意义</h5> 
<p>现代前端高效构建往往将 babel 替代为 swc 化，为了替代 babel 插件实现代码转换，开发 swc 插件成为了一门必修课。</p> 
<h5><a id="_131"></a>初始化</h5> 
<p>参考 <a href="https://swc.rs/docs/plugin/ecmascript/getting-started#create-a-project" rel="nofollow">swc &gt; Create a project</a> ，我们用 swc 脚手架初始化得到一个插件的模板起始项目。</p> 
<h5><a id="_case_135"></a>实战 case</h5> 
<p>我们编写一个最简单的功能，将所有的 <code>react</code> 导入转换为 <code>preact</code> ：</p> 
<pre><code class="prism language-yml"><span class="token comment"># Cargo.toml 确保你含有这些依赖</span>
<span class="token punctuation">[</span>dependencies<span class="token punctuation">]</span>
serde = "1.0.163"
serde_json = "1.0.96"
swc_core = <span class="token punctuation">{<!-- --></span> version = "0.76.39"<span class="token punctuation">,</span> features = <span class="token punctuation">[</span><span class="token string">"ecma_plugin_transform"</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-rust"><span class="token keyword">use</span> <span class="token namespace">swc_core<span class="token punctuation">::</span>ecma<span class="token punctuation">::</span></span><span class="token punctuation">{<!-- --></span>
    <span class="token namespace">ast<span class="token punctuation">::</span></span><span class="token punctuation">{<!-- --></span><span class="token class-name">Program</span><span class="token punctuation">,</span> <span class="token class-name">ImportDecl</span><span class="token punctuation">,</span> <span class="token class-name">ImportSpecifier</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token namespace">visit<span class="token punctuation">::</span></span><span class="token punctuation">{<!-- --></span>as_folder<span class="token punctuation">,</span> <span class="token class-name">FoldWith</span><span class="token punctuation">,</span> <span class="token class-name">VisitMut</span><span class="token punctuation">,</span> <span class="token class-name">VisitMutWith</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">swc_core<span class="token punctuation">::</span>plugin<span class="token punctuation">::</span></span><span class="token punctuation">{<!-- --></span>plugin_transform<span class="token punctuation">,</span> <span class="token namespace">proxies<span class="token punctuation">::</span></span><span class="token class-name">TransformPluginProgramMetadata</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">serde<span class="token punctuation">::</span></span><span class="token punctuation">{<!-- --></span><span class="token class-name">Deserialize</span><span class="token punctuation">,</span> <span class="token class-name">Serialize</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Deserialize, Serialize)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">TransformPluginConfig</span> <span class="token punctuation">{<!-- --></span>
    from<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    to<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">TransformVisitor</span> <span class="token punctuation">{<!-- --></span>
    config<span class="token punctuation">:</span> <span class="token class-name">TransformPluginConfig</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">VisitMut</span> <span class="token keyword">for</span> <span class="token class-name">TransformVisitor</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">fn</span> <span class="token function-definition function">visit_mut_import_decl</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> n<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">ImportDecl</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        n<span class="token punctuation">.</span><span class="token function">visit_mut_children_with</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> n<span class="token punctuation">.</span>specifiers<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">ImportSpecifier</span><span class="token punctuation">::</span><span class="token class-name">Default</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=</span> n<span class="token punctuation">.</span>specifiers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> n<span class="token punctuation">.</span>src<span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token keyword">self</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>from <span class="token punctuation">{<!-- --></span>
                    n<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>to<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[plugin_transform]</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">process_transform</span><span class="token punctuation">(</span>program<span class="token punctuation">:</span> <span class="token class-name">Program</span><span class="token punctuation">,</span> metadata<span class="token punctuation">:</span> <span class="token class-name">TransformPluginProgramMetadata</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Program</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> config <span class="token operator">=</span> <span class="token namespace">serde_json<span class="token punctuation">::</span></span><span class="token function">from_str</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span>metadata
            <span class="token punctuation">.</span><span class="token function">get_transform_plugin_config</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">"invalid config"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    program<span class="token punctuation">.</span><span class="token function">fold_with</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token function">as_folder</span><span class="token punctuation">(</span><span class="token class-name">TransformVisitor</span> <span class="token punctuation">{<!-- --></span> config <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在编写过程中，以下文档可供参考：</p> 
<ul><li> <p><a href="https://swc.rs/docs/plugin/ecmascript/getting-started#create-a-project" rel="nofollow">Swc ：Implementing a plugin</a></p> </li><li> <p><a href="https://rustdoc.swc.rs/swc/" rel="nofollow">Swc ：Rust docs</a></p> </li></ul> 
<h5><a id="_199"></a>构建</h5> 
<pre><code class="prism language-bash">  <span class="token comment"># dev</span>
  cargo build --target wasm32-wasi
  <span class="token comment"># release</span>
  cargo build --target wasm32-wasi --release
</code></pre> 
<p>通过构建，你可以在当前目录下得到 wasm 形式的 swc 插件产物。</p> 
<h5><a id="_swc__210"></a>运行 swc 插件</h5> 
<pre><code class="prism language-ts"><span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> transformSync <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@swc/core'</span>

<span class="token keyword">const</span> <span class="token function-variable function">transform</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> code <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">transformSync</span><span class="token punctuation">(</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
import React from 'react'
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      jsc<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        experimental<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">[</span>
              <span class="token keyword">require</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>
                <span class="token string">'./target/wasm32-wasi/debug/my_first_plugin.wasm'</span>
              <span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token punctuation">{<!-- --></span>
                from<span class="token operator">:</span> <span class="token string">'react'</span><span class="token punctuation">,</span>
                to<span class="token operator">:</span> <span class="token string">'preact'</span><span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        parser<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          syntax<span class="token operator">:</span> <span class="token string">'typescript'</span><span class="token punctuation">,</span>
          dynamicImport<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          tsx<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        target<span class="token operator">:</span> <span class="token string">'es2015'</span><span class="token punctuation">,</span>
        minify<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          compress<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          mangle<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        transform<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          react<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            runtime<span class="token operator">:</span> <span class="token string">'automatic'</span><span class="token punctuation">,</span>
            throwIfNamespace<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            development<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            useBuiltins<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      module<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        type<span class="token operator">:</span> <span class="token string">'es6'</span><span class="token punctuation">,</span>
        ignoreDynamic<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      minify<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      isModule<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      sourceMaps<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      filename<span class="token operator">:</span> <span class="token string">'index.tsx'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>
  <span class="token comment">// import React from 'preact'</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'code: '</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">transform</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="_271"></a>缺点</h5> 
<p>为了避免多平台差异，我们分发了 <code>wasm32-wasi</code> 目标的 wasm 包，好处是只需构建一次即可全平台通用，缺点是产物较大，同时 wasm 运行速度不如 <code>.node</code> ；但现代前端已无需担心只在本地编译阶段使用的包大小，如 Nextjs 单包依赖已达 <code>40 M</code> 以上，TypeScript <code>20 M</code> ，你可以无需关心产物体积问题。</p> 
<p>至此，我们介绍了如何借助 swc 插件实现 babel 插件的替代，在下文中，我们将继续深入，真正构建多平台分发的二进制包，同时不会做过多细节介绍，<strong>推荐只学习到此处为止</strong>。</p> 
<h4><a id="_277"></a>开发代码处理工具</h4> 
<h5><a id="_278"></a>意义</h5> 
<p>目前最主流的前端 Rust 开发即是借助 Swc 来解析 JavaScript 、TypeScript 代码，从而实现代码信息提取、转换、编译等，我们会将 Rust 编译为 Node addon <code>.node</code> 文件，以获得远比 wasm 更快的运行速度。</p> 
<h5><a id="_282"></a>初始化</h5> 
<p>使用 <a href="https://napi.rs/" rel="nofollow">napi-rs</a> 构建 ，参考 <a href="https://napi.rs/docs/introduction/getting-started#install-cli" rel="nofollow">napi &gt; Create project</a> 得到一个模板起始项目。</p> 
<h5><a id="_case_286"></a>实战 case</h5> 
<p>此处同样我们实现一个：将所有 <code>react</code> 导入转换为 <code>preact</code> 的需求，所需要的依赖与模板代码如下：</p> 
<pre><code class="prism language-yml"><span class="token comment"># Cargo.toml 确保你含有这些依赖</span>
<span class="token punctuation">[</span>dependencies<span class="token punctuation">]</span>
napi = <span class="token punctuation">{<!-- --></span> version = "2.12.2"<span class="token punctuation">,</span> default<span class="token punctuation">-</span>features = false<span class="token punctuation">,</span> features = <span class="token punctuation">[</span><span class="token string">"napi4"</span><span class="token punctuation">,</span> <span class="token string">"error_anyhow"</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
napi<span class="token punctuation">-</span>derive = "2.12.2"
swc_common = <span class="token punctuation">{<!-- --></span> version = "0.31.12"<span class="token punctuation">,</span> features = <span class="token punctuation">[</span><span class="token string">"sourcemap"</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
swc_ecmascript = <span class="token punctuation">{<!-- --></span> version = "0.228.27"<span class="token punctuation">,</span> features = <span class="token punctuation">[</span><span class="token string">"parser"</span><span class="token punctuation">,</span> <span class="token string">"visit"</span><span class="token punctuation">,</span> <span class="token string">"codegen"</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-rust"><span class="token attribute attr-name">#[macro_use]</span>
<span class="token keyword">extern</span> <span class="token keyword">crate</span> <span class="token module-declaration namespace">napi_derive</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>path<span class="token punctuation">::</span></span><span class="token punctuation">{<!-- --></span><span class="token class-name">Path</span><span class="token punctuation">,</span> <span class="token class-name">PathBuf</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token keyword">str</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token namespace">swc_common<span class="token punctuation">::</span>comments<span class="token punctuation">::</span></span><span class="token class-name">SingleThreadedComments</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">swc_common<span class="token punctuation">::</span></span><span class="token punctuation">{<!-- --></span><span class="token namespace">sync<span class="token punctuation">::</span></span><span class="token class-name">Lrc</span><span class="token punctuation">,</span> <span class="token class-name">FileName</span><span class="token punctuation">,</span> <span class="token class-name">Globals</span><span class="token punctuation">,</span> <span class="token class-name">SourceMap</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">swc_ecmascript<span class="token punctuation">::</span></span>ast<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">swc_ecmascript<span class="token punctuation">::</span>codegen<span class="token punctuation">::</span>text_writer<span class="token punctuation">::</span></span><span class="token class-name">JsWriter</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">swc_ecmascript<span class="token punctuation">::</span>parser<span class="token punctuation">::</span>lexer<span class="token punctuation">::</span></span><span class="token class-name">Lexer</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">swc_ecmascript<span class="token punctuation">::</span>parser<span class="token punctuation">::</span></span><span class="token punctuation">{<!-- --></span><span class="token class-name">EsConfig</span><span class="token punctuation">,</span> <span class="token class-name">Parser</span><span class="token punctuation">,</span> <span class="token class-name">StringInput</span><span class="token punctuation">,</span> <span class="token class-name">Syntax</span><span class="token punctuation">,</span> <span class="token class-name">TsConfig</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">swc_ecmascript<span class="token punctuation">::</span>visit<span class="token punctuation">::</span></span><span class="token punctuation">{<!-- --></span><span class="token class-name">VisitMut</span><span class="token punctuation">,</span> <span class="token class-name">VisitMutWith</span><span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token attribute attr-name">#[napi]</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">transform</span><span class="token punctuation">(</span>code<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> options<span class="token punctuation">:</span> <span class="token class-name">ImportChange</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">String</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">let</span> is_jsx <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> is_typescript <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> filename_path_buf <span class="token operator">=</span> <span class="token class-name">PathBuf</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"filename.tsx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> syntax <span class="token operator">=</span> <span class="token keyword">if</span> is_typescript <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Syntax</span><span class="token punctuation">::</span><span class="token class-name">Typescript</span><span class="token punctuation">(</span><span class="token class-name">TsConfig</span> <span class="token punctuation">{<!-- --></span>
      tsx<span class="token punctuation">:</span> is_jsx<span class="token punctuation">,</span>
      decorators<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token punctuation">..</span><span class="token class-name">Default</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Syntax</span><span class="token punctuation">::</span><span class="token class-name">Es</span><span class="token punctuation">(</span><span class="token class-name">EsConfig</span> <span class="token punctuation">{<!-- --></span>
      jsx<span class="token punctuation">:</span> is_jsx<span class="token punctuation">,</span>
      export_default_from<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token punctuation">..</span><span class="token class-name">Default</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> source_map <span class="token operator">=</span> <span class="token class-name">Lrc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">SourceMap</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> source_file <span class="token operator">=</span> source_map<span class="token punctuation">.</span><span class="token function">new_source_file</span><span class="token punctuation">(</span>
    <span class="token class-name">FileName</span><span class="token punctuation">::</span><span class="token class-name">Real</span><span class="token punctuation">(</span>filename_path_buf<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    code<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> comments <span class="token operator">=</span> <span class="token class-name">SingleThreadedComments</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> lexer <span class="token operator">=</span> <span class="token class-name">Lexer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
    syntax<span class="token punctuation">,</span>
    <span class="token class-name">Default</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">StringInput</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token operator">*</span>source_file<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>comments<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> <span class="token keyword">mut</span> parser <span class="token operator">=</span> <span class="token class-name">Parser</span><span class="token punctuation">::</span><span class="token function">new_from</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> <span class="token keyword">mut</span> module <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parse_module</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">"failed to parse module"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token namespace">swc_common<span class="token punctuation">::</span></span><span class="token constant">GLOBALS</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token class-name">Globals</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> visitor <span class="token operator">=</span> options<span class="token punctuation">;</span>
    module<span class="token punctuation">.</span><span class="token function">visit_mut_with</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> visitor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> <span class="token punctuation">(</span>code<span class="token punctuation">,</span> _map<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">emit_source_code</span><span class="token punctuation">(</span>
    <span class="token class-name">Lrc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>source_map<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">Some</span><span class="token punctuation">(</span>comments<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token operator">&amp;</span>module<span class="token punctuation">,</span>
    <span class="token class-name">None</span><span class="token punctuation">,</span>
    <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  code
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[napi(object)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">ImportChange</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">pub</span> from<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
  <span class="token keyword">pub</span> to<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">ImportChange</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>from<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> to<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">Self</span> <span class="token punctuation">{<!-- --></span> from<span class="token punctuation">,</span> to <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">VisitMut</span> <span class="token keyword">for</span> <span class="token class-name">ImportChange</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">fn</span> <span class="token function-definition function">visit_mut_module_decl</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> decl<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token namespace">ast<span class="token punctuation">::</span></span><span class="token class-name">ModuleDecl</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token namespace">ast<span class="token punctuation">::</span></span><span class="token class-name">ModuleDecl</span><span class="token punctuation">::</span><span class="token class-name">Import</span><span class="token punctuation">(</span>import_decl<span class="token punctuation">)</span> <span class="token operator">=</span> decl <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> import_decl<span class="token punctuation">.</span>src<span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token keyword">self</span><span class="token punctuation">.</span>from <span class="token punctuation">{<!-- --></span>
        import_decl<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>to<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">emit_source_code</span><span class="token punctuation">(</span>
  source_map<span class="token punctuation">:</span> <span class="token class-name">Lrc</span><span class="token operator">&lt;</span><span class="token class-name">SourceMap</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  comments<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">SingleThreadedComments</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  program<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">ast<span class="token punctuation">::</span></span><span class="token class-name">Module</span><span class="token punctuation">,</span>
  root_dir<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token class-name">Path</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  source_maps<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token namespace">napi<span class="token punctuation">::</span></span><span class="token class-name">Error</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">let</span> <span class="token keyword">mut</span> src_map_buf <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> <span class="token keyword">mut</span> buf <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> writer <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">JsWriter</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
      <span class="token class-name">Lrc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>source_map<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">"\n"</span><span class="token punctuation">,</span>
      <span class="token operator">&amp;</span><span class="token keyword">mut</span> buf<span class="token punctuation">,</span>
      <span class="token keyword">if</span> source_maps <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> src_map_buf<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">None</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> config <span class="token operator">=</span> <span class="token namespace">swc_ecmascript<span class="token punctuation">::</span>codegen<span class="token punctuation">::</span></span><span class="token class-name">Config</span> <span class="token punctuation">{<!-- --></span>
      minify<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      target<span class="token punctuation">:</span> <span class="token namespace">ast<span class="token punctuation">::</span></span><span class="token class-name">EsVersion</span><span class="token punctuation">::</span><span class="token function">latest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      ascii_only<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      omit_last_semi<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> emitter <span class="token operator">=</span> <span class="token namespace">swc_ecmascript<span class="token punctuation">::</span>codegen<span class="token punctuation">::</span></span><span class="token class-name">Emitter</span> <span class="token punctuation">{<!-- --></span>
      cfg<span class="token punctuation">:</span> config<span class="token punctuation">,</span>
      comments<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>comments<span class="token punctuation">)</span><span class="token punctuation">,</span>
      cm<span class="token punctuation">:</span> <span class="token class-name">Lrc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>source_map<span class="token punctuation">)</span><span class="token punctuation">,</span>
      wr<span class="token punctuation">:</span> writer<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    emitter<span class="token punctuation">.</span><span class="token function">emit_module</span><span class="token punctuation">(</span>program<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> <span class="token keyword">mut</span> map_buf <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> emit_source_maps <span class="token operator">=</span> <span class="token keyword">if</span> source_maps <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> s <span class="token operator">=</span> source_map<span class="token punctuation">.</span><span class="token function">build_source_map</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>src_map_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>root_dir<span class="token punctuation">)</span> <span class="token operator">=</span> root_dir <span class="token punctuation">{<!-- --></span>
      s<span class="token punctuation">.</span><span class="token function">set_source_root</span><span class="token punctuation">(</span><span class="token class-name">Some</span><span class="token punctuation">(</span>root_dir<span class="token punctuation">.</span><span class="token function">to_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    s<span class="token punctuation">.</span><span class="token function">to_writer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> map_buf<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> emit_source_maps <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span>
      <span class="token keyword">unsafe</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">str</span><span class="token punctuation">::</span><span class="token function">from_utf8_unchecked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token keyword">unsafe</span> <span class="token punctuation">{<!-- --></span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token keyword">str</span><span class="token punctuation">::</span><span class="token function">from_utf8_unchecked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>map_buf<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsafe</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">str</span><span class="token punctuation">::</span><span class="token function">from_utf8_unchecked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">None</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_447"></a>构建</h5> 
<pre><code class="prism language-bash">  <span class="token comment"># dev</span>
  napi build --platform
  <span class="token comment"># release</span>
  napi build --release
</code></pre> 
<p>一般情况下，我们通常会分发至以下 <code>9</code> 个平台：</p> 
<pre><code class="prism language-ts">  <span class="token string-property property">"napi"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"triples"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"defaults"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token string-property property">"additional"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"x86_64-apple-darwin"</span><span class="token punctuation">,</span>
        <span class="token string">"aarch64-apple-darwin"</span><span class="token punctuation">,</span>
        <span class="token string">"x86_64-pc-windows-msvc"</span><span class="token punctuation">,</span>
        <span class="token string">"aarch64-pc-windows-msvc"</span><span class="token punctuation">,</span>
        <span class="token string">"x86_64-unknown-linux-gnu"</span><span class="token punctuation">,</span>
        <span class="token string">"aarch64-unknown-linux-gnu"</span><span class="token punctuation">,</span>
        <span class="token string">"x86_64-unknown-linux-musl"</span><span class="token punctuation">,</span>
        <span class="token string">"aarch64-unknown-linux-musl"</span><span class="token punctuation">,</span>
        <span class="token string">"armv7-unknown-linux-gnueabihf"</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>通常本地只能编译自己平台的 <code>.node</code> 二进制文件，所以需要依赖 Github Actions CI 等云环境进行多平台的构建，并且在 CICD 中构造好 npm 包使用 Npm Token 发布，此部分内容往往是大量的模板代码与调试过程，请自行研究学习。</p> 
<h5><a id="_479"></a>运行二进制包</h5> 
<pre><code class="prism language-ts"><span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> transform <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./index'</span>

<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
  <span class="token comment">// import React from 'preact'</span>
  <span class="token function">transform</span><span class="token punctuation">(</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">import React from 'react'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span> from<span class="token operator">:</span> <span class="token string">'react'</span><span class="token punctuation">,</span> to<span class="token operator">:</span> <span class="token string">'preact'</span> <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre> 
<p>直接导入 <code>napi</code> 生成的 <code>index.js</code> 胶水代码即可使用 <code>.node</code> 二进制包。</p> 
<h5><a id="_495"></a>缺点</h5> 
<ol><li> <p>通过构建 <code>.node</code> 分发至不同平台是目前最高运行效率、最小下载体积的方法，但相对应需要手动管理所有 Rust 代码，且多平台构建也强依赖云环境，这提出了一些较高的要求。</p> </li><li> <p>随着对 <code>napi</code> / Rust 异步、并发编程 / Swc 的理解精进，你可以写出更高运行效率的代码，得到更快的执行速度。但最简单的代码依然够用，因为现代计算机性能已经足够快，1s 还是 10s 的争论没有意义。</p> </li><li> <p>在开发过程中，你可能会遇到各种 Rust 构建相关的问题，请自行研究并解决。</p> </li></ol> 
<h3><a id="_503"></a>总结</h3> 
<p>本文对 Rust 浅尝辄止，如希望更有所作为，你可以通过不断精进 Rust ，组织出更优雅的代码结构，实现更高的执行效率。</p> 
<p>前端 AST 人尽皆知，如同开发 Babel 插件一样，开发 Rust Swc 插件已然成为现代前端的必修课，文本推荐只入门至 Swc 插件为止，已经能应对绝大多数场景。</p> 
<p>另外，对于性能上无需过多追求，由于计算机的性能已经过剩，不管是 wasm 还是 <code>.node</code> 速度都是很快的，秒级之争没有意义。</p> 
<p>以上。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8ceaf0dff2b466cb8213727a3aeca5ce/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">NextJs rootLayout 和路由上的嵌套布局（新手指南）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/02897e57513db1a7962caa53607a08ac/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">windows安全事件查看及安全事件id汇总</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>