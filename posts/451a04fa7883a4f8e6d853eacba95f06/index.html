<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Oracle对于误删误操作的数据进行恢复（flashback query、flashback drop、flashback table、flashback database） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Oracle对于误删误操作的数据进行恢复（flashback query、flashback drop、flashback table、flashback database）" />
<meta property="og:description" content="Oracle对于误删误操作的数据进行恢复。 日常工作中难免遇到自己或者别人误操作、删除、修改了数据库的数据。此时我们该如何恢复数据呢。 1、我们可以应用Flashback Query查询过去的数据 Flashback Query这一特性，最常被应用的就是修复误操作的数据了。注意，这并不是说Flashback Query能够恢复数据。Flashback Query本身不会恢复任何操作或修改，也不能告诉你做过什么操作或修改，实际上Flashback Query特性实际应用时，是基于标准SELECT的扩展，借助该特性能够让用户查询到指定时间点的表中的记录，相当于拥有了看到过去的能力，至于恢复，SELECT的结果都出来了，难道还不懂如何执行INSERT。 注意： Flashback Query查询过去的数据仅对delete 等dml语句有效，如果是通过truncate更改了数据是无法使用 Flashback Query查询过去的数据的 下面举个例子: 首先我准备了一张表，里面有两条数据。 此时我们执行delete语句 将数据删除。 使用flashback query查询 select * from O_MCHT_KEY_API_BAK as of timestamp to_timestamp(&#39;2020-03-13 11:00:57&#39;, &#39;yyyy-mm-dd hh24:mi:ss&#39;); 我们可以看到使用flashback query指定时间点为2020-03-13 11:00:57，可以查询到当时的数据是什么样，这个时候我们就可以把这两条数据重新复制出来插到表里，这样就完成了数据恢复。 注意： flashback query有时效性，太久之前的数据会被清除。 如果我们drop了表，该如何恢复呢？ 这里我们先把表drop掉，使用查询可以看到，表已经不存在 2、我们可以应用Flashback table恢复被drop操作的表 这时我们使用flashback query是无法查询到表的原来数据，此时可以使用flashback table。 flashback table O_MCHT_KEY_API_BAK to before drop; 再执行查询之后我们可以看到数据已经恢复成功。
当然flashback tabloe也可以用在对已经delete了的数据进行恢复。 此时我们先删除一行数据，然后执行 flashback table O_MCHT_KEY_API_BAK to timestamp to_timestamp(&#39;2020-03-13 11:00:57&#39;, &#39;yyyy-mm-dd hh24:mi:ss&#39;); 可以看到，此时恢复报错，提示[72000][8189] ORA-08189: 因为未启用行移动功能, 不能闪回表
这里只需要给对应的表开启行移动功能即可。 //开启表行移动功能 alter table T_TERM_MCHT_INFO enable row movement; 再次执行 flashback table O_MCHT_KEY_API_BAK to timestamp to_timestamp(&#39;2020-03-13 11:00:57&#39;, &#39;yyyy-mm-dd hh24:mi:ss&#39;); 可以看到被删除的一条记录已经恢复成功了。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/451a04fa7883a4f8e6d853eacba95f06/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-03-13T15:05:42+08:00" />
<meta property="article:modified_time" content="2020-03-13T15:05:42+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Oracle对于误删误操作的数据进行恢复（flashback query、flashback drop、flashback table、flashback database）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div> 
 <strong>Oracle对于误删误操作的数据进行恢复。</strong> 
</div> 
<div> 
 <strong>日常工作中难免遇到自己或者别人误操作、删除、修改了数据库的数据。此时我们该如何恢复数据呢。</strong> 
</div> 
<div>
    
</div> 
<div> 
 <strong>1、我们可以应用Flashback Query查询过去的数据</strong> 
</div> 
<div>
  Flashback Query这一特性，最常被应用的就是修复误操作的数据了。注意，这并不是说Flashback Query能够恢复数据。Flashback Query本身不会恢复任何操作或修改，也不能告诉你做过什么操作或修改，实际上Flashback Query特性实际应用时，是基于标准SELECT的扩展，借助该特性能够让用户查询到指定时间点的表中的记录，相当于拥有了看到过去的能力，至于恢复，SELECT的结果都出来了，难道还不懂如何执行INSERT。 
</div> 
<div>
  注意： 
 <strong>Flashback Query</strong>查询过去的数据仅对delete 等dml语句有效，如果是通过truncate更改了数据是无法使用 
 <strong>Flashback Query查询过去的数据的</strong> 
</div> 
<div>
  下面举个例子: 
</div> 
<div>
  首先我准备了一张表，里面有两条数据。 
</div> 
<div> 
 <img alt="" height="232" src="https://images2.imgbox.com/bd/3d/9nB3B3Vb_o.png" width="1200"> 
</div> 
<div>
    
</div> 
<div>
  此时我们执行delete语句 将数据删除。 
</div> 
<div>
    
</div> 
<div> 
 <img alt="" height="219" src="https://images2.imgbox.com/f3/ba/wotigyRY_o.png" width="1200"> 
</div> 
<div>
    
</div> 
<div>
  使用flashback query查询 
</div> 
<div> 
 <pre><code class="language-sql">select * from O_MCHT_KEY_API_BAK as of timestamp to_timestamp('2020-03-13 11:00:57', 'yyyy-mm-dd hh24:mi:ss');
</code></pre> 
 <p> </p> 
</div> 
<div> 
 <img alt="" height="242" src="https://images2.imgbox.com/fa/68/LseWbWys_o.png" width="1200"> 
</div> 
<div>
    
</div> 
<div>
  我们可以看到使用flashback query指定时间点为2020-03-13 11:00:57，可以查询到当时的数据是什么样，这个时候我们就可以把这两条数据重新复制出来插到表里，这样就完成了数据恢复。 
</div> 
<div>
  注意： flashback query有时效性，太久之前的数据会被清除。 
</div> 
<div>
  如果我们drop了表，该如何恢复呢？ 
</div> 
<div>
  这里我们先把表drop掉，使用查询可以看到，表已经不存在 
</div> 
<div> 
 <img alt="" height="116" src="https://images2.imgbox.com/77/ef/W5rk5Gx1_o.png" width="846"> 
</div> 
<div>
    
</div> 
<div>
    
</div> 
<div> 
 <strong>2、我们可以应用Flashback table恢复被drop操作的表</strong> 
</div> 
<div>
  这时我们使用flashback query是无法查询到表的原来数据，此时可以使用flashback table。 
</div> 
<div> 
 <pre><code class="language-sql">flashback table O_MCHT_KEY_API_BAK to before drop;</code></pre> 
 <p>再执行查询之后我们可以看到数据已经恢复成功。</p> 
</div> 
<div>
    
</div> 
<div> 
 <img alt="" height="246" src="https://images2.imgbox.com/49/47/XwMqW38Y_o.png" width="1200"> 
</div> 
<div>
    
</div> 
<div>
  当然flashback tabloe也可以用在对已经delete了的数据进行恢复。 
</div> 
<div>
    
</div> 
<div>
  此时我们先删除一行数据，然后执行 
</div> 
<div> 
 <pre><code class="language-sql">flashback table O_MCHT_KEY_API_BAK to timestamp to_timestamp('2020-03-13 11:00:57', 'yyyy-mm-dd hh24:mi:ss');</code></pre> 
 <p><span style="color:#000000;">可以看到，此时恢复报错，提示[72000][8189] ORA-08189: 因为未启用行移动功能, 不能闪回表</span></p> 
</div> 
<div>
  这里只需要给对应的表开启行移动功能即可。 
</div> 
<div> 
 <pre><code class="language-sql">//开启表行移动功能
alter table T_TERM_MCHT_INFO enable row movement;</code></pre> 
 <p> </p> 
</div> 
<div> 
 <img alt="" height="242" src="https://images2.imgbox.com/19/d1/Y6mljMkR_o.png" width="1200"> 
</div> 
<div>
    
</div> 
<div>
  再次执行 
</div> 
<div> 
 <pre><code class="language-sql">flashback table O_MCHT_KEY_API_BAK to timestamp to_timestamp('2020-03-13 11:00:57', 'yyyy-mm-dd hh24:mi:ss');</code></pre> 
 <p>可以看到被删除的一条记录已经恢复成功了。</p> 
</div> 
<div>
    
</div> 
<div> 
 <img alt="" height="263" src="https://images2.imgbox.com/e9/b7/3K5uMs2r_o.png" width="1200"> 
</div> 
<div>
    
</div> 
<div> 
 <strong>3、我们可以应用Flashback table恢复被drop操作的表（数据被delete了，且！！新增字段表结构被改变！！！）</strong> 
</div> 
<div>
  delete完数据之后，我们加了一列，此时再执行flashback quert 以及flashback table 
</div> 
<div> 
 <img alt="" height="487" src="https://images2.imgbox.com/75/42/aqs6AUbZ_o.png" width="839"> 
</div> 
<div>
  这里执行flashback query与falshback table 均可以恢复，但是新加的列被使用null填充。 
</div> 
<div>
  次执 
</div> 
<div> 
 <img alt="" height="329" src="https://images2.imgbox.com/38/30/LkFyEVo5_o.png" width="1200"> 
</div> 
<div> 
 <strong>4、当表里的数据被delete了，且！！删除</strong> 
 <strong><span style="color:#ff4635;">字段- - - -</span></strong> 
 <strong>表结构被改变！！！</strong> 
</div> 
<div>
  为了模拟这种情况，首先我们将这个表还原成原始状态并插入两条记录。 
</div> 
<div>
  过5分钟，我们删除表中一列，然后再按flashback query或者flashback table的方式恢复。执行完系统报错：[72000][1466] ORA-01466: 无法读取数据 - 表定义已更改 
</div> 
<div>
  因为系统闪回的数据已经跟当前状态的表不一致了。 
</div> 
<div> 
 <img alt="" height="257" src="https://images2.imgbox.com/66/c2/JFgqsv2Q_o.png" width="1133"> 
</div> 
<div>
    
</div> 
<div>
  此时如果要恢复之前的数据只能使用rename的方式，即将以前的数据按以前的表结构，恢复到另一张新表中，具体操作如下： 
</div> 
<div> 
 <pre><code class="language-sql">--将O_MCHT_KEY_API_BAK闪回并将数据转存到另一张表：O_MCHT_KEY_API_BAK_1
flashback table O_MCHT_KEY_API_BAK to before drop rename to O_MCHT_KEY_API_BAK_1;</code></pre> 
 <p> </p> 
</div> 
<div> 
 <img alt="" height="282" src="https://images2.imgbox.com/20/36/ON8KGJ1v_o.png" width="1200"> 
</div> 
<div>
  我们可以看到原始的数据已经被回复到我们rename之后的一张新表中。 
</div> 
<div>
    
</div> 
<div> 
 <strong>5、当表里的数据被truncate了，只能通过flashback database来恢复</strong> 
</div> 
<div>
  如果表被truncate了，那么flashback query、flashback table都没用了 
</div> 
<div>
  直接通过flashback database来恢复 
</div> 
<div>
  要使用flashback database 首先得确保FLASHBACK 是打开的，也就是下面你的语句 要返回YES 
</div> 
<div> 
 <img alt="" height="212" src="https://images2.imgbox.com/ba/ef/fuOcjCLQ_o.png" width="609">、 
</div> 
<div>
    
</div> 
<div>
  在FLASHBACK是打开的前提下，此时使用以下命令就能重新恢复。如果flashback没有打开，且你已经truncate table，那么恭喜你，找DBA吧，这是你跟他增进感情的绝佳机会！ 
</div> 
<div> 
 <pre><code class="language-sql">flashback database to timestamp to_timestamp('2020-03-13 14:31:26', 'yyyy-mm-dd hh24:mi:ss');</code></pre> 
 <p> </p> 
</div> 
<div>
    
</div> 
<div>
    
</div> 
<div>
    
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e8afd188db8cb2b9e087914767fc21ec/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">免费CDN：jsDeliver-Github-搭建过程记录</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/300a2cedd8b7ee561c1b1f0db28d7e05/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">五大常用算法—动态规划详解和经典题目(python)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>