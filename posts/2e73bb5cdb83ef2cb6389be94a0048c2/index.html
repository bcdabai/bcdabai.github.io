<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Java的四种引用类型 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Java的四种引用类型" />
<meta property="og:description" content="文章目录 一文读懂java中的Reference和引用类型简介强引用Strong Reference软引用Soft Reference弱引用weak Reference虚引用PhantomReferenceReference和ReferenceQueue四大状态三个Queue/List WeakHashMap总结(原作者) 在看JVM的时候，发现Java引用类型反复出现；遂找了一篇总结博客来学习。
一文读懂java中的Reference和引用类型 一文读懂java中的Reference和引用类型
简介 java中有值类型也有引用类型，引用类型一般是针对于java中对象来说的，今天介绍一下java中的引用类型。java为引用类型专门定义了一个类叫做Reference。Reference是跟java垃圾回收机制息息相关的类，通过探讨Reference的实现可以更加深入的理解java的垃圾回收是怎么工作的。
本文先从java中的四种引用类型开始，一步一步揭开Reference的面纱。
java中的四种引用类型分别是：强引用，软引用，弱引用和虚引用。
强引用Strong Reference java中的引用默认就是强引用，任何一个对象的赋值操作就产生了对这个对象的强引用。
我们看一个例子：
public class StrongReferenceUsage { @Test public void stringReference(){ Object obj = new Object(); } } 上面我们new了一个Object对象，并将其赋值给obj，这个obj就是new Object()的强引用。
强引用的特性是只要有强引用存在，被引用的对象就不会被垃圾回收。
软引用Soft Reference 软引用在java中有个专门的SoftReference类型，软引用的意思是只有在内存不足的情况下，被引用的对象才会被回收。
先看下SoftReference的定义：
public class SoftReference&lt;T&gt; extends Reference&lt;T&gt; SoftReference继承自Reference。它有两种构造函数：
public SoftReference(T referent) 和：
public SoftReference(T referent, ReferenceQueue&lt;? super T&gt; q) 第一个参数很好理解，就是软引用的对象，第二个参数叫做ReferenceQueue，是用来存储封装的待回收Reference对象的，ReferenceQueue中的对象是由Reference类中的ReferenceHandler内部类进行处理的。
我们举个SoftReference的例子：
@Test public void softReference(){ Object obj = new Object(); SoftReference&lt;Object&gt; soft = new SoftReference&lt;&gt;(obj); obj = null; log." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/2e73bb5cdb83ef2cb6389be94a0048c2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-01-09T10:00:13+08:00" />
<meta property="article:modified_time" content="2022-01-09T10:00:13+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Java的四种引用类型</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#javaReference_5" rel="nofollow">一文读懂java中的Reference和引用类型</a></li><li><a href="#_11" rel="nofollow">简介</a></li><li><a href="#Strong_Reference_19" rel="nofollow">强引用Strong Reference</a></li><li><a href="#Soft_Reference_39" rel="nofollow">软引用Soft Reference</a></li><li><a href="#weak_Reference_86" rel="nofollow">弱引用weak Reference</a></li><li><a href="#PhantomReference_123" rel="nofollow">虚引用PhantomReference</a></li><li><a href="#ReferenceReferenceQueue_170" rel="nofollow">Reference和ReferenceQueue</a></li><li><ul><li><a href="#_198" rel="nofollow">四大状态</a></li><li><a href="#QueueList_237" rel="nofollow">三个Queue/List</a></li></ul> 
  </li><li><a href="#WeakHashMap_249" rel="nofollow">WeakHashMap</a></li><li><a href="#_284" rel="nofollow">总结(原作者)</a></li></ul> 
</div> 
<p></p> 
<blockquote> 
 <p>在看JVM的时候，发现Java引用类型反复出现；遂找了一篇总结博客来学习。</p> 
</blockquote> 
<h2><a id="javaReference_5"></a>一文读懂java中的Reference和引用类型</h2> 
<p>一文读懂java中的Reference和引用类型</p> 
<h2><a id="_11"></a>简介</h2> 
<p>java中有值类型也有引用类型，引用类型一般是针对于java中对象来说的，今天介绍一下java中的引用类型。java为引用类型专门定义了一个类叫做Reference。Reference是跟java垃圾回收机制息息相关的类，通过探讨Reference的实现可以更加深入的理解java的垃圾回收是怎么工作的。</p> 
<p>本文先从java中的四种引用类型开始，一步一步揭开Reference的面纱。</p> 
<p>java中的四种引用类型分别是：强引用，软引用，弱引用和虚引用。</p> 
<h2><a id="Strong_Reference_19"></a>强引用Strong Reference</h2> 
<p>java中的引用默认就是强引用，任何一个对象的赋值操作就产生了对这个对象的强引用。</p> 
<p>我们看一个例子：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StrongReferenceUsage</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">stringReference</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Object</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上面我们new了一个Object对象，并将其赋值给obj，这个obj就是new Object()的强引用。</p> 
<p>强引用的特性是只要有强引用存在，被引用的对象就不会被垃圾回收。</p> 
<h2><a id="Soft_Reference_39"></a>软引用Soft Reference</h2> 
<p>软引用在java中有个专门的SoftReference类型，软引用的意思是只有在内存不足的情况下，被引用的对象才会被回收。</p> 
<p>先看下SoftReference的定义：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SoftReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">Reference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>SoftReference继承自Reference。它有两种构造函数：</p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token class-name">SoftReference</span><span class="token punctuation">(</span><span class="token class-name">T</span> referent<span class="token punctuation">)</span> 
</code></pre> 
<p>和：</p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token class-name">SoftReference</span><span class="token punctuation">(</span><span class="token class-name">T</span> referent<span class="token punctuation">,</span> <span class="token class-name">ReferenceQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> q<span class="token punctuation">)</span> 
</code></pre> 
<p>第一个参数很好理解，就是软引用的对象，第二个参数叫做ReferenceQueue，是用来存储封装的待回收Reference对象的，ReferenceQueue中的对象是由Reference类中的ReferenceHandler内部类进行处理的。</p> 
<p>我们举个SoftReference的例子：</p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">softReference</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Object</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SoftReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> soft <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SoftReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        obj <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">,</span>soft<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">,</span>soft<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>输出结果：</p> 
<pre><code class="prism language-java"><span class="token number">22</span><span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">43.733</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> INFO <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>flydean<span class="token punctuation">.</span></span>SoftReferenceUsage</span> <span class="token operator">-</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Object</span><span class="token annotation punctuation">@71bc1ae4</span>
<span class="token number">22</span><span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">43.749</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> INFO <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>flydean<span class="token punctuation">.</span></span>SoftReferenceUsage</span> <span class="token operator">-</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Object</span><span class="token annotation punctuation">@71bc1ae4</span>
</code></pre> 
<p>可以看到在内存充足的情况下，SoftReference引用的对象是不会被回收的。</p> 
<h2><a id="weak_Reference_86"></a>弱引用weak Reference</h2> 
<p>weakReference和softReference很类似，不同的是weekReference引用的对象只要垃圾回收执行，就会被回收，而不管是否内存不足。</p> 
<p>同样的WeakReference也有两个构造函数：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">WeakReference</span><span class="token punctuation">(</span><span class="token class-name">T</span> referent<span class="token punctuation">)</span>；

 <span class="token keyword">public</span> <span class="token class-name">WeakReference</span><span class="token punctuation">(</span><span class="token class-name">T</span> referent<span class="token punctuation">,</span> <span class="token class-name">ReferenceQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> q<span class="token punctuation">)</span>；
</code></pre> 
<p>含义和SoftReference一致，这里就不再重复表述了。</p> 
<p>我们看下弱引用的例子：</p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">weakReference</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Object</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> weak <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        obj <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">,</span>weak<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">,</span>weak<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>输出结果：</p> 
<pre><code class="prism language-java"><span class="token number">22</span><span class="token operator">:</span><span class="token number">58</span><span class="token operator">:</span><span class="token number">02.019</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> INFO <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>flydean<span class="token punctuation">.</span></span>WeakReferenceUsage</span> <span class="token operator">-</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Object</span><span class="token annotation punctuation">@71bc1ae4</span>
<span class="token number">22</span><span class="token operator">:</span><span class="token number">58</span><span class="token operator">:</span><span class="token number">02.047</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> INFO <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>flydean<span class="token punctuation">.</span></span>WeakReferenceUsage</span> <span class="token operator">-</span> <span class="token keyword">null</span>
</code></pre> 
<p>我们看到gc过后，弱引用的对象被回收掉了。</p> 
<h2><a id="PhantomReference_123"></a>虚引用PhantomReference</h2> 
<p>PhantomReference的作用是跟踪垃圾回收器收集对象的活动，在GC的过程中，如果发现有PhantomReference，GC则会将引用放到ReferenceQueue中，由程序员自己处理，当程序员调用ReferenceQueue.pull()方法，将引用出ReferenceQueue移除之后，Reference对象会变成Inactive状态，意味着被引用的对象可以被回收了。</p> 
<p>和SoftReference和WeakReference不同的是，PhantomReference只有一个构造函数，必须传入ReferenceQueue：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">PhantomReference</span><span class="token punctuation">(</span><span class="token class-name">T</span> referent<span class="token punctuation">,</span> <span class="token class-name">ReferenceQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> q<span class="token punctuation">)</span>
</code></pre> 
<p>看一个PhantomReference的例子：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PhantomReferenceUsage</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">usePhantomReference</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ReferenceQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> rq <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PhantomReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> phantomReference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PhantomReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span>rq<span class="token punctuation">)</span><span class="token punctuation">;</span>
        obj <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">,</span>phantomReference<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Reference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> r <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Reference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>rq<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">,</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>运行结果：</p> 
<pre><code class="prism language-java"><span class="token number">07</span><span class="token operator">:</span><span class="token number">06</span><span class="token operator">:</span><span class="token number">46.336</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> INFO <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>flydean<span class="token punctuation">.</span></span>PhantomReferenceUsage</span> <span class="token operator">-</span> <span class="token keyword">null</span>
<span class="token number">07</span><span class="token operator">:</span><span class="token number">06</span><span class="token operator">:</span><span class="token number">46.353</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> INFO <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>flydean<span class="token punctuation">.</span></span>PhantomReferenceUsage</span> <span class="token operator">-</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>ref<span class="token punctuation">.</span></span>PhantomReference</span><span class="token annotation punctuation">@136432db</span>
</code></pre> 
<p>我们看到get的值是null，而GC过后，poll是有值的。</p> 
<p>因为PhantomReference引用的是需要被垃圾回收的对象，所以在类的定义中，get一直都是返回null：</p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h2><a id="ReferenceReferenceQueue_170"></a>Reference和ReferenceQueue</h2> 
<p>讲完上面的四种引用,接下来我们谈一下他们的父类Reference和ReferenceQueue的作用。</p> 
<p>Reference是一个抽象类，每个Reference都有一个指向的对象，在Reference中有5个非常重要的属性：referent，next，discovered，pending，queue。</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token class-name">T</span> referent<span class="token punctuation">;</span>         <span class="token comment">/* Treated specially by GC */</span>
<span class="token keyword">volatile</span> <span class="token class-name">ReferenceQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> queue<span class="token punctuation">;</span>
<span class="token class-name">Reference</span> next<span class="token punctuation">;</span>
<span class="token keyword">transient</span> <span class="token keyword">private</span> <span class="token class-name">Reference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> discovered<span class="token punctuation">;</span>  <span class="token comment">/* used by VM */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Reference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> pending <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
</code></pre> 
<p>每个Reference都可以看成是一个节点，多个Reference通过next，discovered和pending这三个属性进行关联。</p> 
<p>先用一张图来对Reference有个整体的概念：</p> 
<p><img src="https://images2.imgbox.com/73/26/WYSLYHPA_o.png" alt="img"></p> 
<p>referent就是Reference实际引用的对象。</p> 
<p>通过next属性，可以构建ReferenceQueue。</p> 
<p>通过discovered属性，可以构建Discovered List。</p> 
<p>通过pending属性，可以构建Pending List。</p> 
<h3><a id="_198"></a>四大状态</h3> 
<p>在讲这三个Queue/List之前，我们先讲一下Reference的四个状态：</p> 
<p><img src="https://images2.imgbox.com/58/38/HFsDwW6p_o.png" alt="img"></p> 
<p>从上面的图中，我们可以看到一个Reference可以有四个状态。</p> 
<p>因为Reference有两个构造函数，一个带ReferenceQueue,一个不带。</p> 
<pre><code class="prism language-java">    <span class="token class-name">Reference</span><span class="token punctuation">(</span><span class="token class-name">T</span> referent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">(</span>referent<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Reference</span><span class="token punctuation">(</span><span class="token class-name">T</span> referent<span class="token punctuation">,</span> <span class="token class-name">ReferenceQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> queue<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>referent <span class="token operator">=</span> referent<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>queue <span class="token operator">=</span> <span class="token punctuation">(</span>queue <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token class-name">ReferenceQueue</span><span class="token punctuation">.</span>NULL <span class="token operator">:</span> queue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>对于带ReferenceQueue的Reference，GC会把要回收对象的Reference放到ReferenceQueue中，后续该Reference需要程序员自己处理（调用poll方法）。</p> 
<p>不带ReferenceQueue的Reference，由GC自己处理，待回收的对象其Reference状态会变成Inactive。</p> 
<p>创建好了Reference，就进入active状态。</p> 
<p>active状态下，如果引用对象的可到达状态发送变化就会转变成Inactive或Pending状态。</p> 
<p>Inactive状态很好理解，到达Inactive状态的Reference状态不能被改变，会等待GC回收。</p> 
<p>Pending状态代表等待入Queue，Reference内部有个ReferenceHandler，会调用enqueue方法，将Pending对象入到Queue中。</p> 
<p>入Queue的对象，其状态就变成了Enqueued。</p> 
<p>Enqueued状态的对象，如果调用poll方法从ReferenceQueue拿出，则该Reference的状态就变成了Inactive，等待GC的回收。</p> 
<p>这就是Reference的一个完整的生命周期。</p> 
<h3><a id="QueueList_237"></a>三个Queue/List</h3> 
<p>有了上面四个状态的概念，我们接下来讲三个Queue/List：ReferenceQueue，discovered List和pending List。</p> 
<p>ReferenceQueue在讲状态的时候已经讲过了，它本质是由Reference中的next连接而成的。用来存储GC待回收的对象。</p> 
<p>pending List就是待入ReferenceQueue的list。</p> 
<p>discovered List这个有点特别，在Pending状态时候，discovered List就等于pending List。</p> 
<p>在Active状态的时候，discovered List实际上维持的是一个引用链。通过这个引用链，我们可以获得引用的链式结构，当某个Reference状态不再是Active状态时，需要将这个Reference从discovered List中删除。</p> 
<h2><a id="WeakHashMap_249"></a>WeakHashMap</h2> 
<p>最后讲一下WeakHashMap，WeakHashMap跟WeakReference有点类似，在WeakHashMap如果key不再被使用，被赋值为null的时候，该key对应的Entry会自动从WeakHashMap中删除。</p> 
<p>我们举个例子：</p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">useWeakHashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">WeakHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> key1<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> value1<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> key2<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> value2<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key1<span class="token punctuation">,</span> value1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key2<span class="token punctuation">,</span> value2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">,</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>

        key1 <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">,</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
</code></pre> 
<p>输出结果：</p> 
<pre><code class="prism language-java"><span class="token punctuation">[</span>main<span class="token punctuation">]</span> INFO <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>flydean<span class="token punctuation">.</span></span>WeakHashMapUsage</span> <span class="token operator">-</span> <span class="token punctuation">{<!-- --></span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Object</span><span class="token annotation punctuation">@14899482</span><span class="token operator">=</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Object</span><span class="token annotation punctuation">@2437c6dc</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Object</span><span class="token annotation punctuation">@11028347</span><span class="token operator">=</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Object</span><span class="token annotation punctuation">@1f89ab83</span><span class="token punctuation">}</span>
<span class="token punctuation">[</span>main<span class="token punctuation">]</span> INFO <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>flydean<span class="token punctuation">.</span></span>WeakHashMapUsage</span> <span class="token operator">-</span> <span class="token punctuation">{<!-- --></span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Object</span><span class="token annotation punctuation">@14899482</span><span class="token operator">=</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Object</span><span class="token annotation punctuation">@2437c6dc</span><span class="token punctuation">}</span>
</code></pre> 
<p>可以看到gc过后，WeakHashMap只有一个Entry了。</p> 
<h2><a id="_284"></a>总结(原作者)</h2> 
<p>本文讲解了4个java中的引用类型，并深入探讨了Reference的内部机制，感兴趣的小伙伴可以留言一起讨论。</p> 
<p>本文的例子https://github.com/ddean2009/learn-java-collections</p> 
<blockquote> 
 <p>欢迎关注我的公众号:程序那些事，更多精彩等着您！<br> 更多内容请访问 <a href="http://www.flydean.com/java-reference-referencetype/" rel="nofollow">www.flydean.com</a></p> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f4d92366f81b8828e162627f145ae106/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">MySQL学习记录（五）-排序、连接、null值处理</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b0d3b551af8256d34656af2dde327a36/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">SimpleDateFormat使用</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>