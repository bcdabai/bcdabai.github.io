<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>机器学习还能预测心血管疾病？没错，我用python写出来了 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="机器学习还能预测心血管疾病？没错，我用python写出来了" />
<meta property="og:description" content="CDA数据分析师 出品 作者：Mika
数据：真达 后期：Mika
【导读】手把手教你如何用python写出心血管疾病预测模型。
全球每年约有1700万人死于心血管疾病，当中主要表现为心肌梗死和心力衰竭。当心脏不能泵出足够的血液来满足人体的需要时，就会发生心力衰竭，通常由糖尿病、高血压或其他心脏疾病引起。
在检测心血管疾病的早期症状时，机器学习就能派上用场了。通过患者的电子病历，可以记录患者的症状、身体特征、临床实验室测试值，从而进行生物统计分析，这能够发现那些医生无法检测到的模式和相关性。
尤其通过机器学习，根据数据就能预测患者的存活率，今天我们就教大家如何用Python写一个心血管疾病的预测模型。
研究背景和数据来源
我们用到的数据集来自Davide Chicco和Giuseppe Jurman发表的论文：《机器学习可以仅通过血肌酐和射血分数来预测心力衰竭患者的生存率》。
他们收集整理了299名心力衰竭患者的医疗记录，这些患者数据来自2015年4月至12月间巴基斯坦费萨拉巴德心脏病研究所和费萨拉巴德联合医院。这些患者由105名女性和194名男性组成，年龄在40至95岁之间。所有299例患者均患有左心室收缩功能不全，并曾出现过心力衰竭。
Davide和Giuseppe应用了多个机器学习分类器来预测患者的生存率，并根据最重要的危险因素对特征进行排序。同时还利用传统的生物统计学测试进行了另一种特征排序分析，并将这些结果与机器学习算法提供的结果进行比较。
他们分析对比了心力衰竭患者的一系列数据，最终发现根据血肌酐和射血分数这两项数据能够很好的预测心力衰竭患者的存活率。
今天我们就教教大家，如果根据这共13个字段的299 条病人诊断记录，用Python写出预测心力衰竭患者存活率的预测模型。
下面是具体的步骤和关键代码。
01、数据理解
数据取自于kaggle平台分享的心血管疾病数据集，共有13个字段299 条病人诊断记录。具体的字段概要如下：
02、数据读入和初步处理
首先导入所需包。
# 数据整理 import numpy as np import pandas as pd # 可视化 import matplotlib.pyplot as plt import seaborn as sns import plotly as py import plotly.graph_objs as go import plotly.express as px import plotly.figure_factory as ff # 模型建立 from sklearn.linear_model import LogisticRegression from sklearn.tree import DecisionTreeClassifier from sklearn." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/403b708ca7e950b81892245909cb7260/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-09-07T10:41:55+08:00" />
<meta property="article:modified_time" content="2020-09-07T10:41:55+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">机器学习还能预测心血管疾病？没错，我用python写出来了</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p><img alt="" src="https://images2.imgbox.com/46/84/35WISU3W_o.png"></p> 
<p>CDA数据分析师 出品  </p> 
<p>作者：Mika</p> 
<p>数据：真达  </p> 
<p>后期：Mika</p> 
<p>【导读】手把手教你如何用python写出心血管疾病预测模型。</p> 
<p>全球每年约有1700万人死于心血管疾病，当中主要表现为心肌梗死和心力衰竭。当心脏不能泵出足够的血液来满足人体的需要时，就会发生心力衰竭，通常由糖尿病、高血压或其他心脏疾病引起。</p> 
<p>在检测心血管疾病的早期症状时，机器学习就能派上用场了。通过患者的电子病历，可以记录患者的症状、身体特征、临床实验室测试值，从而进行生物统计分析，这能够发现那些医生无法检测到的模式和相关性。</p> 
<p>尤其通过机器学习，根据数据就能预测患者的存活率，今天我们就教大家如何用Python写一个心血管疾病的预测模型。</p> 
<p><strong>研究背景和数据来源</strong></p> 
<p>我们用到的数据集来自Davide Chicco和Giuseppe Jurman发表的论文：<em>《机器学习可以仅通过血肌酐和射血分数来预测心力衰竭患者的生存率》</em>。</p> 
<p>他们收集整理了299名心力衰竭患者的医疗记录，这些患者数据来自2015年4月至12月间巴基斯坦费萨拉巴德心脏病研究所和费萨拉巴德联合医院。这些患者由105名女性和194名男性组成，年龄在40至95岁之间。所有299例患者均患有左心室收缩功能不全，并曾出现过心力衰竭。</p> 
<p>Davide和Giuseppe应用了多个机器学习分类器来预测患者的生存率，并根据最重要的危险因素对特征进行排序。同时还利用传统的生物统计学测试进行了另一种特征排序分析，并将这些结果与机器学习算法提供的结果进行比较。</p> 
<p>他们分析对比了心力衰竭患者的一系列数据，最终发现根据血肌酐和射血分数这两项数据能够很好的预测心力衰竭患者的存活率。</p> 
<p>今天我们就教教大家，如果根据这共13个字段的299 条病人诊断记录，用Python写出预测心力衰竭患者存活率的预测模型。</p> 
<p><strong>下面是具体的步骤和关键代码。</strong></p> 
<p><em><strong>01、</strong></em><strong>数据理解</strong></p> 
<p>数据取自于kaggle平台分享的心血管疾病数据集，共有13个字段299 条病人诊断记录。具体的字段概要如下：</p> 
<p><img alt="" src="https://images2.imgbox.com/7b/2f/5rtMD2Ts_o.png"></p> 
<p><em><strong>02、</strong></em><strong>数据读入和初步处理</strong></p> 
<p>首先导入所需包。</p> 
<pre># 数据整理
import numpy as np 
import pandas as pd 

# 可视化
import matplotlib.pyplot as plt
import seaborn as sns
import plotly as py 
import plotly.graph_objs as go
import plotly.express as px
import plotly.figure_factory as ff

# 模型建立
from sklearn.linear_model import LogisticRegression
from sklearn.tree import DecisionTreeClassifier
from sklearn.ensemble import GradientBoostingClassifier, RandomForestClassifier
import lightgbm

# 前处理
from sklearn.preprocessing import StandardScaler

# 模型评估
from sklearn.model_selection import train_test_split, GridSearchCV
from sklearn.metrics import plot_confusion_matrix, confusion_matrix, f1_score
</pre> 
<p> </p> 
<p>加载并预览数据集：</p> 
<pre># 读入数据
df = pd.read_csv('./data/heart_failure.csv')
df.head() </pre> 
<p><img alt="" src="https://images2.imgbox.com/ea/45/EZZKRd3A_o.png"></p> 
<p><em><strong>03、</strong></em><strong>探索性分析</strong></p> 
<p><strong>1. 描述性分析</strong></p> 
<pre>df.describe().T</pre> 
<p><img alt="" src="https://images2.imgbox.com/70/89/GAScdmdh_o.png"></p> 
<p>从上述描述性分析结果简单总结如下：</p> 
<ul><li>是否死亡：平均的死亡率为32%；</li><li>年龄分布：平均年龄60岁，最小40岁，最大95岁</li><li>是否有糖尿病：有41.8%患有糖尿病</li><li>是否有高血压：有35.1%患有高血压</li><li>是否抽烟：有32.1%有抽烟</li></ul> 
<p><strong>2. 目标变量</strong></p> 
<pre># 产生数据
death_num = df['DEATH_EVENT'].value_counts() 
death_num = death_num.reset_index()

# 饼图
fig = px.pie(death_num, names='index', values='DEATH_EVENT')
fig.update_layout(title_text='目标变量DEATH_EVENT的分布')  
py.offline.plot(fig, filename='./html/目标变量DEATH_EVENT的分布.html')</pre> 
<p>总共有299人，其中随访期未存活人数96人，占总人数的32.1%</p> 
<p><strong>3. 贫血</strong></p> 
<p><img alt="" src="https://images2.imgbox.com/c0/8a/R3ci2JD8_o.png"></p> 
<p>从图中可以看出，有贫血症状的患者死亡概率较高，为35.66%。</p> 
<pre>bar1 = draw_categorical_graph(df['anaemia'], df['DEATH_EVENT'], title='红细胞、血红蛋白减少和是否存活')
bar1.render('./html/红细胞血红蛋白减少和是否存活.html')  
</pre> 
<p><strong>4. 年龄</strong></p> 
<p><img alt="" src="https://images2.imgbox.com/d0/fd/OsYzfz2E_o.png"></p> 
<p>从直方图可以看出，在患心血管疾病的病人中年龄分布差异较大，表现趋势为年龄越大，生存比例越低、死亡的比例越高。</p> 
<pre># 产生数据
surv = df[df['DEATH_EVENT'] == 0]['age']
not_surv = df[df['DEATH_EVENT'] == 1]['age']

hist_data = [surv, not_surv]
group_labels = ['Survived', 'Not Survived']

# 直方图
fig = ff.create_distplot(hist_data, group_labels, bin_size=0.5) 
fig.update_layout(title_text='年龄和生存状态关系') 
py.offline.plot(fig, filename='./html/年龄和生存状态关系.html')  </pre> 
<p><strong>5. 年龄/性别</strong></p> 
<p><img alt="" src="https://images2.imgbox.com/d3/b7/7m36AUyC_o.png"></p> 
<p>从分组统计和图形可以看出，不同性别之间生存状态没有显著性差异。在死亡的病例中，男性的平均年龄相对较高。</p> 
<p><strong>6. 年龄/抽烟</strong></p> 
<p><img alt="" src="https://images2.imgbox.com/74/98/qADbZS0O_o.png"></p> 
<p>数据显示，整体来看，是否抽烟与生存与否没有显著相关性。但是当我们关注抽烟的人群中，年龄在50岁以下生存概率较高。</p> 
<p><strong>7. 磷酸肌酸激酶(CPK)</strong></p> 
<p><img alt="" src="https://images2.imgbox.com/ca/37/wqWvNt1s_o.png"></p> 
<p>从直方图可以看出，血液中CPK酶的水平较高的人群死亡的概率较高。</p> 
<p><strong>8. 射血分数</strong></p> 
<p><img alt="" src="https://images2.imgbox.com/f5/0d/EBBEQUUC_o.png"></p> 
<p>射血分数代表了心脏的泵血功能，过高和过低水平下，生存的概率较低。</p> 
<p><strong>9. 血小板</strong></p> 
<p><img alt="" src="https://images2.imgbox.com/26/8a/fN5Ges0j_o.png"></p> 
<p>血液中血小板（100~300）×10^9个/L，较高或较低的水平则代表不正常，存活的概率较低。</p> 
<p><strong>10. 血肌酐水平</strong></p> 
<p><img alt="" src="https://images2.imgbox.com/e8/f9/3VJUKN8s_o.png"></p> 
<p>血肌酐是检测肾功能的最常用指标，较高的指数代表肾功能不全、肾衰竭，有较高的概率死亡。</p> 
<p><strong>11. 血清钠水平</strong></p> 
<p><img alt="" src="https://images2.imgbox.com/22/62/RvXLwrcB_o.png"></p> 
<p>图形显示，血清钠较高或较低往往伴随着风险。</p> 
<p><strong>12. 相关性分析</strong></p> 
<p><img alt="" src="https://images2.imgbox.com/c0/24/o4OSf9ap_o.png"></p> 
<p>从数值型属性的相关性图可以看出，变量之间没有显著的共线性关系。</p> 
<pre>num_df = df[['age', 'creatinine_phosphokinase', 'ejection_fraction', 'platelets',
                  'serum_creatinine', 'serum_sodium']]

plt.figure(figsize=(12, 12))
sns.heatmap(num_df.corr(), vmin=-1, cmap='coolwarm', linewidths=0.1, annot=True)
plt.title('Pearson correlation coefficient between numeric variables', fontdict={'fontsize': 15})
plt.show() </pre> 
<p><em><strong>04、</strong></em><strong>特征筛选</strong></p> 
<p>我们使用统计方法进行特征筛选，目标变量DEATH_EVENT是分类变量时，当自变量是分类变量，使用卡方鉴定，自变量是数值型变量，使用方差分析。</p> 
<pre># 划分X和y
X = df.drop('DEATH_EVENT', axis=1)
y = df['DEATH_EVENT'] </pre> 
<pre>from feature_selection import Feature_select

fs = Feature_select(num_method='anova', cate_method='kf') 
X_selected = fs.fit_transform(X, y) 
X_selected.head() </pre> 
<pre>2020 17:19:49 INFO attr select success!
After select attr: ['serum_creatinine', 'serum_sodium', 'ejection_fraction', 'age', 'time']</pre> 
<p><img alt="" src="https://images2.imgbox.com/37/e4/klSenlHN_o.png"></p> 
<p><em><strong>05、</strong></em><strong>数据建模</strong></p> 
<p>首先划分训练集和测试集。</p> 
<pre># 划分训练集和测试集
Features = X_selected.columns
X = df[Features] 
y = df["DEATH_EVENT"] 
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, stratify=y, 
                                                    random_state=2020)</pre> 
<pre># 标准化
scaler = StandardScaler()
scaler_Xtrain = scaler.fit_transform(X_train) 
scaler_Xtest = scaler.fit_transform(X_test) 

lr = LogisticRegression()
lr.fit(scaler_Xtrain, y_train)
test_pred = lr.predict(scaler_Xtest)

# F1-score
print("F1_score of LogisticRegression is : ", round(f1_score(y_true=y_test, y_pred=test_pred),2)) 
</pre> 
<p>我们使用决策树进行建模，设置特征选择标准为gini，树的深度为5。输出混淆矩阵图：在这个案例中，1类是我们关注的对象。</p> 
<pre># DecisionTreeClassifier
clf = DecisionTreeClassifier(criterion='gini', max_depth=5, random_state=1)
clf.fit(X_train, y_train)
test_pred = clf.predict(X_test)  

# F1-score
print("F1_score of DecisionTreeClassifier is : ", round(f1_score(y_true=y_test, y_pred=test_pred),2)) 

# 绘图
plt.figure(figsize=(10, 7))
plot_confusion_matrix(clf, X_test, y_test, cmap='Blues') 
plt.title("DecisionTreeClassifier - Confusion Matrix", fontsize=15)
plt.xticks(range(2), ["Heart Not Failed","Heart Fail"], fontsize=12)
plt.yticks(range(2), ["Heart Not Failed","Heart Fail"], fontsize=12)
plt.show()  </pre> 
<pre>F1_score of DecisionTreeClassifier is :  0.61
&lt;Figure size 720x504 with 0 Axes&gt;
</pre> 
<p><img alt="" src="https://images2.imgbox.com/67/60/ziiq1EvZ_o.png"></p> 
<p>使用网格搜索进行参数调优，优化标准为f1。</p> 
<pre>parameters = {'splitter':('best','random'),
              'criterion':("gini","entropy"),
              "max_depth":[*range(1, 20)],
             }

clf = DecisionTreeClassifier(random_state=1) 
GS = GridSearchCV(clf, param_grid=parameters, cv=10, scoring='f1', n_jobs=-1) 
GS.fit(X_train, y_train)

print(GS.best_params_) 
print(GS.best_score_) </pre> 
<pre>{'criterion': 'entropy', 'max_depth': 3, 'splitter': 'best'}
0.7638956305132776</pre> 
<p>使用最优的模型重新评估测试集效果：</p> 
<pre>test_pred = GS.best_estimator_.predict(X_test)

# F1-score
print("F1_score of DecisionTreeClassifier is : ", round(f1_score(y_true=y_test, y_pred=test_pred),2)) 

# 绘图
plt.figure(figsize=(10, 7))
plot_confusion_matrix(GS, X_test, y_test, cmap='Blues') 
plt.title("DecisionTreeClassifier - Confusion Matrix", fontsize=15)
plt.xticks(range(2), ["Heart Not Failed","Heart Fail"], fontsize=12)
plt.yticks(range(2), ["Heart Not Failed","Heart Fail"], fontsize=12)
plt.show() </pre> 
<p><img alt="" src="https://images2.imgbox.com/06/ce/s2MJHaZA_o.png"></p> 
<p>使用随机森林</p> 
<pre># RandomForestClassifier
rfc = RandomForestClassifier(n_estimators=1000, random_state=1)

parameters = {'max_depth': np.arange(2, 20, 1) }
GS = GridSearchCV(rfc, param_grid=parameters, cv=10, scoring='f1', n_jobs=-1)  
GS.fit(X_train, y_train)  

print(GS.best_params_) 
print(GS.best_score_) 

test_pred = GS.best_estimator_.predict(X_test)

# F1-score
print("F1_score of RandomForestClassifier is : ", 
      round(f1_score(y_true=y_test, y_pred=test_pred),2)) </pre> 
<pre>{'max_depth': 3}
0.791157747481277
F1_score of RandomForestClassifier is :  0.53</pre> 
<p>使用Boosting</p> 
<pre>gbl = GradientBoostingClassifier(n_estimators=1000, random_state=1)

parameters = {'max_depth': np.arange(2, 20, 1) }
GS = GridSearchCV(gbl, param_grid=parameters, cv=10, scoring='f1', n_jobs=-1)  
GS.fit(X_train, y_train)  

print(GS.best_params_) 
print(GS.best_score_) 

# 测试集
test_pred = GS.best_estimator_.predict(X_test)

# F1-score
print("F1_score of GradientBoostingClassifier is : ", 
      round(f1_score(y_true=y_test, y_pred=test_pred),2))</pre> 
<pre>{'max_depth': 3}
0.7288420428900305
F1_score of GradientBoostingClassifier is :  0.65</pre> 
<p>使用LGBMClassifier</p> 
<pre>lgb_clf = lightgbm.LGBMClassifier(boosting_type='gbdt', random_state=1)

parameters = {'max_depth': np.arange(2, 20, 1) }
GS = GridSearchCV(lgb_clf, param_grid=parameters, cv=10, scoring='f1', n_jobs=-1)  
GS.fit(X_train, y_train)  

print(GS.best_params_) 
print(GS.best_score_) 

# 测试集
test_pred = GS.best_estimator_.predict(X_test)

# F1-score
print("F1_score of LGBMClassifier is : ", round(f1_score(y_true=y_test, y_pred=test_pred),2)) </pre> 
<pre>{'max_depth': 2}
0.780378102289867
F1_score of LGBMClassifier is :  0.74</pre> 
<p>以下为各模型在测试集上的表现效果对比：</p> 
<p>LogisticRegression：0.63</p> 
<p>DecisionTree Classifier：0.73</p> 
<p>Random Forest Classifier: 0.53</p> 
<p>GradientBoosting Classifier: 0.65</p> 
<p>LGBM Classifier: 0.74</p> 
<p> </p> 
<p><em>参考链接：</em></p> 
<p><em>Machine learning can predict survival of patients with heart failure from serum creatinine and ejection fraction alone</em></p> 
<p><em>https://bmcmedinformdecismak.biomedcentral.com/articles/10.1186/s12911-020-1023-5#Abs1</em></p> 
<p> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/936b26023406514ef7cdc3695f63535e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">laravel在线教育开发__四级联动（地区选择）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/da2d963c16d23c8b44b1d6bb952cf42a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">DVB-S2中的LDPC</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>