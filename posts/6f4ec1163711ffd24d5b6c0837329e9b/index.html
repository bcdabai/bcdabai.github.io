<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【鸿蒙开发】第十章 ArkTS语言UI范式-状态管理（二） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【鸿蒙开发】第十章 ArkTS语言UI范式-状态管理（二）" />
<meta property="og:description" content="1 前言 上章节第九章 ArkTS语言UI范式-状态管理（一）我们了解了状态管理是什么，分别有哪些状态管理，并介绍了组件内状态管理的相关知识，本章节接着上一章节的内容，我们来继续学习应用状态管理和其他状态管理的相关知识。
2 应用状态的装饰器 上一个章节中介绍的装饰器仅能在页面内，即一个组件树上共享状态变量。如果开发者要实现应用级的，或者多个页面的状态数据共享，就需要用到应用级别的状态管理的概念。ArkTS根据不同特性，提供了多种应用状态管理的能力：
1. LocalStorage：页面级UI状态存储，通常用于UIAbility内、页面间的状态共享。
2. AppStorage：特殊的单例LocalStorage对象，由UI框架在应用程序启动时创建，为应用程序UI状态属性提供中央存储；
3. PersistentStorage：持久化存储UI状态，通常和AppStorage配合使用，选择AppStorage存储的数据写入磁盘，以确保这些属性在应用程序重新启动时的值与应用程序关闭时的值相同；
4. Environment：应用程序运行的设备的环境参数，环境参数会同步到AppStorage中，可以和AppStorage搭配使用。
2.1 LocalStorage：页面级UI状态存储 LocalStorage是页面级的UI状态存储，通过@Entry装饰器接收的参数可以在页面内共享同一个LocalStorage实例。LocalStorage支持UIAbility实例内多个页面间状态共享。
LocalStorage使用场景和相关的装饰器：单向同步@LocalStorageProp、双向同步@LocalStorageLink
@LocalStorageProp：@LocalStorageProp装饰的变量和与LocalStorage中给定属性建立单向同步关系。@LocalStorageLink：@LocalStorageLink装饰的变量和在@Component中创建与LocalStorage中给定属性建立双向同步关系。 如果要建立LocalStorage和自定义组件的联系，需要使用@LocalStorageProp和@LocalStorageLink装饰器。使用@LocalStorageProp(key)/@LocalStorageLink(key)装饰组件内的变量，key标识了LocalStorage的属性。
当自定义组件初始化的时候，@LocalStorageProp(key)/@LocalStorageLink(key)装饰的变量会通过给定的key，绑定LocalStorage对应的属性，完成初始化。本地初始化是必要的，因为无法保证LocalStorage一定存在给定的key（这取决于应用逻辑是否在组件初始化之前在LocalStorage实例中存入对应的属性）。
2.1.1 @LocalStorageProp @LocalStorageProp(key)是和LocalStorage中key对应的属性建立单向数据同步，我们允许本地改变的发生，但是对于@LocalStorageProp，本地的修改永远不会同步回LocalStorage中，相反，如果LocalStorage给定key的属性发生改变，改变会被同步给@LocalStorageProp，并覆盖掉本地的修改。
变量的传递/访问规则说明
2.1.2 @LocalStorageLink 如果我们需要将自定义组件的状态变量的更新同步回LocalStorage，就需要用到@LocalStorageLink。
@LocalStorageLink(key)是和LocalStorage中key对应的属性建立双向数据同步：
本地修改发生，该修改会被写回LocalStorage中；
LocalStorage中的修改发生后，该修改会被同步到所有绑定LocalStorage对应key的属性上，包括单向（@LocalStorageProp和通过prop创建的单向绑定变量）、双向（@LocalStorageLink和通过link创建的双向绑定变量）变量。
变量的传递/访问规则说明
2.1.3 应用逻辑使用 let para: Record&lt;string,number&gt; = { &#39;PropA&#39;: 47 }; let storage: LocalStorage = new LocalStorage(para); // 创建新实例并使用给定对象初始化 let propA: number | undefined = storage.get(&#39;PropA&#39;) // propA == 47 let link1: SubscribedAbstractProperty&lt;number&gt; = storage.link(&#39;PropA&#39;); // link1.get() == 47 let link2: SubscribedAbstractProperty&lt;number&gt; = storage." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/6f4ec1163711ffd24d5b6c0837329e9b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-13T15:00:12+08:00" />
<meta property="article:modified_time" content="2024-01-13T15:00:12+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【鸿蒙开发】第十章 ArkTS语言UI范式-状态管理（二）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="1__0"></a>1 前言</h2> 
<p>上章节<a href="https://blog.csdn.net/u010687761/article/details/135170618?spm=1001.2014.3001.5502">第九章 ArkTS语言UI范式-状态管理（一）</a>我们了解了状态管理是什么，分别有哪些状态管理，并介绍了组件内状态管理的相关知识，本章节接着上一章节的内容，我们来继续学习<code>应用状态管理</code>和<code>其他状态管理</code>的相关知识。</p> 
<h2><a id="2__3"></a>2 应用状态的装饰器</h2> 
<p>上一个章节中介绍的装饰器仅能在页面内，即一个组件树上共享状态变量。如果开发者要实现<code>应用级</code>的，或者<code>多个页面的状态数据共享</code>，就需要用到<code>应用级别的状态管理</code>的概念。<code>ArkTS</code>根据不同特性，提供了多种应用状态管理的能力：</p> 
<p>1.<code> LocalStorage</code>：页面级UI状态存储，通常用于<code>UIAbility内</code>、<code>页面间</code>的状态共享。<br> 2. <code>AppStorage</code>：特殊的单例<code>LocalStorage</code>对象，由UI框架在应用程序启动时创建，为应用程序UI状态属性提供<code>中央存储</code>；<br> 3. <code>PersistentStorage</code>：持<code>久化存储UI状态</code>，通常和<code>AppStorage</code>配合使用，选择<code>AppStorage</code>存储的数据写入磁盘，以确保这些属性在应用程序重新启动时的值与应用程序关闭时的值相同；<br> 4. <code>Environment</code>：应用程序运行的设备的环境参数，环境参数会同步到<code>AppStorage</code>中，可以和<code>AppStorage</code>搭配使用。</p> 
<h3><a id="21_LocalStorageUI_11"></a>2.1 LocalStorage：页面级UI状态存储</h3> 
<p><code>LocalStorage</code>是<code>页面级</code>的<code>UI状态存储</code>，通过<code>@Entry</code>装饰器接收的参数可以在<code>页面内共享同一个LocalStorage实例</code>。<code>LocalStorage</code>支持<code>UIAbility</code>实例内多个页面间状态共享。<br> <code>LocalStorage</code>使用场景和相关的装饰器：<code>单向同步@LocalStorageProp</code>、<code>双向同步@LocalStorageLink</code></p> 
<ol><li><code>@LocalStorageProp</code>：@LocalStorageProp装饰的变量和与LocalStorage中给定属性建立<code>单向同步关系</code>。</li><li><code>@LocalStorageLink</code>：@LocalStorageLink装饰的变量和在@Component中创建与LocalStorage中给定属性建立<code>双向同步关系</code>。</li></ol> 
<p>如果要建立<code>LocalStorage</code>和<code>自定义组件</code>的联系，需要使用<code>@LocalStorageProp</code>和<code>@LocalStorageLink</code>装饰器。使用<code>@LocalStorageProp(key)/@LocalStorageLink(key)</code>装饰组件内的变量，<code>key</code>标识了<code>LocalStorage</code>的属性。</p> 
<p>当自定义组件初始化的时候，<code>@LocalStorageProp(key)/@LocalStorageLink(key)</code>装饰的变量会通过给定的<code>key</code>，绑定<code>LocalStorage</code>对应的属性，完成初始化。本地初始化是必要的，因为无法保证<code>LocalStorage</code>一定存在给定的<code>key</code>（这取决于应用逻辑是否在组件初始化之前在<code>LocalStorage</code>实例中存入对应的属性）。</p> 
<h4><a id="211_LocalStorageProp_22"></a>2.1.1 @LocalStorageProp</h4> 
<p><code>@LocalStorageProp(key)</code>是和<code>LocalStorage</code>中<code>key</code>对应的属性建立<code>单向数据同步</code>，我们允许本地改变的发生，但是对于<code>@LocalStorageProp</code>，本地的修改永远不会同步回<code>LocalStorage</code>中，相反，如果<code>LocalStorage</code>给定<code>key</code>的属性发生改变，改变会被同步给<code>@LocalStorageProp</code>，并覆盖掉本地的修改。</p> 
<p><img src="https://images2.imgbox.com/fd/fd/V1bEx0Ci_o.png" alt="在这里插入图片描述"><br> 变量的传递/访问规则说明<br> <img src="https://images2.imgbox.com/f2/98/Cn3064QV_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/22/98/tYvZQjv1_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="212_LocalStorageLink_30"></a>2.1.2 @LocalStorageLink</h4> 
<p>如果我们需要将自定义组件的状态变量的更新同步回<code>LocalStorage</code>，就需要用到<code>@LocalStorageLink</code>。</p> 
<p><code>@LocalStorageLink(key)</code>是和<code>LocalStorage</code>中<code>key</code>对应的属性建立双向数据同步：</p> 
<p>本地修改发生，该修改会被写回<code>LocalStorage</code>中；</p> 
<p><code>LocalStorage</code>中的修改发生后，该修改会被同步到所有绑定LocalStorage对应key的属性上，包括单向（<code>@LocalStorageProp</code>和通过<code>prop</code>创建的<code>单向绑定</code>变量）、双向（<code>@LocalStorageLink</code>和通过<code>link</code>创建的<code>双向绑定</code>变量）变量。</p> 
<p><img src="https://images2.imgbox.com/66/c0/C6j7jvqz_o.png" alt="在这里插入图片描述"></p> 
<p>变量的传递/访问规则说明<br> <img src="https://images2.imgbox.com/b6/ec/t4xWa620_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/da/29/8UIjejZ3_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="213__46"></a>2.1.3 应用逻辑使用</h4> 
<pre><code class="prism language-typescript"><span class="token keyword">let</span> para<span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span><span class="token builtin">number</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">'PropA'</span><span class="token operator">:</span> <span class="token number">47</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> storage<span class="token operator">:</span> LocalStorage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalStorage</span><span class="token punctuation">(</span>para<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建新实例并使用给定对象初始化</span>
<span class="token keyword">let</span> propA<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">=</span> storage<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'PropA'</span><span class="token punctuation">)</span> <span class="token comment">// propA == 47</span>
<span class="token keyword">let</span> link1<span class="token operator">:</span> SubscribedAbstractProperty<span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span> <span class="token operator">=</span> storage<span class="token punctuation">.</span><span class="token function">link</span><span class="token punctuation">(</span><span class="token string">'PropA'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// link1.get() == 47</span>
<span class="token keyword">let</span> link2<span class="token operator">:</span> SubscribedAbstractProperty<span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span> <span class="token operator">=</span> storage<span class="token punctuation">.</span><span class="token function">link</span><span class="token punctuation">(</span><span class="token string">'PropA'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// link2.get() == 47</span>
<span class="token keyword">let</span> prop<span class="token operator">:</span> SubscribedAbstractProperty<span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span> <span class="token operator">=</span> storage<span class="token punctuation">.</span><span class="token function">prop</span><span class="token punctuation">(</span><span class="token string">'PropA'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// prop.get() == 47</span>
link1<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">48</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// two-way sync: link1.get() == link2.get() == prop.get() == 48</span>
prop<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// one-way sync: prop.get() == 1; but link1.get() == link2.get() == 48</span>
link1<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">49</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// two-way sync: link1.get() == link2.get() == prop.get() == 49</span>

</code></pre> 
<h4><a id="214_UI_61"></a>2.1.4 UI内部使用</h4> 
<p>@LocalStorageProp实现单向同步</p> 
<pre><code class="prism language-typescript"><span class="token comment">// 创建新实例并使用给定对象初始化</span>
<span class="token keyword">let</span> para<span class="token operator">:</span>Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span><span class="token builtin">number</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">'PropA'</span><span class="token operator">:</span> <span class="token number">47</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> storage<span class="token operator">:</span> LocalStorage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalStorage</span><span class="token punctuation">(</span>para<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 使LocalStorage可从@Component组件访问</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Entry</span></span><span class="token punctuation">(</span>storage<span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span>
struct CompA <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// @LocalStorageProp变量装饰器与LocalStorage中的'PropA'属性建立单向绑定</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">LocalStorageProp</span></span><span class="token punctuation">(</span><span class="token string">'PropA'</span><span class="token punctuation">)</span> storProp1<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> space<span class="token operator">:</span> <span class="token number">15</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 点击后从47开始加1，只改变当前组件显示的storProp1，不会同步到LocalStorage中</span>
      <span class="token function">Button</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Parent from LocalStorage </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>storProp1<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storProp1 <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token function">Child</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span>
struct Child <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// @LocalStorageProp变量装饰器与LocalStorage中的'PropA'属性建立单向绑定</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">LocalStorageProp</span></span><span class="token punctuation">(</span><span class="token string">'PropA'</span><span class="token punctuation">)</span> storProp2<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

  <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> space<span class="token operator">:</span> <span class="token number">15</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 当CompA改变时，当前storProp2不会改变，显示47</span>
      <span class="token function">Text</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Parent from LocalStorage </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>storProp2<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>@LocalStorageLink实现双向同步</p> 
<pre><code class="prism language-typescript"><span class="token comment">// 构造LocalStorage实例</span>
<span class="token keyword">let</span> para<span class="token operator">:</span>Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span><span class="token builtin">number</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">'PropA'</span><span class="token operator">:</span> <span class="token number">47</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> storage<span class="token operator">:</span> LocalStorage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalStorage</span><span class="token punctuation">(</span>para<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 调用link（api9以上）接口构造'PropA'的双向同步数据，linkToPropA 是全局变量</span>
<span class="token keyword">let</span> linkToPropA<span class="token operator">:</span> SubscribedAbstractProperty<span class="token operator">&lt;</span>object<span class="token operator">&gt;</span> <span class="token operator">=</span> storage<span class="token punctuation">.</span><span class="token function">link</span><span class="token punctuation">(</span><span class="token string">'PropA'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Entry</span></span><span class="token punctuation">(</span>storage<span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span>
struct CompA <span class="token punctuation">{<!-- --></span>

  <span class="token comment">// @LocalStorageLink('PropA')在CompA自定义组件中创建'PropA'的双向同步数据，初始值为47，因为在构造LocalStorage已经给“PropA”设置47</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">LocalStorageLink</span></span><span class="token punctuation">(</span><span class="token string">'PropA'</span><span class="token punctuation">)</span> storLink<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">Text</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">incr @LocalStorageLink variable</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token comment">// 点击“incr @LocalStorageLink variable”，this.storLink加1，改变同步回storage，全局变量linkToPropA也会同步改变</span>

        <span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storLink <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span>

      <span class="token comment">// 并不建议在组件内使用全局变量linkToPropA.get()，因为可能会有生命周期不同引起的错误。</span>
      <span class="token function">Text</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">@LocalStorageLink: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>storLink<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> - linkToPropA: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>linkToPropA<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>

      <span class="token comment">// 注意：这里没有同步刷新，因为storage.get&lt;number&gt;(‘PropA’)返回的是常规变量，常规变量的更新并不会引起Text组件的重新渲染。</span>
      <span class="token function">Text</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">playCount in LocalStorage for debug </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>storage<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">'PropA'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fontSize</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="215__132"></a>2.1.5 多个视图中同享</h4> 
<p>如果希望<code>LocalStorage</code>的实例在多个视图中共享我们应该如何操作呢？</p> 
<ol><li><strong>创建</strong>：可以在所属<code>UIAbility</code>中创建<code>LocalStorage</code>实例，并调用<code>windowStage.loadContent</code>。</li><li><strong>获取</strong>：在UI页面通过<code>getShared</code>接口获取在通过<code>loadContent</code>共享的<code>LocalStorage</code>实例。<code>LocalStorage.getShared</code>只在模拟器或者实机上才有效，不能在<code>Preview</code>预览器中使用。</li></ol> 
<pre><code class="prism language-typescript"><span class="token keyword">import</span> UIAbility <span class="token keyword">from</span> <span class="token string">'@ohos.app.ability.UIAbility'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> window <span class="token keyword">from</span> <span class="token string">'@ohos.window'</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> param<span class="token operator">:</span>Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span><span class="token builtin">number</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">'PropA'</span><span class="token operator">:</span> <span class="token number">47</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> localStorage<span class="token operator">:</span> LocalStorage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalStorage</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">EntryAbility</span> <span class="token keyword">extends</span> <span class="token class-name">UIAbility</span> <span class="token punctuation">{<!-- --></span>
  storage<span class="token operator">:</span> LocalStorage <span class="token operator">=</span> localStorage

  <span class="token function">onWindowStageCreate</span><span class="token punctuation">(</span>windowStage<span class="token operator">:</span> window<span class="token punctuation">.</span>WindowStage<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    windowStage<span class="token punctuation">.</span><span class="token function">loadContent</span><span class="token punctuation">(</span><span class="token string">'pages/Index'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storage<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">// 通过getShared接口获取stage共享的LocalStorage实例</span>
<span class="token keyword">let</span> storage <span class="token operator">=</span> LocalStorage<span class="token punctuation">.</span><span class="token function">getShared</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Entry</span></span><span class="token punctuation">(</span>storage<span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span>
struct CompA <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// can access LocalStorage instance using </span>
  <span class="token comment">// @LocalStorageLink/Prop decorated variables</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">LocalStorageLink</span></span><span class="token punctuation">(</span><span class="token string">'PropA'</span><span class="token punctuation">)</span> varA<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">Text</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>varA<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fontSize</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>建议使用这个方式来构建<code>LocalStorage</code>的实例，并且在创建<code>LocalStorage</code>实例的时候就写入默认值，因为默认值可以作为运行异常的备份，也可以用作页面的单元测试。</p> 
<h3><a id="22_AppStorageUI_173"></a>2.2 AppStorage：应用全局的UI状态存储</h3> 
<p><code>AppStorage</code>是<code>应用全局</code>的<code>UI状态存储</code>，是和应用的进程绑定的，由UI框架在应用程序启动时创建，为应用程序UI状态属性提供<code>中央存储</code>。</p> 
<ol><li><strong>LocalStorage</strong>：<code>页面级</code>，通常应用于页面内的数据共享。</li><li><strong>AppStorage</strong>：<code>应用级</code>的全局状态共享，还相当于整个应用的“中枢”，持久化数据<code>PersistentStorage</code>和环境变量<code>Environment</code>都是通过<code>AppStorage</code>中转，才可以和UI交互。</li></ol> 
<p>下面我们来学习<code>AppStorage</code>使用场景和相关的装饰器：<code>@StorageProp</code>和<code>@StorageLink</code>。区别类比上面<code>LocalStorage</code>的装饰器<code>@LocalStorageProp</code>和<code>@LocalStorageLink</code>，其中<code>Prop为单向同步</code>，<code>Link为双向同步</code></p> 
<pre><code class="prism language-typescript">AppStorage<span class="token punctuation">.</span><span class="token function">setOrCreate</span><span class="token punctuation">(</span><span class="token string">'PropA'</span><span class="token punctuation">,</span> <span class="token number">47</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> storage<span class="token operator">:</span> LocalStorage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
storage<span class="token punctuation">.</span><span class="token function">setOrCreate</span><span class="token punctuation">(</span><span class="token string">'PropA'</span><span class="token punctuation">,</span><span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> propA<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">=</span> AppStorage<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'PropA'</span><span class="token punctuation">)</span> <span class="token comment">// propA in AppStorage == 47, propA in LocalStorage == 17</span>
<span class="token keyword">let</span> link1<span class="token operator">:</span> SubscribedAbstractProperty<span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span> <span class="token operator">=</span> AppStorage<span class="token punctuation">.</span><span class="token function">link</span><span class="token punctuation">(</span><span class="token string">'PropA'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// link1.get() == 47</span>
<span class="token keyword">let</span> link2<span class="token operator">:</span> SubscribedAbstractProperty<span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span> <span class="token operator">=</span> AppStorage<span class="token punctuation">.</span><span class="token function">link</span><span class="token punctuation">(</span><span class="token string">'PropA'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// link2.get() == 47</span>
<span class="token keyword">let</span> prop<span class="token operator">:</span> SubscribedAbstractProperty<span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span> <span class="token operator">=</span> AppStorage<span class="token punctuation">.</span><span class="token function">prop</span><span class="token punctuation">(</span><span class="token string">'PropA'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// prop.get() == 47</span>

link1<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">48</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// two-way sync: link1.get() == link2.get() == prop.get() == 48</span>
prop<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// one-way sync: prop.get() == 1; but link1.get() == link2.get() == 48</span>
link1<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">49</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// two-way sync: link1.get() == link2.get() == prop.get() == 49</span>

storage<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">'PropA'</span><span class="token punctuation">)</span> <span class="token comment">// == 17</span>
storage<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'PropA'</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
storage<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">'PropA'</span><span class="token punctuation">)</span> <span class="token comment">// == 101</span>

AppStorage<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">'PropA'</span><span class="token punctuation">)</span> <span class="token comment">// == 49</span>
link1<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// == 49</span>
link2<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// == 49</span>
prop<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// == 49</span>

</code></pre> 
<h4><a id="221_AppStorageLocalStorage_206"></a>2.2.1 从应用逻辑使用AppStorage和LocalStorage</h4> 
<p><code>AppStorage</code>是<code>单例</code>，它的所有<code>API</code>都是<code>静态</code>的，使用类似<code>LocalStorage</code></p> 
<pre><code class="prism language-typescript"><span class="token comment">// 1.LocalStorage的基本使用</span>
<span class="token keyword">let</span> storage<span class="token operator">:</span> LocalStorage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
storage<span class="token punctuation">.</span><span class="token function">setOrCreate</span><span class="token punctuation">(</span><span class="token string">'PropA'</span><span class="token punctuation">,</span><span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

storage<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">'PropA'</span><span class="token punctuation">)</span> <span class="token comment">// == 17</span>
storage<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'PropA'</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
storage<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">'PropA'</span><span class="token punctuation">)</span> <span class="token comment">// == 101</span>


<span class="token comment">// 2.AppStorage的基本使用</span>
AppStorage<span class="token punctuation">.</span><span class="token function">setOrCreate</span><span class="token punctuation">(</span><span class="token string">'PropA'</span><span class="token punctuation">,</span> <span class="token number">47</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
AppStorage<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">'PropA'</span><span class="token punctuation">)</span> <span class="token comment">// == 49</span>

<span class="token keyword">let</span> propA<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">=</span> AppStorage<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'PropA'</span><span class="token punctuation">)</span> <span class="token comment">// propA in AppStorage == 47, propA in LocalStorage == 17</span>
<span class="token keyword">let</span> link1<span class="token operator">:</span> SubscribedAbstractProperty<span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span> <span class="token operator">=</span> AppStorage<span class="token punctuation">.</span><span class="token function">link</span><span class="token punctuation">(</span><span class="token string">'PropA'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// link1.get() == 47</span>
<span class="token keyword">let</span> link2<span class="token operator">:</span> SubscribedAbstractProperty<span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span> <span class="token operator">=</span> AppStorage<span class="token punctuation">.</span><span class="token function">link</span><span class="token punctuation">(</span><span class="token string">'PropA'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// link2.get() == 47</span>
<span class="token keyword">let</span> prop<span class="token operator">:</span> SubscribedAbstractProperty<span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span> <span class="token operator">=</span> AppStorage<span class="token punctuation">.</span><span class="token function">prop</span><span class="token punctuation">(</span><span class="token string">'PropA'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// prop.get() == 47</span>
link1<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">48</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// two-way sync: link1.get() == link2.get() == prop.get() == 48</span>
prop<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// one-way sync: prop.get() == 1; but link1.get() == link2.get() == 48</span>
link1<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">49</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// two-way sync: link1.get() == link2.get() == prop.get() == 49</span>

link1<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// == 49</span>
link2<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// == 49</span>
prop<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// == 49</span>
</code></pre> 
<h4><a id="222_UIAppStorageLocalStorage_236"></a>2.2.2 从UI内部使用AppStorage和LocalStorage</h4> 
<p><code>@StorageLink</code>变量装饰器与<code>AppStorage</code>配合使用，正如<code>@LocalStorageLink</code>与<code>LocalStorage</code>配合使用一样。此装饰器使用<code>AppStorage</code>中的属性创建<code>双向数据同步</code>。</p> 
<pre><code class="prism language-typescript">
<span class="token comment">// 1.LocalStorage配合LocalStorageLink使用</span>
<span class="token keyword">let</span> storage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
storage<span class="token punctuation">.</span><span class="token function">setOrCreate</span><span class="token punctuation">(</span><span class="token string">'PropA'</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 2.AppStorage配合StorageLink使用</span>
AppStorage<span class="token punctuation">.</span><span class="token function">setOrCreate</span><span class="token punctuation">(</span><span class="token string">'PropA'</span><span class="token punctuation">,</span> <span class="token number">47</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token decorator"><span class="token at operator">@</span><span class="token function">Entry</span></span><span class="token punctuation">(</span>storage<span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span>
struct CompA <span class="token punctuation">{<!-- --></span>

  <span class="token comment">// 对应LocalStorage中的数据</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">LocalStorageLink</span></span><span class="token punctuation">(</span><span class="token string">'PropA'</span><span class="token punctuation">)</span> localStorLink<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token comment">// 对应AppStorage中的数据</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">StorageLink</span></span><span class="token punctuation">(</span><span class="token string">'PropA'</span><span class="token punctuation">)</span> storLink<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> space<span class="token operator">:</span> <span class="token number">20</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">Text</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">From LocalStorage </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>localStorLink<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>localStorLink <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span>
      
      <span class="token function">Text</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">From AppStorage </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>storLink<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storLink <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h4><a id="223__273"></a>2.2.3 事件通知</h4> 
<p>使用<code>@StorageLink</code>和<code>AppStorage</code>的双向同步的机制来实现<code>事件通知</code>时要注意，不可多个页面绑定同一变量，因为<code>AppStorage</code>中的变量绑定在<code>多个不同页面的组件中</code>，事件通知则不一定需要通知到所有的这些组件。并且，当这些<code>@StorageLink</code>装饰的变量在UI中使用时，会触发UI刷新，带来不必要的性能影响。<br> 非要使用需要注意这两点：</p> 
<ol><li>是否需要多个页面绑定一个变量；</li><li>是否需要在UI中使用来刷新UI。</li></ol> 
<pre><code class="prism language-typescript"><span class="token keyword">class</span> <span class="token class-name">ViewData</span> <span class="token punctuation">{<!-- --></span>
  title<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  uri<span class="token operator">:</span> Resource<span class="token punctuation">;</span>
  color<span class="token operator">:</span> Color <span class="token operator">=</span> Color<span class="token punctuation">.</span>Black<span class="token punctuation">;</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span>title<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> uri<span class="token operator">:</span> Resource<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>title <span class="token operator">=</span> title<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>uri <span class="token operator">=</span> uri
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span>
struct Gallery <span class="token punctuation">{<!-- --></span>

  dataList<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>ViewData<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">ViewData</span><span class="token punctuation">(</span><span class="token string">'flower'</span><span class="token punctuation">,</span> <span class="token function">$r</span><span class="token punctuation">(</span><span class="token string">'app.media.icon'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">ViewData</span><span class="token punctuation">(</span><span class="token string">'OMG'</span><span class="token punctuation">,</span> <span class="token function">$r</span><span class="token punctuation">(</span><span class="token string">'app.media.icon'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">ViewData</span><span class="token punctuation">(</span><span class="token string">'OMG'</span><span class="token punctuation">,</span> <span class="token function">$r</span><span class="token punctuation">(</span><span class="token string">'app.media.icon'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>

  scroller<span class="token operator">:</span> Scroller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scroller</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">Grid</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>scroller<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">ForEach</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dataList<span class="token punctuation">,</span> <span class="token punctuation">(</span>item<span class="token operator">:</span> ViewData<span class="token punctuation">,</span> index<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">GridItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">TapImage</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
              uri<span class="token operator">:</span> item<span class="token punctuation">.</span>uri<span class="token punctuation">,</span>
              index<span class="token operator">:</span> index
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">aspectRatio</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>item<span class="token operator">:</span> ViewData<span class="token punctuation">,</span> index<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">+</span> index<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">columnsTemplate</span><span class="token punctuation">(</span><span class="token string">'1fr 1fr'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span>
<span class="token keyword">export</span> struct TapImage <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 全局变量，记录当前选择的index</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">StorageLink</span></span><span class="token punctuation">(</span><span class="token string">'tapIndex'</span><span class="token punctuation">)</span> tapIndex<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> index<span class="token operator">:</span> <span class="token builtin">number</span>
  <span class="token keyword">private</span> uri<span class="token operator">:</span> Resource

  <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">Image</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>uri<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">objectFit</span><span class="token punctuation">(</span>ImageFit<span class="token punctuation">.</span>Cover<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>tapIndex <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>index<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">border</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
          width<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
          style<span class="token operator">:</span> BorderStyle<span class="token punctuation">.</span>Dotted<span class="token punctuation">,</span>
          color<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tapIndex <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>index <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tapIndex<span class="token punctuation">)</span> <span class="token operator">?</span> Color<span class="token punctuation">.</span>Red <span class="token operator">:</span> Color<span class="token punctuation">.</span>Black
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>相比借助<code>@StorageLink</code>的双向同步机制实现<code>事件通知</code>，可以使用<code>emit</code>订阅某个事件并接收事件回调的方式来减少开销，增强代码的可读性。<code>emitter</code>的具体使用这里不展开，可到文档中查阅使用方式。</p> 
<h3><a id="23_PersistentStorageUI_346"></a>2.3 PersistentStorage：持久化存储UI状态</h3> 
<p>前面学习了解到<code>LocalStorage</code>和<code>AppStorage</code>都是运行时的内存，但是在应用退出再次启动后，依然能保存选定的结果，是应用开发中十分常见的现象，这就需要用到<code>PersistentStorage</code>。</p> 
<p><code>PersistentStorage</code>是应用程序中的可选<code>单例对象</code>。此对象的作用是<code>持久化存储</code>选定的<code>AppStorage属性</code>，<strong>以确保这些属性在应用程序重新启动时的值与应用程序关闭时的值相同</strong>。</p> 
<h4><a id="231__352"></a>2.3.1 概述</h4> 
<p><code>PersistentStorage</code>将选定的<code>AppStorage属性</code>保留在设备<code>磁盘上</code>。应用程序通过<code>API</code>，以决定哪些<code>AppStorage</code>属性应借助<code>PersistentStorage</code>持久化。UI和业务逻辑不直接访问<code>PersistentStorage</code>中的属性，所有属性访问都是对<code>AppStorage</code>的访问，<code>AppStorage</code>中的更改会自动同步到<code>PersistentStorage</code>。</p> 
<p><code>PersistentStorage</code>和<code>AppStorage</code>中的属性建立<code>双向同步</code>。应用开发通常通过<code>AppStorage</code>访问<code>PersistentStorage</code>，另外还有一些接口可以用于管理持久化属性，但是业务逻辑始终是通过<code>AppStorage</code>获取和设置属性`的。</p> 
<h4><a id="232__358"></a>2.3.2 限制条件</h4> 
<p>PersistentStorage类型和值的限制：</p> 
<ol><li>number, string, boolean, enum 等简单类型。</li><li>可以被JSON.stringify()和JSON.parse()重构的对象。例如Date, Map, Set等内置类型则不支持，以及对象的属性方法不支持持久化。</li><li>不支持嵌套对象（对象数组，对象的属性是对象等）。因为目前框架无法检测AppStorage中嵌套对象（包括数组）值的变化，所以无法写回到PersistentStorage中。</li><li>不支持undefined 和 null 。</li></ol> 
<p>持久化数据是一个相对缓慢的操作，应用程序应避免以下情况：</p> 
<ol><li>持久化大型数据集。</li><li>持久化经常变化的变量。</li></ol> 
<p><code>PersistentStorage</code>的持久化变量最好是<code>小于2kb</code>的数据，不要大量的数据持久化，因为<code>PersistentStorage</code>写入<code>磁盘的操作</code>是<code>同步</code>的，大量的数据本地化读写会同步在UI线程中执行，影响UI渲染性能。<strong>如果开发者需要存储大量的数据，建议使用数据库api。</strong></p> 
<p><code>PersistentStorage</code>和<code>UIContext</code>相关联，需要在<code>UIContext</code>明确的时候才可以调用，可以通过在<code>runScopedTask</code>里明确上下文。<strong>如果没有在UIContext明确的地方调用，将导致无法持久化数据。</strong></p> 
<h4><a id="233__375"></a>2.3.3 实例</h4> 
<pre><code class="prism language-typescript"><span class="token comment">// 初始化PersistentStorage</span>
PersistentStorage<span class="token punctuation">.</span><span class="token function">PersistProp</span><span class="token punctuation">(</span><span class="token string">'aProp'</span><span class="token punctuation">,</span> <span class="token number">47</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Entry</span></span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span>
struct Index <span class="token punctuation">{<!-- --></span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">State</span></span> message<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">'Hello World'</span>
  <span class="token comment">// 在组件内部定义</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">StorageLink</span></span><span class="token punctuation">(</span><span class="token string">'aProp'</span><span class="token punctuation">)</span> aProp<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">48</span>

  <span class="token function">aboutToAppear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 在AppStorage获取对应属性</span>
    <span class="token keyword">var</span> aProp <span class="token operator">=</span> AppStorage<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">Get</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">'aProp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// returns 47</span>
  <span class="token punctuation">}</span>

  <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Row</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">Text</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>message<span class="token punctuation">)</span>
        <span class="token comment">// 应用退出时会保存当前结果。重新启动后，会显示上一次的保存结果</span>
        <span class="token function">Text</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>aProp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// @StorageLink装饰的变量是和AppStorage中建立双向同步的，变化会被同步回AppStorage中</span>
            <span class="token comment">// 该属性已经被持久化，所以在AppStorage中“aProp”的改变会触发PersistentStorage，将新的改变写入本地磁盘。</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>aProp <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><img src="https://images2.imgbox.com/37/06/FuIpgVKl_o.png" alt="在这里插入图片描述"><br> <strong>注意</strong>：在调用<code>PersistentStorage.persistProp</code>或者<code>persistProps</code>之前使用接口<code> AppStorage.setOrCreate</code>去改变<code>AppStorage</code>中的属性是<code>错误的</code>，因为这样的调用顺序会丢失上一次应用程序运行中的属性值</p> 
<h3><a id="24_Environment_415"></a>2.4 Environment：设备环境查询</h3> 
<p>开发者如果需要应用程序运行的设备的环境参数，以此来作出不同的场景判断，比如多语言，暗黑模式等，需要用到Environment设备环境查询。</p> 
<p>Environment是ArkUI框架在应用程序启动时创建的单例对象。它为AppStorage提供了一系列描述应用程序运行状态的属性。Environment的所有属性都是不可变的（即应用不可写入），所有的属性都是简单类型。<br> <img src="https://images2.imgbox.com/e7/ae/JTNCCEQu_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="241__420"></a>2.4.1 实例</h4> 
<pre><code class="prism language-typescript"><span class="token comment">// 将设备languageCode存入AppStorage中</span>
Environment<span class="token punctuation">.</span><span class="token function">EnvProp</span><span class="token punctuation">(</span><span class="token string">'languageCode'</span><span class="token punctuation">,</span> <span class="token string">'en'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Entry</span></span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span>
struct Index <span class="token punctuation">{<!-- --></span>

  <span class="token comment">// StorageProp从AppStorage获取单向绑定的languageCode的变量</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">StorageProp</span></span><span class="token punctuation">(</span><span class="token string">'languageCode'</span><span class="token punctuation">)</span> languageCode<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">'en'</span><span class="token punctuation">;</span>

  <span class="token function">aboutToAppear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 从AppStorage获取单向绑定的languageCode的变量</span>
    <span class="token keyword">var</span> lang<span class="token operator">:</span> SubscribedAbstractProperty<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span> <span class="token operator">=</span> AppStorage<span class="token punctuation">.</span><span class="token function">Prop</span><span class="token punctuation">(</span><span class="token string">'languageCode'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lang<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'zh'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'你好'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'Hello!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Row</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 输出当前设备的languageCode</span>
        <span class="token function">Text</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>languageCode<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>同<code>PersistentStorage</code>一样，<code>Environment</code>需要在<code>UIContext</code>明确的时候才可以调用。可以通过在<code>runScopedTask</code>里明确上下文。如果没有在<code>UIContext</code>明确的地方调用，将导致无法查询到设备环境数据</p> 
<h2><a id="3__457"></a>3 其他状态管理</h2> 
<p>除了前面章节提到的组件状态管理和应用状态管理，<code>ArkTS</code>还提供了<code>@Watch</code>和<code>$$</code>来为开发者提供更多功能：</p> 
<ol><li>@Watch用于监听状态变量的变化。</li><li>$$运算符：给内置组件提供TS变量的引用，使得TS变量和内置组件的内部状态保持同步。</li></ol> 
<h3><a id="31_Watch_463"></a>3.1 @Watch装饰器：状态变量更改通知</h3> 
<p><code>@Watch</code>应用于对<code>状态变量的监听</code>。如果开发者需要关注某个状态变量的值是否改变，可以使用<code>@Watch为状态变量设置回调函数</code>。<code>@Watch</code>在<code>ArkUI</code>框架内部判断数值有无更新使用的是<code>严格相等（===）</code>，遵循严格相等规范。当在严格相等为false的情况下，就会触发<code>@Watch</code>的回调</p> 
<h4><a id="311__466"></a>3.1.1 装饰器说明</h4> 
<p><img src="https://images2.imgbox.com/a0/96/6AnCZqnD_o.png" alt="在这里插入图片描述"><br> 使用及注意：</p> 
<ol><li>当观察到<code>状态变量的变化</code>（包括双向绑定的<code>AppStorage</code>和<code>LocalStorage</code>中对应的<code>key</code>发生的变化）的时候，对应的<code>@Watch的回调方法将被触发</code>；</li><li><code>@Watch</code>方法在自定义组件的属性变更之后同步执行；</li><li>如果在<code>@Watch</code>的方法里改变了其他的状态变量，也会引起状态变更和<code>@Watch</code>的执行；</li><li>在第一次初始化的时候，<code>@Watch</code>装饰的方法不会被调用，即认为<code>初始化不是状态变量的改变</code>。只有在后续状态改变时，才会调用<code>@Watch</code>回调方法。</li><li>注意<code>避免无限循环</code>。循环可能是因为在<code>@Watch</code>的回调方法里直接或者间接地修改了同一个状态变量引起的。为了避免循环的产生，建议不要在<code>@Watch</code>的回调方法里修改当前装饰的状态变量；</li><li>注意<code>关注性能</code>，属性值更新函数会延迟组件的重新渲染（具体请见上面的行为表现），因此，回调函数应仅执行快速运算；</li><li>不建议在<code>@Watch</code>函数中调用<code>async await</code>，因为<code>@Watch</code>设计的用途是为了快速的计算，异步行为可能会导致重新渲染速度的性能问题。</li></ol> 
<h4><a id="312__476"></a>3.1.2 实例</h4> 
<pre><code class="prism language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Entry</span></span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span>
struct TotalView <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// Watch修饰的变量发生改变，会回调到onCountUpdated方法中</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Prop</span></span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">Watch</span></span><span class="token punctuation">(</span><span class="token string">'onCountUpdated'</span><span class="token punctuation">)</span> count<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">State</span></span> total<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment">// @Watch 回调</span>
  <span class="token function">onCountUpdated</span><span class="token punctuation">(</span>propName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// propName为变量名count，值为this.count</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>propName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>total <span class="token operator">+=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// total为count的值</span>
      <span class="token function">Text</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Total: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>total<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token function">Button</span><span class="token punctuation">(</span><span class="token string">'count++'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 点击按钮count+1</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token operator">++</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="32__507"></a>3.2 $$语法：内置组件双向同步</h3> 
<p><code>$$运算符</code>为系统内置组件提供<code>TS变量的引用</code>，使得<code>TS变量</code>和<code>系统内置组件</code>的内部状态保持<code>同步</code>。内部状态具体指什么取决于组件。例如，<code>TextInput</code>组件的<code>text参数</code>。</p> 
<p>当前<code>$$</code>支持基础类型变量，以及<code>@State</code>、<code>@Link</code>和<code>@Prop</code>装饰的变量。</p> 
<p>当前<code>$$</code>支持的组件<br> <img src="https://images2.imgbox.com/63/ba/DoA1T3iP_o.png" alt="在这里插入图片描述"></p> 
<p><code>$$绑定的变量变化时，会触发UI的同步刷新</code></p> 
<h4><a id="321__517"></a>3.2.1 实例</h4> 
<pre><code class="prism language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Entry</span></span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span>
struct TextInputExample <span class="token punctuation">{<!-- --></span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">State</span></span> text<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">''</span>
  controller<span class="token operator">:</span> TextInputController <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextInputController</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> space<span class="token operator">:</span> <span class="token number">20</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">Text</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span>
      <span class="token comment">// $$绑定的变量变化</span>
      <span class="token function">TextInput</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> text<span class="token operator">:</span> $$<span class="token keyword">this</span><span class="token punctuation">.</span>text<span class="token punctuation">,</span> placeholder<span class="token operator">:</span> <span class="token string">'input your word...'</span><span class="token punctuation">,</span> controller<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>controller <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">placeholderColor</span><span class="token punctuation">(</span>Color<span class="token punctuation">.</span>Grey<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">placeholderFont</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> size<span class="token operator">:</span> <span class="token number">14</span><span class="token punctuation">,</span> weight<span class="token operator">:</span> <span class="token number">400</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">caretColor</span><span class="token punctuation">(</span>Color<span class="token punctuation">.</span>Blue<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token string">'100%'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token string">'100%'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">justifyContent</span><span class="token punctuation">(</span>FlexAlign<span class="token punctuation">.</span>Center<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h2><a id="4__541"></a>4 实践</h2> 
<h3><a id="41ObjectLinkProp_542"></a>4.1使用@ObjectLink代替@Prop减少不必要的深拷贝</h3> 
<p>在应用开发中，开发者经常会进行<code>父子组件的数值传递</code>，而在不会改变子组件内状态变量值的情况下，使用<code>@Prop</code>装饰状态变量会导致组件创建的耗时增加，从而影响一部分性能。</p> 
<p>【反例】</p> 
<pre><code class="prism language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Observed</span></span>
<span class="token keyword">class</span> <span class="token class-name">ClassA</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">public</span> c<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span>c<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>c <span class="token operator">=</span> c<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span>
struct PropChild <span class="token punctuation">{<!-- --></span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Prop</span></span> testNum<span class="token operator">:</span> ClassA<span class="token punctuation">;</span> <span class="token comment">// @Prop 装饰状态变量会深拷贝</span>

  <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Text</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">PropChild testNum </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>testNum<span class="token punctuation">.</span>c<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Entry</span></span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span>
struct Parent <span class="token punctuation">{<!-- --></span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">State</span></span> testNum<span class="token operator">:</span> ClassA<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">ClassA</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">Text</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Parent testNum </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>testNum<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>c<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>testNum<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>c <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token comment">// PropChild没有改变@Prop testNum: ClassA的值，所以这时最优的选择是使用@ObjectLink</span>
      <span class="token function">PropChild</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> testNum<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>testNum<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在上文的示例中，<code>PropChild</code>组件没有改变<code>@Prop testNum: ClassA的值</code>，所以这时较优的选择是使用<code>@ObjectLink</code>，因为<code>@Prop会深拷贝数据</code>，具有拷贝的性能开销，所以这个时候<code>@ObjectLink</code>是比<code>@Link</code>和<code>@Prop</code>更优的选择。</p> 
<p>【正例】</p> 
<pre><code class="prism language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Observed</span></span>
<span class="token keyword">class</span> <span class="token class-name">ClassA</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">public</span> c<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span>c<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>c <span class="token operator">=</span> c<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span>
struct PropChild <span class="token punctuation">{<!-- --></span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ObjectLink</span></span> testNum<span class="token operator">:</span> ClassA<span class="token punctuation">;</span> <span class="token comment">// @ObjectLink 装饰状态变量不会深拷贝</span>

  <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Text</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">PropChild testNum </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>testNum<span class="token punctuation">.</span>c<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Entry</span></span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span>
struct Parent <span class="token punctuation">{<!-- --></span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">State</span></span> testNum<span class="token operator">:</span> ClassA<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">ClassA</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">Text</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Parent testNum </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>testNum<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>c<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>testNum<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>c <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token function">PropChild</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> testNum<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>testNum<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="42__621"></a>4.2 不使用状态变量强行更新非状态变量关联组件</h3> 
<p>【反例】</p> 
<pre><code class="prism language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Entry</span></span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span>
struct CompA <span class="token punctuation">{<!-- --></span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">State</span></span> needsUpdate<span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  realState1<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 未使用状态变量装饰器</span>
  realState2<span class="token operator">:</span> Color <span class="token operator">=</span> Color<span class="token punctuation">.</span>Yellow<span class="token punctuation">;</span>

  <span class="token function">updateUI1</span><span class="token punctuation">(</span>param<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> triggerAGet <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>needsUpdate<span class="token punctuation">;</span>
    <span class="token keyword">return</span> param<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">updateUI2</span><span class="token punctuation">(</span>param<span class="token operator">:</span> Color<span class="token punctuation">)</span><span class="token operator">:</span> Color <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> triggerAGet <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>needsUpdate<span class="token punctuation">;</span>
    <span class="token keyword">return</span> param<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> space<span class="token operator">:</span> <span class="token number">20</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">ForEach</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateUI1</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>realState1<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>item<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">Text</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>item<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token function">Text</span><span class="token punctuation">(</span><span class="token string">"add item"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 改变realState1不会触发UI视图更新</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>realState1<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>realState1<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>realState1<span class="token punctuation">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token comment">// 触发UI视图更新</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>needsUpdate <span class="token operator">=</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>needsUpdate<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token function">Text</span><span class="token punctuation">(</span><span class="token string">"chg color"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 改变realState2不会触发UI视图更新</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>realState2 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>realState2 <span class="token operator">==</span> Color<span class="token punctuation">.</span>Yellow <span class="token operator">?</span> Color<span class="token punctuation">.</span>Red <span class="token operator">:</span> Color<span class="token punctuation">.</span>Yellow<span class="token punctuation">;</span>

          <span class="token comment">// 触发UI视图更新</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>needsUpdate <span class="token operator">=</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>needsUpdate<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">backgroundColor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateUI2</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>realState2<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上述示例存在以下问题：</p> 
<ol><li> <p>应用程序希望控制UI更新逻辑，但在ArkUI中，UI更新的逻辑应该是由框架来检测应用程序状态变量的更改去实现。</p> </li><li> <p>this.needsUpdate是一个自定义的UI状态变量，应该仅应用于其绑定的UI组件。变量this.realState1、this.realState2没有被装饰，他们的变化将不会触发UI刷新。</p> </li></ol> 
<p>但是在该应用中，用户试图通过<code>this.needsUpdate</code>的更新来带动常规变量<code>this.realState1</code>、<code>this.realState2</code>的更新，此方法<code>不合理</code>且<code>更新性能较差</code>。</p> 
<p>【正例】<br> 要解决此问题，应将<code>realState1</code>和<code>realState2</code>成员变量用<code>@State</code>装饰。一旦完成此操作，就不再需要变量<code>needsUpdate</code>。</p> 
<pre><code class="prism language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Entry</span></span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span>
struct CompA <span class="token punctuation">{<!-- --></span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">State</span></span> realState1<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">State</span></span> realState2<span class="token operator">:</span> Color <span class="token operator">=</span> Color<span class="token punctuation">.</span>Yellow<span class="token punctuation">;</span>
  <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> space<span class="token operator">:</span> <span class="token number">20</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">ForEach</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>realState1<span class="token punctuation">,</span>
        <span class="token punctuation">(</span>item<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">Text</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>item<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token function">Text</span><span class="token punctuation">(</span><span class="token string">"add item"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 改变realState1触发UI视图更新</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>realState1<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>realState1<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>realState1<span class="token punctuation">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token function">Text</span><span class="token punctuation">(</span><span class="token string">"chg color"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 改变realState2触发UI视图更新</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>realState2 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>realState2 <span class="token operator">==</span> Color<span class="token punctuation">.</span>Yellow <span class="token operator">?</span> Color<span class="token punctuation">.</span>Red <span class="token operator">:</span> Color<span class="token punctuation">.</span>Yellow<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">backgroundColor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>realState2<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="43_710"></a>4.3精准控制状态变量关联的组件数</h3> 
<p>精准控制状态变量关联的组件数能减少不必要的组件刷新，提高组件的刷新效率。有时开发者会将同一个状态变量绑定多个同级组件的属性，当状态变量改变时，会让这些组件做出相同的改变，这有时会造成组件的不必要刷新，如果存在某些比较复杂的组件，则会大大影响整体的性能。但是如果将这个状态变量绑定在这些同级组件的父组件上，则可以减少需要刷新的组件数，从而提高刷新的性能。</p> 
<p>【反例】</p> 
<pre><code class="prism language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Observed</span></span>
<span class="token keyword">class</span> <span class="token class-name">Translate</span> <span class="token punctuation">{<!-- --></span>
  translateX<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span>
struct Title <span class="token punctuation">{<!-- --></span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ObjectLink</span></span> translateObj<span class="token operator">:</span> Translate<span class="token punctuation">;</span>
  <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Row</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">Image</span><span class="token punctuation">(</span><span class="token function">$r</span><span class="token punctuation">(</span><span class="token string">'app.media.icon'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
          x<span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>translateObj<span class="token punctuation">.</span>translateX <span class="token comment">// this.translateObj.translateX used in two component both in Row</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token function">Text</span><span class="token punctuation">(</span><span class="token string">"Title"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">fontSize</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
          x<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>translateObj<span class="token punctuation">.</span>translateX
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Entry</span></span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span>
struct Page <span class="token punctuation">{<!-- --></span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">State</span></span> translateObj<span class="token operator">:</span> Translate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Translate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">Title</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        translateObj<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>translateObj
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token function">Stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token punctuation">}</span>
      <span class="token punctuation">.</span><span class="token function">backgroundColor</span><span class="token punctuation">(</span><span class="token string">"black"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        x<span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>translateObj<span class="token punctuation">.</span>translateX <span class="token comment">//this.translateObj.translateX used in two components both in Column</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token function">Button</span><span class="token punctuation">(</span><span class="token string">"move"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
          x<span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>translateObj<span class="token punctuation">.</span>translateX
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">animateTo</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            duration<span class="token operator">:</span> <span class="token number">50</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>translateObj<span class="token punctuation">.</span>translateX <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>translateObj<span class="token punctuation">.</span>translateX <span class="token operator">+</span> <span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">150</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在上面的示例中，状态变量<code>this.translateObj.translateX</code>被用在多个同级的子组件下，当<code>this.translateObj.translateX</code>变化时，会导致所有关联它的组件一起刷新，但实际上由于这些组件的变化是相同的，因此可以将这个属性绑定到他们共同的父组件上，来实现减少组件的刷新数量。经过分析，所有的子组件其实都处于<code>Page</code>下的<code>Column</code>中，因此将所有子组件相同的<code>translate</code>属性统一到<code>Column</code>上，来实现精准控制状态变量关联的组件数。</p> 
<p>【正例】</p> 
<pre><code class="prism language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Observed</span></span>
<span class="token keyword">class</span> <span class="token class-name">Translate</span> <span class="token punctuation">{<!-- --></span>
  translateX<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span>
struct Title <span class="token punctuation">{<!-- --></span>
  <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Row</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">Image</span><span class="token punctuation">(</span><span class="token function">$r</span><span class="token punctuation">(</span><span class="token string">'app.media.icon'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>
      <span class="token function">Text</span><span class="token punctuation">(</span><span class="token string">"Title"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">fontSize</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Entry</span></span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span>
struct Page1 <span class="token punctuation">{<!-- --></span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">State</span></span> translateObj<span class="token operator">:</span> Translate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Translate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">Title</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token function">Stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token punctuation">}</span>
      <span class="token punctuation">.</span><span class="token function">backgroundColor</span><span class="token punctuation">(</span><span class="token string">"black"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span>
      <span class="token function">Button</span><span class="token punctuation">(</span><span class="token string">"move"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">animateTo</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            duration<span class="token operator">:</span> <span class="token number">50</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>translateObj<span class="token punctuation">.</span>translateX <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>translateObj<span class="token punctuation">.</span>translateX <span class="token operator">+</span> <span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">150</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token comment">// the component in Column shares the same property translate</span>
      x<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>translateObj<span class="token punctuation">.</span>translateX
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5663c2ea74d11241307ef24bbe32a944/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">跟着cherno手搓游戏引擎【4】窗口抽象、GLFW配置、窗口事件</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6afaa2ede10247ed304b6cd4b3dd4c11/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">AI历史项目开发模型训练结果汇总</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>