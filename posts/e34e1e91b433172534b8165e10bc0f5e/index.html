<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>带你阅读linux内核源码：linux内核源代码编程规范 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="带你阅读linux内核源码：linux内核源代码编程规范" />
<meta property="og:description" content="linux内核代码是许许多多遵循相同内核开发规范的牛人们的共同的创造的结晶。作为一名linux内核或者驱动开发工程师，很有必要了解这些内核开发规范。好处有以下几个：
这些约定或者规范对我们阅读linux内核源码、了解设计思路有很大帮助我们基于linux内核做开发，也要往内核里添加代码，遵守开发规范，有助于别人阅读和理解我们的代码。 linux内核代码规范约定如下：
1.强烈推荐单行的宽度为八十列。
任何一行超过八十列宽度的语句都应该拆分成多个行，除非超过八十列的部分可以提高可读性且不会隐藏信息。但是，千万不要把用户可见的字符串，比如 printk 的信息，拆分成多行，因为这样会导致使用 grep 的时候找不到这些信息。
2.关于大括号
c语言里的if，do, while, for语句都会使用到大括号，内核代码倾向于把左括号放在行末，把右括号放在行首，并且大括号和前面的语句，以及if和后面的语句，都保留一个空格，例如：
以上红圈标注都代表一个空格。
3.关于空格
这个还是单独列出来说明一下吧，因为内核代码里用到空格的地方太多了。
Linux 内核风格的空格主要用在一些关键字上，即在关键字之后添一个空格。值得关注的例外是一些长得像函数的关键字，比如：sizeof, typeof, alignof, attribute，在 Linux 中，这些关键字的使用都会带上一对括号，比如sizeof(int)。
所以在下面这些关键字后面需要添加一个空格：
if, switch, case, for, do, while 但是， sizeof, typeof, alignof, attribute 之后则不需要添加空格：
s = sizeof(struct file); 在声明指针或者返回值为指针的函数时，星号的位置应该紧靠着变量名或函数名，而不是类型名，例如：
char *linux_banner; unsigned long long memparse(char *ptr, char **retptr); char *match_strdup(substring_t *s); 在二元操作符和三元操作符周围添加一个空格，例如：
= &#43; - &lt; &gt; * / % | &amp; ^ &lt;= &gt;= == != ?" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/e34e1e91b433172534b8165e10bc0f5e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-11-09T13:49:12+08:00" />
<meta property="article:modified_time" content="2021-11-09T13:49:12+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">带你阅读linux内核源码：linux内核源代码编程规范</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>linux内核代码是许许多多遵循相同内核开发规范的牛人们的共同的创造的结晶。作为一名linux内核或者驱动开发工程师，很有必要了解这些内核开发规范。好处有以下几个：</p> 
<ul><li>这些约定或者规范对我们阅读linux内核源码、了解设计思路有很大帮助</li><li>我们基于linux内核做开发，也要往内核里添加代码，遵守开发规范，有助于别人阅读和理解我们的代码。</li></ul> 
<hr> 
<p>linux内核代码规范约定如下：</p> 
<p><strong>1.强烈推荐单行的宽度为八十列。</strong></p> 
<p>任何一行超过八十列宽度的语句都应该拆分成多个行，除非超过八十列的部分可以提高可读性且不会隐藏信息。但是，千万不要把用户可见的字符串，比如 printk 的信息，拆分成多行，因为<strong>这样会导致使用 grep 的时候找不到这些信息</strong>。</p> 
<p><strong>2.关于大括号</strong></p> 
<p>c语言里的if，do, while, for语句都会使用到大括号，内核代码倾向于把左括号放在行末，把右括号放在行首，并且大括号和前面的语句，以及if和后面的语句，都保留一个空格，例如：</p> 
<p style="text-align:center;"><img alt="带你阅读linux内核源码：linux内核源代码编程规范" src="https://images2.imgbox.com/62/82/58DlNDMP_o.png"></p> 
<p></p> 
<p>以上红圈标注都代表一个空格。</p> 
<p><strong>3.关于空格</strong></p> 
<p>这个还是单独列出来说明一下吧，因为内核代码里用到空格的地方太多了。</p> 
<p>Linux 内核风格的空格主要用在一些关键字上，即在关键字之后添一个空格。值得关注的例外是一些长得像函数的关键字，比如：<strong>sizeof</strong>, <strong>typeof</strong>, <strong>alignof</strong>, <strong>attribute</strong>，在 Linux 中，这些关键字的使用都会带上一对括号，比如sizeof(int)。</p> 
<p>所以在下面这些关键字后面需要添加一个空格：</p> 
<pre><code>if, switch, case, for, do, while</code></pre> 
<p>但是， <strong>sizeof</strong>, <strong>typeof</strong>, <strong>alignof</strong>, <strong>attribute</strong> 之后则不需要添加空格：</p> 
<pre><code>s = sizeof(struct file);</code></pre> 
<p>在声明指针或者返回值为指针的函数时，星号的位置应该紧靠着变量名或函数名，而不是类型名，例如：</p> 
<pre><code>char *linux_banner;
unsigned long long memparse(char *ptr, char **retptr);
char *match_strdup(substring_t *s);</code></pre> 
<p>在二元操作符和三元操作符周围添加一个空格，例如：</p> 
<pre><code>=  +  -  &lt;  &gt;  *  /  %  |  &amp;  ^  &lt;=  &gt;=  ==  !=  ?  :</code></pre> 
<p>但是不要在一元操作符之后添加空格：</p> 
<pre><code>&amp;  *  +  -  ~  !  sizeof  typeof  alignof  __attribute__  defined</code></pre> 
<p><strong>4.变量命名</strong></p> 
<p>C 是一种简洁粗旷的语言，因此，你的命名也应该是简洁的。linux内核里的变量定义应该尽可能简单，在不产生歧义的情况下，越简单越好。可以用下划线，但是绝对不推荐使用大写字母。所以，内核里的变量和函数定义不要使用驼峰命名法。</p> 
<p style="text-align:center;"><img alt="带你阅读linux内核源码：linux内核源代码编程规范" src="https://images2.imgbox.com/9f/6d/vLtzxlfm_o.png"></p> 
<p></p> 
<p><strong>5.函数</strong></p> 
<p>函数应该短小精悍，一个函数只干一件事。几百行<a class="link-info" href="https://www.fgba.net/" rel="nofollow"><span style="color:#494949;">代码</span></a>组成一个函数是不被推荐的。</p> 
<p>关键函数的前面最好留有注释。这样其他人可以快速看懂你的代码意图：</p> 
<p style="text-align:center;"><img alt="带你阅读linux内核源码：linux内核源代码编程规范" src="https://images2.imgbox.com/0f/e3/TypZnens_o.png"></p> 
<p></p> 
<p><strong>6.注释</strong></p> 
<p>多行注释推荐格式如下：</p> 
<pre><code>/*
 * To support ISA shared interrupts, we need to have one interrupt
 * handler that ensures that the IRQ line has been deasserted
 * before returning.  Failing to do this will result in the IRQ
 * line being stuck active, and, since ISA irqs are edge triggered,
 * no more IRQs will be seen.
 */</code></pre> 
<p><strong>7.推荐使用函数自注释</strong></p> 
<p>所谓函数自注释，就是从你的函数名就可以猜到你要干什么，比如内核的：</p> 
<p>wait_event(), wait_event_interruptible(),<br> wait_event_interruptible_timeout()等。</p> 
<p style="text-align:center;"><img alt="带你阅读linux内核源码：linux内核源代码编程规范" src="https://images2.imgbox.com/ec/ee/VOwqmMax_o.png"></p> 
<p></p> 
<p>注意，写代码不只是写给现在的自己，也是写给以后的自己，也是写给其他人看的。如果你回看你一年前写的代码都很陌生，那说明你的代码规范是有问题的。</p> 
<p><strong>8.常量宏和枚举的命名都是大写的：</strong></p> 
<p style="text-align:center;"><img alt="带你阅读linux内核源码：linux内核源代码编程规范" src="https://images2.imgbox.com/48/55/jup68VzN_o.png"></p> 
<p></p> 
<p><strong>9.打印内核或者驱动信息</strong></p> 
<p>编写好的调试信息是一项巨大的挑战，一旦你完成了，这些信息会对远程调试产生巨大帮助</p> 
<p>很多子系统在对应的 makefile 里都有 Kconfig 调试选项来打开 -DDEBUG，或者是在文件里定义宏 #define DEBUG。当调试信息可以被无条件打印，或者说已经编译了和调试有关的 #ifdef 段，那么 printk(KERN_DEBUG ...) 就可以用来打印调试信息。</p> 
<p><strong>10.内联函数（inline）</strong></p> 
<p>Inline关键字会让编译器将指定的函数体插入并取代每一处调用该函数的地方（上下文），从而节省了每次调用函数带来的额外时间开支。然而，inline 关键字的泛滥，会使内核变大，从而使整个系统运行速度变慢，因为大内核会占用更多的CPU高速缓存，同时会导致可用内存页缓存减少。想象一下，一次页缓存未命中就会导致一次磁盘寻址，这至少耗费5毫秒。5毫秒足够CPU运行很多很多的指令。</p> 
<p>好了，以上就是我们在阅读linux内核源码的时候的一些代码规范的约定。linux源码作为世界上最规范、最严谨的代码，确实有很多值得我们学习的地方。有时候欣赏内核代码的时候总有一种赏心悦目的感觉，这可能跟它们的良好的代码规范有关系吧。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/764c032355122915826d60aa9543bcd0/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">人间还是仙界？聊一聊linux系统的用户空间和内核空间</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3821663a7e0a4da9e22eec1f86427d44/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">linux进程上下文、中断上下文介绍，以及为什么软中断不能睡眠？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>