<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>k8s-kubernetes--etcd的备份和恢复 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="k8s-kubernetes--etcd的备份和恢复" />
<meta property="og:description" content="文章目录 1.etcd介绍2.重新搭建集群环境3.etcd的备份4.etcd数据的恢复 1.etcd介绍 官方网址：https://etcd.io/docs/v3.6/op-guide/recovery/
k8s相关网址：https://v1-25.docs.kubernetes.io/zh-cn/docs/tasks/administer-cluster/configure-upgrade-etcd/#restoring-an-etcd-cluster
etcd拉起过程：
kubelet自动扫描/etc/kubernetes/manifests目录（如下图），如果发现.yaml文件自动拉起来
Etcd被形容为Kubernetes集群的大脑，是 Kubernetes的关键组件，因为它存储了集群的全部状态：其配置，规格以及运行中的工作负载的状态。
在Kubernetes世界中，etcd用作服务发现的后端，并存储集群的状态及其配置。
Etcd被部署为一个集群，几个节点的通信由Raft算法处理。在生产环境中，集群包含奇数个节点，并且至少需要三个。
以下来自Heptio博客的序列图显示了在简单的Pod创建过程中涉及的组件。它很好地说明了API服务器和etcd的交互作用。
2.重新搭建集群环境 由于在k8s高可用集群实验后做该实验，我们需要重新初始化集群环境
[root@k8s2 ~]# kubeadm reset
[root@k8s2 ~]# vim kubeadm-init.yaml ##去掉高可用实验时加入的负载均衡地址（25行左右）
[root@k8s3 ~]# kubeadm reset
[root@k8s4 ~]# kubeadm reset
k8s2作为control-plane执行初始化（如下图），然后在k8s3和k8s4节点执行生成的token使这两个节点加入集群即可
[root@k8s2 ~]# kubectl get node ##
NAME STATUS ROLES AGE VERSION
k8s2 Ready control-plane 90m v1.25.0
k8s3 Ready 89m v1.25.0
k8s4 Ready 89m v1.25.0
3.etcd的备份 所有 Kubernetes 对象都存储在 etcd 上。 定期备份 etcd 集群数据对于在灾难场景（例如丢失所有控制平面节点）下恢复 Kubernetes 集群非常重要。 快照文件包含所有 Kubernetes 状态和关键信息。为了保证敏感的 Kubernetes 数据的安全，可以对快照文件进行加密。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/fe03e495e259788bdb3197e4f2fab173/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-10-06T16:52:51+08:00" />
<meta property="article:modified_time" content="2023-10-06T16:52:51+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">k8s-kubernetes--etcd的备份和恢复</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#1etcd_10" rel="nofollow">1.etcd介绍</a></li><li><a href="#2_25" rel="nofollow">2.重新搭建集群环境</a></li><li><a href="#3etcd_40" rel="nofollow">3.etcd的备份</a></li><li><a href="#4etcd_104" rel="nofollow">4.etcd数据的恢复</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<hr> 
<h3><a id="1etcd_10"></a>1.etcd介绍</h3> 
<p>官方网址：<a href="https://etcd.io/docs/v3.6/op-guide/recovery/" rel="nofollow">https://etcd.io/docs/v3.6/op-guide/recovery/</a><br> k8s相关网址：<a href="https://v1-25.docs.kubernetes.io/zh-cn/docs/tasks/administer-cluster/configure-upgrade-etcd/#restoring-an-etcd-cluster" rel="nofollow">https://v1-25.docs.kubernetes.io/zh-cn/docs/tasks/administer-cluster/configure-upgrade-etcd/#restoring-an-etcd-cluster</a><br> <strong>etcd拉起过程：</strong><br> kubelet自动扫描/etc/kubernetes/manifests目录（如下图），如果发现.yaml文件自动拉起来<br> <img src="https://images2.imgbox.com/c9/1d/Qu2BkHTs_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/98/54/xsrHcclS_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>Etcd被形容为Kubernetes集群的大脑，是 Kubernetes的关键组件，因为它<mark>存储了集群的全部状态：其配置，规格以及运行中的工作负载的状态</mark>。<br> 在Kubernetes世界中，<mark>etcd用作服务发现的后端，并存储集群的状态及其配置</mark>。<br> Etcd被部署为一个集群，几个节点的通信由Raft算法处理。在生产环境中，集群包含<mark>奇数</mark>个节点，并且至少需要三个。</p> 
</blockquote> 
<blockquote> 
 <p>以下来自Heptio博客的序列图显示了在简单的Pod创建过程中涉及的组件。它很好地说明了API服务器和etcd的交互作用。<br> <img src="https://images2.imgbox.com/f3/c3/7VcHFaHP_o.png" alt="在这里插入图片描述"></p> 
</blockquote> 
<h3><a id="2_25"></a>2.重新搭建集群环境</h3> 
<p>由于在k8s高可用集群实验后做该实验，我们需要重新初始化集群环境<br> [root@k8s2 ~]# kubeadm reset<br> [root@k8s2 ~]# vim kubeadm-init.yaml ##去掉高可用实验时加入的负载均衡地址（25行左右）<br> [root@k8s3 ~]# kubeadm reset<br> [root@k8s4 ~]# kubeadm reset<br> <mark>k8s2作为control-plane执行初始化（如下图），然后在k8s3和k8s4节点执行生成的token使这两个节点加入集群即可</mark><br> <img src="https://images2.imgbox.com/58/0f/Tehq1Tot_o.png" alt="在这里插入图片描述"><br> [root@k8s2 ~]# kubectl get node ##<br> NAME STATUS ROLES AGE VERSION<br> k8s2 Ready control-plane 90m v1.25.0<br> k8s3 Ready 89m v1.25.0<br> k8s4 Ready 89m v1.25.0</p> 
<h3><a id="3etcd_40"></a>3.etcd的备份</h3> 
<blockquote> 
 <ul><li> <p>所有 Kubernetes 对象都存储在 etcd 上。 定期备份 etcd 集群数据对于在灾难场景（例如丢失所有控制平面节点）下恢复 Kubernetes 集群非常重要。 <mark>快照文件包含所有 Kubernetes 状态和关键信息</mark>。为了保证敏感的 Kubernetes 数据的安全，<mark>可以对快照文件进行加密</mark>。</p> </li><li> <p>备份 etcd 集群可以通过两种方式完成：<mark>etcd 内置快照和卷快照</mark>。也可以使用 etcdctl 选项的快照;</p> </li></ul> 
</blockquote> 
<p><strong>本实验我们采用etcdctl 选项的快照</strong>.</p> 
<p><img src="https://images2.imgbox.com/6b/ab/6UwbGuDZ_o.png" alt="在这里插入图片描述"><br> <strong>得到etcdctl命令</strong><br> 为了版本能够对应，我们未采用安装一个etcdctl，而是从镜像中拷贝etcdctl二进制命令，具体操作如下：</p> 
<pre><code class="prism language-c">从镜像中拷贝etcdctl二进制命令（需确保docker服务开启：systemct status docker）
<span class="token punctuation">[</span>root@k8s2 <span class="token operator">~</span><span class="token punctuation">]</span># docker run <span class="token operator">-</span>it <span class="token operator">--</span>rm reg<span class="token punctuation">.</span>westos<span class="token punctuation">.</span>org<span class="token operator">/</span>k8s<span class="token operator">/</span>etcd<span class="token operator">:</span><span class="token number">3.5</span><span class="token number">.4</span><span class="token operator">-</span><span class="token number">0</span> sh
输入ctrl<span class="token operator">+</span>pq快捷键，把容器打入后台

获取容器id
<span class="token punctuation">[</span>root@k8s2 <span class="token operator">~</span><span class="token punctuation">]</span># docker ps
CONTAINER ID   IMAGE                             COMMAND   CREATED         STATUS         PORTS                               NAMES
c8a2291ce220   reg<span class="token punctuation">.</span>westos<span class="token punctuation">.</span>org<span class="token operator">/</span>k8s<span class="token operator">/</span>etcd<span class="token operator">:</span><span class="token number">3.5</span><span class="token number">.4</span><span class="token operator">-</span><span class="token number">0</span>   <span class="token string">"sh"</span>      <span class="token number">5</span> seconds ago   Up <span class="token number">4</span> seconds   <span class="token number">2379</span><span class="token operator">-</span><span class="token number">2380</span><span class="token operator">/</span>tcp<span class="token punctuation">,</span> <span class="token number">4001</span><span class="token operator">/</span>tcp<span class="token punctuation">,</span> <span class="token number">7001</span><span class="token operator">/</span>tcp   vibrant_ishizaka

从容器拷贝命令到本机                                       ##上课实验时命令路径查看：docker history reg<span class="token punctuation">.</span>westos<span class="token punctuation">.</span>org<span class="token operator">/</span>k8s<span class="token operator">/</span>etcd<span class="token operator">:</span><span class="token number">3.5</span><span class="token number">.4</span><span class="token operator">-</span><span class="token number">0</span>
<span class="token punctuation">[</span>root@k8s2 bin<span class="token punctuation">]</span># docker container cp c8a2291ce220<span class="token operator">:</span><span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>bin<span class="token operator">/</span>etcdctl <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>bin

<span class="token punctuation">[</span>root@k8s2 <span class="token operator">~</span><span class="token punctuation">]</span># which etcdctl
<span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>bin<span class="token operator">/</span>etcdctl

删除容器
<span class="token punctuation">[</span>root@k8s2 bin<span class="token punctuation">]</span># docker rm <span class="token operator">-</span>f c8a2291ce220
</code></pre> 
<p>备份<br> [root@k8s2 etcd]# ETCDCTL_API=3 etcdctl --endpoints 192.168.56.12:2379 --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key --cacert=/etc/kubernetes/pki/etcd/ca.crt snapshot save /tmp/snapshotdb</p> 
<p>注：<br> ETCDCTL_API=3 ----###v3版本<br> etcdctl --endpoints 192.168.56.12:2379 ----###<br> –cert=/etc/kubernetes/pki/etcd/server.crt----###证书位置<br> –key=/etc/kubernetes/pki/etcd/server.key----###key位置<br> –cacert=/etc/kubernetes/pki/etcd/ca.crt —###ca位置，因为有安全通信<br> snapshot save /tmp/snapshotdb----###创建snapshot（快照）的位置：/tmp/snapshotdb<br> 如果加：member list----###列出成员<br> <img src="https://images2.imgbox.com/31/bc/UZddXG4D_o.png" alt="在这里插入图片描述"></p> 
<p>查看快照状态<br> [root@k8s2 etcd]# ETCDCTL_API=3 etcdctl --endpoints 192.168.56.12:2379 --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key --cacert=/etc/kubernetes/pki/etcd/ca.crt <mark>–write-out=table snapshot status /tmp/snapshotdb</mark><br> 注：<br> –write-out=table snapshot status /tmp/snapshotdb----###表示输出的时候通过表格的方式进行显示<br> <img src="https://images2.imgbox.com/71/97/oCdsfCar_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-c">删除集群资源
<span class="token punctuation">[</span>root@k8s2 etcd<span class="token punctuation">]</span># kubectl get pod        ##pod为提前建好，等会恢复即可证明实验成功
NAME                    READY   STATUS    RESTARTS   AGE
myapp<span class="token operator">-</span>fcfbd4477<span class="token operator">-</span><span class="token number">8</span>mg4l   <span class="token number">1</span><span class="token operator">/</span><span class="token number">1</span>     Running   <span class="token number">0</span>          <span class="token number">27</span>m
myapp<span class="token operator">-</span>fcfbd4477<span class="token operator">-</span>h52c9   <span class="token number">1</span><span class="token operator">/</span><span class="token number">1</span>     Running   <span class="token number">0</span>          <span class="token number">27</span>m
myapp<span class="token operator">-</span>fcfbd4477<span class="token operator">-</span>s7nf2   <span class="token number">1</span><span class="token operator">/</span><span class="token number">1</span>     Running   <span class="token number">0</span>          <span class="token number">27</span>m
<span class="token punctuation">[</span>root@k8s2 etcd<span class="token punctuation">]</span># kubectl delete  deployments<span class="token punctuation">.</span>apps myapp
deployment<span class="token punctuation">.</span>apps <span class="token string">"myapp"</span> deleted
<span class="token punctuation">[</span>root@k8s2 etcd<span class="token punctuation">]</span># kubectl get pod         ##已经删除干净
No resources found in <span class="token keyword">default</span> namespace<span class="token punctuation">.</span>
</code></pre> 
<h3><a id="4etcd_104"></a>4.etcd数据的恢复</h3> 
<p>下图需注意：如果是集群恢复，需要将control-plane节点全部停止API，逐个进行恢复；所以集群恢复更加麻烦<br> <img src="https://images2.imgbox.com/de/d8/LyBteaiZ_o.png" alt="在这里插入图片描述"><br> 在/etc/kubernetes/manifests/目录中，所有的核心示例都用静态pod定义；<br> <mark>所以，停止所有核心组件，把该目录的文件移走即可；kubelet会扫描该目录，则对应容器自动停止</mark></p> 
<pre><code class="prism language-c">停止所有核心组件
<span class="token punctuation">[</span>root@k8s2 etcd<span class="token punctuation">]</span># cd <span class="token operator">/</span>etc<span class="token operator">/</span>kubernetes<span class="token operator">/</span>manifests<span class="token operator">/</span>
<span class="token punctuation">[</span>root@k8s2 manifests<span class="token punctuation">]</span># ls
etcd<span class="token punctuation">.</span>yaml  kube<span class="token operator">-</span>apiserver<span class="token punctuation">.</span>yaml  kube<span class="token operator">-</span>controller<span class="token operator">-</span>manager<span class="token punctuation">.</span>yaml  kube<span class="token operator">-</span>scheduler<span class="token punctuation">.</span>yaml
<span class="token punctuation">[</span>root@k8s2 manifests<span class="token punctuation">]</span># mv <span class="token operator">*</span> <span class="token operator">/</span>mnt<span class="token operator">/</span>
</code></pre> 
<p>移除yaml文件后对应容器自动停止：只剩下下图所示，kubectl命令无法使用<br> <img src="https://images2.imgbox.com/74/84/gH3bYnOO_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-c">从快照恢复
<span class="token punctuation">[</span>root@k8s2 manifests<span class="token punctuation">]</span># cd <span class="token operator">/</span>var<span class="token operator">/</span>lib<span class="token operator">/</span>etcd<span class="token operator">/</span>           ##所有数据的位置目录
<span class="token punctuation">[</span>root@k8s2 etcd<span class="token punctuation">]</span># ls
member
<span class="token punctuation">[</span>root@k8s2 etcd<span class="token punctuation">]</span># mv member<span class="token operator">/</span> <span class="token operator">/</span>tmp<span class="token operator">/</span>        ##为了不覆盖，把member目录移走
<span class="token punctuation">[</span>root@k8s2 etcd<span class="token punctuation">]</span># ETCDCTL_API<span class="token operator">=</span><span class="token number">3</span> etcdctl snapshot restore <span class="token operator">--</span>data<span class="token operator">-</span>dir <span class="token operator">/</span>var<span class="token operator">/</span>lib<span class="token operator">/</span>etcd<span class="token operator">/</span> <span class="token operator">/</span>tmp<span class="token operator">/</span>snapshotdb
                ##恢复快照；指定数据目录为<span class="token operator">/</span>var<span class="token operator">/</span>lib<span class="token operator">/</span>etcd<span class="token operator">/</span> ；快照位置：<span class="token operator">/</span>tmp<span class="token operator">/</span>snapshotdb
<span class="token punctuation">[</span>root@k8s2 etcd<span class="token punctuation">]</span># ls       
member                      ##恢复后的新目录

重启所有组件
<span class="token punctuation">[</span>root@k8s2 <span class="token operator">~</span><span class="token punctuation">]</span># cd <span class="token operator">/</span>etc<span class="token operator">/</span>kubernetes<span class="token operator">/</span>manifests<span class="token operator">/</span>
<span class="token punctuation">[</span>root@k8s2 manifests<span class="token punctuation">]</span># mv <span class="token operator">/</span>mnt<span class="token comment">/* .
</span></code></pre> 
<p>yaml文件移动回来后容器自动启动<br> <img src="https://images2.imgbox.com/4f/2b/VzOE5UR6_o.png" alt="在这里插入图片描述"><br> <strong>测试：</strong></p> 
<pre><code class="prism language-c">所有集群节点重启kubelet服务
<span class="token punctuation">[</span>root@k8s2 manifests<span class="token punctuation">]</span># systemctl  restart kubelet
<span class="token punctuation">[</span>root@k8s3 <span class="token operator">~</span><span class="token punctuation">]</span># systemctl  restart kubelet
<span class="token punctuation">[</span>root@k8s4 <span class="token operator">~</span><span class="token punctuation">]</span># systemctl  restart kubelet

看到pod恢复表示成功
<span class="token punctuation">[</span>root@k8s2 manifests<span class="token punctuation">]</span># kubectl get pod          ##删除的pod已经恢复，pod的name等都不变
NAME                    READY   STATUS    RESTARTS   AGE
myapp<span class="token operator">-</span>fcfbd4477<span class="token operator">-</span><span class="token number">8</span>mg4l   <span class="token number">1</span><span class="token operator">/</span><span class="token number">1</span>     Running   <span class="token number">0</span>          <span class="token number">34</span>m
myapp<span class="token operator">-</span>fcfbd4477<span class="token operator">-</span>h52c9   <span class="token number">1</span><span class="token operator">/</span><span class="token number">1</span>     Running   <span class="token number">0</span>          <span class="token number">34</span>m
myapp<span class="token operator">-</span>fcfbd4477<span class="token operator">-</span>s7nf2   <span class="token number">1</span><span class="token operator">/</span><span class="token number">1</span>     Running   <span class="token number">0</span>          <span class="token number">34</span>m
</code></pre> 
<hr>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/34670a2a27b88294458ae57ce85286ef/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">10.4：输入两个正整数m和n，求其最大公约数和最小公倍数</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/52bfd8e3b000a603d9221afaaf32779b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">ImportError: C extension: No module named ‘pandas._libs.tslibs.conversion‘ not built.</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>