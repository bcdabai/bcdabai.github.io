<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Kubernetes（k8s）认识以及应用（二）——kubeadm多机部署 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Kubernetes（k8s）认识以及应用（二）——kubeadm多机部署" />
<meta property="og:description" content="Kubernetes（k8s） 使用多机环境kubeadm部署 部署环境
master：192.168.11.25
node1：192.168.11.26
node2：192.168.11.27
准备工作
1.修改主机名
192.168.11.25：hostnamectl set-hostname master
192.168.11.26：hostnamectl set-hostname node1
192.168.11.27：hostnamectl set-hostname node2
2.关闭防火墙、selinux和swap
systemctl stop firewalld &amp;&amp; systemctl disable firewalld
setenforce 0 &amp;&amp; sed -i &#34;s/^SELINUX=enforcing/SELINUX=disabled/g&#34; /etc/selinux/config
swapoff -a &amp;&amp; sed -i &#39;s/.*swap.*/#&amp;/&#39; /etc/fstab
3.添加域名解析：vim /etc/hosts
192.168.11.25 master
192.168.11.26 node1
192.168.11.27 node2
4.配置国内yum源
wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.cloud.tencent.com/repo/centos7_base.repo
wget -O /etc/yum.repos.d/epel.repo http://mirrors.cloud.tencent.com/repo/epel-7.repo
yum clean all &amp;&amp; yum makecache
5.配置国内Kubernetes源：vim /etc/yum.repos.d/k8s.repo
[kubernetes] name=Kubernetes baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/ enabled=1 gpgcheck=1 repo_gpgcheck=1 gpgkey=https://mirrors." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/1bdfc84c611c3335263e662a3400da39/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-05-10T23:10:26+08:00" />
<meta property="article:modified_time" content="2020-05-10T23:10:26+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Kubernetes（k8s）认识以及应用（二）——kubeadm多机部署</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>Kubernetes（k8s）</h2> 
<h4>使用多机环境kubeadm部署</h4> 
<p>部署环境</p> 
<p>master：192.168.11.25</p> 
<p>node1：192.168.11.26</p> 
<p>node2：192.168.11.27</p> 
<p><strong>准备工作</strong></p> 
<p>1.修改主机名</p> 
<p>192.168.11.25：<span style="color:#3399ea;">hostnamectl set-hostname master</span></p> 
<p>192.168.11.26：<span style="color:#3399ea;">hostnamectl set-hostname node1</span></p> 
<p>192.168.11.27：<span style="color:#3399ea;">hostnamectl set-hostname node2</span></p> 
<p>2.关闭防火墙、selinux和swap</p> 
<p><span style="color:#3399ea;">systemctl stop firewalld &amp;&amp; systemctl disable firewalld</span></p> 
<p><span style="color:#3399ea;">setenforce 0 &amp;&amp; sed -i "s/^SELINUX=enforcing/SELINUX=disabled/g" /etc/selinux/config</span></p> 
<p><span style="color:#3399ea;">swapoff -a &amp;&amp; sed -i 's/.*swap.*/#&amp;/' /etc/fstab</span></p> 
<p>3.添加域名解析：vim /etc/hosts</p> 
<p><span style="color:#f33b45;">192.168.11.25 master<br> 192.168.11.26 node1<br> 192.168.11.27 node2</span></p> 
<p>4.配置国内yum源</p> 
<p><span style="color:#3399ea;">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.cloud.tencent.com/repo/centos7_base.repo</span></p> 
<p><span style="color:#3399ea;">wget -O /etc/yum.repos.d/epel.repo http://mirrors.cloud.tencent.com/repo/epel-7.repo</span></p> 
<p><span style="color:#3399ea;">yum clean all &amp;&amp; yum makecache</span></p> 
<p>5.配置国内Kubernetes源：<span style="color:#3399ea;">vim /etc/yum.repos.d/k8s.repo</span></p> 
<pre><code>[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</code></pre> 
<p>6.安装docker并启动</p> 
<p><span style="color:#3399ea;">yum install -y yum-utils</span></p> 
<p><span style="color:#3399ea;">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></p> 
<p><span style="color:#3399ea;">yum list docker-ce --showduplicates | sort -r</span></p> 
<p><span style="color:#3399ea;">yum -y install docker-ce-18.09.6</span></p> 
<p><span style="color:#3399ea;">systemctl start docker &amp;&amp; systemctl enable docker</span></p> 
<p>7.安装软件工具kubeadm、kubelet、kubectl并启动kubelet</p> 
<p><span style="color:#3399ea;">yum -y install kubelet-1.14.2 kubeadm-1.14.2 kubectl-1.14.2</span></p> 
<p><span style="color:#3399ea;">systemctl start kubelet &amp;&amp; systemctl enable kubelet</span></p> 
<p>8.修改配置内核参数，将桥接的IPv4流量传递到iptables的链</p> 
<p><span style="color:#3399ea;">vim /etc/sysctl.d/k8s.conf</span></p> 
<pre><code>net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward = 1</code></pre> 
<p><span style="color:#3399ea;">sysctl --system</span></p> 
<p>9.在<span style="color:#f33b45;">所有的Kubernetes节点</span>执行以下脚本</p> 
<p><span style="color:#3399ea;">vim /etc/sysconfig/modules/ipvs.modules</span></p> 
<pre><code>#!/bin/bash
modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack_ipv4</code></pre> 
<p><span style="color:#3399ea;">chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules &amp;&amp; lsmod | grep -e ip_vs -e nf_conntrack_ipv4</span></p> 
<p><span style="color:#f33b45;"><strong>补充：</strong></span>Kubernetes 1.15版本以上包括1.15版本需要以下准备工作</p> 
<p>1.确认一下iptables filter表中FOWARD链的默认策略(pllicy)为ACCEPT，并且下载一些组件</p> 
<p><span style="color:#3399ea;">yum -y install ipset ipvsadm</span></p> 
<p><span style="color:#3399ea;">iptables -P FORWARD ACCEPT</span></p> 
<p>2.修改docker cgroup driver为systemd并重启docker</p> 
<p><span style="color:#3399ea;">vim /etc/docker/daemon.json</span></p> 
<pre><code>{
  "exec-opts": ["native.cgroupdriver=systemd"]
}
</code></pre> 
<p>3.修改<span style="color:#f33b45;">/etc/sysctl.d/k8s.conf</span>添加下面一行，修改<span style="color:#f33b45;">/etc/sysconfig/kubelet</span></p> 
<p><span style="color:#3399ea;">vim /etc/sysctl.d/k8s.conf</span></p> 
<pre><code>vm.swappiness=0</code></pre> 
<p><span style="color:#3399ea;">sysctl -p /etc/sysctl.d/k8s.conf</span></p> 
<p><span style="color:#3399ea;">vim /etc/sysconfig/kubelet</span></p> 
<pre><code>KUBELET_EXTRA_ARGS=--fail-swap-on=false</code></pre> 
<p><strong>部署master 节点</strong></p> 
<p>1.在master进行Kubernetes集群初始化</p> 
<p><span style="color:#3399ea;">kubeadm init --kubernetes-version=1.14.2 --apiserver-advertise-address=192.168.11.25 --image-repository registry.aliyuncs.com/google_containers --service-cidr=10.1.0.0/16 --pod-network-cidr=10.244.0.0/16</span></p> 
<p>补充：这里也可以自己手动拉取镜像，通过kubeadm config images list命令列出需要拉取的镜像</p> 
<p><img alt="" height="362" src="https://images2.imgbox.com/0f/a5/4Qrc6wUB_o.png" width="752"></p> 
<p>kubeadm join 192.168.11.25:6443 --token uh0vjw.28nn7hd86tqzygwy --discovery-token-ca-cert-hash sha256:4141547cfd6ecdfa6a9051b2625cf7a497068af86442e15a54d714cef08322bc</p> 
<p>注意：该返回结果在其他node节点上添加节点时运行</p> 
<p>2.配置kubectl工具</p> 
<p><span style="color:#3399ea;">mkdir -p /root/.kube</span></p> 
<p><span style="color:#3399ea;">cp /etc/kubernetes/admin.conf /root/.kube/config</span></p> 
<p><span style="color:#3399ea;">chown $(id -u):$(id -g) /root/.kube/config</span></p> 
<p>如果你是root用户直接运行该命令就行了：<span style="color:#3399ea;">export KUBECONFIG=/etc/kubernetes/admin.conf</span></p> 
<p>查看节点：<span style="color:#3399ea;">kubectl get nodes</span></p> 
<p>查看状态：<span style="color:#3399ea;">kubectl get cs</span></p> 
<p><img alt="" height="213" src="https://images2.imgbox.com/6c/d7/qERwiSfB_o.png" width="443"></p> 
<p>查看pods的运行状态：<span style="color:#3399ea;">kubectl get pods -n kube-system -owide</span></p> 
<p><img alt="" height="488" src="https://images2.imgbox.com/f8/7d/959FXJkO_o.png" width="697"></p> 
<p>注意：必须全部都要Running状态才行</p> 
<p>3.部署flannel网络</p> 
<p>方法一：<span style="color:#3399ea;">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/a70459be0084506e4ec919aa1c114638878db11b/Documentation/kube-flannel.yml</span></p> 
<p>注意（如下图所示）：这里因为无法解析这个地址所以要在/etc/hosts文件里添加地址解析再执行</p> 
<p><img alt="" height="105" src="https://images2.imgbox.com/cd/40/HgmUomaV_o.png" width="760"></p> 
<p><img alt="" height="118" src="https://images2.imgbox.com/45/f9/HptbZ8BQ_o.png" width="423"></p> 
<p>方法二：<span style="color:#3399ea;">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span></p> 
<p>方法三：下载kube-flannel.yml文件并修改</p> 
<p><span style="color:#3399ea;">wget https://raw.githubusercontent.com/coreos/flannel/2140ac876ef134e0ed5af15c65e414cf26827915/Documentation/kube-flannel.yml</span></p> 
<p>vim kube-flannel.yml</p> 
<p><img alt="" height="211" src="https://images2.imgbox.com/71/42/Qdwviz2Q_o.png" width="503"></p> 
<p>安装flannel：<span style="color:#3399ea;">kubectl create -f kube-flannel.yml</span></p> 
<p><strong>部署node节点</strong></p> 
<p>只需要使node节点加如kubernetes集群</p> 
<p>这时候会用到在master上初始化群集时会返回结果的内容，并在node节点上执行</p> 
<p><span style="color:#3399ea;">kubeadm join 192.168.11.25:6443 --token uh0vjw.28nn7hd86tqzygwy --discovery-token-ca-cert-hash sha256:4141547cfd6ecdfa6a9051b2625cf7a497068af86442e15a54d714cef08322bc</span></p> 
<p><strong>部署Dashboard</strong></p> 
<p>1.创建Dashboard的yaml文件</p> 
<p><span style="color:#3399ea;">wget https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yaml</span></p> 
<p>2.修改编辑kubernetes-dashboard.yaml文件</p> 
<p><span style="color:#3399ea;">sed -i 's/k8s.gcr.io/loveone/g' kubernetes-dashboard.yaml</span></p> 
<p><span style="color:#3399ea;">sed -i '/targetPort:/a\ \ \ \ \ \ nodePort: 30001\n\ \ type: NodePort' kubernetes-dashboard.yaml</span></p> 
<p>Dashboard Service内容加入nodePort： 30001和type: NodePort两项内容，将Dashboard访问端口映射为节点端口，以供外部访问，并运行</p> 
<p><span style="color:#3399ea;">kubectl create -f kubernetes-dashboard.yaml</span></p> 
<p>3.检查相关服务运行状态</p> 
<p><span style="color:#3399ea;">kubectl get deployment kubernetes-dashboard -n kube-system</span></p> 
<p><span style="color:#3399ea;">kubectl get pods -n kube-system -o wide</span></p> 
<p><span style="color:#3399ea;">kubectl get services -n kube-system</span></p> 
<p><span style="color:#3399ea;">netstat -ntlp|grep 30001</span></p> 
<p>4.在浏览器输入Dashboard访问地址：<span style="color:#f33b45;">https://192.168.11.25:30001</span></p> 
<p>5.查看访问Dashboard的认证令牌</p> 
<p><span style="color:#3399ea;">kubectl create serviceaccount  dashboard-admin -n kube-system</span></p> 
<p><span style="color:#3399ea;">kubectl create clusterrolebinding  dashboard-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin</span></p> 
<p><span style="color:#3399ea;">kubectl describe secrets -n kube-system $(kubectl -n kube-system get secret | awk '/dashboard-admin/{print $1}')</span></p> 
<p><img alt="" height="190" src="https://images2.imgbox.com/92/5b/40Hd2dO3_o.png" width="834"></p> 
<p>把这串秘钥输入到web页面的令牌上登录（不复制token:     如下图所示）</p> 
<p><img alt="" height="406" src="https://images2.imgbox.com/8e/48/AuPtMYR8_o.png" width="738"></p> 
<p>登录进入到k8s的web界面</p> 
<p><img alt="" height="401" src="https://images2.imgbox.com/57/06/eU4ftW7L_o.png" width="719"></p> 
<p><strong>kubectl工具常用命令</strong></p> 
<pre><code>查看所有node信息：kubectl get node
查看RC和service列表：kubectl get rc,svc
显示Node的详细信息：kubectl describe node 192.168.0.212
显示Pod的详细信息：kubectl describe pod pod-name
根据yaml创建资源：kubectl create -f pod.yaml   kubectl apply -f pod.yaml
#apply 可以重复执行，create 不行
基于pod.yaml定义的名称删除pod：kubectl delete -f pod.yaml 
删除所有包含某个label的pod和service：kubectl delete pod,svc -l name=label-name
删除所有Pod：kubectl delete pod --all
查看endpoint列表：kubectl get endpoints
执行pod的date命令：
kubectl exec pod-name -- date
kubectl exec pod-name -- bash
kubectl exec pod-name -- ping 10.24.51.9
获得pod中某个容器的TTY（相当于登录容器）：
kubectl exec -it pod-name -c container-name -- bash
#查看容器的日志
kubectl logs pod-name
#实时查看日志
kubectl logs -f pod-name
#若pod只有一个容器，可以不加-c
kubectl log pod-name -c container_name
查看注释：
kubectl explain pod
kubectl explain pod.apiVersion
查看节点labels：kubectl get node --show-label</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/85a16ea8b0bdc3404f5880fbda13b9d7/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">jQuery-常用API</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a92f2529a94d9818369d27a052abe06b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">《超级转化率》读书笔记</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>