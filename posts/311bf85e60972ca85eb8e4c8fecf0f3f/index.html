<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ansible 详解 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ansible 详解" />
<meta property="og:description" content="文章目录 一、ansible 简介1.1 ansible 是什么？1.2 ansible 特点1.3 ansible 架构图 二、ansible 任务执行2.1 ansible 任务执行模式2.2 ansible 执行流程2.3 ansible 命令执行过程 三、ansible 配置详解3.1 ansible 安装方式3.1.1 使用 pip（python的包管理模块）安装3.1.2 使用 yum 安装 3.2 ansible 程序结构3.3 ansible配置文件3.4 ansuble主机清单 四、ansible 常用命令4.1 ansible 命令集4.2 ansible-doc 命令4.3 ansible 命令详解 五、ansible 常用模块5.1 ping 模块5.2 command 模块5.3 shell 模块5.4 copy 模块5.5 file 模块5.6 fetch 模块5.7 cron 模块5.8 yum 模块5.9 apt 模块5.10 service 模块5.11 unarchive 模块5.12 lineinfile 模块5.13 script 模块5.14 setup 模块5.15 user 模块5." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/311bf85e60972ca85eb8e4c8fecf0f3f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-24T16:39:43+08:00" />
<meta property="article:modified_time" content="2023-11-24T16:39:43+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ansible 详解</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#ansible__1" rel="nofollow">一、ansible 简介</a></li><li><ul><li><a href="#11_ansible__3" rel="nofollow">1.1 ansible 是什么？</a></li><li><a href="#12_ansible__9" rel="nofollow">1.2 ansible 特点</a></li><li><a href="#13_ansible__20" rel="nofollow">1.3 ansible 架构图</a></li></ul> 
  </li><li><a href="#ansible__35" rel="nofollow">二、ansible 任务执行</a></li><li><ul><li><a href="#21_ansible__37" rel="nofollow">2.1 ansible 任务执行模式</a></li><li><a href="#22_ansible__46" rel="nofollow">2.2 ansible 执行流程</a></li><li><a href="#23_ansible__53" rel="nofollow">2.3 ansible 命令执行过程</a></li></ul> 
  </li><li><a href="#ansible__64" rel="nofollow">三、ansible 配置详解</a></li><li><ul><li><a href="#31_ansible__66" rel="nofollow">3.1 ansible 安装方式</a></li><li><ul><li><a href="#311__pippython_71" rel="nofollow">3.1.1 使用 pip（python的包管理模块）安装</a></li><li><a href="#312__yum__79" rel="nofollow">3.1.2 使用 yum 安装</a></li></ul> 
   </li><li><a href="#32_ansible__86" rel="nofollow">3.2 ansible 程序结构</a></li><li><a href="#33_ansible_95" rel="nofollow">3.3 ansible配置文件</a></li><li><a href="#34_ansuble_112" rel="nofollow">3.4 ansuble主机清单</a></li></ul> 
  </li><li><a href="#ansible__230" rel="nofollow">四、ansible 常用命令</a></li><li><ul><li><a href="#41_ansible__232" rel="nofollow">4.1 ansible 命令集</a></li><li><a href="#42_ansibledoc__246" rel="nofollow">4.2 ansible-doc 命令</a></li><li><a href="#43_ansible__266" rel="nofollow">4.3 ansible 命令详解</a></li></ul> 
  </li><li><a href="#ansible__309" rel="nofollow">五、ansible 常用模块</a></li><li><ul><li><a href="#51_ping__331" rel="nofollow">5.1 ping 模块</a></li><li><a href="#52_command__345" rel="nofollow">5.2 command 模块</a></li><li><a href="#53_shell__372" rel="nofollow">5.3 shell 模块</a></li><li><a href="#54_copy__385" rel="nofollow">5.4 copy 模块</a></li><li><a href="#55_file__433" rel="nofollow">5.5 file 模块</a></li><li><a href="#56_fetch__484" rel="nofollow">5.6 fetch 模块</a></li><li><a href="#57_cron__502" rel="nofollow">5.7 cron 模块</a></li><li><a href="#58_yum__559" rel="nofollow">5.8 yum 模块</a></li><li><a href="#59_apt__633" rel="nofollow">5.9 apt 模块</a></li><li><a href="#510_service__680" rel="nofollow">5.10 service 模块</a></li><li><a href="#511_unarchive__715" rel="nofollow">5.11 unarchive 模块</a></li><li><a href="#512_lineinfile__758" rel="nofollow">5.12 lineinfile 模块</a></li><li><a href="#513_script__800" rel="nofollow">5.13 script 模块</a></li><li><a href="#514_setup__816" rel="nofollow">5.14 setup 模块</a></li><li><a href="#515_user__834" rel="nofollow">5.15 user 模块</a></li><li><a href="#516_mount__878" rel="nofollow">5.16 mount 模块</a></li><li><a href="#517_wait_for_908" rel="nofollow">5.17 wait_for模块</a></li></ul> 
  </li><li><a href="#playbook_964" rel="nofollow">六、playbook</a></li><li><ul><li><a href="#61_playbook_969" rel="nofollow">6.1 playbook核心元素</a></li><li><a href="#62_playbook_979" rel="nofollow">6.2 playbook基本语法</a></li><li><a href="#tags__1059" rel="nofollow">tags: 添加标签</a></li><li><a href="#63_handlers_1085" rel="nofollow">6.3 handlers</a></li><li><a href="#64_register_when_1120" rel="nofollow">6.4 register 和when</a></li><li><a href="#65__1160" rel="nofollow">6.5 循环</a></li><li><a href="#66_templates_1237" rel="nofollow">6.6 模板templates</a></li><li><ul><li><a href="#661_template__1251" rel="nofollow">6.6.1 template 的使用</a></li><li><a href="#662_template_1260" rel="nofollow">6.6.2 template示例</a></li></ul> 
   </li><li><a href="#67_roles_1312" rel="nofollow">6.7 roles</a></li><li><ul><li><a href="#671_Roles_1314" rel="nofollow">6.7.1 Roles介绍</a></li><li><a href="#672_Roles_1317" rel="nofollow">6.7.2 Roles目录结构</a></li><li><a href="#673_Roles_1348" rel="nofollow">6.7.3 Roles示例</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="ansible__1"></a>一、ansible 简介</h2> 
<h3><a id="11_ansible__3"></a>1.1 ansible 是什么？</h3> 
<p>  ansible是新出现的自动化运维工具，基于Python开发，集合了众多运维工具（puppet、chef、func、fabric）的优点，实现了批量系统配置、批量程序部署、批量运行命令等功能。</p> 
<p>  ansible是基于 paramiko 开发的,并且基于模块化工作，本身没有批量部署的能力。真正具有批量部署的是ansible所运行的模块，ansible只是提供一种框架。ansible不需要在远程主机上安装client/agents，因为它们是基于ssh来和远程主机通讯的。ansible目前已经已经被红帽官方收购，是自动化运维工具中大家认可度最高的，并且上手容易，学习简单。是每位运维工程师必须掌握的技能之一。</p> 
<h3><a id="12_ansible__9"></a>1.2 ansible 特点</h3> 
<ol><li>部署简单，只需在主控端部署Ansible环境，被控端无需做任何操作；</li><li>默认使用SSH协议对设备进行管理；</li><li>有大量常规运维操作模块，可实现日常绝大部分操作；</li><li>配置简单、功能强大、扩展性强；</li><li>支持API及自定义模块，可通过Python轻松扩展；</li><li>通过Playbooks来定制强大的配置、状态管理；</li><li>轻量级，无需在客户端安装agent，更新时，只需在操作机上进行一次更新即可；</li><li>提供一个功能强大、操作性强的Web管理界面和REST API接口——AWX平台。</li><li>幂等性：一个任务执行1遍和执行n遍效果一样，不因重复执行带来意外情况</li></ol> 
<h3><a id="13_ansible__20"></a>1.3 ansible 架构图</h3> 
<p><img src="https://images2.imgbox.com/60/af/iOJ1l0mF_o.png" alt="在这里插入图片描述"></p> 
<p><strong>主要模块</strong></p> 
<ul><li>Ansible：Ansible核心程序。</li><li>HostInventory：记录由Ansible管理的主机信息，包括端口、密码、ip等。</li><li>Playbooks：“剧本”YAML格式文件，多个任务定义在一个文件中，定义主机需要调用哪些模块来完成的功能。</li><li>CoreModules：核心模块，主要操作是通过调用核心模块来完成管理任务。</li><li>CustomModules：自定义模块，完成核心模块无法完成的功能，支持多种语言。</li><li>ConnectionPlugins：连接插件，Ansible和Host通信使用</li></ul> 
<h2><a id="ansible__35"></a>二、ansible 任务执行</h2> 
<h3><a id="21_ansible__37"></a>2.1 ansible 任务执行模式</h3> 
<p>Ansible 系统由控制主机对被管节点的操作方式可分为两类，即<code>adhoc</code>和<code>playbook</code></p> 
<ul><li>ad-hoc模式(点对点模式)<br> 　<code>使用单个模块，支持批量执行单条命令。</code>ad-hoc 命令是一种可以快速输入的命令，而且不需要保存起来的命令。就相当于bash中的一句话shell。</li><li>playbook模式(剧本模式)<br> 　是Ansible 主要管理方式 ，也是Ansible功能强大的关键所在。playbook通过多个task集合完成一类功能，如Web服务的安装部署、数据库服务器的批量备份等。可以简单地把playbook理解为通过组合多条ad-hoc操作的配置文件。</li></ul> 
<h3><a id="22_ansible__46"></a>2.2 ansible 执行流程</h3> 
<p><img src="https://images2.imgbox.com/6c/ab/OId0gqJb_o.png" alt="在这里插入图片描述"></p> 
<p>简单理解就是Ansible在运行时， 首先读取ansible.cfg中的配置， 根据规则获取Inventory中的管理主机列表， 并行的在这些主机中执行配置的任务， 最后等待执行返回的结果。</p> 
<h3><a id="23_ansible__53"></a>2.3 ansible 命令执行过程</h3> 
<ol><li>加载自己的配置文件，默认/etc/ansible/ansible.cfg；</li><li>查找对应的主机配置文件，找到要执行的主机或者组；</li><li>加载自己对应的模块文件，如 command；</li><li>通过ansible将模块或命令生成对应的临时py文件(python脚本)， 并将该文件传输至远程服务器；</li><li>对应执行用户的家目录的.ansible/tmp/XXX/XXX.PY文件；</li><li>给文件 +x 执行权限；</li><li>执行并返回结果；</li><li>删除临时py文件，sleep 0退出；</li></ol> 
<h2><a id="ansible__64"></a>三、ansible 配置详解</h2> 
<h3><a id="31_ansible__66"></a>3.1 ansible 安装方式</h3> 
<p>ansible安装常用两种方式，<code>yum</code>安装和<code>pip</code>程序安装</p> 
<h4><a id="311__pippython_71"></a>3.1.1 使用 pip（python的包管理模块）安装</h4> 
<p>需要安装一个python-pip包，安装完成以后，则直接使用pip命令来安装我们的ansible包</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ yum <span class="token function">install</span> python-pip
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ pip <span class="token function">install</span> ansible
</code></pre> 
<h4><a id="312__yum__79"></a>3.1.2 使用 yum 安装</h4> 
<p>需要先安装一个epel-release包，然后再安装 ansible 即可。</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ yum <span class="token parameter variable">-y</span> <span class="token function">install</span> epel-release
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ yum <span class="token parameter variable">-y</span> <span class="token function">install</span> ansible
</code></pre> 
<h3><a id="32_ansible__86"></a>3.2 ansible 程序结构</h3> 
<p>安装目录如下(yum安装)：</p> 
<ul><li>配置文件目录：/etc/ansible/</li><li>执行文件目录：/usr/bin/</li><li>Lib库依赖目录：/usr/lib/pythonX.X/site-packages/ansible/</li><li>Help文档目录：/usr/share/doc/ansible-X.X.X/</li><li>Man文档目录：/usr/share/man/man1/</li></ul> 
<h3><a id="33_ansible_95"></a>3.3 ansible配置文件</h3> 
<p>ansible 的配置文件为<code>/etc/ansible/ansible.cfg</code>，下面是常见参数</p> 
<pre><code class="prism language-shell">inventory <span class="token operator">=</span> /etc/ansible/hosts		  <span class="token comment">#这个参数表示资源清单inventory文件的位置</span>
library <span class="token operator">=</span> /usr/share/ansible		 <span class="token comment">#指向存放Ansible模块的目录，支持多个目录方式，只要用冒号（：）隔开就可以</span>
forks <span class="token operator">=</span> <span class="token number">5</span>		                      <span class="token comment">#并发连接数，默认为5</span>
sudo_user <span class="token operator">=</span> root		              <span class="token comment">#设置默认执行命令的用户</span>
remote_port <span class="token operator">=</span> <span class="token number">22</span>		              <span class="token comment">#指定连接被管节点的管理端口，默认为22端口，建议修改，能够更加安全</span>
ask_pass <span class="token operator">=</span> True                <span class="token comment">#是否需要密码</span>
host_key_checking <span class="token operator">=</span> False		     <span class="token comment">#设置是否检查SSH主机的密钥，值为True/False。关闭后第一次连接不会提示配置实例</span>
<span class="token function">timeout</span> <span class="token operator">=</span> <span class="token number">60</span>		                <span class="token comment">#设置SSH连接的超时时间，单位为秒</span>
log_path <span class="token operator">=</span> /var/log/ansible.log		<span class="token comment">#指定一个存储ansible日志的文件（默认不记录日志）</span>

</code></pre> 
<h3><a id="34_ansuble_112"></a>3.4 ansuble主机清单</h3> 
<p>在配置文件中，我们提到了资源清单，这个清单就是我们的主机清单，里面保存的是一些 ansible 需要连接管理的主机列表。在<code>/etc/ansible/hosts</code>文件内</p> 
<p><strong>直接指明主机地址或主机名：</strong></p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ <span class="token function">vim</span> /etc/ansible/hosts 
<span class="token comment">## green.example.com#</span>
<span class="token comment"># blue.example.com#</span>
<span class="token comment"># 192.168.100.1</span>
<span class="token comment"># 192.168.100.10</span>
</code></pre> 
<p><strong>定义一个主机组[组名]把地址或主机名加进去</strong></p> 
<pre><code>[root@localhost ~]$ vim /etc/ansible/hosts 
[mysql_test]
192.168.253.159 ansible_user=root ansible_port=22 ansible_ssh_pass=root
192.168.253.160 ansible_user=root ansible_port=22 ansible_ssh_pass=root
192.168.253.153 ansible_user=root ansible_port=22 ansible_ssh_pass=root

</code></pre> 
<p>还可以使用密钥对配置免密登录<br> 服务端生成密钥对</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ssh-keygen    <span class="token comment">#一路回车</span>
</code></pre> 
<p>然后把公钥传到被控端</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ssh-copy-id root@192.168.37.122
</code></pre> 
<p><strong>vars变量 ：定义主机的内置参数</strong><br> 定义属于整个组的变量</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ <span class="token function">vim</span> /etc/ansible/hosts 
<span class="token punctuation">[</span>test<span class="token punctuation">]</span>
host1
host2

<span class="token punctuation">[</span>test:vars<span class="token punctuation">]</span>
<span class="token assign-left variable">ntp_server</span><span class="token operator">=</span>ntp.atlanta.example.com
<span class="token assign-left variable">proxy</span><span class="token operator">=</span>proxy.atlanta.example.com
</code></pre> 
<p>嵌套定义vars</p> 
<pre><code class="prism language-powershell"><span class="token comment">#编写主机组</span>
<span class="token namespace">[group1]</span>
group1<span class="token punctuation">.</span>linux<span class="token punctuation">.</span>com
 
<span class="token namespace">[group2]</span>
group2<span class="token punctuation">.</span>example<span class="token punctuation">.</span>com
 
<span class="token namespace">[group:children]</span>
group1
group2
 
<span class="token comment">#嵌套变量定义</span>
<span class="token namespace">[group:vars]</span>   <span class="token comment">##用var进行标识</span>
user=studen    <span class="token comment">##以字典方式定义</span>
</code></pre> 
<p><strong>子组分类变量：children</strong><br> 可以把一个组作为另一个组的子成员,以及分配变量给整个组使用</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ <span class="token function">vim</span> /etc/ansible/hosts 
<span class="token punctuation">[</span>nginx<span class="token punctuation">]</span>
<span class="token number">192.168</span>.1.31
<span class="token punctuation">[</span>apache<span class="token punctuation">]</span>
<span class="token number">192.168</span>.1.32
<span class="token punctuation">[</span>webservers:children<span class="token punctuation">]</span> <span class="token comment">#子组分类变量</span>
apache
nginx

<span class="token punctuation">[</span>webservers:vars<span class="token punctuation">]</span>  <span class="token comment">#webservers组的内置变量</span>
<span class="token assign-left variable">ansible_ssh_user</span><span class="token operator">=</span><span class="token string">'root'</span>
<span class="token assign-left variable">ansible_ssh_pass</span><span class="token operator">=</span><span class="token string">'redhat'</span>
<span class="token assign-left variable">ansible_ssh_port</span><span class="token operator">=</span><span class="token string">'22'</span>
</code></pre> 
<p><strong>Inventory(主机清单) 参数的说明</strong></p> 
<pre><code class="prism language-shell">ansible_ssh_host
      将要连接的远程主机名.与你想要设定的主机的别名不同的话,可通过此变量设置.

ansible_ssh_port
      ssh端口号.如果不是默认的端口号,通过此变量设置.

ansible_ssh_user
      默认的 <span class="token function">ssh</span> 用户名

ansible_ssh_pass
      <span class="token function">ssh</span> 密码<span class="token punctuation">(</span>这种方式并不安全,我们强烈建议使用 --ask-pass 或 SSH 密钥<span class="token punctuation">)</span>

ansible_sudo_pass
      <span class="token function">sudo</span> 密码<span class="token punctuation">(</span>这种方式并不安全,我们强烈建议使用 --ask-sudo-pass<span class="token punctuation">)</span>

ansible_sudo_exe <span class="token punctuation">(</span>new <span class="token keyword">in</span> version <span class="token number">1.8</span><span class="token punctuation">)</span>
      <span class="token function">sudo</span> 命令路径<span class="token punctuation">(</span>适用于1.8及以上版本<span class="token punctuation">)</span>

ansible_connection
      与主机的连接类型.比如:local, <span class="token function">ssh</span> 或者 paramiko. Ansible <span class="token number">1.2</span> 以前默认使用 paramiko.1.2 以后默认使用 <span class="token string">'smart'</span>,<span class="token string">'smart'</span> 方式会根据是否支持 ControlPersist, 来判断<span class="token string">'ssh'</span> 方式是否可行.

ansible_ssh_private_key_file
      <span class="token function">ssh</span> 使用的私钥文件.适用于有多个密钥,而你不想使用 SSH 代理的情况.

ansible_shell_type
      目标系统的shell类型.默认情况下,命令的执行使用 <span class="token string">'sh'</span> 语法,可设置为 <span class="token string">'csh'</span> 或 <span class="token string">'fish'</span><span class="token builtin class-name">.</span>

ansible_python_interpreter
      目标主机的 python 路径.适用于的情况: 系统中有多个 Python, 或者命令路径不是<span class="token string">"/usr/bin/python"</span>,比如  <span class="token punctuation">\</span>*BSD, 或者 /usr/bin/python
      不是 <span class="token number">2</span>.X 版本的 Python.我们不使用 <span class="token string">"/usr/bin/env"</span> 机制,因为这要求远程用户的路径设置正确,且要求 <span class="token string">"python"</span> 可执行程序名不可为 python以外的名字<span class="token punctuation">(</span>实际有可能名为python26<span class="token punctuation">)</span>.
</code></pre> 
<h2><a id="ansible__230"></a>四、ansible 常用命令</h2> 
<h3><a id="41_ansible__232"></a>4.1 ansible 命令集</h3> 
<p><code>/usr/bin/ansible</code>　　 Ansibe AD-Hoc 临时命令执行工具，常用于临时命令的执行<br> <code>/usr/bin/ansible-doc</code> 　　 Ansible 模块功能查看工具<br> <code>/usr/bin/ansible-galaxy</code>　　 下载/上传优秀代码或Roles模块 的官网平台，基于网络的<br> <code>/usr/bin/ansible-playbook</code>　　Ansible 定制自动化的任务集编排工具<br> <code>/usr/bin/ansible-pull</code>　　 Ansible远程执行命令的工具，拉取配置而非推送配置（使用较少，海量机器时使用，对运维的架构能力要求较高）<br> <code>/usr/bin/ansible-vault</code>　 　Ansible 文件加密工具<br> <code>/usr/bin/ansible-console</code>　　Ansible基于Linux Consoble界面可与用户交互的命令执行工具<br> <code>/etc/ansible/roles</code> 角色存放处</p> 
<p>其中，我们比较常用的是<code>/usr/bin/ansible</code>和<code>/usr/bin/ansible-playbook</code>。</p> 
<h3><a id="42_ansibledoc__246"></a>4.2 ansible-doc 命令</h3> 
<p>ansible-doc 命令常用于获取模块信息及其使用帮助</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible-doc
Usage: ansible-doc <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token punctuation">[</span>module<span class="token punctuation">..</span>.<span class="token punctuation">]</span>

Options:
  -h, <span class="token parameter variable">--help</span>            show this <span class="token builtin class-name">help</span> message and <span class="token builtin class-name">exit</span>　　<span class="token comment"># 显示命令参数API文档</span>
  -l, <span class="token parameter variable">--list</span>            List available modules　　<span class="token comment">#列出可用的模块</span>
  <span class="token parameter variable">-M</span> MODULE_PATH, --module-path<span class="token operator">=</span>MODULE_PATH　　<span class="token comment">#指定模块的路径</span>
                        specify path<span class="token punctuation">(</span>s<span class="token punctuation">)</span> to module library <span class="token punctuation">(</span>default<span class="token operator">=</span>None<span class="token punctuation">)</span>
  -s, <span class="token parameter variable">--snippet</span>         Show playbook snippet <span class="token keyword">for</span> specified module<span class="token punctuation">(</span>s<span class="token punctuation">)</span>　　<span class="token comment">#显示playbook制定模块的用法</span>
  -v, <span class="token parameter variable">--verbose</span>         verbose mode <span class="token punctuation">(</span>-vvv <span class="token keyword">for</span> more, <span class="token parameter variable">-vvvv</span> to <span class="token builtin class-name">enable</span>　　<span class="token comment"># 显示ansible-doc的版本号查看模块列表：</span>
                        connection debugging<span class="token punctuation">)</span>
  <span class="token parameter variable">--version</span>             show program's version number and <span class="token builtin class-name">exit</span>

</code></pre> 
<h3><a id="43_ansible__266"></a>4.3 ansible 命令详解</h3> 
<p>命令的具体格式如下：</p> 
<pre><code class="prism language-shell">ansible <span class="token operator">&lt;</span>host-pattern<span class="token operator">&gt;</span> <span class="token punctuation">[</span>-f forks<span class="token punctuation">]</span> <span class="token punctuation">[</span>-m module_name<span class="token punctuation">]</span> <span class="token punctuation">[</span>-a args<span class="token punctuation">]</span>
ansible  匹配主机模式   <span class="token parameter variable">-m</span>  模块  <span class="token parameter variable">-a</span>  <span class="token string">'需要执行的内容'</span>

<span class="token operator">&lt;</span> host-pattern<span class="token operator">&gt;</span> 　 匹配主机的列表
	- ALL   表示列表中的所有主机
    ansible all <span class="token parameter variable">-m</span>  <span class="token function">ping</span>   <span class="token comment">#匹配所有主机</span>
	- *   支持通配符
    ansible <span class="token string">"*"</span> <span class="token parameter variable">-m</span> <span class="token function">ping</span>  <span class="token comment">#匹配所有主机</span>
    ansible <span class="token number">192.168</span>.1.* <span class="token parameter variable">-m</span> <span class="token function">ping</span>  <span class="token comment">#匹配IP地址以192.168.1开头的主机</span>
    ansible “*srvs” <span class="token parameter variable">-m</span> <span class="token function">ping</span>  <span class="token comment"># 匹配分组名 以 srvs结尾的主机</span>
    ansible websrvs  <span class="token parameter variable">-m</span> <span class="token function">ping</span> <span class="token comment">#匹配分组名为websrvs</span>
    

常用选项：
	<span class="token parameter variable">-a</span> MODULE_ARGS <span class="token comment">#模块的参数，如果执行默认COMMAND的模块，即是命令参数，如： “date”，“pwd”等等</span>
	<span class="token parameter variable">-m</span> MODULE_NAME <span class="token comment">#执行模块的名字，默认使用 command 模块，所以如果是只执行单一命令可以不用 -m参数</span>
	-k，--ask-pass <span class="token comment">#ask for SSH password。登录密码，提示输入SSH密码而不是假设基于密钥的验证</span>
	--ask-su-pass <span class="token comment">#ask for su password。su切换密码</span>
	-K，--ask-sudo-pass <span class="token comment">#ask for sudo password。提示密码使用sudo，sudo表示提权操作</span>
	--ask-vault-pass <span class="token comment">#ask for vault password。假设我们设定了加密的密码，则用该选项进行访问</span>
	<span class="token parameter variable">-B</span> <span class="token environment constant">SECONDS</span> <span class="token comment">#后台运行超时时间</span>
	<span class="token parameter variable">-C</span>   <span class="token comment">#模拟运行环境并进行预运行，可以进行查错测试</span>
	<span class="token parameter variable">-c</span> CONNECTION <span class="token comment">#连接类型使用</span>
	<span class="token parameter variable">-f</span> FORKS <span class="token comment">#并行任务数，默认为5</span>
	<span class="token parameter variable">-i</span> INVENTORY <span class="token comment">#指定主机清单的路径，默认为/etc/ansible/hosts</span>
	--list-hosts <span class="token comment">#查看有哪些主机组</span>
	<span class="token parameter variable">-o</span> <span class="token comment">#压缩输出，尝试将所有结果在一行输出，一般针对收集工具使用</span>
	<span class="token parameter variable">-S</span> <span class="token comment">#用 su 命令</span>
	<span class="token parameter variable">-R</span> SU_USER <span class="token comment">#指定 su 的用户，默认为 root 用户</span>
	<span class="token parameter variable">-s</span> <span class="token comment">#用 sudo 命令</span>
	<span class="token parameter variable">-U</span> SUDO_USER <span class="token comment">#指定 sudo 到哪个用户，默认为 root 用户</span>
	<span class="token parameter variable">-T</span> TIMEOUT <span class="token comment">#指定 ssh 默认超时时间，默认为10s，也可在配置文件中修改</span>
	<span class="token parameter variable">-u</span> REMOTE_USER <span class="token comment">#远程用户，默认为 root 用户</span>
	<span class="token parameter variable">-v</span> <span class="token comment">#查看详细信息，同时支持-vvv，-vvvv可查看更详细信息</span>

</code></pre> 
<h2><a id="ansible__309"></a>五、ansible 常用模块</h2> 
<table><thead><tr><th>模块名</th><th>说明</th></tr></thead><tbody><tr><td>ping</td><td>检查指定节点机器是否还能连通，用法很简单，不涉及参数，主机如果在线，则回复pong</td></tr><tr><td>command 和 shell</td><td>用于在各被管理节点运行指定的命令. shell和command的区别：shell模块可以特殊字符，而command是不支持</td></tr><tr><td>copy</td><td>在远程主机执行复制操作文件。</td></tr><tr><td>file</td><td>主要用于远程主机上的文件操作。</td></tr><tr><td>fetch</td><td>它用于从远程机器获取文件，并将其本地存储在由主机名组织的文件树中。</td></tr><tr><td>cron</td><td>该模块适用于管理cron计划任务的。</td></tr><tr><td>yum</td><td>RedHat和CentOS的软件包安装和管理工具。</td></tr><tr><td>apt</td><td>Ubuntu/Debian的软件包安装和管理工具。</td></tr><tr><td>service 或 systemd</td><td>用于管理远程主机的服务。</td></tr><tr><td>user 模块 与 group</td><td>user模块是请求的是useradd, userdel, usermod三个指令，goup模块请求的是groupadd, groupdel, groupmod 三个指令。</td></tr><tr><td>script</td><td>在远程主机上执行主控端的脚本，相当于scp+shell组合。</td></tr><tr><td>setup</td><td>该模块主要用于收集信息</td></tr><tr><td>lineinfile</td><td>远程主机上的文件编辑模块</td></tr><tr><td>unarchive</td><td>用于解压文件。</td></tr><tr><td>hostname</td><td>修改远程主机名的模块。批量修改主机名时最好加变量，防止所有主机名一致,ansible all -m hostname -a “name=webserver1”</td></tr><tr><td>mount</td><td>挂载文件系统。</td></tr><tr><td>wait_for</td><td>等待一个事情发生，然后继续。它可以等待某个端口被占用，然后再做下面的事情，也可以在一定时间超时后做另外的事。</td></tr></tbody></table> 
<h3><a id="51_ping__331"></a>5.1 ping 模块</h3> 
<p>ping模块用来检查目标主机是否在线</p> 
<pre><code class="prism language-shell"> <span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible <span class="token builtin class-name">test</span> <span class="token parameter variable">-m</span> <span class="token function">ping</span>
 <span class="token number">192.168</span>.37.122 <span class="token operator">|</span> SUCCESS <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"changed"</span><span class="token builtin class-name">:</span> false, 
    <span class="token string">"ping"</span><span class="token builtin class-name">:</span> <span class="token string">"pong"</span>
<span class="token punctuation">}</span>
<span class="token number">192.168</span>.37.133 <span class="token operator">|</span> SUCCESS <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"changed"</span><span class="token builtin class-name">:</span> false, 
    <span class="token string">"ping"</span><span class="token builtin class-name">:</span> <span class="token string">"pong"</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="52_command__345"></a>5.2 command 模块</h3> 
<p>可以直接在远程主机上执行命令，并将结果返回本主机。不支持特殊字符</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible <span class="token builtin class-name">test</span> <span class="token parameter variable">-m</span> <span class="token builtin class-name">command</span> <span class="token parameter variable">-a</span> <span class="token string">'ss -ntl'</span>

常用的选项：
	chdir：　　　　 <span class="token comment"># 在执行命令之前，先切换到该目录</span>
	executable：   <span class="token comment"># 切换shell来执行命令，需要使用命令的绝对路径</span>
	free_form： 　 <span class="token comment"># 要执行的Linux指令，一般使用Ansible的-a参数代替。</span>
	creates： 　   <span class="token comment"># 一个文件名，当这个文件存在，则该命令不执行,可以用来做判断</span>
	removes：      <span class="token comment"># 一个文件名，这个文件不存在，则该命令不执行</span>
	

<span class="token comment">#先切换到/data/ 目录，再执行“ls”命令</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible <span class="token builtin class-name">test</span> <span class="token parameter variable">-m</span> <span class="token builtin class-name">command</span> <span class="token parameter variable">-a</span> <span class="token string">'chdir=/data/ ls'</span>

<span class="token comment">#如果/data/aaa.jpg存在，则不执行“ls”命令</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible <span class="token builtin class-name">test</span> <span class="token parameter variable">-m</span> <span class="token builtin class-name">command</span> <span class="token parameter variable">-a</span> <span class="token string">'creates=/data/aaa.jpg ls'</span>

<span class="token comment">#如果/data/aaa.jpg存在，则执行“cat /data/a”命令</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible <span class="token builtin class-name">test</span> <span class="token parameter variable">-m</span> <span class="token builtin class-name">command</span> <span class="token parameter variable">-a</span> <span class="token string">'removes=/data/aaa.jpg cat /data/a'</span>


</code></pre> 
<p>注意，该命令不支持| 管道命令。</p> 
<h3><a id="53_shell__372"></a>5.3 shell 模块</h3> 
<p>shell模块可以在远程主机上调用shell解释器运行命令，支持shell的各种功能</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible <span class="token builtin class-name">test</span> <span class="token parameter variable">-m</span> shell <span class="token parameter variable">-a</span> <span class="token string">'cat /etc/passwd |grep "keer"'</span>
<span class="token number">192.168</span>.37.122 <span class="token operator">|</span> SUCCESS <span class="token operator">|</span> <span class="token assign-left variable">rc</span><span class="token operator">=</span><span class="token number">0</span> <span class="token operator">&gt;&gt;</span>
keer:x:10001:1000:keer:/home/keer:/bin/sh

<span class="token number">192.168</span>.37.133 <span class="token operator">|</span> SUCCESS <span class="token operator">|</span> <span class="token assign-left variable">rc</span><span class="token operator">=</span><span class="token number">0</span> <span class="token operator">&gt;&gt;</span>
keer:x:10001:10001::/home/keer:/bin/sh


</code></pre> 
<h3><a id="54_copy__385"></a>5.4 copy 模块</h3> 
<p>用于将文件复制到远程主机，同时支持给定内容生成文件和修改权限等。远程主机目录不存在，则会自动创建</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible <span class="token builtin class-name">test</span> <span class="token parameter variable">-m</span> copy <span class="token parameter variable">-a</span> <span class="token string">'src=~/hello dest=/data/hello'</span> 

常用选项：
	src：　　　　 <span class="token comment"># 源文件绝对路径或相对路径</span>
	dest：　　　 　<span class="token comment">#必选项，将源文件复制到的远程主机的绝对路径</span>
	content：　　　<span class="token comment">#用于替换"src"，可以直接指定文件的值</span>
	backup：　　 　<span class="token comment">#当文件内容发生改变后，在覆盖之前把源文件备份，备份文件包含时间信息</span>
	directory_mode：　　　　<span class="token comment">#递归设定目录的权限，默认为系统默认权限</span>
	force：　　　　  <span class="token comment">#当目标主机包含该文件，但内容不同时，设为"yes"，表示强制覆盖；为"no"，表示目标主机的目标位置不存在该文件才复制。默认为"yes"</span>
	others：　　　　<span class="token comment">#所有的 file 模块中的选项可以在这里使用</span>
	mode：         <span class="token comment">#设置文件权限</span>
	owner：        <span class="token comment">#属主</span>
	group：        <span class="token comment">#属组</span>
	
	

<span class="token comment">#给定内容生成文件，并制定权限</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible <span class="token builtin class-name">test</span> <span class="token parameter variable">-m</span> copy <span class="token parameter variable">-a</span> <span class="token string">'content="I am keer\n" dest=/data/name mode=666'</span>



<span class="token comment">#查看一下我们生成的文件及其权限</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible <span class="token builtin class-name">test</span> <span class="token parameter variable">-m</span> shell <span class="token parameter variable">-a</span> <span class="token string">'ls -l /data/'</span>
<span class="token number">192.168</span>.37.122 <span class="token operator">|</span> SUCCESS <span class="token operator">|</span> <span class="token assign-left variable">rc</span><span class="token operator">=</span><span class="token number">0</span> <span class="token operator">&gt;&gt;</span>
total <span class="token number">28</span>
-rw-rw-rw-   <span class="token number">1</span> root root   <span class="token number">12</span> Dec  <span class="token number">6</span> 09:45 name

<span class="token number">192.168</span>.37.133 <span class="token operator">|</span> SUCCESS <span class="token operator">|</span> <span class="token assign-left variable">rc</span><span class="token operator">=</span><span class="token number">0</span> <span class="token operator">&gt;&gt;</span>
total <span class="token number">40</span>
-rw-rw-rw- <span class="token number">1</span> root     root       <span class="token number">12</span> Dec  <span class="token number">5</span> 09:45 name

<span class="token comment">#把文件的内容修改一下，然后选择覆盖备份</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible <span class="token builtin class-name">test</span> <span class="token parameter variable">-m</span> copy <span class="token parameter variable">-a</span> <span class="token string">'content="I am keerya\n" backup=yes dest=/data/name mode=666'</span>



<span class="token comment">#可以查看一下name文件的内容</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible <span class="token builtin class-name">test</span> <span class="token parameter variable">-m</span> shell <span class="token parameter variable">-a</span> <span class="token string">'cat /data/name'</span>
<span class="token number">192.168</span>.37.122 <span class="token operator">|</span> SUCCESS <span class="token operator">|</span> <span class="token assign-left variable">rc</span><span class="token operator">=</span><span class="token number">0</span> <span class="token operator">&gt;&gt;</span>
I am keerya

<span class="token number">192.168</span>.37.133 <span class="token operator">|</span> SUCCESS <span class="token operator">|</span> <span class="token assign-left variable">rc</span><span class="token operator">=</span><span class="token number">0</span> <span class="token operator">&gt;&gt;</span>
I am keerya
</code></pre> 
<h3><a id="55_file__433"></a>5.5 file 模块</h3> 
<p>该模块主要用于设置文件的属性，比如创建文件、创建链接文件、删除文件等。</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible <span class="token builtin class-name">test</span> <span class="token parameter variable">-m</span> <span class="token function">file</span> <span class="token parameter variable">-a</span> <span class="token string">'path=/data/app state=directory'</span>

常用选项：
	path：　　<span class="token comment">#必选项，定义文件/目录的路径</span>
	force：　　<span class="token comment">#需要在两种情况下强制创建软链接，一种是源文件不存在，但之后会建立的情况下；另一种是目标软链接已存在，需要先取消之前的软链，然后创建新的软链，有两个选项：yes|no</span>
	group：　　<span class="token comment">#定义文件/目录的属组。后面可以加上mode：定义文件/目录的权限</span>
	owner：　　<span class="token comment">#定义文件/目录的属主。后面必须跟上path：定义文件/目录的路径</span>
	recurse：　　<span class="token comment">#递归设置文件的属性，只对目录有效，后面跟上src：被链接的源文件路径，只应用于state=link的情况</span>
	dest：　　<span class="token comment">#被链接到的路径，只应用于state=link的情况</span>
	state：　　<span class="token comment">#状态，有以下选项：</span>
		directory：如果目录不存在，就创建目录
		file：即使文件不存在，也不会被创建
		link：创建软链接
		hard：创建硬链接
		touch：如果文件不存在，则会创建一个新的文件，如果文件或目录已存在，则更新其最后修改时间
		absent：删除目录、文件或者取消链接文件
		
		
		

<span class="token comment">#创建新目录</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span> ansible all <span class="token parameter variable">-m</span> <span class="token function">file</span> <span class="token parameter variable">-a</span> <span class="token string">'name=/data state=directory'</span>

<span class="token comment">#创建新文件</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible all <span class="token parameter variable">-m</span> <span class="token function">file</span> <span class="token parameter variable">-a</span> <span class="token string">'name=/data/f3 state=touch'</span> 

<span class="token comment">#删除文件</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible all <span class="token parameter variable">-m</span> <span class="token function">file</span> <span class="token parameter variable">-a</span> <span class="token string">'name=/data/f3 state=absent'</span>

<span class="token comment">#删除目录下的所有文件（建议使用shell好用）</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible all <span class="token parameter variable">-m</span> shell <span class="token parameter variable">-a</span> <span class="token string">'rm -rf /data/*'</span>

<span class="token comment">#创建目录</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible all <span class="token parameter variable">-m</span> <span class="token function">file</span> <span class="token parameter variable">-a</span> <span class="token string">'name=/data/dir1 state=directory'</span>

<span class="token comment">#删除目录</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible all <span class="token parameter variable">-m</span> <span class="token function">file</span> <span class="token parameter variable">-a</span> <span class="token string">'name=/data/dir1 state=absent'</span>

<span class="token comment">#创建软连接</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible all <span class="token parameter variable">-m</span> <span class="token function">file</span> <span class="token parameter variable">-a</span> <span class="token string">'src=/etc/fstab dest=/data/fstab.link state=link'</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible all <span class="token parameter variable">-m</span> <span class="token function">file</span> <span class="token parameter variable">-a</span> <span class="token string">'dest=/data/fstab.link state=absent'</span>

<span class="token comment">#创建文件指定所有者，权限</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible all <span class="token parameter variable">-m</span> <span class="token function">file</span> <span class="token parameter variable">-a</span> <span class="token string">'path=/root/a.sh owner=liych mode=755'</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible all <span class="token parameter variable">-m</span> <span class="token function">file</span> <span class="token parameter variable">-a</span> <span class="token string">'src=/data/testfile dest=/data/testfile-link state=link'</span>
</code></pre> 
<h3><a id="56_fetch__484"></a>5.6 fetch 模块</h3> 
<p>该模块用于从远程某主机获取（复制）文件到本地。</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible web <span class="token parameter variable">-m</span> fetch <span class="token parameter variable">-a</span> <span class="token string">'src=/data/hello dest=/data'</span>

常用选项：
	dest：  <span class="token comment"># 本地存储拉取文件的目录。</span>
	src：  <span class="token comment"># 远程主机上的源文件，不支持目录。在未来的版本可能会支持目录递归拉取。</span>
	validate_checksum：     　　 <span class="token comment"># 获取文件后验证源和目标校验和是否匹配</span>
	
	
<span class="token comment">#远程主机拉取文件</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible <span class="token builtin class-name">test</span> <span class="token parameter variable">-m</span> fetch <span class="token parameter variable">-a</span> <span class="token string">'src=/data/hello dest=/data'</span>  

<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ <span class="token function">ls</span> /data/
</code></pre> 
<h3><a id="57_cron__502"></a>5.7 cron 模块</h3> 
<p>该模块适用于管理cron计划任务的。其使用的语法跟我们的crontab文件中的语法一致</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible web <span class="token parameter variable">-m</span> <span class="token function">cron</span> <span class="token parameter variable">-a</span> <span class="token string">'name="ntp update every 5 min" minute=*/5 job="/sbin/ntpdate 172.17.0.1 &amp;&gt; /dev/null"'</span>

常用选项:
	name：     <span class="token comment">#定时任务描述</span>
	job：      <span class="token comment">#指明运行的命令是什么,可以写shell命令</span>
	cron_file：      <span class="token comment"># 自定义cron_file的文件名，使用相对路径则在/etc/cron.d中。</span>
	user：           <span class="token comment"># 以哪个用户的身份执行</span>

	minute：         <span class="token comment"># 分(0-59, *, */N)，不写时，默认为*</span>
	hour：          <span class="token comment"># 时(0-23, *, */N)，不写时，默认为*</span>
	day：           <span class="token comment"># 日(1-31, *, */N)，不写时，默认为*</span>
	month：          <span class="token comment"># 月(1-12, *, */N)，不写时，默认为*</span>
	weekday：        <span class="token comment"># 周(0-6 for Sunday-Saturday, *)，不写时，默认为*</span>

	special_time <span class="token comment">#特殊的时间范围，参数： reboot（重启时），annually（每年），monthly（每月），weekly（每周），daily（每天），hourly（每小时）</span>
	state <span class="token comment">#指定状态</span>
		present表示添加定时任务，也是默认设置
		absent表示删除定时任务



<span class="token comment">#创建计划任务：每周1,3,5，每分钟打印warning，任务名称：test </span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible all <span class="token parameter variable">-m</span> <span class="token function">cron</span> <span class="token parameter variable">-a</span> <span class="token string">'minute=* weekday=1,3,5 job="/usr/bin/wall  warning" name=test'</span>

<span class="token comment">#注释禁用cronname=test的计划任务：也可以用yes/no</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible all <span class="token parameter variable">-m</span> <span class="token function">cron</span> <span class="token parameter variable">-a</span> <span class="token string">'disabled=true job="/usr/bin/wall  warning" name=test'</span>

<span class="token comment">#给cronname=test的计划任务去掉注释：也可以用yes/no</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible all <span class="token parameter variable">-m</span> <span class="token function">cron</span> <span class="token parameter variable">-a</span> <span class="token string">'disabled=false job="/usr/bin/wall  warning" name=test'</span>

<span class="token comment">#删除计划任务：</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible all <span class="token parameter variable">-m</span> <span class="token function">cron</span> <span class="token parameter variable">-a</span> <span class="token string">'job="/usr/bin/wall warning" name=test state=absent'</span>

<span class="token comment">#查看计划任务：</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible all <span class="token parameter variable">-m</span> shell <span class="token parameter variable">-a</span> <span class="token string">'crontab -l'</span>

<span class="token comment">#增加定时任务</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ <span class="token function">vim</span> add_cron.yaml
---
- hosts: sktest
  remote_user: root
  gather_facts: False
  tasks:
   - name: copy <span class="token function">file</span>
     copy: <span class="token assign-left variable">src</span><span class="token operator">=</span>/etc/ansible/test.sh <span class="token assign-left variable">dest</span><span class="token operator">=</span>/home/ <span class="token assign-left variable">mode</span><span class="token operator">=</span><span class="token number">755</span>
   - name: <span class="token function">add</span> <span class="token function">cron</span> <span class="token comment">#每2小时执行一次</span>
     cron: <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token string">'test'</span> <span class="token assign-left variable">hour</span><span class="token operator">=</span>*/2 <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">'bash /home/test.sh'</span>
   - name: zhushi <span class="token function">cron</span> <span class="token comment">#取消注释 disabled=false</span>
     cron: <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token string">'test'</span> <span class="token assign-left variable">hour</span><span class="token operator">=</span>*/2 <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">'bash /home/test.sh'</span> <span class="token assign-left variable">disabled</span><span class="token operator">=</span>true


</code></pre> 
<h3><a id="58_yum__559"></a>5.8 yum 模块</h3> 
<p>RedHat和CentOS的软件包安装和管理工具。</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible web <span class="token parameter variable">-m</span> yum <span class="token parameter variable">-a</span> <span class="token string">'name=htop state=present'</span>

常用选项：
	<span class="token assign-left variable">name</span><span class="token operator">=</span>　　         <span class="token comment">#所安装的包的名称</span>
	<span class="token assign-left variable">state</span><span class="token operator">=</span>　　        <span class="token comment">#present---&gt;安装， latest---&gt;安装最新的, absent---&gt; 卸载软件。</span>
	update_cache　     　<span class="token comment">#强制更新yum的缓存</span>
	conf_file　　        <span class="token comment">#指定远程yum安装时所依赖的配置文件（安装本地已有的包）。</span>
	disable_pgp_check　　<span class="token comment">#是否禁止GPG checking，只用于presentor latest。</span>
	disablerepo　　       <span class="token comment">#临时禁止使用yum库。 只用于安装或更新时。</span>
	enablerepo　      　<span class="token comment">#临时使用的yum库。只用于安装或更新时。</span>
	
	
	

<span class="token comment">#yum安装vsftpd包：（默认state=installd）</span>
<span class="token comment">#列出和ansible相关的包。</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible all <span class="token parameter variable">-m</span> yum <span class="token parameter variable">-a</span> <span class="token string">"list=ansible"</span> 
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible all <span class="token parameter variable">-m</span> yum <span class="token parameter variable">-a</span> <span class="token string">'name=nginx'</span>

<span class="token comment">#安装多个包用逗号隔开：</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible all <span class="token parameter variable">-m</span> yum <span class="token parameter variable">-a</span> <span class="token string">'name=nginx，vsftpd'</span>

<span class="token comment">#显示所有已安装的包：</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible all <span class="token parameter variable">-m</span> yum <span class="token parameter variable">-a</span> <span class="token string">'name=vsftpd  list=installd'</span>

<span class="token comment">#卸载vsftpd包：</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible all <span class="token parameter variable">-m</span> yum <span class="token parameter variable">-a</span> <span class="token string">'name=nvsftpd  state=removed'</span>

<span class="token comment">#安装从互联网下载的包：</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible all <span class="token parameter variable">-m</span> yum <span class="token parameter variable">-a</span> <span class="token string">'name=https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm state=present'</span>

<span class="token comment">#安装本地的包，且排除某些包不安装。</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible all <span class="token parameter variable">-m</span> yum <span class="token parameter variable">-a</span> <span class="token string">"name=/tmp/*.rpm exclude=*unix* state=present"</span>

<span class="token comment">#更新缓存：</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible all <span class="token parameter variable">-m</span> yum <span class="token parameter variable">-a</span> <span class="token string">'update_cache=yes'</span>

<span class="token comment">#更新缓存同时安装dstat包</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible all <span class="token parameter variable">-m</span> yum <span class="token parameter variable">-a</span> <span class="token string">'name=dstat update_cache=yes'</span>


</code></pre> 
<p><strong>yum_repository模块管理远程主机上的yum仓库</strong></p> 
<pre><code class="prism language-powershell">参数
	name：相当于<span class="token punctuation">.</span>repo文件定义中括号的<span class="token punctuation">[</span>仓库ID<span class="token punctuation">]</span>
	baseurl：相当于<span class="token punctuation">.</span>repo文件中baseurl
	description：相当于<span class="token punctuation">.</span>repo文件中的name
	file：相当于<span class="token punctuation">.</span>repo文件的名称，不使用时默认以name加<span class="token punctuation">.</span>repo命令
	enabled=yes<span class="token punctuation">|</span>no：相当于<span class="token punctuation">.</span>repo文件中enabled
	gpgcheck=yes<span class="token punctuation">|</span>no：相当于<span class="token punctuation">.</span>repo文件中gpgcheck
	gpgcakey：前提是gpgcheck=yes，相当于<span class="token punctuation">.</span>repo文件中gpgkey，验证gpg公钥
	state=present<span class="token punctuation">|</span>absent：默认present，absent表示删除
</code></pre> 
<p><strong>示例</strong></p> 
<p>创建阿里云epel源</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ ansible all <span class="token operator">-</span>m yum_repository <span class="token operator">-</span>a <span class="token string">'name=aliepel baseurl=https://mirrors.aliyun.com/epel/7/x86_64/ enabled=yes gpgcheck=yes gpgcakey=https://mirrors.aliyun.com/epel/RPM-GPG-KEY-EPEL-7 state=present file=AlicloudEpel'</span>
</code></pre> 
<p>删除阿里云epel源</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ ansible all <span class="token operator">-</span>m yum_repository <span class="token operator">-</span>a <span class="token string">'file=AlicloudEpel name=aliepel state=absent'</span>
</code></pre> 
<h3><a id="59_apt__633"></a>5.9 apt 模块</h3> 
<p>Apt是Ubuntu/Debian的包管理工具。</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible web-nodes <span class="token parameter variable">-m</span> <span class="token function">apt</span> <span class="token parameter variable">-a</span> <span class="token string">'name=foo update_cache=yes'</span>

常用选项：
	deb:                <span class="token comment">#用于安装远程机器上的.deb后缀的软件包（optional）</span>
	install_recommends:    <span class="token comment">#这个参数可以控制远程电脑上是否只是下载软件包，还是下载后安装，默认参数为true,设置为false的时候只下载软件包，不安装</span>
	update_cache: <span class="token comment">#当这个参数为yes的时候等于apt-get update（optional）</span>
	name:          <span class="token comment">#apt要下载的软件包名字，支持name=git=1.6 这种制定版本的模式</span>
	state:         <span class="token comment">#状态（present，absent，latest）,表示是安装还是卸载. 其中present、installed、latest 表示安装, absent 、removed表示卸载删除; present默认状态, laster表示安装最新版本.</span>
	
	
	

<span class="token comment">#在安装foo软件包前更新然后安装foo</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible web-nodes <span class="token parameter variable">-m</span> <span class="token function">apt</span> <span class="token parameter variable">-a</span> <span class="token string">'name=foo update_cache=yes'</span>
 
<span class="token comment">#移除foo软件包</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible web-nodes <span class="token parameter variable">-m</span> <span class="token function">apt</span> <span class="token parameter variable">-a</span> <span class="token string">'name=foo state=absent'</span>
 
<span class="token comment">#安装foo软件包</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible web-nodes <span class="token parameter variable">-m</span> <span class="token function">apt</span> <span class="token parameter variable">-a</span> <span class="token string">'name=foo state=present'</span>
 
<span class="token comment">#安装foo 1.0软件包</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible web-nodes <span class="token parameter variable">-m</span> <span class="token function">apt</span> <span class="token parameter variable">-a</span> <span class="token string">'name=foo=1.00 state=present'</span>
 
<span class="token comment">#安装nginx最新的名字为squeeze-backport发布包，并且安装前执行更新</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible web-nodes <span class="token parameter variable">-m</span> <span class="token function">apt</span> <span class="token parameter variable">-a</span> <span class="token string">'name=nginx state=latest default_release=squeeze-backports update_cache=yes'</span>
 
<span class="token comment">#只下载openjdk-6-jdk最新的软件包，不安装</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible web-nodes <span class="token parameter variable">-m</span> <span class="token function">apt</span> <span class="token parameter variable">-a</span> <span class="token string">'name=openjdk-6-jdk state=latest install_recommends=no'</span>
 
<span class="token comment">#安装所有软件包到最新版本</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible web-nodes <span class="token parameter variable">-m</span> <span class="token function">apt</span> <span class="token parameter variable">-a</span> <span class="token string">'upgrade=dist'</span>
 
<span class="token comment">#更新apt-get的list</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible web-nodes <span class="token parameter variable">-m</span> <span class="token function">apt</span> <span class="token parameter variable">-a</span> <span class="token string">'update_cache=yes'</span>
 
<span class="token comment">#3600秒后停止update_cache</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible web-nodes <span class="token parameter variable">-m</span> <span class="token function">apt</span> <span class="token parameter variable">-a</span> <span class="token string">'update_cache=yes cache_valid_time=3600'</span>
 
<span class="token comment">#安装远程节点上的/tmp/mypackage.deb软件包</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible web-nodes <span class="token parameter variable">-m</span> <span class="token function">apt</span> <span class="token parameter variable">-a</span> <span class="token string">'deb=/tmp/mypackage.deb'</span>
</code></pre> 
<h3><a id="510_service__680"></a>5.10 service 模块</h3> 
<p>该模块用于服务程序的管理。</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible web <span class="token parameter variable">-m</span> <span class="token function">service</span> <span class="token parameter variable">-a</span> <span class="token string">'name=nginx state=started enabled=true'</span> 

常用选项：

	<span class="token assign-left variable">enabled</span><span class="token operator">=</span><span class="token punctuation">[</span>yes<span class="token operator">|</span>no<span class="token punctuation">]</span> <span class="token comment">#是否开机启动 默认no</span>
	name：           <span class="token comment">#必选项，服务名称</span>
	pattern：        <span class="token comment">#定义一个模式，如果通过status指令来查看服务的状态时，没有响应，就会通过ps指令在进程中根据该模式进行查找，如果匹配到，则认为该服务依然在运行</span>
	sleep：          <span class="token comment">#如果执行了restarted，在则stop和start之间沉睡几秒钟</span>
	state：          <span class="token comment">#对当前服务执行启动，停止、重启、重新加载等操作    </span>
					 <span class="token comment">#（started,stopped,restarted,reloaded）</span>

<span class="token comment">#停止httpd服务：</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible all <span class="token parameter variable">-m</span> <span class="token function">service</span> <span class="token parameter variable">-a</span> ‘name<span class="token operator">=</span>httpd <span class="token assign-left variable">state</span><span class="token operator">=</span>stopped’

<span class="token comment">#开启httpd服务：</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible all <span class="token parameter variable">-m</span> <span class="token function">service</span> <span class="token parameter variable">-a</span> ‘name<span class="token operator">=</span>httpd <span class="token assign-left variable">state</span><span class="token operator">=</span>started’

<span class="token comment">#重新加载httod服务：</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible all <span class="token parameter variable">-m</span> <span class="token function">service</span> <span class="token parameter variable">-a</span> ‘name<span class="token operator">=</span>httpd <span class="token assign-left variable">state</span><span class="token operator">=</span>reloaded’

<span class="token comment">#重启httpd服务：</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible all <span class="token parameter variable">-m</span> <span class="token function">service</span> <span class="token parameter variable">-a</span> ‘name<span class="token operator">=</span>httpd <span class="token assign-left variable">state</span><span class="token operator">=</span>restarted’

<span class="token comment">#开启ftp服务，同时设置开机自动启动：</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible all <span class="token parameter variable">-m</span> <span class="token function">service</span> <span class="token parameter variable">-a</span> ‘name<span class="token operator">=</span>vsftpd <span class="token assign-left variable">state</span><span class="token operator">=</span>started <span class="token assign-left variable">enabled</span><span class="token operator">=</span>yes’

<span class="token comment">#重启ftp服务：</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible all <span class="token parameter variable">-m</span> <span class="token function">service</span> <span class="token parameter variable">-a</span> ‘name<span class="token operator">=</span>vsftpd <span class="token assign-left variable">state</span><span class="token operator">=</span>restarted’

</code></pre> 
<h3><a id="511_unarchive__715"></a>5.11 unarchive 模块</h3> 
<p>将ansible主机上的压缩包在本地解压缩后传到远程主机上，或者将远程主机上的某个压缩包解压缩到指定路径下</p> 
<pre><code>[root@localhost ~]$ ansible pms -m unarchive -a 'src=/srv/tomcat8/apache-tomcat-8.0.29.tar.gz dest=/usr/local copy=no mode=0755'

常用选项：
	creates：一个文件名，当它已经存在时，这个步骤将不会被运行。
	copy：默认为yes，拷贝的文件从ansible主机复制到远程主机，no在远程主机上寻找src源文件解压
	src：tar源路径，可以是ansible主机上的路径，也可以是远程主机上的路径，如果是远程主机上的路径，则需设置copy=no
	dest：远程主机上的目标绝对路径
	mode：设置解压缩后的文件权限
	exec：列出需要排除的目录和文件
	remote_src：设置remote_src=yes为解包目标上已经存在的档案。对于Windows目标，改用win_unzip模块。
	owner：解压后文件或目录的属主
	group：解压后的目录或文件的属组
	
	
#解压ansible管理机上的压缩文件到远程主机并设置权限
[root@localhost ~]$ ansible all -m unarchive -a "src=/tmp/install/zabbix-3.0.4.tar.gz dest=/tmp/ mode=755 copy=yes"

#在远程主机上解压文件并设置权限
[root@localhost ~]$ ansible all -m unarchive -a 'src=/srv/tomcat8/apache-tomcat-8.0.29.tar.gz dest=/usr/local copy=no mode=755'


---
- hosts: test
  remote_user: root
  gather_facts: False
  tasks:
   - name: tar tomcat
     unarchive: src=/srv/tomcat8/apache-tomcat-8.0.29.tar.gz dest=/usr/local copy=yes
     notify:
       - restart tomcat

  handlers: 
    - name: restart tomcat 
      shell: service tomcat restart



</code></pre> 
<h3><a id="512_lineinfile__758"></a>5.12 lineinfile 模块</h3> 
<p>用于对远程受控节点的文件编辑模块</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible web-nodes <span class="token parameter variable">-m</span> lineinfile <span class="token parameter variable">-a</span> <span class="token string">'path=/data/test regexp="123" line="wangshibo" backrefs=no'</span>

常用选项：
	path: 指定要修改的配置文件, 包括:
			 regexp:匹配要修改的内容,可以使用政策
			 line:要增加或者修改的内容
	state: 状态, 包括:
			 absent:表示删除，当匹配到时进行删除
			 present:表示增加，当匹配到时进行修改，当没有匹配到时在最后增加一行，默认为此项
	backrefs: 该参数值包括:
			 no:表示如果没有匹配到，则增加line；如果匹配成功，则替换line；
			 yes:表示如果没有匹配到，则不变line；如果匹配成功，则替换line；
	backup: 该参数值包括:
			 no:表示如果没有匹配到，则增加line；如果匹配成功，则替换line；不备份原文件
			 yes:表示如果没有匹配到，则增加line；如果匹配成功，则替换line；备份原文件
	insertafter<span class="token punctuation">(</span>匹配的是此行<span class="token punctuation">)</span>: 在匹配到的行之后添加一行.  <span class="token punctuation">(</span>经测试, 发现是匹配到的行的最后一行的后面添加一行<span class="token punctuation">)</span>
	insertbefore<span class="token punctuation">(</span>匹配的是此行<span class="token punctuation">)</span>： 在匹配到的行之前添加一行.  <span class="token punctuation">(</span>经测试, 发现是匹配到的行的最后一行的前面添加一行<span class="token punctuation">)</span>
	
	
	
<span class="token comment">#将远程受控节点的/data/test文件中的"123"字段修改为"wangshibo"</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span> ansible web-nodes <span class="token parameter variable">-m</span> lineinfile <span class="token parameter variable">-a</span> <span class="token string">'path=/data/test regexp="123" line="wangshibo" backrefs=no'</span>
 
<span class="token comment"># 将line开头的行替换为test test</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible <span class="token builtin class-name">test</span> <span class="token parameter variable">-m</span> lineinfile <span class="token parameter variable">-a</span> <span class="token string">"path=/testdir/test regexp='^line' line='test test'"</span>
 
<span class="token comment">#匹配到的行后增加一行</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible <span class="token builtin class-name">test</span> <span class="token parameter variable">-m</span> lineinfile <span class="token parameter variable">-a</span> <span class="token string">'dest=/data/test insertafter="wangshibo" line="huihui"'</span>
 
<span class="token comment">#匹配到的行前增加一行 </span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible <span class="token builtin class-name">test</span> <span class="token parameter variable">-m</span> lineinfile <span class="token parameter variable">-a</span> <span class="token string">'dest=/data/test insertbefore="root" line="huihui"'</span>
 
<span class="token comment">#删除匹配到的行：</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible <span class="token builtin class-name">test</span> <span class="token parameter variable">-m</span> lineinfile <span class="token parameter variable">-a</span> <span class="token string">'path=/data/test regexp="123" state=absent'</span>


</code></pre> 
<h3><a id="513_script__800"></a>5.13 script 模块</h3> 
<p>该模块用于将本机的脚本在被管理端的机器上运行。</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ <span class="token function">vim</span> /tmp/df.sh
<span class="token comment">#!/bin/bash</span>

<span class="token function">date</span> <span class="token operator">&gt;&gt;</span> /tmp/disk_total.log
<span class="token function">df</span> <span class="token parameter variable">-lh</span> <span class="token operator">&gt;&gt;</span> /tmp/disk_total.log 
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span> <span class="token function">chmod</span> +x /tmp/df.sh 

<span class="token comment">#执行脚本</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible web <span class="token parameter variable">-m</span> script <span class="token parameter variable">-a</span> <span class="token string">'/tmp/df.sh'</span>

</code></pre> 
<h3><a id="514_setup__816"></a>5.14 setup 模块</h3> 
<p>该模块主要用于收集信息，是通过调用facts组件来实现的。<br> <strong>查看信息</strong><br> 　　可以直接用命令获取到变量的值</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ ansible web <span class="token operator">-</span>m setup <span class="token operator">-</span>a <span class="token string">'filter="*mem*"'</span>	<span class="token comment">#查看内存</span>
<span class="token namespace">[root@localhost ~]</span>$ cd <span class="token operator">/</span>tmp/facts/
</code></pre> 
<p><strong>保存信息</strong><br> setup模块还有一个很好用的功能就是可以保存我们所筛选的信息至我们的主机上，同时，文件名为我们被管制的主机的IP</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ ansible web <span class="token operator">-</span>m setup <span class="token operator">-</span>a <span class="token string">'filter="*mem*"'</span> <span class="token operator">--</span>tree <span class="token operator">/</span>tmp/facts
</code></pre> 
<h3><a id="515_user__834"></a>5.15 user 模块</h3> 
<p>该模块主要是用来管理用户账号。</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible web <span class="token parameter variable">-m</span> user <span class="token parameter variable">-a</span> <span class="token string">'name=keer uid=11111'</span>

常用选项：
	comment　　<span class="token comment"># 用户的描述信息</span>
	createhome　　<span class="token comment"># 是否创建家目录</span>
	force　　<span class="token comment"># 在使用state=absent时, 行为与userdel –force一致.</span>
	group　　<span class="token comment"># 指定基本组</span>
	<span class="token function">groups</span>　　<span class="token comment"># 指定附加组，如果指定为(groups=)表示删除所有组</span>
	home　　<span class="token comment"># 指定用户家目录</span>
	move_home　　<span class="token comment"># 如果设置为home=时, 试图将用户主目录移动到指定的目录</span>
	name　　<span class="token comment"># 指定用户名</span>
	non_unique　　<span class="token comment"># 该选项允许改变非唯一的用户ID值</span>
	password　　<span class="token comment"># 指定用户密码</span>
	remove　　<span class="token comment"># 在使用state=absent时, 行为是与userdel –remove一致</span>
	shell　　<span class="token comment"># 指定默认shell</span>
	state　　<span class="token comment"># 设置帐号状态，不指定为创建，指定值为absent表示删除</span>
	system　　<span class="token comment"># 当创建一个用户，设置这个用户是系统用户。这个设置不能更改现有用户</span>
	uid　　<span class="token comment"># 指定用户的uid</span>
	
	
	

<span class="token comment">#使用bash shell添加用户haha，将组"管理员"和"开发人员"附加到用户组</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible web-nodes <span class="token parameter variable">-m</span> user <span class="token parameter variable">-a</span> <span class="token string">"name=haha shell=/bin/bash groups=admins,developers append=yes"</span>

<span class="token comment">#删除用户anhui</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible <span class="token builtin class-name">test</span> <span class="token parameter variable">-m</span> user <span class="token parameter variable">-a</span> <span class="token string">'name=anhui remove=yes state=absent'</span> 


<span class="token comment">#修改用户密码</span>
---
- hosts: demo
  remote_user: root
  tasks:
  - name: change user <span class="token function">passwd</span>
    user: <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> item.user <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token assign-left variable">password</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> item.password <span class="token operator">|</span> password_hash<span class="token punctuation">(</span><span class="token string">'sha512'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>  <span class="token assign-left variable">update_password</span><span class="token operator">=</span>always
    with_items:
        - <span class="token punctuation">{<!-- --></span> user: <span class="token string">'root'</span>, password: <span class="token string">'root'</span> <span class="token punctuation">}</span>

</code></pre> 
<h3><a id="516_mount__878"></a>5.16 mount 模块</h3> 
<p>在远程受控节点上挂载文件系统。</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible <span class="token builtin class-name">test</span> <span class="token parameter variable">-m</span> <span class="token function">mount</span> <span class="token parameter variable">-a</span> <span class="token string">"path=/mnt/data src=/dev/sd0 fstype=ext4 ots=ro state=present"</span>

常用选项：
	present: 开机挂载，仅将挂载配置写入/etc/fstab（不常用）
	mounted: 挂载设备，并将配置写入/etc/fstab
	unmounted: 卸载设备，不会清除/etc/fstab写入的配置
	absent: 卸载设备，会清理/etc/fstab写入的配置


<span class="token comment">#将受控节点的/dev/sd0设备挂载到/mnt/data目录上, 文件格式为ext4, 只读属性</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible web-nodes <span class="token parameter variable">-m</span> <span class="token function">mount</span> <span class="token parameter variable">-a</span> <span class="token string">"path=/mnt/data src=/dev/sd0 fstype=ext4 ots=ro state=present"</span>
 
<span class="token comment">#仅将挂载的配置写入/etc/fstab，并不会执行挂载操作</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible <span class="token builtin class-name">test</span> <span class="token parameter variable">-m</span> <span class="token function">mount</span> <span class="token parameter variable">-a</span> <span class="token string">"src=172.16.60.220:/data path=/data fstype=nfs opts=defaults state=present"</span>
 
<span class="token comment">#临时挂载设备，并将挂载信息写入/etc/fstab</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible <span class="token builtin class-name">test</span> <span class="token parameter variable">-m</span> <span class="token function">mount</span> <span class="token parameter variable">-a</span> <span class="token string">"src=172.16.60.220:/data path=/data fstype=nfs opts=defaults state=mounted"</span>
 
<span class="token comment">#临时卸载，不会清理/etc/fstab</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible <span class="token builtin class-name">test</span> <span class="token parameter variable">-m</span> <span class="token function">mount</span> <span class="token parameter variable">-a</span> <span class="token string">"src=172.16.60.220:/data path=/data fstype=nfs opts=defaults state=unmounted"</span>
 
<span class="token comment">#卸载，不仅临时卸载，同时会清理/etc/fstab</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible <span class="token builtin class-name">test</span> <span class="token parameter variable">-m</span> <span class="token function">mount</span> <span class="token parameter variable">-a</span> <span class="token string">"src=172.16.60.220:/data path=/data fstype=nfs opts=defaults state=absent"</span>

</code></pre> 
<h3><a id="517_wait_for_908"></a>5.17 wait_for模块</h3> 
<p>当你利用service 启动tomcat，或数据库后，他们真的启来了么？这个你是否想确认下？<br> wait_for模块就是干这个的。</p> 
<p><strong>选项</strong></p> 
<ul><li>connect_timeout<br> 连接的超时时间，默认是5秒。</li><li>delay<br> 开始轮询之前等待的秒数，默认是0。</li><li>exclude_hosts<br> 与state=drained一起使用。用于指定，在寻找活跃的TCP链接的时候，要忽略的主机或IP列表。</li><li>host<br> 要等待的 可解析的主机名 或 IP地址。<br> path<br> 在继续之前，文件系统上必须存在的文件的路径。</li><li>port<br> 要轮询的端口。</li><li>search_regex<br> 用于匹配文件或socket链接中的一个字符串。</li><li>state<br> 可以是present、started、stopped、absent、drained。<br> 当检查端口的时候，started会确保端口打开；stopped会确保端口关闭；drained会检查活跃的链接。<br> 当检查文件或搜索字符串的时候，present和started会确保文件或字符串存在。absent会确保文件不存在或被移除。<br> (Choices: present, started, stopped, absent, drained)[Default: started]</li><li>timeout<br> 等待的超时时间。默认是300秒。</li></ul> 
<p><strong>例子</strong></p> 
<pre><code class="prism language-powershell">wait_for: port:8000 delay=10
等待8000端口打开，每10秒检查一次。超时时间是300秒。

wait_for: host=0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0 port=8000 delay=10 state=drained
等待所有本地IP上的8000端口，关闭活跃连接。每10秒检查一次，超时时间是300秒。

wait_for: host=0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0 port=8000 state=drained exclude_hosts=10<span class="token punctuation">.</span>2<span class="token punctuation">.</span>1<span class="token punctuation">.</span>2<span class="token punctuation">,</span>10<span class="token punctuation">.</span>2<span class="token punctuation">.</span>1<span class="token punctuation">.</span>3
等待所有本地IP上的8000端口，关闭活跃的连接。忽略来自10<span class="token punctuation">.</span>2<span class="token punctuation">.</span>1<span class="token punctuation">.</span>2和10<span class="token punctuation">.</span>2<span class="token punctuation">.</span>1<span class="token punctuation">.</span>3上的连接。超时时间是300秒。

wait_for: path=<span class="token operator">/</span>tmp/foo
一直等到<span class="token operator">/</span>tmp/foo这个文件存在。

wait_for: path=<span class="token operator">/</span>tmp/foo search_regex=completed
一直等到字符串completed出现在文件<span class="token operator">/</span>tmp/foo中。

wait_for: path=<span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lock/file<span class="token punctuation">.</span>lock state=absent
一直等到lock文件被删除。

wait_for: path=<span class="token operator">/</span>proc/3466/status state=absent
一直等到进程结束，并且pid被销毁。

local_action: wait_for port=22 host=<span class="token string">"{<!-- -->{ ansible_ssh_host | default(inventory_hostname) }}"</span> search_regex=OpenSSH delay=10
等待22端口被打开，并且包含字符串OpenSSH。并且不确保inventory_hostname是可解析的。每10秒检查一次，超时时间是300秒。
</code></pre> 
<h2><a id="playbook_964"></a>六、playbook</h2> 
<p>  Playbooks是Ansible的配置，部署和编排语言。他们可以描述您希望在远程机器做哪些事。使用易读的YAML格式组织Playbook。</p> 
<p>  playbook是由一个或多个play组成的列表，play的主要功能在于将事先归并为一组的主机装扮成事先通过ansible中的task定义好的角色。从根本上来讲，所谓的task无非是调用ansible的一个module。将多个play组织在一个playbook中，即可以让它们联合起来按事先编排的机制完成某一任务</p> 
<h3><a id="61_playbook_969"></a>6.1 playbook核心元素</h3> 
<ul><li>Hosts 执行的远程主机列表</li><li>Tasks 任务集</li><li>Varniables 内置变量或自定义变量在playbook中调用</li><li>Templates 模板，即使用模板语法的文件，比如配置文件等</li><li>Handlers 和notity结合使用，由特定条件触发的操作，满足条件方才执行，否则不执行</li><li>tags 标签，指定某条任务执行，用于选择运行playbook中的部分代码。</li><li>remote_user：在远程主机以哪个用户身份执行；</li></ul> 
<h3><a id="62_playbook_979"></a>6.2 playbook基本语法</h3> 
<p>playbook使用yaml语法格式，后缀可以是yaml,也可以是yml。</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ <span class="token function">vim</span> test.yaml
---      <span class="token comment">#表示文档开始</span>
- hosts: <span class="token builtin class-name">test</span>       <span class="token comment"># "- "表示一个块序列的节点，注意：横杠后面有空格，可以写主机名，主机组名，多个使用逗号隔开</span>
  remote_user: root      <span class="token comment">#指定在进行远程操作时使用root用户进行操作</span>
  tasks:       <span class="token comment">#使用tasks关键字指明要进行操作的任务列表，之后的行都属于tasks键值对中的值。</span>
  - name: Ping  <span class="token comment">#每个任务都以"- "开头，每个任务都有自己的名字,任务名使用name关键字进行指定</span>
    ping:         <span class="token comment">#ansible模块</span>
  - name: <span class="token function">make</span> directory <span class="token builtin class-name">test</span>  <span class="token comment">#第二个任务使用file模块，使用file模块时，指定了path参数与state参数的值。</span>
    file:     <span class="token comment">#ansible模块</span>
       path: /data/test   <span class="token comment">#模块的参数</span>
       state: directory
	   
	   
	   
	   
---                             <span class="token comment">#标记文件的开始</span>
- hosts: webservers             <span class="token comment">#指定该playbook在哪个服务器上执行</span>
  vars:                         <span class="token comment">#表示下面是定义的变量，</span>
    http_port: <span class="token number">80</span>               <span class="token comment">#变量的形式，key: value，这里http_port是变量名，80是值</span>
    max_clients: <span class="token number">200</span>
  remote_user: root             <span class="token comment">#指定远程的用户名，这里缩进和vars保持了一致，说明变量的代码块已经结束。</span>
  tasks:                        <span class="token comment">#下面构成playbook的tasks，每个task都有 - name: 开始，name指定该任务的名称。</span>
  - name: ensure apache is at the latest version  <span class="token comment">#指定该任务的名称。</span>
    yum: <span class="token assign-left variable">pkg</span><span class="token operator">=</span>httpd <span class="token assign-left variable">state</span><span class="token operator">=</span>latest                   <span class="token comment">#yum说明要是用的模板名称，后面指定对应的参数，这两行结合起来就相当于一个shell命令。</span>

  - name: <span class="token function">write</span> the apache config <span class="token function">file</span>            <span class="token comment">#每个task之间可以使用空行来做区分。</span>
    template: <span class="token assign-left variable">src</span><span class="token operator">=</span>/srv/httpd.j2 <span class="token assign-left variable">dest</span><span class="token operator">=</span>/etc/httpd.conf

<span class="token comment">#需要说明的是缩进的意义和python中缩进的意义是一样，是来区分代码块的。</span>
</code></pre> 
<p>检测语法</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible-playbook  --syntax-check  /path/to/playbook.yaml
</code></pre> 
<p>测试运行</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible-playbook <span class="token parameter variable">-C</span> /path/to/playbook.yaml
</code></pre> 
<p>运行</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ansible-playbook  /path/to/playbook.yaml
</code></pre> 
<p>示例:Playbook 创建用户</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ vim sysuser<span class="token punctuation">.</span>yml
<span class="token operator">--</span><span class="token operator">-</span>
<span class="token operator">-</span> hosts: all
  remote_user: root

  tasks:
    <span class="token operator">-</span> name: create mysql user
      user: name=mysql system=yes uid=36
    <span class="token operator">-</span> name: create a <span class="token function">group</span>
      <span class="token function">group</span>: name=httpd system=yes
</code></pre> 
<p>Playbook示例 安装nginx服务</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ vim nginx<span class="token punctuation">.</span>yml
<span class="token operator">-</span> hosts: all
  remote_user: root

  tasks:
    <span class="token operator">-</span> name: add <span class="token function">group</span> nginx
      user: name=nginx state=present
    <span class="token operator">-</span> name: add user nginx
      user: name=nginx state=present <span class="token function">group</span>=nginx
    <span class="token operator">-</span> name: Install Nginx
      yum: name=nginx state=present
    <span class="token operator">-</span> name: <span class="token function">Start</span> Nginx
      service: name=nginx state=started enabled=yes
</code></pre> 
<h3><a id="tags__1059"></a>tags: 添加标签</h3> 
<p>可以指定某一个任务添加一个标签,添加标签以后,想执行某个动作可以做出挑选来执行<br> 多个动作可以使用同一个标签</p> 
<p><strong>示例：httpd.yml</strong></p> 
<pre><code class="prism language-powershell"><span class="token operator">-</span> hosts: websrvs
  remote_user: root
  
  tasks:
    <span class="token operator">-</span> name: Install httpd
      yum: name=httpd state=present
      tags: install 
    <span class="token operator">-</span> name: Install configure file
      <span class="token function">copy</span>: src=files/httpd<span class="token punctuation">.</span>conf dest=<span class="token operator">/</span>etc/httpd/conf/
      tags: conf
    <span class="token operator">-</span> name: <span class="token function">start</span> httpd service
      tags: service
      service: name=httpd state=started enabled=yes

ansible-playbook <span class="token operator">-</span>t install<span class="token punctuation">,</span>conf httpd<span class="token punctuation">.</span>yml   指定执行install<span class="token punctuation">,</span>conf 两个标签
</code></pre> 
<h3><a id="63_handlers_1085"></a>6.3 handlers</h3> 
<p><strong>handlers和notify结合使用触发条件</strong><br> Handlers 实际上就是一个触发器是task列表，这些task与前述的task并没有本质上的不同,用于当关注的资源发生变化时，才会采取一定的操作</p> 
<p><strong>Notify此action可用于在每个play的最后被触发，</strong><br> 这样可避免多次有改变发生时每次都执行指定的操作，仅在所有的变化发生完成后一次性地执行指定操作。<br> 在notify中列出的操作称为handler，也即notify中调用handler中定义的操作</p> 
<p>在系统中，我们修改了服务器的配置文件，这时候就需要重启操作服务，就可以使用到handlers。配合 notify使用</p> 
<pre><code class="prism language-shell">---
- hosts: control-node
  remote_user: root
  vars:
    - pkg: httpd
    - name: template configuration <span class="token function">file</span>
      template: <span class="token assign-left variable">src</span><span class="token operator">=</span>template.j2 <span class="token assign-left variable">dest</span><span class="token operator">=</span>/etc/foo.conf  <span class="token comment">#修改了配置文件然后依次启动memcached和apache服务。</span>
        notify:                               <span class="token comment">#使用notify来声明引用handlers。</span>
         - restart memcached
         - restart apache
    
  handlers:                               <span class="token comment">#下面定义了两个handlers</span>
    - name: restart memcached
      service:  <span class="token assign-left variable">name</span><span class="token operator">=</span>memcached <span class="token assign-left variable">state</span><span class="token operator">=</span>restarted
    - name: restart apache
      service: <span class="token assign-left variable">name</span><span class="token operator">=</span>apache <span class="token assign-left variable">state</span><span class="token operator">=</span>restarted
</code></pre> 
<p>在使用handlers的过程中，有以下几点需要注意：</p> 
<ol><li>handlers只有在其所在的任务被执行时，都会被运行；</li><li>handlers只会在Play的末尾运行一次；如果想在一个Playbook的中间运行handlers，则需要使用meta模块来实现，例如：- meta: flush_handlers。</li><li>如果一个Play在运行到调用handlers的语句之前失败了，那么这个handlers将不会被执行。我们可以使用mega模块的–force-handlers选项来强制执行handlers，即使在handlers所在Play中途运行失败也能执行。</li></ol> 
<h3><a id="64_register_when_1120"></a>6.4 register 和when</h3> 
<p><strong>register</strong> 用于注册一个变量，保存命令的结果(shell或command模块)，这个变量可以在后面的task、when语句或模板文件中使用</p> 
<pre><code class="prism language-powershell"><span class="token operator">-</span> shell: <span class="token operator">/</span>bin/<span class="token function">pwd</span>
  register: pwd_result
</code></pre> 
<pre><code>debug:
    #msg: "{<!-- -->{ pwd_result }}"   # 输出全部信息
    #msg: "{<!-- -->{ pwd_result.cmd }}"   # 引用方式一
    msg: "{<!-- -->{ pwd_result['stdout_lines'] }}"  # 引用方式二
</code></pre> 
<p><strong>when</strong> 相当于shell脚本里的if 判断，when语句就是用来实现这个功能的，它是一个jinja2的语法，但是不需要双大括号，用法很简单</p> 
<pre><code class="prism language-powershell"><span class="token operator">-</span> name: <span class="token function">echo</span> date  <span class="token comment">#执行了一个 date 命令，register 关键字将 date 命令的输出存储到 date_output 变量名</span>
  command: date 
  register: date_output 

 <span class="token operator">-</span> name: <span class="token function">echo</span> date_output   <span class="token comment">#用 when 对关键字对分析后的进行判断，如果匹配，则执行这个 task，不匹配就不执行</span>
   command: <span class="token function">echo</span> <span class="token string">"30"</span>
   when: date_output<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">[</span>2<span class="token punctuation">]</span> == <span class="token string">"30"</span>
</code></pre> 
<p>这里第 1 个 task 是执行了一个 date 命令，register 关键字将 date 命令的输出存储到 date_output 变量名。第 2 个 task 对输出进行分析，并使用 when 对关键字对分析后的进行判断，如果匹配，则执行这个 task，不匹配就不执行。这里要重点说下的，因为 register 获取到的输出内容都是字符串，而 ansible 又是 python 写的，你可以使用 python 字符串的方法对其做处理，比如本文中使用的 split，还可以使用 find 方法。</p> 
<p><strong>示例：</strong></p> 
<pre><code class="prism language-powershell">tasks:
  <span class="token operator">-</span> name: <span class="token string">"shutdown RedHat flavored systems"</span>
    shell: <span class="token operator">/</span>sbin/shutdown <span class="token operator">-</span>h now
    when: ansible_os_family == <span class="token string">"RedHat"</span>  <span class="token comment">#当系统属于红帽系列,执行shell模块</span>
</code></pre> 
<h3><a id="65__1160"></a>6.5 循环</h3> 
<p>标准循环关键字：”<strong>with_items</strong>”<br> 对迭代项的引用，固定变量名为"item”，使用with_item属性给定要迭代的元素</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ <span class="token function">cat</span> xh<span class="token punctuation">.</span>yml 
<span class="token operator">--</span><span class="token operator">-</span>
<span class="token operator">-</span> hosts: all
  gather_facts: no
  tasks:
    <span class="token operator">-</span> name: dispaly list
      debug: msg=<span class="token string">"{<!-- -->{item}}"</span>
      with_items:
        <span class="token operator">-</span> one
        <span class="token operator">-</span> two
        <span class="token operator">-</span> three
        <span class="token operator">-</span> four
 
<span class="token namespace">[root@localhost ~]</span>$ ansible-playbook <span class="token operator">-</span>i hosts xh<span class="token punctuation">.</span>yml 
 
PLAY <span class="token namespace">[all]</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
TASK <span class="token namespace">[dispaly xunhuan]</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
ok: <span class="token punctuation">[</span>192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>52<span class="token punctuation">.</span>129<span class="token punctuation">]</span> =&gt; <span class="token punctuation">(</span>item=one<span class="token punctuation">)</span> =&gt; <span class="token punctuation">{<!-- --></span>
    <span class="token string">"changed"</span>: false<span class="token punctuation">,</span> 
    <span class="token string">"item"</span>: <span class="token string">"one"</span><span class="token punctuation">,</span> 
    <span class="token string">"msg"</span>: <span class="token string">"one"</span>
<span class="token punctuation">}</span>
ok: <span class="token punctuation">[</span>192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>52<span class="token punctuation">.</span>129<span class="token punctuation">]</span> =&gt; <span class="token punctuation">(</span>item=two<span class="token punctuation">)</span> =&gt; <span class="token punctuation">{<!-- --></span>
    <span class="token string">"changed"</span>: false<span class="token punctuation">,</span> 
    <span class="token string">"item"</span>: <span class="token string">"two"</span><span class="token punctuation">,</span> 
    <span class="token string">"msg"</span>: <span class="token string">"two"</span>
<span class="token punctuation">}</span>
ok: <span class="token punctuation">[</span>192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>52<span class="token punctuation">.</span>129<span class="token punctuation">]</span> =&gt; <span class="token punctuation">(</span>item=three<span class="token punctuation">)</span> =&gt; <span class="token punctuation">{<!-- --></span>
    <span class="token string">"changed"</span>: false<span class="token punctuation">,</span> 
    <span class="token string">"item"</span>: <span class="token string">"three"</span><span class="token punctuation">,</span> 
    <span class="token string">"msg"</span>: <span class="token string">"three"</span>
<span class="token punctuation">}</span>
ok: <span class="token punctuation">[</span>192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>52<span class="token punctuation">.</span>129<span class="token punctuation">]</span> =&gt; <span class="token punctuation">(</span>item=four<span class="token punctuation">)</span> =&gt; <span class="token punctuation">{<!-- --></span>
    <span class="token string">"changed"</span>: false<span class="token punctuation">,</span> 
    <span class="token string">"item"</span>: <span class="token string">"four"</span><span class="token punctuation">,</span> 
    <span class="token string">"msg"</span>: <span class="token string">"four"</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>安装一堆软件包。</p> 
<pre><code class="prism language-powershell"><span class="token operator">--</span><span class="token operator">-</span>
    <span class="token operator">-</span> hosts: localhost
      tasks: 
        <span class="token operator">-</span> yum: name=<span class="token string">"{<!-- -->{item}}"</span> state=installed
          with_items: 
            <span class="token operator">-</span> pkg1
            <span class="token operator">-</span> pkg2
            <span class="token operator">-</span> pkg3
</code></pre> 
<p>它会一个一个迭代到特殊变量"{<!-- -->{item}}"处。</p> 
<p><code>loop</code>等价于with_list，从名字上可以知道它是遍历数组（列表）的，所以在loop指令中，每个元素都以列表的方式去定义。列表有多少个元素，就循环执行file模块多少次，每轮循环中，都会将本次迭代的列表元素保存在控制变量 item中。</p> 
<p>安装多个软件</p> 
<pre><code class="prism language-powershell">tasks:
  <span class="token operator">-</span> name: <span class="token string">"Install Packages"</span>
    yum: name=<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> item <span class="token punctuation">}</span><span class="token punctuation">}</span>  state=latest
    loop:
      <span class="token operator">-</span> httpd
      <span class="token operator">-</span> mysql-server
      <span class="token operator">-</span> php
</code></pre> 
<h3><a id="66_templates_1237"></a>6.6 模板templates</h3> 
<p>Jinja2语言，使用字面量，有下面形式<br> 字符串：使用单引号或双引号<br> 数字：整数，浮点数<br> 列表：[item1, item2, …]<br> 元组：(item1, item2, …)<br> 字典：{key1:value1, key2:value2, …}<br> 布尔型：true/false<br> 算术运算：+, -, *, /, //, %, **<br> 比较操作：==, !=, &gt;, &gt;=, &lt;, &lt;=<br> 逻辑运算：and，or，not<br> 流表达式：For，If，When</p> 
<h4><a id="661_template__1251"></a>6.6.1 template 的使用</h4> 
<p>templates是ansible的一个模块，其功能是根据模板文件动态生成配置文件，templates文件必须存放于templates目录下，且命名为".j2"结尾，yaml/yml文件需要和templates目录平级，这样我们在yml文件中调用模板的时候，就不需要写模板文件的路径，否则需要描述模板文件的路径，因为template模块会自动去找templates目录下的模板文件</p> 
<p>./<br> ├── temnginx.yml<br> └── templates<br> └── nginx.conf.j2</p> 
<h4><a id="662_template_1260"></a>6.6.2 template示例</h4> 
<p>示例：利用template 同步nginx配置文件<br> 准备templates/nginx.conf.j2文件</p> 
<pre><code class="prism language-powershell">vim temnginx<span class="token punctuation">.</span>yml
<span class="token operator">-</span> hosts: websrvs
  remote_user: root
  
  tasks:
    <span class="token operator">-</span> name: template config to remote hosts
      template: src=nginx<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>j2 dest=<span class="token operator">/</span>etc/nginx/nginx<span class="token punctuation">.</span>conf

ansible-playbook temnginx<span class="token punctuation">.</span>yml
</code></pre> 
<p>for循环使用</p> 
<pre><code class="prism language-powershell"><span class="token punctuation">{<!-- --></span><span class="token operator">%</span> <span class="token keyword">for</span> vhost in nginx_vhosts <span class="token operator">%</span><span class="token punctuation">}</span>
server <span class="token punctuation">{<!-- --></span>
listen <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> vhost<span class="token punctuation">.</span>listen <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token operator">%</span> endfor <span class="token operator">%</span><span class="token punctuation">}</span>
</code></pre> 
<p>if单分支选择使用</p> 
<pre><code class="prism language-powershell"><span class="token punctuation">{<!-- --></span><span class="token operator">%</span> <span class="token keyword">if</span> vhost<span class="token punctuation">.</span>server_name is defined <span class="token operator">%</span><span class="token punctuation">}</span>
    server_name <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> vhost<span class="token punctuation">.</span>server_name <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token operator">%</span> endif <span class="token operator">%</span><span class="token punctuation">}</span>
</code></pre> 
<p>if多分支选择使用</p> 
<pre><code class="prism language-powershell"><span class="token punctuation">{<!-- --></span><span class="token operator">%</span><span class="token keyword">if</span> vhost<span class="token punctuation">.</span>port is undefined <span class="token operator">%</span><span class="token punctuation">}</span>
    http_port=80
<span class="token punctuation">{<!-- --></span><span class="token operator">%</span>elif vhost<span class="token punctuation">.</span>port == 81%<span class="token punctuation">}</span>
    http_port=81
<span class="token punctuation">{<!-- --></span><span class="token operator">%</span><span class="token keyword">else</span><span class="token operator">%</span><span class="token punctuation">}</span>
    http_port = 83
<span class="token punctuation">{<!-- --></span><span class="token operator">%</span>endif%<span class="token punctuation">}</span>
</code></pre> 
<p>单行注释</p> 
<pre><code class="prism language-powershell"><span class="token punctuation">{<!-- --></span><span class="token comment">#% for i in list %#}</span>
</code></pre> 
<h3><a id="67_roles_1312"></a>6.7 roles</h3> 
<h4><a id="671_Roles_1314"></a>6.7.1 Roles介绍</h4> 
<p>ansible自1.2版本引入的新特性，用于层次性、结构化地组织playbook。roles能够根据层次型结构自动装载变量文件、tasks以及handlers等。要使用roles只需要在playbook中使用include指令引入即可。简单来讲，roles就是通过分别将变量、文件、任务、模板及处理器放置于单独的目录中，并可以便捷的include它们的一种机制。角色一般用于基于主机构建服务的场景中，但也可以是用于构建守护进程等场景中。主要使用场景代码复用度较高的情况下。</p> 
<h4><a id="672_Roles_1317"></a>6.7.2 Roles目录结构</h4> 
<p><img src="https://images2.imgbox.com/e6/86/DmjKfOvi_o.png" alt="在这里插入图片描述"></p> 
<p><strong>各目录含义解释</strong></p> 
<pre><code class="prism language-powershell">roles:          &lt;<span class="token operator">--</span>所有的角色必须放在roles目录下，这个目录可以自定义位置，默认的位置在<span class="token operator">/</span>etc/ansible/roles
  project:      &lt;<span class="token operator">--</span><span class="token operator">-</span>具体的角色项目名称，比如nginx、tomcat、php
    files：     &lt;<span class="token operator">--</span>用来存放由<span class="token function">copy</span>模块或script模块调用的文件。
    templates： &lt;<span class="token operator">--</span>用来存放jinjia2模板，template模块会自动在此目录中寻找jinjia2模板文件。
    tasks：     &lt;<span class="token operator">--</span>此目录应当包含一个main<span class="token punctuation">.</span>yml文件，用于定义此角色的任务列表，此文件可以使用include包含其它的位于此目录的task文件。
      main<span class="token punctuation">.</span>yml
    handlers：  &lt;<span class="token operator">--</span>此目录应当包含一个main<span class="token punctuation">.</span>yml文件，用于定义此角色中触发条件时执行的动作。
      main<span class="token punctuation">.</span>yml
    vars：      &lt;<span class="token operator">--</span>此目录应当包含一个main<span class="token punctuation">.</span>yml文件，用于定义此角色用到的变量。
      main<span class="token punctuation">.</span>yml
    defaults：  &lt;<span class="token operator">--</span>此目录应当包含一个main<span class="token punctuation">.</span>yml文件，用于为当前角色设定默认变量。
      main<span class="token punctuation">.</span>yml
    meta：      &lt;<span class="token operator">--</span>此目录应当包含一个main<span class="token punctuation">.</span>yml文件，用于定义此角色的特殊设定及其依赖关系。
      main<span class="token punctuation">.</span>yml




roles/example_role/files/             所有文件，都将可存放在这里
roles/example_role/templates/         所有模板都存放在这里
roles/example_role/tasks/main<span class="token punctuation">.</span>yml：   主函数，包括在其中的所有任务将被执行
roles/example_role/handlers/main<span class="token punctuation">.</span>yml：所有包括其中的 handlers 将被执行
roles/example_role/vars/main<span class="token punctuation">.</span>yml：    所有包括在其中的变量将在roles中生效
roles/example_role/meta/main<span class="token punctuation">.</span>yml：    roles所有依赖将被正常登入
</code></pre> 
<h4><a id="673_Roles_1348"></a>6.7.3 Roles示例</h4> 
<p>通过ansible roles安装配置httpd服务，此处的roles使用默认的路径<code>/etc/ansible/roles</code></p> 
<pre><code class="prism language-powershell"><span class="token comment">#在ansible目录下面，建立roles目录</span>
<span class="token comment">#修改配置文件，使系统能够读取roles目录</span>
<span class="token namespace">[root@ansible ~]</span>$ <span class="token function">cat</span> <span class="token operator">/</span>etc/ansible/ansible<span class="token punctuation">.</span>cfg <span class="token punctuation">|</span> grep roles
<span class="token comment"># additional paths to search for roles in, colon separated</span>
<span class="token comment">#roles_path    = /etc/ansible/roles  #roles默认路径</span>
<span class="token comment"># by default, variables from roles will be visible in the global variable</span>
</code></pre> 
<p>创建role的步骤<br> (1) 创建以roles命名的目录<br> (2) 在roles目录中分别创建以各角色名称命名的目录，如webservers等<br> (3) 在每个角色命名的目录中分别创建files、handlers、meta、tasks、templates和vars目录；<br> 用不到的目录可以创建为空目录，也可以不创建<br> (4) 在playbook文件中，调用各角色</p> 
<pre><code class="prism language-powershell">实验: 创建httpd角色
1&gt; 创建roles目录
   mkdir roles/<span class="token punctuation">{<!-- --></span>httpd<span class="token punctuation">,</span>mysql<span class="token punctuation">,</span>redis<span class="token punctuation">}</span><span class="token operator">/</span>tasks <span class="token operator">-</span>pv
   mkdir  roles/httpd/<span class="token punctuation">{<!-- --></span>handlers<span class="token punctuation">,</span>files<span class="token punctuation">}</span>
查看目录结构
tree roles/
    roles/
    ├── httpd
    │   ├── files
    │   ├── handlers
    │   └── tasks
    ├── mysql
    │   └── tasks
    └── redis
        └── tasks
2&gt; 创建目标文件
   cd roles/httpd/tasks/
   touch install<span class="token punctuation">.</span>yml config<span class="token punctuation">.</span>yml service<span class="token punctuation">.</span>yml
3&gt; vim install<span class="token punctuation">.</span>yml
   <span class="token operator">-</span> name: install httpd package
     yum: name=httpd
     
   vim config<span class="token punctuation">.</span>yml
   <span class="token operator">-</span> name: config file  
     <span class="token function">copy</span>: src=httpd<span class="token punctuation">.</span>conf dest=<span class="token operator">/</span>etc/httpd/conf/ backup=yes 
   
   vim service<span class="token punctuation">.</span>yml
   <span class="token operator">-</span> name: <span class="token function">start</span> service 
     service: name=httpd state=started enabled=yes
     
4&gt; 创建main<span class="token punctuation">.</span>yml主控文件<span class="token punctuation">,</span>调用以上单独的yml文件<span class="token punctuation">,</span>
   main<span class="token punctuation">.</span>yml定义了谁先执行谁后执行的顺序
   vim main<span class="token punctuation">.</span>yml
   <span class="token operator">-</span> include: install<span class="token punctuation">.</span>yml
   <span class="token operator">-</span> include: config<span class="token punctuation">.</span>yml
   <span class="token operator">-</span> include: service<span class="token punctuation">.</span>yml
   
5&gt; 准备httpd<span class="token punctuation">.</span>conf文件<span class="token punctuation">,</span>放到httpd单独的文件目录下
   <span class="token function">cp</span> <span class="token operator">/</span>app/ansible/flies/httpd<span class="token punctuation">.</span>conf <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span>files/
   
6&gt; 创建一个网页
   vim flies/index<span class="token punctuation">.</span>html
   &lt;h1&gt; welcome to weixiaodong home &lt;\h1&gt;
7&gt; 创建网页的yml文件
   vim tasks/index<span class="token punctuation">.</span>yml
   <span class="token operator">-</span> name: index<span class="token punctuation">.</span>html
     <span class="token function">copy</span>: src=index<span class="token punctuation">.</span>html dest=<span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>www/html 
8&gt; 将网页的yml文件写进mian<span class="token punctuation">.</span>yml文件中
   vim mian<span class="token punctuation">.</span>yml
   <span class="token operator">-</span> include: install<span class="token punctuation">.</span>yml
   <span class="token operator">-</span> include: config<span class="token punctuation">.</span>yml
   <span class="token operator">-</span> include: index<span class="token punctuation">.</span>yml
   <span class="token operator">-</span> include: service<span class="token punctuation">.</span>yml
9&gt; 在handlers目录下创建handler文件mian<span class="token punctuation">.</span>yml
   vim handlers/main<span class="token punctuation">.</span>yml
   <span class="token operator">-</span> name: restart service httpd
     service: name=httpd state=restarted
10&gt; 创建文件调用httpd角色
    cd <span class="token operator">/</span>app/ansidle/roles
    vim role_httpd<span class="token punctuation">.</span>yml
    <span class="token operator">--</span><span class="token operator">-</span>
    <span class="token comment"># httpd role</span>
    <span class="token operator">-</span> hosts: appsrvs
      remote_user: root 
      roles:       <span class="token comment">#调用角色</span>
        <span class="token operator">-</span> role: httpd  
        
11&gt; 查看目录结构
    tree 
    <span class="token punctuation">.</span>
    httpd
    ├── files
    │   ├── httpd<span class="token punctuation">.</span>conf
    │   └── index<span class="token punctuation">.</span>html
    ├── handlers
    │   └── main<span class="token punctuation">.</span>yml
    └── tasks
        ├── config<span class="token punctuation">.</span>yml
        ├── index<span class="token punctuation">.</span>yml
        ├── install<span class="token punctuation">.</span>yml
        ├── main<span class="token punctuation">.</span>yml
        └── service<span class="token punctuation">.</span>yml
12&gt; ansible-playbook role_httpd<span class="token punctuation">.</span>yml
</code></pre> 
<p><strong>1）创建目录</strong></p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@ansible ~]</span>$ cd <span class="token operator">/</span>etc/ansible/roles/
<span class="token comment"># 创建需要用到的目录</span>
<span class="token namespace">[root@ansible roles]</span>$ mkdir <span class="token operator">-</span>p httpd/<span class="token punctuation">{<!-- --></span>handlers<span class="token punctuation">,</span>tasks<span class="token punctuation">,</span>templates<span class="token punctuation">,</span>vars<span class="token punctuation">}</span>
<span class="token namespace">[root@ansible roles]</span>$ cd httpd/
<span class="token namespace">[root@ansible httpd]</span>$ tree <span class="token punctuation">.</span>
<span class="token punctuation">.</span>
├── handlers
├── tasks
├── templates
└── vars

4 directories<span class="token punctuation">,</span> 0 file
</code></pre> 
<p><strong>2）变量文件准备vars/main.yml</strong></p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@ansible httpd]</span>$ vim vars/main<span class="token punctuation">.</span>yml
PORT: 8088        <span class="token comment">#指定httpd监听的端口</span>
USERNAME: www     <span class="token comment">#指定httpd运行用户</span>
GROUPNAME: www    <span class="token comment">#指定httpd运行组</span>
</code></pre> 
<p><strong>3）配置文件模板准备templates/httpd.conf.j2</strong></p> 
<pre><code class="prism language-powershell"><span class="token comment"># copy一个本地的配置文件放在templates/下并已j2为后缀</span>
<span class="token namespace">[root@ansible httpd]</span>$ <span class="token function">cp</span> <span class="token operator">/</span>etc/httpd/conf/httpd<span class="token punctuation">.</span>conf templates/httpd<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>j2

<span class="token comment"># 进行一些修改，调用上面定义的变量</span>
<span class="token namespace">[root@ansible httpd]</span>$ vim templates/httpd<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>j2
Listen <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> PORT <span class="token punctuation">}</span><span class="token punctuation">}</span> 
User <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> USERNAME <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token function">Group</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> GROUPNAME <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> 
<p><strong>4）任务剧本编写，创建用户、创建组、安装软件、配置、启动等</strong></p> 
<pre><code class="prism language-powershell"><span class="token comment"># 创建组的task</span>
<span class="token namespace">[root@ansible httpd]</span>$ vim tasks/<span class="token function">group</span><span class="token punctuation">.</span>yml
<span class="token operator">-</span> name: Create a Startup <span class="token function">Group</span>
  <span class="token function">group</span>: name=www gid=60 system=yes

<span class="token comment"># 创建用户的task</span>
<span class="token namespace">[root@ansible httpd]</span>$ vim tasks/user<span class="token punctuation">.</span>yml
<span class="token operator">-</span> name: Create Startup Users
  user: name=www uid=60 system=yes shell=<span class="token operator">/</span>sbin/nologin

<span class="token comment"># 安装软件的task</span>
<span class="token namespace">[root@ansible httpd]</span>$ vim tasks/install<span class="token punctuation">.</span>yml
<span class="token operator">-</span> name: Install Package Httpd
  yum: name=httpd state=installed

<span class="token comment"># 配置软件的task</span>
<span class="token namespace">[root@ansible httpd]</span>$ vim tasks/config<span class="token punctuation">.</span>yml
<span class="token operator">-</span> name: <span class="token function">Copy</span> Httpd Template File
  template: src=httpd<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>j2 dest=<span class="token operator">/</span>etc/httpd/conf/httpd<span class="token punctuation">.</span>conf
  notify: Restart Httpd

<span class="token comment"># 启动软件的task</span>
<span class="token namespace">[root@ansible httpd]</span>$ vim tasks/<span class="token function">start</span><span class="token punctuation">.</span>yml
<span class="token operator">-</span> name: <span class="token function">Start</span> Httpd Service
  service: name=httpd state=started enabled=yes

<span class="token comment"># 编写main.yml，将上面的这些task引入进来</span>
<span class="token namespace">[root@ansible httpd]</span>$ vim tasks/main<span class="token punctuation">.</span>yml
<span class="token operator">-</span> include: <span class="token function">group</span><span class="token punctuation">.</span>yml
<span class="token operator">-</span> include: user<span class="token punctuation">.</span>yml
<span class="token operator">-</span> include: install<span class="token punctuation">.</span>yml
<span class="token operator">-</span> include: config<span class="token punctuation">.</span>yml
<span class="token operator">-</span> include: <span class="token function">start</span><span class="token punctuation">.</span>ym
</code></pre> 
<p><strong>5）编写重启httpd的handlers，handlers/main.yml</strong></p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@ansible httpd]</span>$ vim handlers/main<span class="token punctuation">.</span>yml
<span class="token comment"># 这里的名字需要和task中的notify保持一致</span>
<span class="token operator">-</span> name: Restart Httpd
  service: name=httpd state=restarted
</code></pre> 
<p><strong>6）编写主的httpd_roles.yml文件调用httpd角色</strong></p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@ansible httpd]</span>$ cd <span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token namespace">[root@ansible roles]</span>$ vim httpd_roles<span class="token punctuation">.</span>yml
<span class="token operator">--</span><span class="token operator">-</span>
<span class="token operator">-</span> hosts: all
  remote_user: root
  roles:
    <span class="token operator">-</span> role: httpd        <span class="token comment">#指定角色名称</span>
</code></pre> 
<p><strong>7）整体的一个目录结构查看</strong></p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@ansible roles]</span>$ tree <span class="token punctuation">.</span>
<span class="token punctuation">.</span>
├── httpd
│   ├── handlers
│   │   └── main<span class="token punctuation">.</span>yml
│   ├── tasks
│   │   ├── config<span class="token punctuation">.</span>yml
│   │   ├── <span class="token function">group</span><span class="token punctuation">.</span>yml
│   │   ├── install<span class="token punctuation">.</span>yml
│   │   ├── main<span class="token punctuation">.</span>yml
│   │   ├── <span class="token function">start</span><span class="token punctuation">.</span>yml
│   │   └── user<span class="token punctuation">.</span>yml
│   ├── templates
│   │   └── httpd<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>j2
│   └── vars
│       └── main<span class="token punctuation">.</span>yml
└── httpd_roles<span class="token punctuation">.</span>yml

5 directories<span class="token punctuation">,</span> 10 files
</code></pre> 
<p><strong>8）测试playbook语法是否正确</strong></p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@ansible roles]</span>$ ansible-playbook <span class="token operator">-</span>C httpd_roles<span class="token punctuation">.</span>ym
</code></pre> 
<p><strong>9）上面的测试没有问题，正式执行playbook</strong></p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@ansible roles]</span>$ ansible-playbook httpd_roles<span class="token punctuation">.</span>ym
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4a0e3f69b76387f1cd01fcbff3369ba2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【Kotlin精简】第9章 Kotlin Flow</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6fd276af14d1dbdd4862a08f312c9afe/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">搭建Gateway网关并加入Token鉴权逻辑</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>