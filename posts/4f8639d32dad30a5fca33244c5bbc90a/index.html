<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>高可用_keepalived &#43; haproxy - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="高可用_keepalived &#43; haproxy" />
<meta property="og:description" content="准备： 登录腾讯云申请HAVIP 私有网络 高可用虚拟 IP 概述 - 操作指南 - 文档中心 - 腾讯云 申请通过后，刷新页面，选择 云产品 -&gt; 网络 -&gt; 私有网络 -&gt; IP与网卡 -&gt; 高可用虚拟IP
新建vip，选择自己的私有网络。此时通过自己的vpc无法访问vip(vip未绑定到自己的vpc上)，
通过keepalive配置好vip后其它vpc才能ping 通vip。注意vip申请后如果不绑定eip会默认绑定到一台服务器上，并且会扣费的，购买一个eip然后绑定到vip上就可以通过外网访问高可用环境了。 1. 主机规划 节点主机名内网ip主节点1k8s-master01172.17.0.8主节点2k8s-master02172.17.0.9HAVIPwww.k8s.com172.17.0.250（腾讯云申请-免费）EIPwww.k8s.com110.xx.xxx.2x9 (腾讯云公网ip-购买) 主节点1和主节点2都需要部署keepalived和haproxy。下面配置为主节点1的配置。
主节点2的keepalived配置基本同主节点1，需要修改的地方参考配置中的注释。主节点2的haproxy配置同主节点1的配置
2. 部署keepalived 安装keepalived yum install -y keepalived 配置keepalived vim /etc/keepalived/keepalived.conf 内容如下: ! Configuration File for keepalived global_defs { notification_email { wangfenlei@sina.cn } notification_email_from keepalived@ptmind.com smtp_server 127.0.0.1 smtp_connect_timeout 30 router_id k8s-master01 # 主节点2改为 k8s-master02 } vrrp_script check_apiserver { # script &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/4f8639d32dad30a5fca33244c5bbc90a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-03-25T16:17:14+08:00" />
<meta property="article:modified_time" content="2021-03-25T16:17:14+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">高可用_keepalived &#43; haproxy</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h3>准备：</h3> 
<ul><li> <p>登录腾讯云申请HAVIP <a href="https://cloud.tencent.com/document/product/215/36691" rel="nofollow" title="私有网络 高可用虚拟 IP 概述 - 操作指南 - 文档中心 - 腾讯云">私有网络 高可用虚拟 IP 概述 - 操作指南 - 文档中心 - 腾讯云</a> </p> </li><li>申请通过后，刷新页面，选择 云产品 -&gt; 网络 -&gt; 私有网络 -&gt; IP与网卡 -&gt; 高可用虚拟IP<br> 新建vip，选择自己的私有网络。此时通过自己的vpc无法访问vip(vip未绑定到自己的vpc上)，<br> 通过keepalive配置好vip后其它vpc才能ping 通vip。</li><li><strong>注意vip申请后如果不绑定eip会默认绑定到一台服务器上，并且会扣费的，购买一个eip然后绑定到vip上就可以通过外网访问高可用环境了。</strong></li></ul> 
<h4>1. 主机规划</h4> 
<table align="left" border="1" cellpadding="1" cellspacing="1" style="width:500px;"><tbody><tr><td>节点</td><td>主机名</td><td>内网ip</td></tr><tr><td>主节点1</td><td>k8s-master01</td><td>172.17.0.8</td></tr><tr><td>主节点2</td><td>k8s-master02</td><td>172.17.0.9</td></tr><tr><td>HAVIP</td><td>www.k8s.com</td><td>172.17.0.250（腾讯云申请-免费）</td></tr><tr><td>EIP</td><td>www.k8s.com</td><td>110.xx.xxx.2x9 (腾讯云公网ip-购买)</td></tr></tbody></table> 
<p></p> 
<p></p> 
<p></p> 
<p> </p> 
<p></p> 
<p></p> 
<p>主节点1和主节点2都需要部署keepalived和haproxy。下面配置为主节点1的配置。<br> 主节点2的keepalived配置基本同主节点1，需要修改的地方参考配置中的注释。主节点2的haproxy配置同主节点1的配置</p> 
<h4>2. 部署keepalived</h4> 
<ul><li>安装keepalived <pre><code class="language-bash">yum install -y keepalived</code></pre> <p></p> </li><li>配置keepalived <pre><code class="language-bash">vim /etc/keepalived/keepalived.conf 内容如下:

! Configuration File for keepalived

global_defs {
   notification_email {
     wangfenlei@sina.cn
   }
   notification_email_from keepalived@ptmind.com
   smtp_server 127.0.0.1
   smtp_connect_timeout 30
   router_id k8s-master01 # 主节点2改为 k8s-master02
}

vrrp_script check_apiserver {
   # script "/cron-sh.d/check_apiserver.sh" # script可以指定要执行的shell脚本。
   script "killall -0 haproxy" # 检测ha是否存在。
   interval 5
   weight -20
   fall 3
   rise 1
}

vrrp_instance VI_1 {
    state MASTER       # 主节点2改为 BACKUP
    interface eth0
    virtual_router_id 1
    priority 101 # 主节点2改为 99
    advert_int 1
    unicast_src_ip 172.17.0.8 #当前节点的内网ip  主节点2改为 172.17.0.9
    unicast_peer {
        172.17.0.9 # 主节点2的内网ip  主节点2改为 172.17.0.8
        #x.x.x.x  主节点3的内网ip  如果有多个主节点可以继续添加
    }
    authentication {
        auth_type PASS
        auth_pass 1111
    }

    track_script {
        check_apiserver
    }

    virtual_ipaddress {
        172.17.0.250           # 腾讯云申请vip
    }
}

# 脚本demo. vrrp_script 中用
vim /cron-sh.d/check_apiserver.sh 内容如下

#!/bin/bash

#exit 1

if [ $(ps -C haproxy --no-header | wc -l) -eq 0 ]; then
        systemctl start haproxy
fi

sleep 3
if [ $(ps -C haproxy --no-header | wc -l) -eq 0 ]; then
        systemctl stop keepalived
fi</code></pre> <p></p> </li><li>配置keepalived日志输出路径 <pre><code class="language-bash"># keepalived日志路径配置 (local0中的0 对应-S 后面的0)
1. vim /etc/sysconfig/keepalived
    KEEPALIVED_OPTIONS="-D -d -S 0" (修改)

2. vim /etc/rsyslog.conf
    local0.*                                      /var/log/keepalived.log (文件末添加)</code></pre> <p></p> </li></ul> 
<h4>3. 部署haproxy</h4> 
<ul><li>安装haproxy <pre><code class="language-bash">yum install -y haproxy</code></pre> <p></p> </li><li>配置haproxy <pre><code>vim /etc/haproxy/haproxy.cfg 内容如下：

# Global settings
global
    # 2) configure local2 events to go to the /var/log/haproxy.log
    #    local2.*                       /var/log/haproxy.log
    #
    log         127.0.0.1 local2

    chroot      /var/lib/haproxy
    pidfile     /var/run/haproxy.pid
    maxconn     4000
    user        haproxy
    group       haproxy
    daemon

    spread-checks 3
    nbproc        1  # 默认是1,可以不配。


    # turn on stats unix socket
    stats socket /var/lib/haproxy/stats

# defaults setting 其他配置会继承默认配置,默认配置里的配置项也可以在其它配置里被重写
defaults
    log                     global
    option                  dontlognull
    option                  redispatch
    retries                 3
    timeout http-request    10s
    timeout queue           1m
    timeout connect         10s
    timeout client          1m
    timeout server          1m
    timeout http-keep-alive 10s
    timeout check           10s
    maxconn                 3000
# ui 这里bind用* 没问题(外网ip+端口可以直接访问监控页面)。用0.0.0.0页面访问不了
listen stats
    bind      *:8444
    stats     enable
    mode      http
    maxconn   10
    stats     refresh 30s
    stats     uri /
    stats     hide-version
    stats     realm HAproxy
    stats     auth admin:admin
    stats     admin if TRUE

#---------------------------------------------------------------------
# kubernetes apiserver frontend which proxys to the backends
#---------------------------------------------------------------------
frontend kubernetes-apiserver
    mode                 tcp
    bind                 *:8443
    option               tcplog
    default_backend      kubernetes-apiserver

#---------------------------------------------------------------------
# round robin balancing between the various backends
#---------------------------------------------------------------------
backend kubernetes-apiserver
    mode        tcp
    balance     roundrobin
    server  k8s-master01 172.17.0.8:6443 check
    server  k8s-master02 172.17.0.9:6443 check

# listen
#listen ha-apache-server
#    bind    *:81
#    mode    tcp
#    balance     roundrobin
#    server k8s-master01 172.17.0.8:81 check port 81 inter 5000 rise 1 fall 3
#    server k8s-master02 172.17.0.9:81 check port 81 inter 5000 rise 1 fall 3
</code></pre> <p></p> </li><li>配置haproxy日志输出路径 <pre><code class="language-bash"># haproxy日志路径配置 (local2中的2 与 /etc/haproxy/haproxy.cfg 中log配置的local2对应)
1. vim /etc/rsyslog.conf 
    $ModLoad imudp       (修改)
    $UDPServerRun 514    (修改) 
    local2.*                                       /var/log/haproxy.log (文件末添加)</code></pre> <p></p> </li></ul> 
<h4>4. 排查网络问题相关命令<br>  </h4> 
<pre><code class="language-bash"># 1. tcp 抓取vip数据包 keepalived 的vip绑在eth0网卡上的
tcpdump -i eth0 vrrp -n

# 2. 查看vip绑定
ip addr show dev eth0

# 3. 列举所有vip 
ipvsadm -ln

# 4. 列举所有vip连接
ipvsadm -Lnc

# 5. 查看所有的处于监听状态的tcp连接并且显示pid和对应应用名称
netstat -nltp

</code></pre> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f29fc7f9bc713d622961e7a5d1125f92/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">LDP会话建立过程</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2da0a006bdadedd1aa4caca2f7625166/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Intellij IDEA如何生成JavaDoc</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>