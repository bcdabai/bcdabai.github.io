<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>手把手教你用 NebulaGraph AI 全家桶跑图算法 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="手把手教你用 NebulaGraph AI 全家桶跑图算法" />
<meta property="og:description" content="前段时间 NebulaGraph 3.5.0 发布，@whitewum 吴老师建议我把前段时间 NebulaGraph 社区里开启的新项目 ng_ai 公开给大家。
所以，就有了这个系列文章，本文是该系列的开篇之作。
ng_ai 是什么 ng_ai 的全名是：Nebulagraph AI Suite，顾名思义，它是在 NebulaGraph 之上跑算法的 Python 套件，希望能给 NebulaGraph 的用户一个自然、简洁的高级 API。简单来说，用很少的代码量就可以执行图上的算法相关的任务。
ng_ai 这个开源项目的目标是，快速迭代、公开讨论、持续演进，一句话概述便是：
Simplifying things in surprising ways.
这个 ng_ai 的专属 url：https://github.com/wey-gu/nebulagraph-ai 可以帮你了解更全面的它。
ng_ai 的特点 为了让 NebulaGraph 社区的小伙伴拥有顺滑的算法体验，ng_ai 有以下特点：
与 NebulaGraph 紧密结合，方便从其中读、写图数据支持多引擎、后端，目前支持 Spark（NebulaGraph Algorithm）、NetworkX，之后会支持 DGL、PyG友好、符合直觉的 API 设计与 NebulaGraph 的 UDF 无缝结合，支持从 Query 中调用 ng_ai 任务友好的自定义算法接口，方便用户自己实现算法（尚未完成）一键试玩环境（基于 Docker Extensions） 你可以这么用 ng_ai 跑分布式 PageRank 算法 可以在一个大图上，基于 nebula-algorithm 分布式地跑 PageRank 算法，像是这样：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/b429bf225a2f013180a4cc8cf9b6e469/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-12T12:18:43+08:00" />
<meta property="article:modified_time" content="2023-07-12T12:18:43+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">手把手教你用 NebulaGraph AI 全家桶跑图算法</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><img src="https://images2.imgbox.com/bd/f2/QsixqMrI_o.jpg" alt=""></p> 
<p>前段时间 <a href="https://docs.nebula-graph.com.cn/3.5.0/20.appendix/release-notes/nebula-comm-release-note/" rel="nofollow">NebulaGraph 3.5.0 发布</a>，@<strong><a href="https://github.com/whitewum">whitewum</a></strong> 吴老师建议我把前段时间 NebulaGraph 社区里开启的新项目 <a href="https://github.com/wey-gu/nebulagraph-ai">ng_ai</a> 公开给大家。</p> 
<p>所以，就有了这个系列文章，本文是该系列的开篇之作。</p> 
<h3><a id="ng_ai__6"></a>ng_ai 是什么</h3> 
<p>ng_ai 的全名是：Nebulagraph AI Suite，顾名思义，它是在 NebulaGraph 之上跑算法的 Python 套件，希望能给 NebulaGraph 的用户一个自然、简洁的高级 API。简单来说，用很少的代码量就可以执行图上的算法相关的任务。</p> 
<p>ng_ai 这个开源项目的目标是，快速迭代、公开讨论、持续演进，一句话概述便是：</p> 
<blockquote> 
 <p>Simplifying things in surprising ways.</p> 
</blockquote> 
<p>这个 ng_ai 的专属 url：<a href="https://github.com/wey-gu/nebulagraph-ai">https://github.com/wey-gu/nebulagraph-ai</a> 可以帮你了解更全面的它。</p> 
<h3><a id="ng_ai__16"></a>ng_ai 的特点</h3> 
<p>为了让 NebulaGraph 社区的小伙伴拥有顺滑的算法体验，ng_ai 有以下特点：</p> 
<ul><li>与 NebulaGraph 紧密结合，方便从其中读、写图数据</li><li>支持多引擎、后端，目前支持 Spark（NebulaGraph Algorithm）、NetworkX，之后会支持 <a href="https://www.dgl.ai/" rel="nofollow">DGL</a>、<a href="https://pytorch-geometric.readthedocs.io/en/latest/" rel="nofollow">PyG</a></li><li>友好、符合直觉的 API 设计</li><li>与 NebulaGraph 的 UDF 无缝结合，支持从 Query 中调用 ng_ai 任务</li><li>友好的自定义算法接口，方便用户自己实现算法（尚未完成）</li><li>一键试玩环境（基于 Docker Extensions）</li></ul> 
<h3><a id="_ng_ai_27"></a>你可以这么用 ng_ai</h3> 
<h4><a id="_PageRank__29"></a>跑分布式 PageRank 算法</h4> 
<p>可以在一个大图上，基于 <a href="https://github.com/vesoft-inc/nebula-algorithm">nebula-algorithm</a> 分布式地跑 PageRank 算法，像是这样：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> ng_ai <span class="token keyword">import</span> NebulaReader

<span class="token comment"># scan 模式，通过 Spark 引擎读取数据</span>
reader <span class="token operator">=</span> NebulaReader<span class="token punctuation">(</span>engine<span class="token operator">=</span><span class="token string">"spark"</span><span class="token punctuation">)</span>
reader<span class="token punctuation">.</span>scan<span class="token punctuation">(</span>edge<span class="token operator">=</span><span class="token string">"follow"</span><span class="token punctuation">,</span> props<span class="token operator">=</span><span class="token string">"degree"</span><span class="token punctuation">)</span>
df <span class="token operator">=</span> reader<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 运行 PageRank 算法</span>
pr_result <span class="token operator">=</span> df<span class="token punctuation">.</span>algo<span class="token punctuation">.</span>pagerank<span class="token punctuation">(</span>reset_prob<span class="token operator">=</span><span class="token number">0.15</span><span class="token punctuation">,</span> max_iter<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="_NebulaGraph_45"></a>写回算法结果到 NebulaGraph</h4> 
<p>假设我们要跑一个 Label Propagation 算法，然后把结果写回 NebulaGraph，我们可以这么做：</p> 
<p>先确保结果中要写回图数据库的数据 Schema 已经创建好了，像是下面的示例，便是写到 label_propagation.cluster_id 字段里：</p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> TAG <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> label_propagation <span class="token punctuation">(</span>
    cluster_id string <span class="token operator">NOT</span> <span class="token boolean">NULL</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>下面，我们来看下具体流程。执行算法：</p> 
<pre><code class="prism language-python">df_result <span class="token operator">=</span> df<span class="token punctuation">.</span>algo<span class="token punctuation">.</span>label_propagation<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<p>再看一下结果的 Schema：</p> 
<pre><code class="prism language-python">df_result<span class="token punctuation">.</span>printSchema<span class="token punctuation">(</span><span class="token punctuation">)</span>

root
 <span class="token operator">|</span><span class="token operator">-</span><span class="token operator">-</span> _id<span class="token punctuation">:</span> string <span class="token punctuation">(</span>nullable <span class="token operator">=</span> false<span class="token punctuation">)</span>
 <span class="token operator">|</span><span class="token operator">-</span><span class="token operator">-</span> lpa<span class="token punctuation">:</span> string <span class="token punctuation">(</span>nullable <span class="token operator">=</span> false<span class="token punctuation">)</span>
</code></pre> 
<p>参考下面的代码，把 lpa 的结果写回 NebulaGraph 中的 cluster_id 字段里（<code>{"lpa": "cluster_id"}</code>）：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> ng_ai <span class="token keyword">import</span> NebulaWriter
<span class="token keyword">from</span> ng_ai<span class="token punctuation">.</span>config <span class="token keyword">import</span> NebulaGraphConfig

config <span class="token operator">=</span> NebulaGraphConfig<span class="token punctuation">(</span><span class="token punctuation">)</span>
writer <span class="token operator">=</span> NebulaWriter<span class="token punctuation">(</span>
    data<span class="token operator">=</span>df_result<span class="token punctuation">,</span> sink<span class="token operator">=</span><span class="token string">"nebulagraph_vertex"</span><span class="token punctuation">,</span> config<span class="token operator">=</span>config<span class="token punctuation">,</span> engine<span class="token operator">=</span><span class="token string">"spark"</span>
<span class="token punctuation">)</span>

<span class="token comment"># 将 lpa 同 cluster_id 进行映射</span>
properties <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"lpa"</span><span class="token punctuation">:</span> <span class="token string">"cluster_id"</span><span class="token punctuation">}</span>

writer<span class="token punctuation">.</span>set_options<span class="token punctuation">(</span>
    tag<span class="token operator">=</span><span class="token string">"label_propagation"</span><span class="token punctuation">,</span>
    vid_field<span class="token operator">=</span><span class="token string">"_id"</span><span class="token punctuation">,</span>
    properties<span class="token operator">=</span>properties<span class="token punctuation">,</span>
    batch_size<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>
    write_mode<span class="token operator">=</span><span class="token string">"insert"</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
<span class="token comment"># 将数据写回到 NebulaGraph</span>
writer<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<p>最后，验证一下：</p> 
<pre><code class="prism language-shell">USE basketballplayer<span class="token punctuation">;</span>
MATCH <span class="token punctuation">(</span>v:label_propagation<span class="token punctuation">)</span>
RETURN id<span class="token punctuation">(</span>v<span class="token punctuation">)</span>, v.label_propagation.cluster_id LIMIT <span class="token number">3</span><span class="token punctuation">;</span>
</code></pre> 
<p>结果：</p> 
<pre><code class="prism language-SQL">+-------------+--------------------------------+
| id(v)       | v.label_propagation.cluster_id |
+-------------+--------------------------------+
| "player103" | "player101"                    |
| "player113" | "player129"                    |
| "player121" | "player129"                    |
+-------------+--------------------------------+
</code></pre> 
<p>更详细的例子参考：<a href="https://github.com/wey-gu/nebulagraph-ai/blob/main/examples/spark_engine.ipynb">ng_ai/examples</a></p> 
<h4><a id="_nGQL__122"></a>通过 nGQL 调用算法</h4> 
<p>自 NebulaGraph v3.5.0 开始，用户可从 nGQL 中调用自己实现的函数。而 ng_ai 也用这个能力来实现了一个自己的 ng_ai 函数，让它从 nGQL 中调用 ng_ai 的算法，例如：</p> 
<pre><code class="prism language-sql"><span class="token comment">-- 准备将要写入数据的 Schema</span>
<span class="token keyword">USE</span> basketballplayer<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> TAG <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> pagerank<span class="token punctuation">(</span>pagerank string<span class="token punctuation">)</span><span class="token punctuation">;</span>
:sleep <span class="token number">20</span><span class="token punctuation">;</span>
<span class="token comment">-- 回调 ng_ai()</span>
<span class="token keyword">RETURN</span> ng_ai<span class="token punctuation">(</span><span class="token string">"pagerank"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"follow"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"degree"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"spark"</span><span class="token punctuation">,</span> {space: <span class="token string">"basketballplayer"</span><span class="token punctuation">,</span> max_iter: <span class="token number">10</span>}<span class="token punctuation">,</span> {write_mode: <span class="token string">"insert"</span>}<span class="token punctuation">)</span>
</code></pre> 
<p>更详细的例子参考：<a href="https://github.com/wey-gu/nebulagraph-ai/blob/main/examples/ng_ai_from_ngql_udf.ipynb">ng_ai/examples</a></p> 
<h4><a id="_137"></a>单机运行算法</h4> 
<p>在单机、本地的环境，ng_ai 支持基于 NetworkX 运行算法。</p> 
<p>举个例子，读取图为 ng_ai graph 对象：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> ng_ai <span class="token keyword">import</span> NebulaReader
<span class="token keyword">from</span> ng_ai<span class="token punctuation">.</span>config <span class="token keyword">import</span> NebulaGraphConfig

<span class="token comment"># query 模式，通过 NebulaGraph 或是 NetworkX 引擎读取数据</span>
config_dict <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"graphd_hosts"</span><span class="token punctuation">:</span> <span class="token string">"graphd:9669"</span><span class="token punctuation">,</span>
    <span class="token string">"user"</span><span class="token punctuation">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>
    <span class="token string">"password"</span><span class="token punctuation">:</span> <span class="token string">"nebula"</span><span class="token punctuation">,</span>
    <span class="token string">"space"</span><span class="token punctuation">:</span> <span class="token string">"basketballplayer"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
config <span class="token operator">=</span> NebulaGraphConfig<span class="token punctuation">(</span><span class="token operator">**</span>config_dict<span class="token punctuation">)</span>
reader <span class="token operator">=</span> NebulaReader<span class="token punctuation">(</span>engine<span class="token operator">=</span><span class="token string">"nebula"</span><span class="token punctuation">,</span> config<span class="token operator">=</span>config<span class="token punctuation">)</span>
reader<span class="token punctuation">.</span>query<span class="token punctuation">(</span>edges<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"follow"</span><span class="token punctuation">,</span> <span class="token string">"serve"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> props<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"degree"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
g <span class="token operator">=</span> reader<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>查看、画图：</p> 
<pre><code class="prism language-python">g<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
g<span class="token punctuation">.</span>draw<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>运行算法：</p> 
<pre><code class="prism language-python">pr_result <span class="token operator">=</span> g<span class="token punctuation">.</span>algo<span class="token punctuation">.</span>pagerank<span class="token punctuation">(</span>reset_prob<span class="token operator">=</span><span class="token number">0.15</span><span class="token punctuation">,</span> max_iter<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
</code></pre> 
<p>写回 NebulaGraph：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> ng_ai <span class="token keyword">import</span> NebulaWriter

writer <span class="token operator">=</span> NebulaWriter<span class="token punctuation">(</span>
    data<span class="token operator">=</span>pr_result<span class="token punctuation">,</span>
    sink<span class="token operator">=</span><span class="token string">"nebulagraph_vertex"</span><span class="token punctuation">,</span>
    config<span class="token operator">=</span>config<span class="token punctuation">,</span>
    engine<span class="token operator">=</span><span class="token string">"nebula"</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

<span class="token comment"># 待写入的属性</span>
properties <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"pagerank"</span><span class="token punctuation">]</span>

writer<span class="token punctuation">.</span>set_options<span class="token punctuation">(</span>
    tag<span class="token operator">=</span><span class="token string">"pagerank"</span><span class="token punctuation">,</span>
    properties<span class="token operator">=</span>properties<span class="token punctuation">,</span>
    batch_size<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>
    write_mode<span class="token operator">=</span><span class="token string">"insert"</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
<span class="token comment"># 将数据写回到 NebulaGraph</span>
writer<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>其他算法：</p> 
<pre><code class="prism language-python"><span class="token comment"># 获取所有算法</span>
g<span class="token punctuation">.</span>algo<span class="token punctuation">.</span>get_all_algo<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 获取相关算法的帮助信息</span>
<span class="token builtin">help</span><span class="token punctuation">(</span>g<span class="token punctuation">.</span>algo<span class="token punctuation">.</span>node2vec<span class="token punctuation">)</span>

<span class="token comment"># 调用算法</span>
g<span class="token punctuation">.</span>algo<span class="token punctuation">.</span>node2vec<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>更详细的例子参考：<a href="https://github.com/wey-gu/nebulagraph-ai/blob/main/examples/networkx_engine.ipynb">ng_ai/examples</a></p> 
<h4><a id="_213"></a>可视化图算法结果</h4> 
<p>这里演示一个 NetworkX 引擎情况下，计算 Louvain、PageRank 并可视化的例子：</p> 
<p>先执行两个图算法：</p> 
<pre><code class="prism language-python">pr_result <span class="token operator">=</span> g<span class="token punctuation">.</span>algo<span class="token punctuation">.</span>pagerank<span class="token punctuation">(</span>reset_prob<span class="token operator">=</span><span class="token number">0.15</span><span class="token punctuation">,</span> max_iter<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
louvain_result <span class="token operator">=</span> g<span class="token punctuation">.</span>algo<span class="token punctuation">.</span>louvain<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>再手写一个画图好看的函数：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> matplotlib<span class="token punctuation">.</span>colors <span class="token keyword">import</span> ListedColormap


<span class="token keyword">def</span> <span class="token function">draw_graph_louvain_pr</span><span class="token punctuation">(</span>G<span class="token punctuation">,</span> pr_result<span class="token punctuation">,</span> louvain_result<span class="token punctuation">,</span> colors<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"#1984c5"</span><span class="token punctuation">,</span> <span class="token string">"#22a7f0"</span><span class="token punctuation">,</span> <span class="token string">"#63bff0"</span><span class="token punctuation">,</span> <span class="token string">"#a7d5ed"</span><span class="token punctuation">,</span> <span class="token string">"#e2e2e2"</span><span class="token punctuation">,</span> <span class="token string">"#e1a692"</span><span class="token punctuation">,</span> <span class="token string">"#de6e56"</span><span class="token punctuation">,</span> <span class="token string">"#e14b31"</span><span class="token punctuation">,</span> <span class="token string">"#c23728"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 设定节点的位置</span>
    pos <span class="token operator">=</span> nx<span class="token punctuation">.</span>spring_layout<span class="token punctuation">(</span>G<span class="token punctuation">)</span>

    <span class="token comment"># 新建一个图形并设置坐标轴</span>
    fig<span class="token punctuation">,</span> ax <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">35</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    ax<span class="token punctuation">.</span>set_xlim<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    ax<span class="token punctuation">.</span>set_ylim<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token comment"># 从颜色列表中创建一个 colormap</span>
    cmap <span class="token operator">=</span> ListedColormap<span class="token punctuation">(</span>colors<span class="token punctuation">)</span>

    <span class="token comment"># 将图中的节点和边进行绘图</span>
    node_colors <span class="token operator">=</span> <span class="token punctuation">[</span>louvain_result<span class="token punctuation">[</span>node<span class="token punctuation">]</span> <span class="token keyword">for</span> node <span class="token keyword">in</span> G<span class="token punctuation">.</span>nodes<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    node_sizes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">70000</span> <span class="token operator">*</span> pr_result<span class="token punctuation">[</span>node<span class="token punctuation">]</span> <span class="token keyword">for</span> node <span class="token keyword">in</span> G<span class="token punctuation">.</span>nodes<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    nx<span class="token punctuation">.</span>draw_networkx_nodes<span class="token punctuation">(</span>G<span class="token punctuation">,</span> pos<span class="token operator">=</span>pos<span class="token punctuation">,</span> ax<span class="token operator">=</span>ax<span class="token punctuation">,</span> node_color<span class="token operator">=</span>node_colors<span class="token punctuation">,</span> node_size<span class="token operator">=</span>node_sizes<span class="token punctuation">,</span> cmap<span class="token operator">=</span>cmap<span class="token punctuation">,</span> vmin<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> vmax<span class="token operator">=</span><span class="token builtin">max</span><span class="token punctuation">(</span>louvain_result<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    nx<span class="token punctuation">.</span>draw_networkx_edges<span class="token punctuation">(</span>G<span class="token punctuation">,</span> pos<span class="token operator">=</span>pos<span class="token punctuation">,</span> ax<span class="token operator">=</span>ax<span class="token punctuation">,</span> edge_color<span class="token operator">=</span><span class="token string">'gray'</span><span class="token punctuation">,</span> width<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> connectionstyle<span class="token operator">=</span><span class="token string">'arc3, rad=0.2'</span><span class="token punctuation">,</span> arrowstyle<span class="token operator">=</span><span class="token string">'-|&gt;'</span><span class="token punctuation">,</span> arrows<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token comment"># 提取边数据中的 label 数据作为字典</span>
    edge_labels <span class="token operator">=</span> nx<span class="token punctuation">.</span>get_edge_attributes<span class="token punctuation">(</span>G<span class="token punctuation">,</span> <span class="token string">'label'</span><span class="token punctuation">)</span>

    <span class="token comment"># 在图中加入边的 label 数据</span>
    <span class="token keyword">for</span> edge<span class="token punctuation">,</span> label <span class="token keyword">in</span> edge_labels<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        ax<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">(</span>pos<span class="token punctuation">[</span>edge<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> pos<span class="token punctuation">[</span>edge<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span>
                <span class="token punctuation">(</span>pos<span class="token punctuation">[</span>edge<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> pos<span class="token punctuation">[</span>edge<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span>
                label<span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'black'</span><span class="token punctuation">,</span> ha<span class="token operator">=</span><span class="token string">'center'</span><span class="token punctuation">,</span> va<span class="token operator">=</span><span class="token string">'center'</span><span class="token punctuation">)</span>

    <span class="token comment"># 在图中加入点的 label 数据</span>
    node_labels <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>n<span class="token punctuation">:</span> G<span class="token punctuation">.</span>nodes<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span> <span class="token keyword">if</span> <span class="token string">'label'</span> <span class="token keyword">in</span> G<span class="token punctuation">.</span>nodes<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token keyword">else</span> n <span class="token keyword">for</span> n <span class="token keyword">in</span> G<span class="token punctuation">.</span>nodes<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    nx<span class="token punctuation">.</span>draw_networkx_labels<span class="token punctuation">(</span>G<span class="token punctuation">,</span> pos<span class="token operator">=</span>pos<span class="token punctuation">,</span> ax<span class="token operator">=</span>ax<span class="token punctuation">,</span> labels<span class="token operator">=</span>node_labels<span class="token punctuation">,</span> font_size<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">,</span> font_color<span class="token operator">=</span><span class="token string">'black'</span><span class="token punctuation">)</span>

    <span class="token comment"># 为同社区数据添加相同颜色</span>
    sm <span class="token operator">=</span> plt<span class="token punctuation">.</span>cm<span class="token punctuation">.</span>ScalarMappable<span class="token punctuation">(</span>cmap<span class="token operator">=</span>cmap<span class="token punctuation">,</span> norm<span class="token operator">=</span>plt<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span>vmin<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> vmax<span class="token operator">=</span><span class="token builtin">max</span><span class="token punctuation">(</span>louvain_result<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sm<span class="token punctuation">.</span>set_array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    cbar <span class="token operator">=</span> plt<span class="token punctuation">.</span>colorbar<span class="token punctuation">(</span>sm<span class="token punctuation">,</span> ax<span class="token operator">=</span>ax<span class="token punctuation">,</span> ticks<span class="token operator">=</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">max</span><span class="token punctuation">(</span>louvain_result<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> shrink<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span>
    cbar<span class="token punctuation">.</span>ax<span class="token punctuation">.</span>set_yticklabels<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'Community </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">'</span></span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">max</span><span class="token punctuation">(</span>louvain_result<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token comment"># 数据展示</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

draw_graph_louvain_pr<span class="token punctuation">(</span>G<span class="token punctuation">,</span> pr_result<span class="token operator">=</span>pr_result<span class="token punctuation">,</span> louvain_result<span class="token operator">=</span>louvain_result<span class="token punctuation">)</span>
</code></pre> 
<p>效果如下所示：</p> 
<p><img src="https://images2.imgbox.com/5c/08/3jI6zgUs_o.png" alt=""></p> 
<p>更详细的例子参考：<a href="https://github.com/wey-gu/nebulagraph-ai/blob/main/examples/ng_ai_networkx_plot.ipynb">ng_ai/examples</a></p> 
<h4><a id="_Notebook__NebulaGraph_280"></a>更方便的 Notebook 操作 NebulaGraph</h4> 
<p>结合 NebulaGraph 的 Jupyter Notebook 插件: <a href="https://github.com/wey-gu/ipython-ngql">https://github.com/wey-gu/ipython-ngql</a>，我们还可以更便捷地操作 NebulaGraph：</p> 
<p>可通过 ng_ai 的 extras 在 Jupyter Notbook 中安装插件：</p> 
<pre><code class="prism language-python"><span class="token operator">%</span>pip install ng_ai<span class="token punctuation">[</span>jupyter<span class="token punctuation">]</span>
<span class="token operator">%</span>load_ext ngql
</code></pre> 
<p>当然，也可以单独安装插件：</p> 
<pre><code class="prism language-python"><span class="token operator">%</span>pip install ipython<span class="token operator">-</span>ngql
<span class="token operator">%</span>load_ext ngql
</code></pre> 
<p>安装完成后，就可以在 Notebook 里直接使用 <code>%ngql</code> 命令来执行 nGQL 语句：</p> 
<pre><code class="prism language-python"><span class="token operator">%</span>ngql <span class="token operator">-</span><span class="token operator">-</span>address <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span> <span class="token operator">-</span><span class="token operator">-</span>port <span class="token number">9669</span> <span class="token operator">-</span><span class="token operator">-</span>user root <span class="token operator">-</span><span class="token operator">-</span>password nebula
<span class="token operator">%</span>ngql USE basketballplayer<span class="token punctuation">;</span>
<span class="token operator">%</span>ngql MATCH <span class="token punctuation">(</span>v<span class="token punctuation">:</span>player<span class="token punctuation">{<!-- --></span>name<span class="token punctuation">:</span><span class="token string">"Tim Duncan"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>v2<span class="token punctuation">:</span>player<span class="token punctuation">)</span> RETURN v2<span class="token punctuation">.</span>player<span class="token punctuation">.</span>name AS Name<span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>注，多行的 Query 用两个百分号就好了 <code>%%ngql</code></p> 
</blockquote> 
<p>最后，我们还能在 Jupyter Notebook 里直接可视化渲染结果！只需要 <code>%ng_draw</code> 就可以啦！</p> 
<pre><code class="prism language-python"><span class="token operator">%</span>ngql <span class="token keyword">match</span> p<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">:</span>player<span class="token punctuation">)</span><span class="token operator">-</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">return</span> p LIMIT <span class="token number">5</span>
<span class="token operator">%</span>ng_draw
</code></pre> 
<p>效果如下：</p> 
<p><img src="https://images2.imgbox.com/8b/7b/r52RJpuF_o.png" alt=""></p> 
<h3><a id="_319"></a>未来工作</h3> 
<p>现在 ng_ai 还在开发中，我们还有很多工作要做：</p> 
<ul><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled> 完善 Reader 模式，现在 NebulaGraph / NetworkX 的读取数据只支持 Query-Mode，还需要支持 Scan-Mode</li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled> 实现基于 dgl（GNN）的链路预测、节点分类等算法，例如：</li></ul> 
<pre><code class="prism language-python">model <span class="token operator">=</span> g<span class="token punctuation">.</span>algo<span class="token punctuation">.</span>gnn_link_prediction<span class="token punctuation">(</span><span class="token punctuation">)</span>
result <span class="token operator">=</span> model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># query src, dst to be predicted</span>

model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>src_vertex<span class="token punctuation">,</span> dst_vertices<span class="token punctuation">)</span>
</code></pre> 
<ul><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled> UDA，自定义算法</li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled> 快速部署工具</li></ul> 
<p>ng_ai 完全 build in public，欢迎社区的大家们来参与，一起来完善 ng_ai，让 NebulaGraph 上的 AI 算法更加简单、易用！</p> 
<h3><a id="_ng_ai_339"></a>试玩 ng_ai</h3> 
<p>我们已经准备好了一键部署的 NebulaGraph + NebulaGraph Studio + ng_ai in Jupyter 的环境，只需要大家从 Docker Desktop 的 Extension（扩展）中搜索 NebulaGraph，就可以试玩了。</p> 
<ul><li>安装 <a href="https://www.docker.com/blog/distributed-cloud-native-graph-database-nebulagraph-docker-extension/" rel="nofollow">NebulaGraph Docker 插件</a></li></ul> 
<p>在 Docker Desktop 的插件市场搜索 NebulaGraph，点击安装：</p> 
<p><img src="https://images2.imgbox.com/18/45/foaTIa9o_o.png" alt=""></p> 
<ul><li>安装 ng_ai Playground</li></ul> 
<p>进入 NebulaGraph 插件，点击 <strong>Install NX Mode</strong>，安装 ng_ai 的 NetworkX Playground，通常要等几分钟等待安装完成。</p> 
<p><img src="https://images2.imgbox.com/0d/59/LnXzEzi5_o.png" alt=""></p> 
<ul><li>进入 NetworkX Playground</li></ul> 
<p>点击 <strong>Jupyter NB NetworkX</strong>，进入 NetworkX Playground。</p> 
<p><img src="https://images2.imgbox.com/cc/09/Zhh54QTU_o.png" alt=""></p> 
<h3><a id="ng_ai__361"></a>ng_ai 的架构</h3> 
<p>ng_ai 的架构如下，它的核心模块有：</p> 
<ul><li>Reader：负责从 NebulaGraph 读取数据</li><li>Writer：负责将数据写入 NebulaGraph</li><li>Engine：负责适配不同运行时，例如 Spark、DGL、NetowrkX 等</li><li>Algo：算法模块，例如 PageRank、Louvain、GNN_Link_Predict 等</li></ul> 
<p>此外，为了支持 nGQL 中的调用，还有两个模块：</p> 
<ul><li>ng_ai-udf：负责将 UDF 注册到 NebulaGraph，接受 ng_ai 的 Query 调用，访问 ng_ai API</li><li>ng_ai-api：ng_ai 的 API 服务，接受 UDF 的调用，访问 ng_ai 核心模块</li></ul> 
<pre><code class="prism language-asciiarmor">          ┌───────────────────────────────────────────────────┐
          │   Spark Cluster                                   │
          │    .─────.    .─────.    .─────.    .─────.       │
          │   ;       :  ;       :  ;       :  ;       :      │
       ┌─▶│   :       ;  :       ;  :       ;  :       ;      │
       │  │    ╲     ╱    ╲     ╱    ╲     ╱    ╲     ╱       │
       │  │     `───'      `───'      `───'      `───'        │
  Algo Spark                                                  │
    Engine└───────────────────────────────────────────────────┘
       │  ┌────────────────────────────────────────────────────┬──────────┐
       └──┤                                                    │          │
          │   NebulaGraph AI Suite(ngai)                       │ ngai-api │◀─┐
          │                                                    │          │  │
          │                                                    └──────────┤  │
          │     ┌────────┐    ┌──────┐    ┌────────┐   ┌─────┐            │  │
          │     │ Reader │    │ Algo │    │ Writer │   │ GNN │            │  │
 ┌───────▶│     └────────┘    └──────┘    └────────┘   └─────┘            │  │
 │        │          │            │            │          │               │  │
 │        │          ├────────────┴───┬────────┴─────┐    └──────┐        │  │
 │        │          ▼                ▼              ▼           ▼        │  │
 │        │   ┌─────────────┐ ┌──────────────┐ ┌──────────┐ ┌──────────┐  │  │
 │     ┌──┤   │ SparkEngine │ │ NebulaEngine │ │ NetworkX │ │ DGLEngine│  │  │
 │     │  │   └─────────────┘ └──────────────┘ └──────────┘ └──────────┘  │  │
 │     │  └──────────┬────────────────────────────────────────────────────┘  │
 │     │             │        Spark                                          │
 │     │             └────────Reader ────────────┐                           │
 │  Spark                   Query Mode           │                           │
 │  Reader                                       │                           │
 │Scan Mode                                      ▼                      ┌─────────┐
 │     │  ┌───────────────────────────────────────────────────┬─────────┤ ngai-udf│◀─────────────┐
 │     │  │                                                   │         └─────────┤              │
 │     │  │  NebulaGraph Graph Engine         Nebula-GraphD   │   ngai-GraphD     │              │
 │     │  ├──────────────────────────────┬────────────────────┼───────────────────┘              │
 │     │  │                              │                    │                                  │
 │     │  │  NebulaGraph Storage Engine  │                    │                                  │
 │     │  │                              │                    │                                  │
 │     └─▶│  Nebula-StorageD             │    Nebula-Metad    │                                  │
 │        │                              │                    │                                  │
 │        └──────────────────────────────┴────────────────────┘                                  │
 │                                                                                               │
 │    ┌───────────────────────────────────────────────────────────────────────────────────────┐  │
 │    │ RETURN ng_ai("pagerank", ["follow"], ["degree"], "spark", {space:"basketballplayer"}) │──┘
 │    └───────────────────────────────────────────────────────────────────────────────────────┘
 │  ┌─────────────────────────────────────────────────────────────┐
 │  │ from ng_ai import NebulaReader                              │
 │  │                                                             │
 │  │ # read data with spark engine, scan mode                    │
 │  │ reader = NebulaReader(engine="spark")                       │
 │  │ reader.scan(edge="follow", props="degree")                  │
 └──│ df = reader.read()                                          │
    │                                                             │
    │ # run pagerank algorithm                                    │
    │ pr_result = df.algo.pagerank(reset_prob=0.15, max_iter=10)  │
    │                                                             │
    └─────────────────────────────────────────────────────────────┘  
</code></pre> 
<hr> 
<p><strong>谢谢你读完本文</strong> (///▽///)</p> 
<p>欢迎前往 GitHub 来阅读 NebulaGraph 源码，或是尝试用它解决你的业务问题 yo~ GitHub 地址：<a href="https://github.com/vesoft-inc/nebula">https://github.com/vesoft-inc/nebula</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e6c393f1b18a172503def42820c5159d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">mybatis-plus 批量插入修改操作</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/073df61a41404a9f65bab7999a3fef78/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Linux快速搭建tensorflow-gpu 1.15.0环境&amp;Keras（包括30系显卡）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>