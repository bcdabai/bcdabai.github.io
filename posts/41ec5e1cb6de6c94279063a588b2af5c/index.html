<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>nginx(四十六)log阶段log模块学习 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="nginx(四十六)log阶段log模块学习" />
<meta property="og:description" content="一 ngx_http_log_module
说明：这是&#39;nginx&#39; 11个阶段的&#39;最后&#39;一个阶段 理想: nginx如果能记录最终&#39;匹配的location&#39;和&#39;server_name&#39;就好了 现实的情况： 往往需要根据&#39;Host&#39;头、$proxy_pass、$request &#39;综合&#39;判断 --&gt;由于&#39;内部重定向&#39; nginx何时记录日志 ① access_log
1）path 了解
nginx syslog记录日志
语法：access_log syslog:server=address[,parameter=value] [format]; 特点：可以将nginx日志&#39;直接传输&#39;到logstash中而&#39;不落盘&#39;,但是这种方法传输的日志&#39;不可靠&#39;，并且会对nginx产生&#39;性能&#39;影响,可以在&#39;测试&#39;的时候使用 2）buffer和gzip 了解
细节点： 打开gzip的时候,默认已经&#39;开启&#39;buffer了 3）if 掌握
② log_format
1）日志&#39;格式&#39;应该使用&#39;哪些&#39;变量才能帮助&#39;运维人员快速定位&#39;问题 --&gt;&#39;运维&#39; 2）日志格式&#39;包含哪些信息&#39;来方便我们&#39;提取有效&#39;信息进行全局分析 --&gt;&#39;反馈&#39; 1）默认的日志格式 2）细节阶段
1）default定义&#39;普通的文本&#39;格式转义字符的处理规则 --&gt;体会&#39;default&#39;和&#39;json&#39;转义规则的不同 2）json定义了 &#39;json 格式字符串(单双引号)&#39;中一些&#39;非法字符的转义&#39;规则 --&gt; &#39;1.11.8版本引入&#39; escape=json &#39;{&#34;realip&#34;:&#34;$remote_addr&#34;,&#34;@timestamp&#34;:&#34;$time_iso8601&#34;}&#39;; --&gt;&#39;外围单引号&#39; 场景： nginx日志json化,方便在&#39;es&#39;中生成方便&#39;检索的索引&#39; 3) 日志格式&#39;隐私&#39;问题--&gt;Cookie包含很多&#39;隐私key和value&#39;,之记录通用能&#39;识别用户身份&#39;的即可 4）建议变量&#39;使用&#39; --&gt; [$varable]的形式 5）关于&#39;日志使用哪些变量&#39;帮助我们&#39;快速&#39;判断问题,后续讲解 3） 日志显示l乱码(16进制)
json url中文编码
nginx没有开启ssl导致日志是16进制的
1）在nginx&#39;没有开启ssl支持&#39;的情况下,nginx将https连接建立过程中的&#39;客户端hello报文&#39;当作http报文处理 2）暴力的&#39;截取&#39;了报文中指定位置的十六进制字符串当作了$request的http请求方法、URL和版本号 3）所以access日志中会出现&#39;十六进制&#39;字符串 非法转义的处理
③ open_log_file_cache 了解
之前写的比较烂日志相关的博客
Logging to syslog" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/41ec5e1cb6de6c94279063a588b2af5c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-24T22:46:38+08:00" />
<meta property="article:modified_time" content="2022-11-24T22:46:38+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">nginx(四十六)log阶段log模块学习</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>一  <a href="http://nginx.org/en/docs/http/ngx_http_log_module.html" rel="nofollow" title="ngx_http_log_module">ngx_http_log_module</a></p> 
<p><img alt="" height="366" src="https://images2.imgbox.com/ae/02/0H0uGybH_o.png" width="666"></p> 
<pre><code class="language-bash">说明：这是'nginx' 11个阶段的'最后'一个阶段</code></pre> 
<p><img alt="" height="76" src="https://images2.imgbox.com/b0/86/0UHAiSj6_o.png" width="666"></p> 
<pre><code class="language-bash">理想: nginx如果能记录最终'匹配的location'和'server_name'就好了

现实的情况： 往往需要根据'Host'头、$proxy_pass、$request '综合'判断 --&gt;由于'内部重定向'</code></pre> 
<p> <a class="link-info" href="https://blog.csdn.net/wzj_110/article/details/124892581" title="nginx何时记录日志 ">nginx何时记录日志 </a></p> 
<p>①   <a href="http://nginx.org/en/docs/http/ngx_http_log_module.html#access_log" rel="nofollow" title="access_log">access_log</a></p> 
<p><img alt="" height="184" src="https://images2.imgbox.com/22/1d/ifyu7Z76_o.png" width="666"></p> 
<p>1）<span style="color:#98c091;">path  </span><span style="color:#fe2c24;">了解</span></p> 
<p><a class="link-info" href="https://zhuanlan.zhihu.com/p/100080719" rel="nofollow" title="nginx  syslog记录日志">nginx syslog记录日志</a></p> 
<pre><code class="language-bash">语法：access_log syslog:server=address[,parameter=value] [format];

特点：可以将nginx日志'直接传输'到logstash中而'不落盘',但是这种方法传输的日志'不可靠'，并且会对nginx产生'性能'影响,可以在'测试'的时候使用</code></pre> 
<p><img alt="" height="22" src="https://images2.imgbox.com/ea/56/z8Ys9abQ_o.png" width="666"></p> 
<p><img alt="" height="261" src="https://images2.imgbox.com/92/d1/vt3vUf9d_o.png" width="666"></p> 
<p>2）<span style="color:#1c7892;">buffer和gzip  </span><span style="color:#fe2c24;">了解</span></p> 
<p><img alt="" height="210" src="https://images2.imgbox.com/0f/cc/0BXVieXS_o.png" width="520"></p> 
<pre><code class="language-bash">细节点： 打开gzip的时候,默认已经'开启'buffer了</code></pre> 
<p><img alt="" height="206" src="https://images2.imgbox.com/80/ba/I82kZgfq_o.png" width="520"></p> 
<p>3）<span style="color:#79c6cd;">if  </span><span style="color:#fe2c24;">掌握</span></p> 
<p><img alt="" height="18" src="https://images2.imgbox.com/78/d3/p9YsOUKP_o.png" width="252"></p> 
<p><img alt="" height="163" src="https://images2.imgbox.com/3f/b8/IpiASDbE_o.png" width="666"></p> 
<p>②   <a href="http://nginx.org/en/docs/http/ngx_http_log_module.html#log_format" rel="nofollow" title="log_format">log_format</a></p> 
<pre><code class="language-bash">1）日志'格式'应该使用'哪些'变量才能帮助'运维人员快速定位'问题 --&gt;'运维'

2）日志格式'包含哪些信息'来方便我们'提取有效'信息进行全局分析 --&gt;'反馈'</code></pre> 
<p><img alt="" height="308" src="https://images2.imgbox.com/27/fa/TpCf94cJ_o.png" width="666"></p> 
<p>1）<span style="color:#1a439c;">默认的日志格式 </span></p> 
<p><img alt="" height="166" src="https://images2.imgbox.com/32/b7/EzIqs8hR_o.png" width="666"></p> 
<p>2）<span style="color:#98c091;">细节阶段</span></p> 
<pre><code class="language-bash">1）default定义'普通的文本'格式转义字符的处理规则  --&gt;体会'default'和'json'转义规则的不同

2）json定义了 'json 格式字符串(单双引号)'中一些'非法字符的转义'规则 --&gt; '1.11.8版本引入'

escape=json '{"realip":"$remote_addr","@timestamp":"$time_iso8601"}'; --&gt;'外围单引号'

场景： nginx日志json化,方便在'es'中生成方便'检索的索引'

3) 日志格式'隐私'问题--&gt;Cookie包含很多'隐私key和value',之记录通用能'识别用户身份'的即可

4）建议变量'使用' --&gt; [$varable]的形式

5）关于'日志使用哪些变量'帮助我们'快速'判断问题,后续讲解</code></pre> 
<p>3） <span style="color:#1a439c;">日志显示l乱码(16进制)</span></p> 
<p><span style="color:#1a439c;"><a class="link-info" href="https://blog.csdn.net/u010730731/article/details/87873390" title="json url中文编码">json url中文编码</a></span></p> 
<p><a class="link-info" href="https://www.cnblogs.com/wurijie/p/13222397.html" rel="nofollow" title="nginx没有开启ssl导致日志是16进制的">nginx没有开启ssl导致日志是16进制的</a></p> 
<pre><code class="language-bash">1）在nginx'没有开启ssl支持'的情况下,nginx将https连接建立过程中的'客户端hello报文'当作http报文处理

2）暴力的'截取'了报文中指定位置的十六进制字符串当作了$request的http请求方法、URL和版本号

3）所以access日志中会出现'十六进制'字符串</code></pre> 
<p><a class="link-info" href="https://zhuanlan.zhihu.com/p/341245312" rel="nofollow" title="非法转义的处理">非法转义的处理</a></p> 
<p>③   <a href="http://nginx.org/en/docs/http/ngx_http_log_module.html#open_log_file_cache" rel="nofollow" title="open_log_file_cache">open_log_file_cache</a>  <span style="color:#98c091;">了解</span></p> 
<p><img alt="" height="292" src="https://images2.imgbox.com/90/f3/mmOdYXkf_o.png" width="520"></p> 
<p><a class="link-info" href="https://blog.csdn.net/wzj_110/article/details/111771189" title="之前写的比较烂日志相关的博客">之前写的比较烂日志相关的博客</a></p> 
<p><a class="link-info" href="http://nginx.org/en/docs/syslog.html" rel="nofollow" title="Logging to syslog">Logging to syslog</a></p> 
<p>二   <span style="color:#1a439c;">补充</span></p> 
<p>①  <a class="link-info" href="http://nginx.org/en/docs/ngx_core_module.html#debug_connection" rel="nofollow" title="debug_connection">debug_connection</a></p> 
<p><a class="link-info" href="http://nginx.org/en/docs/debugging_log.html" rel="nofollow" title="官方debug级别日志">官方debug级别日志</a></p> 
<p><img alt="" height="299" src="https://images2.imgbox.com/46/fe/BihaHHo9_o.png" width="600"></p> 
<p>②   <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#log_not_found" rel="nofollow" title="log_not_found">log_not_found</a></p> 
<p><img alt="" height="92" src="https://images2.imgbox.com/24/2f/9udhUZDg_o.png" width="600"></p> 
<p><a class="link-info" href="https://blog.csdn.net/risen16/article/details/78187312" title="忽略favicon.ico日志 ">忽略favicon.ico日志 </a></p> 
<p>③  <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#log_subrequest" rel="nofollow" title="log_subrequest">log_subrequest</a> <span style="color:#79c6cd;">重要</span></p> 
<p><img alt="" height="89" src="https://images2.imgbox.com/02/a7/jfwTf6NS_o.png" width="600"></p> 
<p>④  <a href="http://nginx.org/en/docs/stream/ngx_stream_limit_conn_module.html#limit_conn_log_level" rel="nofollow" title="limit_conn_log_level">limit_conn_log_level</a>  <a href="http://nginx.org/en/docs/http/ngx_http_limit_req_module.html#limit_req_log_level" rel="nofollow" title="limit_req_log_level">limit_req_log_level</a></p> 
<p>⑤  <a href="http://nginx.org/en/docs/http/ngx_http_rewrite_module.html#rewrite_log" rel="nofollow" title="rewrite_log">rewrite_log</a></p> 
<p><img alt="" height="107" src="https://images2.imgbox.com/be/f1/UTtPBN1i_o.png" width="600"></p> 
<p><a class="link-info" href="https://www.bilibili.com/video/BV11T4y1E7A7/?vd_source=69b0e8b94abd32865845089d82fd2706" rel="nofollow" title="access.log日志设计哪些变量加块排错进读">access.log日志设计哪些变量加块排错进读</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/79a828da0cd307d8f0d40eb2e01a1c5f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Ubuntu server 22.04 安装kvm</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/83de0ad71764ae3f944c23b0ba9621a2/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">iOS 一行代码实现单行多按钮单选按钮事例</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>