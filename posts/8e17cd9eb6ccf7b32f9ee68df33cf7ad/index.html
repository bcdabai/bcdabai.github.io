<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【云原生】使用kubeadm搭建K8S - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【云原生】使用kubeadm搭建K8S" />
<meta property="og:description" content="目录 一、Kubeadm搭建K8S1.1环境准备1.2所有节点安装docker1.3所有节点安装kubeadm，kubelet和kubectl1.4部署K8S集群1.5所有节点部署网络插件flannel 二、部署 Dashboard 一、Kubeadm搭建K8S 1.1环境准备 服务器IP配置master（2C/4G，cpu核心数要求大于2）192.168.243.107docker、kubeadm、kubelet、kubectl、flannelnode01（2C/2G）192.168.243.108docker、kubeadm、kubelet、kubectl、flannelnode02（2C/2G）192.168.243.109docker、kubeadm、kubelet、kubectl、flannelmaster02192.168.243.110docker、kubeadm、kubelet、kubectl、flannel //修改主机名 hostnamectl set-hostname master01 hostnamectl set-hostname node01 hostnamectl set-hostname node02 //所有节点修改hosts文件 vim /etc/hosts 192.168.80.10 master01 192.168.80.11 node01 192.168.80.12 node02 //调整内核参数 cat &gt; /etc/sysctl.d/kubernetes.conf &lt;&lt; EOF #开启网桥模式，可将网桥的流量传递给iptables链 net.bridge.bridge-nf-call-ip6tables=1 net.bridge.bridge-nf-call-iptables=1 #关闭ipv6协议 net.ipv6.conf.all.disable_ipv6=1 net.ipv4.ip_forward=1 EOF //生效参数 sysctl --system 1.2所有节点安装docker yum install -y yum-utils device-mapper-persistent-data lvm2 yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo yum install -y docker-ce docker-ce-cli containerd.io mkdir /etc/docker cat &gt; /etc/docker/daemon.json &lt;&lt;EOF { &#34;registry-mirrors&#34;: [&#34;https://6ijb8ubo.mirror.aliyuncs.com&#34;], &#34;exec-opts&#34;: [&#34;native.cgroupdriver=systemd&#34;], &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/8e17cd9eb6ccf7b32f9ee68df33cf7ad/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-05T22:21:29+08:00" />
<meta property="article:modified_time" content="2023-08-05T22:21:29+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【云原生】使用kubeadm搭建K8S</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#KubeadmK8S_1" rel="nofollow">一、Kubeadm搭建K8S</a></li><li><ul><li><a href="#11_2" rel="nofollow">1.1环境准备</a></li><li><a href="#12docker_40" rel="nofollow">1.2所有节点安装docker</a></li><li><a href="#13kubeadmkubeletkubectl_72" rel="nofollow">1.3所有节点安装kubeadm，kubelet和kubectl</a></li><li><a href="#14K8S_96" rel="nofollow">1.4部署K8S集群</a></li><li><a href="#15flannel_205" rel="nofollow">1.5所有节点部署网络插件flannel</a></li></ul> 
  </li><li><a href="#_Dashboard_222" rel="nofollow">二、部署 Dashboard</a></li></ul> 
</div> 
<p></p> 
<h2><a id="KubeadmK8S_1"></a>一、Kubeadm搭建K8S</h2> 
<h3><a id="11_2"></a>1.1环境准备</h3> 
<table><thead><tr><th>服务器</th><th>IP</th><th>配置</th></tr></thead><tbody><tr><td>master（2C/4G，cpu核心数要求大于2）</td><td>192.168.243.107</td><td>docker、kubeadm、kubelet、kubectl、flannel</td></tr><tr><td>node01（2C/2G）</td><td>192.168.243.108</td><td>docker、kubeadm、kubelet、kubectl、flannel</td></tr><tr><td>node02（2C/2G）</td><td>192.168.243.109</td><td>docker、kubeadm、kubelet、kubectl、flannel</td></tr><tr><td>master02</td><td>192.168.243.110</td><td>docker、kubeadm、kubelet、kubectl、flannel</td></tr></tbody></table> 
<pre><code class="prism language-bash">//修改主机名
hostnamectl set-hostname master01
hostnamectl set-hostname node01
hostnamectl set-hostname node02

//所有节点修改hosts文件
<span class="token function">vim</span> /etc/hosts
<span class="token number">192.168</span>.80.10 master01
<span class="token number">192.168</span>.80.11 node01
<span class="token number">192.168</span>.80.12 node02

//调整内核参数
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/sysctl.d/kubernetes.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
#开启网桥模式，可将网桥的流量传递给iptables链
net.bridge.bridge-nf-call-ip6tables=1
net.bridge.bridge-nf-call-iptables=1
#关闭ipv6协议
net.ipv6.conf.all.disable_ipv6=1
net.ipv4.ip_forward=1
EOF</span>

//生效参数
<span class="token function">sysctl</span> <span class="token parameter variable">--system</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/eb/d9/a7G81zNB_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/8b/ef/fB98X4WR_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/bf/55/5ptjSTtM_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="12docker_40"></a>1.2所有节点安装docker</h3> 
<pre><code class="prism language-bash">yum <span class="token function">install</span> <span class="token parameter variable">-y</span> yum-utils device-mapper-persistent-data lvm2 
yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo 
yum <span class="token function">install</span> <span class="token parameter variable">-y</span> docker-ce docker-ce-cli containerd.io

<span class="token function">mkdir</span> /etc/docker
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/docker/daemon.json <span class="token operator">&lt;&lt;</span><span class="token string">EOF
{
  "registry-mirrors": ["https://6ijb8ubo.mirror.aliyuncs.com"],
  "exec-opts": ["native.cgroupdriver=systemd"],
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "500m", "max-file": "3"
  }
}
EOF</span>
<span class="token comment">#使用Systemd管理的Cgroup来进行资源控制与管理，因为相对Cgroupfs而言，Systemd限制CPU、内存等资源更加简单和成熟稳定。</span>
<span class="token comment">#日志使用json-file格式类型存储，大小为100M，保存在/var/log/containers目录下，方便ELK等日志系统收集和管理日志。</span>

systemctl daemon-reload
systemctl restart docker.service
systemctl <span class="token builtin class-name">enable</span> docker.service 

<span class="token function">docker</span> info <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"Cgroup Driver"</span>
Cgroup Driver: systemd
</code></pre> 
<p><img src="https://images2.imgbox.com/a6/da/MERI9jPG_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="13kubeadmkubeletkubectl_72"></a>1.3所有节点安装kubeadm，kubelet和kubectl</h3> 
<pre><code class="prism language-bash">//定义kubernetes源
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/yum.repos.d/kubernetes.repo <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF</span>

yum <span class="token function">install</span> <span class="token parameter variable">-y</span> kubelet-1.20.15 kubeadm-1.20.15 kubectl-1.20.15

//开机自启kubelet
systemctl <span class="token builtin class-name">enable</span> kubelet.service
<span class="token comment">#K8S通过kubeadm安装出来以后都是以Pod方式存在，即底层是以容器方式运行，所以kubelet必须设置开机自启</span>

</code></pre> 
<p><img src="https://images2.imgbox.com/af/27/A1XljDiM_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="14K8S_96"></a>1.4部署K8S集群</h3> 
<pre><code class="prism language-bash">//查看初始化需要的镜像
kubeadm config images list --kubernetes-version <span class="token number">1.20</span>.15

//在 master 节点上传 v1.20.15.zip 压缩包至 /opt 目录
<span class="token function">unzip</span> v1.20.15.zip <span class="token parameter variable">-d</span> /opt/k8s
<span class="token builtin class-name">cd</span> /opt/k8s/
<span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">ls</span> *.tar<span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token function">docker</span> load <span class="token parameter variable">-i</span> <span class="token variable">$i</span><span class="token punctuation">;</span> <span class="token keyword">done</span>

//复制镜像和脚本到 <span class="token function">node</span> 节点，并在 <span class="token function">node</span> 节点上执行脚本加载镜像文件
<span class="token function">scp</span> <span class="token parameter variable">-r</span> /opt/k8s root@node01:/opt
<span class="token function">scp</span> <span class="token parameter variable">-r</span> /opt/k8s root@node02:/opt

//初始化kubeadm
方法一：
kubeadm config print init-defaults <span class="token operator">&gt;</span> /opt/kubeadm-config.yaml

<span class="token builtin class-name">cd</span> /opt/
<span class="token function">vim</span> kubeadm-config.yaml
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
<span class="token number">11</span> localAPIEndpoint:
<span class="token number">12</span>   advertiseAddress: <span class="token number">192.168</span>.80.10		<span class="token comment">#指定master节点的IP地址</span>
<span class="token number">13</span>   bindPort: <span class="token number">6443</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
<span class="token number">32</span> imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers          <span class="token comment">#指定拉取镜像的仓库，默认是k8s.gcr.io</span>
<span class="token number">33</span> kind: ClusterConfiguration
<span class="token number">34</span> kubernetesVersion: v1.20.15				<span class="token comment">#指定kubernetes版本号</span>
<span class="token number">35</span> networking:
<span class="token number">36</span>   dnsDomain: cluster.local
<span class="token number">37</span>   podSubnet: <span class="token string">"10.244.0.0/16"</span>				<span class="token comment">#指定pod网段，10.244.0.0/16用于匹配flannel默认网段</span>
<span class="token number">38</span>   serviceSubnet: <span class="token number">10.96</span>.0.0/16			<span class="token comment">#指定service网段</span>
<span class="token number">39</span> scheduler: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token comment">#末尾再添加以下内容</span>
--- 
apiVersion: kubeproxy.config.k8s.io/v1alpha1
kind: KubeProxyConfiguration
mode: ipvs	

//在线拉取镜像
kubeadm config images pull <span class="token parameter variable">--config</span> /opt/kubeadm-config.yaml

//初始化 master
kubeadm init <span class="token parameter variable">--config</span><span class="token operator">=</span>/opt/kubeadm-config.yaml --upload-certs <span class="token operator">|</span> <span class="token function">tee</span> kubeadm-init.log
<span class="token comment">#--upload-certs 参数可以在后续执行加入节点时自动分发证书文件</span>
<span class="token comment">#tee kubeadm-init.log 用以输出日志</span>

//查看 kubeadm-init 日志
<span class="token function">less</span> kubeadm-init.log

//kubernetes配置文件目录
<span class="token function">ls</span> /etc/kubernetes/

//存放ca等证书和密码的目录
<span class="token function">ls</span> /etc/kubernetes/pki	
</code></pre> 
<p><img src="https://images2.imgbox.com/bb/04/MVbszQRr_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/d1/7e/IWUFhwNP_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/e6/14/Mb3xZS45_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/e2/c7/MAFCLOiJ_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/ef/e2/KblNs5bO_o.png" alt="在这里插入图片描述"><br> <strong>方法二初始化后需要修改 kube-proxy 的 configmap，开启 ipvs</strong></p> 
<pre><code class="prism language-bash">kubectl edit cm kube-proxy <span class="token parameter variable">-n</span><span class="token operator">=</span>kube-system
修改mode: ipvs



提示：
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
Your Kubernetes control-plane has initialized successfully<span class="token operator">!</span>

To start using your cluster, you need to run the following as a regular user:

  <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token environment constant">$HOME</span>/.kube
  <span class="token function">sudo</span> <span class="token function">cp</span> <span class="token parameter variable">-i</span> /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config
  <span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> <span class="token parameter variable">-u</span><span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> <span class="token parameter variable">-g</span><span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config

You should now deploy a pod network to the cluster.
Run <span class="token string">"kubectl apply -f [podnetwork].yaml"</span> with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can <span class="token function">join</span> any number of worker nodes by running the following on each as root:

kubeadm <span class="token function">join</span> <span class="token number">192.168</span>.80.10:6443 <span class="token parameter variable">--token</span> rc0kfs.a1sfe3gl4dvopck5 <span class="token punctuation">\</span>
    --discovery-token-ca-cert-hash sha256:864fe553c812df2af262b406b707db68b0fd450dc08b34efb73dd5a4771d37a2


//设定kubectl
kubectl需经由API server认证及授权后方能执行相应的管理操作，kubeadm 部署的集群为其生成了一个具有管理员权限的认证配置文件 /etc/kubernetes/admin.conf，它可由 kubectl 通过默认的 “<span class="token environment constant">$HOME</span>/.kube/config” 的路径进行加载。

<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token environment constant">$HOME</span>/.kube
<span class="token function">cp</span> <span class="token parameter variable">-i</span> /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config
<span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> <span class="token parameter variable">-u</span><span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> <span class="token parameter variable">-g</span><span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config


//如果 kubectl get cs 发现集群不健康，更改以下两个文件
<span class="token function">vim</span> /etc/kubernetes/manifests/kube-scheduler.yaml 
<span class="token function">vim</span> /etc/kubernetes/manifests/kube-controller-manager.yaml
<span class="token comment"># 修改如下内容</span>
把--bind-address<span class="token operator">=</span><span class="token number">127.0</span>.0.1变成--bind-address<span class="token operator">=</span><span class="token number">192.168</span>.80.10		<span class="token comment">#修改成k8s的控制节点master01的ip</span>
把httpGet:字段下的hosts由127.0.0.1变成192.168.80.10（有两处）
<span class="token comment">#- --port=0					# 搜索port=0，把这一行注释掉</span>

systemctl restart kubelet
</code></pre> 
<p><img src="https://images2.imgbox.com/84/91/jftluPXm_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="15flannel_205"></a>1.5所有节点部署网络插件flannel</h3> 
<p><strong>方法一：</strong></p> 
<pre><code class="prism language-bash">/所有节点上传 flannel 镜像 flannel.tar 和网络插件 cni-plugins-linux-amd64-v0.8.6.tgz 到 /opt 目录，master节点上传 kube-flannel.yml 文件
<span class="token builtin class-name">cd</span> /opt
<span class="token function">docker</span> load <span class="token operator">&lt;</span> flannel.tar

<span class="token function">mv</span> /opt/cni /opt/cni_bak
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /opt/cni/bin
<span class="token function">tar</span> zxvf cni-plugins-linux-amd64-v0.8.6.tgz <span class="token parameter variable">-C</span> /opt/cni/bin

//在 master 节点创建 flannel 资源
kubectl apply <span class="token parameter variable">-f</span> kube-flannel.yml 
</code></pre> 
<p><img src="https://images2.imgbox.com/a3/f7/xZKnZIBH_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/55/7c/zDtXU834_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/be/5e/WDEvlhDC_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_Dashboard_222"></a>二、部署 Dashboard</h2> 
<pre><code class="prism language-bash">//在 master01 节点上操作
<span class="token comment">#上传 recommended.yaml 文件到 /opt/k8s 目录中</span>
<span class="token builtin class-name">cd</span> /opt/k8s
<span class="token function">vim</span> recommended.yaml
<span class="token comment">#默认Dashboard只能集群内部访问，修改Service为NodePort类型，暴露到外部：</span>
kind: Service
apiVersion: v1
metadata:
  labels:
    k8s-app: kubernetes-dashboard
  name: kubernetes-dashboard
  namespace: kubernetes-dashboard
spec:
  ports:
    - port: <span class="token number">443</span>
      targetPort: <span class="token number">8443</span>
      nodePort: <span class="token number">30001</span>     <span class="token comment">#添加</span>
  type: NodePort          <span class="token comment">#添加</span>
  selector:
    k8s-app: kubernetes-dashboard
	
kubectl apply <span class="token parameter variable">-f</span> recommended.yaml

<span class="token comment">#创建service account并绑定默认cluster-admin管理员集群角色</span>
kubectl create serviceaccount dashboard-admin <span class="token parameter variable">-n</span> kube-system
kubectl create clusterrolebinding dashboard-admin <span class="token parameter variable">--clusterrole</span><span class="token operator">=</span>cluster-admin <span class="token parameter variable">--serviceaccount</span><span class="token operator">=</span>kube-system:dashboard-admin
kubectl describe secrets <span class="token parameter variable">-n</span> kube-system <span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> kube-system get secret <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'/dashboard-admin/{print $1}'</span><span class="token variable">)</span></span>

<span class="token comment">#使用输出的token登录Dashboard</span>
https://NodeIP:30001
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/64a7f9644decc908a579de188546f5b5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">JSON.stringify()与JSON.parse()没有你想的那样简单</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/032c7afe97f873589894be1f96f8aaf8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">dvwa靶场通关（十一）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>