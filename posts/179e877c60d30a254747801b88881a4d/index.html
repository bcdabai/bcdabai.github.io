<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>史上最全pandas语法汇总，教你一文掌握pandas - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="史上最全pandas语法汇总，教你一文掌握pandas" />
<meta property="og:description" content="#!/usr/bin/env python # -*- coding: utf-8 -*- # @Author : honshaofeng # @Time : 2021/7/28 17:51 # @File : notes.py # @Project : tianjikit-master sklearn语法模块汇总 import matplotlib.pyplot as plt from sklearn import datasets from sklearn.model_selection import train_test_split,cross_val_score from sklearn.model_selection import GridSearchCV from sklearn.metrics import accuracy_score from xgboost import XGBClassifier from xgboost import plot_importance from sklearn.ensemble import RandomForestRegressor 【集成学习】sklearn中xgboost模块的XGBClassifier函数 # 常规参数 booster：gbtree时，树模型为基分类器（默认）；gbliner时， 线性模型为基分类器. silent ：silent=0时，不输出中间过程（默认）； silent=1时，输出中间过程. nthread： nthread=-1时，使用全部CPU进行并行运算（默认） nthread=1时，使用1个CPU进行运算。 scale_pos_weight：正样本的权重，在二分类任务中，当正负样本比例失衡时，设置正样本的权重，模型效果更好。例如，当正负样本比例为1:10时，scale_pos_weight=10。 # 模型参数 n_estimatores：总共迭代的次数，即决策树的个数 early_stopping_rounds ：含义：在验证集上，当连续n次迭代，分数没有提高后，提前终止训练。调参：防止overfitting。 max_depth：树的深度，默认值为6，典型值3-10。 调参：值越大，越容易过拟合；值越小，越容易欠拟合。 min_child_weight：默认值为1。 调参：值越大，越容易欠拟合；值越小，越容易过拟合（值较大时，避免模型学习到局部的特殊样本）。 subsample：训练每棵树时，使用的数据占全部训练集的比例。默认值为1，典型值为0." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/179e877c60d30a254747801b88881a4d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-07T16:57:36+08:00" />
<meta property="article:modified_time" content="2022-03-07T16:57:36+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">史上最全pandas语法汇总，教你一文掌握pandas</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <pre><code class="prism language-python"><span class="token comment">#!/usr/bin/env python</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token comment"># @Author   : honshaofeng</span>
<span class="token comment"># @Time     : 2021/7/28 17:51</span>
<span class="token comment"># @File     : notes.py</span>
<span class="token comment"># @Project  : tianjikit-master</span>

sklearn语法模块汇总
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">from</span> sklearn <span class="token keyword">import</span> datasets
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> train_test_split<span class="token punctuation">,</span>cross_val_score
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> GridSearchCV
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> accuracy_score
<span class="token keyword">from</span> xgboost <span class="token keyword">import</span> XGBClassifier
<span class="token keyword">from</span> xgboost <span class="token keyword">import</span> plot_importance
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>ensemble <span class="token keyword">import</span> RandomForestRegressor

【集成学习】sklearn中xgboost模块的XGBClassifier函数
<span class="token comment"># 常规参数</span>
booster：gbtree时，树模型为基分类器（默认）；gbliner时， 线性模型为基分类器<span class="token punctuation">.</span>
silent ：silent<span class="token operator">=</span><span class="token number">0</span>时，不输出中间过程（默认）； silent<span class="token operator">=</span><span class="token number">1</span>时，输出中间过程<span class="token punctuation">.</span>
nthread： nthread<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span>时，使用全部CPU进行并行运算（默认）  nthread<span class="token operator">=</span><span class="token number">1</span>时，使用<span class="token number">1</span>个CPU进行运算。
scale_pos_weight：正样本的权重，在二分类任务中，当正负样本比例失衡时，设置正样本的权重，模型效果更好。例如，当正负样本比例为<span class="token number">1</span><span class="token punctuation">:</span><span class="token number">10</span>时，scale_pos_weight<span class="token operator">=</span><span class="token number">10</span>。
<span class="token comment"># 模型参数</span>
n_estimatores：总共迭代的次数，即决策树的个数 
early_stopping_rounds ：含义：在验证集上，当连续n次迭代，分数没有提高后，提前终止训练。调参：防止overfitting。 
max_depth：树的深度，默认值为<span class="token number">6</span>，典型值<span class="token number">3</span><span class="token operator">-</span><span class="token number">10</span>。 调参：值越大，越容易过拟合；值越小，越容易欠拟合。
min_child_weight：默认值为<span class="token number">1</span>。 调参：值越大，越容易欠拟合；值越小，越容易过拟合（值较大时，避免模型学习到局部的特殊样本）。
subsample：训练每棵树时，使用的数据占全部训练集的比例。默认值为<span class="token number">1</span>，典型值为<span class="token number">0.5</span><span class="token operator">-</span><span class="token number">1</span>。调参：防止overfitting。
colsample_bytree：训练每棵树时，使用的特征占全部特征的比例。默认值为<span class="token number">1</span>，典型值为<span class="token number">0.5</span><span class="token operator">-</span><span class="token number">1</span>。调参：防止overfitting。
gamma：惩罚项系数，指定节点分裂所需的最小损失函数下降值。调参：alpha     L1正则化系数，默认为<span class="token number">1</span>
<span class="token keyword">lambda</span><span class="token punctuation">:</span> L2正则化系数，默认为<span class="token number">1</span>
<span class="token comment"># 学习任务参数</span>
learning_rate：学习率，控制每次迭代更新权重时的步长，默认<span class="token number">0.3</span>。调参：值越小，训练越慢。典型值为<span class="token number">0.01</span><span class="token operator">-</span><span class="token number">0.2</span>。<span class="token number">0.1</span>左右就很好。
objective 目标函数
回归任务
reg<span class="token punctuation">:</span>linear <span class="token punctuation">(</span>默认<span class="token punctuation">)</span>    reg<span class="token punctuation">:</span>logistic
二分类 binary<span class="token punctuation">:</span>logistic     概率  binary：logitraw   类别
多分类 multi：softmax  num_class<span class="token operator">=</span>n   返回类别 multi：softprob   num_class<span class="token operator">=</span>n  返回概率
rank<span class="token punctuation">:</span>pairwise eval_metric
回归任务<span class="token punctuation">(</span>默认rmse<span class="token punctuation">)</span> rmse<span class="token operator">-</span><span class="token operator">-</span>均方根误差  mae<span class="token operator">-</span><span class="token operator">-</span>平均绝对误差
分类任务<span class="token punctuation">(</span>默认error<span class="token punctuation">)</span> auc<span class="token operator">-</span><span class="token operator">-</span>roc曲线下面积    error<span class="token operator">-</span><span class="token operator">-</span>错误率（二分类）   merror<span class="token operator">-</span><span class="token operator">-</span>错误率（多分类）
logloss<span class="token operator">-</span><span class="token operator">-</span>负对数似然函数（二分类） mlogloss<span class="token operator">-</span><span class="token operator">-</span>负对数似然函数（多分类）

data <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'label'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                         <span class="token string">'pred'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">,</span> <span class="token number">0.8</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0.9</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment"># 0.83</span>
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">from</span> psi <span class="token keyword">import</span> psi
on <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'idcard_md5'</span><span class="token punctuation">,</span> <span class="token string">'phone_md5'</span><span class="token punctuation">,</span> <span class="token string">'loan_dt'</span><span class="token punctuation">]</span>        on <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'idcard'</span><span class="token punctuation">,</span> <span class="token string">'phone'</span><span class="token punctuation">,</span> <span class="token string">'loan_dt'</span><span class="token punctuation">]</span>
<span class="token comment"># print格式化输出  </span>
小数： <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'percent: %.2f'</span><span class="token operator">%</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token operator">/</span><span class="token number">50</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'percent: {:.2f}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token operator">/</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
百分数： <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'percent: {:.2%}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token operator">/</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'percent: {:.2f}%'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token operator">/</span><span class="token number">50</span><span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token comment"># pycharm:ctrl+shift+e:默认为总项目路径：'E:\\rong360'</span>
<span class="token comment"># 新建列，同时命名</span>
dfpsi <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token punctuation">[</span>np<span class="token punctuation">.</span>nan<span class="token punctuation">]</span><span class="token punctuation">,</span> columns<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'psi'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">#新建表</span>
df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">,</span> columns<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'A'</span><span class="token punctuation">,</span> <span class="token string">'B'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>data<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'Apple'</span><span class="token punctuation">,</span><span class="token string">'Banana'</span><span class="token punctuation">,</span><span class="token string">'Cherry'</span><span class="token punctuation">,</span><span class="token string">'Dates'</span><span class="token punctuation">,</span> <span class="token string">'Eggfruit'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> index <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span>columns<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'Fruits'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>fruits_list<span class="token punctuation">)</span>
pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token string">'Fruits'</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'Apple'</span><span class="token punctuation">,</span><span class="token string">'Banana'</span><span class="token punctuation">,</span><span class="token string">'Cherry'</span><span class="token punctuation">,</span><span class="token string">'Dates'</span><span class="token punctuation">,</span><span class="token string">'Eggfruit'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'Quantity'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token string">'Color'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'Red'</span><span class="token punctuation">,</span> <span class="token string">'Yellow'</span><span class="token punctuation">,</span> <span class="token string">'Red'</span><span class="token punctuation">,</span> <span class="token string">'Brown'</span><span class="token punctuation">,</span> <span class="token string">'Yellow'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment"># 读取文件</span>
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
df <span class="token operator">=</span>pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'zhongxin_1206.txt'</span><span class="token punctuation">,</span>sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">)</span>      df <span class="token operator">=</span>pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'zhongxin_1206.txt'</span><span class="token punctuation">,</span>sep<span class="token operator">=</span><span class="token string">','</span><span class="token punctuation">)</span>      fruits <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_excel<span class="token punctuation">(</span><span class="token string">'fruits.xlsx'</span><span class="token punctuation">,</span>sheet_name<span class="token operator">=</span><span class="token string">'Sheet1'</span><span class="token punctuation">)</span>
df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>path<span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">','</span><span class="token punctuation">,</span> names<span class="token operator">=</span>columns_name<span class="token punctuation">)</span>  <span class="token comment"># 读取文件的同时重命名列名</span>
<span class="token comment"># 读取无表头的文件</span>
ranking_name <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'idcard_md5'</span><span class="token punctuation">,</span> <span class="token string">'phone_md5'</span><span class="token punctuation">,</span> <span class="token string">'loan_dt'</span><span class="token punctuation">,</span> <span class="token string">'score'</span><span class="token punctuation">,</span> <span class="token string">'resource_id'</span><span class="token punctuation">,</span> <span class="token string">'customer'</span><span class="token punctuation">,</span> <span class="token string">'feature_new'</span><span class="token punctuation">]</span>
df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'rong360v1_20210815.txt'</span><span class="token punctuation">,</span> header<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> names<span class="token operator">=</span>ranking_name<span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">)</span>
<span class="token comment"># 读取指定列usecols</span>
df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'rong360_fq1_10w.txt'</span><span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">,</span>usecols<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'idcard_md5'</span><span class="token punctuation">,</span> <span class="token string">'phone_md5'</span><span class="token punctuation">,</span> <span class="token string">'loan_dt'</span><span class="token punctuation">,</span><span class="token string">'n21_score'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">"1217_1out.csv"</span><span class="token punctuation">,</span>usecols<span class="token operator">=</span><span class="token punctuation">[</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment">#按列切分!</span>
<span class="token comment"># 读取前5行</span>
data <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'data.csv'</span><span class="token punctuation">,</span>nrows <span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token comment"># 取某几列</span>
df <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'idcard_md5'</span><span class="token punctuation">,</span> <span class="token string">'phone_md5'</span><span class="token punctuation">,</span> <span class="token string">'loan_dt'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 要加中括号，不然报错，一次多列要多加个中括号！</span>
<span class="token comment"># 转为df</span>
pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>miss_data1<span class="token punctuation">,</span> index<span class="token operator">=</span>list_score1，columns<span class="token operator">=</span> <span class="token string">'shape'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token comment"># 保留4位小数</span>
<span class="token comment"># df保存为csv</span>
df<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string">'zhongxin_1208.txt'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">,</span>encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
<span class="token comment"># 重命名列名</span>
df<span class="token punctuation">.</span>rename<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">'order'</span><span class="token punctuation">:</span> <span class="token string">'id'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
df <span class="token operator">=</span> df<span class="token punctuation">.</span>rename<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"TianJin"</span><span class="token punctuation">:</span> <span class="token string">"tj"</span><span class="token punctuation">,</span> <span class="token string">"ShangHai"</span><span class="token punctuation">:</span> <span class="token string">"sh"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> columns<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"a"</span><span class="token punctuation">:</span> <span class="token string">"A"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  
df <span class="token operator">=</span> df<span class="token punctuation">.</span>rename<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"n21_score"</span><span class="token punctuation">:</span> <span class="token string">"n21_score_tmp"</span><span class="token punctuation">,</span> <span class="token string">"n21_score_new_empty"</span><span class="token punctuation">:</span> <span class="token string">"n21_score"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
df <span class="token operator">=</span> df<span class="token punctuation">.</span>rename<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token keyword">lambda</span> c<span class="token punctuation">:</span> c <span class="token operator">+</span> <span class="token string">"_test"</span><span class="token punctuation">)</span>
df <span class="token operator">=</span> df<span class="token punctuation">.</span>rename<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"name_sha256"</span><span class="token punctuation">:</span> <span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"identity_id_sha256"</span><span class="token punctuation">:</span> <span class="token string">"idcard"</span><span class="token punctuation">,</span><span class="token string">"phone_sha256"</span><span class="token punctuation">:</span><span class="token string">"phone"</span><span class="token punctuation">,</span><span class="token string">"apply_dt"</span><span class="token punctuation">:</span> <span class="token string">"loan_dt"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment"># 删除行或列</span>
df<span class="token punctuation">.</span>drop<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'phone'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
df <span class="token operator">=</span> df<span class="token punctuation">.</span>drop<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token string">'A'</span><span class="token punctuation">)</span>  <span class="token comment"># 删除columns为A的列</span>
df<span class="token punctuation">.</span>drop<span class="token punctuation">(</span>df<span class="token punctuation">.</span>index<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># 删除第1行</span>
df<span class="token punctuation">.</span>drop<span class="token punctuation">(</span>df<span class="token punctuation">.</span>columns<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># 删除第1列</span>
df<span class="token punctuation">.</span>drop<span class="token punctuation">(</span>df<span class="token punctuation">.</span>columns<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># 删除前3列</span>
df<span class="token punctuation">.</span>drop<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'label_x'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># axis=0默认行，axis=1为删除列</span>
df <span class="token operator">=</span> df_new<span class="token punctuation">.</span>drop<span class="token punctuation">(</span>df<span class="token punctuation">[</span>df<span class="token punctuation">.</span>label <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>index<span class="token punctuation">)</span> <span class="token comment"># df = df.drop(df[(df.score &lt; 50) &amp; (df.score &gt; 20)].index)</span>
df<span class="token punctuation">.</span>drop<span class="token punctuation">(</span>df<span class="token punctuation">.</span>columns<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token comment"># dt.columns[[0, 4, 8]] 直接使用索引查找列</span>
<span class="token keyword">del</span> df<span class="token punctuation">[</span><span class="token string">'密度'</span><span class="token punctuation">]</span> <span class="token comment"># 使用del, 一次只能删除一列，不能一次删除多列, del df[['密度', '含糖率']] 报错</span>
<span class="token comment"># 去重</span>
df<span class="token punctuation">.</span>drop_duplicates<span class="token punctuation">(</span>subset<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span><span class="token string">'idcard'</span><span class="token punctuation">,</span><span class="token string">'phone'</span><span class="token punctuation">,</span><span class="token string">'loan_dt'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># 默认保留第一次出现的重复项</span>
df<span class="token punctuation">.</span>drop_duplicates<span class="token punctuation">(</span>subset<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span><span class="token string">'idcard_md5'</span><span class="token punctuation">,</span><span class="token string">'phone_md5'</span><span class="token punctuation">,</span><span class="token string">'loan_dt'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
df<span class="token punctuation">.</span>drop_duplicates<span class="token punctuation">(</span>subset<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'A'</span><span class="token punctuation">,</span><span class="token string">'B'</span><span class="token punctuation">,</span><span class="token string">'C'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>keep<span class="token operator">=</span>Fasle<span class="token punctuation">,</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token comment"># 删除所有重复项。</span>
<span class="token comment"># 去除空值大于5个的列</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>df<span class="token punctuation">.</span>dropna<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token string">'columns'</span><span class="token punctuation">,</span> thresh<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># 排序</span>
df<span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span>by<span class="token operator">=</span><span class="token string">'排序字段'</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> ascending<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> na_position<span class="token operator">=</span><span class="token string">'last'</span><span class="token punctuation">)</span> <span class="token comment"># 升序</span>
df<span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span>by<span class="token operator">=</span><span class="token string">'loan_dt'</span><span class="token punctuation">,</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>ascending<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>  <span class="token comment">#降序</span>
<span class="token comment"># 重置索引reset_index</span>
df <span class="token operator">=</span> df<span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span>by<span class="token operator">=</span><span class="token string">'y_pred'</span><span class="token punctuation">)</span> <span class="token comment"># 排序后顺序是乱的，</span>
df <span class="token operator">=</span> df<span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span>drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token comment">#顺序连续了。drop不要原来乱序的索引</span>
result <span class="token operator">=</span> result<span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span>drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># 索引由01210123变为0-10，如果不进行reset_index(drop=True)，index会变得不连续。</span>
<span class="token comment"># 去空，有一个空，就删除该行</span>
df<span class="token punctuation">.</span>dropna<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> how<span class="token operator">=</span><span class="token string">'any'</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token comment"># merge合并取交集。columns会outer，列会inner</span>
df <span class="token operator">=</span> pd<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>df1<span class="token punctuation">,</span>df2<span class="token punctuation">,</span> how<span class="token operator">=</span><span class="token string">'inner'</span><span class="token punctuation">,</span> on<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'idcard'</span><span class="token punctuation">,</span> <span class="token string">'phone'</span><span class="token punctuation">,</span> <span class="token string">'loan_dt'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  
df<span class="token operator">=</span>df1<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>df2<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'query_name'</span><span class="token punctuation">,</span><span class="token string">'query_iden_num'</span><span class="token punctuation">,</span><span class="token string">'query_mbl_num'</span><span class="token punctuation">,</span><span class="token string">'etl_dt'</span><span class="token punctuation">,</span> <span class="token string">'credit_score'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>left_on<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'name-正常'</span><span class="token punctuation">,</span><span class="token string">'iden_num-正常'</span><span class="token punctuation">,</span><span class="token string">'phone_num-正常'</span><span class="token punctuation">,</span><span class="token string">'etl_dt-正常'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>right_on<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'query_name'</span><span class="token punctuation">,</span><span class="token string">'query_iden_num'</span><span class="token punctuation">,</span><span class="token string">'query_mbl_num'</span><span class="token punctuation">,</span><span class="token string">'etl_dt'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>how<span class="token operator">=</span><span class="token string">'left'</span><span class="token punctuation">)</span>
<span class="token comment"># 不同类型转数字</span>
df_inner<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'score2'</span><span class="token punctuation">,</span><span class="token string">'score'</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> df_inner<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'score2'</span><span class="token punctuation">,</span> <span class="token string">'score'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>pd<span class="token punctuation">.</span>to_numeric<span class="token punctuation">,</span> errors<span class="token operator">=</span><span class="token string">'ignore'</span><span class="token punctuation">)</span>
<span class="token comment"># DataFrame类型与Numpy中array数组类型转换</span>
test_x <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>df_test_x<span class="token punctuation">)</span>  <span class="token comment"># 去掉了索引！效果等同于打df.values,或者df.as_matrix()</span>
df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>test_x<span class="token punctuation">)</span>  <span class="token comment"># array转化成dataframe</span>
<span class="token comment"># iloc</span>
train<span class="token punctuation">,</span> test <span class="token operator">=</span> res<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">90131</span><span class="token punctuation">]</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token number">90131</span><span class="token punctuation">:</span><span class="token punctuation">]</span>  <span class="token comment"># 按行</span>
test <span class="token operator">=</span> N_data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token number">45000</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'n30_hj_score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to_list<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#iloc之后df变列表  # 行索引，列名称。</span>
df<span class="token punctuation">.</span>loc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">]</span><span class="token operator">=</span> df<span class="token punctuation">.</span>loc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">]</span> <span class="token comment"># 等价于data.iloc[:, 0] </span>
df<span class="token punctuation">[</span><span class="token string">'sum'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>df<span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">,</span><span class="token string">'y'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 将x&gt;0的xy两列求和，没有求和的则为空值，可用0填充。df['sum'].fillna(0, inplace=True)</span>
<span class="token comment">#loc</span>
df<span class="token punctuation">.</span>loc<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'f'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 不能索引，只能名称。</span>
<span class="token comment">#按索引取指定行列</span>
df <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> 
<span class="token comment"># 查看数据的分布，唯一值</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'month:'</span><span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'loan_dt'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">str</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">.</span>unique<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># 统计个数</span>
df<span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value_counts<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#查看某列缺失个数及缺失率</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>df_raw<span class="token punctuation">[</span><span class="token string">'v30_dz_huisuV'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 4423</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Vscore缺失率'</span><span class="token punctuation">,</span><span class="token string">'{:.2%}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>df_raw<span class="token punctuation">[</span><span class="token string">'v30_dz_huisuV'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">/</span> df_raw<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token comment">## 删除异常值，记得重置索引。</span>
df_train<span class="token punctuation">.</span>drop<span class="token punctuation">(</span>df_train<span class="token punctuation">[</span><span class="token punctuation">(</span>df_train<span class="token punctuation">[</span><span class="token string">'OverallQual'</span><span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>df_train<span class="token punctuation">[</span><span class="token string">'SalePrice'</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token number">200000</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>index<span class="token punctuation">,</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
df_data <span class="token operator">=</span> df_data<span class="token punctuation">[</span>df_data<span class="token punctuation">[</span><span class="token string">'loanamount'</span><span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token number">1000000</span><span class="token punctuation">]</span> 
<span class="token comment"># 满足条件即替换为对应的值。将sl列替换为flag，如果满足flag=1，就用sl——new。</span>
df<span class="token punctuation">[</span><span class="token string">'sl'</span><span class="token punctuation">]</span><span class="token operator">=</span>df<span class="token punctuation">[</span><span class="token string">'sl'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mask<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'flag'</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">1</span>，df<span class="token punctuation">[</span><span class="token string">'sl_new'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
df<span class="token punctuation">[</span><span class="token string">'flag'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span>
df<span class="token operator">=</span><span class="token punctuation">[</span>df<span class="token punctuation">[</span><span class="token string">'flag'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>notnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token comment">#select_dtypes  挑选字符型变量列。</span>
df<span class="token punctuation">.</span>select_dtypes<span class="token punctuation">(</span>include<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'float64'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># 深拷贝，深复制。对副本的数据或索引的修改不会反映在原始对象中</span>
df_all <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'idcard'</span><span class="token punctuation">,</span> <span class="token string">'phone'</span><span class="token punctuation">,</span><span class="token string">'idcard_rsa'</span><span class="token punctuation">,</span><span class="token string">'phone_rsa'</span><span class="token punctuation">,</span><span class="token string">'loan_dt'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>copy<span class="token punctuation">(</span>deep<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
df_all <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'idcard'</span><span class="token punctuation">,</span> <span class="token string">'phone'</span><span class="token punctuation">,</span><span class="token string">'idcard_rsa'</span><span class="token punctuation">,</span><span class="token string">'phone_rsa'</span><span class="token punctuation">,</span><span class="token string">'loan_dt'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 默认是深拷贝，同上法一致。</span>
<span class="token comment"># 行拼接，记得提前去重，且保证四要素及特征对齐。</span>
df<span class="token operator">=</span>pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>df1<span class="token punctuation">,</span> df2<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># 列拼接</span>
df<span class="token operator">=</span>pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>df1<span class="token punctuation">,</span> df2<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
df_igno_idx <span class="token operator">=</span> pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>df_aa<span class="token punctuation">,</span>df_zz<span class="token punctuation">]</span><span class="token punctuation">,</span> ignore_index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># 重置索引，类似于pd.concat([df1,df2]).reset_index(drop=True))</span>
<span class="token comment"># 插入新的一列insert，防止出错，长度不对。</span>
V_test<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'n30_hj_score_new'</span><span class="token punctuation">,</span> res<span class="token punctuation">,</span> allow_duplicates<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># 插入到主键后面。可行！</span>
<span class="token comment"># 随机取样，固定种子</span>
V_N_data1 <span class="token operator">=</span> df_raw<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>n<span class="token operator">=</span>df_raw<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">5000</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment"># df.replace 字符串替换</span>
df<span class="token punctuation">[</span><span class="token string">'feature_new'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\\N'</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>nan<span class="token punctuation">,</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
df<span class="token punctuation">[</span><span class="token string">'feature_new'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"%"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">"float"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
items_df<span class="token punctuation">[</span><span class="token string">"Cost"</span><span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>to_numeric<span class="token punctuation">(</span>items_df<span class="token punctuation">[</span><span class="token string">"Cost"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">str</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'$'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 转换为数字类型的同时将$去掉。</span>
result<span class="token punctuation">[</span><span class="token string">'prediction'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">870</span><span class="token punctuation">,</span><span class="token number">870</span><span class="token punctuation">,</span><span class="token number">880</span><span class="token punctuation">,</span><span class="token number">898</span><span class="token punctuation">,</span><span class="token number">1300</span><span class="token punctuation">,</span><span class="token number">13117</span><span class="token punctuation">,</span><span class="token number">13298</span><span class="token punctuation">,</span><span class="token number">13690</span><span class="token punctuation">,</span><span class="token number">13691</span><span class="token punctuation">]</span><span class="token punctuation">,</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token comment">#写成数组的值，分别替换</span>
data<span class="token punctuation">[</span><span class="token string">'v'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"\\N"</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">'0'</span><span class="token punctuation">,</span><span class="token string">'None'</span><span class="token punctuation">,</span><span class="token string">'null'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>np<span class="token punctuation">.</span>nan<span class="token punctuation">,</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># 一键替换所有空字符串类型的字符。</span>
<span class="token comment"># replace多种用法：</span>
s<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>       df<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>     df<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">}</span><span class="token punctuation">)</span> df<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'A'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">:</span> <span class="token number">400</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment"># 正则表达式 df.replace(to_replace=r'^ba.$', value='new', regex=True) # 匹配表格整个字符串ba.，替换为new！</span>
df<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'A'</span><span class="token punctuation">:</span> r<span class="token string">'^ba.$'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token string">'A'</span><span class="token punctuation">:</span> <span class="token string">'new'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> regex<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token comment"># 匹配表格A列整个字符串ba.，替换为new！</span>
df<span class="token punctuation">.</span>replace<span class="token punctuation">(</span>regex<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>r<span class="token string">'^ba.$'</span><span class="token punctuation">:</span> <span class="token string">'new'</span><span class="token punctuation">,</span> <span class="token string">'foo'</span><span class="token punctuation">:</span> <span class="token string">'xyz'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
df<span class="token punctuation">.</span>replace<span class="token punctuation">(</span>regex<span class="token operator">=</span><span class="token punctuation">[</span>r<span class="token string">'^ba.$'</span><span class="token punctuation">,</span> <span class="token string">'foo'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> value<span class="token operator">=</span><span class="token string">'new'</span><span class="token punctuation">)</span>
<span class="token comment"># https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.replace.html?highlight=replace#pandas.DataFrame.replace</span>

<span class="token comment"># notnull()取出非空值！</span>
fq1 <span class="token operator">=</span> fq1<span class="token punctuation">[</span>fq1<span class="token punctuation">[</span><span class="token string">'phone_md5'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>notnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token comment"># .isin() 条件筛选，适合单列判断,多列一起无法保证同时四要素的。</span>
df <span class="token operator">=</span> df<span class="token punctuation">[</span>df<span class="token punctuation">[</span><span class="token string">'feature_new'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'\\N'</span><span class="token punctuation">]</span>
df<span class="token punctuation">.</span>drop<span class="token punctuation">(</span>index<span class="token operator">=</span>df<span class="token punctuation">[</span>df<span class="token punctuation">[</span><span class="token string">'A'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isin<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>index<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 删除包含4的行</span>
df<span class="token punctuation">.</span>drop<span class="token punctuation">(</span>index<span class="token operator">=</span>df<span class="token punctuation">[</span>df<span class="token punctuation">[</span><span class="token string">'A'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>index<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 删除包含4的行</span>
df<span class="token punctuation">[</span>df<span class="token punctuation">.</span>isin<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'D'</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'E'</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'aa'</span><span class="token punctuation">,</span><span class="token string">'cc'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token comment"># 多条件筛选 ，和&amp;应该是一样的？</span>
df<span class="token punctuation">[</span>df<span class="token punctuation">.</span>isin<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'D'</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'E'</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'aa'</span><span class="token punctuation">,</span><span class="token string">'cc'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span> 
<span class="token comment">#日期格式化 apply  </span>
<span class="token keyword">import</span> datetime
df<span class="token punctuation">[</span><span class="token string">'loan_dt'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>to_datetime<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'loan_dt'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span>x<span class="token punctuation">,</span><span class="token string">"%Y-%m-%d"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#日期格式化</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>df<span class="token punctuation">.</span>Math_B<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">x</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> a <span class="token operator">-</span> b
df<span class="token punctuation">[</span><span class="token string">'d - a'</span><span class="token punctuation">]</span>  <span class="token operator">=</span> df<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> f<span class="token punctuation">:</span> x<span class="token punctuation">(</span>f<span class="token punctuation">[</span><span class="token string">'d'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>f<span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 涉及2列数据的多个值比较和处理！！！</span>
<span class="token comment"># 数字类型转字符串，字符串转int</span>
employees_df<span class="token punctuation">[</span><span class="token string">"Age"</span><span class="token punctuation">]</span><span class="token operator">=</span>employees_df<span class="token punctuation">[</span><span class="token string">"Age"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">)</span>  
df<span class="token punctuation">[</span><span class="token string">'HIS_DW_DATE'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'HIS_DW_DATE'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
df<span class="token punctuation">[</span><span class="token string">'Full Name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'First'</span><span class="token punctuation">,</span> <span class="token string">'Last'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">.</span>join<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment">#拼接两列字符</span>
df<span class="token punctuation">[</span><span class="token string">'Full Name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'First'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">str</span><span class="token punctuation">.</span>cat<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'Last'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>sep<span class="token operator">=</span><span class="token string">" "</span><span class="token punctuation">)</span>  <span class="token comment">#拼接两列字符</span>
df<span class="token punctuation">[</span><span class="token string">'Full Name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'First'</span><span class="token punctuation">,</span> <span class="token string">'Last'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>agg<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">.</span>join<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment">#拼接两列字符</span>

df<span class="token punctuation">[</span>df<span class="token punctuation">.</span>label<span class="token punctuation">.</span><span class="token builtin">str</span><span class="token punctuation">.</span>startwith<span class="token punctuation">(</span><span class="token string">'199'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment"># 取出字符串以199开头的df</span>
df<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment">#按列</span>
df<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>sqrt<span class="token punctuation">)</span> <span class="token comment">#按行</span>
<span class="token comment">#保留以e结尾或开头的列。保留满足某条件的列。</span>
df<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>regex<span class="token operator">=</span><span class="token string">'e$'</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  
df<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>regex<span class="token operator">=</span><span class="token string">'^e'</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
df<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>like<span class="token operator">=</span><span class="token string">'201'</span>，axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment"># columns which has letter 'a' or 'A' in its name. </span>
df<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>regex <span class="token operator">=</span><span class="token string">'[aA]'</span><span class="token punctuation">)</span> 
<span class="token comment">#删除以e结尾或开头的列。三种方法</span>
df <span class="token operator">=</span> df<span class="token punctuation">[</span>df<span class="token punctuation">.</span>columns<span class="token punctuation">.</span>drop<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>df<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>regex<span class="token operator">=</span><span class="token string">'e$'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
df<span class="token operator">=</span>df<span class="token punctuation">[</span><span class="token punctuation">[</span>c <span class="token keyword">for</span> c <span class="token keyword">in</span> df<span class="token punctuation">.</span>columns <span class="token keyword">if</span> c<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'e'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
df<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token operator">not</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">'Test\d+'</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment">#选择包含‘bbi’的行。</span>
df<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>like<span class="token operator">=</span><span class="token string">'bbi'</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token comment">#map</span>
data<span class="token punctuation">[</span><span class="token string">'result'</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'result'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>lstrip<span class="token punctuation">(</span><span class="token string">'+-'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rstrip<span class="token punctuation">(</span><span class="token string">'aAbBcC'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
最后一个字符：data<span class="token punctuation">[</span><span class="token string">'result'</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'result'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
前两个字符：data<span class="token punctuation">[</span><span class="token string">'result'</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'result'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
data<span class="token punctuation">[</span><span class="token string">'result'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span>regex<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>to_replace<span class="token operator">=</span>r<span class="token string">'\D'</span><span class="token punctuation">,</span>value<span class="token operator">=</span>r<span class="token string">''</span><span class="token punctuation">)</span>
<span class="token comment">#dict.get() # </span>
<span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">'Salary: %s'</span> <span class="token operator">%</span> tinydict<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'Salary'</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 拿到就返回对应value，没拿到就返回0.0</span>
<span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">'Salary: %s'</span> <span class="token operator">%</span> tinydict<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'Salary'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">#  # 拿到就返回对应value，没拿到就返回None</span>
<span class="token comment"># 时间格式转换</span>
temp<span class="token punctuation">[</span><span class="token string">'year'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>to_datetime<span class="token punctuation">(</span>temp<span class="token punctuation">[</span><span class="token string">'Date'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>dt<span class="token punctuation">.</span>year
<span class="token comment">#unique</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>data_te<span class="token punctuation">[</span><span class="token string">'v30_dz'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>unique<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data_te<span class="token punctuation">[</span><span class="token string">'n30_hj_score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>unique<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data_te<span class="token punctuation">[</span><span class="token string">'n30_hj_score_new'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>unique<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># 条件筛选isin，~取反，&amp;，|, map</span>
df <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token operator">~</span><span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'y2'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isin<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">|</span> df<span class="token punctuation">[</span><span class="token string">'y1'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isin<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">|</span> df<span class="token punctuation">[</span><span class="token string">'y3'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isin<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">|</span> df<span class="token punctuation">[</span><span class="token string">'y4'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isin<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
V_test <span class="token operator">=</span> V_N_raw<span class="token punctuation">[</span><span class="token operator">~</span>V_N_raw<span class="token punctuation">[</span><span class="token string">'phone'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isin<span class="token punctuation">(</span>V_N_data<span class="token punctuation">[</span><span class="token string">'phone'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment">#取出手机号不在训练集中的表。</span>
df<span class="token punctuation">[</span><span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'month'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'2021-01'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shape
df<span class="token punctuation">[</span><span class="token punctuation">[</span>x<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'张'</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> df<span class="token punctuation">[</span><span class="token string">'姓名'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token comment"># df['姓名'].map(lambda x: x.startswith('张'))</span>
altered_series<span class="token operator">=</span>my_series<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">".00"</span><span class="token punctuation">)</span>  <span class="token comment"># 只适用于特定列，</span>
df <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'b'</span><span class="token punctuation">]</span><span class="token operator">&gt;=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
tmp <span class="token operator">=</span> tmp<span class="token punctuation">[</span>tmp<span class="token punctuation">[</span><span class="token string">'year'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isin<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1950</span><span class="token punctuation">,</span> <span class="token number">1960</span><span class="token punctuation">,</span> <span class="token number">1970</span><span class="token punctuation">,</span> <span class="token number">1980</span><span class="token punctuation">,</span> <span class="token number">1990</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">,</span> <span class="token number">2010</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token comment"># 选择几年的数据展示</span>
<span class="token comment"># groupby分组，map</span>
groups <span class="token operator">=</span> df<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span>by<span class="token operator">=</span><span class="token string">'month'</span><span class="token punctuation">)</span> <span class="token comment"># 每一组都是df。</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>groups<span class="token punctuation">.</span>get_group<span class="token punctuation">(</span><span class="token string">'2021-05'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
agg <span class="token operator">=</span> groups<span class="token punctuation">[</span><span class="token string">'n21_score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>agg<span class="token punctuation">(</span><span class="token punctuation">[</span>np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">,</span> np<span class="token punctuation">.</span>std<span class="token punctuation">]</span><span class="token punctuation">)</span>
groups <span class="token operator">=</span> df<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'Team'</span><span class="token punctuation">)</span>
score <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> x<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> x<span class="token punctuation">.</span>std<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">10</span>
<span class="token keyword">print</span> <span class="token punctuation">(</span>groups<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>score<span class="token punctuation">)</span><span class="token punctuation">)</span>
df<span class="token operator">=</span> df<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'Team'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token builtin">len</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">3</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> name<span class="token punctuation">,</span> group <span class="token keyword">in</span> groups<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>group<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'{:.2%}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>group<span class="token punctuation">[</span><span class="token string">'n21_score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">/</span>group<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 2.28%</span>
    
target_mean_dict <span class="token operator">=</span> df_train<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span>col<span class="token punctuation">)</span><span class="token punctuation">[</span>target_col<span class="token punctuation">]</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># group转为字典。</span>
df_val<span class="token punctuation">[</span>f<span class="token string">'{col}_mean_target'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df_val<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>target_mean_dict<span class="token punctuation">)</span>  <span class="token comment"># 变量参与命名！</span>
y_true<span class="token punctuation">,</span> y_pred <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>y_true<span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>y_pred<span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># -1自动补齐shape，自动计算得出新的矩阵需要多少行</span>
df<span class="token punctuation">[</span><span class="token string">'data'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>groupby<span class="token punctuation">(</span>time_list<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 按月份求和</span>
<span class="token comment"># np.where,找出同时为空的两列个数np.nan</span>
res <span class="token operator">=</span> <span class="token punctuation">(</span>np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>np<span class="token punctuation">.</span>isnan<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'n30_hj_score_new_empty'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> np<span class="token punctuation">.</span>isnan<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'cy20_hj_score'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#满足为1，不满足为0.</span>
<span class="token comment"># 筛选需要填充的列，筛选存在缺失值的列</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>df<span class="token punctuation">.</span>columns<span class="token punctuation">[</span>df<span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
full<span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>full<span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment"># 查看有缺失值的。</span>
<span class="token comment"># 空值填充，用列均值进行填充缺失值NaN</span>
<span class="token keyword">for</span> column <span class="token keyword">in</span> <span class="token builtin">list</span><span class="token punctuation">(</span>df<span class="token punctuation">.</span>columns<span class="token punctuation">[</span>df<span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    df<span class="token punctuation">[</span>column<span class="token punctuation">]</span><span class="token punctuation">.</span>fillna<span class="token punctuation">(</span>df<span class="token punctuation">[</span>column<span class="token punctuation">]</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

ages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">27</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">37</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">,</span> <span class="token number">61</span><span class="token punctuation">,</span> <span class="token number">45</span><span class="token punctuation">,</span> <span class="token number">41</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">,</span>bins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span>
<span class="token comment"># 返回的是一个特殊的Categorical对象 → 一组表示面元名称的字符串</span>
cats <span class="token operator">=</span> pd<span class="token punctuation">.</span>cut<span class="token punctuation">(</span>ages<span class="token punctuation">,</span> bins<span class="token punctuation">)</span>
pd<span class="token punctuation">.</span>cut<span class="token punctuation">(</span>df_f<span class="token punctuation">.</span>积分<span class="token punctuation">,</span>bins<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>labels<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"低"</span><span class="token punctuation">,</span><span class="token string">"中"</span><span class="token punctuation">,</span><span class="token string">"高"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">#分成3箱并指定标签</span>
group_names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'Youth'</span><span class="token punctuation">,</span> <span class="token string">'YoungAdult'</span><span class="token punctuation">,</span> <span class="token string">'MiddleAged'</span><span class="token punctuation">,</span> <span class="token string">'Senior'</span><span class="token punctuation">]</span><span class="token comment">###打上标签</span>
cats1 <span class="token operator">=</span> pd<span class="token punctuation">.</span>cut<span class="token punctuation">(</span>ages<span class="token punctuation">,</span> bins<span class="token punctuation">,</span> labels<span class="token operator">=</span>group_names<span class="token punctuation">)</span>
aa <span class="token operator">=</span> pd<span class="token punctuation">.</span>value_counts<span class="token punctuation">(</span>cats<span class="token punctuation">)</span>  <span class="token comment"># 按照区间计数</span>
s <span class="token operator">=</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span>np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
cats <span class="token operator">=</span> pd<span class="token punctuation">.</span>qcut<span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>  <span class="token comment"># 按四分位数进行切割</span>
a <span class="token operator">=</span> pd<span class="token punctuation">.</span>value_counts<span class="token punctuation">(</span>cats<span class="token punctuation">)</span>
<span class="token comment">#np.where</span>
np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>condition<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token comment"># 满足条件(condition)，输出x，不满足输出y。</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span>train<span class="token punctuation">[</span><span class="token string">'loan_dt'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token punctuation">(</span>train<span class="token punctuation">[</span><span class="token string">'loan_dt'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 直接拿最开始和最后的日期，比较就可以！不用排序！</span>
<span class="token comment">#切分分箱</span>
 N_new1<span class="token punctuation">[</span><span class="token string">"N_range1"</span><span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>cut<span class="token punctuation">(</span>x<span class="token operator">=</span>N_new1<span class="token punctuation">[</span><span class="token string">"n21_score"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bins<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">,</span> <span class="token number">700</span><span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">,</span> <span class="token number">900</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># 按日期切分</span>
sep_date <span class="token operator">=</span> df1<span class="token punctuation">[</span><span class="token string">'loan_dt'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>df1<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">0.8</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment"># 取出切分的日期点！</span>
before <span class="token operator">=</span> df1<span class="token punctuation">[</span>df1<span class="token punctuation">[</span><span class="token string">'loan_dt'</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> sep_date<span class="token punctuation">]</span>  <span class="token comment"># 划分训练——测试集与oot集！，要么oot与test都有，要么只有oot！</span>
<span class="token comment"># 绘制每年的直方图，以年和平均温度分组，并使用'count'函数进行汇总</span>
temp <span class="token operator">=</span> temp<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'year'</span><span class="token punctuation">,</span> <span class="token string">'Mean_TemperatureC'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>agg<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'Mean_TemperatureC'</span><span class="token punctuation">:</span> <span class="token string">'count'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rename<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">'Mean_TemperatureC'</span><span class="token punctuation">:</span> <span class="token string">'count'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># np.isnan(np.nan) 不能用== 或者is！</span>
dftrain <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>train_data<span class="token punctuation">,</span> columns<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>dropna<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">)</span>
dftrain<span class="token punctuation">.</span>index <span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>dftrain<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">#utf-8解码</span>
df_test<span class="token punctuation">.</span>columns <span class="token operator">=</span> df_test<span class="token punctuation">.</span>columns<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span>x<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
features <span class="token operator">=</span> df_test<span class="token punctuation">[</span><span class="token punctuation">[</span>col <span class="token keyword">for</span> col <span class="token keyword">in</span> model<span class="token punctuation">.</span>features <span class="token keyword">if</span> col <span class="token keyword">in</span> df_test<span class="token punctuation">.</span>columns<span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token comment"># 取10位小数</span>
df_test<span class="token punctuation">[</span><span class="token string">'diff'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">round</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> df_test<span class="token punctuation">[</span><span class="token string">'diff'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token comment"># 判断类型，找出字符串，数字类型，便于处理。</span>
objectList<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
classList<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
numericalList<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> train_data<span class="token punctuation">.</span>columns<span class="token punctuation">:</span>
    <span class="token keyword">if</span> train_data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>dtype<span class="token operator">==</span><span class="token string">'O'</span><span class="token punctuation">:</span>
        objectList<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">list</span><span class="token punctuation">(</span>train_data<span class="token punctuation">.</span>select_dtypes<span class="token punctuation">(</span>exclude<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'object'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>columns<span class="token punctuation">)</span><span class="token punctuation">:</span>
    temp<span class="token operator">=</span>train_data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>unique<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">10</span><span class="token punctuation">:</span>
        classList<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        numericalList<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        
<span class="token comment">#使用LabelEncoder对等级变量进行处理</span>
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>preprocessing <span class="token keyword">import</span> LabelEncoder
le <span class="token operator">=</span> LabelEncoder<span class="token punctuation">(</span><span class="token punctuation">)</span>
df<span class="token punctuation">[</span><span class="token string">'OPBAL_FLAG'</span><span class="token punctuation">]</span><span class="token operator">=</span>le<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'OPBAL_FLAG'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
df<span class="token punctuation">[</span><span class="token string">'CLSBAL_FLAG'</span><span class="token punctuation">]</span><span class="token operator">=</span>le<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'CLSBAL_FLAG'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># psi的计算逻辑：分箱，频率，最终计算频率差。</span>
quantile_points <span class="token operator">=</span> <span class="token punctuation">[</span>dftrain<span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>ceil<span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>indexmax <span class="token operator">*</span> i<span class="token punctuation">)</span> <span class="token operator">/</span> parts<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> parts <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
cut_points <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span>quantile_points<span class="token punctuation">)</span><span class="token punctuation">.</span>drop_duplicates<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values<span class="token punctuation">)</span>  <span class="token comment"># 分箱后去重！得到分享结果</span>
train_frequencies <span class="token operator">=</span> __get_hist<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>dftrain<span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">)</span><span class="token punctuation">,</span> cut_points<span class="token punctuation">)</span>
psi_value <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span>testf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> trainf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> math<span class="token punctuation">.</span>log<span class="token punctuation">(</span>testf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">/</span> trainf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>testf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># 计算psi，同主键</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%.4f'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>psi<span class="token punctuation">(</span>df_inner<span class="token punctuation">[</span><span class="token string">'score'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> df_inner<span class="token punctuation">[</span><span class="token string">'score2'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># 直接调用CALPSI.py脚本算psi！</span>
result_psi2 <span class="token operator">=</span> psi_analysis<span class="token punctuation">(</span>n21_old_ls<span class="token punctuation">,</span> n21_new_ls<span class="token punctuation">,</span> parts<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result_psi2<span class="token punctuation">.</span>columns<span class="token punctuation">)</span>  <span class="token comment"># 4.65228805e-03</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result_psi2<span class="token punctuation">.</span>values<span class="token punctuation">)</span>
<span class="token comment"># 求相关系数</span>
corr_te <span class="token operator">=</span> data_te<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'n21_score_new'</span><span class="token punctuation">,</span> <span class="token string">'n21_score'</span><span class="token punctuation">,</span> <span class="token string">'v30_dz_huisuV'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>corr<span class="token punctuation">(</span>method<span class="token operator">=</span><span class="token string">'spearman'</span><span class="token punctuation">)</span>
df_corr <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>corr_te<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>df_corr<span class="token punctuation">)</span>
<span class="token comment"># 将字符串引号去除，保留数字</span>
<span class="token keyword">import</span> re
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>re<span class="token punctuation">.</span>split<span class="token punctuation">(</span>r<span class="token string">'[\"]?([0-9\.]*)[\"]?'</span><span class="token punctuation">,</span><span class="token string">'1151226468812.22'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>re<span class="token punctuation">.</span>split<span class="token punctuation">(</span>r<span class="token string">'[\"]?([0-9\.]*)[\"]?'</span><span class="token punctuation">,</span><span class="token string">'"1151226468812.22"'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> col <span class="token keyword">in</span> train<span class="token punctuation">.</span>select_dtypes<span class="token punctuation">(</span>include<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'object'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>columns<span class="token punctuation">:</span>  <span class="token comment"># 字符型列唯一值进行查看。</span>
    <span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">"Column {} has {} unique instances"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span> col<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>train<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">.</span>unique<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
matplotlib画图
<span class="token comment">#散点图，先设置字体</span>
plt<span class="token punctuation">.</span>rcParams<span class="token punctuation">[</span><span class="token string">'font.sans-serif'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'SimHei'</span><span class="token punctuation">]</span>  <span class="token comment"># 步骤一（替换sans-serif字体）</span>
plt<span class="token punctuation">.</span>rcParams<span class="token punctuation">[</span><span class="token string">'axes.unicode_minus'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">False</span>  <span class="token comment"># 步骤二（解决坐标轴负数的负号显示问题）</span>

fig1 <span class="token operator">=</span> plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dpi<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'HBXJ产品V和N_new关系散点图'</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token string">'xx-large'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>scatter<span class="token punctuation">(</span>v30_dz_huisuV_ls<span class="token punctuation">,</span> n21_new_ls<span class="token punctuation">,</span> s<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">'V'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'N_new'</span><span class="token punctuation">)</span>
<span class="token comment"># plt.xlim(250, 900)</span>
<span class="token comment"># plt.ylim(250, 900)</span>
corr_val <span class="token operator">=</span> <span class="token string">"%.6f"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>corr_te<span class="token punctuation">.</span>loc<span class="token punctuation">[</span><span class="token string">'n21_score_new'</span><span class="token punctuation">,</span> <span class="token string">'v30_dz_huisuV'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
font <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'family'</span><span class="token punctuation">:</span> <span class="token string">'serif'</span><span class="token punctuation">,</span> <span class="token string">'style'</span><span class="token punctuation">:</span> <span class="token string">'italic'</span><span class="token punctuation">,</span> <span class="token string">'weight'</span><span class="token punctuation">:</span> <span class="token string">'normal'</span><span class="token punctuation">,</span> <span class="token string">'color'</span><span class="token punctuation">:</span> <span class="token string">'red'</span><span class="token punctuation">,</span> <span class="token string">'size'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">}</span>
ax <span class="token operator">=</span> plt<span class="token punctuation">.</span>gca<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">0.8</span><span class="token punctuation">,</span> r<span class="token string">'Pearson: '</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>corr_val<span class="token punctuation">)</span><span class="token punctuation">,</span> fontdict<span class="token operator">=</span>font<span class="token punctuation">,</span> transform<span class="token operator">=</span>ax<span class="token punctuation">.</span>transAxes<span class="token punctuation">)</span>  <span class="token comment"># 采用归一化坐标确定text位置</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

corr_df <span class="token operator">=</span> employees_df<span class="token punctuation">.</span>corr<span class="token punctuation">(</span>method<span class="token operator">=</span><span class="token string">'pearson'</span><span class="token punctuation">)</span>
<span class="token comment"># 热力图1</span>
<span class="token keyword">import</span> seaborn <span class="token keyword">as</span> sns
plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sns<span class="token punctuation">.</span>heatmap<span class="token punctuation">(</span>corr_df<span class="token punctuation">,</span> annot<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 2</span>
corr_df <span class="token operator">=</span> employees_df<span class="token punctuation">.</span>corr<span class="token punctuation">(</span>method<span class="token operator">=</span><span class="token string">'pearson'</span><span class="token punctuation">)</span>
corr_df<span class="token punctuation">.</span>style<span class="token punctuation">.</span>background_gradient<span class="token punctuation">(</span>cmap<span class="token operator">=</span><span class="token string">'coolwarm'</span><span class="token punctuation">)</span>
<span class="token comment">#3</span>
plt<span class="token punctuation">.</span>matshow<span class="token punctuation">(</span>corr_df<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 核密度图</span>
<span class="token comment">#  画一起 ，不显示rug</span>
    fig6 <span class="token operator">=</span> plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dpi<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'HBXJ产品验证集N_old和N_new密度图'</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token string">'xx-large'</span><span class="token punctuation">)</span>
    p1 <span class="token operator">=</span> sns<span class="token punctuation">.</span>kdeplot<span class="token punctuation">(</span>data_te<span class="token punctuation">[</span><span class="token string">'n21_score'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> shade<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">"r"</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'n21_score'</span><span class="token punctuation">)</span>
    p1 <span class="token operator">=</span> sns<span class="token punctuation">.</span>kdeplot<span class="token punctuation">(</span>data_te<span class="token punctuation">[</span><span class="token string">'n21_score_new'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> shade<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">"b"</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'n21_score_new'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'density'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">'n21_score + n21_score_new'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span>loc<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token comment"># corr_val = "%.6f" % (corr_te.loc['score', 'score_new'])</span>
    psi <span class="token operator">=</span> <span class="token string">"%.6f"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>result_psi2<span class="token punctuation">.</span>values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    font <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'family'</span><span class="token punctuation">:</span> <span class="token string">'serif'</span><span class="token punctuation">,</span><span class="token string">'style'</span><span class="token punctuation">:</span> <span class="token string">'italic'</span><span class="token punctuation">,</span><span class="token string">'weight'</span><span class="token punctuation">:</span> <span class="token string">'normal'</span><span class="token punctuation">,</span><span class="token string">'color'</span><span class="token punctuation">:</span> <span class="token string">'red'</span><span class="token punctuation">,</span><span class="token string">'size'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">}</span>
    ax <span class="token operator">=</span> plt<span class="token punctuation">.</span>gca<span class="token punctuation">(</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.02</span><span class="token punctuation">,</span> <span class="token number">0.8</span><span class="token punctuation">,</span> r<span class="token string">'PSI: '</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>psi<span class="token punctuation">)</span><span class="token punctuation">,</span> fontdict<span class="token operator">=</span>font<span class="token punctuation">,</span> transform<span class="token operator">=</span>ax<span class="token punctuation">.</span>transAxes<span class="token punctuation">)</span>  <span class="token comment"># 采用归一化坐标确定 text 位置</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 数值变量查看，画子图。</span>
dis_cols<span class="token operator">=</span><span class="token number">6</span>
dist_rows<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">(</span>numericalList<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span>dis_cols<span class="token punctuation">,</span><span class="token number">4</span><span class="token operator">*</span>dist_rows<span class="token punctuation">)</span><span class="token punctuation">)</span>
i<span class="token operator">=</span><span class="token number">1</span>
<span class="token keyword">for</span> col <span class="token keyword">in</span> numericalList<span class="token punctuation">:</span>
    ax<span class="token operator">=</span>plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span>dist_rows<span class="token punctuation">,</span>dis_cols<span class="token punctuation">,</span>i<span class="token punctuation">)</span>
    ax<span class="token operator">=</span>sns<span class="token punctuation">.</span>kdeplot<span class="token punctuation">(</span>train_data<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">,</span>color<span class="token operator">=</span><span class="token string">'Red'</span><span class="token punctuation">,</span>shade<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    ax<span class="token operator">=</span>sns<span class="token punctuation">.</span>kdeplot<span class="token punctuation">(</span>test_data<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">,</span>color<span class="token operator">=</span><span class="token string">'Blue'</span><span class="token punctuation">,</span>shade<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    ax<span class="token punctuation">.</span>set_xlabel<span class="token punctuation">(</span>col<span class="token punctuation">)</span>
    ax<span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">"Frequency"</span><span class="token punctuation">)</span>
    ax<span class="token operator">=</span>ax<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"train"</span><span class="token punctuation">,</span><span class="token string">"test"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    i<span class="token operator">+=</span><span class="token number">1</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 拿到不同变量类型特征dtype</span>
<span class="token comment">#object的变量  ==&gt; objectList</span>
<span class="token comment">#numerical的变量==&gt;classList</span>
<span class="token comment">#连续变量 ==&gt;numericalList</span>
objectList<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
classList<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
numericalList<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> train_data<span class="token punctuation">.</span>columns<span class="token punctuation">:</span>
    <span class="token keyword">if</span> train_data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>dtype<span class="token operator">==</span><span class="token string">'O'</span><span class="token punctuation">:</span>
        objectList<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">list</span><span class="token punctuation">(</span>train_data<span class="token punctuation">.</span>select_dtypes<span class="token punctuation">(</span>exclude<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'object'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>columns<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 去除类型为对象的列，剩余数字（浮点和整数）及类别</span>
    temp<span class="token operator">=</span>train_data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>unique<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">10</span><span class="token punctuation">:</span>
        classList<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        numericalList<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
<span class="token comment"># 以下简单粗暴</span>
numerical_fea <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>train<span class="token punctuation">.</span>select_dtypes<span class="token punctuation">(</span>exclude<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'object'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>columns<span class="token punctuation">)</span>
category_fea <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>train<span class="token punctuation">.</span>select_dtypes<span class="token punctuation">(</span>include<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'object'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>columns<span class="token punctuation">)</span>      
<span class="token comment"># 字符串替换 </span>
data<span class="token punctuation">[</span><span class="token string">'employmentLength'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span>to_replace<span class="token operator">=</span><span class="token string">'10+ years'</span><span class="token punctuation">,</span> value<span class="token operator">=</span><span class="token string">'10 years'</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
data<span class="token punctuation">[</span><span class="token string">'employmentLength'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'&lt; 1 year'</span><span class="token punctuation">,</span> <span class="token string">'0 years'</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
data<span class="token punctuation">[</span><span class="token string">'earliesCreditLine'</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'earliesCreditLine'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> s<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># 画出缺失率的图，可以看出，train的缺失值还是不少的，但是占比不是很多。不过缺失值对于xgb，lgb等树模型来说可以直接空缺，树模型会自己优化，要是用别的模型还是要处理的。</span>
missing <span class="token operator">=</span> train<span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
missing <span class="token operator">=</span> missing<span class="token punctuation">[</span>missing <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">]</span>
missing_rate <span class="token operator">=</span> missing<span class="token operator">/</span><span class="token builtin">len</span><span class="token punctuation">(</span>train<span class="token punctuation">)</span>
missing_rate<span class="token punctuation">.</span>plot<span class="token punctuation">.</span>bar<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">### 统计数据集缺失情况</span>
missingDf <span class="token operator">=</span> data<span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span>ascending<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span><span class="token punctuation">)</span>
missingDf<span class="token punctuation">.</span>columns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'feature'</span><span class="token punctuation">,</span> <span class="token string">'miss_num'</span><span class="token punctuation">]</span>    
missingDf<span class="token punctuation">[</span><span class="token string">'miss_percentage'</span><span class="token punctuation">]</span> <span class="token operator">=</span> missingDf<span class="token punctuation">[</span><span class="token string">'miss_num'</span><span class="token punctuation">]</span> <span class="token operator">/</span> data<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    <span class="token comment"># 缺失值比例</span>

<span class="token comment"># 去除只有1个值的特征！</span>
one_value_fea <span class="token operator">=</span> <span class="token punctuation">[</span>col <span class="token keyword">for</span> col <span class="token keyword">in</span> train<span class="token punctuation">.</span>columns <span class="token keyword">if</span> train<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">.</span>nunique<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">]</span>
<span class="token comment"># 'policyCode'</span>
one_value_fea_test <span class="token operator">=</span> <span class="token punctuation">[</span>col <span class="token keyword">for</span> col <span class="token keyword">in</span> testA<span class="token punctuation">.</span>columns <span class="token keyword">if</span> testA<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">.</span>nunique<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">]</span>
<span class="token comment"># 'policyCode'</span>


<span class="token comment">#每个数字特征得分布可视化</span>
f <span class="token operator">=</span> pd<span class="token punctuation">.</span>melt<span class="token punctuation">(</span>train<span class="token punctuation">,</span> value_vars<span class="token operator">=</span>numerical_fea<span class="token punctuation">)</span>
g <span class="token operator">=</span> sns<span class="token punctuation">.</span>FacetGrid<span class="token punctuation">(</span>f<span class="token punctuation">,</span> col<span class="token operator">=</span><span class="token string">"variable"</span><span class="token punctuation">,</span>  col_wrap<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> sharex<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> sharey<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
g <span class="token operator">=</span> g<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>sns<span class="token punctuation">.</span>distplot<span class="token punctuation">,</span> <span class="token string">"value"</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">employmentLength_to_int</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> pd<span class="token punctuation">.</span>isnull<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> s  <span class="token comment"># 空值跳过！</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> np<span class="token punctuation">.</span>int8<span class="token punctuation">(</span>s<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 空格划分取第一个！</span>
        
data<span class="token punctuation">[</span><span class="token string">'employmentLength'</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'employmentLength'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>employmentLength_to_int<span class="token punctuation">)</span>
data<span class="token punctuation">[</span><span class="token string">'employmentLength'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value_counts<span class="token punctuation">(</span><span class="token punctuation">)</span>    
<span class="token comment"># 箱型图</span>
column<span class="token operator">=</span>data<span class="token punctuation">.</span>columns<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>
fig<span class="token operator">=</span>plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">,</span>dpi<span class="token operator">=</span><span class="token number">75</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>column<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
    sns<span class="token punctuation">.</span>boxplot<span class="token punctuation">(</span>data<span class="token punctuation">[</span>column<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>orient<span class="token operator">=</span><span class="token string">"v"</span><span class="token punctuation">,</span>width<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span>column<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>fontsize<span class="token operator">=</span><span class="token number">36</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 找出异常值</span>
<span class="token keyword">def</span> <span class="token function">find_outliers_by_3segama</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span>fea<span class="token punctuation">)</span><span class="token punctuation">:</span>
    data_std <span class="token operator">=</span> np<span class="token punctuation">.</span>std<span class="token punctuation">(</span>data<span class="token punctuation">[</span>fea<span class="token punctuation">]</span><span class="token punctuation">)</span>
    data_mean <span class="token operator">=</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>data<span class="token punctuation">[</span>fea<span class="token punctuation">]</span><span class="token punctuation">)</span>
    outliers_cut_off <span class="token operator">=</span> data_std <span class="token operator">*</span> <span class="token number">3</span>
    lower_rule <span class="token operator">=</span> data_mean <span class="token operator">-</span> outliers_cut_off
    upper_rule <span class="token operator">=</span> data_mean <span class="token operator">+</span> outliers_cut_off
    data<span class="token punctuation">[</span>fea<span class="token operator">+</span><span class="token string">'_outliers'</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span>fea<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token string">'异常值'</span><span class="token punctuation">)</span> <span class="token keyword">if</span> x <span class="token operator">&gt;</span> upper_rule <span class="token operator">or</span> x <span class="token operator">&lt;</span> lower_rule <span class="token keyword">else</span> <span class="token string">'正常值'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> data

<span class="token keyword">for</span> fea <span class="token keyword">in</span> column<span class="token punctuation">:</span>
    data_train <span class="token operator">=</span> find_outliers_by_3segama<span class="token punctuation">(</span>train_data<span class="token punctuation">,</span>fea<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>train_data<span class="token punctuation">[</span>fea<span class="token operator">+</span><span class="token string">'_outliers'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value_counts<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>train_data<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span>fea<span class="token operator">+</span><span class="token string">'_outliers'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'isDefault'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">)</span>
    train_data <span class="token operator">=</span> train_data<span class="token punctuation">[</span>train_data<span class="token punctuation">[</span>fea<span class="token operator">+</span><span class="token string">'_outliers'</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">'正常值'</span><span class="token punctuation">]</span>
    train_data <span class="token operator">=</span> train_data<span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span>drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> 
    train_data<span class="token punctuation">.</span>drop<span class="token punctuation">(</span><span class="token punctuation">[</span>fea<span class="token operator">+</span><span class="token string">'_outliers'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
train_data<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># roc曲线绘制ROC曲线</span>
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> roc_curve
y_pred <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
y_true <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
FPR<span class="token punctuation">,</span>TPR<span class="token punctuation">,</span>thresholds<span class="token operator">=</span>roc_curve<span class="token punctuation">(</span>y_true<span class="token punctuation">,</span> y_pred<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'ROC'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>FPR<span class="token punctuation">,</span> TPR<span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'r--'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'TPR'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">'FPR'</span><span class="token punctuation">)</span>

<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> datetime
<span class="token keyword">from</span> CalPSI <span class="token keyword">import</span> <span class="token operator">*</span>  <span class="token comment"># project所在目录</span>
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> seaborn <span class="token keyword">as</span> sns
<span class="token comment">#  画一起，显示rug，显示psi</span>
<span class="token comment">#!/usr/bin/env python</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token comment"># @Time    : 2021/12/17 13:33</span>
<span class="token comment"># @Author  : hongshaofeng</span>
<span class="token comment"># @Project ：rong360 </span>
<span class="token comment"># @File    : 一致性分析.py</span>

<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> datetime
<span class="token keyword">from</span> CalPSI <span class="token keyword">import</span> <span class="token operator">*</span>  <span class="token comment"># project所在目录</span>
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> seaborn <span class="token keyword">as</span> sns


<span class="token keyword">def</span> <span class="token function">plot_kde_psi</span><span class="token punctuation">(</span>f_online<span class="token punctuation">,</span> f_offline<span class="token punctuation">,</span> left_on<span class="token punctuation">,</span> right_on<span class="token punctuation">,</span> model_score_on<span class="token punctuation">,</span> model_score_off<span class="token punctuation">)</span><span class="token punctuation">:</span>
    df1 <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>f_online<span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">)</span>  <span class="token comment"># encoding='utf-8','GB2312'</span>
    df2 <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>f_offline<span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'loan_dt'</span><span class="token punctuation">,</span> <span class="token string">'apply_dt'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> i <span class="token keyword">in</span> df1<span class="token punctuation">.</span>columns<span class="token punctuation">:</span>
            df1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>to_datetime<span class="token punctuation">(</span>df1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token string">"%Y-%m-%d"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 日期格式化</span>
        <span class="token keyword">if</span> i <span class="token keyword">in</span> df2<span class="token punctuation">.</span>columns<span class="token punctuation">:</span>
            df2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>to_datetime<span class="token punctuation">(</span>df2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token string">"%Y-%m-%d"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 日期格式化</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>df1<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> df2<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> df1<span class="token punctuation">.</span>columns<span class="token punctuation">,</span>df2<span class="token punctuation">.</span>columns<span class="token punctuation">)</span>
    df <span class="token operator">=</span> df1<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>df2<span class="token punctuation">,</span> how<span class="token operator">=</span><span class="token string">'inner'</span><span class="token punctuation">,</span> left_on<span class="token operator">=</span>left_on<span class="token punctuation">,</span> right_on<span class="token operator">=</span>right_on<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>df<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> df<span class="token punctuation">,</span> df<span class="token punctuation">.</span>columns<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'线上覆盖率: {:.2%}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> df<span class="token punctuation">[</span>model_score_on<span class="token punctuation">]</span><span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> df<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token string">'线下覆盖率: {:.2%}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> df<span class="token punctuation">[</span>model_score_off<span class="token punctuation">]</span><span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> df<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># df.rename(columns={'信用风险等级_x':'model_score_on','信用风险等级_y':'model_score_off'},inplace=True)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>df<span class="token punctuation">[</span>model_score_on<span class="token punctuation">]</span><span class="token punctuation">.</span>dtype<span class="token punctuation">,</span>df<span class="token punctuation">[</span>model_score_off<span class="token punctuation">]</span><span class="token punctuation">.</span>dtype<span class="token punctuation">)</span>  <span class="token comment"># 查看是否含</span>
    df<span class="token punctuation">[</span>model_score_on<span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"\\N"</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">'0'</span><span class="token punctuation">,</span><span class="token string">'None'</span><span class="token punctuation">,</span><span class="token string">'null'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>np<span class="token punctuation">.</span>nan<span class="token punctuation">,</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    df<span class="token punctuation">[</span>model_score_off<span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"\\N"</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">'0'</span><span class="token punctuation">,</span><span class="token string">'None'</span><span class="token punctuation">,</span><span class="token string">'null'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>np<span class="token punctuation">.</span>nan<span class="token punctuation">,</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token comment"># df[model_score_on] = df[model_score_on].apply(pd.to_numeric, errors='ignore')</span>
    <span class="token comment"># df[model_score_off] = df[model_score_off].apply(pd.to_numeric, errors='ignore')</span>
    <span class="token comment"># print(df[model_score_on].isnull().sum(),df[model_score_off].isnull().sum())</span>
    <span class="token comment"># df[model_score_on] = df[df[model_score_on].notnull()]</span>
    <span class="token comment"># df[model_score_off] = df[df[model_score_off].notnull()]</span>

    score_online_ls <span class="token operator">=</span> df<span class="token punctuation">[</span>model_score_on<span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>
    score_offline_ls <span class="token operator">=</span> df<span class="token punctuation">[</span>model_score_off<span class="token punctuation">]</span><span class="token punctuation">.</span>to_list<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 都可以</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>df<span class="token punctuation">[</span>model_score_on<span class="token punctuation">]</span><span class="token punctuation">.</span>describe<span class="token punctuation">,</span>df<span class="token punctuation">[</span>model_score_off<span class="token punctuation">]</span><span class="token punctuation">.</span>describe<span class="token punctuation">,</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>score_offline_ls<span class="token punctuation">,</span><span class="token string">'\n'</span><span class="token punctuation">,</span>score_online_ls<span class="token punctuation">)</span>
    result_psi2 <span class="token operator">=</span> psi_analysis<span class="token punctuation">(</span>score_online_ls<span class="token punctuation">,</span> score_offline_ls<span class="token punctuation">,</span> parts<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token comment"># print(result_psi2.columns)</span>
    <span class="token comment"># print(result_psi2.values)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'样本的score-psi：{:.6f}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>result_psi2<span class="token punctuation">.</span>values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    plt<span class="token punctuation">.</span>rcParams<span class="token punctuation">[</span><span class="token string">'font.sans-serif'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'SimHei'</span><span class="token punctuation">]</span>  <span class="token comment"># 步骤一（替换sans-serif字体）</span>
    plt<span class="token punctuation">.</span>rcParams<span class="token punctuation">[</span><span class="token string">'axes.unicode_minus'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">False</span>  <span class="token comment"># 步骤二（解决坐标轴负数的负号显示问题）</span>
    fig <span class="token operator">=</span> plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dpi<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span>
    <span class="token comment"># plt.title(str(f_offline[7:-4])+'_密度图', fontsize='xx-large')</span>
    plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>model_score_off<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'_密度图'</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token string">'xx-large'</span><span class="token punctuation">)</span>
    sns<span class="token punctuation">.</span>distplot<span class="token punctuation">(</span>df<span class="token punctuation">[</span>model_score_on<span class="token punctuation">]</span><span class="token punctuation">,</span> bins<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">,</span> rug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> kde_kws<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"label"</span><span class="token punctuation">:</span> <span class="token string">"model_score_online"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">"r"</span><span class="token punctuation">)</span>
    sns<span class="token punctuation">.</span>distplot<span class="token punctuation">(</span>df<span class="token punctuation">[</span>model_score_off<span class="token punctuation">]</span><span class="token punctuation">,</span> bins<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">,</span> rug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> kde_kws<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"label"</span><span class="token punctuation">:</span> <span class="token string">"model_score_offline"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                 color<span class="token operator">=</span><span class="token string">"b"</span><span class="token punctuation">)</span>  <span class="token comment"># 画一起，显示rug，显示psi</span>
    plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'density'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">'线上线下分布对比'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>

    ax <span class="token operator">=</span> plt<span class="token punctuation">.</span>gca<span class="token punctuation">(</span><span class="token punctuation">)</span>
    psi <span class="token operator">=</span> <span class="token string">'{:.6f}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>result_psi2<span class="token punctuation">.</span>values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    font <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'family'</span><span class="token punctuation">:</span> <span class="token string">'serif'</span><span class="token punctuation">,</span> <span class="token string">'style'</span><span class="token punctuation">:</span> <span class="token string">'italic'</span><span class="token punctuation">,</span> <span class="token string">'weight'</span><span class="token punctuation">:</span> <span class="token string">'normal'</span><span class="token punctuation">,</span> <span class="token string">'color'</span><span class="token punctuation">:</span> <span class="token string">'red'</span><span class="token punctuation">,</span> <span class="token string">'size'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">}</span>
    <span class="token comment"># plt.text(0.6, 0.75, r'PSI: ' + str(psi), fontdict=font, transform=ax.transAxes)  # 采用归一化坐标确定 text 位置</span>
    plt<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">,</span> r<span class="token string">'PSI: '</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>psi<span class="token punctuation">)</span><span class="token punctuation">,</span> fontdict<span class="token operator">=</span>font<span class="token punctuation">,</span> transform<span class="token operator">=</span>ax<span class="token punctuation">.</span>transAxes<span class="token punctuation">)</span>  <span class="token comment"># 采用归一化坐标确定 text 位置</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># plt.savefig('fig/'+str(column_online)+'.png')  # 要存就不能show</span>


<span class="token comment"># plot_kde_psi('中信消金_fql_n30xj_1k_93.3%.csv', 'fql_n30xj.txt',</span>
<span class="token comment">#               ['name', 'phone', 'idcard', 'loan_dt'], ['name', 'phone', 'idcard', 'loan_dt'],</span>
<span class="token comment">#              'n30_xj_score_x', 'n30_xj_score_y')</span>
<span class="token comment"># plot_kde_psi('中信消金_fql_v71ty_1k_99.5%.csv', 'fql_v71ty.txt',</span>
<span class="token comment">#               ['name', 'phone', 'idcard', 'loan_dt'],</span>
<span class="token comment">#              ['name', 'phone', 'idcard', 'loan_dt',],</span>
<span class="token comment">#              'v71_ty_x', 'v71_ty_y')</span>
<span class="token comment"># plot_kde_psi('../ppd/中信消金_ppd_v71ty_1k_98.2%.csv', '../ppd/ppd_v71_ty.txt',</span>
<span class="token comment">#               ['name', 'phone', 'idcard', 'loan_dt'],</span>
<span class="token comment">#              ['name', 'phone', 'idcard', 'loan_dt'],</span>
<span class="token comment">#              'v71_ty_x', 'v71_ty_y')</span>
plot_kde_psi<span class="token punctuation">(</span><span class="token string">'fql_cy21xj_1k.txt'</span><span class="token punctuation">,</span> <span class="token string">'fql_cy21xj_10w.txt'</span><span class="token punctuation">,</span>
              <span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span><span class="token string">'phone'</span><span class="token punctuation">,</span><span class="token string">'idcard'</span><span class="token punctuation">,</span><span class="token string">'loan_dt'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
             <span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'phone'</span><span class="token punctuation">,</span> <span class="token string">'idcard'</span><span class="token punctuation">,</span> <span class="token string">'loan_dt'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
             <span class="token string">'cy21_xj_score_x'</span><span class="token punctuation">,</span> <span class="token string">'cy21_xj_score_y'</span><span class="token punctuation">)</span>

    
<span class="token comment"># tools函数：</span>
<span class="token keyword">def</span> <span class="token function">drop_col</span><span class="token punctuation">(</span>df<span class="token punctuation">,</span> cutoff<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 如果这一列中有90%以上的缺失值，那么就从df中删除这一列</span>
    n <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>df<span class="token punctuation">)</span>
    cnt <span class="token operator">=</span> df<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 对列进行非nan值计数</span>
    cnt <span class="token operator">=</span> cnt <span class="token operator">/</span> n <span class="token comment"># 求出非nan值的百分比</span>
    <span class="token comment"># 根据cnt记录的百分比，过滤出cnt百分百大于等于0.1的（也就是去掉nan值大于0.9的索引），</span>
    <span class="token comment"># 然后对df进行选择，行所有，列为满足要求的cnt的索引。</span>
    <span class="token keyword">return</span> df<span class="token punctuation">.</span>loc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> cnt<span class="token punctuation">[</span>cnt <span class="token operator">&gt;=</span> cutoff<span class="token punctuation">]</span><span class="token punctuation">.</span>index<span class="token punctuation">]</span>
df <span class="token operator">=</span> drop_col<span class="token punctuation">(</span>df<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>df<span class="token punctuation">)</span>
<span class="token comment"># 取线上跑批的最新1k条样本。</span>
<span class="token keyword">def</span> <span class="token function">sample_online_1k</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    df<span class="token operator">=</span>pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'FQL_key_0111.txt'</span><span class="token punctuation">,</span>sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">)</span>
    df<span class="token punctuation">.</span>drop_duplicates<span class="token punctuation">(</span>subset<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span><span class="token string">'idcard'</span><span class="token punctuation">,</span><span class="token string">'phone'</span><span class="token punctuation">,</span><span class="token string">'loan_dt'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  
    df<span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span>by<span class="token operator">=</span><span class="token string">'loan_dt'</span><span class="token punctuation">,</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>ascending<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>  <span class="token comment">#降序</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>df<span class="token punctuation">,</span>df<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">1000</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    df<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">1000</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string">'fql_new_1k.txt'</span><span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>

sample_online_1k<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">import</span> os
    <span class="token keyword">print</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>getcwd<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 获取当前工作路径</span>
    <span class="token comment"># pandas 合并多个csv文件</span>
    files <span class="token operator">=</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>path<span class="token punctuation">)</span>                                  <span class="token comment"># 获取文件夹下所有文件名</span>
    df1 <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>path <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>encoding<span class="token operator">=</span><span class="token string">'gbk'</span><span class="token punctuation">)</span>   <span class="token comment"># 读取首个csv文件，保存到df1中</span>

    <span class="token keyword">for</span> <span class="token builtin">file</span> <span class="token keyword">in</span> files<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span>     
        df2 <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>path <span class="token operator">+</span><span class="token string">'/'</span><span class="token operator">+</span><span class="token builtin">file</span><span class="token punctuation">,</span>encoding<span class="token operator">=</span><span class="token string">'gbk'</span><span class="token punctuation">)</span>      <span class="token comment"># 打开csv文件，注意编码问题，保存到df2中</span>
        df1 <span class="token operator">=</span> pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>df1<span class="token punctuation">,</span>df2<span class="token punctuation">]</span><span class="token punctuation">,</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>ignore_index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>   <span class="token comment"># 将df2数据与df1合并</span>

    df1 <span class="token operator">=</span> df1<span class="token punctuation">.</span>drop_duplicates<span class="token punctuation">(</span><span class="token punctuation">)</span>           <span class="token comment"># 去重</span>
    df1 <span class="token operator">=</span> df1<span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span>drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>      <span class="token comment"># 重新生成index</span>
    df1<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span>path <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> <span class="token string">'total.csv'</span><span class="token punctuation">)</span>  <span class="token comment"># 将结果保存为新的csv文件</span>

<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>df1<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'loan_dt'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 打印总样本数，</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>df1<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 打印坏样本数，取第一个既是了！最后都要转化为字符串用tab拼接写入到文件中！</span>
    a <span class="token operator">=</span> df1<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>groupby<span class="token punctuation">(</span>df1<span class="token punctuation">[</span><span class="token string">'loan_dt'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 一个计数，一个求和。</span>
    b <span class="token operator">=</span> df1<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>groupby<span class="token punctuation">(</span>df1<span class="token punctuation">[</span><span class="token string">'loan_dt'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    c <span class="token operator">=</span> pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>a<span class="token punctuation">,</span> b<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    c<span class="token punctuation">.</span>columns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'cnt'</span><span class="token punctuation">,</span> <span class="token string">'ovd'</span><span class="token punctuation">]</span>
    c<span class="token punctuation">[</span><span class="token string">'ovd_ratio'</span><span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">[</span><span class="token string">'ovd'</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">1.0</span> <span class="token operator">/</span> c<span class="token punctuation">[</span><span class="token string">'cnt'</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">get_pri_key</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span>new_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
    rankings_colname<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span><span class="token string">'idcard_md5'</span><span class="token punctuation">,</span><span class="token string">'phone_md5'</span><span class="token punctuation">,</span><span class="token string">'loan_dt'</span><span class="token punctuation">]</span>
    df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>path<span class="token punctuation">,</span> header<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> names<span class="token operator">=</span>rankings_colname<span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">,</span> usecols<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>df<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
    df<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span>new_path<span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> json
<span class="token keyword">def</span> <span class="token function">dict_to_df</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">,</span> file_new<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 表头与取数逻辑一致！不能更改！</span>
    rankings_colname <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'idcard_md5'</span><span class="token punctuation">,</span> <span class="token string">'phone_md5'</span><span class="token punctuation">,</span> <span class="token string">'loan_dt'</span><span class="token punctuation">,</span> <span class="token string">'score'</span><span class="token punctuation">,</span> <span class="token string">'resource_id'</span><span class="token punctuation">,</span> <span class="token string">'customer'</span><span class="token punctuation">,</span> <span class="token string">'feature_new'</span><span class="token punctuation">,</span> <span class="token string">'feature_old'</span><span class="token punctuation">]</span>
    df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">,</span> header<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> names<span class="token operator">=</span>rankings_colname<span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">)</span>  <span class="token comment"># hubei_xj加上scource字段,jryk不需要old,后面需要drop。</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>df<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> <span class="token string">'\n'</span><span class="token punctuation">,</span> df<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># df.drop(['feature_old'], axis=1,inplace=True)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>df<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> <span class="token string">'\n'</span><span class="token punctuation">,</span> df<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># feature_new字典转宽表</span>
    feature_new_list <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'feature_new'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token builtin">eval</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>
    file_name1 <span class="token operator">=</span> <span class="token string">'feature_new_'</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'.json'</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_name1<span class="token punctuation">,</span> <span class="token string">'w+'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f1<span class="token punctuation">:</span>
        json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>feature_new_list<span class="token punctuation">,</span> f1<span class="token punctuation">)</span>
    feature_new <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_json<span class="token punctuation">(</span>file_name1<span class="token punctuation">,</span> orient<span class="token operator">=</span><span class="token string">'records'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>feature_new<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> <span class="token string">'\n'</span><span class="token punctuation">,</span> feature_new<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># feature_old字典转宽表</span>
    feature_old_list <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'feature_old'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token builtin">eval</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>
    file_name2 <span class="token operator">=</span> <span class="token string">'feature_old_'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.json'</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_name2<span class="token punctuation">,</span> <span class="token string">'w+'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f2<span class="token punctuation">:</span>
        json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>feature_old_list<span class="token punctuation">,</span> f2<span class="token punctuation">)</span>
    feature_old <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_json<span class="token punctuation">(</span>file_name2<span class="token punctuation">,</span> orient<span class="token operator">=</span><span class="token string">'records'</span><span class="token punctuation">)</span>
    <span class="token comment"># 三者拼接</span>
    df2 <span class="token operator">=</span> pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>df<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> feature_new<span class="token punctuation">,</span> feature_old<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 适用于wjwl.</span>
    <span class="token comment"># df2 = pd.concat([df.iloc[:, :-1], feature_new], axis=1) # feature_old为空时，将old提前drop掉，不执行old字典转宽表。否则报错。</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>df2<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> df2<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    df<span class="token punctuation">.</span>drop_duplicates<span class="token punctuation">(</span>subset<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'idcard_md5'</span><span class="token punctuation">,</span> <span class="token string">'phone_md5'</span><span class="token punctuation">,</span> <span class="token string">'loan_dt'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># 最后去重！不然主键和特征值对不上！</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>df2<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> df2<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    df2<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span>file_new<span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> feature_new
    
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> datetime
<span class="token keyword">def</span> <span class="token function">get_month_miss</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">)</span>
    df<span class="token punctuation">.</span>drop_duplicates<span class="token punctuation">(</span>subset<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'idcard_md5'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>df<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"n30_hj_score缺失率"</span><span class="token punctuation">,</span> <span class="token string">'{:.2%}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'n30_hj_score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">/</span> df<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token string">"v30_dz缺失率"</span><span class="token punctuation">,</span><span class="token string">'{:.2%}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'v30_dz'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">/</span> df<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 将日期变为标准格式yyyy-mm-dd。</span>
    df<span class="token punctuation">[</span><span class="token string">'loan_dt'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>to_datetime<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'loan_dt'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token string">"%Y-%m-%d"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    df<span class="token punctuation">[</span><span class="token string">'month'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'loan_dt'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">str</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">]</span>
    groups <span class="token operator">=</span> df<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span>by<span class="token operator">=</span><span class="token string">'month'</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> name<span class="token punctuation">,</span> group <span class="token keyword">in</span> groups<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">'\t'</span><span class="token punctuation">,</span> group<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'\t'</span><span class="token punctuation">,</span>
              <span class="token string">'{:.2%}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>group<span class="token punctuation">[</span><span class="token string">'n30_hj_score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">/</span> group<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'\t'</span><span class="token punctuation">,</span>
              <span class="token string">'{:.2%}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>group<span class="token punctuation">[</span><span class="token string">'v30_dz'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">/</span> group<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'\t'</span><span class="token punctuation">,</span>
              <span class="token comment"># '{:.2%}'.format(group['n30_hj_score_new'].isnull().sum(axis=0) / group.shape[0]), '\t',</span>
              <span class="token comment"># '{:.2%}'.format(group['n30_hj_score_new_empty'].isnull().sum(axis=0) / group.shape[0]), '\t',</span>
              <span class="token punctuation">)</span>
              
<span class="token keyword">def</span> <span class="token function">diff_cnt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>r<span class="token string">"C:\Users\hongshaofeng\Desktop\XL_all.txt"</span><span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>df<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> df<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    df<span class="token punctuation">[</span><span class="token string">"N_range1"</span><span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>cut<span class="token punctuation">(</span>x<span class="token operator">=</span>df<span class="token punctuation">[</span><span class="token string">"Nscore"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bins<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">,</span> <span class="token number">700</span><span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">,</span> <span class="token number">900</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    df<span class="token punctuation">[</span><span class="token string">"N_range2"</span><span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>cut<span class="token punctuation">(</span>x<span class="token operator">=</span>df<span class="token punctuation">[</span><span class="token string">"Nscore_new"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bins<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">,</span> <span class="token number">700</span><span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">,</span> <span class="token number">900</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">function</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> a <span class="token operator">==</span> b<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token number">0</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token number">1</span>
    df<span class="token punctuation">[</span><span class="token string">'bool'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> function<span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token string">'N_range1'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> x<span class="token punctuation">[</span><span class="token string">'N_range2'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%.2f%%'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'bool'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span>df<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'{:.4f}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'bool'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span>df<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># print(df.shape,df.head())</span>
    df<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string">'test.csv'</span><span class="token punctuation">,</span>encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">,</span>sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">,</span>index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>


<span class="token comment"># 该函数实现将旧特征映射为新特征，需要的文件包括: 源文件，model特征文件，映射文件，最终新生成表头换好的文件</span>
<span class="token keyword">def</span> <span class="token function">fea_map</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">,</span> model_lib_fea<span class="token punctuation">,</span> fea_map<span class="token punctuation">,</span> file_new<span class="token punctuation">)</span><span class="token punctuation">:</span>
    df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">)</span>  <span class="token comment"># 读取源文件</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>df<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> df<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    res <span class="token operator">=</span> df<span class="token punctuation">.</span>columns<span class="token punctuation">.</span>to_list<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    res_lib <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>model_lib_fea<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>  <span class="token comment"># 将model_lib特征加入res_lib列表中</span>
        <span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">:</span>
            res_lib<span class="token punctuation">.</span>append<span class="token punctuation">(</span>line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    df2 <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>fea_map<span class="token punctuation">,</span> header<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> names<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'new_fea'</span><span class="token punctuation">,</span> <span class="token string">'fea'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">)</span>  <span class="token comment"># 读取映射关系</span>
    res_map1 <span class="token operator">=</span> df2<span class="token punctuation">[</span><span class="token string">'new_fea'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to_list<span class="token punctuation">(</span><span class="token punctuation">)</span>
    res_map2 <span class="token operator">=</span> df2<span class="token punctuation">[</span><span class="token string">'fea'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to_list<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> res<span class="token punctuation">:</span>
        <span class="token keyword">if</span> i <span class="token keyword">in</span> res_map2<span class="token punctuation">:</span>
            res<span class="token punctuation">[</span>res<span class="token punctuation">.</span>index<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> res_map1<span class="token punctuation">[</span>res_map2<span class="token punctuation">.</span>index<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment"># 命中的全部改为标准表头！</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span>
    <span class="token comment"># 将原来的表头替换为新表头，并写入新文件中.</span>
    df<span class="token punctuation">.</span>columns <span class="token operator">=</span> res  <span class="token comment"># 更换表头！</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>df<span class="token punctuation">.</span>columns<span class="token punctuation">)</span>

    <span class="token comment"># #以下只适用于test,将表头n30_hj_score_new_empty修改名字，便于跑modellib --&gt; jryk_test_empty_fea_new.txt</span>
    <span class="token comment"># df = df.rename(columns={"n30_hj_score": "n30_hj_score_old", "n30_hj_score_new_empty": "n30_hj_score"})</span>

    df<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span>file_new<span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

<span class="token comment"># fea_map('jryk_test.txt', 'features.txt', 'fea_map.txt', 'jryk_test_fea_map.txt')</span>

<span class="token keyword">def</span> <span class="token function">jiemi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    df1 <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'wjwl_20210902_fea.txt'</span><span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>df1<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> df1<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    df1<span class="token punctuation">.</span>drop_duplicates<span class="token punctuation">(</span>subset<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span>	<span class="token string">'idcard_md5'</span><span class="token punctuation">,</span> <span class="token string">'phone_md5'</span><span class="token punctuation">,</span> <span class="token string">'loan_dt'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>df1<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> df1<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># df1[['name', 'idcard_md5', 'phone_md5', 'loan_dt']].to_csv('wjwl_20210902_key_jiemi.txt',encoding='utf-8', sep='\t', index=False)</span>
    df1<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string">'wjwl_20210902_fea_new.txt'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>  <span class="token comment"># 部分用户特征为空，删除</span>

<span class="token keyword">def</span> <span class="token function">rand_sample</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">,</span>file_new<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
    df_raw <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">)</span> 
    <span class="token keyword">print</span><span class="token punctuation">(</span>df_raw<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
    df_raw<span class="token punctuation">.</span>drop_duplicates<span class="token punctuation">(</span>subset<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span><span class="token string">'idcard_md5'</span><span class="token punctuation">,</span><span class="token string">'phone_md5'</span><span class="token punctuation">,</span><span class="token string">'loan_dt'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    df_sample <span class="token operator">=</span> df_raw<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>n<span class="token operator">=</span><span class="token number">2000</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 随机取样</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>df_sample<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> df_sample<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
    df_sample<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span>file_new<span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    
    
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'V的空值率：{:.4f}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>data<span class="token punctuation">[</span>V_columns<span class="token punctuation">]</span><span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span>data<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

python切换当前工程目录
<span class="token keyword">import</span> os
<span class="token keyword">print</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>getcwd<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># os.getcwd() == r'D:\tianjikit-master\tj_bank_tools_optimize':</span>
<span class="token keyword">if</span> <span class="token operator">~</span>os<span class="token punctuation">.</span>getcwd<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'./example9/'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>chdir<span class="token punctuation">(</span><span class="token string">'./example9/'</span><span class="token punctuation">)</span>  <span class="token comment"># 调试使用</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>getcwd<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">"just"</span><span class="token punctuation">,</span> <span class="token string">"do"</span><span class="token punctuation">,</span> <span class="token string">"python"</span><span class="token punctuation">,</span> <span class="token string">"dot"</span><span class="token punctuation">,</span> <span class="token string">"com"</span><span class="token punctuation">)</span>  <span class="token comment"># 'just\\do\\python\\dot\\com'</span>
 os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span>
python区间
span_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'[%.3f,%.3f]'</span> <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">round</span><span class="token punctuation">(</span>cut_list<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
np<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span>tup<span class="token punctuation">)</span>使用 <span class="token comment">#沿着竖直方向将矩阵堆叠起来。</span>

<span class="token comment"># 校验是否有label列</span>
<span class="token keyword">assert</span> <span class="token string">'label'</span> <span class="token keyword">in</span> dftrain<span class="token punctuation">.</span>columns<span class="token punctuation">,</span> <span class="token string">'illegal input,there should be a  "label" column in dftrain!'</span>     
<span class="token comment"># 校验label列的合法性</span>
<span class="token keyword">assert</span> <span class="token builtin">set</span><span class="token punctuation">(</span>dftrain<span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'illegal label values,label can only be 0 or 1!'</span>

<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> date
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> timedelta
now_date <span class="token operator">=</span> <span class="token punctuation">(</span>date<span class="token punctuation">.</span>today<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
one_week_before <span class="token operator">=</span> <span class="token punctuation">(</span>date<span class="token punctuation">.</span>today<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%Y-%m-%d"</span><span class="token punctuation">)</span>
data<span class="token operator">=</span>data<span class="token punctuation">[</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'time'</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token builtin">str</span><span class="token punctuation">(</span>now_date<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'time'</span><span class="token punctuation">]</span><span class="token operator">&gt;=</span><span class="token builtin">str</span><span class="token punctuation">(</span>one_week_before<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> date<span class="token punctuation">,</span> timedelta

yesterday <span class="token operator">=</span> <span class="token punctuation">(</span>date<span class="token punctuation">.</span>today<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>days <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%Y-%m-%d"</span><span class="token punctuation">)</span>    <span class="token comment"># 获取前一天日期</span>
<span class="token comment">#目标值分析</span>
<span class="token comment">#我们画出SalePrice的分布图和QQ图（Quantile Quantile Plot）。这里简单说一下QQ图，它是由标准正态分布的分位数为横坐标，样本值为纵坐标的散点图。如果QQ图上的点在一条直线附近，则说明数据近似于正态分布，</span>
<span class="token comment"># 且该直线的斜率为标准差，截距为均值。对于QQ图的详细介绍可以参考这篇文章：https://blog.csdn.net/hzwwpgmwy/article/details/79178485</span>
<span class="token keyword">def</span> <span class="token function">analyseAimVal</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sns<span class="token punctuation">.</span>distplot<span class="token punctuation">(</span>data <span class="token punctuation">,</span> fit<span class="token operator">=</span>norm<span class="token punctuation">)</span><span class="token comment">#distplot是画直方图#fit=norm拟合标准正态分布</span>
 
    <span class="token comment"># Get the fitted parameters used by the function</span>
    <span class="token punctuation">(</span>mu<span class="token punctuation">,</span> sigma<span class="token punctuation">)</span> <span class="token operator">=</span> norm<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token comment">#获取数据列正太分布的均值和标准差。</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span> <span class="token string">'\n mu = {:.2f} and sigma = {:.2f}\n'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>mu<span class="token punctuation">,</span> sigma<span class="token punctuation">)</span><span class="token punctuation">)</span>
 
    <span class="token comment">#Now plot the distribution</span>
    plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'Normal dist. ($\mu=$ {:.2f} and $\sigma=$ {:.2f} )'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>mu<span class="token punctuation">,</span> sigma<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                loc<span class="token operator">=</span><span class="token string">'best'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'Frequency'</span><span class="token punctuation">)</span><span class="token comment">#出现率</span>
    plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'SalePrice distribution'</span><span class="token punctuation">)</span>
 
    <span class="token comment">#Get also the QQ-plot</span>
    fig <span class="token operator">=</span> plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">#如果两个分布相似，则该Q-Q图趋近于落在y=x线上。如果两分布线性相关，则点在Q-Q图上趋近于落在一条直线上，但不一定在y=x线上。</span>
    <span class="token comment">#下面的函数默认dist=norm，也就是说默认你传入的数据train['SalePrice']是与正态分布作比较的。</span>
    <span class="token comment">#这样的话QQ图鉴别样本数据是否近似于正态分布,只需看QQ图上的点是否近似地在一条直线附近,而且该直线的斜率为标准差,截距为均值.</span>
    res <span class="token operator">=</span> stats<span class="token punctuation">.</span>probplot<span class="token punctuation">(</span>data<span class="token punctuation">,</span>plot<span class="token operator">=</span>plt<span class="token punctuation">)</span><span class="token comment">#函数默认值dist="norm"，即默认与正态分布比较</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
analyseAimVal<span class="token punctuation">(</span>train<span class="token punctuation">[</span><span class="token string">'SalePrice'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">#SalePrice的分布呈正偏态，而线性回归模型要求因变量服从正态分布。我们对其做对数变换，让数据接近正态分布。</span>
<span class="token comment">#We use the numpy fuction log1p which  applies log(1+x) to all elements of the column</span>
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd 
train <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>r<span class="token string">'C:\Users\hongshaofeng\Desktop\jiufu_out_data_0512.csv'</span><span class="token punctuation">)</span>
train<span class="token punctuation">[</span><span class="token string">"cy20_hj_score"</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>log1p<span class="token punctuation">(</span>train<span class="token punctuation">[</span><span class="token string">"cy20_hj_score"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
 
analyseAimVal<span class="token punctuation">(</span>train<span class="token punctuation">[</span><span class="token string">"SalePrice"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

环境变量快速进入： 
方法一： 选“环境变量”——搞定。 
方法二： 按快捷键win<span class="token operator">+</span>R后，输入“sysdm<span class="token punctuation">.</span>cpl”，然后回车，完事。
方法三： 按键盘上的windows键，输入“环境变量”或者“huanjing”，打开“编辑系统环境变量”，完事。
方法四：python环境下
<span class="token keyword">import</span> os
os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"path"</span><span class="token punctuation">]</span> <span class="token operator">+=</span> os<span class="token punctuation">.</span>pathsep <span class="token operator">+</span> <span class="token string">"D:\Graphviz\bin"</span>
dot_data<span class="token operator">=</span>xgb<span class="token punctuation">.</span>to_graphviz<span class="token punctuation">(</span>bst<span class="token punctuation">,</span> num_trees<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">#1安装graphviz， 2添加环境变量，graphviz\bin,graphviz\dot.exe</span>


score_slice_arr <span class="token operator">=</span> np<span class="token punctuation">.</span>array_split<span class="token punctuation">(</span>sort_score_ls<span class="token punctuation">,</span> slice_num<span class="token punctuation">)</span>  np<span class="token punctuation">.</span>array_split进行不均等划分！
AUC <span class="token punctuation">(</span>Area Under Curve<span class="token punctuation">)</span> 反映不平衡样本分类模型的性能<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>计算方法：sklearn中metrics<span class="token punctuation">.</span>roc_auc_score，阈值计算TPR<span class="token operator">/</span>FPR
KS（Kolmogorov<span class="token operator">-</span>Smirnov）衡量数值型变量或有序分类变量对好坏用户的区分度。KS <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">{<!-- --></span><span class="token builtin">abs</span><span class="token punctuation">(</span>Fn<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token operator">-</span>F0<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
IV<span class="token punctuation">(</span>information value<span class="token punctuation">)</span>衡量多分类变量对好坏用户的区分度。woe_i <span class="token operator">=</span> ln<span class="token punctuation">(</span> <span class="token punctuation">(</span>ln<span class="token punctuation">(</span>N_bad_in_i <span class="token operator">/</span>N_total_bad<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>N_good_in_i <span class="token operator">/</span>N_total_good<span class="token punctuation">)</span> <span class="token punctuation">)</span>   woei <span class="token operator">=</span> ln<span class="token punctuation">(</span>badi<span class="token operator">/</span>badT<span class="token punctuation">)</span><span class="token operator">-</span>ln<span class="token punctuation">(</span>goodi<span class="token operator">/</span>goodT<span class="token punctuation">)</span>
IV <span class="token operator">=</span> <span class="token builtin">sum</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span>N_bad_in_i <span class="token operator">/</span>N_total_bad<span class="token punctuation">)</span><span class="token operator">-</span><span class="token punctuation">(</span>ln<span class="token punctuation">(</span>N_good_in_i <span class="token operator">/</span>N_total_good<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">*</span>woe_i<span class="token punctuation">)</span>
PSI<span class="token punctuation">(</span>Population stability index<span class="token punctuation">)</span> 衡量变量、模型的稳定性<span class="token punctuation">.</span> PSI<span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>（实际占比<span class="token operator">-</span>预期占比）<span class="token operator">*</span> ln<span class="token punctuation">(</span>实际占比<span class="token operator">/</span>预期占比<span class="token punctuation">)</span><span class="token punctuation">)</span>

WOE <span class="token operator">=</span> ln <span class="token punctuation">(</span>第i个分箱的坏人数 <span class="token operator">/</span> 第i个分箱的好人数<span class="token punctuation">)</span> <span class="token operator">-</span> ln <span class="token punctuation">(</span>总坏人数 <span class="token operator">/</span> 总好人数<span class="token punctuation">)</span> 可以理解为：每个分箱里的坏好比<span class="token punctuation">(</span>Odds<span class="token punctuation">)</span>相对于总体的坏好比之间的差异性。
WOE证据权重，根据贝叶斯理论用以衡量对先验认识修正的增量，
PSI衡量预期分布和实际分布之间的差异性，IV把这两个分布具体化为好人分布和坏人分布。
IV指标是在从信息熵上比较好人分布和坏人分布之间的差异性。

异常值发现outlier detection feature_analysis_tools<span class="token punctuation">.</span>py中值域判断<span class="token operator">&lt;</span><span class="token number">0</span> 均记为<span class="token number">1e</span><span class="token operator">-</span><span class="token number">10</span>                                                                                                         分位数识别 
缺失值填补imputer xgb里处理，如果缺失，试各分支计算增益选择合适方向

特征选择<span class="token punctuation">:</span><span class="token number">1</span>\PSI筛选  <span class="token number">2</span>\<span class="token number">3</span>月间MaxPSI<span class="token operator">&lt;</span><span class="token number">0.</span>2q且avgPSI<span class="token operator">&lt;</span><span class="token number">0.1</span>      <span class="token number">3</span>\IV筛选    <span class="token operator">&gt;</span><span class="token number">0.01</span>或者相对区分度TopN      <span class="token number">4</span>\ 特征重要度xgb    <span class="token number">5</span>\ 评估：KS<span class="token punctuation">,</span>AUC



<span class="token keyword">import</span> random
<span class="token keyword">print</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 18</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 8.315165416</span>


<span class="token keyword">def</span> <span class="token function">jiemi</span><span class="token punctuation">(</span>file_raw<span class="token punctuation">,</span>file_key<span class="token punctuation">)</span><span class="token punctuation">:</span>
    df1 <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>file_raw<span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>df1<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> df1<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    df1<span class="token punctuation">.</span>drop_duplicates<span class="token punctuation">(</span>subset<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span>	<span class="token string">'idcard_md5'</span><span class="token punctuation">,</span> <span class="token string">'phone_md5'</span><span class="token punctuation">,</span> <span class="token string">'loan_dt'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>df1<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> df1<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># df1[['name', 'idcard_md5', 'phone_md5', 'loan_dt']].to_csv('wjwl_20210902_key_jiemi.txt',</span>
    <span class="token comment">#                                                          encoding='utf-8', sep='\t', index=False)</span>
    df1<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span>file_key<span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>  <span class="token comment"># 部分用户特征为空，删除</span>
    

pycharm直接run的时候：无法自动创建save目录？、run的时候在当前目录D<span class="token punctuation">:</span>\tianjikit<span class="token operator">-</span>master\tj_bank_tools_optimize\example10
Alt <span class="token operator">+</span> Shift <span class="token operator">+</span> E 运行目录为 D<span class="token punctuation">:</span>\tianjikit<span class="token operator">-</span>master\tj_bank_tools_optimize，为初始目录


python正则表达式三：<span class="token operator">^</span>和$
<span class="token comment">#coding=utf-8</span>
<span class="token keyword">import</span> re
<span class="token comment">#^匹配字符串起始部分</span>
re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'^ba'</span><span class="token punctuation">,</span><span class="token string">'abacd'</span><span class="token punctuation">)</span>    <span class="token comment">#[]</span>
re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'^ab'</span><span class="token punctuation">,</span><span class="token string">'abacd'</span><span class="token punctuation">)</span>   <span class="token comment"># ['ab']</span>
<span class="token comment">#$匹配字符串终止部分</span>
re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'ac$'</span><span class="token punctuation">,</span><span class="token string">'abacd'</span><span class="token punctuation">)</span>  <span class="token comment"># []</span>
re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'cd$'</span><span class="token punctuation">,</span><span class="token string">'abacd'</span><span class="token punctuation">)</span>  <span class="token comment">#['cd']</span>
<span class="token comment">#匹配整个字符串</span>
m<span class="token operator">=</span>re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'^abacd$'</span><span class="token punctuation">,</span><span class="token string">'abacd'</span><span class="token punctuation">)</span>  <span class="token comment"># ['abacd']</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'---------------------------test1---------------------------------'</span><span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token operator">=</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'log.txt'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 重定向</span>

<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> sys
<span class="token keyword">from</span> feaAnalysis <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment">#</span>
<span class="token keyword">def</span> <span class="token function">big_data_split</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 切分为四份文件 主键: name	idcard	phone	loan_dt	sha256_iden	sha256_phone</span>
    <span class="token comment"># path = sys.argv[1]  终端执行，如果本地执行函数注释掉</span>
    <span class="token comment"># 也可以直接修改源文件主键，flag改为【0，1，2，3，4，5】+ 。。。</span>
    flag <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            flag <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">[</span>j <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment"># 1,2不要。 5，6对上了：sha256——iden，sha256——phone</span>
        <span class="token keyword">elif</span> i <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">or</span> <span class="token number">2</span><span class="token punctuation">:</span>
            flag <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span>j <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token operator">*</span>i<span class="token punctuation">,</span> <span class="token number">10000</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token keyword">elif</span> i <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">:</span>
            flag <span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">[</span>j <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">30000</span><span class="token punctuation">,</span> <span class="token number">34742</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment">#34742</span>
        df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>path<span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">,</span> usecols<span class="token operator">=</span>flag<span class="token punctuation">)</span>
        df<span class="token punctuation">.</span>rename<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">'sha256_iden'</span><span class="token punctuation">:</span> <span class="token string">'idcard'</span><span class="token punctuation">,</span> <span class="token string">'sha256_phone'</span><span class="token punctuation">:</span> <span class="token string">'phone'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># 重命名好</span>
        file_name <span class="token operator">=</span> <span class="token string">'yixin_xxx0'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.csv'</span>
        <span class="token keyword">print</span> <span class="token punctuation">(</span>df<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> df<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        df<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span>file_name<span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">concat_to_real</span><span class="token punctuation">(</span>inpath1<span class="token punctuation">,</span>inpath2<span class="token punctuation">,</span>outpath<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 将9.8w行用户补上缺失的用户，使其成为10w行用户</span>
    df1 <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>inpath1<span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">)</span>  <span class="token comment"># 9w行</span>
    df2 <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>inpath2<span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">','</span><span class="token punctuation">)</span>  <span class="token comment"># 10w行</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>df1<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> df2<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
    df_new <span class="token operator">=</span> df1<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>df2<span class="token punctuation">,</span> how<span class="token operator">=</span><span class="token string">'right'</span><span class="token punctuation">,</span> on<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'idcard'</span><span class="token punctuation">,</span> <span class="token string">'phone'</span><span class="token punctuation">,</span> <span class="token string">'loan_dt'</span><span class="token punctuation">,</span> <span class="token string">'label'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 以df2为目标,注意有无label。</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>df_new<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> df_new<span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    df_new<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span>outpath<span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>


<span class="token comment"># 进行单特征分析需要一个个跑，还未改参数，然后得到特征分析的结果，4份总和6000个。</span>
<span class="token comment"># 将含6k特征的数据集与数据集进行merge得到4份总和含6k特征的数据集。</span>
<span class="token keyword">def</span> <span class="token function">xgb_select_data</span><span class="token punctuation">(</span>inpath1<span class="token punctuation">,</span> inpath2<span class="token punctuation">,</span> outpath<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
    df2 <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>inpath2<span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">','</span><span class="token punctuation">)</span>  <span class="token comment"># 6k行特征，4列指标 先读这个，看会不会报错！特征不是索引。。。分隔符为","</span>
    df1 <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>inpath1<span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">)</span>  <span class="token comment"># 9w行用户，1w列特征，共有4个小文件。。必须\t否则会粘在一起</span>
    <span class="token comment"># pubilc_columns = df2.index.values.tolist()  # 拿到这6k的特征去匹配</span>
    tmp1<span class="token punctuation">,</span> tmp2 <span class="token operator">=</span> df1<span class="token punctuation">.</span>columns<span class="token punctuation">.</span>values<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> df2<span class="token punctuation">[</span><span class="token string">'feature'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 分别拿出对应的特征</span>
    tmp3 <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span>tmp1<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token builtin">set</span><span class="token punctuation">(</span>tmp2<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 取交集 必须要集合，否则无法取交集</span>
    <span class="token keyword">print</span> <span class="token builtin">len</span><span class="token punctuation">(</span>tmp3<span class="token punctuation">)</span>
    pubilcData <span class="token operator">=</span> df1<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'idcard'</span><span class="token punctuation">,</span> <span class="token string">'phone'</span><span class="token punctuation">,</span> <span class="token string">'loan_dt'</span><span class="token punctuation">,</span> <span class="token string">'label'</span><span class="token punctuation">]</span><span class="token operator">+</span>tmp3<span class="token punctuation">]</span>  <span class="token comment"># 对应的拿出来即可</span>
    <span class="token keyword">print</span> pubilcData<span class="token punctuation">.</span>shape
    pubilcData<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span>outpath<span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>


<span class="token comment"># 将4份文件特征拼接</span>
<span class="token keyword">def</span> <span class="token function">concat_four_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        df1 <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'jiufu_meta02_xxx0'</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'_6000.csv'</span><span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">)</span>
        res<span class="token punctuation">.</span>append<span class="token punctuation">(</span>df1<span class="token punctuation">)</span>
    df <span class="token operator">=</span> pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span>res<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> ignore_index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> join<span class="token operator">=</span><span class="token string">"outer"</span><span class="token punctuation">)</span>  <span class="token comment"># 按列拼接</span>
    <span class="token keyword">print</span> df<span class="token punctuation">.</span>shape
    df<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string">'jiufu_meta02_6000.csv'</span><span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>


<span class="token comment"># 对样本按时间先后先后排序,划分训练集与测试集</span>
<span class="token keyword">def</span> <span class="token function">huisu_data_split</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> out_trian<span class="token punctuation">,</span> out_test<span class="token punctuation">)</span><span class="token punctuation">:</span>
    data <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>path<span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">)</span>
    res <span class="token operator">=</span> data<span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span>by<span class="token operator">=</span><span class="token string">'loan_dt'</span><span class="token punctuation">,</span> ascending<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token comment"># train, test = res.iloc[:90131], res.iloc[90131:]  # 训练样本90131取到2020-2-16为止！测试样本取到2020-2-17开始的！</span>
    train<span class="token punctuation">,</span> test <span class="token operator">=</span> res<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">87303</span><span class="token punctuation">]</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token number">87303</span><span class="token punctuation">:</span><span class="token punctuation">]</span>  <span class="token comment"># 训练样本90131取到2020-1为止！测试样本取到2020-2开始的！</span>
    <span class="token keyword">print</span> train<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> test<span class="token punctuation">.</span>shape
    train<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span>out_trian<span class="token punctuation">,</span>  sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">)</span>
    test<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span>out_test<span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">)</span>  <span class="token comment"># run_model_lr,run_model_xgb只能读取空格符号的文件！</span>


<span class="token comment"># 上述两个函数可直接写成以下函数。</span>
<span class="token keyword">def</span> <span class="token function">split_to_concat</span><span class="token punctuation">(</span>file1<span class="token punctuation">,</span> file2<span class="token punctuation">,</span> file3<span class="token punctuation">,</span> file4<span class="token punctuation">,</span> base_trian<span class="token punctuation">,</span> base_test<span class="token punctuation">)</span><span class="token punctuation">:</span>
    df1 <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>file1<span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">)</span>
    df2 <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>file2<span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">)</span>
    df3 <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>file3<span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">)</span>
    df4 <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>file4<span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">)</span>
    <span class="token comment"># df = pd.concat([df1, df2, df3, df4], axis=1, join='left') # 只能out或inner</span>
    df <span class="token operator">=</span> df1<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>df2<span class="token punctuation">,</span> how<span class="token operator">=</span><span class="token string">'right'</span><span class="token punctuation">,</span> on<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'idcard'</span><span class="token punctuation">,</span> <span class="token string">'phone'</span><span class="token punctuation">,</span> <span class="token string">'loan_dt'</span><span class="token punctuation">,</span> <span class="token string">'label'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 以df2为目标</span>
    df <span class="token operator">=</span> df<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>df3<span class="token punctuation">,</span> how<span class="token operator">=</span><span class="token string">'right'</span><span class="token punctuation">,</span> on<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'idcard'</span><span class="token punctuation">,</span> <span class="token string">'phone'</span><span class="token punctuation">,</span> <span class="token string">'loan_dt'</span><span class="token punctuation">,</span> <span class="token string">'label'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    df <span class="token operator">=</span> df<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>df4<span class="token punctuation">,</span> how<span class="token operator">=</span><span class="token string">'right'</span><span class="token punctuation">,</span> on<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'idcard'</span><span class="token punctuation">,</span> <span class="token string">'phone'</span><span class="token punctuation">,</span> <span class="token string">'loan_dt'</span><span class="token punctuation">,</span> <span class="token string">'label'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    res <span class="token operator">=</span> df<span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span>by<span class="token operator">=</span><span class="token string">'loan_dt'</span><span class="token punctuation">,</span> ascending<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token comment"># print(res.head())</span>
    train<span class="token punctuation">,</span> test <span class="token operator">=</span> res<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">90131</span><span class="token punctuation">]</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token number">90131</span><span class="token punctuation">:</span><span class="token punctuation">]</span>  <span class="token comment"># 训练样本90131取到2020-2-16为止！测试样本取到2020-2-17开始的！</span>
    <span class="token keyword">print</span> train<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> test<span class="token punctuation">.</span>shape
    train<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span>base_trian<span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    test<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span>base_test<span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>  <span class="token comment"># run_model_lr,run_model_xgb只能读取空格符号的文件！</span>


<span class="token comment"># 将最终xgb筛选出的832特征与原始6k进行拼接，得到数据集，再将其与外部特征数据分别进行拼接，继续跑xgb得到特征分析结果</span>
<span class="token keyword">def</span> <span class="token function">base_outer_concat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
    df_base <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'xgb_832_data.csv'</span><span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">)</span>
    <span class="token comment"># 先进行数据集的merge，保证主键一致。将16个特征，merge到832中？？</span>
    df_outer <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'jiufu_out_data_0512.csv'</span><span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">','</span><span class="token punctuation">)</span>
    df_base_outer1 <span class="token operator">=</span> pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>df_base<span class="token punctuation">,</span> df_outer<span class="token punctuation">[</span><span class="token string">'cy20_hj_score'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> join<span class="token operator">=</span><span class="token string">'outer'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> df_base_outer1<span class="token punctuation">.</span>shape
    df_base_outer1<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string">'base_outer_cy20.csv'</span><span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token comment"># df_base_outer = df_base.merge(df_outer.iloc[:, 8:17], how='outer', on=['name', 'idcard', 'phone', 'loan_dt', 'label'])</span>
    <span class="token comment"># print df_base_outer.shape</span>
    <span class="token comment"># df_base_outer.to_csv('base_outer_zt.csv', sep='\t', encoding='utf-8', index=False)</span>

<span class="token keyword">def</span> <span class="token function">concat_to_real2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 将9.8w行用户补上缺失的用户，使其成为10w行用户</span>
    df1 <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>r<span class="token string">'C:\Users\hongshaofeng\Desktop\huisu.csv'</span><span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">)</span>  <span class="token comment"># 9w行</span>
    df2 <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>r<span class="token string">'C:\Users\hongshaofeng\Desktop\data_0804.csv'</span><span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">','</span><span class="token punctuation">)</span>  <span class="token comment"># 10w行</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>df1<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> df2<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
    df_new <span class="token operator">=</span> df1<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>df2<span class="token punctuation">,</span> how<span class="token operator">=</span><span class="token string">'outer'</span><span class="token punctuation">,</span> on<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'idcard'</span><span class="token punctuation">,</span> <span class="token string">'phone'</span><span class="token punctuation">,</span> <span class="token string">'loan_dt'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 以df2为目标</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>df_new<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> df_new<span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    df_new<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span>r<span class="token string">'C:\Users\hongshaofeng\Desktop\huisu_new.csv'</span><span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

<span class="token comment"># huisu_data_split('xgb_832_data.csv', 'xgb_832__tr_cy20.csv', 'xgb_832_te_cy20.csv')</span>
<span class="token comment"># huisu_data_split('base_outer_cy20.csv', 'base_outer_tr_cy20.csv', 'base_outer_te_cy20.csv')</span>
<span class="token comment"># huisu_data_split('base_outer_n30.csv', 'base_outer_tr_n30.csv', 'base_outer_te_n30.csv')</span>
<span class="token comment"># huisu_data_split('base_outer_v30.csv', 'base_outer_tr_v30.csv', 'base_outer_te_v30.csv')</span>
<span class="token comment"># huisu_data_split('base_outer_zt.csv', 'base_outer_tr_zt.csv', 'base_outer_te_zt.csv')</span>
<span class="token comment"># python2.7 run_model_xgb.py ../base_outer_tr_cy20.csv ../base_outer_te_cy20.csv base_outer_xgb_results/ ''</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    concat_to_real2<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
pycharm新建<span class="token number">27</span>环境需要用anconda虚拟环境来装。<span class="token number">27</span>的就只有基本包。需要手动安装第三方库。
pip freeze <span class="token operator">&gt;</span> requirements<span class="token punctuation">.</span>txt  <span class="token comment"># 导出依赖包</span>
pip install <span class="token operator">-</span>r requirements<span class="token punctuation">.</span>txt  <span class="token comment"># 安装依赖包</span>
pip  install  <span class="token punctuation">.</span><span class="token operator">/</span>matplotlib<span class="token operator">-</span><span class="token number">2.2</span><span class="token number">.3</span><span class="token operator">-</span>cp36<span class="token operator">-</span>cp36m<span class="token operator">-</span>win32<span class="token punctuation">.</span>whl 

<span class="token comment">#python保留6位小数  4种方式</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%.6f'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>psi<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'cy20_hj_score'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>df<span class="token punctuation">[</span><span class="token string">'model_score'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span><span class="token number">1.32434</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'{:.3f}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token number">1.23456</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token number">1.23456</span><span class="token punctuation">,</span> <span class="token string">'.2f'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># python 百分比输出2种方式</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'percent: {:.2%}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token operator">/</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%.2f%%'</span> <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token number">2.322</span><span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>

<span class="token keyword">import</span> warnings
warnings<span class="token punctuation">.</span>filterwarnings<span class="token punctuation">(</span><span class="token string">"ignore"</span><span class="token punctuation">)</span> <span class="token comment"># 忽略警告</span>


pip install numpy <span class="token operator">-</span>i http<span class="token punctuation">:</span><span class="token operator">//</span>pypi<span class="token punctuation">.</span>douban<span class="token punctuation">.</span>com<span class="token operator">/</span>simple<span class="token operator">/</span>  <span class="token operator">-</span><span class="token operator">-</span>trusted<span class="token operator">-</span>host pypi<span class="token punctuation">.</span>douban<span class="token punctuation">.</span>com   <span class="token comment">#装第三方库</span>
pip install <span class="token operator">-</span>i http<span class="token punctuation">:</span><span class="token operator">//</span>pypi<span class="token punctuation">.</span>douban<span class="token punctuation">.</span>com<span class="token operator">/</span>simple<span class="token operator">/</span> <span class="token operator">-</span><span class="token operator">-</span>trusted<span class="token operator">-</span>host pypi<span class="token punctuation">.</span>douban<span class="token punctuation">.</span>com pandas
pip  install  <span class="token punctuation">.</span><span class="token operator">/</span>matplotlib<span class="token operator">-</span><span class="token number">2.2</span><span class="token number">.3</span><span class="token operator">-</span>cp36<span class="token operator">-</span>cp36m<span class="token operator">-</span>win32<span class="token punctuation">.</span>whl  <span class="token comment">#安装whl包方法</span>

<span class="token comment"># 从文件中拿到特征列表，写入文件</span>
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>r<span class="token string">'C:\Users\hongshaofeng\Desktop\sas\sg_inner_data.csv'</span><span class="token punctuation">,</span>sep<span class="token operator">=</span><span class="token string">','</span><span class="token punctuation">)</span>
df<span class="token operator">=</span> df<span class="token punctuation">.</span>rename<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">'Unnamed: 0'</span><span class="token punctuation">:</span><span class="token string">'seq'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
fea_list <span class="token operator">=</span> df<span class="token punctuation">.</span>columns<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'feature_list.txt'</span><span class="token punctuation">,</span><span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> fea_list<span class="token punctuation">:</span>
        f<span class="token punctuation">.</span>writelines<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'\n'</span><span class="token punctuation">)</span>

<span class="token comment">#读取文件</span>
res<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'feature_list.txt'</span><span class="token punctuation">,</span><span class="token string">'r'</span><span class="token punctuation">,</span>encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    <span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        res<span class="token punctuation">.</span>append<span class="token punctuation">(</span>line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 可以去掉换行符。</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
<span class="token comment"># Python 正则匹配两个特定字符之间的字符</span>
result <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">".*entry(.*)for.*"</span><span class="token punctuation">,</span>string<span class="token punctuation">)</span>

<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>f_list_file<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        <span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">:</span>
            line <span class="token operator">=</span> line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> line <span class="token operator">!=</span> <span class="token string">''</span><span class="token punctuation">:</span> 
                train_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>line<span class="token punctuation">)</span>
                
                
<span class="token comment">#log_jryk</span>
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> date<span class="token punctuation">,</span> timedelta
yesterday <span class="token operator">=</span> <span class="token punctuation">(</span>date<span class="token punctuation">.</span>today<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>days <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%Y-%m-%d"</span><span class="token punctuation">)</span>    <span class="token comment"># 获取前一天日期</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>yesterday<span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">,</span>df1<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">,</span>df2<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">,</span> <span class="token comment">#原有的样本,切换后的样本</span>
<span class="token string">'{:.3%}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>df2<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">/</span><span class="token punctuation">(</span>df1<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span>df2<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">,</span> <span class="token comment"># 切换后的样本占比</span>
<span class="token string">'{:.3%}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>df1<span class="token punctuation">[</span><span class="token string">'n30_hj_score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">/</span> df1<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">,</span>  <span class="token comment">#原有的n缺失率（%）</span>
<span class="token string">'{:.3%}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>df2<span class="token punctuation">[</span><span class="token string">'t.v_af_score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">/</span> df2<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">,</span> <span class="token comment">#切换后的n缺失率（%）</span>
<span class="token builtin">abs</span><span class="token punctuation">(</span><span class="token string">'{:.3%}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token punctuation">(</span>df1<span class="token punctuation">[</span><span class="token string">'n30_hj_score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">/</span> df1<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> df2<span class="token punctuation">[</span><span class="token string">'t.v_af_score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">/</span> df2<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">,</span> <span class="token comment">#diff_n（%）</span>
<span class="token string">'{:.3%}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>df1<span class="token punctuation">[</span><span class="token string">'score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">/</span> df1<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">,</span>  <span class="token comment">#原有score缺失率（%）</span>
<span class="token string">'{:.2%}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>df2<span class="token punctuation">[</span><span class="token string">'score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">/</span> df2<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">,</span>  <span class="token comment">#切换后score缺失率（%）</span>
<span class="token builtin">abs</span><span class="token punctuation">(</span><span class="token string">'{:.3%}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>df1<span class="token punctuation">[</span><span class="token string">'score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">/</span> df1<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> df2<span class="token punctuation">[</span><span class="token string">'score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">/</span> df2<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">,</span> <span class="token comment">#diff_score(%)</span>
<span class="token string">'{:.3%}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token punctuation">(</span>df1<span class="token punctuation">[</span><span class="token string">'score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">/</span> df1<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span><span class="token number">0.75</span> <span class="token operator">+</span> <span class="token punctuation">(</span>df2<span class="token punctuation">[</span><span class="token string">'score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">/</span> df2<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">,</span> <span class="token comment">#score整体缺失率（%）</span>
psi<span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">,</span> <span class="token comment"># 切换前后n_psi</span>

<span class="token builtin">abs</span><span class="token punctuation">(</span>df1<span class="token punctuation">[</span><span class="token string">'n30_hj_score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>skew<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>df2<span class="token punctuation">[</span><span class="token string">'t.v_af_score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>skew<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">,</span>  <span class="token comment">#切换前后n偏度差	</span>
<span class="token builtin">abs</span><span class="token punctuation">(</span>df1<span class="token punctuation">[</span><span class="token string">'n30_hj_score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>skew<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0.030766</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">,</span><span class="token builtin">abs</span><span class="token punctuation">(</span>df2<span class="token punctuation">[</span><span class="token string">'t.v_af_score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>skew<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0.030766</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">#切换前n与离线n偏度差	切换后n与离线n偏度差</span>
psi2<span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">,</span> <span class="token comment"># 切换前后score_psi	</span>
<span class="token builtin">file</span><span class="token operator">=</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'log_jryk.txt'</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> date<span class="token punctuation">,</span> timedelta
yesterday <span class="token operator">=</span> <span class="token punctuation">(</span>date<span class="token punctuation">.</span>today<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>days <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%Y-%m-%d"</span><span class="token punctuation">)</span>    <span class="token comment"># 获取前一天日期</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>yesterday<span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">,</span>df1<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">,</span>df2<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">,</span> <span class="token comment">#原有的样本,切换后的样本</span>
<span class="token string">'{:.3%}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>df2<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">/</span><span class="token punctuation">(</span>df1<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span>df2<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">,</span> <span class="token comment"># 切换后的样本占比</span>
<span class="token string">'{:.3%}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>df1<span class="token punctuation">[</span><span class="token string">'n21_score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">/</span> df1<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">,</span>  <span class="token comment">#原有的n缺失率（%）</span>
<span class="token string">'{:.3%}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>df2<span class="token punctuation">[</span><span class="token string">'t.v_af_score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">/</span> df2<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">,</span> <span class="token comment">#切换后的n缺失率（%）</span>
<span class="token builtin">abs</span><span class="token punctuation">(</span><span class="token string">'{:.3%}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token punctuation">(</span>df1<span class="token punctuation">[</span><span class="token string">'n21_score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">/</span> df1<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> df2<span class="token punctuation">[</span><span class="token string">'t.v_af_score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">/</span> df2<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">,</span> <span class="token comment"># diff_n（%）</span>
<span class="token string">'{:.3%}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>df1<span class="token punctuation">[</span><span class="token string">'score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">/</span> df1<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">,</span>  <span class="token comment">#原有score缺失率（%）</span>
<span class="token string">'{:.2%}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>df2<span class="token punctuation">[</span><span class="token string">'t.y_score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">/</span> df2<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">,</span>  <span class="token comment">#切换后score缺失率（%）</span>
<span class="token builtin">abs</span><span class="token punctuation">(</span><span class="token string">'{:.3%}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token punctuation">(</span>df1<span class="token punctuation">[</span><span class="token string">'score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">/</span> df1<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> df2<span class="token punctuation">[</span><span class="token string">'t.y_score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">/</span> df2<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">,</span> <span class="token comment"># diff_score(%)</span>
<span class="token string">'{:.3%}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token punctuation">(</span>df1<span class="token punctuation">[</span><span class="token string">'score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">/</span> df1<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span><span class="token number">0.92</span> <span class="token operator">+</span> <span class="token punctuation">(</span>df2<span class="token punctuation">[</span><span class="token string">'t.y_score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">/</span> df2<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.08</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">,</span> <span class="token comment">#score整体缺失率（%）</span>
psi<span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">,</span> <span class="token comment"># 切换前后n_psi</span>
<span class="token builtin">abs</span><span class="token punctuation">(</span>df1<span class="token punctuation">[</span><span class="token string">'n21_score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>skew<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>df2<span class="token punctuation">[</span><span class="token string">'t.v_af_score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>skew<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">,</span>  <span class="token comment">#切换前后n偏度差	</span>
<span class="token builtin">abs</span><span class="token punctuation">(</span>df1<span class="token punctuation">[</span><span class="token string">'n21_score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>skew<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0.211146</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">,</span><span class="token builtin">abs</span><span class="token punctuation">(</span>df2<span class="token punctuation">[</span><span class="token string">'t.v_af_score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>skew<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0.211146</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">#切换前n与离线n偏度差	切换后n与离线n偏度差</span>
psi2<span class="token punctuation">,</span><span class="token string">'\t'</span><span class="token punctuation">,</span> <span class="token comment"># 切换前后score_psi	</span>
<span class="token builtin">file</span><span class="token operator">=</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'log_wjwl.txt'</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">import</span> logging  <span class="token comment"># 记录日志</span>
logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span><span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'%(asctime)s : %(levelname)s : %(message)s'</span><span class="token punctuation">,</span> level<span class="token operator">=</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">,</span>filename<span class="token operator">=</span><span class="token string">'xf.log'</span><span class="token punctuation">,</span> filemode<span class="token operator">=</span><span class="token string">'w'</span><span class="token punctuation">)</span>
logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'data loading...'</span><span class="token punctuation">)</span>  <span class="token comment"># 自动写入到xf.log</span>

<span class="token keyword">def</span> <span class="token function">concat_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    df1<span class="token operator">=</span>pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'360_key_1w.txt'</span><span class="token punctuation">,</span>sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">)</span>
    df1<span class="token punctuation">[</span><span class="token string">'flag'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span>
    df1<span class="token punctuation">.</span>drop_duplicates<span class="token punctuation">(</span>subset<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span><span class="token string">'idcard'</span><span class="token punctuation">,</span><span class="token string">'phone'</span><span class="token punctuation">,</span><span class="token string">'loan_dt'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    df<span class="token operator">=</span>df<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>df1<span class="token punctuation">,</span> how<span class="token operator">=</span><span class="token string">'left'</span><span class="token punctuation">,</span> on<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'idcard'</span><span class="token punctuation">,</span> <span class="token string">'phone'</span><span class="token punctuation">,</span> <span class="token string">'loan_dt'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>df<span class="token punctuation">)</span>
    df<span class="token operator">=</span>df<span class="token punctuation">[</span>df<span class="token punctuation">[</span><span class="token string">'flag'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    df<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'idcard'</span><span class="token punctuation">,</span> <span class="token string">'phone'</span><span class="token punctuation">,</span> <span class="token string">'loan_dt'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string">'360_key_9w.txt'</span><span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>df<span class="token punctuation">)</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/261e701afcdcdc39171bcef8624c0f60/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">计算机里边的单位换算：b、KB、MB、GB、TB等</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b421c56d3193151eabea7edd24f4645b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Errors during downloading metadata for repository ‘appstream‘ Centos8 yum 失败</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>