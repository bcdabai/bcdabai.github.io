<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>C# IOC 容器实战：KeyedService和生命周期 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="C# IOC 容器实战：KeyedService和生命周期" />
<meta property="og:description" content="文章目录 前言KeyedServiceKey缺少Key值覆盖 KeyedService.AnyKey生命周期测试代码 总结 前言 我之前写过一篇Ioc容器的使用，用的是微软的IOC容器。这次我们再去深入了解一下IOC 和控制反转
.NET Core 依赖注入 Microsoft.Extensions.DependencyInjection
ASP.NET CORE 内置的IOC解读及使用
ServiceCollection IOC容器 服务的生命周期
Dependency Injection 8.0新功能——KeyedService 作者： 寻己Tenleft
出处：https://www.cnblogs.com/tenleft/p/17719609.html
本站使用「CC BY 4.0」创作共享协议，转载请在文章明显位置注明作者及出处。
详解.NET依赖注入中对象的创建与“销毁”
KeyedService 使用Key值来对类进行区分。
Dependency Injection 8.0新功能——KeyedService public class Person { public List&lt;Phone&gt; Phones { get; set; } public Person() { } /// &lt;summary&gt; /// 使用拿到对应的 /// &lt;/summary&gt; /// &lt;param name=&#34;phone1&#34;&gt;&lt;/param&gt; /// &lt;param name=&#34;phone2&#34;&gt;&lt;/param&gt; public Person( [FromKeyedServices(&#34;A&#34;)] Phone phone1, [FromKeyedServices(&#34;B&#34;)] Phone phone2) { Phones = new List&lt;Phone&gt; { phone1, phone2 }; } } public class Phone { public string Name { get; set; } public Phone() { } } static void Main(string[] args) { IServiceCollection services = new ServiceCollection() ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/36462211f649db3ef054612f34c95dcc/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-13T17:56:56+08:00" />
<meta property="article:modified_time" content="2024-01-13T17:56:56+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">C# IOC 容器实战：KeyedService和生命周期</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_2" rel="nofollow">前言</a></li><li><a href="#KeyedService_22" rel="nofollow">KeyedService</a></li><li><ul><li><a href="#Key_122" rel="nofollow">Key缺少</a></li><li><a href="#Key_128" rel="nofollow">Key值覆盖</a></li></ul> 
  </li><li><a href="#KeyedServiceAnyKey_137" rel="nofollow">KeyedService.AnyKey</a></li><li><a href="#_190" rel="nofollow">生命周期</a></li><li><ul><li><a href="#_196" rel="nofollow">测试代码</a></li></ul> 
  </li><li><a href="#_306" rel="nofollow">总结</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_2"></a>前言</h2> 
<p>我之前写过一篇Ioc容器的使用，用的是微软的IOC容器。这次我们再去深入了解一下IOC 和控制反转</p> 
<blockquote> 
 <p><a href="https://blog.csdn.net/qq_44695769/article/details/134819501?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522170513030616800227487726%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&amp;request_id=170513030616800227487726&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-2-134819501-null-null.nonecase&amp;utm_term=IOC%20&amp;spm=1018.2226.3001.4450">.NET Core 依赖注入 Microsoft.Extensions.DependencyInjection</a></p> 
</blockquote> 
<blockquote> 
 <p><a href="https://www.cnblogs.com/jlion/p/12392461.html" rel="nofollow">ASP.NET CORE 内置的IOC解读及使用</a></p> 
</blockquote> 
<blockquote> 
 <p><a href="https://blog.csdn.net/wulex/article/details/111473962">ServiceCollection IOC容器 服务的生命周期</a></p> 
</blockquote> 
<blockquote> 
 <p><a href="https://www.cnblogs.com/tenleft/p/17719609.html" rel="nofollow">Dependency Injection 8.0新功能——KeyedService </a><br> 作者： 寻己Tenleft<br> 出处：https://www.cnblogs.com/tenleft/p/17719609.html<br> 本站使用「CC BY 4.0」创作共享协议，转载请在文章明显位置注明作者及出处。</p> 
</blockquote> 
<blockquote> 
 <p><a href="https://www.cnblogs.com/tenleft/p/17766501.html" rel="nofollow">详解.NET依赖注入中对象的创建与“销毁”</a></p> 
</blockquote> 
<h2><a id="KeyedService_22"></a>KeyedService</h2> 
<p>使用Key值来对类进行区分。</p> 
<blockquote> 
 <p><a href="https://www.cnblogs.com/tenleft/p/17719609.html" rel="nofollow">Dependency Injection 8.0新功能——KeyedService </a></p> 
</blockquote> 
<pre><code class="prism language-csharp"> <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person</span>
 <span class="token punctuation">{<!-- --></span>


     <span class="token keyword">public</span> <span class="token return-type class-name">List<span class="token punctuation">&lt;</span>Phone<span class="token punctuation">&gt;</span></span> Phones <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

     <span class="token keyword">public</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
     
     <span class="token punctuation">}</span>

     <span class="token comment">/// &lt;summary&gt;</span>
     <span class="token comment">/// 使用拿到对应的</span>
     <span class="token comment">/// &lt;/summary&gt;</span>
     <span class="token comment">/// &lt;param name="phone1"&gt;&lt;/param&gt;</span>
     <span class="token comment">/// &lt;param name="phone2"&gt;&lt;/param&gt;</span>
     <span class="token keyword">public</span> <span class="token function">Person</span><span class="token punctuation">(</span> <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">FromKeyedServices</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span> <span class="token class-name">Phone</span> phone1<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">FromKeyedServices</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"B"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span> <span class="token class-name">Phone</span> phone2<span class="token punctuation">)</span>
     <span class="token punctuation">{<!-- --></span>
         Phones <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Phone<span class="token punctuation">&gt;</span></span>
         <span class="token punctuation">{<!-- --></span>
             phone1<span class="token punctuation">,</span>
             phone2
         <span class="token punctuation">}</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>


 <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Phone</span>
 <span class="token punctuation">{<!-- --></span>
     <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

     <span class="token keyword">public</span> <span class="token function">Phone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-csharp"><span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

    <span class="token class-name">IServiceCollection</span> services <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServiceCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Person<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddKeyedScoped</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Phone<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddKeyedScoped</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Phone<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"B"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name"><span class="token keyword">var</span></span> builder <span class="token operator">=</span> services<span class="token punctuation">.</span><span class="token function">BuildServiceProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    builder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetKeyedService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Phone<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Name <span class="token operator">=</span> <span class="token string">"大米"</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetKeyedService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Phone<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"B"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Name <span class="token operator">=</span> <span class="token string">"小花"</span><span class="token punctuation">;</span>

    <span class="token class-name"><span class="token keyword">var</span></span> person <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Person<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>JsonConvert<span class="token punctuation">.</span><span class="token function">SerializeObject</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"运行完成！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Console<span class="token punctuation">.</span><span class="token function">ReadKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/6e/f6/O4sGSudH_o.png" alt="在这里插入图片描述"></p> 
<p>也可以这么写</p> 
<pre><code class="prism language-csharp"> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
 <span class="token punctuation">{<!-- --></span>

     <span class="token class-name">IServiceCollection</span> services <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServiceCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>NetCore<span class="token punctuation">.</span>Models<span class="token punctuation">.</span>Person<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddKeyedScoped</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Phone<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>sp<span class="token punctuation">,</span>key<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
         <span class="token punctuation">{<!-- --></span>
             <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Phone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>Name <span class="token operator">=</span> <span class="token string">"小花"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddKeyedScoped</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Phone<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"B"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>sp<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
         <span class="token punctuation">{<!-- --></span>
             <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Phone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> Name <span class="token operator">=</span> <span class="token string">"大米"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token class-name"><span class="token keyword">var</span></span> builder <span class="token operator">=</span> services<span class="token punctuation">.</span><span class="token function">BuildServiceProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     


     <span class="token class-name"><span class="token keyword">var</span></span> person <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>NetCore<span class="token punctuation">.</span>Models<span class="token punctuation">.</span>Person<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

     Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>JsonConvert<span class="token punctuation">.</span><span class="token function">SerializeObject</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



     Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"运行完成！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     Console<span class="token punctuation">.</span><span class="token function">ReadKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="Key_122"></a>Key缺少</h3> 
<p>如果Key的构造函数对应不上，就会出现问题</p> 
<p><img src="https://images2.imgbox.com/f3/64/TJJqVA94_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/46/3f/xMd9E8Kj_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="Key_128"></a>Key值覆盖</h3> 
<p><img src="https://images2.imgbox.com/f7/58/0ZqfCNee_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/81/e6/x43hxG2F_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/51/bf/ov5V7FgF_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="KeyedServiceAnyKey_137"></a>KeyedService.AnyKey</h2> 
<p>因为之前的KeyService的要求是必须声明，才能注入，如果缺一个就直接不走构造函数了，实在是太严格了。</p> 
<p>使用KeyedService.AnyKey就是尽可能的获取对应的Key的服务</p> 
<pre><code class="prism language-csharp">        <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>

            <span class="token class-name">IServiceCollection</span> services <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServiceCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>NetCore<span class="token punctuation">.</span>Models<span class="token punctuation">.</span>Person<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddKeyedScoped</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Phone<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>KeyedService<span class="token punctuation">.</span>AnyKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> builder <span class="token operator">=</span> services<span class="token punctuation">.</span><span class="token function">BuildServiceProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//builder.GetServices&lt;Phone&gt;();</span>
            <span class="token class-name"><span class="token keyword">var</span></span> res <span class="token operator">=</span>  builder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetKeyedService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Phone<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> person <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>NetCore<span class="token punctuation">.</span>Models<span class="token punctuation">.</span>Person<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>JsonConvert<span class="token punctuation">.</span><span class="token function">SerializeObject</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"运行完成！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">ReadKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Phone</span>
<span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">Phone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 尝试去拿Key的值</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;param name="key"&gt;&lt;/param&gt;</span>
    <span class="token keyword">public</span> <span class="token function">Phone</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ServiceKey</span></span><span class="token punctuation">]</span> <span class="token class-name"><span class="token keyword">string</span></span> key <span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"我拿到Key了</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">key</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/9c/20/8UtscSHZ_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_190"></a>生命周期</h2> 
<p>详情可以看这篇文章，写的是真的厉害</p> 
<blockquote> 
 <p><a href="https://www.cnblogs.com/tenleft/p/17766501.html" rel="nofollow">详解.NET依赖注入中对象的创建与“销毁”</a></p> 
</blockquote> 
<h3><a id="_196"></a>测试代码</h3> 
<ul><li>this.GetHashCode()会返回每个新对象唯一的code，来区分对象</li><li>继承IDisposable后，IOC容器会在合适的地方自动调用Dispose方法</li></ul> 
<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SingleService</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IDisposable</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">SingleService</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ServiceKey</span></span><span class="token punctuation">]</span> <span class="token class-name"><span class="token keyword">string</span></span> key<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        Name <span class="token operator">=</span> key<span class="token punctuation">;</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"我被创造了[</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Name</span><span class="token punctuation">}</span></span><span class="token string">]-</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp"><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">GetHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"我被销毁了[</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Name</span><span class="token punctuation">}</span></span><span class="token string">]-</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp"><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">GetHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ScopedService</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IDisposable</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">ScopedService</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"我被创造了[</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Name</span><span class="token punctuation">}</span></span><span class="token string">]-</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp"><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">GetHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">ScopedService</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ServiceKey</span></span><span class="token punctuation">]</span> <span class="token class-name"><span class="token keyword">string</span></span> key<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        Name <span class="token operator">=</span> key<span class="token punctuation">;</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"我被创造了[</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Name</span><span class="token punctuation">}</span></span><span class="token string">]-</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp"><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">GetHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"我被销毁了[</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Name</span><span class="token punctuation">}</span></span><span class="token string">]-</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp"><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">GetHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransientService</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IDisposable</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">TransientService</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ServiceKey</span></span><span class="token punctuation">]</span> <span class="token class-name"><span class="token keyword">string</span></span> key<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        Name <span class="token operator">=</span> key<span class="token punctuation">;</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"我被创造了[</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Name</span><span class="token punctuation">}</span></span><span class="token string">]-</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp"><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">GetHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>



    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"我被销毁了[</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Name</span><span class="token punctuation">}</span></span><span class="token string">]-</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp"><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">GetHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<pre><code class="prism language-csharp"><span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

    <span class="token class-name"><span class="token keyword">var</span></span> services <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServiceCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddKeyedSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SingleService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>KeyedService<span class="token punctuation">.</span>AnyKey<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddKeyedScoped</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ScopedService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>KeyedService<span class="token punctuation">.</span>AnyKey<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddKeyedTransient</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TransientService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>KeyedService<span class="token punctuation">.</span>AnyKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">BuildServiceProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetKeyedService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SingleService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetKeyedService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ScopedService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"B"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetKeyedService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TransientService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"C"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetKeyedService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SingleService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetKeyedService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ScopedService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"B"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetKeyedService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TransientService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"C"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//测试Scoped</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> scope <span class="token operator">=</span> services<span class="token punctuation">.</span><span class="token function">CreateScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        scope<span class="token punctuation">.</span>ServiceProvider<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetKeyedService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SingleService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        scope<span class="token punctuation">.</span>ServiceProvider<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetKeyedService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ScopedService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"B"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        scope<span class="token punctuation">.</span>ServiceProvider<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetKeyedService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TransientService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"C"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"运行完成！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Console<span class="token punctuation">.</span><span class="token function">ReadKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/21/c0/sog8AJ57_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_306"></a>总结</h2> 
<p>这次算是补上了上次的坑，彻底弄懂了IOC 容器的生命周期。怎么玩我还不了解，懂了至少吹牛逼的时候有谈资。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c2b5eabcb4d3daf0586d144d98d6c1f8/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">jmap使用</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a7c53a84aa6c9587d14ff6fae5c7bc39/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">深入浅出的说地弹(即地噪声)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>