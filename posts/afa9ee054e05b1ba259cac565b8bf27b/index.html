<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>shell邮件发送脚本 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="shell邮件发送脚本" />
<meta property="og:description" content="先上整体代码
text.sh
#!/bin/bash # 设置收件人邮箱 to=&#34;123456@qq.com&#34; # 设置发件人邮箱 from=&#34;21331@qq.com&#34; # 设置邮件主题 subject=&#34;Test Email&#34; # 设置邮件内容 body=&#34;This is a test email.&#34; # 发送邮件 echo &#34;${body}&#34; | mail -s &#34;${subject}&#34; -r &#34;${from}&#34; &#34;${to}&#34; 再说详细配置，以及思路
一.配置qq邮箱（需要生成授权码）
QQ邮箱-POP服务开启步骤：
1、使用电脑登录mail.qq.com，进入【设置】；
2、换到【账户】选项；
3、在POP3/IMAP… CalDAV服务下，将【POP3/SMTP服务】开启；
4、通过扫一扫/一键验证/手机令牌/短信验证方式获取授权码，并记住此授权码
（注：若POP3/SMTP已开启，直接点击生成授权码，使用授权码登录第三方客户端。用于登录TIM）；
5、将收取选项从最近30天改为全部，并勾选以下四个选项；
6、点击【保存更改】完成设置，使用授权码登录邮箱。 二.配置linux环境
1.直接运行以下命令自动追加内容
#未加密的发送方式通过25端口,会被公有云封掉. cat &gt;&gt;/etc/mail.rc &lt;&lt;EOF set from=12121@qq.com set smtp=smtp.qq.com set smtp-auth-user=12121@qq.com set smtp-auth-password=授权码 set smtp-auth=login EOF #加密的方式465端口 cat &gt;&gt;/etc/mail.rc &lt;&lt;EOF set nss-config-dir=/etc/pki/nssdb/ #加密方式配置 set smtp-user-starttls #加密方式配置 set ssl-verify=ignore #加密方式配置 set from=12121@qq." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/afa9ee054e05b1ba259cac565b8bf27b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-24T11:01:45+08:00" />
<meta property="article:modified_time" content="2023-08-24T11:01:45+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">shell邮件发送脚本</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>先上整体代码</p> 
<p>text.sh</p> 
<pre><code class="language-bash">#!/bin/bash

# 设置收件人邮箱
to="123456@qq.com"

# 设置发件人邮箱
from="21331@qq.com"

# 设置邮件主题
subject="Test Email"

# 设置邮件内容
body="This is a test email."

# 发送邮件
echo "${body}" | mail -s "${subject}" -r "${from}" "${to}"</code></pre> 
<p>再说详细配置，以及思路</p> 
<p>一.配置qq邮箱（需要生成授权码）</p> 
<p>QQ邮箱-POP服务开启步骤：</p> 
<p></p> 
<p>1、使用电脑登录mail.qq.com，进入【设置】；</p> 
<p></p> 
<p class="img-center"><img alt="" height="142" src="https://images2.imgbox.com/0e/23/8v4zzhtC_o.jpg" width="562"></p> 
<p> </p> 
<p>2、换到【账户】选项；</p> 
<p></p> 
<p class="img-center"><img alt="" height="142" src="https://images2.imgbox.com/89/b5/7V5up6Sh_o.jpg" width="562"></p> 
<p> </p> 
<p>3、在POP3/IMAP… CalDAV服务下，将【POP3/SMTP服务】开启；</p> 
<p></p> 
<p class="img-center"><img alt="" height="142" src="https://images2.imgbox.com/ab/70/whJOPOch_o.jpg" width="769"></p> 
<p> </p> 
<p>4、通过扫一扫/一键验证/手机令牌/短信验证方式获取授权码，并记住此授权码</p> 
<p class="img-center"><img alt="" height="317" src="https://images2.imgbox.com/83/dd/uRJP3IKQ_o.jpg" width="495"></p> 
<p></p> 
<p class="img-center"><img alt="" height="345" src="https://images2.imgbox.com/6f/51/psIJHUtV_o.jpg" width="604"></p> 
<p> </p> 
<p>（注：若POP3/SMTP已开启，直接点击生成授权码，使用授权码登录第三方客户端。用于登录TIM）；</p> 
<p></p> 
<p class="img-center"><img alt="" height="103" src="https://images2.imgbox.com/e9/18/N9yABV7i_o.jpg" width="604"></p> 
<p> </p> 
<p>5、将收取选项从最近30天改为全部，并勾选以下四个选项；</p> 
<p></p> 
<p class="img-center"><img alt="" height="199" src="https://images2.imgbox.com/e8/10/0wCC9ZXN_o.jpg" width="495"></p> 
<p> </p> 
<p>6、点击【保存更改】完成设置，使用授权码登录邮箱。 </p> 
<p>二.配置linux环境</p> 
<p>1.直接运行以下命令自动追加内容</p> 
<pre><code class="language-bash">#未加密的发送方式通过25端口,会被公有云封掉.
cat &gt;&gt;/etc/mail.rc &lt;&lt;EOF
set from=12121@qq.com
set smtp=smtp.qq.com
set smtp-auth-user=12121@qq.com
set smtp-auth-password=授权码
set smtp-auth=login
EOF

#加密的方式465端口
cat &gt;&gt;/etc/mail.rc &lt;&lt;EOF
set nss-config-dir=/etc/pki/nssdb/          #加密方式配置
set smtp-user-starttls                      #加密方式配置
set ssl-verify=ignore                       #加密方式配置
set from=12121@qq.com                       #配置发件人
set smtp=smtps://smtp.qq.com:465            #配置使用qq邮箱发送邮件，不加密方式参考上面
set smtp-auth-user=12121@qq.com             #邮箱名
set smtp-auth-password=授权码                #授权码
set smtp-auth=login                         #认证形式
EOF
</code></pre> 
<p>2.或者在根目录下找到/etc/mail.rc文件</p> 
<p>在最后添加（未加密采用未加密的，想用加密采用加密的）</p> 
<pre><code class="language-bash">#采用未加密：
set from=12121@qq.com
set smtp=smtp.qq.com
set smtp-auth-user=12121@qq.com
set smtp-auth-password=授权码
set smtp-auth=login

#采用加密
set nss-config-dir=/etc/pki/nssdb/          #加密方式配置
set smtp-user-starttls                      #加密方式配置
set ssl-verify=ignore                       #加密方式配置
set from=12121@qq.com                       #配置发件人
set smtp=smtps://smtp.qq.com:465            #配置使用qq邮箱发送邮件，不加密方式参考上面
set smtp-auth-user=12121@qq.com             #邮箱名
set smtp-auth-password=授权码                #授权码
set smtp-auth=login  </code></pre> 
<p>三.运行text.sh（三种方式都可以运行）</p> 
<pre><code class="language-bash">1. bash text.sh
指明先用bash解析器解析
如果bash不存在 才会使用默认解析器
2. ./text.sh
./xxx.sh :先按照 文件中#!指定的解析器解析
如果#！指定指定的解析器不存在 才会使用系统默认的解析器
3. . text.sh
直接使用默认解析器解析（不会执行第一行的#！指定的解析器）但是第一行还是要写的</code></pre> 
<p>(注意：脚本文件权限问题) </p> 
<p>如果此时成功了，便可以收到邮件，如果没有继续往下（一般是不会发送成功）</p> 
<p>四.报错</p> 
<p>#发送完邮件后报错<br> Error in certificate: Peer's certificate issuer is not recognized.<br> 或者是其他的（其他的一般是账号，授权码不一致的问题导致的）</p> 
<p>如果报错：Error in certificate: Peer's certificate issuer is not recognized.</p> 
<p>说明是证书没有配置导致的</p> 
<p>此时需要配置证书</p> 
<p>1.检查系统是否安装mailx，一般centos都会自带，如果没有运行<code>yum -y install mail</code></p> 
<pre><code class="language-bash">[root@catchfires ~]# rpm -qa |grep mailx
mailx-12.4-10.el6_10.x86_64</code></pre> 
<p>2./etc/pki/nssdb 目录查看证书，没有放qq.crt的证书，解决方法如下</p> 
<pre><code class="language-bash">[root@catchfires ~]# cd /etc/pki/nssdb/
[root@catchfires nssdb]# echo -n | openssl s_client -connect smtp.qq.com:465 | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' &gt; ./qq.crt
[root@catchfires nssdb]# certutil -A -n "GeoTrust SSL CA - G3" -t "Pu,Pu,Pu"  -d ./ -i qq.crt //添加一个证书到证书数据库中
[root@catchfires nssdb]# echo "test" |mail -s test 123456@qq.com
// 如果没有certutil命令，可以运行yum install -y nss-tools</code></pre> 
<p>3.再次运行shell脚本，发现成功并且没有报错</p> 
<p>4.下面开始添加网络监控系统及时报警，大致的逻辑是1分钟一次统计网络丢包情况，如果丢包&gt; 2%时，发送邮件。</p> 
<pre><code class="language-bash">[root@catchfires ~]# cat /etc/crontab |grep moniter
 */1 * * * * root /root/moniter.sh #添加一分钟一次的网络监控程序
[root@catchfires ~]# cat /root/moniter.sh
#!/bin/bash
ping 223.5.5.5 -n -i 0.5 -q -w 50 -W 1|xargs|awk '{echo -e "\n";printf("%-10s %-15s %6s %s/%s %40s\n",strftime("%F %H:%M:%S"),$2, $18, $13, $16, $26)}' &gt;&gt;/tmp/moniter.log

ping1=`tail /tmp/moniter.log|grep -v " 0%"|grep -v " 1%"|grep -v " 2%"|awk '{print $4" "$3" "$2" "$1}'|tail -n1`
ping2=`tail /tmp/moniter.log|grep -v " 0%"|grep -v " 1%"|grep -v " 2%"|awk '{print $4}'|cut -f1 -d%|tail -n1`
if [ $ping2 -gt 3 ] #bash的判断相当恶心，if前后，[]前后都必须有空格
then
echo $ping1 |mail -s "$ping1" 123456qq.com
fi</code></pre> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fe0a2c70fb53dda71cdfb6937a694de4/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">No valid entries or contents found, this is not a valid OOXML (Office Open XML) file</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/832c58b7ff1720b23ed53f069a08568a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">iOS逆向初探：揭开iOS App的神秘面纱</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>