<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>k8s的对外服务ingress - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="k8s的对外服务ingress" />
<meta property="og:description" content="1、service的作用体现在两个方面 （1）集群内部：不断跟踪pod的变化，更新deployment中的pod对象，基于pod的ip地址不断变化的一种服务发现机制 （2）集群外部：类似于负载均衡器，把流量ip&#43;端口，不涉及转发url（http/https），把请求转发到pod当中 2、service nodeport
容器端口——service端口——nodeport
设定了nodeport，每个节点都会有一个端口被打开（30000-32767）
ip&#43;端口：节点ip&#43;30000-32767，实现负载均衡
loadbalancer
云平台上的一种service服务，云平台提供负载均衡ip地址
extrenal
域名映射
3、ingress：基于域名进行映射，把url（http/https）请求转发到service，再由service把请求转发到每个pod ①ingress：只要一个或者少量的公网ip/LB，可以把多个http请求暴露到外网，七层反向代理 ②ingress：是service的service，是一组基于域名和url路径，把一个或者多个请求转发到service的规则 ④先是七层代理（ingress）——再是四层代理（server）——pod（nginx） 4、ingress的组成 （1）ingress是一个api对象，通过yaml文件来进行配置
（2）ingress的作用：定义请求如何转发到service的规则，配置模版
（3）ingress通过http和https暴露集群内部的service，给service提供一个外部的url、负载均衡、ssl/tls（https）的能力，实现基于域名的负载均衡
ingress-controller
①具体的实现反向代理和负载均衡的程序，对ingress定义的规则进行解析，根据ingress的配置规则进行请求的转发
②ingress-controller不是k8s自带的组件功能，ingress-controller是一个统称
③ingress-controller：nginx ingress controller、traefik（开源）
④ingress-controller的运行方式：pod形式运行在节点上
5、ingress资源的定义项 （1）定义外部流量的路由规则 （2）定义服务的暴露方式：主机名、访问的路径（url）和其他的选项 （3）负载均衡（ingress-controller实现） 6、下载nginx ingress controller wget https://gitee.com/mirrors/ingress-nginx/raw/nginx-0.30.0/deploy/static/mandatory.yaml 7、ingress暴露服务的方式 （1）deployment&#43;LoadBalance模式，ingress部署在公有云 ①ingress的配置文件里面会有一个type，type键值对形式type:LoadBalance ②公有云平台会为LoadBalance的service创建一个负载均衡器，绑定一个公网地址，通过域名指向这个公网地址，就可以实现集群对外暴露 （2）daemonSet&#43;hostnetwork&#43;nodeselector（七层代理upstream） ①daemonset：在每个节点都会创建一个pod ②hostnetwork：pod共享节点主机的网络命名空间，pod中的容器直接使用节点主机的ip&#43;端口，pod中的容器可以直接访问主机上的网络资源 ③nodeselector：根据标签选择部署的节点，nginx-ingress-controller部署的节点 缺点：直接利用节点主机的网络和端口，一个node只能部署一个ingress-controller的pod，适合大并发的生产环境
优点：性能最好
（3）deployment&#43;NodePort（七层&#43;四层） 8、部署daemonSet&#43;hostnetwork&#43;nodeselector （1）修改配置文件mandatory.yaml （2）每个节点上传控制器的镜像 tar -xf ingree.contro-0.30.0.tar.gz docker load -i ingree.contro-0.30.0.tar （3）节点设置标签 kubectl label nodes node2 ingress=true netstat -antp | grep nginx 8181端口：nginx-controller默认配置的一个bachend，反向代理的端口" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/c2c5b8246fabcec4eb12895d962b4816/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-18T17:03:57+08:00" />
<meta property="article:modified_time" content="2024-01-18T17:03:57+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">k8s的对外服务ingress</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h4 style="text-align:justify;"><strong>1、service的作用体现在两个方面</strong></h4> 
<h5 style="text-align:justify;"><strong>（1）集群内部：不断跟踪pod的变化，更新deployment中的pod对象，基于pod的ip地址不断变化的一种服务发现机制</strong></h5> 
<h5 style="text-align:justify;"><strong>（2）集群外部：类似于负载均衡器，把流量ip+端口，不涉及转发url（http/https），把请求转发到pod当中</strong></h5> 
<h4 style="text-align:justify;"><strong>2、service</strong></h4> 
<table border="1" cellspacing="0"><tbody><tr><td style="vertical-align:top;width:75.6pt;"> <p><strong>nodeport</strong></p> </td><td style="vertical-align:top;width:350.5pt;"> <p><strong>容器端口——service端口——nodeport</strong></p> <p><strong>设定了nodeport，每个节点都会有一个端口被打开（30000-32767）</strong></p> <p><strong>ip+端口：节点ip+30000-32767，实现负载均衡</strong></p> </td></tr><tr><td style="vertical-align:top;width:75.6pt;"> <p><strong>loadbalancer</strong></p> </td><td style="vertical-align:top;width:350.5pt;"> <p><strong>云平台上的一种service服务，云平台提供负载均衡ip地址</strong></p> </td></tr><tr><td style="vertical-align:top;width:75.6pt;"> <p><strong>extrenal</strong></p> </td><td style="vertical-align:top;width:350.5pt;"> <p><strong>域名映射</strong></p> </td></tr></tbody></table> 
<h4 style="text-align:justify;"><strong>3、ingress：基于域名进行映射，把url（http/https）请求转发到service，再由service把请求转发到每个pod</strong></h4> 
<h5 style="text-align:justify;"><strong>①ingress：只要一个或者少量的公网ip/LB，可以把多个http请求暴露到外网，</strong><strong><span style="color:#0000ff;">七层反向代理</span></strong></h5> 
<h5 style="text-align:justify;"><strong>②ingress：是service的service，</strong><strong><span style="color:#0000ff;">是一组基于域名和url路径，把一个或者多个请求转发到service的规则</span></strong></h5> 
<h5 style="text-align:justify;"><strong>④先是七层代理（ingress）——再是四层代理（server）——pod（nginx）</strong></h5> 
<h4 style="text-align:justify;"><strong>4、ingress的组成</strong></h4> 
<table border="1" cellspacing="0"><tbody><tr><td style="vertical-align:top;width:426.1pt;"> <p><strong>（1）ingress是一个api对象，通过yaml文件来进行配置</strong></p> <p><strong>（2）ingress的作用：定义请求如何转发到service的规则，配置模版</strong></p> <p><strong>（3）ingress通过http和https暴露集群内部的service，给service提供一个外部的url、负载均衡、ssl/tls（https）的能力，实现基于域名的负载均衡</strong></p> </td></tr><tr><td style="vertical-align:top;width:426.1pt;"> <p><strong><span style="color:#0000ff;">ingress-controller</span></strong></p> <p><strong>①</strong><strong><span style="color:#0000ff;">具体的实现反向代理和负载均衡的程序</span></strong><strong>，对</strong><strong><span style="color:#0000ff;">ingress定义的规则进行解析，根据ingress的配置规则进行请求的转发</span></strong></p> <p><strong>②</strong><strong>ingress-controller不是k8s自带的组件功能，ingress-controller是一个统称</strong></p> <p><strong>③ingress-controller：</strong><strong>nginx ingress controller、traefik（开源）</strong></p> <p><strong>④</strong><strong>ingress-controller的运行方式：pod形式运行在节点上</strong></p> </td></tr></tbody></table> 
<h4 style="text-align:justify;"><strong>5、ingress资源的定义项</strong></h4> 
<h5 style="text-align:justify;"><strong>（1）定义外部流量的路由规则</strong></h5> 
<h5 style="text-align:justify;"><strong>（2）定义服务的暴露方式：主机名、访问的路径（url）和其他的选项</strong></h5> 
<h5 style="text-align:justify;"><strong>（3）负载均衡（ingress-controller实现）</strong></h5> 
<h4 style="text-align:justify;"><strong>6、下载</strong><strong>nginx ingress controller</strong></h4> 
<h5 style="text-align:justify;"><strong>wget https://gitee.com/mirrors/ingress-nginx/raw/nginx-0.30.0/deploy/static/mandatory.yaml</strong></h5> 
<p><img alt="" height="202" src="https://images2.imgbox.com/db/43/yd5QK1Zf_o.png" width="830"></p> 
<h4 style="text-align:justify;"><strong>7、ingress暴露服务的方式</strong></h4> 
<h5 style="text-align:justify;"><strong><span style="color:#0000ff;">（1）deployment+LoadBalance模式，ingress部署在公有云</span></strong></h5> 
<h5 style="text-align:justify;"><strong>①ingress的配置文件里面会有一个type，type键值对形式type:LoadBalance</strong></h5> 
<h5 style="text-align:justify;"><strong>②公有云平台会为LoadBalance的service创建一个负载均衡器，绑定一个公网地址，通过域名指向这个公网地址，就可以实现集群对外暴露</strong></h5> 
<h5 style="text-align:justify;"><strong><span style="color:#0000ff;">（2）daemonSet+hostnetwork+nodeselector（七层代理upstream）</span></strong></h5> 
<h5 style="text-align:justify;"><strong>①daemonset：在每个节点都会创建一个pod</strong></h5> 
<h5 style="text-align:justify;"><strong>②hostnetwork：pod共享节点主机的网络命名空间，pod中的容器直接使用节点主机的ip+端口，pod中的容器可以直接访问主机上的网络资源</strong></h5> 
<h5 style="text-align:justify;"><strong>③nodeselector：根据标签选择部署的节点，nginx-ingress-controller部署的节点</strong></h5> 
<table border="1" cellspacing="0"><tbody><tr><td style="vertical-align:top;width:426.1pt;"> <p><strong>缺点：直接利用节点主机的网络和端口，一个node只能部署一个ingress-controller的pod，适合大并发的生产环境</strong></p> <p><strong>优点：性能最好</strong></p> </td></tr></tbody></table> 
<p><img alt="" height="405" src="https://images2.imgbox.com/d6/b1/fUpU5D3M_o.png" width="830"></p> 
<h5 style="text-align:justify;"><strong><span style="color:#0000ff;">（3）deployment+NodePort（七层+四层）</span></strong></h5> 
<p><img alt="" height="398" src="https://images2.imgbox.com/7b/be/sL0XWdgX_o.png" width="831"></p> 
<h4 style="text-align:justify;"><strong>8、部署daemonSet+hostnetwork+nodeselector</strong></h4> 
<h5 style="text-align:justify;"><strong>（1）修改配置文件mandatory.yaml</strong></h5> 
<p><img alt="" height="673" src="https://images2.imgbox.com/9c/ba/3JNu6FXB_o.png" width="680"></p> 
<p><img alt="" height="253" src="https://images2.imgbox.com/74/1c/TBvfDzH2_o.png" width="830"></p> 
<h5 style="text-align:justify;"><strong>（2）每个节点上传控制器的镜像</strong></h5> 
<h5 style="text-align:justify;"><strong>tar -xf ingree.contro-0.30.0.tar.gz</strong></h5> 
<h5 style="text-align:justify;"><strong>docker load -i ingree.contro-0.30.0.tar</strong></h5> 
<p><img alt="" height="125" src="https://images2.imgbox.com/1c/2c/JamKFzgT_o.png" width="831"></p> 
<h5 style="text-align:justify;"><strong>（3）节点设置标签</strong></h5> 
<h5 style="text-align:justify;"><strong>kubectl label nodes node2 ingress=true</strong></h5> 
<p><img alt="" height="154" src="https://images2.imgbox.com/b4/bd/bm2NVkjP_o.png" width="831"></p> 
<p><img alt="" height="100" src="https://images2.imgbox.com/2b/20/4TPYZ1aS_o.png" width="830"></p> 
<h5 style="text-align:justify;"><strong>netstat -antp | grep nginx</strong></h5> 
<p><img alt="" height="173" src="https://images2.imgbox.com/bf/af/pu6rNLEZ_o.png" width="830"></p> 
<table border="1" cellspacing="0"><tbody><tr><td style="vertical-align:top;width:426.1pt;"> <p><strong>8181端口：nginx-controller默认配置的一个bachend，反向代理的端口</strong></p> <p><strong>所有的请求当中，只要是不符合ingress配置的请求会转发到8181，相当于一个error的页面</strong></p> </td></tr></tbody></table> 
<p style="margin-left:.0001pt;text-align:justify;"><strong>（4）创建PVC、pod、service、ingress规则</strong></p> 
<p><img alt="" height="264" src="https://images2.imgbox.com/bc/92/n1fC6TIp_o.png" width="517"></p> 
<p><img alt="" height="619" src="https://images2.imgbox.com/4e/db/YSUhZMmy_o.png" width="635"></p> 
<p><img alt="" height="541" src="https://images2.imgbox.com/14/4e/z3oqspR4_o.png" width="830"></p> 
<p><img alt="" height="108" src="https://images2.imgbox.com/6e/fc/fhpcMrdM_o.png" width="830"></p> 
<h5 style="text-align:justify;"><strong>（5）配置映射</strong></h5> 
<p><img alt="" height="197" src="https://images2.imgbox.com/71/1f/wUH0FuEX_o.png" width="744"></p> 
<h5 style="text-align:justify;"><strong>（6）测试访问</strong></h5> 
<p><img alt="" height="158" src="https://images2.imgbox.com/9c/10/lfSN7tMO_o.png" width="831"></p> 
<p><img alt="" height="452" src="https://images2.imgbox.com/c5/a0/FjeluVFs_o.png" width="831"></p> 
<p><img alt="" height="200" src="https://images2.imgbox.com/72/b6/uSfQ7TN2_o.png" width="830"></p> 
<p><img alt="" height="73" src="https://images2.imgbox.com/fb/73/nVtwSB70_o.png" width="608"></p> 
<h4 style="text-align:justify;"><strong>8、deployment+NodePort（七层+四层）</strong></h4> 
<p><img alt="" height="209" src="https://images2.imgbox.com/45/39/cGgpFwNX_o.png" width="830"></p> 
<h5 style="text-align:justify;"><strong>（1）修改配置文件vim mandatory.yaml</strong></h5> 
<p><img alt="" height="665" src="https://images2.imgbox.com/c1/cf/ywdcE2V6_o.png" width="735"></p> 
<p><img alt="" height="341" src="https://images2.imgbox.com/41/66/yWetcldc_o.png" width="831"></p> 
<p><img alt="" height="129" src="https://images2.imgbox.com/5a/9a/44K6rNLp_o.png" width="831"></p> 
<h5 style="text-align:justify;"><strong>（2）下载nodeport模版文件：</strong></h5> 
<h5 style="text-align:justify;"><strong>wget https://gitee.com/mirrors/ingress-nginx/raw/nginx-0.30.0/deploy/static/provider/baremetal/service-nodeport.yaml</strong></h5> 
<p><img alt="" height="257" src="https://images2.imgbox.com/d8/20/RK0vTktv_o.png" width="830"></p> 
<p><img alt="" height="583" src="https://images2.imgbox.com/de/6e/HMHwXRTP_o.png" width="831"></p> 
<p><img alt="" height="361" src="https://images2.imgbox.com/05/83/xieJWjHS_o.png" width="831"><img alt="" height="106" src="https://images2.imgbox.com/35/2d/EURSHVIO_o.png" width="830"></p> 
<h5 style="text-align:justify;"><strong>①nodeport在每一节点上都暴露32110和32336的端口</strong></h5> 
<p><img alt="" height="137" src="https://images2.imgbox.com/f6/c2/FOQPNuNb_o.png" width="831"></p> 
<p><img alt="" height="95" src="https://images2.imgbox.com/4f/cd/Oz9xQhC0_o.png" width="830"></p> 
<h5 style="text-align:justify;"><strong>（</strong><strong>3</strong><strong>）</strong><strong>创建PVC、pod、service、ingress规则</strong></h5> 
<p><img alt="" height="268" src="https://images2.imgbox.com/ba/f6/vTASRWIL_o.png" width="523"></p> 
<p><img alt="" height="617" src="https://images2.imgbox.com/71/4d/matPKEIB_o.png" width="581"></p> 
<p><img alt="" height="645" src="https://images2.imgbox.com/ae/d0/mmpTZ3BQ_o.png" width="479"></p> 
<p><img alt="" height="532" src="https://images2.imgbox.com/c6/ab/sVOjLPMs_o.png" width="830"></p> 
<h5 style="text-align:justify;"><strong>（4）配置映射</strong></h5> 
<p><img alt="" height="153" src="https://images2.imgbox.com/ff/15/fYTyPf7E_o.png" width="495"></p> 
<h5 style="text-align:justify;"><strong>（5）访问测试</strong></h5> 
<p><img alt="" height="145" src="https://images2.imgbox.com/07/3a/nJNTIlWb_o.png" width="831"></p> 
<p><img alt="" height="111" src="https://images2.imgbox.com/70/23/sk36MS5H_o.png" width="831"></p> 
<h5 style="text-align:justify;"><strong>（6）deployment+NodePort总结</strong></h5> 
<h5 style="text-align:justify;"><strong>①nodeport由ingress的service创建的，不是deployment的service创建的</strong></h5> 
<h5 style="text-align:justify;"><strong>②nodeport适用于小集群</strong></h5> 
<h5 style="text-align:justify;"><strong>③ingress根据标签匹配ingress-nodeport，ingress-nodeport再根据标签匹配service，service再匹配deployment</strong></h5> 
<h5 style="text-align:justify;"><strong>④每个节点都有一个controller，controller接收到解析后的请求ip和端口</strong></h5> 
<h5 style="text-align:justify;"><strong>（7）ingress暴露服务的方式：核心的控制组件nginx-ingress-controller</strong></h5> 
<h5 style="text-align:justify;"><strong>①host——ingress的配置找到pod——controller转发请求到pod</strong></h5> 
<h5 style="text-align:justify;"><strong>②nodeport——controller——ingress——service转发请求到pod</strong></h5> 
<h5 style="text-align:justify;"><strong>③nodeport暴露端口的方式是最简单的方法，但是nodeport多了一层nat地址转换</strong></h5> 
<h5 style="text-align:justify;"><strong>并发量大的对性能会有一定的影响，内部都会用nodeport</strong></h5> 
<p></p> 
<h4 style="text-align:justify;"><strong>9、通过虚拟主机的方式实现http代理</strong></h4> 
<h5 style="text-align:justify;"><strong>（1）通过ingress方式实现：一个ingress可以访问不同的主机</strong></h5> 
<h5 style="text-align:justify;"><strong>（2）创建pod和service</strong></h5> 
<p><img alt="" height="697" src="https://images2.imgbox.com/70/b7/iou2PvXy_o.png" width="503"></p> 
<p><img alt="" height="697" src="https://images2.imgbox.com/92/db/xahn41iu_o.png" width="446"></p> 
<p><img alt="" height="466" src="https://images2.imgbox.com/fa/ea/0vNUXSMv_o.png" width="830"></p> 
<h5 style="text-align:justify;"><strong>（</strong><strong>3</strong><strong>）</strong><strong>创建ingress</strong></h5> 
<p><img alt="" height="377" src="https://images2.imgbox.com/1f/d8/x164TseE_o.png" width="430"></p> 
<p><img alt="" height="396" src="https://images2.imgbox.com/74/8f/EtCsT6cc_o.png" width="450"></p> 
<p><img alt="" height="596" src="https://images2.imgbox.com/64/21/NDmdexQI_o.png" width="519"></p> 
<p><img alt="" height="234" src="https://images2.imgbox.com/9c/16/7bGp3XyD_o.png" width="831"></p> 
<h5 style="text-align:justify;"><strong>（</strong><strong>4</strong><strong>）</strong><strong>配置映射</strong></h5> 
<p><img alt="" height="197" src="https://images2.imgbox.com/7d/23/Ugbq5xXQ_o.png" width="675"></p> 
<p><img alt="" height="311" src="https://images2.imgbox.com/7f/e6/bGVtVRHq_o.png" width="830"></p> 
<p><img alt="" height="537" src="https://images2.imgbox.com/dc/61/gBiTctSR_o.png" width="830"></p> 
<h5 style="text-align:justify;"><strong>10、总结：</strong></h5> 
<h5 style="text-align:justify;"><strong>（1）ingress的核心组件：nginx-ingress-controller、traefik，都是开源的ingress-controller</strong></h5> 
<h5 style="text-align:justify;"><strong>（2）ingress的三种工作方式</strong><strong><span style="color:#ff0000;">（重点）</span></strong></h5> 
<table border="1" cellspacing="0"><tbody><tr><td style="vertical-align:top;width:426.1pt;"> <p><strong>deployment+loadbalancer：</strong></p> <p><strong>需要云平台提供一个负载均衡的公网地址，公有云上配置</strong></p> </td></tr><tr><td style="vertical-align:top;width:426.1pt;"> <p><strong>daemonset+hostnetwork+nodeselector：指定节点部署controller</strong></p> <p><strong>①缺点：和宿主机共享网络，只能是一个controller的pod，多个端口会造成冲突</strong></p> <p><strong>②hostnetwork会和宿主机共享网络</strong></p> </td></tr><tr><td style="vertical-align:top;width:426.1pt;"> <p><strong>deployment+nodeport：最常见、最常用、最简单的方式</strong></p> <p><strong>①集中一个nodeport端口，所有的ingress的请求都会转发到nodeport，再由service把流量转发到pod</strong></p> </td></tr></tbody></table> 
<h5 style="text-align:justify;"><strong>（3）一个ingress的nodeport可以实现访问多个虚拟主机（和nginx一样）</strong></h5> 
<h4 style="text-align:justify;"><strong>11、基于ingress实现https代理访问（证书、密钥）</strong></h4> 
<h5 style="text-align:justify;"><strong>（1）生成密钥、证书</strong></h5> 
<h5 style="text-align:justify;"><strong>openssl req -x509 -sha256 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj "/CN=nginxsvc/0=nginxsvc"</strong></h5> 
<table border="1" cellspacing="0"><tbody><tr><td style="vertical-align:top;width:179.8pt;"> <p><strong>req</strong></p> </td><td style="vertical-align:top;width:246.3pt;"> <p><strong>生成证书文件的请求</strong></p> </td></tr><tr><td style="vertical-align:top;width:179.8pt;"> <p><strong>-x509</strong></p> </td><td style="vertical-align:top;width:246.3pt;"> <p><strong>生成</strong><strong>x.509自签名的证书</strong></p> </td></tr><tr><td style="vertical-align:top;width:179.8pt;"> <p><strong>-sha256</strong></p> </td><td style="vertical-align:top;width:246.3pt;"> <p><strong>表示使用sha-256的散列算法</strong></p> </td></tr><tr><td style="vertical-align:top;width:179.8pt;"> <p><strong>-nodes</strong></p> </td><td style="vertical-align:top;width:246.3pt;"> <p><strong>表示生成的密钥不加密</strong></p> </td></tr><tr><td style="vertical-align:top;width:179.8pt;"> <p><strong>-day 365</strong></p> </td><td style="vertical-align:top;width:246.3pt;"> <p><strong>证书有效期是265天</strong></p> </td></tr><tr><td style="vertical-align:top;width:179.8pt;"> <p><strong>-newkey rsa:2048</strong></p> </td><td style="vertical-align:top;width:246.3pt;"> <p><strong>RSA的密钥对，长度2048位</strong></p> </td></tr><tr><td style="vertical-align:top;width:179.8pt;"> <p><strong>-keyout tls.key -out tls.crt</strong></p> </td><td style="vertical-align:top;width:246.3pt;"> <p><strong>密钥文件key、证书文件crt</strong></p> </td></tr><tr><td style="vertical-align:top;width:179.8pt;"> <p><strong>-subj"/CN=nginxsvc/O=nginxsvc"</strong></p> </td><td style="vertical-align:top;width:246.3pt;"> <p><strong>主题CN（common name）O：表示organization组织</strong></p> </td></tr></tbody></table> 
<p><img alt="" height="142" src="https://images2.imgbox.com/3c/a9/atsFTW4a_o.png" width="830"></p> 
<h5 style="text-align:justify;"><strong>（2）创建secret，保存证书和密钥</strong></h5> 
<h5 style="text-align:justify;"><strong>kubectl create secret tls tls-secret --key tls.key --cert tls.crt</strong></h5> 
<p><img alt="" height="443" src="https://images2.imgbox.com/ec/f6/UiU0iemi_o.png" width="830"></p> 
<p><strong>（3）创建pod、service、ingress</strong></p> 
<p><img alt="" height="441" src="https://images2.imgbox.com/82/b8/wRVKGssz_o.png" width="506"></p> 
<p><img alt="" height="283" src="https://images2.imgbox.com/72/0a/8TlsCzAG_o.png" width="414"></p> 
<p><img alt="" height="522" src="https://images2.imgbox.com/b5/67/xC9ThgdY_o.png" width="830"></p> 
<p><img alt="" height="370" src="https://images2.imgbox.com/d3/c3/JY2sPhj5_o.png" width="831"></p> 
<p><strong>（4）设置映射</strong></p> 
<p><img alt="" height="188" src="https://images2.imgbox.com/67/27/cbe8kThk_o.png" width="830"></p> 
<p><strong>（5）测试访问</strong></p> 
<p><img alt="" height="513" src="https://images2.imgbox.com/1b/98/wSi6q3iK_o.png" width="831"></p> 
<p><strong>①虚拟机测试访问</strong></p> 
<p><img alt="" height="586" src="https://images2.imgbox.com/82/88/0Lo2MPOH_o.png" width="655"></p> 
<p><img alt="" height="194" src="https://images2.imgbox.com/38/ad/pKMK84rq_o.png" width="831"></p> 
<p><strong>②负载均衡</strong></p> 
<p><img alt="" height="322" src="https://images2.imgbox.com/df/a0/V18lswUF_o.png" width="830"></p> 
<p><img alt="" height="117" src="https://images2.imgbox.com/23/0f/6CbK3TgG_o.png" width="377"><img alt="" height="101" src="https://images2.imgbox.com/8f/9c/00v0cn4V_o.png" width="327"></p> 
<p><img alt="" height="101" src="https://images2.imgbox.com/16/45/1jZC4jUF_o.png" width="309"></p> 
<h5 style="text-align:justify;"><strong>内部实现ingress访问https：DNS域名解析</strong></h5> 
<h5 style="text-align:justify;"><strong>外部实现ingress访问https：购买域名</strong></h5> 
<h4 style="text-align:justify;"><strong>12、ngixn的登录账户认证</strong></h4> 
<h5 style="text-align:justify;"><strong>（1）htpasswd生成一个认证文件，认证文件只能是auth</strong></h5> 
<h5 style="text-align:justify;"><strong>yum -y install httpd</strong></h5> 
<h5 style="text-align:justify;"><strong>htpasswd -c auth hyde</strong></h5> 
<p><img alt="" height="208" src="https://images2.imgbox.com/d4/0d/DQZnJABh_o.png" width="598"></p> 
<p><img alt="" height="158" src="https://images2.imgbox.com/08/c7/1ULng72N_o.png" width="622"></p> 
<h5 style="text-align:justify;"><strong>（</strong><strong>2</strong><strong>）</strong><strong>创建secret保存auth认证文件</strong></h5> 
<h5 style="text-align:justify;"><strong>ubectl create secret generic basic-auth --from-file=auth</strong></h5> 
<p><img alt="" height="283" src="https://images2.imgbox.com/81/74/0uKBd11y_o.png" width="830"></p> 
<p><strong>（3）创建ingress</strong></p> 
<p><img alt="" height="520" src="https://images2.imgbox.com/d8/84/DNAR3dGJ_o.png" width="831"></p> 
<p><img alt="" height="189" src="https://images2.imgbox.com/55/15/HO642Q5B_o.png" width="831"></p> 
<p><strong>（4）配置映射</strong></p> 
<p><img alt="" height="185" src="https://images2.imgbox.com/b5/b8/xcMH8OoN_o.png" width="831"></p> 
<p><strong>（5）测试访问</strong></p> 
<p><img alt="" height="75" src="https://images2.imgbox.com/6d/6f/eyDlvtJZ_o.png" width="830"></p> 
<p><img alt="" height="312" src="https://images2.imgbox.com/48/46/oOZBXF3a_o.png" width="830"></p> 
<p><img alt="" height="137" src="https://images2.imgbox.com/5c/e4/6Em7BxyO_o.png" width="397"></p> 
<h4 style="text-align:justify;"><strong>13、nginx的重写rewrite（nginx的重定向）</strong></h4> 
<h5 style="text-align:justify;"><strong>（1）创建ingress</strong></h5> 
<p><img alt="" height="398" src="https://images2.imgbox.com/44/a7/DDefwp9J_o.png" width="830"></p> 
<p><img alt="" height="188" src="https://images2.imgbox.com/d2/f6/QHgqZNud_o.png" width="831"></p> 
<p><strong>（2）设置映射</strong></p> 
<p><img alt="" height="202" src="https://images2.imgbox.com/97/64/ib37h2md_o.png" width="831"></p> 
<h5 style="text-align:justify;"><strong>（</strong><strong>3</strong><strong>）</strong><strong>测试访问</strong></h5> 
<p><img alt="" height="78" src="https://images2.imgbox.com/34/c3/Lhdlb466_o.png" width="830"></p> 
<p><img alt="" height="160" src="https://images2.imgbox.com/be/84/sAkoSdVG_o.png" width="635"></p> 
<p><img alt="" height="134" src="https://images2.imgbox.com/47/8d/B7K7OyA0_o.png" width="479"></p> 
<h5 style="text-align:justify;"><strong>nginx-ingress-controller全部完成</strong></h5> 
<h5 style="text-align:justify;"><strong>14、traefik ingress controller（和nginx ingress controller的原理一样）</strong></h5> 
<p><img alt="" height="428" src="https://images2.imgbox.com/e5/9f/GBJ2oPWB_o.png" width="830"></p> 
<h5 style="text-align:justify;"><strong>（1）traefik是一个为了让部署微服务更加快捷而诞生的一个http反向代理、负载均衡</strong></h5> 
<h5 style="text-align:justify;"><strong>①traefik设计时就能够实时的和k8s的api进行交互，可以感知后端service以及pod的变化，可以自动更新配置和重载</strong></h5> 
<h5 style="text-align:justify;"><strong>（2）traefik的部署方式</strong></h5> 
<h5 style="text-align:justify;"><strong>①daemonset</strong></h5> 
<h5 style="text-align:justify;"><strong>②deployment</strong></h5> 
<h5 style="text-align:justify;"><strong>（3）daemonset部署的特点</strong></h5> 
<h5 style="text-align:justify;"><strong>①每个节点都会部署一个traefik</strong></h5> 
<h5 style="text-align:justify;"><strong>②节点感知，可以自动发现、更新容器的配置，不需要手动重载</strong></h5> 
<h5 style="text-align:justify;"><strong>③缺点：资源占用，在大型集群中，daemonset可能会运行多个traefik的实例，尤其是在不需要大量容器运行的情况下（资源利用率不是很好，没有办法扩缩容）</strong></h5> 
<h5 style="text-align:justify;"><strong>④应用于部署对外集群（对外的业务会经常变更，使用daemonset可以更好的、自动的发现服务配置变更）</strong></h5> 
<h5 style="text-align:justify;"><strong>⑤设定标签：traffic-type:internal（对内服务）</strong></h5> 
<h5 style="text-align:justify;"><strong>（4）deployment部署的特点</strong></h5> 
<h5 style="text-align:justify;"><strong>①优点：集中办公控制，可以使用少量的实例来运行处理整个集群的流量，更容易升级和维护</strong></h5> 
<h5 style="text-align:justify;"><strong>②缺点：deployment的负载均衡不会均分到每个节点；无法感知容器内部的配置变化，需要手动更新</strong></h5> 
<h5 style="text-align:justify;"><strong>③应用于部署对内集群（内部的业务相对稳定，更新和变化也比较少，更适合deployment）</strong></h5> 
<h5 style="text-align:justify;"><strong>④设定标签：traffic-type:iexternal（对外服务）</strong></h5> 
<h5 style="text-align:justify;"><strong>（5）traefix-ingress和nginx-ingress的区别</strong></h5> 
<h5 style="text-align:justify;"><strong>①工作原理都一样，都是七层代理，都可以动态的更新配置，都可以自动发现服务</strong></h5> 
<h5 style="text-align:justify;"><strong>②traefix自动更新的重载速度更快，更方便</strong></h5> 
<h5 style="text-align:justify;"><strong>③traefix适用于小集群，traefix处理并发的能力只有nginx-ingress的60%</strong></h5> 
<h5 style="text-align:justify;"><strong>（6）traefik的实例之deployment+nodeport模式</strong></h5> 
<h5 style="text-align:justify;"><strong>①生成模版文件</strong></h5> 
<h5 style="text-align:justify;"><strong>wget  https://gitee.com/mirrors/traefik/raw/v1.7/examples/k8s/traefik-deployment.yaml</strong></h5> 
<h5 style="text-align:justify;"><strong>wget  https://gitee.com/mirrors/traefik/raw/v1.7/examples/k8s/traefik-rbac.yaml</strong></h5> 
<h5 style="text-align:justify;"><strong>wget  https://gitee.com/mirrors/traefik/raw/v1.7/examples/k8s/traefik-ds.yaml</strong></h5> 
<h5 style="text-align:justify;"><strong>wget  https://gitee.com/mirrors/traefik/raw/v1.7/examples/k8s/ui.yaml</strong></h5> 
<p><img alt="" height="423" src="https://images2.imgbox.com/64/c3/Zbbut9AM_o.png" width="830"></p> 
<h5 style="text-align:justify;"><strong>②运行配置文件</strong></h5> 
<p><img alt="" height="229" src="https://images2.imgbox.com/5d/99/PRI2HdvZ_o.png" width="830"></p> 
<p><img alt="" height="89" src="https://images2.imgbox.com/2a/1c/2n9eoXcy_o.png" width="831"></p> 
<h5 style="text-align:justify;"><strong>③访问：20.0.0.71:31800</strong></h5> 
<p><img alt="" height="158" src="https://images2.imgbox.com/37/b2/vlShpZ0N_o.png" width="558"></p> 
<p><img alt="" height="392" src="https://images2.imgbox.com/1a/f3/2ZpQmGvT_o.png" width="831"></p> 
<h5 style="text-align:justify;"><strong>* 删除ingress</strong></h5> 
<p><img alt="" height="256" src="https://images2.imgbox.com/d1/ab/yxskgeqV_o.png" width="831"></p> 
<p><img alt="" height="353" src="https://images2.imgbox.com/89/95/VTWjKR8H_o.png" width="831"></p> 
<h5 style="text-align:justify;"><strong>④创建pod、service、ingress</strong></h5> 
<p><img alt="" height="446" src="https://images2.imgbox.com/e9/c1/6JANn0Ng_o.png" width="536"></p> 
<p><img alt="" height="656" src="https://images2.imgbox.com/e5/21/gZTPmHZB_o.png" width="604"></p> 
<p><img alt="" height="430" src="https://images2.imgbox.com/c0/64/KpcSeLCZ_o.png" width="831"></p> 
<p><img alt="" height="417" src="https://images2.imgbox.com/cc/09/Ldt8aerM_o.png" width="830"></p> 
<h5 style="text-align:justify;"><strong>⑤测试访问</strong></h5> 
<p><img alt="" height="347" src="https://images2.imgbox.com/0f/58/xqLi7VWO_o.png" width="831"></p> 
<h5 style="text-align:justify;"><strong>⑥设置映射</strong></h5> 
<p><img alt="" height="200" src="https://images2.imgbox.com/ee/4d/5vigvXtc_o.png" width="831"></p> 
<p><img alt="" height="198" src="https://images2.imgbox.com/e7/e9/FwhJzq5T_o.png" width="830"></p> 
<h5 style="text-align:justify;"><strong>⑦配置自动发现</strong></h5> 
<h5 style="text-align:justify;"><strong>* 缩容</strong></h5> 
<p><img alt="" height="349" src="https://images2.imgbox.com/6f/9c/u0M4hMKS_o.png" width="389"></p> 
<p><img alt="" height="134" src="https://images2.imgbox.com/c3/98/I8ywpcDK_o.png" width="830"></p> 
<p><img alt="" height="376" src="https://images2.imgbox.com/78/5f/pSG5NVa3_o.png" width="830"></p> 
<h5 style="text-align:justify;"><strong>* 扩容</strong></h5> 
<p><img alt="" height="436" src="https://images2.imgbox.com/11/76/HDAjpAGT_o.png" width="394"></p> 
<p><img alt="" height="375" src="https://images2.imgbox.com/85/9b/XsPCZPh5_o.png" width="831"></p> 
<p><strong>15、总结</strong></p> 
<h5 style="text-align:justify;"><strong>（1）ingress的组件（开源）：nginx-ingresscontroller、traefik-ingress-controller</strong></h5> 
<h5 style="text-align:justify;"><strong>（2） nginx-ingress的部署方式</strong></h5> 
<h5 style="text-align:justify;"><strong>①deployment+loadbalancer：公有云提供负载均衡的公网地址</strong></h5> 
<h5 style="text-align:justify;"><strong>②daemonset+hostnetwork+nodeselector：和节点服务器共享网络，一个节点只能部署一个controller pod，使用宿主机的端口，性能最好，适合大并发</strong></h5> 
<h5 style="text-align:justify;"><strong>③deployment+nodeport：最常见、最常用、最简单的方法，但是性能不太好，多了一层nat的地址转发，不太适合大并发</strong></h5> 
<h5 style="text-align:justify;"><strong>（3）traefik-ingress的部署方式</strong></h5> 
<h5 style="text-align:justify;"><strong>①对外：daemonset，可以自动更新容器的配置（host，使用节点的网络）</strong></h5> 
<h5 style="text-align:justify;"><strong>②对内：deployment，无法自动更新容器的配置（nodeport）</strong></h5> 
<h5 style="text-align:justify;"><strong>（4）基于ingress实现https代理访问（证书、密钥）</strong></h5> 
<h5 style="text-align:justify;"><strong>①先生成密钥、证书</strong></h5> 
<h5 style="text-align:justify;"><strong>②创建secret，保存证书和密钥</strong></h5> 
<h5 style="text-align:justify;"><strong>③创建ingress的时候把secret导入进去</strong></h5> 
<h5 style="text-align:justify;"><strong>（5）nginx登录加密认证</strong></h5> 
<h5 style="text-align:justify;"><strong>①htpasswd生成一个认证文件，认证文件只能是auth</strong></h5> 
<h5 style="text-align:justify;"><strong>②创建ingress的两个代码</strong></h5> 
<h5 style="text-align:justify;"><strong>第一条：声明认证类型</strong></h5> 
<h5 style="text-align:justify;"><strong>第二条：导入认证的密钥文件（以secret的方式存储在集群中）</strong></h5> 
<p><img alt="" height="185" src="https://images2.imgbox.com/11/a8/J2uyEGZN_o.png" width="831"></p> 
<h5 style="text-align:justify;"><strong>（6）nginx的rewrite重定向</strong></h5> 
<h5 style="text-align:justify;"><strong>①在指定的ingress文件当中声明的url都会跳转到指定的页面</strong></h5> 
<p><img alt="" height="103" src="https://images2.imgbox.com/ba/e7/cWeaffVB_o.png" width="830"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7a31ee0105c2a355dd7d30cb197aae68/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">AI嵌入式K210项目（14）-TF卡读取</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/58be75961027148d68eb2dfc947032ce/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">机器学习：holdout法（Python）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>