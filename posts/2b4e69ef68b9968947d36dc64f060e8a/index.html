<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux | NVMe | APST 不完全总结 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Linux | NVMe | APST 不完全总结" />
<meta property="og:description" content="本文简要地从 Linux 内核和 NVMe 驱动的角度对 APST 相关问题及分析、解决进行不完全总结 1。
更新：2023 / 2 / 13
Linux / NVMe | APST 不完全总结 背景信息为什么电源管理如何实现电源管理方式场景 电源管理的风险 自主电源状态切换（APST）系统概念配置 APST初始化 NVMe Controller 风险问题描述解决方案1.方法影响 2.方法影响 3.方法影响 参考链接 背景信息 快速可靠的 NVMe SSD 彻底改变了数据存储。但是，NVMe SSD 技术有一个缺点高功耗。
幸运地是 NVMe Spec 提供很多电源管理功能。
为什么电源管理 NVMe 电源管理可以帮助在平台散热和 SSD 消耗的总功率之间达成平衡。
即使规定了 SSD 的最大功率，主机 Host 也可以主动发起功率状态改变来改变 SSD 的功耗。
由于客户端 NVMe 设备大部分时间处于空闲状态，因此使用非工作电源状态（ Non Operational State ）可以延长设备寿命。
如何实现电源管理 方式 主机 Host 可以通过 3 种不同的方式访问 NVMe 电源管理功能：
①" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/2b4e69ef68b9968947d36dc64f060e8a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-13T00:20:16+08:00" />
<meta property="article:modified_time" content="2023-02-13T00:20:16+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux | NVMe | APST 不完全总结</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>本文简要地从 <code>Linux</code> 内核和 <code>NVMe</code> 驱动的角度对 <code>APST</code> 相关问题及分析、解决进行不完全总结 <sup class="footnote-ref"><a href="#fn1" rel="nofollow" id="fnref1">1</a></sup>。</p> 
<p>更新：2023 / 2 / 13</p> 
<hr> 
<p></p> 
<div class="toc"> 
 <h4>Linux / NVMe | APST 不完全总结</h4> 
 <ul><li><a href="#_10" rel="nofollow">背景信息</a></li><li><ul><li><a href="#_17" rel="nofollow">为什么电源管理</a></li><li><a href="#_25" rel="nofollow">如何实现电源管理</a></li><li><ul><li><a href="#_26" rel="nofollow">方式</a></li><li><a href="#_42" rel="nofollow">场景</a></li></ul> 
   </li><li><a href="#_54" rel="nofollow">电源管理的风险</a></li></ul> 
  </li><li><a href="#APST_64" rel="nofollow">自主电源状态切换（APST）</a></li><li><ul><li><a href="#_69" rel="nofollow">系统</a></li><li><ul><li><a href="#_74" rel="nofollow">概念</a></li><li><ul><li><ul><li><a href="#_APST_75" rel="nofollow">配置 APST</a></li><li><a href="#_NVMe_Controller_220" rel="nofollow">初始化 NVMe Controller</a></li></ul> 
    </li></ul> 
   </li></ul> 
   </li><li><a href="#_282" rel="nofollow">风险</a></li><li><ul><li><a href="#_283" rel="nofollow">问题描述</a></li><li><a href="#_306" rel="nofollow">解决方案</a></li><li><ul><li><a href="#1_307" rel="nofollow">1.</a></li><li><ul><li><a href="#_308" rel="nofollow">方法</a></li><li><a href="#_322" rel="nofollow">影响</a></li></ul> 
     </li><li><a href="#2_327" rel="nofollow">2.</a></li><li><ul><li><a href="#_328" rel="nofollow">方法</a></li><li><a href="#_333" rel="nofollow">影响</a></li></ul> 
     </li><li><a href="#3_338" rel="nofollow">3.</a></li><li><ul><li><a href="#_339" rel="nofollow">方法</a></li><li><a href="#_379" rel="nofollow">影响</a></li></ul> 
    </li></ul> 
   </li></ul> 
  </li></ul> 
  </li><li><a href="#_384" rel="nofollow">参考链接</a></li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="_10"></a>背景信息</h2> 
<p>快速可靠的 <code>NVMe</code> <code>SSD</code> 彻底改变了数据存储。但是，<code>NVMe</code> <code>SSD</code> 技术有一个缺点高功耗。</p> 
<p>幸运地是 <code>NVMe</code> <code>Spec</code> 提供很多电源管理功能。</p> 
<br> 
<h3><a id="_17"></a>为什么电源管理</h3> 
<p><code>NVMe</code> 电源管理可以帮助在平台散热和 <code>SSD</code> 消耗的总功率之间达成平衡。</p> 
<blockquote> 
 <p>即使规定了 <code>SSD</code> 的最大功率，主机 <code>Host</code> 也可以主动发起功率状态改变来改变 <code>SSD</code> 的功耗。</p> 
</blockquote> 
<p>由于客户端 <code>NVMe</code> 设备大部分时间处于空闲状态，因此使用非工作电源状态（ <code>Non Operational State</code> ）可以延长设备寿命。</p> 
<br> 
<h3><a id="_25"></a>如何实现电源管理</h3> 
<h4><a id="_26"></a>方式</h4> 
<p>主机 <code>Host</code> 可以通过 <code>3</code> 种不同的方式访问 <code>NVMe</code> 电源管理功能：</p> 
<p>①<br> 主机 <code>Host</code> 使用 <code>Set Feature</code> 命令 ( <code>FID=0xC</code>，<code>APST</code> ) 为自主电源状态转换功能（ <code>Autonomous Power State Transition</code>，<code>APST</code> ）设置电源状态（ <code>Power State</code> ）。<br> 客户端 <code>SSD</code> 将根据设置的条件转换到不同的电源状态。</p> 
<p>②<br> 主机 <code>Host</code> 使用 <code>Set Feature</code> 命令以更改客户端 <code>SSD</code> 当前的电源状态。</p> 
<p>③<br> 主机 <code>Host</code> 使用 <code>Set Feature</code> 命令用于主机控制的热管理，以建立两个温度阈值。<br> 客户端 <code>SSD</code> 达到设定温度后将自动转换到低功耗状态。</p> 
<br> 
<h4><a id="_42"></a>场景</h4> 
<p>针对工作负载和可用的散热平台，对于客户端、数据中心和企业级 <code>SSD</code> 这 <code>3</code> 种使用场景，会有所不同。</p> 
<ul><li>对于客户端 <code>SSD</code>，设备大多数时候都处于空闲（ <code>Idle</code> ）状态，因此 ① <code>APST</code> <code>NVMe</code> 电源管理是最佳方法。<br> 因为设备将根据设置的空闲时间限制自动过渡到功耗较低的电源状态。</li><li>对于数据中心，通常使用 ② 的方法来限制特定工作负载的最大固态硬盘性能。<br> 因为可以在性能和散热预算要求之间取得平衡。</li><li>对于企业级 <code>SSD</code>，设备大多数时候都处于活跃（ <code>Busy</code> ）状态，因此使用 ③ 热管理温度阈值。<br> 因为可以确保设备不会过热并触发热关机条件。</li></ul> 
<br> 
<h3><a id="_54"></a>电源管理的风险</h3> 
<p><code>NVMe</code> 电源管理功能可在电源、性能、产品可靠性和客户体验之间找到可接受的平衡。<br> 但是，如果未正确配置 <code>NVMe</code> 电源管理功能，则存在风险。<br> 这些风险包括以下内容：</p> 
<ul><li>无法正确管理 <code>SSD</code> 的功耗，可能会导致产生过多热量，<code>SSD</code> 可能达到其热关机极限并且会关机。</li><li>在非工作模式（ <code>Non Operational State</code> ）时设备无法转换为低功耗模式，将继续消耗功率。</li><li>最低功耗状态将花费最长的时间以进入和退出。不考虑进入和退出延迟可能会导致性能降低或响应时间延长。</li></ul> 
<hr> 
<h2><a id="APST_64"></a>自主电源状态切换（APST）</h2> 
<p>参考 <sup class="footnote-ref"><a href="#fn2" rel="nofollow" id="fnref2">2</a></sup></p> 
<br> 
<h3><a id="_69"></a>系统</h3> 
<p>从系统和驱动的角度看 <code>NVMe</code> <code>SSD</code> 的 <code>APST</code> 功能是如何实现的：</p> 
<br> 
<h4><a id="_74"></a>概念</h4> 
<h6><a id="_APST_75"></a>配置 APST</h6> 
<p>在 <code>linux/drivers/nvme/host/core.c</code> <sup class="footnote-ref"><a href="#fn3" rel="nofollow" id="fnref3">3</a></sup> 中，关于配置 <code>APST</code> 的源码部分如下，</p> 
<pre><code class="prism language-c"><span class="token comment">/*
 * APST (Autonomous Power State Transition) lets us program a table of power
 * state transitions that the controller will perform automatically.
 *
 * Depending on module params, one of the two supported techniques will be used:
 *
 * - If the parameters provide explicit timeouts and tolerances, they will be
 *   used to build a table with up to 2 non-operational states to transition to.
 *   The default parameter values were selected based on the values used by
 *   Microsoft's and Intel's NVMe drivers. Yet, since we don't implement dynamic
 *   regeneration of the APST table in the event of switching between external
 *   and battery power, the timeouts and tolerances reflect a compromise
 *   between values used by Microsoft for AC and battery scenarios.
 * - If not, we'll configure the table with a simple heuristic: we are willing
 *   to spend at most 2% of the time transitioning between power states.
 *   Therefore, when running in any given state, we will enter the next
 *   lower-power non-operational state after waiting 50 * (enlat + exlat)
 *   microseconds, as long as that state's exit latency is under the requested
 *   maximum latency.
 *
 * We will not autonomously enter any non-operational state for which the total
 * latency exceeds ps_max_latency_us.
 *
 * Users can set ps_max_latency_us to zero to turn off APST.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">nvme_configure_apst</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">nvme_ctrl</span> <span class="token operator">*</span>ctrl<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">nvme_feat_auto_pst</span> <span class="token operator">*</span>table<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> apste <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	u64 max_lat_us <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	__le64 target <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> max_ps <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> state<span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> last_lt_index <span class="token operator">=</span> UINT_MAX<span class="token punctuation">;</span>

	<span class="token comment">/*
	 * If APST isn't supported or if we haven't been initialized yet,
	 * then don't do anything.
	 */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctrl<span class="token operator">-&gt;</span>apsta<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>ctrl<span class="token operator">-&gt;</span>npss <span class="token operator">&gt;</span> <span class="token number">31</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">dev_warn</span><span class="token punctuation">(</span>ctrl<span class="token operator">-&gt;</span>device<span class="token punctuation">,</span> <span class="token string">"NPSS is invalid; not using APST\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	table <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>table<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>table<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	
	<span class="token comment">// 此处说明如果 `ps_max_latency_us` == 0，将会disable APST</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctrl<span class="token operator">-&gt;</span>apst_enabled <span class="token operator">||</span> ctrl<span class="token operator">-&gt;</span>ps_max_latency_us <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">/* Turn off APST. */</span>
		<span class="token function">dev_dbg</span><span class="token punctuation">(</span>ctrl<span class="token operator">-&gt;</span>device<span class="token punctuation">,</span> <span class="token string">"APST disabled\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">goto</span> done<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/*
	 * Walk through all states from lowest- to highest-power.
	 * According to the spec, lower-numbered states use more power.  NPSS,
	 * despite the name, is the index of the lowest-power state, not the
	 * number of states.
	 */</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>state <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>ctrl<span class="token operator">-&gt;</span>npss<span class="token punctuation">;</span> state <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> state<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		u64 total_latency_us<span class="token punctuation">,</span> exit_latency_us<span class="token punctuation">,</span> transition_ms<span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>target<span class="token punctuation">)</span>
			table<span class="token operator">-&gt;</span>entries<span class="token punctuation">[</span>state<span class="token punctuation">]</span> <span class="token operator">=</span> target<span class="token punctuation">;</span>

		<span class="token comment">/*
		 * Don't allow transitions to the deepest state if it's quirked
		 * off.
		 */</span>
		<span class="token comment">// 如果配置了 `NVME_QUIRK_NO_DEEPEST_PS`，说明不允许设备进入最深的低功耗状态</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> ctrl<span class="token operator">-&gt;</span>npss <span class="token operator">&amp;&amp;</span>
		    <span class="token punctuation">(</span>ctrl<span class="token operator">-&gt;</span>quirks <span class="token operator">&amp;</span> NVME_QUIRK_NO_DEEPEST_PS<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">continue</span><span class="token punctuation">;</span>

		<span class="token comment">/*
		 * Is this state a useful non-operational state for higher-power
		 * states to autonomously transition to?
		 */</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>ctrl<span class="token operator">-&gt;</span>psd<span class="token punctuation">[</span>state<span class="token punctuation">]</span><span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> NVME_PS_FLAGS_NON_OP_STATE<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">continue</span><span class="token punctuation">;</span>

		exit_latency_us <span class="token operator">=</span> <span class="token punctuation">(</span>u64<span class="token punctuation">)</span><span class="token function">le32_to_cpu</span><span class="token punctuation">(</span>ctrl<span class="token operator">-&gt;</span>psd<span class="token punctuation">[</span>state<span class="token punctuation">]</span><span class="token punctuation">.</span>exit_lat<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>exit_latency_us <span class="token operator">&gt;</span> ctrl<span class="token operator">-&gt;</span>ps_max_latency_us<span class="token punctuation">)</span>
			<span class="token keyword">continue</span><span class="token punctuation">;</span>

		total_latency_us <span class="token operator">=</span> exit_latency_us <span class="token operator">+</span>
			<span class="token function">le32_to_cpu</span><span class="token punctuation">(</span>ctrl<span class="token operator">-&gt;</span>psd<span class="token punctuation">[</span>state<span class="token punctuation">]</span><span class="token punctuation">.</span>entry_lat<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">/*
		 * This state is good. It can be used as the APST idle target
		 * for higher power states.
		 */</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>apst_primary_timeout_ms <span class="token operator">&amp;&amp;</span> apst_primary_latency_tol_us<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">nvme_apst_get_transition_time</span><span class="token punctuation">(</span>total_latency_us<span class="token punctuation">,</span>
					<span class="token operator">&amp;</span>transition_ms<span class="token punctuation">,</span> <span class="token operator">&amp;</span>last_lt_index<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token keyword">continue</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			transition_ms <span class="token operator">=</span> total_latency_us <span class="token operator">+</span> <span class="token number">19</span><span class="token punctuation">;</span>
			<span class="token function">do_div</span><span class="token punctuation">(</span>transition_ms<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>transition_ms <span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
				transition_ms <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		target <span class="token operator">=</span> <span class="token function">cpu_to_le64</span><span class="token punctuation">(</span><span class="token punctuation">(</span>state <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>transition_ms <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>max_ps <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
			max_ps <span class="token operator">=</span> state<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>total_latency_us <span class="token operator">&gt;</span> max_lat_us<span class="token punctuation">)</span>
			max_lat_us <span class="token operator">=</span> total_latency_us<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>max_ps <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token function">dev_dbg</span><span class="token punctuation">(</span>ctrl<span class="token operator">-&gt;</span>device<span class="token punctuation">,</span> <span class="token string">"APST enabled but no non-operational states are available\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span>
		<span class="token function">dev_dbg</span><span class="token punctuation">(</span>ctrl<span class="token operator">-&gt;</span>device<span class="token punctuation">,</span> <span class="token string">"APST enabled: max PS = %d, max round-trip latency = %lluus, table = %*phN\n"</span><span class="token punctuation">,</span>
			max_ps<span class="token punctuation">,</span> max_lat_us<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>table<span class="token punctuation">)</span><span class="token punctuation">,</span> table<span class="token punctuation">)</span><span class="token punctuation">;</span>
	apste <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

done<span class="token operator">:</span>
	ret <span class="token operator">=</span> <span class="token function">nvme_set_features</span><span class="token punctuation">(</span>ctrl<span class="token punctuation">,</span> NVME_FEAT_AUTO_PST<span class="token punctuation">,</span> apste<span class="token punctuation">,</span>
				table<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>table<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
		<span class="token function">dev_err</span><span class="token punctuation">(</span>ctrl<span class="token operator">-&gt;</span>device<span class="token punctuation">,</span> <span class="token string">"failed to set APST feature (%d)\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">kfree</span><span class="token punctuation">(</span>table<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>从上面可知，<code>APST</code> 是一项允许 <code>NVMe</code> <code>SSD</code> 内的 <code>NVMe</code> <code>Controller</code> 按照可配置规则在电源管理状态之间自主切换的功能。</p> 
<p><code>NVMe</code> <code>Controller</code> 指定进入和退出每个电源状态需要多少微秒，内核 <code>kernel</code> 也将使用此信息进行相应的配置 <sup class="footnote-ref"><a href="#fn2" rel="nofollow" id="fnref2:1">2</a></sup>。</p> 
<p>而在哪一个阶段会配置 <code>APST</code> 呢？<br> —— 在初始化 <code>NVMe</code> <code>Controller</code> 的阶段。</p> 
<br> 
<h6><a id="_NVMe_Controller_220"></a>初始化 NVMe Controller</h6> 
<p>初始化 <code>NVMe</code> <code>Controller</code> 又是如何进行的？如下所示：</p> 
<pre><code class="prism language-c"><span class="token comment">/*
 * Initialize the cached copies of the Identify data and various controller
 * register in our nvme_ctrl structure.  This should be called as soon as
 * the admin queue is fully up and running.
 */</span>
<span class="token keyword">int</span> <span class="token function">nvme_init_ctrl_finish</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">nvme_ctrl</span> <span class="token operator">*</span>ctrl<span class="token punctuation">,</span> bool was_suspended<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>

	ret <span class="token operator">=</span> ctrl<span class="token operator">-&gt;</span>ops<span class="token operator">-&gt;</span><span class="token function">reg_read32</span><span class="token punctuation">(</span>ctrl<span class="token punctuation">,</span> NVME_REG_VS<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ctrl<span class="token operator">-&gt;</span>vs<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">dev_err</span><span class="token punctuation">(</span>ctrl<span class="token operator">-&gt;</span>device<span class="token punctuation">,</span> <span class="token string">"Reading VS failed (%d)\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	ctrl<span class="token operator">-&gt;</span>sqsize <span class="token operator">=</span> <span class="token class-name">min_t</span><span class="token punctuation">(</span>u16<span class="token punctuation">,</span> <span class="token function">NVME_CAP_MQES</span><span class="token punctuation">(</span>ctrl<span class="token operator">-&gt;</span>cap<span class="token punctuation">)</span><span class="token punctuation">,</span> ctrl<span class="token operator">-&gt;</span>sqsize<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>ctrl<span class="token operator">-&gt;</span>vs <span class="token operator">&gt;=</span> <span class="token function">NVME_VS</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		ctrl<span class="token operator">-&gt;</span>subsystem <span class="token operator">=</span> <span class="token function">NVME_CAP_NSSRC</span><span class="token punctuation">(</span>ctrl<span class="token operator">-&gt;</span>cap<span class="token punctuation">)</span><span class="token punctuation">;</span>

	ret <span class="token operator">=</span> <span class="token function">nvme_init_identify</span><span class="token punctuation">(</span>ctrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>

	ret <span class="token operator">=</span> <span class="token function">nvme_configure_apst</span><span class="token punctuation">(</span>ctrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>

	ret <span class="token operator">=</span> <span class="token function">nvme_configure_timestamp</span><span class="token punctuation">(</span>ctrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>

	ret <span class="token operator">=</span> <span class="token function">nvme_configure_host_options</span><span class="token punctuation">(</span>ctrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>

	<span class="token function">nvme_configure_opal</span><span class="token punctuation">(</span>ctrl<span class="token punctuation">,</span> was_suspended<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctrl<span class="token operator">-&gt;</span>identified <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">nvme_discovery_ctrl</span><span class="token punctuation">(</span>ctrl<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">/*
		 * Do not return errors unless we are in a controller reset,
		 * the controller works perfectly fine without hwmon.
		 */</span>
		ret <span class="token operator">=</span> <span class="token function">nvme_hwmon_init</span><span class="token punctuation">(</span>ctrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span>EINTR<span class="token punctuation">)</span>
			<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	ctrl<span class="token operator">-&gt;</span>identified <span class="token operator">=</span> true<span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">EXPORT_SYMBOL_GPL</span><span class="token punctuation">(</span>nvme_init_ctrl_finish<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>由上面可知，会先后进行读取 <code>NVME_REG_VS</code> 寄存器的值、写入 <code>NVME_CAP_MQES</code> 寄存器、配置 <code>APST</code>、配置时间戳、配置主机设置等步骤来完成 <code>NVMe</code> <code>Controller</code> 的初始化。</p> 
<br> 
<h3><a id="_282"></a>风险</h3> 
<h4><a id="_283"></a>问题描述</h4> 
<p>使用 <code>$ sudo nvme get-feature -f 0x0c -H /dev/nvme0</code> 可从输出结果中确认 <code>NVMe</code> <code>SSD</code> 的 <code>APST</code> 是处于 <code>Enabled</code> 状态还是 <code>Disabled</code> 的状态。<br> 使用 <code>$ sudo nvme set-feature -f 0x0c -v=0 /dev/nvme0</code> 可以临时将 <code>NVMe SSD</code> 的 <code>APST</code> 功能禁止。</p> 
<p>如果系统 <code>BIOS</code> 在 <code>NVMe</code> <code>SSD</code> 加载 <code>NVMe</code> 驱动前开启了 <code>NVMe</code> <code>SSD</code> 的 <code>APST</code> 功能，则内核中用于禁止 <code>APST</code> 的相关参数将会被忽略，或者说，不起任何作用。</p> 
<p>在 <code>APST</code> 开启时，如果 <code>NVMe</code> <code>SSD</code> 自动进入低功耗模式（ <code>Non-Operational State</code>）后，无法在预计时间内被唤醒为正常工作模式（ <code>Operational State</code> ）或者只有重启 <code>NVme Controller</code> 才能被唤醒的话，会让 <code>kernel</code> “不高兴”。<br> 此时，可以在内核日志中看到类似于下面的日志记录 <sup class="footnote-ref"><a href="#fn4" rel="nofollow" id="fnref4">4</a></sup>：</p> 
<pre><code class="prism language-shell">vme nvme0: I/O <span class="token number">566</span> QID <span class="token number">7</span> timeout, aborting
 nvme nvme0: I/O <span class="token number">989</span> QID <span class="token number">1</span> timeout, aborting
 nvme nvme0: I/O <span class="token number">990</span> QID <span class="token number">1</span> timeout, aborting
 nvme nvme0: I/O <span class="token number">840</span> QID <span class="token number">6</span> timeout, reset controller
 nvme nvme0: I/O <span class="token number">24</span> QID <span class="token number">0</span> timeout, reset controller
 nvme nvme0: Device not ready<span class="token punctuation">;</span> aborting reset, <span class="token assign-left variable">CSTS</span><span class="token operator">=</span>0x1
 <span class="token punctuation">..</span>.
 nvme nvme0: Device not ready<span class="token punctuation">;</span> aborting reset, <span class="token assign-left variable">CSTS</span><span class="token operator">=</span>0x1
 nvme nvme0: Device not ready<span class="token punctuation">;</span> aborting reset, <span class="token assign-left variable">CSTS</span><span class="token operator">=</span>0x1
 nvme nvme0: failed to <span class="token builtin class-name">set</span> APST feature <span class="token punctuation">(</span>-19<span class="token punctuation">)</span>
</code></pre> 
<br> 
<h4><a id="_306"></a>解决方案</h4> 
<h5><a id="1_307"></a>1.</h5> 
<h6><a id="_308"></a>方法</h6> 
<p>可以通过 <code>cat /sys/module/nvme_core/parameters/default_ps_max_latency_us</code> 的输出结果先行确认当前该参数的值：</p> 
<ul><li>如果输出结果为 <code>0</code>，则满足需求；</li><li>如果输出结果不为 <code>0</code>，通过设定内核启动参数 <code>nvme_core.default_ps_max_latency_us=0.</code> <sup class="footnote-ref"><a href="#fn4" rel="nofollow" id="fnref4:1">4</a></sup> 以禁止 <code>APST</code>。</li></ul> 
<p>修改方式为通过修改 <code>/etc/default/grub</code> <sup class="footnote-ref"><a href="#fn5" rel="nofollow" id="fnref5">5</a></sup>’ <sup class="footnote-ref"><a href="#fn6" rel="nofollow" id="fnref6">6</a></sup> 文件中相应的行为 <code>nvme_core.default_ps_max_latency_us=0</code>，然后使用 <code>update-grub</code> 命令更新内核启动参数。<br> 确认修改结果可通过 <code>$ cat /proc/cmdline</code> 命令，</p> 
<pre><code class="prism language-shell"><span class="token assign-left variable">BOOT_IMAGE</span><span class="token operator">=</span>/boot/vmlinuz-4.10.0-22-generic.efi.signed <span class="token assign-left variable">root</span><span class="token operator">=</span>UUID<span class="token operator">=</span>365f1a9c-9598-4ad5-a387-d02f771767a1 ro quiet splash <span class="token assign-left variable">nvme_core.default_ps_max_latency_us</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">vt.handoff</span><span class="token operator">=</span><span class="token number">7</span>
</code></pre> 
<p>其中，<code>nvme_core.default_ps_max_latency_us=0</code> 出现，证明此前的修改已并入启动配置中。</p> 
<br> 
<h6><a id="_322"></a>影响</h6> 
<p><code>NMVe SSD</code> 的 <code>APST</code> 被禁止后，意味着其只能进入主机 <code>Host</code> 设置的电源状态，即功耗节能将不如 <code>APST</code> 功能开启时的功耗管理效果。</p> 
<br> 
<h5><a id="2_327"></a>2.</h5> 
<h6><a id="_328"></a>方法</h6> 
<p>通过 <code>NVMe</code> <code>SSD</code> 固件确保其 <code>APST</code> 功能中的不同电源状态的进入、退出时间是合适的。</p> 
<br> 
<h6><a id="_333"></a>影响</h6> 
<p>需要进行相应版本的固件升级且每个电源状态的最大进入时间和最大退出时间都是合适的。</p> 
<br> 
<h5><a id="3_338"></a>3.</h5> 
<h6><a id="_339"></a>方法</h6> 
<p>通过修改内核设置来避免 <code>NVMe</code> <code>SSD</code> 进入某些深低功耗状态。</p> 
<p>在内核 <code>kernel</code> 中许多设备驱动都有 <code>quirk table</code> 用于特定硬件模型的临时解决方法 <sup class="footnote-ref"><a href="#fn7" rel="nofollow" id="fnref7">7</a></sup>。<br> 对于 <code>NVMe</code> 驱动 <sup class="footnote-ref"><a href="#fn8" rel="nofollow" id="fnref8">8</a></sup>，<code>quirk table</code> 如下所示：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pci_device_id</span> nvme_id_table<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">{<!-- --></span> <span class="token function">PCI_VDEVICE</span><span class="token punctuation">(</span>INTEL<span class="token punctuation">,</span> <span class="token number">0x0953</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">/* Intel 750/P3500/P3600/P3700 */</span>
        <span class="token punctuation">.</span>driver_data <span class="token operator">=</span> NVME_QUIRK_STRIPE_SIZE <span class="token operator">|</span>
                NVME_QUIRK_DEALLOCATE_ZEROES<span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span> <span class="token function">PCI_VDEVICE</span><span class="token punctuation">(</span>INTEL<span class="token punctuation">,</span> <span class="token number">0x0a53</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">/* Intel P3520 */</span>
        <span class="token punctuation">.</span>driver_data <span class="token operator">=</span> NVME_QUIRK_STRIPE_SIZE <span class="token operator">|</span>
                NVME_QUIRK_DEALLOCATE_ZEROES<span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span> <span class="token function">PCI_VDEVICE</span><span class="token punctuation">(</span>INTEL<span class="token punctuation">,</span> <span class="token number">0x0a54</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">/* Intel P4500/P4600 */</span>
        <span class="token punctuation">.</span>driver_data <span class="token operator">=</span> NVME_QUIRK_STRIPE_SIZE <span class="token operator">|</span>
                NVME_QUIRK_DEALLOCATE_ZEROES<span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span> <span class="token function">PCI_VDEVICE</span><span class="token punctuation">(</span>INTEL<span class="token punctuation">,</span> <span class="token number">0x0a55</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">/* Dell Express Flash P4600 */</span>
        <span class="token punctuation">.</span>driver_data <span class="token operator">=</span> NVME_QUIRK_STRIPE_SIZE <span class="token operator">|</span>
                NVME_QUIRK_DEALLOCATE_ZEROES<span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span> <span class="token function">PCI_VDEVICE</span><span class="token punctuation">(</span>INTEL<span class="token punctuation">,</span> <span class="token number">0xf1a5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">/* Intel 600P/P3100 */</span>
        <span class="token punctuation">.</span>driver_data <span class="token operator">=</span> NVME_QUIRK_NO_DEEPEST_PS <span class="token operator">|</span>
                NVME_QUIRK_MEDIUM_PRIO_SQ <span class="token operator">|</span>
                NVME_QUIRK_NO_TEMP_THRESH_CHANGE <span class="token operator">|</span>
                NVME_QUIRK_DISABLE_WRITE_ZEROES<span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
</code></pre> 
<p>请注意一个已经存在的名为 <code>NVME_QUIRK_NO_DEEPEST_PS</code> 的 <code>quirk</code> 设置，它可以避免进入到最深的电源状态。</p> 
<p>如果你的 <code>NVMe</code> <code>SSD</code> 的 <code>APST</code> 相关问题与 <code>Intel 600P/P3100</code> 的解决方案相同，那么只需要以下面的格式编写一条新的 <code>quirk table entry</code></p> 
<pre><code class="prism language-c">  <span class="token punctuation">{<!-- --></span> <span class="token function">PCI_DEVICE</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>PCI vendor ID<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>PCI product ID of the SSD<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">/* &lt;specify make/model of SSD here&gt; */</span>
        <span class="token punctuation">.</span>driver_data <span class="token operator">=</span> NVME_QUIRK_NO_DEEPEST_PS<span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> 
<p>并基于此修改重新编译内核 <code>kernel</code>。</p> 
<p>又或者，修改 <code>nvme_core.default_ps_max_latency_us=2000</code> <sup class="footnote-ref"><a href="#fn4" rel="nofollow" id="fnref4:2">4</a></sup> 来禁止进入 <code>PS4</code> 电源状态。</p> 
<br> 
<h6><a id="_379"></a>影响</h6> 
<p><code>NVMe</code> <code>SSD</code> 不再进入最深的低功耗状态。</p> 
<hr> 
<h2><a id="_384"></a>参考链接</h2> 
<hr class="footnotes-sep"> 
<section class="footnotes"> 
 <ol class="footnotes-list"><li id="fn1" class="footnote-item"><p><a href="https://searchstorage.techtarget.com.cn/6-28130/" rel="nofollow">为什么以及如何部署NVMe电源管理</a> <a href="#fnref1" rel="nofollow" class="footnote-backref">↩︎</a></p> </li><li id="fn2" class="footnote-item"><p><a href="https://unix.stackexchange.com/questions/612096/clarifying-nvme-apst-problems-for-linux" rel="nofollow">clarifying nvme apst problems for linux</a> <a href="#fnref2" rel="nofollow" class="footnote-backref">↩︎</a> <a href="#fnref2:1" rel="nofollow" class="footnote-backref">↩︎</a></p> </li><li id="fn3" class="footnote-item"><p><a href="https://github.com/torvalds/linux/blob/master/drivers/nvme/host/core.c">linux/drivers/nvme/host/core.c</a> <a href="#fnref3" rel="nofollow" class="footnote-backref">↩︎</a></p> </li><li id="fn4" class="footnote-item"><p><a href="https://wiki.archlinux.org/title/Solid_state_drive/NVMe#Controller_failure_due_to_broken_APST_support" rel="nofollow">Controller failure due to broken APST support</a> <a href="#fnref4" rel="nofollow" class="footnote-backref">↩︎</a> <a href="#fnref4:1" rel="nofollow" class="footnote-backref">↩︎</a> <a href="#fnref4:2" rel="nofollow" class="footnote-backref">↩︎</a></p> </li><li id="fn5" class="footnote-item"><p><a href="https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1699004" rel="nofollow">APST gets enabled against explicit kernel option</a> <a href="#fnref5" rel="nofollow" class="footnote-backref">↩︎</a></p> </li><li id="fn6" class="footnote-item"><p><a href="https://wiki.archlinux.org/title/Kernel_parameters#top-page" rel="nofollow">Kernel parameters</a> <a href="#fnref6" rel="nofollow" class="footnote-backref">↩︎</a></p> </li><li id="fn7" class="footnote-item"><p><a href="https://unix.stackexchange.com/questions/83390/what-are-pci-quirks" rel="nofollow">What are PCI quirks?</a> <a href="#fnref7" rel="nofollow" class="footnote-backref">↩︎</a></p> </li><li id="fn8" class="footnote-item"><p><a href="https://github.com/torvalds/linux/blob/master/drivers/nvme/host/pci.c">linux/drivers/nvme/host/pci.c</a> <a href="#fnref8" rel="nofollow" class="footnote-backref">↩︎</a></p> </li></ol> 
</section>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4d81924054f2974ef8e7582ac472381d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【人工智能】群智能算法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a8b2983bb8ba55899db4f8a08f5b8aae/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">如何通过 9 个简单步骤创建网站</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>