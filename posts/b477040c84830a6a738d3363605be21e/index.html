<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>一、开发社区首页 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="一、开发社区首页" />
<meta property="og:description" content="一、开发社区首页 代码：community-1.6
1.1、建立数据库 init.schema.sql文件
1.2、DAO数据访问层 1、编写实体类（Entity）
User.java 用户信息 DiscussPost.java	Page.java 封装分页相关的信息 2、编写对应Mapper文件（注释：@Mapper）
public interface UserMapper {} public interface DiscussPostMapper {} 3、编写xml配置文件(放在 resources.mapper下)
user-mapper.xml DiscussPost-mapper.xml 4、测试 MapperTests.java
1.3、service业务层 1、编写service包下的 DiscussPostService.java和UserService.java（通过userID查询到用户的信息）
1.4、Controller视图层 1.4.1、开发社区首页，显示前10个数据 1、编写HomeController.java
2、index.html
1.4.2、开发分页组件 分页显示
1.5、项目调试技巧 响应状态码的含义
https://developer.mozilla.org/zh-CN/docs/Web/HTTP
常见状态码：
200：请求成功302：重定向：请求的资源现在临时从不同的 URI 响应请求。由于这样的重定向是临时的，客户端应当继续向原有地址发送以后的请求。只有在Cache-Control或Expires中进行了指定的情况下，这个响应才是可缓存的404：客户端响应：请求失败，请求所希望得到的资源未被在服务器上发现。路径有问题。500：服务器响应：服务器遇到了不知道如何处理的情况。 服务端断点调试技巧
客户端断点调试技巧
设置日志级别，并将日志输出到不同的终端
logback配置文件：logback-spring.xml
1.6、版本控制Git 二、SpringBoot实战，开发社区登录模块 2.1、发送邮件 邮箱设置：启用客户端SMTP服务
Spring Email：
在pom.xml文件中导入jar包
邮箱参数配置
使用JavaMailSender发送邮件
在util包下创建MailClient.java工具类，封装发送邮件功能测试MapperTests.java 模板引擎
使用Thymeleaf发送HTML邮件: resource.templates.mail.demo.html 2.2、开发注册功能 共涉及到了三个请求
(1) 点击注册按钮，弹出注册框
(2) 填完表单数据，点击注册，会发送一次请求
(3) 注册成功后，用户接收到激活邮件后，点击激活邮件又会发送一次请求(进行激活服务)
2.2.1、请求一：访问注册页面 controller层，显示注册网站 controller." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/b477040c84830a6a738d3363605be21e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-06-13T14:05:42+08:00" />
<meta property="article:modified_time" content="2021-06-13T14:05:42+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">一、开发社区首页</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>一、开发社区首页</h2> 
<p><img src="https://images2.imgbox.com/e4/b3/OX09cgyL_o.png" alt="在这里插入图片描述"></p> 
<p>代码：community-1.6</p> 
<h3><a id="11_5"></a>1.1、建立数据库</h3> 
<p><code>init.schema.sql</code>文件</p> 
<h3><a id="12DAO_9"></a>1.2、DAO数据访问层</h3> 
<p>1、编写实体类（Entity）</p> 
<pre><code>User.java         用户信息
DiscussPost.java		
Page.java         封装分页相关的信息
</code></pre> 
<p>2、编写对应Mapper文件（注释：<strong>@Mapper</strong>）</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserMapper</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">DiscussPostMapper</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
</code></pre> 
<p>3、编写<code>xml</code>配置文件(放在 <code>resources.mapper</code>下)</p> 
<pre><code>user-mapper.xml       
DiscussPost-mapper.xml
</code></pre> 
<p>4、测试 <code>MapperTests.java</code></p> 
<h3><a id="13service_36"></a>1.3、service业务层</h3> 
<p>1、编写service包下的 <code>DiscussPostService.java</code>和<code>UserService.java</code>（通过userID查询到用户的信息）</p> 
<h3><a id="14Controller_40"></a>1.4、Controller视图层</h3> 
<h4><a id="14110_42"></a>1.4.1、开发社区首页，显示前10个数据</h4> 
<p>1、编写<code>HomeController.java</code></p> 
<p>2、<code>index.html</code></p> 
<p><img src="https://images2.imgbox.com/a3/70/P48Cq8yp_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="142_51"></a>1.4.2、开发分页组件</h4> 
<p>分页显示<br> <img src="https://images2.imgbox.com/9f/4a/kKNKd6X7_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="15_57"></a>1.5、项目调试技巧</h3> 
<blockquote> 
 <p>响应状态码的含义</p> 
</blockquote> 
<p>https://developer.mozilla.org/zh-CN/docs/Web/HTTP</p> 
<p>常见状态码：</p> 
<ul><li>200：请求成功</li><li>302：重定向：请求的资源现在临时从不同的 URI 响应请求。由于这样的重定向是临时的，客户端应当继续向原有地址发送以后的请求。只有在Cache-Control或Expires中进行了指定的情况下，这个响应才是可缓存的</li><li>404：客户端响应：请求失败，请求所希望得到的资源未被在服务器上发现。路径有问题。</li><li>500：服务器响应：服务器遇到了不知道如何处理的情况。</li></ul> 
<blockquote> 
 <p>服务端断点调试技巧</p> 
</blockquote> 
<blockquote> 
 <p>客户端断点调试技巧</p> 
</blockquote> 
<blockquote> 
 <p>设置日志级别，并将日志输出到不同的终端</p> 
</blockquote> 
<p><code>logback</code>配置文件：<code>logback-spring.xml</code></p> 
<h3><a id="16Git_78"></a>1.6、版本控制Git</h3> 
<h2><a id="SpringBoot_80"></a>二、SpringBoot实战，开发社区登录模块</h2> 
<h3><a id="21_82"></a>2.1、发送邮件</h3> 
<p><img src="https://images2.imgbox.com/65/29/0uwYzypR_o.png" alt="在这里插入图片描述"></p> 
<ol><li> <p>邮箱设置：启用客户端SMTP服务</p> </li><li> <p>Spring Email：</p> 
  <ul><li> <p>在<code>pom.xml</code>文件中导入jar包</p> </li><li> <p>邮箱参数配置<img src="https://images2.imgbox.com/95/32/8MD2f9AK_o.png" alt="在这里插入图片描述"></p> </li><li> <p>使用<code>JavaMailSender</code>发送邮件</p> 
    <ul><li>在<code>util</code>包下创建<code>MailClient.java</code>工具类，封装发送邮件功能</li><li>测试<code>MapperTests.java</code></li></ul> </li></ul> </li><li> <p>模板引擎</p> 
  <ul><li>使用<code>Thymeleaf</code>发送HTML邮件: <code>resource.templates.mail.demo.html</code></li></ul> </li></ol> 
<h3><a id="22_98"></a>2.2、开发注册功能</h3> 
<p><img src="https://images2.imgbox.com/c7/f9/uriSBUwi_o.png" alt="在这里插入图片描述"></p> 
<p><strong>共涉及到了三个请求</strong></p> 
<p>(1) 点击注册按钮，弹出注册框</p> 
<p>(2) 填完表单数据，点击注册，会发送一次请求</p> 
<p>(3) 注册成功后，用户接收到激活邮件后，点击激活邮件又会发送一次请求(进行激活服务)</p> 
<h4><a id="221_111"></a>2.2.1、请求一：访问注册页面</h4> 
<p>controller层，显示注册网站 <code>controller.LoginController.java</code></p> 
<p><img src="https://images2.imgbox.com/5e/1b/mmhekPeZ_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="222_118"></a>2.2.2、请求二：提交注册数据</h4> 
<ol><li>通过表单提交数据</li><li>服务端验证账号是否已经存在、邮箱是否已经注册</li><li>服务端发送激活邮件</li></ol> 
<h5><a id="1service_124"></a>（1）注册service层模块</h5> 
<p>导入 <code>commons lang</code> 依赖,完成对字符串的一些基本的判断，如非空等等</p> 
<p>配置网站相关信息</p> 
<pre><code class="prism language-java">#自己定义的属性
community<span class="token punctuation">.</span>path<span class="token punctuation">.</span>domain<span class="token operator">=</span>http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">8080</span>
</code></pre> 
<p>创建一个<code>CommunityUtil.java</code>工具类</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CommunityUtil</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//生成随机的字符串,以后将用于验证码的生成以及上传文件时对文件的随机命名</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">generateUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">//只需要数字和字符串，因此将-替换为空字符</span>
        <span class="token keyword">return</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//MD5加密,在密码的后面加上一个随机字符串，进而提高密码的安全性-只能加密而不能解密</span>
    <span class="token comment">// hello -&gt; abc123456</span>
    <span class="token comment">// hello + 3e4a8</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//利用spring自带的工具类来完成加密操作</span>
        <span class="token keyword">return</span> <span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5DigestAsHex</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>开发注册业务层：</strong><code>UserService.java</code>： 注入邮件客户端，注入模板引擎，注入域名的值和项目名</p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserMapper</span> userMapper<span class="token punctuation">;</span>
 
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MailClient</span> mailClient<span class="token punctuation">;</span><span class="token comment">//邮件客户端</span>
 
 
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${community.path.domain}"</span><span class="token punctuation">)</span><span class="token comment">//域名</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> domain<span class="token punctuation">;</span>
 
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${server.servlet.context-path}"</span><span class="token punctuation">)</span><span class="token comment">//项目名</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> contextPath<span class="token punctuation">;</span>
 
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">TemplateEngine</span> templateEngine<span class="token punctuation">;</span><span class="token comment">//模板引擎</span>

	<span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">findUserById</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> userMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>编写注册业务层<code>UserService.java</code>中注册方法的逻辑，将返回的结果封装在一个Map集合中：</p> 
<ul><li>先对参数值非空进行判断、账号是否存在、邮箱是否已经注册过，</li><li>开始注册用户，将用户信息保存至数据库中，生成一个随机码(salt:5位)追加在密码后面，对密码进行加密，覆盖user对象中的pass字段，再设置其他的字段(默认普通用户(type)，默认未激活（status），默认的头像路径（head_url))，随机生成一个激活码，设置至user对象之中，默认的注册时间。</li></ul> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//若注册失败则map ！= null，返回失败原因</span>

        <span class="token comment">// 空值处理</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"参数不能为空!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"usernameMsg"</span><span class="token punctuation">,</span> <span class="token string">"账号不能为空!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> map<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"passwordMsg"</span><span class="token punctuation">,</span> <span class="token string">"密码不能为空!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> map<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"emailMsg"</span><span class="token punctuation">,</span> <span class="token string">"邮箱不能为空!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> map<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 验证账号:在数据库中查询是否账号已经被注册！！！！</span>
        <span class="token class-name">User</span> u <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectByName</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>u <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"usernameMsg"</span><span class="token punctuation">,</span> <span class="token string">"该账号已存在!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> map<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 验证邮箱:在数据库中查询是否邮箱已经被注册！！！！</span>
        u <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectByEmail</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>u <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"emailMsg"</span><span class="token punctuation">,</span> <span class="token string">"该邮箱已被注册!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> map<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// 注册用户</span>
        <span class="token comment">//为加密密码生成5位的随机符串：</span>
        user<span class="token punctuation">.</span><span class="token function">setSalt</span><span class="token punctuation">(</span><span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">generateUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">md5</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> user<span class="token punctuation">.</span><span class="token function">getSalt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setActivationCode</span><span class="token punctuation">(</span><span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">generateUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//注册的激活码</span>
        user<span class="token punctuation">.</span><span class="token function">setHeaderUrl</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"http://images.nowcoder.com/head/%dt.png"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//随机头像</span>
        user<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//insert完了以后user里面就有id了，这是数据库自动为我们生成的id</span>
        userMapper<span class="token punctuation">.</span><span class="token function">insertUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//激活邮件</span>
        <span class="token class-name">Context</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span><span class="token function">setVariable</span><span class="token punctuation">(</span><span class="token string">"email"</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//url由程序员自己来定，你自己希望服务器用哪个路径去处理激活的请求</span>
        <span class="token comment">//路径中加入了userID和激活码code，为了后面激活账号的页面好获取到用户id和激活码！！！！</span>
        <span class="token comment">// 激活路径：http://localhost:8080/community/activation/101/code</span>
        <span class="token class-name">String</span> url <span class="token operator">=</span> domain <span class="token operator">+</span> contextPath <span class="token operator">+</span> <span class="token string">"/activation/"</span> <span class="token operator">+</span> user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> user<span class="token punctuation">.</span><span class="token function">getActivationCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span><span class="token function">setVariable</span><span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> content <span class="token operator">=</span> templateEngine<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token string">"/mail/activation"</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mailClient<span class="token punctuation">.</span><span class="token function">sendMail</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"激活账号"</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送激活邮件</span>

        <span class="token keyword">return</span> map<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>数据库自动为我们生成的id：<img src="https://images2.imgbox.com/e7/20/avXoaH18_o.png" alt="在这里插入图片描述"></p> 
<p>给用户发送HTML链接，模板参数<code>activation.html</code></p> 
<pre><code class="prism language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token name">doctype</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>th</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.thymeleaf.org<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>icon<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://static.nowcoder.com/images/logo_87_87.png<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>牛客网-激活账号<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${email}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>xxx@xxx.com<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span>, 您好!
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
			您正在注册牛客网, 这是一封激活邮件, 请点击 
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${url}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>此链接<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>,
			激活您的牛客账号!
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h5><a id="2Controller_277"></a>（2）注册Controller层模块</h5> 
<p><strong><code>LoginController.java</code>:</strong></p> 
<p><strong>注入<code>userService</code></strong></p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>
</code></pre> 
<p><strong>编写注册请求处理方法</strong></p> 
<p>调用<code>userService</code>的方法，如果注册成功，则需要跳转至网站的第三方页面上<code>operate-result.html</code></p> 
<pre><code class="prism language-java"> 
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path<span class="token operator">=</span><span class="token string">"/register"</span><span class="token punctuation">,</span>method<span class="token operator">=</span><span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>POST<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">Model</span> model<span class="token punctuation">,</span><span class="token class-name">User</span> user<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//注册成功的话先跳转到/site/operate-result.html页面上，然后再跳转至首页</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>map <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> map<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"msg"</span><span class="token punctuation">,</span><span class="token string">"注册成功，我们已经向您的邮箱发送了一封激活邮件,请尽快激活!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"target"</span><span class="token punctuation">,</span><span class="token string">"/index"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//最终需要跳转至首页</span>
            <span class="token keyword">return</span> <span class="token string">"/site/operate-result"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">//错误的时候直接把错误信息发送给页面即可，并且重新跳转至注册页面</span>
            model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"usernameMsg"</span><span class="token punctuation">,</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"usernameMsg"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"passwordMsg"</span><span class="token punctuation">,</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"passwordMsg"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"emailMsg"</span><span class="token punctuation">,</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"emailMsg"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">"/site/register"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><strong><code>resource.templates.site.operate-result.html</code></strong>:</p> 
<pre><code class="prism language-html">		<span class="token comment">&lt;!-- 内容 --&gt;</span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>main<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container mt-5<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>jumbotron<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
					<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lead<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${msg}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>您的账号已经激活成功,可以正常使用了!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
					<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>my-4<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
					<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
						系统会在 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>seconds<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text-danger<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span> 秒后自动跳转,
						您也可以点此 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>target<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@{${target}}<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text-primary<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>链接<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>, 手动跳转!
					<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h4><a id="223_331"></a>2.2.3、请求三：激活注册账号</h4> 
<h5><a id="1service_333"></a>（1）service层</h5> 
<p>用户点击激活邮件(携带参数<code>userId</code>和<code>activateCode</code>)，最终对应到数据库中就是需要改变用户的状态,在service层增加一个业务方法。</p> 
<p>激活逻辑判断:(对应三种情况)-把这三种情况放到一个接口的常量声明(<code>util.CommunityConstant.java</code>)里,为了实现复用, 让<code>UseService</code>实现这个常量接口。</p> 
<ul><li>(1)激活成功</li><li>(2)重复激活</li><li>(3)伪造的激活码</li></ul> 
<p><strong><code>CommunityConstant.java:</code></strong></p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>newcoder<span class="token punctuation">.</span>community<span class="token punctuation">.</span>util</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CommunityConstant</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//激活成功</span>
    <span class="token keyword">int</span> ACTIVATION_SUCCESS <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 
    <span class="token comment">//重复激活</span>
    <span class="token keyword">int</span> ACTIVATION_REPEAT <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
 
    <span class="token comment">//激活失败</span>
    <span class="token keyword">int</span> ACTIVATION_FAILURE <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>业务层：<strong><code>UseService.java:</code></strong> 根据用户id和激活码来激活用户</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token keyword">implements</span> <span class="token class-name">CommunityConstant</span> <span class="token punctuation">{<!-- --></span>
    
	<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">activation</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> code<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">//先根据userId查询出user</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//重复激活的情况</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> ACTIVATION_REPEAT<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//可以激活成功</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>code<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getActivationCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token comment">//输入的激活码=数据库中该user激活码</span>
            userMapper<span class="token punctuation">.</span><span class="token function">updateStatus</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//把用户的激活状态改为1，表示激活成功</span>
            <span class="token function">clearCache</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> ACTIVATION_SUCCESS<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> ACTIVATION_FAILURE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="2Controller_385"></a>（2）Controller层</h5> 
<p><code>LoginController.java</code>然该类实现<code>CommunityConstant</code>接口，再加一个响应登录页面<code>/login</code>的请求！！</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginController</span> <span class="token keyword">implements</span> <span class="token class-name">CommunityConstant</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">//....//</span>
    
    <span class="token comment">//响应登录页面的请求</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">"/login"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getLoginPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"/site/login"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
	<span class="token comment">//http://localhost:8080/community/activation/101/code :用户id和激活码</span>
	<span class="token comment">//@PathVariable("userID"):从路径中取值</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">"/activation/{userID}/{code}"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">activation</span><span class="token punctuation">(</span><span class="token class-name">Model</span> model<span class="token punctuation">,</span> <span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"userID"</span><span class="token punctuation">)</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">)</span><span class="token class-name">String</span> code<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">//成功的话直接跳转至login页面，否则直接跳转回首页</span>
        <span class="token keyword">int</span> result <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">activation</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>result <span class="token operator">==</span> ACTIVATION_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"msg"</span><span class="token punctuation">,</span><span class="token string">"激活成功，你的账号已经可以正常使用了!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"target"</span><span class="token punctuation">,</span><span class="token string">"/login"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//激活成果就跳到登录的页面！</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//激活失败：返回首页！</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>result <span class="token operator">==</span> ACTIVATION_REPEAT<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"msg"</span><span class="token punctuation">,</span><span class="token string">"无效操作，该账号已经激活过了!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"target"</span><span class="token punctuation">,</span><span class="token string">"/index"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"msg"</span><span class="token punctuation">,</span><span class="token string">"激活失败，您提供的激活码不正确!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"target"</span><span class="token punctuation">,</span><span class="token string">"/index"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token string">"/site/operate-result"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="23_424"></a>2.3、会话管理</h3> 
<p><strong>HTTP的基本性质：</strong></p> 
<ul><li>-HTTP是简单的</li><li>-HTTP是可扩展的</li><li>-HTTP是无状态的、有会话的 
  <ul><li>HTTP是无状态的:在同一个连接中，两个执行成功的请求之间是没有关系的。</li></ul> </li></ul> 
<p><strong>Cookie：</strong></p> 
<ul><li>-<font color="red">是服务器发送到浏览器，并保存在浏览器端的一小块数据</font></li><li>-浏览器下次访问该服务器时，会自动给携带该数据，将其发送给服务器</li><li>-通常，用于告知服务端两个请求是否来自同一浏览器，如保持用户的登录状态。</li></ul> 
<p><strong>Session：</strong></p> 
<ul><li>-是<code>JavaEE</code>的标准，用于在服务端纪录客户端信息。</li><li>-<font color="red">数据存放在服务端更加安全，但是也会增加服务端的内存压力。</font></li></ul> 
<p>**会话:**用户和服务器之间的对话是连贯的，而非割裂的。由服务器创建发送到用户浏览器并保存在本地的一小块数据。它会在浏览器下次向同一服务器请求时发送这块数据给服务器。</p> 
<h5><a id="1Cookie_446"></a>（1）Cookie的使用案例</h5> 
<ul><li>**HTTP是无状态的:**在同一个连接中，两个执行成功的请求之间是没有关系的。</li><li>这就带来了一个问题，<strong><font color="red">用户没有办法在同一个网站中进行连续的交互</font></strong>，比如在一个电商网站里，用户把某个商品加入到购物车，切换一个页面后再次添加了商品，这两次添加商品的请求之间没有关联，浏览器无法知道用户最终选择了哪些商品。</li><li>而使用HTTP的头部扩展，HTTP Cookie就可以解决这个问题。<strong><font color="red">把Cookies添加到头部中，创建一个会话让每次请求都能共享相同的上下文信息，达成相同的状态</font></strong>。</li><li>有些网站需要有持续性的交互，HTTP本质是无状态的，<strong>使用Cookie可以创建有状态的会话。</strong></li><li><strong>需要把创建的cookie存放至response中，这样才能返回给客户端。</strong></li><li><strong>由服务器创建发送到用户浏览器并保存在本地的一小块数据。它会在浏览器下次向同一服务器请求时发送这块数据给服务器。</strong></li><li>**cookie只能存一个key-value,只能存很少的数据。**而且cookie是存储在response的头部中，不是在数据中。<br> 如果不设置生效时间，cookie存储在内存中，等浏览器一关闭，就消失了， 但如果设置了生效时间，就会存储在硬盘中。</li><li>创建cookie时可以指定key的值(“code”),一个cookie只存一个key value.</li></ul> 
<p><img src="https://images2.imgbox.com/dc/4a/Qo4ZXM8o_o.png" alt="在这里插入图片描述"></p> 
<p>代码实例：</p> 
<pre><code class="prism language-java">	<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">"/cookie/set"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">setCookie</span><span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 创建Cookie，key-value</span>
        <span class="token class-name">Cookie</span> cookie <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cookie</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span> <span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">generateUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置cookie的生效范围 只针对某个功能下的访问生效，只有在这个路径下才有效</span>
        cookie<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span><span class="token string">"/community/alpha"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置cookie的生效时间 默认情况下浏览器一关闭cookie就失效，但一旦设置了cookie的生存时间，再次打开浏览器会依旧有效。</span>
        cookie<span class="token punctuation">.</span><span class="token function">setMaxAge</span><span class="token punctuation">(</span><span class="token number">60</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置10分钟</span>
        response<span class="token punctuation">.</span><span class="token function">addCookie</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//需要把创建好的cookie存放到response之中</span>
        <span class="token keyword">return</span> <span class="token string">"set cookie"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>请求相应的url：localhost:8080/community/alpha/cookie/set</p> 
<p><img src="https://images2.imgbox.com/5f/c5/E4zYP0Kz_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/63/e0/jo3KlMXy_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-java">   <span class="token comment">//服务器获取cookie</span>
	<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">"/cookie/get"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ReusponseBody</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getCookie</span><span class="token punctuation">(</span><span class="token annotation punctuation">@CookieValue</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> code<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"get cooke"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><font color="red">如何获取浏览器中指定的cookie值?</font></p> 
<ul><li>可以从request对象中获得Cookie的数组(包含了所有的cookie)</li><li><font color="red">@CookieValue</font>表示需要从cookie中获取code的值</li></ul> 
<h5><a id="2Session_500"></a>（2）Session的使用案例</h5> 
<ul><li>cookie的缺点:<font color="red">不安全</font>，因为cookie是存在客户端的；每次请求都要携带cookie数据，<font color="red">会造成性能低的后果</font>。</li><li>利用一种思路:session：<font color="red">在服务端存放用户数据</font>：session使用依赖cookie</li><li>session不是http的标准，而是JavaEE的标准，用于在服务端记录客户端信息。</li></ul> 
<p><img src="https://images2.imgbox.com/30/6a/0eUvCxZN_o.png" alt="在这里插入图片描述"></p> 
<ul><li>浏览器<strong>第一次访问服务器:服务器先创建一个session对象</strong>（每个浏览器访问服务器都会创建一个session）</li><li>服务器自动创建一个存放sessionId的cookie, 用来维护浏览器和服务器之间的对应关系。</li><li><strong>浏览器保存cookie,下次访问服务器，携带上cookie。</strong></li><li>服务器再从cookie中根据<strong>sessionId</strong>找到响应的session,再找到对应的session里存放的数据。</li><li>和手动创建cookie不同的是，HttpSession SpringMVC会自动给我们创建session创建并注入进来。</li><li>session的使用和request和response的使用一样。</li></ul> 
<pre><code class="prism language-java">    <span class="token comment">//在服务器端创建session</span>
	<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">"/session/set"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">setSession</span><span class="token punctuation">(</span><span class="token class-name">HttpSession</span> session<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        session<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        session<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span><span class="token string">"Test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"set session"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 	
	<span class="token comment">//服务器获取浏览器请求中的session</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">"/session/get"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getSession</span><span class="token punctuation">(</span><span class="token class-name">HttpSession</span> session<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"get session"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>浏览器发起在服务器端创建session的请求：</p> 
<p><img src="https://images2.imgbox.com/b6/d8/h5sqR58D_o.png" alt="在这里插入图片描述"></p> 
<p>浏览器发起让服务器获取session的请求：</p> 
<p><img src="https://images2.imgbox.com/41/66/KED2vXlN_o.png" alt="在这里插入图片描述"></p> 
<p><strong><font color="cornflowerblue">sesson存储在服务端，大小和类型不受限制，但cookie需要来回传，大小受限制，而且只能保存字符串类型。</font></strong></p> 
<p>一般情况下，如果数据不是特别隐私，还是使用cookie会比较好。</p> 
<h5><a id="3Session_550"></a>（3）共享Session</h5> 
<p>session和cookie都是为了解决会话的技术，各有各自的优缺点，使用应该视具体情况而定，能用cookie尽量用cookie,减少服务端的压力。<strong>但是使用session会存在一个session共享(分布式部署的时候)的问题。</strong></p> 
<p><img src="https://images2.imgbox.com/af/7a/k1ZvgZLO_o.png" alt="在这里插入图片描述"></p> 
<p>解决方案:</p> 
<ul><li><font color="red">黏性session，不完美，将请求和IP固定起来了,每个IP发送过来的请求都由固定个服务器来进行处理，会造成负载不均衡。</font></li><li><font color="red">同步session，所有的服务器中的session数据都是相同的，每个服务器都存储了所有的session，服务器的压力会比较大，另外一个，服务器和服务器之间会产生关联，不再像以前那么独立了，产生一定的耦合，对部署有一定的影响， 非理想！</font></li><li><strong>共享session: 所有的session都由一台服务器进行专门进行处理，当其他服务器需要利用session时，直接从此服务器中获取。<font color="red">缺点:容易出现单点故障问题。分布式部署的目的：解决性能瓶颈</font></strong></li><li>主流的解决方案： 
  <ul><li>数据能存放在cookie就存放在cookie里，而不存放至session中去。</li><li>将session存放至**<font color="red">数据库</font><strong>中，所有服务器都可以访问</strong><font color="red">数据库集群</font>**来得到客户端的会话的数据。</li><li><strong>缺点：从数据库硬盘中获取数据显然和从内存中获取数据的性能差别甚大，在<font color="red">并发度大</font>的时候也容易成为一个瓶颈，但现在<font color="red">非关系型数据库(内存) redis</font>能弥补以上问题。</strong></li></ul> </li></ul> 
<img src="https://images2.imgbox.com/67/be/uI8N4wIB_o.png" alt="img"> 
<h3><a id="24session_569"></a>2.4、生成验证码（存于session）</h3> 
<h4><a id="1Kaptchajar_571"></a>（1）导入Kaptcha的jar包</h4> 
<h4><a id="2Kaptcha_573"></a>（2）编写Kaptcha配置类</h4> 
<ul><li>加入至spring的bean容器管理之中。</li><li>核心是一个<strong>Producer接口</strong>，创建一个Properties ，用Config装配，然后再传递给DefaultKaptcha创建一个实例，然后再调用这个实例的方法来生成图片。<br> <img src="https://images2.imgbox.com/68/7b/sDqbN103_o.png" alt="在这里插入图片描述"></li></ul> 
<p><strong><code>config.KaptchaConfig.java:</code></strong></p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>code<span class="token punctuation">.</span>kaptcha<span class="token punctuation">.</span></span><span class="token class-name">Producer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>code<span class="token punctuation">.</span>kaptcha<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span><span class="token class-name">DefaultKaptcha</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>code<span class="token punctuation">.</span>kaptcha<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Config</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KaptchaConfig</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Producer</span> <span class="token function">kaptchaProducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//Producer接口</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"kaptcha.image.width"</span><span class="token punctuation">,</span> <span class="token string">"100"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"kaptcha.image.height"</span><span class="token punctuation">,</span> <span class="token string">"40"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"kaptcha.textproducer.font.size"</span><span class="token punctuation">,</span> <span class="token string">"32"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"kaptcha.textproducer.font.color"</span><span class="token punctuation">,</span> <span class="token string">"0,0,0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"kaptcha.textproducer.char.string"</span><span class="token punctuation">,</span> <span class="token string">"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYAZ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"kaptcha.textproducer.char.length"</span><span class="token punctuation">,</span> <span class="token string">"4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"kaptcha.noise.impl"</span><span class="token punctuation">,</span> <span class="token string">"com.google.code.kaptcha.impl.NoNoise"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">DefaultKaptcha</span> kaptcha <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultKaptcha</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//config依赖于properties</span>
        kaptcha<span class="token punctuation">.</span><span class="token function">setConfig</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> kaptcha<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>（3）生成随机字符、生成图片(Contoller层)</strong></p> 
<ul><li>方法返回值为void,因为需要<strong>利用response对象向浏览器输出数据</strong>。</li><li><strong>服务端需要记住生成的验证码,因为客户端输入验证码后，服务器需要验证是否正确</strong>(是敏感数据，不能存在浏览器中，而存倒服务器端，而且是需要跨请求的，选择**<font color="red">session</font>**).</li><li>注入生成验证码的配置类</li></ul> 
<p><font color="red">LoginController.java：</font></p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">LoginController</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">Producer</span> kaptchaProducer<span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">"/kaptcha"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getKaptcha</span><span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">HttpSession</span> session<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 生成验证码</span>
        <span class="token class-name">String</span> text <span class="token operator">=</span> kaptchaProducer<span class="token punctuation">.</span><span class="token function">createText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BufferedImage</span> image <span class="token operator">=</span> kaptchaProducer<span class="token punctuation">.</span><span class="token function">createImage</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 将验证码存入session</span>
        session<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"kaptcha"</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 将图片输出给浏览器</span>
        response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">"image/png"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//申明浏览器返回的是什么格式的数据</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">OutputStream</span> os <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//OS输出流</span>
            <span class="token class-name">ImageIO</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> <span class="token string">"png"</span><span class="token punctuation">,</span> os<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将image以.png的格式向OS输出流输出</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"响应验证码失败:"</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><font color="red">login.html：</font></p> 
<p>在前台中<strong>通过js来实现每次点击都刷新验证码的功能。</strong></p> 
<p><img src="https://images2.imgbox.com/54/0a/WuyzqTej_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-js">	<span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
		<span class="token keyword">function</span> <span class="token function">refresh_kaptcha</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">var</span> path <span class="token operator">=</span> <span class="token constant">CONTEXT_PATH</span> <span class="token operator">+</span> <span class="token string">"/kaptcha?p="</span> <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#kaptcha"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">"src"</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre> 
<h3><a id="25_660"></a>2.5、开发登录和退出功能</h3> 
<p>点击登录后，转到登录页面，服务器在这里就存了验证码session，用户填完登录信息提交后，<br> <img src="https://images2.imgbox.com/47/3e/B8NbXM0k_o.png" alt="在这里插入图片描述"></p> 
<p><font color="red">建立登录凭证的数据库：</font></p> 
<p><img src="https://images2.imgbox.com/99/a9/f5f7cUJr_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="1dao_673"></a>（1）dao数据访问层</h4> 
<ol><li> <p>Entity：LoginTicket.java</p> </li><li> <p>dao: LoginTicketMapper.java,通过注解代替Mapper文件</p> <pre><code class="prism language-java"><span class="token annotation punctuation">@Mapper</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">LoginTicketMapper</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Insert</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token comment">//主键不用插，自动生成</span>
            <span class="token string">"insert into login_ticket(user_id,ticket,status,expired) "</span><span class="token punctuation">,</span>
            <span class="token string">"values(#{userId},#{ticket},#{status},#{expired})"</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Options</span><span class="token punctuation">(</span>useGeneratedKeys <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> keyProperty <span class="token operator">=</span> <span class="token string">"id"</span><span class="token punctuation">)</span><span class="token comment">//自动生成主键</span>
    <span class="token keyword">int</span> <span class="token function">insertLoginTicket</span><span class="token punctuation">(</span><span class="token class-name">LoginTicket</span> loginTicket<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            <span class="token string">"select id,user_id,ticket,status,expired "</span><span class="token punctuation">,</span>
            <span class="token string">"from login_ticket where ticket=#{ticket}"</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token class-name">LoginTicket</span> <span class="token function">selectByTicket</span><span class="token punctuation">(</span><span class="token class-name">String</span> ticket<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ticket是唯一标识符</span>

    <span class="token annotation punctuation">@Update</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token comment">//演示注解的动态sql</span>
            <span class="token string">"&lt;script&gt;"</span><span class="token punctuation">,</span>
            <span class="token string">"update login_ticket set status=#{status} where ticket=#{ticket} "</span><span class="token punctuation">,</span>
            <span class="token string">"&lt;if test=\"ticket!=null\"&gt; "</span><span class="token punctuation">,</span>
            <span class="token string">"and 1=1 "</span><span class="token punctuation">,</span>
            <span class="token string">"&lt;/if&gt;"</span><span class="token punctuation">,</span>
            <span class="token string">"&lt;/script&gt;"</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">int</span> <span class="token function">updateStatus</span><span class="token punctuation">(</span><span class="token class-name">String</span> ticket<span class="token punctuation">,</span> <span class="token keyword">int</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p>测试：MapperTest.java</p> </li></ol> 
<h4><a id="2service_710"></a>（2）service层</h4> 
<p>UserService.java:</p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">LoginTicketMapper</span> loginTicketMapper<span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-java">    <span class="token comment">//map:多种情况的返回结果；password需要加密；expiredSeconds过期时限</span>
	<span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">,</span> <span class="token keyword">int</span> expiredSeconds<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 空值处理</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"usernameMsg"</span><span class="token punctuation">,</span> <span class="token string">"账号不能为空!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> map<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"passwordMsg"</span><span class="token punctuation">,</span> <span class="token string">"密码不能为空!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> map<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 验证账号：根据用户名来查询用户对象user</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectByName</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"usernameMsg"</span><span class="token punctuation">,</span> <span class="token string">"该账号不存在!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> map<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 验证状态</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"usernameMsg"</span><span class="token punctuation">,</span> <span class="token string">"该账号未激活!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> map<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 验证密码</span>
        password <span class="token operator">=</span> <span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">md5</span><span class="token punctuation">(</span>password <span class="token operator">+</span> user<span class="token punctuation">.</span><span class="token function">getSalt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"passwordMsg"</span><span class="token punctuation">,</span> <span class="token string">"密码不正确!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> map<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 生成登录凭证</span>
        <span class="token class-name">LoginTicket</span> loginTicket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LoginTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        loginTicket<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//凭证是一个随机生成的字符串，所以每次登录同一个用户的登录凭证都是不一样的</span>
        loginTicket<span class="token punctuation">.</span><span class="token function">setTicket</span><span class="token punctuation">(</span><span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">generateUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        loginTicket<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//0-有效状态</span>
        loginTicket<span class="token punctuation">.</span><span class="token function">setExpired</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> expiredSeconds <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        loginTicketMapper<span class="token punctuation">.</span><span class="token function">insertLoginTicket</span><span class="token punctuation">(</span>loginTicket<span class="token punctuation">)</span><span class="token punctuation">;</span>

        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"ticket"</span><span class="token punctuation">,</span> loginTicket<span class="token punctuation">.</span><span class="token function">getTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ticket放入map中作为返回值</span>
        <span class="token keyword">return</span> map<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>退出：</p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">logout</span><span class="token punctuation">(</span><span class="token class-name">String</span> ticket<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        loginTicketMapper<span class="token punctuation">.</span><span class="token function">updateStatus</span><span class="token punctuation">(</span>ticket<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="3Controller_776"></a>（3）Controller层</h4> 
<p><img src="https://images2.imgbox.com/a7/f8/aiwQOj6w_o.png" alt="在这里插入图片描述"></p> 
<p>CommunityConstant.java:</p> 
<pre><code class="prism language-java">    <span class="token comment">/**
     * 默认状态的登录凭证的超时时间
     */</span>
    <span class="token keyword">int</span> DEFAULT_EXPIRED_SECONDS <span class="token operator">=</span> <span class="token number">3600</span> <span class="token operator">*</span> <span class="token number">12</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 记住状态的登录凭证超时时间
     */</span>
    <span class="token keyword">int</span> REMEMBER_EXPIRED_SECONDS <span class="token operator">=</span> <span class="token number">3600</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">;</span>
</code></pre> 
<p>LoginController.java:</p> 
<p><font color="red">response中的cookie：若登录成功，服务端需将凭证放在cookie中发送给客户端</font></p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${server.servlet.context-path}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> contextPath<span class="token punctuation">;</span>
	<span class="token comment">//和点进等录按钮的请求路径一致，不要紧，因为请求方式不同，这里是post，提交数据</span>
	<span class="token comment">//code:客户端提交的验证码；session中保存了服务器向客户端发送的验证码；</span>
	<span class="token comment">//response中的cookie：若登录成功，服务端需将凭证放在cookie中发送给客户端</span>
	<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">"/login"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>POST<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">,</span> <span class="token class-name">String</span> code<span class="token punctuation">,</span> <span class="token keyword">boolean</span> rememberme<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">,</span> <span class="token class-name">HttpSession</span> session<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 检查验证码，在2.4节中服务器给客户端的响应中存了session(验证码)</span>
        <span class="token class-name">String</span> kaptcha <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"kaptcha"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>kaptcha<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>kaptcha<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"codeMsg"</span><span class="token punctuation">,</span> <span class="token string">"验证码不正确!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">"/site/login"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 检查账号,密码</span>
        <span class="token keyword">int</span> expiredSeconds <span class="token operator">=</span> rememberme <span class="token operator">?</span> 
            REMEMBER_EXPIRED_SECONDS <span class="token operator">:</span> DEFAULT_EXPIRED_SECONDS<span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> expiredSeconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token string">"ticket"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//cookie中放凭证</span>
            <span class="token class-name">Cookie</span> cookie <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cookie</span><span class="token punctuation">(</span><span class="token string">"ticket"</span><span class="token punctuation">,</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"ticket"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            cookie<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span>contextPath<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//整个项目的路径都有效</span>
            cookie<span class="token punctuation">.</span><span class="token function">setMaxAge</span><span class="token punctuation">(</span>expiredSeconds<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//cookie的有效时间</span>
            response<span class="token punctuation">.</span><span class="token function">addCookie</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">"redirect:/index"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"usernameMsg"</span><span class="token punctuation">,</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"usernameMsg"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"passwordMsg"</span><span class="token punctuation">,</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"passwordMsg"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">"/site/login"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>login.html</p> 
<p>退出登录：<font color="red">通过ticket退出登录</font></p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">"/logout"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">logout</span><span class="token punctuation">(</span><span class="token annotation punctuation">@CookieValue</span><span class="token punctuation">(</span><span class="token string">"ticket"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> ticket<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        userService<span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span>ticket<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"redirect:/login"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>配置退出登录的链接index.html</p> 
<h3><a id="26_847"></a>2.6、显示登录信息</h3> 
<p><img src="https://images2.imgbox.com/8f/af/mhEZOh8m_o.png" alt="在这里插入图片描述"></p> 
<p>根据登录与否显示相应的内容</p> 
<h4><a id="1_854"></a>（1）拦截器实例</h4> 
<p>AlphaInterceptor.java :</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AlphaInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">AlphaInterceptor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//在Controller处理请求之前执行，如果返回为false的话，请求就不会被处理</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"preHandle："</span> <span class="token operator">+</span> handler<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//在controller之后执行,主要的请求已经处理完了，下一步就是要去调用模板引擎了，所以有ModelAndView</span>
    <span class="token comment">//在模板引擎执行之前执行</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">ModelAndView</span> modelAndView<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"postHandle："</span> <span class="token operator">+</span> handler<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//在模板引擎执行之后执行</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterCompletion</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"afterCompletion："</span> <span class="token operator">+</span> handler<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>为了使得拦截器生效，还需要写一个配置类:WebMvcConfig.java</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebMvcConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">AlphaInterceptor</span> alphaInterceptor<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">LoginTicketInterceptor</span> loginTicketInterceptor<span class="token punctuation">;</span>
    <span class="token comment">/*@Autowired
    private LoginRequiredInterceptor loginRequiredInterceptor;*/</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DataInterceptor</span> dataInterceptor<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MessageInterceptor</span> messageInterceptor<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span><span class="token class-name">InterceptorRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//排除所有目录下的所有文件夹，将拦截器注册进去</span>
        <span class="token comment">//排除掉静态资源不进行处理</span>
        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span>alphaInterceptor<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">excludePathPatterns</span><span class="token punctuation">(</span><span class="token string">"/**/*.css"</span><span class="token punctuation">,</span> <span class="token string">"/**/*.js"</span><span class="token punctuation">,</span> <span class="token string">"/**/*.jpg"</span><span class="token punctuation">,</span> <span class="token string">"/**/*.jpeg"</span><span class="token punctuation">,</span> <span class="token string">"/**/*.png"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addPathPatterns</span><span class="token punctuation">(</span><span class="token string">"/register"</span><span class="token punctuation">,</span> <span class="token string">"/login"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//表示只拦截register下的内容</span>
        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span>loginTicketInterceptor<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">excludePathPatterns</span><span class="token punctuation">(</span><span class="token string">"/**/*.css"</span><span class="token punctuation">,</span> <span class="token string">"/**/*.js"</span><span class="token punctuation">,</span> <span class="token string">"/**/*.jpg"</span><span class="token punctuation">,</span> <span class="token string">"/**/*.jpeg"</span><span class="token punctuation">,</span> <span class="token string">"/**/*.png"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//registry.addInterceptor(loginRequiredInterceptor)</span>
        <span class="token comment">// .excludePathPatterns("/**/*.css", "/**/*.js", "/**/*.jpg", "/**/*.jpeg", "/**/*.png");</span>
        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span>messageInterceptor<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">excludePathPatterns</span><span class="token punctuation">(</span><span class="token string">"/**/*.css"</span><span class="token punctuation">,</span> <span class="token string">"/**/*.js"</span><span class="token punctuation">,</span> <span class="token string">"/**/*.jpg"</span><span class="token punctuation">,</span> <span class="token string">"/**/*.jpeg"</span><span class="token punctuation">,</span> <span class="token string">"/**/*.png"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span>dataInterceptor<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">excludePathPatterns</span><span class="token punctuation">(</span><span class="token string">"/**/*.css"</span><span class="token punctuation">,</span> <span class="token string">"/**/*.jpg"</span><span class="token punctuation">,</span> <span class="token string">"/**/*.jpeg"</span><span class="token punctuation">,</span> <span class="token string">"/**/*.png"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>需要根据是否登录来调整头部显示的信息。可以利用拦截器来降低模块之间的耦合度。服务器得到了凭证就能得到用户对象。</p> 
<p>handler为拦截的目标。</p> 
<h4><a id="2_919"></a>（2）拦截器应用-显示用户登录信息</h4> 
<ul><li>类似这种显示用户信息的在多个页面上都要显示，如果每打开一个页面都重新发送一次请求获取数据的话，<strong>耦合度比较高.</strong></li><li>可以利用<strong>统一集中的低耦合度</strong>方式实现(<strong><font color="red">拦截器，可以拦截请求，在请求开始和结束的位置插入一些代码,从而批量解决多个请求共有的业务，以低耦度的方式解决通用的问题</font></strong>)</li></ul> 
<img src="https://images2.imgbox.com/ae/e2/yu7cADrM_o.png" alt="img"> 
<ul><li>浏览器携带cookie访问服务器，服务器获得cookie中的ticket凭证，从数据中查询关联到用户（userid），进而查询到User对象</li><li>在接下来的每次调用模板引擎之前将用户信息装入Model中。</li><li>关键在于(用户登陆的时候，存入了ticket,再下次访问的时候可获取到ticket值)。这套逻辑应被复用，利用拦截器来实现。</li></ul> 
<p>只在浏览器中存一个ticket，而不存储用户的数据，这避免了敏感数据所造成的不安全问题。这套逻辑不应该实现多次，因为每次请求都需要在页面上显示用户的数据，可以让拦截器来实现。</p> 
<h5><a id="1LoginInterceptorfont_colorredfont_932"></a>1)创建LoginInterceptor(<font color="red">涉及多线程！</font>)</h5> 
<h6><a id="1preHandle_934"></a>1、preHandle方法之中，保存用户数据</h6> 
<ul><li>封装从request中获取cookie的工具类CookieUtil。</li><li>在请求开始之前就需要保存数据，因为在之后的可能随时随地都需要使用。</li></ul> 
<p>CookieUtil.java 从requeset中获取cookie:</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CookieUtil</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//name:我们想得到的cookie的名字</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>request <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> name <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"参数为空"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Cookie</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cookies <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getCookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>cookies <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Cookie</span> cookie<span class="token operator">:</span>cookies<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>cookie<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> cookie<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>UserService.java中添加查询ticket方法：</p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token class-name">LoginTicket</span> <span class="token function">findLoginTicket</span><span class="token punctuation">(</span><span class="token class-name">String</span> ticket<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> loginTicketMapper<span class="token punctuation">.</span><span class="token function">selectByTicket</span><span class="token punctuation">(</span>ticket<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>HostHolder.java</p> 
<ul><li>服务器在处理请求的时候会创建<strong>一个线程</strong>来处理用户的请求，请求响应了数据，有了返回值之后，线程才会被销毁。</li><li>在**<font color="red">多并发</font><strong>的情况下，需要考虑</strong><font color="red">线程的隔离</font><strong>，利用</strong><font color="red">ThreadLocal</font>**工具(以线程为key存取值)来实现。 
  <ul><li><font color="red">ThreadLocal为每个使用该变量的线程提供独立的变量副本，所以每一个线程都可以独立地改变自己的副本，而不会影响其它线程所对应的副本</font></li></ul> </li><li>创建一个HostHolder工具类，代替session对象</li></ul> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 持有用户信息,用于代替session对象.
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HostHolder</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> users <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//设置当前线程的user</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUser</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        users<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">//得到当前线程的user</span>
    <span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> users<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//清理当前线程的user</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        users<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>LoginTicketInterceptor.java中preHandle方法：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginTicketInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">HostHolder</span> hostHolder<span class="token punctuation">;</span>
	
    <span class="token comment">//一开始就拦截请求获得里面的ticket再去查询有没有这个用户</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 从cookie中获取凭证</span>
        <span class="token class-name">String</span> ticket <span class="token operator">=</span> <span class="token class-name">CookieUtil</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">"ticket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>ticket <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 查询凭证,得到loginTicket对象</span>
            <span class="token class-name">LoginTicket</span> loginTicket <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">findLoginTicket</span><span class="token punctuation">(</span>ticket<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 检查凭证是否有效</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>loginTicket <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> loginTicket<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> loginTicket<span class="token punctuation">.</span><span class="token function">getExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 根据凭证查询用户</span>
                <span class="token class-name">User</span> user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">findUserById</span><span class="token punctuation">(</span>loginTicket<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//在本次请求中持有用户</span>
                <span class="token comment">//考虑多线程的情况，要隔离的存当前用户信息</span>
                <span class="token comment">//需要把User进行暂存,表示在本次请求中持有用户,把对象存储在当前线程ThreadLocal之中</span>
                hostHolder<span class="token punctuation">.</span><span class="token function">setUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="2_postHandleUser_1037"></a>2、 在postHandle方法之中使用保存的User对象信息</h6> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Override</span> <span class="token comment">//在模板引擎调用之前把数据存储在hostHolder之中的数据放入Model之中</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span>
                           <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">ModelAndView</span> modelAndView<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>user <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> modelAndView <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            modelAndView<span class="token punctuation">.</span><span class="token function">addObject</span><span class="token punctuation">(</span><span class="token string">"loginUser"</span><span class="token punctuation">,</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h6><a id="3_afterCompletion_1050"></a>3、 在afterCompletion()，模板引擎渲染完之后清除掉用户的数据</h6> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterCompletion</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span><span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//在模板执行完之后将数据清理掉</span>
        hostHolder<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h5><a id="2_LoginInterceptor_1060"></a>2) 配置LoginInterceptor</h5> 
<ul><li>在WebMvcConfig类之中</li></ul> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">LoginTicketInterceptor</span> loginTicketInterceptor<span class="token punctuation">;</span>

	<span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span><span class="token class-name">InterceptorRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span>loginTicketInterceptor<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">excludePathPatterns</span><span class="token punctuation">(</span><span class="token string">"/**/*.css"</span><span class="token punctuation">,</span> <span class="token string">"/**/*.js"</span><span class="token punctuation">,</span> <span class="token string">"/**/*.png"</span><span class="token punctuation">,</span> <span class="token string">"/**/*.jpg"</span><span class="token punctuation">,</span> <span class="token string">"/**/*.jpeg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//所有路径的请求都要此拦截！！！</span>
        
    <span class="token punctuation">}</span>
</code></pre> 
<h5><a id="3__1077"></a>3) 页面显示用户信息</h5> 
<ul><li>处理情况:未登录不显示用户的信息，登录才显示(<strong>根据Model里面是否有loginUser来判断</strong>)</li></ul> 
<pre><code class="prism language-java"><span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"collapse navbar-collapse"</span> id<span class="token operator">=</span><span class="token string">"navbarSupportedContent"</span><span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>ul <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"navbar-nav mr-auto"</span><span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>li <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"nav-item ml-3 btn-group-vertical"</span><span class="token operator">&gt;</span>
			<span class="token operator">&lt;</span>a <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"nav-link"</span> th<span class="token operator">:</span>href<span class="token operator">=</span><span class="token string">"@{/index}"</span><span class="token operator">&gt;</span>首页<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>li <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"nav-item ml-3 btn-group-vertical"</span> th<span class="token operator">:</span><span class="token keyword">if</span><span class="token operator">=</span><span class="token string">"${loginUser!=null}"</span><span class="token operator">&gt;</span>
			<span class="token operator">&lt;</span>a <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"nav-link position-relative"</span> th<span class="token operator">:</span>href<span class="token operator">=</span><span class="token string">"@{/letter/list}"</span><span class="token operator">&gt;</span>消息
				<span class="token operator">&lt;</span>span <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"badge badge-danger"</span> th<span class="token operator">:</span>text<span class="token operator">=</span><span class="token string">"${allUnreadCount!=0?allUnreadCount:''}"</span><span class="token operator">&gt;</span><span class="token number">12</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
			<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>li <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"nav-item ml-3 btn-group-vertical"</span> th<span class="token operator">:</span><span class="token keyword">if</span><span class="token operator">=</span><span class="token string">"${loginUser==null}"</span><span class="token operator">&gt;</span>
			<span class="token operator">&lt;</span>a <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"nav-link"</span> th<span class="token operator">:</span>href<span class="token operator">=</span><span class="token string">"@{/register}"</span><span class="token operator">&gt;</span>注册<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>li <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"nav-item ml-3 btn-group-vertical"</span> th<span class="token operator">:</span><span class="token keyword">if</span><span class="token operator">=</span><span class="token string">"${loginUser==null}"</span><span class="token operator">&gt;</span>
			<span class="token operator">&lt;</span>a <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"nav-link"</span> th<span class="token operator">:</span>href<span class="token operator">=</span><span class="token string">"@{/login}"</span><span class="token operator">&gt;</span>登录<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>li <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"nav-item ml-3 btn-group-vertical dropdown"</span> th<span class="token operator">:</span><span class="token keyword">if</span><span class="token operator">=</span><span class="token string">"${loginUser!=null}"</span><span class="token operator">&gt;</span>
			<span class="token operator">&lt;</span>a <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"nav-link dropdown-toggle"</span> href<span class="token operator">=</span><span class="token string">"#"</span> id<span class="token operator">=</span><span class="token string">"navbarDropdown"</span> role<span class="token operator">=</span><span class="token string">"button"</span> data<span class="token operator">-</span>toggle<span class="token operator">=</span><span class="token string">"dropdown"</span> aria<span class="token operator">-</span>haspopup<span class="token operator">=</span><span class="token string">"true"</span> aria<span class="token operator">-</span>expanded<span class="token operator">=</span><span class="token string">"false"</span><span class="token operator">&gt;</span>
				<span class="token operator">&lt;</span>img th<span class="token operator">:</span>src<span class="token operator">=</span><span class="token string">"${loginUser.headerUrl}"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"rounded-circle"</span> style<span class="token operator">=</span><span class="token string">"width:30px;"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
			<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
			<span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"dropdown-menu"</span> aria<span class="token operator">-</span>labelledby<span class="token operator">=</span><span class="token string">"navbarDropdown"</span><span class="token operator">&gt;</span>
				<span class="token operator">&lt;</span>a <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"dropdown-item text-center"</span>
				   th<span class="token operator">:</span>href<span class="token operator">=</span><span class="token string">"@{|/user/profile/${loginUser.id}|}"</span><span class="token operator">&gt;</span>个人主页<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
				<span class="token operator">&lt;</span>a <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"dropdown-item text-center"</span> th<span class="token operator">:</span>href<span class="token operator">=</span><span class="token string">"@{/user/setting}"</span><span class="token operator">&gt;</span>账号设置<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
				<span class="token operator">&lt;</span>a <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"dropdown-item text-center"</span> th<span class="token operator">:</span>href<span class="token operator">=</span><span class="token string">"@{/logout}"</span><span class="token operator">&gt;</span>退出登录<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
				<span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"dropdown-divider"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
				<span class="token operator">&lt;</span>span <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"dropdown-item text-center text-secondary"</span>
					  th<span class="token operator">:</span>utext<span class="token operator">=</span><span class="token string">"${loginUser.username}"</span><span class="token operator">&gt;</span>nowcoder<span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
			<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 搜索 <span class="token operator">--</span><span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>form <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-inline my-2 my-lg-0"</span> th<span class="token operator">:</span>action<span class="token operator">=</span><span class="token string">"@{/search}"</span> method<span class="token operator">=</span><span class="token string">"get"</span><span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>input <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-control mr-sm-2"</span> type<span class="token operator">=</span><span class="token string">"search"</span> aria<span class="token operator">-</span>label<span class="token operator">=</span><span class="token string">"Search"</span> name<span class="token operator">=</span><span class="token string">"keyword"</span> th<span class="token operator">:</span>value<span class="token operator">=</span><span class="token string">"${keyword}"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>button <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"btn btn-outline-light my-2 my-sm-0"</span> type<span class="token operator">=</span><span class="token string">"submit"</span><span class="token operator">&gt;</span>搜索<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
</code></pre> 
<h3><a id="27_1121"></a>2.7、账号设置</h3> 
<p><img src="https://images2.imgbox.com/0e/fb/RPiPqWnb_o.png" alt="在这里插入图片描述"></p> 
<p>上传文件-这里不需要数据访问层的代码，上传文件的话只需要在表现层实现就可以</p> 
<ul><li>请求:必须是POST请求</li><li>表单:enctype=”multipart/form-data”</li><li>Spring MVC：通过MultipartFile处理上传文件 MultipartFile：表现层的对象，不应该放到业务层来处理，这会带来较高的耦合度。业务层值只负责更新路径即可</li></ul> 
<p>配置文件：上传的头像图片的保存路径</p> 
<pre><code class="prism language-java">community<span class="token punctuation">.</span>path<span class="token punctuation">.</span>upload<span class="token operator">=</span>d<span class="token operator">:</span><span class="token operator">/</span>project<span class="token operator">/</span>upload
</code></pre> 
<h4><a id="1service_1138"></a>（1）service层</h4> 
<p>UserService.java</p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">updateHeader</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> headerUrl<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> userMapper<span class="token punctuation">.</span><span class="token function">updateHeader</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> headerUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="2Controller_1148"></a>（2）Controller层</h4> 
<p>UserController：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Controller</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/user"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">UserController</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${community.path.upload}"</span><span class="token punctuation">)</span><span class="token comment">//上传路径</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> uploadPath<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${community.path.domain}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> domain<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${server.servlet.context-path}"</span><span class="token punctuation">)</span><span class="token comment">//项目访问路径</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> contextPath<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">HostHolder</span> hostHolder<span class="token punctuation">;</span><span class="token comment">//从hostHolder里取当前用户</span>

    <span class="token annotation punctuation">@LoginRequired</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">"/setting"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getSettingPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"/site/setting"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@LoginRequired</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">"/upload"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>POST<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">uploadHeader</span><span class="token punctuation">(</span><span class="token class-name">MultipartFile</span> headerImage<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>headerImage <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token string">"您还没有选择图片!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">"/site/setting"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		
        <span class="token class-name">String</span> fileName <span class="token operator">=</span> headerImage<span class="token punctuation">.</span><span class="token function">getOriginalFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> suffix <span class="token operator">=</span> fileName<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>fileName<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读取文件的后缀</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>suffix<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token string">"文件的格式不正确!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">"/site/setting"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 生成随机文件名</span>
        fileName <span class="token operator">=</span> <span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">generateUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> suffix<span class="token punctuation">;</span>
        <span class="token comment">// 确定文件存放的路径</span>
        <span class="token class-name">File</span> dest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>uploadPath <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 存储文件</span>
            headerImage<span class="token punctuation">.</span><span class="token function">transferTo</span><span class="token punctuation">(</span>dest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"上传文件失败: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"上传文件失败,服务器发生异常!"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 更新当前用户的头像的路径(web访问路径)</span>
        <span class="token comment">// http://localhost:8080/community/user/header/xxx.png</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> headerUrl <span class="token operator">=</span> domain <span class="token operator">+</span> contextPath <span class="token operator">+</span> <span class="token string">"/user/header/"</span> <span class="token operator">+</span> fileName<span class="token punctuation">;</span>
        userService<span class="token punctuation">.</span><span class="token function">updateHeader</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> headerUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token string">"redirect:/index"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	
    <span class="token comment">//获取头像</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">"/header/{fileName}"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"fileName"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> fileName<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 服务器存放路径</span>
        fileName <span class="token operator">=</span> uploadPath <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> fileName<span class="token punctuation">;</span>
        <span class="token comment">// 文件后缀</span>
        <span class="token class-name">String</span> suffix <span class="token operator">=</span> fileName<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>fileName<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 响应图片</span>
        response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">"image/"</span> <span class="token operator">+</span> suffix<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span>
                <span class="token class-name">FileInputStream</span> fis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//输入流</span>
                <span class="token class-name">OutputStream</span> os <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>b <span class="token operator">=</span> fis<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                os<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"读取头像失败: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p><font color="red">hostHolder到底什么时候清除数据？？？</font>整个网页都关掉的时候？所有路径的请求都要被拦截！！！</p> 
<h3><a id="28_1244"></a>2.8、检查登录状态（自定义注解）</h3> 
<p><img src="https://images2.imgbox.com/9d/5e/MKjwmDAl_o.png" alt="在这里插入图片描述"></p> 
<p>自定义注解：LoginRequired.java</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>nowcoder<span class="token punctuation">.</span>community<span class="token punctuation">.</span>annotation</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">ElementType</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Retention</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Target</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>METHOD<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">LoginRequired</span> <span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span>
</code></pre> 
<p>给UserService.java中需要被拦截的方法加上自定义注释：</p> 
<p><img src="https://images2.imgbox.com/a9/ef/KeAz653G_o.png" alt="在这里插入图片描述"></p> 
<p>LoginRequiredInterceptor.java:</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginRequiredInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">HostHolder</span> hostHolder<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//先判断拦截的是不是方法</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token keyword">instanceof</span> <span class="token class-name">HandlerMethod</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">HandlerMethod</span> handlerMethod <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HandlerMethod</span><span class="token punctuation">)</span> handler<span class="token punctuation">;</span><span class="token comment">//转型</span>
            <span class="token class-name">Method</span> method <span class="token operator">=</span> handlerMethod<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//反射：获取拦截到的对象</span>
            <span class="token comment">//获取方法的注解</span>
            <span class="token class-name">LoginRequired</span> loginRequired <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">LoginRequired</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//如果不等于空，说明这个方法是需要拦截的，如果没登录就要被拦截</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>loginRequired <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//重定向</span>
                response<span class="token punctuation">.</span><span class="token function">sendRedirect</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getContextPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"/login"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>配置拦截器：WebMvcConfigurer</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/698f7f9650079889c1b67e554ac5441c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">为什么有人劝别选计算机专业?</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/eedac4fa94618ce3d78d1e39153b76e3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【踩坑】使用libbpfgo构建你的第一个eBPF项目</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>