<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>华为eNSP配置专题-IPSec的配置 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="华为eNSP配置专题-IPSec的配置" />
<meta property="og:description" content="文章目录 华为eNSP配置专题-IPSec的配置0、概要介绍1、前置环境1.1、宿主机1.2、eNSP模拟器 2、基本环境搭建2.1、终端构成和连接2.2、终端的基本配置 3、IPSec的配置3.1、通过ACL定义需要保护的数据流3.2、配置IPSec安全提议3.3、配置IPSec手动方式安全策略3.3.1、在R1上配置3.3.1、在R2（分公司出口路由）上配置 3.4、在接口上应用IPSec策略3.5、更改接口NAT策略3.6、IPSec配置方式二：自动配置 华为eNSP配置专题-IPSec的配置 0、概要介绍 IPSec（Internet Protocol Security）：是一组基于网络层的，应用密码学的安全通信协议族。IPSec不是具体指哪个协议，而是一个开放的协议族。IPSec协议的设计目标：是在IPV4和IPV6环境中为网络层流量提供灵活的安全服务。IPSec VPN：是基于IPSec协议族构建的在IP层实现的安全虚拟专用网。通过在数据包中插入一个预定义头部的方式，来保障OSI上层协议数据的安全，主要用于保护TCP、UDP、ICMP和隧道的IP数据包。IPSec架构如下，IKE相当于FTP的21端口，用来SA协商建立IPSec通道。
1、前置环境 1.1、宿主机 笔记本电脑，配置如下：Windows10企业版，32GB内存
1.2、eNSP模拟器 eNSP1.3.00
2、基本环境搭建 2.1、终端构成和连接 0、总体拓扑如下：
1、2台PC，1台代表总部，1台代表分公司。
2、3台路由器，1台为总部的出口路由器，1台为分公司的出口路由器，1台为电信服务商的ISP。
3、启动设备。
2.2、终端的基本配置 1、PC1配置静态IP如下：
2、R1出口路由器配置接口地址、默认路由和NAT
&lt;Huawei&gt;system-view [Huawei]undo info-center enable [Huawei]sysname R1 [R1]int g0/0/0 [R1-GigabitEthernet0/0/0]ip add 192.168.10.254 24 [R1-GigabitEthernet0/0/0]quit [R1]int g0/0/1 [R1-GigabitEthernet0/0/1]ip add 100.1.1.1 30 [R1-GigabitEthernet0/0/1]quit [R1]ip route-static 0.0.0.0 0 100.1.1.2 [R1]acl 2000 [R1-acl-basic-2000]rule 10 permit source 192.168.10.0 0.0.0.255 [R1-acl-basic-2000]quit [R1]int g0/0/1 [R1-GigabitEthernet0/0/1]nat outbound 2000 3、ISP配置接口地址和环回口地址：
&lt;Huawei&gt;system-view [Huawei]undo info-center enable [Huawei]sysname ISP [ISP]int g0/0/0 [ISP-GigabitEthernet0/0/0]ip add 100." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/69e2881ce90425d7d881bfd96042543f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-10-26T16:25:58+08:00" />
<meta property="article:modified_time" content="2023-10-26T16:25:58+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">华为eNSP配置专题-IPSec的配置</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#eNSPIPSec_1" rel="nofollow">华为eNSP配置专题-IPSec的配置</a></li><li><ul><li><a href="#0_3" rel="nofollow">0、概要介绍</a></li><li><a href="#1_10" rel="nofollow">1、前置环境</a></li><li><ul><li><a href="#11_12" rel="nofollow">1.1、宿主机</a></li><li><a href="#12eNSP_17" rel="nofollow">1.2、eNSP模拟器</a></li></ul> 
   </li><li><a href="#2_22" rel="nofollow">2、基本环境搭建</a></li><li><ul><li><a href="#21_24" rel="nofollow">2.1、终端构成和连接</a></li><li><a href="#22_33" rel="nofollow">2.2、终端的基本配置</a></li></ul> 
   </li><li><a href="#3IPSec_98" rel="nofollow">3、IPSec的配置</a></li><li><ul><li><a href="#31ACL_103" rel="nofollow">3.1、通过ACL定义需要保护的数据流</a></li><li><a href="#32IPSec_117" rel="nofollow">3.2、配置IPSec安全提议</a></li><li><a href="#33IPSec_159" rel="nofollow">3.3、配置IPSec手动方式安全策略</a></li><li><ul><li><a href="#331R1_161" rel="nofollow">3.3.1、在R1上配置</a></li><li><a href="#331R2_208" rel="nofollow">3.3.1、在R2（分公司出口路由）上配置</a></li></ul> 
    </li><li><a href="#34IPSec_223" rel="nofollow">3.4、在接口上应用IPSec策略</a></li><li><a href="#35NAT_239" rel="nofollow">3.5、更改接口NAT策略</a></li><li><a href="#36IPSec_278" rel="nofollow">3.6、IPSec配置方式二：自动配置</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="eNSPIPSec_1"></a>华为eNSP配置专题-IPSec的配置</h2> 
<h3><a id="0_3"></a>0、概要介绍</h3> 
<ol><li>IPSec（Internet Protocol Security）：是一组基于网络层的，应用密码学的安全通信协议族。IPSec不是具体指哪个协议，而是一个开放的协议族。IPSec协议的设计目标：是在IPV4和IPV6环境中为网络层流量提供灵活的安全服务。</li><li>IPSec VPN：是基于IPSec协议族构建的在IP层实现的安全虚拟专用网。通过在数据包中插入一个预定义头部的方式，来保障OSI上层协议数据的安全，主要用于保护TCP、UDP、ICMP和隧道的IP数据包。</li><li>IPSec架构如下，IKE相当于FTP的21端口，用来SA协商建立IPSec通道。<br> <img src="https://images2.imgbox.com/a1/4c/SVDRTSbn_o.png" alt=""></li></ol> 
<h3><a id="1_10"></a>1、前置环境</h3> 
<h4><a id="11_12"></a>1.1、宿主机</h4> 
<p>笔记本电脑，配置如下：Windows10企业版，32GB内存<br> <img src="https://images2.imgbox.com/68/e3/z7K1hSX4_o.png" alt=""></p> 
<h4><a id="12eNSP_17"></a>1.2、eNSP模拟器</h4> 
<p>eNSP1.3.00<br> <img src="https://images2.imgbox.com/46/8c/yUUkn5A4_o.png" alt=""></p> 
<h3><a id="2_22"></a>2、基本环境搭建</h3> 
<h4><a id="21_24"></a>2.1、终端构成和连接</h4> 
<p>0、总体拓扑如下：<br> <img src="https://images2.imgbox.com/d5/95/YihshqJc_o.png" alt=""><br> 1、2台PC，1台代表总部，1台代表分公司。<br> 2、3台路由器，1台为总部的出口路由器，1台为分公司的出口路由器，1台为电信服务商的ISP。<br> 3、启动设备。</p> 
<h4><a id="22_33"></a>2.2、终端的基本配置</h4> 
<p>1、PC1配置静态IP如下：<br> <img src="https://images2.imgbox.com/61/e3/dmR6Fi0h_o.png" alt=""></p> 
<p>2、R1出口路由器配置接口地址、默认路由和NAT</p> 
<pre><code>&lt;Huawei&gt;system-view 
[Huawei]undo info-center enable
[Huawei]sysname R1
[R1]int g0/0/0
[R1-GigabitEthernet0/0/0]ip add 192.168.10.254 24
[R1-GigabitEthernet0/0/0]quit
[R1]int g0/0/1
[R1-GigabitEthernet0/0/1]ip add 100.1.1.1 30
[R1-GigabitEthernet0/0/1]quit
[R1]ip route-static 0.0.0.0 0 100.1.1.2
[R1]acl 2000
[R1-acl-basic-2000]rule 10 permit source 192.168.10.0 0.0.0.255
[R1-acl-basic-2000]quit
[R1]int g0/0/1
[R1-GigabitEthernet0/0/1]nat outbound 2000
</code></pre> 
<p>3、ISP配置接口地址和环回口地址：</p> 
<pre><code>&lt;Huawei&gt;system-view 
[Huawei]undo info-center enable
[Huawei]sysname ISP
[ISP]int g0/0/0
[ISP-GigabitEthernet0/0/0]ip add 100.1.1.2 30
[ISP-GigabitEthernet0/0/0]int g0/0/1
[ISP-GigabitEthernet0/0/1]ip add 200.1.1.2 30
[ISP-GigabitEthernet0/0/1]int loopback 0
[ISP-LoopBack0]ip add 2.2.2.2 32
[ISP-LoopBack0]quit
</code></pre> 
<p>4、这时在PC1上pingISP的地址和环回口，发现都可以通了。</p> 
<p>5、同理，在PC2、R2上做类似配置。首先在PC2上配置静态IP<br> <img src="https://images2.imgbox.com/33/a6/bsLlRt8I_o.png" alt=""></p> 
<p>6、然后在R2上配置接口地址、默认路由和NAT：</p> 
<pre><code>&lt;Huawei&gt;system-view 
[Huawei]undo info-center enable
[Huawei]sysname R2
[R2]int g0/0/0
[R2-GigabitEthernet0/0/0]ip add 192.168.20.254 24
[R2-GigabitEthernet0/0/0]int g0/0/1
[R2-GigabitEthernet0/0/1]ip add 200.1.1.1 30
[R2-GigabitEthernet0/0/1]quit
[R2]ip route-static 0.0.0.0 0 200.1.1.2
[R2]acl 2000
[R2-acl-basic-2000]rule 10 permit source 192.168.20.0 0.0.0.255
[R2-acl-basic-2000]quit
[R2]int g0/0/1
[R2-GigabitEthernet0/0/1]nat outbound 2000
</code></pre> 
<p>7、这时在PC2上pingISP的地址和环回口，发现都可以通了。但PC1和PC2之间并不互通。</p> 
<p>8、这时就完成了一个简单的一个公司含一个总部和一个分公司的基本网络的搭建，总部和分公司都可以访问互联网，但内网机器之间并不能互通。</p> 
<h3><a id="3IPSec_98"></a>3、IPSec的配置</h3> 
<p>IPSec的手工配置步骤如下：<br> <img src="https://images2.imgbox.com/04/90/1w61MRfz_o.png" alt=""></p> 
<h4><a id="31ACL_103"></a>3.1、通过ACL定义需要保护的数据流</h4> 
<p>1、在R1上做如下配置：</p> 
<pre><code>[R1]acl 3000
[R1-acl-adv-3000]rule 10 permit ip source 192.168.10.0 0.0.0.255 destination 192.168.20.0 0.0.0.255
</code></pre> 
<p>2、在R2上做类似配置，但源和目的正好和R1的配置相反：</p> 
<pre><code>[R2]acl 3000
[R2-acl-adv-3000]rule 10 permit ip source 192.168.20.0 0.0.0.255 destination 192.168.10.0 0.0.0.255
</code></pre> 
<h4><a id="32IPSec_117"></a>3.2、配置IPSec安全提议</h4> 
<p>1、先配置总部的R1：ipsec提议名称为zb（代表总部），认证算法采用MD5，加密算法使用des。这里的认证是认证数据有没有被篡改。</p> 
<pre><code>[R1]ipsec proposal zb
[R1-ipsec-proposal-zb]esp authentication-algorithm ?
  md5       Use HMAC-MD5-96 algorithm
  sha1      Use HMAC-SHA1-96 algorithm
  sha2-256  Use SHA2-256 algorithm
  sha2-384  Use SHA2-384 algorithm
  sha2-512  Use SHA2-512 algorithm
  sm3       Use SM3 algorithm
[R1-ipsec-proposal-zb]esp authentication-algorithm md5
[R1-ipsec-proposal-zb]esp encryption-algorithm ?
  3des     Use 3DES
  aes-128  Use AES-128
  aes-192  Use AES-192
  aes-256  Use AES-256
  des      Use DES
  sm1      Use SM1
  &lt;cr&gt;     Please press ENTER to execute command 
[R1-ipsec-proposal-zb]esp encryption-algorithm des
</code></pre> 
<p>2、可以通过<code>display ipsec proposal</code>来查看IPSec配置情况：</p> 
<pre><code>[R1]display ipsec proposal
Number of proposals: 1
IPSec proposal name: zb                            
 Encapsulation mode: Tunnel                            
 Transform         : esp-new
 ESP protocol      : Authentication MD5-HMAC-96                             
                     Encryption     DES
</code></pre> 
<p>3、再配置分公司的R2：ipsec提议名称为bj（代表北京），认证算法采用MD5，加密算法使用des。这里的认证是认证数据有没有被篡改。</p> 
<pre><code>[R2]ipsec proposal bj
[R2-ipsec-proposal-bj]esp authentication-algorithm md5
[R2-ipsec-proposal-bj]esp encryption-algorithm des
</code></pre> 
<h4><a id="33IPSec_159"></a>3.3、配置IPSec手动方式安全策略</h4> 
<h5><a id="331R1_161"></a>3.3.1、在R1上配置</h5> 
<p>1、配置IPSEC策略zongbu，方式为手动</p> 
<pre><code>ipsec policy zongbu 10 manual
</code></pre> 
<p>2、保护ACL3000的流量</p> 
<pre><code>security acl 3000
</code></pre> 
<p>3、采用IPSec提议zb</p> 
<pre><code>proposal zb
</code></pre> 
<p>4、配置隧道本地地址100.1.1.1</p> 
<pre><code>tunnel local 100.1.1.1
</code></pre> 
<p>5、配置隧道远端地址200.1.1.1</p> 
<pre><code>tunnel remote 200.1.1.1
</code></pre> 
<p>6、配置入方向SA编号54321</p> 
<pre><code>sa spi inbound esp 54321
</code></pre> 
<p>7、配置入方向SA的认证秘钥为summer</p> 
<pre><code>sa string-key inbound esp cipher summer
</code></pre> 
<p>8、配置出方向SA编号12345</p> 
<pre><code>sa spi outbound esp 12345
</code></pre> 
<p>9、配置出方向sa的认证密钥为summer</p> 
<pre><code>sa string-key outbound esp cipher summer
</code></pre> 
<h5><a id="331R2_208"></a>3.3.1、在R2（分公司出口路由）上配置</h5> 
<p>1、在R2上做类似配置。注意这里的inbound和outbound的esp编号正好要反过来，在R1上的inbound为54321，正好对应R2上的outbound。在R1上的outbound为12345，正好对应R2上的inbound。注意，这里非常重要。</p> 
<pre><code>ipsec policy beijing 10 manual
security acl 3000
proposal bj
tunnel local 200.1.1.1
tunnel remote 100.1.1.1
sa spi inbound esp 12345
sa string-key inbound esp cipher summer
sa spi outbound esp 54321
sa string-key outbound esp cipher summer
</code></pre> 
<h4><a id="34IPSec_223"></a>3.4、在接口上应用IPSec策略</h4> 
<p>1、在R1上应用已配置的IPSec策略zongbu</p> 
<pre><code>[R1]int g0/0/1
[R1-GigabitEthernet0/0/1]ipsec policy zongbu
[R1-GigabitEthernet0/0/1]quit
</code></pre> 
<p>2、在R2上应用已配置的IPSec策略beijing</p> 
<pre><code>[R2]int g0/0/1
[R2-GigabitEthernet0/0/1]ipsec policy beijing
[R2-GigabitEthernet0/0/1]quit
</code></pre> 
<h4><a id="35NAT_239"></a>3.5、更改接口NAT策略</h4> 
<p>1、这样配置完成后，PC1和PC2并没内互通。原因在于R1和R2上有NAT，会基于ACL2000将192.168.10网段转换成100.1.1.1的地址，这样IPSec隧道里的配置就用不上了（因为是acl 3000里配的还是192.168.10和192.168.20网段）</p> 
<p>2、在R1上先删除已有的NAT配置和ACL配置</p> 
<pre><code>[R1]int g0/0/1
[R1-GigabitEthernet0/0/1]undo nat outbound 2000
[R1-GigabitEthernet0/0/1]quit
[R1]undo acl 2000
</code></pre> 
<p>3、在R1上创建一个新的ACL 3001，针对从20网段到10网段的流量不做NAT，其他的情况下都做。然后在端口上启用easyIP</p> 
<pre><code>[R1]acl 3001
[R1-acl-adv-3001]rule 10 deny ip source 192.168.10.0 0.0.0.255 destination 192.168.20.0 0.0.0.255
[R1-acl-adv-3001]rule 20 permit ip
[R1-acl-adv-3001]quit
[R1]int g0/0/1
[R1-GigabitEthernet0/0/1]nat outbound 3001
</code></pre> 
<p>4、以上操作在R2上重复类似操作：</p> 
<pre><code>[R2]int g0/0/1
[R2-GigabitEthernet0/0/1]undo nat outbound 2000
[R2-GigabitEthernet0/0/1]quit
[R2]undo acl 2000
[R2]acl 3001
[R2-acl-adv-3001]rule 10 deny ip source 192.168.20.0 0.0.0.255 destination 192.168.10.0 0.0.0.255
[R2-acl-adv-3001]rule 20 permit ip
[R2-acl-adv-3001]quit
[R2]int g0/0/1
[R2-GigabitEthernet0/0/1]nat outbound 3001
[R2-GigabitEthernet0/0/1]quit
</code></pre> 
<p>5、这时就完成IPSec的配置了，PC1和PC2已经互通。</p> 
<h4><a id="36IPSec_278"></a>3.6、IPSec配置方式二：自动配置</h4> 
<p>自动配置会比手动配置多两个步骤，主要是配置IKE，配置IKE的过程相当于建立控制信道的过程，步骤如下图所示：<br> <img src="https://images2.imgbox.com/bd/da/jB40Fqr9_o.png" alt=""></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/53a525e3f88e512c41156c7306496a7d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">计算机中无符号整数和有符号整数</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2b56bbeaf95a68256c488c7e23734551/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">1024 程序员节引爆星城，180&#43; 位大咖谈 AIGC、开源，开启未来编程范式！</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>