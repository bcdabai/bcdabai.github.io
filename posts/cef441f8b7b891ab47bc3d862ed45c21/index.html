<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>kubeadm安装kubernetes集群（master非高可用） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="kubeadm安装kubernetes集群（master非高可用）" />
<meta property="og:description" content="可以考虑通过ansible实现k8s的安装，通过ansible的角色复用减轻后续工作！！
操作系统：Centos 7
第一步：kubelet不支持交换分区，需要将交换分区关掉
临时关闭：swapoff -a
永久关闭：vim fstab，将swap那行挂载去掉
第二步：关闭防火墙和SELinux，安全做法开防火墙上边的白名单端口。
但生产环境一般按照网络区域设置防火墙而不是主机层面，所以建议关掉
1、systemctl disable --now firewalld.service
2、vim /etc/selinux/config
将SELINUX禁用，可通过getenforce查看selinux状态
第三步：配置时间同步服务
建议通过chrony来配置成同一台时间同步服务器实现
第四步、配置yum源
1、http://mirrors.aliyun.com/repo/Centos-7.repo
2、http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
3、kukenetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
master节点安装docker、dockercri、kubeadm、kubectl、kubelet
node节点上安装docker、docker-cri、kubeadm、kubelet
docker-cri的安装会比较难，被墙了
wget https://github.com/Mirantis/cri-dockerd/releases/download/v0.2.6/cri-dockerd-0.2.6-3.el7.x86_64.rpm
yum -y install cri-dockerd-0.2.6-3.el7.x86_64.rpm
systemctl enabled --now docker.service kubelet.service
第五步：配置docker-ce的镜像仓库为国内的开源镜像仓库，docker官方镜像仓库网速较差，我们需要设置国内镜像服务
/etc/docker/daemon.json
{
“registry-mirrors”: [“https://p1xjy9ro.mirror.aliyuncs.com”]
}
注意：需要重启docker服务生效
sudo systemctl daemon-reload
sudo systemctl restart docker
第六步：配置主机名
hostnamectl set-hostname k8s-master01
并配置相应的映射关系/etc/hosts
第七步：master节点上初始化kubernetes集群
kubeadm --v=6 init --kubernetes-version=v1.25.0 --image-repository registry." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/cef441f8b7b891ab47bc3d862ed45c21/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-16T16:55:54+08:00" />
<meta property="article:modified_time" content="2023-05-16T16:55:54+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">kubeadm安装kubernetes集群（master非高可用）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>可以考虑通过ansible实现k8s的安装，通过ansible的角色复用减轻后续工作！！</p> 
<p>操作系统：Centos 7</p> 
<p>第一步：kubelet不支持交换分区，需要将交换分区关掉<br> 临时关闭：swapoff -a<br> 永久关闭：vim fstab，将swap那行挂载去掉</p> 
<p>第二步：关闭防火墙和SELinux，安全做法开防火墙上边的白名单端口。<br> 但生产环境一般按照网络区域设置防火墙而不是主机层面，所以建议关掉<br> 1、systemctl disable --now firewalld.service<br> 2、vim /etc/selinux/config<br> 将SELINUX禁用，可通过getenforce查看selinux状态</p> 
<p>第三步：配置时间同步服务<br> 建议通过chrony来配置成同一台时间同步服务器实现</p> 
<p>第四步、配置yum源<br> 1、http://mirrors.aliyun.com/repo/Centos-7.repo<br> 2、http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo<br> 3、kukenetes.repo<br> [kubernetes]<br> name=Kubernetes<br> baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/<br> enabled=1<br> gpgcheck=0<br> repo_gpgcheck=0<br> gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</p> 
<p>master节点安装docker、dockercri、kubeadm、kubectl、kubelet<br> node节点上安装docker、docker-cri、kubeadm、kubelet</p> 
<p>docker-cri的安装会比较难，被墙了<br> wget https://github.com/Mirantis/cri-dockerd/releases/download/v0.2.6/cri-dockerd-0.2.6-3.el7.x86_64.rpm<br> yum -y install cri-dockerd-0.2.6-3.el7.x86_64.rpm</p> 
<p>systemctl enabled --now docker.service kubelet.service</p> 
<p>第五步：配置docker-ce的镜像仓库为国内的开源镜像仓库，docker官方镜像仓库网速较差，我们需要设置国内镜像服务<br> /etc/docker/daemon.json<br> {<!-- --><br> “registry-mirrors”: [“https://p1xjy9ro.mirror.aliyuncs.com”]<br> }<br> 注意：需要重启docker服务生效<br> sudo systemctl daemon-reload<br> sudo systemctl restart docker</p> 
<p>第六步：配置主机名<br> hostnamectl set-hostname k8s-master01<br> 并配置相应的映射关系/etc/hosts</p> 
<p>第七步：master节点上初始化kubernetes集群<br> kubeadm --v=6 init --kubernetes-version=v1.25.0 --image-repository registry.aliyuncs.com/google_containers --cri-socket unix:///var/run/cri-dockerd.sock<br> 或者<br> kubeadm --v=6 init --config=init-defaults.yaml</p> 
<h2><a id="kubernetes_61"></a>清理初始化失败的kubernetes集群</h2> 
<p>kubeadm reset --cri-socket unix:///var/run/cri-dockerd.sock</p> 
<p>第八步：安装网络插件<br> #安装网络插件（注意要过一会才会成功，可以看看pod创建成功没有还有就是镜像拉取是否正常）<br> kubectl apply -f “https://docs.projectcalico.org/manifests/calico.yaml”</p> 
<p>第九步：配置访问<br> mkdir -p $HOME/.kube<br> sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config<br> sudo chown <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         i 
        
       
         d 
        
       
         − 
        
       
         u 
        
       
         ) 
        
       
         : 
        
       
      
        (id -u): 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">u</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">:</span></span></span></span></span>(id -g) $HOME/.kube/config</p> 
<p>第十步：将新的node纳入集群<br> kubeadm token create --print-join-command</p> 
<p>常见错误：<br> 一、Oct 08 20:31:27 k8s-master01 kubelet[3189]: E1008 20:31:27.600468 3189 run.go:74] “command failed” err=“failed to load kubelet config file, error: failed to load Kubelet config file /var/lib/kubelet/config.yaml, error failed to read kubelet config file “/var/lib/kubelet/config.yaml”, error: open /var/lib/kubelet/config.yaml: no such file or directory, path: /var/lib/kubelet/config.yaml”<br> 解决办法：执行kubeadm init就会生成相应的配置文件</p> 
<p>二、Found multiple CRI endpoints on the host. Please define which one do you wish to use by setting the ‘criSocket’ field in the kubeadm configuration file: unix:///var/run/containerd/containerd.sock, unix:///var/run/cri-dockerd.sock<br> To see the stack trace of this error execute with --v=5 or higher<br> 解决办法：加选项指定使用的CRI</p> 
<p>三、Error getting node" err=“node “k8s-master01” not found”<br> 解决办法：这种情况是apiserver-advertise-address地址有误<br> kubeadm config print init-defaults &gt; kubenetes-init-config<br> vim kubenetes-init-config</p> 
<p>四、failed pulling image "registry.k8s.io/pause:3.6<br> cri-docker会去拉pause镜像，因为镜像库原因可能拉不成功，我们需要在cri-docker.service文件中配置相应的镜像地址<br> 注意：–network-plugin=留空，不要和网上傻不拉几的去填cni。网络的等集群创建好在配置<br> sed -ie ‘s#ExecStart=.*#ExecStart=/usr/bin/cri-dockerd --network-plugin= --pod-infra-container-image=registry.aliyuncs.com/google_containers/pause:3.8#g’ /usr/lib/systemd/system/cri-docker.service</p> 
<p>github提供的镜像加速，下载github东西用这个前缀可以<br> https://ghproxy.com/</p> 
<p>后续需要考虑高可用，就是多个master的情况。<br> 还有就是定期的备份处理！！！</p> 
<p>新增计算节点：<br> 注：采用Docker Engine作为底层容器运行时<br> 1、在你的每个节点上，遵循安装 Docker Engine 指南为你的 Linux 发行版安装 Docker。<br> 2、按照源代码仓库中的说明安装 cri-dockerd。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/745584586ebfb3b09d656f36284d9867/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">医疗器械安规三项是什么？1、漏电流测试 IEC60950-1 2、电介质强度测试=耐压测试？GB9706 3、保护接地电阻测试=保护接地 ？GB9706</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/439e66a47d7962dc766cbdf9d3db7476/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Java Date 对象详解</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>