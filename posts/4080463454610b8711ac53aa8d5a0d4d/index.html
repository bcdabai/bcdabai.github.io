<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Halcon ：Blob分析之Check_blister胶囊检测 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Halcon ：Blob分析之Check_blister胶囊检测" />
<meta property="og:description" content="* This example demonstrates an application from the pharmaceutical industry.
* The task is to check the content of automatically filled blisters.
* The first image (reference) is used to locate the chambers within a blister shape as a reference model, which is then used to realign the subsequent images along to this reference shape. Using
blob analysis the content of each chamber is segmented and finally classified by a few shape features." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/4080463454610b8711ac53aa8d5a0d4d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-02-09T13:15:03+08:00" />
<meta property="article:modified_time" content="2022-02-09T13:15:03+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Halcon ：Blob分析之Check_blister胶囊检测</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p><span style="color:#1c7331;">* This example demonstrates an application from the pharmaceutical industry.<br> * The task is to check the content of automatically filled blisters.<br> * The first image (reference) is used to locate the chambers within a blister shape as a reference model, which is then used to realign the subsequent images along to this reference shape. Using<br> blob analysis the content of each chamber is segmented and finally classified by a few shape features.<br> * 使用blob分析，每个腔室的内容被分割并最终通过一些形状特征进行分类。</span></p> 
<p><strong><span style="color:#fe2c24;">*1）采集图像</span></strong><br> dev_close_window ()<br> dev_update_off ()<br><span style="color:#1a439c;">read_image (ImageOrig, 'blister/blister_reference')<br> dev_open_window_fit_image (ImageOrig, 0, 0, -1, -1, WindowHandle) </span><span style="color:#4da8ee;">*打开具有给定最小和最大范围的新图形窗口，以便保留给定图像大小的宽高比</span><br><span style="color:#1a439c;">set_display_font (WindowHandle, 14, 'mono', 'true', 'false')</span><br> dev_set_draw ('margin')<br> dev_set_line_width (3)<br>  </p> 
<p><strong><span style="color:#fe2c24;">* 2）定位（求标准位置，blob）</span></strong><br><span style="color:#1c7331;">* In the first step, we create a pattern to cut out the chambers in the<br> * subsequent blister images easily.</span><br> access_channel (ImageOrig, Image1, 1) <span style="color:#4da8ee;">*获得一个灰度图像（第一个通道 的图像）</span><br> threshold (Image1, Region, 90, 255)<br> shape_trans (Region, Blister, 'convex')<br> orientation_region (Blister, Phi) <span style="color:#4da8ee;">*orientation_region计算区域的方向，这个算子是基于elliptic_axis 算子来的，elliptic_axis 是求取等效的椭圆，所以用算子orientation_region相当于把区域Blister转化为一个等效椭圆，计算这个椭圆的长轴在图像中的角度</span><span style="color:#fe2c24;">Phi</span><span style="color:#4da8ee;">。</span><br> area_center (Blister, Area1, Row, Column)<br> vector_angle_to_rigid (Row, Column, Phi, Row, Column, 0, HomMat2D)<span style="color:#4da8ee;">#根据点对应关系和两个对应角度计算刚性仿射变换，即由旋转和平移组成的仿射变换</span><br> affine_trans_image (ImageOrig, Image2, HomMat2D, 'constant', 'false')<span style="color:#4da8ee;">*affine_trans_image - 对图像进行任意的2D仿射变换。ImageOrig：要进行仿射变换的图像；Image2：仿射变换之后的图像；HomMat2D：2D仿射变换矩阵；constant：进行仿射变换的方式，这个代表使用均值滤波器来防止混叠效应的发生。false：仿射变换后的图片超出现有图片大小的区域不被剪切掉；若为true则相反。</span><br> gen_empty_obj (Chambers)<span style="color:#4da8ee;">*生成一个空的对象Chambers，类似于list.append()</span></p> 
<p><span style="color:#fe2c24;">*画区域方块</span><br> for I := 0 to 4 by 1<br>     Row := 88 + I * 70<br>     for J := 0 to 2 by 1<br>         Column := 163 + J * 150<br>         gen_rectangle2 (Rectangle, Row, Column, 0, 64, 30)<span style="color:#4da8ee;">*生成一个可旋转的矩形； * * 前两个参数是区域中心坐标，第三个参数是矩形角度，后两个参数是矩形的宽高。</span><br>         concat_obj (Chambers, Rectangle, Chambers)<span style="color:#4da8ee;">*concat_obj (Chambers, Rectangle, Chambers) * concat_obj - 把两个对象融合在一起。 注意，这 个和union不一样，union是把两个对象整合成一个对象，整合后对象的元素个数为1； 而使用concat_obj 是把几个对象联合成一个对象，这个对象中的元素个数之和不变。</span><br>     endfor<br> endfor</p> 
<p><img alt="" height="451" src="https://images2.imgbox.com/68/70/XTzxgLlt_o.png" width="603">affine_trans_region (Blister, Blister, HomMat2D, 'nearest_neighbor')<span style="color:#4da8ee;">*使用变换矩阵HomMat2D对Blister区域使用nearest_neighbor方法进行</span><span style="color:#fe2c24;">仿射变换</span><span style="color:#4da8ee;">,这里的Blister是仿射变换后的Blister。</span><br> difference (Blister, Chambers, Pattern)<span style="color:#4da8ee;">*求取区域Blister与区域Chambers的差集</span></p> 
<p style="text-align:center;"><img alt="" height="459" src="https://images2.imgbox.com/e1/35/GewPWTri_o.png" width="605"></p> 
<p>union1 (Chambers, ChambersUnion)<span style="color:#fe2c24;">*将区域Chambers（有多个元素）联合成一个区域（一个元素）</span><br> orientation_region (Blister, PhiRef)<br> PhiRef := rad(180) + PhiRef<br> area_center (Blister, Area2, RowRef, ColumnRef)<br> * <br> * <br><span style="color:#1c7331;">* Each image read will be aligned to this pattern and reduced to the area of interest,<br> * which is the chambers of the blister</span></p> 
<p><span style="color:#fe2c24;">循环检测每一张图片</span><br> Count := 6<br> for Index := 1 to Count by 1<br>     read_image (Image, 'blister/blister_' + Index$'02')<br>     threshold (Image, Region, 90, 255)<br>     connection (Region, ConnectedRegions)<br>     select_shape (ConnectedRegions, SelectedRegions, 'area', 'and', 5000, 9999999)<br>     shape_trans (SelectedRegions, RegionTrans, 'convex')<br>     * <br>    <span style="color:#1c7331;"> * Align pattern along blister of image</span><br>     orientation_region (RegionTrans, Phi)<br>     area_center (RegionTrans, Area3, Row, Column)<br>     vector_angle_to_rigid (Row, Column, Phi, RowRef, ColumnRef, PhiRef, HomMat2D)<br>     affine_trans_image (Image, ImageAffineTrans, HomMat2D, 'constant', 'false')<br>     * <br><span style="color:#1c7331;">    * Segment pills</span><br>     reduce_domain (ImageAffineTrans, ChambersUnion, ImageReduced)<span style="color:#4da8ee;">*使用区域剪切图片，缩小图像处理定义域</span><br>     decompose3 (ImageReduced, ImageR, ImageG, ImageB)<span style="color:#4da8ee;">*将图片ImageReduced分成R/G/B三通道图像</span><br>     var_threshold (ImageB, Region, 7, 7, 0.2, 2, 'dark')<span style="color:#4da8ee;">*通过局部均值和标准差分析对图像进行阈值处理</span><br>     connection (Region, ConnectedRegions0)<br>     closing_rectangle1 (ConnectedRegions0, ConnectedRegions, 3, 3)<span style="color:#4da8ee;">*闭运算能够填平小湖(即小孔)，弥合小裂缝，而总的位置和形状不变。</span><br>     fill_up (ConnectedRegions, RegionFillUp)<br>     select_shape (RegionFillUp, SelectedRegions, 'area', 'and', 1000, 99999)<br>     opening_circle (SelectedRegions, RegionOpening, 4.5)<br>     connection (RegionOpening, ConnectedRegions)<br>     select_shape (ConnectedRegions, SelectedRegions, 'area', 'and', 1000, 99999)<br>     shape_trans (SelectedRegions, Pills, 'convex')</p> 
<p><img alt="" height="223" src="https://images2.imgbox.com/9f/a6/HdxCtnQc_o.png" width="819"></p> 
<p style="text-align:center;"><img alt="" height="211" src="https://images2.imgbox.com/b4/c8/9RMahoFJ_o.png" width="1146"></p> 
<p>    * <br>     * Classify segmentation results and display statistics<br>     count_obj (Chambers, Number)<br>     gen_empty_obj (WrongPill)<br>     gen_empty_obj (MissingPill)<br>     for I := 1 to Number by 1<br>         select_obj (Chambers, Chamber, I)<br>         intersection (Chamber, Pills, Pill)<br>         area_center (Pill, Area, Row1, Column1)<br>         if (Area &gt; 0)<br>             min_max_gray (Pill, ImageB, 0, Min, Max, Range)<br>             if (Area &lt; 3800 or Min &lt; 60)<br>                 concat_obj (WrongPill, Pill, WrongPill)<br>             endif<br>         else<br>             concat_obj (MissingPill, Chamber, MissingPill)<br>         endif<br>     endfor<br>     * <br>     dev_clear_window ()<br>     dev_display (ImageAffineTrans)<br>     dev_set_color ('forest green')<br>     count_obj (Pills, NumberP)<br>     count_obj (WrongPill, NumberWP)<br>     count_obj (MissingPill, NumberMP)<br>     dev_display (Pills)<br>     if (NumberMP &gt; 0 or NumberWP &gt; 0)<br>         disp_message (WindowHandle, 'Not OK', 'window', 12, 12 + 600, 'red', 'true')<br>     else<br>         disp_message (WindowHandle, 'OK', 'window', 12, 12 + 600, 'forest green', 'true')<br>     endif<br>     * <br>     Message := '# Correct pills: ' + (NumberP - NumberWP)<br>     Message[1] := '# Wrong pills  :  ' + NumberWP<br>     Message[2] := '# Missing pills:  ' + NumberMP<br>     * <br>     Colors := gen_tuple_const(3,'black')<br>     if (NumberWP &gt; 0)<br>         Colors[1] := 'red'<br>     endif<br>     if (NumberMP &gt; 0)<br>         Colors[2] := 'red'<br>     endif<br>     disp_message (WindowHandle, Message, 'window', 12, 12, Colors, 'true')<br>     dev_set_color ('red')<br>     dev_display (WrongPill)<br>     dev_display (MissingPill)<br>     if (Index &lt; Count)<br>         disp_continue_message (WindowHandle, 'black', 'true')<br>     endif<br>     stop ()<br> endfor</p> 
<p> </p> 
<p style="text-align:center;"> </p> 
<p style="text-align:center;"> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/48c7f79071a9c4cc2a227a029d2ad36c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">deepstream多路rtsp流，避免相互影响</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/279cfc3a99f3337dad2a0f14246293ff/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Java程序设计基础【5】</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>