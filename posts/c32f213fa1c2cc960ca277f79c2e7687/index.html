<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SpringBoot2.0.2.RELEASE集成ElasticSearch6.6.1(RestHighLevelClient) - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="SpringBoot2.0.2.RELEASE集成ElasticSearch6.6.1(RestHighLevelClient)" />
<meta property="og:description" content="最近项目有用到Elasticsearch（以下简称ES），用了官方提供的RestHighLevelClient，在这里记录一下。
首先ES是有专门的同事在维护，我的应用层只是调用他们的服务，来进行日志检索。
第一步：引入Elasticsearch依赖 &lt;properties&gt; &lt;elasticSearch.version&gt;6.6.1&lt;/elasticSearch.version&gt; &lt;/properties&gt; &lt;dependency&gt; &lt;groupId&gt;org.elasticsearch&lt;/groupId&gt; &lt;artifactId&gt;elasticsearch&lt;/artifactId&gt; &lt;version&gt;${elasticSearch.version}&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.elasticsearch.client&lt;/groupId&gt; &lt;artifactId&gt;elasticsearch-rest-high-level-client&lt;/artifactId&gt; &lt;version&gt;${elasticSearch.version}&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.elasticsearch.plugin&lt;/groupId&gt; &lt;artifactId&gt;transport-netty4-client&lt;/artifactId&gt; &lt;version&gt;${elasticSearch.version}&lt;/version&gt; &lt;/dependency&gt; 注意版本号需要严格对应哦。
第二步：创建配置类ESConfig import org.apache.http.HttpHost; import org.apache.http.client.config.RequestConfig.Builder; import org.apache.http.impl.nio.client.HttpAsyncClientBuilder; import org.elasticsearch.client.RestClient; import org.elasticsearch.client.RestClientBuilder; import org.elasticsearch.client.RestClientBuilder.HttpClientConfigCallback; import org.elasticsearch.client.RestClientBuilder.RequestConfigCallback; import org.elasticsearch.client.RestHighLevelClient; import org.springframework.context.annotation.Bean; import org.springframework.context.annotation.Configuration; import java.util.ArrayList; @Configuration public class ESConfig { private static String hosts = &#34;10.xx.xxx.xxx&#34;; // 集群地址，多个用,隔开 private static int port = xxxx; // 使用的端口号 private static String schema = &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/c32f213fa1c2cc960ca277f79c2e7687/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-04-02T15:37:13+08:00" />
<meta property="article:modified_time" content="2019-04-02T15:37:13+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SpringBoot2.0.2.RELEASE集成ElasticSearch6.6.1(RestHighLevelClient)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>最近项目有用到Elasticsearch（以下简称ES），用了官方提供的RestHighLevelClient，在这里记录一下。</p> 
<p>首先ES是有专门的同事在维护，我的应用层只是调用他们的服务，来进行日志检索。</p> 
<h4>第一步：引入Elasticsearch依赖</h4> 
<pre class="has"><code class="language-html">&lt;properties&gt;
    &lt;elasticSearch.version&gt;6.6.1&lt;/elasticSearch.version&gt;
&lt;/properties&gt;

&lt;dependency&gt;
    &lt;groupId&gt;org.elasticsearch&lt;/groupId&gt;
    &lt;artifactId&gt;elasticsearch&lt;/artifactId&gt;
    &lt;version&gt;${elasticSearch.version}&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.elasticsearch.client&lt;/groupId&gt;
    &lt;artifactId&gt;elasticsearch-rest-high-level-client&lt;/artifactId&gt;
    &lt;version&gt;${elasticSearch.version}&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.elasticsearch.plugin&lt;/groupId&gt;
    &lt;artifactId&gt;transport-netty4-client&lt;/artifactId&gt;
    &lt;version&gt;${elasticSearch.version}&lt;/version&gt;
&lt;/dependency&gt;
</code></pre> 
<p><strong><span style="color:#f33b45;">注意版本号需要严格对应哦。</span></strong></p> 
<h4>第二步：创建配置类ESConfig</h4> 
<pre class="has"><code class="language-java">import org.apache.http.HttpHost;
import org.apache.http.client.config.RequestConfig.Builder;
import org.apache.http.impl.nio.client.HttpAsyncClientBuilder;
import org.elasticsearch.client.RestClient;
import org.elasticsearch.client.RestClientBuilder;
import org.elasticsearch.client.RestClientBuilder.HttpClientConfigCallback;
import org.elasticsearch.client.RestClientBuilder.RequestConfigCallback;
import org.elasticsearch.client.RestHighLevelClient;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.ArrayList;

@Configuration
public class ESConfig {

    private static String hosts = "10.xx.xxx.xxx"; // 集群地址，多个用,隔开
    private static int port = xxxx; // 使用的端口号
    private static String schema = "http"; // 使用的协议
    private static ArrayList&lt;HttpHost&gt; hostList = null;

    private static int connectTimeOut = 1000; // 连接超时时间
    private static int socketTimeOut = 30000; // 连接超时时间
    private static int connectionRequestTimeOut = 500; // 获取连接的超时时间

    private static int maxConnectNum = 100; // 最大连接数
    private static int maxConnectPerRoute = 100; // 最大路由连接数

    static {
        hostList = new ArrayList&lt;&gt;();
        String[] hostStrs = hosts.split(",");
        for (String host : hostStrs) {
            hostList.add(new HttpHost(host, port, schema));
        }
    }

    @Bean
    public RestHighLevelClient client(){
        RestClientBuilder builder = RestClient.builder(hostList.toArray(new HttpHost[0]));
        // 异步httpclient连接延时配置
        builder.setRequestConfigCallback(new RequestConfigCallback() {
            @Override
            public Builder customizeRequestConfig(Builder requestConfigBuilder) {
                requestConfigBuilder.setConnectTimeout(connectTimeOut);
                requestConfigBuilder.setSocketTimeout(socketTimeOut);
                requestConfigBuilder.setConnectionRequestTimeout(connectionRequestTimeOut);
                return requestConfigBuilder;
            }
        });
        // 异步httpclient连接数配置
        builder.setHttpClientConfigCallback(new HttpClientConfigCallback() {
            @Override
            public HttpAsyncClientBuilder customizeHttpClient(HttpAsyncClientBuilder httpClientBuilder) {
                httpClientBuilder.setMaxConnTotal(maxConnectNum);
                httpClientBuilder.setMaxConnPerRoute(maxConnectPerRoute);
                return httpClientBuilder;
            }
        });
        RestHighLevelClient client = new RestHighLevelClient(builder);
        return client;
    }
}</code></pre> 
<h4>第三步：创建功能类</h4> 
<p>查询：</p> 
<p>首先我们得看下ES服务那边提供的数据的Json结构：</p> 
<pre class="has"><code class="language-html">"hits" : {
    "total" : 12,
    "max_score" : 1.0,
    "hits" : [
      {
        "_index" : "filebeat-6.6.1-2019.03.21",
        "_type" : "doc",
        "_id" : "d6Jan2kBXvHfQ1BtNqYz",
        "_score" : 1.0,
        "_source" : {
          "offset" : 3348,
          "log" : {
            "file" : {
              "path" : "/xxx/xxx/log/redis.log"
            }
          },
          "prospector" : {
            "type" : "log"
          },
          "read_timestamp" : "2019-03-21T08:24:37.873Z",
          "source" : "/xxx/xxx/log/redis.log",
          "fileset" : {
            "module" : "redis",
            "name" : "log"
          },
          "redis" : {
            "log" : {
              "role" : "master",
              "level" : "warning",
              "pid" : "11027",
              "message" : "User requested shutdown..."
            }
          },
          "input" : {
            "type" : "log"
          },
          "@timestamp" : "2019-03-21T16:24:33.477Z",
          "beat" : {
            "hostname" : "xxx",
            "name" : "xxx",
            "version" : "6.6.1"
          },
          "host" : {
            "name" : "xxx"
          },
          "event" : {
            "dataset" : "redis.log"
          },
          "fields" : {
            "port" : 6410,
            "entity_id" : 319
          }
        }
      }
    ]
  }</code></pre> 
<p>假如是这种比较复杂的Json结构，我们要查询entity_id是319，时间戳read_timestamp在某一个区间里这几个字段redis.log.role，log.file.path，fields.port，fields.entity_id，redis.log.message的值。</p> 
<pre class="has"><code class="language-java">import com.alibaba.fastjson.JSON;
import com.foresealife.dbaas.entity.common.ActionResponse;
import org.elasticsearch.action.search.SearchRequest;
import org.elasticsearch.action.search.SearchResponse;
import org.elasticsearch.client.RequestOptions;
import org.elasticsearch.client.RestHighLevelClient;
import org.elasticsearch.index.query.BoolQueryBuilder;
import org.elasticsearch.index.query.MatchQueryBuilder;
import org.elasticsearch.index.query.QueryBuilders;
import org.elasticsearch.index.query.RangeQueryBuilder;
import org.elasticsearch.search.SearchHit;
import org.elasticsearch.search.SearchHits;
import org.elasticsearch.search.builder.SearchSourceBuilder;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.io.IOException;

@Service
public class ElasticSearchLogService {
    private static final Logger LOG = LoggerFactory.getLogger(ElasticSearchLogService.class);

    @Autowired
    private RestHighLevelClient client;

    public ActionResponse search() throws IOException {
        BoolQueryBuilder boolBuilder = QueryBuilders.boolQuery();
        SearchSourceBuilder sourceBuilder = new SearchSourceBuilder();
        MatchQueryBuilder matchQueryBuilder = QueryBuilders.matchQuery("fields.entity_id", "319");//这里可以根据字段进行搜索，must表示符合条件的，相反的mustnot表示不符合条件的
        RangeQueryBuilder rangeQueryBuilder = QueryBuilders.rangeQuery("read_timestamp"); //新建range条件
        rangeQueryBuilder.gte("2019-03-21T08:24:37.873Z"); //开始时间
        rangeQueryBuilder.lte("2019-03-21T08:24:37.873Z"); //结束时间
        boolBuilder.must(matchQueryBuilder);
        boolBuilder.must(rangeQueryBuilder);
        sourceBuilder.query(boolBuilder);
        sourceBuilder.from(0);
        sourceBuilder.size(100); // 获取记录数，默认10
        sourceBuilder.fetchSource(new String[] {"redis.log.role","log.file.path","fields.port","fields.entity_id","redis.log.message"}, new String[] {}); //第一个是获取字段，第二个是过滤的字段，默认获取全部
        SearchRequest searchRequest = new SearchRequest("filebeat-6.6.1-2019.03.21"); //索引
        searchRequest.types("doc"); //类型
        searchRequest.source(sourceBuilder);
        SearchResponse response = client.search(searchRequest, RequestOptions.DEFAULT);
        LOG.info("search: {}",JSON.toJSONString(response));
        SearchHits hits = response.getHits();
        SearchHit[] searchHits = hits.getHits();
        for (SearchHit hit : searchHits) {
            LOG.info("search -&gt; {}",hit.getSourceAsString());
        }
        return ActionResponse.actionSuccess("","");
    }
}</code></pre> 
<p>以上是查询的功能，后续加入更多ES功能后，再补充。</p> 
<p> </p> 
<p> </p> 
<p> </p> 
<p>如果我的文章有帮助到您，欢迎打赏一下鼓励博主。</p> 
<p><img alt="" class="has" height="385" src="https://images2.imgbox.com/80/77/XqZnMkhV_o.png" width="386"></p> 
<p> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f647bb01d33c2ed3d79404355d0a2a74/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">configure: error: zlib library not found 解决方法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/02907d5a89ccf269fd550105b4159a5f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">numpy报错：OSError: Failed to interpret file as a pickle</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>