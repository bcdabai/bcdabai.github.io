<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Compose 中 TextField 的有效状态管理 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Compose 中 TextField 的有效状态管理" />
<meta property="og:description" content="Compose 中 TextField 的有效状态管理 为了防止同步问题和意外行为:
避免在输入和更新TextField状态之间出现延迟/异步行为。避免使用响应式流收集StateFlow的数据来保存TextField状态，例如使用默认调度程序。使用Compose API，例如MutableState&lt;String&gt;，定义TextField状态变量。 需要时，将TextField状态提升到ViewModel，例如将业务验证应用于TextField内容。 假设我们必须在Jetpack Compose应用中实现注册页面，并收到以下设计:
我们有两个文本输入框和一个按钮。
让我们从顶部的文本输入框开始，它是用户名字段。
为了在Compose中实现一个文本输入框，我们需要定义一个状态变量：
存储当前显示的值，并将其传递给TextField的值参数。每当用户在TextField的onValueChange回调中输入新文本时，就会更新它。 /* Copyright 2022 Google LLC. SPDX-License-Identifier: Apache-2.0 */ var myValue = ... OutlinedTextField( value = myValue, // #1 onValueChange = { newValue -&gt; myValue = newValue } // #2 ... ) } 在处理状态时，重要的事情是决定将状态变量放在何处。在我们的例子中，我们希望对用户名进行一些业务逻辑校验，因此我们将状态提升到ViewModel中，而不是将其保留在组成函数中。如需更多关于此及如何组织应用架构的信息，可以阅读我们的架构指南。
通过将状态放在ViewModel中，TextField值将在配置更改时免费持久化。
基于这些要求，我们创建一个包含类似于此的OutlinedTextField组件的组合注册屏幕：
/* Copyright 2022 Google LLC. SPDX-License-Identifier: Apache-2.0 */ // SignUpScreen.kt @Composable fun SignUpScreen(...) { OutlinedTextField( ... value = viewModel.username.collectAsStateWithLifecycle(), onValueChange = { viewModel." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/1a3ff2b290670e2d24a284b8fef2d591/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-02T15:31:29+08:00" />
<meta property="article:modified_time" content="2023-06-02T15:31:29+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Compose 中 TextField 的有效状态管理</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Compose__TextField__0"></a>Compose 中 TextField 的有效状态管理</h2> 
<p><img src="https://images2.imgbox.com/44/33/JL5vSvRO_o.png" alt="compose TextField"></p> 
<p>为了防止同步问题和意外行为:</p> 
<ul><li>避免在输入和更新<code>TextField</code>状态之间出现延迟/异步行为。</li><li>避免使用响应式流收集<code>StateFlow</code>的数据来保存<code>TextField</code>状态，例如使用默认调度程序。</li><li>使用Compose API，例如<code>MutableState&lt;String&gt;</code>，定义<code>TextField</code>状态变量。 需要时，将<code>TextField</code>状态提升到<code>ViewModel</code>，例如将业务验证应用于<code>TextField</code>内容。</li></ul> 
<p>假设我们必须在Jetpack Compose应用中实现注册页面，并收到以下设计:<br> <img src="https://images2.imgbox.com/8c/8f/wSVBgn3h_o.png" alt="使用两个文本输入框实现注册界面"></p> 
<p>我们有两个文本输入框和一个按钮。<br> 让我们从顶部的文本输入框开始，它是用户名字段。<br> 为了在Compose中实现一个文本输入框，我们需要定义一个状态变量：</p> 
<ol><li>存储当前显示的值，并将其传递给TextField的值参数。</li><li>每当用户在TextField的onValueChange回调中输入新文本时，就会更新它。</li></ol> 
<pre><code class="prism language-kt"><span class="token comment">/* Copyright 2022 Google LLC.   
   SPDX-License-Identifier: Apache-2.0 */</span>

<span class="token keyword">var</span> myValue <span class="token operator">=</span> <span class="token operator">..</span><span class="token punctuation">.</span>

<span class="token function">OutlinedTextField</span><span class="token punctuation">(</span>
   value <span class="token operator">=</span> myValue<span class="token punctuation">,</span> <span class="token comment">// #1</span>
   onValueChange <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> newValue <span class="token operator">-&gt;</span> myValue <span class="token operator">=</span> newValue <span class="token punctuation">}</span> <span class="token comment">// #2</span>
   <span class="token operator">..</span><span class="token punctuation">.</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在处理状态时，重要的事情是决定将状态变量放在何处。在我们的例子中，我们希望对用户名进行一些业务逻辑校验，因此我们将状态提升到ViewModel中，而不是将其保留在组成函数中。如需更多关于此及如何组织应用架构的信息，可以阅读我们的架构指南。<br> 通过将状态放在ViewModel中，TextField值将在配置更改时免费持久化。</p> 
<p>基于这些要求，我们创建一个包含类似于此的OutlinedTextField组件的组合注册屏幕：</p> 
<pre><code class="prism language-kt"><span class="token comment">/* Copyright 2022 Google LLC.   
   SPDX-License-Identifier: Apache-2.0 */</span>

<span class="token comment">// SignUpScreen.kt</span>

<span class="token annotation builtin">@Composable</span>
<span class="token keyword">fun</span> <span class="token function">SignUpScreen</span><span class="token punctuation">(</span><span class="token operator">..</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token function">OutlinedTextField</span><span class="token punctuation">(</span>
       <span class="token operator">..</span><span class="token punctuation">.</span>
       value <span class="token operator">=</span> viewModel<span class="token punctuation">.</span>username<span class="token punctuation">.</span><span class="token function">collectAsStateWithLifecycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       onValueChange <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> viewModel<span class="token punctuation">.</span><span class="token function">updateUsername</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span> <span class="token punctuation">}</span>
       <span class="token operator">..</span><span class="token punctuation">.</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>接下来，在 ViewModel 中，我们将定义状态变量并执行业务逻辑。</p> 
<p>目前，不建议使用响应式流来定义 TextField 的状态变量。我们将在接下来的章节中探讨为什么以及其他陷阱，但是现在假设我们犯了这个错误。我们错误地定义了一个类型为 <code>MutableStateFlow</code> 的 <code>_username</code> 变量来存储 TextField 状态，并通过定义不可变的 backed 变量 username 来公开它。</p> 
<p>异步方法 <code>updateUsername</code> 将在用户在 TextField 上键入新字符时，每次调用服务来验证用户名是否可用（例如以前是否已使用）。如果验证失败，它将显示一个错误消息，要求选择不同的用户名。</p> 
<pre><code class="prism language-kt"><span class="token comment">/* Copyright 2022 Google LLC.   
   SPDX-License-Identifier: Apache-2.0 */</span>

<span class="token comment">// SignUpViewModel.kt</span>

<span class="token keyword">class</span> <span class="token function">SignUpViewModel</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">val</span> userRepository<span class="token operator">:</span> UserRepository<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">ViewModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   
   <span class="token comment">// DO NOT DO THIS. ANTI-PATTERN - using a reactive stream for TextField state</span>
   <span class="token keyword">private</span> <span class="token keyword">val</span> _username <span class="token operator">=</span> <span class="token function">MutableStateFlow</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">""</span></span><span class="token punctuation">)</span>
   <span class="token keyword">val</span> username <span class="token operator">=</span> _username<span class="token punctuation">.</span><span class="token function">asStateFlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

   <span class="token keyword">fun</span> <span class="token function">updateUsername</span><span class="token punctuation">(</span>input<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       viewModelScope<span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{<!-- --></span>
           <span class="token comment">// async operation</span>
           <span class="token keyword">val</span> isUsernameAvailable <span class="token operator">=</span> userRepository<span class="token punctuation">.</span><span class="token function">isUsernameAvailable</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span>
           <span class="token comment">// ...</span>
           
           <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isUsernameAvailable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
               <span class="token comment">// modify error state</span>
           <span class="token punctuation">}</span>
           <span class="token comment">// DO NOT DO THIS. ANTI-PATTERN - updating after an async op</span>
           _username<span class="token punctuation">.</span>value <span class="token operator">=</span> input
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_88"></a>问题</h3> 
<p>我们已经完成了用户名字段的实现。如果现在运行应用程序，我们应该能够进行测试：<br> <img src="https://images2.imgbox.com/60/3b/ou3cA2dX_o.png" alt="当我们尝试将用户名jane@mail.com更改为jane.surname@mail.com时，TextField出现不正确的行为"><br> 当我们输入时，我们很快发现不正确的行为：在我们输入时，有些字母会被跳过，有些字母按错误的顺序添加到输入中，整个位被重复，光标来回跳动。所有编辑操作均失败，包括删除和选择要替换的文本。显然存在错误。</p> 
<p>发生了什么，我们该如何解决呢？</p> 
<h3><a id="TextField_95"></a>TextField的内部实现</h3> 
<p>在撰写本文（使用Compose UI 1.3.0-beta01）时，TextField的实现包括持有3个状态的副本：</p> 
<ol><li>输入法编辑器（IME）：为了能够执行智能操作，例如建议替换一个单词的下一个词或表情符号，键盘需要拥有当前显示的文本的副本。</li><li>由用户定义并更新的状态持有者，在上面的示例中，它是一个MutableStateFlow变量。</li><li>内部状态充当控制器，使其他两个状态保持同步，因此您无需手动与IME交互。</li></ol> 
<blockquote> 
 <p>即使在每个TextField的全部时间内都有3个状态的副本在发挥作用，开发人员只管理其中一个（状态持有者），而其他副本则是内部的。</p> 
</blockquote> 
<p>这三种状态如何在幕后相互作用？为了简化，从键盘键入或添加的每个字符执行一系列步骤，构成一个反馈循环，如下所示：</p> 
<p><img src="https://images2.imgbox.com/69/00/UTdCaLOu_o.png" alt="TextField状态之间的交互"></p> 
<ol><li>从键盘输入事件（输入单词“hello”）并被转发到内部控制器。</li><li>内部控制器接收到此更新“hello”，并将其转发给状态持有者。</li><li>状态持有者更新为“hello”内容，这将更新UI并通知内部控制器已接收到更新。</li><li>内部控制器通知键盘。</li><li>键盘被通知，因此它可以为下一个键入事件做准备，例如建议下一个单词。</li></ol> 
<p>只要这些状态的副本保持同步，TextField就能按预期运行。</p> 
<p>然而，通过引入异步行为和竞态条件到打字的过程中，这些拷贝就可能不同步，且无法恢复。这些错误的严重程度取决于各种因素，如引入的延迟量、键盘语言、文本内容和长度以及输入法实现。</p> 
<p>即使只是使用响应式流来表示状态（例如StateFlow）而没有延迟，也可能会出现问题，因为如果您使用默认调度程序，则更新事件的分派不是立即的。</p> 
<p>让我们尝试看一下在这种情况下会发生什么，当您开始输入时。来自键盘的新事件“hello”到来，然后在我们更新状态和UI之前，我们生成一个异步调用。然后另一个事件“world”从键盘上来了。</p> 
<p>第一个异步事件恢复，循环完成。当TextField内部状态接收到异步“hello”时，它会丢弃之前收到的最新的“hello world”。<br> <img src="https://images2.imgbox.com/e9/04/tLvAWOea_o.png" alt="TextField 的内部状态被覆盖为 'hello'，而不是 'hello world'"><br> 但是在某个时候，“hello world” 异步事件也将恢复。此时 TextField 保持无效状态，其中 3 个状态不匹配。</p> 
<p>TextField 的内部状态被覆盖为 ‘hello’，而不是 ‘hello world’。<br> 但是在某个时候，“hello world” 异步事件也将恢复。此时 TextField 保持无效状态，其中 3 个状态不匹配。<br> <img src="https://images2.imgbox.com/7d/13/rzkJY6nc_o.png" alt="每次异步处理恢复后，TextField存在不一致性"><br> TextField存在不一致性。这些意外的异步调用与IME的处理、快速输入、时序条件以及替换整个文本块的删除等操作相结合，缺陷变得更加明显。</p> 
<p>既然我们对其中的动态有了一些了解，让我们看看如何修复和避免这些问题。</p> 
<h3><a id="TextField_131"></a>处理TextField状态的最佳实践</h3> 
<p><strong>避免延迟更新状态</strong><br> 当onValueChange被调用时，立即同步更新您的TextField。</p> 
<pre><code class="prism language-kt"><span class="token comment">/* Copyright 2022 Google LLC.   
   SPDX-License-Identifier: Apache-2.0 */</span>

<span class="token comment">// SignUpViewModel.kt</span>

<span class="token keyword">class</span> <span class="token function">SignUpViewModel</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">val</span> userRepository<span class="token operator">:</span> UserRepository<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">ViewModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   
   <span class="token keyword">fun</span> <span class="token function">updateUsername</span><span class="token punctuation">(</span>input<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">-</span>       viewModelScope<span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">-</span>           <span class="token comment">// async operation</span>
<span class="token operator">-</span>           <span class="token keyword">val</span> isUsernameAvailable <span class="token operator">=</span> userRepository<span class="token punctuation">.</span><span class="token function">isUsernameAvailable</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span>
<span class="token operator">-</span>           <span class="token comment">// ...</span>
<span class="token operator">-</span>           
<span class="token operator">-</span>           <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isUsernameAvailable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">-</span>               <span class="token comment">// modify error state</span>
<span class="token operator">-</span>           <span class="token punctuation">}</span>
           username<span class="token punctuation">.</span>value <span class="token operator">=</span> input
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">// SignUpScreen.kt</span>

<span class="token annotation builtin">@Composable</span>
<span class="token keyword">fun</span> <span class="token function">SignUpScreen</span><span class="token punctuation">(</span><span class="token operator">..</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

   <span class="token function">OutlinedTextField</span><span class="token punctuation">(</span>
      value <span class="token operator">=</span> viewModel<span class="token punctuation">.</span>username<span class="token punctuation">,</span>
      onValueChange <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> username <span class="token operator">-&gt;</span> viewModel<span class="token punctuation">.</span><span class="token function">updateUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span> <span class="token punctuation">}</span>
      …
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>你可能仍然需要对文本进行过滤或修剪。同步操作可以进行。例如，如果你的同步操作将输入转换为不同的字符集，请考虑使用 <code>visualTransformation</code>。你应该避免使用异步操作，因为这会导致上述问题。</p> 
<p><strong>使用 MutableState 表示 TextField 状态</strong><br> 避免使用响应式流（例如 StateFlow）来表示 TextField 状态，因为这些结构引入了异步延迟。而应该使用 MutableState：</p> 
<pre><code class="prism language-kt"><span class="token comment">/* Copyright 2022 Google LLC.   
   SPDX-License-Identifier: Apache-2.0 */</span>

<span class="token keyword">class</span> SignUpViewModel <span class="token operator">:</span> <span class="token function">ViewModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token keyword">var</span> username <span class="token keyword">by</span> <span class="token function">mutableStateOf</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">""</span></span><span class="token punctuation">)</span>
       <span class="token keyword">private</span> <span class="token keyword">set</span>

   <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>如果您仍然更喜欢使用 StateFlow 来存储状态，请确保使用立即调度程序而不是默认调度程序来从流中收集。</p> 
<p>这种解决方案需要更深入的协程知识，并可能导致以下问题：</p> 
<ul><li>由于收集是同步的，因此当它发生时，UI 可能处于不可操作状态。</li><li>会干扰 Compose 的线程和渲染阶段，因为它假设重组发生在主线程上。</li></ul> 
<p><strong>在哪里定义状态</strong><br> 如果您的TextField state需要在键入时进行业务逻辑验证，则将状态提升到ViewModel中是正确的。如果不需要，您可以使用Composables或状态持有类作为真正的数据源。</p> 
<p>一般的规则是，您应该将状态放在尽可能低的位置，同时仍然被正确地拥有，这通常意味着更接近它被使用的地方。有关Compose中状态的更多信息，请查看我们的指南。</p> 
<p>在解决此问题时，重要的不是将TextField state提升到哪里，而是如何存储它。</p> 
<h3><a id="_198"></a>在您的应用程序中应用最佳实践</h3> 
<p>考虑到这些最佳实践，让我们同时实现异步和同步验证到我们的TextField state中。</p> 
<p>从异步验证开始，如果要使用的用户名无效，则我们想要在TextField下方显示错误消息，并在服务器端执行此验证。在我们的UI中，它将如下所示：</p> 
<p><img src="https://images2.imgbox.com/52/fe/M6BCFkPE_o.png" alt="显示错误，因为“username1”已经被使用了"></p> 
<p>当调用<code>onValueChange</code>时，我们将立即调用更新方法来更新<code>TextField</code>，然后，ViewModel将根据刚刚更改的值安排异步检查。</p> 
<p>在ViewModel中，我们定义了两个状态变量：一个用于TextField状态的<code>username</code>变量作为<code>MutableState</code>，一个<code>userNameHasError</code>作为<code>StateFlow</code>，它会在用户名更新时进行反应性计算。</p> 
<p><code>snapshotFlow</code> API将Compose State转换为<code>flow</code>，以便我们可以对每个值执行异步（挂起）操作。</p> 
<p>因为输入速度可能比获取异步调用结果更快，所以我们按顺序处理事件，并使用<code>mapLatest</code>（实验性）在出现新事件时取消未完成的调用，以避免浪费资源或显示不正确的状态。出于同样的原因，我们还可以添加一个防抖方法（异步调用之间的延迟）。</p> 
<pre><code class="prism language-kt"><span class="token comment">/* Copyright 2022 Google LLC.   
   SPDX-License-Identifier: Apache-2.0 */</span>

<span class="token comment">// SignUpViewModel.kt</span>

<span class="token annotation builtin">@OptIn</span><span class="token punctuation">(</span>ExperimentalCoroutinesApi<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token function">SignUpViewModel</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">val</span> signUpRepository<span class="token operator">:</span> SignUpRepository<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">ViewModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> username <span class="token keyword">by</span> <span class="token function">mutableStateOf</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">""</span></span><span class="token punctuation">)</span>
        <span class="token keyword">private</span> <span class="token keyword">set</span>

    <span class="token keyword">val</span> userNameHasError<span class="token operator">:</span> StateFlow<span class="token operator">&lt;</span>Boolean<span class="token operator">&gt;</span> <span class="token operator">=</span>
        snapshotFlow <span class="token punctuation">{<!-- --></span> username <span class="token punctuation">}</span>
            <span class="token punctuation">.</span><span class="token function">mapLatest</span> <span class="token punctuation">{<!-- --></span> signUpRepository<span class="token punctuation">.</span><span class="token function">isUsernameAvailable</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span> <span class="token punctuation">}</span>
            <span class="token punctuation">.</span><span class="token function">stateIn</span><span class="token punctuation">(</span>
                scope <span class="token operator">=</span> viewModelScope<span class="token punctuation">,</span>
                started <span class="token operator">=</span> SharingStarted<span class="token punctuation">.</span><span class="token function">WhileSubscribed</span><span class="token punctuation">(</span><span class="token number">5_000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                initialValue <span class="token operator">=</span> <span class="token boolean">false</span>
            <span class="token punctuation">)</span>

    <span class="token keyword">fun</span> <span class="token function">updateUsername</span><span class="token punctuation">(</span>input<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        username <span class="token operator">=</span> input
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">// SignUpScreen.kt</span>

<span class="token annotation builtin">@OptIn</span><span class="token punctuation">(</span>ExperimentalLifecycleComposeApi<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation builtin">@Composable</span>
<span class="token keyword">fun</span> <span class="token function">SignUpScreen</span><span class="token punctuation">(</span><span class="token operator">..</span><span class="token punctuation">.</span><span class="token punctuation">)</span>

    <span class="token function">OutlinedTextField</span><span class="token punctuation">(</span>
        value <span class="token operator">=</span> viewModel<span class="token punctuation">.</span>username<span class="token punctuation">,</span>
        onValueChange <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> newValue <span class="token operator">-&gt;</span>
            viewModel<span class="token punctuation">.</span><span class="token function">updateUsername</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">val</span> userNameHasError <span class="token keyword">by</span> viewModel<span class="token punctuation">.</span>userNameHasError<span class="token punctuation">.</span><span class="token function">collectAsStateWithLifecycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>userNameHasError<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">Text</span><span class="token punctuation">(</span>
            text <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"Username not available. Please choose a different one."</span></span><span class="token punctuation">,</span>
            color <span class="token operator">=</span> <span class="token function">Color</span><span class="token punctuation">(</span>ColorError<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>请注意，我们正在使用实验性的collectAsStateWithLifecycle API收集错误验证流，这是在Android中收集流的推荐方式。要了解有关此API的更多信息，您可以查看Jetpack Compose博客文章中的“安全地消费流”部分。</p> 
<blockquote> 
 <p>https://medium.com/androiddevelopers/consuming-flows-safely-in-jetpack-compose-cde014d0d5a3</p> 
</blockquote> 
<p>现在，我们想添加同步验证以检查输入是否包含无效字符。我们可以使用synchronous的derivedStateOf() API，每当用户名更改时将触发lambda验证。</p> 
<pre><code class="prism language-kt"><span class="token comment">/* Copyright 2022 Google LLC.   
   SPDX-License-Identifier: Apache-2.0 */</span>

<span class="token comment">// SignUpViewModel.kt</span>

<span class="token keyword">class</span> <span class="token function">SignUpViewModel</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">val</span> signUpRepository<span class="token operator">:</span> SignUpRepository<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">ViewModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token keyword">var</span> username <span class="token keyword">by</span> <span class="token function">mutableStateOf</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">""</span></span><span class="token punctuation">)</span>
        <span class="token keyword">private</span> <span class="token keyword">set</span>    

    <span class="token keyword">val</span> userNameHasLocalError <span class="token keyword">by</span> derivedStateOf <span class="token punctuation">{<!-- --></span> 
        <span class="token comment">// synchronous call</span>
        signUpRepository<span class="token punctuation">.</span><span class="token function">isUsernameCorrect</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>

    <span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>derivedStateOf()</code>创建新的State，读取<code>userNameHasLocalError</code>的组件将在该值在true和false之间更改时重新组合。<br> 我们完整的带验证的用户名实现如下：<br> <img src="https://images2.imgbox.com/54/99/qfzv63Ft_o.gif" alt="实现具有同步和异步错误的用户名字段"></p> 
<h3><a id="_TextField__292"></a>考虑 TextField 的实现</h3> 
<p>目前，我们正在改进 TextField API，并将其视为我们的优先事项之一。</p> 
<p>Compose 路线图反映了团队在多个方面开展的工作，这种情况下文本编辑和键盘输入的改进都与这些 API 相关。因此，请注意未来的 Compose 发布版本以及发布说明。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fa785419bb5cbd08268210f3fe11e987/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">用Java写入excel</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5575323e13195640abe167da503bef3e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">docker部署rocketmq</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>