<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Hive-SQL语法大全 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Hive-SQL语法大全" />
<meta property="og:description" content="Hive SQL 语法大全 基于语法描述说明 CREATE DATABASE [IF NOT EXISTS] db_name [LOCATION] &#39;path&#39;; SELECT expr, ... FROM tbl ORDER BY col_name [ASC | DESC] (A | B | C) 如上语法，在语法描述中出现：
[]，表示可选，如上[LOCATION] 表示可写、可不写
|，表示或，如上ASC | DESC，表示二选一
…，表示序列，即未完结，如上SELECT expr, ... 表示在SELECT后可以跟多个expr（查询表达式），以逗号隔开
()，表示必填，如上(A | B | C)表示此处必填，填入内容在A、B、C中三选一
数据库操作 创建数据库 CREATE DATABASE [IF NOT EXISTS] db_name [LOCATION &#39;path&#39;] [COMMENT database_comment]; IF NOT EXISTS，如存在同名数据库不执行任何操作，否则执行创建数据库操作
[LOCATION]，自定义数据库存储位置，如不填写，默认数据库在HDFS的路径为：/user/hive/warehouse
[COMMENT database_comment]，可选，数据库注释
删除数据库 DROP DATABASE [IF EXISTS] db_name [CASCADE]; [IF EXISTS]，可选，如果存在此数据库执行删除，不存在不执行任何操作[CASCADE]，可选，级联删除，即数据库内存在表，使用CASCADE可以强制删除数据库 数据库修改LOCATION ALTER DATABASE database_name SET LOCATION hdfs_path; 不会在HDFS对数据库所在目录进行改名，只是修改location后，新创建的表在新的路径，旧的不变" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/5c12686cdff40fb84df0c0d9e59e495f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-23T21:20:11+08:00" />
<meta property="article:modified_time" content="2024-01-23T21:20:11+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Hive-SQL语法大全</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Hive_SQL__0"></a>Hive SQL 语法大全</h2> 
<h3><a id="_2"></a>基于语法描述说明</h3> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token punctuation">[</span><span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span><span class="token punctuation">]</span> db_name <span class="token punctuation">[</span>LOCATION<span class="token punctuation">]</span> <span class="token string">'path'</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> expr<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">FROM</span> tbl <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> col_name <span class="token punctuation">[</span><span class="token keyword">ASC</span> <span class="token operator">|</span> <span class="token keyword">DESC</span><span class="token punctuation">]</span>
<span class="token punctuation">(</span>A <span class="token operator">|</span> B <span class="token operator">|</span> C<span class="token punctuation">)</span>
</code></pre> 
<p>如上语法，在语法描述中出现：</p> 
<ul><li> <p><code>[]</code>，表示可选，如上<code>[LOCATION] </code>表示可写、可不写</p> </li><li> <p><code>|</code>，表示或，如上<code>ASC | DESC</code>，表示二选一</p> </li><li> <p>…，表示序列，即未完结，如上<code>SELECT expr, ...</code> 表示在SELECT后可以跟多个<code>expr（查询表达式）</code>，以逗号隔开</p> </li><li> <p><code>()</code>，表示必填，如上(A | B | C)表示此处必填，填入内容在A、B、C中三选一</p> </li></ul> 
<h3><a id="_22"></a>数据库操作</h3> 
<h4><a id="_24"></a>创建数据库</h4> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token punctuation">[</span><span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span><span class="token punctuation">]</span> db_name <span class="token punctuation">[</span>LOCATION <span class="token string">'path'</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token keyword">COMMENT</span> database_comment<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li> <p><code>IF NOT EXISTS</code>，如存在同名数据库<code>不执行任何操作</code>，否则<code>执行创建数据库</code>操作</p> </li><li> <p><code>[LOCATION]</code>，自定义数据库存储位置，<code>如不填写</code>，默认数据库在HDFS的路径为：<code>/user/hive/warehouse</code></p> </li><li> <p><code>[COMMENT database_comment]</code>，可选，数据库注释</p> </li></ul> 
<h4><a id="_37"></a>删除数据库</h4> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">DATABASE</span> <span class="token punctuation">[</span><span class="token keyword">IF</span> <span class="token keyword">EXISTS</span><span class="token punctuation">]</span> db_name <span class="token punctuation">[</span><span class="token keyword">CASCADE</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li><code>[IF EXISTS]</code>，可选，如果存在此数据库执行删除，不存在不执行任何操作</li><li><code>[CASCADE]</code>，可选，级联删除，即数据库内存在表，使用CASCADE可以强制删除数据库</li></ul> 
<h4><a id="LOCATION_50"></a>数据库修改LOCATION</h4> 
<pre><code class="prism language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">DATABASE</span> database_name <span class="token keyword">SET</span> LOCATION hdfs_path<span class="token punctuation">;</span>
</code></pre> 
<p><mark>不会在HDFS对数据库所在目录进行改名，只是修改location后，新创建的表在新的路径，旧的不变</mark></p> 
<h4><a id="_60"></a>选择数据库</h4> 
<pre><code class="prism language-sql"><span class="token keyword">USE</span> db_name<span class="token punctuation">;</span>
</code></pre> 
<ul><li>选择数据库后，后续<code>SQL</code>操作基于当前选择的库执行</li><li>如不使用use，默认在<code>default</code>库执行</li></ul> 
<p><strong>若想切换回使用default库</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">USE</span> <span class="token keyword">DEFAULT</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>查询当前USE的数据库</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> current_database<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="_87"></a>表操作</h3> 
<h4><a id="_89"></a>数据类型</h4> 
<table><thead><tr><th><strong>分类</strong></th><th><strong>类型</strong></th><th><strong>描述</strong></th><th><strong>字面量示例</strong></th></tr></thead><tbody><tr><td>原始类型</td><td>BOOLEAN</td><td>true/false</td><td>TRUE</td></tr><tr><td></td><td>TINYINT</td><td>1字节的有符号整数 -128~127</td><td>1Y</td></tr><tr><td></td><td>SMALLINT</td><td>2个字节的有符号整数，-32768~32767</td><td>1S</td></tr><tr><td></td><td>INT</td><td>4个字节的带符号整数</td><td>1</td></tr><tr><td></td><td>BIGINT</td><td>8字节带符号整数</td><td>1L</td></tr><tr><td></td><td>FLOAT</td><td>4字节单精度浮点数1.0</td><td></td></tr><tr><td></td><td>DOUBLE</td><td>8字节双精度浮点数</td><td>1.0</td></tr><tr><td></td><td>DEICIMAL</td><td>任意精度的带符号小数</td><td>1.0</td></tr><tr><td></td><td>STRING</td><td>字符串，变长</td><td>“a”,’b’</td></tr><tr><td></td><td>VARCHAR</td><td>变长字符串</td><td>“a”,’b’</td></tr><tr><td></td><td>CHAR</td><td>固定长度字符串</td><td>“a”,’b’</td></tr><tr><td></td><td>BINARY</td><td>字节数组</td><td></td></tr><tr><td></td><td>TIMESTAMP</td><td>时间戳，毫秒值精度</td><td>122327493795</td></tr><tr><td></td><td>DATE</td><td>日期</td><td>‘2016-03-29’</td></tr><tr><td></td><td></td><td>时间频率间隔</td><td></td></tr><tr><td>复杂类型</td><td>ARRAY</td><td>有序的的同类型的集合</td><td>array(1,2)</td></tr><tr><td></td><td>MAP</td><td>key-value,key必须为原始类型，value可以任意类型</td><td>map(‘a’,1,’b’,2)</td></tr><tr><td></td><td>STRUCT</td><td>字段集合,类型可以不同</td><td>struct(‘1’,1,1.0), named_stract(‘col1’,’1’,’col2’,1,’clo3’,1.0)</td></tr><tr><td></td><td>UNION</td><td>在有限取值范围内的一个值</td><td>create_union(1,’a’,63)</td></tr></tbody></table> 
<h4><a id="_117"></a>基础建表</h4> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token punctuation">[</span>EXTERNAL<span class="token punctuation">]</span> <span class="token keyword">TABLE</span> tb_name
	<span class="token punctuation">(</span>col_name col_type <span class="token punctuation">[</span><span class="token keyword">COMMENT</span> col_comment<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
	<span class="token punctuation">[</span><span class="token keyword">COMMENT</span> tb_comment<span class="token punctuation">]</span>
	<span class="token punctuation">[</span>PARTITIONED <span class="token keyword">BY</span><span class="token punctuation">(</span>col_name<span class="token punctuation">,</span> col_type<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
	<span class="token punctuation">[</span><span class="token keyword">CLUSTERED</span> <span class="token keyword">BY</span><span class="token punctuation">(</span>col_name<span class="token punctuation">,</span> col_type<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">INTO</span> num BUCKETS<span class="token punctuation">]</span>
	<span class="token punctuation">[</span><span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">''</span><span class="token punctuation">]</span>
	<span class="token punctuation">[</span>LOCATION <span class="token string">'path'</span><span class="token punctuation">]</span>
</code></pre> 
<ul><li> <p><code>[EXTERNAL]</code>，外部表，必须搭配</p> </li><li> <p><code>[ROW FORMAT DELIMITED FIELDS TERMINATED BY '']</code>指定列分隔符</p> </li><li> <p><code>[LOCATION 'path']</code>表数据路径</p> </li><li> <p>外部表示意</p> <pre><code class="prism language-sql"><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> test_ext<span class="token punctuation">(</span>id <span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'external table'</span> <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">'\t'</span> LOCATION <span class="token string">'hdfs://node1:8020/tmp/test_ext'</span><span class="token punctuation">;</span>
</code></pre> </li></ul> 
<p>（1）外部表中的表和数据是相互独立的，将表删除（删除元数据），数据还保留在Hive中；将数据删除，表仍然存在。<br> <img src="https://images2.imgbox.com/d4/ba/9YXcl2gm_o.png" alt="请添加图片描述"></p> 
<p>（2） 删除内部表，则元数据和数据都被删除。<br> <img src="https://images2.imgbox.com/11/dd/npOccgB7_o.png" alt="请添加图片描述"></p> 
<ul><li> <p><code>[desc formatted tablename]</code>查看表类型</p> </li><li> <p><code>[COMMENT tb_comment]</code>表注释，可选</p> </li><li> <p><code>[PARTITIONED BY(col_name, col_type, ......)]</code>基于列分区</p> <pre><code class="prism language-sql"><span class="token comment">-- 分区表示意</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test_ext<span class="token punctuation">(</span>id <span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'partitioned table'</span> <span class="token keyword">PARTITION</span> <span class="token keyword">BY</span><span class="token punctuation">(</span><span class="token keyword">year</span> string<span class="token punctuation">,</span> <span class="token keyword">month</span> string<span class="token punctuation">,</span> <span class="token keyword">day</span> string<span class="token punctuation">)</span> <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">'\t'</span><span class="token punctuation">;</span>
</code></pre> </li><li> <p><code>[CLUSTERED BY(col_name, col_type, ......)]</code>基于列分桶</p> <pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> course <span class="token punctuation">(</span>c_id string<span class="token punctuation">,</span>c_name string<span class="token punctuation">,</span>t_id string<span class="token punctuation">)</span> <span class="token keyword">CLUSTERED</span> <span class="token keyword">BY</span><span class="token punctuation">(</span>c_id<span class="token punctuation">)</span> <span class="token keyword">INTO</span> <span class="token number">3</span> BUCKETS <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">'\t'</span><span class="token punctuation">;</span>
</code></pre> </li></ul> 
<h4><a id="_174"></a>基于其它表的结构建表</h4> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> tbl_name <span class="token operator">LIKE</span> other_tbl<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_182"></a>基于查询结果建表</h4> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> tbl_name <span class="token keyword">AS</span> <span class="token keyword">SELECT</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_190"></a>删除表</h4> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> tbl<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_198"></a>修改表</h4> 
<p><strong>重命名</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> old <span class="token keyword">RENAME</span> <span class="token keyword">TO</span> new<span class="token punctuation">;</span>
</code></pre> 
<p><strong>修改属性：内部表和外部表的转换</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> tbl <span class="token keyword">SET</span> TBLPROPERTIES<span class="token punctuation">(</span><span class="token keyword">key</span><span class="token operator">=</span><span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 常用属性</span>
<span class="token punctuation">(</span><span class="token string">"EXTERNAL"</span><span class="token operator">=</span><span class="token string">"TRUE"</span><span class="token punctuation">)</span> <span class="token comment">-- 内外部表，TRUE表示外部表，内转外</span>
<span class="token punctuation">(</span><span class="token string">'comment'</span> <span class="token operator">=</span> new_comment<span class="token punctuation">)</span> <span class="token comment">-- 修改表注释</span>
<span class="token comment">-- 其余属性参见</span>
https:<span class="token comment">//cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL#LanguageManualDDL-listTableProperties</span>
</code></pre> 
<h4><a id="_221"></a>分区操作</h4> 
<p><strong>创建分区表：</strong> 将表拆分到不同的子文件夹中进行存储</p> 
<pre><code class="prism language-sql"><span class="token comment">-- 分区表示意</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test_ext<span class="token punctuation">(</span>id <span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'partitioned table'</span> <span class="token keyword">PARTITION</span> <span class="token keyword">BY</span><span class="token punctuation">(</span><span class="token keyword">year</span> string<span class="token punctuation">,</span> <span class="token keyword">month</span> string<span class="token punctuation">,</span> <span class="token keyword">day</span> string<span class="token punctuation">)</span> <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">'\t'</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>添加分区</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> tablename <span class="token keyword">ADD</span> <span class="token keyword">PARTITION</span> <span class="token punctuation">(</span>partition_key<span class="token operator">=</span><span class="token string">'partition_value'</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>修改分区值</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> tablename <span class="token keyword">PARTITION</span> <span class="token punctuation">(</span>partition_key<span class="token operator">=</span><span class="token string">'old_partition_value'</span><span class="token punctuation">)</span> <span class="token keyword">RENAME</span> <span class="token keyword">TO</span> <span class="token keyword">PARTITION</span> <span class="token punctuation">(</span>partition_key<span class="token operator">=</span><span class="token string">'new_partition_value'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><mark>注意</mark></p> 
<p>只会在元数据中修改，不会同步修改HDFS路径吗，如：</p> 
<ul><li>原分区路径为：<code>/user/hive/warehouse/test.db/test_table/month=201910</code>，分区名：<code>month='201910'</code></li><li>将分区名修改为：<code>201911</code>后，分区所在路径不变，依旧是：<code>/user/hive/warehouse/test.db/test_table/month=201910</code></li></ul> 
<p>如果希望修改分区名后，同步修改HDFS的路径，并保证正常可用，需要：</p> 
<ul><li>在元数据库中：<code>找到SDS表</code> -&gt; <code>找到LOCATION列</code> -&gt; <code>找到对应分区的路径记录进行修改</code> 
  <ul><li>如将记录的：<code>/user/hive/warehouse/test.db/test_table/month=201910</code> 修改为：<code>/user/hive/warehouse/test.db/test_table/month=201911</code></li></ul> </li><li>在HDFS中，同步修改文件夹名 
  <ul><li>如将文件夹：<code>/user/hive/warehouse/test.db/test_table/month=201910</code> 修改为：<code>/user/hive/warehouse/test.db/test_table/month=201911</code></li></ul> </li></ul> 
<p><strong>删除分区</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> tablename <span class="token keyword">DROP</span> <span class="token keyword">PARTITION</span> <span class="token punctuation">(</span>partition_key<span class="token operator">=</span><span class="token string">'partition_value'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>删除分区后，只是在元数据中删除，即删除元数据库中：</p> 
 <ul><li><code>PARTITION</code>表</li><li><code>SDS</code>表</li></ul> 
 <p>相关记录</p> 
 <p><mark>分区所在的HDFS文件夹依旧保留</mark></p> 
</blockquote> 
<p><strong>加载数据</strong></p> 
<p>LOAD DATA：从本地 or Hdfs</p> 
<pre><code class="prism language-sql"><span class="token keyword">LOAD</span> <span class="token keyword">DATA</span> <span class="token punctuation">[</span><span class="token keyword">LOCAL</span><span class="token punctuation">]</span> INPATH <span class="token string">'path'</span> <span class="token keyword">INTO</span> <span class="token keyword">TABLE</span> tbl <span class="token keyword">PARTITION</span><span class="token punctuation">(</span>partition_key<span class="token operator">=</span><span class="token string">'partition_value'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 注意，基于HDFS进行load加载数据，源数据文件会消失</span>
<span class="token comment">--（本质是被移动到表所在的目录中）</span>
</code></pre> 
<p>INSERT SELECT：从其他表中加载数据</p> 
<pre><code class="prism language-sql"><span class="token keyword">INSERT</span> <span class="token punctuation">(</span>OVERWRITE <span class="token operator">|</span> <span class="token keyword">INTO</span><span class="token punctuation">)</span> <span class="token keyword">TABLE</span> tbl <span class="token keyword">PARTITION</span><span class="token punctuation">(</span>partition_key<span class="token operator">=</span><span class="token string">'partition_value'</span><span class="token punctuation">)</span> <span class="token keyword">SELECT</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">FROM</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_302"></a>分桶操作</h4> 
<pre><code>分桶是将表拆分到固定数量的不同文件中进行存储
</code></pre> 
<p><strong>建表</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">set</span> hive<span class="token punctuation">.</span>enforce<span class="token punctuation">.</span>bucketing<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">--开启分桶自动优化</span>
<span class="token comment">-- 创建分桶表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> course <span class="token punctuation">(</span>c_id string<span class="token punctuation">,</span>c_name string<span class="token punctuation">,</span>t_id string<span class="token punctuation">)</span> 
	<span class="token punctuation">[</span><span class="token keyword">PARTITION</span><span class="token punctuation">(</span>partition_key<span class="token operator">=</span><span class="token string">'partition_value'</span><span class="token punctuation">)</span><span class="token punctuation">]</span> 
	<span class="token keyword">CLUSTERED</span> <span class="token keyword">BY</span><span class="token punctuation">(</span>c_id<span class="token punctuation">)</span> <span class="token keyword">INTO</span> <span class="token number">3</span> BUCKETS 
	<span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">'\t'</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li><code>CLUSTERED BY(col)</code> 指定分桶列</li><li><code>INTO 3 BUCKETS</code>，设定3个桶</li></ul> 
<blockquote> 
 <p>分桶表需要开启：</p> 
 <p><code>set hive.enforce.bucketing=true;</code></p> 
 <p>设置自动匹配桶数量的reduces task数量</p> 
</blockquote> 
<p><strong>分桶表能带来什么性能提升？</strong><br> 答：在基于分桶列做操作的前提下，单值过滤、Group by、join。</p> 
<p><strong>数据加载</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">INSERT</span> <span class="token punctuation">(</span>OVERWRITE <span class="token operator">|</span> <span class="token keyword">INTO</span><span class="token punctuation">)</span> <span class="token keyword">TABLE</span> tbl 
	<span class="token punctuation">[</span><span class="token keyword">PARTITION</span><span class="token punctuation">(</span>partition_key<span class="token operator">=</span><span class="token string">'partition_value'</span><span class="token punctuation">)</span><span class="token punctuation">]</span> 
	<span class="token keyword">SELECT</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">FROM</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> CLUSTER <span class="token keyword">BY</span><span class="token punctuation">(</span>col<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><mark>分桶表无法使用LOAD DATA进行数据加载</mark></p> 
<h4><a id="_343"></a>数据加载</h4> 
<p><strong>LOAD DATA</strong></p> 
<p>将数据文件加载到表</p> 
<pre><code class="prism language-sql"><span class="token keyword">LOAD</span> <span class="token keyword">DATA</span> <span class="token punctuation">[</span><span class="token keyword">LOCAL</span><span class="token punctuation">]</span> INPATH <span class="token string">'path'</span> <span class="token keyword">INTO</span> <span class="token keyword">TABLE</span> tbl <span class="token punctuation">[</span><span class="token keyword">PARTITION</span><span class="token punctuation">(</span>partition_key<span class="token operator">=</span><span class="token string">'partition_value'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">-- 指定分区可选</span>
</code></pre> 
<p><strong>INSERT SELECT</strong></p> 
<p>将其它表数据，加载到目标表</p> 
<pre><code class="prism language-sql"><span class="token keyword">INSERT</span> <span class="token punctuation">(</span>OVERWRITE <span class="token operator">|</span> <span class="token keyword">INTO</span><span class="token punctuation">)</span> <span class="token keyword">TABLE</span> tbl 
	<span class="token punctuation">[</span><span class="token keyword">PARTITION</span><span class="token punctuation">(</span>partition_key<span class="token operator">=</span><span class="token string">'partition_value'</span><span class="token punctuation">)</span><span class="token punctuation">]</span> 		<span class="token comment">-- 指定分区，可选</span>
	<span class="token keyword">SELECT</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">FROM</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">[</span>CLUSTER <span class="token keyword">BY</span><span class="token punctuation">(</span>col<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>				<span class="token comment">-- 指定分桶列，可选</span>

</code></pre> 
<h4><a id="_368"></a>数据导出</h4> 
<p><strong>INSERT OVERWRITE SELECT</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">INSERT</span> OVERWRITE <span class="token punctuation">[</span><span class="token keyword">LOCAL</span><span class="token punctuation">]</span> DIRECTORY ‘path’ 				<span class="token comment">-- LOCAL可选，带LOCAL导出Linux本地，不带LOCAL导出到HDFS</span>
	<span class="token punctuation">[</span><span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">''</span><span class="token punctuation">]</span>		<span class="token comment">-- 可选，自定义列分隔符</span>
	<span class="token keyword">SELECT</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">FROM</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
<span class="token comment">-- 将表中的数据导出到其他任意目录，例如linux本地磁盘，例如hdfs，例如mysql等等</span>
</code></pre> 
<p><strong>bin/hive</strong></p> 
<ul><li><code>bin/hive -e 'sql' &gt; export_file</code> 将<code>sql</code>结果重定向到导出文件中</li><li><code>bin/hive -f 'sql_script_file' &gt; export_file</code> 将<code>sql脚本</code>执行的结果重定向到导出文件中</li></ul> 
<h4><a id="_388"></a>复杂类型</h4> 
<table><thead><tr><th><strong>类型</strong></th><th><strong>定义</strong></th><th><strong>示例</strong></th><th><strong>内含元素类型</strong></th><th><strong>元素个数</strong></th><th><strong>取元素</strong></th><th><strong>可用函数</strong></th></tr></thead><tbody><tr><td>array</td><td>array&lt;类型&gt;</td><td>如定义为array数据为：1,2,3,4,5</td><td>单值，类型取决于定义</td><td>动态，不限制</td><td>array[数字序号] 序号从0开始</td><td>size统计元素个数 array_contains判断是否包含指定数据</td></tr><tr><td>map</td><td>map&lt;key类型, value类型&gt;</td><td>如定义为：map&lt;string, int&gt;数据为：{’a’: 1, ‘b’: 2, ‘c’: 3}</td><td>键值对，K-V，K和V类型取决于定义</td><td>动态，不限制</td><td>map[key] 取出对应key的value</td><td>size统计元素个数array_contains判断是否包含指定数据 map_keys取出全部key，返回array map_values取出全部values，返回array</td></tr><tr><td>struct</td><td>struct&lt;子列名 类型, 子列名 类型…&gt;</td><td>如定义为：struct&lt;c1 string, c2 int, c3 date&gt;数据为：’a’, 1, ‘2000-01-01’</td><td>单值，类型取决于定义</td><td>固定，取决于定义的子列数量</td><td>struct.子列名 通过子列名取出子列值</td><td>暂无</td></tr></tbody></table> 
<h3><a id="SQL_400"></a>数据查询的课堂SQL记录</h3> 
<h4><a id="_402"></a>基本查询</h4> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">database</span> itheima<span class="token punctuation">;</span>
<span class="token keyword">use</span> itheima<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> itheima<span class="token punctuation">.</span>orders <span class="token punctuation">(</span>
    orderId <span class="token keyword">bigint</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单id'</span><span class="token punctuation">,</span>
    orderNo string <span class="token keyword">COMMENT</span> <span class="token string">'订单编号'</span><span class="token punctuation">,</span>
    shopId <span class="token keyword">bigint</span> <span class="token keyword">COMMENT</span> <span class="token string">'门店id'</span><span class="token punctuation">,</span>
    userId <span class="token keyword">bigint</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户id'</span><span class="token punctuation">,</span>
    orderStatus <span class="token keyword">tinyint</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单状态 -3:用户拒收 -2:未付款的订单 -1：用户取消 0:待发货 1:配送中 2:用户确认收货'</span><span class="token punctuation">,</span>
    goodsMoney <span class="token keyword">double</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品金额'</span><span class="token punctuation">,</span>
    deliverMoney <span class="token keyword">double</span> <span class="token keyword">COMMENT</span> <span class="token string">'运费'</span><span class="token punctuation">,</span>
    totalMoney <span class="token keyword">double</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单金额（包括运费）'</span><span class="token punctuation">,</span>
    realTotalMoney <span class="token keyword">double</span> <span class="token keyword">COMMENT</span> <span class="token string">'实际订单金额（折扣后金额）'</span><span class="token punctuation">,</span>
    payType <span class="token keyword">tinyint</span> <span class="token keyword">COMMENT</span> <span class="token string">'支付方式,0:未知;1:支付宝，2：微信;3、现金；4、其他'</span><span class="token punctuation">,</span>
    isPay <span class="token keyword">tinyint</span> <span class="token keyword">COMMENT</span> <span class="token string">'是否支付 0:未支付 1:已支付'</span><span class="token punctuation">,</span>
    userName string <span class="token keyword">COMMENT</span> <span class="token string">'收件人姓名'</span><span class="token punctuation">,</span>
    userAddress string <span class="token keyword">COMMENT</span> <span class="token string">'收件人地址'</span><span class="token punctuation">,</span>
    userPhone string <span class="token keyword">COMMENT</span> <span class="token string">'收件人电话'</span><span class="token punctuation">,</span>
    createTime <span class="token keyword">timestamp</span> <span class="token keyword">COMMENT</span> <span class="token string">'下单时间'</span><span class="token punctuation">,</span>
    payTime <span class="token keyword">timestamp</span> <span class="token keyword">COMMENT</span> <span class="token string">'支付时间'</span><span class="token punctuation">,</span>
    totalPayFee <span class="token keyword">int</span> <span class="token keyword">COMMENT</span> <span class="token string">'总支付金额'</span>
<span class="token punctuation">)</span> <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">'\t'</span><span class="token punctuation">;</span>

<span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath <span class="token string">'/home/hadoop/itheima_orders.txt'</span> <span class="token keyword">into</span> <span class="token keyword">table</span> itheima<span class="token punctuation">.</span>orders<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> itheima<span class="token punctuation">.</span>users <span class="token punctuation">(</span>
    userId <span class="token keyword">int</span><span class="token punctuation">,</span>
    loginName string<span class="token punctuation">,</span>
    loginSecret <span class="token keyword">int</span><span class="token punctuation">,</span>
    loginPwd string<span class="token punctuation">,</span>
    userSex <span class="token keyword">tinyint</span><span class="token punctuation">,</span>
    userName string<span class="token punctuation">,</span>
    trueName string<span class="token punctuation">,</span>
    brithday <span class="token keyword">date</span><span class="token punctuation">,</span>
    userPhoto string<span class="token punctuation">,</span>
    userQQ string<span class="token punctuation">,</span>
    userPhone string<span class="token punctuation">,</span>
    userScore <span class="token keyword">int</span><span class="token punctuation">,</span>
    userTotalScore <span class="token keyword">int</span><span class="token punctuation">,</span>
    userFrom <span class="token keyword">tinyint</span><span class="token punctuation">,</span>
    userMoney <span class="token keyword">double</span><span class="token punctuation">,</span>
    lockMoney <span class="token keyword">double</span><span class="token punctuation">,</span>
    createTime <span class="token keyword">timestamp</span><span class="token punctuation">,</span>
    payPwd string<span class="token punctuation">,</span>
    rechargeMoney <span class="token keyword">double</span>
<span class="token punctuation">)</span> <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">'\t'</span><span class="token punctuation">;</span>

<span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath <span class="token string">'/home/hadoop/itheima_users.txt'</span> <span class="token keyword">into</span> <span class="token keyword">table</span> itheima<span class="token punctuation">.</span>users<span class="token punctuation">;</span>

<span class="token comment">-- 查询全表数据</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> itheima<span class="token punctuation">.</span>orders<span class="token punctuation">;</span>

<span class="token comment">-- 查询单列信息</span>
<span class="token keyword">SELECT</span> orderid<span class="token punctuation">,</span> userid<span class="token punctuation">,</span> totalmoney <span class="token keyword">FROM</span> itheima<span class="token punctuation">.</span>orders o <span class="token punctuation">;</span>

<span class="token comment">-- 查询表有多少条数据</span>
<span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> itheima<span class="token punctuation">.</span>orders<span class="token punctuation">;</span>

<span class="token comment">-- 过滤广东省的订单</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> itheima<span class="token punctuation">.</span>orders <span class="token keyword">WHERE</span> useraddress <span class="token operator">LIKE</span> <span class="token string">'%广东%'</span><span class="token punctuation">;</span>

<span class="token comment">-- 找出广东省单笔营业额最大的订单</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> itheima<span class="token punctuation">.</span>orders <span class="token keyword">WHERE</span> useraddress <span class="token operator">LIKE</span> <span class="token string">'%广东%'</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> totalmoney <span class="token keyword">DESC</span> <span class="token keyword">LIMIT</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token comment">-- 统计未支付、已支付各自的人数</span>
<span class="token keyword">SELECT</span> ispay<span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> itheima<span class="token punctuation">.</span>orders o <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> ispay <span class="token punctuation">;</span>

<span class="token comment">-- 在已付款的订单中，统计每个用户最高的一笔消费金额</span>
<span class="token keyword">SELECT</span> userid<span class="token punctuation">,</span> <span class="token function">MAX</span><span class="token punctuation">(</span>totalmoney<span class="token punctuation">)</span> <span class="token keyword">FROM</span> itheima<span class="token punctuation">.</span>orders <span class="token keyword">WHERE</span> ispay <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> userid<span class="token punctuation">;</span>
<span class="token comment">-- 统计每个用户的平均订单消费额</span>
<span class="token keyword">SELECT</span> userid<span class="token punctuation">,</span> <span class="token function">AVG</span><span class="token punctuation">(</span>totalmoney<span class="token punctuation">)</span> <span class="token keyword">FROM</span> itheima<span class="token punctuation">.</span>orders <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> userid<span class="token punctuation">;</span>
<span class="token comment">-- 统计每个用户的平均订单消费额，并过滤大于10000的数据</span>
<span class="token keyword">SELECT</span> userid<span class="token punctuation">,</span> <span class="token function">AVG</span><span class="token punctuation">(</span>totalmoney<span class="token punctuation">)</span> <span class="token keyword">AS</span> avg_money <span class="token keyword">FROM</span> itheima<span class="token punctuation">.</span>orders <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> userid <span class="token keyword">HAVING</span> avg_money <span class="token operator">&gt;</span> <span class="token number">10000</span><span class="token punctuation">;</span>

<span class="token comment">-- 订单表和用户表JOIN 找出用户username</span>
<span class="token keyword">SELECT</span> o<span class="token punctuation">.</span>orderid<span class="token punctuation">,</span> o<span class="token punctuation">.</span>userid<span class="token punctuation">,</span> u<span class="token punctuation">.</span>username <span class="token keyword">FROM</span> itheima<span class="token punctuation">.</span>orders o <span class="token keyword">JOIN</span> itheima<span class="token punctuation">.</span>users u <span class="token keyword">ON</span> o<span class="token punctuation">.</span>userid <span class="token operator">=</span> u<span class="token punctuation">.</span>userid<span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> o<span class="token punctuation">.</span>orderid<span class="token punctuation">,</span> o<span class="token punctuation">.</span>userid<span class="token punctuation">,</span> u<span class="token punctuation">.</span>username <span class="token keyword">FROM</span> itheima<span class="token punctuation">.</span>orders o <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> itheima<span class="token punctuation">.</span>users u <span class="token keyword">ON</span> o<span class="token punctuation">.</span>userid <span class="token operator">=</span> u<span class="token punctuation">.</span>userid<span class="token punctuation">;</span>

</code></pre> 
<h4><a id="RLIKE_487"></a>RLIKE</h4> 
<p><img src="https://images2.imgbox.com/d0/32/AMcqH6mU_o.png" alt="image-20230224234706719"></p> 
<p><img src="https://images2.imgbox.com/d4/d9/m8Na0nCM_o.png" alt="image-20230224234719463"></p> 
<p><img src="https://images2.imgbox.com/f6/b7/kkxXBZWX_o.png" alt="image-20230224234733895"></p> 
<pre><code class="prism language-sql"><span class="token comment">-- 查找广东省数据</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> itheima<span class="token punctuation">.</span>orders <span class="token keyword">WHERE</span> useraddress <span class="token operator">RLIKE</span> <span class="token string">'.*广东.*'</span><span class="token punctuation">;</span>
<span class="token comment">-- 查找用户地址是：xx省 xx市 xx区</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> itheima<span class="token punctuation">.</span>orders <span class="token keyword">WHERE</span> useraddress <span class="token operator">RLIKE</span> <span class="token string">'..省 ..市 ..区'</span><span class="token punctuation">;</span>
<span class="token comment">-- 查找用户姓为：张、王、邓</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> itheima<span class="token punctuation">.</span>orders <span class="token keyword">WHERE</span> username <span class="token operator">RLIKE</span> <span class="token string">'[张王邓]\\S+'</span><span class="token punctuation">;</span>
<span class="token comment">-- 查找手机号符合：188****0*** 规则</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> itheima<span class="token punctuation">.</span>orders <span class="token keyword">WHERE</span> userphone <span class="token operator">RLIKE</span> <span class="token string">'188\\S{4}0[0-9]{3}'</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="UNION_512"></a>UNION联合</h4> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> itheima<span class="token punctuation">.</span>course<span class="token punctuation">(</span>
c_id string<span class="token punctuation">,</span> 
c_name string<span class="token punctuation">,</span> 
t_id string<span class="token punctuation">)</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">'\t'</span><span class="token punctuation">;</span>

<span class="token keyword">LOAD</span> <span class="token keyword">DATA</span> <span class="token keyword">LOCAL</span> INPATH <span class="token string">'/home/hadoop/course.txt'</span> <span class="token keyword">INTO</span> <span class="token keyword">TABLE</span> itheima<span class="token punctuation">.</span>course<span class="token punctuation">;</span>
<span class="token comment">-- 基础UNION</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> itheima<span class="token punctuation">.</span>course <span class="token keyword">WHERE</span> t_id <span class="token operator">=</span> <span class="token string">'周杰轮'</span>
	<span class="token keyword">UNION</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> itheima<span class="token punctuation">.</span>course <span class="token keyword">WHERE</span> t_id <span class="token operator">=</span> <span class="token string">'王力鸿'</span><span class="token punctuation">;</span>
<span class="token comment">-- 去重演示</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> itheima<span class="token punctuation">.</span>course
	<span class="token keyword">UNION</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> itheima<span class="token punctuation">.</span>course<span class="token punctuation">;</span>
<span class="token comment">-- 不去重</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> itheima<span class="token punctuation">.</span>course
	<span class="token keyword">UNION</span> <span class="token keyword">ALL</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> itheima<span class="token punctuation">.</span>course<span class="token punctuation">;</span>
<span class="token comment">-- UNION写在FROM中 UNION写在子查询中</span>
<span class="token keyword">SELECT</span> t_id<span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> 
<span class="token punctuation">(</span>
	<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> itheima<span class="token punctuation">.</span>course <span class="token keyword">WHERE</span> t_id <span class="token operator">=</span> <span class="token string">'周杰轮'</span>
		<span class="token keyword">UNION</span> <span class="token keyword">ALL</span>
	<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> itheima<span class="token punctuation">.</span>course <span class="token keyword">WHERE</span> t_id <span class="token operator">=</span> <span class="token string">'王力鸿'</span> 
<span class="token punctuation">)</span> <span class="token keyword">AS</span> u <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> t_id<span class="token punctuation">;</span>

<span class="token comment">-- 用于INSERT SELECT</span>
<span class="token keyword">INSERT</span> OVERWRITE <span class="token keyword">TABLE</span> itheima<span class="token punctuation">.</span>course2
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> itheima<span class="token punctuation">.</span>course 
	<span class="token keyword">UNION</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> itheima<span class="token punctuation">.</span>course<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="Sampling_553"></a>Sampling采样</h4> 
<pre><code class="prism language-sql"><span class="token comment"># 随机桶抽取， 分配桶是有规则的</span>
<span class="token comment"># 可以按照列的hash取模分桶</span>
<span class="token comment"># 按照完全随机分桶</span>
<span class="token comment">-- 其它条件不变的话，每一次运行结果一致</span>
<span class="token keyword">select</span> username<span class="token punctuation">,</span> orderId<span class="token punctuation">,</span> totalmoney <span class="token keyword">FROM</span> itheima<span class="token punctuation">.</span>orders 
	tablesample<span class="token punctuation">(</span>bucket <span class="token number">3</span> <span class="token keyword">out</span> <span class="token keyword">of</span> <span class="token number">10</span> <span class="token keyword">on</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
<span class="token comment">-- 完全随机，每一次运行结果不同</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> itheima<span class="token punctuation">.</span>orders 
	tablesample<span class="token punctuation">(</span>bucket <span class="token number">3</span> <span class="token keyword">out</span> <span class="token keyword">of</span> <span class="token number">10</span> <span class="token keyword">on</span> rand<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	


<span class="token comment"># 数据块抽取，按顺序抽取，每次条件不变，抽取结果不变</span>
<span class="token comment">-- 抽取100条</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> itheima<span class="token punctuation">.</span>orders
	tablesample<span class="token punctuation">(</span><span class="token number">100</span> <span class="token keyword">rows</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
<span class="token comment">-- 取1%数据</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> itheima<span class="token punctuation">.</span>orders
	tablesample<span class="token punctuation">(</span><span class="token number">1</span> <span class="token keyword">percent</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
<span class="token comment">-- 取 1KB数据</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> itheima<span class="token punctuation">.</span>orders
	tablesample<span class="token punctuation">(</span><span class="token number">1</span>K<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<h4><a id="_588"></a>虚拟列</h4> 
<p>虚拟列是Hive内置的可以在查询语句中使用的特殊标记，可以查询数据本身的详细参数。</p> 
<p>Hive目前可用3个虚拟列：</p> 
<pre><code class="prism language-shell">- INPUT__FILE__NAME，显示数据行所在的具体文件
- BLOCK__OFFSET__INSIDE__FILE，显示数据行所在文件的偏移量
- ROW__OFFSET__INSIDE__BLOCK，显示数据所在HDFS块的偏移量
  此虚拟列需要设置：SET hive.exec.rowoffset<span class="token operator">=</span>true 才可使用
</code></pre> 
<pre><code class="prism language-sql"><span class="token keyword">SET</span> hive<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">.</span>rowoffset<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> orderid<span class="token punctuation">,</span> username<span class="token punctuation">,</span> INPUT__FILE__NAME<span class="token punctuation">,</span> BLOCK__OFFSET__INSIDE__FILE<span class="token punctuation">,</span> ROW__OFFSET__INSIDE__BLOCK <span class="token keyword">FROM</span> itheima<span class="token punctuation">.</span>orders<span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> <span class="token operator">*</span><span class="token punctuation">,</span> BLOCK__OFFSET__INSIDE__FILE <span class="token keyword">FROM</span> itheima<span class="token punctuation">.</span>orders <span class="token keyword">WHERE</span> BLOCK__OFFSET__INSIDE__FILE <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> orderid<span class="token punctuation">,</span> username<span class="token punctuation">,</span> INPUT__FILE__NAME<span class="token punctuation">,</span> BLOCK__OFFSET__INSIDE__FILE<span class="token punctuation">,</span> ROW__OFFSET__INSIDE__BLOCK <span class="token keyword">FROM</span> itheima<span class="token punctuation">.</span>orders_bucket<span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> INPUT__FILE__NAME<span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> itheima<span class="token punctuation">.</span>orders_bucket <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> INPUT__FILE__NAME<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_619"></a>函数</h4> 
<p>数值、集合、转换、日期函数</p> 
<pre><code class="prism language-sql"><span class="token comment">-- 查看所有可用函数</span>
<span class="token keyword">show</span> functions<span class="token punctuation">;</span>
<span class="token comment">-- 查看函数使用方式</span>
<span class="token keyword">describe</span> <span class="token keyword">function</span> <span class="token keyword">extended</span> count<span class="token punctuation">;</span>
<span class="token comment">-- 数值函数</span>
<span class="token comment">-- round 取整，设置小数精度</span>
<span class="token keyword">select</span> <span class="token function">round</span><span class="token punctuation">(</span><span class="token number">3.1415926</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">-- 取整(四舍五入)</span>
<span class="token keyword">select</span> <span class="token function">round</span><span class="token punctuation">(</span><span class="token number">3.1415926</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">-- 设置小数精度4位(四舍五入)</span>
<span class="token comment">-- 随机数</span>
<span class="token keyword">select</span> rand<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>					<span class="token comment">-- 完全随机</span>
<span class="token keyword">select</span> rand<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>					<span class="token comment">-- 设置随机数种子，设置种子后每次运行结果一致的</span>
<span class="token comment">-- 绝对值</span>
<span class="token keyword">select</span> abs<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 求PI</span>
<span class="token keyword">select</span> pi<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 集合函数</span>
<span class="token comment">-- 求元素个数</span>
<span class="token keyword">select</span> size<span class="token punctuation">(</span>work_locations<span class="token punctuation">)</span> <span class="token keyword">from</span> test_array<span class="token punctuation">;</span>
<span class="token keyword">select</span> size<span class="token punctuation">(</span>members<span class="token punctuation">)</span> <span class="token keyword">from</span> test_map<span class="token punctuation">;</span>
<span class="token comment">-- 取出map的全部key</span>
<span class="token keyword">select</span> map_keys<span class="token punctuation">(</span>members<span class="token punctuation">)</span> <span class="token keyword">from</span> test_map<span class="token punctuation">;</span>
<span class="token comment">-- 取出map的全部value</span>
<span class="token keyword">select</span> map_values<span class="token punctuation">(</span>members<span class="token punctuation">)</span> <span class="token keyword">from</span> test_map<span class="token punctuation">;</span>
<span class="token comment">-- 查询array内是否包含指定元素，是就返回True</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test_array <span class="token keyword">where</span> ARRAY_CONTAINS<span class="token punctuation">(</span>work_locations<span class="token punctuation">,</span> <span class="token string">'tianjin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 排序</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span> sort_array<span class="token punctuation">(</span>work_locations<span class="token punctuation">)</span> <span class="token keyword">from</span> test_array<span class="token punctuation">;</span>


<span class="token comment">-- 类型转换函数</span>
<span class="token comment">-- 转二进制</span>
<span class="token keyword">select</span> <span class="token keyword">binary</span><span class="token punctuation">(</span><span class="token string">'hadoop'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 自由转换，类型转换失败报错或返回NULL</span>
<span class="token keyword">select</span> cast<span class="token punctuation">(</span><span class="token string">'1'</span> <span class="token keyword">as</span> <span class="token keyword">bigint</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 日期函数</span>
<span class="token comment">-- 当前时间戳</span>
<span class="token keyword">select</span> <span class="token keyword">current_timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 当前日期</span>
<span class="token keyword">select</span> <span class="token keyword">current_date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 时间戳转日期</span>
<span class="token keyword">select</span> to_date<span class="token punctuation">(</span><span class="token keyword">current_timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 年月日季度等</span>
<span class="token keyword">select</span> <span class="token keyword">year</span><span class="token punctuation">(</span><span class="token string">'2020-01-11'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token keyword">month</span><span class="token punctuation">(</span><span class="token string">'2020-01-11'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token keyword">day</span><span class="token punctuation">(</span><span class="token string">'2020-01-11'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> quarter<span class="token punctuation">(</span><span class="token string">'2020-05-11'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> dayofmonth<span class="token punctuation">(</span><span class="token string">'2020-05-11'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token keyword">hour</span><span class="token punctuation">(</span><span class="token string">'2020-05-11 10:36:59'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token keyword">minute</span><span class="token punctuation">(</span><span class="token string">'2020-05-11 10:36:59'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token keyword">second</span><span class="token punctuation">(</span><span class="token string">'2020-05-11 10:36:59'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> weekofyear<span class="token punctuation">(</span><span class="token string">'2020-05-11 10:36:59'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 日期之间的天数</span>
<span class="token keyword">select</span> datediff<span class="token punctuation">(</span><span class="token string">'2022-12-31'</span><span class="token punctuation">,</span> <span class="token string">'2019-12-31'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 日期相加、相减</span>
<span class="token keyword">select</span> date_add<span class="token punctuation">(</span><span class="token string">'2022-12-31'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> date_sub<span class="token punctuation">(</span><span class="token string">'2022-12-31'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<h3><a id="SQL_689"></a>社交案例操作SQL</h3> 
<p>准备数据</p> 
<pre><code class="prism language-sql"><span class="token comment">-- 创建数据库</span>
<span class="token keyword">create</span> <span class="token keyword">database</span> db_msg<span class="token punctuation">;</span>
<span class="token comment">-- 选择数据库</span>
<span class="token keyword">use</span> db_msg<span class="token punctuation">;</span>

<span class="token comment">-- 如果表已存在就删除</span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> db_msg<span class="token punctuation">.</span>tb_msg_source <span class="token punctuation">;</span>
<span class="token comment">-- 建表</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> db_msg<span class="token punctuation">.</span>tb_msg_source<span class="token punctuation">(</span>
    msg_time string <span class="token keyword">comment</span> <span class="token string">"消息发送时间"</span><span class="token punctuation">,</span>
    sender_name string <span class="token keyword">comment</span> <span class="token string">"发送人昵称"</span><span class="token punctuation">,</span>
    sender_account string <span class="token keyword">comment</span> <span class="token string">"发送人账号"</span><span class="token punctuation">,</span>
    sender_sex string <span class="token keyword">comment</span> <span class="token string">"发送人性别"</span><span class="token punctuation">,</span>
    sender_ip string <span class="token keyword">comment</span> <span class="token string">"发送人ip地址"</span><span class="token punctuation">,</span>
    sender_os string <span class="token keyword">comment</span> <span class="token string">"发送人操作系统"</span><span class="token punctuation">,</span>
    sender_phonetype string <span class="token keyword">comment</span> <span class="token string">"发送人手机型号"</span><span class="token punctuation">,</span>
    sender_network string <span class="token keyword">comment</span> <span class="token string">"发送人网络类型"</span><span class="token punctuation">,</span>
    sender_gps string <span class="token keyword">comment</span> <span class="token string">"发送人的GPS定位"</span><span class="token punctuation">,</span>
    receiver_name string <span class="token keyword">comment</span> <span class="token string">"接收人昵称"</span><span class="token punctuation">,</span>
    receiver_ip string <span class="token keyword">comment</span> <span class="token string">"接收人IP"</span><span class="token punctuation">,</span>
    receiver_account string <span class="token keyword">comment</span> <span class="token string">"接收人账号"</span><span class="token punctuation">,</span>
    receiver_os string <span class="token keyword">comment</span> <span class="token string">"接收人操作系统"</span><span class="token punctuation">,</span>
    receiver_phonetype string <span class="token keyword">comment</span> <span class="token string">"接收人手机型号"</span><span class="token punctuation">,</span>
    receiver_network string <span class="token keyword">comment</span> <span class="token string">"接收人网络类型"</span><span class="token punctuation">,</span>
    receiver_gps string <span class="token keyword">comment</span> <span class="token string">"接收人的GPS定位"</span><span class="token punctuation">,</span>
    receiver_sex string <span class="token keyword">comment</span> <span class="token string">"接收人性别"</span><span class="token punctuation">,</span>
    msg_type string <span class="token keyword">comment</span> <span class="token string">"消息类型"</span><span class="token punctuation">,</span>
    distance string <span class="token keyword">comment</span> <span class="token string">"双方距离"</span><span class="token punctuation">,</span>
    message string <span class="token keyword">comment</span> <span class="token string">"消息内容"</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 上传数据到HDFS(Linux命令)</span>
hadoop fs <span class="token operator">-</span>mkdir <span class="token operator">-</span>p <span class="token operator">/</span>chatdemo<span class="token operator">/</span><span class="token keyword">data</span>
hadoop fs <span class="token operator">-</span>put chat_data<span class="token operator">-</span><span class="token number">30</span>W<span class="token punctuation">.</span>csv <span class="token operator">/</span>chatdemo<span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>

<span class="token comment">-- 加载数据到表中，基于HDFS加载</span>
<span class="token keyword">load</span> <span class="token keyword">data</span> inpath <span class="token string">'/chatdemo/data/chat_data-30W.csv'</span> <span class="token keyword">into</span> <span class="token keyword">table</span> tb_msg_source<span class="token punctuation">;</span>

<span class="token comment">-- 验证数据加载</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tb_msg_source tablesample<span class="token punctuation">(</span><span class="token number">100</span> <span class="token keyword">rows</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 验证一下表的数量</span>
<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> tb_msg_source<span class="token punctuation">;</span>
</code></pre> 
<p>ETL清洗转换</p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> db_msg<span class="token punctuation">.</span>tb_msg_etl<span class="token punctuation">(</span>
    msg_time string <span class="token keyword">comment</span> <span class="token string">"消息发送时间"</span><span class="token punctuation">,</span>
    sender_name string <span class="token keyword">comment</span> <span class="token string">"发送人昵称"</span><span class="token punctuation">,</span>
    sender_account string <span class="token keyword">comment</span> <span class="token string">"发送人账号"</span><span class="token punctuation">,</span>
    sender_sex string <span class="token keyword">comment</span> <span class="token string">"发送人性别"</span><span class="token punctuation">,</span>
    sender_ip string <span class="token keyword">comment</span> <span class="token string">"发送人ip地址"</span><span class="token punctuation">,</span>
    sender_os string <span class="token keyword">comment</span> <span class="token string">"发送人操作系统"</span><span class="token punctuation">,</span>
    sender_phonetype string <span class="token keyword">comment</span> <span class="token string">"发送人手机型号"</span><span class="token punctuation">,</span>
    sender_network string <span class="token keyword">comment</span> <span class="token string">"发送人网络类型"</span><span class="token punctuation">,</span>
    sender_gps string <span class="token keyword">comment</span> <span class="token string">"发送人的GPS定位"</span><span class="token punctuation">,</span>
    receiver_name string <span class="token keyword">comment</span> <span class="token string">"接收人昵称"</span><span class="token punctuation">,</span>
    receiver_ip string <span class="token keyword">comment</span> <span class="token string">"接收人IP"</span><span class="token punctuation">,</span>
    receiver_account string <span class="token keyword">comment</span> <span class="token string">"接收人账号"</span><span class="token punctuation">,</span>
    receiver_os string <span class="token keyword">comment</span> <span class="token string">"接收人操作系统"</span><span class="token punctuation">,</span>
    receiver_phonetype string <span class="token keyword">comment</span> <span class="token string">"接收人手机型号"</span><span class="token punctuation">,</span>
    receiver_network string <span class="token keyword">comment</span> <span class="token string">"接收人网络类型"</span><span class="token punctuation">,</span>
    receiver_gps string <span class="token keyword">comment</span> <span class="token string">"接收人的GPS定位"</span><span class="token punctuation">,</span>
    receiver_sex string <span class="token keyword">comment</span> <span class="token string">"接收人性别"</span><span class="token punctuation">,</span>
    msg_type string <span class="token keyword">comment</span> <span class="token string">"消息类型"</span><span class="token punctuation">,</span>
    distance string <span class="token keyword">comment</span> <span class="token string">"双方距离"</span><span class="token punctuation">,</span>
    message string <span class="token keyword">comment</span> <span class="token string">"消息内容"</span><span class="token punctuation">,</span>
    msg_day string <span class="token keyword">comment</span> <span class="token string">"消息日"</span><span class="token punctuation">,</span>
    msg_hour string <span class="token keyword">comment</span> <span class="token string">"消息小时"</span><span class="token punctuation">,</span>
    sender_lng <span class="token keyword">double</span> <span class="token keyword">comment</span> <span class="token string">"经度"</span><span class="token punctuation">,</span>
    sender_lat <span class="token keyword">double</span> <span class="token keyword">comment</span> <span class="token string">"纬度"</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> OVERWRITE <span class="token keyword">TABLE</span> db_msg<span class="token punctuation">.</span>tb_msg_etl
<span class="token keyword">SELECT</span> 
	<span class="token operator">*</span><span class="token punctuation">,</span> 
	<span class="token keyword">DATE</span><span class="token punctuation">(</span>msg_time<span class="token punctuation">)</span> <span class="token keyword">AS</span> msg_day<span class="token punctuation">,</span> 
	<span class="token keyword">HOUR</span><span class="token punctuation">(</span>msg_time<span class="token punctuation">)</span> <span class="token keyword">AS</span> msg_hour<span class="token punctuation">,</span> 
	SPLIT<span class="token punctuation">(</span>sender_gps<span class="token punctuation">,</span> <span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">AS</span> sender_lng<span class="token punctuation">,</span> 
	SPLIT<span class="token punctuation">(</span>sender_gps<span class="token punctuation">,</span> <span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">AS</span> sender_lat
<span class="token keyword">FROM</span> db_msg<span class="token punctuation">.</span>tb_msg_source
<span class="token keyword">WHERE</span> LENGTH<span class="token punctuation">(</span>sender_gps<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre> 
<p>指标计算</p> 
<p>需求1</p> 
<pre><code class="prism language-sql"><span class="token comment">--保存结果表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> tb_rs_total_msg_cnt 
<span class="token keyword">COMMENT</span> <span class="token string">"每日消息总量"</span> <span class="token keyword">AS</span> 
<span class="token keyword">SELECT</span> 
    msg_day<span class="token punctuation">,</span> 
    <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> total_msg_cnt 
<span class="token keyword">FROM</span> db_msg<span class="token punctuation">.</span>tb_msg_etl 
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> msg_day<span class="token punctuation">;</span>
</code></pre> 
<p>需求2</p> 
<pre><code class="prism language-sql"><span class="token comment">--保存结果表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> tb_rs_hour_msg_cnt 
<span class="token keyword">COMMENT</span> <span class="token string">"每小时消息量趋势"</span> <span class="token keyword">AS</span>  
<span class="token keyword">SELECT</span>  
    msg_hour<span class="token punctuation">,</span> 
    <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> total_msg_cnt<span class="token punctuation">,</span> 
    <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> sender_account<span class="token punctuation">)</span> <span class="token keyword">AS</span> sender_user_cnt<span class="token punctuation">,</span> 
    <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> receiver_account<span class="token punctuation">)</span> <span class="token keyword">AS</span> receiver_user_cnt
<span class="token keyword">FROM</span> db_msg<span class="token punctuation">.</span>tb_msg_etl <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> msg_hour<span class="token punctuation">;</span>
</code></pre> 
<p>需求3</p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> tb_rs_loc_cnt
<span class="token keyword">COMMENT</span> <span class="token string">'今日各地区发送消息总量'</span> <span class="token keyword">AS</span> 
<span class="token keyword">SELECT</span> 
    msg_day<span class="token punctuation">,</span>  
    sender_lng<span class="token punctuation">,</span> 
    sender_lat<span class="token punctuation">,</span> 
    <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> total_msg_cnt 
<span class="token keyword">FROM</span> db_msg<span class="token punctuation">.</span>tb_msg_etl
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> msg_day<span class="token punctuation">,</span> sender_lng<span class="token punctuation">,</span> sender_lat<span class="token punctuation">;</span>
</code></pre> 
<p>需求4</p> 
<pre><code class="prism language-sql"><span class="token comment">--保存结果表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> tb_rs_user_cnt
<span class="token keyword">COMMENT</span> <span class="token string">"今日发送消息人数、接受消息人数"</span> <span class="token keyword">AS</span>
<span class="token keyword">SELECT</span> 
msg_day<span class="token punctuation">,</span> 
<span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> sender_account<span class="token punctuation">)</span> <span class="token keyword">AS</span> sender_user_cnt<span class="token punctuation">,</span> 
<span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> receiver_account<span class="token punctuation">)</span> <span class="token keyword">AS</span> receiver_user_cnt
<span class="token keyword">FROM</span> db_msg<span class="token punctuation">.</span>tb_msg_etl
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> msg_day<span class="token punctuation">;</span>
</code></pre> 
<p>需求5</p> 
<pre><code class="prism language-sql"><span class="token comment">--保存结果表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> db_msg<span class="token punctuation">.</span>tb_rs_s_user_top10
<span class="token keyword">COMMENT</span> <span class="token string">"发送消息条数最多的Top10用户"</span> <span class="token keyword">AS</span>
<span class="token keyword">SELECT</span> 
    sender_name <span class="token keyword">AS</span> username<span class="token punctuation">,</span> 
    <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> sender_msg_cnt 
<span class="token keyword">FROM</span> db_msg<span class="token punctuation">.</span>tb_msg_etl 
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> sender_name 
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> sender_msg_cnt <span class="token keyword">DESC</span> 
<span class="token keyword">LIMIT</span> <span class="token number">10</span><span class="token punctuation">;</span>
</code></pre> 
<p>需求6</p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> db_msg<span class="token punctuation">.</span>tb_rs_r_user_top10
<span class="token keyword">COMMENT</span> <span class="token string">"接收消息条数最多的Top10用户"</span> <span class="token keyword">AS</span>
<span class="token keyword">SELECT</span> 
receiver_name <span class="token keyword">AS</span> username<span class="token punctuation">,</span> 
<span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> receiver_msg_cnt 
<span class="token keyword">FROM</span> db_msg<span class="token punctuation">.</span>tb_msg_etl 
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> receiver_name 
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> receiver_msg_cnt <span class="token keyword">DESC</span> 
<span class="token keyword">LIMIT</span> <span class="token number">10</span><span class="token punctuation">;</span>
</code></pre> 
<p>需求7</p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> db_msg<span class="token punctuation">.</span>tb_rs_sender_phone
<span class="token keyword">COMMENT</span> <span class="token string">"发送人的手机型号分布"</span> <span class="token keyword">AS</span>
<span class="token keyword">SELECT</span> 
    sender_phonetype<span class="token punctuation">,</span> 
    <span class="token function">COUNT</span><span class="token punctuation">(</span>sender_account<span class="token punctuation">)</span> <span class="token keyword">AS</span> cnt 
<span class="token keyword">FROM</span> db_msg<span class="token punctuation">.</span>tb_msg_etl 
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> sender_phonetype<span class="token punctuation">;</span>
</code></pre> 
<p>需求8</p> 
<pre><code class="prism language-sql"><span class="token comment">--保存结果表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> db_msg<span class="token punctuation">.</span>tb_rs_sender_os
<span class="token keyword">COMMENT</span> <span class="token string">"发送人的OS分布"</span> <span class="token keyword">AS</span>
<span class="token keyword">SELECT</span>
    sender_os<span class="token punctuation">,</span> 
    <span class="token function">COUNT</span><span class="token punctuation">(</span>sender_account<span class="token punctuation">)</span> <span class="token keyword">AS</span> cnt 
<span class="token keyword">FROM</span> db_msg<span class="token punctuation">.</span>tb_msg_etl 
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> sender_os
</code></pre> 
<h3><a id="Hive_926"></a>Hive列注释、表注释等乱码解决方案</h3> 
<pre><code class="prism language-sql"><span class="token comment">-- 在Hive的MySQL元数据库中执行</span>
<span class="token keyword">use</span> hive<span class="token punctuation">;</span>

<span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>修改字段注释字符集

<span class="token keyword">alter</span> <span class="token keyword">table</span> COLUMNS_V2 <span class="token keyword">modify</span> <span class="token keyword">column</span> <span class="token keyword">COMMENT</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">character</span> <span class="token keyword">set</span> utf8<span class="token punctuation">;</span>
<span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>修改表注释字符集

<span class="token keyword">alter</span> <span class="token keyword">table</span> TABLE_PARAMS <span class="token keyword">modify</span> <span class="token keyword">column</span> PARAM_VALUE <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span> <span class="token keyword">character</span> <span class="token keyword">set</span> utf8<span class="token punctuation">;</span>
<span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span>修改分区表参数，以支持分区键能够用中文表示

<span class="token keyword">alter</span> <span class="token keyword">table</span> PARTITION_PARAMS <span class="token keyword">modify</span> <span class="token keyword">column</span> PARAM_VALUE <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span> <span class="token keyword">character</span> <span class="token keyword">set</span> utf8<span class="token punctuation">;</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> PARTITION_KEYS <span class="token keyword">modify</span> <span class="token keyword">column</span> PKEY_COMMENT <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span> <span class="token keyword">character</span> <span class="token keyword">set</span> utf8<span class="token punctuation">;</span>
<span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span>修改索引注解

mysql<span class="token operator">&gt;</span><span class="token keyword">alter</span> <span class="token keyword">table</span> INDEX_PARAMS <span class="token keyword">modify</span> <span class="token keyword">column</span> PARAM_VALUE <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span> <span class="token keyword">character</span> <span class="token keyword">set</span> utf8<span class="token punctuation">;</span>
</code></pre> 
<p>COUNT(sender_account) AS cnt<br> FROM db_msg.tb_msg_etl<br> GROUP BY sender_phonetype;</p> 
<pre><code>






需求8

```sql
--保存结果表
CREATE TABLE IF NOT EXISTS db_msg.tb_rs_sender_os
COMMENT "发送人的OS分布" AS
SELECT
    sender_os, 
    COUNT(sender_account) AS cnt 
FROM db_msg.tb_msg_etl 
GROUP BY sender_os
</code></pre> 
<h3><a id="Hive_993"></a>Hive列注释、表注释等乱码解决方案</h3> 
<pre><code class="prism language-sql"><span class="token comment">-- 在Hive的MySQL元数据库中执行</span>
<span class="token keyword">use</span> hive<span class="token punctuation">;</span>

<span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>修改字段注释字符集

<span class="token keyword">alter</span> <span class="token keyword">table</span> COLUMNS_V2 <span class="token keyword">modify</span> <span class="token keyword">column</span> <span class="token keyword">COMMENT</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">character</span> <span class="token keyword">set</span> utf8<span class="token punctuation">;</span>
<span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>修改表注释字符集

<span class="token keyword">alter</span> <span class="token keyword">table</span> TABLE_PARAMS <span class="token keyword">modify</span> <span class="token keyword">column</span> PARAM_VALUE <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span> <span class="token keyword">character</span> <span class="token keyword">set</span> utf8<span class="token punctuation">;</span>
<span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span>修改分区表参数，以支持分区键能够用中文表示

<span class="token keyword">alter</span> <span class="token keyword">table</span> PARTITION_PARAMS <span class="token keyword">modify</span> <span class="token keyword">column</span> PARAM_VALUE <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span> <span class="token keyword">character</span> <span class="token keyword">set</span> utf8<span class="token punctuation">;</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> PARTITION_KEYS <span class="token keyword">modify</span> <span class="token keyword">column</span> PKEY_COMMENT <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span> <span class="token keyword">character</span> <span class="token keyword">set</span> utf8<span class="token punctuation">;</span>
<span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span>修改索引注解

mysql<span class="token operator">&gt;</span><span class="token keyword">alter</span> <span class="token keyword">table</span> INDEX_PARAMS <span class="token keyword">modify</span> <span class="token keyword">column</span> PARAM_VALUE <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span> <span class="token keyword">character</span> <span class="token keyword">set</span> utf8<span class="token punctuation">;</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/30b2c204235e8cb3bfe671e15e48f1ac/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">NQA测试机制—UDP Jitter测试</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/15dbd57c74cdf3ab48a7d34b65184591/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">回调函数(callback)是什么？（*****）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>