<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Resnet152对102种花朵图像分类（PyTorch，迁移学习） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Resnet152对102种花朵图像分类（PyTorch，迁移学习）" />
<meta property="og:description" content="目录 1.介绍1.1.项目数据及源码1.2.数据集介绍1.3.任务介绍1.4.ResNet网络介绍 2.数据预处理3.展示数据4.进行迁移学习4.1.训练全连接层4.2.训练所有层 5.测试网络效果5.1.测试数据预处理5.2.结果可视化 1.介绍 1.1.项目数据及源码 可在github下载：
https://github.com/chenshunpeng/Flower-recognition-model-based-on-pytorch
1.2.数据集介绍 flower_data ├── train │ └── 1-102（102个文件夹，共264 MB） │ └── XXX.jpg（每个文件夹含若干张图像） ├── valid │ └── 1-102（102个文件夹，共32.8 MB） └── ───	└── XXX.jpg（每个文件夹含若干张图像） cat_to_name.json：每一类花朵的&#34;名称-编号&#34;对应关系 1.3.任务介绍 实现102种花朵的分类任务，即通过训练train数据集后，从valid数据集中选取某一花朵图像，能准确判别其属于哪一类花朵
1.4.ResNet网络介绍 参考文章：Pytorch Note31 深度残差网络 ResNet
在ResNet网络中有如下两个亮点：
提出residual结构（残差结构），并搭建超深的网络结构(突破1000层)使用Batch Normalization加速训练(丢弃dropout) 在ResNet网络提出之前，传统的卷积神经网络都是通过将一系列卷积层与下采样层进行堆叠得到的。但是当堆叠到一定网络深度时，就会出现两个问题：
梯度消失或梯度爆炸退化问题(degradation problem) 这是在ImageNet数据集中更深的残差网络的模型，这里面给出了残差结构给出了主分支上卷积核的大小与卷积核个数，表中的xN表示将该残差结构重复N次：
对于我们ResNet18/34/50/101/152，表中conv3_x, conv4_x, conv5_x所对应的一系列残差结构的第一层残差结构都是虚线残差结构。因为这一系列残差结构的第一层都有调整输入特征矩阵shape的使命（将特征矩阵的高和宽缩减为原来的一半，将深度channel调整成下一层残差结构所需要的channel）
ResNet-50：我们用3层瓶颈块替换34层网络中的每一个2层块，得到了一个50层ResNe。我们使用1x1卷积核来增加维度。该模型有38亿FLOPResNet-101/152：我们通过使用更多的3层瓶颈块来构建101层和152层ResNets。值得注意的是，尽管深度显著增加，但152层ResNet（113亿FLOP）仍然比VGG-16/19网络（153/196亿FLOP）具有更低的复杂度 2.数据预处理 引入头文件：
import os import matplotlib.pyplot as plt %matplotlib inline import numpy as np import torch from torch import nn import torch." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/a159c88e918d591225296296d4be1582/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-29T22:36:08+08:00" />
<meta property="article:modified_time" content="2022-08-29T22:36:08+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Resnet152对102种花朵图像分类（PyTorch，迁移学习）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><ul><li><a href="#1_2" rel="nofollow">1.介绍</a></li><li><ul><li><a href="#11_3" rel="nofollow">1.1.项目数据及源码</a></li><li><a href="#12_9" rel="nofollow">1.2.数据集介绍</a></li><li><a href="#13_21" rel="nofollow">1.3.任务介绍</a></li><li><a href="#14ResNet_23" rel="nofollow">1.4.ResNet网络介绍</a></li></ul> 
   </li><li><a href="#2_45" rel="nofollow">2.数据预处理</a></li><li><a href="#3_273" rel="nofollow">3.展示数据</a></li><li><a href="#4_317" rel="nofollow">4.进行迁移学习</a></li><li><ul><li><a href="#41_331" rel="nofollow">4.1.训练全连接层</a></li><li><a href="#42_683" rel="nofollow">4.2.训练所有层</a></li></ul> 
   </li><li><a href="#5_766" rel="nofollow">5.测试网络效果</a></li><li><ul><li><a href="#51_767" rel="nofollow">5.1.测试数据预处理</a></li><li><a href="#52_889" rel="nofollow">5.2.结果可视化</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="1_2"></a>1.介绍</h3> 
<h4><a id="11_3"></a>1.1.项目数据及源码</h4> 
<p>可在github下载：</p> 
<p><a href="https://github.com/chenshunpeng/Flower-recognition-model-based-on-pytorch">https://github.com/chenshunpeng/Flower-recognition-model-based-on-pytorch</a></p> 
<p><img src="https://images2.imgbox.com/32/fa/HLVFjf4m_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="12_9"></a>1.2.数据集介绍</h4> 
<pre><code class="prism language-python">flower_data
    ├── train
    │   └── <span class="token number">1</span><span class="token operator">-</span><span class="token number">102</span>（<span class="token number">102</span>个文件夹，共<span class="token number">264</span> MB）
    │   	└── XXX<span class="token punctuation">.</span>jpg（每个文件夹含若干张图像）
    ├── valid
    │   └── <span class="token number">1</span><span class="token operator">-</span><span class="token number">102</span>（<span class="token number">102</span>个文件夹，共<span class="token number">32.8</span> MB）
    └── ───	└── XXX<span class="token punctuation">.</span>jpg（每个文件夹含若干张图像）  
     
cat_to_name<span class="token punctuation">.</span>json：每一类花朵的<span class="token string">"名称-编号"</span>对应关系
</code></pre> 
<h4><a id="13_21"></a>1.3.任务介绍</h4> 
<p>实现102种花朵的分类任务，即通过训练<code>train</code>数据集后，从<code>valid</code>数据集中选取某一花朵图像，能准确判别其属于哪一类花朵</p> 
<h4><a id="14ResNet_23"></a>1.4.ResNet网络介绍</h4> 
<p>参考文章：<a href="https://blog.csdn.net/weixin_45508265/article/details/119087199">Pytorch Note31 深度残差网络 ResNet</a></p> 
<p>在ResNet网络中有如下两个亮点：</p> 
<ol><li>提出residual结构（残差结构），并搭建超深的网络结构(突破1000层)</li><li>使用Batch Normalization加速训练(丢弃dropout)</li></ol> 
<p>在ResNet网络提出之前，传统的卷积神经网络都是通过将一系列卷积层与下采样层进行堆叠得到的。但是当堆叠到一定网络深度时，就会出现两个问题：</p> 
<ol><li>梯度消失或梯度爆炸</li><li>退化问题(degradation problem)</li></ol> 
<p>这是在ImageNet数据集中更深的残差网络的模型，这里面给出了残差结构给出了主分支上卷积核的大小与卷积核个数，表中的xN表示将该残差结构重复N次：</p> 
<p><img src="https://images2.imgbox.com/ff/f2/TcUCyUUR_o.png" alt="在这里插入图片描述"><br> 对于我们ResNet18/34/50/101/152，表中conv3_x, conv4_x, conv5_x所对应的一系列残差结构的第一层残差结构都是虚线残差结构。因为这一系列残差结构的第一层都有调整输入特征矩阵shape的使命（将特征矩阵的高和宽缩减为原来的一半，将深度channel调整成下一层残差结构所需要的channel）</p> 
<ul><li>ResNet-50：我们用3层瓶颈块替换34层网络中的每一个2层块，得到了一个50层ResNe。我们使用1x1卷积核来增加维度。该模型有38亿FLOP</li><li>ResNet-101/152：我们通过使用更多的3层瓶颈块来构建101层和152层ResNets。值得注意的是，尽管深度显著增加，但152层ResNet（113亿FLOP）仍然比VGG-16/19网络（153/196亿FLOP）具有更低的复杂度</li></ul> 
<h3><a id="2_45"></a>2.数据预处理</h3> 
<p>引入头文件：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token operator">%</span>matplotlib inline
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> torch
<span class="token keyword">from</span> torch <span class="token keyword">import</span> nn
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>optim <span class="token keyword">as</span> optim
<span class="token keyword">import</span> torchvision
<span class="token keyword">from</span> torchvision <span class="token keyword">import</span> transforms<span class="token punctuation">,</span> models<span class="token punctuation">,</span> datasets
<span class="token keyword">import</span> imageio
<span class="token keyword">import</span> time
<span class="token keyword">import</span> warnings
<span class="token keyword">import</span> random
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> copy
<span class="token keyword">import</span> json
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image

<span class="token comment"># 加入下述代码！可能！是因为torch包中包含了名为libiomp5md.dll的文件，</span>
<span class="token comment"># 与Anaconda环境中的同一个文件出现了某种冲突，所以需要删除一个。</span>
<span class="token keyword">import</span> os
os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"KMP_DUPLICATE_LIB_OK"</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">"TRUE"</span>
</code></pre> 
<p>设置文件存放目录：</p> 
<pre><code class="prism language-python">data_dir <span class="token operator">=</span> <span class="token string">'./flower_data/'</span>
train_dir <span class="token operator">=</span> data_dir <span class="token operator">+</span> <span class="token string">'/train'</span>
valid_dir <span class="token operator">=</span> data_dir <span class="token operator">+</span> <span class="token string">'/valid'</span>
</code></pre> 
<p>通过<code>torchvision</code>中<code>transforms</code>模块的自带功能实现数据预处理，在<code>data_transforms</code>部分指定了所有图像预处理操作</p> 
<p>这里借鉴的是：<a href="https://pytorch.org/vision/stable/transforms.html" rel="nofollow">https://pytorch.org/vision/stable/transforms.html</a></p> 
<p><img src="https://images2.imgbox.com/e7/1c/3ndnPlB5_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python">data_transforms <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment"># 训练集</span>
    <span class="token string">'train'</span><span class="token punctuation">:</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>transforms<span class="token punctuation">.</span>RandomRotation<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">#随机旋转，-45到45度之间随机选</span>
        transforms<span class="token punctuation">.</span>CenterCrop<span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">#从中心开始裁剪，留下224x224的区域</span>
        transforms<span class="token punctuation">.</span>RandomHorizontalFlip<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">#随机水平翻转 选择一个概率</span>
        transforms<span class="token punctuation">.</span>RandomVerticalFlip<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">#随机垂直翻转</span>
        transforms<span class="token punctuation">.</span>ColorJitter<span class="token punctuation">(</span>brightness<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span> contrast<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span> saturation<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span> hue<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">#参数1为亮度，参数2为对比度，参数3为饱和度，参数4为色相</span>
        transforms<span class="token punctuation">.</span>RandomGrayscale<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.025</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">#概率转换成灰度率，如果原来的是3通道，那就使得R=G=B</span>
        transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment">#均值，标准差（标准化操作）</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment"># 验证集（和训练集操作需要对应）</span>
    <span class="token string">'valid'</span><span class="token punctuation">:</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        transforms<span class="token punctuation">.</span>CenterCrop<span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># 和网络配置吻合</span>
        transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>制作Batch数据：</p> 
<p>可以参考：<a href="https://pytorch.org/vision/stable/datasets.html" rel="nofollow">https://pytorch.org/vision/stable/datasets.html</a></p> 
<p><img src="https://images2.imgbox.com/1a/86/bF8juDzb_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python">batch_size <span class="token operator">=</span> <span class="token number">8</span>

image_datasets <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>x<span class="token punctuation">:</span> datasets<span class="token punctuation">.</span>ImageFolder<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>data_dir<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">,</span> data_transforms<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'train'</span><span class="token punctuation">,</span> <span class="token string">'valid'</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
dataloaders <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>x<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>image_datasets<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">,</span> batch_size<span class="token operator">=</span>batch_size<span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'train'</span><span class="token punctuation">,</span> <span class="token string">'valid'</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
dataset_sizes <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>x<span class="token punctuation">:</span> <span class="token builtin">len</span><span class="token punctuation">(</span>image_datasets<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'train'</span><span class="token punctuation">,</span> <span class="token string">'valid'</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
class_names <span class="token operator">=</span> image_datasets<span class="token punctuation">[</span><span class="token string">'train'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>classes
</code></pre> 
<p>查看<code>image_datasets</code>变量，结果如下：</p> 
<pre><code class="prism language-python"><span class="token punctuation">{<!-- --></span><span class="token string">'train'</span><span class="token punctuation">:</span> Dataset ImageFolder
     Number of datapoints<span class="token punctuation">:</span> <span class="token number">6552</span>
     Root location<span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token operator">/</span>flower_data<span class="token operator">/</span>train
     StandardTransform
 Transform<span class="token punctuation">:</span> Compose<span class="token punctuation">(</span>
                RandomRotation<span class="token punctuation">(</span>degrees<span class="token operator">=</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">45.0</span><span class="token punctuation">,</span> <span class="token number">45.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> interpolation<span class="token operator">=</span>nearest<span class="token punctuation">,</span> expand<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> fill<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
                CenterCrop<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                RandomHorizontalFlip<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span>
                RandomVerticalFlip<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span>
                ColorJitter<span class="token punctuation">(</span>brightness<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.8</span><span class="token punctuation">,</span> <span class="token number">1.2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> contrast<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.9</span><span class="token punctuation">,</span> <span class="token number">1.1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> saturation<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.9</span><span class="token punctuation">,</span> <span class="token number">1.1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> hue<span class="token operator">=</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                RandomGrayscale<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.025</span><span class="token punctuation">)</span>
                ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span>
                Normalize<span class="token punctuation">(</span>mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span><span class="token punctuation">,</span> std<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token string">'valid'</span><span class="token punctuation">:</span> Dataset ImageFolder
     Number of datapoints<span class="token punctuation">:</span> <span class="token number">818</span>
     Root location<span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token operator">/</span>flower_data<span class="token operator">/</span>valid
     StandardTransform
 Transform<span class="token punctuation">:</span> Compose<span class="token punctuation">(</span>
                Resize<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span> interpolation<span class="token operator">=</span>bilinear<span class="token punctuation">,</span> max_size<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> antialias<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>
                CenterCrop<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span>
                Normalize<span class="token punctuation">(</span>mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span><span class="token punctuation">,</span> std<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">}</span>
</code></pre> 
<p>查看<code>dataloaders</code>变量：</p> 
<pre><code class="prism language-python"><span class="token punctuation">{<!-- --></span><span class="token string">'train'</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span>torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>dataloader<span class="token punctuation">.</span>DataLoader at <span class="token number">0x200b56a86c8</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
 <span class="token string">'valid'</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span>torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>dataloader<span class="token punctuation">.</span>DataLoader at <span class="token number">0x200b57c9688</span><span class="token operator">&gt;</span><span class="token punctuation">}</span>
</code></pre> 
<p>查看<code>dataset_sizes</code>变量，结果如下：</p> 
<pre><code class="prism language-python"><span class="token punctuation">{<!-- --></span><span class="token string">'train'</span><span class="token punctuation">:</span> <span class="token number">6552</span><span class="token punctuation">,</span> <span class="token string">'valid'</span><span class="token punctuation">:</span> <span class="token number">818</span><span class="token punctuation">}</span>
</code></pre> 
<p>读取标签对应的实际名字：</p> 
<pre><code class="prism language-python"><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'cat_to_name.json'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    cat_to_name <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
</code></pre> 
<p>查看<code>cat_to_name</code>变量，结果如下：</p> 
<pre><code class="prism language-python"><span class="token punctuation">{<!-- --></span><span class="token string">'21'</span><span class="token punctuation">:</span> <span class="token string">'fire lily'</span><span class="token punctuation">,</span>
 <span class="token string">'3'</span><span class="token punctuation">:</span> <span class="token string">'canterbury bells'</span><span class="token punctuation">,</span>
 <span class="token string">'45'</span><span class="token punctuation">:</span> <span class="token string">'bolero deep blue'</span><span class="token punctuation">,</span>
 <span class="token string">'1'</span><span class="token punctuation">:</span> <span class="token string">'pink primrose'</span><span class="token punctuation">,</span>
 <span class="token string">'34'</span><span class="token punctuation">:</span> <span class="token string">'mexican aster'</span><span class="token punctuation">,</span>
 <span class="token string">'27'</span><span class="token punctuation">:</span> <span class="token string">'prince of wales feathers'</span><span class="token punctuation">,</span>
 <span class="token string">'7'</span><span class="token punctuation">:</span> <span class="token string">'moon orchid'</span><span class="token punctuation">,</span>
 <span class="token string">'16'</span><span class="token punctuation">:</span> <span class="token string">'globe-flower'</span><span class="token punctuation">,</span>
 <span class="token string">'25'</span><span class="token punctuation">:</span> <span class="token string">'grape hyacinth'</span><span class="token punctuation">,</span>
 <span class="token string">'26'</span><span class="token punctuation">:</span> <span class="token string">'corn poppy'</span><span class="token punctuation">,</span>
 <span class="token string">'79'</span><span class="token punctuation">:</span> <span class="token string">'toad lily'</span><span class="token punctuation">,</span>
 <span class="token string">'39'</span><span class="token punctuation">:</span> <span class="token string">'siam tulip'</span><span class="token punctuation">,</span>
 <span class="token string">'24'</span><span class="token punctuation">:</span> <span class="token string">'red ginger'</span><span class="token punctuation">,</span>
 <span class="token string">'67'</span><span class="token punctuation">:</span> <span class="token string">'spring crocus'</span><span class="token punctuation">,</span>
 <span class="token string">'35'</span><span class="token punctuation">:</span> <span class="token string">'alpine sea holly'</span><span class="token punctuation">,</span>
 <span class="token string">'32'</span><span class="token punctuation">:</span> <span class="token string">'garden phlox'</span><span class="token punctuation">,</span>
 <span class="token string">'10'</span><span class="token punctuation">:</span> <span class="token string">'globe thistle'</span><span class="token punctuation">,</span>
 <span class="token string">'6'</span><span class="token punctuation">:</span> <span class="token string">'tiger lily'</span><span class="token punctuation">,</span>
 <span class="token string">'93'</span><span class="token punctuation">:</span> <span class="token string">'ball moss'</span><span class="token punctuation">,</span>
 <span class="token string">'33'</span><span class="token punctuation">:</span> <span class="token string">'love in the mist'</span><span class="token punctuation">,</span>
 <span class="token string">'9'</span><span class="token punctuation">:</span> <span class="token string">'monkshood'</span><span class="token punctuation">,</span>
 <span class="token string">'102'</span><span class="token punctuation">:</span> <span class="token string">'blackberry lily'</span><span class="token punctuation">,</span>
 <span class="token string">'14'</span><span class="token punctuation">:</span> <span class="token string">'spear thistle'</span><span class="token punctuation">,</span>
 <span class="token string">'19'</span><span class="token punctuation">:</span> <span class="token string">'balloon flower'</span><span class="token punctuation">,</span>
 <span class="token string">'100'</span><span class="token punctuation">:</span> <span class="token string">'blanket flower'</span><span class="token punctuation">,</span>
 <span class="token string">'13'</span><span class="token punctuation">:</span> <span class="token string">'king protea'</span><span class="token punctuation">,</span>
 <span class="token string">'49'</span><span class="token punctuation">:</span> <span class="token string">'oxeye daisy'</span><span class="token punctuation">,</span>
 <span class="token string">'15'</span><span class="token punctuation">:</span> <span class="token string">'yellow iris'</span><span class="token punctuation">,</span>
 <span class="token string">'61'</span><span class="token punctuation">:</span> <span class="token string">'cautleya spicata'</span><span class="token punctuation">,</span>
 <span class="token string">'31'</span><span class="token punctuation">:</span> <span class="token string">'carnation'</span><span class="token punctuation">,</span>
 <span class="token string">'64'</span><span class="token punctuation">:</span> <span class="token string">'silverbush'</span><span class="token punctuation">,</span>
 <span class="token string">'68'</span><span class="token punctuation">:</span> <span class="token string">'bearded iris'</span><span class="token punctuation">,</span>
 <span class="token string">'63'</span><span class="token punctuation">:</span> <span class="token string">'black-eyed susan'</span><span class="token punctuation">,</span>
 <span class="token string">'69'</span><span class="token punctuation">:</span> <span class="token string">'windflower'</span><span class="token punctuation">,</span>
 <span class="token string">'62'</span><span class="token punctuation">:</span> <span class="token string">'japanese anemone'</span><span class="token punctuation">,</span>
 <span class="token string">'20'</span><span class="token punctuation">:</span> <span class="token string">'giant white arum lily'</span><span class="token punctuation">,</span>
 <span class="token string">'38'</span><span class="token punctuation">:</span> <span class="token string">'great masterwort'</span><span class="token punctuation">,</span>
 <span class="token string">'4'</span><span class="token punctuation">:</span> <span class="token string">'sweet pea'</span><span class="token punctuation">,</span>
 <span class="token string">'86'</span><span class="token punctuation">:</span> <span class="token string">'tree mallow'</span><span class="token punctuation">,</span>
 <span class="token string">'101'</span><span class="token punctuation">:</span> <span class="token string">'trumpet creeper'</span><span class="token punctuation">,</span>
 <span class="token string">'42'</span><span class="token punctuation">:</span> <span class="token string">'daffodil'</span><span class="token punctuation">,</span>
 <span class="token string">'22'</span><span class="token punctuation">:</span> <span class="token string">'pincushion flower'</span><span class="token punctuation">,</span>
 <span class="token string">'2'</span><span class="token punctuation">:</span> <span class="token string">'hard-leaved pocket orchid'</span><span class="token punctuation">,</span>
 <span class="token string">'54'</span><span class="token punctuation">:</span> <span class="token string">'sunflower'</span><span class="token punctuation">,</span>
 <span class="token string">'66'</span><span class="token punctuation">:</span> <span class="token string">'osteospermum'</span><span class="token punctuation">,</span>
 <span class="token string">'70'</span><span class="token punctuation">:</span> <span class="token string">'tree poppy'</span><span class="token punctuation">,</span>
 <span class="token string">'85'</span><span class="token punctuation">:</span> <span class="token string">'desert-rose'</span><span class="token punctuation">,</span>
 <span class="token string">'99'</span><span class="token punctuation">:</span> <span class="token string">'bromelia'</span><span class="token punctuation">,</span>
 <span class="token string">'87'</span><span class="token punctuation">:</span> <span class="token string">'magnolia'</span><span class="token punctuation">,</span>
 <span class="token string">'5'</span><span class="token punctuation">:</span> <span class="token string">'english marigold'</span><span class="token punctuation">,</span>
 <span class="token string">'92'</span><span class="token punctuation">:</span> <span class="token string">'bee balm'</span><span class="token punctuation">,</span>
 <span class="token string">'28'</span><span class="token punctuation">:</span> <span class="token string">'stemless gentian'</span><span class="token punctuation">,</span>
 <span class="token string">'97'</span><span class="token punctuation">:</span> <span class="token string">'mallow'</span><span class="token punctuation">,</span>
 <span class="token string">'57'</span><span class="token punctuation">:</span> <span class="token string">'gaura'</span><span class="token punctuation">,</span>
 <span class="token string">'40'</span><span class="token punctuation">:</span> <span class="token string">'lenten rose'</span><span class="token punctuation">,</span>
 <span class="token string">'47'</span><span class="token punctuation">:</span> <span class="token string">'marigold'</span><span class="token punctuation">,</span>
 <span class="token string">'59'</span><span class="token punctuation">:</span> <span class="token string">'orange dahlia'</span><span class="token punctuation">,</span>
 <span class="token string">'48'</span><span class="token punctuation">:</span> <span class="token string">'buttercup'</span><span class="token punctuation">,</span>
 <span class="token string">'55'</span><span class="token punctuation">:</span> <span class="token string">'pelargonium'</span><span class="token punctuation">,</span>
 <span class="token string">'36'</span><span class="token punctuation">:</span> <span class="token string">'ruby-lipped cattleya'</span><span class="token punctuation">,</span>
 <span class="token string">'91'</span><span class="token punctuation">:</span> <span class="token string">'hippeastrum'</span><span class="token punctuation">,</span>
 <span class="token string">'29'</span><span class="token punctuation">:</span> <span class="token string">'artichoke'</span><span class="token punctuation">,</span>
 <span class="token string">'71'</span><span class="token punctuation">:</span> <span class="token string">'gazania'</span><span class="token punctuation">,</span>
 <span class="token string">'90'</span><span class="token punctuation">:</span> <span class="token string">'canna lily'</span><span class="token punctuation">,</span>
 <span class="token string">'18'</span><span class="token punctuation">:</span> <span class="token string">'peruvian lily'</span><span class="token punctuation">,</span>
 <span class="token string">'98'</span><span class="token punctuation">:</span> <span class="token string">'mexican petunia'</span><span class="token punctuation">,</span>
 <span class="token string">'8'</span><span class="token punctuation">:</span> <span class="token string">'bird of paradise'</span><span class="token punctuation">,</span>
 <span class="token string">'30'</span><span class="token punctuation">:</span> <span class="token string">'sweet william'</span><span class="token punctuation">,</span>
 <span class="token string">'17'</span><span class="token punctuation">:</span> <span class="token string">'purple coneflower'</span><span class="token punctuation">,</span>
 <span class="token string">'52'</span><span class="token punctuation">:</span> <span class="token string">'wild pansy'</span><span class="token punctuation">,</span>
 <span class="token string">'84'</span><span class="token punctuation">:</span> <span class="token string">'columbine'</span><span class="token punctuation">,</span>
 <span class="token string">'12'</span><span class="token punctuation">:</span> <span class="token string">"colt's foot"</span><span class="token punctuation">,</span>
 <span class="token string">'11'</span><span class="token punctuation">:</span> <span class="token string">'snapdragon'</span><span class="token punctuation">,</span>
 <span class="token string">'96'</span><span class="token punctuation">:</span> <span class="token string">'camellia'</span><span class="token punctuation">,</span>
 <span class="token string">'23'</span><span class="token punctuation">:</span> <span class="token string">'fritillary'</span><span class="token punctuation">,</span>
 <span class="token string">'50'</span><span class="token punctuation">:</span> <span class="token string">'common dandelion'</span><span class="token punctuation">,</span>
 <span class="token string">'44'</span><span class="token punctuation">:</span> <span class="token string">'poinsettia'</span><span class="token punctuation">,</span>
 <span class="token string">'53'</span><span class="token punctuation">:</span> <span class="token string">'primula'</span><span class="token punctuation">,</span>
 <span class="token string">'72'</span><span class="token punctuation">:</span> <span class="token string">'azalea'</span><span class="token punctuation">,</span>
 <span class="token string">'65'</span><span class="token punctuation">:</span> <span class="token string">'californian poppy'</span><span class="token punctuation">,</span>
 <span class="token string">'80'</span><span class="token punctuation">:</span> <span class="token string">'anthurium'</span><span class="token punctuation">,</span>
 <span class="token string">'76'</span><span class="token punctuation">:</span> <span class="token string">'morning glory'</span><span class="token punctuation">,</span>
 <span class="token string">'37'</span><span class="token punctuation">:</span> <span class="token string">'cape flower'</span><span class="token punctuation">,</span>
 <span class="token string">'56'</span><span class="token punctuation">:</span> <span class="token string">'bishop of llandaff'</span><span class="token punctuation">,</span>
 <span class="token string">'60'</span><span class="token punctuation">:</span> <span class="token string">'pink-yellow dahlia'</span><span class="token punctuation">,</span>
 <span class="token string">'82'</span><span class="token punctuation">:</span> <span class="token string">'clematis'</span><span class="token punctuation">,</span>
 <span class="token string">'58'</span><span class="token punctuation">:</span> <span class="token string">'geranium'</span><span class="token punctuation">,</span>
 <span class="token string">'75'</span><span class="token punctuation">:</span> <span class="token string">'thorn apple'</span><span class="token punctuation">,</span>
 <span class="token string">'41'</span><span class="token punctuation">:</span> <span class="token string">'barbeton daisy'</span><span class="token punctuation">,</span>
 <span class="token string">'95'</span><span class="token punctuation">:</span> <span class="token string">'bougainvillea'</span><span class="token punctuation">,</span>
 <span class="token string">'43'</span><span class="token punctuation">:</span> <span class="token string">'sword lily'</span><span class="token punctuation">,</span>
 <span class="token string">'83'</span><span class="token punctuation">:</span> <span class="token string">'hibiscus'</span><span class="token punctuation">,</span>
 <span class="token string">'78'</span><span class="token punctuation">:</span> <span class="token string">'lotus lotus'</span><span class="token punctuation">,</span>
 <span class="token string">'88'</span><span class="token punctuation">:</span> <span class="token string">'cyclamen'</span><span class="token punctuation">,</span>
 <span class="token string">'94'</span><span class="token punctuation">:</span> <span class="token string">'foxglove'</span><span class="token punctuation">,</span>
 <span class="token string">'81'</span><span class="token punctuation">:</span> <span class="token string">'frangipani'</span><span class="token punctuation">,</span>
 <span class="token string">'74'</span><span class="token punctuation">:</span> <span class="token string">'rose'</span><span class="token punctuation">,</span>
 <span class="token string">'89'</span><span class="token punctuation">:</span> <span class="token string">'watercress'</span><span class="token punctuation">,</span>
 <span class="token string">'73'</span><span class="token punctuation">:</span> <span class="token string">'water lily'</span><span class="token punctuation">,</span>
 <span class="token string">'46'</span><span class="token punctuation">:</span> <span class="token string">'wallflower'</span><span class="token punctuation">,</span>
 <span class="token string">'77'</span><span class="token punctuation">:</span> <span class="token string">'passion flower'</span><span class="token punctuation">,</span>
 <span class="token string">'51'</span><span class="token punctuation">:</span> <span class="token string">'petunia'</span><span class="token punctuation">}</span>
</code></pre> 
<h3><a id="3_273"></a>3.展示数据</h3> 
<p>定义图像处理函数<code>im_convert</code>：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">im_convert</span><span class="token punctuation">(</span>tensor<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">""" 展示数据"""</span>
<span class="token comment">#     tensor.clone()  返回tensor的拷贝，返回的新tensor和原来的tensor具有同样的大小和数据类型</span>
<span class="token comment">#     tensor.detach() 从计算图中脱离出来。</span>
    image <span class="token operator">=</span> tensor<span class="token punctuation">.</span>to<span class="token punctuation">(</span><span class="token string">"cpu"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
<span class="token comment">#     numpy.squeeze()这个函数的作用是去掉矩阵里维度为1的维度</span>
    image <span class="token operator">=</span> image<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
<span class="token comment">#     将npimg的数据格式由（channels,imagesize,imagesize）转化为（imagesize,imagesize,channels）,</span>
<span class="token comment">#     进行格式的转换后方可进行显示</span>
    image <span class="token operator">=</span> image<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
    
<span class="token comment">#     和标准差操作正好相反即可</span>
    image <span class="token operator">=</span> image <span class="token operator">*</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
<span class="token comment">#     使用image.clip(0, 1) 将数据 限制在0和1之间</span>
    image <span class="token operator">=</span> image<span class="token punctuation">.</span>clip<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> image
</code></pre> 
<p>显示图像：</p> 
<pre><code class="prism language-python">fig<span class="token operator">=</span>plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
columns <span class="token operator">=</span> <span class="token number">4</span>
rows <span class="token operator">=</span> <span class="token number">2</span>

dataiter <span class="token operator">=</span> <span class="token builtin">iter</span><span class="token punctuation">(</span>dataloaders<span class="token punctuation">[</span><span class="token string">'valid'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
inputs<span class="token punctuation">,</span> classes <span class="token operator">=</span> dataiter<span class="token punctuation">.</span><span class="token builtin">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> idx <span class="token keyword">in</span> <span class="token builtin">range</span> <span class="token punctuation">(</span>columns<span class="token operator">*</span>rows<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ax <span class="token operator">=</span> fig<span class="token punctuation">.</span>add_subplot<span class="token punctuation">(</span>rows<span class="token punctuation">,</span> columns<span class="token punctuation">,</span> idx<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> xticks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> yticks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    ax<span class="token punctuation">.</span>set_title<span class="token punctuation">(</span>cat_to_name<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>class_names<span class="token punctuation">[</span>classes<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>im_convert<span class="token punctuation">(</span>inputs<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>结果：<br> <img src="https://images2.imgbox.com/1e/f7/LQrwobwG_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="4_317"></a>4.进行迁移学习</h3> 
<p>参考文章：<a href="https://blog.csdn.net/dakenz/article/details/85954548?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522165952451116782425120998%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=165952451116782425120998&amp;biz_id=0&amp;spm=1018.2226.3001.4187">迁移学习概述（Transfer Learning）</a></p> 
<p><strong>关键点</strong></p> 
<ul><li>研究可以用哪些知识在不同的领域或者任务中进行迁移学习，即不同领域之间有哪些共有知识可以迁移</li><li>研究在找到了迁移对象之后，针对具体问题所采用哪种迁移学习的特定算法，即如何设计出合适的算法来提取和迁移共有知识</li><li>研究什么情况下适合迁移，迁移技巧是否适合具体应用，其中涉及到负迁移的问题。</li></ul> 
<p>当领域间的概率分布差异很大时，上述假设通常难以成立，这会导致严重的负迁移问题，负迁移是旧知识对新知识学习的阻碍作用，比如学习了三轮车之后对骑自行车的影响，和学习汉语拼音对学英文字母的影响，我们应研究如何利用正迁移，避免负迁移</p> 
<p><img src="https://images2.imgbox.com/31/06/sgAdxjXe_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="41_331"></a>4.1.训练全连接层</h4> 
<p>加载models中提供的模型，并且直接用训练的好权重当做初始化参数（第一次执行需要下载，可能会比较慢），下载链接：<a href="https://download.pytorch.org/models/resnet152-394f9c45.pth" rel="nofollow">https://download.pytorch.org/models/resnet152-394f9c45.pth</a>，默认下载到本地的<code>C:\Users\HP ZBook15/.cache\torch\hub\checkpoints\resnet152-394f9c45.pth</code></p> 
<p><img src="https://images2.imgbox.com/c8/1e/1ATNvWY3_o.png" alt="在这里插入图片描述"></p> 
<p>首先选择<code>resnet</code>网络，并用官方训练好的特征来做：</p> 
<pre><code class="prism language-python">model_name <span class="token operator">=</span> <span class="token string">'resnet'</span>  <span class="token comment">#可选的有： ['resnet', 'alexnet', 'vgg', 'squeezenet', 'densenet', 'inception']</span>

<span class="token comment">#是否用官方训练好的特征来做</span>
feature_extract <span class="token operator">=</span> <span class="token boolean">True</span> 
</code></pre> 
<p>设置用GPU训练：</p> 
<pre><code class="prism language-python"><span class="token comment"># 是否用GPU训练</span>
train_on_gpu <span class="token operator">=</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> <span class="token keyword">not</span> train_on_gpu<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'CUDA is not available.  Training on CPU ...'</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'CUDA is available!  Training on GPU ...'</span><span class="token punctuation">)</span>
    
device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">"cuda:0"</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">"cpu"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>device<span class="token punctuation">)</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-python">CUDA <span class="token keyword">is</span> available!  Training on GPU <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
cuda<span class="token punctuation">:</span><span class="token number">0</span>
</code></pre> 
<p>屏蔽预训练模型的权重，只训练全连接层的权重：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">set_parameter_requires_grad</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> feature_extracting<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> feature_extracting<span class="token punctuation">:</span>
        <span class="token keyword">for</span> param <span class="token keyword">in</span> model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            
<span class="token comment">#             屏蔽预训练模型的权重,只训练全连接层的权重</span>
            param<span class="token punctuation">.</span>requires_grad <span class="token operator">=</span> <span class="token boolean">False</span>
</code></pre> 
<p>这里选择的是152层的resnet网络：</p> 
<p>参考：<a href="https://pytorch.org/vision/stable/models/resnet.html" rel="nofollow">https://pytorch.org/vision/stable/models/resnet.html</a></p> 
<p><img src="https://images2.imgbox.com/e4/09/Ff6Rdtaq_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python">model_ft <span class="token operator">=</span> models<span class="token punctuation">.</span>resnet152<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#152层的resnet网络</span>
model_ft
</code></pre> 
<p>结果：</p> 
<p><img src="https://images2.imgbox.com/5e/52/mzKUosHb_o.png" alt="在这里插入图片描述"></p> 
<p>设置优化器：</p> 
<pre><code class="prism language-python"><span class="token comment"># 优化器设置</span>
optimizer_ft <span class="token operator">=</span> optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>params_to_update<span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">1e-2</span><span class="token punctuation">)</span>
scheduler <span class="token operator">=</span> optim<span class="token punctuation">.</span>lr_scheduler<span class="token punctuation">.</span>StepLR<span class="token punctuation">(</span>optimizer_ft<span class="token punctuation">,</span> step_size<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span> gamma<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token comment">#学习率每7个epoch衰减成原来的1/10</span>
<span class="token comment">#最后一层已经LogSoftmax()了，所以不能nn.CrossEntropyLoss()来计算了，nn.CrossEntropyLoss()相当于logSoftmax()和nn.NLLLoss()整合</span>
criterion <span class="token operator">=</span> nn<span class="token punctuation">.</span>NLLLoss<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>定义训练模块：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">train_model</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> dataloaders<span class="token punctuation">,</span> criterion<span class="token punctuation">,</span> optimizer<span class="token punctuation">,</span> num_epochs<span class="token operator">=</span><span class="token number">25</span><span class="token punctuation">,</span> is_inception<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>filename<span class="token operator">=</span>filename<span class="token punctuation">)</span><span class="token punctuation">:</span>
    since <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    best_acc <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token triple-quoted-string string">"""
    checkpoint = torch.load(filename)
    best_acc = checkpoint['best_acc']
    model.load_state_dict(checkpoint['state_dict'])
    optimizer.load_state_dict(checkpoint['optimizer'])
    model.class_to_idx = checkpoint['mapping']
    """</span>
    model<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span> <span class="token comment">#</span>

    val_acc_history <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    train_acc_history <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    train_losses <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    valid_losses <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    LRs <span class="token operator">=</span> <span class="token punctuation">[</span>optimizer<span class="token punctuation">.</span>param_groups<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'lr'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>

    best_model_wts <span class="token operator">=</span> copy<span class="token punctuation">.</span>deepcopy<span class="token punctuation">(</span>model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Epoch {}/{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>epoch<span class="token punctuation">,</span> num_epochs <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'-'</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span>

        <span class="token comment"># 训练和验证</span>
        <span class="token keyword">for</span> phase <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'train'</span><span class="token punctuation">,</span> <span class="token string">'valid'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> phase <span class="token operator">==</span> <span class="token string">'train'</span><span class="token punctuation">:</span>
                model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 训练</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment"># 验证</span>

            running_loss <span class="token operator">=</span> <span class="token number">0.0</span>
            running_corrects <span class="token operator">=</span> <span class="token number">0</span>

            <span class="token comment"># 把数据都取个遍</span>
            <span class="token keyword">for</span> inputs<span class="token punctuation">,</span> labels <span class="token keyword">in</span> dataloaders<span class="token punctuation">[</span>phase<span class="token punctuation">]</span><span class="token punctuation">:</span>
                inputs <span class="token operator">=</span> inputs<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
                labels <span class="token operator">=</span> labels<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>

                <span class="token comment"># 清零</span>
                optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment"># 只有训练的时候计算和更新梯度</span>
                <span class="token keyword">with</span> torch<span class="token punctuation">.</span>set_grad_enabled<span class="token punctuation">(</span>phase <span class="token operator">==</span> <span class="token string">'train'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> is_inception <span class="token keyword">and</span> phase <span class="token operator">==</span> <span class="token string">'train'</span><span class="token punctuation">:</span>
                        outputs<span class="token punctuation">,</span> aux_outputs <span class="token operator">=</span> model<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span>
                        
                        outputs<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
                        aux_outputs<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
                        criterion<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
                        
                        loss1 <span class="token operator">=</span> criterion<span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> labels<span class="token punctuation">)</span>
                        loss2 <span class="token operator">=</span> criterion<span class="token punctuation">(</span>aux_outputs<span class="token punctuation">,</span> labels<span class="token punctuation">)</span>
                        loss <span class="token operator">=</span> loss1 <span class="token operator">+</span> <span class="token number">0.4</span><span class="token operator">*</span>loss2
                    <span class="token keyword">else</span><span class="token punctuation">:</span><span class="token comment">#resnet执行的是这里</span>
                        outputs <span class="token operator">=</span> model<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span>
                        loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> labels<span class="token punctuation">)</span>

                    _<span class="token punctuation">,</span> preds <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

                    <span class="token comment"># 训练阶段更新权重</span>
                    <span class="token keyword">if</span> phase <span class="token operator">==</span> <span class="token string">'train'</span><span class="token punctuation">:</span>
                        loss<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span> <span class="token comment">#</span>
                        loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
                        optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>

                <span class="token comment"># 计算损失</span>
                running_loss <span class="token operator">+=</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> inputs<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                running_corrects <span class="token operator">+=</span> torch<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>preds <span class="token operator">==</span> labels<span class="token punctuation">.</span>data<span class="token punctuation">)</span>

            epoch_loss <span class="token operator">=</span> running_loss <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>dataloaders<span class="token punctuation">[</span>phase<span class="token punctuation">]</span><span class="token punctuation">.</span>dataset<span class="token punctuation">)</span>
            epoch_acc <span class="token operator">=</span> running_corrects<span class="token punctuation">.</span>double<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>dataloaders<span class="token punctuation">[</span>phase<span class="token punctuation">]</span><span class="token punctuation">.</span>dataset<span class="token punctuation">)</span>
            
            
            time_elapsed <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> since
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Time elapsed {:.0f}m {:.0f}s'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>time_elapsed <span class="token operator">//</span> <span class="token number">60</span><span class="token punctuation">,</span> time_elapsed <span class="token operator">%</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'{} Loss: {:.4f} Acc: {:.4f}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>phase<span class="token punctuation">,</span> epoch_loss<span class="token punctuation">,</span> epoch_acc<span class="token punctuation">)</span><span class="token punctuation">)</span>
            

            <span class="token comment"># 得到最好那次的模型</span>
            <span class="token keyword">if</span> phase <span class="token operator">==</span> <span class="token string">'valid'</span> <span class="token keyword">and</span> epoch_acc <span class="token operator">&gt;</span> best_acc<span class="token punctuation">:</span>
                best_acc <span class="token operator">=</span> epoch_acc
                best_model_wts <span class="token operator">=</span> copy<span class="token punctuation">.</span>deepcopy<span class="token punctuation">(</span>model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                state <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
                  <span class="token string">'state_dict'</span><span class="token punctuation">:</span> model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  <span class="token string">'best_acc'</span><span class="token punctuation">:</span> best_acc<span class="token punctuation">,</span>
                  <span class="token string">'optimizer'</span> <span class="token punctuation">:</span> optimizer<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span>
                torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>state<span class="token punctuation">,</span> filename<span class="token punctuation">)</span>
            <span class="token keyword">if</span> phase <span class="token operator">==</span> <span class="token string">'valid'</span><span class="token punctuation">:</span>
                val_acc_history<span class="token punctuation">.</span>append<span class="token punctuation">(</span>epoch_acc<span class="token punctuation">)</span>
                valid_losses<span class="token punctuation">.</span>append<span class="token punctuation">(</span>epoch_loss<span class="token punctuation">)</span>
                scheduler<span class="token punctuation">.</span>step<span class="token punctuation">(</span>epoch_loss<span class="token punctuation">)</span>
            <span class="token keyword">if</span> phase <span class="token operator">==</span> <span class="token string">'train'</span><span class="token punctuation">:</span>
                train_acc_history<span class="token punctuation">.</span>append<span class="token punctuation">(</span>epoch_acc<span class="token punctuation">)</span>
                train_losses<span class="token punctuation">.</span>append<span class="token punctuation">(</span>epoch_loss<span class="token punctuation">)</span>
        
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Optimizer learning rate : {:.7f}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>optimizer<span class="token punctuation">.</span>param_groups<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'lr'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        LRs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>optimizer<span class="token punctuation">.</span>param_groups<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'lr'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    time_elapsed <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> since
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Training complete in {:.0f}m {:.0f}s'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>time_elapsed <span class="token operator">//</span> <span class="token number">60</span><span class="token punctuation">,</span> time_elapsed <span class="token operator">%</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Best val Acc: {:4f}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>best_acc<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 训练完后用最好的一次当做模型最终的结果</span>
    model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>best_model_wts<span class="token punctuation">)</span>
    <span class="token keyword">return</span> model<span class="token punctuation">,</span> val_acc_history<span class="token punctuation">,</span> train_acc_history<span class="token punctuation">,</span> valid_losses<span class="token punctuation">,</span> train_losses<span class="token punctuation">,</span> LRs 
</code></pre> 
<p>进行训练：</p> 
<pre><code class="prism language-python">model_ft<span class="token punctuation">,</span> val_acc_history<span class="token punctuation">,</span> train_acc_history<span class="token punctuation">,</span> valid_losses<span class="token punctuation">,</span> train_losses<span class="token punctuation">,</span> LRs  <span class="token operator">=</span> train_model<span class="token punctuation">(</span>model_ft<span class="token punctuation">,</span> dataloaders<span class="token punctuation">,</span> criterion<span class="token punctuation">,</span> optimizer_ft<span class="token punctuation">,</span> num_epochs<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> is_inception<span class="token operator">=</span><span class="token punctuation">(</span>model_name<span class="token operator">==</span><span class="token string">"inception"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>训练结果，注意保存的最终结果不一定是最后一次训练的结果，而是测试集（<code>valid</code>）的<code>epoch_acc</code>（<code>running_corrects.double() / len(dataloaders[phase].dataset)</code>）最高的那次结果</p> 
<pre><code class="prism language-python">Epoch <span class="token number">0</span><span class="token operator">/</span><span class="token number">19</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
Time elapsed 4m 52s
train Loss<span class="token punctuation">:</span> <span class="token number">1.9106</span> Acc<span class="token punctuation">:</span> <span class="token number">0.7237</span>
Time elapsed 5m 22s
valid Loss<span class="token punctuation">:</span> <span class="token number">3.7403</span> Acc<span class="token punctuation">:</span> <span class="token number">0.6186</span>
F<span class="token punctuation">:</span>\F_software\Anaconda\lib\site<span class="token operator">-</span>packages\torch\optim\lr_scheduler<span class="token punctuation">.</span>py<span class="token punctuation">:</span><span class="token number">154</span><span class="token punctuation">:</span> UserWarning<span class="token punctuation">:</span> The epoch parameter <span class="token keyword">in</span> `scheduler<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>` was <span class="token keyword">not</span> necessary <span class="token keyword">and</span> <span class="token keyword">is</span> being deprecated where possible<span class="token punctuation">.</span> Please use `scheduler<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>` to step the scheduler<span class="token punctuation">.</span> During the deprecation<span class="token punctuation">,</span> <span class="token keyword">if</span> epoch <span class="token keyword">is</span> different <span class="token keyword">from</span> <span class="token boolean">None</span><span class="token punctuation">,</span> the closed form <span class="token keyword">is</span> used instead of the new chainable form<span class="token punctuation">,</span> where available<span class="token punctuation">.</span> Please <span class="token builtin">open</span> an issue <span class="token keyword">if</span> you are unable to replicate your use <span class="token keyword">case</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span><span class="token operator">//</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>pytorch<span class="token operator">/</span>pytorch<span class="token operator">/</span>issues<span class="token operator">/</span>new<span class="token operator">/</span>choose<span class="token punctuation">.</span>
  warnings<span class="token punctuation">.</span>warn<span class="token punctuation">(</span>EPOCH_DEPRECATION_WARNING<span class="token punctuation">,</span> UserWarning<span class="token punctuation">)</span>
Optimizer learning rate <span class="token punctuation">:</span> <span class="token number">0.0100000</span>

Epoch <span class="token number">1</span><span class="token operator">/</span><span class="token number">19</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
Time elapsed 10m 13s
train Loss<span class="token punctuation">:</span> <span class="token number">10.4597</span> Acc<span class="token punctuation">:</span> <span class="token number">0.4754</span>
Time elapsed 10m 43s
valid Loss<span class="token punctuation">:</span> <span class="token number">13.0444</span> Acc<span class="token punctuation">:</span> <span class="token number">0.5049</span>
Optimizer learning rate <span class="token punctuation">:</span> <span class="token number">0.0010000</span>

Epoch <span class="token number">2</span><span class="token operator">/</span><span class="token number">19</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
Time elapsed 15m 41s
train Loss<span class="token punctuation">:</span> <span class="token number">2.7631</span> Acc<span class="token punctuation">:</span> <span class="token number">0.7401</span>
Time elapsed 16m 11s
valid Loss<span class="token punctuation">:</span> <span class="token number">4.7466</span> Acc<span class="token punctuation">:</span> <span class="token number">0.6565</span>
Optimizer learning rate <span class="token punctuation">:</span> <span class="token number">0.0100000</span>

Epoch <span class="token number">3</span><span class="token operator">/</span><span class="token number">19</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
Time elapsed 21m 54s
train Loss<span class="token punctuation">:</span> <span class="token number">9.0169</span> Acc<span class="token punctuation">:</span> <span class="token number">0.5606</span>
Time elapsed 22m 30s
valid Loss<span class="token punctuation">:</span> <span class="token number">12.3037</span> Acc<span class="token punctuation">:</span> <span class="token number">0.5477</span>
Optimizer learning rate <span class="token punctuation">:</span> <span class="token number">0.0010000</span>

Epoch <span class="token number">4</span><span class="token operator">/</span><span class="token number">19</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
Time elapsed 28m 29s
train Loss<span class="token punctuation">:</span> <span class="token number">3.1063</span> Acc<span class="token punctuation">:</span> <span class="token number">0.7662</span>
Time elapsed 29m 6s
valid Loss<span class="token punctuation">:</span> <span class="token number">5.4615</span> Acc<span class="token punctuation">:</span> <span class="token number">0.6846</span>
Optimizer learning rate <span class="token punctuation">:</span> <span class="token number">0.0100000</span>

Epoch <span class="token number">5</span><span class="token operator">/</span><span class="token number">19</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
Time elapsed 35m 24s
train Loss<span class="token punctuation">:</span> <span class="token number">8.8574</span> Acc<span class="token punctuation">:</span> <span class="token number">0.5954</span>
Time elapsed 36m 2s
valid Loss<span class="token punctuation">:</span> <span class="token number">13.5686</span> Acc<span class="token punctuation">:</span> <span class="token number">0.5293</span>
Optimizer learning rate <span class="token punctuation">:</span> <span class="token number">0.0010000</span>

Epoch <span class="token number">6</span><span class="token operator">/</span><span class="token number">19</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
Time elapsed 42m 1s
train Loss<span class="token punctuation">:</span> <span class="token number">3.1315</span> Acc<span class="token punctuation">:</span> <span class="token number">0.7830</span>
Time elapsed 42m 39s
valid Loss<span class="token punctuation">:</span> <span class="token number">6.2158</span> Acc<span class="token punctuation">:</span> <span class="token number">0.6956</span>
Optimizer learning rate <span class="token punctuation">:</span> <span class="token number">0.0100000</span>

Epoch <span class="token number">7</span><span class="token operator">/</span><span class="token number">19</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
Time elapsed 48m 47s
train Loss<span class="token punctuation">:</span> <span class="token number">8.8825</span> Acc<span class="token punctuation">:</span> <span class="token number">0.6245</span>
Time elapsed 49m 24s
valid Loss<span class="token punctuation">:</span> <span class="token number">13.3052</span> Acc<span class="token punctuation">:</span> <span class="token number">0.5831</span>
Optimizer learning rate <span class="token punctuation">:</span> <span class="token number">0.0010000</span>

Epoch <span class="token number">8</span><span class="token operator">/</span><span class="token number">19</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
Time elapsed 55m 17s
train Loss<span class="token punctuation">:</span> <span class="token number">3.3563</span> Acc<span class="token punctuation">:</span> <span class="token number">0.7869</span>
Time elapsed 55m 48s
valid Loss<span class="token punctuation">:</span> <span class="token number">6.5123</span> Acc<span class="token punctuation">:</span> <span class="token number">0.7090</span>
Optimizer learning rate <span class="token punctuation">:</span> <span class="token number">0.0100000</span>

Epoch <span class="token number">9</span><span class="token operator">/</span><span class="token number">19</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
Time elapsed 60m 50s
train Loss<span class="token punctuation">:</span> <span class="token number">8.4838</span> Acc<span class="token punctuation">:</span> <span class="token number">0.6474</span>
Time elapsed 61m 20s
valid Loss<span class="token punctuation">:</span> <span class="token number">15.0695</span> Acc<span class="token punctuation">:</span> <span class="token number">0.5526</span>
Optimizer learning rate <span class="token punctuation">:</span> <span class="token number">0.0001000</span>

Epoch <span class="token number">10</span><span class="token operator">/</span><span class="token number">19</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
Time elapsed 66m 12s
train Loss<span class="token punctuation">:</span> <span class="token number">5.7601</span> Acc<span class="token punctuation">:</span> <span class="token number">0.7353</span>
Time elapsed 66m 42s
valid Loss<span class="token punctuation">:</span> <span class="token number">8.1664</span> Acc<span class="token punctuation">:</span> <span class="token number">0.6785</span>
Optimizer learning rate <span class="token punctuation">:</span> <span class="token number">0.0010000</span>

Epoch <span class="token number">11</span><span class="token operator">/</span><span class="token number">19</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
Time elapsed 71m 36s
train Loss<span class="token punctuation">:</span> <span class="token number">2.9966</span> Acc<span class="token punctuation">:</span> <span class="token number">0.8066</span>
Time elapsed 72m 7s
valid Loss<span class="token punctuation">:</span> <span class="token number">6.3007</span> Acc<span class="token punctuation">:</span> <span class="token number">0.7200</span>
Optimizer learning rate <span class="token punctuation">:</span> <span class="token number">0.0100000</span>

Epoch <span class="token number">12</span><span class="token operator">/</span><span class="token number">19</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
Time elapsed 77m 9s
train Loss<span class="token punctuation">:</span> <span class="token number">8.8926</span> Acc<span class="token punctuation">:</span> <span class="token number">0.6525</span>
Time elapsed 77m 40s
valid Loss<span class="token punctuation">:</span> <span class="token number">14.6601</span> Acc<span class="token punctuation">:</span> <span class="token number">0.5318</span>
Optimizer learning rate <span class="token punctuation">:</span> <span class="token number">0.0001000</span>

Epoch <span class="token number">13</span><span class="token operator">/</span><span class="token number">19</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
Time elapsed 82m 29s
train Loss<span class="token punctuation">:</span> <span class="token number">4.9730</span> Acc<span class="token punctuation">:</span> <span class="token number">0.7424</span>
Time elapsed 82m 58s
valid Loss<span class="token punctuation">:</span> <span class="token number">8.0723</span> Acc<span class="token punctuation">:</span> <span class="token number">0.6834</span>
Optimizer learning rate <span class="token punctuation">:</span> <span class="token number">0.0010000</span>

Epoch <span class="token number">14</span><span class="token operator">/</span><span class="token number">19</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
Time elapsed 87m 56s
train Loss<span class="token punctuation">:</span> <span class="token number">3.0844</span> Acc<span class="token punctuation">:</span> <span class="token number">0.8146</span>
Time elapsed 88m 26s
valid Loss<span class="token punctuation">:</span> <span class="token number">7.1570</span> Acc<span class="token punctuation">:</span> <span class="token number">0.7200</span>
Optimizer learning rate <span class="token punctuation">:</span> <span class="token number">0.0010000</span>

Epoch <span class="token number">15</span><span class="token operator">/</span><span class="token number">19</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
Time elapsed 93m 37s
train Loss<span class="token punctuation">:</span> <span class="token number">2.8540</span> Acc<span class="token punctuation">:</span> <span class="token number">0.8213</span>
Time elapsed 94m 7s
valid Loss<span class="token punctuation">:</span> <span class="token number">7.2964</span> Acc<span class="token punctuation">:</span> <span class="token number">0.7054</span>
Optimizer learning rate <span class="token punctuation">:</span> <span class="token number">0.0010000</span>

Epoch <span class="token number">16</span><span class="token operator">/</span><span class="token number">19</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
Time elapsed 99m 3s
train Loss<span class="token punctuation">:</span> <span class="token number">2.7436</span> Acc<span class="token punctuation">:</span> <span class="token number">0.8239</span>
Time elapsed 99m 33s
valid Loss<span class="token punctuation">:</span> <span class="token number">7.2337</span> Acc<span class="token punctuation">:</span> <span class="token number">0.7139</span>
Optimizer learning rate <span class="token punctuation">:</span> <span class="token number">0.0010000</span>

Epoch <span class="token number">17</span><span class="token operator">/</span><span class="token number">19</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
Time elapsed 104m 26s
train Loss<span class="token punctuation">:</span> <span class="token number">2.6948</span> Acc<span class="token punctuation">:</span> <span class="token number">0.8303</span>
Time elapsed 104m 56s
valid Loss<span class="token punctuation">:</span> <span class="token number">7.0850</span> Acc<span class="token punctuation">:</span> <span class="token number">0.7188</span>
Optimizer learning rate <span class="token punctuation">:</span> <span class="token number">0.0010000</span>

Epoch <span class="token number">18</span><span class="token operator">/</span><span class="token number">19</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
Time elapsed 109m 49s
train Loss<span class="token punctuation">:</span> <span class="token number">2.6879</span> Acc<span class="token punctuation">:</span> <span class="token number">0.8252</span>
Time elapsed 110m 19s
valid Loss<span class="token punctuation">:</span> <span class="token number">6.6747</span> Acc<span class="token punctuation">:</span> <span class="token number">0.7115</span>
Optimizer learning rate <span class="token punctuation">:</span> <span class="token number">0.0100000</span>

Epoch <span class="token number">19</span><span class="token operator">/</span><span class="token number">19</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
Time elapsed 115m 16s
train Loss<span class="token punctuation">:</span> <span class="token number">9.2354</span> Acc<span class="token punctuation">:</span> <span class="token number">0.6598</span>
Time elapsed 115m 47s
valid Loss<span class="token punctuation">:</span> <span class="token number">14.9602</span> Acc<span class="token punctuation">:</span> <span class="token number">0.5892</span>
Optimizer learning rate <span class="token punctuation">:</span> <span class="token number">0.0001000</span>

Training complete <span class="token keyword">in</span> 115m 47s
Best val Acc<span class="token punctuation">:</span> <span class="token number">0.720049</span>
</code></pre> 
<h4><a id="42_683"></a>4.2.训练所有层</h4> 
<p>我们从上次训练好最优的那个全连接层的参数开始，以此为基础训练所有层，设置<code>param.requires_grad = True</code>表明接下来训练全部网络，之后把学习率调小一点，衰减函数为每7次衰减为原来的1/10，损失函数不变</p> 
<pre><code class="prism language-python"><span class="token keyword">for</span> param <span class="token keyword">in</span> model_ft<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    param<span class="token punctuation">.</span>requires_grad <span class="token operator">=</span> <span class="token boolean">True</span>

<span class="token comment"># 再继续训练所有的参数，学习率调小一点</span>
optimizer <span class="token operator">=</span> optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>params_to_update<span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">1e-4</span><span class="token punctuation">)</span>
scheduler <span class="token operator">=</span> optim<span class="token punctuation">.</span>lr_scheduler<span class="token punctuation">.</span>StepLR<span class="token punctuation">(</span>optimizer_ft<span class="token punctuation">,</span> step_size<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span> gamma<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span>

<span class="token comment"># 损失函数</span>
criterion <span class="token operator">=</span> nn<span class="token punctuation">.</span>NLLLoss<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>导入之前最优的结果：</p> 
<pre><code class="prism language-python"><span class="token comment"># Load the checkpoint</span>

checkpoint <span class="token operator">=</span> torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
best_acc <span class="token operator">=</span> checkpoint<span class="token punctuation">[</span><span class="token string">'best_acc'</span><span class="token punctuation">]</span>
model_ft<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>checkpoint<span class="token punctuation">[</span><span class="token string">'state_dict'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
optimizer<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>checkpoint<span class="token punctuation">[</span><span class="token string">'optimizer'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">#model_ft.class_to_idx = checkpoint['mapping']</span>
</code></pre> 
<p>开始训练：</p> 
<pre><code class="prism language-python">model_ft<span class="token punctuation">,</span> val_acc_history<span class="token punctuation">,</span> train_acc_history<span class="token punctuation">,</span> valid_losses<span class="token punctuation">,</span> train_losses<span class="token punctuation">,</span> LRs  <span class="token operator">=</span> train_model<span class="token punctuation">(</span>model_ft<span class="token punctuation">,</span> dataloaders<span class="token punctuation">,</span> criterion<span class="token punctuation">,</span> optimizer<span class="token punctuation">,</span> num_epochs<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> is_inception<span class="token operator">=</span><span class="token punctuation">(</span>model_name<span class="token operator">==</span><span class="token string">"inception"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>训练结果：</p> 
<pre><code class="prism language-python">Epoch <span class="token number">0</span><span class="token operator">/</span><span class="token number">4</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
Time elapsed 11m 45s
train Loss<span class="token punctuation">:</span> <span class="token number">2.5644</span> Acc<span class="token punctuation">:</span> <span class="token number">0.8303</span>
Time elapsed 12m 14s
valid Loss<span class="token punctuation">:</span> <span class="token number">8.0441</span> Acc<span class="token punctuation">:</span> <span class="token number">0.6956</span>
F<span class="token punctuation">:</span>\F_software\Anaconda\lib\site<span class="token operator">-</span>packages\torch\optim\lr_scheduler<span class="token punctuation">.</span>py<span class="token punctuation">:</span><span class="token number">134</span><span class="token punctuation">:</span> UserWarning<span class="token punctuation">:</span> Detected call of `lr_scheduler<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>` before `optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>`<span class="token punctuation">.</span> In PyTorch <span class="token number">1.1</span><span class="token number">.0</span> <span class="token keyword">and</span> later<span class="token punctuation">,</span> you should call them <span class="token keyword">in</span> the opposite order<span class="token punctuation">:</span> `optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>` before `lr_scheduler<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>`<span class="token punctuation">.</span>  Failure to do this will result <span class="token keyword">in</span> PyTorch skipping the first value of the learning rate schedule<span class="token punctuation">.</span> See more details at https<span class="token punctuation">:</span><span class="token operator">//</span>pytorch<span class="token punctuation">.</span>org<span class="token operator">/</span>docs<span class="token operator">/</span>stable<span class="token operator">/</span>optim<span class="token punctuation">.</span>html<span class="token comment">#how-to-adjust-learning-rate</span>
  <span class="token string">"https://pytorch.org/docs/stable/optim.html#how-to-adjust-learning-rate"</span><span class="token punctuation">,</span> UserWarning<span class="token punctuation">)</span>
F<span class="token punctuation">:</span>\F_software\Anaconda\lib\site<span class="token operator">-</span>packages\torch\optim\lr_scheduler<span class="token punctuation">.</span>py<span class="token punctuation">:</span><span class="token number">154</span><span class="token punctuation">:</span> UserWarning<span class="token punctuation">:</span> The epoch parameter <span class="token keyword">in</span> `scheduler<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>` was <span class="token keyword">not</span> necessary <span class="token keyword">and</span> <span class="token keyword">is</span> being deprecated where possible<span class="token punctuation">.</span> Please use `scheduler<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>` to step the scheduler<span class="token punctuation">.</span> During the deprecation<span class="token punctuation">,</span> <span class="token keyword">if</span> epoch <span class="token keyword">is</span> different <span class="token keyword">from</span> <span class="token boolean">None</span><span class="token punctuation">,</span> the closed form <span class="token keyword">is</span> used instead of the new chainable form<span class="token punctuation">,</span> where available<span class="token punctuation">.</span> Please <span class="token builtin">open</span> an issue <span class="token keyword">if</span> you are unable to replicate your use <span class="token keyword">case</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span><span class="token operator">//</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>pytorch<span class="token operator">/</span>pytorch<span class="token operator">/</span>issues<span class="token operator">/</span>new<span class="token operator">/</span>choose<span class="token punctuation">.</span>
  warnings<span class="token punctuation">.</span>warn<span class="token punctuation">(</span>EPOCH_DEPRECATION_WARNING<span class="token punctuation">,</span> UserWarning<span class="token punctuation">)</span>
Optimizer learning rate <span class="token punctuation">:</span> <span class="token number">0.0010000</span>

Epoch <span class="token number">1</span><span class="token operator">/</span><span class="token number">4</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
Time elapsed 22m 39s
train Loss<span class="token punctuation">:</span> <span class="token number">2.4003</span> Acc<span class="token punctuation">:</span> <span class="token number">0.8352</span>
Time elapsed 23m 6s
valid Loss<span class="token punctuation">:</span> <span class="token number">6.4505</span> Acc<span class="token punctuation">:</span> <span class="token number">0.7176</span>
Optimizer learning rate <span class="token punctuation">:</span> <span class="token number">0.0010000</span>

Epoch <span class="token number">2</span><span class="token operator">/</span><span class="token number">4</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
Time elapsed 33m 32s
train Loss<span class="token punctuation">:</span> <span class="token number">2.3979</span> Acc<span class="token punctuation">:</span> <span class="token number">0.8375</span>
Time elapsed 33m 60s
valid Loss<span class="token punctuation">:</span> <span class="token number">7.3643</span> Acc<span class="token punctuation">:</span> <span class="token number">0.7164</span>
Optimizer learning rate <span class="token punctuation">:</span> <span class="token number">0.0010000</span>

Epoch <span class="token number">3</span><span class="token operator">/</span><span class="token number">4</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
Time elapsed 44m 30s
train Loss<span class="token punctuation">:</span> <span class="token number">2.2851</span> Acc<span class="token punctuation">:</span> <span class="token number">0.8393</span>
Time elapsed 44m 56s
valid Loss<span class="token punctuation">:</span> <span class="token number">6.0566</span> Acc<span class="token punctuation">:</span> <span class="token number">0.7274</span>
Optimizer learning rate <span class="token punctuation">:</span> <span class="token number">0.0010000</span>

Epoch <span class="token number">4</span><span class="token operator">/</span><span class="token number">4</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
Time elapsed 55m 28s
train Loss<span class="token punctuation">:</span> <span class="token number">2.1712</span> Acc<span class="token punctuation">:</span> <span class="token number">0.8449</span>
Time elapsed 55m 56s
valid Loss<span class="token punctuation">:</span> <span class="token number">5.6752</span> Acc<span class="token punctuation">:</span> <span class="token number">0.7408</span>
Optimizer learning rate <span class="token punctuation">:</span> <span class="token number">0.0010000</span>

Training complete <span class="token keyword">in</span> 55m 56s
Best val Acc<span class="token punctuation">:</span> <span class="token number">0.740831</span>
</code></pre> 
<p>训练时CPU和GPU的使用情况截图：</p> 
<p><img src="https://images2.imgbox.com/00/b9/DIENtvYn_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="5_766"></a>5.测试网络效果</h3> 
<h4><a id="51_767"></a>5.1.测试数据预处理</h4> 
<p>首先将新训练好的<code>checkpoint.pth</code>重命名为<code>seriouscheckpoint.pth</code>，之后加载训练好的模型：</p> 
<pre><code class="prism language-python">model_ft<span class="token punctuation">,</span> input_size <span class="token operator">=</span> initialize_model<span class="token punctuation">(</span>model_name<span class="token punctuation">,</span> <span class="token number">102</span><span class="token punctuation">,</span> feature_extract<span class="token punctuation">,</span> use_pretrained<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token comment"># GPU模式</span>
model_ft <span class="token operator">=</span> model_ft<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>

<span class="token comment"># 保存文件的名字</span>
filename<span class="token operator">=</span><span class="token string">'seriouscheckpoint.pth'</span>

<span class="token comment"># 加载模型</span>
checkpoint <span class="token operator">=</span> torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
best_acc <span class="token operator">=</span> checkpoint<span class="token punctuation">[</span><span class="token string">'best_acc'</span><span class="token punctuation">]</span>
model_ft<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>checkpoint<span class="token punctuation">[</span><span class="token string">'state_dict'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li>测试数据处理方法需要跟训练时一致才可以</li><li>crop操作的目的是保证输入的大小是一致的</li><li>标准化操作也是必须的，用跟训练数据相同的mean和std,但是需要注意一点训练数据是在0-1上进行标准化，所以测试数据也需要先归一化</li><li>PyTorch中颜色通道是第一个维度，跟很多工具包都不一样，需要转换</li></ul> 
<p>定义图像处理函数<code>process_image()</code>：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">process_image</span><span class="token punctuation">(</span>image_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 读取测试数据</span>
    img <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>image_path<span class="token punctuation">)</span>
    <span class="token comment"># Resize,thumbnail方法只能进行缩小，所以进行了判断</span>
    <span class="token keyword">if</span> img<span class="token punctuation">.</span>size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> img<span class="token punctuation">.</span>size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        img<span class="token punctuation">.</span>thumbnail<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        img<span class="token punctuation">.</span>thumbnail<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># Crop操作</span>
    left_margin <span class="token operator">=</span> <span class="token punctuation">(</span>img<span class="token punctuation">.</span>width<span class="token operator">-</span><span class="token number">224</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span>
    bottom_margin <span class="token operator">=</span> <span class="token punctuation">(</span>img<span class="token punctuation">.</span>height<span class="token operator">-</span><span class="token number">224</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span>
    right_margin <span class="token operator">=</span> left_margin <span class="token operator">+</span> <span class="token number">224</span>
    top_margin <span class="token operator">=</span> bottom_margin <span class="token operator">+</span> <span class="token number">224</span>
    img <span class="token operator">=</span> img<span class="token punctuation">.</span>crop<span class="token punctuation">(</span><span class="token punctuation">(</span>left_margin<span class="token punctuation">,</span> bottom_margin<span class="token punctuation">,</span> right_margin<span class="token punctuation">,</span>   
                      top_margin<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 相同的预处理方法</span>
    img <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">255</span>
    mean <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">#provided mean</span>
    std <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">#provided std</span>
    img <span class="token operator">=</span> <span class="token punctuation">(</span>img <span class="token operator">-</span> mean<span class="token punctuation">)</span><span class="token operator">/</span>std
    
    <span class="token comment"># 注意颜色通道应该放在第一个位置</span>
    img <span class="token operator">=</span> img<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> img
</code></pre> 
<p>定义图像展示函数<code>imshow()</code>：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">imshow</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> ax<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> title<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""展示数据"""</span>
    <span class="token keyword">if</span> ax <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        fig<span class="token punctuation">,</span> ax <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 颜色通道还原</span>
    image <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 预处理还原</span>
    mean <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    std <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    image <span class="token operator">=</span> std <span class="token operator">*</span> image <span class="token operator">+</span> mean
    image <span class="token operator">=</span> np<span class="token punctuation">.</span>clip<span class="token punctuation">(</span>image<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    
    ax<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
    ax<span class="token punctuation">.</span>set_title<span class="token punctuation">(</span>title<span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> ax
</code></pre> 
<p>尝试展示其中一个图像：</p> 
<pre><code class="prism language-python">image_path <span class="token operator">=</span> <span class="token string">'image_06621.jpg'</span>
img <span class="token operator">=</span> process_image<span class="token punctuation">(</span>image_path<span class="token punctuation">)</span>
imshow<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
</code></pre> 
<p>结果：<br> <img src="https://images2.imgbox.com/2b/90/WE4FRVl0_o.png" alt="在这里插入图片描述"><br> <code>img.shape</code>查看图像格式：</p> 
<pre><code class="prism language-python"><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">)</span>
</code></pre> 
<p>得到一个batch的测试数据：</p> 
<pre><code class="prism language-python"><span class="token comment"># 得到一个batch的测试数据</span>
dataiter <span class="token operator">=</span> <span class="token builtin">iter</span><span class="token punctuation">(</span>dataloaders<span class="token punctuation">[</span><span class="token string">'valid'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
images<span class="token punctuation">,</span> labels <span class="token operator">=</span> dataiter<span class="token punctuation">.</span><span class="token builtin">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

model_ft<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> train_on_gpu<span class="token punctuation">:</span>
    output <span class="token operator">=</span> model_ft<span class="token punctuation">(</span>images<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    output <span class="token operator">=</span> model_ft<span class="token punctuation">(</span>images<span class="token punctuation">)</span>
</code></pre> 
<p>这里output表示对一个batch中每一个数据得到其属于各个类别的可能性</p> 
<p><code>output.shape</code>查看<code>output</code>数据维度：</p> 
<pre><code class="prism language-python"><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">)</span>
</code></pre> 
<p><code>torch.max()</code>函数计算标签值：</p> 
<pre><code class="prism language-python">_<span class="token punctuation">,</span> preds_tensor <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>output<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

preds <span class="token operator">=</span> np<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span>preds_tensor<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token keyword">not</span> train_on_gpu <span class="token keyword">else</span> np<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span>preds_tensor<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

preds
</code></pre> 
<p>打印每一张图片对应的结果索引：</p> 
<pre><code class="prism language-python">array<span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token number">49</span><span class="token punctuation">,</span>  <span class="token number">70</span><span class="token punctuation">,</span>  <span class="token number">93</span><span class="token punctuation">,</span>  <span class="token number">43</span><span class="token punctuation">,</span>  <span class="token number">55</span><span class="token punctuation">,</span>  <span class="token number">43</span><span class="token punctuation">,</span>  <span class="token number">77</span><span class="token punctuation">,</span>  <span class="token number">77</span><span class="token punctuation">,</span>  <span class="token number">76</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>int64<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="52_889"></a>5.2.结果可视化</h4> 
<pre><code class="prism language-python">fig<span class="token operator">=</span>plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
columns <span class="token operator">=</span><span class="token number">3</span>
rows <span class="token operator">=</span> <span class="token number">3</span>

<span class="token keyword">for</span> idx <span class="token keyword">in</span> <span class="token builtin">range</span> <span class="token punctuation">(</span>columns<span class="token operator">*</span>rows<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ax <span class="token operator">=</span> fig<span class="token punctuation">.</span>add_subplot<span class="token punctuation">(</span>rows<span class="token punctuation">,</span> columns<span class="token punctuation">,</span> idx<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> xticks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> yticks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>im_convert<span class="token punctuation">(</span>images<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    ax<span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">"{} ({})"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>cat_to_name<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>preds<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cat_to_name<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>labels<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 color<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">"green"</span> <span class="token keyword">if</span> cat_to_name<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>preds<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">==</span>cat_to_name<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>labels<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">else</span> <span class="token string">"red"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>在<strong>训练所有层</strong>时<code>batch_size</code>的大小设置为10，因此可绘制出3x3的图像，结果如下（绿色标题代表识别成功，红色标题代表识别失败，括号里面为真实值，括号外为预测值）：</p> 
<p><img src="https://images2.imgbox.com/49/ba/axMhpNMC_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/97b2a19b556fbbad193e8fb32b463a85/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">一键清理系统垃圾文件.BAT</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/87784a6f83db6313452da4c0cc725925/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Xception实现动物识别（TensorFlow）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>