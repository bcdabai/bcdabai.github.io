<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>百度ueditor粘贴图片自动上传到服务器(Java版) - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="百度ueditor粘贴图片自动上传到服务器(Java版)" />
<meta property="og:description" content="在之前在工作中遇到在富文本编辑器中粘贴图片不能展示的问题，于是各种网上扒拉，终于找到解决方案，在这里感谢一下知乎中众大神以及TheViper。
通过知乎提供的思路找到粘贴的原理，通过TheViper找到粘贴图片的方法。
其原理为一下步骤：
监听粘贴事件；【用于插入图片】
获取光标位置；【记录图片插入位置】
获取剪切板内容；【主要是获取文件】
上传剪切板图片；
在指定光标位置插入图片。
以下是代码部分：
1.获取光标代码部分，大部分都是直接利用TheViper的代码，只是做了简单的修改，在获取光标的位置添加了插件子集document对象，因为直接使用document对象获取不到光标位置
var isSupportRange = typeof document.createRange == &#39;function&#39;;
var currentRange,
_parentElement;
// 获取当前光标多在位置
function getCurrentRange(target) {
var selection,
range;
if (isSupportRange) {
selection = target.getSelection();
if (selection.getRangeAt &amp;&amp; selection.rangeCount) {
range = selection.getRangeAt(0);
_parentElement = range.commonAncestorContainer;
}
} else {
range = target.selection.createRange();
_parentElement = range.parentElement();
}
return range;
}
function saveSelection(target) {
currentRange = getCurrentRange(target);
}
function _restoreSelection() {" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/ae314952b0a9613d6dd8277cdeb7e605/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-13T14:31:15+08:00" />
<meta property="article:modified_time" content="2023-04-13T14:31:15+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">百度ueditor粘贴图片自动上传到服务器(Java版)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>在之前在工作中遇到在富文本编辑器中粘贴图片不能展示的问题，于是各种网上扒拉，终于找到解决方案，在这里感谢一下知乎中众大神以及TheViper。</p> 
<p>通过知乎提供的思路找到粘贴的原理，通过TheViper找到粘贴图片的方法。</p> 
<p>其原理为一下步骤：</p> 
<p>监听粘贴事件；【用于插入图片】</p> 
<p>获取光标位置；【记录图片插入位置】</p> 
<p>获取剪切板内容；【主要是获取文件】</p> 
<p>上传剪切板图片；</p> 
<p>在指定光标位置插入图片。</p> 
<p>以下是代码部分：</p> 
<p>1.获取光标代码部分，大部分都是直接利用TheViper的代码，只是做了简单的修改，在获取光标的位置添加了插件子集document对象，因为直接使用document对象获取不到光标位置</p> 
<p>var isSupportRange = typeof document.createRange == 'function';</p> 
<p>    var currentRange,</p> 
<p>        _parentElement;</p> 
<p>    // 获取当前光标多在位置</p> 
<p>    function getCurrentRange(target) {<!-- --></p> 
<p>        var selection,</p> 
<p>            range;</p> 
<p></p> 
<p>        if (isSupportRange) {<!-- --></p> 
<p>            selection = target.getSelection();</p> 
<p>            if (selection.getRangeAt &amp;&amp; selection.rangeCount) {<!-- --></p> 
<p>                range = selection.getRangeAt(0);</p> 
<p>                _parentElement = range.commonAncestorContainer;</p> 
<p>            }</p> 
<p>        } else {<!-- --></p> 
<p>            range = target.selection.createRange();</p> 
<p>            _parentElement = range.parentElement();</p> 
<p>        }</p> 
<p>        return range;</p> 
<p>    }</p> 
<p></p> 
<p>    function saveSelection(target) {<!-- --></p> 
<p>        currentRange = getCurrentRange(target);</p> 
<p>    }</p> 
<p></p> 
<p>    function _restoreSelection() {<!-- --></p> 
<p>        if (!currentRange) {<!-- --></p> 
<p>            return;</p> 
<p>        }</p> 
<p></p> 
<p>        var selection,</p> 
<p>            range;</p> 
<p></p> 
<p>        if (isSupportRange) {<!-- --></p> 
<p>            selection = document.getSelection();</p> 
<p>            selection.removeAllRanges();</p> 
<p>            selection.addRange(currentRange);</p> 
<p>        } else {<!-- --></p> 
<p>            range = document.selection.createRange();</p> 
<p>            range.setEndPoint('EndToEnd', currentRange);</p> 
<p>            if (currentRange.text.length === 0) {<!-- --></p> 
<p>                range.collapse(false);</p> 
<p>            } else {<!-- --></p> 
<p>                range.setEndPoint('StartToStart', currentRange);</p> 
<p>            }</p> 
<p>            range.select();</p> 
<p>        }</p> 
<p>    }</p> 
<p></p> 
<p>    function insertImage(html,target) {<!-- --></p> 
<p>        if (document.selection)</p> 
<p>            currentRange.pasteHTML(html);</p> 
<p>        else</p> 
<p>            target.execCommand("insertImage", false, html);</p> 
<p>        saveSelection();</p> 
<p>    }</p> 
<p></p> 
<p>2.监听粘贴事件、获取上传图片、上传至服务器并添加至编辑器</p> 
<p>CKEDITOR.instances['document-info'].on('instanceReady', function(e) {<!-- --></p> 
<p>    this.document.on('paste', function(event) {<!-- --></p> 
<p>        var target = event.sender.$;</p> 
<p>        saveSelection(target);</p> 
<p>        var items = event.data.$.clipboardData.items;</p> 
<p>        if (!items) {<!-- --></p> 
<p>            return;</p> 
<p>        }</p> 
<p>        for (var i = items.length - 1; i &gt;= 0; i--) {<!-- --></p> 
<p>            if (items[i].kind == 'file' &amp;&amp; items[i].type.indexOf('image/') !== -1) {<!-- --></p> 
<p>                var file = items[i].getAsFile();</p> 
<p>                if (file) {<!-- --></p> 
<p>                    if (file.size === 0) {<!-- --></p> 
<p>                        return;</p> 
<p>                    }</p> 
<p></p> 
<p>                    var formData = new FormData();</p> 
<p>                    formData.append("file", file);</p> 
<p></p> 
<p>                    $.ajax({<!-- --></p> 
<p>                        method: 'POST',</p> 
<p>                        url: url,</p> 
<p>                        data: formData,</p> 
<p>                        processData: false,</p> 
<p>                        contentType: false,</p> 
<p>                        success: function(response) {<!-- --></p> 
<p>                            var _img_html = response.url;</p> 
<p>                            insertImage(_img_html,target);</p> 
<p>                        }</p> 
<p>                    });</p> 
<p>                }</p> 
<p>            }</p> 
<p>        }</p> 
<p>    });</p> 
<p>});</p> 
<p>优化后的代码变得更加精简</p> 
<p>    //手动粘贴</p> 
<p>     this.PasteManual = function ()</p> 
<p>     {<!-- --></p> 
<p>         if (!this.setuped)</p> 
<p>        {<!-- --></p> 
<p>            this.setup_tip(); return;</p> 
<p>         }</p> 
<p>         if (!this.chrome45 &amp;&amp; !_this.edge)</p> 
<p>         {<!-- --></p> 
<p></p> 
<p>            this.app.paste();</p> 
<p>         }</p> 
<p>         else if (this.chrome45)</p> 
<p>         {<!-- --></p> 
<p>            this.app.paste();</p> 
<p>         }</p> 
<p>         else if(this.edge)</p> 
<p>         {<!-- --></p> 
<p>            this.app.paste();</p> 
<p>         }</p> 
<p>     };</p> 
<p></p> 
<p>前台的引用也非常的简单：</p> 
<p>&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&gt;</p> 
<p>&lt;html xmlns="http://www.w3.org/1999/xhtml"&gt;</p> 
<p>&lt;head&gt;</p> 
<p>     &lt;meta http-equiv="Content-Type" content="text/html;charset=utf-8"/&gt;</p> 
<p>     &lt;title&gt;WordPaster-jsp-ueditor-1.2.6.0&lt;/title&gt;</p> 
<p>     &lt;script type="text/javascript" src="ueditor.config.js" charset="utf-8"&gt;&lt;/script&gt;</p> 
<p>     &lt;script type="text/javascript" src="ueditor.all.min.js" charset="utf-8"&gt;&lt;/script&gt;</p> 
<p>     &lt;link type="text/css" rel="Stylesheet" href="WordPaster/css/WordPaster.css"/&gt;</p> 
<p>    &lt;link type="text/css" rel="Stylesheet" href="WordPaster/js/skygqbox.css" /&gt;</p> 
<p>    &lt;script type="text/javascript" src="WordPaster/js/json2.min.js" charset="utf-8"&gt;&lt;/script&gt;</p> 
<p>    &lt;script type="text/javascript" src="WordPaster/js/jquery-1.4.min.js" charset="utf-8"&gt;&lt;/script&gt;</p> 
<p>    &lt;script type="text/javascript" src="WordPaster/js/w.edge.js" charset="utf-8"&gt;&lt;/script&gt;</p> 
<p>    &lt;script type="text/javascript" src="WordPaster/js/w.app.js" charset="utf-8"&gt;&lt;/script&gt;</p> 
<p>    &lt;script type="text/javascript" src="WordPaster/js/w.file.js" charset="utf-8"&gt;&lt;/script&gt;</p> 
<p>    &lt;script type="text/javascript" src="WordPaster/js/skygqbox.js" charset="utf-8"&gt;&lt;/script&gt;</p> 
<p>    &lt;script type="text/javascript" src="WordPaster/js/WordPaster.js" charset="utf-8"&gt;&lt;/script&gt;</p> 
<p>&lt;/head&gt;</p> 
<p>&lt;body&gt;</p> 
<p>     &lt;textarea name="后台取值的key" id="myEditor"&gt;这里写你的初始化内容&lt;/textarea&gt;</p> 
<p>     &lt;script type="text/javascript"&gt;</p> 
<p>        var pasterMgr = new WordPasterManager();</p> 
<p>    pasterMgr.Config["PostUrl"] = "http://localhost:8080/WordPaster2UEditor1.4x/upload.jsp"</p> 
<p>    pasterMgr.Load();//加载控件</p> 
<p></p> 
<p>        var ue = UE.getEditor('myEditor');</p> 
<p>        </p> 
<p>         ue.ready(function() {<!-- --></p> 
<p>             //设置编辑器的内容</p> 
<p>             ue.setContent('hello');</p> 
<p>             //获取html内容，返回: &lt;p&gt;hello&lt;/p&gt;</p> 
<p>             var html = ue.getContent();</p> 
<p>             //获取纯文本内容，返回: hello</p> 
<p>             var txt = ue.getContentTxt();</p> 
<p>             pasterMgr.SetEditor(ue);</p> 
<p>         });</p> 
<p>                  </p> 
<p>     &lt;/script&gt;</p> 
<p>&lt;/body&gt;</p> 
<p>&lt;/html&gt;</p> 
<p></p> 
<p></p> 
<p>数据提交部分需要注意</p> 
<p>processData: false,</p> 
<p>contentType: false,</p> 
<p>这两项需要设置，否则文件不能正常上传</p> 
<p></p> 
<p>该问题没有完美的解决，存在以下疑问，如有想法，请告知。</p> 
<p>1.从word中复制图片为rtf格式，不能被保存，并解析图片，有待解决；</p> 
<p>2.只能单个文件复制，多个文件复制存在问题。这个问题使用WordPaster插件解决掉了，能够批量上传Word中的所有图片，并且保留Word样式，效果如下：</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/d8/be/Itv3I0eH_o.gif"></p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/12/96/rhEWtmHU_o.gif"> </p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/25/75/UsrHUnSM_o.gif"> </p> 
<p>视频演示：</p> 
<div class="csdn-video-box"> 
 <iframe id="vFC12eik-1681367467036" frameborder="0" src="https://player.bilibili.com/player.html?aid=652331903" allowfullscreen="true" data-mediaembed="bilibili"></iframe> 
 <p>Word一键粘贴(导入)插件-WordPress-整合教程</p> 
</div> 
<p> </p> 
<p>服务器能够接收到图片，并进行保存</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/5c/39/WFj4M1Ra_o.jpg"></p> 
<p>编辑器中的图片地址已经全部被替换成了服务器的图片地址，其它的用户也能够正常访问 </p> 
<p>在接触该问题前期，错误的解决思路：</p> 
<p>1.通过input控件上传，因浏览器安全设置原因，不允许input:file赋值；</p> 
<p>2.使用convas将图片转换为base64存储，该处也有问题，传唤base64时，存在跨域问题。</p> 
<p>经过这些处理基本上实现了一个完整的Word图片上传插件（WordPaster），能够自动上传剪切板中的图片，能够自动上传Word中的所有图片，使用起来非常的方便，有需要的朋友可以直接下载使用</p> 
<p>更多详细资料可以参考这篇文章：</p> 
<p><a href="http://blog.ncmem.com/wordpress/2019/08/12/ueditor-word%E5%9B%BE%E7%89%87%E8%BD%AC%E5%AD%98%E4%BA%A4%E4%BA%92/" rel="nofollow" title="详细思路及源码">详细思路及源码</a></p> 
<p>示例下载：</p> 
<p><a href="https://gitee.com/xproer/wordpaster-vue3-cli-ueditor1.5" rel="nofollow" title="wordpaster-vue3-cli-ueditor1.5">wordpaster-vue3-cli-ueditor1.5</a>，<a href="https://gitee.com/xproer/wordpaster-vue-ueditor1.5" rel="nofollow" title="wordpaster-vue-ueditor1.5">wordpaster-vue-ueditor1.5</a>，<a href="https://gitee.com/xproer/wordpaster-asp.net-ueditor1.5x" rel="nofollow" title="wordpaster-asp.net-ueditor1.5x">wordpaster-asp.net-ueditor1.5x</a>，<a href="https://gitee.com/xproer/wordpaster-php-ueditor1x" rel="nofollow" title="wordpaster-php-ueditor1x">wordpaster-php-ueditor1x</a>，<a href="https://gitee.com/xproer/wordpaster-jsp-ueditor1x%E2%80%8B" rel="nofollow" title="wordpaster-jsp-ueditor1x​">wordpaster-jsp-ueditor1x​</a></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0e2e3628c500edb3e3f245c5692aa87f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">SqlServer 添加指定用户限制访问表或试图的权限</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c5afda1e1c963a6243b084675e3a0abb/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">GNU Makefile教程入门</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>