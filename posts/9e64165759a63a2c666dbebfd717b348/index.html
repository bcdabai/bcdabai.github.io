<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>C#播放音频的正确姿势（一）——NAudio的简介与基础播放 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="C#播放音频的正确姿势（一）——NAudio的简介与基础播放" />
<meta property="og:description" content="前言 各网查了一圈，NAudio相关中文资料较少。鉴于本人最近在使用此库的播放音频方面有所涉及，在此将自己的学习过程与经验总结与大家分享，同时也欢迎大佬探讨和指正。
简介 为什么使用NAudio NAudio为.NET平台下的开源库，采用ML-PL协议，开源地址：https://github.com/naudio/NAudio。截至今日，已有约2.4k的stars。
NAudio功能强大，且其入门容易。
强大在于：它支持许多音频操作，可实现多种API播放与录制、多种不同音频格式、音频格式转换（重采样、位深、声道等）、音频编码、多通道播放、音频效果处理等等（详细介绍可以看Github readme）。
入门容易在于：对C#的语法、结构友好，且对于一个仅仅是播放声音的需求，几行即可搞定：
using(var audioFile = new AudioFileReader(audioFile)) using(var outputDevice = new WaveOutEvent()) { outputDevice.Init(audioFile); outputDevice.Play(); // 异步执行 while (outputDevice.PlaybackState == PlaybackState.Playing) { Thread.Sleep(1000); } } Demo来自于官方Readme
另一方面，基于NAudio本身的架构值得学习
其框架系统、完善，但实际开箱即用的功能并不是十分的齐全（相对于Bass），对于一个喜爱倒腾的人来说，容易激发学习研究的兴趣，其官方教程与例子很是齐全。
快速入门：https://github.com/naudio/NAudio#tutorials
深入学习：https://markheath.net/category/naudio（作者博客）
与其他播放方式对比 基于使用角度考虑，NAudio的优势在于，它是一个原生的.NET轻量库（其底层与其他API交互，但透明于使用者）。在不需要COM、独立SDK、手动P/Invoke的同时，对于音频交互更加可控、并且可以完成比以上更加复杂的功能。当然其也有一定的不足，例如目前无法跨平台，底层API强依赖于Windows（作者表示期待.NET Core的Span&lt;T&gt;的后续发展，时机成熟会考虑跨平台）。
目前常见的播放方案：
方式简介备注系统事件声音仅播放系统事件声音System.Media.SystemSounds 静态类SoundPlayer使用方便。但是仅支持PCM的wav播放、单通道播放System.Media.SoundPlayer类Windows Media Player COM组件要求电脑上安装WMP，仅能完成简单播放功能，不利于自定义化MME API (Multimedia Extensions)自由度高。但是由于未经封装，若需求复杂则操作复杂，且P/Invoke不安全winmm.dllDirectX自由度高，相较于MME更为现代化，能从硬件层完成更多音频功能DirectX SDKBass功能强大的封装，但常见交换库对C#的语法、结构不友好Bass.NET（需进行授权使用） 或 ManagedBass 还有很多未列出。
例1：制作一个简易的音乐播放器 目标：制作一个Winform的音乐播放器，仅实现读取mp3、播放、暂停、停止、进度拖动及显示、音量控制功能。
为了直观的展示，本例将弱化OOP封装思想。
回顾开篇的代码：
using(var audioFile = new AudioFileReader(audioFile)) using(var outputDevice = new WaveOutEvent()) { outputDevice.Init(audioFile); outputDevice." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/9e64165759a63a2c666dbebfd717b348/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-02-26T17:32:05+08:00" />
<meta property="article:modified_time" content="2020-02-26T17:32:05+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">C#播放音频的正确姿势（一）——NAudio的简介与基础播放</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>前言</h2> 
<p>各网查了一圈，NAudio相关中文资料较少。鉴于本人最近在使用此库的播放音频方面有所涉及，在此将自己的学习过程与经验总结与大家分享，同时也欢迎大佬探讨和指正。</p> 
<h2><a id="_3"></a>简介</h2> 
<h3><a id="NAudio_4"></a>为什么使用NAudio</h3> 
<p>NAudio为.NET平台下的开源库，采用ML-PL协议，开源地址：<a href="https://github.com/naudio/NAudio">https://github.com/naudio/NAudio</a>。截至今日，已有约2.4k的stars。</p> 
<p><strong>NAudio功能强大，且其入门容易。</strong><br> 强大在于：它支持许多音频操作，可实现多种API播放与录制、多种不同音频格式、音频格式转换（重采样、位深、声道等）、音频编码、多通道播放、音频效果处理等等（详细介绍可以看Github readme）。<br> 入门容易在于：对C#的语法、结构友好，且对于一个仅仅是播放声音的需求，几行即可搞定：</p> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span><span class="token punctuation">(</span><span class="token keyword">var</span> audioFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AudioFileReader</span><span class="token punctuation">(</span>audioFile<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">using</span><span class="token punctuation">(</span><span class="token keyword">var</span> outputDevice <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WaveOutEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    outputDevice<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span>audioFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    outputDevice<span class="token punctuation">.</span><span class="token function">Play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 异步执行</span>
    
    <span class="token keyword">while</span> <span class="token punctuation">(</span>outputDevice<span class="token punctuation">.</span>PlaybackState <span class="token operator">==</span> PlaybackState<span class="token punctuation">.</span>Playing<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><em>Demo来自于<a href="https://github.com/naudio/NAudio/blob/master/Docs/PlayAudioFileConsoleApp.md">官方Readme</a></em></p> 
<p><strong>另一方面，基于NAudio本身的架构值得学习</strong><br> 其框架系统、完善，但实际开箱即用的功能并不是十分的齐全（相对于<a href="http://www.un4seen.com/bass.html" rel="nofollow">Bass</a>），对于一个喜爱倒腾的人来说，容易激发学习研究的兴趣，其官方教程与例子很是齐全。<br> 快速入门：<a href="https://github.com/naudio/NAudio#tutorials">https://github.com/naudio/NAudio#tutorials</a><br> 深入学习：<a href="https://markheath.net/category/naudio" rel="nofollow">https://markheath.net/category/naudio</a>（作者博客）</p> 
<h3><a id="_31"></a>与其他播放方式对比</h3> 
<p>基于使用角度考虑，NAudio的优势在于，它是一个原生的.NET轻量库（其底层与其他API交互，但透明于使用者）。在不需要COM、独立SDK、手动P/Invoke的同时，对于音频交互更加可控、并且可以完成比以上更加复杂的功能。当然其也有一定的不足，例如目前无法跨平台，底层API强依赖于Windows（作者表示期待.NET Core的Span&lt;T&gt;的后续发展，时机成熟会考虑跨平台）。</p> 
<p><strong>目前常见的播放方案</strong>：</p> 
<table><thead><tr><th>方式</th><th>简介</th><th>备注</th></tr></thead><tbody><tr><td>系统事件声音</td><td>仅播放系统事件声音</td><td><code>System.Media.SystemSounds</code> 静态类</td></tr><tr><td>SoundPlayer</td><td>使用方便。但是仅支持PCM的wav播放、单通道播放</td><td><code>System.Media.SoundPlayer</code>类</td></tr><tr><td>Windows Media Player COM组件</td><td>要求电脑上安装WMP，仅能完成简单播放功能，不利于自定义化</td><td></td></tr><tr><td>MME API (Multimedia Extensions)</td><td>自由度高。但是由于未经封装，若需求复杂则操作复杂，且P/Invoke不安全</td><td>winmm.dll</td></tr><tr><td>DirectX</td><td>自由度高，相较于MME更为现代化，能从硬件层完成更多音频功能</td><td>DirectX SDK</td></tr><tr><td>Bass</td><td>功能强大的封装，但常见交换库对C#的语法、结构不友好</td><td>Bass.NET（需进行授权使用） 或 ManagedBass</td></tr></tbody></table> 
<p>还有很多未列出。</p> 
<h2><a id="1_46"></a>例1：制作一个简易的音乐播放器</h2> 
<p>目标：制作一个Winform的音乐播放器，仅实现读取mp3、播放、暂停、停止、进度拖动及显示、音量控制功能。<br> <em>为了直观的展示，本例将弱化OOP封装思想。</em></p> 
<p><strong>回顾开篇的代码：</strong></p> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span><span class="token punctuation">(</span><span class="token keyword">var</span> audioFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AudioFileReader</span><span class="token punctuation">(</span>audioFile<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">using</span><span class="token punctuation">(</span><span class="token keyword">var</span> outputDevice <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WaveOutEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    outputDevice<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span>audioFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    outputDevice<span class="token punctuation">.</span><span class="token function">Play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 异步执行</span>
    
    <span class="token keyword">while</span> <span class="token punctuation">(</span>outputDevice<span class="token punctuation">.</span>PlaybackState <span class="token operator">==</span> PlaybackState<span class="token punctuation">.</span>Playing<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>显然，这只能完成最基础的播放功能。而且对于一个GUI播放器而言，这样做会带来很多问题。<br> 首先它会在播放时阻塞线程，其次当播放完毕就会立刻释放资源，无法对其进行任何控制。</p> 
<p><strong>针对以上缺陷完善代码：</strong></p> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span> System<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>ComponentModel<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>Data<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>Drawing<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>IO<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>Linq<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>Text<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>Threading<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>Windows<span class="token punctuation">.</span>Forms<span class="token punctuation">;</span>
<span class="token keyword">using</span> NAudio<span class="token punctuation">.</span>Wave<span class="token punctuation">;</span>
<span class="token keyword">using</span> NAudio<span class="token punctuation">.</span>Wave<span class="token punctuation">.</span>SampleProviders<span class="token punctuation">;</span>

<span class="token keyword">namespace</span> SimplePlayer
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">partial</span> <span class="token keyword">class</span> <span class="token class-name">FormPlayer</span> <span class="token punctuation">:</span> <span class="token class-name">Form</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">private</span> <span class="token class-name">IWavePlayer</span> _device<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">AudioFileReader</span> _reader<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token function">FormPlayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">InitializeComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">btnPlay_Click</span><span class="token punctuation">(</span><span class="token keyword">object</span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">PlayAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">btnPause_Click</span><span class="token punctuation">(</span><span class="token keyword">object</span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">PauseAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">btnStop_Click</span><span class="token punctuation">(</span><span class="token keyword">object</span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">StopAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">btnOpen_Click</span><span class="token punctuation">(</span><span class="token keyword">object</span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">var</span> ofd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OpenFileDialog</span>
            <span class="token punctuation">{<!-- --></span>
                Filter <span class="token operator">=</span> <span class="token string">"支持的文件|*.mp3;*.wav;*.aiff|所有文件|*.*"</span><span class="token punctuation">,</span>
                Multiselect <span class="token operator">=</span> <span class="token keyword">false</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> result <span class="token operator">=</span> ofd<span class="token punctuation">.</span><span class="token function">ShowDialog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> DialogResult<span class="token punctuation">.</span>OK<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

            <span class="token function">DisposeAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">try</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">var</span> fileName <span class="token operator">=</span> ofd<span class="token punctuation">.</span>FileName<span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>File<span class="token punctuation">.</span><span class="token function">Exists</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">FileNotFoundException</span><span class="token punctuation">(</span><span class="token string">"所选文件不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                _device <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WaveOutEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Create device</span>
                _reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AudioFileReader</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Create reader</span>

                _device<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span>_reader<span class="token punctuation">)</span><span class="token punctuation">;</span>
                _device<span class="token punctuation">.</span>PlaybackStopped <span class="token operator">+</span><span class="token operator">=</span> Device_OnPlaybackStopped<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">DisposeAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                MessageBox<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">Form_Closed</span><span class="token punctuation">(</span><span class="token keyword">object</span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">DisposeAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">Device_OnPlaybackStopped</span><span class="token punctuation">(</span><span class="token keyword">object</span> obj<span class="token punctuation">,</span> <span class="token class-name">StoppedEventArgs</span> arg<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">StopAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">StopAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _device<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_reader <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> _reader<span class="token punctuation">.</span>Position <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">PlayAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _device<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">Play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">PauseAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _device<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">Pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">DisposeDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_device <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                _device<span class="token punctuation">.</span>PlaybackStopped <span class="token operator">-</span><span class="token operator">=</span> Device_OnPlaybackStopped<span class="token punctuation">;</span>
                _device<span class="token punctuation">.</span><span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">DisposeAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _reader<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">DisposeDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>以上完成了一个可以打开文件、播放、暂停、停止、释放资源的基础功能播放器。接下来完善一下进度显示以及进度调整。</p> 
<pre><code class="prism language-csharp">        <span class="token keyword">private</span> <span class="token class-name">CancellationTokenSource</span> _cts<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">bool</span> _sliderLock<span class="token punctuation">;</span> <span class="token comment">// 逻辑锁，当为true时不更新界面上的进度</span>
        
        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">sliderProgress_MouseDown</span><span class="token punctuation">(</span><span class="token keyword">object</span> sender<span class="token punctuation">,</span> <span class="token class-name">MouseEventArgs</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _sliderLock <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">;</span> <span class="token comment">// 拖动开始，停止更新界面</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">sliderProgress_MouseUp</span><span class="token punctuation">(</span><span class="token keyword">object</span> sender<span class="token punctuation">,</span> <span class="token class-name">MouseEventArgs</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 释放鼠标时，应用目标进度</span>
            _reader<span class="token punctuation">.</span>CurrentTime <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromMilliseconds</span><span class="token punctuation">(</span>sliderProgress<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">UpdateProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            _sliderLock <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span> <span class="token comment">// 拖动结束，恢复更新界面</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">sliderProgress_ValueChanged</span><span class="token punctuation">(</span><span class="token keyword">object</span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_sliderLock<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 拖动时可以直观看到目标进度</span>
                lblPosition<span class="token punctuation">.</span>Text <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromMilliseconds</span><span class="token punctuation">(</span>sliderProgress<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token string">@"mm\:ss"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">StartUpdateProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">// 此处可用Timer完成而不是手动循环，但不建议使用UI线程上的Timer</span>
            Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>_cts<span class="token punctuation">.</span>IsCancellationRequested<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>_device<span class="token punctuation">.</span>PlaybackState <span class="token operator">==</span> PlaybackState<span class="token punctuation">.</span>Playing<span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                    	<span class="token comment">// 若为播放状态，持续更新界面</span>
                        <span class="token function">BeginInvoke</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Action</span><span class="token punctuation">(</span>UpdateProgress<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">else</span>
                    <span class="token punctuation">{<!-- --></span>
                        Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">UpdateProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">var</span> currentTime <span class="token operator">=</span> _reader<span class="token operator">?</span><span class="token punctuation">.</span>CurrentTime <span class="token operator">?</span><span class="token operator">?</span> TimeSpan<span class="token punctuation">.</span>Zero<span class="token punctuation">;</span> <span class="token comment">// 当前时间</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_sliderLock<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                sliderProgress<span class="token punctuation">.</span>Value <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>currentTime<span class="token punctuation">.</span>TotalMilliseconds<span class="token punctuation">;</span>
                lblPosition<span class="token punctuation">.</span>Text <span class="token operator">=</span> currentTime<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token string">@"mm\:ss"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// 更新此方法</span>
        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">btnOpen_Click</span><span class="token punctuation">(</span><span class="token keyword">object</span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                _device<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span>_reader<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">var</span> duration <span class="token operator">=</span> _reader<span class="token punctuation">.</span>TotalTime<span class="token punctuation">;</span> <span class="token comment">// 总时长</span>
                sliderProgress<span class="token punctuation">.</span>Maximum <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>duration<span class="token punctuation">.</span>TotalMilliseconds<span class="token punctuation">;</span>
                lblDuration<span class="token punctuation">.</span>Text <span class="token operator">=</span> duration<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token string">@"mm\:ss"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                _cts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CancellationTokenSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">StartUpdateProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 界面更新线程</span>

                _device<span class="token punctuation">.</span>PlaybackStopped <span class="token operator">+</span><span class="token operator">=</span> Device_OnPlaybackStopped<span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// 更新此方法</span>
        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">StopAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_reader <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> _reader<span class="token punctuation">.</span>Position <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token function">UpdateProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span>

        <span class="token comment">// 更新此方法</span>
        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">DisposeAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _cts<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">Cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            _cts<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            _reader<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>以上完成了进度显示以及进度调整，里面包含了一些UI上的优化后的交互逻辑。其中涉及到了个人常用的Task / Cancellation的线程模式，可用<code>Timer</code>代替。</p> 
<p><strong>那么最后一个功能，如何进行音量控制？</strong> 事实上，<code>IWavePlayer</code>接口包含了<code>Volume</code>这个属性，所以如果仅仅要达成这个目标十分简单，只需进行属性设置即可：</p> 
<pre><code class="prism language-csharp">        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">SetVolume</span><span class="token punctuation">(</span><span class="token keyword">float</span> volume<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_device <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> _device<span class="token punctuation">.</span>Volume <span class="token operator">=</span> volume<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p><strong>然而，这样做法并不推荐，因为对于内部的WaveOutEvent等<code>IWavePlayer</code>实现，实际效果是从改变了系统的合成器中的音量</strong>，如图：<img src="https://images2.imgbox.com/ac/ff/mJZCpK9F_o.png" alt="图1"><br> 也就意味着，这将改变整个应用程序的音量，不利于之后进行程序内部混音。</p> 
<p>那将如何实现内部音量处理呢？这就涉及了DSP音频处理。在NAudio中，通过实现接口<code>ISampleProvider</code>，得到<code>WaveStream</code>提供音频原始数据并且进行处理，再将处理后的数据返回。将多个<code>ISampleProvider</code>链接起来进行顺序处理，最终将最外层的<code>ISampleProvider</code>交给<code>IWavePlayer</code>进行初始化<code>Init()</code>这样的一个处理模式。也就是说，其实基于上面的代码来看，<code>AudioFileReader</code>本身既是<code>WaveStream</code>，也实现了<code>ISampleProvider</code>。</p> 
<blockquote> 
 <p>https://stackoverflow.com/questions/46433790/how-to-chain-together-multiple-naudio-isampleprovider-effects</p> 
</blockquote> 
<p>说了这么多有点绕口，用简洁的方法表示，就是将之前的<br> <code>AudioFileReader -&gt; IWavePlayer.Init()</code><br> 替换成<br> <code>AudioFileReader -&gt; 某种可以控制音量的处理 -&gt; IWavePlayer.Init()</code></p> 
<p>在NAudio内置提供的DSP中，实现了音量处理相关的类<code>VolumeSampleProvider</code>，因此直接拿来用即可。</p> 
<p><em>以上内容推荐结合NAudio源码食用</em></p> 
<p><strong>根据以上所述，更新代码：</strong></p> 
<pre><code class="prism language-csharp">        <span class="token keyword">private</span> <span class="token class-name">VolumeSampleProvider</span> _volumeProvider<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">sliderVolume_ValueChanged</span><span class="token punctuation">(</span><span class="token keyword">object</span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">UpdateVolume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 更新此方法</span>
        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">UpdateVolume</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">var</span> volume <span class="token operator">=</span> sliderVolume<span class="token punctuation">.</span>Value <span class="token operator">/</span> <span class="token number">100f</span><span class="token punctuation">;</span>
            _volumeProvider<span class="token punctuation">.</span>Volume <span class="token operator">=</span> volume<span class="token punctuation">;</span>
            <span class="token comment">//if (_device != null) _device.Volume = volume;  // 注释这一句</span>
        <span class="token punctuation">}</span>
    
        <span class="token comment">// 更新此方法</span>
        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">btnOpen_Click</span><span class="token punctuation">(</span><span class="token keyword">object</span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                _reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AudioFileReader</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Create reader</span>

                <span class="token comment">// dsp start</span>
                _volumeProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VolumeSampleProvider</span><span class="token punctuation">(</span>_reader<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    Volume <span class="token operator">=</span> sliderVolume<span class="token punctuation">.</span>Value <span class="token operator">/</span> <span class="token number">100f</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token comment">// dsp end</span>

                _device<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span>_volumeProvider<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//_device.Init(_reader); // 之前是reader，现改为VolumeSampleProvider</span>

                <span class="token keyword">var</span> duration <span class="token operator">=</span> _reader<span class="token punctuation">.</span>TotalTime<span class="token punctuation">;</span> <span class="token comment">// 总时长</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>这样就对原始音频进行了处理（改变音量），然后输出。</p> 
<p><strong>完成后的全部代码：</strong></p> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span> System<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>IO<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>Threading<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>Windows<span class="token punctuation">.</span>Forms<span class="token punctuation">;</span>
<span class="token keyword">using</span> NAudio<span class="token punctuation">.</span>Wave<span class="token punctuation">;</span>
<span class="token keyword">using</span> NAudio<span class="token punctuation">.</span>Wave<span class="token punctuation">.</span>SampleProviders<span class="token punctuation">;</span>

<span class="token keyword">namespace</span> SimplePlayer
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">partial</span> <span class="token keyword">class</span> <span class="token class-name">FormPlayer</span> <span class="token punctuation">:</span> <span class="token class-name">Form</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">private</span> <span class="token class-name">IWavePlayer</span> _device<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">AudioFileReader</span> _reader<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">VolumeSampleProvider</span> _volumeProvider<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">CancellationTokenSource</span> _cts<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token keyword">bool</span> _sliderLock<span class="token punctuation">;</span> <span class="token comment">// 逻辑锁，当为true时不更新界面上的进度</span>

        <span class="token keyword">public</span> <span class="token function">FormPlayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">InitializeComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">btnPlay_Click</span><span class="token punctuation">(</span><span class="token keyword">object</span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">PlayAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">btnPause_Click</span><span class="token punctuation">(</span><span class="token keyword">object</span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">PauseAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">btnStop_Click</span><span class="token punctuation">(</span><span class="token keyword">object</span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">StopAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">btnOpen_Click</span><span class="token punctuation">(</span><span class="token keyword">object</span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">var</span> ofd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OpenFileDialog</span>
            <span class="token punctuation">{<!-- --></span>
                Filter <span class="token operator">=</span> <span class="token string">"支持的文件|*.mp3;*.wav;*.aiff|所有文件|*.*"</span><span class="token punctuation">,</span>
                Multiselect <span class="token operator">=</span> <span class="token keyword">false</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> result <span class="token operator">=</span> ofd<span class="token punctuation">.</span><span class="token function">ShowDialog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> DialogResult<span class="token punctuation">.</span>OK<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

            <span class="token function">DisposeAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">try</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">var</span> fileName <span class="token operator">=</span> ofd<span class="token punctuation">.</span>FileName<span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>File<span class="token punctuation">.</span><span class="token function">Exists</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">FileNotFoundException</span><span class="token punctuation">(</span><span class="token string">"所选文件不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                _device <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WaveOutEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Create device</span>
                _reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AudioFileReader</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Create reader</span>

                <span class="token comment">// dsp start</span>
                _volumeProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VolumeSampleProvider</span><span class="token punctuation">(</span>_reader<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    Volume <span class="token operator">=</span> sliderVolume<span class="token punctuation">.</span>Value <span class="token operator">/</span> <span class="token number">100f</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token comment">// dsp end</span>

                _device<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span>_volumeProvider<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//_device.Init(_reader); // 之前是reader，现改为VolumeSampleProvider</span>
                <span class="token comment">// https://stackoverflow.com/questions/46433790/how-to-chain-together-multiple-naudio-isampleprovider-effects</span>

                <span class="token keyword">var</span> duration <span class="token operator">=</span> _reader<span class="token punctuation">.</span>TotalTime<span class="token punctuation">;</span> <span class="token comment">// 总时长</span>
                sliderProgress<span class="token punctuation">.</span>Maximum <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>duration<span class="token punctuation">.</span>TotalMilliseconds<span class="token punctuation">;</span>
                lblDuration<span class="token punctuation">.</span>Text <span class="token operator">=</span> duration<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token string">@"mm\:ss"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                _cts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CancellationTokenSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">StartUpdateProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 界面更新线程</span>

                _device<span class="token punctuation">.</span>PlaybackStopped <span class="token operator">+</span><span class="token operator">=</span> Device_OnPlaybackStopped<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">DisposeAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                MessageBox<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">sliderProgress_MouseDown</span><span class="token punctuation">(</span><span class="token keyword">object</span> sender<span class="token punctuation">,</span> <span class="token class-name">MouseEventArgs</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _sliderLock <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">;</span> <span class="token comment">// 拖动开始，停止更新界面</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">sliderProgress_MouseUp</span><span class="token punctuation">(</span><span class="token keyword">object</span> sender<span class="token punctuation">,</span> <span class="token class-name">MouseEventArgs</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 释放鼠标时，应用目标进度</span>
            _reader<span class="token punctuation">.</span>CurrentTime <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromMilliseconds</span><span class="token punctuation">(</span>sliderProgress<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">UpdateProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            _sliderLock <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span> <span class="token comment">// 拖动结束，恢复更新界面</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">sliderProgress_ValueChanged</span><span class="token punctuation">(</span><span class="token keyword">object</span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_sliderLock<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 拖动时可以直观看到目标进度</span>
                lblPosition<span class="token punctuation">.</span>Text <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromMilliseconds</span><span class="token punctuation">(</span>sliderProgress<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token string">@"mm\:ss"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">sliderVolume_ValueChanged</span><span class="token punctuation">(</span><span class="token keyword">object</span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">UpdateVolume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">Form_Load</span><span class="token punctuation">(</span><span class="token keyword">object</span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>

        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">Form_Closed</span><span class="token punctuation">(</span><span class="token keyword">object</span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">DisposeAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">Device_OnPlaybackStopped</span><span class="token punctuation">(</span><span class="token keyword">object</span> obj<span class="token punctuation">,</span> <span class="token class-name">StoppedEventArgs</span> arg<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">StopAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">StartUpdateProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 此处可用Timer完成而不是手动循环，但不建议使用UI线程上的Timer</span>
            Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>_cts<span class="token punctuation">.</span>IsCancellationRequested<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>_device<span class="token punctuation">.</span>PlaybackState <span class="token operator">==</span> PlaybackState<span class="token punctuation">.</span>Playing<span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// 若为播放状态，持续更新界面</span>
                        <span class="token function">BeginInvoke</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Action</span><span class="token punctuation">(</span>UpdateProgress<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">else</span>
                    <span class="token punctuation">{<!-- --></span>
                        Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">StopAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _device<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_reader <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> _reader<span class="token punctuation">.</span>Position <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token function">UpdateProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">PlayAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _device<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">Play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">PauseAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _device<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">Pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">UpdateProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">var</span> currentTime <span class="token operator">=</span> _reader<span class="token operator">?</span><span class="token punctuation">.</span>CurrentTime <span class="token operator">?</span><span class="token operator">?</span> TimeSpan<span class="token punctuation">.</span>Zero<span class="token punctuation">;</span> <span class="token comment">// 当前时间</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_sliderLock<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                sliderProgress<span class="token punctuation">.</span>Value <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>currentTime<span class="token punctuation">.</span>TotalMilliseconds<span class="token punctuation">;</span>
                lblPosition<span class="token punctuation">.</span>Text <span class="token operator">=</span> currentTime<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token string">@"mm\:ss"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">UpdateVolume</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">var</span> volume <span class="token operator">=</span> sliderVolume<span class="token punctuation">.</span>Value <span class="token operator">/</span> <span class="token number">100f</span><span class="token punctuation">;</span>
            _volumeProvider<span class="token punctuation">.</span>Volume <span class="token operator">=</span> volume<span class="token punctuation">;</span>
            <span class="token comment">//if (_device != null) _device.Volume = volume;  // 注释这一句</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">DisposeDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_device <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                _device<span class="token punctuation">.</span>PlaybackStopped <span class="token operator">-</span><span class="token operator">=</span> Device_OnPlaybackStopped<span class="token punctuation">;</span>
                _device<span class="token punctuation">.</span><span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">DisposeAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _cts<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">Cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            _cts<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            _reader<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">DisposeDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这样本例目标功能就实现完毕了，能实现最基础但是同时也可靠的音频播放功能。</p> 
<p><strong>注（坑）：</strong></p> 
<ul><li>IWavePlayer的创建，最好在STA线程中完成</li><li>一个进程中仅创建一个IWavePlayer为佳（若需进行多个通道进行播放，同时播放背景音与音效，可以关注一下我后面的更新）</li></ul> 
<p>相关源代码会随着本系列进行更新（如果不鸽）：<br> <a href="https://github.com/Milkitic/NAudioDemo">https://github.com/Milkitic/NAudioDemo</a></p> 
<p>顺便宣传一下个人在应用的一个NAudio相关的开源项目：<br> <a href="https://github.com/Milkitic/Osu-Player">https://github.com/Milkitic/Osu-Player</a></p> 
<p>参考：<br> [1] <a href="https://en.wikipedia.org/wiki/Windows_legacy_audio_components" rel="nofollow">Windows legacy audio components</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8ce062f0d27f52798e771dd90de601b6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">强大的中间人攻击工具（Bettercap）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c70ed40e13e063300dcc97e43096887b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">在Jupyter Notebook终止cell（代码块）而非终止（重启）整个Jupyter</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>