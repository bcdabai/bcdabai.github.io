<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【数据压缩实验五--JPEG】 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【数据压缩实验五--JPEG】" />
<meta property="og:description" content="数据压缩实验五--JPEG JPEG编解码原理编码原理解码原理 JPEG文件格式Segment的组织形式Segment Marker JPEG解码解码流程程序设计整体框架三个结构体struct huffman_tablestruct componentstruct jdec_private TRACE 实验步骤1.JPG文件输出YUV文件2.以txt文件输出所有的量化矩阵和所有的HUFFMAN码表输出DC，AC图像并统计其概率分布 JPEG编解码原理 编码原理 基本流程：
1.亮度信号零偏置电平下移，对于灰度级是2n的像素，通过减去2n-1,将无符号的整数值变成是有符号数。这样做的目的是使像素的绝对值出现3位10进制的概率大大减少。
2.DCT变换
对每个单独的彩色图像分量，把整个分量图像分成8×8的图像块，并进行8×8DCT变换，目的是去除图像数据的相关性，便于量化过程去除图像数据的空间冗余。
3.量化
利用人眼视觉特性设计而成的矩阵量化DCT系数，减小视觉冗余。因为人眼对亮度信号比色差信号更敏感，因此使用了两种量化表：亮度量化值和色差量化值；根据人眼对低频敏感，对高频不太敏感，对低频分量采取较细的量化，对高频分量采取较粗的量化。
4.熵编码
（1）对量化后的DC系数进行差分编码
8×8图像块经过DCT变换之后得到的DC直流系数有两个特点：系数的数值较大；相邻8×8图像块的DC系数值变化不大。根据这个特点，JPEG算法使用了差分脉冲调制编码（DPCM）技术对相邻图像块之间量化DC系数的差值进行编码。
（2）AC系数进行Z字扫描和游程编码后，再分别进行VLC编码
Z字扫描：由于DCT变换后，系数大多数集中在左上角，即低频分量区，因此采用Z字形按频率的高低顺序读出，可以出现很多连零的机会，可以使用游程编码。
游程编码：在JPEG和MPEG编码中规定为（run,level）：表示连续run个0，后面跟值为level的系数。
解码原理 解码是编码的逆过程。
JPEG文件格式 Segment的组织形式 JPEG在文件中均以Segment的形式组织，它具有以下特点：
（1）均以 0xFF 开始，后跟 1 byte 的 Marker 和 2 byte 的 Segment length（包含表示Length 本身所占用的 2 byte，不含“0xFF” &#43; “Marker” 所占用的 2 byte）；
（2）采用 Motorola 序（相对于 Intel 序），即保存时高位在前，低位在后；
（3）Data 部分中，0xFF 后若为 0x00，则跳过此字节不予处理；
Segment Marker SOI
SOI（start of image），表示图像的开始，标记代码FFD8。
APP0
标记代码：FFE0
APP0：Application,应用程序保留标记0。
给出如下信息：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/e0ebf9cbaf8105adc86d07eb49c5f3b6/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-06-04T18:00:45+08:00" />
<meta property="article:modified_time" content="2022-06-04T18:00:45+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【数据压缩实验五--JPEG】</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>数据压缩实验五--JPEG</h4> 
 <ul><li><a href="#JPEG_3" rel="nofollow">JPEG编解码原理</a></li><li><ul><li><a href="#_4" rel="nofollow">编码原理</a></li><li><a href="#_18" rel="nofollow">解码原理</a></li></ul> 
  </li><li><a href="#JPEG_20" rel="nofollow">JPEG文件格式</a></li><li><ul><li><a href="#Segment_21" rel="nofollow">Segment的组织形式</a></li><li><a href="#Segment_Marker_26" rel="nofollow">Segment Marker</a></li></ul> 
  </li><li><a href="#JPEG_52" rel="nofollow">JPEG解码</a></li><li><ul><li><a href="#_53" rel="nofollow">解码流程</a></li><li><a href="#_74" rel="nofollow">程序设计整体框架</a></li><li><a href="#_149" rel="nofollow">三个结构体</a></li><li><ul><li><a href="#struct_huffman_table_150" rel="nofollow">struct huffman_table</a></li><li><a href="#struct_component_167" rel="nofollow">struct component</a></li><li><a href="#struct_jdec_private_185" rel="nofollow">struct jdec_private</a></li></ul> 
   </li><li><a href="#TRACE_221" rel="nofollow">TRACE</a></li></ul> 
  </li><li><a href="#_228" rel="nofollow">实验步骤</a></li><li><ul><li><a href="#1JPGYUV_229" rel="nofollow">1.JPG文件输出YUV文件</a></li><li><a href="#2txtHUFFMAN_263" rel="nofollow">2.以txt文件输出所有的量化矩阵和所有的HUFFMAN码表</a></li><li><a href="#DCAC_395" rel="nofollow">输出DC，AC图像并统计其概率分布</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="JPEG_3"></a>JPEG编解码原理</h2> 
<h3><a id="_4"></a>编码原理</h3> 
<p><img src="https://images2.imgbox.com/8f/3e/IW7GQJqe_o.png" alt="在这里插入图片描述"><br> <strong>基本流程：</strong><br> 1.<strong>亮度信号零偏置电平下移</strong>，对于灰度级是2<sup>n</sup>的像素，通过减去2<sup>n-1</sup>,将无符号的整数值变成是有符号数。这样做的目的是使像素的绝对值出现3位10进制的概率大大减少。<br> 2.<strong>DCT变换</strong><br> 对每个单独的彩色图像分量，把整个分量图像分成8×8的图像块，并进行8×8DCT变换，目的是去除图像数据的相关性，便于量化过程去除图像数据的空间冗余。<br> 3.<strong>量化</strong><br> 利用人眼视觉特性设计而成的矩阵量化DCT系数，减小视觉冗余。因为人眼对亮度信号比色差信号更敏感，因此使用了两种量化表：亮度量化值和色差量化值；根据人眼对低频敏感，对高频不太敏感，对低频分量采取较细的量化，对高频分量采取较粗的量化。<br> 4.<strong>熵编码</strong><br> （1）<strong>对量化后的DC系数进行差分编码</strong><br> 8×8图像块经过DCT变换之后得到的DC直流系数有两个特点：系数的数值较大；相邻8×8图像块的DC系数值变化不大。根据这个特点，JPEG算法使用了差分脉冲调制编码（DPCM）技术对相邻图像块之间量化DC系数的差值进行编码。<br> （2）<strong>AC系数进行Z字扫描和游程编码后，再分别进行VLC编码</strong><br> <strong>Z字扫描</strong>：由于DCT变换后，系数大多数集中在左上角，即低频分量区，因此采用Z字形按频率的高低顺序读出，可以出现很多连零的机会，可以使用游程编码。<br> <strong>游程编码</strong>：在JPEG和MPEG编码中规定为（run,level）：表示连续run个0，后面跟值为level的系数。</p> 
<h3><a id="_18"></a>解码原理</h3> 
<p>解码是编码的逆过程。</p> 
<h2><a id="JPEG_20"></a>JPEG文件格式</h2> 
<h3><a id="Segment_21"></a>Segment的组织形式</h3> 
<p>JPEG在文件中均以Segment的形式组织，它具有以下特点：<br> （1）均以 <strong>0xFF</strong> 开始，后跟 1 byte 的 <strong>Marke</strong>r 和 2 byte 的 <strong>Segment length</strong>（包含表示Length 本身所占用的 2 byte，不含“0xFF” + “Marker” 所占用的 2 byte）；<br> （2）采用 Motorola 序（相对于 Intel 序），即保存时高位在前，低位在后；<br> （3）Data 部分中，0xFF 后若为 0x00，则跳过此字节不予处理；</p> 
<h3><a id="Segment_Marker_26"></a>Segment Marker</h3> 
<p><strong>SOI</strong><br> SOI（start of image），表示图像的开始，标记代码FFD8。<br> <strong>APP0</strong><br> 标记代码：FFE0<br> APP0：Application,应用程序保留标记0。<br> 给出如下信息：<br> <img src="https://images2.imgbox.com/af/38/uAAtkGJj_o.png" alt="在这里插入图片描述"><br> <strong>量化表DQT</strong><br> 量化表标记代码：FFDB<br> <img src="https://images2.imgbox.com/6e/17/X3aEJmlL_o.png" alt="在这里插入图片描述"><br> 精度及量化表 ID：<br> 1byte, 低位为量化表的 ID 的索引值，其取值范围为 0～3，所以说最多可能有四张量化表（亮度量化表，色度量化表，可能会有 R、G、B 各一张量化表）；而高位为量化精度，有两个可选值，0：8 位；1：16 位，这里是 00，代表量化精度为 8bit,即用一个字节来表示一个量化系数<br> <strong>SOF0</strong><br> 如：<br> <img src="https://images2.imgbox.com/36/d9/xGRa8V2i_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/c8/5d/WGIRzIbd_o.png" alt="在这里插入图片描述"><br> <strong>DHT</strong><br> <img src="https://images2.imgbox.com/a7/b0/cD5FrxVX_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/66/89/YNoQ1I06_o.png" alt="在这里插入图片描述"><br> <strong>SOS</strong><br> <img src="https://images2.imgbox.com/e1/94/2sRWZpv9_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/62/bc/c40UYkBG_o.png" alt="在这里插入图片描述"><br> <strong>EOI</strong><br> EOI（start of image），表示图像的结束，标记代码FFD9。</p> 
<h2><a id="JPEG_52"></a>JPEG解码</h2> 
<h3><a id="_53"></a>解码流程</h3> 
<p>1.读取文件<br> 2.解析 Segment Marker</p> 
<ul><li>2.1 解析 SOI</li><li>2.2 解析 APP0<br> – 检查标识“JFIF”及版本<br> – 得到一些参数</li><li>2.3解析 DQT<br> – 得到量化表长度（可能包含多张量化表）<br> – 得到量化表的精度<br> – 得到及检查量化表的序号（只能是 0 —— 3）<br> – 得到量化表内容（64 个数据）</li><li>2.4解析 SOF0<br> – 得到每个 sample 的比特数、长宽、颜色分量数<br> – 得到每个颜色分量的 ID、水平采样因子、垂直采样因子、使用的量化表<br> 序号（与 DQT 中序号对应）</li><li>2.5解析 DHT<br> – 得到 Huffman 表的类型（AC、DC）、序号<br> – 依据数据重建 Huffman 表</li><li>2.6解析 SOS<br> – 得到解析每个颜色分量的 DC、AC 值所使用的 Huffman 表序号（与 DHT中序号对应）</li></ul> 
<h3><a id="_74"></a>程序设计整体框架</h3> 
<p><strong>main函数</strong><br> 接受输入输出文件，并可选择输出文件的类型</p> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">int</span> output_format <span class="token operator">=</span> TINYJPEG_FMT_YUV420P<span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>output_filename<span class="token punctuation">,</span> <span class="token operator">*</span>input_filename<span class="token punctuation">;</span>
  clock_t start_time<span class="token punctuation">,</span> finish_time<span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> duration<span class="token punctuation">;</span>
  <span class="token keyword">int</span> current_argument<span class="token punctuation">;</span>
  <span class="token keyword">int</span> benchmark_mode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">TRACE</span></span>
  p_trace<span class="token operator">=</span><span class="token function">fopen</span><span class="token punctuation">(</span>TRACEFILE<span class="token punctuation">,</span><span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>p_trace<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
	  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"trace file open error!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token function">usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  current_argument <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
   <span class="token punctuation">{<!-- --></span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>current_argument<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"--benchmark"</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
       benchmark_mode <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
     <span class="token keyword">else</span>
       <span class="token keyword">break</span><span class="token punctuation">;</span>
     current_argument<span class="token operator">++</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;</span> current_argument<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token function">usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  input_filename <span class="token operator">=</span> argv<span class="token punctuation">[</span>current_argument<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>current_argument<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"yuv420p"</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
    output_format <span class="token operator">=</span> TINYJPEG_FMT_YUV420P<span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>current_argument<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"rgb24"</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
    output_format <span class="token operator">=</span> TINYJPEG_FMT_RGB24<span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>current_argument<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"bgr24"</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
    output_format <span class="token operator">=</span> TINYJPEG_FMT_BGR24<span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>current_argument<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"grey"</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
    output_format <span class="token operator">=</span> TINYJPEG_FMT_GREY<span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    <span class="token function">exitmessage</span><span class="token punctuation">(</span><span class="token string">"Bad format: need to be one of yuv420p, rgb24, bgr24, grey\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  output_filename <span class="token operator">=</span> argv<span class="token punctuation">[</span>current_argument<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  start_time <span class="token operator">=</span> <span class="token function">clock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>benchmark_mode<span class="token punctuation">)</span>
    <span class="token function">load_multiple_times</span><span class="token punctuation">(</span>input_filename<span class="token punctuation">,</span> output_filename<span class="token punctuation">,</span> output_format<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    <span class="token function">convert_one_image</span><span class="token punctuation">(</span>input_filename<span class="token punctuation">,</span> output_filename<span class="token punctuation">,</span> output_format<span class="token punctuation">)</span><span class="token punctuation">;</span>

  finish_time <span class="token operator">=</span> <span class="token function">clock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  duration <span class="token operator">=</span> finish_time <span class="token operator">-</span> start_time<span class="token punctuation">;</span>
  <span class="token function">snprintf</span><span class="token punctuation">(</span>error_string<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>error_string<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"Decoding finished in %u ticks\n"</span><span class="token punctuation">,</span> duration<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">TRACE</span></span>
  <span class="token function">fclose</span><span class="token punctuation">(</span>p_trace<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>tinyjpeg.c中的函数<br> <img src="https://images2.imgbox.com/dd/02/6BpXqqfK_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/5a/6b/luyiwxUx_o.png" alt="在这里插入图片描述"><br> parse_JFIF:解析marker标识<br> parse_DQT:解析DQT<br> parse_SOF:解析SOF<br> parse_DHT:解析DHT<br> parse_SOS:解析SOS<br> build_huffman_table:建立huffman表<br> build_quantization_table:建立量化表</p> 
<h3><a id="_149"></a>三个结构体</h3> 
<h4><a id="struct_huffman_table_150"></a>struct huffman_table</h4> 
<p>huffman查找表有两种实现方法，分别为huffman树的遍历和loookup查找表。优先选用lookup查找表，code_size给出每个符号的编码比特位数。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">struct</span> <span class="token class-name">huffman_table</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token comment">/* Fast look up table, using HUFFMAN_HASH_NBITS bits we can have directly the symbol,
   * if the symbol is &lt;0, then we need to look into the tree table */</span>
  <span class="token keyword">short</span> <span class="token keyword">int</span> lookup<span class="token punctuation">[</span>HUFFMAN_HASH_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">/* code size: give the number of bits of a symbol is encoded */</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> code_size<span class="token punctuation">[</span>HUFFMAN_HASH_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">/* some place to store value that is not encoded in the lookup table 
   * FIXME: Calculate if 256 value is enough to store all values
   */</span>
  <span class="token keyword">uint16_t</span> slowtable<span class="token punctuation">[</span><span class="token number">16</span><span class="token operator">-</span>HUFFMAN_HASH_NBITS<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> 
<h4><a id="struct_component_167"></a>struct component</h4> 
<p>包含struct huffman_table。<br> 定义了采样因子，量化表，AC和DC huffman表，前一个块的直流DCT系数（亮度编码为DPCM，需要使用上一个块的直流系数来解码），当前块的DCT系数。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">struct</span> <span class="token class-name">component</span> 
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> Hfactor<span class="token punctuation">;</span><span class="token comment">//水平采样因子</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> Vfactor<span class="token punctuation">;</span><span class="token comment">//垂直采样因子</span>
  <span class="token keyword">float</span> <span class="token operator">*</span>Q_table<span class="token punctuation">;</span><span class="token comment">//量化表		/* Pointer to the quantisation table to use */</span>
  <span class="token keyword">struct</span> <span class="token class-name">huffman_table</span> <span class="token operator">*</span>AC_table<span class="token punctuation">;</span><span class="token comment">//交流AC huffman表</span>
  <span class="token keyword">struct</span> <span class="token class-name">huffman_table</span> <span class="token operator">*</span>DC_table<span class="token punctuation">;</span><span class="token comment">//直流DC huffman表</span>
  <span class="token keyword">short</span> <span class="token keyword">int</span> previous_DC<span class="token punctuation">;</span>	<span class="token comment">/* Previous DC coefficient */</span>
  <span class="token keyword">short</span> <span class="token keyword">int</span> DCT<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span>		<span class="token comment">/* DCT coef */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">SANITY_CHECK</span></span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cid<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="struct_jdec_private_185"></a>struct jdec_private</h4> 
<p>包含struct huffman_table，struct component 。<br> 定义了图像宽高，数据流起始，数据流长度，量化表和huffman表。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">struct</span> <span class="token class-name">jdec_private</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token comment">/* Public variables */</span>
  <span class="token keyword">uint8_t</span> <span class="token operator">*</span>components<span class="token punctuation">[</span>COMPONENTS<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> height<span class="token punctuation">;</span>	<span class="token comment">/* Size of the image */</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> flags<span class="token punctuation">;</span>

  <span class="token comment">/* Private variables */</span>
  <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>stream_begin<span class="token punctuation">,</span> <span class="token operator">*</span>stream_end<span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> stream_length<span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>stream<span class="token punctuation">;</span>	<span class="token comment">/* Pointer to the current stream */</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> reservoir<span class="token punctuation">,</span> nbits_in_reservoir<span class="token punctuation">;</span>

  <span class="token keyword">struct</span> <span class="token class-name">component</span> component_infos<span class="token punctuation">[</span>COMPONENTS<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">float</span> Q_tables<span class="token punctuation">[</span>COMPONENTS<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span>		<span class="token comment">/* quantization tables */</span>
  <span class="token keyword">struct</span> <span class="token class-name">huffman_table</span> HTDC<span class="token punctuation">[</span>HUFFMAN_TABLES<span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">/* DC huffman tables   */</span>
  <span class="token keyword">struct</span> <span class="token class-name">huffman_table</span> HTAC<span class="token punctuation">[</span>HUFFMAN_TABLES<span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">/* AC huffman tables   */</span>
  <span class="token keyword">int</span> default_huffman_table_initialized<span class="token punctuation">;</span>
  <span class="token keyword">int</span> restart_interval<span class="token punctuation">;</span>
  <span class="token keyword">int</span> restarts_to_go<span class="token punctuation">;</span>				<span class="token comment">/* MCUs left in this restart interval */</span>
  <span class="token keyword">int</span> last_rst_marker_seen<span class="token punctuation">;</span>			<span class="token comment">/* Rst marker is incremented each time */</span>

  <span class="token comment">/* Temp space used after the IDCT to store each components */</span>
  <span class="token keyword">uint8_t</span> Y<span class="token punctuation">[</span><span class="token number">64</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Cr<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Cb<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  jmp_buf jump_state<span class="token punctuation">;</span>
  <span class="token comment">/* Internal Pointer use for colorspace conversion, do not modify it !!! */</span>
  <span class="token keyword">uint8_t</span> <span class="token operator">*</span>plane<span class="token punctuation">[</span>COMPONENTS<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="TRACE_221"></a>TRACE</h3> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TRACE</span> <span class="token expression"><span class="token number">1</span></span><span class="token comment">//add by nxn //1为使用TRACE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name">TRACEFILE</span> <span class="token string">"trace_jpeg.txt"</span><span class="token comment">//add by nxn //TRACE文件名，程序运行过程中输出的数据会写入trace_jpeg.txt中</span></span>
</code></pre> 
<h2><a id="_228"></a>实验步骤</h2> 
<h3><a id="1JPGYUV_229"></a>1.JPG文件输出YUV文件</h3> 
<p>修改loadjpg.c中的write_yuv函数：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">write_yuv</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>components<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  FILE <span class="token operator">*</span>F<span class="token punctuation">;</span>
  <span class="token keyword">char</span> temp<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token function">snprintf</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token string">"%s.Y"</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
  F <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fwrite</span><span class="token punctuation">(</span>components<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> F<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fclose</span><span class="token punctuation">(</span>F<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">snprintf</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token string">"%s.U"</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
  F <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fwrite</span><span class="token punctuation">(</span>components<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> width<span class="token operator">*</span>height<span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> F<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fclose</span><span class="token punctuation">(</span>F<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">snprintf</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token string">"%s.V"</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
  F <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fwrite</span><span class="token punctuation">(</span>components<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> width<span class="token operator">*</span>height<span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> F<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fclose</span><span class="token punctuation">(</span>F<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//添加代码</span>
  <span class="token function">snprintf</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token string">"%s.YUV"</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
  F <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span><span class="token string">"wb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fwrite</span><span class="token punctuation">(</span>components<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> F<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fwrite</span><span class="token punctuation">(</span>components<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> width<span class="token operator">*</span>height<span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span> F<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fwrite</span><span class="token punctuation">(</span>components<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> width<span class="token operator">*</span>height <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> F<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fclose</span><span class="token punctuation">(</span>F<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>修改命令参数：<br> <img src="https://images2.imgbox.com/93/cd/b8KeXciw_o.png" alt="在这里插入图片描述"><br> 得到的YUV文件，用YUVviewer打开（图像宽和高均为1024）<br> <img src="https://images2.imgbox.com/d5/d2/8hwrTBku_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="2txtHUFFMAN_263"></a>2.以txt文件输出所有的量化矩阵和所有的HUFFMAN码表</h3> 
<p><strong>量化矩阵</strong><br> 在build_quantization_table函数中增加代码：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">build_quantization_table</span><span class="token punctuation">(</span><span class="token keyword">float</span> <span class="token operator">*</span>qtable<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>ref_table<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token comment">/* Taken from libjpeg. Copyright Independent JPEG Group's LLM idct.
   * For float AA&amp;N IDCT method, divisors are equal to quantization
   * coefficients scaled by scalefactor[row]*scalefactor[col], where
   *   scalefactor[0] = 1
   *   scalefactor[k] = cos(k*PI/16) * sqrt(2)    for k=1..7
   * We apply a further scale factor of 8.
   * What's actually stored is 1/divisor so that the inner loop can
   * use a multiplication rather than a division.
   */</span>
  <span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">double</span> aanscalefactor<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
     <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.387039845</span><span class="token punctuation">,</span> <span class="token number">1.306562965</span><span class="token punctuation">,</span> <span class="token number">1.175875602</span><span class="token punctuation">,</span>
     <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.785694958</span><span class="token punctuation">,</span> <span class="token number">0.541196100</span><span class="token punctuation">,</span> <span class="token number">0.275899379</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>zz <span class="token operator">=</span> zigzag<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
     <span class="token keyword">for</span> <span class="token punctuation">(</span>j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       <span class="token operator">*</span>qtable<span class="token operator">++</span> <span class="token operator">=</span> ref_table<span class="token punctuation">[</span><span class="token operator">*</span>zz<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">*</span> aanscalefactor<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> aanscalefactor<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
  <span class="token comment">//增加代码</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">TRACE</span></span>
  <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> zz1 <span class="token operator">=</span> zigzag<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">fprintf</span><span class="token punctuation">(</span>p_trace<span class="token punctuation">,</span> <span class="token string">"%d"</span><span class="token punctuation">,</span> ref_table<span class="token punctuation">[</span><span class="token operator">*</span>zz1<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">==</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token function">fprintf</span><span class="token punctuation">(</span>p_trace<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
 
<span class="token punctuation">}</span>
</code></pre> 
<p>输出的量化矩阵保存在trace_jpeg.txt中<br> <img src="https://images2.imgbox.com/ab/64/WySqXVPT_o.png" alt="在这里插入图片描述"><br> <strong>HUFFMAN码表</strong><br> build_huffman_table函数可以输出HUFFMAN码表</p> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">build_huffman_table</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>bits<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>vals<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">huffman_table</span> <span class="token operator">*</span>table<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> code<span class="token punctuation">,</span> code_size<span class="token punctuation">,</span> val<span class="token punctuation">,</span> nbits<span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> huffsize<span class="token punctuation">[</span>HUFFMAN_BITS_SIZE<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">*</span>hz<span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> huffcode<span class="token punctuation">[</span>HUFFMAN_BITS_SIZE<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">*</span>hc<span class="token punctuation">;</span>
  <span class="token keyword">int</span> next_free_entry<span class="token punctuation">;</span>

  <span class="token comment">/*
   * Build a temp array 
   *   huffsize[X] =&gt; numbers of bits to write vals[X]
   */</span>
  hz <span class="token operator">=</span> huffsize<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">&lt;=</span><span class="token number">16</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
   <span class="token punctuation">{<!-- --></span>
     <span class="token keyword">for</span> <span class="token punctuation">(</span>j<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> j<span class="token operator">&lt;=</span>bits<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
       <span class="token operator">*</span>hz<span class="token operator">++</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
  <span class="token operator">*</span>hz <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token function">memset</span><span class="token punctuation">(</span>table<span class="token operator">-&gt;</span>lookup<span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>table<span class="token operator">-&gt;</span>lookup<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token operator">-</span>HUFFMAN_HASH_NBITS<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    table<span class="token operator">-&gt;</span>slowtable<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment">/* Build a temp array
   *   huffcode[X] =&gt; code used to write vals[X]
   */</span>
  code <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  hc <span class="token operator">=</span> huffcode<span class="token punctuation">;</span>
  hz <span class="token operator">=</span> huffsize<span class="token punctuation">;</span>
  nbits <span class="token operator">=</span> <span class="token operator">*</span>hz<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>hz<span class="token punctuation">)</span>
   <span class="token punctuation">{<!-- --></span>
     <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>hz <span class="token operator">==</span> nbits<span class="token punctuation">)</span>
      <span class="token punctuation">{<!-- --></span>
	<span class="token operator">*</span>hc<span class="token operator">++</span> <span class="token operator">=</span> code<span class="token operator">++</span><span class="token punctuation">;</span>
	hz<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
     code <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
     nbits<span class="token operator">++</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

  <span class="token comment">/*
   * Build the lookup table, and the slowtable if needed.
   */</span>
  next_free_entry <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> huffsize<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
   <span class="token punctuation">{<!-- --></span>
     val <span class="token operator">=</span> vals<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
     code <span class="token operator">=</span> huffcode<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
     code_size <span class="token operator">=</span> huffsize<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">TRACE</span></span>
     <span class="token function">fprintf</span><span class="token punctuation">(</span>p_trace<span class="token punctuation">,</span><span class="token string">"val=%2.2x code=%8.8x codesize=%2.2d\n"</span><span class="token punctuation">,</span> val<span class="token punctuation">,</span> code<span class="token punctuation">,</span> code_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 <span class="token function">fflush</span><span class="token punctuation">(</span>p_trace<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
     table<span class="token operator">-&gt;</span>code_size<span class="token punctuation">[</span>val<span class="token punctuation">]</span> <span class="token operator">=</span> code_size<span class="token punctuation">;</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>code_size <span class="token operator">&lt;=</span> HUFFMAN_HASH_NBITS<span class="token punctuation">)</span>
      <span class="token punctuation">{<!-- --></span>
	<span class="token comment">/*
	 * Good: val can be put in the lookup table, so fill all value of this
	 * column with value val 
	 */</span>
	<span class="token keyword">int</span> repeat <span class="token operator">=</span> <span class="token number">1UL</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span>HUFFMAN_HASH_NBITS <span class="token operator">-</span> code_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	code <span class="token operator">&lt;&lt;=</span> HUFFMAN_HASH_NBITS <span class="token operator">-</span> code_size<span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span> repeat<span class="token operator">--</span> <span class="token punctuation">)</span>
	  table<span class="token operator">-&gt;</span>lookup<span class="token punctuation">[</span>code<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span>

      <span class="token punctuation">}</span>
     <span class="token keyword">else</span>
      <span class="token punctuation">{<!-- --></span>
	<span class="token comment">/* Perhaps sorting the array will be an optimization */</span>
	<span class="token keyword">uint16_t</span> <span class="token operator">*</span>slowtable <span class="token operator">=</span> table<span class="token operator">-&gt;</span>slowtable<span class="token punctuation">[</span>code_size<span class="token operator">-</span>HUFFMAN_HASH_NBITS<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>slowtable<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	  slowtable<span class="token operator">+=</span><span class="token number">2</span><span class="token punctuation">;</span>
	slowtable<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> code<span class="token punctuation">;</span>
	slowtable<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span>
	slowtable<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token comment">/* TODO: NEED TO CHECK FOR AN OVERFLOW OF THE TABLE */</span>
      <span class="token punctuation">}</span>

   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/22/f7/yxIpr7wP_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="DCAC_395"></a>输出DC，AC图像并统计其概率分布</h3> 
<p>在tinyjpeg_decode中添加代码</p> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> file_length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    FILE<span class="token operator">*</span> DC_file <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"DC.yuv"</span><span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    FILE<span class="token operator">*</span> AC_file <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"AC.yuv"</span><span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-cpp"><span class="token keyword">unsigned</span> <span class="token keyword">char</span> dc<span class="token punctuation">;</span>
         <span class="token keyword">unsigned</span> <span class="token keyword">char</span> ac<span class="token punctuation">;</span>
         dc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>priv<span class="token operator">-&gt;</span>component_infos<span class="token operator">-&gt;</span>DCT<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">512.0</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//DC系数的取值范围[-512,511],转换为[0,255]的范围</span>
         ac <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">(</span>priv<span class="token operator">-&gt;</span>component_infos<span class="token operator">-&gt;</span>DCT<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//AC系数的取值范围为[-128,127]，将其转换为[0,255]的范围</span>
         <span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dc<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> DC_file<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ac<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> AC_file<span class="token punctuation">)</span><span class="token punctuation">;</span>
         file_length<span class="token operator">++</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-cpp"><span class="token keyword">unsigned</span> <span class="token keyword">char</span> uv <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> file_length <span class="token operator">/</span> <span class="token number">4</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>uv<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> DC_file<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>uv<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> AC_file<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">fclose</span><span class="token punctuation">(</span>DC_file<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fclose</span><span class="token punctuation">(</span>AC_file<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>得到DC,AC图像：<br> <img src="https://images2.imgbox.com/7d/74/UaMpn8Vy_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/0f/46/k8MkkZdG_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/653f758175de9b65c8e578bd296d401a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Java用户修改头像接口</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9af0a60cb7780d66f4afff68ca29f65c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">go-prometheus业务监控指标实战(一)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>