<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>解决opencv源代码编译找不到ffmpeg - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="解决opencv源代码编译找不到ffmpeg" />
<meta property="og:description" content="系统环境： 操作系统：Ubuntu18.04
硬件架构：X86_64
OpenCV版本：4.5.1或3.4.16
项目场景： 最近在研究OpenCV结合CUVIDEC解码视频流，就使用OpenCV源代码编译。结果发现无论如何都找不到ffmpeg。经过一系列研究终于找到了原因，记录如下。
问题描述 OpenCV4和OpenCV3编译当选择WITH_FFMPEG选项的时候不能找到ffmpeg模块。
原因分析： OpenCV-3.4.16和OpenCV-4.5.1两个版本略有差别，这个问题的答案我们可以在OpenCV的cmake文件里面找到答案。
先来看看opencv-3.4.16的cmake文件，在opencv-3.4.16的cmake文件夹下面找到OpenCVFindLibsVideo.cmake
# --- FFMPEG --- ocv_clear_vars(HAVE_FFMPEG) if(WITH_FFMPEG) # try FFmpeg autodetection if(OPENCV_FFMPEG_USE_FIND_PACKAGE) if(OPENCV_FFMPEG_USE_FIND_PACKAGE STREQUAL &#34;1&#34; OR OPENCV_FFMPEG_USE_FIND_PACKAGE STREQUAL &#34;ON&#34;) set(OPENCV_FFMPEG_USE_FIND_PACKAGE &#34;FFMPEG&#34;) endif() find_package(${OPENCV_FFMPEG_USE_FIND_PACKAGE}) # Required components: AVCODEC AVFORMAT AVUTIL SWSCALE if(FFMPEG_FOUND OR FFmpeg_FOUND) set(HAVE_FFMPEG TRUE) else() message(STATUS &#34;Can&#39;t find FFmpeg via find_package(${OPENCV_FFMPEG_USE_FIND_PACKAGE})&#34;) endif() elseif(WIN32 AND NOT ARM AND NOT OPENCV_FFMPEG_SKIP_DOWNLOAD) include(&#34;${OpenCV_SOURCE_DIR}/3rdparty/ffmpeg/ffmpeg.cmake&#34;) download_win_ffmpeg(FFMPEG_CMAKE_SCRIPT) if(FFMPEG_CMAKE_SCRIPT) set(HAVE_FFMPEG TRUE) set(HAVE_FFMPEG_WRAPPER 1) include(&#34;${FFMPEG_CMAKE_SCRIPT}&#34;) endif() elseif(PKG_CONFIG_FOUND) ocv_check_modules(FFMPEG libavcodec libavformat libavutil libswscale) ocv_check_modules(FFMPEG_libavresample libavresample) if(FFMPEG_libavresample_FOUND) ocv_append_build_options(FFMPEG FFMPEG_libavresample) endif() else() message(STATUS &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/62ad5ba7fbbe5597051f70546c1b4d3c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-06-01T15:32:05+08:00" />
<meta property="article:modified_time" content="2022-06-01T15:32:05+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">解决opencv源代码编译找不到ffmpeg</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>系统环境：</h2> 
<p>操作系统：Ubuntu18.04<br> 硬件架构：X86_64<br> OpenCV版本：4.5.1或3.4.16</p> 
<h2><a id="_4"></a>项目场景：</h2> 
<p>最近在研究OpenCV结合CUVIDEC解码视频流，就使用OpenCV源代码编译。结果发现无论如何都找不到<code>ffmpeg</code>。经过一系列研究终于找到了原因，记录如下。</p> 
<hr> 
<h2><a id="_9"></a>问题描述</h2> 
<p>OpenCV4和OpenCV3编译当选择<code>WITH_FFMPEG</code>选项的时候不能找到<code>ffmpeg</code>模块。</p> 
<hr> 
<h2><a id="_14"></a>原因分析：</h2> 
<p>OpenCV-3.4.16和OpenCV-4.5.1两个版本略有差别，这个问题的答案我们可以在<code>OpenCV</code>的<code>cmake</code>文件里面找到答案。</p> 
<p>先来看看<code>opencv-3.4.16</code>的<code>cmake</code>文件，在<code>opencv-3.4.16</code>的<code>cmake</code>文件夹下面找到<code>OpenCVFindLibsVideo.cmake</code></p> 
<pre><code class="prism language-powershell"><span class="token comment"># --- FFMPEG ---</span>
ocv_clear_vars<span class="token punctuation">(</span>HAVE_FFMPEG<span class="token punctuation">)</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>WITH_FFMPEG<span class="token punctuation">)</span>  <span class="token comment"># try FFmpeg autodetection</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>OPENCV_FFMPEG_USE_FIND_PACKAGE<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>OPENCV_FFMPEG_USE_FIND_PACKAGE STREQUAL <span class="token string">"1"</span> OR OPENCV_FFMPEG_USE_FIND_PACKAGE STREQUAL <span class="token string">"ON"</span><span class="token punctuation">)</span>
      <span class="token function">set</span><span class="token punctuation">(</span>OPENCV_FFMPEG_USE_FIND_PACKAGE <span class="token string">"FFMPEG"</span><span class="token punctuation">)</span>
    endif<span class="token punctuation">(</span><span class="token punctuation">)</span>
    find_package<span class="token punctuation">(</span>$<span class="token punctuation">{<!-- --></span>OPENCV_FFMPEG_USE_FIND_PACKAGE<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment"># Required components: AVCODEC AVFORMAT AVUTIL SWSCALE</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>FFMPEG_FOUND OR FFmpeg_FOUND<span class="token punctuation">)</span>
      <span class="token function">set</span><span class="token punctuation">(</span>HAVE_FFMPEG TRUE<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      message<span class="token punctuation">(</span>STATUS <span class="token string">"Can't find FFmpeg via find_package(${OPENCV_FFMPEG_USE_FIND_PACKAGE})"</span><span class="token punctuation">)</span>
    endif<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">elseif</span><span class="token punctuation">(</span>WIN32 AND NOT ARM AND NOT OPENCV_FFMPEG_SKIP_DOWNLOAD<span class="token punctuation">)</span>
    include<span class="token punctuation">(</span><span class="token string">"${OpenCV_SOURCE_DIR}/3rdparty/ffmpeg/ffmpeg.cmake"</span><span class="token punctuation">)</span>
    download_win_ffmpeg<span class="token punctuation">(</span>FFMPEG_CMAKE_SCRIPT<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>FFMPEG_CMAKE_SCRIPT<span class="token punctuation">)</span>
      <span class="token function">set</span><span class="token punctuation">(</span>HAVE_FFMPEG TRUE<span class="token punctuation">)</span>
      <span class="token function">set</span><span class="token punctuation">(</span>HAVE_FFMPEG_WRAPPER 1<span class="token punctuation">)</span>
      include<span class="token punctuation">(</span><span class="token string">"${FFMPEG_CMAKE_SCRIPT}"</span><span class="token punctuation">)</span>
    endif<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">elseif</span><span class="token punctuation">(</span>PKG_CONFIG_FOUND<span class="token punctuation">)</span>
    ocv_check_modules<span class="token punctuation">(</span>FFMPEG libavcodec libavformat libavutil libswscale<span class="token punctuation">)</span>
    ocv_check_modules<span class="token punctuation">(</span>FFMPEG_libavresample libavresample<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>FFMPEG_libavresample_FOUND<span class="token punctuation">)</span>
      ocv_append_build_options<span class="token punctuation">(</span>FFMPEG FFMPEG_libavresample<span class="token punctuation">)</span>
    endif<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">else</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    message<span class="token punctuation">(</span>STATUS <span class="token string">"Can't find ffmpeg - 'pkg-config' utility is missing"</span><span class="token punctuation">)</span>
  endif<span class="token punctuation">(</span><span class="token punctuation">)</span>
endif<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>HAVE_FFMPEG
    AND NOT HAVE_FFMPEG_WRAPPER
<span class="token punctuation">)</span>
  try_compile<span class="token punctuation">(</span>__VALID_FFMPEG
      <span class="token string">"${OpenCV_BINARY_DIR}"</span>
      <span class="token string">"${OpenCV_SOURCE_DIR}/cmake/checks/ffmpeg_test.cpp"</span>
      CMAKE_FLAGS <span class="token string">"-DINCLUDE_DIRECTORIES:STRING=${FFMPEG_INCLUDE_DIRS}"</span>
                  <span class="token string">"-DLINK_DIRECTORIES:STRING=${FFMPEG_LIBRARY_DIRS}"</span>
                  <span class="token string">"-DLINK_LIBRARIES:STRING=${FFMPEG_LIBRARIES}"</span>
      OUTPUT_VARIABLE TRY_OUT
  <span class="token punctuation">)</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>NOT __VALID_FFMPEG<span class="token punctuation">)</span>
    <span class="token comment">#message(FATAL_ERROR "FFMPEG: test check build log:\n${TRY_OUT}")</span>
    message<span class="token punctuation">(</span>STATUS <span class="token string">"WARNING: Can't build ffmpeg test code"</span><span class="token punctuation">)</span>
    <span class="token function">set</span><span class="token punctuation">(</span>HAVE_FFMPEG FALSE<span class="token punctuation">)</span>
  <span class="token keyword">else</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    ocv_append_build_options<span class="token punctuation">(</span>VIDEOIO FFMPEG<span class="token punctuation">)</span>
  endif<span class="token punctuation">(</span><span class="token punctuation">)</span>
endif<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>注意看<code>find_package(${OPENCV_FFMPEG_USE_FIND_PACKAGE})</code>这句，这个是核心，它是通过pkg-config来查找指定的包的，可以把它理解成一个<code>linux</code>包管理器。我们这里不去过多探究它的原理，感兴趣的小伙伴可以私下里拓展下。</p> 
<p>这个时候我们打开<code>/usr/lib/x86_64-linux-gnu/pkgconfig</code>这个文件夹下面，这个就是<code>pkg-config</code>的文件夹，里面有<code>libavcodec.pc</code>、<code>libavformat.pc</code>、<code>libavutil.pc</code>等等<code>.pc</code>文件，所有借助<code>pkg-config</code>查询的包信息都在这里面。</p> 
<p>接下来我们看看<code>opencv-4.5.1</code>的<code>cmake</code>文件，和<code>opencv-3.4.16</code>不同的是<code>opencv-4.5.1</code>的<code>cmake</code>不在<code>OpenCVFindLibsVideo.cmake</code>这个文件里面了，移到了别的地方。还是老样子先去<code>OpenCV</code>官网下载源代码并解压，接着打开<code>opencv-4.5.1/modules/videoio/cmake/detect_ffmpeg.cmake</code>，你会看到以下内容:</p> 
<pre><code class="prism language-powershell"><span class="token comment"># --- FFMPEG ---</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>NOT HAVE_FFMPEG AND OPENCV_FFMPEG_USE_FIND_PACKAGE<span class="token punctuation">)</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>OPENCV_FFMPEG_USE_FIND_PACKAGE STREQUAL <span class="token string">"1"</span> OR OPENCV_FFMPEG_USE_FIND_PACKAGE STREQUAL <span class="token string">"ON"</span><span class="token punctuation">)</span>
    <span class="token function">set</span><span class="token punctuation">(</span>OPENCV_FFMPEG_USE_FIND_PACKAGE <span class="token string">"FFMPEG"</span><span class="token punctuation">)</span>
  endif<span class="token punctuation">(</span><span class="token punctuation">)</span>
  find_package<span class="token punctuation">(</span>$<span class="token punctuation">{<!-- --></span>OPENCV_FFMPEG_USE_FIND_PACKAGE<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment"># Required components: AVCODEC AVFORMAT AVUTIL SWSCALE</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>FFMPEG_FOUND OR FFmpeg_FOUND<span class="token punctuation">)</span>
    <span class="token function">set</span><span class="token punctuation">(</span>HAVE_FFMPEG TRUE<span class="token punctuation">)</span>
  endif<span class="token punctuation">(</span><span class="token punctuation">)</span>
endif<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span><span class="token punctuation">(</span>NOT HAVE_FFMPEG AND WIN32 AND NOT ARM AND NOT OPENCV_FFMPEG_SKIP_DOWNLOAD<span class="token punctuation">)</span>
  include<span class="token punctuation">(</span><span class="token string">"${OpenCV_SOURCE_DIR}/3rdparty/ffmpeg/ffmpeg.cmake"</span><span class="token punctuation">)</span>
  download_win_ffmpeg<span class="token punctuation">(</span>FFMPEG_CMAKE_SCRIPT<span class="token punctuation">)</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>FFMPEG_CMAKE_SCRIPT<span class="token punctuation">)</span>
    include<span class="token punctuation">(</span><span class="token string">"${FFMPEG_CMAKE_SCRIPT}"</span><span class="token punctuation">)</span>
    <span class="token function">set</span><span class="token punctuation">(</span>FFMPEG_libavcodec_VERSION $<span class="token punctuation">{<!-- --></span>FFMPEG_libavcodec_VERSION<span class="token punctuation">}</span> PARENT_SCOPE<span class="token punctuation">)</span> <span class="token comment"># info</span>
    <span class="token function">set</span><span class="token punctuation">(</span>FFMPEG_libavformat_VERSION $<span class="token punctuation">{<!-- --></span>FFMPEG_libavformat_VERSION<span class="token punctuation">}</span> PARENT_SCOPE<span class="token punctuation">)</span> <span class="token comment"># info</span>
    <span class="token function">set</span><span class="token punctuation">(</span>FFMPEG_libavutil_VERSION $<span class="token punctuation">{<!-- --></span>FFMPEG_libavutil_VERSION<span class="token punctuation">}</span> PARENT_SCOPE<span class="token punctuation">)</span> <span class="token comment"># info</span>
    <span class="token function">set</span><span class="token punctuation">(</span>FFMPEG_libswscale_VERSION $<span class="token punctuation">{<!-- --></span>FFMPEG_libswscale_VERSION<span class="token punctuation">}</span> PARENT_SCOPE<span class="token punctuation">)</span> <span class="token comment"># info</span>
    <span class="token function">set</span><span class="token punctuation">(</span>FFMPEG_libavresample_VERSION $<span class="token punctuation">{<!-- --></span>FFMPEG_libavresample_VERSION<span class="token punctuation">}</span> PARENT_SCOPE<span class="token punctuation">)</span> <span class="token comment"># info</span>
    <span class="token function">set</span><span class="token punctuation">(</span>HAVE_FFMPEG TRUE<span class="token punctuation">)</span>
    <span class="token function">set</span><span class="token punctuation">(</span>HAVE_FFMPEG_WRAPPER TRUE<span class="token punctuation">)</span>
  endif<span class="token punctuation">(</span><span class="token punctuation">)</span>
endif<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token function">set</span><span class="token punctuation">(</span>_required_ffmpeg_libraries libavcodec libavformat libavutil libswscale<span class="token punctuation">)</span>
<span class="token function">set</span><span class="token punctuation">(</span>_used_ffmpeg_libraries $<span class="token punctuation">{<!-- --></span>_required_ffmpeg_libraries<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>NOT HAVE_FFMPEG AND PKG_CONFIG_FOUND<span class="token punctuation">)</span>
  ocv_check_modules<span class="token punctuation">(</span>FFMPEG libavcodec libavformat libavutil libswscale<span class="token punctuation">)</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>FFMPEG_FOUND<span class="token punctuation">)</span>
    ocv_check_modules<span class="token punctuation">(</span>FFMPEG_libavresample libavresample<span class="token punctuation">)</span> <span class="token comment"># optional</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>FFMPEG_libavresample_FOUND<span class="token punctuation">)</span>
      list<span class="token punctuation">(</span>APPEND FFMPEG_LIBRARIES $<span class="token punctuation">{<!-- --></span>FFMPEG_libavresample_LIBRARIES<span class="token punctuation">}</span><span class="token punctuation">)</span>
      list<span class="token punctuation">(</span>APPEND _used_ffmpeg_libraries libavresample<span class="token punctuation">)</span>
    endif<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">set</span><span class="token punctuation">(</span>HAVE_FFMPEG TRUE<span class="token punctuation">)</span>
  <span class="token keyword">else</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">set</span><span class="token punctuation">(</span>_missing_ffmpeg_libraries <span class="token string">""</span><span class="token punctuation">)</span>
    <span class="token keyword">foreach</span> <span class="token punctuation">(</span>ffmpeg_lib $<span class="token punctuation">{<!-- --></span>_required_ffmpeg_libraries<span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>NOT FFMPEG_$<span class="token punctuation">{<!-- --></span>ffmpeg_lib<span class="token punctuation">}</span>_FOUND<span class="token punctuation">)</span>
        list<span class="token punctuation">(</span>APPEND _missing_ffmpeg_libraries $<span class="token punctuation">{<!-- --></span>ffmpeg_lib<span class="token punctuation">}</span><span class="token punctuation">)</span>
      endif<span class="token punctuation">(</span><span class="token punctuation">)</span>
    endforeach <span class="token punctuation">(</span><span class="token punctuation">)</span>
    message<span class="token punctuation">(</span>STATUS <span class="token string">"FFMPEG is disabled. Required libraries: ${_required_ffmpeg_libraries}."</span>
            <span class="token string">" Missing libraries: ${_missing_ffmpeg_libraries}"</span><span class="token punctuation">)</span>
    unset<span class="token punctuation">(</span>_missing_ffmpeg_libraries<span class="token punctuation">)</span>
  endif<span class="token punctuation">(</span><span class="token punctuation">)</span>
endif<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">#=================================</span>
<span class="token comment"># Versions check.</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>HAVE_FFMPEG AND NOT HAVE_FFMPEG_WRAPPER<span class="token punctuation">)</span>
  <span class="token function">set</span><span class="token punctuation">(</span>_min_libavcodec_version 54<span class="token punctuation">.</span>35<span class="token punctuation">.</span>0<span class="token punctuation">)</span>
  <span class="token function">set</span><span class="token punctuation">(</span>_min_libavformat_version 54<span class="token punctuation">.</span>20<span class="token punctuation">.</span>4<span class="token punctuation">)</span>
  <span class="token function">set</span><span class="token punctuation">(</span>_min_libavutil_version 52<span class="token punctuation">.</span>3<span class="token punctuation">.</span>0<span class="token punctuation">)</span>
  <span class="token function">set</span><span class="token punctuation">(</span>_min_libswscale_version 2<span class="token punctuation">.</span>1<span class="token punctuation">.</span>1<span class="token punctuation">)</span>
  <span class="token function">set</span><span class="token punctuation">(</span>_min_libavresample_version 1<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1<span class="token punctuation">)</span>
  <span class="token keyword">foreach</span><span class="token punctuation">(</span>ffmpeg_lib $<span class="token punctuation">{<!-- --></span>_used_ffmpeg_libraries<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>FFMPEG_$<span class="token punctuation">{<!-- --></span>ffmpeg_lib<span class="token punctuation">}</span>_VERSION VERSION_LESS _min_$<span class="token punctuation">{<!-- --></span>ffmpeg_lib<span class="token punctuation">}</span>_version<span class="token punctuation">)</span>
      message<span class="token punctuation">(</span>STATUS <span class="token string">"FFMPEG is disabled. Can't find suitable ${ffmpeg_lib} library"</span>
              <span class="token string">" (minimal ${_min_${ffmpeg_lib}_version}, found ${FFMPEG_${ffmpeg_lib}_VERSION})."</span><span class="token punctuation">)</span>
      <span class="token function">set</span><span class="token punctuation">(</span>HAVE_FFMPEG FALSE<span class="token punctuation">)</span>
    endif<span class="token punctuation">(</span><span class="token punctuation">)</span>
  endforeach<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>NOT HAVE_FFMPEG<span class="token punctuation">)</span>
    message<span class="token punctuation">(</span>STATUS <span class="token string">"FFMPEG libraries version check failed "</span>
            <span class="token string">"(minimal libav release 9.20, minimal FFMPEG release 1.1.16)."</span><span class="token punctuation">)</span>
  endif<span class="token punctuation">(</span><span class="token punctuation">)</span>
  unset<span class="token punctuation">(</span>_min_libavcodec_version<span class="token punctuation">)</span>
  unset<span class="token punctuation">(</span>_min_libavformat_version<span class="token punctuation">)</span>
  unset<span class="token punctuation">(</span>_min_libavutil_version<span class="token punctuation">)</span>
  unset<span class="token punctuation">(</span>_min_libswscale_version<span class="token punctuation">)</span>
  unset<span class="token punctuation">(</span>_min_libavresample_version<span class="token punctuation">)</span>
endif<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">#==================================</span>

<span class="token keyword">if</span><span class="token punctuation">(</span>HAVE_FFMPEG AND NOT HAVE_FFMPEG_WRAPPER AND NOT OPENCV_FFMPEG_SKIP_BUILD_CHECK<span class="token punctuation">)</span>
  try_compile<span class="token punctuation">(</span>__VALID_FFMPEG
      <span class="token string">"${OpenCV_BINARY_DIR}"</span>
      <span class="token string">"${OpenCV_SOURCE_DIR}/cmake/checks/ffmpeg_test.cpp"</span>
      CMAKE_FLAGS <span class="token string">"-DINCLUDE_DIRECTORIES:STRING=${FFMPEG_INCLUDE_DIRS}"</span>
                  <span class="token string">"-DLINK_LIBRARIES:STRING=${FFMPEG_LIBRARIES}"</span>
      OUTPUT_VARIABLE TRY_OUT
  <span class="token punctuation">)</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>NOT __VALID_FFMPEG<span class="token punctuation">)</span>
    <span class="token comment"># message(FATAL_ERROR "FFMPEG: test check build log:\n${TRY_OUT}")</span>
    message<span class="token punctuation">(</span>STATUS <span class="token string">"WARNING: Can't build ffmpeg test code"</span><span class="token punctuation">)</span>
    <span class="token function">set</span><span class="token punctuation">(</span>HAVE_FFMPEG FALSE<span class="token punctuation">)</span>
  endif<span class="token punctuation">(</span><span class="token punctuation">)</span>
endif<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">#==================================</span>
unset<span class="token punctuation">(</span>_required_ffmpeg_libraries<span class="token punctuation">)</span>
unset<span class="token punctuation">(</span>_used_ffmpeg_libraries<span class="token punctuation">)</span>

<span class="token keyword">if</span><span class="token punctuation">(</span>HAVE_FFMPEG_WRAPPER<span class="token punctuation">)</span>
  ocv_add_external_target<span class="token punctuation">(</span>ffmpeg <span class="token string">""</span> <span class="token string">""</span> <span class="token string">"HAVE_FFMPEG_WRAPPER"</span><span class="token punctuation">)</span>
<span class="token keyword">elseif</span><span class="token punctuation">(</span>HAVE_FFMPEG<span class="token punctuation">)</span>
  ocv_add_external_target<span class="token punctuation">(</span>ffmpeg <span class="token string">"${FFMPEG_INCLUDE_DIRS}"</span> <span class="token string">"${FFMPEG_LIBRARIES}"</span> <span class="token string">"HAVE_FFMPEG"</span><span class="token punctuation">)</span>
endif<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token function">set</span><span class="token punctuation">(</span>HAVE_FFMPEG $<span class="token punctuation">{<!-- --></span>HAVE_FFMPEG<span class="token punctuation">}</span> PARENT_SCOPE<span class="token punctuation">)</span>
</code></pre> 
<p>我们不去逐行分析这个文件，我们只分析重点。还是那句话<code>find_package(${OPENCV_FFMPEG_USE_FIND_PACKAGE})</code>，<code>opencv-4.5.1</code>这个版本还是通过<code>pkg-config</code>来查找计算机上的<code>ffmpeg</code>的，包括ffmpeg依赖的库，所以问题就找到了。</p> 
<hr> 
<h2><a id="_187"></a>解决方案：</h2> 
<p>这里直接说我自己的解决方案，解决方案有可能不止一个。<br> 1、OpenCV-3.4.16<br> 照理说3.4.2版本或者其他版本也是通用的，我没有测试所有的版本。如果你的电脑可以联网可以通过<code>apt</code>安装<code>ffmpeg</code>方法是：</p> 
<pre><code class="prism language-powershell">sudo apt update
sudo apt install <span class="token operator">-</span>y ffmpeg
</code></pre> 
<p>只安装<code>ffmpeg</code>还是不够的，我们还需要安装<code>libavcodec-dev</code> 、<code>libavformat-dev</code>、<code>libavutil-dev</code> 、<code>libavfilter-dev</code>、 <code>libavresample-dev</code>、 <code>libswresample-dev</code>、 <code>libswscale-dev</code>开发环境，注意一定要是开发环境，而不是运行库，运行库是不带<code>头文件</code>的，不能用于编译源代码。</p> 
<p>这个时候我们去<code>/usr/include</code>找到刚刚安装的这些运行库的头文件，在<code>/usr/include</code>里面创建一个文件夹<code>ffmpeg</code>，将刚才的诸如<code>libavcodec</code>这些文件夹下面的所有头文件都复制到<code>/usr/include/ffmpeg</code>文件夹下面，注意不要复制整个文件夹，要复制文件夹里面的所有头文件。完了之后再编译<code>OpenCV</code>并加上<code>WITH_FFMPEG</code>如果出现下图所示，说明对了。</p> 
<p><img src="https://images2.imgbox.com/86/57/8rxDzvtM_o.png" alt="在这里插入图片描述"><br> <code>注：必须是YES，不能是NO，如果是NO就检查下操作是不是有误。这个版本是ffmpeg-4.4.2的版本，Ubuntu18.04原生安装的是ffmpeg-3.4.8或ffmpeg-3.4.6版本，对于我来说用起来没影响。</code></p> 
<p>2、OpenCV-4.5.1</p> 
<p>这个版本的<code>OpenCV</code>编译比较麻烦点，这里我没有用<code>apt</code>去安装<code>ffmpeg</code>而是选择用<code>ffmpeg-4.4.2</code>的源代码编译<code>ffmpeg</code>。关于<code>ffmpeg</code>的源代码编译这里我不详述了，大家可以自行去查询下资料。我这里只编译我用到的功能。</p> 
<p>首先到<code>ffmpeg</code>的官网下载源代码，这里我选的是<code>ffmpeg-4.4.2</code>，其他的版本我没有测试过，大家可以自行测试，理论上<code>4.x.x</code>的版本应该都是可以的。</p> 
<pre><code class="prism language-powershell"><span class="token punctuation">.</span><span class="token operator">/</span>configure <span class="token operator">--</span><span class="token function">enable-shared</span> <span class="token operator">--</span><span class="token function">enable-avresample</span> <span class="token operator">--</span>prefix=<span class="token operator">/</span>usr/
make <span class="token operator">-</span>j$<span class="token punctuation">(</span>nproc<span class="token punctuation">)</span>
sudo make install
</code></pre> 
<p><code>注：--prefix=/usr/ 这句话一定要这么写，不能安装到/usr/local目录下，OpenCV可能会找不到ffmpeg</code></p> 
<p>最后编译<code>OpenCV</code>并加上<code>WITH_FFMPEG</code>如果出现下图所示，说明对了。<br> <img src="https://images2.imgbox.com/2a/0f/iR542ugl_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_219"></a>写在最后</h2> 
<p>大体的方法就是上面那些了，有疑问的童鞋可以在下面提问。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/10675c40dd7091948b477f2cc811d982/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Android 编程入门笔记</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e37c5d32b528ac48a1aed12d010dfdae/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">MySQL之binlog</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>