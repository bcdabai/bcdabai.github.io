<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>YOLOv8-Segæ¨ç†è¯¦è§£åŠéƒ¨ç½²å®ç° - ç¼–ç¨‹å¤§ç™½çš„åšå®¢</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="YOLOv8-Segæ¨ç†è¯¦è§£åŠéƒ¨ç½²å®ç°" />
<meta property="og:description" content="ç›®å½• æ³¨æ„äº‹é¡¹ä¸€ã€2024/1/10æ›´æ–°å‰è¨€ä¸€ã€YOLOv8-Segæ¨ç†(Python)1. YOLOv8-Segé¢„æµ‹2. YOLOv8-Segé¢„å¤„ç†3. YOLOv8-Segåå¤„ç†4. YOLOv8-Segæ¨ç† äºŒã€YOLOv8-Segæ¨ç†(C&#43;&#43;)1. ONNXå¯¼å‡º2. YOLOv8-Segé¢„å¤„ç†3. YOLOv8-Segåå¤„ç†4. YOLOv8-Segæ¨ç† ä¸‰ã€YOLOv8-Segéƒ¨ç½²1. æºç ä¸‹è½½2. ç¯å¢ƒé…ç½®2.1 é…ç½®CMakeLists.txt2.2 é…ç½®Makefile 3. ONNXå¯¼å‡º4. æºç ä¿®æ”¹ ç»“è¯­ä¸‹è½½é“¾æ¥å‚è€ƒ æ³¨æ„äº‹é¡¹ ä¸€ã€2024/1/10æ›´æ–° ä¿®æ”¹ç¬¬ 4 éƒ¨åˆ† YOLOv8-Seg æ¨ç†ä¸­åå¤„ç† iou è®¡ç®—ä»£ç ï¼ŒåŸä»£ç å­˜åœ¨é—®é¢˜ï¼ŒåŸä»£ç å¦‚ä¸‹ï¼š
def iou(box1, box2): def area_box(box): return (box[2] - box[0]) * (box[3] - box[1]) left, top = max(box1[:2], box2[:2]) right, bottom = min(box1[2:4], box2[2:4]) ... å…¶ä¸­ï¼Œbox1 å’Œ box2 æ˜¯è¡¨ç¤ºè¾¹ç•Œæ¡†çš„åˆ—è¡¨ï¼Œæ ¼å¼ä¸º [left, top, right, bottom, â€¦]ã€‚åœ¨ Python ä¸­ï¼Œå½“ max å‡½æ•°ç”¨äºä¸¤ä¸ªåˆ—è¡¨æ—¶ï¼Œå®ƒä¼šæ¯”è¾ƒåˆ—è¡¨ä¸­çš„å…ƒç´ ï¼Œä»å·¦åˆ°å³ï¼Œç›´åˆ°æ‰¾åˆ°æŸä¸€ä¸ªåˆ—è¡¨ä¸­çš„è¾ƒå¤§å…ƒç´ ï¼Œç„¶åè¿”å›é‚£ä¸ªè¾ƒå¤§å…ƒç´ çš„å®Œæ•´åˆ—è¡¨ã€‚æ¯”å¦‚ç°åœ¨æ¯”è¾ƒ max([3,0],[2,1])ï¼Œå› ä¸º 3 å¤§äº 2ï¼Œè€Œä¸è€ƒè™‘åé¢çš„å…ƒç´ ï¼Œè¿”å›çš„å°±æ˜¯ [3,0]ã€‚è¿™æ„å‘³ç€åœ¨è®¡ç®—äº¤é›†åŒºåŸŸçš„å·¦ä¸Šè§’åæ ‡æ—¶ï¼Œä»…æ¯”è¾ƒäº† left åæ ‡ï¼Œè€Œæ²¡æœ‰æ­£ç¡®åœ°å¤„ç† top åæ ‡ï¼ŒåŒç†å³ä¸‹è§’åæ ‡ä¹Ÿå­˜åœ¨ç±»ä¼¼çš„é—®é¢˜" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/f6fde0a97d9cd657f9df0baebdbb485e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-10T15:09:59+08:00" />
<meta property="article:modified_time" content="2024-01-10T15:09:59+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="ç¼–ç¨‹å¤§ç™½çš„åšå®¢" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">ç¼–ç¨‹å¤§ç™½çš„åšå®¢</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">YOLOv8-Segæ¨ç†è¯¦è§£åŠéƒ¨ç½²å®ç°</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>ç›®å½•</h4> 
 <ul><li><ul><li><a href="#_2" rel="nofollow">æ³¨æ„äº‹é¡¹</a></li><li><a href="#2024110_4" rel="nofollow">ä¸€ã€2024/1/10æ›´æ–°</a></li><li><a href="#_37" rel="nofollow">å‰è¨€</a></li><li><a href="#YOLOv8SegPython_45" rel="nofollow">ä¸€ã€YOLOv8-Segæ¨ç†(Python)</a></li><li><ul><li><a href="#1_YOLOv8Seg_47" rel="nofollow">1. YOLOv8-Segé¢„æµ‹</a></li><li><a href="#2_YOLOv8Seg_149" rel="nofollow">2. YOLOv8-Segé¢„å¤„ç†</a></li><li><a href="#3_YOLOv8Seg_233" rel="nofollow">3. YOLOv8-Segåå¤„ç†</a></li><li><a href="#4_YOLOv8Seg_438" rel="nofollow">4. YOLOv8-Segæ¨ç†</a></li></ul> 
   </li><li><a href="#YOLOv8SegC_673" rel="nofollow">äºŒã€YOLOv8-Segæ¨ç†(C++)</a></li><li><ul><li><a href="#1_ONNX_677" rel="nofollow">1. ONNXå¯¼å‡º</a></li><li><a href="#2_YOLOv8Seg_763" rel="nofollow">2. YOLOv8-Segé¢„å¤„ç†</a></li><li><a href="#3_YOLOv8Seg_859" rel="nofollow">3. YOLOv8-Segåå¤„ç†</a></li><li><a href="#4_YOLOv8Seg_998" rel="nofollow">4. YOLOv8-Segæ¨ç†</a></li></ul> 
   </li><li><a href="#YOLOv8Seg_1020" rel="nofollow">ä¸‰ã€YOLOv8-Segéƒ¨ç½²</a></li><li><ul><li><a href="#1__1026" rel="nofollow">1. æºç ä¸‹è½½</a></li><li><a href="#2__1036" rel="nofollow">2. ç¯å¢ƒé…ç½®</a></li><li><ul><li><a href="#21_CMakeListstxt_1042" rel="nofollow">2.1 é…ç½®CMakeLists.txt</a></li><li><a href="#22_Makefile_1076" rel="nofollow">2.2 é…ç½®Makefile</a></li></ul> 
    </li><li><a href="#3_ONNX_1110" rel="nofollow">3. ONNXå¯¼å‡º</a></li><li><a href="#4__1114" rel="nofollow">4. æºç ä¿®æ”¹</a></li></ul> 
   </li><li><a href="#_1149" rel="nofollow">ç»“è¯­</a></li><li><a href="#_1155" rel="nofollow">ä¸‹è½½é“¾æ¥</a></li><li><a href="#_1160" rel="nofollow">å‚è€ƒ</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="_2"></a>æ³¨æ„äº‹é¡¹</h3> 
<h3><a id="2024110_4"></a>ä¸€ã€2024/1/10æ›´æ–°</h3> 
<p><strong>ä¿®æ”¹ç¬¬ 4 éƒ¨åˆ† YOLOv8-Seg æ¨ç†ä¸­åå¤„ç† iou è®¡ç®—ä»£ç </strong>ï¼ŒåŸä»£ç å­˜åœ¨é—®é¢˜ï¼ŒåŸä»£ç å¦‚ä¸‹ï¼š</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">iou</span><span class="token punctuation">(</span>box1<span class="token punctuation">,</span> box2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">area_box</span><span class="token punctuation">(</span>box<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    left<span class="token punctuation">,</span> top <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    right<span class="token punctuation">,</span> bottom <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p>å…¶ä¸­ï¼Œ<strong>box1</strong> å’Œ <strong>box2</strong> æ˜¯è¡¨ç¤ºè¾¹ç•Œæ¡†çš„åˆ—è¡¨ï¼Œæ ¼å¼ä¸º <strong>[left, top, right, bottom, â€¦]</strong>ã€‚åœ¨ Python ä¸­ï¼Œå½“ <strong>max</strong> å‡½æ•°ç”¨äºä¸¤ä¸ªåˆ—è¡¨æ—¶ï¼Œå®ƒä¼šæ¯”è¾ƒåˆ—è¡¨ä¸­çš„å…ƒç´ ï¼Œä»å·¦åˆ°å³ï¼Œç›´åˆ°æ‰¾åˆ°æŸä¸€ä¸ªåˆ—è¡¨ä¸­çš„è¾ƒå¤§å…ƒç´ ï¼Œ<strong>ç„¶åè¿”å›é‚£ä¸ªè¾ƒå¤§å…ƒç´ çš„å®Œæ•´åˆ—è¡¨</strong>ã€‚æ¯”å¦‚ç°åœ¨æ¯”è¾ƒ <strong>max([3,0],[2,1])</strong>ï¼Œå› ä¸º 3 å¤§äº 2ï¼Œè€Œä¸è€ƒè™‘åé¢çš„å…ƒç´ ï¼Œè¿”å›çš„å°±æ˜¯ <strong>[3,0]</strong>ã€‚è¿™æ„å‘³ç€åœ¨è®¡ç®—äº¤é›†åŒºåŸŸçš„å·¦ä¸Šè§’åæ ‡æ—¶ï¼Œä»…æ¯”è¾ƒäº† <strong>left</strong> åæ ‡ï¼Œè€Œæ²¡æœ‰æ­£ç¡®åœ°å¤„ç† <strong>top</strong> åæ ‡ï¼ŒåŒç†å³ä¸‹è§’åæ ‡ä¹Ÿå­˜åœ¨ç±»ä¼¼çš„é—®é¢˜</p> 
<p>å› æ­¤ï¼Œä¿®æ”¹åçš„ä»£ç å¦‚ä¸‹ï¼š</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">iou</span><span class="token punctuation">(</span>box1<span class="token punctuation">,</span> box2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">area_box</span><span class="token punctuation">(</span>box<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment"># box -&gt; [x1,y1,x2,y2,...]</span>
    left   <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    top    <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    right  <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    bottom <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p>æ„Ÿè°¢ @<a href="https://blog.csdn.net/weixin_45679938">ä½ çš„é™ˆæŸæŸ</a> çš„æŒ‡æ­£ğŸ¤—</p> 
<h3><a id="_37"></a>å‰è¨€</h3> 
<blockquote> 
 <p>æ¢³ç†ä¸‹ YOLOv8-Seg çš„é¢„å¤„ç†å’Œåå¤„ç†æµç¨‹ï¼Œé¡ºä¾¿è®© tensorRT_Pro æ”¯æŒ YOLOv8-Seg</p> 
 <p>å‚è€ƒï¼š<a href="https://github.com/shouxieai/tensorRT_Pro">https://github.com/shouxieai/tensorRT_Pro</a></p> 
 <p>å®ç°ï¼š<a href="https://github.com/Melody-Zhou/tensorRT_Pro-YOLOv8">https://github.com/Melody-Zhou/tensorRT_Pro-YOLOv8</a></p> 
</blockquote> 
<h3><a id="YOLOv8SegPython_45"></a>ä¸€ã€YOLOv8-Segæ¨ç†(Python)</h3> 
<h4><a id="1_YOLOv8Seg_47"></a>1. YOLOv8-Segé¢„æµ‹</h4> 
<blockquote> 
 <p>æˆ‘ä»¬å…ˆå°è¯•åˆ©ç”¨å®˜æ–¹é¢„è®­ç»ƒæƒé‡æ¥æ¨ç†ä¸€å¼ å›¾ç‰‡å¹¶ä¿å­˜ï¼Œçœ‹èƒ½å¦æˆåŠŸ</p> 
</blockquote> 
<p>åœ¨ YOLOv8 ä¸»ç›®å½•ä¸‹æ–°å»º <strong>predict-seg.py</strong> é¢„æµ‹æ–‡ä»¶ï¼Œå…¶å†…å®¹å¦‚ä¸‹ï¼š</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> cv2
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> ultralytics <span class="token keyword">import</span> YOLO

<span class="token keyword">def</span> <span class="token function">hsv2bgr</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> s<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">:</span>
    h_i <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>h <span class="token operator">*</span> <span class="token number">6</span><span class="token punctuation">)</span>
    f <span class="token operator">=</span> h <span class="token operator">*</span> <span class="token number">6</span> <span class="token operator">-</span> h_i
    p <span class="token operator">=</span> v <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> s<span class="token punctuation">)</span>
    q <span class="token operator">=</span> v <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> f <span class="token operator">*</span> s<span class="token punctuation">)</span>
    t <span class="token operator">=</span> v <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> f<span class="token punctuation">)</span> <span class="token operator">*</span> s<span class="token punctuation">)</span>
    
    r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>

    <span class="token keyword">if</span> h_i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> v<span class="token punctuation">,</span> t<span class="token punctuation">,</span> p
    <span class="token keyword">elif</span> h_i <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> q<span class="token punctuation">,</span> v<span class="token punctuation">,</span> p
    <span class="token keyword">elif</span> h_i <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> p<span class="token punctuation">,</span> v<span class="token punctuation">,</span> t
    <span class="token keyword">elif</span> h_i <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> p<span class="token punctuation">,</span> q<span class="token punctuation">,</span> v
    <span class="token keyword">elif</span> h_i <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> t<span class="token punctuation">,</span> p<span class="token punctuation">,</span> v
    <span class="token keyword">elif</span> h_i <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> v<span class="token punctuation">,</span> p<span class="token punctuation">,</span> q

    <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">(</span>b <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>g <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>r <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">random_color</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    h_plane <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">id</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">0x937151</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">100.0</span>
    s_plane <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">id</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">0x315793</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">100.0</span>
    <span class="token keyword">return</span> hsv2bgr<span class="token punctuation">(</span>h_plane<span class="token punctuation">,</span> s_plane<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    
    model <span class="token operator">=</span> YOLO<span class="token punctuation">(</span><span class="token string">"yolov8s-seg.pt"</span><span class="token punctuation">)</span>

    img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">"ultralytics/assets/bus.jpg"</span><span class="token punctuation">)</span>
    result <span class="token operator">=</span> model<span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    names <span class="token operator">=</span> result<span class="token punctuation">.</span>names
    boxes <span class="token operator">=</span> result<span class="token punctuation">.</span>boxes<span class="token punctuation">.</span>data<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>
    masks <span class="token operator">=</span> result<span class="token punctuation">.</span>masks

    h<span class="token punctuation">,</span> w <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>

    <span class="token keyword">for</span> i<span class="token punctuation">,</span> mask <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>masks<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
        
        mask <span class="token operator">=</span> mask<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
        mask_resized <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>mask<span class="token punctuation">,</span> <span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">)</span>

        label <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>boxes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        color <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>random_color<span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token punctuation">)</span>

        colored_mask <span class="token operator">=</span> <span class="token punctuation">(</span>np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> w<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> color<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
        masked_colored_mask <span class="token operator">=</span> cv2<span class="token punctuation">.</span>bitwise_and<span class="token punctuation">(</span>colored_mask<span class="token punctuation">,</span> colored_mask<span class="token punctuation">,</span> mask<span class="token operator">=</span>mask_resized<span class="token punctuation">)</span>

        mask_indices <span class="token operator">=</span> mask_resized <span class="token operator">==</span> <span class="token number">1</span>
        img<span class="token punctuation">[</span>mask_indices<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>img<span class="token punctuation">[</span>mask_indices<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">0.6</span> <span class="token operator">+</span> masked_colored_mask<span class="token punctuation">[</span>mask_indices<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>

    <span class="token comment"># for i, points in enumerate(masks.xy):</span>
    <span class="token comment">#     label = int(boxes[i][5])</span>
    <span class="token comment">#     color = random_color(label)</span>
    <span class="token comment">#     points = np.array(points, np.int32)</span>
    <span class="token comment">#     cv2.drawContours(img, [points], -1, color, 2)</span>

    <span class="token keyword">for</span> obj <span class="token keyword">in</span> boxes<span class="token punctuation">:</span>
        left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> right<span class="token punctuation">,</span> bottom <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        confidence <span class="token operator">=</span> obj<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>
        label <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        color <span class="token operator">=</span> random_color<span class="token punctuation">(</span>label<span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span>left<span class="token punctuation">,</span> top<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>right<span class="token punctuation">,</span> bottom<span class="token punctuation">)</span><span class="token punctuation">,</span> color <span class="token operator">=</span> color <span class="token punctuation">,</span>thickness<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> lineType<span class="token operator">=</span>cv2<span class="token punctuation">.</span>LINE_AA<span class="token punctuation">)</span>
        caption <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>names<span class="token punctuation">[</span>label<span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>confidence<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
        w<span class="token punctuation">,</span> h <span class="token operator">=</span> cv2<span class="token punctuation">.</span>getTextSize<span class="token punctuation">(</span>caption<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span>left <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">,</span> top <span class="token operator">-</span> <span class="token number">33</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>left <span class="token operator">+</span> w <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">,</span> top<span class="token punctuation">)</span><span class="token punctuation">,</span> color<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>img<span class="token punctuation">,</span> caption<span class="token punctuation">,</span> <span class="token punctuation">(</span>left<span class="token punctuation">,</span> top <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>

    cv2<span class="token punctuation">.</span>imwrite<span class="token punctuation">(</span><span class="token string">"predict-seg.jpg"</span><span class="token punctuation">,</span> img<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"save done"</span><span class="token punctuation">)</span>
</code></pre> 
<p>åœ¨ä¸Šè¿°ä»£ç ä¸­æˆ‘ä»¬é€šè¿‡ opencv è¯»å–äº†ä¸€å¼ å›¾åƒï¼Œå¹¶é€å…¥æ¨¡å‹ä¸­æ¨ç†å¾—åˆ°è¾“å‡º resultsï¼Œresults ä¸­ä¿å­˜ç€ä¸åŒä»»åŠ¡çš„ç»“æœï¼Œæˆ‘ä»¬è¿™é‡Œæ˜¯åˆ†å‰²ä»»åŠ¡ï¼Œå› æ­¤åªéœ€è¦æ‹¿åˆ°å¯¹åº”çš„ boxes å’Œ masks å³å¯ã€‚</p> 
<p>æ‹¿åˆ° boxes åæˆ‘ä»¬å°±å¯ä»¥å°†å¯¹åº”çš„æ¡†å’Œç½®ä¿¡åº¦ç»˜åˆ¶åœ¨å›¾åƒä¸Šï¼Œæ‹¿åˆ° masks åæˆ‘ä»¬å°±å¯ä»¥å°†å¯¹åº”çš„ mask ç»˜åˆ¶åœ¨å›¾åƒä¸Šå¹¶ä¿å­˜ã€‚</p> 
<p>å…³äº boxes å¯è§†åŒ–çš„ä»£ç å®ç°å‚è€ƒè‡ª tensorRT_Pro ä¸­çš„å®ç°ï¼Œå¯ä»¥å‚è€ƒï¼š<a href="https://github.com/shouxieai/tensorRT_Pro/blob/main/src/application/app_yolo.cpp#L95">app_yolo.cpp#L95</a></p> 
<p>å…³äº masks å¯è§†åŒ–çš„ä»£ç å®ç°å‚è€ƒè‡ª ultralytics/utils/plotting.py ä¸­çš„å®ç°ï¼Œå…·ä½“å®ç°ä»£ç æ¥æºäº <strong>chatGPT</strong>ï¼Œå¯ä»¥å‚è€ƒï¼š<a href="https://github.com/ultralytics/ultralytics/blob/main/ultralytics/utils/plotting.py#L468">plotting.py#L468</a></p> 
<p>å…³äºéšæœºé¢œè‰²çš„ä»£ç å®ç°å‚è€ƒè‡ª tensorRT_Pro ä¸­çš„å®ç°ï¼Œå¯ä»¥å‚è€ƒï¼š<a href="https://github.com/shouxieai/tensorRT_Pro/blob/main/src/tensorRT/common/ilogger.cpp#L90">ilogger.cpp#L90</a></p> 
<p>æ¨¡å‹æ¨ç†ä¿å­˜çš„ç»“æœå›¾åƒå¦‚ä¸‹æ‰€ç¤ºï¼š</p> 
<p><img src="https://images2.imgbox.com/74/6d/OQWFUyDl_o.jpg" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<h4><a id="2_YOLOv8Seg_149"></a>2. YOLOv8-Segé¢„å¤„ç†</h4> 
<blockquote> 
 <p>æ¨¡å‹é¢„æµ‹æˆåŠŸåæˆ‘ä»¬å°±éœ€è¦è‡ªå·±åŠ¨æ‰‹æ¥å†™ä¸‹ YOLOv8-Seg çš„é¢„å¤„ç†å’Œåå¤„ç†ï¼Œæ–¹ä¾¿åç»­åœ¨ C++ ä¸Šçš„å®ç°ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹é¢„å¤„ç†çš„å®ç°</p> 
</blockquote> 
<p>ç»è¿‡æˆ‘ä»¬çš„è°ƒè¯•åˆ†æå¯çŸ¥ YOLOv8-Seg çš„é¢„å¤„ç†è¿‡ç¨‹åœ¨ <strong>ultralytics/engine/predictor.py</strong> æ–‡ä»¶ä¸­ï¼Œå¯ä»¥å‚è€ƒï¼š<a href="https://github.com/ultralytics/ultralytics/blob/main/ultralytics/engine/predictor.py#L111">predictor.py#L111</a></p> 
<p>ä»£ç å¦‚ä¸‹ï¼š</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">preprocess</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> im<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Prepares input image before inference.

    Args:
        im (torch.Tensor | List(np.ndarray)): BCHW for tensor, [(HWC) x B] for list.
    """</span>
    not_tensor <span class="token operator">=</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>im<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">)</span>
    <span class="token keyword">if</span> not_tensor<span class="token punctuation">:</span>
        im <span class="token operator">=</span> np<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pre_transform<span class="token punctuation">(</span>im<span class="token punctuation">)</span><span class="token punctuation">)</span>
        im <span class="token operator">=</span> im<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># BGR to RGB, BHWC to BCHW, (n, 3, h, w)</span>
        im <span class="token operator">=</span> np<span class="token punctuation">.</span>ascontiguousarray<span class="token punctuation">(</span>im<span class="token punctuation">)</span>  <span class="token comment"># contiguous</span>
        im <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>im<span class="token punctuation">)</span>

    im <span class="token operator">=</span> im<span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
    im <span class="token operator">=</span> im<span class="token punctuation">.</span>half<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>fp16 <span class="token keyword">else</span> im<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># uint8 to fp16/32</span>
    <span class="token keyword">if</span> not_tensor<span class="token punctuation">:</span>
        im <span class="token operator">/=</span> <span class="token number">255</span>  <span class="token comment"># 0 - 255 to 0.0 - 1.0</span>
    <span class="token keyword">return</span> im
</code></pre> 
<p>å®ƒåŒ…å«ä»¥ä¸‹æ­¥éª¤ï¼š</p> 
<ul><li><strong>self.pre_transform</strong>ï¼šå³ letterbox æ·»åŠ ç°æ¡</li><li><strong>im[â€¦,::-1]</strong>ï¼šBGR â†’ RGB</li><li><strong>transpose((0, 3, 1, 2))</strong>ï¼šæ·»åŠ  batch ç»´åº¦ï¼ŒHWC â†’ CHW</li><li><strong>torch.from_numpy</strong>ï¼što Tensor</li><li><strong>im /= 255</strong>ï¼šé™¤ä»¥ 255ï¼Œå½’ä¸€åŒ–</li></ul> 
<p>å¤§å®¶å¦‚æœå¯¹ YOLOv5 çš„é¢„å¤„ç†ç†Ÿæ‚‰çš„è¯ï¼Œä¼šå‘ç° YOLOv8-Seg çš„é¢„å¤„ç†å’Œ YOLOv5 çš„é¢„å¤„ç†ä¸€æ¨¡ä¸€æ ·ï¼Œå› æ­¤æˆ‘ä»¬ä¸éš¾å†™å‡ºå¯¹åº”çš„é¢„å¤„ç†ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">preprocess_warpAffine</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> dst_width<span class="token operator">=</span><span class="token number">640</span><span class="token punctuation">,</span> dst_height<span class="token operator">=</span><span class="token number">640</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    scale <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dst_width <span class="token operator">/</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dst_height <span class="token operator">/</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    ox <span class="token operator">=</span> <span class="token punctuation">(</span>dst_width  <span class="token operator">-</span> scale <span class="token operator">*</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
    oy <span class="token operator">=</span> <span class="token punctuation">(</span>dst_height <span class="token operator">-</span> scale <span class="token operator">*</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
    M <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token punctuation">[</span>scale<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ox<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> scale<span class="token punctuation">,</span> oy<span class="token punctuation">]</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
    
    img_pre <span class="token operator">=</span> cv2<span class="token punctuation">.</span>warpAffine<span class="token punctuation">(</span>image<span class="token punctuation">,</span> M<span class="token punctuation">,</span> <span class="token punctuation">(</span>dst_width<span class="token punctuation">,</span> dst_height<span class="token punctuation">)</span><span class="token punctuation">,</span> flags<span class="token operator">=</span>cv2<span class="token punctuation">.</span>INTER_LINEAR<span class="token punctuation">,</span>
                             borderMode<span class="token operator">=</span>cv2<span class="token punctuation">.</span>BORDER_CONSTANT<span class="token punctuation">,</span> borderValue<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">114</span><span class="token punctuation">,</span> <span class="token number">114</span><span class="token punctuation">,</span> <span class="token number">114</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    IM <span class="token operator">=</span> cv2<span class="token punctuation">.</span>invertAffineTransform<span class="token punctuation">(</span>M<span class="token punctuation">)</span>

    img_pre <span class="token operator">=</span> <span class="token punctuation">(</span>img_pre<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">255.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
    img_pre <span class="token operator">=</span> img_pre<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span>
    img_pre <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>img_pre<span class="token punctuation">)</span>
    <span class="token keyword">return</span> img_pre<span class="token punctuation">,</span> IM
</code></pre> 
<p>å…¶ä¸­çš„ letterbox æ·»åŠ ç°æ¡æ­¥éª¤æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¿å°„å˜æ¢ warpAffine å®ç°ï¼ŒwarpAffine éå¸¸é€‚åˆåœ¨ CUDA ä¸ŠåŠ é€Ÿï¼Œå…³äº warpAffine ä»¿å°„å˜æ¢çš„ç»†èŠ‚å¤§å®¶å¯ä»¥å‚è€ƒ <a href="https://blog.csdn.net/qq_40672115/article/details/127012332">YOLOv5æ¨ç†è¯¦è§£åŠé¢„å¤„ç†é«˜æ€§èƒ½å®ç°</a>ï¼Œè¿™è¾¹ä¸å†èµ˜è¿°ã€‚å…¶å®ƒæ­¥éª¤å€’æ˜¯å’Œå®˜æ–¹çš„æ²¡æœ‰åŒºåˆ«ã€‚</p> 
<p>å€¼å¾—æ³¨æ„å¾—æ˜¯ï¼Œletterbox çš„æ“ä½œæ˜¯å…ˆå°†é•¿è¾¹ç¼©æ”¾åˆ° 640ï¼Œå†å°†çŸ­è¾¹æŒ‰æ¯”ä¾‹ç¼©æ”¾ï¼ŒåŒæ—¶ç¡®ä¿ç¼©æ”¾åçš„çŸ­è¾¹èƒ½æ•´é™¤ 32ï¼Œå¦‚æœä¸èƒ½åˆ™å‘ä¸Šå–æ•´å¤šä½™éƒ¨åˆ†å¡«å……ã€‚warpAffine çš„æ“ä½œåˆ™æ˜¯å°†å›¾åƒåˆ†è¾¨ç‡å›ºå®šåœ¨ 640x640ï¼Œå¤šä½™éƒ¨åˆ†æ·»åŠ ç°æ¡ï¼Œåšä¸»å¯¹ä¸€å¼  <strong>1080x810</strong> åˆ†è¾¨ç‡çš„å›¾åƒç»è¿‡ä¸¤ç§ä¸åŒé¢„å¤„ç†åçš„ç»“æœè¿›è¡Œäº†å¯¹æ¯”ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p> 
<p><img src="https://images2.imgbox.com/04/f5/2wx2U1o9_o.jpg" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<center> 
 <b>å›¾1-1 LeeterBoxé¢„å¤„ç†å›¾åƒ</b> 
</center> 
<p><img src="https://images2.imgbox.com/35/24/1fXeB38B_o.jpg" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<center> 
 <b>å›¾1-2 warpAffineé¢„å¤„ç†å›¾åƒ</b> 
</center> 
<p>å¯ä»¥çœ‹åˆ°äºŒè€…æ˜æ˜¾çš„å·®åˆ«ï¼Œletterbox ä¸­æ²¡æœ‰ç°æ¡ï¼Œå› ä¸ºé•¿è¾¹ç¼©æ”¾åˆ° 640 åçŸ­è¾¹åˆšå¥½ç¼©æ”¾åˆ° 480ï¼Œèƒ½æ•´é™¤ 32ã€‚è€Œ warpAffine åˆ™æ˜¯å›ºå®šåˆ†è¾¨ç‡ 640x640ï¼Œå› æ­¤çŸ­è¾¹å¤šä½™éƒ¨åˆ†å°†ç”¨ç°æ¡å¡«å……ã€‚</p> 
<p>warpAffine é¢„å¤„ç†æ–¹æ³•å°†å›¾åƒåˆ†è¾¨ç‡å›ºå®šåœ¨ 640x640ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ç‚¹è€ƒè™‘ï¼š(<strong>from chatGPT</strong>)</p> 
<ul><li><strong>ç®€åŒ–å¤„ç†é€»è¾‘</strong>ï¼šæ‰€æœ‰é¢„å¤„ç†åçš„å›¾åƒåˆ†è¾¨ç‡ç›¸åŒï¼Œå¯ä»¥ç®€åŒ– CUDA ä¸­å¹¶è¡Œå¤„ç†çš„é€»è¾‘ï¼Œä½¿å¾—ä»£ç æ›´æ˜“äºç¼–å†™å’Œç»´æŠ¤ã€‚</li><li><strong>ä¼˜åŒ–å†…å­˜è®¿é—®</strong>ï¼šåœ¨ GPU ä¸Šï¼Œè¿ç»­çš„å†…å­˜è®¿é—®æ¨¡å¼é€šå¸¸æ¯”éè¿ç»­çš„è®¿é—®æ›´é«˜æ•ˆã€‚å¦‚æœæ‰€æœ‰å›¾åƒå…·æœ‰ç›¸åŒçš„å¤§å°å’Œå¸ƒå±€ï¼Œè¿™å¯ä»¥å¸®åŠ©ä¼˜åŒ–å†…å­˜è®¿é—®ï¼Œæé«˜å¤„ç†é€Ÿåº¦ã€‚</li><li><strong>é¿å…åŠ¨æ€å†…å­˜åˆ†é…</strong>ï¼šåŠ¨æ€å†…å­˜åˆ†é…å’Œé‡Šæ”¾æ˜¯æ˜‚è´µçš„æ“ä½œï¼Œç‰¹åˆ«æ˜¯åœ¨ GPU ä¸Šã€‚å›ºå®šåˆ†è¾¨ç‡æ„å‘³ç€å¯ä»¥é¢„å…ˆåˆ†é…è¶³å¤Ÿçš„å†…å­˜ï¼Œè€Œä¸éœ€è¦æ ¹æ®æ¯ä¸ªå›¾åƒçš„å¤§å°åŠ¨æ€è°ƒæ•´å†…å­˜å¤§å°ã€‚</li></ul> 
<p>è¿™ä¸¤ç§ä¸åŒçš„é¢„å¤„ç†æ–¹æ³•ç”Ÿæˆçš„å›¾ç‰‡è¾“å…¥åˆ°ç¥ç»ç½‘ç»œæ—¶çš„ç»´åº¦ä¸åŒï¼Œletterbox çš„è¾“å…¥æ˜¯ <strong>torch.Size([1, 3, 640, 480])</strong>ï¼ŒwarpAffine çš„è¾“å…¥æ˜¯ <strong>torch.Size([1, 3, 640, 640])</strong>ã€‚ç”±äºè¾“å…¥ç»´åº¦ä¸åŒå°†å¯¼è‡´æ¨¡å‹è¾“å‡ºç»´åº¦çš„å·®å¼‚ï¼Œleetrbox çš„è¾“å‡ºæ˜¯ <strong>torch.Size([1, 56, 6300])</strong> åªæœ‰ 6300 ä¸ªæ¡†ï¼Œè€Œ warpAffine çš„è¾“å‡ºæ˜¯ <strong>torch.Size([1, 56, 8400])</strong> æœ‰ 8400 ä¸ªæ¡†ï¼Œè¿™ç‚¹å¤§å®¶éœ€è¦æ¸…æ¥šã€‚</p> 
<h4><a id="3_YOLOv8Seg_233"></a>3. YOLOv8-Segåå¤„ç†</h4> 
<blockquote> 
 <p>æˆ‘ä»¬å†æ¥çœ‹çœ‹åå¤„ç†çš„å®ç°</p> 
</blockquote> 
<p>ç»è¿‡æˆ‘ä»¬çš„è°ƒè¯•åˆ†æå¯çŸ¥ YOLOv8-Seg çš„åå¤„ç†éƒ¨åˆ†åœ¨ <strong>ultralytics/models/yolo/segment/predict.py</strong> æ–‡ä»¶ä¸­ï¼Œå¯ä»¥å‚è€ƒï¼š<a href="https://github.com/ultralytics/ultralytics/blob/main/ultralytics/models/yolo/segment/predict.py#L28">segment/predict.py#L28</a></p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">SegmentationPredictor</span><span class="token punctuation">(</span>DetectionPredictor<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    A class extending the DetectionPredictor class for prediction based on a segmentation model.

    Example:
        ```python
        from ultralytics.utils import ASSETS
        from ultralytics.models.yolo.segment import SegmentationPredictor

        args = dict(model='yolov8n-seg.pt', source=ASSETS)
        predictor = SegmentationPredictor(overrides=args)
        predictor.predict_cli()
        
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> cfg<span class="token operator">=</span>DEFAULT_CFG<span class="token punctuation">,</span> overrides<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> _callbacks<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Initializes the SegmentationPredictor with the provided configuration, overrides, and callbacks."""</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> overrides<span class="token punctuation">,</span> _callbacks<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>task <span class="token operator">=</span> <span class="token string">'segment'</span>

    <span class="token keyword">def</span> <span class="token function">postprocess</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> preds<span class="token punctuation">,</span> img<span class="token punctuation">,</span> orig_imgs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Applies non-max suppression and processes detections for each image in an input batch."""</span>
        p <span class="token operator">=</span> ops<span class="token punctuation">.</span>non_max_suppression<span class="token punctuation">(</span>preds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                    self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>conf<span class="token punctuation">,</span>
                                    self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>iou<span class="token punctuation">,</span>
                                    agnostic<span class="token operator">=</span>self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>agnostic_nms<span class="token punctuation">,</span>
                                    max_det<span class="token operator">=</span>self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>max_det<span class="token punctuation">,</span>
                                    nc<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>names<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                    classes<span class="token operator">=</span>self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>classes<span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>orig_imgs<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># input images are a torch.Tensor, not a list</span>
            orig_imgs <span class="token operator">=</span> ops<span class="token punctuation">.</span>convert_torch2numpy_batch<span class="token punctuation">(</span>orig_imgs<span class="token punctuation">)</span>

        results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        proto <span class="token operator">=</span> preds<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>preds<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span> <span class="token keyword">else</span> preds<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment"># second output is len 3 if pt, but only 1 if exported</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> pred <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">:</span>
            orig_img <span class="token operator">=</span> orig_imgs<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            img_path <span class="token operator">=</span> self<span class="token punctuation">.</span>batch<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">len</span><span class="token punctuation">(</span>pred<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># save empty boxes</span>
                masks <span class="token operator">=</span> <span class="token boolean">None</span>
            <span class="token keyword">elif</span> self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>retina_masks<span class="token punctuation">:</span>
                pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> ops<span class="token punctuation">.</span>scale_boxes<span class="token punctuation">(</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> orig_img<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
                masks <span class="token operator">=</span> ops<span class="token punctuation">.</span>process_mask_native<span class="token punctuation">(</span>proto<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> orig_img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># HWC</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                masks <span class="token operator">=</span> ops<span class="token punctuation">.</span>process_mask<span class="token punctuation">(</span>proto<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> upsample<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># HWC</span>
                pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> ops<span class="token punctuation">.</span>scale_boxes<span class="token punctuation">(</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> orig_img<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
            results<span class="token punctuation">.</span>append<span class="token punctuation">(</span>Results<span class="token punctuation">(</span>orig_img<span class="token punctuation">,</span> path<span class="token operator">=</span>img_path<span class="token punctuation">,</span> names<span class="token operator">=</span>self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>names<span class="token punctuation">,</span> boxes<span class="token operator">=</span>pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> masks<span class="token operator">=</span>masks<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> results
</code></pre> 
<p>å®ƒåŒ…å«ä»¥ä¸‹æ­¥éª¤ï¼š</p> 
<ul><li><strong>ops.non_max_suppression</strong>ï¼šéæå¤§å€¼æŠ‘åˆ¶ï¼Œå³ NMS</li><li><strong>ops.process_mask</strong>ï¼šmask çš„å¤„ç†</li><li><strong>ops.scale_boxes</strong>ï¼šæ¡†çš„è§£ç ï¼Œå³ decode boxes</li></ul> 
<p>å¤§å®¶å¦‚æœå¯¹ YOLOv5 çš„åå¤„ç†ç†Ÿæ‚‰çš„è¯ï¼Œä¼šå‘ç° YOLOv8-Seg çš„åå¤„ç†ä¸­æ£€æµ‹æ¡†çš„å¤„ç†å’Œ YOLOv5 ä¸­çš„åŸºæœ¬ä¸€æ ·ï¼Œåªæ˜¯éœ€è¦å¤§å®¶é¢å¤–å¤„ç†ä¸‹ maskï¼Œå› æ­¤æˆ‘ä»¬ä¸éš¾å†™å‡ºå¯¹åº”çš„åå¤„ç†ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">iou</span><span class="token punctuation">(</span>box1<span class="token punctuation">,</span> box2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">area_box</span><span class="token punctuation">(</span>box<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    left   <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    top    <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    right  <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    bottom <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    cross  <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">(</span>right<span class="token operator">-</span>left<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">(</span>bottom<span class="token operator">-</span>top<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    union  <span class="token operator">=</span> area_box<span class="token punctuation">(</span>box1<span class="token punctuation">)</span> <span class="token operator">+</span> area_box<span class="token punctuation">(</span>box2<span class="token punctuation">)</span> <span class="token operator">-</span> cross
    <span class="token keyword">if</span> cross <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">or</span> union <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">0</span>
    <span class="token keyword">return</span> cross <span class="token operator">/</span> union

<span class="token keyword">def</span> <span class="token function">NMS</span><span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> iou_thres<span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    remove_flags <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token boolean">False</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>boxes<span class="token punctuation">)</span>

    keep_boxes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> ibox <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>boxes<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> remove_flags<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>

        keep_boxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ibox<span class="token punctuation">)</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>boxes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> remove_flags<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>

            jbox <span class="token operator">=</span> boxes<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>ibox<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">!=</span> jbox<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            <span class="token keyword">if</span> iou<span class="token punctuation">(</span>ibox<span class="token punctuation">,</span> jbox<span class="token punctuation">)</span> <span class="token operator">&gt;</span> iou_thres<span class="token punctuation">:</span>
                remove_flags<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">True</span>
    <span class="token keyword">return</span> keep_boxes

<span class="token keyword">def</span> <span class="token function">postprocess</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> conf_thres<span class="token operator">=</span><span class="token number">0.25</span><span class="token punctuation">,</span> iou_thres<span class="token operator">=</span><span class="token number">0.45</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token comment"># è¾“å…¥æ˜¯æ¨¡å‹æ¨ç†çš„ç»“æœï¼Œå³8400ä¸ªé¢„æµ‹æ¡†</span>
    <span class="token comment"># 1,8400,116 [cx,cy,w,h,class*80,32]</span>
    boxes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> item <span class="token keyword">in</span> pred<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        cx<span class="token punctuation">,</span> cy<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>
        label <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">.</span>argmax<span class="token punctuation">(</span><span class="token punctuation">)</span>
        confidence <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">+</span> label<span class="token punctuation">]</span>
        <span class="token keyword">if</span> confidence <span class="token operator">&lt;</span> conf_thres<span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        left    <span class="token operator">=</span> cx <span class="token operator">-</span> w <span class="token operator">*</span> <span class="token number">0.5</span>
        top     <span class="token operator">=</span> cy <span class="token operator">-</span> h <span class="token operator">*</span> <span class="token number">0.5</span>
        right   <span class="token operator">=</span> cx <span class="token operator">+</span> w <span class="token operator">*</span> <span class="token number">0.5</span>
        bottom  <span class="token operator">=</span> cy <span class="token operator">+</span> h <span class="token operator">*</span> <span class="token number">0.5</span>
        boxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> right<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> confidence<span class="token punctuation">,</span> label<span class="token punctuation">,</span> <span class="token operator">*</span>item<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">32</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        
    boxes <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span>x<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> NMS<span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> iou_thres<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">crop_mask</span><span class="token punctuation">(</span>masks<span class="token punctuation">,</span> boxes<span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    <span class="token comment"># masks -&gt; n, 160, 160  åŸå§‹ masks</span>
    <span class="token comment"># boxes -&gt; n, 4         æ£€æµ‹æ¡†ï¼Œæ˜ å°„åˆ° 160x160 å°ºå¯¸ä¸‹çš„</span>
    n<span class="token punctuation">,</span> h<span class="token punctuation">,</span> w <span class="token operator">=</span> masks<span class="token punctuation">.</span>shape
    x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2 <span class="token operator">=</span> torch<span class="token punctuation">.</span>chunk<span class="token punctuation">(</span>boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># x1 shape(n,1,1)</span>
    r <span class="token operator">=</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>w<span class="token punctuation">,</span> device<span class="token operator">=</span>masks<span class="token punctuation">.</span>device<span class="token punctuation">,</span> dtype<span class="token operator">=</span>x1<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>  <span class="token comment"># rows shape(1,1,w)</span>
    c <span class="token operator">=</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>h<span class="token punctuation">,</span> device<span class="token operator">=</span>masks<span class="token punctuation">.</span>device<span class="token punctuation">,</span> dtype<span class="token operator">=</span>x1<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span>  <span class="token comment"># cols shape(1,h,1)</span>

    <span class="token keyword">return</span> masks <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r <span class="token operator">&gt;=</span> x1<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>r <span class="token operator">&lt;</span> x2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>c <span class="token operator">&gt;=</span> y1<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>c <span class="token operator">&lt;</span> y2<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">process_mask</span><span class="token punctuation">(</span>protos<span class="token punctuation">,</span> masks_in<span class="token punctuation">,</span> bboxes<span class="token punctuation">,</span> shape<span class="token punctuation">,</span> upsample<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token comment"># protos   -&gt; 32, 160, 160 åˆ†å‰²å¤´è¾“å‡º</span>
    <span class="token comment"># masks_in -&gt; n, 32        æ£€æµ‹å¤´è¾“å‡ºçš„ 32 ç»´å‘é‡ï¼Œå¯ä»¥ç†è§£ä¸º mask çš„æƒé‡</span>
    <span class="token comment"># bboxes   -&gt; n, 4         æ£€æµ‹æ¡†</span>
    <span class="token comment"># shape    -&gt; 640, 640     è¾“å…¥ç½‘ç»œä¸­çš„å›¾åƒ shape</span>
    <span class="token comment"># unsample ä¸€ä¸ª bool å€¼ï¼Œè¡¨ç¤ºæ˜¯å¦éœ€è¦ä¸Šé‡‡æ · masks åˆ°å›¾åƒçš„åŸå§‹å½¢çŠ¶</span>
    c<span class="token punctuation">,</span> mh<span class="token punctuation">,</span> mw <span class="token operator">=</span> protos<span class="token punctuation">.</span>shape  <span class="token comment"># CHW</span>
    ih<span class="token punctuation">,</span> iw <span class="token operator">=</span> shape
    <span class="token comment"># çŸ©é˜µç›¸ä¹˜ nx32 @ 32x(160x160) -&gt; nx(160x160) -&gt; sigmoid -&gt; nx160x160</span>
    masks <span class="token operator">=</span> <span class="token punctuation">(</span>masks_in<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span> @ protos<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> mh<span class="token punctuation">,</span> mw<span class="token punctuation">)</span>  <span class="token comment"># CHW</span>

    downsampled_bboxes <span class="token operator">=</span> bboxes<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span>
    downsampled_bboxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*=</span> mw <span class="token operator">/</span> iw
    downsampled_bboxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*=</span> mw <span class="token operator">/</span> iw
    downsampled_bboxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">*=</span> mh <span class="token operator">/</span> ih
    downsampled_bboxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*=</span> mh <span class="token operator">/</span> ih

    masks <span class="token operator">=</span> crop_mask<span class="token punctuation">(</span>masks<span class="token punctuation">,</span> downsampled_bboxes<span class="token punctuation">)</span>  <span class="token comment"># CHW</span>
    <span class="token keyword">if</span> upsample<span class="token punctuation">:</span>
        masks <span class="token operator">=</span> F<span class="token punctuation">.</span>interpolate<span class="token punctuation">(</span>masks<span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">,</span> shape<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'bilinear'</span><span class="token punctuation">,</span> align_corners<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># CHW</span>
    <span class="token keyword">return</span> masks<span class="token punctuation">.</span>gt_<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>
</code></pre> 
<p>å¯èƒ½æœ‰ç‚¹éš¾ç†è§£ï¼Œä¸‹é¢æˆ‘ä»¬ç®€å•åˆ†æä¸‹</p> 
<p>é¦–å…ˆå¯¹äºä¸€å¼  640x640 çš„å›¾ç‰‡æ¥è¯´ï¼ŒYOLOv8-Seg æ¨¡å‹å­˜åœ¨ä¸¤ä¸ªè¾“å‡ºï¼Œä¸€ä¸ªæ˜¯ output0 å¯ä»¥ç†è§£ä¸ºæ£€æµ‹å¤´çš„è¾“å‡ºï¼Œå®ƒçš„ç»´åº¦æ˜¯ <strong>1x116x8400</strong>ï¼›å¦ä¸€ä¸ªæ˜¯ output1 å¯ä»¥ç†è§£ä¸ºåˆ†å‰²å¤´çš„è¾“å‡ºï¼Œå®ƒçš„ç»´åº¦æ˜¯ <strong>1x32x160x160</strong>ï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸ªæ¥åˆ†æã€‚</p> 
<p>é’ˆå¯¹äºæ£€æµ‹å¤´çš„è¾“å‡º <strong>1x116x8400</strong> æˆ‘ä»¬åº”è¯¥å·²ç»éå¸¸ç†Ÿæ‚‰äº†ï¼Œå®ƒä»£è¡¨é¢„æµ‹æ¡†çš„æ€»æ•°é‡æ˜¯ <strong>8400</strong>ï¼Œæ¯ä¸ªé¢„æµ‹æ¡†çš„ç»´åº¦æ˜¯ <strong>116</strong>ï¼ˆé’ˆå¯¹ COCO æ•°æ®é›†çš„ 80 ä¸ªç±»åˆ«è€Œè¨€ï¼‰<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
           
            
            
              8400 
             
            
              Ã— 
             
            
              116 
             
            
           
          
          
           
            
             
            
              = 
             
            
              80 
             
            
              Ã— 
             
            
              80 
             
            
              Ã— 
             
            
              116 
             
            
              + 
             
            
              40 
             
            
              Ã— 
             
            
              40 
             
            
              Ã— 
             
            
              116 
             
            
              + 
             
            
              20 
             
            
              Ã— 
             
            
              20 
             
            
              Ã— 
             
            
              116 
             
            
           
          
         
         
          
           
            
           
          
          
           
            
             
            
              = 
             
            
              80 
             
            
              Ã— 
             
            
              80 
             
            
              Ã— 
             
            
              ( 
             
            
              84 
             
            
              + 
             
            
              32 
             
            
              ) 
             
            
              + 
             
            
              40 
             
            
              Ã— 
             
            
              40 
             
            
              Ã— 
             
            
              ( 
             
            
              84 
             
            
              + 
             
            
              32 
             
            
              ) 
             
            
              + 
             
            
              20 
             
            
              Ã— 
             
            
              20 
             
            
              Ã— 
             
            
              ( 
             
            
              84 
             
            
              + 
             
            
              32 
             
            
              ) 
             
            
           
          
         
         
          
           
            
           
          
          
           
            
             
            
              = 
             
            
              80 
             
            
              Ã— 
             
            
              80 
             
            
              Ã— 
             
            
              ( 
             
            
              4 
             
            
              + 
             
            
              80 
             
            
              + 
             
            
              32 
             
            
              ) 
             
            
              + 
             
            
              40 
             
            
              Ã— 
             
            
              40 
             
            
              Ã— 
             
            
              ( 
             
            
              4 
             
            
              + 
             
            
              80 
             
            
              + 
             
            
              32 
             
            
              ) 
             
            
              + 
             
            
              20 
             
            
              Ã— 
             
            
              20 
             
            
              Ã— 
             
            
              ( 
             
            
              4 
             
            
              + 
             
            
              80 
             
            
              + 
             
            
              32 
             
            
              ) 
             
            
           
          
         
        
       
         \begin{aligned} 8400\times116&amp;=80\times80\times116+40\times40\times116+20\times20\times116\\ &amp;=80\times80\times(84+32)+40\times40\times(84+32)+20\times20\times(84+32)\\ &amp;=80\times80\times(4+80+32)+40\times40\times(4+80+32)+20\times20\times(4+80+32)\\ \end{aligned} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 4.5em; vertical-align: -2em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.5em;"><span class="" style="top: -4.66em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">8400</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">116</span></span></span><span class="" style="top: -3.16em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -1.66em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 2em;"><span class=""></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.5em;"><span class="" style="top: -4.66em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord">80</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">80</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">116</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">40</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">40</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">116</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">20</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">20</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">116</span></span></span><span class="" style="top: -3.16em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord">80</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">80</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mopen">(</span><span class="mord">84</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">32</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">40</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">40</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mopen">(</span><span class="mord">84</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">32</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">20</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">20</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mopen">(</span><span class="mord">84</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">32</span><span class="mclose">)</span></span></span><span class="" style="top: -1.66em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord">80</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">80</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mopen">(</span><span class="mord">4</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">80</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">32</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">40</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">40</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mopen">(</span><span class="mord">4</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">80</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">32</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">20</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">20</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mopen">(</span><span class="mord">4</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">80</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">32</span><span class="mclose">)</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 2em;"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span><br> å…¶ä¸­çš„ 4 å¯¹åº”çš„æ˜¯ <strong>cx</strong>, <strong>cy</strong>, <strong>w</strong>, <strong>h</strong>ï¼Œåˆ†åˆ«ä»£è¡¨çš„å«ä¹‰æ˜¯è¾¹ç•Œæ¡†ä¸­å¿ƒç‚¹åæ ‡ã€å®½é«˜ï¼›80 å¯¹åº”çš„æ˜¯ COCO æ•°æ®é›†ä¸­çš„ 80 ä¸ªç±»åˆ«ç½®ä¿¡åº¦ã€‚32 ç»´çš„å‘é‡å¯ä»¥çœ‹ä½œæ˜¯ä¸æ¯ä¸ªæ£€æµ‹æ¡†å…³è”çš„åˆ†å‰² mask çš„ç³»æ•°æˆ–æƒé‡ã€‚</p> 
<p>é’ˆå¯¹äºåˆ†å‰²å¤´çš„è¾“å‡º <strong>1x32x160x160</strong>ï¼Œä¸€ä¸ªå…³é”®çš„æ¦‚å¿µæ˜¯ <strong>prototype masks</strong>ã€‚å®ƒæ˜¯ä¸€ä¸ªå›ºå®šæ•°é‡ï¼ˆ32ï¼‰çš„åŸºç¡€ maskï¼Œæ¯ä¸ª mask çš„å°ºå¯¸ä¸º 160x160ã€‚è¿™äº›åŸºç¡€ mask å¹¶ä¸ç›´æ¥å¯¹åº”äºä»»ä½•ç‰¹å®šçš„ç‰©ä½“æˆ–ç±»åˆ«ï¼Œè€Œæ˜¯è¢«è®¾è®¡ä¸ºå¯ä»¥çº¿æ€§ç»„åˆæ¥è¡¨ç¤ºä»»ä½•å¯èƒ½çš„ç‰©ä½“ maskã€‚</p> 
<p>ç®€å•æ¥è¯´ï¼Œæ¨¡å‹ä¸ç›´æ¥é¢„æµ‹æ¯ä¸ªç‰©ä½“çš„å®Œæ•´ maskï¼Œè€Œæ˜¯é¢„æµ‹ä¸€ç»„åŸºæœ¬çš„ masksï¼ˆç§°ä¸º prototype masksï¼‰ä»¥åŠæ¯ä¸ªç‰©ä½“å¦‚ä½•ç»„åˆè¿™äº› masksï¼ˆæƒé‡/ç³»æ•°ï¼‰ã€‚è¿™ç§æ–¹æ³•çš„å¥½å¤„æ˜¯ï¼Œæ¨¡å‹åªéœ€è¦é¢„æµ‹ä¸€ä¸ªè¾ƒå°çš„ mask å¼ é‡ï¼Œç„¶åå¯ä»¥é€šè¿‡ç®€å•çš„çŸ©é˜µä¹˜æ³•å°†è¿™äº›å° mask ç»„åˆæˆå®Œæ•´çš„ç‰©ä½“ masksã€‚</p> 
<p>å¤§å®¶å¯ä»¥æŠŠå®ƒç±»æ¯”äºçº¿æ€§ä»£æ•°ä¸­åŸºå‘é‡çš„æ¦‚å¿µï¼Œç©ºé—´ä¸­çš„ä»»ä½•ä¸€ä¸ªå‘é‡æ˜¯ä¸æ˜¯éƒ½å¯ä»¥è¡¨ç¤ºä¸ºä¸€ç»„åŸºå‘é‡çš„çº¿æ€§ç»„åˆï¼Œé‚£ä¹ˆå…¶ä¸­çš„ prototype masks å³ <strong>32x160x160</strong> çš„ mask å¼ é‡å¯ä»¥æŠŠå®ƒç†è§£ä¸ºä¸€ç»„åŸºå‘é‡ï¼Œè€Œä¹‹å‰åœ¨æ£€æµ‹æ¡†ä¸­çš„ <strong>32</strong> ç»´å‘é‡å¯ä»¥ç†è§£ä¸ºç»„åˆè¿™ä¸€ç»„åŸºå‘é‡çš„æƒé‡æˆ–è€…è¯´ç³»æ•°ã€‚</p> 
<p>å½“æˆ‘ä»¬ä»æ£€æµ‹å¤´å¾—åˆ°ä¸€ä¸ª 32 ç»´çš„å‘é‡ï¼Œåˆ†å‰²å¤´å¾—åˆ° 32 ä¸ªåŸºç¡€ masks æ—¶ï¼Œè¿™ä¸ª 32 ç»´çš„å‘é‡å®é™…ä¸Šè¡¨ç¤ºäº†å¦‚ä½•ç»„åˆè¿™äº›åŸºç¡€ masks æ¥å¾—åˆ°ä¸€ä¸ªç‰¹å®šç‰©ä½“çš„ maskã€‚å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬ç”¨è¿™ä¸ª 32 ç»´å‘é‡å¯¹ 32 ä¸ªåŸºç¡€ masks è¿›è¡Œçº¿æ€§ç»„åˆï¼Œä»è€Œå¾—åˆ°ä¸æ£€æµ‹æ¡†å…³è”çš„æœ€ç»ˆ maskã€‚ç®€å•æ¥è¯´ï¼Œè¿™å°±åƒä½ ç°åœ¨æœ‰ 32 ç§ä¸åŒçš„é¢œæ–™ï¼Œæ£€æµ‹å¤´ç»™ä½ ä¸€ä¸ªé…æ–¹ï¼ˆ32 ç»´å‘é‡ï¼‰ï¼Œå‘Šè¯‰ä½ å¦‚ä½•æ··åˆè¿™äº›é¢œæ–™æ¥å¾—åˆ°ä¸€ä¸ªç‰¹å®šçš„é¢œè‰²ï¼ˆæœ€ç»ˆçš„ maskï¼‰ã€‚</p> 
<p>è¿™æ ·åšçš„ä¼˜ç‚¹æ˜¯æˆ‘ä»¬ä¸éœ€è¦ä¸ºæ¯ä¸ªæ£€æµ‹æ¡†éƒ½é¢„æµ‹ä¸€ä¸ªå®Œæ•´çš„ maskï¼Œè¿™ä¸ªéå¸¸æ¶ˆè€—å†…å­˜å’Œè®¡ç®—èµ„æºã€‚ç›¸åï¼Œæˆ‘ä»¬åªéœ€è¦é¢„æµ‹ä¸€ä¸ªç›¸å¯¹è¾ƒå°çš„ 32 ç»´å‘é‡å’Œä¸€ä¸ªå›ºå®šæ•°é‡çš„åŸºç¡€ masksï¼Œç„¶ååœ¨åå¤„ç†ä¸­è¿›è¡Œç»„åˆå³å¯ã€‚</p> 
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ä»£ç ä¸­æ¡†çš„è§£ç æˆ‘ä»¬å¹¶æ²¡æœ‰åƒä¹‹å‰çš„ YOLOv5 ä¸€æ ·ï¼Œé€šè¿‡ä»¿å°„å˜æ¢é€†çŸ©é˜µ IM æ˜ å°„å›åŸå›¾ä¸Šï¼Œè€Œæ˜¯è®©å®ƒç»§ç»­ä¿æŒåœ¨ 640x640 çš„å›¾åƒä¸Šï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬åç»­åœ¨å¤„ç† mask çš„æ—¶å€™è¿˜éœ€è¦å°† boxes æ˜ å°„åˆ° 160x160 çš„ mask ä¸Šã€‚</p> 
<p>æˆ‘ä»¬é‡ç‚¹æ¥çœ‹ä¸‹ mask éƒ¨åˆ†çš„å¤„ç†ï¼Œåˆ†å‰²å¤´çš„è¾“å‡ºä¼šä½œä¸ºå‚æ•°ç›´æ¥ä¼ é€’åˆ° <strong>process_mask</strong> å‡½æ•°ä¸­è¿›è¡Œä¸‹ä¸€æ­¥å¤„ç†ï¼Œè¿™ä¸ªå‡½æ•°çš„ç›®çš„æ˜¯å°†åˆ†å‰²å¤´çš„è¾“å‡ºè½¬æ¢ä¸ºç‰©ä½“çš„ masksï¼Œä¸‹é¢æˆ‘ä»¬ç®€å•åˆ†æä¸‹è¯¥å‡½æ•°ï¼š</p> 
<p><strong>è¾“å…¥</strong>ï¼š</p> 
<ul><li><strong>protos</strong>ï¼šåˆ†å‰²å¤´çš„è¾“å‡ºï¼Œå½¢çŠ¶ä¸º 32x160x160</li><li><strong>masks_in</strong>ï¼šæ£€æµ‹å¤´è¾“å‡ºçš„ 32 ç»´å‘é‡ï¼Œå½¢çŠ¶ä¸º nx32</li><li><strong>bboxes</strong>ï¼šæ£€æµ‹æ¡†ï¼Œå½¢çŠ¶ä¸º nx4</li><li><strong>shape</strong>ï¼šè¾“å…¥ç½‘ç»œä¸­çš„å›¾åƒå¤§å° 640x640</li><li><strong>unsample</strong>ï¼šä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæ˜¯å¦éœ€è¦ä¸Šé‡‡æ · masks åˆ°å›¾åƒçš„åŸå§‹å½¢çŠ¶</li></ul> 
<p><strong>è¾“å‡º</strong>ï¼š</p> 
<ul><li>æœ€ç»ˆçš„ç‰©ä½“ masks</li></ul> 
<p><strong>å®ç°ç»†èŠ‚</strong>ï¼š</p> 
<ul><li>é¦–å…ˆä½¿ç”¨çŸ©é˜µä¹˜æ³•å°† <strong>mask_in</strong> ä¸ <strong>protos</strong> è¿›è¡Œçº¿æ€§ç»„åˆï¼Œå¾—åˆ°åŸå§‹çš„ masks</li><li>ç„¶åä½¿ç”¨ sigmoid å‡½æ•°å°†åŸå§‹ masks çš„å€¼æ˜ å°„åˆ° [0,1] ä¹‹é—´çš„æ¦‚ç‡å€¼</li><li>æ¥ç€ä¼šæ ¹æ®å›¾åƒçš„ shape å°†è¾¹ç•Œæ¡†çš„å¤§å°ç¼©æ”¾åˆ° 160x160 ä¸Š</li><li>ä½¿ç”¨ <strong>crop_mask</strong> å‡½æ•°è£å‰ª masks</li><li>å¦‚æœ <strong>unsample</strong> ä¸º Trueï¼Œåˆ™ä½¿ç”¨åŒçº¿æ€§æ’å€¼å°† masks ä¸Šé‡‡æ ·åˆ°å›¾åƒçš„åŸå§‹å½¢çŠ¶ï¼ˆ640x640ï¼‰</li><li>æœ€åä½¿ç”¨ <strong>gt_(0.5)</strong> å°† masks çš„å€¼æ˜ å°„åˆ° {0, 1}ã€‚å¤§äº 0.5 çš„éƒ¨åˆ†æˆ‘ä»¬è®¤ä¸ºè¿™ä¸ªåƒç´ æœ‰è¶…è¿‡ 50% çš„æ¦‚ç‡å±äºå‰æ™¯ï¼ˆç›®æ ‡ç‰©ä½“ï¼‰ï¼Œå› æ­¤è®¾ç½®ä¸º 1ï¼›åä¹‹ï¼Œå¦‚æœæ¦‚ç‡å°äºç­‰äº 0.5ï¼Œæˆ‘ä»¬åˆ™è®¤ä¸ºè¯¥åƒç´ æ˜¯èƒŒæ™¯ï¼Œè®¾ç½®ä¸º 0</li></ul> 
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ<strong>crop_masks</strong> å‡½æ•°å¹¶ä¸æ˜¯å°†åŸå§‹ masks è¿›è¡Œå°ºå¯¸çš„è£å‰ªï¼Œå®ƒä¸ä¼šæ”¹å˜ masks çš„å°ºå¯¸ã€‚å®ƒçš„ä¸»è¦ç›®çš„æ˜¯ä¸ºäº† <strong>å±è”½</strong> æ‰é‚£äº›ä¸åœ¨æ£€æµ‹æ¡†å†…çš„éƒ¨åˆ†ï¼Œè¿™æ · mask é‡Œçš„å€¼åªä¼šåœ¨æ£€æµ‹æ¡†å†…éƒ¨åˆ†ä¸º 1ï¼Œè€Œæ£€æµ‹æ¡†å¤–çš„éƒ¨åˆ†ä¸º 0ã€‚è¿™æ˜¯å› ä¸ºåœ¨ 160x160 çš„ mask èŒƒå›´å†…ï¼Œæˆ‘ä»¬åªå¯¹æ£€æµ‹æ¡†å†…çš„ç‰©ä½“éƒ¨åˆ†æ„Ÿå…´è¶£ï¼Œå…¶å®ƒéƒ¨åˆ†æˆ‘ä»¬å¹¶ä¸å…³æ³¨ã€‚</p> 
<h4><a id="4_YOLOv8Seg_438"></a>4. YOLOv8-Segæ¨ç†</h4> 
<blockquote> 
 <p>é€šè¿‡ä¸Šé¢å¯¹ YOLOv8-Seg çš„é¢„å¤„ç†å’Œåå¤„ç†åˆ†æä¹‹åï¼Œæ•´ä¸ªæ¨ç†è¿‡ç¨‹å°±æ˜¾è€Œæ˜“è§äº†ã€‚YOLOv8-Seg çš„æ¨ç†åŒ…æ‹¬å›¾åƒé¢„å¤„ç†ã€æ¨¡å‹æ¨ç†ã€é¢„æµ‹ç»“æœåå¤„ç†ä¸‰éƒ¨åˆ†ï¼Œå…¶ä¸­é¢„å¤„ç†ä¸»è¦åŒ…æ‹¬ <strong>warpAffine ä»¿å°„å˜æ¢</strong>ï¼Œåå¤„ç†ä¸»è¦åŒ…æ‹¬ <strong>boxes çš„ decode è§£ç å’Œ NMS ä»¥åŠ mask çš„å¤„ç†</strong> ä¸‰éƒ¨åˆ†ã€‚</p> 
</blockquote> 
<p>å®Œæ•´çš„æ¨ç†ä»£ç å¦‚ä¸‹ï¼š</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> cv2
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F
<span class="token keyword">from</span> ultralytics<span class="token punctuation">.</span>data<span class="token punctuation">.</span>augment <span class="token keyword">import</span> LetterBox
<span class="token keyword">from</span> ultralytics<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>autobackend <span class="token keyword">import</span> AutoBackend

<span class="token keyword">def</span> <span class="token function">preprocess_letterbox</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">:</span>
    letterbox <span class="token operator">=</span> LetterBox<span class="token punctuation">(</span>new_shape<span class="token operator">=</span><span class="token number">640</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> auto<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    image <span class="token operator">=</span> letterbox<span class="token punctuation">(</span>image<span class="token operator">=</span>image<span class="token punctuation">)</span>
    image <span class="token operator">=</span> <span class="token punctuation">(</span>image<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">255.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span> <span class="token comment"># BGR to RGB, 0 - 255 to 0.0 - 1.0</span>
    image <span class="token operator">=</span> image<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span>  <span class="token comment"># BHWC to BCHW (n, 3, h, w)</span>
    image <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
    <span class="token keyword">return</span> image

<span class="token keyword">def</span> <span class="token function">preprocess_warpAffine</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> dst_width<span class="token operator">=</span><span class="token number">640</span><span class="token punctuation">,</span> dst_height<span class="token operator">=</span><span class="token number">640</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    scale <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dst_width <span class="token operator">/</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dst_height <span class="token operator">/</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    ox <span class="token operator">=</span> <span class="token punctuation">(</span>dst_width  <span class="token operator">-</span> scale <span class="token operator">*</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
    oy <span class="token operator">=</span> <span class="token punctuation">(</span>dst_height <span class="token operator">-</span> scale <span class="token operator">*</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
    M <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token punctuation">[</span>scale<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ox<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> scale<span class="token punctuation">,</span> oy<span class="token punctuation">]</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
    
    img_pre <span class="token operator">=</span> cv2<span class="token punctuation">.</span>warpAffine<span class="token punctuation">(</span>image<span class="token punctuation">,</span> M<span class="token punctuation">,</span> <span class="token punctuation">(</span>dst_width<span class="token punctuation">,</span> dst_height<span class="token punctuation">)</span><span class="token punctuation">,</span> flags<span class="token operator">=</span>cv2<span class="token punctuation">.</span>INTER_LINEAR<span class="token punctuation">,</span>
                             borderMode<span class="token operator">=</span>cv2<span class="token punctuation">.</span>BORDER_CONSTANT<span class="token punctuation">,</span> borderValue<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">114</span><span class="token punctuation">,</span> <span class="token number">114</span><span class="token punctuation">,</span> <span class="token number">114</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    IM <span class="token operator">=</span> cv2<span class="token punctuation">.</span>invertAffineTransform<span class="token punctuation">(</span>M<span class="token punctuation">)</span>

    img_pre <span class="token operator">=</span> <span class="token punctuation">(</span>img_pre<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">255.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
    img_pre <span class="token operator">=</span> img_pre<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span>
    img_pre <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>img_pre<span class="token punctuation">)</span>
    <span class="token keyword">return</span> img_pre<span class="token punctuation">,</span> IM

<span class="token keyword">def</span> <span class="token function">iou</span><span class="token punctuation">(</span>box1<span class="token punctuation">,</span> box2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">area_box</span><span class="token punctuation">(</span>box<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    left   <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    top    <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    right  <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    bottom <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    cross  <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">(</span>right<span class="token operator">-</span>left<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">(</span>bottom<span class="token operator">-</span>top<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    union  <span class="token operator">=</span> area_box<span class="token punctuation">(</span>box1<span class="token punctuation">)</span> <span class="token operator">+</span> area_box<span class="token punctuation">(</span>box2<span class="token punctuation">)</span> <span class="token operator">-</span> cross
    <span class="token keyword">if</span> cross <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">or</span> union <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">0</span>
    <span class="token keyword">return</span> cross <span class="token operator">/</span> union

<span class="token keyword">def</span> <span class="token function">NMS</span><span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> iou_thres<span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    remove_flags <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token boolean">False</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>boxes<span class="token punctuation">)</span>

    keep_boxes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> ibox <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>boxes<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> remove_flags<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>

        keep_boxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ibox<span class="token punctuation">)</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>boxes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> remove_flags<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>

            jbox <span class="token operator">=</span> boxes<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>ibox<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">!=</span> jbox<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            <span class="token keyword">if</span> iou<span class="token punctuation">(</span>ibox<span class="token punctuation">,</span> jbox<span class="token punctuation">)</span> <span class="token operator">&gt;</span> iou_thres<span class="token punctuation">:</span>
                remove_flags<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">True</span>
    <span class="token keyword">return</span> keep_boxes

<span class="token keyword">def</span> <span class="token function">postprocess</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> conf_thres<span class="token operator">=</span><span class="token number">0.25</span><span class="token punctuation">,</span> iou_thres<span class="token operator">=</span><span class="token number">0.45</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token comment"># è¾“å…¥æ˜¯æ¨¡å‹æ¨ç†çš„ç»“æœï¼Œå³8400ä¸ªé¢„æµ‹æ¡†</span>
    <span class="token comment"># 1,8400,116 [cx,cy,w,h,class*80,32]</span>
    boxes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> item <span class="token keyword">in</span> pred<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        cx<span class="token punctuation">,</span> cy<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>
        label <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">.</span>argmax<span class="token punctuation">(</span><span class="token punctuation">)</span>
        confidence <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">+</span> label<span class="token punctuation">]</span>
        <span class="token keyword">if</span> confidence <span class="token operator">&lt;</span> conf_thres<span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        left    <span class="token operator">=</span> cx <span class="token operator">-</span> w <span class="token operator">*</span> <span class="token number">0.5</span>
        top     <span class="token operator">=</span> cy <span class="token operator">-</span> h <span class="token operator">*</span> <span class="token number">0.5</span>
        right   <span class="token operator">=</span> cx <span class="token operator">+</span> w <span class="token operator">*</span> <span class="token number">0.5</span>
        bottom  <span class="token operator">=</span> cy <span class="token operator">+</span> h <span class="token operator">*</span> <span class="token number">0.5</span>
        boxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> right<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> confidence<span class="token punctuation">,</span> label<span class="token punctuation">,</span> <span class="token operator">*</span>item<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">32</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        
    boxes <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span>x<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> NMS<span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> iou_thres<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">crop_mask</span><span class="token punctuation">(</span>masks<span class="token punctuation">,</span> boxes<span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    <span class="token comment"># masks -&gt; n, 160, 160  åŸå§‹ masks</span>
    <span class="token comment"># boxes -&gt; n, 4         æ£€æµ‹æ¡†ï¼Œæ˜ å°„åˆ° 160x160 å°ºå¯¸ä¸‹çš„</span>
    n<span class="token punctuation">,</span> h<span class="token punctuation">,</span> w <span class="token operator">=</span> masks<span class="token punctuation">.</span>shape
    x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2 <span class="token operator">=</span> torch<span class="token punctuation">.</span>chunk<span class="token punctuation">(</span>boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># x1 shape(n,1,1)</span>
    r <span class="token operator">=</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>w<span class="token punctuation">,</span> device<span class="token operator">=</span>masks<span class="token punctuation">.</span>device<span class="token punctuation">,</span> dtype<span class="token operator">=</span>x1<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>  <span class="token comment"># rows shape(1,1,w)</span>
    c <span class="token operator">=</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>h<span class="token punctuation">,</span> device<span class="token operator">=</span>masks<span class="token punctuation">.</span>device<span class="token punctuation">,</span> dtype<span class="token operator">=</span>x1<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span>  <span class="token comment"># cols shape(1,h,1)</span>

    <span class="token keyword">return</span> masks <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r <span class="token operator">&gt;=</span> x1<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>r <span class="token operator">&lt;</span> x2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>c <span class="token operator">&gt;=</span> y1<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>c <span class="token operator">&lt;</span> y2<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">process_mask</span><span class="token punctuation">(</span>protos<span class="token punctuation">,</span> masks_in<span class="token punctuation">,</span> bboxes<span class="token punctuation">,</span> shape<span class="token punctuation">,</span> upsample<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token comment"># protos   -&gt; 32, 160, 160 åˆ†å‰²å¤´è¾“å‡º</span>
    <span class="token comment"># masks_in -&gt; n, 32        æ£€æµ‹å¤´è¾“å‡ºçš„ 32 ç»´å‘é‡ï¼Œå¯ä»¥ç†è§£ä¸º mask çš„æƒé‡</span>
    <span class="token comment"># bboxes   -&gt; n, 4         æ£€æµ‹æ¡†</span>
    <span class="token comment"># shape    -&gt; 640, 640     è¾“å…¥ç½‘ç»œä¸­çš„å›¾åƒ shape</span>
    <span class="token comment"># unsample ä¸€ä¸ª bool å€¼ï¼Œè¡¨ç¤ºæ˜¯å¦éœ€è¦ä¸Šé‡‡æ · masks åˆ°å›¾åƒçš„åŸå§‹å½¢çŠ¶</span>
    c<span class="token punctuation">,</span> mh<span class="token punctuation">,</span> mw <span class="token operator">=</span> protos<span class="token punctuation">.</span>shape  <span class="token comment"># CHW</span>
    ih<span class="token punctuation">,</span> iw <span class="token operator">=</span> shape
    <span class="token comment"># çŸ©é˜µç›¸ä¹˜ nx32 @ 32x(160x160) -&gt; nx(160x160) -&gt; sigmoid -&gt; nx160x160</span>
    masks <span class="token operator">=</span> <span class="token punctuation">(</span>masks_in<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span> @ protos<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> mh<span class="token punctuation">,</span> mw<span class="token punctuation">)</span>  <span class="token comment"># CHW</span>

    downsampled_bboxes <span class="token operator">=</span> bboxes<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span>
    downsampled_bboxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*=</span> mw <span class="token operator">/</span> iw
    downsampled_bboxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*=</span> mw <span class="token operator">/</span> iw
    downsampled_bboxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">*=</span> mh <span class="token operator">/</span> ih
    downsampled_bboxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*=</span> mh <span class="token operator">/</span> ih

    masks <span class="token operator">=</span> crop_mask<span class="token punctuation">(</span>masks<span class="token punctuation">,</span> downsampled_bboxes<span class="token punctuation">)</span>  <span class="token comment"># CHW</span>
    <span class="token keyword">if</span> upsample<span class="token punctuation">:</span>
        masks <span class="token operator">=</span> F<span class="token punctuation">.</span>interpolate<span class="token punctuation">(</span>masks<span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">,</span> shape<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'bilinear'</span><span class="token punctuation">,</span> align_corners<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># CHW</span>
    <span class="token keyword">return</span> masks<span class="token punctuation">.</span>gt_<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">hsv2bgr</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> s<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">:</span>
    h_i <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>h <span class="token operator">*</span> <span class="token number">6</span><span class="token punctuation">)</span>
    f <span class="token operator">=</span> h <span class="token operator">*</span> <span class="token number">6</span> <span class="token operator">-</span> h_i
    p <span class="token operator">=</span> v <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> s<span class="token punctuation">)</span>
    q <span class="token operator">=</span> v <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> f <span class="token operator">*</span> s<span class="token punctuation">)</span>
    t <span class="token operator">=</span> v <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> f<span class="token punctuation">)</span> <span class="token operator">*</span> s<span class="token punctuation">)</span>
    
    r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>

    <span class="token keyword">if</span> h_i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> v<span class="token punctuation">,</span> t<span class="token punctuation">,</span> p
    <span class="token keyword">elif</span> h_i <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> q<span class="token punctuation">,</span> v<span class="token punctuation">,</span> p
    <span class="token keyword">elif</span> h_i <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> p<span class="token punctuation">,</span> v<span class="token punctuation">,</span> t
    <span class="token keyword">elif</span> h_i <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> p<span class="token punctuation">,</span> q<span class="token punctuation">,</span> v
    <span class="token keyword">elif</span> h_i <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> t<span class="token punctuation">,</span> p<span class="token punctuation">,</span> v
    <span class="token keyword">elif</span> h_i <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> v<span class="token punctuation">,</span> p<span class="token punctuation">,</span> q

    <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">(</span>b <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>g <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>r <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">random_color</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    h_plane <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">id</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">0x937151</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">100.0</span>
    s_plane <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">id</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">0x315793</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">100.0</span>
    <span class="token keyword">return</span> hsv2bgr<span class="token punctuation">(</span>h_plane<span class="token punctuation">,</span> s_plane<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>

    img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">"ultralytics/assets/bus.jpg"</span><span class="token punctuation">)</span>

    <span class="token comment"># img_pre = preprocess_letterbox(img)</span>
    img_pre<span class="token punctuation">,</span> IM <span class="token operator">=</span> preprocess_warpAffine<span class="token punctuation">(</span>img<span class="token punctuation">)</span>

    model  <span class="token operator">=</span> AutoBackend<span class="token punctuation">(</span>weights<span class="token operator">=</span><span class="token string">"yolov8s-seg.pt"</span><span class="token punctuation">)</span>
    names  <span class="token operator">=</span> model<span class="token punctuation">.</span>names
    result <span class="token operator">=</span> model<span class="token punctuation">(</span>img_pre<span class="token punctuation">)</span>
    <span class="token triple-quoted-string string">"""
    result[0] -&gt; 1, 116, 8400 -&gt; det head
    result[1][0][0] -&gt; 1, 144, 80, 80
    result[1][0][1] -&gt; 1, 144, 40, 40
    result[1][0][2] -&gt; 1, 144, 20, 20
    result[1][1] -&gt; 1, 32, 8400
    result[1][2] -&gt; 1, 32, 160, 160 -&gt; seg head
    """</span>

    output0 <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment"># 1,8400,116 æ£€æµ‹å¤´è¾“å‡º</span>
    output1 <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>             <span class="token comment"># 32,160,160 åˆ†å‰²å¤´è¾“å‡º</span>

    pred <span class="token operator">=</span> postprocess<span class="token punctuation">(</span>output0<span class="token punctuation">)</span>
    pred <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>pred<span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">38</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># pred -&gt; nx38 = [cx,cy,w,h,conf,label,32]</span>
    masks <span class="token operator">=</span> process_mask<span class="token punctuation">(</span>output1<span class="token punctuation">,</span> pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> img_pre<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>

    boxes <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    lr <span class="token operator">=</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    tb <span class="token operator">=</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> IM<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> lr <span class="token operator">+</span> IM<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
    boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> IM<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> tb <span class="token operator">+</span> IM<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>

    <span class="token comment"># draw mask</span>
    h<span class="token punctuation">,</span> w <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> mask <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>masks<span class="token punctuation">)</span><span class="token punctuation">:</span>
        
        mask <span class="token operator">=</span> mask<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span> <span class="token comment"># 640x640</span>
        mask_resized <span class="token operator">=</span> cv2<span class="token punctuation">.</span>warpAffine<span class="token punctuation">(</span>mask<span class="token punctuation">,</span> IM<span class="token punctuation">,</span> <span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">,</span> flags<span class="token operator">=</span>cv2<span class="token punctuation">.</span>INTER_LINEAR<span class="token punctuation">)</span>  <span class="token comment"># 1080x810</span>
        
        label <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>boxes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        color <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>random_color<span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        colored_mask <span class="token operator">=</span> <span class="token punctuation">(</span>np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> w<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> color<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
        masked_colored_mask <span class="token operator">=</span> cv2<span class="token punctuation">.</span>bitwise_and<span class="token punctuation">(</span>colored_mask<span class="token punctuation">,</span> colored_mask<span class="token punctuation">,</span> mask<span class="token operator">=</span>mask_resized<span class="token punctuation">)</span>

        mask_indices <span class="token operator">=</span> mask_resized <span class="token operator">==</span> <span class="token number">1</span>
        img<span class="token punctuation">[</span>mask_indices<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>img<span class="token punctuation">[</span>mask_indices<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">0.6</span> <span class="token operator">+</span> masked_colored_mask<span class="token punctuation">[</span>mask_indices<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>

        <span class="token comment"># contours, _ = cv2.findContours(mask_resized, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)</span>
        <span class="token comment"># cv2.drawContours(img, contours, -1, random_color(label), 2)</span>

    <span class="token comment"># draw box</span>
    <span class="token keyword">for</span> obj <span class="token keyword">in</span> boxes<span class="token punctuation">:</span>
        left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> right<span class="token punctuation">,</span> bottom <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        confidence <span class="token operator">=</span> obj<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>
        label <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        color <span class="token operator">=</span> random_color<span class="token punctuation">(</span>label<span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span>left<span class="token punctuation">,</span> top<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>right<span class="token punctuation">,</span> bottom<span class="token punctuation">)</span><span class="token punctuation">,</span> color <span class="token operator">=</span> color <span class="token punctuation">,</span>thickness<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> lineType<span class="token operator">=</span>cv2<span class="token punctuation">.</span>LINE_AA<span class="token punctuation">)</span>
        caption <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>names<span class="token punctuation">[</span>label<span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>confidence<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
        w<span class="token punctuation">,</span> h <span class="token operator">=</span> cv2<span class="token punctuation">.</span>getTextSize<span class="token punctuation">(</span>caption<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span>left <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">,</span> top <span class="token operator">-</span> <span class="token number">33</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>left <span class="token operator">+</span> w <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">,</span> top<span class="token punctuation">)</span><span class="token punctuation">,</span> color<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>img<span class="token punctuation">,</span> caption<span class="token punctuation">,</span> <span class="token punctuation">(</span>left<span class="token punctuation">,</span> top <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
    
    cv2<span class="token punctuation">.</span>imwrite<span class="token punctuation">(</span><span class="token string">"infer-seg.jpg"</span><span class="token punctuation">,</span> img<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"save done"</span><span class="token punctuation">)</span>    
</code></pre> 
<p>æ¨ç†æ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p> 
<p><img src="https://images2.imgbox.com/f3/c9/t9xVErjt_o.jpg" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬åœ¨ Python ä¸Šé¢å®Œæˆäº† YOLOv8-Seg çš„æ•´ä¸ªæ¨ç†è¿‡ç¨‹ï¼Œä¸‹é¢æˆ‘ä»¬å» C++ ä¸Šå®ç°ã€‚</p> 
<h3><a id="YOLOv8SegC_673"></a>äºŒã€YOLOv8-Segæ¨ç†(C++)</h3> 
<blockquote> 
 <p>C++ ä¸Šçš„å®ç°æˆ‘ä»¬ä½¿ç”¨çš„ repo ä¾æ—§æ˜¯ tensorRT_Proï¼Œç°åœ¨æˆ‘ä»¬å°±åŸºäº tensorRT_Pro å®Œæˆ YOLOv8-Seg åœ¨ C++ ä¸Šçš„æ¨ç†ã€‚</p> 
</blockquote> 
<h4><a id="1_ONNX_677"></a>1. ONNXå¯¼å‡º</h4> 
<p>é¦–å…ˆæˆ‘ä»¬éœ€è¦å°† YOLOv8-Seg æ¨¡å‹å¯¼å‡ºä¸º ONNXï¼Œä¸ºäº†é€‚é… tensorRT_Pro æˆ‘ä»¬éœ€è¦åšä¸€äº›ä¿®æ”¹ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š</p> 
<ul><li>è¾“å…¥è¾“å‡ºåªè®© batch ç»´åº¦åŠ¨æ€ï¼Œå®½é«˜ä¸åŠ¨æ€</li><li>å¢åŠ  <strong>transpose</strong> èŠ‚ç‚¹äº¤æ¢è¾“å‡ºçš„ 2ã€3 ç»´åº¦</li></ul> 
<p>å…·ä½“ä¿®æ”¹å¦‚ä¸‹ï¼š</p> 
<p><strong>1.</strong> <strong>åœ¨ ultralytics/engine/exporter.py æ–‡ä»¶ä¸­æ”¹åŠ¨ä¸€å¤„</strong></p> 
<ul><li><strong>326 è¡Œ</strong>ï¼šè¾“å…¥åªè®© batch ç»´åº¦åŠ¨æ€ï¼Œå®½é«˜ä¸åŠ¨æ€</li><li><strong>328/329 è¡Œ</strong>ï¼šè¾“å‡ºåªè®© batch åŠ¨æ€ï¼Œå®½é«˜ä¸åŠ¨æ€</li></ul> 
<pre><code class="prism language-python"><span class="token comment"># ========== exporter.py ==========</span>

<span class="token comment"># ultralytics/engine/exporter.pyç¬¬323è¡Œ</span>
<span class="token comment"># output_names = ['output0', 'output1'] if isinstance(self.model, SegmentationModel) else ['output0']</span>
<span class="token comment"># dynamic = self.args.dynamic</span>
<span class="token comment"># if dynamic:</span>
<span class="token comment">#     dynamic = {'images': {0: 'batch', 2: 'height', 3: 'width'}}  # shape(1,3,640,640)</span>
<span class="token comment">#     if isinstance(self.model, SegmentationModel):</span>
<span class="token comment">#         dynamic['output0'] = {0: 'batch', 2: 'anchors'}  # shape(1, 116, 8400)</span>
<span class="token comment">#         dynamic['output1'] = {0: 'batch', 2: 'mask_height', 3: 'mask_width'}  # shape(1,32,160,160)</span>
<span class="token comment">#     elif isinstance(self.model, DetectionModel):</span>
<span class="token comment">#         dynamic['output0'] = {0: 'batch', 2: 'anchors'}  # shape(1, 84, 8400)</span>
<span class="token comment"># ä¿®æ”¹ä¸ºï¼š</span>

output_names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'output0'</span><span class="token punctuation">,</span> <span class="token string">'output1'</span><span class="token punctuation">]</span> <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>model<span class="token punctuation">,</span> SegmentationModel<span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token punctuation">[</span><span class="token string">'output0'</span><span class="token punctuation">]</span>
dynamic <span class="token operator">=</span> self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>dynamic
<span class="token keyword">if</span> dynamic<span class="token punctuation">:</span>
    dynamic <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'images'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">'batch'</span><span class="token punctuation">}</span><span class="token punctuation">}</span>  <span class="token comment"># shape(1,3,640,640)</span>
    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>model<span class="token punctuation">,</span> SegmentationModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
        dynamic<span class="token punctuation">[</span><span class="token string">'output0'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">'batch'</span><span class="token punctuation">}</span>  <span class="token comment"># shape(1, 116, 8400)</span>
        dynamic<span class="token punctuation">[</span><span class="token string">'output1'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">'batch'</span><span class="token punctuation">}</span>  <span class="token comment"># shape(1,32,160,160)</span>
    <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>model<span class="token punctuation">,</span> DetectionModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
        dynamic<span class="token punctuation">[</span><span class="token string">'output0'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">'batch'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span> <span class="token string">'anchors'</span><span class="token punctuation">}</span>  <span class="token comment"># shape(1, 84, 8400)</span>
</code></pre> 
<p><strong>2.</strong> <strong>åœ¨ ultralytics/nn/modules/head.py æ–‡ä»¶ä¸­æ”¹åŠ¨ä¸€å¤„</strong></p> 
<ul><li><strong>106 è¡Œ</strong>ï¼šæ·»åŠ  <strong>transpose</strong> èŠ‚ç‚¹äº¤æ¢æ£€æµ‹å¤´è¾“å‡ºçš„ç¬¬ 2 å’Œ ç¬¬ 3 ç»´åº¦</li></ul> 
<pre><code class="prism language-python"><span class="token comment"># ========== head.py ==========</span>

<span class="token comment"># ultralytics/nn/modules/head.pyç¬¬106è¡Œï¼Œforwardå‡½æ•°</span>
<span class="token comment"># return (torch.cat([x, mc], 1), p) if self.export else (torch.cat([x[0], mc], 1), (x[1], mc, p))</span>
<span class="token comment"># ä¿®æ”¹ä¸ºï¼š</span>

<span class="token keyword">return</span> <span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">,</span> mc<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>export <span class="token keyword">else</span> <span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> mc<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> mc<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>ä»¥ä¸Šå°±æ˜¯ä¸ºäº†é€‚é… tensorRT_Pro è€Œåšå‡ºçš„ä»£ç ä¿®æ”¹ï¼Œä¿®æ”¹å¥½ä»¥åï¼Œå°†é¢„è®­ç»ƒæƒé‡ <strong>yolov8s-seg.pt</strong> æ”¾åœ¨ ultralytics-main ä¸»ç›®å½•ä¸‹ï¼Œæ–°å»ºå¯¼å‡ºæ–‡ä»¶ <strong>export.py</strong>ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> ultralytics <span class="token keyword">import</span> YOLO

model <span class="token operator">=</span> YOLO<span class="token punctuation">(</span><span class="token string">"yolov8s-seg.pt"</span><span class="token punctuation">)</span>

success <span class="token operator">=</span> model<span class="token punctuation">.</span>export<span class="token punctuation">(</span><span class="token builtin">format</span><span class="token operator">=</span><span class="token string">"onnx"</span><span class="token punctuation">,</span> dynamic<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> simplify<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre> 
<p>åœ¨ç»ˆç«¯æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤å³å¯å®Œæˆ onnx å¯¼å‡ºï¼š</p> 
<pre><code class="prism language-shell">python export.py
</code></pre> 
<p>å¯¼å‡ºè¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p> 
<p><img src="https://images2.imgbox.com/d7/4d/IxVpqD3a_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<p>å¯ä»¥çœ‹åˆ°å¯¼å‡ºçš„ pytorch æ¨¡å‹çš„è¾“å…¥ shape æ˜¯ 1x3x640x640ï¼Œæ£€æµ‹å¤´è¾“å‡º shape æ˜¯ 1x8400x116ï¼Œåˆ†å‰²å¤´è¾“å‡º shape æ˜¯ 1x32x160x160ï¼Œç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸã€‚</p> 
<p>å¯¼å‡ºæˆåŠŸåä¼šåœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆ yolov8s-seg.onnx æ¨¡å‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <a href="https://netron.app/" rel="nofollow">Netron</a> å¯è§†åŒ–å·¥å…·æŸ¥çœ‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p> 
<p><img src="https://images2.imgbox.com/19/75/gaqHVgrt_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<p>å¯ä»¥çœ‹åˆ°è¾“å…¥èŠ‚ç‚¹åæ˜¯ <strong>images</strong>ï¼Œç»´åº¦æ˜¯ batchx3x640x640ï¼Œä¿è¯åªæœ‰ batch ç»´åº¦åŠ¨æ€ï¼Œæ£€æµ‹å¤´è¾“å‡ºèŠ‚ç‚¹åæ˜¯ <strong>output0</strong>ï¼Œç»´åº¦æ˜¯ batchxTransposeoutput_dim_1xTransposeoutput_dim_2ï¼Œåˆ†å‰²å¤´è¾“å‡ºèŠ‚ç‚¹åæ˜¯ <strong>output1</strong>ï¼Œç»´åº¦æ˜¯ batchx32x160x160ï¼Œä¿è¯åªæœ‰ batch ç»´åº¦åŠ¨æ€ï¼Œç¬¦åˆ tensorRT_Pro çš„æ ¼å¼ã€‚</p> 
<p>å¤§å®¶ä¸è¦çœ‹åˆ° Transposeoutput_dim_1 å’Œ Transposeoutput_dim_2 å°±è®¤ä¸ºè¿™ä¹Ÿæ˜¯åŠ¨æ€çš„ï¼Œå…¶å®è¾“å‡ºèŠ‚ç‚¹çš„ç»´åº¦æ˜¯æ ¹æ®è¾“å…¥èŠ‚ç‚¹çš„ç»´åº¦å’Œæ¨¡å‹çš„ç»“æ„ç”Ÿæˆçš„ï¼Œè€Œé¢å¤–çš„ç»´åº¦ Transposeoutput_dim_1 å’Œ Transposeoutput_dim_2 å¯èƒ½æ˜¯ç”±æ¨¡å‹ç»“æ„ä¸­æŸäº›æ“ä½œå†³å®šçš„ï¼Œå¦‚é€šé“æ•°å˜æ¢ï¼ˆTransposeï¼‰æ“ä½œçš„è¾“å‡ºç»´åº¦ï¼Œè€Œä¸æ˜¯ç”±åŠ¨æ€ç»´åº¦å†³å®šçš„ã€‚å› æ­¤ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œè¿™äº›ç»´åº¦æ˜¯é™æ€çš„ï¼Œä¸ä¼šåœ¨æ¨ç†æ—¶æ”¹å˜ã€‚</p> 
<h4><a id="2_YOLOv8Seg_763"></a>2. YOLOv8-Segé¢„å¤„ç†</h4> 
<blockquote> 
 <p>ä¹‹å‰æœ‰æåˆ°è¿‡ YOLOv8-Seg çš„é¢„å¤„ç†éƒ¨åˆ†å’Œ YOLOv5 å®ç°ä¸€æ¨¡ä¸€æ ·ï¼Œå› æ­¤æˆ‘ä»¬åœ¨ tensorRT_Pro ä¸­ YOLOv8-Seg æ¨¡å‹çš„é¢„å¤„ç†å¯ä»¥ç›´æ¥ä½¿ç”¨ YOLOv5 çš„é¢„å¤„ç†ã€‚</p> 
</blockquote> 
<p>tensorRT_Pro ä¸­é¢„å¤„ç†çš„ä»£ç å¦‚ä¸‹ï¼š</p> 
<pre><code class="prism language-cpp">__global__ <span class="token keyword">void</span> <span class="token function">warp_affine_bilinear_and_normalize_plane_kernel</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span><span class="token operator">*</span> src<span class="token punctuation">,</span> <span class="token keyword">int</span> src_line_size<span class="token punctuation">,</span> <span class="token keyword">int</span> src_width<span class="token punctuation">,</span> <span class="token keyword">int</span> src_height<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">*</span> dst<span class="token punctuation">,</span> <span class="token keyword">int</span> dst_width<span class="token punctuation">,</span> <span class="token keyword">int</span> dst_height<span class="token punctuation">,</span> 
	<span class="token keyword">uint8_t</span> const_value_st<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">*</span> warp_affine_matrix_2_3<span class="token punctuation">,</span> Norm norm<span class="token punctuation">,</span> <span class="token keyword">int</span> edge<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

	<span class="token keyword">int</span> position <span class="token operator">=</span> blockDim<span class="token punctuation">.</span>x <span class="token operator">*</span> blockIdx<span class="token punctuation">.</span>x <span class="token operator">+</span> threadIdx<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>position <span class="token operator">&gt;=</span> edge<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

	<span class="token keyword">float</span> m_x1 <span class="token operator">=</span> warp_affine_matrix_2_3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> m_y1 <span class="token operator">=</span> warp_affine_matrix_2_3<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> m_z1 <span class="token operator">=</span> warp_affine_matrix_2_3<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> m_x2 <span class="token operator">=</span> warp_affine_matrix_2_3<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> m_y2 <span class="token operator">=</span> warp_affine_matrix_2_3<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> m_z2 <span class="token operator">=</span> warp_affine_matrix_2_3<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token keyword">int</span> dx      <span class="token operator">=</span> position <span class="token operator">%</span> dst_width<span class="token punctuation">;</span>
	<span class="token keyword">int</span> dy      <span class="token operator">=</span> position <span class="token operator">/</span> dst_width<span class="token punctuation">;</span>
	<span class="token keyword">float</span> src_x <span class="token operator">=</span> m_x1 <span class="token operator">*</span> dx <span class="token operator">+</span> m_y1 <span class="token operator">*</span> dy <span class="token operator">+</span> m_z1<span class="token punctuation">;</span>
	<span class="token keyword">float</span> src_y <span class="token operator">=</span> m_x2 <span class="token operator">*</span> dx <span class="token operator">+</span> m_y2 <span class="token operator">*</span> dy <span class="token operator">+</span> m_z2<span class="token punctuation">;</span>
	<span class="token keyword">float</span> c0<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">;</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span>src_x <span class="token operator">&lt;=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> src_x <span class="token operator">&gt;=</span> src_width <span class="token operator">||</span> src_y <span class="token operator">&lt;=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> src_y <span class="token operator">&gt;=</span> src_height<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token comment">// out of range</span>
		c0 <span class="token operator">=</span> const_value_st<span class="token punctuation">;</span>
		c1 <span class="token operator">=</span> const_value_st<span class="token punctuation">;</span>
		c2 <span class="token operator">=</span> const_value_st<span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
		<span class="token keyword">int</span> y_low <span class="token operator">=</span> <span class="token function">floorf</span><span class="token punctuation">(</span>src_y<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> x_low <span class="token operator">=</span> <span class="token function">floorf</span><span class="token punctuation">(</span>src_x<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> y_high <span class="token operator">=</span> y_low <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> x_high <span class="token operator">=</span> x_low <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

		<span class="token keyword">uint8_t</span> const_value<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>const_value_st<span class="token punctuation">,</span> const_value_st<span class="token punctuation">,</span> const_value_st<span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token keyword">float</span> ly    <span class="token operator">=</span> src_y <span class="token operator">-</span> y_low<span class="token punctuation">;</span>
		<span class="token keyword">float</span> lx    <span class="token operator">=</span> src_x <span class="token operator">-</span> x_low<span class="token punctuation">;</span>
		<span class="token keyword">float</span> hy    <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> ly<span class="token punctuation">;</span>
		<span class="token keyword">float</span> hx    <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> lx<span class="token punctuation">;</span>
		<span class="token keyword">float</span> w1    <span class="token operator">=</span> hy <span class="token operator">*</span> hx<span class="token punctuation">,</span> w2 <span class="token operator">=</span> hy <span class="token operator">*</span> lx<span class="token punctuation">,</span> w3 <span class="token operator">=</span> ly <span class="token operator">*</span> hx<span class="token punctuation">,</span> w4 <span class="token operator">=</span> ly <span class="token operator">*</span> lx<span class="token punctuation">;</span>
		<span class="token keyword">uint8_t</span><span class="token operator">*</span> v1 <span class="token operator">=</span> const_value<span class="token punctuation">;</span>
		<span class="token keyword">uint8_t</span><span class="token operator">*</span> v2 <span class="token operator">=</span> const_value<span class="token punctuation">;</span>
		<span class="token keyword">uint8_t</span><span class="token operator">*</span> v3 <span class="token operator">=</span> const_value<span class="token punctuation">;</span>
		<span class="token keyword">uint8_t</span><span class="token operator">*</span> v4 <span class="token operator">=</span> const_value<span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>y_low <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>x_low <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
				v1 <span class="token operator">=</span> src <span class="token operator">+</span> y_low <span class="token operator">*</span> src_line_size <span class="token operator">+</span> x_low <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span>x_high <span class="token operator">&lt;</span> src_width<span class="token punctuation">)</span>
				v2 <span class="token operator">=</span> src <span class="token operator">+</span> y_low <span class="token operator">*</span> src_line_size <span class="token operator">+</span> x_high <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
		<span class="token keyword">if</span><span class="token punctuation">(</span>y_high <span class="token operator">&lt;</span> src_height<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>x_low <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
				v3 <span class="token operator">=</span> src <span class="token operator">+</span> y_high <span class="token operator">*</span> src_line_size <span class="token operator">+</span> x_low <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span>x_high <span class="token operator">&lt;</span> src_width<span class="token punctuation">)</span>
				v4 <span class="token operator">=</span> src <span class="token operator">+</span> y_high <span class="token operator">*</span> src_line_size <span class="token operator">+</span> x_high <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
		<span class="token comment">// same to opencv</span>
		c0 <span class="token operator">=</span> <span class="token function">floorf</span><span class="token punctuation">(</span>w1 <span class="token operator">*</span> v1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> w2 <span class="token operator">*</span> v2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> w3 <span class="token operator">*</span> v3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> w4 <span class="token operator">*</span> v4<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0.5f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		c1 <span class="token operator">=</span> <span class="token function">floorf</span><span class="token punctuation">(</span>w1 <span class="token operator">*</span> v1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> w2 <span class="token operator">*</span> v2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> w3 <span class="token operator">*</span> v3<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> w4 <span class="token operator">*</span> v4<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0.5f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		c2 <span class="token operator">=</span> <span class="token function">floorf</span><span class="token punctuation">(</span>w1 <span class="token operator">*</span> v1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> w2 <span class="token operator">*</span> v2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> w3 <span class="token operator">*</span> v3<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> w4 <span class="token operator">*</span> v4<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0.5f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span>norm<span class="token punctuation">.</span>channel_type <span class="token operator">==</span> ChannelType<span class="token double-colon punctuation">::</span>Invert<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token keyword">float</span> t <span class="token operator">=</span> c2<span class="token punctuation">;</span>
		c2 <span class="token operator">=</span> c0<span class="token punctuation">;</span>  c0 <span class="token operator">=</span> t<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span>norm<span class="token punctuation">.</span>type <span class="token operator">==</span> NormType<span class="token double-colon punctuation">::</span>MeanStd<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		c0 <span class="token operator">=</span> <span class="token punctuation">(</span>c0 <span class="token operator">*</span> norm<span class="token punctuation">.</span>alpha <span class="token operator">-</span> norm<span class="token punctuation">.</span>mean<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> norm<span class="token punctuation">.</span>std<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		c1 <span class="token operator">=</span> <span class="token punctuation">(</span>c1 <span class="token operator">*</span> norm<span class="token punctuation">.</span>alpha <span class="token operator">-</span> norm<span class="token punctuation">.</span>mean<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> norm<span class="token punctuation">.</span>std<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		c2 <span class="token operator">=</span> <span class="token punctuation">(</span>c2 <span class="token operator">*</span> norm<span class="token punctuation">.</span>alpha <span class="token operator">-</span> norm<span class="token punctuation">.</span>mean<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> norm<span class="token punctuation">.</span>std<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>norm<span class="token punctuation">.</span>type <span class="token operator">==</span> NormType<span class="token double-colon punctuation">::</span>AlphaBeta<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		c0 <span class="token operator">=</span> c0 <span class="token operator">*</span> norm<span class="token punctuation">.</span>alpha <span class="token operator">+</span> norm<span class="token punctuation">.</span>beta<span class="token punctuation">;</span>
		c1 <span class="token operator">=</span> c1 <span class="token operator">*</span> norm<span class="token punctuation">.</span>alpha <span class="token operator">+</span> norm<span class="token punctuation">.</span>beta<span class="token punctuation">;</span>
		c2 <span class="token operator">=</span> c2 <span class="token operator">*</span> norm<span class="token punctuation">.</span>alpha <span class="token operator">+</span> norm<span class="token punctuation">.</span>beta<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">int</span> area <span class="token operator">=</span> dst_width <span class="token operator">*</span> dst_height<span class="token punctuation">;</span>
	<span class="token keyword">float</span><span class="token operator">*</span> pdst_c0 <span class="token operator">=</span> dst <span class="token operator">+</span> dy <span class="token operator">*</span> dst_width <span class="token operator">+</span> dx<span class="token punctuation">;</span>
	<span class="token keyword">float</span><span class="token operator">*</span> pdst_c1 <span class="token operator">=</span> pdst_c0 <span class="token operator">+</span> area<span class="token punctuation">;</span>
	<span class="token keyword">float</span><span class="token operator">*</span> pdst_c2 <span class="token operator">=</span> pdst_c1 <span class="token operator">+</span> area<span class="token punctuation">;</span>
	<span class="token operator">*</span>pdst_c0 <span class="token operator">=</span> c0<span class="token punctuation">;</span>
	<span class="token operator">*</span>pdst_c1 <span class="token operator">=</span> c1<span class="token punctuation">;</span>
	<span class="token operator">*</span>pdst_c2 <span class="token operator">=</span> c2<span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre> 
<p>å…³äºé¢„å¤„ç†éƒ¨åˆ†å…¶å®å°±æ˜¯è°ƒç”¨äº†ä¸Šè¿° CUDA æ ¸å‡½æ•°æ¥å®ç° warpAffineï¼Œç”±äºåœ¨ CUDA ä¸­æˆ‘ä»¬æ˜¯å¯¹æ¯ä¸ªåƒç´ è¿›è¡Œæ“ä½œï¼Œå› æ­¤éå¸¸å®¹æ˜“å®ç° BGR â†’ RGBï¼Œ/255.0 ç­‰æ“ä½œã€‚å…³äºä»£ç çš„å…·ä½“åˆ†æå¯ä»¥å‚è€ƒ <a href="https://blog.csdn.net/qq_40672115/article/details/127012332">YOLOv5æ¨ç†è¯¦è§£åŠé¢„å¤„ç†é«˜æ€§èƒ½å®ç°</a>ï¼Œè¿™è¾¹ä¸å†èµ˜è¿°ã€‚</p> 
<h4><a id="3_YOLOv8Seg_859"></a>3. YOLOv8-Segåå¤„ç†</h4> 
<blockquote> 
 <p>åœ¨ <a href="https://github.com/shouxieai/infer">infer</a> æ¡†æ¶ä¸­æœ‰å…³äº YOLOv8-Seg æ¨¡å‹çš„åå¤„ç†ï¼Œå› æ­¤æˆ‘ä»¬ç›´æ¥ copy è¿‡æ¥å³å¯ï¼Œå®ƒåŒ…æ‹¬æ£€æµ‹æ¡†çš„åå¤„ç†å’Œ mask çš„åå¤„ç†ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹æ£€æµ‹æ¡†çš„åå¤„ç†ï¼Œä»£ç å¯å‚è€ƒï¼š<a href="https://github.com/shouxieai/infer/blob/main/src/yolo.cu#L129">yolo.cu#L129</a></p> 
</blockquote> 
<p>å› æ­¤æˆ‘ä»¬ä¸éš¾å†™å‡º YOLOv8-Seg çš„æ£€æµ‹æ¡† decode è§£ç éƒ¨åˆ†çš„å®ç°ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> __global__ <span class="token keyword">void</span> <span class="token function">decode_kernel_v8_Seg</span><span class="token punctuation">(</span><span class="token keyword">float</span> <span class="token operator">*</span>predict<span class="token punctuation">,</span> <span class="token keyword">int</span> num_bboxes<span class="token punctuation">,</span> <span class="token keyword">int</span> num_classes<span class="token punctuation">,</span> <span class="token keyword">float</span> confidence_threshold<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">*</span> invert_affine_matrix<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">*</span> parray<span class="token punctuation">,</span> <span class="token keyword">int</span> MAX_IMAGE_BOXES<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    
    <span class="token keyword">int</span> position <span class="token operator">=</span> blockDim<span class="token punctuation">.</span>x <span class="token operator">*</span> blockIdx<span class="token punctuation">.</span>x <span class="token operator">+</span> threadIdx<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>position <span class="token operator">&gt;=</span> num_bboxes<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">float</span><span class="token operator">*</span> pitem            <span class="token operator">=</span> predict <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">+</span> num_classes <span class="token operator">+</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">*</span> position<span class="token punctuation">;</span>
    <span class="token keyword">float</span><span class="token operator">*</span> class_confidence <span class="token operator">=</span> pitem <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> confidence        <span class="token operator">=</span> <span class="token operator">*</span>class_confidence<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> label               <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_classes<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">,</span> <span class="token operator">++</span>class_confidence<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>class_confidence <span class="token operator">&gt;</span> confidence<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            confidence <span class="token operator">=</span> <span class="token operator">*</span>class_confidence<span class="token punctuation">;</span>
            label      <span class="token operator">=</span> i<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>confidence <span class="token operator">&lt;</span> confidence_threshold<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token function">atomicAdd</span><span class="token punctuation">(</span>parray<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>index <span class="token operator">&gt;=</span> MAX_IMAGE_BOXES<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">float</span> cx         <span class="token operator">=</span> <span class="token operator">*</span>pitem<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> cy         <span class="token operator">=</span> <span class="token operator">*</span>pitem<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> width      <span class="token operator">=</span> <span class="token operator">*</span>pitem<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> height     <span class="token operator">=</span> <span class="token operator">*</span>pitem<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> left   <span class="token operator">=</span> cx <span class="token operator">-</span> width  <span class="token operator">*</span> <span class="token number">0.5f</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> top    <span class="token operator">=</span> cy <span class="token operator">-</span> height <span class="token operator">*</span> <span class="token number">0.5f</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> right  <span class="token operator">=</span> cx <span class="token operator">+</span> width  <span class="token operator">*</span> <span class="token number">0.5f</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> bottom <span class="token operator">=</span> cy <span class="token operator">+</span> height <span class="token operator">*</span> <span class="token number">0.5f</span><span class="token punctuation">;</span>
    <span class="token function">affine_project</span><span class="token punctuation">(</span>invert_affine_matrix<span class="token punctuation">,</span> left<span class="token punctuation">,</span>  top<span class="token punctuation">,</span>    <span class="token operator">&amp;</span>left<span class="token punctuation">,</span>  <span class="token operator">&amp;</span>top<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">affine_project</span><span class="token punctuation">(</span>invert_affine_matrix<span class="token punctuation">,</span> right<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> <span class="token operator">&amp;</span>right<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bottom<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">float</span> <span class="token operator">*</span>pout_item <span class="token operator">=</span> parray <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> index <span class="token operator">*</span> NUM_BOX_ELEMENT<span class="token punctuation">;</span>
    <span class="token operator">*</span>pout_item<span class="token operator">++</span> <span class="token operator">=</span> left<span class="token punctuation">;</span>
    <span class="token operator">*</span>pout_item<span class="token operator">++</span> <span class="token operator">=</span> top<span class="token punctuation">;</span>
    <span class="token operator">*</span>pout_item<span class="token operator">++</span> <span class="token operator">=</span> right<span class="token punctuation">;</span>
    <span class="token operator">*</span>pout_item<span class="token operator">++</span> <span class="token operator">=</span> bottom<span class="token punctuation">;</span>
    <span class="token operator">*</span>pout_item<span class="token operator">++</span> <span class="token operator">=</span> confidence<span class="token punctuation">;</span>
    <span class="token operator">*</span>pout_item<span class="token operator">++</span> <span class="token operator">=</span> label<span class="token punctuation">;</span>
    <span class="token operator">*</span>pout_item<span class="token operator">++</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 1 = keep, 0 = ignore</span>
    <span class="token operator">*</span>pout_item<span class="token operator">++</span> <span class="token operator">=</span> position<span class="token punctuation">;</span>  <span class="token comment">// row_index</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>å…³äº decode çš„å…·ä½“å®ç°å…¶å®å°±æ˜¯å¯åŠ¨å¤šä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹å¤„ç†ä¸€ä¸ªæ¡†çš„è§£ç ï¼Œæˆ‘ä»¬ä¼šé€šè¿‡ä»¿å°„å˜æ¢çŸ©é˜µ IM å°†åæ ‡æ˜ å°„å›åŸå›¾ä¸Šï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬åœ¨ NUM_BOX_ELEMENT ä¸­æ–°å¢äº†ä¸€ä¸ª <strong>position</strong> çš„å…ƒç´ ï¼Œè¯¥å…ƒç´ åœ¨åç»­å¤„ç† mask æ—¶èƒ½å¤Ÿå‘Šè¯‰æˆ‘ä»¬æŸä¸ªæ£€æµ‹æ¡†çš„ mask æƒé‡ç³»æ•°åœ¨å†…å­˜ä¸­çš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯è¯´é€šè¿‡ <strong>position</strong> æˆ‘ä»¬å¯ä»¥å¾—åˆ°æ£€æµ‹æ¡†çš„ mask_weightsã€‚</p> 
<p>å…³äº decode ä»£ç çš„è¯¦ç»†åˆ†æå¯å‚è€ƒ <a href="https://blog.csdn.net/qq_40672115/article/details/129837469">inferæºç é˜…è¯»ä¹‹yolo.cu</a>ï¼Œè¿™è¾¹ä¸å†èµ˜è¿°ï¼Œå¦å¤–å…³äº NMS éƒ¨åˆ†çš„å®ç°æ— éœ€ä¿®æ”¹ï¼Œå…¶å…·ä½“å®ç°å¯ä»¥å‚è€ƒï¼š<a href="https://github.com/shouxieai/tensorRT_Pro/blob/main/src/application/app_yolo/yolo_decode.cu#L81">yolo_decode.cu#L81</a></p> 
<p>å…³äº mask éƒ¨åˆ†çš„åå¤„ç†æˆ‘ä»¬å¯ä»¥å‚è€ƒï¼š<a href="https://github.com/shouxieai/infer/blob/main/src/yolo.cu#L629">yolo.cu#L629</a></p> 
<p>å› æ­¤æˆ‘ä»¬ä¸éš¾å†™å‡º YOLOv8-Seg çš„åˆ†å‰² mask åå¤„ç†éƒ¨åˆ†çš„å®ç°ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p> 
<pre><code class="prism language-cpp">Box <span class="token function">result_object_box</span><span class="token punctuation">(</span>pbox<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pbox<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pbox<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pbox<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pbox<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pbox<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// process mask</span>
<span class="token comment">// reference: https://github.com/shouxieai/infer/blob/main/src/yolo.cu#L629</span>
<span class="token keyword">int</span> row_index <span class="token operator">=</span> pbox<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> mask_dim  <span class="token operator">=</span> mask_head_output<span class="token operator">-&gt;</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">float</span><span class="token operator">*</span> mask_weights      <span class="token operator">=</span> bbox_head_output<span class="token operator">-&gt;</span><span class="token generic-function"><span class="token function">gpu</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>ibatch<span class="token punctuation">)</span> <span class="token operator">+</span> row_index <span class="token operator">*</span> bbox_head_output<span class="token operator">-&gt;</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> num_classes <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token keyword">float</span><span class="token operator">*</span> mask_head_predict <span class="token operator">=</span> mask_head_output<span class="token operator">-&gt;</span><span class="token generic-function"><span class="token function">gpu</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>ibatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> right<span class="token punctuation">,</span> bottom<span class="token punctuation">;</span>
<span class="token keyword">float</span><span class="token operator">*</span> i2d <span class="token operator">=</span> job<span class="token punctuation">.</span>additional<span class="token punctuation">.</span>i2d<span class="token punctuation">;</span>
<span class="token function">affine_project</span><span class="token punctuation">(</span>i2d<span class="token punctuation">,</span> pbox<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pbox<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>left<span class="token punctuation">,</span>  <span class="token operator">&amp;</span>top<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">affine_project</span><span class="token punctuation">(</span>i2d<span class="token punctuation">,</span> pbox<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pbox<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>right<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bottom<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">float</span> box_width          <span class="token operator">=</span> right <span class="token operator">-</span> left<span class="token punctuation">;</span>
<span class="token keyword">float</span> box_height         <span class="token operator">=</span> bottom <span class="token operator">-</span> top<span class="token punctuation">;</span>
<span class="token keyword">float</span> scale_to_predict_x <span class="token operator">=</span> mask_head_output<span class="token operator">-&gt;</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>input_width_<span class="token punctuation">;</span>
<span class="token keyword">float</span> scale_to_predict_y <span class="token operator">=</span> mask_head_output<span class="token operator">-&gt;</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>input_height_<span class="token punctuation">;</span>
<span class="token keyword">int</span> mask_out_width       <span class="token operator">=</span> box_width  <span class="token operator">*</span> scale_to_predict_x <span class="token operator">+</span> <span class="token number">0.5f</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> mask_out_height      <span class="token operator">=</span> box_height <span class="token operator">*</span> scale_to_predict_y <span class="token operator">+</span> <span class="token number">0.5f</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span>mask_out_width <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> mask_out_height <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> bytes_of_mask_out <span class="token operator">=</span> mask_out_width <span class="token operator">*</span> mask_out_height<span class="token punctuation">;</span>
    box_mask_output_memory<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>bytes_of_mask_out<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to_gpu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    box_mask_output_memory<span class="token punctuation">.</span><span class="token function">to_gpu</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result_object_box<span class="token punctuation">.</span>seg <span class="token operator">=</span> <span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>InstanceSegmentMap<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>mask_out_width<span class="token punctuation">,</span> mask_out_height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> mask_out_device <span class="token operator">=</span> box_mask_output_memory<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">gpu</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> mask_out_host   <span class="token operator">=</span> result_object_box<span class="token punctuation">.</span>seg<span class="token operator">-&gt;</span>data<span class="token punctuation">;</span>

    <span class="token function">decode_single_mask</span><span class="token punctuation">(</span>left <span class="token operator">*</span> scale_to_predict_x<span class="token punctuation">,</span> top <span class="token operator">*</span> scale_to_predict_y<span class="token punctuation">,</span> mask_weights<span class="token punctuation">,</span>
                        mask_head_predict<span class="token punctuation">,</span> mask_head_output<span class="token operator">-&gt;</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mask_head_output<span class="token operator">-&gt;</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        mask_out_device<span class="token punctuation">,</span> mask_dim<span class="token punctuation">,</span> mask_out_width<span class="token punctuation">,</span> mask_out_height<span class="token punctuation">,</span> stream_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result_object_box<span class="token punctuation">.</span>seg<span class="token operator">-&gt;</span>left <span class="token operator">=</span> left <span class="token operator">*</span> scale_to_predict_x<span class="token punctuation">;</span>
    result_object_box<span class="token punctuation">.</span>seg<span class="token operator">-&gt;</span>top  <span class="token operator">=</span> top  <span class="token operator">*</span> scale_to_predict_y<span class="token punctuation">;</span>
    <span class="token function">checkCudaRuntime</span><span class="token punctuation">(</span><span class="token function">cudaMemcpyAsync</span><span class="token punctuation">(</span>mask_out_host<span class="token punctuation">,</span> mask_out_device<span class="token punctuation">,</span> box_mask_output_memory<span class="token punctuation">.</span><span class="token function">bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cudaMemcpyDeviceToHost<span class="token punctuation">,</span> stream_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    image_based_boxes<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>result_object_box<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>åœ¨ mask åå¤„ç†éƒ¨åˆ†æˆ‘ä»¬å…ˆè¦å°† box è¾¹ç•Œæ¡†ä»åŸå›¾ä¸Šæ˜ å°„åˆ° 640x640 çš„å›¾åƒä¸Šï¼Œå†ä» 640x640 çš„å›¾åƒä¸Šæ˜ å°„åˆ° 160x160 çš„ mask å›¾åƒä¸Šï¼Œç„¶åé€šè¿‡ <strong>row_index</strong> å³ <strong>position</strong> è·å– mask çš„æƒé‡ç³»æ•° mask_weightsï¼Œæ¥ç€å°†æƒé‡å’ŒåŸºç¡€ masks é€å…¥åˆ° <strong>decode_single_mask</strong> å‡½æ•°ç”Ÿæˆæœ€ç»ˆçš„ç‰©ä½“ maskã€‚</p> 
<p><strong>decode_single_mask</strong> å‡½æ•°æœ€ç»ˆä¼šè°ƒç”¨ CUDA æ ¸å‡½æ•°æ¥å¯¹åŸºç¡€ masks å’Œæƒé‡ç³»æ•°è¿›è¡Œç‚¹ç§¯è¿ç®—ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> __global__ <span class="token keyword">void</span> <span class="token function">decode_single_mask_kernel</span><span class="token punctuation">(</span><span class="token keyword">int</span> left<span class="token punctuation">,</span> <span class="token keyword">int</span> top<span class="token punctuation">,</span> <span class="token keyword">float</span> <span class="token operator">*</span>mask_weights<span class="token punctuation">,</span> <span class="token keyword">float</span> <span class="token operator">*</span>mask_predict<span class="token punctuation">,</span> <span class="token keyword">int</span> mask_width<span class="token punctuation">,</span> <span class="token keyword">int</span> mask_height<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>mask_out<span class="token punctuation">,</span> <span class="token keyword">int</span> mask_dim<span class="token punctuation">,</span> <span class="token keyword">int</span> out_width<span class="token punctuation">,</span> <span class="token keyword">int</span> out_height<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// mask_predict to mask_out</span>
    <span class="token comment">// mask_weights @ mask_predict</span>
    <span class="token keyword">int</span> dx <span class="token operator">=</span> blockDim<span class="token punctuation">.</span>x <span class="token operator">*</span> blockIdx<span class="token punctuation">.</span>x <span class="token operator">+</span> threadIdx<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    <span class="token keyword">int</span> dy <span class="token operator">=</span> blockDim<span class="token punctuation">.</span>y <span class="token operator">*</span> blockIdx<span class="token punctuation">.</span>y <span class="token operator">+</span> threadIdx<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dx <span class="token operator">&gt;=</span> out_width <span class="token operator">||</span> dy <span class="token operator">&gt;=</span> out_height<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> sx <span class="token operator">=</span> left <span class="token operator">+</span> dx<span class="token punctuation">;</span>
    <span class="token keyword">int</span> sy <span class="token operator">=</span> top <span class="token operator">+</span> dy<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sx <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> sx <span class="token operator">&gt;=</span> mask_width <span class="token operator">||</span> sy <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> sy <span class="token operator">&gt;=</span> mask_height<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mask_out<span class="token punctuation">[</span>dy <span class="token operator">*</span> out_width <span class="token operator">+</span> dx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">float</span> cumprod <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> ic <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ic <span class="token operator">&lt;</span> mask_dim<span class="token punctuation">;</span> <span class="token operator">++</span>ic<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">float</span> cval <span class="token operator">=</span> mask_predict<span class="token punctuation">[</span><span class="token punctuation">(</span>ic <span class="token operator">*</span> mask_height <span class="token operator">+</span> sy<span class="token punctuation">)</span> <span class="token operator">*</span> mask_width <span class="token operator">+</span> sx<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> wval <span class="token operator">=</span> mask_weights<span class="token punctuation">[</span>ic<span class="token punctuation">]</span><span class="token punctuation">;</span>
        cumprod <span class="token operator">+=</span> cval <span class="token operator">*</span> wval<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">float</span> alpha <span class="token operator">=</span> <span class="token number">1.0f</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1.0f</span> <span class="token operator">+</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token operator">-</span>cumprod<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// sigmoid</span>
    mask_out<span class="token punctuation">[</span>dy <span class="token operator">*</span> out_width <span class="token operator">+</span> dx<span class="token punctuation">]</span> <span class="token operator">=</span> alpha <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>å…³äº mask ç‚¹ç§¯è¿ç®—çš„å…·ä½“å®ç°å…¶å®å°±æ˜¯å¯åŠ¨å¤šä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹å¤„ç†ä¸€ä¸ªåƒç´ ï¼Œä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œåšä¸»ç»˜åˆ¶äº†ä¸€ä¸ªè‰å›¾ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p> 
<p><img src="https://images2.imgbox.com/4c/9b/VUYuOjyQ_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<p>åœ¨æ ¸å‡½æ•°ä¸­æˆ‘ä»¬å¯åŠ¨çš„çº¿ç¨‹æ•°ä¸º <strong>out_width * out_height</strong>ï¼Œæ¯ä¸ªçº¿ç¨‹å¤„ç†ç›®æ ‡æ¡†å†…çš„ä¸€ä¸ªåƒç´ ï¼Œå€¼å¾—æ³¨æ„æ˜¯ <strong>(sx, sy)</strong> æ˜¯ç›¸å¯¹äº mask_width, mask_height çš„ç´¢å¼•ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡ sx å’Œ sy å»è·å–åŸºç¡€ masks ä¸­å¯¹åº”çš„å€¼ cvalï¼Œæ¥ç€ä¸æƒé‡ç³»æ•°ä¸­çš„å€¼ wval ç›¸ä¹˜ï¼Œç„¶åç´¯åŠ ã€‚æœ€åæˆ‘ä»¬ä¼šä½¿ç”¨ sigmoid å‡½æ•°å°†ç´¯åŠ ç»“æœè½¬æ¢ä¸ºæ¦‚ç‡å€¼ï¼Œå¹¶å°†å…¶æ˜ å°„åˆ° 0~255 èŒƒå›´å†…ã€‚è€Œ <strong>(dx, dy)</strong> æ˜¯ç›¸å¯¹äº out_width, out_height çš„ç´¢å¼•ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡ dx å’Œ dy å°†æœ€ç»ˆçš„ mask åƒç´ å€¼å¡«å…¥åˆ°è¾“å‡ºçš„æŒ‡å®šä½ç½®ã€‚</p> 
<h4><a id="4_YOLOv8Seg_998"></a>4. YOLOv8-Segæ¨ç†</h4> 
<blockquote> 
 <p>é€šè¿‡ä¸Šé¢å¯¹ YOLOv8-Seg çš„é¢„å¤„ç†å’Œåå¤„ç†åˆ†æä¹‹åï¼Œæ•´ä¸ªæ¨ç†è¿‡ç¨‹å°±æ˜¾è€Œæ˜“è§äº†ã€‚C++ ä¸Š YOLOv8-Seg çš„é¢„å¤„ç†éƒ¨åˆ†å¯ç›´æ¥æ²¿ç”¨ YOLOv5 çš„é¢„å¤„ç†ï¼Œåå¤„ç†ä¸­çš„ decode è§£ç éœ€è¦ç®€å•ä¿®æ”¹ï¼Œå¦å¤–è¿˜éœ€è¦æ–°å¢å…³äº mask å¤„ç†ã€‚</p> 
</blockquote> 
<p>æˆ‘ä»¬åœ¨ç»ˆç«¯æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤å³å¯å®Œæˆæ¨ç†ï¼ˆ<strong>æ³¨æ„ï¼å®Œæ•´æµç¨‹åšä¸»ä¼šåœ¨åç»­å†…å®¹ä»‹ç»ï¼Œè¿™è¾¹åªæ˜¯ç®€å•æ¼”ç¤º</strong>ï¼‰</p> 
<pre><code class="prism language-shell"><span class="token function">make</span> yolo_seg
</code></pre> 
<p>ç¼–è¯‘å›¾è§£å¦‚ä¸‹æ‰€ç¤ºï¼š</p> 
<p><img src="https://images2.imgbox.com/26/fb/dkbsZL9p_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<p>æ¨ç†ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p> 
<p><img src="https://images2.imgbox.com/58/0a/AZfBFTKm_o.jpg" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬åœ¨ C++ ä¸Šé¢å®Œæˆäº† YOLOv8-Seg çš„æ•´ä¸ªæ¨ç†è¿‡ç¨‹ï¼Œä¸‹é¢æˆ‘ä»¬å°†å®Œæ•´çš„èµ°ä¸€éæµç¨‹ã€‚</p> 
<h3><a id="YOLOv8Seg_1020"></a>ä¸‰ã€YOLOv8-Segéƒ¨ç½²</h3> 
<blockquote> 
 <p>åšä¸»æ–°å»ºäº†ä¸€ä¸ªä»“åº“ <a href="https://github.com/Melody-Zhou/tensorRT_Pro-YOLOv8">tensorRT_Pro-YOLOv8</a>ï¼Œè¯¥ä»“åº“åŸºäº <a href="https://github.com/shouxieai/tensorRT_Pro">shouxieai/tensorRT_Pro</a>ï¼Œå¹¶è¿›è¡Œäº†è°ƒæ•´ä»¥æ”¯æŒ YOLOv8 çš„å„é¡¹ä»»åŠ¡ï¼Œç›®å‰å·²æ”¯æŒåˆ†ç±»ã€æ£€æµ‹ã€åˆ†å‰²ã€å§¿æ€ç‚¹ä¼°è®¡ä»»åŠ¡ã€‚</p> 
 <p>ä¸‹é¢æˆ‘ä»¬å°±æ¥å…·ä½“çœ‹çœ‹å¦‚ä½•åˆ©ç”¨ tensorRT_Pro-YOLOv8 è¿™ä¸ª repo å®Œæˆ YOLOv8-Seg çš„æ¨ç†ã€‚</p> 
</blockquote> 
<h4><a id="1__1026"></a>1. æºç ä¸‹è½½</h4> 
<p>tensorRT_Pro-YOLOv8 çš„ä»£ç å¯ä»¥ç›´æ¥ä» GitHub å®˜ç½‘ä¸Šä¸‹è½½ï¼Œæºç ä¸‹è½½åœ°å€æ˜¯ <a href="https://github.com/Melody-Zhou/tensorRT_Pro-YOLOv8">https://github.com/Melody-Zhou/tensorRT_Pro-YOLOv8</a>ï¼ŒLinux ä¸‹ä»£ç å…‹éš†æŒ‡ä»¤å¦‚ä¸‹ï¼š</p> 
<pre><code class="prism language-shell"><span class="token function">git</span> clone https://github.com/Melody-Zhou/tensorRT_Pro-YOLOv8.git
</code></pre> 
<p>ä¹Ÿå¯æ‰‹åŠ¨ç‚¹å‡»ä¸‹è½½ï¼Œç‚¹å‡»å³ä¸Šè§’çš„ <code>Code</code> æŒ‰é”®ï¼Œå°†ä»£ç ä¸‹è½½ä¸‹æ¥ã€‚è‡³æ­¤æ•´ä¸ªé¡¹ç›®å°±å·²ç»å‡†å¤‡å¥½äº†ã€‚ä¹Ÿå¯ä»¥ç‚¹å‡» <a href="https://pan.baidu.com/s/1yn8rdGVruCkhfHuVhTr8_w" rel="nofollow">here</a> ä¸‹è½½åšä¸»å‡†å¤‡å¥½çš„æºä»£ç ï¼ˆ<strong>æ³¨æ„ä»£ç ä¸‹è½½äº 2023/11/7 æ—¥ï¼Œè‹¥æœ‰æ”¹åŠ¨è¯·å‚è€ƒæœ€æ–°</strong>ï¼‰</p> 
<h4><a id="2__1036"></a>2. ç¯å¢ƒé…ç½®</h4> 
<blockquote> 
 <p>éœ€è¦ä½¿ç”¨çš„è½¯ä»¶ç¯å¢ƒæœ‰ <strong>TensorRTã€CUDAã€cuDNNã€OpenCVã€Protobuf</strong>ï¼Œæ‰€æœ‰è½¯ä»¶ç¯å¢ƒçš„å®‰è£…å¯ä»¥å‚è€ƒ <a href="https://blog.csdn.net/qq_40672115/article/details/130255299">Ubuntu20.04è½¯ä»¶å®‰è£…å¤§å…¨</a>ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ï¼Œéœ€è¦å„ä½çœ‹å®˜è‡ªè¡Œé…ç½®å¥½ç›¸å…³ç¯å¢ƒğŸ˜„ï¼Œå¤–ç½‘è®¿é—®è¾ƒæ…¢ï¼Œè¿™é‡Œæä¾›ä¸‹åšä¸»å®‰è£…è¿‡ç¨‹ä¸­çš„è½¯ä»¶å®‰è£…åŒ…ä¸‹è½½é“¾æ¥ <a href="https://pan.baidu.com/s/1XPe6xd6q1TLDMlVO-84KXA" rel="nofollow">Baidu Driveã€pwd:yoloã€‘</a>ğŸš€ğŸš€ğŸš€</p> 
 <p>tensorRT_Pro-YOLOv8 æä¾› CMakeLists.txt å’Œ Makefile ä¸¤ç§æ–¹å¼ç¼–è¯‘ï¼Œ<strong>äºŒè€…é€‰ä¸€å³å¯</strong></p> 
</blockquote> 
<h5><a id="21_CMakeListstxt_1042"></a>2.1 é…ç½®CMakeLists.txt</h5> 
<p>ä¸»è¦ä¿®æ”¹äº”å¤„</p> 
<p><strong>1.</strong> ä¿®æ”¹ç¬¬ 13 è¡Œï¼Œä¿®æ”¹ OpenCV è·¯å¾„</p> 
<pre><code class="prism language-cpp"><span class="token function">set</span><span class="token punctuation">(</span>OpenCV_DIR   <span class="token string">"/usr/local/include/opencv4"</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>2.</strong> ä¿®æ”¹ç¬¬ 15 è¡Œï¼Œä¿®æ”¹ CUDA è·¯å¾„</p> 
<pre><code class="prism language-cpp"><span class="token function">set</span><span class="token punctuation">(</span>CUDA_TOOLKIT_ROOT_DIR     <span class="token string">"/usr/local/cuda-11.6"</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>3.</strong> ä¿®æ”¹ç¬¬ 16 è¡Œï¼Œä¿®æ”¹ cuDNN è·¯å¾„</p> 
<pre><code class="prism language-cpp"><span class="token function">set</span><span class="token punctuation">(</span>CUDNN_DIR    <span class="token string">"/usr/local/cudnn8.4.0.27-cuda11.6"</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>4.</strong> ä¿®æ”¹ç¬¬ 17 è¡Œï¼Œä¿®æ”¹ tensorRT è·¯å¾„</p> 
<pre><code class="prism language-cpp"><span class="token function">set</span><span class="token punctuation">(</span>TENSORRT_DIR <span class="token string">"/opt/TensorRT-8.4.1.5"</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>5.</strong> ä¿®æ”¹ç¬¬ 20 è¡Œï¼Œä¿®æ”¹ protobuf è·¯å¾„</p> 
<pre><code class="prism language-cpp"><span class="token function">set</span><span class="token punctuation">(</span>PROTOBUF_DIR <span class="token string">"/home/jarvis/protobuf"</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="22_Makefile_1076"></a>2.2 é…ç½®Makefile</h5> 
<p>ä¸»è¦ä¿®æ”¹äº”å¤„</p> 
<p><strong>1.</strong> ä¿®æ”¹ç¬¬ 4 è¡Œï¼Œä¿®æ”¹ protobuf è·¯å¾„</p> 
<pre><code class="prism language-cpp">lean_protobuf  <span class="token operator">:</span><span class="token operator">=</span> <span class="token operator">/</span>home<span class="token operator">/</span>jarvis<span class="token operator">/</span>protobuf
</code></pre> 
<p><strong>2.</strong> ä¿®æ”¹ç¬¬ 5 è¡Œï¼Œä¿®æ”¹ tensorRT è·¯å¾„</p> 
<pre><code class="prism language-cpp">lean_tensor_rt <span class="token operator">:</span><span class="token operator">=</span> <span class="token operator">/</span>opt<span class="token operator">/</span>TensorRT<span class="token operator">-</span><span class="token number">8.4</span><span class="token punctuation">.</span><span class="token number">1.5</span>
</code></pre> 
<p><strong>3.</strong> ä¿®æ”¹ç¬¬ 6 è¡Œï¼Œä¿®æ”¹ cuDNN è·¯å¾„</p> 
<pre><code class="prism language-cpp">lean_cudnn     <span class="token operator">:</span><span class="token operator">=</span> <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>cudnn8<span class="token punctuation">.</span><span class="token number">4.0</span><span class="token punctuation">.</span><span class="token number">27</span><span class="token operator">-</span>cuda11<span class="token punctuation">.</span><span class="token number">6</span>
</code></pre> 
<p><strong>4.</strong> ä¿®æ”¹ç¬¬ 7 è¡Œï¼Œä¿®æ”¹ OpenCV è·¯å¾„</p> 
<pre><code class="prism language-cpp">lean_opencv    <span class="token operator">:</span><span class="token operator">=</span> <span class="token operator">/</span>usr<span class="token operator">/</span>local
</code></pre> 
<p><strong>5.</strong> ä¿®æ”¹ç¬¬ 8 è¡Œï¼Œä¿®æ”¹ CUDA è·¯å¾„</p> 
<pre><code class="prism language-cpp">lean_cuda      <span class="token operator">:</span><span class="token operator">=</span> <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>cuda<span class="token operator">-</span><span class="token number">11.6</span>
</code></pre> 
<h4><a id="3_ONNX_1110"></a>3. ONNXå¯¼å‡º</h4> 
<p>å¯¼å‡ºç»†èŠ‚å¯ä»¥æŸ¥çœ‹ä¹‹å‰çš„å†…å®¹ï¼Œè¿™è¾¹ä¸å†èµ˜è¿°ã€‚è®°å¾—å°†å¯¼å‡ºçš„ ONNX æ¨¡å‹æ”¾åœ¨ tensorRT_Pro-YOLOv8/workspace æ–‡ä»¶å¤¹ä¸‹ã€‚</p> 
<h4><a id="4__1114"></a>4. æºç ä¿®æ”¹</h4> 
<blockquote> 
 <p>å¦‚æœä½ æƒ³æ¨ç†è‡ªå·±è®­ç»ƒçš„æ¨¡å‹è¿˜éœ€è¦ä¿®æ”¹ä¸‹æºä»£ç ï¼ŒYOLOv8-Seg æ¨¡å‹çš„æ¨ç†ä»£ç ä¸»è¦åœ¨ <strong>app_yolo_seg.cpp</strong> æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å°±åªéœ€è¦ä¿®æ”¹è¿™ä¸€ä¸ªæ–‡ä»¶ä¸­çš„å†…å®¹å³å¯ï¼Œæºç ä¿®æ”¹è¾ƒç®€å•ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š</p> 
</blockquote> 
<ul><li><strong>1.</strong> <strong>app_yolo_seg.cpp 329è¡Œï¼Œâ€œyolov8s-segâ€ ä¿®æ”¹ä¸ºä½ å¯¼å‡ºçš„ ONNX æ¨¡å‹å</strong></li><li><strong>2.</strong> <strong>app_yolo_seg.cpp 10è¡Œï¼Œå°† cocolabels æ•°ç»„ä¸­çš„ç±»åˆ«åç§°ä¿®æ”¹ä¸ºä½ è®­ç»ƒçš„ç±»åˆ«</strong></li></ul> 
<p>å…·ä½“ä¿®æ”¹ç¤ºä¾‹å¦‚ä¸‹ï¼š</p> 
<pre><code class="prism language-cpp"><span class="token function">test</span><span class="token punctuation">(</span>TRT<span class="token double-colon punctuation">::</span>Model<span class="token double-colon punctuation">::</span>FP32<span class="token punctuation">,</span> <span class="token string">"best"</span><span class="token punctuation">)</span>	<span class="token comment">// ä¿®æ”¹1 329è¡Œ"yolov8s-seg"æ”¹æˆ"best"</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>cocolabels<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"have_mask"</span><span class="token punctuation">,</span> <span class="token string">"no_mask"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>	<span class="token comment">// ä¿®æ”¹2 10è¡Œä¿®æ”¹æ£€æµ‹ç±»åˆ«ï¼Œä¸ºè‡ªè®­ç»ƒæ¨¡å‹çš„ç±»åˆ«åç§°</span>
</code></pre> 
<p>OKï¼æºç ä¿®æ”¹å¥½äº†ï¼ŒMakefile ç¼–è¯‘æ–‡ä»¶ä¹Ÿæå®šäº†ï¼ŒONNX æ¨¡å‹ä¹Ÿå‡†å¤‡å¥½äº†ï¼Œç°åœ¨å¯ä»¥ç¼–è¯‘è¿è¡Œäº†ï¼Œç›´æ¥åœ¨ç»ˆç«¯æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤å³å¯ï¼š</p> 
<pre><code class="prism language-shell"><span class="token function">make</span> yolo_seg
</code></pre> 
<p>ç¼–è¯‘è¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p> 
<p><img src="https://images2.imgbox.com/da/ed/xQ02KPhf_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<p>ç¼–è¯‘è¿è¡ŒæˆåŠŸååœ¨ workspace æ–‡ä»¶å¤¹ä¸‹ä¼šç”Ÿæˆ engine æ–‡ä»¶ <strong>yolov8s-seg.FP32.trtmodel</strong> ç”¨äºæ¨¡å‹æ¨ç†ï¼ŒåŒæ—¶å®ƒè¿˜ä¼šç”Ÿæˆ <strong>yolov8s-seg_YoloV8-Seg_FP32_result</strong> æ–‡ä»¶å¤¹ï¼Œè¯¥æ–‡ä»¶å¤¹ä¸‹ä¿å­˜äº†æ¨ç†çš„å›¾ç‰‡ã€‚</p> 
<p>æ¨¡å‹æ¨ç†æ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p> 
<p><img src="https://images2.imgbox.com/b7/e7/e7uKbtkt_o.jpg" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<p>OKï¼ä»¥ä¸Šå°±æ˜¯ä½¿ç”¨ tensorRT_Pro-YOLOv8 æ¨ç† YOLOv8-Seg çš„å¤§è‡´æµç¨‹ï¼Œè‹¥æœ‰é—®é¢˜ï¼Œæ¬¢è¿å„ä½çœ‹å®˜æ‰¹è¯„æŒ‡æ­£ã€‚</p> 
<h3><a id="_1149"></a>ç»“è¯­</h3> 
<blockquote> 
 <p>åšä¸»åœ¨è¿™é‡Œé’ˆå¯¹ YOLOv8-Seg çš„é¢„å¤„ç†å’Œåå¤„ç†åšäº†ç®€å•åˆ†æï¼ŒåŒæ—¶ä¸å¤§å®¶åˆ†äº«äº† C++ ä¸Šçš„å®ç°æµç¨‹ï¼Œç›®çš„æ˜¯å¸®å¤§å®¶ç†æ¸…æ€è·¯ï¼Œæ›´å¥½çš„å®Œæˆåç»­çš„éƒ¨ç½²å·¥ä½œğŸ˜„ã€‚æ„Ÿè°¢å„ä½çœ‹åˆ°æœ€åï¼Œåˆ›ä½œä¸æ˜“ï¼Œè¯»åæœ‰æ”¶è·çš„çœ‹å®˜è¯·å¸®å¿™ç‚¹ä¸ªğŸ‘â­ï¸</p> 
 <p>æœ€åå¤§å®¶å¦‚æœè§‰å¾— <a href="https://github.com/Melody-Zhou/tensorRT_Pro-YOLOv8">tensorRT_Pro-YOLOv8</a> è¿™ä¸ª repo å¯¹ä½ æœ‰å¸®åŠ©çš„è¯ï¼Œä¸å¦¨ç‚¹ä¸ª â­ï¸ æ”¯æŒä¸€æ³¢ï¼Œè¿™å¯¹åšä¸»æ¥è¯´éå¸¸é‡è¦ï¼Œæ„Ÿè°¢å„ä½ğŸ™ã€‚</p> 
</blockquote> 
<h3><a id="_1155"></a>ä¸‹è½½é“¾æ¥</h3> 
<ul><li><a href="https://pan.baidu.com/s/1XPe6xd6q1TLDMlVO-84KXA" rel="nofollow">è½¯ä»¶å®‰è£…åŒ…ä¸‹è½½é“¾æ¥ã€æå–ç :yoloã€‘</a>ğŸš€ğŸš€ğŸš€</li><li><a href="https://pan.baidu.com/s/1yn8rdGVruCkhfHuVhTr8_w" rel="nofollow">æºä»£ç ã€æƒé‡ä¸‹è½½é“¾æ¥ã€æå–ç :yoloã€‘</a></li></ul> 
<h3><a id="_1160"></a>å‚è€ƒ</h3> 
<ul><li><a href="https://github.com/shouxieai/infer">https://github.com/shouxieai/infer</a></li><li><a href="https://github.com/ultralytics/ultralytics">https://github.com/ultralytics/ultralytics</a></li><li><a href="https://github.com/shouxieai/tensorRT_Pro">https://github.com/shouxieai/tensorRT_Pro</a></li><li><a href="https://github.com/Melody-Zhou/tensorRT_Pro-YOLOv8">https://github.com/Melody-Zhou/tensorRT_Pro-YOLOv8</a></li><li><a href="https://blog.csdn.net/qq_40672115/article/details/127012332">YOLOv5æ¨ç†è¯¦è§£åŠé¢„å¤„ç†é«˜æ€§èƒ½å®ç°</a></li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3dd5ed570133e85a01a326aef49a3b17/" rel="prev">
			<span class="pager__subtitle">Â«&thinsp;Previous</span>
			<p class="pager__title">MapStructå¤åˆ¶å¤±è´¥ï¼Œå±æ€§ä¸ºnullï¼Œä¸lombokæœ‰å…³ç³»</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f63590dfdb4577508f944d77550f9e16/" rel="next">
			<span class="pager__subtitle">Next&thinsp;Â»</span>
			<p class="pager__title">ã€Helm åŠ Chart å¿«é€Ÿå…¥é—¨ã€‘03ã€Chart åŸºæœ¬ä»‹ç»</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 ç¼–ç¨‹å¤§ç™½çš„åšå®¢.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>