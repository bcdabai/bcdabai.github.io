<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>YOLOv8-Seg推理详解及部署实现 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="YOLOv8-Seg推理详解及部署实现" />
<meta property="og:description" content="目录 注意事项一、2024/1/10更新前言一、YOLOv8-Seg推理(Python)1. YOLOv8-Seg预测2. YOLOv8-Seg预处理3. YOLOv8-Seg后处理4. YOLOv8-Seg推理 二、YOLOv8-Seg推理(C&#43;&#43;)1. ONNX导出2. YOLOv8-Seg预处理3. YOLOv8-Seg后处理4. YOLOv8-Seg推理 三、YOLOv8-Seg部署1. 源码下载2. 环境配置2.1 配置CMakeLists.txt2.2 配置Makefile 3. ONNX导出4. 源码修改 结语下载链接参考 注意事项 一、2024/1/10更新 修改第 4 部分 YOLOv8-Seg 推理中后处理 iou 计算代码，原代码存在问题，原代码如下：
def iou(box1, box2): def area_box(box): return (box[2] - box[0]) * (box[3] - box[1]) left, top = max(box1[:2], box2[:2]) right, bottom = min(box1[2:4], box2[2:4]) ... 其中，box1 和 box2 是表示边界框的列表，格式为 [left, top, right, bottom, …]。在 Python 中，当 max 函数用于两个列表时，它会比较列表中的元素，从左到右，直到找到某一个列表中的较大元素，然后返回那个较大元素的完整列表。比如现在比较 max([3,0],[2,1])，因为 3 大于 2，而不考虑后面的元素，返回的就是 [3,0]。这意味着在计算交集区域的左上角坐标时，仅比较了 left 坐标，而没有正确地处理 top 坐标，同理右下角坐标也存在类似的问题" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/f6fde0a97d9cd657f9df0baebdbb485e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-10T15:09:59+08:00" />
<meta property="article:modified_time" content="2024-01-10T15:09:59+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">YOLOv8-Seg推理详解及部署实现</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><ul><li><a href="#_2" rel="nofollow">注意事项</a></li><li><a href="#2024110_4" rel="nofollow">一、2024/1/10更新</a></li><li><a href="#_37" rel="nofollow">前言</a></li><li><a href="#YOLOv8SegPython_45" rel="nofollow">一、YOLOv8-Seg推理(Python)</a></li><li><ul><li><a href="#1_YOLOv8Seg_47" rel="nofollow">1. YOLOv8-Seg预测</a></li><li><a href="#2_YOLOv8Seg_149" rel="nofollow">2. YOLOv8-Seg预处理</a></li><li><a href="#3_YOLOv8Seg_233" rel="nofollow">3. YOLOv8-Seg后处理</a></li><li><a href="#4_YOLOv8Seg_438" rel="nofollow">4. YOLOv8-Seg推理</a></li></ul> 
   </li><li><a href="#YOLOv8SegC_673" rel="nofollow">二、YOLOv8-Seg推理(C++)</a></li><li><ul><li><a href="#1_ONNX_677" rel="nofollow">1. ONNX导出</a></li><li><a href="#2_YOLOv8Seg_763" rel="nofollow">2. YOLOv8-Seg预处理</a></li><li><a href="#3_YOLOv8Seg_859" rel="nofollow">3. YOLOv8-Seg后处理</a></li><li><a href="#4_YOLOv8Seg_998" rel="nofollow">4. YOLOv8-Seg推理</a></li></ul> 
   </li><li><a href="#YOLOv8Seg_1020" rel="nofollow">三、YOLOv8-Seg部署</a></li><li><ul><li><a href="#1__1026" rel="nofollow">1. 源码下载</a></li><li><a href="#2__1036" rel="nofollow">2. 环境配置</a></li><li><ul><li><a href="#21_CMakeListstxt_1042" rel="nofollow">2.1 配置CMakeLists.txt</a></li><li><a href="#22_Makefile_1076" rel="nofollow">2.2 配置Makefile</a></li></ul> 
    </li><li><a href="#3_ONNX_1110" rel="nofollow">3. ONNX导出</a></li><li><a href="#4__1114" rel="nofollow">4. 源码修改</a></li></ul> 
   </li><li><a href="#_1149" rel="nofollow">结语</a></li><li><a href="#_1155" rel="nofollow">下载链接</a></li><li><a href="#_1160" rel="nofollow">参考</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="_2"></a>注意事项</h3> 
<h3><a id="2024110_4"></a>一、2024/1/10更新</h3> 
<p><strong>修改第 4 部分 YOLOv8-Seg 推理中后处理 iou 计算代码</strong>，原代码存在问题，原代码如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">iou</span><span class="token punctuation">(</span>box1<span class="token punctuation">,</span> box2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">area_box</span><span class="token punctuation">(</span>box<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    left<span class="token punctuation">,</span> top <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    right<span class="token punctuation">,</span> bottom <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p>其中，<strong>box1</strong> 和 <strong>box2</strong> 是表示边界框的列表，格式为 <strong>[left, top, right, bottom, …]</strong>。在 Python 中，当 <strong>max</strong> 函数用于两个列表时，它会比较列表中的元素，从左到右，直到找到某一个列表中的较大元素，<strong>然后返回那个较大元素的完整列表</strong>。比如现在比较 <strong>max([3,0],[2,1])</strong>，因为 3 大于 2，而不考虑后面的元素，返回的就是 <strong>[3,0]</strong>。这意味着在计算交集区域的左上角坐标时，仅比较了 <strong>left</strong> 坐标，而没有正确地处理 <strong>top</strong> 坐标，同理右下角坐标也存在类似的问题</p> 
<p>因此，修改后的代码如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">iou</span><span class="token punctuation">(</span>box1<span class="token punctuation">,</span> box2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">area_box</span><span class="token punctuation">(</span>box<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment"># box -&gt; [x1,y1,x2,y2,...]</span>
    left   <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    top    <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    right  <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    bottom <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p>感谢 @<a href="https://blog.csdn.net/weixin_45679938">你的陈某某</a> 的指正🤗</p> 
<h3><a id="_37"></a>前言</h3> 
<blockquote> 
 <p>梳理下 YOLOv8-Seg 的预处理和后处理流程，顺便让 tensorRT_Pro 支持 YOLOv8-Seg</p> 
 <p>参考：<a href="https://github.com/shouxieai/tensorRT_Pro">https://github.com/shouxieai/tensorRT_Pro</a></p> 
 <p>实现：<a href="https://github.com/Melody-Zhou/tensorRT_Pro-YOLOv8">https://github.com/Melody-Zhou/tensorRT_Pro-YOLOv8</a></p> 
</blockquote> 
<h3><a id="YOLOv8SegPython_45"></a>一、YOLOv8-Seg推理(Python)</h3> 
<h4><a id="1_YOLOv8Seg_47"></a>1. YOLOv8-Seg预测</h4> 
<blockquote> 
 <p>我们先尝试利用官方预训练权重来推理一张图片并保存，看能否成功</p> 
</blockquote> 
<p>在 YOLOv8 主目录下新建 <strong>predict-seg.py</strong> 预测文件，其内容如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> cv2
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> ultralytics <span class="token keyword">import</span> YOLO

<span class="token keyword">def</span> <span class="token function">hsv2bgr</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> s<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">:</span>
    h_i <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>h <span class="token operator">*</span> <span class="token number">6</span><span class="token punctuation">)</span>
    f <span class="token operator">=</span> h <span class="token operator">*</span> <span class="token number">6</span> <span class="token operator">-</span> h_i
    p <span class="token operator">=</span> v <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> s<span class="token punctuation">)</span>
    q <span class="token operator">=</span> v <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> f <span class="token operator">*</span> s<span class="token punctuation">)</span>
    t <span class="token operator">=</span> v <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> f<span class="token punctuation">)</span> <span class="token operator">*</span> s<span class="token punctuation">)</span>
    
    r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>

    <span class="token keyword">if</span> h_i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> v<span class="token punctuation">,</span> t<span class="token punctuation">,</span> p
    <span class="token keyword">elif</span> h_i <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> q<span class="token punctuation">,</span> v<span class="token punctuation">,</span> p
    <span class="token keyword">elif</span> h_i <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> p<span class="token punctuation">,</span> v<span class="token punctuation">,</span> t
    <span class="token keyword">elif</span> h_i <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> p<span class="token punctuation">,</span> q<span class="token punctuation">,</span> v
    <span class="token keyword">elif</span> h_i <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> t<span class="token punctuation">,</span> p<span class="token punctuation">,</span> v
    <span class="token keyword">elif</span> h_i <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> v<span class="token punctuation">,</span> p<span class="token punctuation">,</span> q

    <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">(</span>b <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>g <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>r <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">random_color</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    h_plane <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">id</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">0x937151</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">100.0</span>
    s_plane <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">id</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">0x315793</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">100.0</span>
    <span class="token keyword">return</span> hsv2bgr<span class="token punctuation">(</span>h_plane<span class="token punctuation">,</span> s_plane<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    
    model <span class="token operator">=</span> YOLO<span class="token punctuation">(</span><span class="token string">"yolov8s-seg.pt"</span><span class="token punctuation">)</span>

    img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">"ultralytics/assets/bus.jpg"</span><span class="token punctuation">)</span>
    result <span class="token operator">=</span> model<span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    names <span class="token operator">=</span> result<span class="token punctuation">.</span>names
    boxes <span class="token operator">=</span> result<span class="token punctuation">.</span>boxes<span class="token punctuation">.</span>data<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>
    masks <span class="token operator">=</span> result<span class="token punctuation">.</span>masks

    h<span class="token punctuation">,</span> w <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>

    <span class="token keyword">for</span> i<span class="token punctuation">,</span> mask <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>masks<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
        
        mask <span class="token operator">=</span> mask<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
        mask_resized <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>mask<span class="token punctuation">,</span> <span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">)</span>

        label <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>boxes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        color <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>random_color<span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token punctuation">)</span>

        colored_mask <span class="token operator">=</span> <span class="token punctuation">(</span>np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> w<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> color<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
        masked_colored_mask <span class="token operator">=</span> cv2<span class="token punctuation">.</span>bitwise_and<span class="token punctuation">(</span>colored_mask<span class="token punctuation">,</span> colored_mask<span class="token punctuation">,</span> mask<span class="token operator">=</span>mask_resized<span class="token punctuation">)</span>

        mask_indices <span class="token operator">=</span> mask_resized <span class="token operator">==</span> <span class="token number">1</span>
        img<span class="token punctuation">[</span>mask_indices<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>img<span class="token punctuation">[</span>mask_indices<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">0.6</span> <span class="token operator">+</span> masked_colored_mask<span class="token punctuation">[</span>mask_indices<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>

    <span class="token comment"># for i, points in enumerate(masks.xy):</span>
    <span class="token comment">#     label = int(boxes[i][5])</span>
    <span class="token comment">#     color = random_color(label)</span>
    <span class="token comment">#     points = np.array(points, np.int32)</span>
    <span class="token comment">#     cv2.drawContours(img, [points], -1, color, 2)</span>

    <span class="token keyword">for</span> obj <span class="token keyword">in</span> boxes<span class="token punctuation">:</span>
        left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> right<span class="token punctuation">,</span> bottom <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        confidence <span class="token operator">=</span> obj<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>
        label <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        color <span class="token operator">=</span> random_color<span class="token punctuation">(</span>label<span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span>left<span class="token punctuation">,</span> top<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>right<span class="token punctuation">,</span> bottom<span class="token punctuation">)</span><span class="token punctuation">,</span> color <span class="token operator">=</span> color <span class="token punctuation">,</span>thickness<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> lineType<span class="token operator">=</span>cv2<span class="token punctuation">.</span>LINE_AA<span class="token punctuation">)</span>
        caption <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>names<span class="token punctuation">[</span>label<span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>confidence<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
        w<span class="token punctuation">,</span> h <span class="token operator">=</span> cv2<span class="token punctuation">.</span>getTextSize<span class="token punctuation">(</span>caption<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span>left <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">,</span> top <span class="token operator">-</span> <span class="token number">33</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>left <span class="token operator">+</span> w <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">,</span> top<span class="token punctuation">)</span><span class="token punctuation">,</span> color<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>img<span class="token punctuation">,</span> caption<span class="token punctuation">,</span> <span class="token punctuation">(</span>left<span class="token punctuation">,</span> top <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>

    cv2<span class="token punctuation">.</span>imwrite<span class="token punctuation">(</span><span class="token string">"predict-seg.jpg"</span><span class="token punctuation">,</span> img<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"save done"</span><span class="token punctuation">)</span>
</code></pre> 
<p>在上述代码中我们通过 opencv 读取了一张图像，并送入模型中推理得到输出 results，results 中保存着不同任务的结果，我们这里是分割任务，因此只需要拿到对应的 boxes 和 masks 即可。</p> 
<p>拿到 boxes 后我们就可以将对应的框和置信度绘制在图像上，拿到 masks 后我们就可以将对应的 mask 绘制在图像上并保存。</p> 
<p>关于 boxes 可视化的代码实现参考自 tensorRT_Pro 中的实现，可以参考：<a href="https://github.com/shouxieai/tensorRT_Pro/blob/main/src/application/app_yolo.cpp#L95">app_yolo.cpp#L95</a></p> 
<p>关于 masks 可视化的代码实现参考自 ultralytics/utils/plotting.py 中的实现，具体实现代码来源于 <strong>chatGPT</strong>，可以参考：<a href="https://github.com/ultralytics/ultralytics/blob/main/ultralytics/utils/plotting.py#L468">plotting.py#L468</a></p> 
<p>关于随机颜色的代码实现参考自 tensorRT_Pro 中的实现，可以参考：<a href="https://github.com/shouxieai/tensorRT_Pro/blob/main/src/tensorRT/common/ilogger.cpp#L90">ilogger.cpp#L90</a></p> 
<p>模型推理保存的结果图像如下所示：</p> 
<p><img src="https://images2.imgbox.com/74/6d/OQWFUyDl_o.jpg" alt="在这里插入图片描述"></p> 
<h4><a id="2_YOLOv8Seg_149"></a>2. YOLOv8-Seg预处理</h4> 
<blockquote> 
 <p>模型预测成功后我们就需要自己动手来写下 YOLOv8-Seg 的预处理和后处理，方便后续在 C++ 上的实现，我们先来看看预处理的实现</p> 
</blockquote> 
<p>经过我们的调试分析可知 YOLOv8-Seg 的预处理过程在 <strong>ultralytics/engine/predictor.py</strong> 文件中，可以参考：<a href="https://github.com/ultralytics/ultralytics/blob/main/ultralytics/engine/predictor.py#L111">predictor.py#L111</a></p> 
<p>代码如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">preprocess</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> im<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Prepares input image before inference.

    Args:
        im (torch.Tensor | List(np.ndarray)): BCHW for tensor, [(HWC) x B] for list.
    """</span>
    not_tensor <span class="token operator">=</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>im<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">)</span>
    <span class="token keyword">if</span> not_tensor<span class="token punctuation">:</span>
        im <span class="token operator">=</span> np<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pre_transform<span class="token punctuation">(</span>im<span class="token punctuation">)</span><span class="token punctuation">)</span>
        im <span class="token operator">=</span> im<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># BGR to RGB, BHWC to BCHW, (n, 3, h, w)</span>
        im <span class="token operator">=</span> np<span class="token punctuation">.</span>ascontiguousarray<span class="token punctuation">(</span>im<span class="token punctuation">)</span>  <span class="token comment"># contiguous</span>
        im <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>im<span class="token punctuation">)</span>

    im <span class="token operator">=</span> im<span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
    im <span class="token operator">=</span> im<span class="token punctuation">.</span>half<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>fp16 <span class="token keyword">else</span> im<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># uint8 to fp16/32</span>
    <span class="token keyword">if</span> not_tensor<span class="token punctuation">:</span>
        im <span class="token operator">/=</span> <span class="token number">255</span>  <span class="token comment"># 0 - 255 to 0.0 - 1.0</span>
    <span class="token keyword">return</span> im
</code></pre> 
<p>它包含以下步骤：</p> 
<ul><li><strong>self.pre_transform</strong>：即 letterbox 添加灰条</li><li><strong>im[…,::-1]</strong>：BGR → RGB</li><li><strong>transpose((0, 3, 1, 2))</strong>：添加 batch 维度，HWC → CHW</li><li><strong>torch.from_numpy</strong>：to Tensor</li><li><strong>im /= 255</strong>：除以 255，归一化</li></ul> 
<p>大家如果对 YOLOv5 的预处理熟悉的话，会发现 YOLOv8-Seg 的预处理和 YOLOv5 的预处理一模一样，因此我们不难写出对应的预处理代码，如下所示：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">preprocess_warpAffine</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> dst_width<span class="token operator">=</span><span class="token number">640</span><span class="token punctuation">,</span> dst_height<span class="token operator">=</span><span class="token number">640</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    scale <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dst_width <span class="token operator">/</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dst_height <span class="token operator">/</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    ox <span class="token operator">=</span> <span class="token punctuation">(</span>dst_width  <span class="token operator">-</span> scale <span class="token operator">*</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
    oy <span class="token operator">=</span> <span class="token punctuation">(</span>dst_height <span class="token operator">-</span> scale <span class="token operator">*</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
    M <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token punctuation">[</span>scale<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ox<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> scale<span class="token punctuation">,</span> oy<span class="token punctuation">]</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
    
    img_pre <span class="token operator">=</span> cv2<span class="token punctuation">.</span>warpAffine<span class="token punctuation">(</span>image<span class="token punctuation">,</span> M<span class="token punctuation">,</span> <span class="token punctuation">(</span>dst_width<span class="token punctuation">,</span> dst_height<span class="token punctuation">)</span><span class="token punctuation">,</span> flags<span class="token operator">=</span>cv2<span class="token punctuation">.</span>INTER_LINEAR<span class="token punctuation">,</span>
                             borderMode<span class="token operator">=</span>cv2<span class="token punctuation">.</span>BORDER_CONSTANT<span class="token punctuation">,</span> borderValue<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">114</span><span class="token punctuation">,</span> <span class="token number">114</span><span class="token punctuation">,</span> <span class="token number">114</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    IM <span class="token operator">=</span> cv2<span class="token punctuation">.</span>invertAffineTransform<span class="token punctuation">(</span>M<span class="token punctuation">)</span>

    img_pre <span class="token operator">=</span> <span class="token punctuation">(</span>img_pre<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">255.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
    img_pre <span class="token operator">=</span> img_pre<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span>
    img_pre <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>img_pre<span class="token punctuation">)</span>
    <span class="token keyword">return</span> img_pre<span class="token punctuation">,</span> IM
</code></pre> 
<p>其中的 letterbox 添加灰条步骤我们可以通过仿射变换 warpAffine 实现，warpAffine 非常适合在 CUDA 上加速，关于 warpAffine 仿射变换的细节大家可以参考 <a href="https://blog.csdn.net/qq_40672115/article/details/127012332">YOLOv5推理详解及预处理高性能实现</a>，这边不再赘述。其它步骤倒是和官方的没有区别。</p> 
<p>值得注意得是，letterbox 的操作是先将长边缩放到 640，再将短边按比例缩放，同时确保缩放后的短边能整除 32，如果不能则向上取整多余部分填充。warpAffine 的操作则是将图像分辨率固定在 640x640，多余部分添加灰条，博主对一张 <strong>1080x810</strong> 分辨率的图像经过两种不同预处理后的结果进行了对比，如下图所示：</p> 
<p><img src="https://images2.imgbox.com/04/f5/2wx2U1o9_o.jpg" alt="在这里插入图片描述"></p> 
<center> 
 <b>图1-1 LeeterBox预处理图像</b> 
</center> 
<p><img src="https://images2.imgbox.com/35/24/1fXeB38B_o.jpg" alt="在这里插入图片描述"></p> 
<center> 
 <b>图1-2 warpAffine预处理图像</b> 
</center> 
<p>可以看到二者明显的差别，letterbox 中没有灰条，因为长边缩放到 640 后短边刚好缩放到 480，能整除 32。而 warpAffine 则是固定分辨率 640x640，因此短边多余部分将用灰条填充。</p> 
<p>warpAffine 预处理方法将图像分辨率固定在 640x640，主要有以下几点考虑：(<strong>from chatGPT</strong>)</p> 
<ul><li><strong>简化处理逻辑</strong>：所有预处理后的图像分辨率相同，可以简化 CUDA 中并行处理的逻辑，使得代码更易于编写和维护。</li><li><strong>优化内存访问</strong>：在 GPU 上，连续的内存访问模式通常比非连续的访问更高效。如果所有图像具有相同的大小和布局，这可以帮助优化内存访问，提高处理速度。</li><li><strong>避免动态内存分配</strong>：动态内存分配和释放是昂贵的操作，特别是在 GPU 上。固定分辨率意味着可以预先分配足够的内存，而不需要根据每个图像的大小动态调整内存大小。</li></ul> 
<p>这两种不同的预处理方法生成的图片输入到神经网络时的维度不同，letterbox 的输入是 <strong>torch.Size([1, 3, 640, 480])</strong>，warpAffine 的输入是 <strong>torch.Size([1, 3, 640, 640])</strong>。由于输入维度不同将导致模型输出维度的差异，leetrbox 的输出是 <strong>torch.Size([1, 56, 6300])</strong> 只有 6300 个框，而 warpAffine 的输出是 <strong>torch.Size([1, 56, 8400])</strong> 有 8400 个框，这点大家需要清楚。</p> 
<h4><a id="3_YOLOv8Seg_233"></a>3. YOLOv8-Seg后处理</h4> 
<blockquote> 
 <p>我们再来看看后处理的实现</p> 
</blockquote> 
<p>经过我们的调试分析可知 YOLOv8-Seg 的后处理部分在 <strong>ultralytics/models/yolo/segment/predict.py</strong> 文件中，可以参考：<a href="https://github.com/ultralytics/ultralytics/blob/main/ultralytics/models/yolo/segment/predict.py#L28">segment/predict.py#L28</a></p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">SegmentationPredictor</span><span class="token punctuation">(</span>DetectionPredictor<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    A class extending the DetectionPredictor class for prediction based on a segmentation model.

    Example:
        ```python
        from ultralytics.utils import ASSETS
        from ultralytics.models.yolo.segment import SegmentationPredictor

        args = dict(model='yolov8n-seg.pt', source=ASSETS)
        predictor = SegmentationPredictor(overrides=args)
        predictor.predict_cli()
        
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> cfg<span class="token operator">=</span>DEFAULT_CFG<span class="token punctuation">,</span> overrides<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> _callbacks<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Initializes the SegmentationPredictor with the provided configuration, overrides, and callbacks."""</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> overrides<span class="token punctuation">,</span> _callbacks<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>task <span class="token operator">=</span> <span class="token string">'segment'</span>

    <span class="token keyword">def</span> <span class="token function">postprocess</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> preds<span class="token punctuation">,</span> img<span class="token punctuation">,</span> orig_imgs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Applies non-max suppression and processes detections for each image in an input batch."""</span>
        p <span class="token operator">=</span> ops<span class="token punctuation">.</span>non_max_suppression<span class="token punctuation">(</span>preds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                    self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>conf<span class="token punctuation">,</span>
                                    self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>iou<span class="token punctuation">,</span>
                                    agnostic<span class="token operator">=</span>self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>agnostic_nms<span class="token punctuation">,</span>
                                    max_det<span class="token operator">=</span>self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>max_det<span class="token punctuation">,</span>
                                    nc<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>names<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                    classes<span class="token operator">=</span>self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>classes<span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>orig_imgs<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># input images are a torch.Tensor, not a list</span>
            orig_imgs <span class="token operator">=</span> ops<span class="token punctuation">.</span>convert_torch2numpy_batch<span class="token punctuation">(</span>orig_imgs<span class="token punctuation">)</span>

        results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        proto <span class="token operator">=</span> preds<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>preds<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span> <span class="token keyword">else</span> preds<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment"># second output is len 3 if pt, but only 1 if exported</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> pred <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">:</span>
            orig_img <span class="token operator">=</span> orig_imgs<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            img_path <span class="token operator">=</span> self<span class="token punctuation">.</span>batch<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">len</span><span class="token punctuation">(</span>pred<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># save empty boxes</span>
                masks <span class="token operator">=</span> <span class="token boolean">None</span>
            <span class="token keyword">elif</span> self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>retina_masks<span class="token punctuation">:</span>
                pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> ops<span class="token punctuation">.</span>scale_boxes<span class="token punctuation">(</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> orig_img<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
                masks <span class="token operator">=</span> ops<span class="token punctuation">.</span>process_mask_native<span class="token punctuation">(</span>proto<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> orig_img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># HWC</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                masks <span class="token operator">=</span> ops<span class="token punctuation">.</span>process_mask<span class="token punctuation">(</span>proto<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> upsample<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># HWC</span>
                pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> ops<span class="token punctuation">.</span>scale_boxes<span class="token punctuation">(</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> orig_img<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
            results<span class="token punctuation">.</span>append<span class="token punctuation">(</span>Results<span class="token punctuation">(</span>orig_img<span class="token punctuation">,</span> path<span class="token operator">=</span>img_path<span class="token punctuation">,</span> names<span class="token operator">=</span>self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>names<span class="token punctuation">,</span> boxes<span class="token operator">=</span>pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> masks<span class="token operator">=</span>masks<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> results
</code></pre> 
<p>它包含以下步骤：</p> 
<ul><li><strong>ops.non_max_suppression</strong>：非极大值抑制，即 NMS</li><li><strong>ops.process_mask</strong>：mask 的处理</li><li><strong>ops.scale_boxes</strong>：框的解码，即 decode boxes</li></ul> 
<p>大家如果对 YOLOv5 的后处理熟悉的话，会发现 YOLOv8-Seg 的后处理中检测框的处理和 YOLOv5 中的基本一样，只是需要大家额外处理下 mask，因此我们不难写出对应的后处理代码，如下所示：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">iou</span><span class="token punctuation">(</span>box1<span class="token punctuation">,</span> box2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">area_box</span><span class="token punctuation">(</span>box<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    left   <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    top    <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    right  <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    bottom <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    cross  <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">(</span>right<span class="token operator">-</span>left<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">(</span>bottom<span class="token operator">-</span>top<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    union  <span class="token operator">=</span> area_box<span class="token punctuation">(</span>box1<span class="token punctuation">)</span> <span class="token operator">+</span> area_box<span class="token punctuation">(</span>box2<span class="token punctuation">)</span> <span class="token operator">-</span> cross
    <span class="token keyword">if</span> cross <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">or</span> union <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">0</span>
    <span class="token keyword">return</span> cross <span class="token operator">/</span> union

<span class="token keyword">def</span> <span class="token function">NMS</span><span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> iou_thres<span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    remove_flags <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token boolean">False</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>boxes<span class="token punctuation">)</span>

    keep_boxes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> ibox <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>boxes<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> remove_flags<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>

        keep_boxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ibox<span class="token punctuation">)</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>boxes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> remove_flags<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>

            jbox <span class="token operator">=</span> boxes<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>ibox<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">!=</span> jbox<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            <span class="token keyword">if</span> iou<span class="token punctuation">(</span>ibox<span class="token punctuation">,</span> jbox<span class="token punctuation">)</span> <span class="token operator">&gt;</span> iou_thres<span class="token punctuation">:</span>
                remove_flags<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">True</span>
    <span class="token keyword">return</span> keep_boxes

<span class="token keyword">def</span> <span class="token function">postprocess</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> conf_thres<span class="token operator">=</span><span class="token number">0.25</span><span class="token punctuation">,</span> iou_thres<span class="token operator">=</span><span class="token number">0.45</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token comment"># 输入是模型推理的结果，即8400个预测框</span>
    <span class="token comment"># 1,8400,116 [cx,cy,w,h,class*80,32]</span>
    boxes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> item <span class="token keyword">in</span> pred<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        cx<span class="token punctuation">,</span> cy<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>
        label <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">.</span>argmax<span class="token punctuation">(</span><span class="token punctuation">)</span>
        confidence <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">+</span> label<span class="token punctuation">]</span>
        <span class="token keyword">if</span> confidence <span class="token operator">&lt;</span> conf_thres<span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        left    <span class="token operator">=</span> cx <span class="token operator">-</span> w <span class="token operator">*</span> <span class="token number">0.5</span>
        top     <span class="token operator">=</span> cy <span class="token operator">-</span> h <span class="token operator">*</span> <span class="token number">0.5</span>
        right   <span class="token operator">=</span> cx <span class="token operator">+</span> w <span class="token operator">*</span> <span class="token number">0.5</span>
        bottom  <span class="token operator">=</span> cy <span class="token operator">+</span> h <span class="token operator">*</span> <span class="token number">0.5</span>
        boxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> right<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> confidence<span class="token punctuation">,</span> label<span class="token punctuation">,</span> <span class="token operator">*</span>item<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">32</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        
    boxes <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span>x<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> NMS<span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> iou_thres<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">crop_mask</span><span class="token punctuation">(</span>masks<span class="token punctuation">,</span> boxes<span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    <span class="token comment"># masks -&gt; n, 160, 160  原始 masks</span>
    <span class="token comment"># boxes -&gt; n, 4         检测框，映射到 160x160 尺寸下的</span>
    n<span class="token punctuation">,</span> h<span class="token punctuation">,</span> w <span class="token operator">=</span> masks<span class="token punctuation">.</span>shape
    x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2 <span class="token operator">=</span> torch<span class="token punctuation">.</span>chunk<span class="token punctuation">(</span>boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># x1 shape(n,1,1)</span>
    r <span class="token operator">=</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>w<span class="token punctuation">,</span> device<span class="token operator">=</span>masks<span class="token punctuation">.</span>device<span class="token punctuation">,</span> dtype<span class="token operator">=</span>x1<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>  <span class="token comment"># rows shape(1,1,w)</span>
    c <span class="token operator">=</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>h<span class="token punctuation">,</span> device<span class="token operator">=</span>masks<span class="token punctuation">.</span>device<span class="token punctuation">,</span> dtype<span class="token operator">=</span>x1<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span>  <span class="token comment"># cols shape(1,h,1)</span>

    <span class="token keyword">return</span> masks <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r <span class="token operator">&gt;=</span> x1<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>r <span class="token operator">&lt;</span> x2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>c <span class="token operator">&gt;=</span> y1<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>c <span class="token operator">&lt;</span> y2<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">process_mask</span><span class="token punctuation">(</span>protos<span class="token punctuation">,</span> masks_in<span class="token punctuation">,</span> bboxes<span class="token punctuation">,</span> shape<span class="token punctuation">,</span> upsample<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token comment"># protos   -&gt; 32, 160, 160 分割头输出</span>
    <span class="token comment"># masks_in -&gt; n, 32        检测头输出的 32 维向量，可以理解为 mask 的权重</span>
    <span class="token comment"># bboxes   -&gt; n, 4         检测框</span>
    <span class="token comment"># shape    -&gt; 640, 640     输入网络中的图像 shape</span>
    <span class="token comment"># unsample 一个 bool 值，表示是否需要上采样 masks 到图像的原始形状</span>
    c<span class="token punctuation">,</span> mh<span class="token punctuation">,</span> mw <span class="token operator">=</span> protos<span class="token punctuation">.</span>shape  <span class="token comment"># CHW</span>
    ih<span class="token punctuation">,</span> iw <span class="token operator">=</span> shape
    <span class="token comment"># 矩阵相乘 nx32 @ 32x(160x160) -&gt; nx(160x160) -&gt; sigmoid -&gt; nx160x160</span>
    masks <span class="token operator">=</span> <span class="token punctuation">(</span>masks_in<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span> @ protos<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> mh<span class="token punctuation">,</span> mw<span class="token punctuation">)</span>  <span class="token comment"># CHW</span>

    downsampled_bboxes <span class="token operator">=</span> bboxes<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span>
    downsampled_bboxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*=</span> mw <span class="token operator">/</span> iw
    downsampled_bboxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*=</span> mw <span class="token operator">/</span> iw
    downsampled_bboxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">*=</span> mh <span class="token operator">/</span> ih
    downsampled_bboxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*=</span> mh <span class="token operator">/</span> ih

    masks <span class="token operator">=</span> crop_mask<span class="token punctuation">(</span>masks<span class="token punctuation">,</span> downsampled_bboxes<span class="token punctuation">)</span>  <span class="token comment"># CHW</span>
    <span class="token keyword">if</span> upsample<span class="token punctuation">:</span>
        masks <span class="token operator">=</span> F<span class="token punctuation">.</span>interpolate<span class="token punctuation">(</span>masks<span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">,</span> shape<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'bilinear'</span><span class="token punctuation">,</span> align_corners<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># CHW</span>
    <span class="token keyword">return</span> masks<span class="token punctuation">.</span>gt_<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>
</code></pre> 
<p>可能有点难理解，下面我们简单分析下</p> 
<p>首先对于一张 640x640 的图片来说，YOLOv8-Seg 模型存在两个输出，一个是 output0 可以理解为检测头的输出，它的维度是 <strong>1x116x8400</strong>；另一个是 output1 可以理解为分割头的输出，它的维度是 <strong>1x32x160x160</strong>，我们一个个来分析。</p> 
<p>针对于检测头的输出 <strong>1x116x8400</strong> 我们应该已经非常熟悉了，它代表预测框的总数量是 <strong>8400</strong>，每个预测框的维度是 <strong>116</strong>（针对 COCO 数据集的 80 个类别而言）<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
           
            
            
              8400 
             
            
              × 
             
            
              116 
             
            
           
          
          
           
            
             
            
              = 
             
            
              80 
             
            
              × 
             
            
              80 
             
            
              × 
             
            
              116 
             
            
              + 
             
            
              40 
             
            
              × 
             
            
              40 
             
            
              × 
             
            
              116 
             
            
              + 
             
            
              20 
             
            
              × 
             
            
              20 
             
            
              × 
             
            
              116 
             
            
           
          
         
         
          
           
            
           
          
          
           
            
             
            
              = 
             
            
              80 
             
            
              × 
             
            
              80 
             
            
              × 
             
            
              ( 
             
            
              84 
             
            
              + 
             
            
              32 
             
            
              ) 
             
            
              + 
             
            
              40 
             
            
              × 
             
            
              40 
             
            
              × 
             
            
              ( 
             
            
              84 
             
            
              + 
             
            
              32 
             
            
              ) 
             
            
              + 
             
            
              20 
             
            
              × 
             
            
              20 
             
            
              × 
             
            
              ( 
             
            
              84 
             
            
              + 
             
            
              32 
             
            
              ) 
             
            
           
          
         
         
          
           
            
           
          
          
           
            
             
            
              = 
             
            
              80 
             
            
              × 
             
            
              80 
             
            
              × 
             
            
              ( 
             
            
              4 
             
            
              + 
             
            
              80 
             
            
              + 
             
            
              32 
             
            
              ) 
             
            
              + 
             
            
              40 
             
            
              × 
             
            
              40 
             
            
              × 
             
            
              ( 
             
            
              4 
             
            
              + 
             
            
              80 
             
            
              + 
             
            
              32 
             
            
              ) 
             
            
              + 
             
            
              20 
             
            
              × 
             
            
              20 
             
            
              × 
             
            
              ( 
             
            
              4 
             
            
              + 
             
            
              80 
             
            
              + 
             
            
              32 
             
            
              ) 
             
            
           
          
         
        
       
         \begin{aligned} 8400\times116&amp;=80\times80\times116+40\times40\times116+20\times20\times116\\ &amp;=80\times80\times(84+32)+40\times40\times(84+32)+20\times20\times(84+32)\\ &amp;=80\times80\times(4+80+32)+40\times40\times(4+80+32)+20\times20\times(4+80+32)\\ \end{aligned} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 4.5em; vertical-align: -2em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.5em;"><span class="" style="top: -4.66em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">8400</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">116</span></span></span><span class="" style="top: -3.16em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -1.66em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2em;"><span class=""></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.5em;"><span class="" style="top: -4.66em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord">80</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">80</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">116</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">40</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">40</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">116</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">20</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">20</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">116</span></span></span><span class="" style="top: -3.16em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord">80</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">80</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mopen">(</span><span class="mord">84</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">32</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">40</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">40</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mopen">(</span><span class="mord">84</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">32</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">20</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">20</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mopen">(</span><span class="mord">84</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">32</span><span class="mclose">)</span></span></span><span class="" style="top: -1.66em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord">80</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">80</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mopen">(</span><span class="mord">4</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">80</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">32</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">40</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">40</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mopen">(</span><span class="mord">4</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">80</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">32</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">20</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">20</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mopen">(</span><span class="mord">4</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">80</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">32</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2em;"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span><br> 其中的 4 对应的是 <strong>cx</strong>, <strong>cy</strong>, <strong>w</strong>, <strong>h</strong>，分别代表的含义是边界框中心点坐标、宽高；80 对应的是 COCO 数据集中的 80 个类别置信度。32 维的向量可以看作是与每个检测框关联的分割 mask 的系数或权重。</p> 
<p>针对于分割头的输出 <strong>1x32x160x160</strong>，一个关键的概念是 <strong>prototype masks</strong>。它是一个固定数量（32）的基础 mask，每个 mask 的尺寸为 160x160。这些基础 mask 并不直接对应于任何特定的物体或类别，而是被设计为可以线性组合来表示任何可能的物体 mask。</p> 
<p>简单来说，模型不直接预测每个物体的完整 mask，而是预测一组基本的 masks（称为 prototype masks）以及每个物体如何组合这些 masks（权重/系数）。这种方法的好处是，模型只需要预测一个较小的 mask 张量，然后可以通过简单的矩阵乘法将这些小 mask 组合成完整的物体 masks。</p> 
<p>大家可以把它类比于线性代数中基向量的概念，空间中的任何一个向量是不是都可以表示为一组基向量的线性组合，那么其中的 prototype masks 即 <strong>32x160x160</strong> 的 mask 张量可以把它理解为一组基向量，而之前在检测框中的 <strong>32</strong> 维向量可以理解为组合这一组基向量的权重或者说系数。</p> 
<p>当我们从检测头得到一个 32 维的向量，分割头得到 32 个基础 masks 时，这个 32 维的向量实际上表示了如何组合这些基础 masks 来得到一个特定物体的 mask。具体来说，我们用这个 32 维向量对 32 个基础 masks 进行线性组合，从而得到与检测框关联的最终 mask。简单来说，这就像你现在有 32 种不同的颜料，检测头给你一个配方（32 维向量），告诉你如何混合这些颜料来得到一个特定的颜色（最终的 mask）。</p> 
<p>这样做的优点是我们不需要为每个检测框都预测一个完整的 mask，这个非常消耗内存和计算资源。相反，我们只需要预测一个相对较小的 32 维向量和一个固定数量的基础 masks，然后在后处理中进行组合即可。</p> 
<p>值得注意的是代码中框的解码我们并没有像之前的 YOLOv5 一样，通过仿射变换逆矩阵 IM 映射回原图上，而是让它继续保持在 640x640 的图像上，这是因为我们后续在处理 mask 的时候还需要将 boxes 映射到 160x160 的 mask 上。</p> 
<p>我们重点来看下 mask 部分的处理，分割头的输出会作为参数直接传递到 <strong>process_mask</strong> 函数中进行下一步处理，这个函数的目的是将分割头的输出转换为物体的 masks，下面我们简单分析下该函数：</p> 
<p><strong>输入</strong>：</p> 
<ul><li><strong>protos</strong>：分割头的输出，形状为 32x160x160</li><li><strong>masks_in</strong>：检测头输出的 32 维向量，形状为 nx32</li><li><strong>bboxes</strong>：检测框，形状为 nx4</li><li><strong>shape</strong>：输入网络中的图像大小 640x640</li><li><strong>unsample</strong>：一个布尔值，表示是否需要上采样 masks 到图像的原始形状</li></ul> 
<p><strong>输出</strong>：</p> 
<ul><li>最终的物体 masks</li></ul> 
<p><strong>实现细节</strong>：</p> 
<ul><li>首先使用矩阵乘法将 <strong>mask_in</strong> 与 <strong>protos</strong> 进行线性组合，得到原始的 masks</li><li>然后使用 sigmoid 函数将原始 masks 的值映射到 [0,1] 之间的概率值</li><li>接着会根据图像的 shape 将边界框的大小缩放到 160x160 上</li><li>使用 <strong>crop_mask</strong> 函数裁剪 masks</li><li>如果 <strong>unsample</strong> 为 True，则使用双线性插值将 masks 上采样到图像的原始形状（640x640）</li><li>最后使用 <strong>gt_(0.5)</strong> 将 masks 的值映射到 {0, 1}。大于 0.5 的部分我们认为这个像素有超过 50% 的概率属于前景（目标物体），因此设置为 1；反之，如果概率小于等于 0.5，我们则认为该像素是背景，设置为 0</li></ul> 
<p>值得注意的是，<strong>crop_masks</strong> 函数并不是将原始 masks 进行尺寸的裁剪，它不会改变 masks 的尺寸。它的主要目的是为了 <strong>屏蔽</strong> 掉那些不在检测框内的部分，这样 mask 里的值只会在检测框内部分为 1，而检测框外的部分为 0。这是因为在 160x160 的 mask 范围内，我们只对检测框内的物体部分感兴趣，其它部分我们并不关注。</p> 
<h4><a id="4_YOLOv8Seg_438"></a>4. YOLOv8-Seg推理</h4> 
<blockquote> 
 <p>通过上面对 YOLOv8-Seg 的预处理和后处理分析之后，整个推理过程就显而易见了。YOLOv8-Seg 的推理包括图像预处理、模型推理、预测结果后处理三部分，其中预处理主要包括 <strong>warpAffine 仿射变换</strong>，后处理主要包括 <strong>boxes 的 decode 解码和 NMS 以及 mask 的处理</strong> 三部分。</p> 
</blockquote> 
<p>完整的推理代码如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> cv2
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F
<span class="token keyword">from</span> ultralytics<span class="token punctuation">.</span>data<span class="token punctuation">.</span>augment <span class="token keyword">import</span> LetterBox
<span class="token keyword">from</span> ultralytics<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>autobackend <span class="token keyword">import</span> AutoBackend

<span class="token keyword">def</span> <span class="token function">preprocess_letterbox</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">:</span>
    letterbox <span class="token operator">=</span> LetterBox<span class="token punctuation">(</span>new_shape<span class="token operator">=</span><span class="token number">640</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> auto<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    image <span class="token operator">=</span> letterbox<span class="token punctuation">(</span>image<span class="token operator">=</span>image<span class="token punctuation">)</span>
    image <span class="token operator">=</span> <span class="token punctuation">(</span>image<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">255.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span> <span class="token comment"># BGR to RGB, 0 - 255 to 0.0 - 1.0</span>
    image <span class="token operator">=</span> image<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span>  <span class="token comment"># BHWC to BCHW (n, 3, h, w)</span>
    image <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
    <span class="token keyword">return</span> image

<span class="token keyword">def</span> <span class="token function">preprocess_warpAffine</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> dst_width<span class="token operator">=</span><span class="token number">640</span><span class="token punctuation">,</span> dst_height<span class="token operator">=</span><span class="token number">640</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    scale <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dst_width <span class="token operator">/</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dst_height <span class="token operator">/</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    ox <span class="token operator">=</span> <span class="token punctuation">(</span>dst_width  <span class="token operator">-</span> scale <span class="token operator">*</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
    oy <span class="token operator">=</span> <span class="token punctuation">(</span>dst_height <span class="token operator">-</span> scale <span class="token operator">*</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
    M <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token punctuation">[</span>scale<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ox<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> scale<span class="token punctuation">,</span> oy<span class="token punctuation">]</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
    
    img_pre <span class="token operator">=</span> cv2<span class="token punctuation">.</span>warpAffine<span class="token punctuation">(</span>image<span class="token punctuation">,</span> M<span class="token punctuation">,</span> <span class="token punctuation">(</span>dst_width<span class="token punctuation">,</span> dst_height<span class="token punctuation">)</span><span class="token punctuation">,</span> flags<span class="token operator">=</span>cv2<span class="token punctuation">.</span>INTER_LINEAR<span class="token punctuation">,</span>
                             borderMode<span class="token operator">=</span>cv2<span class="token punctuation">.</span>BORDER_CONSTANT<span class="token punctuation">,</span> borderValue<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">114</span><span class="token punctuation">,</span> <span class="token number">114</span><span class="token punctuation">,</span> <span class="token number">114</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    IM <span class="token operator">=</span> cv2<span class="token punctuation">.</span>invertAffineTransform<span class="token punctuation">(</span>M<span class="token punctuation">)</span>

    img_pre <span class="token operator">=</span> <span class="token punctuation">(</span>img_pre<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">255.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
    img_pre <span class="token operator">=</span> img_pre<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span>
    img_pre <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>img_pre<span class="token punctuation">)</span>
    <span class="token keyword">return</span> img_pre<span class="token punctuation">,</span> IM

<span class="token keyword">def</span> <span class="token function">iou</span><span class="token punctuation">(</span>box1<span class="token punctuation">,</span> box2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">area_box</span><span class="token punctuation">(</span>box<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    left   <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    top    <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    right  <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    bottom <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    cross  <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">(</span>right<span class="token operator">-</span>left<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">(</span>bottom<span class="token operator">-</span>top<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    union  <span class="token operator">=</span> area_box<span class="token punctuation">(</span>box1<span class="token punctuation">)</span> <span class="token operator">+</span> area_box<span class="token punctuation">(</span>box2<span class="token punctuation">)</span> <span class="token operator">-</span> cross
    <span class="token keyword">if</span> cross <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">or</span> union <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">0</span>
    <span class="token keyword">return</span> cross <span class="token operator">/</span> union

<span class="token keyword">def</span> <span class="token function">NMS</span><span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> iou_thres<span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    remove_flags <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token boolean">False</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>boxes<span class="token punctuation">)</span>

    keep_boxes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> ibox <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>boxes<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> remove_flags<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>

        keep_boxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ibox<span class="token punctuation">)</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>boxes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> remove_flags<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>

            jbox <span class="token operator">=</span> boxes<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>ibox<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">!=</span> jbox<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            <span class="token keyword">if</span> iou<span class="token punctuation">(</span>ibox<span class="token punctuation">,</span> jbox<span class="token punctuation">)</span> <span class="token operator">&gt;</span> iou_thres<span class="token punctuation">:</span>
                remove_flags<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">True</span>
    <span class="token keyword">return</span> keep_boxes

<span class="token keyword">def</span> <span class="token function">postprocess</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> conf_thres<span class="token operator">=</span><span class="token number">0.25</span><span class="token punctuation">,</span> iou_thres<span class="token operator">=</span><span class="token number">0.45</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token comment"># 输入是模型推理的结果，即8400个预测框</span>
    <span class="token comment"># 1,8400,116 [cx,cy,w,h,class*80,32]</span>
    boxes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> item <span class="token keyword">in</span> pred<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        cx<span class="token punctuation">,</span> cy<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>
        label <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">.</span>argmax<span class="token punctuation">(</span><span class="token punctuation">)</span>
        confidence <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">+</span> label<span class="token punctuation">]</span>
        <span class="token keyword">if</span> confidence <span class="token operator">&lt;</span> conf_thres<span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        left    <span class="token operator">=</span> cx <span class="token operator">-</span> w <span class="token operator">*</span> <span class="token number">0.5</span>
        top     <span class="token operator">=</span> cy <span class="token operator">-</span> h <span class="token operator">*</span> <span class="token number">0.5</span>
        right   <span class="token operator">=</span> cx <span class="token operator">+</span> w <span class="token operator">*</span> <span class="token number">0.5</span>
        bottom  <span class="token operator">=</span> cy <span class="token operator">+</span> h <span class="token operator">*</span> <span class="token number">0.5</span>
        boxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> right<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> confidence<span class="token punctuation">,</span> label<span class="token punctuation">,</span> <span class="token operator">*</span>item<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">32</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        
    boxes <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span>x<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> NMS<span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> iou_thres<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">crop_mask</span><span class="token punctuation">(</span>masks<span class="token punctuation">,</span> boxes<span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    <span class="token comment"># masks -&gt; n, 160, 160  原始 masks</span>
    <span class="token comment"># boxes -&gt; n, 4         检测框，映射到 160x160 尺寸下的</span>
    n<span class="token punctuation">,</span> h<span class="token punctuation">,</span> w <span class="token operator">=</span> masks<span class="token punctuation">.</span>shape
    x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2 <span class="token operator">=</span> torch<span class="token punctuation">.</span>chunk<span class="token punctuation">(</span>boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># x1 shape(n,1,1)</span>
    r <span class="token operator">=</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>w<span class="token punctuation">,</span> device<span class="token operator">=</span>masks<span class="token punctuation">.</span>device<span class="token punctuation">,</span> dtype<span class="token operator">=</span>x1<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>  <span class="token comment"># rows shape(1,1,w)</span>
    c <span class="token operator">=</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>h<span class="token punctuation">,</span> device<span class="token operator">=</span>masks<span class="token punctuation">.</span>device<span class="token punctuation">,</span> dtype<span class="token operator">=</span>x1<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span>  <span class="token comment"># cols shape(1,h,1)</span>

    <span class="token keyword">return</span> masks <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r <span class="token operator">&gt;=</span> x1<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>r <span class="token operator">&lt;</span> x2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>c <span class="token operator">&gt;=</span> y1<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>c <span class="token operator">&lt;</span> y2<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">process_mask</span><span class="token punctuation">(</span>protos<span class="token punctuation">,</span> masks_in<span class="token punctuation">,</span> bboxes<span class="token punctuation">,</span> shape<span class="token punctuation">,</span> upsample<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token comment"># protos   -&gt; 32, 160, 160 分割头输出</span>
    <span class="token comment"># masks_in -&gt; n, 32        检测头输出的 32 维向量，可以理解为 mask 的权重</span>
    <span class="token comment"># bboxes   -&gt; n, 4         检测框</span>
    <span class="token comment"># shape    -&gt; 640, 640     输入网络中的图像 shape</span>
    <span class="token comment"># unsample 一个 bool 值，表示是否需要上采样 masks 到图像的原始形状</span>
    c<span class="token punctuation">,</span> mh<span class="token punctuation">,</span> mw <span class="token operator">=</span> protos<span class="token punctuation">.</span>shape  <span class="token comment"># CHW</span>
    ih<span class="token punctuation">,</span> iw <span class="token operator">=</span> shape
    <span class="token comment"># 矩阵相乘 nx32 @ 32x(160x160) -&gt; nx(160x160) -&gt; sigmoid -&gt; nx160x160</span>
    masks <span class="token operator">=</span> <span class="token punctuation">(</span>masks_in<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span> @ protos<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> mh<span class="token punctuation">,</span> mw<span class="token punctuation">)</span>  <span class="token comment"># CHW</span>

    downsampled_bboxes <span class="token operator">=</span> bboxes<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span>
    downsampled_bboxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*=</span> mw <span class="token operator">/</span> iw
    downsampled_bboxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*=</span> mw <span class="token operator">/</span> iw
    downsampled_bboxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">*=</span> mh <span class="token operator">/</span> ih
    downsampled_bboxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*=</span> mh <span class="token operator">/</span> ih

    masks <span class="token operator">=</span> crop_mask<span class="token punctuation">(</span>masks<span class="token punctuation">,</span> downsampled_bboxes<span class="token punctuation">)</span>  <span class="token comment"># CHW</span>
    <span class="token keyword">if</span> upsample<span class="token punctuation">:</span>
        masks <span class="token operator">=</span> F<span class="token punctuation">.</span>interpolate<span class="token punctuation">(</span>masks<span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">,</span> shape<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'bilinear'</span><span class="token punctuation">,</span> align_corners<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># CHW</span>
    <span class="token keyword">return</span> masks<span class="token punctuation">.</span>gt_<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">hsv2bgr</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> s<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">:</span>
    h_i <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>h <span class="token operator">*</span> <span class="token number">6</span><span class="token punctuation">)</span>
    f <span class="token operator">=</span> h <span class="token operator">*</span> <span class="token number">6</span> <span class="token operator">-</span> h_i
    p <span class="token operator">=</span> v <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> s<span class="token punctuation">)</span>
    q <span class="token operator">=</span> v <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> f <span class="token operator">*</span> s<span class="token punctuation">)</span>
    t <span class="token operator">=</span> v <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> f<span class="token punctuation">)</span> <span class="token operator">*</span> s<span class="token punctuation">)</span>
    
    r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>

    <span class="token keyword">if</span> h_i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> v<span class="token punctuation">,</span> t<span class="token punctuation">,</span> p
    <span class="token keyword">elif</span> h_i <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> q<span class="token punctuation">,</span> v<span class="token punctuation">,</span> p
    <span class="token keyword">elif</span> h_i <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> p<span class="token punctuation">,</span> v<span class="token punctuation">,</span> t
    <span class="token keyword">elif</span> h_i <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> p<span class="token punctuation">,</span> q<span class="token punctuation">,</span> v
    <span class="token keyword">elif</span> h_i <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> t<span class="token punctuation">,</span> p<span class="token punctuation">,</span> v
    <span class="token keyword">elif</span> h_i <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> v<span class="token punctuation">,</span> p<span class="token punctuation">,</span> q

    <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">(</span>b <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>g <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>r <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">random_color</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    h_plane <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">id</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">0x937151</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">100.0</span>
    s_plane <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">id</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">0x315793</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">100.0</span>
    <span class="token keyword">return</span> hsv2bgr<span class="token punctuation">(</span>h_plane<span class="token punctuation">,</span> s_plane<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>

    img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">"ultralytics/assets/bus.jpg"</span><span class="token punctuation">)</span>

    <span class="token comment"># img_pre = preprocess_letterbox(img)</span>
    img_pre<span class="token punctuation">,</span> IM <span class="token operator">=</span> preprocess_warpAffine<span class="token punctuation">(</span>img<span class="token punctuation">)</span>

    model  <span class="token operator">=</span> AutoBackend<span class="token punctuation">(</span>weights<span class="token operator">=</span><span class="token string">"yolov8s-seg.pt"</span><span class="token punctuation">)</span>
    names  <span class="token operator">=</span> model<span class="token punctuation">.</span>names
    result <span class="token operator">=</span> model<span class="token punctuation">(</span>img_pre<span class="token punctuation">)</span>
    <span class="token triple-quoted-string string">"""
    result[0] -&gt; 1, 116, 8400 -&gt; det head
    result[1][0][0] -&gt; 1, 144, 80, 80
    result[1][0][1] -&gt; 1, 144, 40, 40
    result[1][0][2] -&gt; 1, 144, 20, 20
    result[1][1] -&gt; 1, 32, 8400
    result[1][2] -&gt; 1, 32, 160, 160 -&gt; seg head
    """</span>

    output0 <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment"># 1,8400,116 检测头输出</span>
    output1 <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>             <span class="token comment"># 32,160,160 分割头输出</span>

    pred <span class="token operator">=</span> postprocess<span class="token punctuation">(</span>output0<span class="token punctuation">)</span>
    pred <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>pred<span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">38</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># pred -&gt; nx38 = [cx,cy,w,h,conf,label,32]</span>
    masks <span class="token operator">=</span> process_mask<span class="token punctuation">(</span>output1<span class="token punctuation">,</span> pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> img_pre<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>

    boxes <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    lr <span class="token operator">=</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    tb <span class="token operator">=</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> IM<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> lr <span class="token operator">+</span> IM<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
    boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> IM<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> tb <span class="token operator">+</span> IM<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>

    <span class="token comment"># draw mask</span>
    h<span class="token punctuation">,</span> w <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> mask <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>masks<span class="token punctuation">)</span><span class="token punctuation">:</span>
        
        mask <span class="token operator">=</span> mask<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span> <span class="token comment"># 640x640</span>
        mask_resized <span class="token operator">=</span> cv2<span class="token punctuation">.</span>warpAffine<span class="token punctuation">(</span>mask<span class="token punctuation">,</span> IM<span class="token punctuation">,</span> <span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">,</span> flags<span class="token operator">=</span>cv2<span class="token punctuation">.</span>INTER_LINEAR<span class="token punctuation">)</span>  <span class="token comment"># 1080x810</span>
        
        label <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>boxes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        color <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>random_color<span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        colored_mask <span class="token operator">=</span> <span class="token punctuation">(</span>np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> w<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> color<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
        masked_colored_mask <span class="token operator">=</span> cv2<span class="token punctuation">.</span>bitwise_and<span class="token punctuation">(</span>colored_mask<span class="token punctuation">,</span> colored_mask<span class="token punctuation">,</span> mask<span class="token operator">=</span>mask_resized<span class="token punctuation">)</span>

        mask_indices <span class="token operator">=</span> mask_resized <span class="token operator">==</span> <span class="token number">1</span>
        img<span class="token punctuation">[</span>mask_indices<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>img<span class="token punctuation">[</span>mask_indices<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">0.6</span> <span class="token operator">+</span> masked_colored_mask<span class="token punctuation">[</span>mask_indices<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>

        <span class="token comment"># contours, _ = cv2.findContours(mask_resized, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)</span>
        <span class="token comment"># cv2.drawContours(img, contours, -1, random_color(label), 2)</span>

    <span class="token comment"># draw box</span>
    <span class="token keyword">for</span> obj <span class="token keyword">in</span> boxes<span class="token punctuation">:</span>
        left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> right<span class="token punctuation">,</span> bottom <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        confidence <span class="token operator">=</span> obj<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>
        label <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        color <span class="token operator">=</span> random_color<span class="token punctuation">(</span>label<span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span>left<span class="token punctuation">,</span> top<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>right<span class="token punctuation">,</span> bottom<span class="token punctuation">)</span><span class="token punctuation">,</span> color <span class="token operator">=</span> color <span class="token punctuation">,</span>thickness<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> lineType<span class="token operator">=</span>cv2<span class="token punctuation">.</span>LINE_AA<span class="token punctuation">)</span>
        caption <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>names<span class="token punctuation">[</span>label<span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>confidence<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
        w<span class="token punctuation">,</span> h <span class="token operator">=</span> cv2<span class="token punctuation">.</span>getTextSize<span class="token punctuation">(</span>caption<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span>left <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">,</span> top <span class="token operator">-</span> <span class="token number">33</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>left <span class="token operator">+</span> w <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">,</span> top<span class="token punctuation">)</span><span class="token punctuation">,</span> color<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>img<span class="token punctuation">,</span> caption<span class="token punctuation">,</span> <span class="token punctuation">(</span>left<span class="token punctuation">,</span> top <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
    
    cv2<span class="token punctuation">.</span>imwrite<span class="token punctuation">(</span><span class="token string">"infer-seg.jpg"</span><span class="token punctuation">,</span> img<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"save done"</span><span class="token punctuation">)</span>    
</code></pre> 
<p>推理效果如下图所示：</p> 
<p><img src="https://images2.imgbox.com/f3/c9/t9xVErjt_o.jpg" alt="在这里插入图片描述"></p> 
<p>至此，我们在 Python 上面完成了 YOLOv8-Seg 的整个推理过程，下面我们去 C++ 上实现。</p> 
<h3><a id="YOLOv8SegC_673"></a>二、YOLOv8-Seg推理(C++)</h3> 
<blockquote> 
 <p>C++ 上的实现我们使用的 repo 依旧是 tensorRT_Pro，现在我们就基于 tensorRT_Pro 完成 YOLOv8-Seg 在 C++ 上的推理。</p> 
</blockquote> 
<h4><a id="1_ONNX_677"></a>1. ONNX导出</h4> 
<p>首先我们需要将 YOLOv8-Seg 模型导出为 ONNX，为了适配 tensorRT_Pro 我们需要做一些修改，主要有以下几点：</p> 
<ul><li>输入输出只让 batch 维度动态，宽高不动态</li><li>增加 <strong>transpose</strong> 节点交换输出的 2、3 维度</li></ul> 
<p>具体修改如下：</p> 
<p><strong>1.</strong> <strong>在 ultralytics/engine/exporter.py 文件中改动一处</strong></p> 
<ul><li><strong>326 行</strong>：输入只让 batch 维度动态，宽高不动态</li><li><strong>328/329 行</strong>：输出只让 batch 动态，宽高不动态</li></ul> 
<pre><code class="prism language-python"><span class="token comment"># ========== exporter.py ==========</span>

<span class="token comment"># ultralytics/engine/exporter.py第323行</span>
<span class="token comment"># output_names = ['output0', 'output1'] if isinstance(self.model, SegmentationModel) else ['output0']</span>
<span class="token comment"># dynamic = self.args.dynamic</span>
<span class="token comment"># if dynamic:</span>
<span class="token comment">#     dynamic = {'images': {0: 'batch', 2: 'height', 3: 'width'}}  # shape(1,3,640,640)</span>
<span class="token comment">#     if isinstance(self.model, SegmentationModel):</span>
<span class="token comment">#         dynamic['output0'] = {0: 'batch', 2: 'anchors'}  # shape(1, 116, 8400)</span>
<span class="token comment">#         dynamic['output1'] = {0: 'batch', 2: 'mask_height', 3: 'mask_width'}  # shape(1,32,160,160)</span>
<span class="token comment">#     elif isinstance(self.model, DetectionModel):</span>
<span class="token comment">#         dynamic['output0'] = {0: 'batch', 2: 'anchors'}  # shape(1, 84, 8400)</span>
<span class="token comment"># 修改为：</span>

output_names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'output0'</span><span class="token punctuation">,</span> <span class="token string">'output1'</span><span class="token punctuation">]</span> <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>model<span class="token punctuation">,</span> SegmentationModel<span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token punctuation">[</span><span class="token string">'output0'</span><span class="token punctuation">]</span>
dynamic <span class="token operator">=</span> self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>dynamic
<span class="token keyword">if</span> dynamic<span class="token punctuation">:</span>
    dynamic <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'images'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">'batch'</span><span class="token punctuation">}</span><span class="token punctuation">}</span>  <span class="token comment"># shape(1,3,640,640)</span>
    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>model<span class="token punctuation">,</span> SegmentationModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
        dynamic<span class="token punctuation">[</span><span class="token string">'output0'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">'batch'</span><span class="token punctuation">}</span>  <span class="token comment"># shape(1, 116, 8400)</span>
        dynamic<span class="token punctuation">[</span><span class="token string">'output1'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">'batch'</span><span class="token punctuation">}</span>  <span class="token comment"># shape(1,32,160,160)</span>
    <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>model<span class="token punctuation">,</span> DetectionModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
        dynamic<span class="token punctuation">[</span><span class="token string">'output0'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">'batch'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span> <span class="token string">'anchors'</span><span class="token punctuation">}</span>  <span class="token comment"># shape(1, 84, 8400)</span>
</code></pre> 
<p><strong>2.</strong> <strong>在 ultralytics/nn/modules/head.py 文件中改动一处</strong></p> 
<ul><li><strong>106 行</strong>：添加 <strong>transpose</strong> 节点交换检测头输出的第 2 和 第 3 维度</li></ul> 
<pre><code class="prism language-python"><span class="token comment"># ========== head.py ==========</span>

<span class="token comment"># ultralytics/nn/modules/head.py第106行，forward函数</span>
<span class="token comment"># return (torch.cat([x, mc], 1), p) if self.export else (torch.cat([x[0], mc], 1), (x[1], mc, p))</span>
<span class="token comment"># 修改为：</span>

<span class="token keyword">return</span> <span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">,</span> mc<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>export <span class="token keyword">else</span> <span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> mc<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> mc<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>以上就是为了适配 tensorRT_Pro 而做出的代码修改，修改好以后，将预训练权重 <strong>yolov8s-seg.pt</strong> 放在 ultralytics-main 主目录下，新建导出文件 <strong>export.py</strong>，内容如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> ultralytics <span class="token keyword">import</span> YOLO

model <span class="token operator">=</span> YOLO<span class="token punctuation">(</span><span class="token string">"yolov8s-seg.pt"</span><span class="token punctuation">)</span>

success <span class="token operator">=</span> model<span class="token punctuation">.</span>export<span class="token punctuation">(</span><span class="token builtin">format</span><span class="token operator">=</span><span class="token string">"onnx"</span><span class="token punctuation">,</span> dynamic<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> simplify<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre> 
<p>在终端执行如下指令即可完成 onnx 导出：</p> 
<pre><code class="prism language-shell">python export.py
</code></pre> 
<p>导出过程如下图所示：</p> 
<p><img src="https://images2.imgbox.com/d7/4d/IxVpqD3a_o.png" alt="在这里插入图片描述"></p> 
<p>可以看到导出的 pytorch 模型的输入 shape 是 1x3x640x640，检测头输出 shape 是 1x8400x116，分割头输出 shape 是 1x32x160x160，符合我们的预期。</p> 
<p>导出成功后会在当前目录下生成 yolov8s-seg.onnx 模型，我们可以使用 <a href="https://netron.app/" rel="nofollow">Netron</a> 可视化工具查看，如下图所示：</p> 
<p><img src="https://images2.imgbox.com/19/75/gaqHVgrt_o.png" alt="在这里插入图片描述"></p> 
<p>可以看到输入节点名是 <strong>images</strong>，维度是 batchx3x640x640，保证只有 batch 维度动态，检测头输出节点名是 <strong>output0</strong>，维度是 batchxTransposeoutput_dim_1xTransposeoutput_dim_2，分割头输出节点名是 <strong>output1</strong>，维度是 batchx32x160x160，保证只有 batch 维度动态，符合 tensorRT_Pro 的格式。</p> 
<p>大家不要看到 Transposeoutput_dim_1 和 Transposeoutput_dim_2 就认为这也是动态的，其实输出节点的维度是根据输入节点的维度和模型的结构生成的，而额外的维度 Transposeoutput_dim_1 和 Transposeoutput_dim_2 可能是由模型结构中某些操作决定的，如通道数变换（Transpose）操作的输出维度，而不是由动态维度决定的。因此，通常情况下，这些维度是静态的，不会在推理时改变。</p> 
<h4><a id="2_YOLOv8Seg_763"></a>2. YOLOv8-Seg预处理</h4> 
<blockquote> 
 <p>之前有提到过 YOLOv8-Seg 的预处理部分和 YOLOv5 实现一模一样，因此我们在 tensorRT_Pro 中 YOLOv8-Seg 模型的预处理可以直接使用 YOLOv5 的预处理。</p> 
</blockquote> 
<p>tensorRT_Pro 中预处理的代码如下：</p> 
<pre><code class="prism language-cpp">__global__ <span class="token keyword">void</span> <span class="token function">warp_affine_bilinear_and_normalize_plane_kernel</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span><span class="token operator">*</span> src<span class="token punctuation">,</span> <span class="token keyword">int</span> src_line_size<span class="token punctuation">,</span> <span class="token keyword">int</span> src_width<span class="token punctuation">,</span> <span class="token keyword">int</span> src_height<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">*</span> dst<span class="token punctuation">,</span> <span class="token keyword">int</span> dst_width<span class="token punctuation">,</span> <span class="token keyword">int</span> dst_height<span class="token punctuation">,</span> 
	<span class="token keyword">uint8_t</span> const_value_st<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">*</span> warp_affine_matrix_2_3<span class="token punctuation">,</span> Norm norm<span class="token punctuation">,</span> <span class="token keyword">int</span> edge<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

	<span class="token keyword">int</span> position <span class="token operator">=</span> blockDim<span class="token punctuation">.</span>x <span class="token operator">*</span> blockIdx<span class="token punctuation">.</span>x <span class="token operator">+</span> threadIdx<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>position <span class="token operator">&gt;=</span> edge<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

	<span class="token keyword">float</span> m_x1 <span class="token operator">=</span> warp_affine_matrix_2_3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> m_y1 <span class="token operator">=</span> warp_affine_matrix_2_3<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> m_z1 <span class="token operator">=</span> warp_affine_matrix_2_3<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> m_x2 <span class="token operator">=</span> warp_affine_matrix_2_3<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> m_y2 <span class="token operator">=</span> warp_affine_matrix_2_3<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> m_z2 <span class="token operator">=</span> warp_affine_matrix_2_3<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token keyword">int</span> dx      <span class="token operator">=</span> position <span class="token operator">%</span> dst_width<span class="token punctuation">;</span>
	<span class="token keyword">int</span> dy      <span class="token operator">=</span> position <span class="token operator">/</span> dst_width<span class="token punctuation">;</span>
	<span class="token keyword">float</span> src_x <span class="token operator">=</span> m_x1 <span class="token operator">*</span> dx <span class="token operator">+</span> m_y1 <span class="token operator">*</span> dy <span class="token operator">+</span> m_z1<span class="token punctuation">;</span>
	<span class="token keyword">float</span> src_y <span class="token operator">=</span> m_x2 <span class="token operator">*</span> dx <span class="token operator">+</span> m_y2 <span class="token operator">*</span> dy <span class="token operator">+</span> m_z2<span class="token punctuation">;</span>
	<span class="token keyword">float</span> c0<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">;</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span>src_x <span class="token operator">&lt;=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> src_x <span class="token operator">&gt;=</span> src_width <span class="token operator">||</span> src_y <span class="token operator">&lt;=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> src_y <span class="token operator">&gt;=</span> src_height<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token comment">// out of range</span>
		c0 <span class="token operator">=</span> const_value_st<span class="token punctuation">;</span>
		c1 <span class="token operator">=</span> const_value_st<span class="token punctuation">;</span>
		c2 <span class="token operator">=</span> const_value_st<span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
		<span class="token keyword">int</span> y_low <span class="token operator">=</span> <span class="token function">floorf</span><span class="token punctuation">(</span>src_y<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> x_low <span class="token operator">=</span> <span class="token function">floorf</span><span class="token punctuation">(</span>src_x<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> y_high <span class="token operator">=</span> y_low <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> x_high <span class="token operator">=</span> x_low <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

		<span class="token keyword">uint8_t</span> const_value<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>const_value_st<span class="token punctuation">,</span> const_value_st<span class="token punctuation">,</span> const_value_st<span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token keyword">float</span> ly    <span class="token operator">=</span> src_y <span class="token operator">-</span> y_low<span class="token punctuation">;</span>
		<span class="token keyword">float</span> lx    <span class="token operator">=</span> src_x <span class="token operator">-</span> x_low<span class="token punctuation">;</span>
		<span class="token keyword">float</span> hy    <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> ly<span class="token punctuation">;</span>
		<span class="token keyword">float</span> hx    <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> lx<span class="token punctuation">;</span>
		<span class="token keyword">float</span> w1    <span class="token operator">=</span> hy <span class="token operator">*</span> hx<span class="token punctuation">,</span> w2 <span class="token operator">=</span> hy <span class="token operator">*</span> lx<span class="token punctuation">,</span> w3 <span class="token operator">=</span> ly <span class="token operator">*</span> hx<span class="token punctuation">,</span> w4 <span class="token operator">=</span> ly <span class="token operator">*</span> lx<span class="token punctuation">;</span>
		<span class="token keyword">uint8_t</span><span class="token operator">*</span> v1 <span class="token operator">=</span> const_value<span class="token punctuation">;</span>
		<span class="token keyword">uint8_t</span><span class="token operator">*</span> v2 <span class="token operator">=</span> const_value<span class="token punctuation">;</span>
		<span class="token keyword">uint8_t</span><span class="token operator">*</span> v3 <span class="token operator">=</span> const_value<span class="token punctuation">;</span>
		<span class="token keyword">uint8_t</span><span class="token operator">*</span> v4 <span class="token operator">=</span> const_value<span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>y_low <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>x_low <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
				v1 <span class="token operator">=</span> src <span class="token operator">+</span> y_low <span class="token operator">*</span> src_line_size <span class="token operator">+</span> x_low <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span>x_high <span class="token operator">&lt;</span> src_width<span class="token punctuation">)</span>
				v2 <span class="token operator">=</span> src <span class="token operator">+</span> y_low <span class="token operator">*</span> src_line_size <span class="token operator">+</span> x_high <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
		<span class="token keyword">if</span><span class="token punctuation">(</span>y_high <span class="token operator">&lt;</span> src_height<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>x_low <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
				v3 <span class="token operator">=</span> src <span class="token operator">+</span> y_high <span class="token operator">*</span> src_line_size <span class="token operator">+</span> x_low <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span>x_high <span class="token operator">&lt;</span> src_width<span class="token punctuation">)</span>
				v4 <span class="token operator">=</span> src <span class="token operator">+</span> y_high <span class="token operator">*</span> src_line_size <span class="token operator">+</span> x_high <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
		<span class="token comment">// same to opencv</span>
		c0 <span class="token operator">=</span> <span class="token function">floorf</span><span class="token punctuation">(</span>w1 <span class="token operator">*</span> v1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> w2 <span class="token operator">*</span> v2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> w3 <span class="token operator">*</span> v3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> w4 <span class="token operator">*</span> v4<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0.5f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		c1 <span class="token operator">=</span> <span class="token function">floorf</span><span class="token punctuation">(</span>w1 <span class="token operator">*</span> v1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> w2 <span class="token operator">*</span> v2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> w3 <span class="token operator">*</span> v3<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> w4 <span class="token operator">*</span> v4<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0.5f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		c2 <span class="token operator">=</span> <span class="token function">floorf</span><span class="token punctuation">(</span>w1 <span class="token operator">*</span> v1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> w2 <span class="token operator">*</span> v2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> w3 <span class="token operator">*</span> v3<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> w4 <span class="token operator">*</span> v4<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0.5f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span>norm<span class="token punctuation">.</span>channel_type <span class="token operator">==</span> ChannelType<span class="token double-colon punctuation">::</span>Invert<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token keyword">float</span> t <span class="token operator">=</span> c2<span class="token punctuation">;</span>
		c2 <span class="token operator">=</span> c0<span class="token punctuation">;</span>  c0 <span class="token operator">=</span> t<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span>norm<span class="token punctuation">.</span>type <span class="token operator">==</span> NormType<span class="token double-colon punctuation">::</span>MeanStd<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		c0 <span class="token operator">=</span> <span class="token punctuation">(</span>c0 <span class="token operator">*</span> norm<span class="token punctuation">.</span>alpha <span class="token operator">-</span> norm<span class="token punctuation">.</span>mean<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> norm<span class="token punctuation">.</span>std<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		c1 <span class="token operator">=</span> <span class="token punctuation">(</span>c1 <span class="token operator">*</span> norm<span class="token punctuation">.</span>alpha <span class="token operator">-</span> norm<span class="token punctuation">.</span>mean<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> norm<span class="token punctuation">.</span>std<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		c2 <span class="token operator">=</span> <span class="token punctuation">(</span>c2 <span class="token operator">*</span> norm<span class="token punctuation">.</span>alpha <span class="token operator">-</span> norm<span class="token punctuation">.</span>mean<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> norm<span class="token punctuation">.</span>std<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>norm<span class="token punctuation">.</span>type <span class="token operator">==</span> NormType<span class="token double-colon punctuation">::</span>AlphaBeta<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		c0 <span class="token operator">=</span> c0 <span class="token operator">*</span> norm<span class="token punctuation">.</span>alpha <span class="token operator">+</span> norm<span class="token punctuation">.</span>beta<span class="token punctuation">;</span>
		c1 <span class="token operator">=</span> c1 <span class="token operator">*</span> norm<span class="token punctuation">.</span>alpha <span class="token operator">+</span> norm<span class="token punctuation">.</span>beta<span class="token punctuation">;</span>
		c2 <span class="token operator">=</span> c2 <span class="token operator">*</span> norm<span class="token punctuation">.</span>alpha <span class="token operator">+</span> norm<span class="token punctuation">.</span>beta<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">int</span> area <span class="token operator">=</span> dst_width <span class="token operator">*</span> dst_height<span class="token punctuation">;</span>
	<span class="token keyword">float</span><span class="token operator">*</span> pdst_c0 <span class="token operator">=</span> dst <span class="token operator">+</span> dy <span class="token operator">*</span> dst_width <span class="token operator">+</span> dx<span class="token punctuation">;</span>
	<span class="token keyword">float</span><span class="token operator">*</span> pdst_c1 <span class="token operator">=</span> pdst_c0 <span class="token operator">+</span> area<span class="token punctuation">;</span>
	<span class="token keyword">float</span><span class="token operator">*</span> pdst_c2 <span class="token operator">=</span> pdst_c1 <span class="token operator">+</span> area<span class="token punctuation">;</span>
	<span class="token operator">*</span>pdst_c0 <span class="token operator">=</span> c0<span class="token punctuation">;</span>
	<span class="token operator">*</span>pdst_c1 <span class="token operator">=</span> c1<span class="token punctuation">;</span>
	<span class="token operator">*</span>pdst_c2 <span class="token operator">=</span> c2<span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre> 
<p>关于预处理部分其实就是调用了上述 CUDA 核函数来实现 warpAffine，由于在 CUDA 中我们是对每个像素进行操作，因此非常容易实现 BGR → RGB，/255.0 等操作。关于代码的具体分析可以参考 <a href="https://blog.csdn.net/qq_40672115/article/details/127012332">YOLOv5推理详解及预处理高性能实现</a>，这边不再赘述。</p> 
<h4><a id="3_YOLOv8Seg_859"></a>3. YOLOv8-Seg后处理</h4> 
<blockquote> 
 <p>在 <a href="https://github.com/shouxieai/infer">infer</a> 框架中有关于 YOLOv8-Seg 模型的后处理，因此我们直接 copy 过来即可，它包括检测框的后处理和 mask 的后处理，我们先来看检测框的后处理，代码可参考：<a href="https://github.com/shouxieai/infer/blob/main/src/yolo.cu#L129">yolo.cu#L129</a></p> 
</blockquote> 
<p>因此我们不难写出 YOLOv8-Seg 的检测框 decode 解码部分的实现代码，如下所示：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> __global__ <span class="token keyword">void</span> <span class="token function">decode_kernel_v8_Seg</span><span class="token punctuation">(</span><span class="token keyword">float</span> <span class="token operator">*</span>predict<span class="token punctuation">,</span> <span class="token keyword">int</span> num_bboxes<span class="token punctuation">,</span> <span class="token keyword">int</span> num_classes<span class="token punctuation">,</span> <span class="token keyword">float</span> confidence_threshold<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">*</span> invert_affine_matrix<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">*</span> parray<span class="token punctuation">,</span> <span class="token keyword">int</span> MAX_IMAGE_BOXES<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    
    <span class="token keyword">int</span> position <span class="token operator">=</span> blockDim<span class="token punctuation">.</span>x <span class="token operator">*</span> blockIdx<span class="token punctuation">.</span>x <span class="token operator">+</span> threadIdx<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>position <span class="token operator">&gt;=</span> num_bboxes<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">float</span><span class="token operator">*</span> pitem            <span class="token operator">=</span> predict <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">+</span> num_classes <span class="token operator">+</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">*</span> position<span class="token punctuation">;</span>
    <span class="token keyword">float</span><span class="token operator">*</span> class_confidence <span class="token operator">=</span> pitem <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> confidence        <span class="token operator">=</span> <span class="token operator">*</span>class_confidence<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> label               <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_classes<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">,</span> <span class="token operator">++</span>class_confidence<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>class_confidence <span class="token operator">&gt;</span> confidence<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            confidence <span class="token operator">=</span> <span class="token operator">*</span>class_confidence<span class="token punctuation">;</span>
            label      <span class="token operator">=</span> i<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>confidence <span class="token operator">&lt;</span> confidence_threshold<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token function">atomicAdd</span><span class="token punctuation">(</span>parray<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>index <span class="token operator">&gt;=</span> MAX_IMAGE_BOXES<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">float</span> cx         <span class="token operator">=</span> <span class="token operator">*</span>pitem<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> cy         <span class="token operator">=</span> <span class="token operator">*</span>pitem<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> width      <span class="token operator">=</span> <span class="token operator">*</span>pitem<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> height     <span class="token operator">=</span> <span class="token operator">*</span>pitem<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> left   <span class="token operator">=</span> cx <span class="token operator">-</span> width  <span class="token operator">*</span> <span class="token number">0.5f</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> top    <span class="token operator">=</span> cy <span class="token operator">-</span> height <span class="token operator">*</span> <span class="token number">0.5f</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> right  <span class="token operator">=</span> cx <span class="token operator">+</span> width  <span class="token operator">*</span> <span class="token number">0.5f</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> bottom <span class="token operator">=</span> cy <span class="token operator">+</span> height <span class="token operator">*</span> <span class="token number">0.5f</span><span class="token punctuation">;</span>
    <span class="token function">affine_project</span><span class="token punctuation">(</span>invert_affine_matrix<span class="token punctuation">,</span> left<span class="token punctuation">,</span>  top<span class="token punctuation">,</span>    <span class="token operator">&amp;</span>left<span class="token punctuation">,</span>  <span class="token operator">&amp;</span>top<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">affine_project</span><span class="token punctuation">(</span>invert_affine_matrix<span class="token punctuation">,</span> right<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> <span class="token operator">&amp;</span>right<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bottom<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">float</span> <span class="token operator">*</span>pout_item <span class="token operator">=</span> parray <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> index <span class="token operator">*</span> NUM_BOX_ELEMENT<span class="token punctuation">;</span>
    <span class="token operator">*</span>pout_item<span class="token operator">++</span> <span class="token operator">=</span> left<span class="token punctuation">;</span>
    <span class="token operator">*</span>pout_item<span class="token operator">++</span> <span class="token operator">=</span> top<span class="token punctuation">;</span>
    <span class="token operator">*</span>pout_item<span class="token operator">++</span> <span class="token operator">=</span> right<span class="token punctuation">;</span>
    <span class="token operator">*</span>pout_item<span class="token operator">++</span> <span class="token operator">=</span> bottom<span class="token punctuation">;</span>
    <span class="token operator">*</span>pout_item<span class="token operator">++</span> <span class="token operator">=</span> confidence<span class="token punctuation">;</span>
    <span class="token operator">*</span>pout_item<span class="token operator">++</span> <span class="token operator">=</span> label<span class="token punctuation">;</span>
    <span class="token operator">*</span>pout_item<span class="token operator">++</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 1 = keep, 0 = ignore</span>
    <span class="token operator">*</span>pout_item<span class="token operator">++</span> <span class="token operator">=</span> position<span class="token punctuation">;</span>  <span class="token comment">// row_index</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>关于 decode 的具体实现其实就是启动多个线程，每个线程处理一个框的解码，我们会通过仿射变换矩阵 IM 将坐标映射回原图上，值得注意的是，我们在 NUM_BOX_ELEMENT 中新增了一个 <strong>position</strong> 的元素，该元素在后续处理 mask 时能够告诉我们某个检测框的 mask 权重系数在内存中的位置，也就是说通过 <strong>position</strong> 我们可以得到检测框的 mask_weights。</p> 
<p>关于 decode 代码的详细分析可参考 <a href="https://blog.csdn.net/qq_40672115/article/details/129837469">infer源码阅读之yolo.cu</a>，这边不再赘述，另外关于 NMS 部分的实现无需修改，其具体实现可以参考：<a href="https://github.com/shouxieai/tensorRT_Pro/blob/main/src/application/app_yolo/yolo_decode.cu#L81">yolo_decode.cu#L81</a></p> 
<p>关于 mask 部分的后处理我们可以参考：<a href="https://github.com/shouxieai/infer/blob/main/src/yolo.cu#L629">yolo.cu#L629</a></p> 
<p>因此我们不难写出 YOLOv8-Seg 的分割 mask 后处理部分的实现代码，如下所示：</p> 
<pre><code class="prism language-cpp">Box <span class="token function">result_object_box</span><span class="token punctuation">(</span>pbox<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pbox<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pbox<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pbox<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pbox<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pbox<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// process mask</span>
<span class="token comment">// reference: https://github.com/shouxieai/infer/blob/main/src/yolo.cu#L629</span>
<span class="token keyword">int</span> row_index <span class="token operator">=</span> pbox<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> mask_dim  <span class="token operator">=</span> mask_head_output<span class="token operator">-&gt;</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">float</span><span class="token operator">*</span> mask_weights      <span class="token operator">=</span> bbox_head_output<span class="token operator">-&gt;</span><span class="token generic-function"><span class="token function">gpu</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>ibatch<span class="token punctuation">)</span> <span class="token operator">+</span> row_index <span class="token operator">*</span> bbox_head_output<span class="token operator">-&gt;</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> num_classes <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token keyword">float</span><span class="token operator">*</span> mask_head_predict <span class="token operator">=</span> mask_head_output<span class="token operator">-&gt;</span><span class="token generic-function"><span class="token function">gpu</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>ibatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> right<span class="token punctuation">,</span> bottom<span class="token punctuation">;</span>
<span class="token keyword">float</span><span class="token operator">*</span> i2d <span class="token operator">=</span> job<span class="token punctuation">.</span>additional<span class="token punctuation">.</span>i2d<span class="token punctuation">;</span>
<span class="token function">affine_project</span><span class="token punctuation">(</span>i2d<span class="token punctuation">,</span> pbox<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pbox<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>left<span class="token punctuation">,</span>  <span class="token operator">&amp;</span>top<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">affine_project</span><span class="token punctuation">(</span>i2d<span class="token punctuation">,</span> pbox<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pbox<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>right<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bottom<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">float</span> box_width          <span class="token operator">=</span> right <span class="token operator">-</span> left<span class="token punctuation">;</span>
<span class="token keyword">float</span> box_height         <span class="token operator">=</span> bottom <span class="token operator">-</span> top<span class="token punctuation">;</span>
<span class="token keyword">float</span> scale_to_predict_x <span class="token operator">=</span> mask_head_output<span class="token operator">-&gt;</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>input_width_<span class="token punctuation">;</span>
<span class="token keyword">float</span> scale_to_predict_y <span class="token operator">=</span> mask_head_output<span class="token operator">-&gt;</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>input_height_<span class="token punctuation">;</span>
<span class="token keyword">int</span> mask_out_width       <span class="token operator">=</span> box_width  <span class="token operator">*</span> scale_to_predict_x <span class="token operator">+</span> <span class="token number">0.5f</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> mask_out_height      <span class="token operator">=</span> box_height <span class="token operator">*</span> scale_to_predict_y <span class="token operator">+</span> <span class="token number">0.5f</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span>mask_out_width <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> mask_out_height <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> bytes_of_mask_out <span class="token operator">=</span> mask_out_width <span class="token operator">*</span> mask_out_height<span class="token punctuation">;</span>
    box_mask_output_memory<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>bytes_of_mask_out<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to_gpu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    box_mask_output_memory<span class="token punctuation">.</span><span class="token function">to_gpu</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result_object_box<span class="token punctuation">.</span>seg <span class="token operator">=</span> <span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>InstanceSegmentMap<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>mask_out_width<span class="token punctuation">,</span> mask_out_height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> mask_out_device <span class="token operator">=</span> box_mask_output_memory<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">gpu</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> mask_out_host   <span class="token operator">=</span> result_object_box<span class="token punctuation">.</span>seg<span class="token operator">-&gt;</span>data<span class="token punctuation">;</span>

    <span class="token function">decode_single_mask</span><span class="token punctuation">(</span>left <span class="token operator">*</span> scale_to_predict_x<span class="token punctuation">,</span> top <span class="token operator">*</span> scale_to_predict_y<span class="token punctuation">,</span> mask_weights<span class="token punctuation">,</span>
                        mask_head_predict<span class="token punctuation">,</span> mask_head_output<span class="token operator">-&gt;</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mask_head_output<span class="token operator">-&gt;</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        mask_out_device<span class="token punctuation">,</span> mask_dim<span class="token punctuation">,</span> mask_out_width<span class="token punctuation">,</span> mask_out_height<span class="token punctuation">,</span> stream_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result_object_box<span class="token punctuation">.</span>seg<span class="token operator">-&gt;</span>left <span class="token operator">=</span> left <span class="token operator">*</span> scale_to_predict_x<span class="token punctuation">;</span>
    result_object_box<span class="token punctuation">.</span>seg<span class="token operator">-&gt;</span>top  <span class="token operator">=</span> top  <span class="token operator">*</span> scale_to_predict_y<span class="token punctuation">;</span>
    <span class="token function">checkCudaRuntime</span><span class="token punctuation">(</span><span class="token function">cudaMemcpyAsync</span><span class="token punctuation">(</span>mask_out_host<span class="token punctuation">,</span> mask_out_device<span class="token punctuation">,</span> box_mask_output_memory<span class="token punctuation">.</span><span class="token function">bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cudaMemcpyDeviceToHost<span class="token punctuation">,</span> stream_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    image_based_boxes<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>result_object_box<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在 mask 后处理部分我们先要将 box 边界框从原图上映射到 640x640 的图像上，再从 640x640 的图像上映射到 160x160 的 mask 图像上，然后通过 <strong>row_index</strong> 即 <strong>position</strong> 获取 mask 的权重系数 mask_weights，接着将权重和基础 masks 送入到 <strong>decode_single_mask</strong> 函数生成最终的物体 mask。</p> 
<p><strong>decode_single_mask</strong> 函数最终会调用 CUDA 核函数来对基础 masks 和权重系数进行点积运算，如下所示：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> __global__ <span class="token keyword">void</span> <span class="token function">decode_single_mask_kernel</span><span class="token punctuation">(</span><span class="token keyword">int</span> left<span class="token punctuation">,</span> <span class="token keyword">int</span> top<span class="token punctuation">,</span> <span class="token keyword">float</span> <span class="token operator">*</span>mask_weights<span class="token punctuation">,</span> <span class="token keyword">float</span> <span class="token operator">*</span>mask_predict<span class="token punctuation">,</span> <span class="token keyword">int</span> mask_width<span class="token punctuation">,</span> <span class="token keyword">int</span> mask_height<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>mask_out<span class="token punctuation">,</span> <span class="token keyword">int</span> mask_dim<span class="token punctuation">,</span> <span class="token keyword">int</span> out_width<span class="token punctuation">,</span> <span class="token keyword">int</span> out_height<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// mask_predict to mask_out</span>
    <span class="token comment">// mask_weights @ mask_predict</span>
    <span class="token keyword">int</span> dx <span class="token operator">=</span> blockDim<span class="token punctuation">.</span>x <span class="token operator">*</span> blockIdx<span class="token punctuation">.</span>x <span class="token operator">+</span> threadIdx<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    <span class="token keyword">int</span> dy <span class="token operator">=</span> blockDim<span class="token punctuation">.</span>y <span class="token operator">*</span> blockIdx<span class="token punctuation">.</span>y <span class="token operator">+</span> threadIdx<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dx <span class="token operator">&gt;=</span> out_width <span class="token operator">||</span> dy <span class="token operator">&gt;=</span> out_height<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> sx <span class="token operator">=</span> left <span class="token operator">+</span> dx<span class="token punctuation">;</span>
    <span class="token keyword">int</span> sy <span class="token operator">=</span> top <span class="token operator">+</span> dy<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sx <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> sx <span class="token operator">&gt;=</span> mask_width <span class="token operator">||</span> sy <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> sy <span class="token operator">&gt;=</span> mask_height<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mask_out<span class="token punctuation">[</span>dy <span class="token operator">*</span> out_width <span class="token operator">+</span> dx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">float</span> cumprod <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> ic <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ic <span class="token operator">&lt;</span> mask_dim<span class="token punctuation">;</span> <span class="token operator">++</span>ic<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">float</span> cval <span class="token operator">=</span> mask_predict<span class="token punctuation">[</span><span class="token punctuation">(</span>ic <span class="token operator">*</span> mask_height <span class="token operator">+</span> sy<span class="token punctuation">)</span> <span class="token operator">*</span> mask_width <span class="token operator">+</span> sx<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> wval <span class="token operator">=</span> mask_weights<span class="token punctuation">[</span>ic<span class="token punctuation">]</span><span class="token punctuation">;</span>
        cumprod <span class="token operator">+=</span> cval <span class="token operator">*</span> wval<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">float</span> alpha <span class="token operator">=</span> <span class="token number">1.0f</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1.0f</span> <span class="token operator">+</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token operator">-</span>cumprod<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// sigmoid</span>
    mask_out<span class="token punctuation">[</span>dy <span class="token operator">*</span> out_width <span class="token operator">+</span> dx<span class="token punctuation">]</span> <span class="token operator">=</span> alpha <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>关于 mask 点积运算的具体实现其实就是启动多个线程，每个线程处理一个像素，为了方便理解，博主绘制了一个草图，如下所示：</p> 
<p><img src="https://images2.imgbox.com/4c/9b/VUYuOjyQ_o.png" alt="在这里插入图片描述"></p> 
<p>在核函数中我们启动的线程数为 <strong>out_width * out_height</strong>，每个线程处理目标框内的一个像素，值得注意是 <strong>(sx, sy)</strong> 是相对于 mask_width, mask_height 的索引，我们需要通过 sx 和 sy 去获取基础 masks 中对应的值 cval，接着与权重系数中的值 wval 相乘，然后累加。最后我们会使用 sigmoid 函数将累加结果转换为概率值，并将其映射到 0~255 范围内。而 <strong>(dx, dy)</strong> 是相对于 out_width, out_height 的索引，我们需要通过 dx 和 dy 将最终的 mask 像素值填入到输出的指定位置。</p> 
<h4><a id="4_YOLOv8Seg_998"></a>4. YOLOv8-Seg推理</h4> 
<blockquote> 
 <p>通过上面对 YOLOv8-Seg 的预处理和后处理分析之后，整个推理过程就显而易见了。C++ 上 YOLOv8-Seg 的预处理部分可直接沿用 YOLOv5 的预处理，后处理中的 decode 解码需要简单修改，另外还需要新增关于 mask 处理。</p> 
</blockquote> 
<p>我们在终端执行如下指令即可完成推理（<strong>注意！完整流程博主会在后续内容介绍，这边只是简单演示</strong>）</p> 
<pre><code class="prism language-shell"><span class="token function">make</span> yolo_seg
</code></pre> 
<p>编译图解如下所示：</p> 
<p><img src="https://images2.imgbox.com/26/fb/dkbsZL9p_o.png" alt="在这里插入图片描述"></p> 
<p>推理结果如下图所示：</p> 
<p><img src="https://images2.imgbox.com/58/0a/AZfBFTKm_o.jpg" alt="在这里插入图片描述"></p> 
<p>至此，我们在 C++ 上面完成了 YOLOv8-Seg 的整个推理过程，下面我们将完整的走一遍流程。</p> 
<h3><a id="YOLOv8Seg_1020"></a>三、YOLOv8-Seg部署</h3> 
<blockquote> 
 <p>博主新建了一个仓库 <a href="https://github.com/Melody-Zhou/tensorRT_Pro-YOLOv8">tensorRT_Pro-YOLOv8</a>，该仓库基于 <a href="https://github.com/shouxieai/tensorRT_Pro">shouxieai/tensorRT_Pro</a>，并进行了调整以支持 YOLOv8 的各项任务，目前已支持分类、检测、分割、姿态点估计任务。</p> 
 <p>下面我们就来具体看看如何利用 tensorRT_Pro-YOLOv8 这个 repo 完成 YOLOv8-Seg 的推理。</p> 
</blockquote> 
<h4><a id="1__1026"></a>1. 源码下载</h4> 
<p>tensorRT_Pro-YOLOv8 的代码可以直接从 GitHub 官网上下载，源码下载地址是 <a href="https://github.com/Melody-Zhou/tensorRT_Pro-YOLOv8">https://github.com/Melody-Zhou/tensorRT_Pro-YOLOv8</a>，Linux 下代码克隆指令如下：</p> 
<pre><code class="prism language-shell"><span class="token function">git</span> clone https://github.com/Melody-Zhou/tensorRT_Pro-YOLOv8.git
</code></pre> 
<p>也可手动点击下载，点击右上角的 <code>Code</code> 按键，将代码下载下来。至此整个项目就已经准备好了。也可以点击 <a href="https://pan.baidu.com/s/1yn8rdGVruCkhfHuVhTr8_w" rel="nofollow">here</a> 下载博主准备好的源代码（<strong>注意代码下载于 2023/11/7 日，若有改动请参考最新</strong>）</p> 
<h4><a id="2__1036"></a>2. 环境配置</h4> 
<blockquote> 
 <p>需要使用的软件环境有 <strong>TensorRT、CUDA、cuDNN、OpenCV、Protobuf</strong>，所有软件环境的安装可以参考 <a href="https://blog.csdn.net/qq_40672115/article/details/130255299">Ubuntu20.04软件安装大全</a>，这里不再赘述，需要各位看官自行配置好相关环境😄，外网访问较慢，这里提供下博主安装过程中的软件安装包下载链接 <a href="https://pan.baidu.com/s/1XPe6xd6q1TLDMlVO-84KXA" rel="nofollow">Baidu Drive【pwd:yolo】</a>🚀🚀🚀</p> 
 <p>tensorRT_Pro-YOLOv8 提供 CMakeLists.txt 和 Makefile 两种方式编译，<strong>二者选一即可</strong></p> 
</blockquote> 
<h5><a id="21_CMakeListstxt_1042"></a>2.1 配置CMakeLists.txt</h5> 
<p>主要修改五处</p> 
<p><strong>1.</strong> 修改第 13 行，修改 OpenCV 路径</p> 
<pre><code class="prism language-cpp"><span class="token function">set</span><span class="token punctuation">(</span>OpenCV_DIR   <span class="token string">"/usr/local/include/opencv4"</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>2.</strong> 修改第 15 行，修改 CUDA 路径</p> 
<pre><code class="prism language-cpp"><span class="token function">set</span><span class="token punctuation">(</span>CUDA_TOOLKIT_ROOT_DIR     <span class="token string">"/usr/local/cuda-11.6"</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>3.</strong> 修改第 16 行，修改 cuDNN 路径</p> 
<pre><code class="prism language-cpp"><span class="token function">set</span><span class="token punctuation">(</span>CUDNN_DIR    <span class="token string">"/usr/local/cudnn8.4.0.27-cuda11.6"</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>4.</strong> 修改第 17 行，修改 tensorRT 路径</p> 
<pre><code class="prism language-cpp"><span class="token function">set</span><span class="token punctuation">(</span>TENSORRT_DIR <span class="token string">"/opt/TensorRT-8.4.1.5"</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>5.</strong> 修改第 20 行，修改 protobuf 路径</p> 
<pre><code class="prism language-cpp"><span class="token function">set</span><span class="token punctuation">(</span>PROTOBUF_DIR <span class="token string">"/home/jarvis/protobuf"</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="22_Makefile_1076"></a>2.2 配置Makefile</h5> 
<p>主要修改五处</p> 
<p><strong>1.</strong> 修改第 4 行，修改 protobuf 路径</p> 
<pre><code class="prism language-cpp">lean_protobuf  <span class="token operator">:</span><span class="token operator">=</span> <span class="token operator">/</span>home<span class="token operator">/</span>jarvis<span class="token operator">/</span>protobuf
</code></pre> 
<p><strong>2.</strong> 修改第 5 行，修改 tensorRT 路径</p> 
<pre><code class="prism language-cpp">lean_tensor_rt <span class="token operator">:</span><span class="token operator">=</span> <span class="token operator">/</span>opt<span class="token operator">/</span>TensorRT<span class="token operator">-</span><span class="token number">8.4</span><span class="token punctuation">.</span><span class="token number">1.5</span>
</code></pre> 
<p><strong>3.</strong> 修改第 6 行，修改 cuDNN 路径</p> 
<pre><code class="prism language-cpp">lean_cudnn     <span class="token operator">:</span><span class="token operator">=</span> <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>cudnn8<span class="token punctuation">.</span><span class="token number">4.0</span><span class="token punctuation">.</span><span class="token number">27</span><span class="token operator">-</span>cuda11<span class="token punctuation">.</span><span class="token number">6</span>
</code></pre> 
<p><strong>4.</strong> 修改第 7 行，修改 OpenCV 路径</p> 
<pre><code class="prism language-cpp">lean_opencv    <span class="token operator">:</span><span class="token operator">=</span> <span class="token operator">/</span>usr<span class="token operator">/</span>local
</code></pre> 
<p><strong>5.</strong> 修改第 8 行，修改 CUDA 路径</p> 
<pre><code class="prism language-cpp">lean_cuda      <span class="token operator">:</span><span class="token operator">=</span> <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>cuda<span class="token operator">-</span><span class="token number">11.6</span>
</code></pre> 
<h4><a id="3_ONNX_1110"></a>3. ONNX导出</h4> 
<p>导出细节可以查看之前的内容，这边不再赘述。记得将导出的 ONNX 模型放在 tensorRT_Pro-YOLOv8/workspace 文件夹下。</p> 
<h4><a id="4__1114"></a>4. 源码修改</h4> 
<blockquote> 
 <p>如果你想推理自己训练的模型还需要修改下源代码，YOLOv8-Seg 模型的推理代码主要在 <strong>app_yolo_seg.cpp</strong> 文件中，我们就只需要修改这一个文件中的内容即可，源码修改较简单主要有以下几点：</p> 
</blockquote> 
<ul><li><strong>1.</strong> <strong>app_yolo_seg.cpp 329行，“yolov8s-seg” 修改为你导出的 ONNX 模型名</strong></li><li><strong>2.</strong> <strong>app_yolo_seg.cpp 10行，将 cocolabels 数组中的类别名称修改为你训练的类别</strong></li></ul> 
<p>具体修改示例如下：</p> 
<pre><code class="prism language-cpp"><span class="token function">test</span><span class="token punctuation">(</span>TRT<span class="token double-colon punctuation">::</span>Model<span class="token double-colon punctuation">::</span>FP32<span class="token punctuation">,</span> <span class="token string">"best"</span><span class="token punctuation">)</span>	<span class="token comment">// 修改1 329行"yolov8s-seg"改成"best"</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>cocolabels<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"have_mask"</span><span class="token punctuation">,</span> <span class="token string">"no_mask"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>	<span class="token comment">// 修改2 10行修改检测类别，为自训练模型的类别名称</span>
</code></pre> 
<p>OK！源码修改好了，Makefile 编译文件也搞定了，ONNX 模型也准备好了，现在可以编译运行了，直接在终端执行如下指令即可：</p> 
<pre><code class="prism language-shell"><span class="token function">make</span> yolo_seg
</code></pre> 
<p>编译过程如下所示：</p> 
<p><img src="https://images2.imgbox.com/da/ed/xQ02KPhf_o.png" alt="在这里插入图片描述"></p> 
<p>编译运行成功后在 workspace 文件夹下会生成 engine 文件 <strong>yolov8s-seg.FP32.trtmodel</strong> 用于模型推理，同时它还会生成 <strong>yolov8s-seg_YoloV8-Seg_FP32_result</strong> 文件夹，该文件夹下保存了推理的图片。</p> 
<p>模型推理效果如下图所示：</p> 
<p><img src="https://images2.imgbox.com/b7/e7/e7uKbtkt_o.jpg" alt="在这里插入图片描述"></p> 
<p>OK！以上就是使用 tensorRT_Pro-YOLOv8 推理 YOLOv8-Seg 的大致流程，若有问题，欢迎各位看官批评指正。</p> 
<h3><a id="_1149"></a>结语</h3> 
<blockquote> 
 <p>博主在这里针对 YOLOv8-Seg 的预处理和后处理做了简单分析，同时与大家分享了 C++ 上的实现流程，目的是帮大家理清思路，更好的完成后续的部署工作😄。感谢各位看到最后，创作不易，读后有收获的看官请帮忙点个👍⭐️</p> 
 <p>最后大家如果觉得 <a href="https://github.com/Melody-Zhou/tensorRT_Pro-YOLOv8">tensorRT_Pro-YOLOv8</a> 这个 repo 对你有帮助的话，不妨点个 ⭐️ 支持一波，这对博主来说非常重要，感谢各位🙏。</p> 
</blockquote> 
<h3><a id="_1155"></a>下载链接</h3> 
<ul><li><a href="https://pan.baidu.com/s/1XPe6xd6q1TLDMlVO-84KXA" rel="nofollow">软件安装包下载链接【提取码:yolo】</a>🚀🚀🚀</li><li><a href="https://pan.baidu.com/s/1yn8rdGVruCkhfHuVhTr8_w" rel="nofollow">源代码、权重下载链接【提取码:yolo】</a></li></ul> 
<h3><a id="_1160"></a>参考</h3> 
<ul><li><a href="https://github.com/shouxieai/infer">https://github.com/shouxieai/infer</a></li><li><a href="https://github.com/ultralytics/ultralytics">https://github.com/ultralytics/ultralytics</a></li><li><a href="https://github.com/shouxieai/tensorRT_Pro">https://github.com/shouxieai/tensorRT_Pro</a></li><li><a href="https://github.com/Melody-Zhou/tensorRT_Pro-YOLOv8">https://github.com/Melody-Zhou/tensorRT_Pro-YOLOv8</a></li><li><a href="https://blog.csdn.net/qq_40672115/article/details/127012332">YOLOv5推理详解及预处理高性能实现</a></li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3dd5ed570133e85a01a326aef49a3b17/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">MapStruct复制失败，属性为null，与lombok有关系</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f63590dfdb4577508f944d77550f9e16/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【Helm 及 Chart 快速入门】03、Chart 基本介绍</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>