<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【Java】SpringCloud使用 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【Java】SpringCloud使用" />
<meta property="og:description" content="SpringCloud使用 发起远程调用 根据订单id查询订单的同时，把订单所属的用户信息一起返回，但订单信息和用户信息分属两个不同的模块。
本质上是订单模块向用户模块发起请求，在spring中使用resttemplate发起。
@MapperScan(&#34;cn.itcast.order.mapper&#34;) @SpringBootApplication public class OrderApplication { public static void main(String[] args) { SpringApplication.run(OrderApplication.class, args); } @Bean public RestTemplate restTemplate(){ return new RestTemplate(); } } 搭建Eureka-server 引入依赖 &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-server&lt;/artifactId&gt; &lt;/dependency&gt; 在启动类上添加注解
添加配置文件 server: port: 10086 # 服务端口 spring: application: name: eurekaserver # eureka的服务名称 eureka: client: service-url: # eureka的地址信息 defaultZone: http://127.0.0.1:10086/eureka 注册客户端 引入pom依赖 &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt; &lt;/dependency&gt; 编写配置文件 spring: application: name: userservice eureka: client: service-url: defaultZone: http://127." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/0a87457ccc984dbd7aa7e3aeadc73079/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-01-30T23:04:53+08:00" />
<meta property="article:modified_time" content="2023-01-30T23:04:53+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【Java】SpringCloud使用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="SpringCloud_0"></a>SpringCloud使用</h2> 
<h3><a id="_1"></a>发起远程调用</h3> 
<p>根据订单id查询订单的同时，把订单所属的用户信息一起返回，但订单信息和用户信息分属两个不同的模块。<br> 本质上是订单模块向用户模块发起请求，在spring中使用resttemplate发起。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@MapperScan</span><span class="token punctuation">(</span><span class="token string">"cn.itcast.order.mapper"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderApplication</span> <span class="token punctuation">{<!-- --></span>    
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>       
	<span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">OrderApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>    
	<span class="token punctuation">}</span>     
	<span class="token annotation punctuation">@Bean</span>    
	<span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">restTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>        
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="Eurekaserver_19"></a>搭建Eureka-server</h3> 
<ol><li>引入依赖</li></ol> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>    
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<ol start="2"><li>在启动类上添加注解<br> <img src="https://images2.imgbox.com/e6/f0/gXDsxbjI_o.png" alt="在这里插入图片描述"></li><li>添加配置文件</li></ol> 
<pre><code class="prism language-yml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10086</span> <span class="token comment"># 服务端口</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> eurekaserver <span class="token comment"># eureka的服务名称</span>
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>  <span class="token comment"># eureka的地址信息</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>10086/eureka
</code></pre> 
<h3><a id="_43"></a>注册客户端</h3> 
<ol><li>引入pom依赖</li></ol> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<ol start="2"><li>编写配置文件</li></ol> 
<pre><code class="prism language-yml"><span class="token key atrule">spring</span><span class="token punctuation">:</span> 
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> userservice
    <span class="token key atrule">eureka</span><span class="token punctuation">:</span>  
      <span class="token key atrule">client</span><span class="token punctuation">:</span>    
      <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
        <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>10086/eureka/
</code></pre> 
<ol start="3"><li>修改访问的路径，使用服务名代替ip+端口<br> <img src="https://images2.imgbox.com/22/1b/yaaggtVD_o.png" alt="在这里插入图片描述"></li><li>添加负载均衡注解，使服务可以随机访问</li></ol> 
<p><img src="https://images2.imgbox.com/5c/98/6eNgHItm_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="Ribbon_69"></a>Ribbon负载均衡</h3> 
<h4><a id="Ribbon_70"></a>Ribbon负载均衡规则</h4> 
<p>Ribbon的负载均衡规则是一个叫做IRule的接口来定义的，每一个子接口都是一种规则。</p> 
<p><img src="https://images2.imgbox.com/44/64/j8KnaLPq_o.png" alt="在这里插入图片描述"></p> 
<table><thead><tr><th>内置负载均衡规则类</th><th>规则描述</th></tr></thead><tbody><tr><td>RoundRobinRule</td><td>轮询index，选择index对应位置的Server</td></tr><tr><td>AvailabilityFilteringRule</td><td>检查status里记录的各个服务的状态，过滤掉一直连接失败和高并发的服务器</td></tr><tr><td>WeightedResponseTimeRule</td><td>根据响应时间加权，响应时间越长，权重越小，被选中的可能性越低</td></tr><tr><td>ZoneAvoidanceRule</td><td>默认的负载均衡策略，使用Zone对服务器进行分类，即复合判断Server所在区域的性能和Server的可用性，再对同一个Zone内做轮询</td></tr><tr><td>BestAvailableRule</td><td>选择一个最小的并发请求的server，如果Server被tripped了，则跳过</td></tr><tr><td>RandomRule</td><td>随机选择一个可用的服务器</td></tr><tr><td>RetryRule</td><td>对选定的负载均衡策略加上重试机制，在一个配置时间段内当 选择Server不成功，则一直尝试使用subRule的方式选择一个 可用的Server</td></tr></tbody></table> 
<h4><a id="Ribbon_85"></a>Ribbon核心组件</h4> 
<p><img src="https://images2.imgbox.com/a6/b1/4hato5zh_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="ribbon_88"></a>ribbon的懒加载</h4> 
<p>Ribbon默认是采用懒加载，即第一次访问时才会去创建LoadBalanceClient，请求时间会很长。<br> 而饥饿加载则会在项目启动时创建，降低第一次访问的耗时，通过下面配置开启饥饿加载.<br> <img src="https://images2.imgbox.com/a0/33/B5keg80W_o.png" alt="在这里插入图片描述">,</p> 
<h3><a id="Spring_92"></a>Spring配置刷新</h3> 
<p><a href="https://juejin.cn/post/7054576582093963294" rel="nofollow">参考这篇文章学习了一遍</a></p> 
<p>在修改代码的时候发现了如下问题:</p> 
<p>application.yml配置文件内容如下：</p> 
<pre><code class="prism language-yml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8081</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> userservice
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml
        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.application.name<span class="token punctuation">}</span>
        <span class="token key atrule">group</span><span class="token punctuation">:</span> DEFAULT_GROUP
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>3306/gotest<span class="token punctuation">?</span>useSSL=false<span class="token important">&amp;useUnicode=true&amp;characterEncoding=utf-8&amp;serverTimezone=UTC</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> root
    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123456</span>
    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
  <span class="token key atrule">shardingsphere</span><span class="token punctuation">:</span>
    <span class="token key atrule">sharding</span><span class="token punctuation">:</span>
      <span class="token key atrule">default-database-strategy</span><span class="token punctuation">:</span>
      <span class="token key atrule">tables</span><span class="token punctuation">:</span>
<span class="token comment">#      discovery:</span>
<span class="token comment">#        cluster-name: HZ</span>
<span class="token key atrule">mybatis</span><span class="token punctuation">:</span>
  <span class="token key atrule">type-aliases-package</span><span class="token punctuation">:</span> cn.itcast.user.pojo
  <span class="token key atrule">configuration</span><span class="token punctuation">:</span>
    <span class="token key atrule">map-underscore-to-camel-case</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">level</span><span class="token punctuation">:</span>
    <span class="token key atrule">cn.itcast</span><span class="token punctuation">:</span> debug
  <span class="token key atrule">pattern</span><span class="token punctuation">:</span>
    <span class="token key atrule">dateformat</span><span class="token punctuation">:</span> MM<span class="token punctuation">-</span>dd HH<span class="token punctuation">:</span>mm<span class="token punctuation">:</span>ss<span class="token punctuation">:</span>SSS
<span class="token comment">#eureka:</span>
<span class="token comment">#  client:</span>
<span class="token comment">#    service-url:  # eureka的地址信息</span>
<span class="token comment">#      defaultZone: http://127.0.0.1:10086/eureka</span>
<span class="token key atrule">pattern</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> 本地环境local

<span class="token key atrule">book</span><span class="token punctuation">:</span>
  <span class="token key atrule">author</span><span class="token punctuation">:</span> haha
  <span class="token key atrule">name</span><span class="token punctuation">:</span> springcloudtest
  <span class="token key atrule">category</span><span class="token punctuation">:</span> category01
</code></pre> 
<p>按照dataid的格式: <code>${prefix}-${spring.profiles.active}.${file-extension}</code><br> 此处读取的nacos中配置的dataid应当为userservice.yaml<br> 实际生效的为userservice.properties</p> 
<p><img src="https://images2.imgbox.com/0e/ca/NqnWM0ik_o.png" alt="在这里插入图片描述"><br> 控制台无输出。</p> 
<p><img src="https://images2.imgbox.com/c8/46/xBEGRjNU_o.png" alt="在这里插入图片描述"><br> 修改properties文件</p> 
<p><img src="https://images2.imgbox.com/c8/b8/dGqIMHhq_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/fe/25/Ec2znUY9_o.png" alt="在这里插入图片描述"><br> 控制台有输出，且请求对应有变化。<br> <img src="https://images2.imgbox.com/45/41/TUVHNr3x_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="GateWay11_160"></a>GateWay中的11种路由断言工厂</h3> 
<p><img src="https://images2.imgbox.com/9e/9d/yyrMxKmf_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_164"></a>注意事项</h3> 
<ol><li>nacos默认是以集群方式启动的，安装nacos之后直接启动会报如下错误<br> <img src="https://images2.imgbox.com/11/4b/ERFYfd9E_o.png" alt="在这里插入图片描述"><br> 需要修改启动命令为：<code>startup.cmd -m standalone</code><br> 或者修改<code>startup.cmd/startup.sh</code>:</li></ol> 
<pre><code class="prism language-sh"><span class="token comment"># startup.sh删除</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">MODE</span><span class="token operator">=</span><span class="token string">"cluster"</span>
<span class="token comment"># 调整为</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">MODE</span><span class="token operator">=</span><span class="token string">"standalone"</span>
</code></pre> 
<ol start="2"><li><a href="https://blog.csdn.net/weixin_40815637/article/details/121552227">启动eurekaserver的时候还可能出现这样的错误</a></li></ol> 
<h3><a id="_176"></a>参考资料</h3> 
<ol><li><a href="https://www.bilibili.com/video/BV1LQ4y127n4/?p=14&amp;spm_id_from=333.880.my_history.page.click" rel="nofollow">SpringCloud+RabbitMQ+Docker+Redis+搜索+分布式，系统详解springcloud微服务技术栈课程</a></li><li><a href="https://juejin.cn/post/6933124032447381511" rel="nofollow">SpringCloud 源码系列（9）— 负载均衡Ribbon 之 核心组件与配置</a></li><li><a href="https://juejin.cn/post/7091088205868433421" rel="nofollow">面试官：如何设计一个Ribbon负载均衡组件</a></li><li><a href="https://juejin.cn/post/7149053391652519967" rel="nofollow">SpringCloud实践系列（二）：Ribbon负载均衡</a></li><li><a href="https://nacos.io/zh-cn/docs/quick-start-spring-cloud.html" rel="nofollow">nacos官方文档</a></li><li><a href="https://www.jb51.net/article/254779.htm" rel="nofollow">SpringCloud使用Nacos保存和读取变量的配置方法</a></li><li><a href="https://juejin.cn/post/7049756722285674503" rel="nofollow">Spring Cloud Alibaba（三） 搭建API网关 gateway动态路由</a></li></ol>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/33ada5212f1a753e6ed5e32548e95d60/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【面试大全-缓存】-Redis必修课</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/520f5d435067078e28e806c3d5a89b0a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">CMake中INSTALL_RPATH与BUILD_RPATH问题</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>