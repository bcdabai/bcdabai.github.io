<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>基于FPGA的I2C读写EEPROM - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="基于FPGA的I2C读写EEPROM" />
<meta property="og:description" content="文章目录 前言一、I2C协议1.1 I2C协议简介1.2 物理层1.3 协议层 二、EEPROM2.1 型号及硬件规格2.2 各种读写时序 三、状态机设计四、项目源码：五、实现效果参考资料 前言 本次项目所用开发板FPGA芯片型号为：EP4CE6F17C8 EEPROM芯片型号为：24LC04B UART串口设置为：波特率115200
无校验位
本次项目仅实现了EEPROM的单字节读写。若要实现连续读写可以在下文的EEPROM控制模块设置计数器控制读写字数。
一、I2C协议 1.1 I2C协议简介 I2C总线是Philips公司在八十年代初推出的一种同步、串行、半双工 的总线，主要用于近距离、低速的芯片之间的通信；I2C总线有两根双向的信号线，一根数据线SDA用于收发数据，一根时钟线SCL用于通信双方时钟的同步；I2C总线硬件结构简单，简化了PCB布线，降低了系统成本，提高了系统可靠性，因此在各个领域得到了广泛应用。
I2C是一种多主机多从机总线，通过呼叫应答的方式实现主机与从机间的通信。每一个I2C设备都有一个唯一的7位地址，也就是说同一根线上最多挂载127个I2C从机设备（主机自己占一个地址）。主机有权发起和结束一次通信，从机只能被动呼叫；当总线上有多个主机同时启用总线时，I2C也具备冲突检测和仲裁的功能来防止错误产生。
1.2 物理层 I2C支持多主机多从机
I2C有两条线，一条SCL串行时钟线，用于数据收发同步；一条SDA串行数据线，用来表示数据
每个连接到IIC总线的设备都有一个唯一的地址（ID），主机可以通过地址与不同的从机建立连接
I2C 总线通过上拉电阻接到电源。当 IIC 设备空闲时，设备会输出高阻态，当所有设备都空闲，都输出高阻态时，由上拉电阻把 IIC总线拉成高电平。
I2C总线有仲裁机制：当多个主机同时发起传输时，触发仲裁机制，最终只给一个主机授权。
具有三种传输模式，每种传输模式对应的传输速率不同，具体速率如下：
有些I2C变种还包含了快速&#43;（1Mbit/s）和超高速（5Mbit/s 单向传输）模式。
1.3 协议层 空闲状态：I2C协议规定，在空闲状态下SDA数据线和SCL时钟线均处于高电平。开始位：当SCL处于高电平时，SDA数据线被拉低，则认为检测到起始位，一次数据传输开始。数据传输：同时，协议规定在SCL高电平时期SDA数据线必须保持稳定，在SCL低电平时，SDA才允许发生改变。主机进行数据读写时，I2C协议规定，数据传输时先发送寻址字节，即7位从机地址&#43;0/1。其中0表示主机写，1表示主机读。寻址字节发送完成后才是数据字节应答位：I2C协议规定，主机每次向从机传输1字节数据后，需要接收一次从机的应答信号。0为接收成功；1为接受失败，没有响应。停止位：当SCL为高电平时，数据线SDA拉高，则认为检测到停止位，一次数据传输结束。
二、EEPROM 2.1 型号及硬件规格 EEPROM的全称是“电可擦除可编程只读存储器”，即Electrically Erasable Programmable Read-Only Memory。本次项目中使用的EEPROM型号为24LC04B。
由手册可以看出，24LC04B支持的最大时钟频率为400KHz。
由手册得出该型号EEPROM共有两个Block 每个Block的存储容量为256×8bit。
由手册得出，设备地址为1010xxB0共七位（xx为dont care B0为块选择），1为读操作，0为写操作。
2.2 各种读写时序 单字节写
先写开始位然后写控制字节，从机接收到发应答信号然后写数据地址，从机接收到发应答信号，如果数据地址是2位的话，就继续写数据地址，从机接收到发应答信号然后写数据，从机接收到发应答信号最后写结束位 页写
页节写先开始位然后写控制字节，从机接收到应答信号然后写数据地址，从机接收到应答信号，如果数据地址是2位的话，就继续写数据地址，从机接收到应答信号然后写数据，从机接收到应答信号然后继续写数据，直到写完全部的数据最后是结束位 当前地址读
当前地址读先开始位然后写控制字节，从机接收到应答信号，然后读数据，无应答信号最后结束位 随机地址读和顺序读
随机读先写开始位然后写控制字节，从机接收到应答信号然后dummuy write 虚写，写数据地址，从机接收到应答信号然后开始位然后读控制字节，从机接收到应答信号然后读数据最后结束位 三、状态机设计 I2C接口模块：
EEPROM控制模块：
四、项目源码： EEPROM驱动模块：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/5ad8a3ac514f76f905c4ef0b7beca5b0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-10-08T14:06:22+08:00" />
<meta property="article:modified_time" content="2023-10-08T14:06:22+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">基于FPGA的I2C读写EEPROM</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_1" rel="nofollow">前言</a></li><li><a href="#I2C_8" rel="nofollow">一、I2C协议</a></li><li><ul><li><a href="#11_I2C_9" rel="nofollow">1.1 I2C协议简介</a></li><li><a href="#12__13" rel="nofollow">1.2 物理层</a></li><li><a href="#13__28" rel="nofollow">1.3 协议层</a></li></ul> 
  </li><li><a href="#EEPROM_36" rel="nofollow">二、EEPROM</a></li><li><ul><li><a href="#21__37" rel="nofollow">2.1 型号及硬件规格</a></li><li><a href="#22__49" rel="nofollow">2.2 各种读写时序</a></li></ul> 
  </li><li><a href="#_87" rel="nofollow">三、状态机设计</a></li><li><a href="#_92" rel="nofollow">四、项目源码：</a></li><li><a href="#_1470" rel="nofollow">五、实现效果</a></li><li><a href="#_1474" rel="nofollow">参考资料</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>前言</h2> 
<blockquote> 
 <p>本次项目所用开发板FPGA芯片型号为：EP4CE6F17C8 EEPROM芯片型号为：24LC04B UART串口设置为：波特率115200<br> 无校验位</p> 
 <p>本次项目仅实现了EEPROM的单字节读写。若要实现连续读写可以在下文的EEPROM控制模块设置计数器控制读写字数。</p> 
</blockquote> 
<h2><a id="I2C_8"></a>一、I2C协议</h2> 
<h3><a id="11_I2C_9"></a>1.1 I2C协议简介</h3> 
<p>I2C总线是Philips公司在八十年代初推出的一种<strong>同步、串行、半双工</strong> 的总线，主要用于近距离、低速的芯片之间的通信；I2C总线有两根双向的信号线，一根数据线SDA用于收发数据，一根时钟线SCL用于通信双方时钟的同步；I2C总线硬件结构简单，简化了PCB布线，降低了系统成本，提高了系统可靠性，因此在各个领域得到了广泛应用。</p> 
<p>I2C是一种多主机多从机总线，通过<strong>呼叫应答</strong>的方式实现主机与从机间的通信。每一个I2C设备都有一个唯一的7位地址，也就是说同一根线上最多挂载127个I2C从机设备（主机自己占一个地址）。主机有权发起和结束一次通信，从机只能被动呼叫；当总线上有多个主机同时启用总线时，I2C也具备冲突检测和仲裁的功能来防止错误产生。</p> 
<h3><a id="12__13"></a>1.2 物理层</h3> 
<p><img src="https://images2.imgbox.com/84/61/DJb7rdqr_o.png" alt="在这里插入图片描述"></p> 
<ul><li> <p>I2C支持多主机多从机</p> </li><li> <p>I2C有两条线，一条SCL串行时钟线，用于数据收发同步；一条SDA串行数据线，用来表示数据</p> </li><li> <p>每个连接到IIC总线的设备都有一个唯一的地址（ID），主机可以通过地址与不同的从机建立连接</p> </li><li> <p>I2C 总线通过上拉电阻接到电源。当 IIC 设备空闲时，设备会输出高阻态，当所有设备都空闲，都输出高阻态时，由上拉电阻把 IIC总线拉成高电平。</p> </li><li> <p>I2C总线有仲裁机制：当多个主机同时发起传输时，触发仲裁机制，最终只给一个主机授权。</p> </li><li> <p>具有三种传输模式，每种传输模式对应的传输速率不同，具体速率如下：<br> <img src="https://images2.imgbox.com/4a/c8/StoTEzpa_o.png" alt="在这里插入图片描述"><br> 有些I2C变种还包含了快速+（1Mbit/s）和超高速（5Mbit/s 单向传输）模式。</p> </li></ul> 
<h3><a id="13__28"></a>1.3 协议层</h3> 
<ul><li>空闲状态：I2C协议规定，在空闲状态下SDA数据线和SCL时钟线均处于高电平。</li><li>开始位：当SCL处于高电平时，SDA数据线被拉低，则认为检测到起始位，一次数据传输开始。</li><li>数据传输：同时，协议规定在SCL高电平时期SDA数据线必须保持稳定，在SCL低电平时，SDA才允许发生改变。主机进行数据读写时，I2C协议规定，数据传输时先发送寻址字节，即7位从机地址+0/1。其中0表示主机写，1表示主机读。寻址字节发送完成后才是数据字节</li><li>应答位：I2C协议规定，主机每次向从机传输1字节数据后，需要接收一次从机的应答信号。0为接收成功；1为接受失败，没有响应。</li><li>停止位：当SCL为高电平时，数据线SDA拉高，则认为检测到停止位，一次数据传输结束。<br> <img src="https://images2.imgbox.com/f1/fc/7jY7nf7e_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/61/ff/MRF9rue9_o.png" alt="在这里插入图片描述"></li></ul> 
<h2><a id="EEPROM_36"></a>二、EEPROM</h2> 
<h3><a id="21__37"></a>2.1 型号及硬件规格</h3> 
<p>EEPROM的全称是“电可擦除可编程只读存储器”，即Electrically Erasable Programmable Read-Only Memory。本次项目中使用的EEPROM型号为24LC04B。</p> 
<p><img src="https://images2.imgbox.com/32/1e/oiCJIaQK_o.png" alt="在这里插入图片描述"><br> 由手册可以看出，24LC04B支持的最大时钟频率为400KHz。</p> 
<p><img src="https://images2.imgbox.com/2c/74/FP0Yet0p_o.png" alt="在这里插入图片描述"><br> 由手册得出该型号EEPROM共有两个Block 每个Block的存储容量为256×8bit。<br> <img src="https://images2.imgbox.com/3a/44/Zstv9b1m_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/f2/fe/NaAx9IkH_o.png" alt="在这里插入图片描述"></p> 
<p>由手册得出，设备地址为1010xxB0共七位（xx为dont care B0为块选择），1为读操作，0为写操作。</p> 
<h3><a id="22__49"></a>2.2 各种读写时序</h3> 
<p><strong>单字节写</strong></p> 
<p><img src="https://images2.imgbox.com/8f/7c/4RyNUNF8_o.png" alt="在这里插入图片描述"></p> 
<ul><li>先写开始位</li><li>然后写控制字节，从机接收到发应答信号</li><li>然后写数据地址，从机接收到发应答信号，如果数据地址是2位的话，就继续写数据地址，从机接收到发应答信号</li><li>然后写数据，从机接收到发应答信号</li><li>最后写结束位</li></ul> 
<p><strong>页写</strong></p> 
<p><img src="https://images2.imgbox.com/f0/d3/ilpdtTEF_o.png" alt="在这里插入图片描述"></p> 
<ul><li>页节写先开始位</li><li>然后写控制字节，从机接收到应答信号</li><li>然后写数据地址，从机接收到应答信号，如果数据地址是2位的话，就继续写数据地址，从机接收到应答信号</li><li>然后写数据，从机接收到应答信号</li><li>然后继续写数据，直到写完全部的数据</li><li>最后是结束位</li></ul> 
<p><strong>当前地址读</strong></p> 
<p><img src="https://images2.imgbox.com/38/4d/SzeucTBt_o.png" alt="在这里插入图片描述"></p> 
<ul><li>当前地址读先开始位</li><li>然后写控制字节，从机接收到应答信号，然后读数据，无应答信号</li><li>最后结束位</li></ul> 
<p><strong>随机地址读和顺序读</strong></p> 
<p><img src="https://images2.imgbox.com/17/d7/ti3kqRQi_o.png" alt="在这里插入图片描述"></p> 
<ul><li>随机读先写开始位</li><li>然后写控制字节，从机接收到应答信号</li><li>然后dummuy write 虚写，写数据地址，从机接收到应答信号</li><li>然后开始位</li><li>然后读控制字节，从机接收到应答信号</li><li>然后读数据</li><li>最后结束位</li></ul> 
<h2><a id="_87"></a>三、状态机设计</h2> 
<p>I2C接口模块：<br> <img src="https://images2.imgbox.com/f9/32/eescVLMU_o.jpg" alt="在这里插入图片描述"><br> EEPROM控制模块：<br> <img src="https://images2.imgbox.com/2d/81/ODbL5zep_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_92"></a>四、项目源码：</h2> 
<p><strong>EEPROM驱动模块：</strong></p> 
<pre><code class="prism language-c"><span class="token comment">/**************************************功能介绍***********************************
Date	: 2023年8月28日 
Author	: majiko
Version	: 1.0
Description: eeprom驱动模块
             
             cmd       0      1
             开始位    NO    YES          
             写数据    NO    YES      
             读数据    NO    YES          
             停止位    NO    YES              
             应答位    ACK   NO_ACK
*********************************************************************************/</span>
    
module <span class="token function">eeprom_driver</span><span class="token punctuation">(</span> 
    input       wire            clk         <span class="token punctuation">,</span>
    input       wire            rst_n       <span class="token punctuation">,</span>
    input       wire    <span class="token punctuation">[</span><span class="token number">7</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>   wr_data     <span class="token punctuation">,</span>
    input       wire    <span class="token punctuation">[</span><span class="token number">4</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>   cmd         <span class="token punctuation">,</span>
    input       wire            cmd_vld     <span class="token punctuation">,</span>

    inout       wire            i2c_sda     <span class="token punctuation">,</span>
    output      reg             i2c_scl     <span class="token punctuation">,</span>

    output      wire    <span class="token punctuation">[</span><span class="token number">7</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>   rd_data     <span class="token punctuation">,</span>
    output      wire            rd_data_vld <span class="token punctuation">,</span>
    output      reg             done        <span class="token punctuation">,</span>
    output      reg             rev_ack         
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//内部参数定义</span>
    <span class="token comment">//命令宏定义</span>
    `define START_BIT  <span class="token number">5</span>'b00001
    `define WRITE_BIT  <span class="token number">5</span>'b00010
    `define READ_BIT   <span class="token number">5</span>'b00100
    `define STOP_BIT   <span class="token number">5</span>'b01000
    `define ACK_BIT    <span class="token number">5</span>'b10000

    `define ACK        <span class="token number">0</span>
    `define NO_ACK     <span class="token number">1</span>

    <span class="token comment">//状态定义</span>
    parameter   IDLE    <span class="token operator">=</span> <span class="token number">7</span>'b000_0001<span class="token punctuation">,</span>
                START   <span class="token operator">=</span> <span class="token number">7</span>'b000_0010<span class="token punctuation">,</span>
                WR_DATA <span class="token operator">=</span> <span class="token number">7</span>'b000_0100<span class="token punctuation">,</span>
                R_ACK   <span class="token operator">=</span> <span class="token number">7</span>'b000_1000<span class="token punctuation">,</span>
                STOP    <span class="token operator">=</span> <span class="token number">7</span>'b001_0000<span class="token punctuation">,</span>
                RD_DATA <span class="token operator">=</span> <span class="token number">7</span>'b010_0000<span class="token punctuation">,</span>
                T_ACK   <span class="token operator">=</span> <span class="token number">7</span>'b100_0000<span class="token punctuation">;</span>

    <span class="token comment">//i2c速率以及采样点定义</span>
    parameter   SCL_MAX <span class="token operator">=</span> <span class="token number">50</span>_000_000<span class="token operator">/</span><span class="token number">100</span>_000<span class="token punctuation">;</span> <span class="token comment">//100K速率</span>
    parameter   SCL_1_4 <span class="token operator">=</span> SCL_MAX<span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">;</span>
    parameter   SCL_3_4 <span class="token operator">=</span> SCL_MAX<span class="token operator">*</span><span class="token number">3</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">;</span>


    

<span class="token comment">//内部信号定义</span>
    <span class="token comment">//状态寄存器</span>
    reg         <span class="token punctuation">[</span><span class="token number">6</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>   cstate          <span class="token punctuation">;</span>
    reg         <span class="token punctuation">[</span><span class="token number">6</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>   nstate          <span class="token punctuation">;</span>

    reg         <span class="token punctuation">[</span><span class="token number">7</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>   wr_data_r       <span class="token punctuation">;</span><span class="token comment">//输入数据寄存</span>
    reg         <span class="token punctuation">[</span><span class="token number">4</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>   cmd_r           <span class="token punctuation">;</span><span class="token comment">//输入命令寄存</span>

    reg         <span class="token punctuation">[</span><span class="token number">7</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>   rev_data        <span class="token punctuation">;</span>         

    <span class="token comment">//跳转条件定义</span>
    wire                idle2start      <span class="token punctuation">;</span>
    wire                idle2wr_data    <span class="token punctuation">;</span>
    wire                idle2rd_data    <span class="token punctuation">;</span>
    wire                start2wr_data   <span class="token punctuation">;</span>
    wire                wr_data2r_ack   <span class="token punctuation">;</span>
    wire                r_ack2stop      <span class="token punctuation">;</span>
    wire                r_ack2idle      <span class="token punctuation">;</span>
    wire                stop2idle       <span class="token punctuation">;</span>
    wire                rd_data2t_ack   <span class="token punctuation">;</span>
    wire                t_ack2stop      <span class="token punctuation">;</span>
    wire                t_ack2idle      <span class="token punctuation">;</span>

    <span class="token comment">//bit计数器</span>
    reg			<span class="token punctuation">[</span><span class="token number">3</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>	cnt_bit	   	    <span class="token punctuation">;</span>
    wire				add_cnt_bit	    <span class="token punctuation">;</span>
    wire				end_cnt_bit	    <span class="token punctuation">;</span>
    reg         <span class="token punctuation">[</span><span class="token number">3</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>   bit_max         <span class="token punctuation">;</span>

    <span class="token comment">//i2c分频计数器</span>
    reg			<span class="token punctuation">[</span><span class="token number">8</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>	cnt_scl	   	    <span class="token punctuation">;</span>
    wire				add_cnt_scl	    <span class="token punctuation">;</span>
    wire				end_cnt_scl	    <span class="token punctuation">;</span>

    <span class="token comment">//三态门信号定义</span>
    reg                 sda_out         <span class="token punctuation">;</span>
    wire                sda_in          <span class="token punctuation">;</span>
    reg                 sda_en          <span class="token punctuation">;</span>
    

<span class="token comment">//****************************************************************</span>
<span class="token comment">//--数据寄存 命令寄存</span>
<span class="token comment">//****************************************************************</span>
    always@<span class="token punctuation">(</span>posedge clk or negedge rst_n<span class="token punctuation">)</span>begin
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span>begin
            wr_data_r <span class="token operator">&lt;=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>
        end
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>cmd_vld<span class="token punctuation">)</span>begin
            wr_data_r <span class="token operator">&lt;=</span> wr_data<span class="token punctuation">;</span>
        end
        <span class="token keyword">else</span> begin
            wr_data_r <span class="token operator">&lt;=</span> wr_data_r<span class="token punctuation">;</span>
        end
    end

    always@<span class="token punctuation">(</span>posedge clk or negedge rst_n<span class="token punctuation">)</span>begin
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span>begin
            cmd_r <span class="token operator">&lt;=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>
        end
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>cmd_vld<span class="token punctuation">)</span>begin
            cmd_r <span class="token operator">&lt;=</span> cmd<span class="token punctuation">;</span>
        end
        <span class="token keyword">else</span> begin
            cmd_r <span class="token operator">&lt;=</span> cmd_r<span class="token punctuation">;</span>
        end
    end
<span class="token comment">//****************************************************************</span>
<span class="token comment">//--读写状态机</span>
<span class="token comment">//****************************************************************</span>
    <span class="token comment">//第一段 状态定义</span>
    always @<span class="token punctuation">(</span>posedge clk or negedge rst_n<span class="token punctuation">)</span> begin
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span>begin
            cstate <span class="token operator">&lt;=</span> IDLE<span class="token punctuation">;</span>
        end
        <span class="token keyword">else</span> begin
            cstate <span class="token operator">&lt;=</span> nstate<span class="token punctuation">;</span>
        end
    end

    <span class="token comment">//第二段 状态转移规律</span>
    always@<span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>begin
        <span class="token keyword">case</span> <span class="token punctuation">(</span>cstate<span class="token punctuation">)</span>
            IDLE    <span class="token operator">:</span>   begin
                            <span class="token keyword">if</span><span class="token punctuation">(</span>idle2start<span class="token punctuation">)</span>begin
                                nstate <span class="token operator">=</span> START<span class="token punctuation">;</span>
                            end
                            <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>idle2wr_data<span class="token punctuation">)</span>begin
                                nstate <span class="token operator">=</span> WR_DATA<span class="token punctuation">;</span>
                            end
                            <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>idle2rd_data<span class="token punctuation">)</span>begin
                                nstate <span class="token operator">=</span> RD_DATA<span class="token punctuation">;</span>
                            end
                            <span class="token keyword">else</span> begin
                                nstate <span class="token operator">=</span> cstate<span class="token punctuation">;</span>
                            end
                        end
            START   <span class="token operator">:</span>   begin
                            <span class="token keyword">if</span><span class="token punctuation">(</span>start2wr_data<span class="token punctuation">)</span>begin
                                nstate <span class="token operator">=</span> WR_DATA<span class="token punctuation">;</span>
                            end
                            <span class="token keyword">else</span> begin
                                nstate <span class="token operator">=</span> cstate<span class="token punctuation">;</span>
                            end
                        end
            WR_DATA <span class="token operator">:</span>   begin
                            <span class="token keyword">if</span><span class="token punctuation">(</span>wr_data2r_ack<span class="token punctuation">)</span>begin
                                nstate <span class="token operator">=</span> R_ACK<span class="token punctuation">;</span>
                            end
                            <span class="token keyword">else</span> begin
                                nstate <span class="token operator">=</span> cstate<span class="token punctuation">;</span>
                            end
                        end            
            R_ACK   <span class="token operator">:</span>   begin
                            <span class="token keyword">if</span><span class="token punctuation">(</span>r_ack2stop<span class="token punctuation">)</span>begin
                                nstate <span class="token operator">=</span> STOP<span class="token punctuation">;</span>
                            end
                            <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>r_ack2idle<span class="token punctuation">)</span>begin
                                nstate <span class="token operator">=</span> IDLE<span class="token punctuation">;</span>
                            end
                            <span class="token keyword">else</span> begin
                                nstate <span class="token operator">=</span> cstate<span class="token punctuation">;</span>
                            end
                        end
            STOP    <span class="token operator">:</span>   begin
                            <span class="token keyword">if</span><span class="token punctuation">(</span>stop2idle<span class="token punctuation">)</span>begin
                                nstate <span class="token operator">=</span> IDLE<span class="token punctuation">;</span>
                            end
                            <span class="token keyword">else</span> begin
                                nstate <span class="token operator">=</span> cstate<span class="token punctuation">;</span>
                            end
                        end
            RD_DATA <span class="token operator">:</span>   begin
                            <span class="token keyword">if</span><span class="token punctuation">(</span>rd_data2t_ack<span class="token punctuation">)</span>begin
                                nstate <span class="token operator">=</span> T_ACK<span class="token punctuation">;</span>
                            end
                            <span class="token keyword">else</span> begin
                                nstate <span class="token operator">=</span> cstate<span class="token punctuation">;</span>
                            end
                        end
             T_ACK  <span class="token operator">:</span>   begin
                            <span class="token keyword">if</span><span class="token punctuation">(</span>t_ack2stop<span class="token punctuation">)</span>begin
                                nstate <span class="token operator">=</span> STOP<span class="token punctuation">;</span>
                            end
                            <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>t_ack2idle<span class="token punctuation">)</span>begin
                                nstate <span class="token operator">=</span> IDLE<span class="token punctuation">;</span>
                            end
                            <span class="token keyword">else</span> begin
                                nstate <span class="token operator">=</span> cstate<span class="token punctuation">;</span>
                            end
                        end                                
            <span class="token keyword">default</span><span class="token operator">:</span>    nstate <span class="token operator">=</span> IDLE<span class="token punctuation">;</span>
        endcase
    end

    assign idle2start    <span class="token operator">=</span> <span class="token punctuation">(</span>cstate <span class="token operator">==</span> IDLE<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> cmd_vld <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>cmd <span class="token operator">&amp;</span> `START_BIT<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    assign idle2wr_data  <span class="token operator">=</span> <span class="token punctuation">(</span>cstate <span class="token operator">==</span> IDLE<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> cmd_vld <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>cmd <span class="token operator">&amp;</span> `WRITE_BIT<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    assign idle2rd_data  <span class="token operator">=</span> <span class="token punctuation">(</span>cstate <span class="token operator">==</span> IDLE<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> cmd_vld <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>cmd <span class="token operator">&amp;</span> `READ_BIT<span class="token punctuation">)</span><span class="token punctuation">;</span>

    assign start2wr_data <span class="token operator">=</span> <span class="token punctuation">(</span>cstate <span class="token operator">==</span> START  <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> end_cnt_bit <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>cmd_r <span class="token operator">&amp;</span> `WRITE_BIT<span class="token punctuation">)</span><span class="token punctuation">;</span>

    assign wr_data2r_ack <span class="token operator">=</span> <span class="token punctuation">(</span>cstate <span class="token operator">==</span> WR_DATA<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> end_cnt_bit<span class="token punctuation">;</span>

    assign r_ack2stop    <span class="token operator">=</span> <span class="token punctuation">(</span>cstate <span class="token operator">==</span> R_ACK<span class="token punctuation">)</span>   <span class="token operator">&amp;&amp;</span> end_cnt_bit <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>cmd_r <span class="token operator">&amp;</span> `STOP_BIT<span class="token punctuation">)</span><span class="token punctuation">;</span>       
    assign r_ack2idle    <span class="token operator">=</span> <span class="token punctuation">(</span>cstate <span class="token operator">==</span> R_ACK<span class="token punctuation">)</span>   <span class="token operator">&amp;&amp;</span> end_cnt_bit <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>cmd_r <span class="token operator">&amp;</span> `STOP_BIT<span class="token punctuation">)</span><span class="token punctuation">;</span>

    assign stop2idle     <span class="token operator">=</span> <span class="token punctuation">(</span>cstate <span class="token operator">==</span> STOP   <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> end_cnt_bit<span class="token punctuation">;</span>   
    assign rd_data2t_ack <span class="token operator">=</span> <span class="token punctuation">(</span>cstate <span class="token operator">==</span> RD_DATA<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> end_cnt_bit<span class="token punctuation">;</span>

    assign t_ack2stop    <span class="token operator">=</span> <span class="token punctuation">(</span>cstate <span class="token operator">==</span> T_ACK<span class="token punctuation">)</span>   <span class="token operator">&amp;&amp;</span> end_cnt_bit <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>cmd_r <span class="token operator">&amp;</span> `STOP_BIT<span class="token punctuation">)</span><span class="token punctuation">;</span>   
    assign t_ack2idle    <span class="token operator">=</span> <span class="token punctuation">(</span>cstate <span class="token operator">==</span> T_ACK<span class="token punctuation">)</span>   <span class="token operator">&amp;&amp;</span> end_cnt_bit <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>cmd_r <span class="token operator">&amp;</span> `STOP_BIT<span class="token punctuation">)</span><span class="token punctuation">;</span>   

<span class="token comment">//****************************************************************</span>
<span class="token comment">//--i2c时钟分频</span>
<span class="token comment">//****************************************************************</span>
    
    always @<span class="token punctuation">(</span>posedge clk or negedge rst_n<span class="token punctuation">)</span>begin 
       <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span>begin
            cnt_scl <span class="token operator">&lt;=</span> 'd0<span class="token punctuation">;</span>
        end 
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>add_cnt_scl<span class="token punctuation">)</span>begin 
            <span class="token keyword">if</span><span class="token punctuation">(</span>end_cnt_scl<span class="token punctuation">)</span>begin 
                cnt_scl <span class="token operator">&lt;=</span> 'd0<span class="token punctuation">;</span>
            end
            <span class="token keyword">else</span> begin 
                cnt_scl <span class="token operator">&lt;=</span> cnt_scl <span class="token operator">+</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
            end 
        end
    end 
    
    assign add_cnt_scl <span class="token operator">=</span> cstate <span class="token operator">!=</span> IDLE<span class="token punctuation">;</span>
    assign end_cnt_scl <span class="token operator">=</span> add_cnt_scl <span class="token operator">&amp;&amp;</span> cnt_scl <span class="token operator">==</span> SCL_MAX <span class="token operator">-</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>

    <span class="token comment">//assign i2c_scl = (cnt_scl == (SCL_MAX - 1'b1) &gt;&gt; 1'b1 || stop2idle) ? 1'b1 : 1'b0;</span>
    
    always@<span class="token punctuation">(</span>posedge clk or negedge rst_n<span class="token punctuation">)</span>begin
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span>begin
            i2c_scl <span class="token operator">&lt;=</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
        end
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>cnt_scl <span class="token operator">==</span> <span class="token punctuation">(</span>SCL_MAX <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">1</span>'b1 <span class="token operator">||</span> stop2idle<span class="token punctuation">)</span>begin
            i2c_scl <span class="token operator">&lt;=</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
        end
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>end_cnt_scl<span class="token punctuation">)</span>begin
            i2c_scl <span class="token operator">&lt;=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>
        end
        <span class="token keyword">else</span> begin
            i2c_scl <span class="token operator">&lt;=</span> i2c_scl<span class="token punctuation">;</span>
        end
    end
    
<span class="token comment">//****************************************************************</span>
<span class="token comment">//--bit计数器</span>
<span class="token comment">//****************************************************************</span>
    
    always @<span class="token punctuation">(</span>posedge clk or negedge rst_n<span class="token punctuation">)</span>begin 
       <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span>begin
            cnt_bit <span class="token operator">&lt;=</span> 'd0<span class="token punctuation">;</span>
        end 
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>add_cnt_bit<span class="token punctuation">)</span>begin 
            <span class="token keyword">if</span><span class="token punctuation">(</span>end_cnt_bit<span class="token punctuation">)</span>begin 
                cnt_bit <span class="token operator">&lt;=</span> 'd0<span class="token punctuation">;</span>
            end
            <span class="token keyword">else</span> begin 
                cnt_bit <span class="token operator">&lt;=</span> cnt_bit <span class="token operator">+</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
            end 
        end
    end 
    
    assign add_cnt_bit <span class="token operator">=</span> end_cnt_scl<span class="token punctuation">;</span>
    assign end_cnt_bit <span class="token operator">=</span> add_cnt_bit <span class="token operator">&amp;&amp;</span> cnt_bit <span class="token operator">==</span> bit_max <span class="token operator">-</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
    
    always @<span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>begin
        <span class="token keyword">if</span><span class="token punctuation">(</span>cstate <span class="token operator">==</span> WR_DATA <span class="token operator">||</span> cstate <span class="token operator">==</span> RD_DATA<span class="token punctuation">)</span>begin
            bit_max <span class="token operator">=</span> 'd8<span class="token punctuation">;</span>
        end
        <span class="token keyword">else</span> begin
            bit_max <span class="token operator">=</span> 'd1<span class="token punctuation">;</span>
        end
    end

<span class="token comment">//****************************************************************</span>
<span class="token comment">//--三态门控制</span>
<span class="token comment">//****************************************************************</span>
    assign sda_in <span class="token operator">=</span> i2c_sda<span class="token punctuation">;</span>
    assign i2c_sda <span class="token operator">=</span> sda_en <span class="token operator">?</span> sda_out <span class="token operator">:</span> <span class="token number">1</span>'bz<span class="token punctuation">;</span>

    <span class="token comment">//使能信号开启</span>
    always @<span class="token punctuation">(</span>posedge clk or negedge rst_n<span class="token punctuation">)</span>begin
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span>begin
            sda_en <span class="token operator">&lt;=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>
        end
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>wr_data2r_ack <span class="token operator">||</span> stop2idle <span class="token operator">||</span> idle2rd_data<span class="token punctuation">)</span>begin
            sda_en <span class="token operator">&lt;=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>
        end
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>idle2wr_data <span class="token operator">||</span> idle2start <span class="token operator">||</span> rd_data2t_ack <span class="token operator">||</span> r_ack2stop <span class="token operator">||</span> start2wr_data<span class="token punctuation">)</span>begin
            sda_en <span class="token operator">&lt;=</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
        end
        <span class="token keyword">else</span> begin
            sda_en <span class="token operator">&lt;=</span> sda_en<span class="token punctuation">;</span>
        end
    end
<span class="token comment">//****************************************************************</span>
<span class="token comment">//--数据发送</span>
<span class="token comment">//****************************************************************</span>
    always@<span class="token punctuation">(</span>posedge clk or negedge rst_n<span class="token punctuation">)</span>begin
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span>begin
            sda_out <span class="token operator">&lt;=</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
        end
        <span class="token keyword">else</span> begin
            <span class="token keyword">case</span><span class="token punctuation">(</span>cstate<span class="token punctuation">)</span>
                IDLE    <span class="token operator">:</span>   sda_out <span class="token operator">&lt;=</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
                START   <span class="token operator">:</span>   begin
                                <span class="token keyword">if</span><span class="token punctuation">(</span>cnt_scl <span class="token operator">==</span> SCL_1_4<span class="token punctuation">)</span>begin
                                    sda_out <span class="token operator">&lt;=</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
                                end
                                <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>cnt_scl <span class="token operator">==</span> SCL_3_4<span class="token punctuation">)</span>begin
                                    sda_out <span class="token operator">&lt;=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>
                                end
                                <span class="token keyword">else</span> begin
                                    sda_out <span class="token operator">&lt;=</span> sda_out<span class="token punctuation">;</span>
                                end
                            end
                WR_DATA <span class="token operator">:</span>   begin
                                <span class="token keyword">if</span><span class="token punctuation">(</span>cnt_scl <span class="token operator">==</span> SCL_1_4<span class="token punctuation">)</span>begin
                                    sda_out <span class="token operator">&lt;=</span> wr_data_r<span class="token punctuation">[</span><span class="token number">7</span><span class="token operator">-</span>cnt_bit<span class="token punctuation">]</span><span class="token punctuation">;</span>
                                end
                                <span class="token keyword">else</span> begin
                                    sda_out <span class="token operator">&lt;=</span> sda_out<span class="token punctuation">;</span>
                                end
                            end
                T_ACK   <span class="token operator">:</span>   begin
                                <span class="token keyword">if</span><span class="token punctuation">(</span>cnt_scl <span class="token operator">==</span> SCL_1_4<span class="token punctuation">)</span>begin
                                    <span class="token keyword">if</span><span class="token punctuation">(</span>cmd <span class="token operator">&amp;</span> `ACK_BIT<span class="token punctuation">)</span>begin
                                        sda_out <span class="token operator">&lt;=</span> `NO_ACK<span class="token punctuation">;</span>
                                    end
                                    <span class="token keyword">else</span> begin
                                        sda_out <span class="token operator">&lt;=</span> `ACK<span class="token punctuation">;</span>
                                    end
                                end
                                <span class="token keyword">else</span> begin
                                    sda_out <span class="token operator">&lt;=</span> sda_out<span class="token punctuation">;</span>
                                end
                            end
                STOP    <span class="token operator">:</span>   begin
                                <span class="token keyword">if</span><span class="token punctuation">(</span>cnt_scl <span class="token operator">==</span> SCL_1_4<span class="token punctuation">)</span>begin
                                    sda_out <span class="token operator">&lt;=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>
                                end
                                <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>cnt_scl <span class="token operator">==</span> SCL_3_4<span class="token punctuation">)</span>begin
                                    sda_out <span class="token operator">&lt;=</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
                                end
                                <span class="token keyword">else</span> begin
                                    sda_out <span class="token operator">&lt;=</span> sda_out<span class="token punctuation">;</span>
                                end
                            end
                <span class="token keyword">default</span> <span class="token operator">:</span>   sda_out <span class="token operator">&lt;=</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
            endcase
        end
    end

<span class="token comment">//****************************************************************</span>
<span class="token comment">//--数据接收</span>
<span class="token comment">//****************************************************************</span>

    always @<span class="token punctuation">(</span>posedge clk or negedge rst_n<span class="token punctuation">)</span>begin
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span>begin
            rev_ack <span class="token operator">&lt;=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>
            rev_data <span class="token operator">&lt;=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>
        end
        <span class="token keyword">else</span> begin
            <span class="token keyword">case</span><span class="token punctuation">(</span>cstate<span class="token punctuation">)</span>
            R_ACK   <span class="token operator">:</span>   begin
                            <span class="token keyword">if</span><span class="token punctuation">(</span>cnt_scl <span class="token operator">==</span> SCL_3_4<span class="token punctuation">)</span>begin
                                rev_ack <span class="token operator">&lt;=</span> sda_in<span class="token punctuation">;</span>
                            end
                            <span class="token keyword">else</span> begin
                                rev_ack <span class="token operator">&lt;=</span> rev_ack<span class="token punctuation">;</span>
                            end
                        end
            RD_DATA <span class="token operator">:</span>   begin
                            <span class="token keyword">if</span><span class="token punctuation">(</span>cnt_scl <span class="token operator">==</span> SCL_3_4<span class="token punctuation">)</span>begin
                                rev_data<span class="token punctuation">[</span><span class="token number">7</span><span class="token operator">-</span>cnt_bit<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> sda_in<span class="token punctuation">;</span>
                            end
                            <span class="token keyword">else</span> begin
                                rev_data <span class="token operator">&lt;=</span> rev_data<span class="token punctuation">;</span>
                            end
                        end
            <span class="token keyword">default</span> <span class="token operator">:</span>   <span class="token punctuation">;</span>
            endcase
        end
    end

<span class="token comment">//****************************************************************</span>
<span class="token comment">//--接口输出</span>
<span class="token comment">//****************************************************************</span>
   
    always @<span class="token punctuation">(</span>posedge clk or negedge rst_n<span class="token punctuation">)</span>begin
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span>begin
            done <span class="token operator">&lt;=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>
        end
        <span class="token keyword">else</span> begin
            done <span class="token operator">&lt;=</span> t_ack2idle <span class="token operator">||</span> r_ack2idle <span class="token operator">||</span> stop2idle<span class="token punctuation">;</span>
        end
    end

    <span class="token comment">//assign done = (t_ack2idle || r_ack2idle || stop2idle) ? 1'b1 : 1'b0;</span>

    assign rd_data <span class="token operator">=</span> <span class="token punctuation">(</span>t_ack2idle <span class="token operator">||</span> t_ack2stop<span class="token punctuation">)</span> <span class="token operator">?</span> rev_data <span class="token operator">:</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>
    assign rd_data_vld <span class="token operator">=</span> t_ack2idle <span class="token operator">||</span> t_ack2stop<span class="token punctuation">;</span>



endmodule
</code></pre> 
<p><strong>EEPROM控制模块：</strong></p> 
<pre><code class="prism language-c"><span class="token comment">/**************************************功能介绍***********************************
Date	: 2023年8月30日 
Author	: majiko
Version	: 1.0
Description: EEPROM控制模块
*********************************************************************************/</span>
    
module eeprom_control
#<span class="token punctuation">(</span>
    parameter ADDR_BIT <span class="token operator">=</span> <span class="token number">8</span>              <span class="token comment">//从机寄存器地址</span>
<span class="token punctuation">)</span>
<span class="token punctuation">(</span>
    input       wire                        clk             <span class="token punctuation">,</span>
    input       wire                        rst_n           <span class="token punctuation">,</span>
    input       wire    <span class="token punctuation">[</span><span class="token number">6</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>               device_id       <span class="token punctuation">,</span><span class="token comment">//i2c从机设备地址</span>
    input       wire                        wr_req          <span class="token punctuation">,</span>
    input       wire                        rd_req          <span class="token punctuation">,</span>
    input       wire    <span class="token punctuation">[</span>ADDR_BIT <span class="token operator">-</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>    reg_addr        <span class="token punctuation">,</span><span class="token comment">//配置寄存器地址</span>
    input       wire                        reg_addr_vld    <span class="token punctuation">,</span>
    input       wire    <span class="token punctuation">[</span><span class="token number">7</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>               wr_data         <span class="token punctuation">,</span>
    input       wire                        wr_data_vld     <span class="token punctuation">,</span>

    output      wire    <span class="token punctuation">[</span><span class="token number">7</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>               rd_data         <span class="token punctuation">,</span>
    output      wire                        rd_data_vld     <span class="token punctuation">,</span>
    output      wire                        ready           <span class="token punctuation">,</span>

    output      wire                        i2c_scl         <span class="token punctuation">,</span>
    inout       wire                        i2c_sda          
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//参数定义</span>
    <span class="token comment">//命令宏定义</span>
    `define START_BIT <span class="token number">5</span>'b00001
    `define WRITE_BIT <span class="token number">5</span>'b00010
    `define READ_BIT  <span class="token number">5</span>'b00100
    `define STOP_BIT  <span class="token number">5</span>'b01000
    `define ACK_BIT   <span class="token number">5</span>'b10000

    parameter   IDLE    <span class="token operator">=</span> <span class="token number">6</span>'b000_001<span class="token punctuation">,</span>
                WR_REQ  <span class="token operator">=</span> <span class="token number">6</span>'b000_010<span class="token punctuation">,</span>
                WR_WAIT <span class="token operator">=</span> <span class="token number">6</span>'b000_100<span class="token punctuation">,</span>
                RD_REQ  <span class="token operator">=</span> <span class="token number">6</span>'b001_000<span class="token punctuation">,</span>
                RD_WAIT <span class="token operator">=</span> <span class="token number">6</span>'b010_000<span class="token punctuation">,</span>
                DONE    <span class="token operator">=</span> <span class="token number">6</span>'b100_000<span class="token punctuation">;</span>

    parameter   WR_CTRL_BYTE <span class="token operator">=</span> <span class="token number">8</span>'b1010_0000<span class="token punctuation">,</span>
                RD_CTRL_BYTE <span class="token operator">=</span> <span class="token number">8</span>'b1010_0001<span class="token punctuation">;</span>

<span class="token comment">//内部信号定义</span>
    <span class="token comment">//状态寄存器</span>
    reg         <span class="token punctuation">[</span><span class="token number">5</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>   cstate          <span class="token punctuation">;</span>
    reg         <span class="token punctuation">[</span><span class="token number">5</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>   nstate          <span class="token punctuation">;</span>

    <span class="token comment">//跳转条件定义</span>
    wire                idle2rd_req     <span class="token punctuation">;</span>
    wire                idle2wr_req     <span class="token punctuation">;</span>
    wire                wr_req2wr_wait  <span class="token punctuation">;</span>
    wire                wr_wait2wr_req  <span class="token punctuation">;</span>
    wire                wr_wait2done    <span class="token punctuation">;</span>
    wire                rd_req2rd_wait  <span class="token punctuation">;</span>
    wire                rd_wait2done    <span class="token punctuation">;</span>
    wire                rd_wait2rd_req  <span class="token punctuation">;</span>
    wire                done2idle       <span class="token punctuation">;</span>

    wire                done            <span class="token punctuation">;</span>


    reg         <span class="token punctuation">[</span><span class="token number">4</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>   cmd             <span class="token punctuation">;</span>
    reg                 cmd_vld         <span class="token punctuation">;</span>
    reg         <span class="token punctuation">[</span><span class="token number">7</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>   op_wr_data      <span class="token punctuation">;</span>

    reg         <span class="token punctuation">[</span><span class="token number">7</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>   addr_r          <span class="token punctuation">;</span>
    reg         <span class="token punctuation">[</span><span class="token number">7</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>   wr_data_r       <span class="token punctuation">;</span>

    <span class="token comment">//字节计数器</span>
    reg			<span class="token punctuation">[</span><span class="token number">2</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>	cnt_byte	   	<span class="token punctuation">;</span>
    wire				add_cnt_byte	<span class="token punctuation">;</span>
    wire				end_cnt_byte	<span class="token punctuation">;</span>
    reg         <span class="token punctuation">[</span><span class="token number">2</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>   byte_mawr_addr  <span class="token punctuation">;</span>

<span class="token comment">//****************************************************************</span>
<span class="token comment">//--寄存输入数据</span>
<span class="token comment">//****************************************************************</span>
    always @<span class="token punctuation">(</span>posedge clk or negedge rst_n<span class="token punctuation">)</span>begin
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span>begin
            addr_r <span class="token operator">&lt;=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>
        end
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>reg_addr_vld<span class="token punctuation">)</span>begin
            addr_r <span class="token operator">&lt;=</span> reg_addr<span class="token punctuation">;</span>
        end
        <span class="token keyword">else</span> begin
            addr_r <span class="token operator">&lt;=</span> addr_r<span class="token punctuation">;</span>
        end
    end

    always @<span class="token punctuation">(</span>posedge clk or negedge rst_n<span class="token punctuation">)</span>begin
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span>begin
            wr_data_r <span class="token operator">&lt;=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>
        end
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>wr_data_vld<span class="token punctuation">)</span>begin
            wr_data_r <span class="token operator">&lt;=</span> wr_data<span class="token punctuation">;</span>
        end
        <span class="token keyword">else</span> begin
            wr_data_r <span class="token operator">&lt;=</span> wr_data_r<span class="token punctuation">;</span>
        end
    end

<span class="token comment">//****************************************************************</span>
<span class="token comment">//--状态机</span>
<span class="token comment">//****************************************************************</span>
    always @<span class="token punctuation">(</span>posedge clk or negedge rst_n<span class="token punctuation">)</span>begin
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span>begin
            cstate <span class="token operator">&lt;=</span> IDLE<span class="token punctuation">;</span>
        end
        <span class="token keyword">else</span> begin
            cstate <span class="token operator">&lt;=</span> nstate<span class="token punctuation">;</span>
        end
    end

    always @<span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>begin
        <span class="token keyword">case</span><span class="token punctuation">(</span>cstate<span class="token punctuation">)</span>
            IDLE    <span class="token operator">:</span>   begin
                            <span class="token keyword">if</span><span class="token punctuation">(</span>idle2rd_req<span class="token punctuation">)</span>begin
                                nstate <span class="token operator">=</span> RD_REQ<span class="token punctuation">;</span>
                            end
                            <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>idle2wr_req<span class="token punctuation">)</span>begin
                                nstate <span class="token operator">=</span> WR_REQ<span class="token punctuation">;</span>
                            end
                            <span class="token keyword">else</span> begin
                                nstate <span class="token operator">=</span> cstate<span class="token punctuation">;</span>
                            end
                        end
            WR_REQ  <span class="token operator">:</span>   begin
                            <span class="token keyword">if</span><span class="token punctuation">(</span>wr_req2wr_wait<span class="token punctuation">)</span>begin
                                nstate <span class="token operator">=</span> WR_WAIT<span class="token punctuation">;</span>
                            end
                            <span class="token keyword">else</span> begin
                                nstate <span class="token operator">=</span> cstate<span class="token punctuation">;</span>
                            end
                        end
            WR_WAIT <span class="token operator">:</span>   begin
                            <span class="token keyword">if</span><span class="token punctuation">(</span>wr_wait2done<span class="token punctuation">)</span>begin
                                nstate <span class="token operator">=</span> DONE<span class="token punctuation">;</span>
                            end
                            <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>wr_wait2wr_req<span class="token punctuation">)</span>begin
                                nstate <span class="token operator">=</span> WR_REQ<span class="token punctuation">;</span>
                            end
                            <span class="token keyword">else</span> begin
                                nstate <span class="token operator">=</span> cstate<span class="token punctuation">;</span>
                            end
                        end
            RD_REQ  <span class="token operator">:</span>   begin
                            <span class="token keyword">if</span><span class="token punctuation">(</span>rd_req2rd_wait<span class="token punctuation">)</span>begin
                                nstate <span class="token operator">=</span> RD_WAIT<span class="token punctuation">;</span>
                            end
                            <span class="token keyword">else</span> begin
                                nstate <span class="token operator">=</span> cstate<span class="token punctuation">;</span>
                            end
                        end
            RD_WAIT <span class="token operator">:</span>   begin
                            <span class="token keyword">if</span><span class="token punctuation">(</span>rd_wait2done<span class="token punctuation">)</span>begin
                                nstate <span class="token operator">=</span> DONE<span class="token punctuation">;</span>
                            end
                            <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>rd_wait2rd_req<span class="token punctuation">)</span>begin
                                nstate <span class="token operator">=</span> RD_REQ<span class="token punctuation">;</span>
                            end
                            <span class="token keyword">else</span> begin
                                nstate <span class="token operator">=</span> cstate<span class="token punctuation">;</span>
                            end
                        end
            DONE    <span class="token operator">:</span>   begin
                            <span class="token keyword">if</span><span class="token punctuation">(</span>done2idle<span class="token punctuation">)</span>begin
                                nstate <span class="token operator">=</span> IDLE<span class="token punctuation">;</span>
                            end
                            <span class="token keyword">else</span> begin
                                nstate <span class="token operator">=</span> cstate<span class="token punctuation">;</span>
                            end
                        end
            <span class="token keyword">default</span> <span class="token operator">:</span>   <span class="token punctuation">;</span>
        endcase
    end


assign idle2rd_req    <span class="token operator">=</span> cstate <span class="token operator">==</span> IDLE <span class="token operator">&amp;&amp;</span> rd_req<span class="token punctuation">;</span>
assign idle2wr_req    <span class="token operator">=</span> cstate <span class="token operator">==</span> IDLE <span class="token operator">&amp;&amp;</span> wr_req<span class="token punctuation">;</span>

assign wr_req2wr_wait <span class="token operator">=</span> cstate <span class="token operator">==</span> WR_REQ  <span class="token operator">&amp;&amp;</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
assign wr_wait2wr_req <span class="token operator">=</span> cstate <span class="token operator">==</span> WR_WAIT <span class="token operator">&amp;&amp;</span> done<span class="token punctuation">;</span>
assign wr_wait2done   <span class="token operator">=</span> cstate <span class="token operator">==</span> WR_WAIT <span class="token operator">&amp;&amp;</span> end_cnt_byte<span class="token punctuation">;</span>

assign rd_req2rd_wait <span class="token operator">=</span> cstate <span class="token operator">==</span> RD_REQ  <span class="token operator">&amp;&amp;</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
assign rd_wait2done   <span class="token operator">=</span> cstate <span class="token operator">==</span> RD_WAIT <span class="token operator">&amp;&amp;</span> end_cnt_byte<span class="token punctuation">;</span>
assign rd_wait2rd_req <span class="token operator">=</span> cstate <span class="token operator">==</span> RD_WAIT <span class="token operator">&amp;&amp;</span> done<span class="token punctuation">;</span>

assign done2idle      <span class="token operator">=</span> cstate <span class="token operator">==</span> DONE <span class="token operator">&amp;&amp;</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>

<span class="token comment">//****************************************************************</span>
<span class="token comment">//--字节计数器</span>
<span class="token comment">//****************************************************************</span>
    
    always @<span class="token punctuation">(</span>posedge clk or negedge rst_n<span class="token punctuation">)</span>begin 
       <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span>begin
            cnt_byte <span class="token operator">&lt;=</span> 'd0<span class="token punctuation">;</span>
        end 
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>add_cnt_byte<span class="token punctuation">)</span>begin 
            <span class="token keyword">if</span><span class="token punctuation">(</span>end_cnt_byte<span class="token punctuation">)</span>begin 
                cnt_byte <span class="token operator">&lt;=</span> 'd0<span class="token punctuation">;</span>
            end
            <span class="token keyword">else</span> begin 
                cnt_byte <span class="token operator">&lt;=</span> cnt_byte <span class="token operator">+</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
            end 
        end
    end 
    
    assign add_cnt_byte <span class="token operator">=</span> done<span class="token punctuation">;</span>
    assign end_cnt_byte <span class="token operator">=</span> add_cnt_byte <span class="token operator">&amp;&amp;</span> cnt_byte <span class="token operator">==</span> byte_mawr_addr <span class="token operator">-</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
    
    always @<span class="token punctuation">(</span>posedge clk or negedge rst_n<span class="token punctuation">)</span> begin
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span>begin
            byte_mawr_addr <span class="token operator">&lt;=</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
        end
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>wr_req<span class="token punctuation">)</span>begin
            byte_mawr_addr <span class="token operator">&lt;=</span> 'd3<span class="token punctuation">;</span>
        end
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>rd_req<span class="token punctuation">)</span>begin
            byte_mawr_addr <span class="token operator">&lt;=</span> 'd4<span class="token punctuation">;</span>
        end
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>end_cnt_byte<span class="token punctuation">)</span>begin
            byte_mawr_addr <span class="token operator">&lt;=</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
        end
        <span class="token keyword">else</span> begin
            byte_mawr_addr <span class="token operator">&lt;=</span> byte_mawr_addr<span class="token punctuation">;</span>
        end
    end

<span class="token comment">//****************************************************************</span>
<span class="token comment">//--接口模块控制</span>
<span class="token comment">//****************************************************************</span>

    task TX<span class="token punctuation">;</span>
        input           task_cmd_vld<span class="token punctuation">;</span>
        input   <span class="token punctuation">[</span><span class="token number">4</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>   task_cmd<span class="token punctuation">;</span>
        input   <span class="token punctuation">[</span><span class="token number">7</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>   task_wr_data<span class="token punctuation">;</span>
        begin
            cmd_vld    <span class="token operator">=</span> task_cmd_vld<span class="token punctuation">;</span>
            cmd        <span class="token operator">=</span> task_cmd<span class="token punctuation">;</span>
            op_wr_data <span class="token operator">=</span> task_wr_data<span class="token punctuation">;</span>
        end
    endtask

    always @<span class="token punctuation">(</span>posedge clk or negedge rst_n<span class="token punctuation">)</span> begin
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span>begin
            <span class="token function">TX</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token char">'h0,8'</span>h00<span class="token punctuation">)</span><span class="token punctuation">;</span>
        end
        <span class="token keyword">else</span> begin
            <span class="token keyword">case</span><span class="token punctuation">(</span>cstate<span class="token punctuation">)</span>
                RD_REQ  <span class="token operator">:</span>   <span class="token keyword">case</span><span class="token punctuation">(</span>cnt_byte<span class="token punctuation">)</span>
                                <span class="token number">0</span>   <span class="token operator">:</span>   <span class="token function">TX</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">(</span>`START_BIT <span class="token operator">|</span> `WRITE_BIT<span class="token punctuation">)</span><span class="token punctuation">,</span>WR_CTRL_BYTE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//写控制字节</span>
                                <span class="token number">1</span>   <span class="token operator">:</span>   <span class="token function">TX</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">(</span>`WRITE_BIT<span class="token punctuation">)</span><span class="token punctuation">,</span>addr_r<span class="token punctuation">[</span><span class="token number">7</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//写地址</span>
                                <span class="token number">2</span>   <span class="token operator">:</span>   <span class="token function">TX</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">(</span>`START_BIT <span class="token operator">|</span> `WRITE_BIT<span class="token punctuation">)</span><span class="token punctuation">,</span>RD_CTRL_BYTE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读控制字节</span>
                                <span class="token number">3</span>   <span class="token operator">:</span>   <span class="token function">TX</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">(</span>`ACK_BIT<span class="token operator">|</span> `READ_BIT <span class="token operator">|</span> `STOP_BIT<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">8</span>'h00<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读数据</span>
                                <span class="token keyword">default</span> <span class="token operator">:</span>   <span class="token function">TX</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>cmd<span class="token punctuation">,</span>op_wr_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            endcase
                WR_REQ  <span class="token operator">:</span>   <span class="token keyword">case</span><span class="token punctuation">(</span>cnt_byte<span class="token punctuation">)</span>
                                <span class="token number">0</span>   <span class="token operator">:</span>   <span class="token function">TX</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">(</span>`START_BIT <span class="token operator">|</span> `WRITE_BIT<span class="token punctuation">)</span><span class="token punctuation">,</span>WR_CTRL_BYTE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//写控制字节</span>
                                <span class="token number">1</span>   <span class="token operator">:</span>   <span class="token function">TX</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">(</span>`WRITE_BIT<span class="token punctuation">)</span><span class="token punctuation">,</span>addr_r<span class="token punctuation">[</span><span class="token number">7</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//写地址</span>
                                <span class="token number">2</span>   <span class="token operator">:</span>   <span class="token function">TX</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">(</span>`WRITE_BIT <span class="token operator">|</span> `STOP_BIT<span class="token punctuation">)</span><span class="token punctuation">,</span>wr_data_r<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//写数据</span>
                                <span class="token keyword">default</span> <span class="token operator">:</span>   <span class="token function">TX</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>cmd<span class="token punctuation">,</span>op_wr_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            endcase
                <span class="token keyword">default</span> <span class="token operator">:</span>   <span class="token function">TX</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>cmd<span class="token punctuation">,</span>op_wr_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            endcase
        end
    end


    eeprom_driver <span class="token function">u_eeprom_driver</span><span class="token punctuation">(</span> 
        <span class="token comment">/*input       wire            */</span><span class="token punctuation">.</span><span class="token function">clk</span>         <span class="token punctuation">(</span>clk           <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/*input       wire            */</span><span class="token punctuation">.</span><span class="token function">rst_n</span>       <span class="token punctuation">(</span>rst_n         <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/*input       wire    [7:0]   */</span><span class="token punctuation">.</span><span class="token function">wr_data</span>     <span class="token punctuation">(</span>op_wr_data    <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/*input       wire    [4:0]   */</span><span class="token punctuation">.</span><span class="token function">cmd</span>         <span class="token punctuation">(</span>cmd           <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/*input       wire            */</span><span class="token punctuation">.</span><span class="token function">cmd_vld</span>     <span class="token punctuation">(</span>cmd_vld       <span class="token punctuation">)</span><span class="token punctuation">,</span>

        <span class="token comment">/*inout       wire            */</span><span class="token punctuation">.</span><span class="token function">i2c_sda</span>     <span class="token punctuation">(</span>i2c_sda       <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/*output      wire            */</span><span class="token punctuation">.</span><span class="token function">i2c_scl</span>     <span class="token punctuation">(</span>i2c_scl       <span class="token punctuation">)</span><span class="token punctuation">,</span>

        <span class="token comment">/*output      wire    [7:0]   */</span><span class="token punctuation">.</span><span class="token function">rd_data</span>     <span class="token punctuation">(</span>rd_data       <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/*output      wire            */</span><span class="token punctuation">.</span><span class="token function">rd_data_vld</span> <span class="token punctuation">(</span>rd_data_vld   <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/*output      wire            */</span><span class="token punctuation">.</span><span class="token function">done</span>        <span class="token punctuation">(</span>done          <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/*output      reg             */</span><span class="token punctuation">.</span><span class="token function">rev_ack</span>     <span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// iic_interface iic_interface_inst(</span>
        <span class="token comment">// /* input            */.clk          (clk        ),</span>
        <span class="token comment">// /* input            */.rst_n        (rst_n      ),</span>
        <span class="token comment">// /* input   [4:0]    */.cmd          (cmd        ),</span>
        <span class="token comment">// /* input            */.cmd_vld      (cmd_vld    ),</span>
        <span class="token comment">// /* output           */.done         (done       ),   //操作结束</span>
        <span class="token comment">// /* output  reg      */.rev_ack      (           ),   //接收到的响应信号</span>
        <span class="token comment">// /* input   [7:0]    */.wr_data      (op_wr_data ),   //伴随cmd_vld信号一起接收写数据</span>
        <span class="token comment">// /* output  [7:0]    */.rd_data      (rd_data    ),</span>
        <span class="token comment">// /* output           */.rd_data_vld  (rd_data_vld),</span>
        <span class="token comment">// /* output reg       */.iic_scl      (i2c_scl    ),</span>
        <span class="token comment">// /* inout            */.iic_sda      (i2c_sda    ) </span>
    <span class="token comment">// );</span>


    assign ready <span class="token operator">=</span> cstate <span class="token operator">==</span> IDLE<span class="token punctuation">;</span>


endmodule
</code></pre> 
<p><strong>UART RX模块：</strong></p> 
<pre><code class="prism language-c"><span class="token comment">//****************************************************************</span>
<span class="token comment">//--majiko 2023-8-15 UART RX模块</span>
<span class="token comment">//****************************************************************</span>
module uart_rx 
#<span class="token punctuation">(</span>
    parameter   BORT        <span class="token operator">=</span> <span class="token number">20</span>'d115200<span class="token punctuation">,</span>
    parameter   CLOCK       <span class="token operator">=</span> <span class="token number">50</span>_000_000<span class="token punctuation">,</span>
    parameter   CHECK_BIT   <span class="token operator">=</span> <span class="token string">"None"</span>      <span class="token comment">//"None" 无校验，"Odd" 奇校验，"Even" 偶校验</span>
<span class="token punctuation">)</span>
<span class="token punctuation">(</span>
    input       wire             clk         <span class="token punctuation">,</span>
    input       wire             rst_n       <span class="token punctuation">,</span>
    input       wire             ready       <span class="token punctuation">,</span><span class="token comment">//准备接受数据信号</span>
    input       wire             rx          <span class="token punctuation">,</span>

    output      wire             rx_data_vld <span class="token punctuation">,</span><span class="token comment">//数据有效信号</span>
    output      wire     <span class="token punctuation">[</span><span class="token number">7</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>   rx_data      
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//参数定义</span>
    parameter TIME_BORT <span class="token operator">=</span> CLOCK<span class="token operator">/</span>BORT<span class="token punctuation">;</span>

    <span class="token comment">//状态机状态定义</span>
    parameter   IDLE  <span class="token operator">=</span> <span class="token number">4</span>'b0001<span class="token punctuation">,</span><span class="token comment">//空闲状态电平默认拉高</span>
                START <span class="token operator">=</span> <span class="token number">4</span>'b0010<span class="token punctuation">,</span><span class="token comment">//起始位赋值</span>
                DATA  <span class="token operator">=</span> <span class="token number">4</span>'b0100<span class="token punctuation">,</span><span class="token comment">//数据位赋值</span>
                CHECK <span class="token operator">=</span> <span class="token number">4</span>'b1000<span class="token punctuation">;</span>
    
    <span class="token comment">//波特率115200 1bit传输时间计数器参数</span>

<span class="token comment">//内部信号定义</span>
    <span class="token comment">//状态寄存器</span>
    reg         <span class="token punctuation">[</span><span class="token number">3</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>   cstate          <span class="token punctuation">;</span>
    reg         <span class="token punctuation">[</span><span class="token number">3</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>   nstate          <span class="token punctuation">;</span>

    <span class="token comment">//状态跳转条件</span>
    wire                idle2start      <span class="token punctuation">;</span>
    wire                start2data      <span class="token punctuation">;</span>
    wire                data2idle       <span class="token punctuation">;</span>
    wire                data2check      <span class="token punctuation">;</span>
    wire                check2idle      <span class="token punctuation">;</span>

    <span class="token comment">//1Baud时间计数器</span>
    reg			<span class="token punctuation">[</span><span class="token number">8</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>	cnt_bort	   	<span class="token punctuation">;</span>
    wire				add_cnt_bort	<span class="token punctuation">;</span>
    wire				end_cnt_bort	<span class="token punctuation">;</span>

    <span class="token comment">//比特计数器（复用）</span>
    reg			<span class="token punctuation">[</span><span class="token number">2</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>	cnt_bit	   	    <span class="token punctuation">;</span>
    wire				add_cnt_bit	    <span class="token punctuation">;</span>
    wire				end_cnt_bit	    <span class="token punctuation">;</span>
    reg         <span class="token punctuation">[</span><span class="token number">3</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>   bit_max         <span class="token punctuation">;</span><span class="token comment">//计数器复用信号</span>

    reg         <span class="token punctuation">[</span><span class="token number">7</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>   rx_temp         <span class="token punctuation">;</span>    
    
    reg                 check_bit       <span class="token punctuation">;</span>
    wire                check_temp      <span class="token punctuation">;</span>

    reg                 rx_r1           <span class="token punctuation">;</span>
    reg                 rx_r2           <span class="token punctuation">;</span>
    wire                rx_nedge        <span class="token punctuation">;</span>

<span class="token comment">//rx同步至时钟域 并检测下降沿</span>
    always@<span class="token punctuation">(</span>posedge clk or negedge rst_n<span class="token punctuation">)</span>begin
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span>begin
            rx_r1 <span class="token operator">&lt;=</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
            rx_r2 <span class="token operator">&lt;=</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
        end
        <span class="token keyword">else</span> begin
            rx_r1 <span class="token operator">&lt;=</span> rx<span class="token punctuation">;</span>
            rx_r2 <span class="token operator">&lt;=</span> rx_r1<span class="token punctuation">;</span>
        end
    end

    assign rx_nedge <span class="token operator">=</span> <span class="token operator">~</span>rx_r1 <span class="token operator">&amp;&amp;</span> rx_r2<span class="token punctuation">;</span>

<span class="token comment">//三段式状态机</span>
    <span class="token comment">//第一段 时序逻辑</span>
    always @<span class="token punctuation">(</span>posedge clk or negedge rst_n<span class="token punctuation">)</span> begin
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span>begin
            cstate <span class="token operator">&lt;=</span> IDLE<span class="token punctuation">;</span>
        end
        <span class="token keyword">else</span> begin
            cstate <span class="token operator">&lt;=</span> nstate<span class="token punctuation">;</span>
        end
    end


    <span class="token comment">//第二段 组合逻辑</span>
    always @<span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>begin
        <span class="token keyword">case</span> <span class="token punctuation">(</span>cstate<span class="token punctuation">)</span>
            IDLE <span class="token operator">:</span>  begin
                        <span class="token keyword">if</span><span class="token punctuation">(</span>idle2start<span class="token punctuation">)</span>begin
                            nstate <span class="token operator">=</span> START<span class="token punctuation">;</span>
                        end
                        <span class="token keyword">else</span> begin
                            nstate <span class="token operator">=</span> cstate<span class="token punctuation">;</span>
                        end
                    end
            START<span class="token operator">:</span>  begin
                        <span class="token keyword">if</span><span class="token punctuation">(</span>start2data<span class="token punctuation">)</span>begin
                            nstate <span class="token operator">=</span> DATA<span class="token punctuation">;</span>
                        end
                        <span class="token keyword">else</span> begin
                            nstate <span class="token operator">=</span> cstate<span class="token punctuation">;</span>
                        end
                    end
            DATA <span class="token operator">:</span>  begin
                        <span class="token keyword">if</span><span class="token punctuation">(</span>data2idle<span class="token punctuation">)</span>begin
                            nstate <span class="token operator">=</span> IDLE<span class="token punctuation">;</span>
                        end
                        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>data2check<span class="token punctuation">)</span>begin
                            nstate <span class="token operator">=</span> CHECK<span class="token punctuation">;</span>
                        end
                        <span class="token keyword">else</span> begin
                            nstate <span class="token operator">=</span> cstate<span class="token punctuation">;</span>
                        end
                    end
            CHECK<span class="token operator">:</span>  begin
                        <span class="token keyword">if</span><span class="token punctuation">(</span>check2idle<span class="token punctuation">)</span>begin
                            nstate <span class="token operator">=</span> IDLE<span class="token punctuation">;</span>
                        end
                        <span class="token keyword">else</span> begin
                            nstate <span class="token operator">=</span> cstate<span class="token punctuation">;</span>
                        end
                    end
            <span class="token keyword">default</span> <span class="token operator">:</span>   nstate <span class="token operator">=</span> IDLE<span class="token punctuation">;</span>
        endcase
    end

    assign idle2start <span class="token operator">=</span> cstate <span class="token operator">==</span> IDLE  <span class="token operator">&amp;&amp;</span> rx_nedge<span class="token punctuation">;</span><span class="token comment">//检测到开始位，结束空闲状态，开始接收数据</span>
    assign start2data <span class="token operator">=</span> cstate <span class="token operator">==</span> START <span class="token operator">&amp;&amp;</span> end_cnt_bit<span class="token punctuation">;</span>
    assign data2idle  <span class="token operator">=</span> cstate <span class="token operator">==</span> DATA  <span class="token operator">&amp;&amp;</span> end_cnt_bit <span class="token operator">&amp;&amp;</span> CHECK_BIT <span class="token operator">==</span> <span class="token string">"None"</span><span class="token punctuation">;</span>
    assign data2check <span class="token operator">=</span> cstate <span class="token operator">==</span> DATA  <span class="token operator">&amp;&amp;</span> end_cnt_bit<span class="token punctuation">;</span>
    assign check2idle <span class="token operator">=</span> cstate <span class="token operator">==</span> CHECK <span class="token operator">&amp;&amp;</span> end_cnt_bit<span class="token punctuation">;</span>

    <span class="token comment">//1Baud所需时间</span>
    always @<span class="token punctuation">(</span>posedge clk or negedge rst_n<span class="token punctuation">)</span>begin 
       <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span>begin
            cnt_bort <span class="token operator">&lt;=</span> 'd0<span class="token punctuation">;</span>
        end 
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>add_cnt_bort<span class="token punctuation">)</span>begin 
            <span class="token keyword">if</span><span class="token punctuation">(</span>end_cnt_bort<span class="token punctuation">)</span>begin 
                cnt_bort <span class="token operator">&lt;=</span> 'd0<span class="token punctuation">;</span>
            end
            <span class="token keyword">else</span> begin 
                cnt_bort <span class="token operator">&lt;=</span> cnt_bort <span class="token operator">+</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
            end 
        end
    end 
    
    assign add_cnt_bort <span class="token operator">=</span> cstate <span class="token operator">!=</span> IDLE<span class="token punctuation">;</span>
    assign end_cnt_bort <span class="token operator">=</span> add_cnt_bort <span class="token operator">&amp;&amp;</span> cnt_bort <span class="token operator">==</span> TIME_BORT <span class="token operator">-</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>

    <span class="token comment">//8bit共需时间</span>
    always @<span class="token punctuation">(</span>posedge clk or negedge rst_n<span class="token punctuation">)</span>begin 
       <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span>begin
            cnt_bit <span class="token operator">&lt;=</span> 'd0<span class="token punctuation">;</span>
        end 
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>add_cnt_bit<span class="token punctuation">)</span>begin 
            <span class="token keyword">if</span><span class="token punctuation">(</span>end_cnt_bit<span class="token punctuation">)</span>begin 
                cnt_bit <span class="token operator">&lt;=</span> 'd0<span class="token punctuation">;</span>
            end
            <span class="token keyword">else</span> begin 
                cnt_bit <span class="token operator">&lt;=</span> cnt_bit <span class="token operator">+</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
            end 
        end
    end 
    
    assign add_cnt_bit <span class="token operator">=</span> end_cnt_bort<span class="token punctuation">;</span>
    assign end_cnt_bit <span class="token operator">=</span> add_cnt_bit <span class="token operator">&amp;&amp;</span> cnt_bit <span class="token operator">==</span> bit_max <span class="token operator">-</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>

<span class="token comment">//bit计数器复用</span>
    always@<span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>begin
        <span class="token keyword">case</span><span class="token punctuation">(</span>cstate<span class="token punctuation">)</span>
            IDLE    <span class="token operator">:</span>   bit_max <span class="token operator">=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>
            START   <span class="token operator">:</span>   bit_max <span class="token operator">=</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
            DATA    <span class="token operator">:</span>   bit_max <span class="token operator">=</span> <span class="token number">4</span>'d8<span class="token punctuation">;</span><span class="token comment">//8位数据位</span>
            CHECK   <span class="token operator">:</span>   bit_max <span class="token operator">=</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span><span class="token comment">//校验位</span>
            <span class="token keyword">default</span> <span class="token operator">:</span>   bit_max <span class="token operator">=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>
        endcase
    end


<span class="token comment">//状态输出</span>
    always @<span class="token punctuation">(</span>posedge clk or negedge rst_n<span class="token punctuation">)</span>begin
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span>begin
            rx_temp <span class="token operator">&lt;=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>
        end
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>cstate <span class="token operator">==</span> DATA <span class="token operator">&amp;&amp;</span> cnt_bort <span class="token operator">==</span> <span class="token punctuation">(</span>TIME_BORT <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>begin
            rx_temp<span class="token punctuation">[</span>cnt_bit<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> rx_r1<span class="token punctuation">;</span>
        end
        <span class="token keyword">else</span> begin
            rx_temp <span class="token operator">&lt;=</span> rx_temp<span class="token punctuation">;</span>
        end
    end

    assign rx_data <span class="token operator">=</span> rx_temp<span class="token punctuation">;</span>

<span class="token comment">//校验位</span>
    always @<span class="token punctuation">(</span>posedge clk or negedge rst_n<span class="token punctuation">)</span>begin
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span>begin
            check_bit <span class="token operator">&lt;=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>
        end
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>cstate <span class="token operator">==</span> CHECK <span class="token operator">&amp;&amp;</span> cnt_bort <span class="token operator">==</span> <span class="token punctuation">(</span>TIME_BORT <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>begin
            check_bit <span class="token operator">&lt;=</span> rx<span class="token punctuation">;</span>
        end
        <span class="token keyword">else</span> begin
            check_bit <span class="token operator">&lt;=</span> check_bit<span class="token punctuation">;</span>
        end
    end
    
    assign check_temp <span class="token operator">=</span> CHECK_BIT <span class="token operator">==</span> <span class="token string">"Odd"</span> <span class="token operator">?</span> <span class="token operator">~</span><span class="token operator">^</span>rx_data <span class="token operator">:</span> <span class="token operator">^</span>rx_data<span class="token punctuation">;</span>

    assign rx_data_vld <span class="token operator">=</span> CHECK_BIT <span class="token operator">==</span> <span class="token string">"None"</span> <span class="token operator">?</span> data2idle 
                        <span class="token operator">:</span> <span class="token punctuation">(</span>check2idle <span class="token operator">&amp;&amp;</span> check_temp <span class="token operator">==</span> check_bit<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span>
                        <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    
endmodule
</code></pre> 
<p><strong>UART TX模块：</strong></p> 
<pre><code class="prism language-c"><span class="token comment">//****************************************************************</span>
<span class="token comment">//--majiko 2023-8-15 UART TX模块</span>
<span class="token comment">//****************************************************************</span>
module uart_tx 
#<span class="token punctuation">(</span> 
    parameter   BORT      <span class="token operator">=</span> <span class="token number">20</span>'d115200<span class="token punctuation">,</span><span class="token comment">//波特率</span>
    parameter   CLOCK     <span class="token operator">=</span> <span class="token number">50</span>_000_000<span class="token punctuation">,</span><span class="token comment">//系统时钟参数</span>
    parameter   CHECK_BIT <span class="token operator">=</span> <span class="token string">"None"</span>     <span class="token comment">//"None" 无校验，"Odd" 奇校验，"Even" 偶校验</span>
<span class="token punctuation">)</span> 
<span class="token punctuation">(</span>
    input       wire             clk         <span class="token punctuation">,</span>
    input       wire             rst_n       <span class="token punctuation">,</span>
    input       wire    <span class="token punctuation">[</span><span class="token number">7</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>    tx_data     <span class="token punctuation">,</span>
    input       wire             tx_data_vld <span class="token punctuation">,</span><span class="token comment">//数据有效信号</span>

    output      wire             ready       <span class="token punctuation">,</span><span class="token comment">//准备接受数据信号</span>
    output      reg              tx  
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//参数定义</span>
    parameter TIME_BORT <span class="token operator">=</span> CLOCK<span class="token operator">/</span>BORT<span class="token punctuation">;</span>

    <span class="token comment">//状态机状态定义</span>
    parameter   IDLE  <span class="token operator">=</span> <span class="token number">5</span>'b00001<span class="token punctuation">,</span><span class="token comment">//空闲状态电平默认拉高</span>
                START <span class="token operator">=</span> <span class="token number">5</span>'b00010<span class="token punctuation">,</span><span class="token comment">//起始位赋值</span>
                DATA  <span class="token operator">=</span> <span class="token number">5</span>'b00100<span class="token punctuation">,</span><span class="token comment">//数据位赋值</span>
                CHECK <span class="token operator">=</span> <span class="token number">5</span>'b01000<span class="token punctuation">,</span><span class="token comment">//奇偶校验位</span>
                STOP  <span class="token operator">=</span> <span class="token number">5</span>'b10000<span class="token punctuation">;</span><span class="token comment">//停止位赋值</span>
    
    <span class="token comment">//波特率115200 1bit传输时间计数器参数</span>

<span class="token comment">//内部信号定义</span>
    <span class="token comment">//状态寄存器</span>
    reg         <span class="token punctuation">[</span><span class="token number">4</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>   cstate          <span class="token punctuation">;</span>
    reg         <span class="token punctuation">[</span><span class="token number">4</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>   nstate          <span class="token punctuation">;</span>

    <span class="token comment">//状态跳转条件</span>
    wire                idle2start      <span class="token punctuation">;</span>
    wire                start2data      <span class="token punctuation">;</span>
    wire                data2check      <span class="token punctuation">;</span>
    wire                data2stop       <span class="token punctuation">;</span>              
    wire                check2stop      <span class="token punctuation">;</span>
    wire                stop2idle       <span class="token punctuation">;</span>

    <span class="token comment">//1Baud时间计数器</span>
    reg			<span class="token punctuation">[</span><span class="token number">8</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>	cnt_bort	   	<span class="token punctuation">;</span>
    wire				add_cnt_bort	<span class="token punctuation">;</span>
    wire				end_cnt_bort	<span class="token punctuation">;</span>

    <span class="token comment">//比特计数器（复用）</span>
    reg			<span class="token punctuation">[</span><span class="token number">2</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>	cnt_bit	   	    <span class="token punctuation">;</span>
    wire				add_cnt_bit	    <span class="token punctuation">;</span>
    wire				end_cnt_bit	    <span class="token punctuation">;</span>
    reg         <span class="token punctuation">[</span><span class="token number">3</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>   bit_max         <span class="token punctuation">;</span><span class="token comment">//计数器复用信号</span>

    reg         <span class="token punctuation">[</span><span class="token number">7</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>   tx_data_r       <span class="token punctuation">;</span><span class="token comment">//寄存数据</span>

    wire                check_bit       <span class="token punctuation">;</span>
     

<span class="token comment">//三段式状态机</span>
    <span class="token comment">//第一段 时序逻辑</span>
    always @<span class="token punctuation">(</span>posedge clk or negedge rst_n<span class="token punctuation">)</span> begin
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span>begin
            cstate <span class="token operator">&lt;=</span> IDLE<span class="token punctuation">;</span>
        end
        <span class="token keyword">else</span> begin
            cstate <span class="token operator">&lt;=</span> nstate<span class="token punctuation">;</span>
        end
    end


    <span class="token comment">//第二段 组合逻辑</span>
    always @<span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>begin
        <span class="token keyword">case</span> <span class="token punctuation">(</span>cstate<span class="token punctuation">)</span>
            IDLE <span class="token operator">:</span>  begin
                        <span class="token keyword">if</span><span class="token punctuation">(</span>idle2start<span class="token punctuation">)</span>begin
                            nstate <span class="token operator">&lt;=</span> START<span class="token punctuation">;</span>
                        end
                        <span class="token keyword">else</span> begin
                            nstate <span class="token operator">&lt;=</span> cstate<span class="token punctuation">;</span>
                        end
                    end
            START<span class="token operator">:</span>  begin
                        <span class="token keyword">if</span><span class="token punctuation">(</span>start2data<span class="token punctuation">)</span>begin
                            nstate <span class="token operator">&lt;=</span> DATA<span class="token punctuation">;</span>
                        end
                        <span class="token keyword">else</span> begin
                            nstate <span class="token operator">&lt;=</span> cstate<span class="token punctuation">;</span>
                        end
                    end
            DATA <span class="token operator">:</span>  begin
                        <span class="token keyword">if</span><span class="token punctuation">(</span>data2check<span class="token punctuation">)</span>begin
                            nstate <span class="token operator">&lt;=</span> CHECK<span class="token punctuation">;</span>
                        end
                        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>data2stop<span class="token punctuation">)</span>begin
                            nstate <span class="token operator">&lt;=</span> STOP<span class="token punctuation">;</span>
                        end
                        <span class="token keyword">else</span> begin
                            nstate <span class="token operator">&lt;=</span> cstate<span class="token punctuation">;</span>
                        end
                    end
            CHECK<span class="token operator">:</span>  begin
                        <span class="token keyword">if</span><span class="token punctuation">(</span>check2stop<span class="token punctuation">)</span>begin
                            nstate <span class="token operator">&lt;=</span> STOP<span class="token punctuation">;</span>
                        end
                        <span class="token keyword">else</span> begin
                            nstate <span class="token operator">&lt;=</span> cstate<span class="token punctuation">;</span>
                        end
                    end
            STOP <span class="token operator">:</span>  begin
                        <span class="token keyword">if</span><span class="token punctuation">(</span>stop2idle<span class="token punctuation">)</span>begin
                            nstate <span class="token operator">&lt;=</span> IDLE<span class="token punctuation">;</span>
                        end
                        <span class="token keyword">else</span> begin
                            nstate <span class="token operator">&lt;=</span> cstate<span class="token punctuation">;</span>
                        end
                    end
            <span class="token keyword">default</span> <span class="token operator">:</span>   nstate <span class="token operator">&lt;=</span> IDLE<span class="token punctuation">;</span>
        endcase
    end

    assign idle2start <span class="token operator">=</span> cstate <span class="token operator">==</span> IDLE  <span class="token operator">&amp;&amp;</span> tx_data_vld<span class="token punctuation">;</span><span class="token comment">//数据有效信号拉高，结束空闲状态，开始接收数据</span>
    assign start2data <span class="token operator">=</span> cstate <span class="token operator">==</span> START <span class="token operator">&amp;&amp;</span> end_cnt_bit<span class="token punctuation">;</span>
    assign data2check <span class="token operator">=</span> cstate <span class="token operator">==</span> DATA  <span class="token operator">&amp;&amp;</span> end_cnt_bit<span class="token punctuation">;</span>
    assign data2stop  <span class="token operator">=</span> cstate <span class="token operator">==</span> DATA  <span class="token operator">&amp;&amp;</span> end_cnt_bit <span class="token operator">&amp;&amp;</span> CHECK_BIT <span class="token operator">==</span> <span class="token string">"None"</span><span class="token punctuation">;</span> 
    assign check2stop <span class="token operator">=</span> cstate <span class="token operator">==</span> CHECK <span class="token operator">&amp;&amp;</span> end_cnt_bit<span class="token punctuation">;</span>
    assign stop2idle  <span class="token operator">=</span> cstate <span class="token operator">==</span> STOP  <span class="token operator">&amp;&amp;</span> end_cnt_bit<span class="token punctuation">;</span>

    <span class="token comment">//1Baud所需时间</span>
    always @<span class="token punctuation">(</span>posedge clk or negedge rst_n<span class="token punctuation">)</span>begin 
       <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span>begin
            cnt_bort <span class="token operator">&lt;=</span> 'd0<span class="token punctuation">;</span>
        end 
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>add_cnt_bort<span class="token punctuation">)</span>begin 
            <span class="token keyword">if</span><span class="token punctuation">(</span>end_cnt_bort<span class="token punctuation">)</span>begin 
                cnt_bort <span class="token operator">&lt;=</span> 'd0<span class="token punctuation">;</span>
            end
            <span class="token keyword">else</span> begin 
                cnt_bort <span class="token operator">&lt;=</span> cnt_bort <span class="token operator">+</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
            end 
        end
    end 
    
    assign add_cnt_bort <span class="token operator">=</span> cstate <span class="token operator">!=</span> IDLE<span class="token punctuation">;</span>
    assign end_cnt_bort <span class="token operator">=</span> add_cnt_bort <span class="token operator">&amp;&amp;</span> cnt_bort <span class="token operator">==</span> TIME_BORT <span class="token operator">-</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>

    <span class="token comment">//不同状态bit数所需时间</span>
    always @<span class="token punctuation">(</span>posedge clk or negedge rst_n<span class="token punctuation">)</span>begin 
       <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span>begin
            cnt_bit <span class="token operator">&lt;=</span> 'd0<span class="token punctuation">;</span>
        end 
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>add_cnt_bit<span class="token punctuation">)</span>begin 
            <span class="token keyword">if</span><span class="token punctuation">(</span>end_cnt_bit<span class="token punctuation">)</span>begin 
                cnt_bit <span class="token operator">&lt;=</span> 'd0<span class="token punctuation">;</span>
            end
            <span class="token keyword">else</span> begin 
                cnt_bit <span class="token operator">&lt;=</span> cnt_bit <span class="token operator">+</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
            end 
        end
    end 

    assign add_cnt_bit <span class="token operator">=</span> end_cnt_bort<span class="token punctuation">;</span>
    assign end_cnt_bit <span class="token operator">=</span> add_cnt_bit <span class="token operator">&amp;&amp;</span> cnt_bit <span class="token operator">==</span> bit_max <span class="token operator">-</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>

<span class="token comment">//bit计数器复用</span>
    always@<span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>begin
        <span class="token keyword">case</span><span class="token punctuation">(</span>cstate<span class="token punctuation">)</span>
            IDLE    <span class="token operator">:</span>   bit_max <span class="token operator">=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>
            START   <span class="token operator">:</span>   bit_max <span class="token operator">=</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span><span class="token comment">//1位起始位数据</span>
            DATA    <span class="token operator">:</span>   bit_max <span class="token operator">=</span> <span class="token number">4</span>'d8<span class="token punctuation">;</span><span class="token comment">//8位数据位</span>
            CHECK   <span class="token operator">:</span>   bit_max <span class="token operator">=</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span><span class="token comment">//1位奇偶校验位</span>
            STOP    <span class="token operator">:</span>   bit_max <span class="token operator">=</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span><span class="token comment">//1位停止位数据</span>
            <span class="token keyword">default</span> <span class="token operator">:</span>   bit_max <span class="token operator">=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>
        endcase
    end
    

<span class="token comment">//状态输出</span>
    <span class="token comment">//输入数据寄存</span>
    always@<span class="token punctuation">(</span>posedge clk or negedge rst_n<span class="token punctuation">)</span>begin
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span>begin
            tx_data_r <span class="token operator">&lt;=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>
        end
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>tx_data_vld<span class="token punctuation">)</span>begin
            tx_data_r <span class="token operator">&lt;=</span> tx_data<span class="token punctuation">;</span>
        end
        <span class="token keyword">else</span> begin
            tx_data_r <span class="token operator">&lt;=</span> tx_data_r<span class="token punctuation">;</span>
        end
    end

    <span class="token comment">//奇偶校验位</span>
    assign check_bit <span class="token operator">=</span> CHECK_BIT <span class="token operator">==</span> <span class="token string">"Odd"</span> <span class="token operator">?</span> <span class="token operator">~</span><span class="token operator">^</span>tx_data_r <span class="token operator">:</span> <span class="token operator">^</span>tx_data_r<span class="token punctuation">;</span>

    <span class="token comment">//数据输出</span>
    always@<span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>begin
        <span class="token keyword">case</span><span class="token punctuation">(</span>cstate<span class="token punctuation">)</span>
            IDLE    <span class="token operator">:</span>   tx <span class="token operator">=</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span><span class="token comment">//空闲时为高电平</span>
            START   <span class="token operator">:</span>   tx <span class="token operator">=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span><span class="token comment">//起始位低电平</span>
            DATA    <span class="token operator">:</span>   tx <span class="token operator">=</span> tx_data_r<span class="token punctuation">[</span>cnt_bit<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//数据位从低位开始发送</span>
            CHECK   <span class="token operator">:</span>   tx <span class="token operator">=</span> check_bit<span class="token punctuation">;</span>
            STOP    <span class="token operator">:</span>   tx <span class="token operator">=</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span><span class="token comment">//停止位高电平</span>
            <span class="token keyword">default</span> <span class="token operator">:</span>   tx <span class="token operator">=</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
        endcase
    end

    assign ready <span class="token operator">=</span> cstate <span class="token operator">==</span> IDLE<span class="token punctuation">;</span>
    
    
endmodule
</code></pre> 
<p><strong>顶层模块：</strong></p> 
<pre><code class="prism language-c">module <span class="token function">top</span><span class="token punctuation">(</span>
    input       wire            clk         <span class="token punctuation">,</span>
    input       wire            rst_n       <span class="token punctuation">,</span>
    input       wire            rx          <span class="token punctuation">,</span>
	input	    wire            key_in		<span class="token punctuation">,</span>

    inout       wire            i2c_sda     <span class="token punctuation">,</span>
    output      wire            i2c_scl     <span class="token punctuation">,</span>
    output      wire            tx 

<span class="token punctuation">)</span><span class="token punctuation">;</span>

    wire             ready       <span class="token punctuation">;</span>
    wire    <span class="token punctuation">[</span><span class="token number">7</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>    rx_data     <span class="token punctuation">;</span>
    wire    <span class="token punctuation">[</span><span class="token number">7</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>    tx_data     <span class="token punctuation">;</span>
    wire             rx_data_vld <span class="token punctuation">;</span>
    wire             tx_data_vld <span class="token punctuation">;</span>

    wire             key_out     <span class="token punctuation">;</span>



<span class="token comment">//模块例化</span>
    eeprom_control  <span class="token function">u_eeprom_control</span>
    <span class="token punctuation">(</span>
        <span class="token comment">/*input       wire                        */</span><span class="token punctuation">.</span><span class="token function">clk</span>             <span class="token punctuation">(</span>clk           <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/*input       wire                        */</span><span class="token punctuation">.</span><span class="token function">rst_n</span>           <span class="token punctuation">(</span>rst_n         <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/*input       wire    [6:0]               */</span><span class="token punctuation">.</span><span class="token function">device_id</span>       <span class="token punctuation">(</span><span class="token number">7</span>'b1010_000   <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/*input       wire                        */</span><span class="token punctuation">.</span><span class="token function">wr_req</span>          <span class="token punctuation">(</span>rx_data_vld   <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/*input       wire                        */</span><span class="token punctuation">.</span><span class="token function">rd_req</span>          <span class="token punctuation">(</span>key_out       <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/*input       wire    [ADDR_BIT - 1:0]    */</span><span class="token punctuation">.</span><span class="token function">reg_addr</span>        <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/*input       wire                        */</span><span class="token punctuation">.</span><span class="token function">reg_addr_vld</span>    <span class="token punctuation">(</span>rx_data_vld   <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/*input       wire    [7:0]               */</span><span class="token punctuation">.</span><span class="token function">wr_data</span>         <span class="token punctuation">(</span>rx_data       <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/*input       wire                        */</span><span class="token punctuation">.</span><span class="token function">wr_data_vld</span>     <span class="token punctuation">(</span>rx_data_vld   <span class="token punctuation">)</span><span class="token punctuation">,</span>

        <span class="token comment">/*output      wire    [7:0]               */</span><span class="token punctuation">.</span><span class="token function">rd_data</span>         <span class="token punctuation">(</span>tx_data       <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/*output      wire                        */</span><span class="token punctuation">.</span><span class="token function">rd_data_vld</span>     <span class="token punctuation">(</span>tx_data_vld   <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/*output      wire                        */</span><span class="token punctuation">.</span><span class="token function">ready</span>           <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

        <span class="token comment">/*output      wire                        */</span><span class="token punctuation">.</span><span class="token function">i2c_scl</span>         <span class="token punctuation">(</span>i2c_scl       <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/*inout       wire                        */</span><span class="token punctuation">.</span><span class="token function">i2c_sda</span>         <span class="token punctuation">(</span>i2c_sda       <span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">// iic_control u_eeprom_control2</span>
    <span class="token comment">// (</span>
        <span class="token comment">// /*input       wire                        */.clk             (clk           ),</span>
        <span class="token comment">// /*input       wire                        */.rst_n           (rst_n         ),</span>
        <span class="token comment">// /*input       wire    [6:0]               */.device_id       (7'b1010_000   ),</span>
        <span class="token comment">// /*input       wire                        */.wr_req          (rx_data_vld   ),</span>
        <span class="token comment">// /*input       wire                        */.rd_req          (key_out       ),</span>
        <span class="token comment">// /*input       wire    [ADDR_BIT - 1:0]    */.addr            (0),</span>
        <span class="token comment">// /*input       wire                        */.addr_vld        (rx_data_vld   ),</span>
        <span class="token comment">// /*input       wire    [7:0]               */.wr_data         (rx_data       ),</span>
        <span class="token comment">// /*input       wire                        */.wr_data_vld     (rx_data_vld   ),</span>
        <span class="token comment">// /*output      wire    [7:0]               */.rd_data         (tx_data       ),</span>
        <span class="token comment">// /*output      wire                        */.rd_data_vld     (tx_data_vld   ),</span>
        <span class="token comment">// /*output      wire                        */.ready           (),</span>
        <span class="token comment">// /*output      wire                        */.iic_scl         (i2c_scl       ),</span>
        <span class="token comment">// /*inout       wire                        */.iic_sda         (i2c_sda       )</span>
    <span class="token comment">// );</span>

    uart_rx <span class="token function">u_uart_rx</span>
    <span class="token punctuation">(</span>
       <span class="token punctuation">.</span><span class="token function">clk</span>         <span class="token punctuation">(</span>clk         <span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">.</span><span class="token function">rst_n</span>       <span class="token punctuation">(</span>rst_n       <span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">.</span><span class="token function">ready</span>       <span class="token punctuation">(</span>            <span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">.</span><span class="token function">rx</span>          <span class="token punctuation">(</span>rx          <span class="token punctuation">)</span><span class="token punctuation">,</span>
    
       <span class="token punctuation">.</span><span class="token function">rx_data_vld</span> <span class="token punctuation">(</span>rx_data_vld <span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">.</span><span class="token function">rx_data</span>     <span class="token punctuation">(</span>rx_data     <span class="token punctuation">)</span> 
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    uart_tx <span class="token function">u_uart_tx</span>
    <span class="token punctuation">(</span>
       <span class="token punctuation">.</span><span class="token function">clk</span>         <span class="token punctuation">(</span>clk         <span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">.</span><span class="token function">rst_n</span>       <span class="token punctuation">(</span>rst_n       <span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">.</span><span class="token function">tx_data</span>     <span class="token punctuation">(</span>tx_data     <span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">.</span><span class="token function">tx_data_vld</span> <span class="token punctuation">(</span>tx_data_vld <span class="token punctuation">)</span><span class="token punctuation">,</span>
    
       <span class="token punctuation">.</span><span class="token function">ready</span>       <span class="token punctuation">(</span>ready       <span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">.</span><span class="token function">tx</span>          <span class="token punctuation">(</span>tx          <span class="token punctuation">)</span> 
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ctrl u_ctrl (</span>
        <span class="token comment">//  /*input        wire               */.clk         (clk         ),</span>
        <span class="token comment">//  /*input        wire               */.rst_n       (rst_n       ),</span>
        <span class="token comment">//  /*input        wire               */.rx_data_vld (rx_data_vld ),</span>
        <span class="token comment">//  /*input        reg        [7:0]   */.rx_data     (rx_data     ),</span>
        <span class="token comment">//  /*input        wire               */.ready       (ready       ),</span>
        <span class="token comment">//  /*output       wire       [7:0]   */.tx_data     (),</span>
        <span class="token comment">//  /*output       wire               */.tx_data_vld ()</span>
    <span class="token comment">// );</span>


    key_filter#<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token function">WIDTH</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">u_key_filter</span>          
    <span class="token punctuation">(</span>
        <span class="token comment">/*input       wire                    */</span><span class="token punctuation">.</span><span class="token function">clk</span>     <span class="token punctuation">(</span>clk       <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/*input       wire                    */</span><span class="token punctuation">.</span><span class="token function">rst_n</span>   <span class="token punctuation">(</span>rst_n     <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/*input       wire  [WIDTH - 1:0]     */</span><span class="token punctuation">.</span><span class="token function">key_in</span>  <span class="token punctuation">(</span>key_in    <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/*output      reg   [WIDTH - 1:0]     */</span><span class="token punctuation">.</span><span class="token function">key_out</span> <span class="token punctuation">(</span>key_out   <span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>



endmodule
</code></pre> 
<p><strong>按键消抖模块：</strong></p> 
<pre><code class="prism language-c">module key_filter#<span class="token punctuation">(</span>parameter WIDTH <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">)</span>           <span class="token comment">//参数化按键位宽</span>
<span class="token punctuation">(</span>
    input       wire                    clk     <span class="token punctuation">,</span>
    input       wire                    rst_n   <span class="token punctuation">,</span>
    input       wire  <span class="token punctuation">[</span>WIDTH <span class="token operator">-</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>     key_in  <span class="token punctuation">,</span><span class="token comment">//按键输入信号</span>

    output      reg   <span class="token punctuation">[</span>WIDTH <span class="token operator">-</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>     key_out  <span class="token comment">//输出稳定的脉冲信号</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

parameter MAX <span class="token operator">=</span> <span class="token number">20</span>'d1_000_000<span class="token punctuation">;</span>

reg     <span class="token punctuation">[</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>                  cnt_delay       <span class="token punctuation">;</span> <span class="token comment">//20ms延时计数寄存器</span>
wire                            add_cnt_delay   <span class="token punctuation">;</span> <span class="token comment">//开始计数的标志</span>
wire                            end_cnt_delay   <span class="token punctuation">;</span> <span class="token comment">//结束计数的标志</span>

reg     <span class="token punctuation">[</span>WIDTH <span class="token operator">-</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>           key_r0          <span class="token punctuation">;</span> <span class="token comment">//同步</span>
reg     <span class="token punctuation">[</span>WIDTH <span class="token operator">-</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>           key_r1          <span class="token punctuation">;</span> <span class="token comment">//打一拍</span>
reg     <span class="token punctuation">[</span>WIDTH <span class="token operator">-</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>           key_r2          <span class="token punctuation">;</span> <span class="token comment">//打两拍</span>

wire    <span class="token punctuation">[</span>WIDTH <span class="token operator">-</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>           nedge           <span class="token punctuation">;</span> <span class="token comment">//下降沿寄存器</span>


<span class="token comment">//同步打拍</span>
always @<span class="token punctuation">(</span>posedge clk or negedge rst_n<span class="token punctuation">)</span> begin
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span>begin
        key_r0 <span class="token operator">&lt;=</span> <span class="token punctuation">{<!-- --></span>WIDTH<span class="token punctuation">{<!-- --></span><span class="token number">1</span>'b1<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        key_r1 <span class="token operator">&lt;=</span> <span class="token punctuation">{<!-- --></span>WIDTH<span class="token punctuation">{<!-- --></span><span class="token number">1</span>'b1<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        key_r2 <span class="token operator">&lt;=</span> <span class="token punctuation">{<!-- --></span>WIDTH<span class="token punctuation">{<!-- --></span><span class="token number">1</span>'b1<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    end
    <span class="token keyword">else</span> begin
        key_r0 <span class="token operator">&lt;=</span> key_in<span class="token punctuation">;</span> <span class="token comment">//同步</span>
        key_r1 <span class="token operator">&lt;=</span> key_r0<span class="token punctuation">;</span> <span class="token comment">//寄存一拍</span>
        key_r2 <span class="token operator">&lt;=</span> key_r1<span class="token punctuation">;</span> <span class="token comment">//寄存两拍</span>
    end
end

<span class="token comment">//20ms计数器</span>
always @<span class="token punctuation">(</span>posedge clk or negedge rst_n<span class="token punctuation">)</span>begin
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span>begin
        cnt_delay <span class="token operator">&lt;=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>
    end
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>add_cnt_delay <span class="token punctuation">)</span>begin
        <span class="token keyword">if</span><span class="token punctuation">(</span>nedge<span class="token punctuation">)</span>begin <span class="token comment">//检测到下降沿从0开始计数</span>
            cnt_delay <span class="token operator">&lt;=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>
        end
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>cnt_delay <span class="token operator">==</span> MAX <span class="token operator">-</span> <span class="token number">1</span>'b1<span class="token punctuation">)</span>begin
            cnt_delay <span class="token operator">&lt;=</span> cnt_delay<span class="token punctuation">;</span> <span class="token comment">//计数计满结束后保持，避免产生多个输出脉冲</span>
        end
        <span class="token keyword">else</span> begin
            cnt_delay <span class="token operator">&lt;=</span> cnt_delay <span class="token operator">+</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
        end
    end
    <span class="token keyword">else</span> begin
        cnt_delay <span class="token operator">&lt;=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>
    end
end

assign nedge <span class="token operator">=</span> <span class="token operator">~</span>key_r1 <span class="token operator">&amp;</span> key_r2<span class="token punctuation">;</span> <span class="token comment">//下降沿检测</span>
assign add_cnt_delay <span class="token operator">=</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span> 
assign end_cnt_delay <span class="token operator">=</span> add_cnt_delay <span class="token operator">&amp;&amp;</span> cnt_delay <span class="token operator">==</span> MAX <span class="token operator">-</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>


<span class="token comment">//key_out脉冲信号赋值</span>
always@<span class="token punctuation">(</span>posedge clk or negedge rst_n<span class="token punctuation">)</span>begin
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span>begin
        key_out <span class="token operator">&lt;=</span> 'd0<span class="token punctuation">;</span>
    end
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>cnt_delay <span class="token operator">==</span> MAX <span class="token operator">-</span> <span class="token number">2</span>'d2<span class="token punctuation">)</span>begin <span class="token comment">//计数计满前一个脉冲时产生按键脉冲</span>
        key_out <span class="token operator">&lt;=</span> <span class="token operator">~</span>key_in<span class="token punctuation">;</span>
    end
    <span class="token keyword">else</span> begin
        key_out <span class="token operator">&lt;=</span> 'd0<span class="token punctuation">;</span>
    end
end

endmodule
</code></pre> 
<h2><a id="_1470"></a>五、实现效果</h2> 
<p><img src="https://images2.imgbox.com/00/12/iboz4K8g_o.png" alt="在这里插入图片描述"><br> 可以看出，能够正常进行单个字节的收发。</p> 
<h2><a id="_1474"></a>参考资料</h2> 
<p><a href="https://blog.csdn.net/zhangduang_KHKW/article/details/121953275">https://blog.csdn.net/zhangduang_KHKW/article/details/121953275</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fdd4de3e717f88d431f19e804c535ee3/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">井盖异动传感器-城市窨井盖监测设备-旭华智能</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d849c2a6ad77ba2461f652e4c7af72f2/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">es6 数据类型</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>