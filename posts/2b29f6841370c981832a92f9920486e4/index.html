<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>K8S控制器之Deployment详解及配置。 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="K8S控制器之Deployment详解及配置。" />
<meta property="og:description" content="目录：
一，引入Deployment
二，Deployment支持的功能
三，Deployment资源清单文件详解
四，滚动更新及回滚实验
五，弹性伸缩实验
一，引入Deployment 对于kubernetes来说Pod是资源调度最小单元，kubernetes主要的功能就是管理多个Pod，Pod中可以包含一个或多个容器，而kubernetes是如可管理多个Pod的呢？对，没错，就是通过控制器，比如Deployment和ReplicaSet（rs）。
kubernetes下有多个Deployment，Deployment下管理RepliceSet，通过RepliceSet管理多个Pod，通过Pod管理容器。
它们之间的关系图如下：
二，Deployment支持的功能 1，动态水平的弹性伸缩
容器对比虚拟机，最大的优势就在于容器可以灵活的弹性伸缩，而这一部分工作由kubernets中的控制器进行调度。
Deployment的弹性伸缩本质指得是RS下Pod的数量增加或减少
在创建Deployment时会相应创建一个RS，通过RS实现弹性伸缩的自动化部署，并在很短的时间内进行数量的变更
弹性伸缩通过修改yaml文件中的replicas参数实现
修改yaml文件后，通过 apply 命令重新应用而实现扩容或缩容
2，支持动态的回滚和滚动更新
定义一个Deployment会创建一个新的RS，通过RS创建Pod，删除Deployment控制器，同时也会删除所对应的RS及RS下控制的Pod资源。
可以说Deployment是建立在RS之上的一种控制器，可以管理多个RS，当每次需要更新Pod的时候，就会自动生成一个新的RS，把旧的RS替换掉，多个RS可以同时存在，但只有一个RS在运行，因为新RS里生成的Pod会依次去替换旧RS里面的Pod，所以需要等待时间，大约十分钟。
Deployment还支持回滚到以前的历史版本。
更新节奏和更新逻辑：
加入Deployment中定义了replicas数量为5（也就是期望的Pod数为5个）但在实际更新时会额外多几个，假如说能多一个，但是不可以少，那么更新的过程就是先增加一个Pod，再删除一个，增一个，删一个，但一般感受不到，这里只是讲一下原理，可以不必太在意。
三，Deployment资源清单文件详解 apiVersion: apps/v1 ##版本 kind: Deployment ##类型 metadata: ##Deployment的元数据 name: httpd ##Deployment的名字 labels: ##标签 app: httpd ##标签app=httpd spec: ##Pod的信息 replicas: 3 ##Pod的副本数 selector: ##标签选择器 matchLabels: ##查找匹配的标签 app: httpd ##app=httpd template: ##Pod的模板信息，根据模板信息来创建Pod metadata: ##Pod的元数据 labels: ##Pod的标签 app: httpd ##标签app=httpd spec: ##容器的信息 containers: ##容器 - name: httpd ##容器名 image: httpd ##容器所需的镜像 ports: ##端口 - containerPort: 80 ##容器暴露的端口 当我们不知道该怎么写时可以通过命令来查看更多详细内容：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/2b29f6841370c981832a92f9920486e4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-11-27T17:25:27+08:00" />
<meta property="article:modified_time" content="2021-11-27T17:25:27+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">K8S控制器之Deployment详解及配置。</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="%E7%9B%AE%E5%BD%95%EF%BC%9A-toc" style="margin-left:0px;"><a href="#%E7%9B%AE%E5%BD%95%EF%BC%9A" rel="nofollow" title="目录：">目录：</a></p> 
<p id="%E4%B8%80%EF%BC%8C%E5%BC%95%E5%85%A5Deployment-toc" style="margin-left:0px;"><a href="#%E4%B8%80%EF%BC%8C%E5%BC%95%E5%85%A5Deployment" rel="nofollow" title="一，引入Deployment">一，引入Deployment</a></p> 
<p id="%E4%BA%8C%EF%BC%8CDeployment%E6%94%AF%E6%8C%81%E7%9A%84%E5%8A%9F%E8%83%BD-toc" style="margin-left:0px;"><a href="#%E4%BA%8C%EF%BC%8CDeployment%E6%94%AF%E6%8C%81%E7%9A%84%E5%8A%9F%E8%83%BD" rel="nofollow" title="二，Deployment支持的功能">二，Deployment支持的功能</a></p> 
<p id="%E4%B8%89%EF%BC%8CDeployment%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3-toc" style="margin-left:0px;"><a href="#%E4%B8%89%EF%BC%8CDeployment%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3" rel="nofollow" title="三，Deployment资源清单文件详解">三，Deployment资源清单文件详解</a></p> 
<p id="%E5%9B%9B%EF%BC%8C%E6%BB%9A%E5%8A%A8%E6%9B%B4%E6%96%B0%E5%8F%8A%E5%9B%9E%E6%BB%9A%E5%AE%9E%E9%AA%8C-toc" style="margin-left:0px;"><a href="#%E5%9B%9B%EF%BC%8C%E6%BB%9A%E5%8A%A8%E6%9B%B4%E6%96%B0%E5%8F%8A%E5%9B%9E%E6%BB%9A%E5%AE%9E%E9%AA%8C" rel="nofollow" title="四，滚动更新及回滚实验">四，滚动更新及回滚实验</a></p> 
<p id="%E4%BA%94%EF%BC%8C%E5%BC%B9%E6%80%A7%E4%BC%B8%E7%BC%A9%E5%AE%9E%E9%AA%8C-toc" style="margin-left:0px;"><a href="#%E4%BA%94%EF%BC%8C%E5%BC%B9%E6%80%A7%E4%BC%B8%E7%BC%A9%E5%AE%9E%E9%AA%8C" rel="nofollow" title="五，弹性伸缩实验">五，弹性伸缩实验</a></p> 
<hr id="hr-toc"> 
<h2 id="%E4%B8%80%EF%BC%8C%E5%BC%95%E5%85%A5Deployment">一，引入Deployment</h2> 
<p>对于kubernetes来说Pod是资源调度最小单元，kubernetes主要的功能就是管理多个Pod，Pod中可以包含一个或多个容器，而kubernetes是如可管理多个Pod的呢？对，没错，就是通过控制器，比如Deployment和ReplicaSet（rs）。</p> 
<p> kubernetes下有多个Deployment，Deployment下管理RepliceSet，通过RepliceSet管理多个Pod，通过Pod管理容器。</p> 
<p>它们之间的关系图如下：</p> 
<p><img alt="" height="534" src="https://images2.imgbox.com/7a/94/GY7PbsOI_o.png" width="943"></p> 
<h2 id="%E4%BA%8C%EF%BC%8CDeployment%E6%94%AF%E6%8C%81%E7%9A%84%E5%8A%9F%E8%83%BD">二，Deployment支持的功能</h2> 
<p>1，动态水平的弹性伸缩</p> 
<p>容器对比虚拟机，最大的优势就在于容器可以灵活的弹性伸缩，而这一部分工作由kubernets中的控制器进行调度。</p> 
<p>Deployment的弹性伸缩本质指得是RS下Pod的数量增加或减少</p> 
<p>在创建Deployment时会相应创建一个RS，通过RS实现弹性伸缩的自动化部署，并在很短的时间内进行数量的变更</p> 
<p>弹性伸缩通过修改yaml文件中的replicas参数实现</p> 
<p>修改yaml文件后，通过 apply 命令重新应用而实现扩容或缩容</p> 
<p>2，支持动态的回滚和滚动更新</p> 
<p>定义一个Deployment会创建一个新的RS，通过RS创建Pod，删除Deployment控制器，同时也会删除所对应的RS及RS下控制的Pod资源。</p> 
<p>可以说Deployment是建立在RS之上的一种控制器，可以管理多个RS，当每次需要更新Pod的时候，就会自动生成一个新的RS，把旧的RS替换掉，多个RS可以同时存在，但只有一个RS在运行，因为新RS里生成的Pod会依次去替换旧RS里面的Pod，所以需要等待时间，大约十分钟。</p> 
<p>Deployment还支持回滚到以前的历史版本。</p> 
<p>更新节奏和更新逻辑：</p> 
<p>加入Deployment中定义了replicas数量为5（也就是期望的Pod数为5个）但在实际更新时会额外多几个，假如说能多一个，但是不可以少，那么更新的过程就是先增加一个Pod，再删除一个，增一个，删一个，但一般感受不到，这里只是讲一下原理，可以不必太在意。</p> 
<h2 id="%E4%B8%89%EF%BC%8CDeployment%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3">三，Deployment资源清单文件详解</h2> 
<pre><code class="language-bash">apiVersion: apps/v1            ##版本
kind: Deployment               ##类型
metadata:                      ##Deployment的元数据
  name: httpd                  ##Deployment的名字
  labels:                      ##标签
    app: httpd                 ##标签app=httpd
spec:                          ##Pod的信息
  replicas: 3                  ##Pod的副本数
  selector:                    ##标签选择器
    matchLabels:               ##查找匹配的标签
      app: httpd               ##app=httpd
  template:                    ##Pod的模板信息，根据模板信息来创建Pod
    metadata:                  ##Pod的元数据
      labels:                  ##Pod的标签
        app: httpd             ##标签app=httpd
    spec:                      ##容器的信息
      containers:              ##容器
      - name: httpd            ##容器名
        image: httpd           ##容器所需的镜像
        ports:                 ##端口
        - containerPort: 80    ##容器暴露的端口</code></pre> 
<p>当我们不知道该怎么写时可以通过命令来查看更多详细内容：</p> 
<p>查看Deployment资源对象由哪几部分组成</p> 
<pre><code class="language-bash">kubectl explain deployment</code></pre> 
<p><img alt="" height="700" src="https://images2.imgbox.com/e3/90/NKKm3Mco_o.png" width="1132"></p> 
<p> 可以一级一级的查看，想查看什么只需要在后面加上  .字段名  即可。例如查看Deployment下的spec字段</p> 
<pre><code class="language-bash">kubectl explain deployment.spec</code></pre> 
<p><img alt="" height="848" src="https://images2.imgbox.com/b5/63/dp0zSjzL_o.png" width="1015"></p> 
<p> 在写yaml文件时不仅要注意字段，还要注意字段之间的等级，每级之间一般用两个空格隔开，文件中不可以出现tab键，当你在不清楚要空几个的时候，可以用kubectl explain命令查一下，看看你加了几个点，点数*2=空格数。如kubectl explain deployment.spec，有一个点，那就是1*2=2，需空两个格。</p> 
<h2 id="%E5%9B%9B%EF%BC%8C%E6%BB%9A%E5%8A%A8%E6%9B%B4%E6%96%B0%E5%8F%8A%E5%9B%9E%E6%BB%9A%E5%AE%9E%E9%AA%8C">四，滚动更新及回滚实验</h2> 
<p>1，创建deployment</p> 
<p><img alt="" height="630" src="https://images2.imgbox.com/e4/b4/HJ5vNnPb_o.png" width="721"></p> 
<p>2，访问其中一个页面内容</p> 
<p><img alt="" height="649" src="https://images2.imgbox.com/57/ef/dMOScNGd_o.png" width="764"></p> 
<p> 3，滚动更新：更改镜像，</p> 
<p><img alt="" height="486" src="https://images2.imgbox.com/fc/16/6H429vnA_o.png" width="748"></p> 
<p>4，查看Pod并访问页面内容，可以看到已经改变</p> 
<p><img alt="" height="529" src="https://images2.imgbox.com/aa/95/12AT1lmM_o.png" width="764"></p> 
<p> 5，查看历史版本，实现回滚更新，需要大概等10分钟，才能完全完成</p> 
<p>查看deployment的更新记录</p> 
<pre><code>kubectl rollout history deployment nginx-deployment
</code></pre> 
<p><img alt="" height="152" src="https://images2.imgbox.com/82/81/RdU8tLYB_o.png" width="836"></p> 
<p> 查看历史版本2的详细信息</p> 
<pre><code>kubectl rollout history deployment nginx-deployment --revision=2</code></pre> 
<p><img alt="" height="398" src="https://images2.imgbox.com/15/94/jboN59Wf_o.png" width="851"></p> 
<p>回滚到历史版本2,可以看到当前只会滚完毕了2个Pod</p> 
<pre><code>kubectl rollout undo deployment nginx-deployment --to-revision=2</code></pre> 
<p><img alt="" height="495" src="https://images2.imgbox.com/59/65/iTgSAyrp_o.png" width="928"></p> 
<h2 id="%E4%BA%94%EF%BC%8C%E5%BC%B9%E6%80%A7%E4%BC%B8%E7%BC%A9%E5%AE%9E%E9%AA%8C">五，弹性伸缩实验</h2> 
<p>1，创建一个Deployment，4副本</p> 
<pre><code>kubectl apply -f jpzhttpd.yaml</code></pre> 
<p><img alt="" height="674" src="https://images2.imgbox.com/02/f2/7t7k9NFx_o.png" width="970"></p> 
<p>2，缩为3副本</p> 
<pre><code>kubectl apply -f jpzhttpd.yaml</code></pre> 
<p><img alt="" height="641" src="https://images2.imgbox.com/92/ea/7yYEevo8_o.png" width="958"></p> 
<p> 到此为止，结束，感谢大家的观看，你们的每一个赞，以及阅读量，都是我跟新的动力，让我们一起学习，加油！！！</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1b11db144627eb8dadb207befeec9d3f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">虚拟内存抽象，进程的地址空间</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/768768a82761506d35c9a30bad9e29d8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">中国天气网全城市代码weather_cityId</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>