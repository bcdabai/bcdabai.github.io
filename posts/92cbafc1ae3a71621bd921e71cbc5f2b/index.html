<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>数据压缩—BMP2YUV - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="数据压缩—BMP2YUV" />
<meta property="og:description" content="文章目录 一.BMP文件格式介绍二.实验流程三. 实验原理及代码四. 实验结果： 一.BMP文件格式介绍 位图文件格式（BMP）是Windows采用的图像文件存储格式，在Windows环境下运行的所有图像处理软件都支持这种格式。
BMP文本大体上分为四个部分：
部分说明位图文件头BITMAPFILEHEADER包含BMP图像文件的类型，显示内容等信息位图信息头BITMAPINFOHEADER包含有BMP图像的宽，高压缩方法，以及定义颜色等信息调色板 Palette可选，真彩（24BMP）不需要调色板实际的位图数据 ImageData根据位图使用的位数不同而不同，在24位图中直接使用RGB，而其他的小于24位的使用颜色板中索引值 1.位图文件头
typedef struct tagBITMAPFILEHEADER { WORD bfType;//说明文件的类型 DWORD bfSize;//说明文件的大小，以字节为单位 WORD bfReserved1;//保留，设置为0 WORD bfReserved2;//保留，设置为0 DWORD bfOffBits;//说明从BITMAPFILEHEADER结构开始到实际的图像数据之间的字节偏移量 }BITMAPFILEHEADER; 2.位图信息头
typedef struct tagBITMAPINFOHEADER { DWORD biSize;//说明结构体所需字节数 LONG biWidth;//以像素为单位说明图像的宽度,对于32为的机子来说，LONG也是4字节，只是有一位被用来做符号位 LONG biHeight;//以像素为单位说明图像的高度 WORD biPlanes;//说明位面数，必须为1 WORD biBitCount;//说明位数每像素，1，2，4，8，24 DWORD biCompression;//说明图像是否压缩及压缩类型 DWORD biSizeImage;//以字节为单位说明图像大小，必须是4的整数倍 LONG biXPelsPerMeter;//目标设备的水平分辨率，像素每米 LONG biYPelsPerMeter;//目标设备的垂直分辨率，像素每米 DWORD biClrUsed;//说明图像实际用到的颜色数，如果为0，则颜色数为2的biBitCount次方 DWORD biClrImportant;//说明对图像显示有重要影响的颜色索引的数目，如果是0，表示都重要 }BITMAPINFOHEADER; 3.调色板
typedef struct tagRGBQUAD { BYTE rgbBlue;//指定蓝色分量 BYTE rgbGreen;//指定绿色分量 BYTE rgbRed;//指定红色分量 BYTE rgbReserved;//保留，指定为0 }RGBQUAD; 使用FlexHEX打开实验所需BMP文件：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/92cbafc1ae3a71621bd921e71cbc5f2b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-17T17:46:59+08:00" />
<meta property="article:modified_time" content="2022-04-17T17:46:59+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">数据压缩—BMP2YUV</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#BMP_2" rel="nofollow">一.BMP文件格式介绍</a></li><li><a href="#_68" rel="nofollow">二.实验流程</a></li><li><a href="#__75" rel="nofollow">三. 实验原理及代码</a></li><li><a href="#__434" rel="nofollow">四. 实验结果：</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="BMP_2"></a>一.BMP文件格式介绍</h3> 
<p>位图文件格式（BMP）是Windows采用的图像文件存储格式，在Windows环境下运行的所有图像处理软件都支持这种格式。<br> BMP文本大体上分为四个部分：</p> 
<table><thead><tr><th>部分</th><th>说明</th></tr></thead><tbody><tr><td>位图文件头BITMAPFILEHEADER</td><td>包含BMP图像文件的类型，显示内容等信息</td></tr><tr><td>位图信息头BITMAPINFOHEADER</td><td>包含有BMP图像的宽，高压缩方法，以及定义颜色等信息</td></tr><tr><td>调色板 Palette</td><td>可选，真彩（24BMP）不需要调色板</td></tr><tr><td>实际的位图数据 ImageData</td><td>根据位图使用的位数不同而不同，在24位图中直接使用RGB，而其他的小于24位的使用颜色板中索引值</td></tr></tbody></table> 
<p><strong>1.位图文件头</strong></p> 
<pre><code class="prism language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">tagBITMAPFILEHEADER</span> <span class="token punctuation">{<!-- --></span>
	WORD bfType<span class="token punctuation">;</span><span class="token comment">//说明文件的类型</span>
	DWORD bfSize<span class="token punctuation">;</span><span class="token comment">//说明文件的大小，以字节为单位</span>
	WORD bfReserved1<span class="token punctuation">;</span><span class="token comment">//保留，设置为0</span>
	WORD bfReserved2<span class="token punctuation">;</span><span class="token comment">//保留，设置为0</span>
	DWORD bfOffBits<span class="token punctuation">;</span><span class="token comment">//说明从BITMAPFILEHEADER结构开始到实际的图像数据之间的字节偏移量</span>
<span class="token punctuation">}</span>BITMAPFILEHEADER<span class="token punctuation">;</span>
</code></pre> 
<p><strong>2.位图信息头</strong></p> 
<pre><code class="prism language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">tagBITMAPINFOHEADER</span> <span class="token punctuation">{<!-- --></span>
	DWORD biSize<span class="token punctuation">;</span><span class="token comment">//说明结构体所需字节数</span>
	LONG biWidth<span class="token punctuation">;</span><span class="token comment">//以像素为单位说明图像的宽度,对于32为的机子来说，LONG也是4字节，只是有一位被用来做符号位</span>
	LONG biHeight<span class="token punctuation">;</span><span class="token comment">//以像素为单位说明图像的高度</span>
	WORD biPlanes<span class="token punctuation">;</span><span class="token comment">//说明位面数，必须为1</span>
	WORD biBitCount<span class="token punctuation">;</span><span class="token comment">//说明位数每像素，1，2，4，8，24</span>
	DWORD biCompression<span class="token punctuation">;</span><span class="token comment">//说明图像是否压缩及压缩类型</span>
	DWORD biSizeImage<span class="token punctuation">;</span><span class="token comment">//以字节为单位说明图像大小，必须是4的整数倍</span>
	LONG biXPelsPerMeter<span class="token punctuation">;</span><span class="token comment">//目标设备的水平分辨率，像素每米</span>
	LONG biYPelsPerMeter<span class="token punctuation">;</span><span class="token comment">//目标设备的垂直分辨率，像素每米</span>
	DWORD biClrUsed<span class="token punctuation">;</span><span class="token comment">//说明图像实际用到的颜色数，如果为0，则颜色数为2的biBitCount次方</span>
	DWORD biClrImportant<span class="token punctuation">;</span><span class="token comment">//说明对图像显示有重要影响的颜色索引的数目，如果是0，表示都重要</span>
<span class="token punctuation">}</span>BITMAPINFOHEADER<span class="token punctuation">;</span>
</code></pre> 
<p><strong>3.调色板</strong></p> 
<pre><code class="prism language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">tagRGBQUAD</span> <span class="token punctuation">{<!-- --></span>
	BYTE rgbBlue<span class="token punctuation">;</span><span class="token comment">//指定蓝色分量</span>
	BYTE rgbGreen<span class="token punctuation">;</span><span class="token comment">//指定绿色分量</span>
	BYTE rgbRed<span class="token punctuation">;</span><span class="token comment">//指定红色分量</span>
	BYTE rgbReserved<span class="token punctuation">;</span><span class="token comment">//保留，指定为0</span>
<span class="token punctuation">}</span>RGBQUAD<span class="token punctuation">;</span>
</code></pre> 
<p>使用FlexHEX打开实验所需BMP文件：<br> <strong>文件头部分</strong>：<br> <img src="https://images2.imgbox.com/03/bb/jYuEIcmo_o.png" alt="文件在这里插入图片描述"><br> “42 4D”:说明文件类型为BMP。<br> “66 75 00 00”:（<strong>小端存储</strong>，0x“00007566”）说明文件大小为30054字节。<br> “36 00 00 00”: (<strong>小端存储</strong>，0x“00000036”)说明从结构体开始到实际的图像数据之间偏移量为54字节。<br> <strong>信息头部分：</strong><br> <img src="https://images2.imgbox.com/2c/03/UFWjA9iN_o.png" alt="在这里插入图片描述"><br> “28 00 00 00”:(0x"00000028")，说明结构体所需字节数为40字节<br> “64 00 00 00”:(0x"00000064")，说明图像的宽度为100像素<br> “64 00 00 00”:(0x"00000064")，说明图像的高度为100像素<br> “01 00”:(0x"0001")，位面数，必须为1<br> “18 00”:(0x"0018")，说明24位/像素<br> “13 0B 00 00”:(0x"00000B13")，说明目标设备的水平分辨率为2835<br> “13 0B 00 00”:(0x"00000B13")，说明目标设备的垂直分辨率为2835<br> 由此，我们知道了该实验图片的基本信息。</p> 
<h3><a id="_68"></a>二.实验流程</h3> 
<p>1.程序初始化（打开两个文件，定义变量和缓冲区等）<br> 2.读取BMP文件，抽取或生成RGB数据写入缓冲区<br> 3.调用RGB2YUV的函数实现RGB到YUV数据的转换<br> 4.写YUV文件<br> 5.程序收尾工作（关闭文件，释放缓冲区）</p> 
<h3><a id="__75"></a>三. 实验原理及代码</h3> 
<p><strong>1.头文件BMP2YUV.h</strong><br> 头文件进行函数声明，方便函数调用</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;windows.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">BMP2YUV_H_</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BMP2YUV_H_</span></span>

<span class="token keyword">void</span> <span class="token function">BMP2RGB</span><span class="token punctuation">(</span><span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> FILE<span class="token operator">*</span> bmpfile<span class="token punctuation">,</span> BITMAPFILEHEADER<span class="token operator">&amp;</span> file_header<span class="token punctuation">,</span> BITMAPINFOHEADER<span class="token operator">&amp;</span> info_header<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> rgbout<span class="token punctuation">)</span><span class="token punctuation">;</span>
bool <span class="token function">MakePalette</span><span class="token punctuation">(</span>FILE<span class="token operator">*</span> bmpfile<span class="token punctuation">,</span> BITMAPFILEHEADER<span class="token operator">&amp;</span> file_header<span class="token punctuation">,</span> BITMAPINFOHEADER<span class="token operator">&amp;</span> info_header<span class="token punctuation">,</span> RGBQUAD<span class="token operator">*</span> rgbout<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">RGB2YUV</span><span class="token punctuation">(</span><span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> rgbbuf<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> ybuf<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> ubuf<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> vbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">DownYUV</span><span class="token punctuation">(</span><span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> utmp<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> vtmp<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> ubuf<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> vbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> 
<p><strong>2.main.cpp</strong><br> <em><strong>(1)程序初始化，定义变量和缓冲区</strong></em></p> 
<pre><code class="prism language-c">    FILE<span class="token operator">*</span> bmpfile <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">*</span> yuvfile <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	BITMAPFILEHEADER file_header<span class="token punctuation">;</span>
	BITMAPINFOHEADER info_header<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> rgbbuf <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> ybuf <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> ubuf <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> vbuf <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> width<span class="token punctuation">,</span> height<span class="token punctuation">;</span>
</code></pre> 
<p><strong>(2)定义输入输出:</strong><br> main()函数带有参数argc和argv，argc表示输入变量的个数，argv[0]为生成的.exe文件，后面依次为输入参数。<br> 本实验输入参数分别为五个bmp文件的文件名以及重复次数。在项目属性-调试-命令参数中，可以提前设置好输入参数。</p> 
<pre><code class="prism language-c">    <span class="token keyword">int</span> repeat_num<span class="token punctuation">;</span>
	<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> bmpfilename<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> yuvfilename<span class="token punctuation">;</span>
	bmpfilename<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	bmpfilename<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	bmpfilename<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	bmpfilename<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	bmpfilename<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	repeat_num <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	yuvfilename <span class="token operator">=</span> <span class="token string">"out.yuv"</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/f0/ec/oZiNaQaC_o.png" alt="在这里插入图片描述"><br> <strong>(3)读位图文件头及位图信息头</strong></p> 
<pre><code class="prism language-c"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">//判断文件是否能打开</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>bmpfile <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>bmpfilename<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"can't find bmpfilie"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>yuvfile <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>yuvfilename<span class="token punctuation">,</span> <span class="token string">"ab"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"can't find yuvfilie"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//读取文件头</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>file_header<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>BITMAPFILEHEADER<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> bmpfile<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"read file header error!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//判断是否为BMP文件</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>file_header<span class="token punctuation">.</span>bfType <span class="token operator">!=</span> <span class="token number">0x4D42</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"not bmp file"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"this is a bmp file!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//读取信息头</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>info_header<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>BITMAPINFOHEADER<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> bmpfile<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"read info header error!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
</code></pre> 
<p><strong>(4)保证每一行的数据量为4的整数倍，保证行数为偶数</strong></p> 
<pre><code class="prism language-c"><span class="token comment">//为了保证图像大小是4的倍数，所以每一行的数据量是4字节的整数倍</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>info_header<span class="token punctuation">.</span>biWidth <span class="token operator">%</span> <span class="token number">4</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			width <span class="token operator">=</span> info_header<span class="token punctuation">.</span>biWidth<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{<!-- --></span>
			width <span class="token operator">=</span> <span class="token punctuation">(</span>info_header<span class="token punctuation">.</span>biWidth <span class="token operator">*</span> info_header<span class="token punctuation">.</span>biBitCount <span class="token operator">+</span> <span class="token number">31</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">32</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">32</span> <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//（x+31）/32,结果为下取整，得到结果以后，再乘以32，就能得到比原位数大且是32倍数的数字，再除以8得到字节数</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//保证行数是偶数</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>info_header<span class="token punctuation">.</span>biHeight <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			height <span class="token operator">=</span> info_header<span class="token punctuation">.</span>biHeight<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{<!-- --></span>
			height <span class="token operator">=</span> info_header<span class="token punctuation">.</span>biHeight <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
</code></pre> 
<p><strong>(5)开辟缓冲区</strong></p> 
<pre><code class="prism language-c">        rgbbuf <span class="token operator">=</span> new <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">[</span>height <span class="token operator">*</span> width <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		ybuf <span class="token operator">=</span> new <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">[</span>height <span class="token operator">*</span> width<span class="token punctuation">]</span><span class="token punctuation">;</span>
		ubuf <span class="token operator">=</span> new <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">[</span>height <span class="token operator">*</span> width <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		vbuf <span class="token operator">=</span> new <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">[</span>height <span class="token operator">*</span> width <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> utmp <span class="token operator">=</span> new <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">[</span>height <span class="token operator">*</span> width<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> vtmp <span class="token operator">=</span> new <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">[</span>height <span class="token operator">*</span> width<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>(6)之后调用BMP2RGB函数将BMP转为RGB；</strong><br> <strong>调用RGB2YUV函数将RGB转为YUV，</strong><br> <strong>此时的YUV为4:4:4的取样结构，因此还需调用DownYUV进行下采样，使YUV的取样格式为4：2：0</strong></p> 
<pre><code class="prism language-c">        <span class="token function">BMP2RGB</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> bmpfile<span class="token punctuation">,</span> file_header<span class="token punctuation">,</span> info_header<span class="token punctuation">,</span> rgbbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">RGB2YUV</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> rgbbuf<span class="token punctuation">,</span> ybuf<span class="token punctuation">,</span> utmp<span class="token punctuation">,</span> vtmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">DownYUV</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> utmp<span class="token punctuation">,</span> vtmp<span class="token punctuation">,</span> ubuf<span class="token punctuation">,</span> vbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>（7）写入YUV</strong></p> 
<pre><code class="prism language-c">     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> repeat_num<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">fwrite</span><span class="token punctuation">(</span>ybuf<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> width <span class="token operator">*</span> height<span class="token punctuation">,</span> yuvfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">fwrite</span><span class="token punctuation">(</span>ubuf<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> width <span class="token operator">*</span> height <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">,</span> yuvfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">fwrite</span><span class="token punctuation">(</span>vbuf<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> width <span class="token operator">*</span> height <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">,</span> yuvfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
</code></pre> 
<p><strong>（8）释放缓冲区，关闭文件</strong></p> 
<pre><code class="prism language-c">        <span class="token keyword">if</span> <span class="token punctuation">(</span>rgbbuf<span class="token punctuation">)</span>
			delete<span class="token punctuation">[</span><span class="token punctuation">]</span> rgbbuf<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ybuf<span class="token punctuation">)</span>
			delete<span class="token punctuation">[</span><span class="token punctuation">]</span> ybuf<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ubuf<span class="token punctuation">)</span>
			delete<span class="token punctuation">[</span><span class="token punctuation">]</span> ubuf<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>vbuf<span class="token punctuation">)</span>
			delete<span class="token punctuation">[</span><span class="token punctuation">]</span> vbuf<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>utmp<span class="token punctuation">)</span>
			delete<span class="token punctuation">[</span><span class="token punctuation">]</span> utmp<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>vtmp<span class="token punctuation">)</span>
			delete<span class="token punctuation">[</span><span class="token punctuation">]</span> vtmp<span class="token punctuation">;</span>

		<span class="token function">fclose</span><span class="token punctuation">(</span>bmpfile<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token function">fclose</span><span class="token punctuation">(</span>yuvfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>3.BMP2RGB.cpp</strong><br> 因为BMP为倒序存放，所以读入BMP数据信息后，要进行倒序到正序的转化；<br> 然后根据每像素位数的不同，执行不同的操作：<br> 在24位图中直接取像素数据写RGB缓冲区，<br> 16位图中，最低的5位表示蓝色分量，中间的6位标识绿色分量，高的5位表示红色分量，需要位与移位取像素数据转换为8bit/彩色分量，写RGB缓冲区；<br> 8bit以下需要构造调色板，位与移位取像素数据，用掩码mask来遮蔽暂时不需要的比特位，查调色板，写RGB缓冲区。</p> 
<pre><code class="prism language-c">  <span class="token keyword">void</span> <span class="token function">BMP2RGB</span><span class="token punctuation">(</span><span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> FILE<span class="token operator">*</span> bmpfile<span class="token punctuation">,</span> BITMAPFILEHEADER<span class="token operator">&amp;</span> file_header<span class="token punctuation">,</span> BITMAPINFOHEADER<span class="token operator">&amp;</span> info_header<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> rgbout<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> loop<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> mask<span class="token punctuation">,</span> <span class="token operator">*</span> index_data<span class="token punctuation">,</span> <span class="token operator">*</span> data<span class="token punctuation">;</span>
	<span class="token keyword">int</span> w<span class="token punctuation">,</span> h<span class="token punctuation">;</span>
	w <span class="token operator">=</span> width <span class="token operator">*</span> info_header<span class="token punctuation">.</span>biBitCount<span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">;</span>
	h <span class="token operator">=</span> height<span class="token punctuation">;</span>
	<span class="token comment">//倒序前数据缓冲区</span>
	index_data <span class="token operator">=</span> new <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">[</span>h <span class="token operator">*</span> w<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token comment">//倒序后数据缓冲区</span>
	data <span class="token operator">=</span> new <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">[</span>h <span class="token operator">*</span> w<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token function">fseek</span><span class="token punctuation">(</span>bmpfile<span class="token punctuation">,</span> file_header<span class="token punctuation">.</span>bfOffBits<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fread</span><span class="token punctuation">(</span>index_data<span class="token punctuation">,</span> h <span class="token operator">*</span> w<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> bmpfile<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"read file error!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//倒序变正序</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> h<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> w<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			data<span class="token punctuation">[</span>i <span class="token operator">*</span> w <span class="token operator">+</span> j<span class="token punctuation">]</span> <span class="token operator">=</span> index_data<span class="token punctuation">[</span><span class="token punctuation">(</span>h <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> i<span class="token punctuation">)</span> <span class="token operator">*</span> w <span class="token operator">+</span> j<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//24位，直接将倒序后的缓存区数据复制给缓存输出区</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>info_header<span class="token punctuation">.</span>biBitCount <span class="token operator">==</span> <span class="token number">24</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">memcpy</span><span class="token punctuation">(</span>rgbout<span class="token punctuation">,</span> data<span class="token punctuation">,</span> h <span class="token operator">*</span> w<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//保存顺序是BGR</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//16位，位与移位取像素数据转换为8bit/彩色分量，写RGB缓冲区</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>info_header<span class="token punctuation">.</span>biBitCount <span class="token operator">==</span> <span class="token number">16</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>loop <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> loop <span class="token operator">&lt;</span> h <span class="token operator">*</span> w<span class="token punctuation">;</span> loop <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token operator">*</span>rgbout <span class="token operator">=</span> <span class="token punctuation">(</span>data<span class="token punctuation">[</span>loop<span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0x1F</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span>
			<span class="token operator">*</span><span class="token punctuation">(</span>rgbout <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>loop<span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0xE0</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>loop <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0x03</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token operator">*</span><span class="token punctuation">(</span>rgbout <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>data<span class="token punctuation">[</span>loop <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0x7C</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
			rgbout <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//8bit以下，位与移位取像素数据，查调色板，写RGB缓冲区</span>
	RGBQUAD<span class="token operator">*</span> pRGB <span class="token operator">=</span> <span class="token punctuation">(</span>RGBQUAD<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>RGBQUAD<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>info_header<span class="token punctuation">.</span>biBitCount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">MakePalette</span><span class="token punctuation">(</span>bmpfile<span class="token punctuation">,</span> file_header<span class="token punctuation">,</span> info_header<span class="token punctuation">,</span> pRGB<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"no palette"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>info_header<span class="token punctuation">.</span>biBitCount <span class="token operator">&lt;=</span> <span class="token number">8</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>loop <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> loop <span class="token operator">&lt;</span> h <span class="token operator">*</span> w<span class="token punctuation">;</span> loop<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">switch</span> <span class="token punctuation">(</span>info_header<span class="token punctuation">.</span>biBitCount<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
				mask <span class="token operator">=</span> <span class="token number">0x80</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
				mask <span class="token operator">=</span> <span class="token number">0xC0</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>
				mask <span class="token operator">=</span> <span class="token number">0xF0</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token number">8</span><span class="token operator">:</span>
				mask <span class="token operator">=</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">int</span> shiftcnt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
			<span class="token keyword">while</span> <span class="token punctuation">(</span>mask<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">unsigned</span> <span class="token keyword">char</span> index <span class="token operator">=</span> mask <span class="token operator">==</span> <span class="token number">0xFF</span> <span class="token operator">?</span> data<span class="token punctuation">[</span>loop<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>loop<span class="token punctuation">]</span> <span class="token operator">&amp;</span> mask<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token punctuation">(</span><span class="token number">8</span> <span class="token operator">-</span> shiftcnt <span class="token operator">*</span> info_header<span class="token punctuation">.</span>biBitCount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token operator">*</span>rgbout <span class="token operator">=</span> pRGB<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>rgbBlue<span class="token punctuation">;</span>
				<span class="token operator">*</span><span class="token punctuation">(</span>rgbout <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> pRGB<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>rgbGreen<span class="token punctuation">;</span>
				<span class="token operator">*</span><span class="token punctuation">(</span>rgbout <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> pRGB<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>rgbRed<span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>info_header<span class="token punctuation">.</span>biBitCount <span class="token operator">==</span> <span class="token number">8</span><span class="token punctuation">)</span>
					mask <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
				<span class="token keyword">else</span>
					mask <span class="token operator">&gt;&gt;=</span> info_header<span class="token punctuation">.</span>biBitCount<span class="token punctuation">;</span>
				rgbout <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">;</span>
				shiftcnt<span class="token operator">++</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>调色板MakePalette</strong></p> 
<pre><code class="prism language-c">  bool <span class="token function">MakePalette</span><span class="token punctuation">(</span>FILE<span class="token operator">*</span> bmpfile<span class="token punctuation">,</span> BITMAPFILEHEADER<span class="token operator">&amp;</span> file_header<span class="token punctuation">,</span> BITMAPINFOHEADER<span class="token operator">&amp;</span> info_header<span class="token punctuation">,</span> RGBQUAD<span class="token operator">*</span> rgbout<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>file_header<span class="token punctuation">.</span>bfOffBits <span class="token operator">-</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>BITMAPFILEHEADER<span class="token punctuation">)</span> <span class="token operator">-</span> info_header<span class="token punctuation">.</span>biSize<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>RGBQUAD<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> info_header<span class="token punctuation">.</span>biBitCount<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">fseek</span><span class="token punctuation">(</span>bmpfile<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>BITMAPFILEHEADER<span class="token punctuation">)</span> <span class="token operator">+</span> info_header<span class="token punctuation">.</span>biSize<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">fread</span><span class="token punctuation">(</span>rgbout<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>RGBQUAD<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> info_header<span class="token punctuation">.</span>biBitCount<span class="token punctuation">)</span><span class="token punctuation">,</span> bmpfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> true<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
		<span class="token keyword">return</span> false<span class="token punctuation">;</span>
</code></pre> 
<p><strong>4.RGB2YUV.cpp</strong><br> <strong>采用部分查找表法，提高运行效率</strong></p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">initLookupTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">256</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		RGBYUV02990<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token number">0.2990</span> <span class="token operator">*</span> i<span class="token punctuation">;</span>
		RGBYUV05870<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token number">0.5870</span> <span class="token operator">*</span> i<span class="token punctuation">;</span>
		RGBYUV01140<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token number">0.1140</span> <span class="token operator">*</span> i<span class="token punctuation">;</span>
		RGBYUV01684<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token number">0.1684</span> <span class="token operator">*</span> i<span class="token punctuation">;</span>
		RGBYUV03316<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token number">0.3316</span> <span class="token operator">*</span> i<span class="token punctuation">;</span>
		RGBYUV04187<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token number">0.4187</span> <span class="token operator">*</span> i<span class="token punctuation">;</span>
		RGBYUV00813<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token number">0.0813</span> <span class="token operator">*</span> i<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>RGB2YUV计算公式</strong><br> 要注意计算后的数据越界问题。超出最大范围的按照最大值处理，超出最小范围的按照最小值处理。</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">adjust</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> b<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> g<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> r<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> y<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> u<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> v<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">float</span> temp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	temp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">(</span>RGBYUV02990<span class="token punctuation">[</span><span class="token operator">*</span>r<span class="token punctuation">]</span> <span class="token operator">+</span> RGBYUV05870<span class="token punctuation">[</span><span class="token operator">*</span>g<span class="token punctuation">]</span> <span class="token operator">+</span> RGBYUV01140<span class="token punctuation">[</span><span class="token operator">*</span>b<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	temp <span class="token operator">&gt;</span> <span class="token number">235</span> <span class="token operator">?</span> <span class="token number">235</span> <span class="token operator">:</span> temp<span class="token punctuation">;</span>
	temp <span class="token operator">&lt;</span> <span class="token number">16</span> <span class="token operator">?</span> <span class="token number">16</span> <span class="token operator">:</span> temp<span class="token punctuation">;</span>
	<span class="token operator">*</span>y <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span>temp<span class="token punctuation">;</span>

	temp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">-</span>RGBYUV01684<span class="token punctuation">[</span><span class="token operator">*</span>r<span class="token punctuation">]</span> <span class="token operator">-</span> RGBYUV03316<span class="token punctuation">[</span><span class="token operator">*</span>g<span class="token punctuation">]</span> <span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">*</span>b<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token operator">+</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	temp <span class="token operator">&gt;</span> <span class="token number">240</span> <span class="token operator">?</span> <span class="token number">240</span> <span class="token operator">:</span> temp<span class="token punctuation">;</span>
	temp <span class="token operator">&lt;</span> <span class="token number">16</span> <span class="token operator">?</span> <span class="token number">16</span> <span class="token operator">:</span> temp<span class="token punctuation">;</span>
	<span class="token operator">*</span>u <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span>temp<span class="token punctuation">;</span>

	temp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>r<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token operator">-</span>RGBYUV04187<span class="token punctuation">[</span><span class="token operator">*</span>g<span class="token punctuation">]</span> <span class="token operator">-</span> RGBYUV00813<span class="token punctuation">[</span><span class="token operator">*</span>b<span class="token punctuation">]</span><span class="token operator">+</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	temp <span class="token operator">&gt;</span> <span class="token number">240</span> <span class="token operator">?</span> <span class="token number">240</span> <span class="token operator">:</span> temp<span class="token punctuation">;</span>
	temp <span class="token operator">&lt;</span> <span class="token number">16</span> <span class="token operator">?</span> <span class="token number">16</span> <span class="token operator">:</span> temp<span class="token punctuation">;</span>
	<span class="token operator">*</span>v <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span>temp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">RGB2YUV</span><span class="token punctuation">(</span><span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> rgbbuf<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> ybuf<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> ubuf<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> vbuf<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">initLookupTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">long</span> size<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>r<span class="token punctuation">,</span> <span class="token operator">*</span> g<span class="token punctuation">,</span> <span class="token operator">*</span> b<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>y<span class="token punctuation">,</span> <span class="token operator">*</span> u<span class="token punctuation">,</span> <span class="token operator">*</span> v<span class="token punctuation">;</span>

	size <span class="token operator">=</span> width <span class="token operator">*</span> height<span class="token punctuation">;</span>
	b <span class="token operator">=</span> rgbbuf<span class="token punctuation">;</span>
	y <span class="token operator">=</span> ybuf<span class="token punctuation">;</span>
	u <span class="token operator">=</span> ubuf<span class="token punctuation">;</span>
	v <span class="token operator">=</span> vbuf<span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		g <span class="token operator">=</span> b <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
		r <span class="token operator">=</span> b <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>
		<span class="token function">adjust</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span>g<span class="token punctuation">,</span>r<span class="token punctuation">,</span>y<span class="token punctuation">,</span>u<span class="token punctuation">,</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
		b <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">;</span>
		y<span class="token operator">++</span><span class="token punctuation">;</span>
		u<span class="token operator">++</span><span class="token punctuation">;</span>
		v<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	ybuf <span class="token operator">=</span> y<span class="token punctuation">;</span>
	ubuf <span class="token operator">=</span> u<span class="token punctuation">;</span>
	vbuf <span class="token operator">=</span> v<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>5.DownYUV.cpp</strong><br> 4:2:0取样结构如下，我们用小正方形内四个数据值的平均值作为一个色度数据，由此实现下采样。<br> <img src="https://images2.imgbox.com/f1/b9/1fJvuib7_o.jpg" alt="在这里插入图片描述"><br> <strong>代码：</strong></p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">DownYUV</span><span class="token punctuation">(</span><span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> utmp<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> vtmp<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> ubuf<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> vbuf<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> ut <span class="token operator">=</span> utmp<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> vt <span class="token operator">=</span> vtmp<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> ub <span class="token operator">=</span> ubuf<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> vb <span class="token operator">=</span> vbuf<span class="token punctuation">;</span>
	<span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> u<span class="token punctuation">,</span> v<span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> height <span class="token operator">*</span> width <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		u <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>ut <span class="token operator">+</span> k<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token operator">*</span><span class="token punctuation">(</span>ut <span class="token operator">+</span> k <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token operator">*</span><span class="token punctuation">(</span>ut <span class="token operator">+</span> width <span class="token operator">+</span> k<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token operator">*</span><span class="token punctuation">(</span>ut <span class="token operator">+</span> width <span class="token operator">+</span> k <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">4.0</span><span class="token punctuation">;</span>
		v <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>vt <span class="token operator">+</span> k<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token operator">*</span><span class="token punctuation">(</span>vt <span class="token operator">+</span> k <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token operator">*</span><span class="token punctuation">(</span>vt <span class="token operator">+</span> width <span class="token operator">+</span> k<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token operator">*</span><span class="token punctuation">(</span>vt <span class="token operator">+</span> width <span class="token operator">+</span> k <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">4.0</span><span class="token punctuation">;</span>
		<span class="token operator">*</span>ub <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span>u<span class="token punctuation">;</span>
		<span class="token operator">*</span>vb <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span>v<span class="token punctuation">;</span>
		ub<span class="token operator">++</span><span class="token punctuation">;</span>
		vb<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">(</span>width <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			k <span class="token operator">=</span> k <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">+</span> width<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
			k <span class="token operator">=</span> k <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	ubuf <span class="token operator">=</span> ub<span class="token punctuation">;</span>
	vbuf <span class="token operator">=</span> vb<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="__434"></a>四. 实验结果：</h3> 
<p><img src="https://images2.imgbox.com/77/6d/gUEeMIvk_o.gif" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c665c43f3471e97369a0cd5cbe0dda50/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">larave8中添加sql运行日志</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/880c57a13ae10a4b8d880819391cf38e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">IC验证-SDHOST项目1</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>