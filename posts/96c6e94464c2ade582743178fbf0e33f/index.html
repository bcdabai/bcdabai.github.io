<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【序列标注】kaggle实战系列-序列标注 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【序列标注】kaggle实战系列-序列标注" />
<meta property="og:description" content="数据：来自于98年人民日报NER语料
环境：TensorFlow 1.13.1
模型：BiLSTM-CRF
目录 一、任务描述二、数据说明三、模型架构概述模型结构模型实现细节 四、代码 一、任务描述 用seq_tag/data_path 中的数据训练模型，来完成序列标注任务（命名实体识别），识别出文本中的人名、地名和组织机构名。
二、数据说明 注：该数据集为小规模中文数据集，来自于98年人民日报NER语料
1.标签说明
{ B-PER：人名开始； I-PER：人名中间 ；B-LOC：地名开始， I-LOC：地名中间； B-ORG：机构名开始 ；I-ORG：机构名中间；O：其他 }
2.数据集格式说明
训练语料：
train_corpus.txt 文件为训练文本：
train_label.txt 文件为训练文本对应的每个字的标签：
如“周恩来”这个人名实体对应的标签B-PER, I-PER, I-PER。
测试语料：
test_corpus.txt 文件为测试文本，test_label.txt 文件为对应的标签，格式同上。
3.评价指标
采用准确率、召回率以及F1值来进行模型评价。
三、模型架构概述 输入层通过embedding获得词向量，表示层选择BiLSTM对词向量进行加工和表示，输出层未直接使用softmax来直接获得词对应的标签，而是通过CRF使得标注精度更高。
模型结构 模型实现细节 Word Embedding功能及完整思路：
1). 将训练数据集train_corpus.txt、train_label.txt进行遍历得到词典{字：[id, 出现次数]}，id为字对应的标签： {“O”:0;“B-PER”：1; “I-PER”：2 ; “B-LOC”：3; “I-LOC”：4; “B-ORG”：5; “I-ORG”：6} ，将7种标签转化为对应数字类型，便于模型处理；
2)设定出现次数阈值，去除词典中的低频词，重新生成词典{字：id}，这里丢弃低频词之后，出现次数便不再需要记录了；
3)对于训练数据中的每条语句，利用上一步生成的词典，将句子转化为id序列，再将所有的句子按照最长的一句话进行padding，得到句子的向量表示。
BiLSTM-CRF层功能及完整思路：
1). 功能：使用双向长短期记忆网络LSTM加条件随机场CRF的方式解决文本标注的问题，LSTM是RNN的加强版，主要解决RNN对距离较远文本之间关联较差的问题，其单向性也成为了相比于BiLSTM的不足之处。
2). BiLSTM模型更好地利用了文本上下文中的信息，相较于之前的模型LSTM，从上下文中获取了更多信息，从而减小了对词向量的依赖。但它也存在十分明显的缺点，其最终输出依赖于softmax输出概率最大的标签，使得相邻输出标签之间可能存在没有实际意义的连续标签。这个问题可以通用CRF来解决。
3). CRF计算整个标记序列的联合概率分布，优势是考虑了标签间的关系。
4). LSTM-CRF结合了上述两种模型。CRF将状态转移矩阵作为参数，并使用之前和之后的标签预测当前标签。
四、代码 环境配置：
!pip install tensorflow==1.13.1 如果环境有问题，kaggle终端使用conda init --user来初始化环境，再重新配置。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/96c6e94464c2ade582743178fbf0e33f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-13T21:17:04+08:00" />
<meta property="article:modified_time" content="2022-12-13T21:17:04+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【序列标注】kaggle实战系列-序列标注</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>数据：来自于98年人民日报<code>NER</code>语料<br> 环境：<code>TensorFlow 1.13.1</code><br> 模型：<code>BiLSTM-CRF</code></p> 
</blockquote> 
<p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#_6" rel="nofollow">一、任务描述</a></li><li><a href="#_10" rel="nofollow">二、数据说明</a></li><li><a href="#_27" rel="nofollow">三、模型架构概述</a></li><li><ul><li><a href="#_31" rel="nofollow">模型结构</a></li><li><a href="#_34" rel="nofollow">模型实现细节</a></li></ul> 
  </li><li><a href="#_44" rel="nofollow">四、代码</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_6"></a>一、任务描述</h2> 
<p>用<code>seq_tag/data_path</code> 中的数据训练模型，来完成序列标注任务（命名实体识别），识别出文本中的<strong>人名、地名和组织机构名</strong>。<br> <img src="https://images2.imgbox.com/a6/a4/s8aI7EkM_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_10"></a>二、数据说明</h2> 
<p>注：该数据集为小规模中文数据集，来自于98年人民日报<code>NER</code>语料<br> <strong>1.标签说明</strong><br> { <code>B-PER</code>：人名开始； <code>I-PER</code>：人名中间 ；<code>B-LOC</code>：地名开始， <code>I-LOC</code>：地名中间； <code>B-ORG</code>：机构名开始 ；<code>I-ORG</code>：机构名中间；<code>O</code>：其他 }<br> <strong>2.数据集格式说明</strong><br> 训练语料：<br> <code>train_corpus.txt</code> 文件为训练文本：<br> <img src="https://images2.imgbox.com/e3/9f/iRtr8wmL_o.png" alt="在这里插入图片描述"><br> <code>train_label.txt</code> 文件为训练文本对应的每个字的标签：<br> <img src="https://images2.imgbox.com/ec/ba/qlPZtmDF_o.png" alt="在这里插入图片描述"><br> 如“周恩来”这个人名实体对应的标签<code>B-PER</code>, <code>I-PER</code>, <code>I-PER</code>。<br> 测试语料：<br> <code>test_corpus.txt</code> 文件为测试文本，<code>test_label.txt</code> 文件为对应的标签，格式同上。</p> 
<p><strong>3.评价指标</strong><br> 采用<strong>准确率</strong>、<strong>召回率</strong>以及<strong>F1值</strong>来进行模型评价。</p> 
<h2><a id="_27"></a>三、模型架构概述</h2> 
<p>输入层通过<code>embedding</code>获得词向量，表示层选择<code>BiLSTM</code>对词向量进行加工和表示，输出层未直接使用<code>softmax</code>来直接获得词对应的标签，而是通过<code>CRF</code>使得标注精度更高。<br> <img src="https://images2.imgbox.com/c4/af/DxzHRbNE_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_31"></a>模型结构</h3> 
<p><img src="https://images2.imgbox.com/6a/b0/uknLuNw3_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_34"></a>模型实现细节</h3> 
<p><strong>Word Embedding功能及完整思路：</strong><br> 1). 将训练数据集<code>train_corpus.txt</code>、<code>train_label.txt</code>进行遍历得到词典<code>{字：[id, 出现次数]}</code>，<code>id</code>为字对应的标签： {“<code>O</code>”:0;“B-PER”：1; “<code>I-PER</code>”：2 ; “<code>B-LOC</code>”：3; “<code>I-LOC</code>”：4; “<code>B-ORG</code>”：5; “<code>I-ORG</code>”：6} ，将7种标签转化为对应数字类型，便于模型处理；<br> 2)设定出现次数阈值，去除词典中的低频词，重新生成词典<code>{字：id}</code>，这里丢弃低频词之后，出现次数便不再需要记录了；<br> 3)对于训练数据中的每条语句，利用上一步生成的词典，将句子转化为<code>id</code>序列，再将所有的句子按照最长的一句话进行<code>padding</code>，得到句子的向量表示。<br> <strong>BiLSTM-CRF层功能及完整思路：</strong><br> 1). 功能：使用双向长短期记忆网络<code>LSTM</code>加条件随机场<code>CRF</code>的方式解决文本标注的问题，<code>LSTM</code>是<code>RNN</code>的加强版，主要解决<code>RNN</code>对距离较远文本之间关联较差的问题，其单向性也成为了相比于<code>BiLSTM</code>的不足之处。<br> 2). <code>BiLSTM</code>模型更好地利用了文本上下文中的信息，相较于之前的模型<code>LSTM</code>，从上下文中获取了更多信息，从而减小了对词向量的依赖。但它也存在十分明显的缺点，其最终输出依赖于<code>softmax</code>输出概率最大的标签，使得<strong>相邻输出标签之间可能存在没有实际意义的连续标签</strong>。这个问题可以通用<code>CRF</code>来解决。<br> 3). <code>CRF</code>计算整个标记序列的联合概率分布，优势是考虑了标签间的关系。<br> 4). <code>LSTM-CRF</code>结合了上述两种模型。<code>CRF</code>将状态转移矩阵作为参数，并使用之前和之后的标签预测当前标签。</p> 
<h2><a id="_44"></a>四、代码</h2> 
<p>环境配置：</p> 
<pre><code class="prism language-handlebars"><span class="token punctuation">!</span><span class="token variable">pip</span> <span class="token variable">install</span> <span class="token variable">tensorflow</span><span class="token punctuation">=</span><span class="token punctuation">=</span><span class="token number">1.13</span><span class="token number">.1</span>
</code></pre> 
<p>如果环境有问题，<code>kaggle</code>终端使用<code>conda init --user</code>来初始化环境，再重新配置。<br> 对应：<code>data.py</code>，<code>kaggle</code>支持<code>markdown</code>，可以依次输入代码块，无需导包。</p> 
<pre><code class="prism language-handlebars"><span class="token variable">import</span> <span class="token variable">sys</span><span class="token punctuation">,</span> <span class="token variable">pickle</span><span class="token punctuation">,</span> <span class="token variable">os</span><span class="token punctuation">,</span> <span class="token variable">random</span>
<span class="token variable">import</span> <span class="token variable">numpy</span> <span class="token variable">as</span> <span class="token variable">np</span>
 
 
<span class="token punctuation">#</span><span class="token variable">第一步：数据处理</span>
<span class="token punctuation">#</span><span class="token variable">pikle是一个将任意复杂的对象转成对象的文本或二进制表示的过程。</span>
<span class="token punctuation">#</span><span class="token variable">同样，必须能够将对象经过序列化后的形式恢复到原有的对象。</span>
<span class="token punctuation">#</span><span class="token variable">在</span> <span class="token variable">Python</span> <span class="token variable">中，这种序列化过程称为</span> <span class="token variable">pickle，</span>
<span class="token punctuation">#</span><span class="token variable">可以将对象</span> <span class="token variable">pickle</span> <span class="token variable">成字符串、磁盘上的文件或者任何类似于文件的对象，</span>
<span class="token punctuation">#</span><span class="token variable">也可以将这些字符串、文件或任何类似于文件的对象</span> <span class="token variable">unpickle</span> <span class="token variable">成原来的对象。</span>
 
 
<span class="token punctuation">#</span><span class="token punctuation">#</span> <span class="token variable">tags</span><span class="token punctuation">,</span> <span class="token variable">BIO</span>
<span class="token variable">tag2label</span> <span class="token punctuation">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"O"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
             <span class="token string">"B-PER"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"I-PER"</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
             <span class="token string">"B-LOC"</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"I-LOC"</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
             <span class="token string">"B-ORG"</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">"I-ORG"</span><span class="token punctuation">:</span> <span class="token number">6</span>
             <span class="token punctuation">}</span>
 
 
<span class="token punctuation">#</span><span class="token variable">输入train_data文件的路径，读取训练集的语料，输出train_data</span>
<span class="token variable">def</span> <span class="token variable">read_corpus</span><span class="token punctuation">(</span><span class="token variable">corpus_path</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token string">""</span><span class="token punctuation">"</span>
    <span class="token variable">read</span> <span class="token variable">corpus</span> <span class="token variable">and</span> <span class="token variable">return</span> <span class="token variable">the</span> <span class="token variable">list</span> <span class="token variable">of</span> <span class="token variable">samples</span>
    <span class="token punctuation">:</span><span class="token variable">param</span> <span class="token variable">corpus_path</span><span class="token punctuation">:</span>
    <span class="token punctuation">:</span><span class="token variable">return</span><span class="token punctuation">:</span> <span class="token variable">data</span>
    <span class="token string">""</span><span class="token punctuation">"</span>
    <span class="token variable">data</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token variable">with</span> <span class="token variable">open</span><span class="token punctuation">(</span><span class="token variable">corpus_path</span><span class="token punctuation">,</span> <span class="token variable">encoding</span><span class="token punctuation">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token variable">as</span> <span class="token variable">fr</span><span class="token punctuation">:</span>
        <span class="token string">''</span><span class="token string">'lines的形状为['</span><span class="token variable">北</span><span class="token punctuation">\</span><span class="token variable">tB-LOC</span><span class="token punctuation">\</span><span class="token variable">n</span><span class="token string">','</span><span class="token variable">京</span><span class="token punctuation">\</span><span class="token variable">tI-LOC</span><span class="token punctuation">\</span><span class="token variable">n</span><span class="token string">','</span><span class="token variable">的</span><span class="token punctuation">\</span><span class="token variable">tO</span><span class="token punctuation">\</span><span class="token variable">n</span><span class="token string">','</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token string">']总共有2220537个字及对应的tag'</span><span class="token string">''</span>
        <span class="token variable">lines</span> <span class="token punctuation">=</span> <span class="token variable">fr</span><span class="token punctuation">.</span><span class="token variable">readlines</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token variable">sent_</span><span class="token punctuation">,</span> <span class="token variable">tag_</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token variable">for</span> <span class="token variable">line</span> <span class="token variable">in</span> <span class="token variable">lines</span><span class="token punctuation">:</span>
        <span class="token variable">if</span> <span class="token variable">line</span> <span class="token punctuation">!</span><span class="token punctuation">=</span> <span class="token string">'\n'</span><span class="token punctuation">:</span><span class="token punctuation">#</span><span class="token variable">每句话之间以换行符为区分</span>
            <span class="token punctuation">#</span> <span class="token variable">char</span> <span class="token variable">与</span> <span class="token variable">label之间有个空格</span>
            <span class="token punctuation">#</span> <span class="token variable">line</span><span class="token punctuation">.</span><span class="token variable">strip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token variable">的意思是去掉每句话句首句尾的空格</span>
            <span class="token punctuation">#</span> <span class="token punctuation">.</span><span class="token variable">split</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token variable">的意思是根据空格来把整句话切割成一片片独立的字符串放到数组中，同时删除句子中的换行符号</span><span class="token punctuation">\</span><span class="token variable">n</span>
            <span class="token brackets"><span class="token punctuation">[</span><span class="token variable">char, label</span><span class="token punctuation">]</span></span> <span class="token punctuation">=</span> <span class="token variable">line</span><span class="token punctuation">.</span><span class="token variable">strip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token variable">split</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">#</span> <span class="token variable">把一个个的字放进sent_</span>
            <span class="token variable">sent_</span><span class="token punctuation">.</span><span class="token variable">append</span><span class="token punctuation">(</span><span class="token variable">char</span><span class="token punctuation">)</span>
            <span class="token punctuation">#</span> <span class="token variable">把字后面的tag放进tag_</span>
            <span class="token variable">tag_</span><span class="token punctuation">.</span><span class="token variable">append</span><span class="token punctuation">(</span><span class="token variable">label</span><span class="token punctuation">)</span>
        <span class="token variable">else</span><span class="token punctuation">:</span><span class="token punctuation">#</span><span class="token variable">一句话结束了，添加到data</span>
            <span class="token variable">data</span><span class="token punctuation">.</span><span class="token variable">append</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">sent_</span><span class="token punctuation">,</span> <span class="token variable">tag_</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token variable">sent_</span><span class="token punctuation">,</span> <span class="token variable">tag_</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token string">""</span><span class="token punctuation">"</span> <span class="token variable">data的形状为</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'我'</span><span class="token punctuation">,</span><span class="token variable">在</span><span class="token string">'北'</span><span class="token punctuation">,</span><span class="token string">'京'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string">'O'</span><span class="token punctuation">,</span><span class="token string">'O'</span><span class="token punctuation">,</span><span class="token string">'B-LOC'</span><span class="token punctuation">,</span><span class="token string">'I-LOC'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token variable">第一句话</span>
                         <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'我'</span><span class="token punctuation">,</span><span class="token variable">在</span><span class="token string">'天'</span><span class="token punctuation">,</span><span class="token string">'安'</span><span class="token punctuation">,</span><span class="token string">'门'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string">'O'</span><span class="token punctuation">,</span><span class="token string">'O'</span><span class="token punctuation">,</span><span class="token string">'B-LOC'</span><span class="token punctuation">,</span><span class="token string">'I-LOC'</span><span class="token punctuation">,</span><span class="token string">'I-LOC'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token variable">第二句话</span>  
                          <span class="token punctuation">(</span> <span class="token variable">第三句话</span> <span class="token punctuation">)</span>  <span class="token punctuation">]</span> <span class="token variable">总共有</span><span class="token number">50658</span><span class="token variable">句话</span><span class="token string">""</span><span class="token punctuation">"</span>
    <span class="token variable">return</span> <span class="token variable">data</span>
 
 
<span class="token punctuation">#</span><span class="token variable">由train_data来构造一个</span><span class="token punctuation">(</span><span class="token variable">统计非重复字</span><span class="token punctuation">)</span><span class="token variable">字典</span><span class="token punctuation">{<!-- --></span><span class="token string">'第一个字'</span><span class="token punctuation">:</span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">对应的id,该字出现的次数</span><span class="token punctuation">]</span></span><span class="token punctuation">,</span><span class="token string">'第二个字'</span><span class="token punctuation">:</span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">对应的id,该字出现的次数</span><span class="token punctuation">]</span></span><span class="token punctuation">,</span> <span class="token punctuation">,</span> <span class="token punctuation">,</span><span class="token punctuation">}</span>
<span class="token punctuation">#</span><span class="token variable">去除低频词，生成一个word_id的字典并保存在输入的vocab_path的路径下，</span>
<span class="token punctuation">#</span><span class="token variable">保存的方法是pickle模块自带的dump方法，保存后的文件格式是word2id</span><span class="token punctuation">.</span><span class="token variable">pkl文件</span>
<span class="token variable">def</span> <span class="token variable">vocab_build</span><span class="token punctuation">(</span><span class="token variable">vocab_path</span><span class="token punctuation">,</span> <span class="token variable">corpus_path</span><span class="token punctuation">,</span> <span class="token variable">min_count</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token string">""</span><span class="token punctuation">"</span>
    <span class="token punctuation">:</span><span class="token variable">param</span> <span class="token variable">vocab_path</span><span class="token punctuation">:</span>
    <span class="token punctuation">:</span><span class="token variable">param</span> <span class="token variable">corpus_path</span><span class="token punctuation">:</span>
    <span class="token punctuation">:</span><span class="token variable">param</span> <span class="token variable">min_count</span><span class="token punctuation">:</span>
    <span class="token punctuation">:</span><span class="token variable">return</span><span class="token punctuation">:</span>
    <span class="token string">""</span><span class="token punctuation">"</span>
    <span class="token variable">data</span> <span class="token punctuation">=</span> <span class="token variable">read_corpus</span><span class="token punctuation">(</span><span class="token variable">corpus_path</span><span class="token punctuation">)</span>
    <span class="token variable">word2id</span> <span class="token punctuation">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token punctuation">#</span><span class="token variable">sent_的形状为</span><span class="token punctuation">[</span><span class="token string">'我'</span><span class="token punctuation">,</span><span class="token string">'在'</span><span class="token punctuation">,</span><span class="token string">'北'</span><span class="token punctuation">,</span><span class="token string">'京'</span><span class="token punctuation">]</span><span class="token variable">，对应的tag_为</span><span class="token punctuation">[</span><span class="token string">'O'</span><span class="token punctuation">,</span><span class="token string">'O'</span><span class="token punctuation">,</span><span class="token string">'B-LOC'</span><span class="token punctuation">,</span><span class="token string">'I-LOC'</span><span class="token punctuation">]</span>
    <span class="token variable">for</span> <span class="token variable">sent_</span><span class="token punctuation">,</span> <span class="token variable">tag_</span> <span class="token variable">in</span> <span class="token variable">data</span><span class="token punctuation">:</span>
        <span class="token variable">for</span> <span class="token variable">word</span> <span class="token variable">in</span> <span class="token variable">sent_</span><span class="token punctuation">:</span>
            <span class="token punctuation">#</span> <span class="token variable">如果字符串只包含数字则返回</span> <span class="token variable">True</span> <span class="token variable">否则返回</span> <span class="token variable">False。</span>
            <span class="token variable">if</span> <span class="token variable">word</span><span class="token punctuation">.</span><span class="token variable">isdigit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token variable">word</span> <span class="token punctuation">=</span> <span class="token string">'&lt;NUM&gt;'</span>
            <span class="token block keyword">#A-Z：(\u0041-\u005a)</span>    <span class="token variable">a-z</span> <span class="token variable">：</span><span class="token punctuation">\</span><span class="token variable">u0061-</span><span class="token punctuation">\</span><span class="token variable">u007a</span>
            <span class="token variable">elif</span> <span class="token punctuation">(</span><span class="token string">'\u0041'</span> <span class="token punctuation">&lt;</span><span class="token punctuation">=</span> <span class="token variable">word</span> <span class="token punctuation">&lt;</span><span class="token punctuation">=</span><span class="token string">'\u005a'</span><span class="token punctuation">)</span> <span class="token variable">or</span> <span class="token punctuation">(</span><span class="token string">'\u0061'</span> <span class="token punctuation">&lt;</span><span class="token punctuation">=</span> <span class="token variable">word</span> <span class="token punctuation">&lt;</span><span class="token punctuation">=</span><span class="token string">'\u007a'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token variable">word</span> <span class="token punctuation">=</span> <span class="token string">'&lt;ENG&gt;'</span>
            <span class="token variable">if</span> <span class="token variable">word</span> <span class="token variable">not</span> <span class="token variable">in</span> <span class="token variable">word2id</span><span class="token punctuation">:</span><span class="token punctuation">#</span><span class="token variable">是新词</span>
                <span class="token punctuation">#</span> <span class="token punctuation">[</span><span class="token variable">len</span><span class="token punctuation">(</span><span class="token variable">word2id</span><span class="token punctuation">)</span><span class="token punctuation">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token variable">用来统计</span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">位置标签，出现次数</span><span class="token punctuation">]</span></span><span class="token variable">，第一次出现定为</span><span class="token number">1</span>
                <span class="token variable">word2id</span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">word</span><span class="token punctuation">]</span></span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token variable">len</span><span class="token punctuation">(</span><span class="token variable">word2id</span><span class="token punctuation">)</span><span class="token punctuation">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">#</span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">对应的id，出现的次数</span><span class="token punctuation">]</span></span>
            <span class="token variable">else</span><span class="token punctuation">:</span><span class="token punctuation">#</span><span class="token variable">不是新词</span>
                <span class="token punctuation">#</span> <span class="token variable">word2id</span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">word</span><span class="token punctuation">]</span></span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token variable">实现对词频的统计，出现次数累加</span><span class="token number">1</span>
                <span class="token variable">word2id</span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">word</span><span class="token punctuation">]</span></span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">+</span><span class="token punctuation">=</span> <span class="token number">1</span>
 
 
    <span class="token block keyword">#其实前面统计词频的目的就是这里删除低频词，删除完之后也就不用统计词频了</span>
    <span class="token block keyword">#用来统计低频词</span>
    <span class="token variable">low_freq_words</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token variable">for</span> <span class="token variable">word</span><span class="token punctuation">,</span> <span class="token brackets"><span class="token punctuation">[</span><span class="token variable">word_id, word_freq</span><span class="token punctuation">]</span></span> <span class="token variable">in</span> <span class="token variable">word2id</span><span class="token punctuation">.</span><span class="token variable">items</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token punctuation">#</span><span class="token variable">寻找低于某个数字的低频词</span>
        <span class="token variable">if</span> <span class="token variable">word_freq</span> <span class="token punctuation">&lt;</span> <span class="token variable">min_count</span> <span class="token variable">and</span> <span class="token variable">word</span> <span class="token punctuation">!</span><span class="token punctuation">=</span> <span class="token string">'&lt;NUM&gt;'</span> <span class="token variable">and</span> <span class="token variable">word</span> <span class="token punctuation">!</span><span class="token punctuation">=</span> <span class="token string">'&lt;ENG&gt;'</span><span class="token punctuation">:</span>
            <span class="token variable">low_freq_words</span><span class="token punctuation">.</span><span class="token variable">append</span><span class="token punctuation">(</span><span class="token variable">word</span><span class="token punctuation">)</span>
    <span class="token variable">for</span> <span class="token variable">word</span> <span class="token variable">in</span> <span class="token variable">low_freq_words</span><span class="token punctuation">:</span>
        <span class="token punctuation">#</span> <span class="token variable">把这些低频词从字典中删除</span>
        <span class="token variable">del</span> <span class="token variable">word2id</span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">word</span><span class="token punctuation">]</span></span>
 
    <span class="token punctuation">#</span> <span class="token variable">删除低频词后为每个字重新建立id，而不再统计词频</span>
    <span class="token variable">new_id</span> <span class="token punctuation">=</span> <span class="token number">1</span>
    <span class="token variable">for</span> <span class="token variable">word</span> <span class="token variable">in</span> <span class="token variable">word2id</span><span class="token punctuation">.</span><span class="token variable">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token variable">word2id</span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">word</span><span class="token punctuation">]</span></span> <span class="token punctuation">=</span> <span class="token variable">new_id</span>
        <span class="token variable">new_id</span> <span class="token punctuation">+</span><span class="token punctuation">=</span> <span class="token number">1</span>
    <span class="token variable">word2id</span><span class="token punctuation">[</span><span class="token string">'&lt;UNK&gt;'</span><span class="token punctuation">]</span> <span class="token punctuation">=</span> <span class="token variable">new_id</span>
    <span class="token variable">word2id</span><span class="token punctuation">[</span><span class="token string">'&lt;PAD&gt;'</span><span class="token punctuation">]</span> <span class="token punctuation">=</span> <span class="token number">0</span>
 
    <span class="token variable">print</span><span class="token punctuation">(</span><span class="token variable">len</span><span class="token punctuation">(</span><span class="token variable">word2id</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token variable">with</span> <span class="token variable">open</span><span class="token punctuation">(</span><span class="token variable">vocab_path</span><span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token variable">as</span> <span class="token variable">fw</span><span class="token punctuation">:</span>
        <span class="token punctuation">#</span> <span class="token variable">序列化到名字为word2id</span><span class="token punctuation">.</span><span class="token variable">pkl文件</span>
        <span class="token variable">pickle</span><span class="token punctuation">.</span><span class="token variable">dump</span><span class="token punctuation">(</span><span class="token variable">word2id</span><span class="token punctuation">,</span> <span class="token variable">fw</span><span class="token punctuation">)</span>
 
 
<span class="token punctuation">#</span><span class="token variable">输入一句话，生成一个</span> <span class="token variable">sentence_id</span>
<span class="token string">''</span><span class="token string">'sentence_id的形状为[1,2,3,4,...]对应的sent为['</span><span class="token variable">当</span><span class="token string">','</span><span class="token variable">希</span><span class="token string">','</span><span class="token variable">望</span><span class="token string">','</span><span class="token variable">工</span><span class="token string">',程'</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token string">''</span><span class="token punctuation">'</span>
<span class="token variable">def</span> <span class="token variable">sentence2id</span><span class="token punctuation">(</span><span class="token variable">sent</span><span class="token punctuation">,</span> <span class="token variable">word2id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token string">""</span><span class="token punctuation">"</span>
    <span class="token punctuation">:</span><span class="token variable">param</span> <span class="token variable">sent</span><span class="token punctuation">:</span>
    <span class="token punctuation">:</span><span class="token variable">param</span> <span class="token variable">word2id</span><span class="token punctuation">:</span>
    <span class="token punctuation">:</span><span class="token variable">return</span><span class="token punctuation">:</span>
    <span class="token string">""</span><span class="token punctuation">"</span>
    <span class="token variable">sentence_id</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token variable">for</span> <span class="token variable">word</span> <span class="token variable">in</span> <span class="token variable">sent</span><span class="token punctuation">:</span>
        <span class="token variable">if</span> <span class="token variable">word</span><span class="token punctuation">.</span><span class="token variable">isdigit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token variable">word</span> <span class="token punctuation">=</span> <span class="token string">'&lt;NUM&gt;'</span>
        <span class="token variable">elif</span> <span class="token punctuation">(</span><span class="token string">'\u0041'</span> <span class="token punctuation">&lt;</span><span class="token punctuation">=</span> <span class="token variable">word</span> <span class="token punctuation">&lt;</span><span class="token punctuation">=</span> <span class="token string">'\u005a'</span><span class="token punctuation">)</span> <span class="token variable">or</span> <span class="token punctuation">(</span><span class="token string">'\u0061'</span> <span class="token punctuation">&lt;</span><span class="token punctuation">=</span> <span class="token variable">word</span> <span class="token punctuation">&lt;</span><span class="token punctuation">=</span> <span class="token string">'\u007a'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token variable">word</span> <span class="token punctuation">=</span> <span class="token string">'&lt;ENG&gt;'</span>
        <span class="token variable">if</span> <span class="token variable">word</span> <span class="token variable">not</span> <span class="token variable">in</span> <span class="token variable">word2id</span><span class="token punctuation">:</span>
            <span class="token variable">word</span> <span class="token punctuation">=</span> <span class="token string">'&lt;UNK&gt;'</span>
        <span class="token variable">sentence_id</span><span class="token punctuation">.</span><span class="token variable">append</span><span class="token punctuation">(</span><span class="token variable">word2id</span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">word</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span>
    <span class="token variable">return</span> <span class="token variable">sentence_id</span>
 
<span class="token punctuation">#</span><span class="token variable">通过pickle模块自带的load方法</span><span class="token punctuation">(</span><span class="token variable">反序列化方法</span><span class="token punctuation">)</span><span class="token variable">加载输出word2id</span>
<span class="token variable">def</span> <span class="token variable">read_dictionary</span><span class="token punctuation">(</span><span class="token variable">vocab_path</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token string">""</span><span class="token punctuation">"</span>
    <span class="token punctuation">:</span><span class="token variable">param</span> <span class="token variable">vocab_path</span><span class="token punctuation">:</span>
    <span class="token punctuation">:</span><span class="token variable">return</span><span class="token punctuation">:</span>
    <span class="token string">""</span><span class="token punctuation">"</span>
    <span class="token variable">vocab_path</span> <span class="token punctuation">=</span> <span class="token variable">os</span><span class="token punctuation">.</span><span class="token variable">path</span><span class="token punctuation">.</span><span class="token variable">join</span><span class="token punctuation">(</span><span class="token variable">vocab_path</span><span class="token punctuation">)</span>
    <span class="token variable">with</span> <span class="token variable">open</span><span class="token punctuation">(</span><span class="token variable">vocab_path</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token variable">as</span> <span class="token variable">fr</span><span class="token punctuation">:</span>
        <span class="token punctuation">#</span><span class="token variable">反序列化方法加载输出</span>
        <span class="token variable">word2id</span> <span class="token punctuation">=</span> <span class="token variable">pickle</span><span class="token punctuation">.</span><span class="token variable">load</span><span class="token punctuation">(</span><span class="token variable">fr</span><span class="token punctuation">)</span>
    <span class="token variable">print</span><span class="token punctuation">(</span><span class="token string">'vocab_size:'</span><span class="token punctuation">,</span> <span class="token variable">len</span><span class="token punctuation">(</span><span class="token variable">word2id</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token variable">return</span> <span class="token variable">word2id</span>
<span class="token string">''</span><span class="token string">'word2id的形状为{'</span><span class="token variable">当</span><span class="token string">': 1, '</span><span class="token variable">希</span><span class="token string">': 2, '</span><span class="token variable">望</span><span class="token string">': 3, '</span><span class="token variable">工</span><span class="token string">': 4, '</span><span class="token variable">程</span><span class="token string">': 5,。。'</span><span class="token punctuation">&lt;</span><span class="token variable">UNK</span><span class="token punctuation">&gt;</span><span class="token string">': 3904, '</span><span class="token punctuation">&lt;</span><span class="token variable">PAD</span><span class="token punctuation">&gt;</span><span class="token punctuation">'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span>
   <span class="token variable">总共</span><span class="token number">3903</span><span class="token variable">个字</span><span class="token string">''</span><span class="token punctuation">'</span>
 
 
<span class="token punctuation">#</span><span class="token variable">输入vocab，vocab就是前面得到的word2id，embedding_dim</span><span class="token punctuation">=</span><span class="token number">300</span>
<span class="token variable">def</span> <span class="token variable">random_embedding</span><span class="token punctuation">(</span><span class="token variable">vocab</span><span class="token punctuation">,</span> <span class="token variable">embedding_dim</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token string">""</span><span class="token punctuation">"</span>
    <span class="token punctuation">:</span><span class="token variable">param</span> <span class="token variable">vocab</span><span class="token punctuation">:</span>
    <span class="token punctuation">:</span><span class="token variable">param</span> <span class="token variable">embedding_dim</span><span class="token punctuation">:</span>
    <span class="token punctuation">:</span><span class="token variable">return</span><span class="token punctuation">:</span>
    <span class="token string">""</span><span class="token punctuation">"</span>
    <span class="token punctuation">#</span> <span class="token variable">返回一个len</span><span class="token punctuation">(</span><span class="token variable">vocab</span><span class="token punctuation">)</span><span class="token punctuation">*</span><span class="token variable">embedding_dim</span><span class="token punctuation">=</span><span class="token number">3905</span><span class="token punctuation">*</span><span class="token number">300</span><span class="token variable">的矩阵</span><span class="token punctuation">(</span><span class="token variable">每个字投射到</span><span class="token number">300</span><span class="token variable">维</span><span class="token punctuation">)</span><span class="token variable">作为初始值</span>
    <span class="token punctuation">#</span><span class="token variable">numpy</span><span class="token punctuation">.</span><span class="token variable">random</span><span class="token punctuation">.</span><span class="token variable">uniform</span><span class="token punctuation">(</span><span class="token variable">low</span><span class="token punctuation">,</span><span class="token variable">high</span><span class="token punctuation">,</span><span class="token variable">size</span><span class="token punctuation">)</span><span class="token variable">功能：从一个均匀分布</span><span class="token punctuation">[</span><span class="token variable">low</span><span class="token punctuation">,</span><span class="token variable">high</span><span class="token punctuation">)</span><span class="token variable">中随机采样，注意定义域是左闭右开，即包含low，不包含high</span><span class="token punctuation">.</span>
    <span class="token punctuation">#</span> <span class="token variable">参数介绍</span><span class="token punctuation">:</span>
    <span class="token punctuation">#</span>     
    <span class="token punctuation">#</span>     <span class="token variable">low</span><span class="token punctuation">:</span> <span class="token variable">采样下界，float类型，默认值为</span><span class="token number">0</span><span class="token variable">；</span>
    <span class="token punctuation">#</span>     <span class="token variable">high</span><span class="token punctuation">:</span> <span class="token variable">采样上界，float类型，默认值为</span><span class="token number">1</span><span class="token variable">；</span>
    <span class="token punctuation">#</span>     <span class="token variable">size</span><span class="token punctuation">:</span> <span class="token variable">输出样本数目，为int或元组</span><span class="token punctuation">(</span><span class="token variable">tuple</span><span class="token punctuation">)</span>
    <span class="token punctuation">#</span> <span class="token variable">类型，例如，size</span> <span class="token punctuation">=</span> <span class="token punctuation">(</span><span class="token variable">m</span><span class="token punctuation">,</span> <span class="token variable">n</span><span class="token punctuation">,</span> <span class="token variable">k</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">则输出m</span> <span class="token punctuation">*</span> <span class="token variable">n</span> <span class="token punctuation">*</span> <span class="token variable">k个样本，缺省时输出</span><span class="token number">1</span><span class="token variable">个值。</span>
    <span class="token punctuation">#</span>
    <span class="token punctuation">#</span> <span class="token variable">返回值：ndarray类型，其形状和参数size中描述一致。</span>
    <span class="token variable">embedding_mat</span> <span class="token punctuation">=</span> <span class="token variable">np</span><span class="token punctuation">.</span><span class="token variable">random</span><span class="token punctuation">.</span><span class="token variable">uniform</span><span class="token punctuation">(</span><span class="token variable">-</span><span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token variable">len</span><span class="token punctuation">(</span><span class="token variable">vocab</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">embedding_dim</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token variable">embedding_mat</span> <span class="token punctuation">=</span> <span class="token variable">np</span><span class="token punctuation">.</span><span class="token variable">float32</span><span class="token punctuation">(</span><span class="token variable">embedding_mat</span><span class="token punctuation">)</span>
    <span class="token variable">return</span> <span class="token variable">embedding_mat</span>
 
 
<span class="token punctuation">#</span><span class="token variable">padding</span><span class="token punctuation">,</span><span class="token variable">输入一句话，不够标准的样本用pad_mark来补齐</span>
<span class="token string">''</span><span class="token punctuation">'</span> 
<span class="token variable">输入：seqs的形状为二维矩阵，形状为</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">33</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">17</span><span class="token punctuation">,</span><span class="token number">88</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">]</span><span class="token variable">-第一句话</span>
                                 <span class="token punctuation">[</span><span class="token number">52</span><span class="token punctuation">,</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token number">66</span><span class="token punctuation">,</span><span class="token number">31</span><span class="token punctuation">,</span><span class="token number">89</span><span class="token punctuation">]</span><span class="token variable">-第二句话</span>
                                                    <span class="token punctuation">]</span> 
<span class="token variable">输出：seq_list为seqs经过padding后的序列</span>
      <span class="token variable">seq_len_list保留了padding之前每条样本的真实长度</span>
      <span class="token variable">seq_list和seq_len_list用来喂给feed_dict</span>
<span class="token string">''</span><span class="token punctuation">'</span>
<span class="token variable">def</span> <span class="token variable">pad_sequences</span><span class="token punctuation">(</span><span class="token variable">sequences</span><span class="token punctuation">,</span> <span class="token variable">pad_mark</span><span class="token punctuation">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token string">""</span><span class="token punctuation">"</span>
    <span class="token punctuation">:</span><span class="token variable">param</span> <span class="token variable">sequences</span><span class="token punctuation">:</span>
    <span class="token punctuation">:</span><span class="token variable">param</span> <span class="token variable">pad_mark</span><span class="token punctuation">:</span>
    <span class="token punctuation">:</span><span class="token variable">return</span><span class="token punctuation">:</span>
    <span class="token string">""</span><span class="token punctuation">"</span>
    <span class="token punctuation">#</span> <span class="token variable">返回一个序列中长度最长的那条样本的长度</span>
    <span class="token variable">max_len</span> <span class="token punctuation">=</span> <span class="token variable">max</span><span class="token punctuation">(</span><span class="token variable">map</span><span class="token punctuation">(</span><span class="token variable">lambda</span> <span class="token variable">x</span> <span class="token punctuation">:</span> <span class="token variable">len</span><span class="token punctuation">(</span><span class="token variable">x</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">sequences</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token variable">seq_list</span><span class="token punctuation">,</span> <span class="token variable">seq_len_list</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token variable">for</span> <span class="token variable">seq</span> <span class="token variable">in</span> <span class="token variable">sequences</span><span class="token punctuation">:</span>
        <span class="token punctuation">#</span> <span class="token variable">由元组格式</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token variable">转化为列表格式</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token variable">seq</span> <span class="token punctuation">=</span> <span class="token variable">list</span><span class="token punctuation">(</span><span class="token variable">seq</span><span class="token punctuation">)</span>
        <span class="token punctuation">#</span> <span class="token variable">不够最大长度的样本用</span><span class="token number">0</span><span class="token variable">补上放到列表seq_list</span>
        <span class="token variable">seq_</span> <span class="token punctuation">=</span> <span class="token variable">seq</span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">:max_len</span><span class="token punctuation">]</span></span> <span class="token punctuation">+</span> <span class="token brackets"><span class="token punctuation">[</span><span class="token variable">pad_mark</span><span class="token punctuation">]</span></span> <span class="token punctuation">*</span> <span class="token variable">max</span><span class="token punctuation">(</span><span class="token variable">max_len</span> <span class="token variable">-</span> <span class="token variable">len</span><span class="token punctuation">(</span><span class="token variable">seq</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">#</span><span class="token variable">seq_list为sequences经过padding后的序列</span>
        <span class="token variable">seq_list</span><span class="token punctuation">.</span><span class="token variable">append</span><span class="token punctuation">(</span><span class="token variable">seq_</span><span class="token punctuation">)</span>
        <span class="token punctuation">#</span> <span class="token variable">seq_len_list用来统计每个样本的真实长度</span>
        <span class="token variable">seq_len_list</span><span class="token punctuation">.</span><span class="token variable">append</span><span class="token punctuation">(</span><span class="token variable">min</span><span class="token punctuation">(</span><span class="token variable">len</span><span class="token punctuation">(</span><span class="token variable">seq</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">max_len</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token variable">return</span> <span class="token variable">seq_list</span><span class="token punctuation">,</span> <span class="token variable">seq_len_list</span>
 
 
<span class="token punctuation">#</span><span class="token variable">生成batch</span>
<span class="token string">''</span><span class="token punctuation">'</span> <span class="token variable">seqs的形状为二维矩阵，形状为</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">33</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">17</span><span class="token punctuation">,</span><span class="token number">88</span><span class="token punctuation">,</span><span class="token number">50.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token variable">第一句话</span>
                                <span class="token punctuation">[</span><span class="token number">52</span><span class="token punctuation">,</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token number">66.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token variable">第二句话</span>
                                                    <span class="token punctuation">]</span> 
   <span class="token variable">labels的形状为二维矩阵，形状为</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token variable">第一句话</span>
                                 <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token variable">第二句话</span>
                                             <span class="token punctuation">]</span>
<span class="token string">''</span><span class="token punctuation">'</span>
<span class="token variable">def</span> <span class="token variable">batch_yield</span><span class="token punctuation">(</span><span class="token variable">data</span><span class="token punctuation">,</span> <span class="token variable">batch_size</span><span class="token punctuation">,</span> <span class="token variable">vocab</span><span class="token punctuation">,</span> <span class="token variable">tag2label</span><span class="token punctuation">,</span> <span class="token variable">shuffle</span><span class="token punctuation">=</span><span class="token variable">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token string">""</span><span class="token punctuation">"</span>
    <span class="token punctuation">:</span><span class="token variable">param</span> <span class="token variable">data</span><span class="token punctuation">:</span>
    <span class="token punctuation">:</span><span class="token variable">param</span> <span class="token variable">batch_size</span><span class="token punctuation">:</span>
    <span class="token punctuation">:</span><span class="token variable">param</span> <span class="token variable">vocab</span><span class="token punctuation">:</span>
    <span class="token punctuation">:</span><span class="token variable">param</span> <span class="token variable">tag2label</span><span class="token punctuation">:</span>
    <span class="token punctuation">:</span><span class="token variable">param</span> <span class="token variable">shuffle</span><span class="token punctuation">:</span>
    <span class="token punctuation">:</span><span class="token variable">return</span><span class="token punctuation">:</span>
    <span class="token string">""</span><span class="token punctuation">"</span>
    <span class="token variable">if</span> <span class="token variable">shuffle</span><span class="token punctuation">:</span>
        <span class="token variable">random</span><span class="token punctuation">.</span><span class="token variable">shuffle</span><span class="token punctuation">(</span><span class="token variable">data</span><span class="token punctuation">)</span>
 
    <span class="token variable">seqs</span><span class="token punctuation">,</span> <span class="token variable">labels</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token variable">for</span> <span class="token punctuation">(</span><span class="token variable">sent_</span><span class="token punctuation">,</span> <span class="token variable">tag_</span><span class="token punctuation">)</span> <span class="token variable">in</span> <span class="token variable">data</span><span class="token punctuation">:</span><span class="token punctuation">#</span><span class="token variable">data形状</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'我'</span><span class="token punctuation">,</span><span class="token variable">在</span><span class="token string">'北'</span><span class="token punctuation">,</span><span class="token string">'京'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string">'O'</span><span class="token punctuation">,</span><span class="token string">'O'</span><span class="token punctuation">,</span><span class="token string">'B-LOC'</span><span class="token punctuation">,</span><span class="token string">'I-LOC'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token punctuation">#</span> <span class="token variable">sent_的形状为</span><span class="token punctuation">[</span><span class="token number">33</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">17</span><span class="token punctuation">,</span><span class="token number">88</span><span class="token punctuation">,</span><span class="token number">50.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token variable">句中的字在Wordid对应的位置标签</span>
        <span class="token punctuation">#</span> <span class="token variable">如果tag_形状为</span><span class="token punctuation">[</span><span class="token string">'O'</span><span class="token punctuation">,</span><span class="token string">'O'</span><span class="token punctuation">,</span><span class="token string">'B-LOC'</span><span class="token punctuation">,</span><span class="token string">'I-LOC'</span><span class="token punctuation">]</span><span class="token variable">，对应的label_形状为</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>
        <span class="token punctuation">#</span> <span class="token variable">返回tag2label字典中每个tag对应的value值</span>
 
        <span class="token string">''</span><span class="token string">'sentence_id的形状为[1,2,3,4,...]对应的sent为['</span><span class="token variable">当</span><span class="token string">','</span><span class="token variable">希</span><span class="token string">','</span><span class="token variable">望</span><span class="token string">','</span><span class="token variable">工</span><span class="token string">',程'</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token string">''</span><span class="token punctuation">'</span>
        <span class="token variable">sent_</span> <span class="token punctuation">=</span> <span class="token variable">sentence2id</span><span class="token punctuation">(</span><span class="token variable">sent_</span><span class="token punctuation">,</span> <span class="token variable">vocab</span><span class="token punctuation">)</span><span class="token punctuation">#</span><span class="token variable">返回id如</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token punctuation">#</span> <span class="token variable">如果tag_形状为</span><span class="token punctuation">[</span><span class="token string">'O'</span><span class="token punctuation">,</span><span class="token string">'O'</span><span class="token punctuation">,</span><span class="token string">'B-LOC'</span><span class="token punctuation">,</span><span class="token string">'I-LOC'</span><span class="token punctuation">]</span><span class="token variable">，对应的label_形状为</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>
        <span class="token variable">label_</span> <span class="token punctuation">=</span> <span class="token brackets"><span class="token punctuation">[</span><span class="token variable">tag2label</span><span class="token punctuation">[</span><span class="token variable">tag</span><span class="token punctuation">]</span></span> <span class="token variable">for</span> <span class="token variable">tag</span> <span class="token variable">in</span> <span class="token variable">tag_</span><span class="token punctuation">]</span>
        <span class="token punctuation">#</span> <span class="token variable">保证了seqs的长度为batch_size</span>
        <span class="token variable">if</span> <span class="token variable">len</span><span class="token punctuation">(</span><span class="token variable">seqs</span><span class="token punctuation">)</span> <span class="token punctuation">=</span><span class="token punctuation">=</span> <span class="token variable">batch_size</span><span class="token punctuation">:</span>
            <span class="token variable">yield</span> <span class="token variable">seqs</span><span class="token punctuation">,</span> <span class="token variable">labels</span>
            <span class="token variable">seqs</span><span class="token punctuation">,</span> <span class="token variable">labels</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
 
        <span class="token variable">seqs</span><span class="token punctuation">.</span><span class="token variable">append</span><span class="token punctuation">(</span><span class="token variable">sent_</span><span class="token punctuation">)</span><span class="token punctuation">#</span><span class="token variable">seqs如</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token variable">，</span><span class="token number">2</span><span class="token variable">，</span><span class="token number">3</span><span class="token variable">，</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token variable">……</span><span class="token punctuation">]</span><span class="token variable">剧中词语的标号</span>
        <span class="token variable">labels</span><span class="token punctuation">.</span><span class="token variable">append</span><span class="token punctuation">(</span><span class="token variable">label_</span><span class="token punctuation">)</span><span class="token punctuation">#</span><span class="token variable">abel_形状为</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">#</span><span class="token variable">剧中词语的标签</span>
 
    <span class="token variable">if</span> <span class="token variable">len</span><span class="token punctuation">(</span><span class="token variable">seqs</span><span class="token punctuation">)</span> <span class="token punctuation">!</span><span class="token punctuation">=</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token variable">yield</span> <span class="token variable">seqs</span><span class="token punctuation">,</span> <span class="token variable">labels</span>
 
<span class="token punctuation">#</span><span class="token variable">执行vocab_build</span>
<span class="token variable">vocab_path</span> <span class="token punctuation">=</span> <span class="token string">'./word2id.pkl'</span>
<span class="token variable">corpus_path</span> <span class="token punctuation">=</span> <span class="token string">'../input/seq-tag/data_path/train_data.txt'</span>

<span class="token variable">vocab_build</span><span class="token punctuation">(</span><span class="token variable">vocab_path</span><span class="token punctuation">,</span> <span class="token variable">corpus_path</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
</code></pre> 
<p>对应：<code>utils.py</code></p> 
<pre><code class="prism language-handlebars"><span class="token variable">import</span> <span class="token variable">logging</span><span class="token punctuation">,</span> <span class="token variable">sys</span><span class="token punctuation">,</span> <span class="token variable">argparse</span>
 
<span class="token punctuation">#</span><span class="token variable">第二步</span>
<span class="token variable">def</span> <span class="token variable">str2bool</span><span class="token punctuation">(</span><span class="token variable">v</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">#</span> <span class="token variable">copy</span> <span class="token variable">from</span> <span class="token variable">StackOverflow</span>
    <span class="token variable">if</span> <span class="token variable">v</span><span class="token punctuation">.</span><span class="token variable">lower</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token variable">in</span> <span class="token punctuation">(</span><span class="token string">'yes'</span><span class="token punctuation">,</span> <span class="token string">'true'</span><span class="token punctuation">,</span> <span class="token string">'t'</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token variable">return</span> <span class="token variable">True</span>
    <span class="token variable">elif</span> <span class="token variable">v</span><span class="token punctuation">.</span><span class="token variable">lower</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token variable">in</span> <span class="token punctuation">(</span><span class="token string">'no'</span><span class="token punctuation">,</span> <span class="token string">'false'</span><span class="token punctuation">,</span> <span class="token string">'f'</span><span class="token punctuation">,</span> <span class="token string">'n'</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token variable">return</span> <span class="token variable">False</span>
    <span class="token variable">else</span><span class="token punctuation">:</span>
        <span class="token punctuation">#</span> <span class="token variable">首先被内层IOError异常捕获，打印“inner</span> <span class="token variable">exception”</span><span class="token punctuation">,</span> <span class="token variable">然后把相同的异常再抛出，</span>
        <span class="token punctuation">#</span> <span class="token variable">被外层的except捕获，打印</span><span class="token string">"outter exception"</span>
        <span class="token variable">raise</span> <span class="token variable">argparse</span><span class="token punctuation">.</span><span class="token variable">ArgumentTypeError</span><span class="token punctuation">(</span><span class="token string">'Boolean value expected.'</span><span class="token punctuation">)</span>
 
 
<span class="token punctuation">#</span><span class="token variable">根据输入的tag返回对应的字符</span>
<span class="token variable">def</span> <span class="token variable">get_entity</span><span class="token punctuation">(</span><span class="token variable">tag_seq</span><span class="token punctuation">,</span> <span class="token variable">char_seq</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">#</span><span class="token punctuation">[</span><span class="token string">'B-PER'</span><span class="token punctuation">,</span> <span class="token string">'I-PER'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'B-LOC'</span><span class="token punctuation">,</span> <span class="token string">'I-LOC'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'B-ORG'</span><span class="token punctuation">,</span> <span class="token string">'I-ORG'</span><span class="token punctuation">,</span> <span class="token string">'I-ORG'</span><span class="token punctuation">,</span> <span class="token string">'I-ORG'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string">'小'</span><span class="token punctuation">,</span> <span class="token string">'明'</span><span class="token punctuation">,</span> <span class="token string">'的'</span><span class="token punctuation">,</span> <span class="token string">'大'</span><span class="token punctuation">,</span> <span class="token string">'学'</span><span class="token punctuation">,</span> <span class="token string">'在'</span><span class="token punctuation">,</span> <span class="token string">'北'</span><span class="token punctuation">,</span> <span class="token string">'京'</span><span class="token punctuation">,</span> <span class="token string">'的'</span><span class="token punctuation">,</span> <span class="token string">'北'</span><span class="token punctuation">,</span> <span class="token string">'京'</span><span class="token punctuation">,</span> <span class="token string">'大'</span><span class="token punctuation">,</span> <span class="token string">'学'</span><span class="token punctuation">]</span>
    <span class="token variable">PER</span> <span class="token punctuation">=</span> <span class="token variable">get_PER_entity</span><span class="token punctuation">(</span><span class="token variable">tag_seq</span><span class="token punctuation">,</span> <span class="token variable">char_seq</span><span class="token punctuation">)</span>
    <span class="token variable">LOC</span> <span class="token punctuation">=</span> <span class="token variable">get_LOC_entity</span><span class="token punctuation">(</span><span class="token variable">tag_seq</span><span class="token punctuation">,</span> <span class="token variable">char_seq</span><span class="token punctuation">)</span>
    <span class="token variable">ORG</span> <span class="token punctuation">=</span> <span class="token variable">get_ORG_entity</span><span class="token punctuation">(</span><span class="token variable">tag_seq</span><span class="token punctuation">,</span> <span class="token variable">char_seq</span><span class="token punctuation">)</span>
    <span class="token variable">return</span> <span class="token variable">PER</span><span class="token punctuation">,</span> <span class="token variable">LOC</span><span class="token punctuation">,</span> <span class="token variable">ORG</span>
 
 
<span class="token punctuation">#</span><span class="token variable">输出PER对应的字符</span>
<span class="token variable">def</span> <span class="token variable">get_PER_entity</span><span class="token punctuation">(</span><span class="token variable">tag_seq</span><span class="token punctuation">,</span> <span class="token variable">char_seq</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token variable">length</span> <span class="token punctuation">=</span> <span class="token variable">len</span><span class="token punctuation">(</span><span class="token variable">char_seq</span><span class="token punctuation">)</span><span class="token punctuation">#</span><span class="token variable">句子长度</span>
    <span class="token variable">PER</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">#</span> <span class="token variable">构成一个zip对象</span><span class="token punctuation">,</span><span class="token variable">形状类似</span><span class="token punctuation">[</span><span class="token punctuation">(</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">#</span> <span class="token variable">zip函数可以接受一系列的可迭代对象作为参数，将对象中对应的元素打包成一个个tuple</span><span class="token punctuation">(</span><span class="token variable">元组</span><span class="token punctuation">)</span><span class="token variable">，</span>
    <span class="token punctuation">#</span> <span class="token variable">在zip函数的括号里面加上</span><span class="token punctuation">*</span><span class="token variable">号，则是zip函数的逆操作</span>
    <span class="token variable">for</span> <span class="token variable">i</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token variable">char</span><span class="token punctuation">,</span> <span class="token variable">tag</span><span class="token punctuation">)</span> <span class="token variable">in</span> <span class="token variable">enumerate</span><span class="token punctuation">(</span><span class="token variable">zip</span><span class="token punctuation">(</span><span class="token variable">char_seq</span><span class="token punctuation">,</span> <span class="token variable">tag_seq</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">#</span><span class="token variable">如小</span> <span class="token variable">B-PER</span>
        <span class="token punctuation">#</span> <span class="token variable">tag里包含了O</span><span class="token punctuation">,</span><span class="token variable">B-PER</span><span class="token punctuation">,</span><span class="token variable">I-PER</span><span class="token punctuation">,</span><span class="token variable">B-LOCI-PER</span><span class="token punctuation">,</span><span class="token variable">B-ORG</span><span class="token punctuation">,</span><span class="token variable">I-PER</span>
        <span class="token variable">if</span> <span class="token variable">tag</span> <span class="token punctuation">=</span><span class="token punctuation">=</span> <span class="token string">'B-PER'</span><span class="token punctuation">:</span>
            <span class="token variable">if</span> <span class="token string">'per'</span> <span class="token variable">in</span> <span class="token variable">locals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token variable">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">#</span><span class="token variable">把上一个名字加进去，这样才能继续往里面添加</span>
                <span class="token variable">PER</span><span class="token punctuation">.</span><span class="token variable">append</span><span class="token punctuation">(</span><span class="token variable">per</span><span class="token punctuation">)</span>
                <span class="token variable">del</span> <span class="token variable">per</span>
            <span class="token variable">per</span> <span class="token punctuation">=</span> <span class="token variable">char</span>
            <span class="token variable">if</span> <span class="token variable">i</span><span class="token punctuation">+</span><span class="token number">1</span> <span class="token punctuation">=</span><span class="token punctuation">=</span> <span class="token variable">length</span><span class="token punctuation">:</span><span class="token punctuation">#</span><span class="token variable">说明这个名字就一个字</span>
                <span class="token variable">PER</span><span class="token punctuation">.</span><span class="token variable">append</span><span class="token punctuation">(</span><span class="token variable">per</span><span class="token punctuation">)</span>
        <span class="token variable">if</span> <span class="token variable">tag</span> <span class="token punctuation">=</span><span class="token punctuation">=</span> <span class="token string">'I-PER'</span><span class="token punctuation">:</span>
            <span class="token variable">per</span> <span class="token punctuation">+</span><span class="token punctuation">=</span> <span class="token variable">char</span>
            <span class="token variable">if</span> <span class="token variable">i</span><span class="token punctuation">+</span><span class="token number">1</span> <span class="token punctuation">=</span><span class="token punctuation">=</span> <span class="token variable">length</span><span class="token punctuation">:</span>
                <span class="token variable">PER</span><span class="token punctuation">.</span><span class="token variable">append</span><span class="token punctuation">(</span><span class="token variable">per</span><span class="token punctuation">)</span>
        <span class="token variable">if</span> <span class="token variable">tag</span> <span class="token variable">not</span> <span class="token variable">in</span> <span class="token punctuation">[</span><span class="token string">'I-PER'</span><span class="token punctuation">,</span> <span class="token string">'B-PER'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token variable">if</span> <span class="token string">'per'</span> <span class="token variable">in</span> <span class="token variable">locals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token variable">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token variable">PER</span><span class="token punctuation">.</span><span class="token variable">append</span><span class="token punctuation">(</span><span class="token variable">per</span><span class="token punctuation">)</span>
                <span class="token variable">del</span> <span class="token variable">per</span>
            <span class="token variable">continue</span>
    <span class="token variable">return</span> <span class="token variable">PER</span>
 
 
<span class="token punctuation">#</span><span class="token variable">输出LOC对应的字符</span>
<span class="token variable">def</span> <span class="token variable">get_LOC_entity</span><span class="token punctuation">(</span><span class="token variable">tag_seq</span><span class="token punctuation">,</span> <span class="token variable">char_seq</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token variable">length</span> <span class="token punctuation">=</span> <span class="token variable">len</span><span class="token punctuation">(</span><span class="token variable">char_seq</span><span class="token punctuation">)</span>
    <span class="token variable">LOC</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token variable">for</span> <span class="token variable">i</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token variable">char</span><span class="token punctuation">,</span> <span class="token variable">tag</span><span class="token punctuation">)</span> <span class="token variable">in</span> <span class="token variable">enumerate</span><span class="token punctuation">(</span><span class="token variable">zip</span><span class="token punctuation">(</span><span class="token variable">char_seq</span><span class="token punctuation">,</span> <span class="token variable">tag_seq</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token variable">if</span> <span class="token variable">tag</span> <span class="token punctuation">=</span><span class="token punctuation">=</span> <span class="token string">'B-LOC'</span><span class="token punctuation">:</span>
            <span class="token variable">if</span> <span class="token string">'loc'</span> <span class="token variable">in</span> <span class="token variable">locals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token variable">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token variable">LOC</span><span class="token punctuation">.</span><span class="token variable">append</span><span class="token punctuation">(</span><span class="token variable">loc</span><span class="token punctuation">)</span>
                <span class="token variable">del</span> <span class="token variable">loc</span>
            <span class="token variable">loc</span> <span class="token punctuation">=</span> <span class="token variable">char</span>
            <span class="token variable">if</span> <span class="token variable">i</span><span class="token punctuation">+</span><span class="token number">1</span> <span class="token punctuation">=</span><span class="token punctuation">=</span> <span class="token variable">length</span><span class="token punctuation">:</span>
                <span class="token variable">LOC</span><span class="token punctuation">.</span><span class="token variable">append</span><span class="token punctuation">(</span><span class="token variable">loc</span><span class="token punctuation">)</span>
        <span class="token variable">if</span> <span class="token variable">tag</span> <span class="token punctuation">=</span><span class="token punctuation">=</span> <span class="token string">'I-LOC'</span><span class="token punctuation">:</span>
            <span class="token variable">loc</span> <span class="token punctuation">+</span><span class="token punctuation">=</span> <span class="token variable">char</span>
            <span class="token variable">if</span> <span class="token variable">i</span><span class="token punctuation">+</span><span class="token number">1</span> <span class="token punctuation">=</span><span class="token punctuation">=</span> <span class="token variable">length</span><span class="token punctuation">:</span>
                <span class="token variable">LOC</span><span class="token punctuation">.</span><span class="token variable">append</span><span class="token punctuation">(</span><span class="token variable">loc</span><span class="token punctuation">)</span>
        <span class="token variable">if</span> <span class="token variable">tag</span> <span class="token variable">not</span> <span class="token variable">in</span> <span class="token punctuation">[</span><span class="token string">'I-LOC'</span><span class="token punctuation">,</span> <span class="token string">'B-LOC'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token variable">if</span> <span class="token string">'loc'</span> <span class="token variable">in</span> <span class="token variable">locals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token variable">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token variable">LOC</span><span class="token punctuation">.</span><span class="token variable">append</span><span class="token punctuation">(</span><span class="token variable">loc</span><span class="token punctuation">)</span>
                <span class="token variable">del</span> <span class="token variable">loc</span>
            <span class="token variable">continue</span>
    <span class="token variable">return</span> <span class="token variable">LOC</span>
 
 
<span class="token punctuation">#</span><span class="token variable">输出ORG对应的字符</span>
<span class="token variable">def</span> <span class="token variable">get_ORG_entity</span><span class="token punctuation">(</span><span class="token variable">tag_seq</span><span class="token punctuation">,</span> <span class="token variable">char_seq</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token variable">length</span> <span class="token punctuation">=</span> <span class="token variable">len</span><span class="token punctuation">(</span><span class="token variable">char_seq</span><span class="token punctuation">)</span>
    <span class="token variable">ORG</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token variable">for</span> <span class="token variable">i</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token variable">char</span><span class="token punctuation">,</span> <span class="token variable">tag</span><span class="token punctuation">)</span> <span class="token variable">in</span> <span class="token variable">enumerate</span><span class="token punctuation">(</span><span class="token variable">zip</span><span class="token punctuation">(</span><span class="token variable">char_seq</span><span class="token punctuation">,</span> <span class="token variable">tag_seq</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token variable">if</span> <span class="token variable">tag</span> <span class="token punctuation">=</span><span class="token punctuation">=</span> <span class="token string">'B-ORG'</span><span class="token punctuation">:</span>
            <span class="token variable">if</span> <span class="token string">'org'</span> <span class="token variable">in</span> <span class="token variable">locals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token variable">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token variable">ORG</span><span class="token punctuation">.</span><span class="token variable">append</span><span class="token punctuation">(</span><span class="token variable">org</span><span class="token punctuation">)</span>
                <span class="token variable">del</span> <span class="token variable">org</span>
            <span class="token variable">org</span> <span class="token punctuation">=</span> <span class="token variable">char</span>
            <span class="token variable">if</span> <span class="token variable">i</span><span class="token punctuation">+</span><span class="token number">1</span> <span class="token punctuation">=</span><span class="token punctuation">=</span> <span class="token variable">length</span><span class="token punctuation">:</span>
                <span class="token variable">ORG</span><span class="token punctuation">.</span><span class="token variable">append</span><span class="token punctuation">(</span><span class="token variable">org</span><span class="token punctuation">)</span>
        <span class="token variable">if</span> <span class="token variable">tag</span> <span class="token punctuation">=</span><span class="token punctuation">=</span> <span class="token string">'I-ORG'</span><span class="token punctuation">:</span>
            <span class="token variable">org</span> <span class="token punctuation">+</span><span class="token punctuation">=</span> <span class="token variable">char</span>
            <span class="token variable">if</span> <span class="token variable">i</span><span class="token punctuation">+</span><span class="token number">1</span> <span class="token punctuation">=</span><span class="token punctuation">=</span> <span class="token variable">length</span><span class="token punctuation">:</span>
                <span class="token variable">ORG</span><span class="token punctuation">.</span><span class="token variable">append</span><span class="token punctuation">(</span><span class="token variable">org</span><span class="token punctuation">)</span>
        <span class="token variable">if</span> <span class="token variable">tag</span> <span class="token variable">not</span> <span class="token variable">in</span> <span class="token punctuation">[</span><span class="token string">'I-ORG'</span><span class="token punctuation">,</span> <span class="token string">'B-ORG'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token variable">if</span> <span class="token string">'org'</span> <span class="token variable">in</span> <span class="token variable">locals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token variable">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token variable">ORG</span><span class="token punctuation">.</span><span class="token variable">append</span><span class="token punctuation">(</span><span class="token variable">org</span><span class="token punctuation">)</span>
                <span class="token variable">del</span> <span class="token variable">org</span>
            <span class="token variable">continue</span>
    <span class="token variable">return</span> <span class="token variable">ORG</span>
 
<span class="token punctuation">#</span><span class="token variable">记录日志</span>
<span class="token variable">def</span> <span class="token variable">get_logger</span><span class="token punctuation">(</span><span class="token variable">filename</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token variable">logger</span> <span class="token punctuation">=</span> <span class="token variable">logging</span><span class="token punctuation">.</span><span class="token variable">getLogger</span><span class="token punctuation">(</span><span class="token string">'logger'</span><span class="token punctuation">)</span>
    <span class="token variable">logger</span><span class="token punctuation">.</span><span class="token variable">setLevel</span><span class="token punctuation">(</span><span class="token variable">logging</span><span class="token punctuation">.</span><span class="token variable">DEBUG</span><span class="token punctuation">)</span>
    <span class="token variable">logging</span><span class="token punctuation">.</span><span class="token variable">basicConfig</span><span class="token punctuation">(</span><span class="token variable">format</span><span class="token punctuation">=</span><span class="token string">'%(message)s'</span><span class="token punctuation">,</span> <span class="token variable">level</span><span class="token punctuation">=</span><span class="token variable">logging</span><span class="token punctuation">.</span><span class="token variable">DEBUG</span><span class="token punctuation">)</span>
    <span class="token variable">handler</span> <span class="token punctuation">=</span> <span class="token variable">logging</span><span class="token punctuation">.</span><span class="token variable">FileHandler</span><span class="token punctuation">(</span><span class="token variable">filename</span><span class="token punctuation">)</span>
    <span class="token variable">handler</span><span class="token punctuation">.</span><span class="token variable">setLevel</span><span class="token punctuation">(</span><span class="token variable">logging</span><span class="token punctuation">.</span><span class="token variable">DEBUG</span><span class="token punctuation">)</span>
    <span class="token variable">handler</span><span class="token punctuation">.</span><span class="token variable">setFormatter</span><span class="token punctuation">(</span><span class="token variable">logging</span><span class="token punctuation">.</span><span class="token variable">Formatter</span><span class="token punctuation">(</span><span class="token string">'%(asctime)s:%(levelname)s: %(message)s'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token variable">logging</span><span class="token punctuation">.</span><span class="token variable">getLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token variable">addHandler</span><span class="token punctuation">(</span><span class="token variable">handler</span><span class="token punctuation">)</span>
    <span class="token variable">return</span> <span class="token variable">logger</span>
</code></pre> 
<p>对应：<code>model.py</code></p> 
<pre><code class="prism language-handlebars"><span class="token variable">import</span> <span class="token variable">numpy</span> <span class="token variable">as</span> <span class="token variable">np</span>
<span class="token variable">import</span> <span class="token variable">os</span><span class="token punctuation">,</span> <span class="token variable">time</span><span class="token punctuation">,</span> <span class="token variable">sys</span>
<span class="token variable">import</span> <span class="token variable">tensorflow</span> <span class="token variable">as</span> <span class="token variable">tf</span>


<span class="token variable">from</span> <span class="token variable">tensorflow</span><span class="token punctuation">.</span><span class="token variable">contrib</span><span class="token punctuation">.</span><span class="token variable">rnn</span> <span class="token variable">import</span> <span class="token variable">LSTMCell</span>
<span class="token variable">from</span> <span class="token variable">tensorflow</span><span class="token punctuation">.</span><span class="token variable">contrib</span><span class="token punctuation">.</span><span class="token variable">crf</span> <span class="token variable">import</span> <span class="token variable">crf_log_likelihood</span>
<span class="token variable">from</span> <span class="token variable">tensorflow</span><span class="token punctuation">.</span><span class="token variable">contrib</span><span class="token punctuation">.</span><span class="token variable">crf</span> <span class="token variable">import</span> <span class="token variable">viterbi_decode</span>
<span class="token punctuation">#</span> <span class="token variable">from</span> <span class="token variable">data</span> <span class="token variable">import</span> <span class="token variable">pad_sequences</span><span class="token punctuation">,</span> <span class="token variable">batch_yield</span>
<span class="token punctuation">#</span> <span class="token variable">from</span> <span class="token variable">utils</span> <span class="token variable">import</span> <span class="token variable">get_logger</span>
<span class="token punctuation">#</span> <span class="token variable">from</span> <span class="token variable">eval</span> <span class="token variable">import</span> <span class="token variable">conlleval</span>
 
<span class="token punctuation">#</span><span class="token variable">第三步</span><span class="token punctuation">:</span><span class="token variable">设置模型</span>
 
<span class="token variable">class</span> <span class="token variable">BiLSTM_CRF</span><span class="token punctuation">(</span><span class="token variable">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token variable">def</span> <span class="token variable">__init__</span><span class="token punctuation">(</span><span class="token variable">self</span><span class="token punctuation">,</span> <span class="token variable">args</span><span class="token punctuation">,</span> <span class="token variable">embeddings</span><span class="token punctuation">,</span> <span class="token variable">tag2label</span><span class="token punctuation">,</span> <span class="token variable">vocab</span><span class="token punctuation">,</span> <span class="token variable">paths</span><span class="token punctuation">,</span> <span class="token variable">config</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token punctuation">#</span><span class="token variable">批次大小</span>
        <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">batch_size</span> <span class="token punctuation">=</span> <span class="token variable">args</span><span class="token punctuation">.</span><span class="token variable">batch_size</span>
        <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">epoch_num</span> <span class="token punctuation">=</span> <span class="token variable">args</span><span class="token punctuation">.</span><span class="token variable">epoch</span>
        <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">hidden_dim</span> <span class="token punctuation">=</span> <span class="token variable">args</span><span class="token punctuation">.</span><span class="token variable">hidden_dim</span>
        <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">embeddings</span> <span class="token punctuation">=</span> <span class="token variable">embeddings</span>
        <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">CRF</span> <span class="token punctuation">=</span> <span class="token variable">args</span><span class="token punctuation">.</span><span class="token variable">CRF</span><span class="token punctuation">#</span><span class="token variable">True</span>
        <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">update_embedding</span> <span class="token punctuation">=</span> <span class="token variable">args</span><span class="token punctuation">.</span><span class="token variable">update_embedding</span>
        <span class="token punctuation">#</span><span class="token variable">drop操作参数</span>
        <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">dropout_keep_prob</span> <span class="token punctuation">=</span> <span class="token variable">args</span><span class="token punctuation">.</span><span class="token variable">dropout</span>
        <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">optimizer</span> <span class="token punctuation">=</span> <span class="token variable">args</span><span class="token punctuation">.</span><span class="token variable">optimizer</span><span class="token punctuation">#</span><span class="token variable">Adam</span>
        <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">lr</span> <span class="token punctuation">=</span> <span class="token variable">args</span><span class="token punctuation">.</span><span class="token variable">lr</span>
        <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">clip_grad</span> <span class="token punctuation">=</span> <span class="token variable">args</span><span class="token punctuation">.</span><span class="token variable">clip</span>
        <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">tag2label</span> <span class="token punctuation">=</span> <span class="token variable">tag2label</span>
        <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">num_tags</span> <span class="token punctuation">=</span> <span class="token variable">len</span><span class="token punctuation">(</span><span class="token variable">tag2label</span><span class="token punctuation">)</span>
        <span class="token punctuation">#</span><span class="token variable">tag2label</span> <span class="token punctuation">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"O"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
             <span class="token punctuation">#</span> <span class="token string">"B-PER"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"I-PER"</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
             <span class="token punctuation">#</span> <span class="token string">"B-LOC"</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"I-LOC"</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
             <span class="token punctuation">#</span> <span class="token string">"B-ORG"</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">"I-ORG"</span><span class="token punctuation">:</span> <span class="token number">6</span>
             <span class="token punctuation">#</span> <span class="token punctuation">}</span>
        <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">vocab</span> <span class="token punctuation">=</span> <span class="token variable">vocab</span>
        <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">shuffle</span> <span class="token punctuation">=</span> <span class="token variable">args</span><span class="token punctuation">.</span><span class="token variable">shuffle</span>
        <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">model_path</span> <span class="token punctuation">=</span> <span class="token variable">paths</span><span class="token punctuation">[</span><span class="token string">'model_path'</span><span class="token punctuation">]</span>
        <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">summary_path</span> <span class="token punctuation">=</span> <span class="token variable">paths</span><span class="token punctuation">[</span><span class="token string">'summary_path'</span><span class="token punctuation">]</span>
        <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">logger</span> <span class="token punctuation">=</span> <span class="token variable">get_logger</span><span class="token punctuation">(</span><span class="token variable">paths</span><span class="token punctuation">[</span><span class="token string">'log_path'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">result_path</span> <span class="token punctuation">=</span> <span class="token variable">paths</span><span class="token punctuation">[</span><span class="token string">'result_path'</span><span class="token punctuation">]</span>
        <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">config</span> <span class="token punctuation">=</span> <span class="token variable">config</span>
 
    <span class="token variable">def</span> <span class="token variable">build_graph</span><span class="token punctuation">(</span><span class="token variable">self</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token punctuation">#</span><span class="token variable">占位符</span>
        <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">add_placeholders</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">lookup_layer_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">biLSTM_layer_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">softmax_pred_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">#</span><span class="token variable">损失函数</span>
        <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">loss_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">trainstep_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">#</span><span class="token variable">初始化所有变量</span>
        <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">init_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 
    <span class="token variable">def</span> <span class="token variable">add_placeholders</span><span class="token punctuation">(</span><span class="token variable">self</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">word_ids</span> <span class="token punctuation">=</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">placeholder</span><span class="token punctuation">(</span><span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">int32</span><span class="token punctuation">,</span> <span class="token variable">shape</span><span class="token punctuation">=</span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">None, None</span><span class="token punctuation">]</span></span><span class="token punctuation">,</span> <span class="token variable">name</span><span class="token punctuation">=</span><span class="token string">"word_ids"</span><span class="token punctuation">)</span>
        <span class="token punctuation">#</span><span class="token variable">真实的标签序列</span>
        <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">labels</span> <span class="token punctuation">=</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">placeholder</span><span class="token punctuation">(</span><span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">int32</span><span class="token punctuation">,</span> <span class="token variable">shape</span><span class="token punctuation">=</span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">None, None</span><span class="token punctuation">]</span></span><span class="token punctuation">,</span> <span class="token variable">name</span><span class="token punctuation">=</span><span class="token string">"labels"</span><span class="token punctuation">)</span>
        <span class="token punctuation">#</span><span class="token variable">一个样本真实的序列长度</span>
        <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">sequence_lengths</span> <span class="token punctuation">=</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">placeholder</span><span class="token punctuation">(</span><span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">int32</span><span class="token punctuation">,</span> <span class="token variable">shape</span><span class="token punctuation">=</span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">None</span><span class="token punctuation">]</span></span><span class="token punctuation">,</span> <span class="token variable">name</span><span class="token punctuation">=</span><span class="token string">"sequence_lengths"</span><span class="token punctuation">)</span>
        <span class="token punctuation">#</span><span class="token variable">dropout</span>
        <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">dropout_pl</span> <span class="token punctuation">=</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">placeholder</span><span class="token punctuation">(</span><span class="token variable">dtype</span><span class="token punctuation">=</span><span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">float32</span><span class="token punctuation">,</span> <span class="token variable">shape</span><span class="token punctuation">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">name</span><span class="token punctuation">=</span><span class="token string">"dropout"</span><span class="token punctuation">)</span>
        <span class="token punctuation">#</span><span class="token variable">学习率</span>
        <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">lr_pl</span> <span class="token punctuation">=</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">placeholder</span><span class="token punctuation">(</span><span class="token variable">dtype</span><span class="token punctuation">=</span><span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">float32</span><span class="token punctuation">,</span> <span class="token variable">shape</span><span class="token punctuation">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">name</span><span class="token punctuation">=</span><span class="token string">"lr"</span><span class="token punctuation">)</span>
 
    <span class="token variable">def</span> <span class="token variable">lookup_layer_op</span><span class="token punctuation">(</span><span class="token variable">self</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token variable">with</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">variable_scope</span><span class="token punctuation">(</span><span class="token string">"words"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token variable">_word_embeddings</span> <span class="token punctuation">=</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">Variable</span><span class="token punctuation">(</span><span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">embeddings</span><span class="token punctuation">,</span><span class="token punctuation">#</span><span class="token number">3905</span><span class="token punctuation">*</span><span class="token number">300</span><span class="token variable">的矩阵，矩阵元素均在-</span><span class="token number">0.25</span><span class="token variable">到</span><span class="token number">0.25</span><span class="token variable">之间</span>
                                           <span class="token variable">dtype</span><span class="token punctuation">=</span><span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">float32</span><span class="token punctuation">,</span>
                                           <span class="token variable">trainable</span><span class="token punctuation">=</span><span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">update_embedding</span><span class="token punctuation">,</span><span class="token punctuation">#</span><span class="token variable">默认是True，如果为True，则会默认将变量添加到图形集合GraphKeys</span><span class="token punctuation">.</span><span class="token variable">TRAINABLE_VARIABLES中。此集合用于优化器Optimizer类优化的的默认变量列表【可为optimizer指定其他的变量集合】，可就是要训练的变量列表。这样的话在训练的过程中就会改变值</span>
                                           <span class="token variable">name</span><span class="token punctuation">=</span><span class="token string">"_word_embeddings"</span><span class="token punctuation">)</span>
            <span class="token variable">word_embeddings</span> <span class="token punctuation">=</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">nn</span><span class="token punctuation">.</span><span class="token variable">embedding_lookup</span><span class="token punctuation">(</span><span class="token variable">params</span><span class="token punctuation">=</span><span class="token variable">_word_embeddings</span><span class="token punctuation">,</span><span class="token punctuation">#</span>
                                                     <span class="token variable">ids</span><span class="token punctuation">=</span><span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">word_ids</span><span class="token punctuation">,</span>
                                                     <span class="token variable">name</span><span class="token punctuation">=</span><span class="token string">"word_embeddings"</span><span class="token punctuation">)</span>
            <span class="token punctuation">#</span> <span class="token variable">params</span><span class="token punctuation">:</span> <span class="token variable">表示完整的嵌入张量，或者除了第一维度之外具有相同形状的P个张量的列表，表示经分割的嵌入张量</span>
            <span class="token punctuation">#</span>
            <span class="token punctuation">#</span> <span class="token variable">ids</span><span class="token punctuation">:</span> <span class="token variable">一个类型为int32或int64的Tensor，包含要在params中查找的id</span>
            <span class="token punctuation">#</span>
            <span class="token punctuation">#</span> <span class="token variable">partition_strategy</span><span class="token punctuation">:</span> <span class="token variable">指定分区策略的字符串，如果len（params）</span> <span class="token punctuation">&gt;</span> <span class="token number">1</span><span class="token variable">，则相关。当前支持“div”和“mod”。</span> <span class="token variable">默认为“mod”</span>
            <span class="token punctuation">#</span>
            <span class="token punctuation">#</span> <span class="token variable">name</span><span class="token punctuation">:</span> <span class="token variable">操作名称（可选）</span>
            <span class="token punctuation">#</span>
            <span class="token punctuation">#</span> <span class="token variable">validate_indices</span><span class="token punctuation">:</span>  <span class="token variable">是否验证收集索引</span>
            <span class="token punctuation">#</span>
            <span class="token punctuation">#</span> <span class="token variable">max_norm</span><span class="token punctuation">:</span> <span class="token variable">如果不是None，嵌入值将被l2归一化为max_norm的值</span>
            <span class="token punctuation">#</span>
            <span class="token punctuation">#</span>  
            <span class="token punctuation">#</span>
            <span class="token punctuation">#</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">nn</span><span class="token punctuation">.</span><span class="token variable">embedding_lookup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">#</span> <span class="token variable">函数的用法主要是选取一个张量里面索引对应的元素</span>
            <span class="token punctuation">#</span>
            <span class="token punctuation">#</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">nn</span><span class="token punctuation">.</span><span class="token variable">embedding_lookup</span><span class="token punctuation">(</span><span class="token variable">tensor</span><span class="token punctuation">,</span> <span class="token variable">id</span><span class="token punctuation">)</span><span class="token variable">：即tensor就是输入的张量，id</span>
            <span class="token punctuation">#</span> <span class="token variable">就是张量对应的索引</span>
            <span class="token punctuation">#</span><span class="token variable">更完整的信息</span>  <span class="token variable">https</span><span class="token punctuation">:</span><span class="token punctuation">/</span><span class="token punctuation">/</span><span class="token variable">blog</span><span class="token punctuation">.</span><span class="token variable">csdn</span><span class="token punctuation">.</span><span class="token variable">net</span><span class="token punctuation">/</span><span class="token variable">yangfengling1023</span><span class="token punctuation">/</span><span class="token variable">article</span><span class="token punctuation">/</span><span class="token variable">details</span><span class="token punctuation">/</span><span class="token number">82910951</span>
        <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">word_embeddings</span> <span class="token punctuation">=</span>  <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">nn</span><span class="token punctuation">.</span><span class="token variable">dropout</span><span class="token punctuation">(</span><span class="token variable">word_embeddings</span><span class="token punctuation">,</span> <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">dropout_pl</span><span class="token punctuation">)</span>
        <span class="token variable">print</span><span class="token punctuation">(</span><span class="token string">'model 93行：'</span><span class="token punctuation">)</span>
        <span class="token variable">print</span><span class="token punctuation">(</span><span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">word_embeddings</span><span class="token punctuation">.</span><span class="token variable">shape</span><span class="token punctuation">)</span>
        <span class="token variable">print</span><span class="token punctuation">(</span><span class="token string">'model 97:'</span><span class="token punctuation">)</span>
        <span class="token variable">print</span><span class="token punctuation">(</span><span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">word_ids</span><span class="token punctuation">)</span>
 
    <span class="token variable">def</span> <span class="token variable">biLSTM_layer_op</span><span class="token punctuation">(</span><span class="token variable">self</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token punctuation">#</span><span class="token variable">关于tf</span><span class="token punctuation">.</span><span class="token variable">variable_scope和tf</span><span class="token punctuation">.</span><span class="token variable">get_variable：https</span><span class="token punctuation">:</span><span class="token punctuation">/</span><span class="token punctuation">/</span><span class="token variable">blog</span><span class="token punctuation">.</span><span class="token variable">csdn</span><span class="token punctuation">.</span><span class="token variable">net</span><span class="token punctuation">/</span><span class="token variable">zSean</span><span class="token punctuation">/</span><span class="token variable">article</span><span class="token punctuation">/</span><span class="token variable">details</span><span class="token punctuation">/</span><span class="token number">75057806</span>
        <span class="token variable">with</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">variable_scope</span><span class="token punctuation">(</span><span class="token string">"bi-lstm"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token variable">cell_fw</span> <span class="token punctuation">=</span> <span class="token variable">LSTMCell</span><span class="token punctuation">(</span><span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">hidden_dim</span><span class="token punctuation">)</span><span class="token punctuation">#</span><span class="token variable">隐藏层神经元，默认</span><span class="token number">300</span>
            <span class="token variable">cell_bw</span> <span class="token punctuation">=</span> <span class="token variable">LSTMCell</span><span class="token punctuation">(</span><span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">hidden_dim</span><span class="token punctuation">)</span>
 
            <span class="token punctuation">#</span> <span class="token variable">def</span> <span class="token variable">bidirectional_dynamic_rnn</span><span class="token punctuation">(</span>
            <span class="token punctuation">#</span>         <span class="token variable">cell_fw</span><span class="token punctuation">,</span>  <span class="token punctuation">#</span> <span class="token variable">前向RNN</span>
            <span class="token punctuation">#</span>         <span class="token variable">cell_bw</span><span class="token punctuation">,</span>  <span class="token punctuation">#</span> <span class="token variable">后向RNN</span>
            <span class="token punctuation">#</span>         <span class="token variable">inputs</span><span class="token punctuation">,</span>  <span class="token punctuation">#</span> <span class="token variable">输入</span>
            <span class="token punctuation">#</span>         <span class="token variable">sequence_length</span><span class="token punctuation">=</span><span class="token variable">None</span><span class="token punctuation">,</span>  <span class="token punctuation">#</span> <span class="token variable">输入序列的实际长度（可选，默认为输入序列的最大长度）</span>
            <span class="token punctuation">#</span>         <span class="token variable">initial_state_fw</span><span class="token punctuation">=</span><span class="token variable">None</span><span class="token punctuation">,</span>  <span class="token punctuation">#</span> <span class="token variable">前向的初始化状态（可选）</span>
            <span class="token punctuation">#</span>         <span class="token variable">initial_state_bw</span><span class="token punctuation">=</span><span class="token variable">None</span><span class="token punctuation">,</span>  <span class="token punctuation">#</span> <span class="token variable">后向的初始化状态（可选）</span>
            <span class="token punctuation">#</span>         <span class="token variable">dtype</span><span class="token punctuation">=</span><span class="token variable">None</span><span class="token punctuation">,</span>  <span class="token punctuation">#</span> <span class="token variable">初始化和输出的数据类型（可选）</span>
            <span class="token punctuation">#</span>         <span class="token variable">parallel_iterations</span><span class="token punctuation">=</span><span class="token variable">None</span><span class="token punctuation">,</span>
            <span class="token punctuation">#</span>         <span class="token variable">swap_memory</span><span class="token punctuation">=</span><span class="token variable">False</span><span class="token punctuation">,</span>
            <span class="token punctuation">#</span>         <span class="token variable">time_major</span><span class="token punctuation">=</span><span class="token variable">False</span><span class="token punctuation">,</span>
            <span class="token punctuation">#</span>         <span class="token punctuation">#</span> <span class="token variable">决定了输入输出tensor的格式：如果为</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token variable">向量的形状必须为</span> <span class="token punctuation">`</span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">max_time, batch_size, depth</span><span class="token punctuation">]</span></span><span class="token punctuation">`</span><span class="token punctuation">.</span>
            <span class="token punctuation">#</span>         <span class="token punctuation">#</span> <span class="token variable">如果为</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token variable">tensor的形状必须为</span><span class="token punctuation">`</span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">batch_size, max_time, depth</span><span class="token punctuation">]</span></span><span class="token punctuation">`</span><span class="token punctuation">.</span>
            <span class="token punctuation">#</span>         <span class="token variable">scope</span><span class="token punctuation">=</span><span class="token variable">None</span>
            <span class="token punctuation">#</span> <span class="token punctuation">)</span>
            <span class="token punctuation">#</span><span class="token variable">outputs为</span><span class="token punctuation">(</span><span class="token variable">output_fw</span><span class="token punctuation">,</span> <span class="token variable">output_bw</span><span class="token punctuation">)</span><span class="token variable">，是一个包含前向cell输出tensor和后向cell输出tensor组成的二元组。</span>
            <span class="token punctuation">#</span> <span class="token variable">如果time_major</span> <span class="token punctuation">=</span><span class="token punctuation">=</span> <span class="token variable">False</span><span class="token punctuation">(</span><span class="token variable">默认值</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">则output_fw将是形状为</span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">batch_size, max_time, cell_fw.output_size</span><span class="token punctuation">]</span></span>
            <span class="token punctuation">#</span> <span class="token variable">的张量</span><span class="token punctuation">,</span> <span class="token variable">则output_bw将是形状为</span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">batch_size, max_time, cell_bw.output_size</span><span class="token punctuation">]</span></span>
            <span class="token punctuation">#</span> <span class="token variable">的张量；</span>
            <span class="token punctuation">#</span> <span class="token variable">如果time_major</span> <span class="token punctuation">=</span><span class="token punctuation">=</span> <span class="token variable">True</span><span class="token punctuation">,</span> <span class="token variable">则output_fw将是形状为</span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">max_time, batch_size, cell_fw.output_size</span><span class="token punctuation">]</span></span>
            <span class="token punctuation">#</span> <span class="token variable">的张量；output_bw将会是形状为</span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">max_time, batch_size, cell_bw.output_size</span><span class="token punctuation">]</span></span>
            <span class="token punctuation">#</span> <span class="token variable">的张量</span><span class="token punctuation">.</span>
            <span class="token punctuation">#</span> <span class="token variable">与bidirectional_rnn不同</span><span class="token punctuation">,</span> <span class="token variable">它返回一个元组而不是单个连接的张量</span><span class="token punctuation">.</span><span class="token variable">如果优选连接的</span><span class="token punctuation">,</span> <span class="token variable">则正向和反向输出可以连接为tf</span><span class="token punctuation">.</span><span class="token variable">concat</span><span class="token punctuation">(</span><span class="token variable">outputs</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
 
            <span class="token punctuation">#</span> <span class="token variable">output_states为</span><span class="token punctuation">(</span><span class="token variable">output_state_fw</span><span class="token punctuation">,</span> <span class="token variable">output_state_bw</span><span class="token punctuation">)</span><span class="token variable">，包含了前向和后向最后的隐藏状态的组成的二元组。</span> 
            <span class="token punctuation">#</span> <span class="token variable">output_state_fw和output_state_bw的类型为LSTMStateTuple。</span> 
            <span class="token punctuation">#</span> <span class="token variable">LSTMStateTuple由（c，h）组成，分别代表memory</span>
            <span class="token punctuation">#</span> <span class="token variable">cell和hidden（即c</span><span class="token punctuation">,</span><span class="token variable">h矩阵）</span>
            <span class="token punctuation">#</span> <span class="token variable">state。</span>
            <span class="token punctuation">(</span><span class="token variable">output_fw_seq</span><span class="token punctuation">,</span> <span class="token variable">output_bw_seq</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">_</span> <span class="token punctuation">=</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">nn</span><span class="token punctuation">.</span><span class="token variable">bidirectional_dynamic_rnn</span><span class="token punctuation">(</span>
                <span class="token variable">cell_fw</span><span class="token punctuation">=</span><span class="token variable">cell_fw</span><span class="token punctuation">,</span>
                <span class="token variable">cell_bw</span><span class="token punctuation">=</span><span class="token variable">cell_bw</span><span class="token punctuation">,</span>
                <span class="token variable">inputs</span><span class="token punctuation">=</span><span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">word_embeddings</span><span class="token punctuation">,</span><span class="token punctuation">#</span><span class="token punctuation">#</span> <span class="token variable">输入</span>  <span class="token brackets"><span class="token punctuation">[</span><span class="token variable">batch_szie, max_time, depth</span><span class="token punctuation">]</span></span><span class="token variable">depth</span><span class="token punctuation">=</span><span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">hidden_dim</span><span class="token punctuation">=</span><span class="token number">300</span><span class="token variable">，max_time可以为句子的长度（一般以最长的句子为准，短句需要做padding），depth为输入句子词向量的维度</span>
                <span class="token variable">sequence_length</span><span class="token punctuation">=</span><span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">sequence_lengths</span><span class="token punctuation">,</span><span class="token punctuation">#</span> <span class="token variable">输入序列的实际长度（可选，默认为输入序列的最大长度）</span>
                <span class="token variable">dtype</span><span class="token punctuation">=</span><span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">float32</span><span class="token punctuation">)</span>
            <span class="token variable">print</span><span class="token punctuation">(</span><span class="token string">'model 137'</span><span class="token punctuation">)</span>
            <span class="token variable">print</span><span class="token punctuation">(</span><span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">word_embeddings</span><span class="token punctuation">)</span>
            <span class="token variable">print</span><span class="token punctuation">(</span><span class="token string">'model 143'</span><span class="token punctuation">)</span>
            <span class="token variable">print</span><span class="token punctuation">(</span><span class="token variable">output_fw_seq</span><span class="token punctuation">.</span><span class="token variable">shape</span><span class="token punctuation">)</span>
            <span class="token variable">print</span><span class="token punctuation">(</span><span class="token variable">output_bw_seq</span><span class="token punctuation">.</span><span class="token variable">shape</span><span class="token punctuation">)</span>
            <span class="token punctuation">#</span><span class="token variable">则output_fw将是形状为</span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">batch_size, max_time, cell_fw.output_size</span><span class="token punctuation">]</span></span><span class="token punctuation">,</span>
            <span class="token punctuation">#</span> <span class="token variable">的张量</span><span class="token punctuation">,</span> <span class="token variable">则output_bw将是形状为</span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">batch_size, max_time, cell_bw.output_size</span><span class="token punctuation">]</span></span>
            <span class="token punctuation">#</span> <span class="token variable">维持行数不变，后面的行接到前面的行后面</span>  <span class="token variable">示例程序在tt</span><span class="token punctuation">.</span><span class="token variable">py</span>
 
            <span class="token variable">output</span> <span class="token punctuation">=</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">concat</span><span class="token punctuation">(</span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">output_fw_seq, output_bw_seq</span><span class="token punctuation">]</span></span><span class="token punctuation">,</span> <span class="token variable">axis</span><span class="token punctuation">=</span><span class="token variable">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">#</span><span class="token punctuation">[</span><span class="token variable">batch_size</span><span class="token punctuation">,</span> <span class="token variable">max_time</span><span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">]</span><span class="token variable">-</span><span class="token number">1</span><span class="token variable">是按行的意思</span>
            <span class="token variable">print</span><span class="token punctuation">(</span><span class="token string">'model 151'</span><span class="token punctuation">)</span>
            <span class="token variable">print</span><span class="token punctuation">(</span><span class="token variable">output</span><span class="token punctuation">.</span><span class="token variable">shape</span><span class="token punctuation">)</span>
            <span class="token punctuation">#</span> <span class="token variable">model</span> <span class="token number">143</span>
            <span class="token punctuation">#</span> <span class="token punctuation">(</span><span class="token variable">?</span><span class="token punctuation">,</span> <span class="token variable">?</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span>
            <span class="token punctuation">#</span> <span class="token punctuation">(</span><span class="token variable">?</span><span class="token punctuation">,</span> <span class="token variable">?</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span>
            <span class="token punctuation">#</span> <span class="token variable">model</span> <span class="token number">151</span>
            <span class="token punctuation">#</span> <span class="token punctuation">(</span><span class="token variable">?</span><span class="token punctuation">,</span> <span class="token variable">?</span><span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">)</span>
            <span class="token punctuation">#</span><span class="token variable">经过droupput处理</span>
            <span class="token variable">output</span> <span class="token punctuation">=</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">nn</span><span class="token punctuation">.</span><span class="token variable">dropout</span><span class="token punctuation">(</span><span class="token variable">output</span><span class="token punctuation">,</span> <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">dropout_pl</span><span class="token punctuation">)</span>
 
        <span class="token variable">with</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">variable_scope</span><span class="token punctuation">(</span><span class="token string">"proj"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token variable">W</span> <span class="token punctuation">=</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">get_variable</span><span class="token punctuation">(</span><span class="token variable">name</span><span class="token punctuation">=</span><span class="token string">"W"</span><span class="token punctuation">,</span>
                                <span class="token variable">shape</span><span class="token punctuation">=</span><span class="token punctuation">[</span><span class="token number">2</span> <span class="token punctuation">*</span> <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">hidden_dim</span><span class="token punctuation">,</span> <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">num_tags</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">#</span><span class="token punctuation">[</span><span class="token number">600</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">]</span>
                                <span class="token punctuation">#</span> <span class="token variable">该函数返回一个用于初始化权重的初始化程序</span> <span class="token variable">“Xavier”</span> <span class="token variable">。</span>
                                <span class="token punctuation">#</span> <span class="token variable">这个初始化器是用来保持每一层的梯度大小都差不多相同</span>
                                <span class="token variable">initializer</span><span class="token punctuation">=</span><span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">contrib</span><span class="token punctuation">.</span><span class="token variable">layers</span><span class="token punctuation">.</span><span class="token variable">xavier_initializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                <span class="token variable">dtype</span><span class="token punctuation">=</span><span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">float32</span><span class="token punctuation">)</span>
 
            <span class="token variable">b</span> <span class="token punctuation">=</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">get_variable</span><span class="token punctuation">(</span><span class="token variable">name</span><span class="token punctuation">=</span><span class="token string">"b"</span><span class="token punctuation">,</span>
                                <span class="token variable">shape</span><span class="token punctuation">=</span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">self.num_tags</span><span class="token punctuation">]</span></span><span class="token punctuation">,</span><span class="token punctuation">#</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span>
                                <span class="token punctuation">#</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">zeros_initializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token variable">，也可以简写为tf</span><span class="token punctuation">.</span><span class="token variable">Zeros</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token variable">initializer</span><span class="token punctuation">=</span><span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">zeros_initializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                <span class="token variable">dtype</span><span class="token punctuation">=</span><span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">float32</span><span class="token punctuation">)</span>
            <span class="token punctuation">#</span> <span class="token variable">output的形状为</span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">batch_size,steps,cell_num</span><span class="token punctuation">]</span></span><span class="token variable">批次大小，步长，神经元个数</span><span class="token punctuation">=</span><span class="token number">600</span>
            <span class="token variable">s</span> <span class="token punctuation">=</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">shape</span><span class="token punctuation">(</span><span class="token variable">output</span><span class="token punctuation">)</span>
            <span class="token punctuation">#</span><span class="token variable">print</span><span class="token punctuation">(</span><span class="token variable">output</span><span class="token punctuation">.</span><span class="token variable">shape</span><span class="token punctuation">)</span>
            <span class="token punctuation">#</span> <span class="token variable">reshape的目的是为了跟w做矩阵乘法</span>
            <span class="token variable">output</span> <span class="token punctuation">=</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">reshape</span><span class="token punctuation">(</span><span class="token variable">output</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token variable">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">*</span><span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">hidden_dim</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">#</span><span class="token variable">-</span><span class="token number">1</span><span class="token variable">就是未知值，是批次大小</span>
            <span class="token variable">pred</span> <span class="token punctuation">=</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">matmul</span><span class="token punctuation">(</span><span class="token variable">output</span><span class="token punctuation">,</span> <span class="token variable">W</span><span class="token punctuation">)</span> <span class="token punctuation">+</span> <span class="token variable">b</span><span class="token punctuation">#</span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">batch_size,self.num_tags</span><span class="token punctuation">]</span></span>
            <span class="token punctuation">#</span> <span class="token variable">s</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">=</span><span class="token variable">batch_size</span>
            <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">logits</span> <span class="token punctuation">=</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">reshape</span><span class="token punctuation">(</span><span class="token variable">pred</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token variable">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token variable">s</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">num_tags</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">#</span><span class="token punctuation">[</span><span class="token variable">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token variable">batch_size</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">]</span>
            <span class="token variable">print</span><span class="token punctuation">(</span><span class="token string">"******************************************************************************"</span><span class="token punctuation">)</span>
            <span class="token variable">print</span><span class="token punctuation">(</span><span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">logits</span><span class="token punctuation">.</span><span class="token variable">shape</span><span class="token punctuation">)</span>
 
    <span class="token variable">def</span> <span class="token variable">loss_op</span><span class="token punctuation">(</span><span class="token variable">self</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token variable">if</span> <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">CRF</span><span class="token punctuation">:</span>
            <span class="token punctuation">#</span> <span class="token variable">crf_log_likelihood作为损失函数</span>
            <span class="token punctuation">#</span> <span class="token variable">inputs：unary</span> <span class="token variable">potentials</span><span class="token punctuation">,</span><span class="token variable">就是每个标签的预测概率值</span>
            <span class="token punctuation">#</span> <span class="token variable">tag_indices，这个就是真实的标签序列了</span>
            <span class="token punctuation">#</span> <span class="token variable">sequence_lengths</span><span class="token punctuation">,</span><span class="token variable">一个样本真实的序列长度，为了对齐长度会做些padding，但是可以把真实的长度放到这个参数里</span>
            <span class="token punctuation">#</span> <span class="token variable">transition_params</span><span class="token punctuation">,</span><span class="token variable">转移概率，可以没有，没有的话这个函数也会算出来</span>
            <span class="token punctuation">#</span> <span class="token variable">输出：log_likelihood</span><span class="token punctuation">:</span><span class="token variable">标量</span><span class="token punctuation">;</span><span class="token variable">transition_params</span><span class="token punctuation">,</span><span class="token variable">转移概率，如果输入没输，它就自己算个给返回</span>
            <span class="token variable">log_likelihood</span><span class="token punctuation">,</span> <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">transition_params</span> <span class="token punctuation">=</span> <span class="token variable">crf_log_likelihood</span><span class="token punctuation">(</span><span class="token variable">inputs</span><span class="token punctuation">=</span><span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">logits</span><span class="token punctuation">,</span>
                                                                   <span class="token variable">tag_indices</span><span class="token punctuation">=</span><span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">labels</span><span class="token punctuation">,</span>
                                                                   <span class="token variable">sequence_lengths</span><span class="token punctuation">=</span><span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">sequence_lengths</span><span class="token punctuation">)</span>
            <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">loss</span> <span class="token punctuation">=</span> <span class="token variable">-tf</span><span class="token punctuation">.</span><span class="token variable">reduce_mean</span><span class="token punctuation">(</span><span class="token variable">log_likelihood</span><span class="token punctuation">)</span>
 
        <span class="token variable">else</span><span class="token punctuation">:</span>
            <span class="token punctuation">#</span> <span class="token variable">交叉熵做损失函数</span>
            <span class="token variable">losses</span> <span class="token punctuation">=</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">nn</span><span class="token punctuation">.</span><span class="token variable">sparse_softmax_cross_entropy_with_logits</span><span class="token punctuation">(</span><span class="token variable">logits</span><span class="token punctuation">=</span><span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">logits</span><span class="token punctuation">,</span>
                                                                    <span class="token variable">labels</span><span class="token punctuation">=</span><span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">labels</span><span class="token punctuation">)</span>
            <span class="token punctuation">#</span><span class="token variable">张量变换函数</span>
            <span class="token variable">mask</span> <span class="token punctuation">=</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">sequence_mask</span><span class="token punctuation">(</span><span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">sequence_lengths</span><span class="token punctuation">)</span>
            <span class="token punctuation">#</span><span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">boolean_mask</span>     <span class="token variable">https</span><span class="token punctuation">:</span><span class="token punctuation">/</span><span class="token punctuation">/</span><span class="token variable">blog</span><span class="token punctuation">.</span><span class="token variable">csdn</span><span class="token punctuation">.</span><span class="token variable">net</span><span class="token punctuation">/</span><span class="token variable">qq_29444571</span><span class="token punctuation">/</span><span class="token variable">article</span><span class="token punctuation">/</span><span class="token variable">details</span><span class="token punctuation">/</span><span class="token number">84574526</span>
            <span class="token variable">losses</span> <span class="token punctuation">=</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">boolean_mask</span><span class="token punctuation">(</span><span class="token variable">losses</span><span class="token punctuation">,</span> <span class="token variable">mask</span><span class="token punctuation">)</span>
            <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">loss</span> <span class="token punctuation">=</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">reduce_mean</span><span class="token punctuation">(</span><span class="token variable">losses</span><span class="token punctuation">)</span>
 
        <span class="token punctuation">#</span><span class="token variable">添加标量统计结果</span>
        <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">summary</span><span class="token punctuation">.</span><span class="token variable">scalar</span><span class="token punctuation">(</span><span class="token string">"loss"</span><span class="token punctuation">,</span> <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">loss</span><span class="token punctuation">)</span>
 
    <span class="token variable">def</span> <span class="token variable">softmax_pred_op</span><span class="token punctuation">(</span><span class="token variable">self</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token variable">if</span> <span class="token variable">not</span> <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">CRF</span><span class="token punctuation">:</span>
            <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">labels_softmax_</span> <span class="token punctuation">=</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">argmax</span><span class="token punctuation">(</span><span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">logits</span><span class="token punctuation">,</span> <span class="token variable">axis</span><span class="token punctuation">=</span><span class="token variable">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">#</span><span class="token variable">-</span><span class="token number">1</span><span class="token variable">表示按行取值最大的索引</span>
            <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">labels_softmax_</span> <span class="token punctuation">=</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">cast</span><span class="token punctuation">(</span><span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">labels_softmax_</span><span class="token punctuation">,</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">int32</span><span class="token punctuation">)</span>
 
    <span class="token variable">def</span> <span class="token variable">trainstep_op</span><span class="token punctuation">(</span><span class="token variable">self</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token variable">with</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">variable_scope</span><span class="token punctuation">(</span><span class="token string">"train_step"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">global_step</span> <span class="token punctuation">=</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">Variable</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token variable">name</span><span class="token punctuation">=</span><span class="token string">"global_step"</span><span class="token punctuation">,</span> <span class="token variable">trainable</span><span class="token punctuation">=</span><span class="token variable">False</span><span class="token punctuation">)</span>
            <span class="token variable">if</span> <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">optimizer</span> <span class="token punctuation">=</span><span class="token punctuation">=</span> <span class="token string">'Adam'</span><span class="token punctuation">:</span>
                <span class="token variable">optim</span> <span class="token punctuation">=</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">train</span><span class="token punctuation">.</span><span class="token variable">AdamOptimizer</span><span class="token punctuation">(</span><span class="token variable">learning_rate</span><span class="token punctuation">=</span><span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">lr_pl</span><span class="token punctuation">)</span>
            <span class="token variable">elif</span> <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">optimizer</span> <span class="token punctuation">=</span><span class="token punctuation">=</span> <span class="token string">'Adadelta'</span><span class="token punctuation">:</span>
                <span class="token variable">optim</span> <span class="token punctuation">=</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">train</span><span class="token punctuation">.</span><span class="token variable">AdadeltaOptimizer</span><span class="token punctuation">(</span><span class="token variable">learning_rate</span><span class="token punctuation">=</span><span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">lr_pl</span><span class="token punctuation">)</span>
            <span class="token variable">elif</span> <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">optimizer</span> <span class="token punctuation">=</span><span class="token punctuation">=</span> <span class="token string">'Adagrad'</span><span class="token punctuation">:</span>
                <span class="token variable">optim</span> <span class="token punctuation">=</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">train</span><span class="token punctuation">.</span><span class="token variable">AdagradOptimizer</span><span class="token punctuation">(</span><span class="token variable">learning_rate</span><span class="token punctuation">=</span><span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">lr_pl</span><span class="token punctuation">)</span>
            <span class="token variable">elif</span> <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">optimizer</span> <span class="token punctuation">=</span><span class="token punctuation">=</span> <span class="token string">'RMSProp'</span><span class="token punctuation">:</span>
                <span class="token variable">optim</span> <span class="token punctuation">=</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">train</span><span class="token punctuation">.</span><span class="token variable">RMSPropOptimizer</span><span class="token punctuation">(</span><span class="token variable">learning_rate</span><span class="token punctuation">=</span><span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">lr_pl</span><span class="token punctuation">)</span>
            <span class="token variable">elif</span> <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">optimizer</span> <span class="token punctuation">=</span><span class="token punctuation">=</span> <span class="token string">'Momentum'</span><span class="token punctuation">:</span>
                <span class="token variable">optim</span> <span class="token punctuation">=</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">train</span><span class="token punctuation">.</span><span class="token variable">MomentumOptimizer</span><span class="token punctuation">(</span><span class="token variable">learning_rate</span><span class="token punctuation">=</span><span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">lr_pl</span><span class="token punctuation">,</span> <span class="token variable">momentum</span><span class="token punctuation">=</span><span class="token number">0.9</span><span class="token punctuation">)</span>
            <span class="token variable">elif</span> <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">optimizer</span> <span class="token punctuation">=</span><span class="token punctuation">=</span> <span class="token string">'SGD'</span><span class="token punctuation">:</span>
                <span class="token variable">optim</span> <span class="token punctuation">=</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">train</span><span class="token punctuation">.</span><span class="token variable">GradientDescentOptimizer</span><span class="token punctuation">(</span><span class="token variable">learning_rate</span><span class="token punctuation">=</span><span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">lr_pl</span><span class="token punctuation">)</span>
            <span class="token variable">else</span><span class="token punctuation">:</span>
                <span class="token variable">optim</span> <span class="token punctuation">=</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">train</span><span class="token punctuation">.</span><span class="token variable">GradientDescentOptimizer</span><span class="token punctuation">(</span><span class="token variable">learning_rate</span><span class="token punctuation">=</span><span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">lr_pl</span><span class="token punctuation">)</span>
            <span class="token punctuation">#</span><span class="token variable">minimize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token variable">实际上包含了两个步骤，即compute_gradients和apply_gradients，前者用于计算梯度，后者用于使用计算得到的梯度来更新对应的variable</span>
            <span class="token variable">grads_and_vars</span> <span class="token punctuation">=</span> <span class="token variable">optim</span><span class="token punctuation">.</span><span class="token variable">compute_gradients</span><span class="token punctuation">(</span><span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">loss</span><span class="token punctuation">)</span>
            <span class="token variable">grads_and_vars_clip</span> <span class="token punctuation">=</span> <span class="token brackets"><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token variable">tf.clip_by_value(g, -self.clip_grad, self.clip_grad), v</span><span class="token punctuation">]</span></span> <span class="token variable">for</span> <span class="token variable">g</span><span class="token punctuation">,</span> <span class="token variable">v</span> <span class="token variable">in</span> <span class="token variable">grads_and_vars</span><span class="token punctuation">]</span>
            <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">train_op</span> <span class="token punctuation">=</span> <span class="token variable">optim</span><span class="token punctuation">.</span><span class="token variable">apply_gradients</span><span class="token punctuation">(</span><span class="token variable">grads_and_vars_clip</span><span class="token punctuation">,</span> <span class="token variable">global_step</span><span class="token punctuation">=</span><span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">global_step</span><span class="token punctuation">)</span>
 
    <span class="token variable">def</span> <span class="token variable">init_op</span><span class="token punctuation">(</span><span class="token variable">self</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">init_op</span> <span class="token punctuation">=</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">global_variables_initializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 
    <span class="token variable">def</span> <span class="token variable">add_summary</span><span class="token punctuation">(</span><span class="token variable">self</span><span class="token punctuation">,</span> <span class="token variable">sess</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token string">""</span><span class="token punctuation">"</span>
        <span class="token punctuation">:</span><span class="token variable">param</span> <span class="token variable">sess</span><span class="token punctuation">:</span>
        <span class="token punctuation">:</span><span class="token variable">return</span><span class="token punctuation">:</span>
        <span class="token string">""</span><span class="token punctuation">"</span>
        <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">merged</span> <span class="token punctuation">=</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">summary</span><span class="token punctuation">.</span><span class="token variable">merge_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">file_writer</span> <span class="token punctuation">=</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">summary</span><span class="token punctuation">.</span><span class="token variable">FileWriter</span><span class="token punctuation">(</span><span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">summary_path</span><span class="token punctuation">,</span> <span class="token variable">sess</span><span class="token punctuation">.</span><span class="token variable">graph</span><span class="token punctuation">)</span>
 
    <span class="token variable">def</span> <span class="token variable">train</span><span class="token punctuation">(</span><span class="token variable">self</span><span class="token punctuation">,</span> <span class="token variable">train</span><span class="token punctuation">,</span> <span class="token variable">dev</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">#</span><span class="token variable">下面的train</span><span class="token punctuation">=</span><span class="token variable">train_data</span><span class="token punctuation">,</span> <span class="token variable">dev</span><span class="token punctuation">=</span><span class="token variable">test_data</span>
        <span class="token string">""</span><span class="token punctuation">"</span> <span class="token variable">train_data的形状为</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'我'</span><span class="token punctuation">,</span><span class="token variable">在</span><span class="token string">'北'</span><span class="token punctuation">,</span><span class="token string">'京'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string">'O'</span><span class="token punctuation">,</span><span class="token string">'O'</span><span class="token punctuation">,</span><span class="token string">'B-LOC'</span><span class="token punctuation">,</span><span class="token string">'I-LOC'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token variable">第一句话</span>
                                 <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'我'</span><span class="token punctuation">,</span><span class="token variable">在</span><span class="token string">'天'</span><span class="token punctuation">,</span><span class="token string">'安'</span><span class="token punctuation">,</span><span class="token string">'门'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string">'O'</span><span class="token punctuation">,</span><span class="token string">'O'</span><span class="token punctuation">,</span><span class="token string">'B-LOC'</span><span class="token punctuation">,</span><span class="token string">'I-LOC'</span><span class="token punctuation">,</span><span class="token string">'I-LOC'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token variable">第二句话</span>
                                  <span class="token punctuation">(</span> <span class="token variable">第三句话</span> <span class="token punctuation">)</span>  <span class="token punctuation">]</span> <span class="token variable">总共有</span><span class="token number">50658</span><span class="token variable">句话</span><span class="token string">""</span><span class="token punctuation">"</span>
        <span class="token string">""</span><span class="token punctuation">"</span>
        <span class="token punctuation">:</span><span class="token variable">param</span> <span class="token variable">train</span><span class="token punctuation">:</span>
        <span class="token punctuation">:</span><span class="token variable">param</span> <span class="token variable">dev</span><span class="token punctuation">:</span>
        <span class="token punctuation">:</span><span class="token variable">return</span><span class="token punctuation">:</span>
        <span class="token string">""</span><span class="token punctuation">"</span>
        <span class="token variable">saver</span> <span class="token punctuation">=</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">train</span><span class="token punctuation">.</span><span class="token variable">Saver</span><span class="token punctuation">(</span><span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">global_variables</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 
        <span class="token variable">with</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">Session</span><span class="token punctuation">(</span><span class="token variable">config</span><span class="token punctuation">=</span><span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">config</span><span class="token punctuation">)</span> <span class="token variable">as</span> <span class="token variable">sess</span><span class="token punctuation">:</span>
            <span class="token variable">sess</span><span class="token punctuation">.</span><span class="token variable">run</span><span class="token punctuation">(</span><span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">init_op</span><span class="token punctuation">)</span>
            <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">add_summary</span><span class="token punctuation">(</span><span class="token variable">sess</span><span class="token punctuation">)</span>
 
            <span class="token punctuation">#</span><span class="token variable">epoch_num</span><span class="token punctuation">=</span><span class="token number">40</span>
            <span class="token variable">for</span> <span class="token variable">epoch</span> <span class="token variable">in</span> <span class="token variable">range</span><span class="token punctuation">(</span><span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">epoch_num</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">run_one_epoch</span><span class="token punctuation">(</span><span class="token variable">sess</span><span class="token punctuation">,</span> <span class="token variable">train</span><span class="token punctuation">,</span> <span class="token variable">dev</span><span class="token punctuation">,</span> <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">tag2label</span><span class="token punctuation">,</span> <span class="token variable">epoch</span><span class="token punctuation">,</span> <span class="token variable">saver</span><span class="token punctuation">)</span>
 
    <span class="token variable">def</span> <span class="token variable">test</span><span class="token punctuation">(</span><span class="token variable">self</span><span class="token punctuation">,</span> <span class="token variable">test</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token variable">saver</span> <span class="token punctuation">=</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">train</span><span class="token punctuation">.</span><span class="token variable">Saver</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token variable">with</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">Session</span><span class="token punctuation">(</span><span class="token variable">config</span><span class="token punctuation">=</span><span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">config</span><span class="token punctuation">)</span> <span class="token variable">as</span> <span class="token variable">sess</span><span class="token punctuation">:</span>
            <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">logger</span><span class="token punctuation">.</span><span class="token variable">info</span><span class="token punctuation">(</span><span class="token string">'=========== testing ==========='</span><span class="token punctuation">)</span>
            <span class="token variable">saver</span><span class="token punctuation">.</span><span class="token variable">restore</span><span class="token punctuation">(</span><span class="token variable">sess</span><span class="token punctuation">,</span> <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">model_path</span><span class="token punctuation">)</span>
            <span class="token variable">label_list</span><span class="token punctuation">,</span> <span class="token variable">seq_len_list</span> <span class="token punctuation">=</span> <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">dev_one_epoch</span><span class="token punctuation">(</span><span class="token variable">sess</span><span class="token punctuation">,</span> <span class="token variable">test</span><span class="token punctuation">)</span>
            <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">evaluate</span><span class="token punctuation">(</span><span class="token variable">label_list</span><span class="token punctuation">,</span> <span class="token variable">seq_len_list</span><span class="token punctuation">,</span> <span class="token variable">test</span><span class="token punctuation">)</span>
    <span class="token punctuation">#</span><span class="token variable">用模型测试一个句子</span>
    <span class="token variable">def</span> <span class="token variable">demo_one</span><span class="token punctuation">(</span><span class="token variable">self</span><span class="token punctuation">,</span> <span class="token variable">sess</span><span class="token punctuation">,</span> <span class="token variable">sent</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token string">""</span><span class="token punctuation">"</span>
        <span class="token punctuation">:</span><span class="token variable">param</span> <span class="token variable">sess</span><span class="token punctuation">:</span>
        <span class="token punctuation">:</span><span class="token variable">param</span> <span class="token variable">sent</span><span class="token punctuation">:</span> 
        <span class="token punctuation">:</span><span class="token variable">return</span><span class="token punctuation">:</span>
        <span class="token string">""</span><span class="token punctuation">"</span>
        <span class="token variable">label_list</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token variable">for</span> <span class="token variable">seqs</span><span class="token punctuation">,</span> <span class="token variable">labels</span> <span class="token variable">in</span> <span class="token variable">batch_yield</span><span class="token punctuation">(</span><span class="token variable">sent</span><span class="token punctuation">,</span> <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">batch_size</span><span class="token punctuation">,</span> <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">vocab</span><span class="token punctuation">,</span> <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">tag2label</span><span class="token punctuation">,</span> <span class="token variable">shuffle</span><span class="token punctuation">=</span><span class="token variable">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token punctuation">#</span> <span class="token variable">print</span><span class="token punctuation">(</span><span class="token string">'model 268行:'</span><span class="token punctuation">)</span>
            <span class="token punctuation">#</span> <span class="token variable">print</span><span class="token punctuation">(</span><span class="token variable">seqs</span><span class="token punctuation">)</span>
            <span class="token punctuation">#</span> <span class="token variable">print</span><span class="token punctuation">(</span><span class="token variable">labels</span><span class="token punctuation">)</span>
            <span class="token punctuation">#</span> <span class="token variable">model</span> <span class="token number">268</span> <span class="token variable">行</span><span class="token punctuation">:</span><span class="token variable">以</span>  <span class="token variable">小明的大学在北京的北京大学</span>  <span class="token variable">为例</span>
            <span class="token punctuation">#</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">841</span><span class="token punctuation">,</span> <span class="token number">37</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">485</span><span class="token punctuation">,</span> <span class="token number">73</span><span class="token punctuation">,</span> <span class="token number">87</span><span class="token punctuation">,</span> <span class="token number">74</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">87</span><span class="token punctuation">,</span> <span class="token number">74</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">485</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token variable">可见batch_yield就是把输入的句子每个字的id返回，以及每个标签转化为对应的tag2label的值</span>
            <span class="token punctuation">#</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
            <span class="token variable">label_list_</span><span class="token punctuation">,</span> <span class="token variable">_</span> <span class="token punctuation">=</span> <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">predict_one_batch</span><span class="token punctuation">(</span><span class="token variable">sess</span><span class="token punctuation">,</span> <span class="token variable">seqs</span><span class="token punctuation">)</span><span class="token punctuation">#</span><span class="token variable">得到了预测值</span>
            <span class="token punctuation">#</span> <span class="token variable">print</span><span class="token punctuation">(</span><span class="token string">'model 275行'</span><span class="token punctuation">)</span>
            <span class="token punctuation">#</span> <span class="token variable">print</span><span class="token punctuation">(</span><span class="token variable">label_list_</span><span class="token punctuation">)</span>
            <span class="token punctuation">#</span> <span class="token variable">print</span><span class="token punctuation">(</span><span class="token variable">_</span><span class="token punctuation">)</span>
            <span class="token punctuation">#</span> <span class="token variable">model</span> <span class="token number">275</span> <span class="token variable">行</span>
            <span class="token punctuation">#</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
            <span class="token punctuation">#</span> <span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span>
            <span class="token variable">label_list</span><span class="token punctuation">.</span><span class="token variable">extend</span><span class="token punctuation">(</span><span class="token variable">label_list_</span><span class="token punctuation">)</span>
        <span class="token variable">label2tag</span> <span class="token punctuation">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token variable">for</span> <span class="token variable">tag</span><span class="token punctuation">,</span> <span class="token variable">label</span> <span class="token variable">in</span> <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">tag2label</span><span class="token punctuation">.</span><span class="token variable">items</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token variable">label2tag</span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">label</span><span class="token punctuation">]</span></span> <span class="token punctuation">=</span> <span class="token variable">tag</span> <span class="token variable">if</span> <span class="token variable">label</span> <span class="token punctuation">!</span><span class="token punctuation">=</span> <span class="token number">0</span> <span class="token variable">else</span> <span class="token variable">label</span><span class="token punctuation">#</span>
        <span class="token variable">print</span><span class="token punctuation">(</span><span class="token string">'model 304'</span><span class="token punctuation">)</span>
        <span class="token variable">print</span><span class="token punctuation">(</span><span class="token variable">label2tag</span><span class="token punctuation">)</span>
        <span class="token variable">tag</span> <span class="token punctuation">=</span> <span class="token brackets"><span class="token punctuation">[</span><span class="token variable">label2tag</span><span class="token punctuation">[</span><span class="token variable">label</span><span class="token punctuation">]</span></span> <span class="token variable">for</span> <span class="token variable">label</span> <span class="token variable">in</span> <span class="token variable">label_list</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        <span class="token variable">print</span><span class="token punctuation">(</span><span class="token string">'model 307'</span><span class="token punctuation">)</span>
        <span class="token variable">print</span><span class="token punctuation">(</span><span class="token variable">tag</span><span class="token punctuation">)</span>
        <span class="token punctuation">#</span> <span class="token variable">model</span> <span class="token number">304</span>
        <span class="token punctuation">#</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span> <span class="token string">'B-PER'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span> <span class="token string">'I-PER'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">:</span> <span class="token string">'B-LOC'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">:</span> <span class="token string">'I-LOC'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span> <span class="token string">'B-ORG'</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">:</span> <span class="token string">'I-ORG'</span><span class="token punctuation">}</span>
        <span class="token punctuation">#</span> <span class="token variable">model</span> <span class="token number">307</span>
        <span class="token punctuation">#</span> <span class="token punctuation">[</span><span class="token string">'B-PER'</span><span class="token punctuation">,</span> <span class="token string">'I-PER'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'B-LOC'</span><span class="token punctuation">,</span> <span class="token string">'I-LOC'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'B-ORG'</span><span class="token punctuation">,</span> <span class="token string">'I-ORG'</span><span class="token punctuation">,</span> <span class="token string">'I-ORG'</span><span class="token punctuation">,</span> <span class="token string">'I-ORG'</span><span class="token punctuation">]</span>
        <span class="token variable">return</span> <span class="token variable">tag</span>
 
    <span class="token variable">def</span> <span class="token variable">run_one_epoch</span><span class="token punctuation">(</span><span class="token variable">self</span><span class="token punctuation">,</span> <span class="token variable">sess</span><span class="token punctuation">,</span> <span class="token variable">train</span><span class="token punctuation">,</span> <span class="token variable">dev</span><span class="token punctuation">,</span> <span class="token variable">tag2label</span><span class="token punctuation">,</span> <span class="token variable">epoch</span><span class="token punctuation">,</span> <span class="token variable">saver</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token string">""</span><span class="token punctuation">"</span>
        <span class="token punctuation">:</span><span class="token variable">param</span> <span class="token variable">sess</span><span class="token punctuation">:</span>
        <span class="token punctuation">:</span><span class="token variable">param</span> <span class="token variable">train</span><span class="token punctuation">:</span>
        <span class="token punctuation">:</span><span class="token variable">param</span> <span class="token variable">dev</span><span class="token punctuation">:</span>
        <span class="token punctuation">:</span><span class="token variable">param</span> <span class="token variable">tag2label</span><span class="token punctuation">:</span>
        <span class="token punctuation">:</span><span class="token variable">param</span> <span class="token variable">epoch</span><span class="token punctuation">:</span>
        <span class="token punctuation">:</span><span class="token variable">param</span> <span class="token variable">saver</span><span class="token punctuation">:</span>
        <span class="token punctuation">:</span><span class="token variable">return</span><span class="token punctuation">:</span>
        <span class="token string">""</span><span class="token punctuation">"</span>
        <span class="token punctuation">#</span> <span class="token variable">计算出多少个batch，计算过程：</span><span class="token punctuation">(</span><span class="token number">50658</span><span class="token punctuation">+</span><span class="token number">64</span><span class="token variable">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">/</span><span class="token punctuation">/</span><span class="token number">64</span><span class="token punctuation">=</span><span class="token number">792</span>
        <span class="token variable">num_batches</span> <span class="token punctuation">=</span> <span class="token punctuation">(</span><span class="token variable">len</span><span class="token punctuation">(</span><span class="token variable">train</span><span class="token punctuation">)</span> <span class="token punctuation">+</span> <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">batch_size</span> <span class="token variable">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">/</span><span class="token punctuation">/</span> <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">batch_size</span>
        <span class="token punctuation">#</span> <span class="token variable">记录开始训练的时间</span>
        <span class="token variable">start_time</span> <span class="token punctuation">=</span> <span class="token variable">time</span><span class="token punctuation">.</span><span class="token variable">strftime</span><span class="token punctuation">(</span><span class="token string">"%Y-%m-%d %H:%M:%S"</span><span class="token punctuation">,</span> <span class="token variable">time</span><span class="token punctuation">.</span><span class="token variable">localtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">#</span> <span class="token variable">产生每一个batch</span>
        <span class="token variable">batches</span> <span class="token punctuation">=</span> <span class="token variable">batch_yield</span><span class="token punctuation">(</span><span class="token variable">train</span><span class="token punctuation">,</span> <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">batch_size</span><span class="token punctuation">,</span> <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">vocab</span><span class="token punctuation">,</span> <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">tag2label</span><span class="token punctuation">,</span> <span class="token variable">shuffle</span><span class="token punctuation">=</span><span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">shuffle</span><span class="token punctuation">)</span>
        <span class="token variable">for</span> <span class="token variable">step</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token variable">seqs</span><span class="token punctuation">,</span> <span class="token variable">labels</span><span class="token punctuation">)</span> <span class="token variable">in</span> <span class="token variable">enumerate</span><span class="token punctuation">(</span><span class="token variable">batches</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token punctuation">#</span> <span class="token variable">sys</span><span class="token punctuation">.</span><span class="token variable">stdout</span> <span class="token variable">是标准输出文件，write就是往这个文件写数据</span>
            <span class="token variable">sys</span><span class="token punctuation">.</span><span class="token variable">stdout</span><span class="token punctuation">.</span><span class="token variable">write</span><span class="token punctuation">(</span><span class="token string">' processing: {} batch / {} batches.'</span><span class="token punctuation">.</span><span class="token variable">format</span><span class="token punctuation">(</span><span class="token variable">step</span> <span class="token punctuation">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token variable">num_batches</span><span class="token punctuation">)</span> <span class="token punctuation">+</span> <span class="token string">'\r'</span><span class="token punctuation">)</span>
            <span class="token punctuation">#</span> <span class="token variable">step_num</span><span class="token punctuation">=</span><span class="token variable">epoch</span><span class="token punctuation">*</span><span class="token number">792</span><span class="token punctuation">+</span><span class="token variable">step</span><span class="token punctuation">+</span><span class="token number">1</span>
            <span class="token variable">step_num</span> <span class="token punctuation">=</span> <span class="token variable">epoch</span> <span class="token punctuation">*</span> <span class="token variable">num_batches</span> <span class="token punctuation">+</span> <span class="token variable">step</span> <span class="token punctuation">+</span> <span class="token number">1</span>
            <span class="token variable">feed_dict</span><span class="token punctuation">,</span> <span class="token variable">_</span> <span class="token punctuation">=</span> <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">get_feed_dict</span><span class="token punctuation">(</span><span class="token variable">seqs</span><span class="token punctuation">,</span> <span class="token variable">labels</span><span class="token punctuation">,</span> <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">lr</span><span class="token punctuation">,</span> <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">dropout_keep_prob</span><span class="token punctuation">)</span>
            <span class="token variable">_</span><span class="token punctuation">,</span> <span class="token variable">loss_train</span><span class="token punctuation">,</span> <span class="token variable">summary</span><span class="token punctuation">,</span> <span class="token variable">step_num_</span> <span class="token punctuation">=</span> <span class="token variable">sess</span><span class="token punctuation">.</span><span class="token variable">run</span><span class="token punctuation">(</span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">self.train_op, self.loss, self.merged, self.global_step</span><span class="token punctuation">]</span></span><span class="token punctuation">,</span>
                                                         <span class="token variable">feed_dict</span><span class="token punctuation">=</span><span class="token variable">feed_dict</span><span class="token punctuation">)</span>
            <span class="token variable">if</span> <span class="token variable">step</span> <span class="token punctuation">+</span> <span class="token number">1</span> <span class="token punctuation">=</span><span class="token punctuation">=</span> <span class="token number">1</span> <span class="token variable">or</span> <span class="token punctuation">(</span><span class="token variable">step</span> <span class="token punctuation">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">%</span> <span class="token number">300</span> <span class="token punctuation">=</span><span class="token punctuation">=</span> <span class="token number">0</span> <span class="token variable">or</span> <span class="token variable">step</span> <span class="token punctuation">+</span> <span class="token number">1</span> <span class="token punctuation">=</span><span class="token punctuation">=</span> <span class="token variable">num_batches</span><span class="token punctuation">:</span><span class="token punctuation">#</span><span class="token variable">开头后每相隔</span><span class="token number">300</span><span class="token variable">记录一次，最后再记录一次</span>
                <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">logger</span><span class="token punctuation">.</span><span class="token variable">info</span><span class="token punctuation">(</span>
                    <span class="token string">'{} epoch {}, step {}, loss: {:.4}, global_step: {}'</span><span class="token punctuation">.</span><span class="token variable">format</span><span class="token punctuation">(</span><span class="token variable">start_time</span><span class="token punctuation">,</span> <span class="token variable">epoch</span> <span class="token punctuation">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token variable">step</span> <span class="token punctuation">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
                                                                                <span class="token variable">loss_train</span><span class="token punctuation">,</span> <span class="token variable">step_num</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">#</span><span class="token variable">可视化</span>
            <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">file_writer</span><span class="token punctuation">.</span><span class="token variable">add_summary</span><span class="token punctuation">(</span><span class="token variable">summary</span><span class="token punctuation">,</span> <span class="token variable">step_num</span><span class="token punctuation">)</span>
 
            <span class="token variable">if</span> <span class="token variable">step</span> <span class="token punctuation">+</span> <span class="token number">1</span> <span class="token punctuation">=</span><span class="token punctuation">=</span> <span class="token variable">num_batches</span><span class="token punctuation">:</span>
                <span class="token punctuation">#</span> <span class="token variable">训练的最后一个batch保存模型</span>
                <span class="token variable">saver</span><span class="token punctuation">.</span><span class="token variable">save</span><span class="token punctuation">(</span><span class="token variable">sess</span><span class="token punctuation">,</span> <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">model_path</span><span class="token punctuation">,</span> <span class="token variable">global_step</span><span class="token punctuation">=</span><span class="token variable">step_num</span><span class="token punctuation">)</span>
 
        <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">logger</span><span class="token punctuation">.</span><span class="token variable">info</span><span class="token punctuation">(</span><span class="token string">'===========validation / test==========='</span><span class="token punctuation">)</span>
        <span class="token variable">label_list_dev</span><span class="token punctuation">,</span> <span class="token variable">seq_len_list_dev</span> <span class="token punctuation">=</span> <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">dev_one_epoch</span><span class="token punctuation">(</span><span class="token variable">sess</span><span class="token punctuation">,</span> <span class="token variable">dev</span><span class="token punctuation">)</span><span class="token punctuation">#</span><span class="token variable">将test_data传过去</span>
        <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">evaluate</span><span class="token punctuation">(</span><span class="token variable">label_list_dev</span><span class="token punctuation">,</span> <span class="token variable">seq_len_list_dev</span><span class="token punctuation">,</span> <span class="token variable">dev</span><span class="token punctuation">,</span> <span class="token variable">epoch</span><span class="token punctuation">)</span>
 
    <span class="token punctuation">#</span><span class="token variable">占位符赋值</span>
    <span class="token variable">def</span> <span class="token variable">get_feed_dict</span><span class="token punctuation">(</span><span class="token variable">self</span><span class="token punctuation">,</span> <span class="token variable">seqs</span><span class="token punctuation">,</span> <span class="token variable">labels</span><span class="token punctuation">=</span><span class="token variable">None</span><span class="token punctuation">,</span> <span class="token variable">lr</span><span class="token punctuation">=</span><span class="token variable">None</span><span class="token punctuation">,</span> <span class="token variable">dropout</span><span class="token punctuation">=</span><span class="token variable">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token string">""</span><span class="token punctuation">"</span>
        <span class="token punctuation">:</span><span class="token variable">param</span> <span class="token variable">seqs</span><span class="token punctuation">:</span>
        <span class="token punctuation">:</span><span class="token variable">param</span> <span class="token variable">labels</span><span class="token punctuation">:</span>
        <span class="token punctuation">:</span><span class="token variable">param</span> <span class="token variable">lr</span><span class="token punctuation">:</span>
        <span class="token punctuation">:</span><span class="token variable">param</span> <span class="token variable">dropout</span><span class="token punctuation">:</span>
        <span class="token punctuation">:</span><span class="token variable">return</span><span class="token punctuation">:</span> <span class="token variable">feed_dict</span>
        <span class="token string">""</span><span class="token punctuation">"</span>
        <span class="token punctuation">#</span> <span class="token variable">seq_len_list用来统计每个样本的真实长度</span>
        <span class="token punctuation">#</span> <span class="token variable">word_ids就是seq_list，padding后的样本序列</span>
        <span class="token variable">word_ids</span><span class="token punctuation">,</span> <span class="token variable">seq_len_list</span> <span class="token punctuation">=</span> <span class="token variable">pad_sequences</span><span class="token punctuation">(</span><span class="token variable">seqs</span><span class="token punctuation">,</span> <span class="token variable">pad_mark</span><span class="token punctuation">=</span><span class="token number">0</span><span class="token punctuation">)</span>
 
        <span class="token variable">feed_dict</span> <span class="token punctuation">=</span> <span class="token punctuation">{<!-- --></span><span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">word_ids</span><span class="token punctuation">:</span> <span class="token variable">word_ids</span><span class="token punctuation">,</span>
                     <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">sequence_lengths</span><span class="token punctuation">:</span> <span class="token variable">seq_len_list</span><span class="token punctuation">}</span>
        <span class="token variable">if</span> <span class="token variable">labels</span> <span class="token variable">is</span> <span class="token variable">not</span> <span class="token variable">None</span><span class="token punctuation">:</span>
            <span class="token punctuation">#</span> <span class="token variable">labels经过padding后，喂给feed_dict</span>
            <span class="token variable">labels_</span><span class="token punctuation">,</span> <span class="token variable">_</span> <span class="token punctuation">=</span> <span class="token variable">pad_sequences</span><span class="token punctuation">(</span><span class="token variable">labels</span><span class="token punctuation">,</span> <span class="token variable">pad_mark</span><span class="token punctuation">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token variable">feed_dict</span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">self.labels</span><span class="token punctuation">]</span></span> <span class="token punctuation">=</span> <span class="token variable">labels_</span>
        <span class="token variable">if</span> <span class="token variable">lr</span> <span class="token variable">is</span> <span class="token variable">not</span> <span class="token variable">None</span><span class="token punctuation">:</span>
            <span class="token variable">feed_dict</span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">self.lr_pl</span><span class="token punctuation">]</span></span> <span class="token punctuation">=</span> <span class="token variable">lr</span>
        <span class="token variable">if</span> <span class="token variable">dropout</span> <span class="token variable">is</span> <span class="token variable">not</span> <span class="token variable">None</span><span class="token punctuation">:</span>
            <span class="token variable">feed_dict</span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">self.dropout_pl</span><span class="token punctuation">]</span></span> <span class="token punctuation">=</span> <span class="token variable">dropout</span>
        <span class="token punctuation">#</span> <span class="token variable">seq_len_list用来统计每个样本的真实长度</span>
        <span class="token variable">return</span> <span class="token variable">feed_dict</span><span class="token punctuation">,</span> <span class="token variable">seq_len_list</span>
 
    <span class="token variable">def</span> <span class="token variable">dev_one_epoch</span><span class="token punctuation">(</span><span class="token variable">self</span><span class="token punctuation">,</span> <span class="token variable">sess</span><span class="token punctuation">,</span> <span class="token variable">dev</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token string">""</span><span class="token punctuation">"</span>
        <span class="token punctuation">:</span><span class="token variable">param</span> <span class="token variable">sess</span><span class="token punctuation">:</span>
        <span class="token punctuation">:</span><span class="token variable">param</span> <span class="token variable">dev</span><span class="token punctuation">:</span>
        <span class="token punctuation">:</span><span class="token variable">return</span><span class="token punctuation">:</span>
        <span class="token string">""</span><span class="token punctuation">"</span>
        <span class="token variable">label_list</span><span class="token punctuation">,</span> <span class="token variable">seq_len_list</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token punctuation">#</span><span class="token variable">获取一个批次的句子中词的id以及标签</span>
        <span class="token variable">for</span> <span class="token variable">seqs</span><span class="token punctuation">,</span> <span class="token variable">labels</span> <span class="token variable">in</span> <span class="token variable">batch_yield</span><span class="token punctuation">(</span><span class="token variable">dev</span><span class="token punctuation">,</span> <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">batch_size</span><span class="token punctuation">,</span> <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">vocab</span><span class="token punctuation">,</span> <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">tag2label</span><span class="token punctuation">,</span> <span class="token variable">shuffle</span><span class="token punctuation">=</span><span class="token variable">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
 
            <span class="token variable">label_list_</span><span class="token punctuation">,</span> <span class="token variable">seq_len_list_</span> <span class="token punctuation">=</span> <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">predict_one_batch</span><span class="token punctuation">(</span><span class="token variable">sess</span><span class="token punctuation">,</span> <span class="token variable">seqs</span><span class="token punctuation">)</span>
            <span class="token variable">label_list</span><span class="token punctuation">.</span><span class="token variable">extend</span><span class="token punctuation">(</span><span class="token variable">label_list_</span><span class="token punctuation">)</span>
            <span class="token variable">seq_len_list</span><span class="token punctuation">.</span><span class="token variable">extend</span><span class="token punctuation">(</span><span class="token variable">seq_len_list_</span><span class="token punctuation">)</span>
        <span class="token variable">return</span> <span class="token variable">label_list</span><span class="token punctuation">,</span> <span class="token variable">seq_len_list</span>
 
    <span class="token variable">def</span> <span class="token variable">predict_one_batch</span><span class="token punctuation">(</span><span class="token variable">self</span><span class="token punctuation">,</span> <span class="token variable">sess</span><span class="token punctuation">,</span> <span class="token variable">seqs</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token string">""</span><span class="token punctuation">"</span>
        <span class="token punctuation">:</span><span class="token variable">param</span> <span class="token variable">sess</span><span class="token punctuation">:</span>
        <span class="token punctuation">:</span><span class="token variable">param</span> <span class="token variable">seqs</span><span class="token punctuation">:</span>
        <span class="token punctuation">:</span><span class="token variable">return</span><span class="token punctuation">:</span> <span class="token variable">label_list</span>
                 <span class="token variable">seq_len_list</span>
        <span class="token string">""</span><span class="token punctuation">"</span>
        <span class="token punctuation">#</span> <span class="token variable">seq_len_list用来统计每个样本的真实长度</span>
        <span class="token variable">feed_dict</span><span class="token punctuation">,</span> <span class="token variable">seq_len_list</span> <span class="token punctuation">=</span> <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">get_feed_dict</span><span class="token punctuation">(</span><span class="token variable">seqs</span><span class="token punctuation">,</span> <span class="token variable">dropout</span><span class="token punctuation">=</span><span class="token number">1.0</span><span class="token punctuation">)</span>
 
        <span class="token variable">if</span> <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">CRF</span><span class="token punctuation">:</span>
            <span class="token punctuation">#</span> <span class="token variable">transition_params代表转移概率，由crf_log_likelihood方法计算出</span>
            <span class="token variable">logits</span><span class="token punctuation">,</span> <span class="token variable">transition_params</span> <span class="token punctuation">=</span> <span class="token variable">sess</span><span class="token punctuation">.</span><span class="token variable">run</span><span class="token punctuation">(</span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">self.logits, self.transition_params</span><span class="token punctuation">]</span></span><span class="token punctuation">,</span>
                                                 <span class="token variable">feed_dict</span><span class="token punctuation">=</span><span class="token variable">feed_dict</span><span class="token punctuation">)</span>
<span class="token punctuation">#</span>             <span class="token variable">print</span><span class="token punctuation">(</span><span class="token string">'model 405'</span><span class="token punctuation">)</span>
<span class="token punctuation">#</span>             <span class="token variable">print</span><span class="token punctuation">(</span><span class="token variable">logits</span><span class="token punctuation">.</span><span class="token variable">shape</span><span class="token punctuation">)</span><span class="token punctuation">#</span><span class="token number">1</span><span class="token punctuation">*</span><span class="token number">13</span><span class="token punctuation">*</span><span class="token number">7</span>
<span class="token punctuation">#</span>             <span class="token variable">print</span><span class="token punctuation">(</span><span class="token variable">transition_params</span><span class="token punctuation">)</span><span class="token punctuation">#</span><span class="token number">7</span><span class="token punctuation">*</span><span class="token number">7</span><span class="token variable">矩阵</span>
            <span class="token variable">label_list</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            <span class="token punctuation">#</span> <span class="token variable">打包成元素形式为元组的列表</span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">(logit,seq_len),(logit,seq_len),( ,),</span><span class="token punctuation">]</span></span>
            <span class="token punctuation">#</span><span class="token variable">print</span><span class="token punctuation">(</span><span class="token variable">logits</span><span class="token punctuation">)</span>
<span class="token punctuation">#</span>             <span class="token variable">print</span><span class="token punctuation">(</span><span class="token string">'model 411'</span><span class="token punctuation">)</span>
<span class="token punctuation">#</span>             <span class="token variable">print</span><span class="token punctuation">(</span><span class="token variable">seq_len_list</span><span class="token punctuation">)</span>
            <span class="token punctuation">#</span> <span class="token variable">model</span> <span class="token number">411</span>
            <span class="token punctuation">#</span> <span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span> <span class="token punctuation">=</span><span class="token variable">小明的大学在北京的北京大学的长度</span>
            <span class="token variable">for</span> <span class="token variable">logit</span><span class="token punctuation">,</span> <span class="token variable">seq_len</span> <span class="token variable">in</span> <span class="token variable">zip</span><span class="token punctuation">(</span><span class="token variable">logits</span><span class="token punctuation">,</span> <span class="token variable">seq_len_list</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">#</span><span class="token variable">如果是demo情况下，输入句子，那么只有一个句子，所以只循环一次，训练模式下就不会</span>
                <span class="token punctuation">#</span><span class="token variable">对logits解析得到一个数</span>
                <span class="token variable">viterbi_seq</span><span class="token punctuation">,</span> <span class="token variable">_</span> <span class="token punctuation">=</span> <span class="token variable">viterbi_decode</span><span class="token punctuation">(</span><span class="token variable">logit</span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">:seq_len</span><span class="token punctuation">]</span></span><span class="token punctuation">,</span> <span class="token variable">transition_params</span><span class="token punctuation">)</span>
                <span class="token variable">label_list</span><span class="token punctuation">.</span><span class="token variable">append</span><span class="token punctuation">(</span><span class="token variable">viterbi_seq</span><span class="token punctuation">)</span>
            <span class="token variable">print</span><span class="token punctuation">(</span><span class="token string">'*-*******************************************************'</span><span class="token punctuation">)</span>
<span class="token punctuation">#</span>             <span class="token variable">print</span><span class="token punctuation">(</span><span class="token variable">label_list</span><span class="token punctuation">)</span><span class="token punctuation">#</span><span class="token variable">对logit按行解析返回的值</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">#</span><span class="token variable">这就是预测结果，对应着tag2label里的值</span>
            <span class="token variable">return</span> <span class="token variable">label_list</span><span class="token punctuation">,</span> <span class="token variable">seq_len_list</span>
 
        <span class="token variable">else</span><span class="token punctuation">:</span><span class="token punctuation">#</span><span class="token variable">如果不用CRF，就是把self</span><span class="token punctuation">.</span><span class="token variable">logits每行取最大的</span>
            <span class="token variable">label_list</span> <span class="token punctuation">=</span> <span class="token variable">sess</span><span class="token punctuation">.</span><span class="token variable">run</span><span class="token punctuation">(</span><span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">labels_softmax_</span><span class="token punctuation">,</span> <span class="token variable">feed_dict</span><span class="token punctuation">=</span><span class="token variable">feed_dict</span><span class="token punctuation">)</span>
            <span class="token variable">return</span> <span class="token variable">label_list</span><span class="token punctuation">,</span> <span class="token variable">seq_len_list</span>
 
    <span class="token variable">def</span> <span class="token variable">evaluate</span><span class="token punctuation">(</span><span class="token variable">self</span><span class="token punctuation">,</span> <span class="token variable">label_list</span><span class="token punctuation">,</span> <span class="token variable">seq_len_list</span><span class="token punctuation">,</span> <span class="token variable">data</span><span class="token punctuation">,</span> <span class="token variable">epoch</span><span class="token punctuation">=</span><span class="token variable">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token string">""</span><span class="token punctuation">"</span>
        <span class="token punctuation">:</span><span class="token variable">param</span> <span class="token variable">label_list</span><span class="token punctuation">:</span>
        <span class="token punctuation">:</span><span class="token variable">param</span> <span class="token variable">seq_len_list</span><span class="token punctuation">:</span>
        <span class="token punctuation">:</span><span class="token variable">param</span> <span class="token variable">data</span><span class="token punctuation">:</span>
        <span class="token punctuation">:</span><span class="token variable">param</span> <span class="token variable">epoch</span><span class="token punctuation">:</span>
        <span class="token punctuation">:</span><span class="token variable">return</span><span class="token punctuation">:</span>
        <span class="token string">""</span><span class="token punctuation">"</span>
        <span class="token variable">label2tag</span> <span class="token punctuation">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token variable">for</span> <span class="token variable">tag</span><span class="token punctuation">,</span> <span class="token variable">label</span> <span class="token variable">in</span> <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">tag2label</span><span class="token punctuation">.</span><span class="token variable">items</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token punctuation">#</span> <span class="token variable">tag2label</span> <span class="token punctuation">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"O"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token punctuation">#</span>              <span class="token string">"B-PER"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"I-PER"</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
            <span class="token punctuation">#</span>              <span class="token string">"B-LOC"</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"I-LOC"</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
            <span class="token punctuation">#</span>              <span class="token string">"B-ORG"</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">"I-ORG"</span><span class="token punctuation">:</span> <span class="token number">6</span>
            <span class="token punctuation">#</span>              <span class="token punctuation">}</span>
            <span class="token variable">label2tag</span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">label</span><span class="token punctuation">]</span></span> <span class="token punctuation">=</span> <span class="token variable">tag</span> <span class="token variable">if</span> <span class="token variable">label</span> <span class="token punctuation">!</span><span class="token punctuation">=</span> <span class="token number">0</span> <span class="token variable">else</span> <span class="token variable">label</span>
 
        <span class="token variable">model_predict</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token variable">for</span> <span class="token variable">label_</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token variable">sent</span><span class="token punctuation">,</span> <span class="token variable">tag</span><span class="token punctuation">)</span> <span class="token variable">in</span> <span class="token variable">zip</span><span class="token punctuation">(</span><span class="token variable">label_list</span><span class="token punctuation">,</span> <span class="token variable">data</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token variable">tag_</span> <span class="token punctuation">=</span> <span class="token brackets"><span class="token punctuation">[</span><span class="token variable">label2tag</span><span class="token punctuation">[</span><span class="token variable">label__</span><span class="token punctuation">]</span></span> <span class="token variable">for</span> <span class="token variable">label__</span> <span class="token variable">in</span> <span class="token variable">label_</span><span class="token punctuation">]</span>
            <span class="token variable">sent_res</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            <span class="token variable">if</span>  <span class="token variable">len</span><span class="token punctuation">(</span><span class="token variable">label_</span><span class="token punctuation">)</span> <span class="token punctuation">!</span><span class="token punctuation">=</span> <span class="token variable">len</span><span class="token punctuation">(</span><span class="token variable">sent</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token variable">print</span><span class="token punctuation">(</span><span class="token variable">sent</span><span class="token punctuation">)</span>
                <span class="token variable">print</span><span class="token punctuation">(</span><span class="token variable">len</span><span class="token punctuation">(</span><span class="token variable">label_</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token variable">print</span><span class="token punctuation">(</span><span class="token variable">tag</span><span class="token punctuation">)</span>
            <span class="token variable">for</span> <span class="token variable">i</span> <span class="token variable">in</span> <span class="token variable">range</span><span class="token punctuation">(</span><span class="token variable">len</span><span class="token punctuation">(</span><span class="token variable">sent</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token variable">sent_res</span><span class="token punctuation">.</span><span class="token variable">append</span><span class="token punctuation">(</span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">sent</span><span class="token punctuation">[</span><span class="token variable">i</span><span class="token punctuation">]</span></span><span class="token punctuation">,</span> <span class="token variable">tag</span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">i</span><span class="token punctuation">]</span></span><span class="token punctuation">,</span> <span class="token variable">tag_</span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">i</span><span class="token punctuation">]</span></span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token variable">model_predict</span><span class="token punctuation">.</span><span class="token variable">append</span><span class="token punctuation">(</span><span class="token variable">sent_res</span><span class="token punctuation">)</span>
        <span class="token variable">epoch_num</span> <span class="token punctuation">=</span> <span class="token variable">str</span><span class="token punctuation">(</span><span class="token variable">epoch</span><span class="token punctuation">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token variable">if</span> <span class="token variable">epoch</span> <span class="token punctuation">!</span><span class="token punctuation">=</span> <span class="token variable">None</span> <span class="token variable">else</span> <span class="token string">'test'</span>
        <span class="token variable">label_path</span> <span class="token punctuation">=</span> <span class="token variable">os</span><span class="token punctuation">.</span><span class="token variable">path</span><span class="token punctuation">.</span><span class="token variable">join</span><span class="token punctuation">(</span><span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">result_path</span><span class="token punctuation">,</span> <span class="token string">'label_'</span> <span class="token punctuation">+</span> <span class="token variable">epoch_num</span><span class="token punctuation">)</span>
        <span class="token variable">metric_path</span> <span class="token punctuation">=</span> <span class="token variable">os</span><span class="token punctuation">.</span><span class="token variable">path</span><span class="token punctuation">.</span><span class="token variable">join</span><span class="token punctuation">(</span><span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">result_path</span><span class="token punctuation">,</span> <span class="token string">'result_metric_'</span> <span class="token punctuation">+</span> <span class="token variable">epoch_num</span><span class="token punctuation">)</span>
        <span class="token variable">for</span> <span class="token variable">_</span> <span class="token variable">in</span> <span class="token variable">conlleval</span><span class="token punctuation">(</span><span class="token variable">model_predict</span><span class="token punctuation">,</span> <span class="token variable">label_path</span><span class="token punctuation">,</span> <span class="token variable">metric_path</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token variable">self</span><span class="token punctuation">.</span><span class="token variable">logger</span><span class="token punctuation">.</span><span class="token variable">info</span><span class="token punctuation">(</span><span class="token variable">_</span><span class="token punctuation">)</span>
</code></pre> 
<p>对应：<code>eval.py</code>，这里只进行评测过程的定义。在实际执行中，应该放在<code>model.py</code>之前。实际测试过程是在<code>model.py</code>中执行的。</p> 
<pre><code class="prism language-handlebars"><span class="token variable">import</span> <span class="token variable">os</span>
 
<span class="token punctuation">#</span><span class="token variable">第四步</span>
 
<span class="token punctuation">#</span><span class="token variable">使用conlleval</span><span class="token punctuation">.</span><span class="token variable">pl对CRF测试结果进行评价的方法</span>
<span class="token variable">def</span> <span class="token variable">conlleval</span><span class="token punctuation">(</span><span class="token variable">label_predict</span><span class="token punctuation">,</span> <span class="token variable">label_path</span><span class="token punctuation">,</span> <span class="token variable">metric_path</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token string">""</span><span class="token punctuation">"</span>
    <span class="token punctuation">:</span><span class="token variable">param</span> <span class="token variable">label_predict</span><span class="token punctuation">:</span>
    <span class="token punctuation">:</span><span class="token variable">param</span> <span class="token variable">label_path</span><span class="token punctuation">:</span>
    <span class="token punctuation">:</span><span class="token variable">par</span> <span class="token variable">am</span> <span class="token variable">metric_path</span><span class="token punctuation">:</span>
    <span class="token punctuation">:</span><span class="token variable">return</span><span class="token punctuation">:</span>
    <span class="token string">""</span><span class="token punctuation">"</span>
    <span class="token variable">eval_perl</span> <span class="token punctuation">=</span> <span class="token string">"../input/seq-tag/conlleval_rev.pl"</span>
    <span class="token variable">with</span> <span class="token variable">open</span><span class="token punctuation">(</span><span class="token variable">label_path</span><span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span> <span class="token variable">as</span> <span class="token variable">fw</span><span class="token punctuation">:</span>
        <span class="token variable">line</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token variable">for</span> <span class="token variable">sent_result</span> <span class="token variable">in</span> <span class="token variable">label_predict</span><span class="token punctuation">:</span>
            <span class="token variable">for</span> <span class="token variable">char</span><span class="token punctuation">,</span> <span class="token variable">tag</span><span class="token punctuation">,</span> <span class="token variable">tag_</span> <span class="token variable">in</span> <span class="token variable">sent_result</span><span class="token punctuation">:</span>
                <span class="token variable">tag</span> <span class="token punctuation">=</span> <span class="token string">'0'</span> <span class="token variable">if</span> <span class="token variable">tag</span> <span class="token punctuation">=</span><span class="token punctuation">=</span> <span class="token string">'O'</span> <span class="token variable">else</span> <span class="token variable">tag</span>
                <span class="token variable">char</span> <span class="token punctuation">=</span> <span class="token variable">char</span><span class="token punctuation">.</span><span class="token variable">encode</span><span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span>
                <span class="token variable">line</span><span class="token punctuation">.</span><span class="token variable">append</span><span class="token punctuation">(</span><span class="token string">"{} {} {}\n"</span><span class="token punctuation">.</span><span class="token variable">format</span><span class="token punctuation">(</span><span class="token variable">char</span><span class="token punctuation">,</span> <span class="token variable">tag</span><span class="token punctuation">,</span> <span class="token variable">tag_</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token variable">line</span><span class="token punctuation">.</span><span class="token variable">append</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span>
        <span class="token variable">fw</span><span class="token punctuation">.</span><span class="token variable">writelines</span><span class="token punctuation">(</span><span class="token variable">line</span><span class="token punctuation">)</span>
    <span class="token variable">os</span><span class="token punctuation">.</span><span class="token variable">system</span><span class="token punctuation">(</span><span class="token string">"perl {} &lt; {} &gt; {}"</span><span class="token punctuation">.</span><span class="token variable">format</span><span class="token punctuation">(</span><span class="token variable">eval_perl</span><span class="token punctuation">,</span> <span class="token variable">label_path</span><span class="token punctuation">,</span> <span class="token variable">metric_path</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token variable">with</span> <span class="token variable">open</span><span class="token punctuation">(</span><span class="token variable">metric_path</span><span class="token punctuation">)</span> <span class="token variable">as</span> <span class="token variable">fr</span><span class="token punctuation">:</span>
        <span class="token variable">metrics</span> <span class="token punctuation">=</span> <span class="token brackets"><span class="token punctuation">[</span><span class="token variable">line.strip() for line in fr</span><span class="token punctuation">]</span></span>
    <span class="token variable">return</span> <span class="token variable">metrics</span>
</code></pre> 
<p>对应：<code>main.py</code></p> 
<pre><code class="prism language-handlebars"><span class="token variable">import</span> <span class="token variable">tensorflow</span> <span class="token variable">as</span> <span class="token variable">tf</span>
<span class="token variable">from</span> <span class="token variable">tensorflow</span><span class="token punctuation">.</span><span class="token variable">python</span><span class="token punctuation">.</span><span class="token variable">framework</span> <span class="token variable">import</span> <span class="token variable">ops</span>
<span class="token variable">ops</span><span class="token punctuation">.</span><span class="token variable">reset_default_graph</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">#</span> <span class="token variable">import</span> <span class="token variable">tensorflow</span><span class="token punctuation">.</span><span class="token variable">compat</span><span class="token punctuation">.</span><span class="token variable">v1</span> <span class="token variable">as</span> <span class="token variable">tf</span>
<span class="token punctuation">#</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">disable_v2_behavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token punctuation">#</span> <span class="token variable">import</span> <span class="token variable">tensorflow</span><span class="token punctuation">.</span><span class="token variable">compat</span><span class="token punctuation">.</span><span class="token variable">v1</span> <span class="token variable">as</span> <span class="token variable">tf</span>
<span class="token punctuation">#</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">compat</span><span class="token punctuation">.</span><span class="token variable">v1</span><span class="token punctuation">.</span><span class="token variable">disable_eager_execution</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token variable">import</span> <span class="token variable">numpy</span> <span class="token variable">as</span> <span class="token variable">np</span>
<span class="token variable">import</span> <span class="token variable">os</span><span class="token punctuation">,</span> <span class="token variable">argparse</span><span class="token punctuation">,</span> <span class="token variable">time</span><span class="token punctuation">,</span> <span class="token variable">random</span>
<span class="token punctuation">#</span> <span class="token variable">from</span> <span class="token variable">model</span> <span class="token variable">import</span> <span class="token variable">BiLSTM_CRF</span>
<span class="token punctuation">#</span> <span class="token variable">from</span> <span class="token variable">utils</span> <span class="token variable">import</span> <span class="token variable">str2bool</span><span class="token punctuation">,</span> <span class="token variable">get_logger</span><span class="token punctuation">,</span> <span class="token variable">get_entity</span>
<span class="token punctuation">#</span> <span class="token variable">from</span> <span class="token variable">data</span> <span class="token variable">import</span> <span class="token variable">read_corpus</span><span class="token punctuation">,</span> <span class="token variable">read_dictionary</span><span class="token punctuation">,</span> <span class="token variable">tag2label</span><span class="token punctuation">,</span> <span class="token variable">random_embedding</span>

<span class="token punctuation">#</span> <span class="token variable">第五步运行</span>

<span class="token punctuation">#</span><span class="token punctuation">#</span> <span class="token variable">Session</span> <span class="token variable">configuration</span>
<span class="token punctuation">#</span> <span class="token variable">在python代码中设置使用的GPU</span>
<span class="token variable">os</span><span class="token punctuation">.</span><span class="token variable">environ</span><span class="token punctuation">[</span><span class="token string">'CUDA_VISIBLE_DEVICES'</span><span class="token punctuation">]</span> <span class="token punctuation">=</span> <span class="token string">'0'</span>
<span class="token variable">os</span><span class="token punctuation">.</span><span class="token variable">environ</span><span class="token punctuation">[</span><span class="token string">'TF_CPP_MIN_LOG_LEVEL'</span><span class="token punctuation">]</span> <span class="token punctuation">=</span> <span class="token string">'2'</span>  <span class="token punctuation">#</span> <span class="token variable">default</span><span class="token punctuation">:</span> <span class="token number">0</span>
<span class="token punctuation">#</span> <span class="token variable">记录设备指派情况</span><span class="token punctuation">:</span><span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">ConfigProto</span><span class="token punctuation">(</span><span class="token variable">log_device_placement</span><span class="token punctuation">=</span><span class="token variable">True</span><span class="token punctuation">)</span>
<span class="token punctuation">#</span> <span class="token variable">设置tf</span><span class="token punctuation">.</span><span class="token variable">ConfigProto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token variable">中参数log_device_placement</span> <span class="token punctuation">=</span> <span class="token variable">True</span> <span class="token punctuation">,</span>
<span class="token punctuation">#</span> <span class="token variable">可以获取到</span> <span class="token variable">operations</span> <span class="token variable">和</span> <span class="token variable">Tensor</span> <span class="token variable">被指派到哪个设备</span><span class="token punctuation">(</span><span class="token variable">几号CPU或几号GPU</span><span class="token punctuation">)</span><span class="token variable">上运行</span><span class="token punctuation">,</span>
<span class="token punctuation">#</span> <span class="token variable">会在终端打印出各项操作是在哪个设备上运行的。</span>
<span class="token punctuation">#</span> <span class="token variable">config</span> <span class="token punctuation">=</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">ConfigProto</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token variable">config</span><span class="token punctuation">=</span><span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">compat</span><span class="token punctuation">.</span><span class="token variable">v1</span><span class="token punctuation">.</span><span class="token variable">ConfigProto</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token variable">config</span><span class="token punctuation">.</span><span class="token variable">gpu_options</span><span class="token punctuation">.</span><span class="token variable">allow_growth</span> <span class="token punctuation">=</span> <span class="token variable">True</span>
<span class="token variable">config</span><span class="token punctuation">.</span><span class="token variable">gpu_options</span><span class="token punctuation">.</span><span class="token variable">per_process_gpu_memory_fraction</span> <span class="token punctuation">=</span> <span class="token number">0.2</span>  <span class="token punctuation">#</span> <span class="token variable">need</span> <span class="token punctuation">~</span><span class="token number">700</span><span class="token variable">MB</span> <span class="token variable">GPU</span> <span class="token variable">memory</span>

<span class="token punctuation">#</span><span class="token punctuation">#</span> <span class="token variable">hyperparameters超参数设置</span>
<span class="token punctuation">#</span> <span class="token variable">使用argparse的第一步就是创建一个解析器对象，并告诉它将会有些什么参数。</span>
<span class="token punctuation">#</span> <span class="token variable">那么当你的程序运行时，该解析器就可以用于处理命令行参数</span>
<span class="token variable">parser</span> <span class="token punctuation">=</span> <span class="token variable">argparse</span><span class="token punctuation">.</span><span class="token variable">ArgumentParser</span><span class="token punctuation">(</span><span class="token variable">description</span><span class="token punctuation">=</span><span class="token string">'BiLSTM-CRF for Chinese NER task'</span><span class="token punctuation">)</span>
<span class="token punctuation">#</span> <span class="token variable">方法add_argument</span><span class="token punctuation">(</span><span class="token variable">name</span> <span class="token variable">or</span> <span class="token variable">flags</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">, action</span><span class="token punctuation">]</span></span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">, nargs</span><span class="token punctuation">]</span></span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">, const</span><span class="token punctuation">]</span></span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">, default</span><span class="token punctuation">]</span></span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">, type</span><span class="token punctuation">]</span></span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">, choices</span><span class="token punctuation">]</span></span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">, required</span><span class="token punctuation">]</span></span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">, help</span><span class="token punctuation">]</span></span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">, metavar</span><span class="token punctuation">]</span></span><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">, dest</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span>
<span class="token punctuation">#</span> <span class="token variable">其中：</span>
<span class="token punctuation">#</span> <span class="token variable">name</span> <span class="token variable">or</span> <span class="token variable">flags：命令行参数名或者选项，如上面的address或者-p</span><span class="token punctuation">,</span><span class="token variable">--port</span><span class="token punctuation">.</span><span class="token variable">​</span>
<span class="token punctuation">#</span> <span class="token variable">其中命令行参数如果没给定，且没有设置defualt，则出错。但是如果是选项的话，则设置为None</span>
<span class="token punctuation">#</span> <span class="token variable">nargs：命令行参数的个数，</span>
<span class="token punctuation">#</span> <span class="token variable">一般使用通配符表示，其中，</span><span class="token string">'?'</span><span class="token variable">表示只用一个，</span><span class="token string">'*'</span><span class="token variable">表示</span><span class="token number">0</span><span class="token variable">到多个，</span><span class="token string">'+'</span><span class="token variable">表示至少一个</span>
<span class="token punctuation">#</span> <span class="token variable">default：默认值</span>
<span class="token punctuation">#</span> <span class="token variable">type：参数的类型，默认是字符串string类型，还有float、int等类型</span>
<span class="token punctuation">#</span> <span class="token variable">help：和ArgumentParser方法中的参数作用相似，出现的场合也一致</span>
<span class="token punctuation">#</span> <span class="token variable">最常用的地方就是这些，其他的可以参考官方文档。</span>
<span class="token variable">parser</span><span class="token punctuation">.</span><span class="token variable">add_argument</span><span class="token punctuation">(</span><span class="token string">'--train_data'</span><span class="token punctuation">,</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token variable">str</span><span class="token punctuation">,</span> <span class="token variable">default</span><span class="token punctuation">=</span><span class="token string">'../input/seq-tag/data_path'</span><span class="token punctuation">,</span> <span class="token variable">help</span><span class="token punctuation">=</span><span class="token string">'train data source'</span><span class="token punctuation">)</span>
<span class="token variable">parser</span><span class="token punctuation">.</span><span class="token variable">add_argument</span><span class="token punctuation">(</span><span class="token string">'--test_data'</span><span class="token punctuation">,</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token variable">str</span><span class="token punctuation">,</span> <span class="token variable">default</span><span class="token punctuation">=</span><span class="token string">'../input/seq-tag/data_path'</span><span class="token punctuation">,</span> <span class="token variable">help</span><span class="token punctuation">=</span><span class="token string">'test data source'</span><span class="token punctuation">)</span>
<span class="token variable">parser</span><span class="token punctuation">.</span><span class="token variable">add_argument</span><span class="token punctuation">(</span><span class="token string">'--batch_size'</span><span class="token punctuation">,</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token variable">int</span><span class="token punctuation">,</span> <span class="token variable">default</span><span class="token punctuation">=</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token variable">help</span><span class="token punctuation">=</span><span class="token string">'#sample of each minibatch'</span><span class="token punctuation">)</span>
<span class="token variable">parser</span><span class="token punctuation">.</span><span class="token variable">add_argument</span><span class="token punctuation">(</span><span class="token string">'--epoch'</span><span class="token punctuation">,</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token variable">int</span><span class="token punctuation">,</span> <span class="token variable">default</span><span class="token punctuation">=</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token variable">help</span><span class="token punctuation">=</span><span class="token string">'#epoch of training'</span><span class="token punctuation">)</span>
<span class="token variable">parser</span><span class="token punctuation">.</span><span class="token variable">add_argument</span><span class="token punctuation">(</span><span class="token string">'--hidden_dim'</span><span class="token punctuation">,</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token variable">int</span><span class="token punctuation">,</span> <span class="token variable">default</span><span class="token punctuation">=</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token variable">help</span><span class="token punctuation">=</span><span class="token string">'#dim of hidden state'</span><span class="token punctuation">)</span>
<span class="token variable">parser</span><span class="token punctuation">.</span><span class="token variable">add_argument</span><span class="token punctuation">(</span><span class="token string">'--optimizer'</span><span class="token punctuation">,</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token variable">str</span><span class="token punctuation">,</span> <span class="token variable">default</span><span class="token punctuation">=</span><span class="token string">'Adam'</span><span class="token punctuation">,</span> <span class="token variable">help</span><span class="token punctuation">=</span><span class="token string">'Adam/Adadelta/Adagrad/RMSProp/Momentum/SGD'</span><span class="token punctuation">)</span>
<span class="token variable">parser</span><span class="token punctuation">.</span><span class="token variable">add_argument</span><span class="token punctuation">(</span><span class="token string">'--CRF'</span><span class="token punctuation">,</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token variable">str2bool</span><span class="token punctuation">,</span> <span class="token variable">default</span><span class="token punctuation">=</span><span class="token variable">True</span><span class="token punctuation">,</span> <span class="token variable">help</span><span class="token punctuation">=</span><span class="token string">'use CRF at the top layer. if False, use Softmax'</span><span class="token punctuation">)</span>
<span class="token variable">parser</span><span class="token punctuation">.</span><span class="token variable">add_argument</span><span class="token punctuation">(</span><span class="token string">'--lr'</span><span class="token punctuation">,</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token variable">float</span><span class="token punctuation">,</span> <span class="token variable">default</span><span class="token punctuation">=</span><span class="token number">0.001</span><span class="token punctuation">,</span> <span class="token variable">help</span><span class="token punctuation">=</span><span class="token string">'learning rate'</span><span class="token punctuation">)</span>
<span class="token variable">parser</span><span class="token punctuation">.</span><span class="token variable">add_argument</span><span class="token punctuation">(</span><span class="token string">'--clip'</span><span class="token punctuation">,</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token variable">float</span><span class="token punctuation">,</span> <span class="token variable">default</span><span class="token punctuation">=</span><span class="token number">5.0</span><span class="token punctuation">,</span> <span class="token variable">help</span><span class="token punctuation">=</span><span class="token string">'gradient clipping'</span><span class="token punctuation">)</span>
<span class="token variable">parser</span><span class="token punctuation">.</span><span class="token variable">add_argument</span><span class="token punctuation">(</span><span class="token string">'--dropout'</span><span class="token punctuation">,</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token variable">float</span><span class="token punctuation">,</span> <span class="token variable">default</span><span class="token punctuation">=</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token variable">help</span><span class="token punctuation">=</span><span class="token string">'dropout keep_prob'</span><span class="token punctuation">)</span>
<span class="token variable">parser</span><span class="token punctuation">.</span><span class="token variable">add_argument</span><span class="token punctuation">(</span><span class="token string">'--update_embedding'</span><span class="token punctuation">,</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token variable">str2bool</span><span class="token punctuation">,</span> <span class="token variable">default</span><span class="token punctuation">=</span><span class="token variable">True</span><span class="token punctuation">,</span> <span class="token variable">help</span><span class="token punctuation">=</span><span class="token string">'update embedding during training'</span><span class="token punctuation">)</span>
<span class="token variable">parser</span><span class="token punctuation">.</span><span class="token variable">add_argument</span><span class="token punctuation">(</span><span class="token string">'--pretrain_embedding'</span><span class="token punctuation">,</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token variable">str</span><span class="token punctuation">,</span> <span class="token variable">default</span><span class="token punctuation">=</span><span class="token string">'random'</span><span class="token punctuation">,</span>
                    <span class="token variable">help</span><span class="token punctuation">=</span><span class="token string">'use pretrained char embedding or init it randomly'</span><span class="token punctuation">)</span>
<span class="token variable">parser</span><span class="token punctuation">.</span><span class="token variable">add_argument</span><span class="token punctuation">(</span><span class="token string">'--embedding_dim'</span><span class="token punctuation">,</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token variable">int</span><span class="token punctuation">,</span> <span class="token variable">default</span><span class="token punctuation">=</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token variable">help</span><span class="token punctuation">=</span><span class="token string">'random init char embedding_dim'</span><span class="token punctuation">)</span>
<span class="token variable">parser</span><span class="token punctuation">.</span><span class="token variable">add_argument</span><span class="token punctuation">(</span><span class="token string">'--shuffle'</span><span class="token punctuation">,</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token variable">str2bool</span><span class="token punctuation">,</span> <span class="token variable">default</span><span class="token punctuation">=</span><span class="token variable">True</span><span class="token punctuation">,</span> <span class="token variable">help</span><span class="token punctuation">=</span><span class="token string">'shuffle training data before each epoch'</span><span class="token punctuation">)</span>
<span class="token variable">parser</span><span class="token punctuation">.</span><span class="token variable">add_argument</span><span class="token punctuation">(</span><span class="token string">'--mode'</span><span class="token punctuation">,</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token variable">str</span><span class="token punctuation">,</span> <span class="token variable">default</span><span class="token punctuation">=</span><span class="token string">'test'</span><span class="token punctuation">,</span> <span class="token variable">help</span><span class="token punctuation">=</span><span class="token string">'train/test/demo'</span><span class="token punctuation">)</span>
<span class="token variable">parser</span><span class="token punctuation">.</span><span class="token variable">add_argument</span><span class="token punctuation">(</span><span class="token string">'--demo_model'</span><span class="token punctuation">,</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token variable">str</span><span class="token punctuation">,</span> <span class="token variable">default</span><span class="token punctuation">=</span><span class="token string">'1669192178'</span><span class="token punctuation">,</span> <span class="token variable">help</span><span class="token punctuation">=</span><span class="token string">'model for test and demo'</span><span class="token punctuation">)</span>
<span class="token punctuation">#</span> <span class="token variable">传递参数送入模型中解析</span>
<span class="token variable">args</span> <span class="token punctuation">=</span> <span class="token variable">parser</span><span class="token punctuation">.</span><span class="token variable">parse_args</span><span class="token punctuation">(</span><span class="token variable">args</span><span class="token punctuation">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token punctuation">#</span><span class="token punctuation">#</span> <span class="token variable">get</span> <span class="token variable">char</span> <span class="token variable">embeddings</span>

<span class="token string">''</span><span class="token string">'word2id的形状为{'</span><span class="token variable">当</span><span class="token string">': 1, '</span><span class="token variable">希</span><span class="token string">': 2, '</span><span class="token variable">望</span><span class="token string">': 3, '</span><span class="token variable">工</span><span class="token string">': 4, '</span><span class="token variable">程</span><span class="token string">': 5,。。'</span><span class="token punctuation">&lt;</span><span class="token variable">UNK</span><span class="token punctuation">&gt;</span><span class="token string">': 3904, '</span><span class="token punctuation">&lt;</span><span class="token variable">PAD</span><span class="token punctuation">&gt;</span><span class="token punctuation">'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span>
   <span class="token variable">train_data总共</span><span class="token number">3903</span><span class="token variable">个去重后的字</span><span class="token string">''</span><span class="token punctuation">'</span>
<span class="token variable">word2id</span> <span class="token punctuation">=</span> <span class="token variable">read_dictionary</span><span class="token punctuation">(</span><span class="token string">'./word2id.pkl'</span><span class="token punctuation">)</span>
<span class="token punctuation">#</span>     <span class="token variable">os</span><span class="token punctuation">.</span><span class="token variable">path</span><span class="token punctuation">.</span><span class="token variable">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token variable">args</span><span class="token punctuation">.</span><span class="token variable">train_data</span><span class="token punctuation">,</span> <span class="token string">'word2id.pkl'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">#</span> <span class="token punctuation">.</span><span class="token punctuation">\</span><span class="token variable">args</span><span class="token punctuation">.</span><span class="token variable">train_data</span><span class="token punctuation">\</span><span class="token variable">word2id</span><span class="token punctuation">.</span><span class="token variable">pkl</span> <span class="token punctuation">#</span><span class="token variable">提前执行vocab_build</span>

<span class="token punctuation">#</span> <span class="token variable">通过调用random_embedding函数返回一个len</span><span class="token punctuation">(</span><span class="token variable">vocab</span><span class="token punctuation">)</span><span class="token punctuation">*</span><span class="token variable">embedding_dim</span><span class="token punctuation">=</span><span class="token number">3905</span><span class="token punctuation">*</span><span class="token number">300</span><span class="token variable">的矩阵</span><span class="token punctuation">(</span><span class="token variable">矩阵元素均在-</span><span class="token number">0.25</span><span class="token variable">到</span><span class="token number">0.25</span><span class="token variable">之间</span><span class="token punctuation">)</span><span class="token variable">作为初始值</span>
<span class="token variable">if</span> <span class="token variable">args</span><span class="token punctuation">.</span><span class="token variable">pretrain_embedding</span> <span class="token punctuation">=</span><span class="token punctuation">=</span> <span class="token string">'random'</span><span class="token punctuation">:</span>
    <span class="token variable">embeddings</span> <span class="token punctuation">=</span> <span class="token variable">random_embedding</span><span class="token punctuation">(</span><span class="token variable">word2id</span><span class="token punctuation">,</span> <span class="token variable">args</span><span class="token punctuation">.</span><span class="token variable">embedding_dim</span><span class="token punctuation">)</span>
<span class="token variable">else</span><span class="token punctuation">:</span>
    <span class="token variable">embedding_path</span> <span class="token punctuation">=</span> <span class="token string">'pretrain_embedding.npy'</span>
    <span class="token variable">embeddings</span> <span class="token punctuation">=</span> <span class="token variable">np</span><span class="token punctuation">.</span><span class="token variable">array</span><span class="token punctuation">(</span><span class="token variable">np</span><span class="token punctuation">.</span><span class="token variable">load</span><span class="token punctuation">(</span><span class="token variable">embedding_path</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">dtype</span><span class="token punctuation">=</span><span class="token string">'float32'</span><span class="token punctuation">)</span>

<span class="token punctuation">#</span><span class="token punctuation">#</span> <span class="token variable">read</span> <span class="token variable">corpus</span> <span class="token variable">and</span> <span class="token variable">get</span> <span class="token variable">training</span> <span class="token variable">data</span>
<span class="token variable">if</span> <span class="token variable">args</span><span class="token punctuation">.</span><span class="token variable">mode</span> <span class="token punctuation">!</span><span class="token punctuation">=</span> <span class="token string">'demo'</span><span class="token punctuation">:</span>
    <span class="token punctuation">#</span> <span class="token variable">设置train_path的路径为data_path下的train_data文件</span>
    <span class="token variable">train_path</span> <span class="token punctuation">=</span> <span class="token variable">os</span><span class="token punctuation">.</span><span class="token variable">path</span><span class="token punctuation">.</span><span class="token variable">join</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token variable">args</span><span class="token punctuation">.</span><span class="token variable">train_data</span><span class="token punctuation">,</span> <span class="token string">'train_data.txt'</span><span class="token punctuation">)</span>  <span class="token punctuation">#</span> <span class="token punctuation">.</span><span class="token punctuation">\</span><span class="token variable">args</span><span class="token punctuation">.</span><span class="token variable">train_data</span><span class="token punctuation">(</span><span class="token variable">默认值data_path</span><span class="token punctuation">)</span><span class="token punctuation">\</span><span class="token variable">train_data</span>
    <span class="token punctuation">#</span> <span class="token variable">设置test_path的路径为data_path下的test_path文件</span>
    <span class="token variable">test_path</span> <span class="token punctuation">=</span> <span class="token variable">os</span><span class="token punctuation">.</span><span class="token variable">path</span><span class="token punctuation">.</span><span class="token variable">join</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token variable">args</span><span class="token punctuation">.</span><span class="token variable">test_data</span><span class="token punctuation">,</span> <span class="token string">'test_data.txt'</span><span class="token punctuation">)</span>  <span class="token punctuation">#</span> <span class="token punctuation">.</span><span class="token punctuation">\</span><span class="token variable">args</span><span class="token punctuation">.</span><span class="token variable">train_data</span><span class="token punctuation">(</span><span class="token variable">默认值data_path</span><span class="token punctuation">)</span><span class="token punctuation">\</span><span class="token variable">test_data</span>
    <span class="token punctuation">#</span> <span class="token variable">通过read_corpus函数读取出train_data</span>
    <span class="token string">""</span><span class="token punctuation">"</span> <span class="token variable">train_data的形状为</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'我'</span><span class="token punctuation">,</span><span class="token variable">在</span><span class="token string">'北'</span><span class="token punctuation">,</span><span class="token string">'京'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string">'O'</span><span class="token punctuation">,</span><span class="token string">'O'</span><span class="token punctuation">,</span><span class="token string">'B-LOC'</span><span class="token punctuation">,</span><span class="token string">'I-LOC'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token variable">第一句话</span>
                         <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'我'</span><span class="token punctuation">,</span><span class="token variable">在</span><span class="token string">'天'</span><span class="token punctuation">,</span><span class="token string">'安'</span><span class="token punctuation">,</span><span class="token string">'门'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string">'O'</span><span class="token punctuation">,</span><span class="token string">'O'</span><span class="token punctuation">,</span><span class="token string">'B-LOC'</span><span class="token punctuation">,</span><span class="token string">'I-LOC'</span><span class="token punctuation">,</span><span class="token string">'I-LOC'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token variable">第二句话</span>  
                          <span class="token punctuation">(</span> <span class="token variable">第三句话</span> <span class="token punctuation">)</span>  <span class="token punctuation">]</span> <span class="token variable">总共有</span><span class="token number">50658</span><span class="token variable">句话</span><span class="token string">""</span><span class="token punctuation">"</span>
    <span class="token variable">train_data</span> <span class="token punctuation">=</span> <span class="token variable">read_corpus</span><span class="token punctuation">(</span><span class="token variable">train_path</span><span class="token punctuation">)</span>
    <span class="token variable">test_data</span> <span class="token punctuation">=</span> <span class="token variable">read_corpus</span><span class="token punctuation">(</span><span class="token variable">test_path</span><span class="token punctuation">)</span>
    <span class="token variable">test_size</span> <span class="token punctuation">=</span> <span class="token variable">len</span><span class="token punctuation">(</span><span class="token variable">test_data</span><span class="token punctuation">)</span>

<span class="token punctuation">#</span><span class="token punctuation">#</span> <span class="token variable">paths</span> <span class="token variable">setting</span>
<span class="token variable">paths</span> <span class="token punctuation">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">#</span> <span class="token variable">时间戳就是一个时间点，一般就是为了在同步更新的情况下提高效率之用。</span>
<span class="token punctuation">#</span> <span class="token variable">就比如一个文件，如果他没有被更改，那么他的时间戳就不会改变，那么就没有必要写回，以提高效率，</span>
<span class="token punctuation">#</span> <span class="token variable">如果不论有没有被更改都重新写回的话，很显然效率会有所下降。</span>

<span class="token punctuation">#</span> <span class="token variable">如果是训练就获取最新时间，否则就</span><span class="token punctuation">=</span><span class="token variable">args</span><span class="token punctuation">.</span><span class="token variable">demo_model</span>
<span class="token variable">timestamp</span> <span class="token punctuation">=</span> <span class="token variable">str</span><span class="token punctuation">(</span><span class="token variable">int</span><span class="token punctuation">(</span><span class="token variable">time</span><span class="token punctuation">.</span><span class="token variable">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token variable">if</span> <span class="token variable">args</span><span class="token punctuation">.</span><span class="token variable">mode</span> <span class="token punctuation">=</span><span class="token punctuation">=</span> <span class="token string">'train'</span> <span class="token variable">else</span> <span class="token variable">args</span><span class="token punctuation">.</span><span class="token variable">demo_model</span>
<span class="token punctuation">#</span> <span class="token variable">输出地址</span><span class="token punctuation">,</span><span class="token variable">默认是</span><span class="token punctuation">.</span><span class="token punctuation">/</span><span class="token variable">data_path_save</span><span class="token punctuation">/</span><span class="token variable">时间戳</span>
<span class="token variable">output_path</span> <span class="token punctuation">=</span> <span class="token variable">os</span><span class="token punctuation">.</span><span class="token variable">path</span><span class="token punctuation">.</span><span class="token variable">join</span><span class="token punctuation">(</span><span class="token string">'./'</span><span class="token punctuation">,</span> <span class="token string">'data_path_save'</span><span class="token punctuation">,</span> <span class="token variable">timestamp</span><span class="token punctuation">)</span> <span class="token punctuation">#</span><span class="token punctuation">.</span><span class="token punctuation">/</span><span class="token variable">data_path_save</span><span class="token punctuation">/</span><span class="token variable">时间</span>
<span class="token punctuation">#</span>     <span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token variable">args</span><span class="token punctuation">.</span><span class="token variable">train_data</span> <span class="token punctuation">+</span> <span class="token string">"_save"</span><span class="token punctuation">,</span> <span class="token variable">timestamp</span><span class="token punctuation">)</span><span class="token punctuation">#</span><span class="token punctuation">.</span><span class="token punctuation">/</span><span class="token variable">data_path_save</span><span class="token punctuation">/</span><span class="token variable">时间</span>
<span class="token punctuation">#</span> <span class="token variable">如果地址不存在就新建</span>
<span class="token variable">if</span> <span class="token variable">not</span> <span class="token variable">os</span><span class="token punctuation">.</span><span class="token variable">path</span><span class="token punctuation">.</span><span class="token variable">exists</span><span class="token punctuation">(</span><span class="token variable">output_path</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token variable">os</span><span class="token punctuation">.</span><span class="token variable">makedirs</span><span class="token punctuation">(</span><span class="token variable">output_path</span><span class="token punctuation">)</span>

<span class="token punctuation">#</span> <span class="token punctuation">.</span><span class="token punctuation">/</span><span class="token variable">data_path_save</span><span class="token punctuation">/</span><span class="token variable">时间戳</span><span class="token punctuation">/</span><span class="token variable">summaries</span>
<span class="token variable">summary_path</span> <span class="token punctuation">=</span> <span class="token variable">os</span><span class="token punctuation">.</span><span class="token variable">path</span><span class="token punctuation">.</span><span class="token variable">join</span><span class="token punctuation">(</span><span class="token variable">output_path</span><span class="token punctuation">,</span> <span class="token string">"summaries"</span><span class="token punctuation">)</span><span class="token punctuation">#</span><span class="token punctuation">.</span><span class="token punctuation">/</span><span class="token variable">data_path_save</span><span class="token punctuation">/</span><span class="token variable">时间</span><span class="token punctuation">/</span><span class="token variable">summaries</span>
<span class="token variable">paths</span><span class="token punctuation">[</span><span class="token string">'summary_path'</span><span class="token punctuation">]</span> <span class="token punctuation">=</span> <span class="token variable">summary_path</span>
<span class="token punctuation">#</span> <span class="token variable">如果地址不存在就新建</span>
<span class="token variable">if</span> <span class="token variable">not</span> <span class="token variable">os</span><span class="token punctuation">.</span><span class="token variable">path</span><span class="token punctuation">.</span><span class="token variable">exists</span><span class="token punctuation">(</span><span class="token variable">summary_path</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token variable">os</span><span class="token punctuation">.</span><span class="token variable">makedirs</span><span class="token punctuation">(</span><span class="token variable">summary_path</span><span class="token punctuation">)</span>

<span class="token punctuation">#</span> <span class="token punctuation">.</span><span class="token punctuation">/</span><span class="token variable">data_path_save</span><span class="token punctuation">/</span><span class="token variable">时间戳</span><span class="token punctuation">/</span><span class="token variable">checkpoints</span><span class="token punctuation">/</span>
<span class="token variable">model_path</span> <span class="token punctuation">=</span> <span class="token variable">os</span><span class="token punctuation">.</span><span class="token variable">path</span><span class="token punctuation">.</span><span class="token variable">join</span><span class="token punctuation">(</span><span class="token variable">output_path</span><span class="token punctuation">,</span> <span class="token string">"checkpoints/"</span><span class="token punctuation">)</span><span class="token punctuation">#</span><span class="token punctuation">#</span><span class="token punctuation">.</span><span class="token punctuation">/</span><span class="token variable">data_path_save</span><span class="token punctuation">/</span><span class="token variable">时间</span><span class="token punctuation">/</span><span class="token variable">checkpoints</span><span class="token punctuation">/</span>
<span class="token variable">if</span> <span class="token variable">not</span> <span class="token variable">os</span><span class="token punctuation">.</span><span class="token variable">path</span><span class="token punctuation">.</span><span class="token variable">exists</span><span class="token punctuation">(</span><span class="token variable">model_path</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token variable">os</span><span class="token punctuation">.</span><span class="token variable">makedirs</span><span class="token punctuation">(</span><span class="token variable">model_path</span><span class="token punctuation">)</span>

<span class="token punctuation">#</span> <span class="token punctuation">.</span><span class="token punctuation">/</span><span class="token variable">data_path_save</span><span class="token punctuation">/</span><span class="token variable">时间戳</span><span class="token punctuation">/</span><span class="token variable">checkpoints</span><span class="token punctuation">/</span><span class="token variable">model</span>
<span class="token variable">ckpt_prefix</span> <span class="token punctuation">=</span> <span class="token variable">os</span><span class="token punctuation">.</span><span class="token variable">path</span><span class="token punctuation">.</span><span class="token variable">join</span><span class="token punctuation">(</span><span class="token variable">model_path</span><span class="token punctuation">,</span> <span class="token string">"model"</span><span class="token punctuation">)</span><span class="token punctuation">#</span><span class="token punctuation">.</span><span class="token punctuation">/</span><span class="token variable">data_path_save</span><span class="token punctuation">/</span><span class="token variable">时间</span><span class="token punctuation">/</span><span class="token variable">checkpoints</span><span class="token punctuation">/</span><span class="token variable">model</span>
<span class="token variable">paths</span><span class="token punctuation">[</span><span class="token string">'model_path'</span><span class="token punctuation">]</span> <span class="token punctuation">=</span> <span class="token variable">ckpt_prefix</span>
<span class="token punctuation">#</span> <span class="token variable">如果不存在就新建</span>
<span class="token variable">if</span> <span class="token variable">not</span> <span class="token variable">os</span><span class="token punctuation">.</span><span class="token variable">path</span><span class="token punctuation">.</span><span class="token variable">exists</span><span class="token punctuation">(</span><span class="token variable">ckpt_prefix</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token variable">os</span><span class="token punctuation">.</span><span class="token variable">makedirs</span><span class="token punctuation">(</span><span class="token variable">ckpt_prefix</span><span class="token punctuation">)</span>

<span class="token punctuation">#</span> <span class="token punctuation">.</span><span class="token punctuation">/</span><span class="token variable">data_path_save</span><span class="token punctuation">/</span><span class="token variable">时间戳</span><span class="token punctuation">/</span><span class="token variable">results</span>
<span class="token variable">result_path</span> <span class="token punctuation">=</span> <span class="token variable">os</span><span class="token punctuation">.</span><span class="token variable">path</span><span class="token punctuation">.</span><span class="token variable">join</span><span class="token punctuation">(</span><span class="token variable">output_path</span><span class="token punctuation">,</span> <span class="token string">"results"</span><span class="token punctuation">)</span><span class="token punctuation">#</span><span class="token punctuation">#</span><span class="token punctuation">.</span><span class="token punctuation">/</span><span class="token variable">data_path_save</span><span class="token punctuation">/</span><span class="token variable">时间</span><span class="token punctuation">/</span><span class="token variable">results</span>
<span class="token variable">paths</span><span class="token punctuation">[</span><span class="token string">'result_path'</span><span class="token punctuation">]</span> <span class="token punctuation">=</span> <span class="token variable">result_path</span>
<span class="token punctuation">#</span> <span class="token variable">如果不存在就新建</span>
<span class="token variable">if</span> <span class="token variable">not</span> <span class="token variable">os</span><span class="token punctuation">.</span><span class="token variable">path</span><span class="token punctuation">.</span><span class="token variable">exists</span><span class="token punctuation">(</span><span class="token variable">result_path</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token variable">os</span><span class="token punctuation">.</span><span class="token variable">makedirs</span><span class="token punctuation">(</span><span class="token variable">result_path</span><span class="token punctuation">)</span>

<span class="token variable">log_path</span> <span class="token punctuation">=</span> <span class="token variable">os</span><span class="token punctuation">.</span><span class="token variable">path</span><span class="token punctuation">.</span><span class="token variable">join</span><span class="token punctuation">(</span><span class="token variable">result_path</span><span class="token punctuation">,</span> <span class="token string">"log.txt"</span><span class="token punctuation">)</span>
<span class="token variable">paths</span><span class="token punctuation">[</span><span class="token string">'log_path'</span><span class="token punctuation">]</span> <span class="token punctuation">=</span> <span class="token variable">log_path</span>
<span class="token punctuation">#</span> <span class="token variable">把调用的函数及各个参数写入日志文件</span>
<span class="token punctuation">#</span> <span class="token number">2019</span><span class="token variable">-</span><span class="token number">07</span><span class="token variable">-</span><span class="token number">26</span> <span class="token number">08</span><span class="token punctuation">:</span><span class="token number">45</span><span class="token punctuation">:</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token number">081</span><span class="token punctuation">:</span><span class="token variable">INFO</span><span class="token punctuation">:</span> <span class="token variable">Namespace</span><span class="token punctuation">(</span><span class="token variable">CRF</span><span class="token punctuation">=</span><span class="token variable">True</span><span class="token punctuation">,</span> <span class="token variable">batch_size</span><span class="token punctuation">=</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token variable">clip</span><span class="token punctuation">=</span><span class="token number">5.0</span><span class="token punctuation">,</span> <span class="token variable">demo_model</span><span class="token punctuation">=</span><span class="token string">'1521112368'</span><span class="token punctuation">,</span> <span class="token variable">dropout</span><span class="token punctuation">=</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token variable">embedding_dim</span><span class="token punctuation">=</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token variable">epoch</span><span class="token punctuation">=</span><span class="token number">40</span><span class="token punctuation">,</span> <span class="token variable">hidden_dim</span><span class="token punctuation">=</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token variable">lr</span><span class="token punctuation">=</span><span class="token number">0.001</span><span class="token punctuation">,</span> <span class="token variable">mode</span><span class="token punctuation">=</span><span class="token string">'demo'</span><span class="token punctuation">,</span> <span class="token variable">optimizer</span><span class="token punctuation">=</span><span class="token string">'Adam'</span><span class="token punctuation">,</span> <span class="token variable">pretrain_embedding</span><span class="token punctuation">=</span><span class="token string">'random'</span><span class="token punctuation">,</span> <span class="token variable">shuffle</span><span class="token punctuation">=</span><span class="token variable">True</span><span class="token punctuation">,</span> <span class="token variable">test_data</span><span class="token punctuation">=</span><span class="token string">'data_path'</span><span class="token punctuation">,</span> <span class="token variable">train_data</span><span class="token punctuation">=</span><span class="token string">'data_path'</span><span class="token punctuation">,</span> <span class="token variable">update_embedding</span><span class="token punctuation">=</span><span class="token variable">True</span><span class="token punctuation">)</span>
<span class="token variable">get_logger</span><span class="token punctuation">(</span><span class="token variable">log_path</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token variable">info</span><span class="token punctuation">(</span><span class="token variable">str</span><span class="token punctuation">(</span><span class="token variable">args</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">#</span><span class="token punctuation">#</span> <span class="token variable">training</span> <span class="token variable">model</span>
<span class="token variable">if</span> <span class="token variable">args</span><span class="token punctuation">.</span><span class="token variable">mode</span> <span class="token punctuation">=</span><span class="token punctuation">=</span> <span class="token string">'train'</span><span class="token punctuation">:</span>
    <span class="token punctuation">#</span> <span class="token variable">引入第二步建立的模型</span>
    <span class="token variable">model</span> <span class="token punctuation">=</span> <span class="token variable">BiLSTM_CRF</span><span class="token punctuation">(</span><span class="token variable">args</span><span class="token punctuation">,</span> <span class="token variable">embeddings</span><span class="token punctuation">,</span> <span class="token variable">tag2label</span><span class="token punctuation">,</span> <span class="token variable">word2id</span><span class="token punctuation">,</span> <span class="token variable">paths</span><span class="token punctuation">,</span> <span class="token variable">config</span><span class="token punctuation">=</span><span class="token variable">config</span><span class="token punctuation">)</span>
    <span class="token punctuation">#</span> <span class="token variable">创建节点，无返回值</span>
<span class="token punctuation">#</span>     <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">reset_default_graph</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token variable">model</span><span class="token punctuation">.</span><span class="token variable">build_graph</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token punctuation">#</span><span class="token punctuation">#</span> <span class="token variable">hyperparameters-tuning</span><span class="token punctuation">,</span> <span class="token variable">split</span> <span class="token variable">train</span><span class="token punctuation">/</span><span class="token variable">dev</span>
    <span class="token punctuation">#</span> <span class="token variable">dev_data</span> <span class="token punctuation">=</span> <span class="token variable">train_data</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5000</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token variable">dev_size</span> <span class="token punctuation">=</span> <span class="token variable">len</span><span class="token punctuation">(</span><span class="token variable">dev_data</span><span class="token punctuation">)</span>
    <span class="token punctuation">#</span> <span class="token variable">train_data</span> <span class="token punctuation">=</span> <span class="token variable">train_data</span><span class="token punctuation">[</span><span class="token number">5000</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token variable">train_size</span> <span class="token punctuation">=</span> <span class="token variable">len</span><span class="token punctuation">(</span><span class="token variable">train_data</span><span class="token punctuation">)</span>
    <span class="token punctuation">#</span> <span class="token variable">print</span><span class="token punctuation">(</span><span class="token string">"train data: {0}\ndev data: {1}"</span><span class="token punctuation">.</span><span class="token variable">format</span><span class="token punctuation">(</span><span class="token variable">train_size</span><span class="token punctuation">,</span> <span class="token variable">dev_size</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">#</span> <span class="token variable">model</span><span class="token punctuation">.</span><span class="token variable">train</span><span class="token punctuation">(</span><span class="token variable">train</span><span class="token punctuation">=</span><span class="token variable">train_data</span><span class="token punctuation">,</span> <span class="token variable">dev</span><span class="token punctuation">=</span><span class="token variable">dev_data</span><span class="token punctuation">)</span>

    <span class="token punctuation">#</span><span class="token punctuation">#</span> <span class="token variable">train</span> <span class="token variable">model</span> <span class="token variable">on</span> <span class="token variable">the</span> <span class="token variable">whole</span> <span class="token variable">training</span> <span class="token variable">data</span>
    <span class="token variable">print</span><span class="token punctuation">(</span><span class="token string">"train data: {}"</span><span class="token punctuation">.</span><span class="token variable">format</span><span class="token punctuation">(</span><span class="token variable">len</span><span class="token punctuation">(</span><span class="token variable">train_data</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">#</span> <span class="token variable">训练</span>
    <span class="token variable">model</span><span class="token punctuation">.</span><span class="token variable">train</span><span class="token punctuation">(</span><span class="token variable">train</span><span class="token punctuation">=</span><span class="token variable">train_data</span><span class="token punctuation">,</span> <span class="token variable">dev</span><span class="token punctuation">=</span><span class="token variable">test_data</span><span class="token punctuation">)</span>  <span class="token punctuation">#</span> <span class="token variable">use</span> <span class="token variable">test_data</span> <span class="token variable">as</span> <span class="token variable">the</span> <span class="token variable">dev_data</span> <span class="token variable">to</span> <span class="token variable">see</span> <span class="token variable">overfitting</span> <span class="token variable">phenomena</span>

<span class="token punctuation">#</span><span class="token punctuation">#</span> <span class="token variable">testing</span> <span class="token variable">model</span>
<span class="token variable">elif</span> <span class="token variable">args</span><span class="token punctuation">.</span><span class="token variable">mode</span> <span class="token punctuation">=</span><span class="token punctuation">=</span> <span class="token string">'test'</span><span class="token punctuation">:</span>
    <span class="token variable">ckpt_file</span> <span class="token punctuation">=</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">train</span><span class="token punctuation">.</span><span class="token variable">latest_checkpoint</span><span class="token punctuation">(</span><span class="token variable">model_path</span><span class="token punctuation">)</span>
    <span class="token variable">print</span><span class="token punctuation">(</span><span class="token variable">ckpt_file</span><span class="token punctuation">)</span>
    <span class="token variable">paths</span><span class="token punctuation">[</span><span class="token string">'model_path'</span><span class="token punctuation">]</span> <span class="token punctuation">=</span> <span class="token variable">ckpt_file</span>
    <span class="token variable">model</span> <span class="token punctuation">=</span> <span class="token variable">BiLSTM_CRF</span><span class="token punctuation">(</span><span class="token variable">args</span><span class="token punctuation">,</span> <span class="token variable">embeddings</span><span class="token punctuation">,</span> <span class="token variable">tag2label</span><span class="token punctuation">,</span> <span class="token variable">word2id</span><span class="token punctuation">,</span> <span class="token variable">paths</span><span class="token punctuation">,</span> <span class="token variable">config</span><span class="token punctuation">=</span><span class="token variable">config</span><span class="token punctuation">)</span>
    <span class="token variable">model</span><span class="token punctuation">.</span><span class="token variable">build_graph</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token variable">print</span><span class="token punctuation">(</span><span class="token string">"test data: {}"</span><span class="token punctuation">.</span><span class="token variable">format</span><span class="token punctuation">(</span><span class="token variable">test_size</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">#</span> <span class="token variable">测试</span>
    <span class="token variable">model</span><span class="token punctuation">.</span><span class="token variable">test</span><span class="token punctuation">(</span><span class="token variable">test_data</span><span class="token punctuation">)</span>

<span class="token punctuation">#</span><span class="token punctuation">#</span> <span class="token variable">demo</span>
<span class="token variable">elif</span> <span class="token variable">args</span><span class="token punctuation">.</span><span class="token variable">mode</span> <span class="token punctuation">=</span><span class="token punctuation">=</span> <span class="token string">'demo'</span><span class="token punctuation">:</span>
    <span class="token variable">ckpt_file</span> <span class="token punctuation">=</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">train</span><span class="token punctuation">.</span><span class="token variable">latest_checkpoint</span><span class="token punctuation">(</span><span class="token variable">model_path</span><span class="token punctuation">)</span>
    <span class="token variable">print</span><span class="token punctuation">(</span><span class="token variable">ckpt_file</span><span class="token punctuation">)</span>
    <span class="token variable">paths</span><span class="token punctuation">[</span><span class="token string">'model_path'</span><span class="token punctuation">]</span> <span class="token punctuation">=</span> <span class="token variable">ckpt_file</span>
    <span class="token variable">model</span> <span class="token punctuation">=</span> <span class="token variable">BiLSTM_CRF</span><span class="token punctuation">(</span><span class="token variable">args</span><span class="token punctuation">,</span> <span class="token variable">embeddings</span><span class="token punctuation">,</span> <span class="token variable">tag2label</span><span class="token punctuation">,</span> <span class="token variable">word2id</span><span class="token punctuation">,</span> <span class="token variable">paths</span><span class="token punctuation">,</span> <span class="token variable">config</span><span class="token punctuation">=</span><span class="token variable">config</span><span class="token punctuation">)</span>
    <span class="token variable">model</span><span class="token punctuation">.</span><span class="token variable">build_graph</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token variable">saver</span> <span class="token punctuation">=</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">train</span><span class="token punctuation">.</span><span class="token variable">Saver</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token variable">with</span> <span class="token variable">tf</span><span class="token punctuation">.</span><span class="token variable">Session</span><span class="token punctuation">(</span><span class="token variable">config</span><span class="token punctuation">=</span><span class="token variable">config</span><span class="token punctuation">)</span> <span class="token variable">as</span> <span class="token variable">sess</span><span class="token punctuation">:</span>
        <span class="token variable">print</span><span class="token punctuation">(</span><span class="token string">'============= demo ============='</span><span class="token punctuation">)</span>
        <span class="token variable">saver</span><span class="token punctuation">.</span><span class="token variable">restore</span><span class="token punctuation">(</span><span class="token variable">sess</span><span class="token punctuation">,</span> <span class="token variable">ckpt_file</span><span class="token punctuation">)</span>  <span class="token punctuation">#</span> <span class="token variable">读入已经训练好的模型</span>
        <span class="token variable">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token variable">print</span><span class="token punctuation">(</span><span class="token string">'Please input your sentence:'</span><span class="token punctuation">)</span>
            <span class="token variable">demo_sent</span> <span class="token punctuation">=</span> <span class="token variable">input</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token variable">if</span> <span class="token variable">demo_sent</span> <span class="token punctuation">=</span><span class="token punctuation">=</span> <span class="token string">''</span> <span class="token variable">or</span> <span class="token variable">demo_sent</span><span class="token punctuation">.</span><span class="token variable">isspace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token variable">print</span><span class="token punctuation">(</span><span class="token string">'See you next time!'</span><span class="token punctuation">)</span>
                <span class="token variable">break</span>
            <span class="token variable">else</span><span class="token punctuation">:</span>
                <span class="token variable">demo_sent</span> <span class="token punctuation">=</span> <span class="token variable">list</span><span class="token punctuation">(</span><span class="token variable">demo_sent</span><span class="token punctuation">.</span><span class="token variable">strip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">#</span> <span class="token punctuation">[</span><span class="token string">'小'</span><span class="token punctuation">,</span> <span class="token string">'明'</span><span class="token punctuation">,</span> <span class="token string">'的'</span><span class="token punctuation">,</span> <span class="token string">'大'</span><span class="token punctuation">,</span> <span class="token string">'学'</span><span class="token punctuation">,</span> <span class="token string">'在'</span><span class="token punctuation">,</span> <span class="token string">'北'</span><span class="token punctuation">,</span> <span class="token string">'京'</span><span class="token punctuation">,</span> <span class="token string">'的'</span><span class="token punctuation">,</span> <span class="token string">'北'</span><span class="token punctuation">,</span> <span class="token string">'京'</span><span class="token punctuation">,</span> <span class="token string">'大'</span><span class="token punctuation">,</span> <span class="token string">'学'</span><span class="token punctuation">]</span>
                <span class="token variable">demo_data</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token variable">demo_sent</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'O'</span><span class="token punctuation">]</span> <span class="token punctuation">*</span> <span class="token variable">len</span><span class="token punctuation">(</span>
                    <span class="token variable">demo_sent</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token punctuation">#</span> <span class="token variable">如</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'小'</span><span class="token punctuation">,</span> <span class="token string">'明'</span><span class="token punctuation">,</span> <span class="token string">'的'</span><span class="token punctuation">,</span> <span class="token string">'大'</span><span class="token punctuation">,</span> <span class="token string">'学'</span><span class="token punctuation">,</span> <span class="token string">'在'</span><span class="token punctuation">,</span> <span class="token string">'北'</span><span class="token punctuation">,</span> <span class="token string">'京'</span><span class="token punctuation">,</span> <span class="token string">'的'</span><span class="token punctuation">,</span> <span class="token string">'北'</span><span class="token punctuation">,</span> <span class="token string">'京'</span><span class="token punctuation">,</span> <span class="token string">'大'</span><span class="token punctuation">,</span> <span class="token string">'学'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'O'</span><span class="token punctuation">,</span> <span class="token string">'O'</span><span class="token punctuation">,</span> <span class="token string">'O'</span><span class="token punctuation">,</span> <span class="token string">'O'</span><span class="token punctuation">,</span> <span class="token string">'O'</span><span class="token punctuation">,</span> <span class="token string">'O'</span><span class="token punctuation">,</span> <span class="token string">'O'</span><span class="token punctuation">,</span> <span class="token string">'O'</span><span class="token punctuation">,</span> <span class="token string">'O'</span><span class="token punctuation">,</span> <span class="token string">'O'</span><span class="token punctuation">,</span> <span class="token string">'O'</span><span class="token punctuation">,</span> <span class="token string">'O'</span><span class="token punctuation">,</span> <span class="token string">'O'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
                <span class="token punctuation">#</span> <span class="token variable">用模型测试一个句子</span>
                <span class="token variable">print</span><span class="token punctuation">(</span><span class="token string">'main 172行:'</span><span class="token punctuation">)</span>
                <span class="token variable">print</span><span class="token punctuation">(</span><span class="token variable">demo_data</span><span class="token punctuation">)</span>
                <span class="token punctuation">#</span> <span class="token variable">main</span> <span class="token number">172</span><span class="token variable">行</span><span class="token punctuation">:</span>
                <span class="token punctuation">#</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'小'</span><span class="token punctuation">,</span> <span class="token string">'明'</span><span class="token punctuation">,</span> <span class="token string">'的'</span><span class="token punctuation">,</span> <span class="token string">'大'</span><span class="token punctuation">,</span> <span class="token string">'学'</span><span class="token punctuation">,</span> <span class="token string">'在'</span><span class="token punctuation">,</span> <span class="token string">'北'</span><span class="token punctuation">,</span> <span class="token string">'京'</span><span class="token punctuation">,</span> <span class="token string">'的'</span><span class="token punctuation">,</span> <span class="token string">'北'</span><span class="token punctuation">,</span> <span class="token string">'京'</span><span class="token punctuation">,</span> <span class="token string">'大'</span><span class="token punctuation">,</span> <span class="token string">'学'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'O'</span><span class="token punctuation">,</span> <span class="token string">'O'</span><span class="token punctuation">,</span> <span class="token string">'O'</span><span class="token punctuation">,</span> <span class="token string">'O'</span><span class="token punctuation">,</span> <span class="token string">'O'</span><span class="token punctuation">,</span> <span class="token string">'O'</span><span class="token punctuation">,</span> <span class="token string">'O'</span><span class="token punctuation">,</span> <span class="token string">'O'</span><span class="token punctuation">,</span> <span class="token string">'O'</span><span class="token punctuation">,</span> <span class="token string">'O'</span><span class="token punctuation">,</span> <span class="token string">'O'</span><span class="token punctuation">,</span> <span class="token string">'O'</span><span class="token punctuation">,</span> <span class="token string">'O'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
                <span class="token variable">tag</span> <span class="token punctuation">=</span> <span class="token variable">model</span><span class="token punctuation">.</span><span class="token variable">demo_one</span><span class="token punctuation">(</span><span class="token variable">sess</span><span class="token punctuation">,</span>
                                     <span class="token variable">demo_data</span><span class="token punctuation">)</span>  <span class="token punctuation">#</span><span class="token punctuation">#</span> <span class="token punctuation">[</span><span class="token string">'B-PER'</span><span class="token punctuation">,</span> <span class="token string">'I-PER'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'B-LOC'</span><span class="token punctuation">,</span> <span class="token string">'I-LOC'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'B-ORG'</span><span class="token punctuation">,</span> <span class="token string">'I-ORG'</span><span class="token punctuation">,</span> <span class="token string">'I-ORG'</span><span class="token punctuation">,</span> <span class="token string">'I-ORG'</span><span class="token punctuation">]</span>
                <span class="token variable">PER</span><span class="token punctuation">,</span> <span class="token variable">LOC</span><span class="token punctuation">,</span> <span class="token variable">ORG</span> <span class="token punctuation">=</span> <span class="token variable">get_entity</span><span class="token punctuation">(</span><span class="token variable">tag</span><span class="token punctuation">,</span> <span class="token variable">demo_sent</span><span class="token punctuation">)</span>
                <span class="token variable">print</span><span class="token punctuation">(</span><span class="token string">'PER: {}\nLOC: {}\nORG: {}'</span><span class="token punctuation">.</span><span class="token variable">format</span><span class="token punctuation">(</span><span class="token variable">PER</span><span class="token punctuation">,</span> <span class="token variable">LOC</span><span class="token punctuation">,</span> <span class="token variable">ORG</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>打包模型和预测结果：</p> 
<pre><code class="prism language-handlebars"><span class="token variable">import</span> <span class="token variable">os</span>
<span class="token variable">import</span> <span class="token variable">zipfile</span>
<span class="token variable">import</span> <span class="token variable">datetime</span>

<span class="token variable">def</span> <span class="token variable">file2zip</span><span class="token punctuation">(</span><span class="token variable">packagePath</span><span class="token punctuation">,</span> <span class="token variable">zipPath</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token variable">zip</span> <span class="token punctuation">=</span> <span class="token variable">zipfile</span><span class="token punctuation">.</span><span class="token variable">ZipFile</span><span class="token punctuation">(</span><span class="token variable">zipPath</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> <span class="token variable">zipfile</span><span class="token punctuation">.</span><span class="token variable">ZIP_DEFLATED</span><span class="token punctuation">)</span>
    <span class="token variable">for</span> <span class="token variable">path</span><span class="token punctuation">,</span> <span class="token variable">dirNames</span><span class="token punctuation">,</span> <span class="token variable">fileNames</span> <span class="token variable">in</span> <span class="token variable">os</span><span class="token punctuation">.</span><span class="token variable">walk</span><span class="token punctuation">(</span><span class="token variable">packagePath</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token variable">fpath</span> <span class="token punctuation">=</span> <span class="token variable">path</span><span class="token punctuation">.</span><span class="token variable">replace</span><span class="token punctuation">(</span><span class="token variable">packagePath</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
        <span class="token variable">for</span> <span class="token variable">name</span> <span class="token variable">in</span> <span class="token variable">fileNames</span><span class="token punctuation">:</span>
            <span class="token variable">fullName</span> <span class="token punctuation">=</span> <span class="token variable">os</span><span class="token punctuation">.</span><span class="token variable">path</span><span class="token punctuation">.</span><span class="token variable">join</span><span class="token punctuation">(</span><span class="token variable">path</span><span class="token punctuation">,</span> <span class="token variable">name</span><span class="token punctuation">)</span>
            <span class="token variable">name</span> <span class="token punctuation">=</span> <span class="token variable">fpath</span> <span class="token punctuation">+</span> <span class="token string">'\\'</span> <span class="token punctuation">+</span> <span class="token variable">name</span>
            <span class="token variable">zip</span><span class="token punctuation">.</span><span class="token variable">write</span><span class="token punctuation">(</span><span class="token variable">fullName</span><span class="token punctuation">,</span> <span class="token variable">name</span><span class="token punctuation">)</span>
    <span class="token variable">zip</span><span class="token punctuation">.</span><span class="token variable">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token variable">if</span> <span class="token variable">__name__</span> <span class="token punctuation">=</span><span class="token punctuation">=</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token punctuation">#</span> <span class="token variable">文件夹路径</span>
    <span class="token variable">packagePath</span> <span class="token punctuation">=</span> <span class="token string">'/kaggle/working/'</span>
    <span class="token variable">zipPath</span> <span class="token punctuation">=</span> <span class="token string">'/kaggle/working/output.zip'</span>
    <span class="token variable">if</span> <span class="token variable">os</span><span class="token punctuation">.</span><span class="token variable">path</span><span class="token punctuation">.</span><span class="token variable">exists</span><span class="token punctuation">(</span><span class="token variable">zipPath</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token variable">os</span><span class="token punctuation">.</span><span class="token variable">remove</span><span class="token punctuation">(</span><span class="token variable">zipPath</span><span class="token punctuation">)</span>
    <span class="token variable">file2zip</span><span class="token punctuation">(</span><span class="token variable">packagePath</span><span class="token punctuation">,</span> <span class="token variable">zipPath</span><span class="token punctuation">)</span>
    <span class="token variable">print</span><span class="token punctuation">(</span><span class="token string">"打包完成"</span><span class="token punctuation">)</span>
    <span class="token variable">print</span><span class="token punctuation">(</span><span class="token variable">datetime</span><span class="token punctuation">.</span><span class="token variable">datetime</span><span class="token punctuation">.</span><span class="token variable">utcnow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>执行完生成以下文件：<br> 在<code>/kaggle/working/data_path_save/1669192178/results</code>目录下存储了模型训练及测试时输出的数据；<br> <code>outpu.zip</code>为模型及评测结果的打包文件。<br> <img src="https://images2.imgbox.com/95/53/FLrEAA34_o.png" alt="在这里插入图片描述"><br> <code>/1669192178/results</code>中保存训练过程及测试过程的评测结果，其中<code>result_metric_1~5</code>为训练过程中的输出指标，<code>result_metrix_label</code>存储训练好的模型在测试数据及上的评测指标。<br> <img src="https://images2.imgbox.com/23/69/gqFNgxX3_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/6c/3f/2w6Z4vux_o.png" alt="在这里插入图片描述"></p> 
<p>，<br> 代码实现借鉴：<a href="https://blog.csdn.net/qq_41076797/article/details/99569285">BiLSTM+CRF完成命名实体识别</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e6964c3ddcb4ad7a4c85ee7b5dee0b55/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Error response from daemon: conflict: unable to delete feb5d9fea6a5 (must be forced) - image is bein</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/da292a94d23cf1797b4a84a385569cb6/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Arduino环境下在ESP32上使用SmartConfig</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>