<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【Hystrix技术指南】（7）故障切换的运作流程原理分析（含源码） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【Hystrix技术指南】（7）故障切换的运作流程原理分析（含源码）" />
<meta property="og:description" content="背景介绍 目前对于一些非核心操作，如增减库存后保存操作日志发送异步消息时（具体业务流程），一旦出现MQ服务异常时，会导致接口响应超时，因此可以考虑对非核心操作引入服务降级、服务隔离。
Hystrix说明 官方文档
Hystrix是Netflix开源的一个容灾框架，解决当外部依赖故障时拖垮业务系统、甚至引起雪崩的问题。
为什么需要Hystrix? 在大中型分布式系统中，通常系统很多依赖(HTTP,hession,Netty,Dubbo等)，在高并发访问下,这些依赖的稳定性与否对系统的影响非常大,但是依赖有很多不可控问题：如网络连接缓慢，资源繁忙，暂时不可用，服务脱机等。*当依赖阻塞时,大多数服务器的线程池就出现阻塞(BLOCK),影响整个线上服务的稳定性，在复杂的分布式架构的应用程序有很多的依赖，都会不可避免地在某些时候失败。高并发的依赖失败时如果没有隔离措施，当前应用服务就有被拖垮的风险。 例如:一个依赖30个SOA服务的系统,每个服务99.99 99.99 0.3 换算成时间大约每月有2个小时服务不稳定. 随着服务依赖数量的变多，服务不稳定的概率会成指数性提高. 解决问题方案：对依赖做隔离。 复制代码 Hystrix设计理念 想要知道如何使用，必须先明白其核心设计理念，Hystrix基于命令模式，通过UML图先直观的认识一下这一设计模式。
可见，Command是在 Receiver和 Invoker之间添加的中间层， Command实现了对Receiver的封装。API既可以是Invoker又可以是reciever，通过继承Hystrix核心类HystrixCommand来封装这些API（例如，远程接口调用，数据库查询之类可能会产生延时的操作）。*就可以为API提供弹性保护了。 Hystrix如何解决依赖隔离 Hystrix使用命令模式HystrixCommand(Command)包装依赖调用逻辑，每个命令在单独线程中/信号授权下执行。可配置依赖调用超时时间，超时时间一般设为比99.5%平均时间略高即可。当调用超时时，直接返回或执行fallback逻辑。为每个依赖提供一个小的线程池（或信号），如果线程池已满调用将被立即拒绝，默认不采用排队，加速失败判定时间。依赖调用结果分，成功，失败（抛出异常），超时，线程拒绝，短路。 请求失败(异常，拒绝，超时，短路)时执行fallback(降级)逻辑。提供熔断器组件，可以自动运行或手动调用，停止当前依赖一段时间(10秒)，熔断器默认错误率阈值为50%，超过将自动运行。提供近实时依赖的统计和监控 Hystrix流程结构解析 、
流程说明: 每次调用构建HystrixCommand或者HystrixObservableCommand对象，把依赖调用封装在run()方法中.结果是否有缓存如果没有执行execute()/queue做sync或async调用，对应真正的run()/construct()判断熔断器(circuit-breaker)是否打开，如果打开跳到步骤8，进行降级策略，如果关闭进入步骤.判断线程池/队列/信号量是否跑满，如果跑满进入降级步骤8，否则继续后续步骤.使用HystrixObservableCommand.construct()还是HystrixCommand.run()，运行依赖逻辑依赖逻辑调用超时，进入步骤8判断逻辑是否调用成功 6a 返回成功调用结果6b 调用出错，进入步骤8. 计算熔断器状态,所有的运行状态(成功, 失败, 拒绝,超时)上报给熔断器，用于统计从而判断熔断器状态.getFallback()降级逻辑. a. 没有实现getFallback的Command将直接抛出异常 b. fallback降级逻辑调用成功直接返回 c. 降级逻辑调用失败抛出异常返回执行成功结果 以下四种情况将触发getFallback调用：
run()方法抛出非HystrixBadRequestException异常。run()方法调用超时熔断器开启短路调用线程池/队列/信号量是否跑满 熔断器:Circuit Breaker 每个熔断器默认维护10个bucket，每秒一个bucket，每个bucket记录成功，失败,超时,拒绝的状态，默认错误超过50%且10秒内超过20个请求进行中断短路。
Hystrix隔离分析 Hystrix隔离方式采用线程/信号的方式,通过隔离限制依赖的并发量和阻塞扩散.
线程隔离 执行依赖代码的线程与请求线程(如:jetty线程)分离，请求线程可以自由控制离开的时间(异步过程)。通过线程池大小可以控制并发量，当线程池饱和时可以提前拒绝服务,防止依赖问题扩散。*线上建议线程池不要设置过大，否则大量堵塞线程有可能会拖慢服务器。 实际案例： Netflix公司内部认为线程隔离开销足够小，不会造成重大的成本或性能的影响。Netflix 内部API 每天100亿的HystrixCommand依赖请求使用线程隔，每个应用大约40多个线程池，每个线程池大约5-20个线程。
信号隔离 信号隔离也可以用于限制并发访问，防止阻塞扩散, 与线程隔离最大不同在于执行依赖代码的线程依然是请求线程（该线程需要通过信号申请）,如果客户端是可信的且可以快速返回，可以使用信号隔离替换线程隔离,降低开销。
信号量的大小可以动态调整, 线程池大小不可以。
线程隔离与信号隔离区别如下图:
fallback故障切换降级机制 有兴趣的小伙伴可以看看：官方参考文档
源码分析 hystrix-core-1.5.12-sources.jar!/com/netflix/hystrix/AbstractCommand.java
executeCommandAndObserve private Observable executeCommandAndObserve(final AbstractCommand _cmd) { final Func1&gt; handleFallback = new Func1&gt;() { public Observable call(Throwable t) { circuitBreaker." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/a71a24ee4e5f598a6cd323795a26ed0e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-11T12:48:51+08:00" />
<meta property="article:modified_time" content="2023-08-11T12:48:51+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【Hystrix技术指南】（7）故障切换的运作流程原理分析（含源码）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h4><a id="_3"></a>背景介绍</h4> 
<blockquote> 
 <p><strong>目前对于一些非核心操作，如增减库存后保存操作日志发送异步消息时（具体业务流程），一旦出现MQ服务异常时，会导致接口响应超时，因此可以考虑对非核心操作引入服务降级、服务隔离。</strong></p> 
</blockquote> 
<h4><a id="Hystrix_7"></a>Hystrix说明</h4> 
<p><a href="https://github.com/Netflix/Hystrix/wiki">官方文档</a></p> 
<blockquote> 
 <p><strong>Hystrix是Netflix开源的一个容灾框架，解决当外部依赖故障时拖垮业务系统、甚至引起雪崩的问题。</strong></p> 
</blockquote> 
<h5><a id="Hystrix_13"></a>为什么需要Hystrix?</h5> 
<ul><li><strong>在大中型分布式系统中，通常系统很多依赖(HTTP,hession,Netty,Dubbo等)，在高并发访问下,这些依赖的稳定性与否对系统的影响非常大,但是依赖有很多不可控问题：如网络连接缓慢，资源繁忙，暂时不可用，服务脱机等。</strong></li><li>*<em>当依赖阻塞时,大多数服务器的线程池就出现阻塞(BLOCK),影响整个线上服务的稳定性，在复杂的分布式架构的应用程序有很多的依赖，都会不可避免地在某些时候失败。高并发的依赖失败时如果没有隔离措施，当前应用服务就有被拖垮的风险。</em></li></ul> 
<pre><code class="prism language-erlang">例如<span class="token punctuation">:</span>一个依赖<span class="token number">30</span>个<span class="token variable">SOA</span>服务的系统<span class="token punctuation">,</span>每个服务<span class="token number">99.99</span>

<span class="token number">99.99</span>

<span class="token number">0.3</span>

换算成时间大约每月有<span class="token number">2</span>个小时服务不稳定<span class="token punctuation">.</span>

随着服务依赖数量的变多，服务不稳定的概率会成指数性提高<span class="token punctuation">.</span>

解决问题方案：对依赖做隔离。
复制代码
</code></pre> 
<h4><a id="Hystrix_33"></a>Hystrix设计理念</h4> 
<blockquote> 
 <p><strong>想要知道如何使用，必须先明白其核心设计理念，Hystrix基于命令模式，通过UML图先直观的认识一下这一设计模式</strong>。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/cd/94/Fze8bkdB_o.png" alt=""></p> 
<ul><li><strong>可见，Command</strong>是在 <strong>Receiver</strong>和 <strong>Invoker</strong>之间添加的中间层， <strong>Command实现了对Receiver的封装</strong>。</li><li><strong>API既可以是Invoker又可以是reciever，通过继承Hystrix核心类HystrixCommand来封装这些API（例如，远程接口调用，数据库查询之类可能会产生延时的操作）</strong>。</li><li>*<em>就可以为API提供弹性保护了。</em></li></ul> 
<h4><a id="Hystrix_43"></a>Hystrix如何解决依赖隔离</h4> 
<ol><li><strong>Hystrix使用命令模式HystrixCommand(Command)包装依赖调用逻辑，每个命令在单独线程中/信号授权下执行。</strong></li><li><strong>可配置依赖调用超时时间，超时时间一般设为比99.5%平均时间略高即可。当调用超时时，直接返回或执行fallback逻辑。</strong></li><li><strong>为每个依赖提供一个小的线程池（或信号），如果线程池已满调用将被立即拒绝，默认不采用排队，加速失败判定时间。</strong></li><li><strong>依赖调用结果分，成功，失败（抛出异常），超时，线程拒绝，短路。 请求失败(异常，拒绝，超时，短路)时执行fallback(降级)逻辑。</strong></li><li><strong>提供熔断器组件，可以自动运行或手动调用，停止当前依赖一段时间(10秒)，熔断器默认错误率阈值为50%，超过将自动运行</strong>。</li><li><strong>提供近实时依赖的统计和监控</strong></li></ol> 
<h4><a id="Hystrix_52"></a>Hystrix流程结构解析</h4> 
<p><img src="https://images2.imgbox.com/49/00/4IYDnnWI_o.png" alt="">、</p> 
<h5><a id="_56"></a>流程说明:</h5> 
<ol><li><strong>每次调用构建HystrixCommand或者HystrixObservableCommand对象，把依赖调用封装在run()方法中.</strong></li><li><strong>结果是否有缓存如果没有执行execute()/queue做sync或async调用，对应真正的run()/construct()</strong></li><li><strong>判断熔断器(circuit-breaker)是否打开，如果打开跳到步骤8，进行降级策略，如果关闭进入步骤.</strong></li><li><strong>判断线程池/队列/信号量是否跑满，如果跑满进入降级步骤8，否则继续后续步骤.</strong></li><li><strong>使用HystrixObservableCommand.construct()还是HystrixCommand.run()，运行依赖逻辑</strong></li><li><strong>依赖逻辑调用超时，进入步骤8</strong></li><li><strong>判断逻辑是否调用成功</strong></li></ol> 
<ul><li>6a <strong>返回成功调用结果</strong></li><li>6b <strong>调用出错，进入步骤8.</strong></li></ul> 
<ol start="8"><li><strong>计算熔断器状态,所有的运行状态(成功, 失败, 拒绝,超时)上报给熔断器，用于统计从而判断熔断器状态.</strong></li><li><strong>getFallback()降级逻辑</strong>. a. <strong>没有实现getFallback的Command将直接抛出异常</strong> b. <strong>fallback降级逻辑调用成功直接返回</strong> c. <strong>降级逻辑调用失败抛出异常</strong></li><li>返回执行成功结果</li></ol> 
<p>以下四种情况将触发getFallback调用：</p> 
<ol><li><strong>run()方法抛出非HystrixBadRequestException异常</strong>。</li><li><strong>run()方法调用超时</strong></li><li><strong>熔断器开启短路调用</strong></li><li><strong>线程池/队列/信号量是否跑满</strong></li></ol> 
<h5><a id="Circuit_Breaker_78"></a>熔断器:Circuit Breaker</h5> 
<blockquote> 
 <p><strong>每个熔断器默认维护10个bucket，每秒一个bucket，每个bucket记录成功，失败,超时,拒绝的状态，默认错误超过50%且10秒内超过20个请求进行中断短路。</strong></p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/80/51/bbcgUoVW_o.png" alt=""></p> 
<h4><a id="Hystrix_84"></a>Hystrix隔离分析</h4> 
<blockquote> 
 <p><strong>Hystrix隔离方式采用线程/信号的方式,通过隔离限制依赖的并发量和阻塞扩散.</strong></p> 
</blockquote> 
<h5><a id="_88"></a>线程隔离</h5> 
<ul><li><strong>执行依赖代码的线程与请求线程(如:jetty线程)分离，请求线程可以自由控制离开的时间(异步过程)。</strong></li><li><strong>通过线程池大小可以控制并发量，当线程池饱和时可以提前拒绝服务,防止依赖问题扩散。</strong></li><li>*<em>线上建议线程池不要设置过大，否则大量堵塞线程有可能会拖慢服务器。</em></li></ul> 
<h6><a id="_94"></a>实际案例：</h6> 
<blockquote> 
 <p><strong>Netflix公司内部认为线程隔离开销足够小，不会造成重大的成本或性能的影响。Netflix 内部API 每天100亿的HystrixCommand依赖请求使用线程隔，每个应用大约40多个线程池，每个线程池大约5-20个线程。</strong></p> 
</blockquote> 
<h5><a id="_98"></a>信号隔离</h5> 
<blockquote> 
 <p><strong>信号隔离也可以用于限制并发访问，防止阻塞扩散, 与线程隔离最大不同在于执行依赖代码的线程依然是请求线程（该线程需要通过信号申请）,如果客户端是可信的且可以快速返回，可以使用信号隔离替换线程隔离,降低开销。</strong></p> 
</blockquote> 
<blockquote> 
 <p><strong>信号量的大小可以动态调整, 线程池大小不可以。</strong></p> 
</blockquote> 
<p>线程隔离与信号隔离区别如下图:</p> 
<p><img src="https://images2.imgbox.com/18/8d/PK5ViKew_o.png" alt=""></p> 
<h4><a id="fallback_108"></a>fallback故障切换降级机制</h4> 
<p>有兴趣的小伙伴可以看看：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FNetflix%2FHystrix%2Fwiki%2FConfiguration%23fallback" rel="nofollow" title="https://github.com/Netflix/Hystrix/wiki/Configuration#fallback">官方参考文档</a></p> 
<h5><a id="_112"></a>源码分析</h5> 
<blockquote> 
 <p><strong>hystrix-core-1.5.12-sources.jar!/com/netflix/hystrix/AbstractCommand.java</strong></p> 
</blockquote> 
<h6><a id="executeCommandAndObserve_116"></a>executeCommandAndObserve</h6> 
<pre><code class="prism language-java">
    <span class="token keyword">private</span> <span class="token class-name">Observable</span> <span class="token function">executeCommandAndObserve</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">AbstractCommand</span> _cmd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">final</span> <span class="token class-name">Func1</span><span class="token operator">&gt;</span> handleFallback <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Func1</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

            <span class="token keyword">public</span> <span class="token class-name">Observable</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                circuitBreaker<span class="token punctuation">.</span><span class="token function">markNonSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Exception</span> e <span class="token operator">=</span> <span class="token function">getExceptionFromThrowable</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
                executionResult <span class="token operator">=</span> executionResult<span class="token punctuation">.</span><span class="token function">setExecutionException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">RejectedExecutionException</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> <span class="token function">handleThreadPoolRejectionViaFallback</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token keyword">instanceof</span> <span class="token class-name">HystrixTimeoutException</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> <span class="token function">handleTimeoutViaFallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token keyword">instanceof</span> <span class="token class-name">HystrixBadRequestException</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> <span class="token function">handleBadRequestByEmittingError</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">HystrixBadRequestException</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        eventNotifier<span class="token punctuation">.</span><span class="token function">markEvent</span><span class="token punctuation">(</span><span class="token class-name">HystrixEventType</span><span class="token punctuation">.</span><span class="token constant">BAD_REQUEST</span><span class="token punctuation">,</span> commandKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token class-name">Observable</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">return</span> <span class="token function">handleFailureViaFallback</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token class-name">Observable</span> execution<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">executionTimeoutEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            execution <span class="token operator">=</span> <span class="token function">executeCommandWithSpecifiedIsolation</span><span class="token punctuation">(</span>_cmd<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lift</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HystrixObservableTimeoutOperator</span><span class="token punctuation">(</span>_cmd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            execution <span class="token operator">=</span> <span class="token function">executeCommandWithSpecifiedIsolation</span><span class="token punctuation">(</span>_cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> execution<span class="token punctuation">.</span><span class="token function">doOnNext</span><span class="token punctuation">(</span>markEmits<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">doOnCompleted</span><span class="token punctuation">(</span>markOnCompleted<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">onErrorResumeNext</span><span class="token punctuation">(</span>handleFallback<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">doOnEach</span><span class="token punctuation">(</span>setRequestContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
复制代码
</code></pre> 
<p>使用Observable的onErrorResumeNext，里头调用了handleFallback，handleFallback中区分不同的异常来调用不同的fallback。</p> 
<ul><li><strong>RejectedExecutionException调用handleThreadPoolRejectionViaFallback</strong></li><li><strong>HystrixTimeoutException调用handleTimeoutViaFallback</strong></li><li>*<em>非HystrixBadRequestException的调用handleFailureViaFallback</em></li></ul> 
<h6><a id="applyHystrixSemantics_165"></a>applyHystrixSemantics</h6> 
<pre><code class="prism language-java">    <span class="token keyword">private</span> <span class="token class-name">Observable</span> <span class="token function">applyHystrixSemantics</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">AbstractCommand</span> _cmd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        executionHook<span class="token punctuation">.</span><span class="token function">onStart</span><span class="token punctuation">(</span>_cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>circuitBreaker<span class="token punctuation">.</span><span class="token function">attemptExecution</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token class-name">TryableSemaphore</span> executionSemaphore <span class="token operator">=</span> <span class="token function">getExecutionSemaphore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token class-name">AtomicBoolean</span> semaphoreHasBeenReleased <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicBoolean</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token class-name">Action0</span> singleSemaphoreRelease <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Action0</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>semaphoreHasBeenReleased<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        executionSemaphore<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token class-name">Action1</span> markExceptionThrown <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Action1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    eventNotifier<span class="token punctuation">.</span><span class="token function">markEvent</span><span class="token punctuation">(</span><span class="token class-name">HystrixEventType</span><span class="token punctuation">.</span><span class="token constant">EXCEPTION_THROWN</span><span class="token punctuation">,</span> commandKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>executionSemaphore<span class="token punctuation">.</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>

                    executionResult <span class="token operator">=</span> executionResult<span class="token punctuation">.</span><span class="token function">setInvocationStartTime</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token function">executeCommandAndObserve</span><span class="token punctuation">(</span>_cmd<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">doOnError</span><span class="token punctuation">(</span>markExceptionThrown<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">doOnTerminate</span><span class="token punctuation">(</span>singleSemaphoreRelease<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">doOnUnsubscribe</span><span class="token punctuation">(</span>singleSemaphoreRelease<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> <span class="token class-name">Observable</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token function">handleSemaphoreRejectionViaFallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">handleShortCircuitViaFallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
复制代码
</code></pre> 
<ul><li>applyHystrixSemantics方法针对executionSemaphore.tryAcquire()没通过的调用</li><li>handleSemaphoreRejectionViaFallback</li><li>applyHystrixSemantics方法针对circuitBreaker.attemptExecution()没通过的调用handleShortCircuitViaFallback()</li></ul> 
<h6><a id="ViaFallback_214"></a>ViaFallback方法</h6> 
<pre><code class="prism language-java">    <span class="token keyword">private</span> <span class="token class-name">Observable</span> <span class="token function">handleSemaphoreRejectionViaFallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Exception</span> semaphoreRejectionException <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"could not acquire a semaphore for execution"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        executionResult <span class="token operator">=</span> executionResult<span class="token punctuation">.</span><span class="token function">setExecutionException</span><span class="token punctuation">(</span>semaphoreRejectionException<span class="token punctuation">)</span><span class="token punctuation">;</span>
        eventNotifier<span class="token punctuation">.</span><span class="token function">markEvent</span><span class="token punctuation">(</span><span class="token class-name">HystrixEventType</span><span class="token punctuation">.</span><span class="token constant">SEMAPHORE_REJECTED</span><span class="token punctuation">,</span> commandKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"HystrixCommand Execution Rejection by Semaphore."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token function">getFallbackOrThrowException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token class-name">HystrixEventType</span><span class="token punctuation">.</span><span class="token constant">SEMAPHORE_REJECTED</span><span class="token punctuation">,</span> <span class="token class-name">FailureType</span><span class="token punctuation">.</span><span class="token constant">REJECTED_SEMAPHORE_EXECUTION</span><span class="token punctuation">,</span>
                <span class="token string">"could not acquire a semaphore for execution"</span><span class="token punctuation">,</span> semaphoreRejectionException<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">Observable</span> <span class="token function">handleShortCircuitViaFallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        eventNotifier<span class="token punctuation">.</span><span class="token function">markEvent</span><span class="token punctuation">(</span><span class="token class-name">HystrixEventType</span><span class="token punctuation">.</span><span class="token constant">SHORT_CIRCUITED</span><span class="token punctuation">,</span> commandKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Exception</span> shortCircuitException <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Hystrix circuit short-circuited and is OPEN"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        executionResult <span class="token operator">=</span> executionResult<span class="token punctuation">.</span><span class="token function">setExecutionException</span><span class="token punctuation">(</span>shortCircuitException<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">getFallbackOrThrowException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token class-name">HystrixEventType</span><span class="token punctuation">.</span><span class="token constant">SHORT_CIRCUITED</span><span class="token punctuation">,</span> <span class="token class-name">FailureType</span><span class="token punctuation">.</span><span class="token constant">SHORTCIRCUIT</span><span class="token punctuation">,</span>
                    <span class="token string">"short-circuited"</span><span class="token punctuation">,</span> shortCircuitException<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">Observable</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">Observable</span> <span class="token function">handleThreadPoolRejectionViaFallback</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> underlying<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        eventNotifier<span class="token punctuation">.</span><span class="token function">markEvent</span><span class="token punctuation">(</span><span class="token class-name">HystrixEventType</span><span class="token punctuation">.</span><span class="token constant">THREAD_POOL_REJECTED</span><span class="token punctuation">,</span> commandKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        threadPool<span class="token punctuation">.</span><span class="token function">markThreadRejection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token function">getFallbackOrThrowException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token class-name">HystrixEventType</span><span class="token punctuation">.</span><span class="token constant">THREAD_POOL_REJECTED</span><span class="token punctuation">,</span> <span class="token class-name">FailureType</span><span class="token punctuation">.</span><span class="token constant">REJECTED_THREAD_EXECUTION</span><span class="token punctuation">,</span> <span class="token string">"could not be queued for execution"</span><span class="token punctuation">,</span> underlying<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">Observable</span> <span class="token function">handleTimeoutViaFallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">getFallbackOrThrowException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token class-name">HystrixEventType</span><span class="token punctuation">.</span><span class="token constant">TIMEOUT</span><span class="token punctuation">,</span> <span class="token class-name">FailureType</span><span class="token punctuation">.</span><span class="token constant">TIMEOUT</span><span class="token punctuation">,</span> <span class="token string">"timed-out"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TimeoutException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">Observable</span> <span class="token function">handleFailureViaFallback</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> underlying<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Error executing HystrixCommand.run(). Proceeding to fallback logic ..."</span><span class="token punctuation">,</span> underlying<span class="token punctuation">)</span><span class="token punctuation">;</span>

        eventNotifier<span class="token punctuation">.</span><span class="token function">markEvent</span><span class="token punctuation">(</span><span class="token class-name">HystrixEventType</span><span class="token punctuation">.</span><span class="token constant">FAILURE</span><span class="token punctuation">,</span> commandKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

        executionResult <span class="token operator">=</span> executionResult<span class="token punctuation">.</span><span class="token function">setException</span><span class="token punctuation">(</span>underlying<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">getFallbackOrThrowException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token class-name">HystrixEventType</span><span class="token punctuation">.</span><span class="token constant">FAILURE</span><span class="token punctuation">,</span> <span class="token class-name">FailureType</span><span class="token punctuation">.</span><span class="token constant">COMMAND_EXCEPTION</span><span class="token punctuation">,</span> <span class="token string">"failed"</span><span class="token punctuation">,</span> underlying<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
复制代码
</code></pre> 
<ul><li>handleSemaphoreRejectionViaFallback、handleShortCircuitViaFallback、handleThreadPoolRejectionViaFallback、handleTimeoutViaFallback、handleFailureViaFallback这几个方法调用了getFallbackOrThrowException</li><li>其eventType分别是SEMAPHORE_REJECTED、SHORT_CIRCUITED、THREAD_POOL_REJECTED、TIMEOUT、FAILURE</li><li>AbstractCommand.getFallbackOrThrowException</li></ul> 
<blockquote> 
 <p>hystrix-core-1.5.12-sources.jar!/com/netflix/hystrix/AbstractCommand.java</p> 
</blockquote> 
<pre><code class="prism language-java">
    <span class="token keyword">private</span> <span class="token class-name">Observable</span> <span class="token function">getFallbackOrThrowException</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">AbstractCommand</span> _cmd<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">HystrixEventType</span> eventType<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">FailureType</span> failureType<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> message<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Exception</span> originalException<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token class-name">HystrixRequestContext</span> requestContext <span class="token operator">=</span> <span class="token class-name">HystrixRequestContext</span><span class="token punctuation">.</span><span class="token function">getContextForCurrentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> latency <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> executionResult<span class="token punctuation">.</span><span class="token function">getStartTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        executionResult <span class="token operator">=</span> executionResult<span class="token punctuation">.</span><span class="token function">addEvent</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> latency<span class="token punctuation">,</span> eventType<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUnrecoverable</span><span class="token punctuation">(</span>originalException<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Unrecoverable Error for HystrixCommand so will throw HystrixRuntimeException and not apply fallback. "</span><span class="token punctuation">,</span> originalException<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Exception</span> e <span class="token operator">=</span> <span class="token function">wrapWithOnErrorHook</span><span class="token punctuation">(</span>failureType<span class="token punctuation">,</span> originalException<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Observable</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HystrixRuntimeException</span><span class="token punctuation">(</span>failureType<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getLogMessagePrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> message <span class="token operator">+</span> <span class="token string">" and encountered unrecoverable error."</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRecoverableError</span><span class="token punctuation">(</span>originalException<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Recovered from java.lang.Error by serving Hystrix fallback"</span><span class="token punctuation">,</span> originalException<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">fallbackEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

                <span class="token keyword">final</span> <span class="token class-name">Action1super</span> <span class="token class-name">R</span><span class="token operator">&gt;&gt;</span> setRequestContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Action1super</span> <span class="token class-name">R</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token class-name">Notificationsuper</span> <span class="token class-name">R</span><span class="token operator">&gt;</span> rNotification<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token function">setRequestContextIfNeeded</span><span class="token punctuation">(</span>requestContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>

                <span class="token keyword">final</span> <span class="token class-name">Action1</span> markFallbackEmit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Action1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token class-name">R</span> r<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldOutputOnNextEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            executionResult <span class="token operator">=</span> executionResult<span class="token punctuation">.</span><span class="token function">addEvent</span><span class="token punctuation">(</span><span class="token class-name">HystrixEventType</span><span class="token punctuation">.</span><span class="token constant">FALLBACK_EMIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            eventNotifier<span class="token punctuation">.</span><span class="token function">markEvent</span><span class="token punctuation">(</span><span class="token class-name">HystrixEventType</span><span class="token punctuation">.</span><span class="token constant">FALLBACK_EMIT</span><span class="token punctuation">,</span> commandKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token class-name">Action0</span> markFallbackCompleted <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Action0</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">long</span> latency <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> executionResult<span class="token punctuation">.</span><span class="token function">getStartTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        eventNotifier<span class="token punctuation">.</span><span class="token function">markEvent</span><span class="token punctuation">(</span><span class="token class-name">HystrixEventType</span><span class="token punctuation">.</span><span class="token constant">FALLBACK_SUCCESS</span><span class="token punctuation">,</span> commandKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        executionResult <span class="token operator">=</span> executionResult<span class="token punctuation">.</span><span class="token function">addEvent</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> latency<span class="token punctuation">,</span>
						<span class="token class-name">HystrixEventType</span><span class="token punctuation">.</span><span class="token constant">FALLBACK_SUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token class-name">Func1</span><span class="token operator">&gt;</span> handleFallbackError <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Func1</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

                    <span class="token keyword">public</span> <span class="token class-name">Observable</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

                        <span class="token class-name">Exception</span> e <span class="token operator">=</span> <span class="token function">wrapWithOnErrorHook</span><span class="token punctuation">(</span>failureType<span class="token punctuation">,</span> originalException<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">Exception</span> fe <span class="token operator">=</span> <span class="token function">getExceptionFromThrowable</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token keyword">long</span> latency <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> executionResult<span class="token punctuation">.</span><span class="token function">getStartTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">Exception</span> toEmit<span class="token punctuation">;</span>

                        <span class="token keyword">if</span> <span class="token punctuation">(</span>fe <span class="token keyword">instanceof</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"No fallback for HystrixCommand. "</span><span class="token punctuation">,</span> fe<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            eventNotifier<span class="token punctuation">.</span><span class="token function">markEvent</span><span class="token punctuation">(</span><span class="token class-name">HystrixEventType</span><span class="token punctuation">.</span><span class="token constant">FALLBACK_MISSING</span><span class="token punctuation">,</span> commandKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            executionResult <span class="token operator">=</span> executionResult<span class="token punctuation">.</span><span class="token function">addEvent</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> latency<span class="token punctuation">,</span> <span class="token class-name">HystrixEventType</span><span class="token punctuation">.</span><span class="token constant">FALLBACK_MISSING</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                            toEmit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HystrixRuntimeException</span><span class="token punctuation">(</span>failureType<span class="token punctuation">,</span> _cmd<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getLogMessagePrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> message <span class="token operator">+</span> <span class="token string">" and no fallback available."</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> fe<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"HystrixCommand execution "</span> <span class="token operator">+</span> failureType<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" and fallback failed."</span><span class="token punctuation">,</span> fe<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            eventNotifier<span class="token punctuation">.</span><span class="token function">markEvent</span><span class="token punctuation">(</span><span class="token class-name">HystrixEventType</span><span class="token punctuation">.</span><span class="token constant">FALLBACK_FAILURE</span><span class="token punctuation">,</span> commandKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            executionResult <span class="token operator">=</span> executionResult<span class="token punctuation">.</span><span class="token function">addEvent</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> latency<span class="token punctuation">,</span> <span class="token class-name">HystrixEventType</span><span class="token punctuation">.</span><span class="token constant">FALLBACK_FAILURE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                            toEmit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HystrixRuntimeException</span><span class="token punctuation">(</span>failureType<span class="token punctuation">,</span> _cmd<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getLogMessagePrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> message <span class="token operator">+</span> <span class="token string">" and fallback failed."</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> fe<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldNotBeWrapped</span><span class="token punctuation">(</span>originalException<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">return</span> <span class="token class-name">Observable</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token keyword">return</span> <span class="token class-name">Observable</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>toEmit<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>

                <span class="token keyword">final</span> <span class="token class-name">TryableSemaphore</span> fallbackSemaphore <span class="token operator">=</span> <span class="token function">getFallbackSemaphore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token class-name">AtomicBoolean</span> semaphoreHasBeenReleased <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicBoolean</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token class-name">Action0</span> singleSemaphoreRelease <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Action0</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>semaphoreHasBeenReleased<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            fallbackSemaphore<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>

                <span class="token class-name">Observable</span> fallbackExecutionChain<span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>fallbackSemaphore<span class="token punctuation">.</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFallbackUserDefined</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            executionHook<span class="token punctuation">.</span><span class="token function">onFallbackStart</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            fallbackExecutionChain <span class="token operator">=</span> <span class="token function">getFallbackObservable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>

                            fallbackExecutionChain <span class="token operator">=</span> <span class="token function">getFallbackObservable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

                        fallbackExecutionChain <span class="token operator">=</span> <span class="token class-name">Observable</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">return</span> fallbackExecutionChain
                            <span class="token punctuation">.</span><span class="token function">doOnEach</span><span class="token punctuation">(</span>setRequestContext<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">lift</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FallbackHookApplication</span><span class="token punctuation">(</span>_cmd<span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">lift</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DeprecatedOnFallbackHookApplication</span><span class="token punctuation">(</span>_cmd<span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">doOnNext</span><span class="token punctuation">(</span>markFallbackEmit<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">doOnCompleted</span><span class="token punctuation">(</span>markFallbackCompleted<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">onErrorResumeNext</span><span class="token punctuation">(</span>handleFallbackError<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">doOnTerminate</span><span class="token punctuation">(</span>singleSemaphoreRelease<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">doOnUnsubscribe</span><span class="token punctuation">(</span>singleSemaphoreRelease<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                   <span class="token keyword">return</span> <span class="token function">handleFallbackRejectionByEmittingError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token function">handleFallbackDisabledByEmittingError</span><span class="token punctuation">(</span>originalException<span class="token punctuation">,</span> failureType<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
复制代码
</code></pre> 
<ul><li>fallbackExecutionChain的onErrorResumeNext，调用了handleFallbackError</li><li>fallbackExecutionChain的doOnCompleted，调用了markFallbackCompleted</li><li>AbstractCommand.getFallbackSemaphore</li></ul> 
<blockquote> 
 <p>hystrix-core-1.5.12-sources.jar!/com/netflix/hystrix/AbstractCommand.java</p> 
</blockquote> 
<pre><code class="prism language-java">
    <span class="token keyword">protected</span> <span class="token class-name">TryableSemaphore</span> <span class="token function">getFallbackSemaphore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fallbackSemaphoreOverride <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">TryableSemaphore</span> _s <span class="token operator">=</span> fallbackSemaphorePerCircuit<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>commandKey<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_s <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

                fallbackSemaphorePerCircuit<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>commandKey<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TryableSemaphoreActual</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">fallbackIsolationSemaphoreMaxConcurrentRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">return</span> fallbackSemaphorePerCircuit<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>commandKey<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> _s<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> fallbackSemaphoreOverride<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
复制代码
</code></pre> 
<blockquote> 
 <p>针对每个commandKey获取或创建TryableSemaphoreActual</p> 
</blockquote> 
<h6><a id="fallback_422"></a>fallback源码分析小结</h6> 
<p>hystrix的fallback主要分为5种类型：</p> 
<ul><li>SEMAPHORE_REJECTED对应handleSemaphoreRejectionViaFallback</li><li>SHORT_CIRCUITED对应handleShortCircuitViaFallback</li><li>THREAD_POOL_REJECTED对应handleThreadPoolRejectionViaFallback</li><li>TIMEOUT对应handleTimeoutViaFallback</li><li>FAILURE对应handleFailureViaFallback</li><li>这几个方法最后都调用了getFallbackOrThrowException方法。</li></ul> 
<h3><a id="center_font_color0000FFfont_432"></a> 
 <center> 
  <font color="#0000FF">分享资源</font> 
 </center></h3> 
<p><img src="https://images2.imgbox.com/4f/d1/J3cPypJm_o.png" alt="资源分享"><br> <a href="https://gitee.com/xiayi/java-docs" rel="nofollow">获取以上资源请访问开源项目 点击跳转</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4b660ba5334a60cf3187e9c02641429d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">视觉拖拽软件平台：使用C&#43;&#43;/opencv/MFC/自研算法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3dee09cb0b01db0100f01fd056574552/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">python按帧保存视频中的图片</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>