<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>tcp支持浏览器websocket协议 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="tcp支持浏览器websocket协议" />
<meta property="og:description" content="tcp支持浏览器websocket协议 一个io它是怎么一种情况，一个客户端连接一个服务器，一个客户端一个连接，大家时刻在做服务器，都是时刻抓住这样一个点，
就是说一个客户端在服务端会有一个网络io，一个客户端在服务端会有一个网络io，之前用epoll来管理这些io我们写了一个版本写了一个版本是怎么做的。
网络io到epoll的实现,epoll在实现的中间它有哪些问题以及如何去封装，然后再一层一层的跟大家实现的这个反应堆模式，就是以大量的网络io，然后每一个网络io它对应的事件会有对应的回调函数，
网络io对应的事件有对应的回调函数，
那这个网络io对应的事件是说的哪些事件？
就是所说的epollin/可读,epollout可写，
对应的回调函数怎么理解呢，就是epollin的时候我们调用recv_cb
然后epollout我们调send_cb，
当然还有与之对应的listen,我们可以调用accept_cb，封装完了之后，它的封装性更强，
它的封装性更强好吧，这是跟大家讲的reactor就这么一个模式，
在reactor的基础上面我们看看协议怎么做，基于websocket,就是因为协议很简单，它大体上的东西,核心的元素都会有
一个客户端对应一个连接，一个连接是怎么管理的呢就是通过epoll管理，一个连接我们对应的数据存储在哪呢？
服务器所生成的一个fd我们放到sockitem
如果客户端给服务器发数据，epoll检测到io可读，就会调用sockitem里面对应回调函数。
如果是收到数据那么有两种情况：一个io对应可读或者可写
读的数据发送的数据都放到buffer里面
接收
发送
那么分析这个代码的时候逻辑就会有很大的改变了
recv_cb里面我们接收到的数据我们该怎么去发送，比如回声服务器接收数据就返回什么数据的话我们该怎么做？
我们不需要去关注在什么时候调用send，我们只要关注一点这个sendbuffer里面有没有数据就ok了，只要关注这样一点就ok了，它会自动发送，
发送是怎么发送的呢？
两步就ok
我们现在根本就不用关注他的发送，只要把send_cb这一步做好了
libevent源码也是这样设计的有一个buffer，把数据放到里面就ok了，
我们只是做到了接收与发送，要是有协议呢？
接下来我们如何把websocket协议加进去？
首先第一步要考虑的是websocket的握手，
关于websocket握手是怎么一回事
websocket使用在哪？
为什么会有一个握手？
主要它是用来浏览器跟服务器做一个长链接，什么意思？我们打开CSDN有个登录，我们看到这边我们点击登录，现在这时候出来一个微信二维码，我们现在通过微信扫描二维码登录
那么这个功能与我们的websocket有什么关系？
前端页面，二维码是前端的，现在我们通过微信的那个微信的客户端，我们扫码扫一下这个二维码，扫完之后把对应的二维码，传到微信的服务器，然后微信的服务器，进行回调到csdn的服务器，然后前端扫码完之后为什么会有一个跳转？
就是这步，在csdn的服务器会主动推送一个数据，csdn的服务器，主动发数据给网页前端。
那在这一步是服务器主动发的，主动发的过程中间，就是采用了websocket协议
服务器主动发数据给浏览器的时候，可以选择websocket，但是websocket不是唯一的解决方案，
1.网页聊天，即时通讯
2.网页弹幕
3.股票
单独使用tcp没有那么好做，websocket是基于tcp，
了解websocket的使用场景后思考一下websocket是怎么建立的？
weisocket协议和客户端之间是怎么一种反思？
这个连接请大家注意，这个连接是在TCP建立后连接的基础上面，客户端和服务器已经有一个连接了，然后客户端给服务器发送一段应用数据，这个数据叫做握手数据，
相当于是这样一个客户端和服务器之间建立好的连接，现在这个客户端发送一段数据
首先发的第一步数据验证双方是否合法，这个数据叫做握手数据，
与http协议如此相似，
客户端先握手成功之后在服务器发送消息
握手过程
websocket协议由两部分组成一部分握手，另一部分通信。
就是在recv_cb里面我们怎么接收？我们怎么去区分他是握手数据还是通信数据？
需要引入一个状态机，
那么这个状态机的状态我们保存在哪里？每一个连接里面应该都有一个状态机
区分accept_cb和recv_cb
握手的状态怎么进入通信的状态？
刚刚讲了状态机，横向思考一下，其实HTTP协议也需要有一个状态机
在http协议接收的时候它也有握手，同样它有它的header还有它的body
header和body里面都有自己对应的资源，就是方便理解为什么nginx里面有一个状态机的实现？
实现recv_cb的时候我们不能通过具体的数据去判断它是不是头。
第一个状态处理完了之后去处理下一个状态，状态机就是这样。
websocket通信的时候它的协议头是什么样的？
如果以后自己基于TCP做协议的时候，可以看到有三个核心的点
1.操作码，fin是不是终止的包是不是数据包是不是握手包
2.包长度，分包粘包怎么解：可以选择包长度或者分隔符，这里websocket选择的就是包长度，
3.不想传输明文可以加一个mask–&gt;key 主要与payload做一个可逆的计算得出data
4.payload data数据是纯应用层的数据，就可以采用json/xml，" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/ed2e71bf362ffe8f75a318deea613455/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-11T10:11:53+08:00" />
<meta property="article:modified_time" content="2022-07-11T10:11:53+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">tcp支持浏览器websocket协议</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>tcp支持浏览器websocket协议</h4> 
</div> 
<p></p> 
<p>一个io它是怎么一种情况，一个客户端连接一个服务器，一个客户端一个连接，大家时刻在做服务器，都是时刻抓住这样一个点，<br> 就是说一个客户端在服务端会有一个网络io，一个客户端在服务端会有一个网络io，之前用epoll来管理这些io我们写了一个版本写了一个版本是怎么做的。<br> <img src="https://images2.imgbox.com/8c/4a/9P0ed37g_o.png" alt="在这里插入图片描述"></p> 
<p>网络io到epoll的实现,epoll在实现的中间它有哪些问题以及如何去封装，然后再一层一层的跟大家实现的这个反应堆模式，就是以大量的网络io，然后每一个网络io它对应的事件会有对应的回调函数，<br> 网络io对应的事件有对应的回调函数，</p> 
<p><strong>那这个网络io对应的事件是说的哪些事件？</strong><br> 就是所说的epollin/可读,epollout可写，<br> 对应的回调函数怎么理解呢，就是epollin的时候我们调用recv_cb<br> 然后epollout我们调send_cb，<br> 当然还有与之对应的listen,我们可以调用accept_cb，封装完了之后，它的封装性更强，<br> 它的封装性更强好吧，这是跟大家讲的reactor就这么一个模式，</p> 
<p>在reactor的基础上面我们看看协议怎么做，基于websocket,就是因为协议很简单，它大体上的东西,核心的元素都会有</p> 
<p>一个客户端对应一个连接，一个连接是怎么管理的呢就是通过epoll管理，一个连接我们对应的数据存储在哪呢？</p> 
<p>服务器所生成的一个fd我们放到sockitem<br> <img src="https://images2.imgbox.com/c5/1a/DeHNhG4O_o.png" alt="在这里插入图片描述"></p> 
<p>如果客户端给服务器发数据，epoll检测到io可读，就会调用sockitem里面对应回调函数。<br> <img src="https://images2.imgbox.com/a0/10/7hZH6nht_o.png" alt="在这里插入图片描述"><br> 如果是收到数据那么有两种情况：一个io对应可读或者可写<br> 读的数据发送的数据都放到buffer里面</p> 
<p><img src="https://images2.imgbox.com/3f/dc/HSp7lt6U_o.png" alt="在这里插入图片描述"><br> 接收<br> <img src="https://images2.imgbox.com/21/ef/97S2torR_o.png" alt="在这里插入图片描述"><br> 发送<br> <img src="https://images2.imgbox.com/6e/df/p5v3e9rc_o.png" alt="在这里插入图片描述"></p> 
<p>那么分析这个代码的时候逻辑就会有很大的改变了<br> <img src="https://images2.imgbox.com/53/49/Sw5LCSie_o.png" alt="在这里插入图片描述"></p> 
<p>recv_cb里面我们接收到的数据我们该怎么去发送，比如回声服务器接收数据就返回什么数据的话我们该怎么做？</p> 
<p>我们不需要去关注在什么时候调用send，我们只要关注一点这个sendbuffer里面有没有数据就ok了，只要关注这样一点就ok了，它会自动发送，<br> <img src="https://images2.imgbox.com/71/2e/7wFlANY0_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/8b/b7/FwATzqUF_o.png" alt="在这里插入图片描述"></p> 
<p>发送是怎么发送的呢？<br> 两步就ok<br> 我们现在根本就不用关注他的发送，只要把send_cb这一步做好了<br> <img src="https://images2.imgbox.com/e8/74/CZH72BhI_o.png" alt="在这里插入图片描述"><br> libevent源码也是这样设计的有一个buffer，把数据放到里面就ok了，</p> 
<p>我们只是做到了接收与发送，要是有协议呢？<br> <strong>接下来我们如何把websocket协议加进去？</strong></p> 
<p><img src="https://images2.imgbox.com/c7/1c/XFyMp7YG_o.png" alt="在这里插入图片描述"></p> 
<p>首先第一步要考虑的是websocket的握手，</p> 
<p>关于websocket握手是怎么一回事<br> <strong>websocket使用在哪？</strong><br> 为什么会有一个握手？</p> 
<p>主要它是用来浏览器跟服务器做一个长链接，什么意思？我们打开CSDN有个登录，我们看到这边我们点击登录，现在这时候出来一个微信二维码，我们现在通过微信扫描二维码登录</p> 
<p>那么这个功能与我们的websocket有什么关系？<br> 前端页面，二维码是前端的，现在我们通过微信的那个微信的客户端，我们扫码扫一下这个二维码，扫完之后把对应的二维码，传到微信的服务器，然后微信的服务器，进行回调到csdn的服务器，然后前端扫码完之后为什么会有一个跳转？<br> 就是这步，在csdn的服务器会主动推送一个数据，csdn的服务器，主动发数据给网页前端。<br> 那在这一步是服务器主动发的，主动发的过程中间，就是采用了websocket协议</p> 
<p>服务器主动发数据给浏览器的时候，可以选择websocket，但是websocket不是唯一的解决方案，<br> 1.网页聊天，即时通讯<br> 2.网页弹幕<br> 3.股票<br> 单独使用tcp没有那么好做，websocket是基于tcp，</p> 
<p><strong>了解websocket的使用场景后思考一下websocket是怎么建立的？</strong></p> 
<p>weisocket协议和客户端之间是怎么一种反思？<br> <img src="https://images2.imgbox.com/37/77/X434DjnL_o.png" alt="在这里插入图片描述"></p> 
<p>这个连接请大家注意，这个连接是在TCP建立后连接的基础上面，客户端和服务器已经有一个连接了，然后客户端给服务器发送一段应用数据，这个数据叫做握手数据，</p> 
<p>相当于是这样一个客户端和服务器之间建立好的连接，现在这个客户端发送一段数据<br> 首先发的第一步数据验证双方是否合法，这个数据叫做握手数据，</p> 
<p><img src="https://images2.imgbox.com/e9/a1/aj8ZViCa_o.png" alt="在这里插入图片描述"><br> 与http协议如此相似，<br> 客户端先握手成功之后在服务器发送消息<br> <strong>握手过程</strong><br> <img src="https://images2.imgbox.com/39/77/tARb2lvm_o.png" alt="在这里插入图片描述"></p> 
<p>websocket协议由两部分组成一部分握手，另一部分通信。</p> 
<p><strong>就是在recv_cb里面我们怎么接收？我们怎么去区分他是握手数据还是通信数据？</strong><br> 需要引入一个状态机，<br> <img src="https://images2.imgbox.com/75/96/5pTN9Oa7_o.png" alt="在这里插入图片描述"></p> 
<p>那么这个状态机的状态我们保存在哪里？每一个连接里面应该都有一个状态机<br> <img src="https://images2.imgbox.com/ce/aa/a0rW0lmO_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/c7/6c/7zpqkM01_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/83/7b/jIii2ghc_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/42/6f/sEukZv8Q_o.png" alt="在这里插入图片描述"><br> 区分accept_cb和recv_cb<br> <img src="https://images2.imgbox.com/6e/11/PaZH6JEa_o.png" alt="在这里插入图片描述"><br> 握手的状态怎么进入通信的状态？</p> 
<p>刚刚讲了状态机，横向思考一下，其实HTTP协议也需要有一个状态机<br> 在http协议接收的时候它也有握手，同样它有它的header还有它的body<br> header和body里面都有自己对应的资源，就是方便理解为什么nginx里面有一个状态机的实现？</p> 
<p>实现recv_cb的时候我们不能通过具体的数据去判断它是不是头。<br> 第一个状态处理完了之后去处理下一个状态，状态机就是这样。</p> 
<p>websocket通信的时候它的协议头是什么样的？<br> <img src="https://images2.imgbox.com/86/2d/ivxUKqXz_o.png" alt="在这里插入图片描述"><br> 如果以后自己基于TCP做协议的时候，可以看到有三个核心的点<br> 1.操作码，fin是不是终止的包是不是数据包是不是握手包<br> 2.包长度，分包粘包怎么解：可以选择包长度或者分隔符，这里websocket选择的就是包长度，<br> 3.不想传输明文可以加一个mask–&gt;key 主要与payload做一个可逆的计算得出data<br> 4.payload data数据是纯应用层的数据，就可以采用json/xml，</p> 
<p><img src="https://images2.imgbox.com/07/8b/ry8V1MWw_o.png" alt="在这里插入图片描述"><br> 长连接是客户端和服务器维持的一个连接，通过心跳包去维持，短连接就是一次请求不用管了，发送短信，长连接计算完需要回数据</p> 
<p>tcp的keepalive有这么几个特点，不要去代替应用层的心跳包<br> 1.一旦超时之后tcp会自动的去回收keepalive<br> 2.超时之后应用层得不到可控制的反馈，没办法去判断他超时我们该做什么策略性的东西</p> 
<pre><code class="prism language-cpp">

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/tcp.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;openssl/sha.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;openssl/pem.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;openssl/bio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;openssl/evp.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BUFFER_LENGTH</span>			<span class="token expression"><span class="token number">1024</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GUID</span> 					<span class="token string">"258EAFA5-E914-47DA-95CA-C5AB0DC85B11"</span></span>


<span class="token keyword">enum</span>  <span class="token class-name">WEBSOCKET_STATUS</span> <span class="token punctuation">{<!-- --></span>
	WS_HANDSHARK<span class="token punctuation">,</span>
	WS_DATATRANSFORM<span class="token punctuation">,</span>
	WS_DATAEND<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token keyword">struct</span> <span class="token class-name">sockitem</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//</span>
	<span class="token keyword">int</span> sockfd<span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>callback<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> events<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">char</span> recvbuffer<span class="token punctuation">[</span>BUFFER_LENGTH<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//</span>
	<span class="token keyword">char</span> sendbuffer<span class="token punctuation">[</span>BUFFER_LENGTH<span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token keyword">int</span> rlength<span class="token punctuation">;</span>
	<span class="token keyword">int</span> slength<span class="token punctuation">;</span>

	<span class="token keyword">int</span> status<span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// mainloop / eventloop --&gt; epoll --&gt;  </span>
<span class="token keyword">struct</span> <span class="token class-name">reactor</span> <span class="token punctuation">{<!-- --></span>

	<span class="token keyword">int</span> epfd<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> events<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	
	

<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token keyword">struct</span> <span class="token class-name">reactor</span> <span class="token operator">*</span>eventloop <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">recv_cb</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> events<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">send_cb</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> events<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">1</span>  </span><span class="token comment">// websocket</span></span>

<span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">decode_packet</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>stream<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>mask<span class="token punctuation">,</span> <span class="token keyword">int</span> length<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">encode_packet</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>buffer<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span>mask<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>stream<span class="token punctuation">,</span> <span class="token keyword">int</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">_nty_ophdr</span> <span class="token punctuation">{<!-- --></span>

	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> opcode<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">,</span>
		 rsv3<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
		 rsv2<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
		 rsv1<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
		 fin<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> payload_length<span class="token operator">:</span><span class="token number">7</span><span class="token punctuation">,</span>
		mask<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span> <span class="token function">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>packed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">_nty_websocket_head_126</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">short</span> payload_length<span class="token punctuation">;</span>
	<span class="token keyword">char</span> mask_key<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> data<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token function">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>packed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">_nty_websocket_head_127</span> <span class="token punctuation">{<!-- --></span>

	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> payload_length<span class="token punctuation">;</span>
	<span class="token keyword">char</span> mask_key<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> data<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	
<span class="token punctuation">}</span> <span class="token function">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>packed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_nty_websocket_head_127</span> nty_websocket_head_127<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_nty_websocket_head_126</span> nty_websocket_head_126<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_nty_ophdr</span> nty_ophdr<span class="token punctuation">;</span>


<span class="token keyword">int</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>in_str<span class="token punctuation">,</span> <span class="token keyword">int</span> in_len<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>out_str<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>    
	BIO <span class="token operator">*</span>b64<span class="token punctuation">,</span> <span class="token operator">*</span>bio<span class="token punctuation">;</span>    
	BUF_MEM <span class="token operator">*</span>bptr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    
	size_t size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    

	<span class="token keyword">if</span> <span class="token punctuation">(</span>in_str <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> out_str <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>        
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    

	b64 <span class="token operator">=</span> <span class="token function">BIO_new</span><span class="token punctuation">(</span><span class="token function">BIO_f_base64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
	bio <span class="token operator">=</span> <span class="token function">BIO_new</span><span class="token punctuation">(</span><span class="token function">BIO_s_mem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
	bio <span class="token operator">=</span> <span class="token function">BIO_push</span><span class="token punctuation">(</span>b64<span class="token punctuation">,</span> bio<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token function">BIO_write</span><span class="token punctuation">(</span>bio<span class="token punctuation">,</span> in_str<span class="token punctuation">,</span> in_len<span class="token punctuation">)</span><span class="token punctuation">;</span>    
	<span class="token function">BIO_flush</span><span class="token punctuation">(</span>bio<span class="token punctuation">)</span><span class="token punctuation">;</span>    

	<span class="token function">BIO_get_mem_ptr</span><span class="token punctuation">(</span>bio<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bptr<span class="token punctuation">)</span><span class="token punctuation">;</span>    
	<span class="token function">memcpy</span><span class="token punctuation">(</span>out_str<span class="token punctuation">,</span> bptr<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> bptr<span class="token operator">-&gt;</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>    
	out_str<span class="token punctuation">[</span>bptr<span class="token operator">-&gt;</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>    
	size <span class="token operator">=</span> bptr<span class="token operator">-&gt;</span>length<span class="token punctuation">;</span>    

	<span class="token function">BIO_free_all</span><span class="token punctuation">(</span>bio<span class="token punctuation">)</span><span class="token punctuation">;</span>    
	<span class="token keyword">return</span> size<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">int</span> <span class="token function">readline</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> allbuf<span class="token punctuation">,</span><span class="token keyword">int</span> level<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> linebuf<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>    
	<span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>allbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>    

	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span>level <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> <span class="token operator">++</span>level<span class="token punctuation">)</span>    <span class="token punctuation">{<!-- --></span>        
		<span class="token keyword">if</span><span class="token punctuation">(</span>allbuf<span class="token punctuation">[</span>level<span class="token punctuation">]</span><span class="token operator">==</span><span class="token char">'\r'</span> <span class="token operator">&amp;&amp;</span> allbuf<span class="token punctuation">[</span>level<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token char">'\n'</span><span class="token punctuation">)</span>            
			<span class="token keyword">return</span> level<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">;</span>        
		<span class="token keyword">else</span>            
			<span class="token operator">*</span><span class="token punctuation">(</span>linebuf<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">=</span> allbuf<span class="token punctuation">[</span>level<span class="token punctuation">]</span><span class="token punctuation">;</span>    
	<span class="token punctuation">}</span>    

	<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">handshark</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockitem</span> <span class="token operator">*</span>si<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">reactor</span> <span class="token operator">*</span>mainloop<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

	<span class="token keyword">char</span> linebuf<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> sec_accept<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
	<span class="token keyword">int</span> level <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> sha1_data<span class="token punctuation">[</span>SHA_DIGEST_LENGTH<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> head<span class="token punctuation">[</span>BUFFER_LENGTH<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  

	<span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>        
		<span class="token function">memset</span><span class="token punctuation">(</span>linebuf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>linebuf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        
		level <span class="token operator">=</span> <span class="token function">readline</span><span class="token punctuation">(</span>si<span class="token operator">-&gt;</span>recvbuffer<span class="token punctuation">,</span> level<span class="token punctuation">,</span> linebuf<span class="token punctuation">)</span><span class="token punctuation">;</span> 

		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>linebuf<span class="token punctuation">,</span><span class="token string">"Sec-WebSocket-Key"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>        <span class="token punctuation">{<!-- --></span>   
			
			<span class="token function">strcat</span><span class="token punctuation">(</span>linebuf<span class="token punctuation">,</span> GUID<span class="token punctuation">)</span><span class="token punctuation">;</span>    
			
			<span class="token function">SHA1</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>linebuf<span class="token operator">+</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>linebuf<span class="token operator">+</span><span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>sha1_data<span class="token punctuation">)</span><span class="token punctuation">;</span>  
			
			<span class="token function">base64_encode</span><span class="token punctuation">(</span>sha1_data<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>sha1_data<span class="token punctuation">)</span><span class="token punctuation">,</span>sec_accept<span class="token punctuation">)</span><span class="token punctuation">;</span>           
			<span class="token function">sprintf</span><span class="token punctuation">(</span>head<span class="token punctuation">,</span> <span class="token string">"HTTP/1.1 101 Switching Protocols\r\n"</span> \
				<span class="token string">"Upgrade: websocket\r\n"</span> \
				<span class="token string">"Connection: Upgrade\r\n"</span> \
				<span class="token string">"Sec-WebSocket-Accept: %s\r\n"</span> \
				<span class="token string">"\r\n"</span><span class="token punctuation">,</span> sec_accept<span class="token punctuation">)</span><span class="token punctuation">;</span>            

			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"response\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n\n\n"</span><span class="token punctuation">,</span> head<span class="token punctuation">)</span><span class="token punctuation">;</span>            
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">0</span></span></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">write</span><span class="token punctuation">(</span>cli_fd<span class="token punctuation">,</span> head<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>     <span class="token comment">//write ---&gt; send            </span>
				<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"write"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
			<span class="token function">memset</span><span class="token punctuation">(</span>si<span class="token operator">-&gt;</span>recvbuffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> BUFFER_LENGTH<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token function">memcpy</span><span class="token punctuation">(</span>si<span class="token operator">-&gt;</span>sendbuffer<span class="token punctuation">,</span> head<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// to send </span>
			si<span class="token operator">-&gt;</span>slength <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// to set epollout events</span>
			<span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> ev<span class="token punctuation">;</span>
			ev<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLOUT <span class="token operator">|</span> EPOLLET<span class="token punctuation">;</span>
			<span class="token comment">//ev.data.fd = clientfd;</span>
			si<span class="token operator">-&gt;</span>sockfd <span class="token operator">=</span> si<span class="token operator">-&gt;</span>sockfd<span class="token punctuation">;</span>
			si<span class="token operator">-&gt;</span>callback <span class="token operator">=</span> send_cb<span class="token punctuation">;</span>
			si<span class="token operator">-&gt;</span>status <span class="token operator">=</span> WS_DATATRANSFORM<span class="token punctuation">;</span>
			ev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr <span class="token operator">=</span> si<span class="token punctuation">;</span>

			<span class="token function">epoll_ctl</span><span class="token punctuation">(</span>mainloop<span class="token operator">-&gt;</span>epfd<span class="token punctuation">,</span> EPOLL_CTL_MOD<span class="token punctuation">,</span> si<span class="token operator">-&gt;</span>sockfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>        
		<span class="token punctuation">}</span>    

	<span class="token punctuation">}</span> <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>si<span class="token operator">-&gt;</span>recvbuffer<span class="token punctuation">[</span>level<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token char">'\r'</span> <span class="token operator">||</span> si<span class="token operator">-&gt;</span>recvbuffer<span class="token punctuation">[</span>level<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token char">'\n'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> level <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockitem</span> <span class="token operator">*</span>si<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">reactor</span> <span class="token operator">*</span>mainloop<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

	<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> mask<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token function">decode_packet</span><span class="token punctuation">(</span>si<span class="token operator">-&gt;</span>recvbuffer<span class="token punctuation">,</span> mask<span class="token punctuation">,</span> si<span class="token operator">-&gt;</span>rlength<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>


	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"data : %s , length : %d\n"</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>

	ret <span class="token operator">=</span> <span class="token function">encode_packet</span><span class="token punctuation">(</span>si<span class="token operator">-&gt;</span>sendbuffer<span class="token punctuation">,</span> mask<span class="token punctuation">,</span> data<span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
	si<span class="token operator">-&gt;</span>slength <span class="token operator">=</span> ret<span class="token punctuation">;</span>

	<span class="token function">memset</span><span class="token punctuation">(</span>si<span class="token operator">-&gt;</span>recvbuffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> BUFFER_LENGTH<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> ev<span class="token punctuation">;</span>
	ev<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLOUT <span class="token operator">|</span> EPOLLET<span class="token punctuation">;</span>
	<span class="token comment">//ev.data.fd = clientfd;</span>
	si<span class="token operator">-&gt;</span>sockfd <span class="token operator">=</span> si<span class="token operator">-&gt;</span>sockfd<span class="token punctuation">;</span>
	si<span class="token operator">-&gt;</span>callback <span class="token operator">=</span> send_cb<span class="token punctuation">;</span>
	si<span class="token operator">-&gt;</span>status <span class="token operator">=</span> WS_DATATRANSFORM<span class="token punctuation">;</span>
	ev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr <span class="token operator">=</span> si<span class="token punctuation">;</span>

	<span class="token function">epoll_ctl</span><span class="token punctuation">(</span>mainloop<span class="token operator">-&gt;</span>epfd<span class="token punctuation">,</span> EPOLL_CTL_MOD<span class="token punctuation">,</span> si<span class="token operator">-&gt;</span>sockfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">umask</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span><span class="token keyword">int</span> len<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span>mask<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>    
	<span class="token keyword">int</span> i<span class="token punctuation">;</span>    
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span>i <span class="token operator">++</span><span class="token punctuation">)</span>        
		<span class="token operator">*</span><span class="token punctuation">(</span>data<span class="token operator">+</span>i<span class="token punctuation">)</span> <span class="token operator">^=</span> <span class="token operator">*</span><span class="token punctuation">(</span>mask<span class="token operator">+</span><span class="token punctuation">(</span>i<span class="token operator">%</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">decode_packet</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>stream<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>mask<span class="token punctuation">,</span> <span class="token keyword">int</span> length<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

	nty_ophdr <span class="token operator">*</span>hdr <span class="token operator">=</span>  <span class="token punctuation">(</span>nty_ophdr<span class="token operator">*</span><span class="token punctuation">)</span>stream<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>data <span class="token operator">=</span> stream <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>nty_ophdr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> start <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token comment">//char mask[4] = {0};</span>
	<span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token comment">//if (hdr-&gt;fin == 1) return NULL;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>hdr<span class="token operator">-&gt;</span>mask <span class="token operator">&amp;</span> <span class="token number">0x7F</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">126</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

		nty_websocket_head_126 <span class="token operator">*</span>hdr126 <span class="token operator">=</span> <span class="token punctuation">(</span>nty_websocket_head_126<span class="token operator">*</span><span class="token punctuation">)</span>data<span class="token punctuation">;</span>
		size <span class="token operator">=</span> hdr126<span class="token operator">-&gt;</span>payload_length<span class="token punctuation">;</span>
		
		<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span>i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			mask<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> hdr126<span class="token operator">-&gt;</span>mask_key<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
		start <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
		
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>hdr<span class="token operator">-&gt;</span>mask <span class="token operator">&amp;</span> <span class="token number">0x7F</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">127</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

		nty_websocket_head_127 <span class="token operator">*</span>hdr127 <span class="token operator">=</span> <span class="token punctuation">(</span>nty_websocket_head_127<span class="token operator">*</span><span class="token punctuation">)</span>data<span class="token punctuation">;</span>
		size <span class="token operator">=</span> hdr127<span class="token operator">-&gt;</span>payload_length<span class="token punctuation">;</span>
		
		<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span>i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			mask<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> hdr127<span class="token operator">-&gt;</span>mask_key<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
		start <span class="token operator">=</span> <span class="token number">14</span><span class="token punctuation">;</span>

	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		size <span class="token operator">=</span> hdr<span class="token operator">-&gt;</span>payload_length<span class="token punctuation">;</span>

		<span class="token function">memcpy</span><span class="token punctuation">(</span>mask<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		start <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token operator">*</span>ret <span class="token operator">=</span> size<span class="token punctuation">;</span>
	<span class="token function">umask</span><span class="token punctuation">(</span>stream<span class="token operator">+</span>start<span class="token punctuation">,</span> size<span class="token punctuation">,</span> mask<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> stream <span class="token operator">+</span> start<span class="token punctuation">;</span>
	
<span class="token punctuation">}</span>


<span class="token keyword">int</span> <span class="token function">encode_packet</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>buffer<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span>mask<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>stream<span class="token punctuation">,</span> <span class="token keyword">int</span> length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

	nty_ophdr head <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	head<span class="token punctuation">.</span>fin <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	head<span class="token punctuation">.</span>opcode <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">&lt;</span> <span class="token number">126</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		head<span class="token punctuation">.</span>payload_length <span class="token operator">=</span> length<span class="token punctuation">;</span>
		<span class="token function">memcpy</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>head<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>nty_ophdr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		size <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">&lt;</span> <span class="token number">0xffff</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		nty_websocket_head_126 hdr <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
		hdr<span class="token punctuation">.</span>payload_length <span class="token operator">=</span> length<span class="token punctuation">;</span>
		<span class="token function">memcpy</span><span class="token punctuation">(</span>hdr<span class="token punctuation">.</span>mask_key<span class="token punctuation">,</span> mask<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token function">memcpy</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>head<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>nty_ophdr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">memcpy</span><span class="token punctuation">(</span>buffer<span class="token operator">+</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>nty_ophdr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>hdr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>nty_websocket_head_126<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>nty_websocket_head_126<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		
		nty_websocket_head_127 hdr <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
		hdr<span class="token punctuation">.</span>payload_length <span class="token operator">=</span> length<span class="token punctuation">;</span>
		<span class="token function">memcpy</span><span class="token punctuation">(</span>hdr<span class="token punctuation">.</span>mask_key<span class="token punctuation">,</span> mask<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token function">memcpy</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>head<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>nty_ophdr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">memcpy</span><span class="token punctuation">(</span>buffer<span class="token operator">+</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>nty_ophdr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>hdr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>nty_websocket_head_127<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>nty_websocket_head_127<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
	<span class="token punctuation">}</span>

	<span class="token function">memcpy</span><span class="token punctuation">(</span>buffer<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">,</span> stream<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> length <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> </span>



<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">set_nonblock</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> flags<span class="token punctuation">;</span>

	flags <span class="token operator">=</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_GETFL<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> flags<span class="token punctuation">;</span>
	flags <span class="token operator">|=</span> O_NONBLOCK<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> flags<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">int</span> <span class="token function">send_cb</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> events<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

	<span class="token keyword">struct</span> <span class="token class-name">sockitem</span> <span class="token operator">*</span>si <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockitem</span><span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>

	<span class="token function">send</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> si<span class="token operator">-&gt;</span>sendbuffer<span class="token punctuation">,</span> si<span class="token operator">-&gt;</span>slength<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//</span>

	<span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> ev<span class="token punctuation">;</span>
	ev<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN <span class="token operator">|</span> EPOLLET<span class="token punctuation">;</span>
	<span class="token comment">//ev.data.fd = clientfd;</span>
	si<span class="token operator">-&gt;</span>sockfd <span class="token operator">=</span> fd<span class="token punctuation">;</span>
	si<span class="token operator">-&gt;</span>callback <span class="token operator">=</span> recv_cb<span class="token punctuation">;</span>
	ev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr <span class="token operator">=</span> si<span class="token punctuation">;</span>
	
	<span class="token function">memset</span><span class="token punctuation">(</span>si<span class="token operator">-&gt;</span>sendbuffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> BUFFER_LENGTH<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">epoll_ctl</span><span class="token punctuation">(</span>eventloop<span class="token operator">-&gt;</span>epfd<span class="token punctuation">,</span> EPOLL_CTL_MOD<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token comment">//  ./epoll 8080</span>

<span class="token keyword">int</span> <span class="token function">recv_cb</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> events<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

	<span class="token comment">//int clientfd = events[i].data.fd;</span>
	<span class="token keyword">struct</span> <span class="token class-name">sockitem</span> <span class="token operator">*</span>si <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockitem</span><span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> ev<span class="token punctuation">;</span>

	<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> si<span class="token operator">-&gt;</span>recvbuffer<span class="token punctuation">,</span> BUFFER_LENGTH<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EAGAIN <span class="token operator">||</span> errno <span class="token operator">==</span> EWOULDBLOCK<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//</span>
			<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			
		<span class="token punctuation">}</span>

		ev<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN<span class="token punctuation">;</span>
		<span class="token comment">//ev.data.fd = fd;</span>
		<span class="token function">epoll_ctl</span><span class="token punctuation">(</span>eventloop<span class="token operator">-&gt;</span>epfd<span class="token punctuation">,</span> EPOLL_CTL_DEL<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">free</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span>
		

	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//</span>

		<span class="token comment">// </span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"disconnect %d\n"</span><span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
		ev<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN<span class="token punctuation">;</span>
		<span class="token comment">//ev.data.fd = fd;</span>
		<span class="token function">epoll_ctl</span><span class="token punctuation">(</span>eventloop<span class="token operator">-&gt;</span>epfd<span class="token punctuation">,</span> EPOLL_CTL_DEL<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">free</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>

		<span class="token comment">//printf("Recv: %s, %d Bytes\n", si-&gt;recvbuffer, ret);</span>
		si<span class="token operator">-&gt;</span>rlength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>si<span class="token operator">-&gt;</span>status <span class="token operator">==</span> WS_HANDSHARK<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"request\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> si<span class="token operator">-&gt;</span>recvbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>   

			<span class="token function">handshark</span><span class="token punctuation">(</span>si<span class="token punctuation">,</span> eventloop<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>si<span class="token operator">-&gt;</span>status <span class="token operator">==</span> WS_DATATRANSFORM<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">transform</span><span class="token punctuation">(</span>si<span class="token punctuation">,</span> eventloop<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>si<span class="token operator">-&gt;</span>status <span class="token operator">==</span> WS_DATAEND<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

		<span class="token punctuation">}</span>

	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>


<span class="token keyword">int</span> <span class="token function">accept_cb</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> events<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

	<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> client_addr<span class="token punctuation">;</span>
	<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>client_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	socklen_t client_len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>client_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">int</span> clientfd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>client_addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>client_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>clientfd <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

	<span class="token function">set_nonblock</span><span class="token punctuation">(</span>clientfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">char</span> str<span class="token punctuation">[</span>INET_ADDRSTRLEN<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv from %s at port %d\n"</span><span class="token punctuation">,</span> <span class="token function">inet_ntop</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> <span class="token operator">&amp;</span>client_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token function">ntohs</span><span class="token punctuation">(</span>client_addr<span class="token punctuation">.</span>sin_port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> ev<span class="token punctuation">;</span>
	ev<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN <span class="token operator">|</span> EPOLLET<span class="token punctuation">;</span>
	<span class="token comment">//ev.data.fd = clientfd;</span>

	<span class="token keyword">struct</span> <span class="token class-name">sockitem</span> <span class="token operator">*</span>si <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockitem</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockitem</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	si<span class="token operator">-&gt;</span>sockfd <span class="token operator">=</span> clientfd<span class="token punctuation">;</span>
	si<span class="token operator">-&gt;</span>callback <span class="token operator">=</span> recv_cb<span class="token punctuation">;</span>
	si<span class="token operator">-&gt;</span>status <span class="token operator">=</span> WS_HANDSHARK<span class="token punctuation">;</span>
	ev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr <span class="token operator">=</span> si<span class="token punctuation">;</span>
	
	<span class="token function">epoll_ctl</span><span class="token punctuation">(</span>eventloop<span class="token operator">-&gt;</span>epfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> clientfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">return</span> clientfd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	

	<span class="token keyword">int</span> sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>sockfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">set_nonblock</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> addr<span class="token punctuation">;</span>
	<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
	addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
	addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> INADDR_ANY<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">listen</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	eventloop <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">reactor</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">reactor</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// epoll opera</span>

	eventloop<span class="token operator">-&gt;</span>epfd <span class="token operator">=</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> ev<span class="token punctuation">;</span>
	ev<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN<span class="token punctuation">;</span>
	
	<span class="token keyword">struct</span> <span class="token class-name">sockitem</span> <span class="token operator">*</span>si <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockitem</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockitem</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	si<span class="token operator">-&gt;</span>sockfd <span class="token operator">=</span> sockfd<span class="token punctuation">;</span>
	si<span class="token operator">-&gt;</span>callback <span class="token operator">=</span> accept_cb<span class="token punctuation">;</span>
	ev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr <span class="token operator">=</span> si<span class="token punctuation">;</span>
	
	<span class="token function">epoll_ctl</span><span class="token punctuation">(</span>eventloop<span class="token operator">-&gt;</span>epfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> sockfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

		<span class="token keyword">int</span> nready <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>eventloop<span class="token operator">-&gt;</span>epfd<span class="token punctuation">,</span> eventloop<span class="token operator">-&gt;</span>events<span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>nready <span class="token operator">&lt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> nready<span class="token punctuation">;</span>i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>



			<span class="token keyword">if</span> <span class="token punctuation">(</span>eventloop<span class="token operator">-&gt;</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">//printf("sockitem\n");</span>
				<span class="token keyword">struct</span> <span class="token class-name">sockitem</span> <span class="token operator">*</span>si <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockitem</span><span class="token operator">*</span><span class="token punctuation">)</span>eventloop<span class="token operator">-&gt;</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">;</span>
				si<span class="token operator">-&gt;</span><span class="token function">callback</span><span class="token punctuation">(</span>si<span class="token operator">-&gt;</span>sockfd<span class="token punctuation">,</span> eventloop<span class="token operator">-&gt;</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events<span class="token punctuation">,</span> si<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span>eventloop<span class="token operator">-&gt;</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLOUT<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">struct</span> <span class="token class-name">sockitem</span> <span class="token operator">*</span>si <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockitem</span><span class="token operator">*</span><span class="token punctuation">)</span>eventloop<span class="token operator">-&gt;</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">;</span>
				si<span class="token operator">-&gt;</span><span class="token function">callback</span><span class="token punctuation">(</span>si<span class="token operator">-&gt;</span>sockfd<span class="token punctuation">,</span> eventloop<span class="token operator">-&gt;</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events<span class="token punctuation">,</span> si<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>





</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ce582520d89bd12e7accc503ff68c4c6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【校招VIP】java语言考点之线程池相关</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8b17e7ed6bf597ee4d29934ba94d2b77/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">黑马 Spring_day01</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>