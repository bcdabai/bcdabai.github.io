<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>tomcat session server集群配置 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="tomcat session server集群配置" />
<meta property="og:description" content="一，通过memcache 搭建tomcat session server 本实验基于centos 7.2
主要目的是通过memcache来保持会话
为了方便，本次实验总共需要四台服务器
centos 7.2: tomcat1.memcache1
centos 7.2: tomcat2,memcache2
centos 7.2: nginx
windows: client
架构图
配置nginx 1，先安装nginx
yum install nginx -y 2,配置nginx
vim /etc/nginx/nginx.conf vim /etc/nginx/conf.d/default.conf 3,检查配置文件并启动服务
nginx -t systemctl start nginx ss -ntl 配置tomcat 因为要实现会话保持，并且基于memcached，因此需要一些关于memcached 的jar包
1,在ser1 安装tomcat和memcached
yum install tomcat memcached -y 2,复制jar包到tomcat的lib下
3，配置tomcat的server.xml
&lt;Context path=&#34;/test&#34; docBase=&#34;test&#34; reloadable=&#34;true&#34;&gt; &lt;Manager className=&#34;de.javakaffee.web.msm.MemcachedBackupSessionManager&#34; memcachedNodes=&#34;n1:192.168.153.112:11211,n2:192.168.153.113:11211&#34; failoverNodes=&#34;n1&#34; requestUriIgnorePattern=&#34;.*\.(ico|png|gif|jpg|css|js)$&#34; transcoderFactoryClass=&#34;de.javakaffee.web.msm.serializer.javolution.JavolutionTranscoderFactory&#34; /&gt; &lt;/Context&gt; 将配置文件复制到另外一台服务器上
scp /etc/tomcat/server.xml 192.168.153.113:/etc/tomcat/ 4,创建测试页面
mkdir /usr/share/tomcat/webapps/test vim /usr/share/tomcat/webapps/test/test." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/2f54396b84b33af06253d6fd3b1e618a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-19T14:39:11+08:00" />
<meta property="article:modified_time" content="2022-08-19T14:39:11+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">tomcat session server集群配置</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>一，通过memcache 搭建tomcat session server</h2> 
<p></p> 
<p>本实验基于centos 7.2</p> 
<p>主要目的是通过memcache来保持会话</p> 
<p></p> 
<p>为了方便，本次实验总共需要四台服务器</p> 
<p>        centos 7.2:   tomcat1.memcache1</p> 
<p>        centos 7.2:   tomcat2,memcache2</p> 
<p><strong>        centos 7.2:   </strong>nginx</p> 
<p>        windows:      client</p> 
<blockquote> 
 <p>架构图</p> 
</blockquote> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/5d/52/WeHVDalw_o.png"></p> 
<p></p> 
<p></p> 
<h3>配置nginx</h3> 
<p></p> 
<blockquote> 
 <p>1，先安装nginx</p> 
</blockquote> 
<pre><code class="language-bash">yum install nginx -y</code></pre> 
<blockquote> 
 <p>2,配置nginx</p> 
</blockquote> 
<pre><code class="language-bash">vim /etc/nginx/nginx.conf</code></pre> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/4e/1d/JctIKR94_o.png"></p> 
<pre><code class="language-bash">vim /etc/nginx/conf.d/default.conf</code></pre> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/65/f4/37pQXm9d_o.png"></p> 
<blockquote> 
 <p>3,检查配置文件并启动服务</p> 
</blockquote> 
<pre><code class="language-bash">nginx -t
systemctl start nginx
ss -ntl</code></pre> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/8c/6c/cUeZwM6S_o.png"></p> 
<p></p> 
<h3>配置tomcat</h3> 
<p></p> 
<p>因为要实现会话保持，并且基于memcached，因此需要一些关于memcached 的jar包</p> 
<p></p> 
<blockquote> 
 <p>1,在ser1 安装tomcat和memcached</p> 
</blockquote> 
<pre><code class="language-bash">yum install tomcat memcached -y</code></pre> 
<blockquote> 
 <p>2,复制jar包到tomcat的lib下</p> 
</blockquote> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/fa/fb/hRJxp125_o.png"></p> 
<p></p> 
<blockquote> 
 <p>3，配置tomcat的server.xml</p> 
</blockquote> 
<pre><code class="language-bash"> &lt;Context path="/test" docBase="test" reloadable="true"&gt;
         &lt;Manager className="de.javakaffee.web.msm.MemcachedBackupSessionManager"
        memcachedNodes="n1:192.168.153.112:11211,n2:192.168.153.113:11211"
        failoverNodes="n1"
        requestUriIgnorePattern=".*\.(ico|png|gif|jpg|css|js)$"
        transcoderFactoryClass="de.javakaffee.web.msm.serializer.javolution.JavolutionTranscoderFactory"
        /&gt;
 &lt;/Context&gt;</code></pre> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/99/75/QpwDbHgR_o.png"></p> 
<p>将配置文件复制到另外一台服务器上</p> 
<p></p> 
<pre><code class="language-bash">scp /etc/tomcat/server.xml 192.168.153.113:/etc/tomcat/</code></pre> 
<blockquote> 
 <p>4,创建测试页面</p> 
</blockquote> 
<pre><code class="language-bash">mkdir /usr/share/tomcat/webapps/test</code></pre> 
<pre><code class="language-bash">vim /usr/share/tomcat/webapps/test/test.jsp

# 内容如下

&lt;%@ page language="java" %&gt;
&lt;html&gt;
    this istomcatA:  #在另外一台改为 thsi istomcatB
    &lt;% session.setAttribute("nineven.com","nineven.com"); %&gt;
    &lt;%=session.getId()  %&gt;
&lt;/html&gt;</code></pre> 
<blockquote> 
 <p>5,启动服务</p> 
</blockquote> 
<pre><code class="language-bash">systemctl start memcached
systemctl start tomcat
ss -ntl</code></pre> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/48/91/NqhPIW5z_o.png"></p> 
<p></p> 
<blockquote> 
 <p>6,测试:</p> 
</blockquote> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/49/c6/IUhP9FFC_o.png"></p> 
<h2><strong>二，Tomcat自带的会话保持集群配置 </strong></h2> 
<p></p> 
<p></p> 
<p>本实验环境均为centos7.2</p> 
<p>四台服务器</p> 
<p>        tomcat1  : 192.168.153.112</p> 
<p>        tomcat2  : 192.168.153.113</p> 
<p>        nginx   : 192.168.153.111</p> 
<p>        client</p> 
<p></p> 
<h3>nginx配置</h3> 
<blockquote> 
 <p>1，先安装nginx</p> 
</blockquote> 
<pre><code class="language-bash">yum install nginx -y</code></pre> 
<blockquote> 
 <p>2,配置nginx</p> 
</blockquote> 
<pre><code class="language-bash">vim /etc/nginx/nginx.conf</code></pre> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/70/a3/RUN2k8wh_o.png"></p> 
<pre><code class="language-bash">vim /etc/nginx/conf.d/default.conf</code></pre> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/01/c3/ksPYTagW_o.png"></p> 
<p></p> 
<blockquote> 
 <p>3,检查配置文件并启动服务</p> 
</blockquote> 
<pre><code class="language-bash">nginx -t
systemctl start nginx
ss -ntl</code></pre> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/c0/11/mTgRy7Rx_o.png"></p> 
<p></p> 
<h3>tomcat配置</h3> 
<p></p> 
<blockquote> 
 <p>1,先安装tomcat</p> 
</blockquote> 
<pre><code class="language-bash">yum install tomcat -y</code></pre> 
<p></p> 
<blockquote> 
 <p>2，配置server</p> 
</blockquote> 
<p>在&lt;Engine ...&gt; 标签下面一行加入如下代码</p> 
<pre><code class="language-bash">&lt;Cluster className="org.apache.catalina.ha.tcp.SimpleTcpCluster"
                 channelSendOptions="8"&gt;
          &lt;Manager className="org.apache.catalina.ha.session.DeltaManager"
                   expireSessionsOnShutdown="false"
                   notifyListenersOnReplication="true"/&gt;
          &lt;Channel className="org.apache.catalina.tribes.group.GroupChannel"&gt;
            &lt;Membership className="org.apache.catalina.tribes.membership.McastService"
                        address="228.0.0.4"
                        port="45564"
                        frequency="500"     #每隔500ms传递一下心跳信息，（请删除该注释，配置不支持）
                        dropTime="3000"/&gt;
            &lt;Receiver className="org.apache.catalina.tribes.transport.nio.NioReceiver"
                      address="192.168.153.112"     #该服务器的ip  （请删除该注释，配置不支持）
                      port="4000"
                      autoBind="100"
                      selectorTimeout="5000"
                      maxThreads="6"/&gt;
            &lt;Sender className="org.apache.catalina.tribes.transport.ReplicationTransmitter"&gt;
              &lt;Transport className="org.apache.catalina.tribes.transport.nio.PooledParallelSender"/&gt;
            &lt;/Sender&gt;
            &lt;Interceptor className="org.apache.catalina.tribes.group.interceptors.TcpFailureDetector"/&gt;
            &lt;Interceptor className="org.apache.catalina.tribes.group.interceptors.MessageDispatch15Interceptor"/&gt;
          &lt;/Channel&gt;
          &lt;Valve className="org.apache.catalina.ha.tcp.ReplicationValve"
                 filter=""/&gt;
          &lt;Valve className="org.apache.catalina.ha.session.JvmRouteBinderValve"/&gt;
          &lt;Deployer className="org.apache.catalina.ha.deploy.FarmWarDeployer"
                    tempDir="/tmp/war-temp/"
                    deployDir="/tmp/war-deploy/"
                    watchDir="/tmp/war-listen/"
                    watchEnabled="false"/&gt;
          &lt;ClusterListener className="org.apache.catalina.ha.session.JvmRouteSessionIDBinderListener"/&gt;
          &lt;ClusterListener className="org.apache.catalina.ha.session.ClusterSessionListener"/&gt;
 &lt;/Cluster&gt;</code></pre> 
<blockquote> 
 <p>3,编辑测试页面</p> 
</blockquote> 
<pre><code class="language-bash">mkdir /usr/share/tomcat/webapps/ROOT/WEB-INF -pv
cp /etc/tomcat/web.xml /usr/share/tomcat/webapps/ROOT/WEB-INF/</code></pre> 
<p>配置web.xml</p> 
<pre><code class="language-bash">vim /usr/share/tomcat/webapps/ROOT/WEB-INF/web.xml

&lt;distributable/&gt;</code></pre> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/3a/9c/esrNn2SW_o.png"></p> 
<pre><code class="language-bash">vim /usr/share/tomcat/webapps/ROOT/test.jsp

#内容如下
&lt;%@ page language="java" %&gt;
&lt;html&gt;
    this istomcatA:
    &lt;% session.setAttribute("nineven.com","nineven.com"); %&gt;
    &lt;%=session.getId()  %&gt;
&lt;/html&gt;</code></pre> 
<blockquote> 
 <p>4,启动服务</p> 
</blockquote> 
<pre><code class="language-bash">systemctl start tomcat</code></pre> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/9e/86/g5vM4UDR_o.png"></p> 
<blockquote> 
 <p>5，测试</p> 
</blockquote> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/1d/5f/KTozU1n0_o.png"></p> 
<p></p> 
<h2>三，附录:</h2> 
<p></p> 
<p>Simply add</p> 
<pre><code class="language-bash">&lt;Cluster className="org.apache.catalina.ha.tcp.SimpleTcpCluster"/&gt;</code></pre> 
<p>to your &lt;Engine&gt; or your &lt;Host&gt; element to enable clustering.</p> 
<p></p> 
<p>Using the above configuration will enable all-to-all session replication using the DeltaManager to replicate session deltas. By all-to-all we mean that the session gets replicated to all the other nodes in the cluster. This works great for smaller cluster but we don't recommend it for larger clusters(a lot of Tomcat nodes). Also when using the delta manager it will replicate to all nodes, even nodes that don't have the application deployed.</p> 
<p>To get around this problem, you'll want to use the BackupManager. This manager only replicates the session data to one backup node, and only to nodes that have the application deployed. Downside of the BackupManager: not quite as battle tested as the delta manager.</p> 
<p></p> 
<p>Here are some of the important default values:</p> 
<p></p> 
<p>Multicast address is 228.0.0.4</p> 
<p>Multicast port is 45564 (the port and the address together determine cluster membership.</p> 
<p>The IP broadcasted is<span style="background-color:#eaf4fc;"> </span><span style="background-color:#cbe0f1;">java.net.InetAddress.getLocalHost().getHostAddress() </span>(make sure you don't broadcast 127.0.0.1, this is a common error)</p> 
<p>The TCP port listening for replication messages is the first available server socket in range <span style="background-color:#cbe0f1;">4000-4100</span></p> 
<p>Listener is configured ClusterSessionListener</p> 
<p>Two interceptors are configured TcpFailureDetector and MessageDispatch15Interceptor</p> 
<p>The following is the default cluster configuration:</p> 
<pre><code class="language-bash">        &lt;Cluster className="org.apache.catalina.ha.tcp.SimpleTcpCluster"
                 channelSendOptions="8"&gt;
          &lt;Manager className="org.apache.catalina.ha.session.DeltaManager"
                   expireSessionsOnShutdown="false"
                   notifyListenersOnReplication="true"/&gt;
          &lt;Channel className="org.apache.catalina.tribes.group.GroupChannel"&gt;
            &lt;Membership className="org.apache.catalina.tribes.membership.McastService"
                        address="228.0.0.4"
                        port="45564"
                        frequency="500"     #每隔500ms传递一下心跳信息
                        dropTime="3000"/&gt;
            &lt;Receiver className="org.apache.catalina.tribes.transport.nio.NioReceiver"
                      address="auto"
                      port="4000"
                      autoBind="100"
                      selectorTimeout="5000"
                      maxThreads="6"/&gt;
            &lt;Sender className="org.apache.catalina.tribes.transport.ReplicationTransmitter"&gt;
              &lt;Transport className="org.apache.catalina.tribes.transport.nio.PooledParallelSender"/&gt;
            &lt;/Sender&gt;
            &lt;Interceptor className="org.apache.catalina.tribes.group.interceptors.TcpFailureDetector"/&gt;
            &lt;Interceptor className="org.apache.catalina.tribes.group.interceptors.MessageDispatch15Interceptor"/&gt;
          &lt;/Channel&gt;
          &lt;Valve className="org.apache.catalina.ha.tcp.ReplicationValve"
                 filter=""/&gt;
          &lt;Valve className="org.apache.catalina.ha.session.JvmRouteBinderValve"/&gt;
          &lt;Deployer className="org.apache.catalina.ha.deploy.FarmWarDeployer"
                    tempDir="/tmp/war-temp/"
                    deployDir="/tmp/war-deploy/"
                    watchDir="/tmp/war-listen/"
                    watchEnabled="false"/&gt;
          &lt;ClusterListener className="org.apache.catalina.ha.session.JvmRouteSessionIDBinderListener"/&gt;
          &lt;ClusterListener className="org.apache.catalina.ha.session.ClusterSessionListener"/&gt;
        &lt;/Cluster&gt;</code></pre> 
<p>Will cover this section in more detail later in this document.</p> 
<p></p> 
<p>ter Basics</p> 
<p>To run session replication in your Tomcat 7.0 container, the following steps should be completed:</p> 
<p></p> 
<p>All your session attributes must implement java.io.Serializable</p> 
<p>Uncomment the Cluster element in server.xml</p> 
<p>If you have defined custom cluster valves, make sure you have the ReplicationValve defined as well under the Cluster element in server.xml</p> 
<p>If your Tomcat instances are running on the same machine, make sure the Receiver.port attribute is unique for each instance, in most cases Tomcat is smart enough to resolve this on it's own by autodetecting available ports in the range 4000-4100</p> 
<p><span style="background-color:#cbe0f1;">Make sure your web.xml has the &lt;distributable/&gt; element</span></p> 
<p>If you are using mod_jk, make sure that jvmRoute attribute is set at your Engine <span style="background-color:#cbe0f1;">&lt;Engine name="Catalina" jvmRoute="node01" &gt;</span> and that the jvmRoute attribute value matches your worker name in workers.properties</p> 
<p>Make sure that all nodes have the same time and sync with NTP service!</p> 
<p>Make sure that your loadbalancer is configured for sticky session mode.</p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/80ba8c0eb07e70431d069e4a3bc9509f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">人工智能笔记</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c225917067ad537643cfe1fa495a4a82/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">go配置文件热加载</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>