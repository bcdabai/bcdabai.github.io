<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>mysql高级篇-docker mysql主从 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="mysql高级篇-docker mysql主从" />
<meta property="og:description" content="mysql高级篇-docker mysql主从搭建
一、docker环境准备
1、VM安装centos-7 安装详情见https://blog.csdn.net/chaojiangroke/article/details/108660782
2、安装centos-7版docker 安装详细见https://blog.csdn.net/chaojiangroke/article/details/108666791
3、为mysql主从自定义网段 docker network create --subnet=172.18.0.0/16 net-mysql
二、mysql主从（一主一从）
1、下载redis镜像 docker pull mysql:version
2、查看镜像 docker images
3、创建mysql的映射目录 进入要创建映射目录的位置
cd /home/docker
创建主数据库的映射主目录
mkdir mysql-master
进入主数据库的映射主目录
cd mysql-master
创建主数据库的配置文件映射目录
mkdir conf
将准备好的配置文件mysql.cnf docker.cnf mysqldump.cnf拷贝到该目录下
文件保存在网盘
链接：https://pan.baidu.com/s/1g47PAUB-sSf09QkctyTY7w 提取码：aaaa 在docker.cnf目录下添加以下配置
## 设置server_id,注意要唯一
server-id=1
## 开启二进制日志功能，以备Slave作为其它Slave的Master时使用
log-bin=mysql-bin
进入要创建映射目录的位置
cd /home/docker
创建从数据库的映射主目录
mkdir mysql-slave
进入从数据库的映射主目录
cd mysql- slave
创建主数据库的配置文件映射目录
mkdir conf
将准备好的配置文件mysql.cnf docker.cnf mysqldump.cnf拷贝到该目录下
文件保存在网盘
链接：https://pan.baidu.com/s/1g47PAUB-sSf09QkctyTY7w 提取码：aaaa 在docker.cnf目录下添加以下配置
## 设置server_id,注意要唯一" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/056dec0843adec8308de5327ff67ae2a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-10-09T17:10:16+08:00" />
<meta property="article:modified_time" content="2020-10-09T17:10:16+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">mysql高级篇-docker mysql主从</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p style="margin-left:0cm;"><strong>mysql高级篇-docker mysql主从搭建</strong></p> 
<p style="margin-left:0cm;"><strong>一、docker环境准备</strong></p> 
<h3 style="margin-left:0cm;">1、VM安装centos-7</h3> 
<p style="margin-left:0cm;">安装详情见<a href="https://blog.csdn.net/chaojiangroke/article/details/108660782">https://blog.csdn.net/chaojiangroke/article/details/108660782</a></p> 
<p style="margin-left:0cm;"> </p> 
<h3 style="margin-left:0cm;">2、安装centos-7版docker</h3> 
<p style="margin-left:0cm;">安装详细见<a href="https://blog.csdn.net/chaojiangroke/article/details/108666791">https://blog.csdn.net/chaojiangroke/article/details/108666791</a></p> 
<p style="margin-left:0cm;"> </p> 
<h3 style="margin-left:0cm;">3、为mysql主从自定义网段</h3> 
<p style="margin-left:0cm;">docker network create --subnet=172.18.0.0/16 net-mysql</p> 
<p style="margin-left:0cm;"><strong>二、mysql主从（一主一从）</strong></p> 
<h3 style="margin-left:0cm;">1、下载redis镜像</h3> 
<p style="margin-left:0cm;">docker pull mysql:version</p> 
<p style="margin-left:0cm;"> </p> 
<h3 style="margin-left:0cm;">2、查看镜像</h3> 
<p style="margin-left:0cm;">docker images</p> 
<p style="margin-left:0cm;"> </p> 
<h3 style="margin-left:0cm;">3、创建mysql的映射目录</h3> 
<p style="margin-left:0cm;">进入要创建映射目录的位置</p> 
<p style="margin-left:0cm;">cd /home/docker</p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">创建主数据库的映射主目录</p> 
<p style="margin-left:0cm;">mkdir mysql-master</p> 
<p style="margin-left:0cm;">进入主数据库的映射主目录</p> 
<p style="margin-left:0cm;">cd mysql-master</p> 
<p style="margin-left:0cm;">创建主数据库的配置文件映射目录</p> 
<p style="margin-left:0cm;">mkdir conf</p> 
<p style="margin-left:0cm;">将准备好的配置文件mysql.cnf  docker.cnf  mysqldump.cnf拷贝到该目录下</p> 
<p style="margin-left:0cm;">文件保存在网盘</p> 
<p style="margin-left:0cm;">链接：https://pan.baidu.com/s/1g47PAUB-sSf09QkctyTY7w <br> 提取码：aaaa </p> 
<p style="margin-left:0cm;">在docker.cnf目录下添加以下配置</p> 
<p style="margin-left:0cm;">## 设置server_id,注意要唯一</p> 
<p style="margin-left:0cm;">server-id=1</p> 
<p style="margin-left:0cm;">## 开启二进制日志功能，以备Slave作为其它Slave的Master时使用</p> 
<p style="margin-left:0cm;">log-bin=mysql-bin</p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">进入要创建映射目录的位置</p> 
<p style="margin-left:0cm;">cd /home/docker</p> 
<p style="margin-left:0cm;">创建从数据库的映射主目录</p> 
<p style="margin-left:0cm;">mkdir mysql-slave</p> 
<p style="margin-left:0cm;">进入从数据库的映射主目录</p> 
<p style="margin-left:0cm;">cd mysql- slave</p> 
<p style="margin-left:0cm;">创建主数据库的配置文件映射目录</p> 
<p style="margin-left:0cm;">mkdir conf</p> 
<p style="margin-left:0cm;">将准备好的配置文件mysql.cnf  docker.cnf  mysqldump.cnf拷贝到该目录下</p> 
<p style="margin-left:0cm;">文件保存在网盘</p> 
<p style="margin-left:0cm;">链接：https://pan.baidu.com/s/1g47PAUB-sSf09QkctyTY7w <br> 提取码：aaaa </p> 
<p style="margin-left:0cm;">在docker.cnf目录下添加以下配置</p> 
<p style="margin-left:0cm;">## 设置server_id,注意要唯一</p> 
<p style="margin-left:0cm;">server-id=2</p> 
<p style="margin-left:0cm;">## 开启二进制日志功能，以备Slave作为其它Slave的Master时使用</p> 
<p style="margin-left:0cm;">log-bin=mysql-bin  </p> 
<p style="margin-left:0cm;">## relay_log配置中继日志</p> 
<p style="margin-left:0cm;">relay_log=edu-mysql-relay-bin</p> 
<p style="margin-left:0cm;"> </p> 
<h3 style="margin-left:0cm;">4、运行mysql镜像生成相应的容器</h3> 
<p style="margin-left:0cm;"><span style="color:#008800;">主服务器：</span></p> 
<p style="margin-left:0cm;"><span style="color:#008800;">docker run -p 3307:3306 --name mysql-master --restart=always -v /home/docker/mysql-master/conf:/etc/mysql/conf.d -v /home/docker/mysql- master/logs:/logs -v /home/docker/mysql-master/data:/var/lib/mysql -v /etc/localtime:/etc/localtime:ro -e MYSQL_ROOT_PASSWORD=123456 –net net-mysql –ip 172.17.0.2 -d mysql:latest --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci --lower_case_table_names=1</span></p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;"><span style="color:#008800;">从服务器：</span></p> 
<p style="margin-left:0cm;"><span style="color:#008800;">docker run -p 3308:3306 --name mysql-slave --restart=always -v /home/docker/mysql-slave/conf:/etc/mysql/conf.d -v /home/docker/mysql- slave/logs:/logs -v /home/docker/mysql-slave/data:/var/lib/mysql -v /etc/localtime:/etc/localtime:ro -e MYSQL_ROOT_PASSWORD=123456 –net net-mysql –ip 172.17.0.2 -d mysql:latest --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci --lower_case_table_names=1</span></p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">启动后进入master</p> 
<p style="margin-left:0cm;">查看主从信息</p> 
<p style="margin-left:0cm;">#进入容器</p> 
<p style="margin-left:0cm;">mysql&gt; [root@localhost ~]# docker exec -ti mysql-master /bin/bash</p> 
<p style="margin-left:0cm;">root@30d5b22e4f60:/# mysql -uroot -p123456</p> 
<p style="margin-left:0cm;">mysql&gt; show master status;</p> 
<p style="margin-left:0cm;">+------------------+----------+--------------+------------------+-------------------+</p> 
<p style="margin-left:0cm;">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</p> 
<p style="margin-left:0cm;">+------------------+----------+--------------+------------------+-------------------+</p> 
<p style="margin-left:0cm;">| mysql-bin.000003 |      156 |              |                  |                   |</p> 
<p style="margin-left:0cm;">+------------------+----------+--------------+------------------+-------------------+</p> 
<p style="margin-left:0cm;">1 row in set (0.00 sec)</p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">File和Position字段的值后面将会用到，在后面的操作完成之前，需要保证Master库不能做任何操作，否则将会引起状态变化，File和Position字段的值变化。</p> 
<p style="margin-left:0cm;">在Slave 中进入 mysql，执行change master to master_host='172.17.0.2', master_user='slave', master_password='123456', master_port=3306, master_log_file='mysql-bin.000001', master_log_pos= 2830, master_connect_retry=30;</p> 
<p style="margin-left:0cm;"><strong>命令说明：</strong></p> 
<p style="margin-left:0cm;"><strong>master_host</strong> ：Master的地址，指的是容器的独立ip,可以通过docker inspect --format='{<!-- -->{.NetworkSettings.IPAddress}}' 容器名称|容器id查询容器的ip</p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;"><strong>master_port</strong>：Master的端口号，指的是容器的端口号</p> 
<p style="margin-left:0cm;"><strong>master_user</strong>：用于数据同步的用户</p> 
<p style="margin-left:0cm;"><strong>master_password</strong>：用于同步的用户的密码</p> 
<p style="margin-left:0cm;"><strong>master_log_file</strong>：指定 Slave 从哪个日志文件开始复制数据，即上文中提到的 File 字段的值</p> 
<p style="margin-left:0cm;"><strong>master_log_pos</strong>：从哪个 Position 开始读，即上文中提到的 Position 字段的值</p> 
<p style="margin-left:0cm;"><strong>master_connect_retry</strong>：如果连接失败，重试的时间间隔，单位是秒，默认是60秒</p> 
<p style="margin-left:0cm;">在Slave 中的mysql终端执行show slave status \G;用于查看主从同步状态。</p> 
<p style="margin-left:0cm;"><img alt="" height="802" src="https://images2.imgbox.com/05/80/Llct3fSj_o.png" width="554"></p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">正常情况下，SlaveIORunning 和 SlaveSQLRunning 都是No，因为我们还没有开启主从复制过程。使用start slave开启主从复制过程，然后再次查询主从同步状态show slave status \G;。</p> 
<p style="margin-left:0cm;"><img alt="" height="816" src="https://images2.imgbox.com/0b/5c/RIPG58Vx_o.png" width="554"></p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">SlaveIORunning 和 SlaveSQLRunning 都是Yes，说明主从复制已经开启。此时可以测试数据同步是否成功。</p> 
<p style="margin-left:0cm;"><strong>主从复制排错：</strong></p> 
<p style="margin-left:0cm;">使用start slave开启主从复制过程后，如果SlaveIORunning一直是Connecting，则说明主从复制一直处于连接状态，这种情况一般是下面几种原因造成的，我们可以根据 Last_IO_Error提示予以排除。</p> 
<ol><li>网络不通</li></ol> 
<p style="margin-left:0cm;">检查ip,端口</p> 
<ol><li>密码不对</li></ol> 
<p style="margin-left:0cm;">检查是否创建用于同步的用户和用户密码是否正确</p> 
<ol><li>pos不对</li></ol> 
<p style="margin-left:0cm;">检查Master的 Position</p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">本次我遇到的错误</p> 
<p style="margin-left:0cm;"><img alt="" height="323" src="https://images2.imgbox.com/59/98/HUWoFeRn_o.png" width="554"></p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">我用了宿主机的映射端口，应该内网环境下用实际主数据库的端口3306</p> 
<p style="margin-left:0cm;"><img alt="" height="126" src="https://images2.imgbox.com/ea/a8/YtJSdxdZ_o.png" width="554"></p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">这个错误事版本涉及到的权限问题，处理方法如下</p> 
<ol><li>// 修改加密规则</li><li>ALTER USER 'root'@'localhost' IDENTIFIED BY 'password' PASSWORD EXPIRE NEVER;</li><li>// 更新一下用户的密码</li><li>ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'password';</li><li>// 刷新权限</li><li>FLUSH PRIVILEGES;</li><li>// 最后重置下密码：</li><li>alter user 'root'@'localhost' identified by '123456';</li></ol> 
<p style="margin-left:0cm;"> </p> 
<p> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2b766a5797f37bd9f5c73c227c7b42cc/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">COIL 100数据集</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/cfcdeb618a3cd1dd83543fe67192b5f5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">gitHub资源快速访问方法--jsDeliver</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>