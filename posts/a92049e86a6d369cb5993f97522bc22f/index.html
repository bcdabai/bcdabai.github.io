<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Docker（黑马spring cloud笔记） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Docker（黑马spring cloud笔记）" />
<meta property="og:description" content="Docker 目录 Docker一、介绍和安装1. 安装2. 启动3. 镜像加速 二、Docker基本操作1. 镜像操作2. 容器操作3. 数据卷操作 三、Dockerfile1. 镜像结构2. Dockerfile 四、Docker-Compose1. 安装2. 基本命令 五、Docker私服搭建六、练习练习1：save和load练习2：docker部署nginx问题：修改主页 练习3：部署MySQL练习4：基于Ubuntu构建一个新镜像，运行一个java项目问题 层数太多，每次都要安装jdk 练习5：部署微服务集群问题：微服务注册失败 一、介绍和安装 Docker 是一个开源的应用容器引擎，基于 Go 语言 并遵从 Apache2.0 协议开源。
Docker 可以让开发者打包他们的应用以及依赖包到一个轻量级、可移植的容器中，然后发布到任何流行的 Linux 机器上，也可以实现虚拟化。
容器是完全使用沙箱机制，相互之间不会有任何接口（类似 iPhone 的 app）,更重要的是容器性能开销极低。
几个概念：
镜像（image）：Docker将应用程序及其所需要的依赖、函数库等打包在一起，即为镜像。容器：镜像中的应用程序运行后形成的进程。Docker Registry：镜像托管平台，如DockerHub，网易云镜像服务，阿里云镜像服务。 docker架构：
1. 安装 可以先选择卸载：
yum remove docker \ docker-client \ docker-client-latest \ docker-common \ docker-latest \ docker-latest-logrotate \ docker-logrotate \ docker-selinux \ docker-engine-selinux \ docker-engine \ docker-ce 安装存储驱动等：
yum install -y yum-utils \ device-mapper-persistent-data \ lvm2 --skip-broken 设置docker仓库：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/a92049e86a6d369cb5993f97522bc22f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-01-16T17:56:29+08:00" />
<meta property="article:modified_time" content="2023-01-16T17:56:29+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Docker（黑马spring cloud笔记）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Docker_0"></a>Docker</h2> 
<p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#Docker_0" rel="nofollow">Docker</a></li><li><ul><li><a href="#_2" rel="nofollow">一、介绍和安装</a></li><li><ul><li><a href="#1__21" rel="nofollow">1. 安装</a></li><li><a href="#2__68" rel="nofollow">2. 启动</a></li><li><a href="#3__87" rel="nofollow">3. 镜像加速</a></li></ul> 
   </li><li><a href="#Docker_91" rel="nofollow">二、Docker基本操作</a></li><li><ul><li><a href="#1__93" rel="nofollow">1. 镜像操作</a></li><li><a href="#2__121" rel="nofollow">2. 容器操作</a></li><li><a href="#3__142" rel="nofollow">3. 数据卷操作</a></li></ul> 
   </li><li><a href="#Dockerfile_161" rel="nofollow">三、Dockerfile</a></li><li><ul><li><a href="#1__165" rel="nofollow">1. 镜像结构</a></li><li><a href="#2_Dockerfile_178" rel="nofollow">2. Dockerfile</a></li></ul> 
   </li><li><a href="#DockerCompose_191" rel="nofollow">四、Docker-Compose</a></li><li><ul><li><a href="#1__197" rel="nofollow">1. 安装</a></li><li><a href="#2__208" rel="nofollow">2. 基本命令</a></li></ul> 
   </li><li><a href="#Docker_228" rel="nofollow">五、Docker私服搭建</a></li><li><a href="#_290" rel="nofollow">六、练习</a></li><li><ul><li><a href="#1saveload_292" rel="nofollow">练习1：save和load</a></li><li><a href="#2dockernginx_306" rel="nofollow">练习2：docker部署nginx</a></li><li><ul><li><a href="#_319" rel="nofollow">问题：修改主页</a></li></ul> 
    </li><li><a href="#3MySQL_357" rel="nofollow">练习3：部署MySQL</a></li><li><a href="#4Ubuntujava_397" rel="nofollow">练习4：基于Ubuntu构建一个新镜像，运行一个java项目</a></li><li><ul><li><a href="#_jdk_438" rel="nofollow">问题 层数太多，每次都要安装jdk</a></li></ul> 
    </li><li><a href="#5_473" rel="nofollow">练习5：部署微服务集群</a></li><li><ul><li><a href="#_561" rel="nofollow">问题：微服务注册失败</a></li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="_2"></a>一、介绍和安装</h3> 
<p>Docker 是一个开源的应用容器引擎，基于 <a href="https://www.runoob.com/go/go-tutorial.html" rel="nofollow">Go 语言</a> 并遵从 Apache2.0 协议开源。</p> 
<p>Docker 可以让开发者打包他们的应用以及依赖包到一个轻量级、可移植的容器中，然后发布到任何流行的 Linux 机器上，也可以实现虚拟化。</p> 
<p>容器是完全使用沙箱机制，相互之间不会有任何接口（类似 iPhone 的 app）,更重要的是容器性能开销极低。</p> 
<p>几个概念：</p> 
<ul><li>镜像（image）：Docker将应用程序及其所需要的依赖、函数库等打包在一起，即为镜像。</li><li>容器：镜像中的应用程序运行后形成的进程。</li><li>Docker Registry：镜像托管平台，如DockerHub，网易云镜像服务，阿里云镜像服务。</li></ul> 
<p>docker架构：</p> 
<p><img src="https://images2.imgbox.com/a1/49/UvvxQ3Hy_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="1__21"></a>1. 安装</h4> 
<p>可以先选择卸载：</p> 
<pre><code class="prism language-bash">yum remove <span class="token function">docker</span> <span class="token punctuation">\</span>
                  docker-client <span class="token punctuation">\</span>
                  docker-client-latest <span class="token punctuation">\</span>
                  docker-common <span class="token punctuation">\</span>
                  docker-latest <span class="token punctuation">\</span>
                  docker-latest-logrotate <span class="token punctuation">\</span>
                  docker-logrotate <span class="token punctuation">\</span>
                  docker-selinux <span class="token punctuation">\</span>
                  docker-engine-selinux <span class="token punctuation">\</span>
                  docker-engine <span class="token punctuation">\</span>
                  docker-ce
</code></pre> 
<p>安装存储驱动等：</p> 
<pre><code class="prism language-bash">yum <span class="token function">install</span> <span class="token parameter variable">-y</span> yum-utils <span class="token punctuation">\</span>
           device-mapper-persistent-data <span class="token punctuation">\</span>
           lvm2 --skip-broken
</code></pre> 
<p>设置docker仓库：</p> 
<pre><code class="prism language-bash"><span class="token comment"># 设置docker镜像源</span>
yum-config-manager <span class="token punctuation">\</span>
    --add-repo <span class="token punctuation">\</span>
    https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
    
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s/download.docker.com/mirrors.aliyun.com\/docker-ce/g'</span> /etc/yum.repos.d/docker-ce.repo

yum makecache fast
</code></pre> 
<p>安装社区版docker：</p> 
<pre><code class="prism language-bash">yum <span class="token function">install</span> <span class="token parameter variable">-y</span> docker-ce
</code></pre> 
<h4><a id="2__68"></a>2. 启动</h4> 
<pre><code class="prism language-sh"><span class="token comment"># 关闭防火墙</span>
systemctl stop firewalld
<span class="token comment"># 禁止开机启动防火墙</span>
systemctl disable firewalld
<span class="token comment"># 启动docker服务</span>
systemctl start <span class="token function">docker</span>
<span class="token comment"># 停止docker服务</span>
systemctl stop <span class="token function">docker</span>  
<span class="token comment"># 重启docker服务</span>
systemctl restart <span class="token function">docker</span>  
<span class="token comment"># 查看docker版本</span>
<span class="token function">docker</span> <span class="token parameter variable">-v</span>
</code></pre> 
<h4><a id="3__87"></a>3. 镜像加速</h4> 
<p>参考阿里云的镜像加速文档：https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors</p> 
<h3><a id="Docker_91"></a>二、Docker基本操作</h3> 
<h4><a id="1__93"></a>1. 镜像操作</h4> 
<p>一些简单的操作：</p> 
<pre><code class="prism language-bash"><span class="token comment"># 查看镜像</span>
<span class="token function">docker</span> images
<span class="token comment"># 删除镜像</span>
<span class="token function">docker</span> rmi 
<span class="token comment"># 拉取镜像</span>
<span class="token function">docker</span> pull
<span class="token comment"># 推送镜像到Docker Registry</span>
<span class="token function">docker</span> push
<span class="token comment"># 保存镜像为tar包</span>
<span class="token function">docker</span> save
<span class="token comment"># 加载tar包为镜像</span>
<span class="token function">docker</span> load
…………
</code></pre> 
<p>命令有很多，不必记忆，勤用 <code>--help</code></p> 
<p>例如：</p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> images <span class="token parameter variable">--help</span>
</code></pre> 
<h4><a id="2__121"></a>2. 容器操作</h4> 
<p><img src="https://images2.imgbox.com/21/0a/RE4K1UZj_o.png" alt="在这里插入图片描述"></p> 
<p>一些简单的容器操作：</p> 
<pre><code class="prism language-sh"><span class="token comment"># 创建容器</span>
<span class="token function">docker</span> run
<span class="token comment"># 进入容器</span>
<span class="token function">docker</span> <span class="token builtin class-name">exec</span>
<span class="token comment"># 查看容器日志（添加-f可以持续查看）</span>
<span class="token function">docker</span> logs 
<span class="token comment"># 查看容器</span>
<span class="token function">docker</span> <span class="token function">ps</span>
<span class="token comment"># 删除容器</span>
<span class="token function">docker</span> <span class="token function">rm</span>
…………
</code></pre> 
<h4><a id="3__142"></a>3. 数据卷操作</h4> 
<p>数据卷是一个虚拟目录，指向宿主机文件系统中的某个目录。</p> 
<pre><code class="prism language-sh"><span class="token function">docker</span> volume <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span>
</code></pre> 
<ul><li>create 创建数据卷</li><li>inspect 显示一个或多个数据卷的信息</li><li>ls 列出所有数据卷</li><li>prune 删除未使用数据卷</li><li>rm 删除一个或多个数据卷</li></ul> 
<p><img src="https://images2.imgbox.com/d4/88/lOu5iYhl_o.png" alt="在这里插入图片描述"></p> 
<p><mark>后文练习123帮助理解。</mark></p> 
<h3><a id="Dockerfile_161"></a>三、Dockerfile</h3> 
<p>很多时候需要自己构建镜像，构建镜像需要写Dockerfile。</p> 
<h4><a id="1__165"></a>1. 镜像结构</h4> 
<p>首先介绍镜像结构，镜像是应用程序及其所需要的系统函数库、环境、配置、依赖一层一层构建出来的，以mysql为例：</p> 
<p>底层是系统函数库（例如Ubuntu），这一层也叫做<strong>基础镜像（BaseImage）</strong>，相当于地基。</p> 
<p>然后在地基上添加安装包，配置环境变量、配置、依赖等等。</p> 
<p>最后需要提供一个<strong>入口（Entrypoint）</strong>，也就是程序启动的脚本和参数。</p> 
<p><img src="https://images2.imgbox.com/1f/1b/mI5c4jES_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="2_Dockerfile_178"></a>2. Dockerfile</h4> 
<p>Dockerfile是一个文本文件，名为Dockerfile，没有后缀，其中包含一些指令，每一个指令就是一层。</p> 
<p>常用指令：</p> 
<p><img src="https://images2.imgbox.com/e9/54/qajWnct3_o.png" alt="在这里插入图片描述"></p> 
<p>写好Dockerfile后使用<code>docker build</code>命令构建镜像</p> 
<p>详见练习4</p> 
<h3><a id="DockerCompose_191"></a>四、Docker-Compose</h3> 
<p>若是部署微服务集群，一个个docker去构建会很繁琐，所以需要DOcker-Compose。</p> 
<p>DockerCompose基于Compose文件快速部署分布式应用，无需手动一个个的创建和运行。Compose文件也是一个文本文件，通过指令定义集群中的每个容器如何运行。</p> 
<h4><a id="1__197"></a>1. 安装</h4> 
<pre><code class="prism language-sh"><span class="token comment"># 下载docker-compose</span>
<span class="token function">curl</span> <span class="token parameter variable">-L</span> https://github.com/docker/compose/releases/download/1.23.1/docker-compose-<span class="token variable"><span class="token variable">`</span><span class="token function">uname</span> <span class="token parameter variable">-s</span><span class="token variable">`</span></span>-<span class="token variable"><span class="token variable">`</span><span class="token function">uname</span> <span class="token parameter variable">-m</span><span class="token variable">`</span></span> <span class="token operator">&gt;</span> /usr/local/bin/docker-compose
<span class="token comment"># 添加执行权限</span>
<span class="token function">chmod</span> +x /usr/local/bin/docker-compose
<span class="token comment"># 下载自动补全</span>
<span class="token function">curl</span> <span class="token parameter variable">-L</span> https://raw.githubusercontent.com/docker/compose/1.29.1/contrib/completion/bash/docker-compose <span class="token operator">&gt;</span> /etc/bash_completion.d/docker-compose
</code></pre> 
<h4><a id="2__208"></a>2. 基本命令</h4> 
<pre><code class="prism language-sh"><span class="token comment"># 后台启动当前项目 也可以指定服务</span>
<span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span>
<span class="token comment"># 查看项目容器</span>
<span class="token function">docker-compose</span> <span class="token function">ps</span>
<span class="token comment"># 停止容器运行 可以指定服务</span>
<span class="token function">docker-compose</span> stop
<span class="token comment"># 停止并删除容器 可以加参数来删除镜像、数据卷等</span>
<span class="token function">docker-compose</span> down
<span class="token comment"># 持续查看日志</span>
<span class="token function">docker-compose</span> logs <span class="token parameter variable">-f</span>
<span class="token comment"># 构建或重新构建镜像 可以指定服务</span>
<span class="token function">docker-compose</span> build
…………
</code></pre> 
<p>和docker操作差不多</p> 
<h3><a id="Docker_228"></a>五、Docker私服搭建</h3> 
<p>搭建一个docker私服。</p> 
<p>docker-compose.yml:</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.0'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">registry</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> registry
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./registry<span class="token punctuation">-</span>data<span class="token punctuation">:</span>/var/lib/registry
  <span class="token key atrule">ui</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> joxit/docker<span class="token punctuation">-</span>registry<span class="token punctuation">-</span>ui<span class="token punctuation">:</span>static
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 5000<span class="token punctuation">:</span><span class="token number">80</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> REGISTRY_TITLE=docker私服
      <span class="token punctuation">-</span> REGISTRY_URL=http<span class="token punctuation">:</span>//registry<span class="token punctuation">:</span><span class="token number">5000</span>
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> registry
</code></pre> 
<p>存放镜像的目录得准备好。</p> 
<p>还得给docker设置信任地址。</p> 
<p>我们的私服采用的是http协议，默认不被Docker信任，所以需要做一个配置：</p> 
<pre><code class="prism language-sh"><span class="token comment"># 打开要修改的文件</span>
<span class="token function">vi</span> /etc/docker/daemon.json
<span class="token comment"># 添加内容：</span>
<span class="token string">"insecure-registries"</span>:<span class="token punctuation">[</span><span class="token string">"http://yourip:port"</span><span class="token punctuation">]</span>
<span class="token comment"># 重加载</span>
systemctl daemon-reload
<span class="token comment"># 重启docker</span>
systemctl restart <span class="token function">docker</span>
</code></pre> 
<p>然后就可以<code>docker-compose up -d</code>启动</p> 
<p>访问ip+端口，成功：</p> 
<p><img src="https://images2.imgbox.com/ff/00/P2FwufqX_o.png" alt="在这里插入图片描述"></p> 
<p>上传一个镜像试试：</p> 
<pre><code class="prism language-sh"><span class="token comment"># 标记镜像，归入私服，有格式要求，名称前缀为私服地址</span>
<span class="token function">docker</span> tag nginx:latest xxx:xxx/nginx:1.0
<span class="token comment"># 推送</span>
<span class="token function">docker</span> push xxx:xxx/nginx:1.0
<span class="token comment"># 拉取</span>
<span class="token function">docker</span> pull xxx:xxx/nginx:1.0
</code></pre> 
<p><img src="https://images2.imgbox.com/25/36/AvBfWOIr_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_290"></a>六、练习</h3> 
<h4><a id="1saveload_292"></a>练习1：save和load</h4> 
<p>打包镜像：</p> 
<pre><code class="prism language-sh"><span class="token function">docker</span> save <span class="token parameter variable">-o</span> mynginx.tar nginx:latest
</code></pre> 
<p>加载镜像：</p> 
<pre><code class="prism language-sh"><span class="token function">docker</span> load <span class="token parameter variable">-i</span> mynginx.tar
</code></pre> 
<h4><a id="2dockernginx_306"></a>练习2：docker部署nginx</h4> 
<pre><code class="prism language-bash"><span class="token comment"># 拉取</span>
<span class="token function">docker</span> pull nginx
<span class="token comment"># 启动</span>
<span class="token function">docker</span> run <span class="token parameter variable">--name</span> mynginx <span class="token parameter variable">-p</span> <span class="token number">8080</span>:80 <span class="token parameter variable">-d</span> nginx
<span class="token comment"># -p 后面的端口 左边是宿主机 右边是容器 </span>
<span class="token comment"># -d 后台运行</span>
</code></pre> 
<p>此时访问宿主机的8080端口即可访问到nginx服务。</p> 
<h5><a id="_319"></a>问题：修改主页</h5> 
<p>方式一：进入容器修改/usr/share/nginx/html/index.html文件（这个路径dockerhub的nginx镜像官方文档中可以找到）</p> 
<pre><code class="prism language-sh"><span class="token comment"># 进入容器</span>
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> mynginx <span class="token function">bash</span>
<span class="token comment"># -it 给当前进入的容器创建一个标准输入输出的终端，允许我们与容器交互</span>
<span class="token comment"># bash 进入容器执行的命令</span>

<span class="token comment"># 因为没有vi等文本编辑器，所以使用替换命令</span>
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s#Welcome to nginx#替换#g'</span> index.html
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s#&lt;head&gt;#&lt;/head&gt;&lt;meta charset="utf-8"&gt;#g'</span> index.html
</code></pre> 
<p><img src="https://images2.imgbox.com/fd/56/Qi7pz4nF_o.png" alt="在这里插入图片描述"></p> 
<p>这种方式明显是有很大局限性的！容器和数据耦合度非常高，操作繁琐不说，数据也不可复用，维护也非常困难。</p> 
<p>方式二：将数据卷挂载到/usr/share/nginx/html目录。</p> 
<pre><code class="prism language-sh"><span class="token comment"># 强行删除容器</span>
<span class="token function">docker</span> <span class="token function">rm</span> <span class="token parameter variable">-f</span> mynginx
<span class="token comment"># 准备一个目录</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /tmp/nginx/html
<span class="token comment"># 启动</span>
<span class="token function">docker</span> run <span class="token parameter variable">--name</span> mynginx <span class="token parameter variable">-v</span> /tmp/nginx/html:/usr/share/nginx/html <span class="token parameter variable">-p</span> <span class="token number">8080</span>:80 <span class="token parameter variable">-d</span> nginx
<span class="token comment"># -p 后面的端口 左边是宿主机 右边是容器 </span>
<span class="token comment"># -d 后台运行</span>
<span class="token comment"># -v 数据卷挂载 左边是宿主机目录 右边是容器</span>
</code></pre> 
<p>这样 就可以把数据和容器解耦了。</p> 
<h4><a id="3MySQL_357"></a>练习3：部署MySQL</h4> 
<pre><code class="prism language-sh"><span class="token comment"># 拉取镜像（先去dockerhub看看镜像名和版本）</span>
<span class="token function">docker</span> pull mysql:5.7.25
<span class="token comment"># 准备存放数据和配置的数据卷</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /tmp/mysql/data
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /tmp/mysql/conf
</code></pre> 
<p>准备mysql配置文件后缀是.conf例如my.conf，内容如下：</p> 
<pre><code class="prism language-properties">[mysqld]
skip-name-resolve
character_set_server=utf8
datadir=/var/lib/mysql
server-id=1000
</code></pre> 
<pre><code class="prism language-sh"><span class="token comment"># 启动mysql</span>
<span class="token function">docker</span> run <span class="token punctuation">\</span>
<span class="token parameter variable">--name</span> mysql <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span><span class="token number">123456</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-p</span> <span class="token number">3306</span>:3306 <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /tmp/mysql/conf:/etc/mysql/conf.d <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /tmp/mysql/data:/var/lib/mysql <span class="token punctuation">\</span>
<span class="token parameter variable">-d</span> <span class="token punctuation">\</span>
mysql:5.7.25
<span class="token comment"># -e 后面表示这个容器的环境变量 这里我们将环境变量MYSQL_ROOT_PASSWORD赋值为123456</span>
<span class="token comment"># -p 端口 左宿主 右容器</span>
<span class="token comment"># -v 数据卷挂载</span>
<span class="token comment"># -d 后台运行</span>
</code></pre> 
<p>这里面的一些数据是需要取看官方文档的，例如环境变量、配置文件目录等。</p> 
<h4><a id="4Ubuntujava_397"></a>练习4：基于Ubuntu构建一个新镜像，运行一个java项目</h4> 
<p>Dockerfile内容：</p> 
<pre><code class="prism language-dockerfile"># 指定基础镜像
FROM ubuntu:16.04
# 配置环境变量，JDK的安装目录
ENV JAVA_DIR=/usr/local

# 拷贝jdk和java项目的包
COPY ./jdk8.tar.gz $JAVA_DIR/
COPY ./docker-demo.jar /tmp/app.jar

# 安装JDK
RUN cd $JAVA_DIR \
 &amp;&amp; tar -xf ./jdk8.tar.gz \
 &amp;&amp; mv ./jdk1.8.0_144 ./java8

# 配置环境变量
ENV JAVA_HOME=$JAVA_DIR/java8
ENV PATH=$PATH:$JAVA_HOME/bin

# 暴露端口
EXPOSE 8090
# 入口，java项目的启动命令
ENTRYPOINT java -jar /tmp/app.jar
</code></pre> 
<p>构建镜像</p> 
<pre><code class="prism language-sh"><span class="token comment"># 构建镜像</span>
<span class="token function">docker</span> build <span class="token parameter variable">-t</span> javaweb:1.0 <span class="token builtin class-name">.</span>
<span class="token comment"># -t 表示后面是 name:tag</span>
<span class="token comment">#. 表示Dockerfile所在的目录 . 表示当前目录</span>

<span class="token comment"># 启动容器</span>
<span class="token function">docker</span> run <span class="token parameter variable">--name</span> web <span class="token parameter variable">-p</span> <span class="token number">8090</span>:8090 <span class="token parameter variable">-d</span> javaweb:1.0
</code></pre> 
<h5><a id="_jdk_438"></a>问题 层数太多，每次都要安装jdk</h5> 
<p>这样做有缺陷，有很多层都用来做安装jdk了：</p> 
<pre><code class="prism language-dockerfile"># 指定基础镜像
FROM ubuntu:16.04
# 配置环境变量，JDK的安装目录
ENV JAVA_DIR=/usr/local
# 拷贝jdk
COPY ./jdk8.tar.gz $JAVA_DIR/
# 安装JDK
RUN cd $JAVA_DIR \
 &amp;&amp; tar -xf ./jdk8.tar.gz \
 &amp;&amp; mv ./jdk1.8.0_144 ./java8
# 配置环境变量
ENV JAVA_HOME=$JAVA_DIR/java8
ENV PATH=$PATH:$JAVA_HOME/bin
</code></pre> 
<p>所以改进后：</p> 
<pre><code class="prism language-dockerfile"># 指定基础镜像
FROM java:8-alpine
# 拷贝项目
COPY ./docker-demo.jar /tmp/app.jar
# 暴露端口
EXPOSE 8090
# 入口，java项目的启动命令
ENTRYPOINT java -jar /tmp/app.jar
</code></pre> 
<h4><a id="5_473"></a>练习5：部署微服务集群</h4> 
<p>部署之前的cloud-demo。</p> 
<ol><li> <p>修改cloud-demo中的配置，nacos和mysql的地址改为docker-compose中的服务名，例如：</p> <pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//mysql<span class="token punctuation">:</span>3306/cloud_order<span class="token punctuation">?</span>useSSL=false
    <span class="token key atrule">username</span><span class="token punctuation">:</span> root
    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123456</span>
    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> orderservice
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> nacos<span class="token punctuation">:</span><span class="token number">8848</span>
</code></pre> </li><li> <p>打包，然后写对应的Dockerfile，例如：</p> <p>打包有个小坑 如果之前feign-api这个公共模块是创建的spring项目而不是maven项目，那么会order-service打包失败，换一个打包插件就好：</p> <pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>maven-compiler-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>source</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>target</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>target</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
</code></pre> <p>然后install一下这个模块就行。</p> <pre><code class="prism language-java"><span class="token constant">FROM</span> java<span class="token operator">:</span><span class="token number">8</span><span class="token operator">-</span>alpine
<span class="token constant">COPY</span> <span class="token punctuation">.</span>/app1<span class="token punctuation">.</span>jar <span class="token operator">/</span>tmp<span class="token operator">/</span>app<span class="token punctuation">.</span>jar
<span class="token constant">ENTRYPOINT</span> java <span class="token operator">-</span>jar <span class="token operator">/</span>tmp<span class="token operator">/</span>app<span class="token punctuation">.</span>jar
</code></pre> <p>完成后：</p> <p><img src="https://images2.imgbox.com/70/96/P6061jhl_o.png" alt="在这里插入图片描述"></p> </li><li> <p>编写docker-compose.yml:</p> <pre><code class="prism language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"3.2"</span>

<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nacos/nacos<span class="token punctuation">-</span>server
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">MODE</span><span class="token punctuation">:</span> standalone
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"8848:8848"</span>
  <span class="token key atrule">mysql</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql<span class="token punctuation">:</span>5.7.25
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">MYSQL_ROOT_PASSWORD</span><span class="token punctuation">:</span> <span class="token number">123</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"$PWD/mysql/data:/var/lib/mysql"</span>
      <span class="token punctuation">-</span> <span class="token string">"$PWD/mysql/conf:/etc/mysql/conf.d/"</span>
  <span class="token key atrule">userservice</span><span class="token punctuation">:</span>
    <span class="token key atrule">build</span><span class="token punctuation">:</span> ./user<span class="token punctuation">-</span>service
  <span class="token key atrule">orderservice</span><span class="token punctuation">:</span>
    <span class="token key atrule">build</span><span class="token punctuation">:</span> ./order<span class="token punctuation">-</span>service
  <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
    <span class="token key atrule">build</span><span class="token punctuation">:</span> ./gateway
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"10010:10010"</span>
</code></pre> </li><li> <p>启动docker-compose</p> <pre><code class="prism language-sh"><span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span>
<span class="token comment"># 后台运行</span>
<span class="token function">docker-compose</span> logs <span class="token parameter variable">-f</span>
<span class="token comment"># 持续查看日志</span>
</code></pre> </li></ol> 
<h5><a id="_561"></a>问题：微服务注册失败</h5> 
<p>原因：nacos启动慢，微服务启动时nacos还没有启动完成。</p> 
<p>解决：重启指定微服务，下次部署时先部署好nacos，使用depends_on也不行不知道啥问题。</p> 
<pre><code class="prism language-sh"><span class="token function">docker-compose</span> restart gateway userservice orderservice
<span class="token comment"># 重启指定服务</span>
<span class="token function">docker-compose</span> logs <span class="token parameter variable">-f</span>
<span class="token comment"># 持续查看日志</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ae84d5139c17f442e06701bd5fd351b9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">若依框架自动生成功能使用</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/69b711233e3ed0c387498154ba00490a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">CentOS 8修改系统语言为中文</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>