<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Zookeeper在分布式命名服务中的实践 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Zookeeper在分布式命名服务中的实践" />
<meta property="og:description" content="Java学习&#43;面试指南：https://javaxiaobear.cn
命名服务是为系统中的资源提供标识能力。ZooKeeper的命名服务主要是利用ZooKeeper节点的树形分层结构和子节点的顺序维护能力，来为分布式系统中的资源命名。
哪些应用场景需要用到分布式命名服务呢？典型的有：
分布式API目录
分布式节点命名
分布式ID生成器
1、分布式API目录 为分布式系统中各种API接口服务的名称、链接地址，提供类似JNDI（Java命名和目录接口）中的文件系统的功能。借助于ZooKeeper的树形分层结构就能提供分布式的API调用功能。
著名的Dubbo分布式框架就是应用了ZooKeeper的分布式的JNDI功能。在Dubbo中，使用ZooKeeper维护的全局服务接口API的地址列表。大致的思路为：
服务提供者（Service Provider）在启动的时候，向ZooKeeper上的指定节点/dubbo/${serviceName}/providers写入自己的API地址，这个操作就相当于服务的公开。
服务消费者（Consumer）启动的时候，订阅节点/dubbo/{serviceName}/providers下的服务提供者的URL地址，获得所有服务提供者的API。
2、分布式节点命名 一个分布式系统通常会由很多的节点组成，节点的数量不是固定的，而是不断动态变化的。比如说，当业务不断膨胀和流量洪峰到来时，大量的节点可能会动态加入到集群中。而一旦流量洪峰过去了，就需要下线大量的节点。再比如说，由于机器或者网络的原因，一些节点会主动离开集群。
如何为大量的动态节点命名呢？一种简单的办法是可以通过配置文件，手动为每一个节点命名。但是，如果节点数据量太大，或者说变动频繁，手动命名则是不现实的，这就需要用到分布式节点的命名服务。
可用于生成集群节点的编号的方案：
（1）使用数据库的自增ID特性，用数据表存储机器的MAC地址或者IP来维护。
（2）使用ZooKeeper持久顺序节点的顺序特性来维护节点的NodeId编号。
在第2种方案中，集群节点命名服务的基本流程是：
启动节点服务，连接ZooKeeper，检查命名服务根节点是否存在，如果不存在，就创建系统的根节点。
在根节点下创建一个临时顺序ZNode节点，取回ZNode的编号把它作为分布式系统中节点的NODEID。
如果临时节点太多，可以根据需要删除临时顺序ZNode节点。
3、分布式ID生成器 在分布式系统中，分布式ID生成器的使用场景非常之多：
大量的数据记录，需要分布式ID。
大量的系统消息，需要分布式ID。
大量的请求日志，如restful的操作记录，需要唯一标识，以便进行后续的用户行为分析和调用链路分析。
分布式节点的命名服务，往往也需要分布式ID。
。。。
传统的数据库自增主键已经不能满足需求。在分布式系统环境中，迫切需要一种全新的唯一ID系统，这种系统需要满足以下需求：
（1）全局唯一：不能出现重复ID。
（2）高可用：ID生成系统是基础系统，被许多关键系统调用，一旦宕机，就会造成严重影响。
有哪些分布式的ID生成器方案呢？大致如下：
Java的UUID。分布式缓存Redis生成ID：利用Redis的原子操作INCR和INCRBY，生成全局唯一的ID。Twitter的SnowFlake算法。ZooKeeper生成ID：利用ZooKeeper的顺序节点，生成全局唯一的ID。MongoDb的ObjectId:MongoDB是一个分布式的非结构化NoSQL数据库，每插入一条记录会自动生成全局唯一的一个“_id”字段值，它是一个12字节的字符串，可以作为分布式系统中全局唯一的ID。 前面我写过一篇关于分布式ID的设计与实现，关于其他的实现可参考这篇哈
1、基于Zookeeper实现分布式ID生成器 在ZooKeeper节点的四种类型中，其中有以下两种类型具备自动编号的能力
PERSISTENT_SEQUENTIAL持久化顺序节点。
EPHEMERAL_SEQUENTIAL临时顺序节点。
ZooKeeper的每一个节点都会为它的第一级子节点维护一份顺序编号，会记录每个子节点创建的先后顺序，这个顺序编号是分布式同步的，也是全局唯一的。
可以通过创建ZooKeeper的临时顺序节点的方法，生成全局唯一的ID
/** * @author 小熊学Java * @version 1.0 * @description: TODO * @date 2023/12/17 21:08 */ public class IDMaker { private static final String ZOOKEEPER_ADDRESS = &#34;ip:2181&#34;; private static final int SESSION_TIMEOUT = 3000; public CuratorFramework client; public IDMaker() { // 重试策略 RetryPolicy retryPolicy = new ExponentialBackoffRetry(1000, 3); client = CuratorFrameworkFactory." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/473ec0caa1d95c8d6a26af9d4ad614b7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-26T17:18:25+08:00" />
<meta property="article:modified_time" content="2023-12-26T17:18:25+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Zookeeper在分布式命名服务中的实践</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>Java学习+面试指南：https://javaxiaobear.cn</p> 
</blockquote> 
<p>命名服务是为系统中的资源提供标识能力。ZooKeeper的命名服务主要是利用ZooKeeper节点的树形分层结构和子节点的顺序维护能力，来为分布式系统中的资源命名。</p> 
<p>哪些应用场景需要用到分布式命名服务呢？典型的有：</p> 
<ul><li> <p>分布式API目录</p> </li><li> <p>分布式节点命名</p> </li><li> <p>分布式ID生成器</p> </li></ul> 
<h3><a id="1API_12"></a>1、分布式API目录</h3> 
<p>为分布式系统中各种API接口服务的名称、链接地址，提供类似JNDI（Java命名和目录接口）中的文件系统的功能。借助于ZooKeeper的树形分层结构就能提供分布式的API调用功能。</p> 
<p>著名的Dubbo分布式框架就是应用了ZooKeeper的分布式的JNDI功能。在Dubbo中，使用ZooKeeper维护的全局服务接口API的地址列表。大致的思路为：</p> 
<ul><li> <p>服务提供者（Service Provider）在启动的时候，向ZooKeeper上的指定节点/dubbo/${serviceName}/providers写入自己的API地址，这个操作就相当于服务的公开。</p> </li><li> <p>服务消费者（Consumer）启动的时候，订阅节点/dubbo/{serviceName}/providers下的服务提供者的URL地址，获得所有服务提供者的API。</p> </li></ul> 
<img src="https://images2.imgbox.com/6b/e2/zomiTLMI_o.png" alt="image-20231217200800728"> 
<h3><a id="2_24"></a>2、分布式节点命名</h3> 
<p>一个分布式系统通常会由很多的节点组成，节点的数量不是固定的，而是不断动态变化的。比如说，当业务不断膨胀和流量洪峰到来时，大量的节点可能会动态加入到集群中。而一旦流量洪峰过去了，就需要下线大量的节点。再比如说，由于机器或者网络的原因，一些节点会主动离开集群。</p> 
<p>如何为大量的动态节点命名呢？一种简单的办法是可以通过配置文件，手动为每一个节点命名。但是，如果节点数据量太大，或者说变动频繁，手动命名则是不现实的，这就需要用到分布式节点的命名服务。</p> 
<p>可用于生成集群节点的编号的方案：</p> 
<p>（1）使用数据库的自增ID特性，用数据表存储机器的MAC地址或者IP来维护。</p> 
<p>（2）使用ZooKeeper持久顺序节点的顺序特性来维护节点的NodeId编号。</p> 
<p>在第2种方案中，集群节点命名服务的基本流程是：</p> 
<ul><li> <p>启动节点服务，连接ZooKeeper，检查命名服务根节点是否存在，如果不存在，就创建系统的根节点。</p> </li><li> <p>在根节点下创建一个临时顺序ZNode节点，取回ZNode的编号把它作为分布式系统中节点的NODEID。</p> </li><li> <p>如果临时节点太多，可以根据需要删除临时顺序ZNode节点。</p> </li></ul> 
<h3><a id="3ID_44"></a>3、分布式ID生成器</h3> 
<p>在分布式系统中，分布式ID生成器的使用场景非常之多：</p> 
<ul><li> <p>大量的数据记录，需要分布式ID。</p> </li><li> <p>大量的系统消息，需要分布式ID。</p> </li><li> <p>大量的请求日志，如restful的操作记录，需要唯一标识，以便进行后续的用户行为分析和调用链路分析。</p> </li><li> <p>分布式节点的命名服务，往往也需要分布式ID。</p> </li><li> <p>。。。</p> </li></ul> 
<p>传统的数据库自增主键已经不能满足需求。在分布式系统环境中，迫切需要一种全新的唯一ID系统，这种系统需要满足以下需求：</p> 
<p>（1）全局唯一：不能出现重复ID。</p> 
<p>（2）高可用：ID生成系统是基础系统，被许多关键系统调用，一旦宕机，就会造成严重影响。</p> 
<p>有哪些分布式的ID生成器方案呢？大致如下：</p> 
<ol><li>Java的UUID。</li><li>分布式缓存Redis生成ID：利用Redis的原子操作INCR和INCRBY，生成全局唯一的ID。</li><li>Twitter的SnowFlake算法。</li><li>ZooKeeper生成ID：利用ZooKeeper的顺序节点，生成全局唯一的ID。</li><li>MongoDb的ObjectId:MongoDB是一个分布式的非结构化NoSQL数据库，每插入一条记录会自动生成全局唯一的一个“_id”字段值，它是一个12字节的字符串，可以作为分布式系统中全局唯一的ID。</li></ol> 
<p>前面我写过一篇关于<a href="https://javaxiaobear.gitee.io/architecture/distributed/distributedId.html" rel="nofollow">分布式ID的设计与实现</a>，关于其他的实现可参考这篇哈</p> 
<h4><a id="1ZookeeperID_76"></a>1、基于Zookeeper实现分布式ID生成器</h4> 
<p>在ZooKeeper节点的四种类型中，其中有以下两种类型具备自动编号的能力</p> 
<ul><li> <p>PERSISTENT_SEQUENTIAL持久化顺序节点。</p> </li><li> <p>EPHEMERAL_SEQUENTIAL临时顺序节点。</p> </li></ul> 
<p>ZooKeeper的每一个节点都会为它的第一级子节点维护一份顺序编号，会记录每个子节点创建的先后顺序，这个顺序编号是分布式同步的，也是全局唯一的。</p> 
<p>可以通过创建ZooKeeper的临时顺序节点的方法，生成全局唯一的ID</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @author 小熊学Java
 * @version 1.0
 * @description: TODO
 * @date 2023/12/17 21:08
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IDMaker</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ZOOKEEPER_ADDRESS</span> <span class="token operator">=</span> <span class="token string">"ip:2181"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">SESSION_TIMEOUT</span> <span class="token operator">=</span> <span class="token number">3000</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">CuratorFramework</span> client<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">IDMaker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 重试策略</span>
        <span class="token class-name">RetryPolicy</span> retryPolicy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExponentialBackoffRetry</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        client <span class="token operator">=</span> <span class="token class-name">CuratorFrameworkFactory</span><span class="token punctuation">.</span><span class="token function">newClient</span><span class="token punctuation">(</span><span class="token constant">ZOOKEEPER_ADDRESS</span><span class="token punctuation">,</span> retryPolicy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 根据路径创建
     * @param path
     * @return
     * @throws Exception
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">createSeqNode</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> client<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">creatingParentsIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withMode</span><span class="token punctuation">(</span><span class="token class-name">CreateMode</span><span class="token punctuation">.</span><span class="token constant">EPHEMERAL_SEQUENTIAL</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">forPath</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">createId</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> seqNode <span class="token operator">=</span> <span class="token function">createSeqNode</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>seqNode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">//获取末尾的序号</span>
            <span class="token keyword">int</span> i <span class="token operator">=</span> seqNode<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                i <span class="token operator">+=</span> path<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> i <span class="token operator">&lt;=</span> seqNode<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> seqNode<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> seqNode<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">IDMaker</span> idMaker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IDMaker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> nodePath <span class="token operator">=</span> <span class="token string">"/javaxiaobear"</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">5</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">String</span> id <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                        id <span class="token operator">=</span> idMaker<span class="token punctuation">.</span><span class="token function">createId</span><span class="token punctuation">(</span>nodePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"线程第"</span> <span class="token operator">+</span> j <span class="token operator">+</span> <span class="token string">"个创建的id为"</span><span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"thread"</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>执行结果</p> 
<p><img src="https://images2.imgbox.com/4e/09/EVVjJgB3_o.png" alt="image-20231217222047186"></p> 
<h4><a id="2ZookeeperSnowFlakeID_159"></a>2、基于Zookeeper实现SnowFlakeID算法</h4> 
<p>Twitter（推特）的SnowFlake算法是一种著名的分布式服务器用户ID生成算法。SnowFlake算法所生成的ID是一个64bit的长整型数字，如图10-2所示。这个64bit被划分成四个部分，其中后面三个部分分别表示时间戳、工作机器ID、序列号。</p> 
<p><img src="https://images2.imgbox.com/18/d7/7ef9nIrV_o.png" alt="image-20231218155206354"></p> 
<p>SnowFlakeID的四个部分，具体介绍如下：</p> 
<p>（1）第一位 占用1 bit，其值始终是0，没有实际作用。</p> 
<p>（2）时间戳 占用41 bit，精确到毫秒，总共可以容纳约69年的时间。</p> 
<p>（3）工作机器id占用10 bit，最多可以容纳1024个节点。</p> 
<p>（4）序列号 占用12 bit。这个值在同一毫秒同一节点上从0开始不断累加，最多可以累加到4095。</p> 
<p>在工作节点达到1024顶配的场景下，SnowFlake算法在同一毫秒最多可以生成的ID数量为： 1024 * 4096 =4194304，在绝大多数并发场景下都是够用的。</p> 
<p>SnowFlake算法的优点：</p> 
<ul><li> <p>生成ID时不依赖于数据库，完全在内存生成，高性能和高可用性。</p> </li><li> <p>容量大，每秒可生成几百万个ID。</p> </li><li> <p>ID呈趋势递增，后续插入数据库的索引树时，性能较高。</p> </li></ul> 
<p>SnowFlake算法的缺点：</p> 
<ul><li> <p>依赖于系统时钟的一致性，如果某台机器的系统时钟回拨了，有可能造成ID冲突，或者ID乱序。</p> </li><li> <p>在启动之前，如果这台机器的系统时间回拨过，那么有可能出现ID重复的危险。</p> </li></ul> 
<p>基于zookeeper实现雪花算法：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SnowflakeIdGenerator</span> <span class="token punctuation">{<!-- --></span>
 
    <span class="token comment">/**
     * 单例
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">SnowflakeIdGenerator</span> instance <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">SnowflakeIdGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 
    <span class="token comment">/**
     * 初始化单例
     *
     * @param workerId 节点Id,最大8091
     * @return the 单例
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">long</span> workerId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>workerId <span class="token operator">&gt;</span> <span class="token constant">MAX_WORKER_ID</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// zk分配的workerId过大</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"woker Id wrong: "</span> <span class="token operator">+</span> workerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        instance<span class="token punctuation">.</span>workerId <span class="token operator">=</span> workerId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">private</span> <span class="token class-name">SnowflakeIdGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 
    <span class="token punctuation">}</span>
 
 
    <span class="token comment">/**
     * 开始使用该算法的时间为: 2017-01-01 00:00:00
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">START_TIME</span> <span class="token operator">=</span> <span class="token number">1483200000000L</span><span class="token punctuation">;</span>
 
    <span class="token comment">/**
     * worker id 的bit数，最多支持8192个节点
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">WORKER_ID_BITS</span> <span class="token operator">=</span> <span class="token number">13</span><span class="token punctuation">;</span>
 
    <span class="token comment">/**
     * 序列号，支持单节点最高每毫秒的最大ID数1024
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token constant">SEQUENCE_BITS</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
 
    <span class="token comment">/**
     * 最大的 worker id ，8091
     * -1 的补码（二进制全1）右移13位, 然后取反
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token constant">MAX_WORKER_ID</span> <span class="token operator">=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">WORKER_ID_BITS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token comment">/**
     * 最大的序列号，1023
     * -1 的补码（二进制全1）右移10位, 然后取反
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token constant">MAX_SEQUENCE</span> <span class="token operator">=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">SEQUENCE_BITS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token comment">/**
     * worker 节点编号的移位
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token constant">WORKER_ID_SHIFT</span> <span class="token operator">=</span> <span class="token constant">SEQUENCE_BITS</span><span class="token punctuation">;</span>
 
    <span class="token comment">/**
     * 时间戳的移位
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token constant">TIMESTAMP_LEFT_SHIFT</span> <span class="token operator">=</span> <span class="token constant">WORKER_ID_BITS</span> <span class="token operator">+</span> <span class="token constant">SEQUENCE_BITS</span><span class="token punctuation">;</span>
 
    <span class="token comment">/**
     * 该项目的worker 节点 id
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> workerId<span class="token punctuation">;</span>
 
    <span class="token comment">/**
     * 上次生成ID的时间戳
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> lastTimestamp <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">;</span>
 
    <span class="token comment">/**
     * 当前毫秒生成的序列
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> sequence <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
 
    <span class="token comment">/**
     * Next id long.
     *
     * @return the nextId
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">generateId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">/**
     * 生成唯一id的具体实现
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">synchronized</span> <span class="token keyword">long</span> <span class="token function">generateId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">long</span> current <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">&lt;</span> lastTimestamp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 如果当前时间小于上一次ID生成的时间戳，说明系统时钟回退过，出现问题返回-1</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
 
        <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">==</span> lastTimestamp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 如果当前生成id的时间还是上次的时间，那么对sequence序列号进行+1</span>
            sequence <span class="token operator">=</span> <span class="token punctuation">(</span>sequence <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token constant">MAX_SEQUENCE</span><span class="token punctuation">;</span>
 
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sequence <span class="token operator">==</span> <span class="token constant">MAX_SEQUENCE</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 当前毫秒生成的序列数已经大于最大值，那么阻塞到下一个毫秒再获取新的时间戳</span>
                current <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">nextMs</span><span class="token punctuation">(</span>lastTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 当前的时间戳已经是下一个毫秒</span>
            sequence <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
 
        <span class="token comment">// 更新上次生成id的时间戳</span>
        lastTimestamp <span class="token operator">=</span> current<span class="token punctuation">;</span>
 
        <span class="token comment">// 进行移位操作生成int64的唯一ID</span>
 
        <span class="token comment">//时间戳右移动23位</span>
        <span class="token keyword">long</span> time <span class="token operator">=</span> <span class="token punctuation">(</span>current <span class="token operator">-</span> <span class="token constant">START_TIME</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">TIMESTAMP_LEFT_SHIFT</span><span class="token punctuation">;</span>
 
        <span class="token comment">//workerId 右移动10位</span>
        <span class="token keyword">long</span> workerId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>workerId <span class="token operator">&lt;&lt;</span> <span class="token constant">WORKER_ID_SHIFT</span><span class="token punctuation">;</span>
 
        <span class="token keyword">return</span> time <span class="token operator">|</span> workerId <span class="token operator">|</span> sequence<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">/**
     * 阻塞到下一个毫秒
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">nextMs</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeStamp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">long</span> current <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>current <span class="token operator">&lt;=</span> timeStamp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            current <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> current<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/6f/d7/GbPOeIWF_o.png" alt=""></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/aa2427d97c00c51e07d4c992f58ae47f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Python就业月入20000？你需要一份真正的就业指导</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/53b41a1df9ba3d80f704e964e48406c5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">怎么修复MSVCR110.dll文件？全面解析MSVCR110.dll缺失修复方法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>