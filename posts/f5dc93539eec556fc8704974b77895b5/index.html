<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>基于深度学习的HRNet-YOLO的花卉图像识别系统 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="基于深度学习的HRNet-YOLO的花卉图像识别系统" />
<meta property="og:description" content="1.研究背景与意义 项目参考AAAI Association for the Advancement of Artificial Intelligence
研究背景与意义
随着计算机视觉技术的快速发展，图像识别已经成为了人工智能领域的一个重要研究方向。图像识别技术在各个领域都有广泛的应用，其中之一就是花卉图像识别。花卉图像识别可以帮助人们快速准确地识别花卉的种类和特征，对于植物学研究、园艺种植、生态环境保护等方面都具有重要的意义。
传统的花卉图像识别方法主要依赖于手工设计的特征提取算法和分类器，这些方法在一定程度上可以实现花卉图像的识别，但是存在着一些问题。首先，手工设计的特征提取算法往往需要人工经验和专业知识，对于不同的花卉种类和特征可能需要不同的特征提取算法，这给算法的设计和实现带来了一定的困难。其次，传统的分类器在处理大规模的花卉图像数据时，往往需要大量的计算资源和时间，无法满足实时性的要求。此外，传统的方法对于花卉图像中的遮挡、光照变化等问题也比较敏感，识别准确率有限。
基于深度学习的图像识别方法在解决上述问题上具有很大的优势。深度学习模型可以自动学习图像的特征表示，不需要手工设计特征提取算法，大大减轻了算法设计的难度。同时，深度学习模型可以通过大规模的训练数据进行训练，可以充分利用计算资源，提高识别的准确率和效率。此外，深度学习模型对于图像中的遮挡、光照变化等问题也具有一定的鲁棒性。
HRNet-YOLO是一种基于深度学习的目标检测算法，它结合了高分辨率网络（HRNet）和You Only Look Once（YOLO）的思想，可以实现对花卉图像中花卉目标的准确检测和识别。HRNet-YOLO具有多尺度特征融合和全局上下文信息的建模能力，可以有效地解决花卉图像中的遮挡、光照变化等问题，提高识别的准确率和鲁棒性。
因此，基于深度学习的HRNet-YOLO的花卉图像识别系统具有重要的研究意义和应用价值。通过研究该系统，可以实现对花卉图像的自动化识别和分类，为植物学研究、园艺种植、生态环境保护等领域提供有力的支持。此外，该系统还可以应用于花卉市场、花卉展览等场景，提供快速准确的花卉识别服务，提升用户体验和商业价值。因此，研究基于深度学习的HRNet-YOLO的花卉图像识别系统具有重要的理论和实践意义。
2.图片演示 3.视频演示 基于深度学习的HRNet-YOLO的花卉图像识别系统_哔哩哔哩_bilibili
4.数据集的采集＆标注和整理 图片的收集 首先，我们需要收集所需的图片。这可以通过不同的方式来实现，例如使用现有的公开数据集FlowerDatasets。
下面是一个简单的方法是使用Python脚本，该脚本读取分类图片文件，然后将其转换为所需的格式。
import os import shutil import random # 指定输入和输出文件夹的路径 input_dir = &#39;train&#39; output_dir = &#39;output&#39; # 确保输出文件夹存在 if not os.path.exists(output_dir): os.makedirs(output_dir) # 遍历输入文件夹中的所有子文件夹 for subdir in os.listdir(input_dir): input_subdir_path = os.path.join(input_dir, subdir) # 确保它是一个子文件夹 if os.path.isdir(input_subdir_path): output_subdir_path = os.path.join(output_dir, subdir) # 在输出文件夹中创建同名的子文件夹 if not os.path.exists(output_subdir_path): os.makedirs(output_subdir_path) # 获取所有文件的列表 files = [f for f in os." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/f5dc93539eec556fc8704974b77895b5/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-14T09:59:54+08:00" />
<meta property="article:modified_time" content="2023-11-14T09:59:54+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">基于深度学习的HRNet-YOLO的花卉图像识别系统</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="1_1"></a>1.研究背景与意义</h2> 
<p>项目参考<a href="https://www.zhihu.com/people/2-38-73-10/posts" rel="nofollow">AAAI Association for the Advancement of Artificial Intelligence</a></p> 
<p>研究背景与意义</p> 
<p>随着计算机视觉技术的快速发展，图像识别已经成为了人工智能领域的一个重要研究方向。图像识别技术在各个领域都有广泛的应用，其中之一就是花卉图像识别。花卉图像识别可以帮助人们快速准确地识别花卉的种类和特征，对于植物学研究、园艺种植、生态环境保护等方面都具有重要的意义。</p> 
<p>传统的花卉图像识别方法主要依赖于手工设计的特征提取算法和分类器，这些方法在一定程度上可以实现花卉图像的识别，但是存在着一些问题。首先，手工设计的特征提取算法往往需要人工经验和专业知识，对于不同的花卉种类和特征可能需要不同的特征提取算法，这给算法的设计和实现带来了一定的困难。其次，传统的分类器在处理大规模的花卉图像数据时，往往需要大量的计算资源和时间，无法满足实时性的要求。此外，传统的方法对于花卉图像中的遮挡、光照变化等问题也比较敏感，识别准确率有限。</p> 
<p>基于深度学习的图像识别方法在解决上述问题上具有很大的优势。深度学习模型可以自动学习图像的特征表示，不需要手工设计特征提取算法，大大减轻了算法设计的难度。同时，深度学习模型可以通过大规模的训练数据进行训练，可以充分利用计算资源，提高识别的准确率和效率。此外，深度学习模型对于图像中的遮挡、光照变化等问题也具有一定的鲁棒性。</p> 
<p>HRNet-YOLO是一种基于深度学习的目标检测算法，它结合了高分辨率网络（HRNet）和You Only Look Once（YOLO）的思想，可以实现对花卉图像中花卉目标的准确检测和识别。HRNet-YOLO具有多尺度特征融合和全局上下文信息的建模能力，可以有效地解决花卉图像中的遮挡、光照变化等问题，提高识别的准确率和鲁棒性。</p> 
<p>因此，基于深度学习的HRNet-YOLO的花卉图像识别系统具有重要的研究意义和应用价值。通过研究该系统，可以实现对花卉图像的自动化识别和分类，为植物学研究、园艺种植、生态环境保护等领域提供有力的支持。此外，该系统还可以应用于花卉市场、花卉展览等场景，提供快速准确的花卉识别服务，提升用户体验和商业价值。因此，研究基于深度学习的HRNet-YOLO的花卉图像识别系统具有重要的理论和实践意义。</p> 
<h2><a id="2_17"></a>2.图片演示</h2> 
<p><img src="https://images2.imgbox.com/23/d8/hn0RUuCi_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/b7/84/pRcbw8Q0_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/22/fc/ZvSvOjC5_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="3_22"></a>3.视频演示</h2> 
<p><a href="https://www.bilibili.com/video/BV1ka4y1S7v8/?spm_id_from=333.999.0.0&amp;vd_source=bc9aec86d164b67a7004b996143742dc" rel="nofollow">基于深度学习的HRNet-YOLO的花卉图像识别系统_哔哩哔哩_bilibili</a></p> 
<h2><a id="4_26"></a>4.数据集的采集＆标注和整理</h2> 
<h5><a id="_27"></a>图片的收集</h5> 
<p>首先，我们需要收集所需的图片。这可以通过不同的方式来实现，例如使用现有的公开数据集FlowerDatasets。<br> <img src="https://images2.imgbox.com/8a/71/TWTBKqAR_o.jpg" alt="在这里插入图片描述"></p> 
<p>下面是一个简单的方法是使用Python脚本，该脚本读取分类图片文件，然后将其转换为所需的格式。</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> shutil
<span class="token keyword">import</span> random

<span class="token comment"># 指定输入和输出文件夹的路径</span>
input_dir <span class="token operator">=</span> <span class="token string">'train'</span>
output_dir <span class="token operator">=</span> <span class="token string">'output'</span>

<span class="token comment"># 确保输出文件夹存在</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>output_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>output_dir<span class="token punctuation">)</span>

<span class="token comment"># 遍历输入文件夹中的所有子文件夹</span>
<span class="token keyword">for</span> subdir <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>input_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
    input_subdir_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>input_dir<span class="token punctuation">,</span> subdir<span class="token punctuation">)</span>

    <span class="token comment"># 确保它是一个子文件夹</span>
    <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isdir<span class="token punctuation">(</span>input_subdir_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        output_subdir_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>output_dir<span class="token punctuation">,</span> subdir<span class="token punctuation">)</span>

        <span class="token comment"># 在输出文件夹中创建同名的子文件夹</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>output_subdir_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
            os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>output_subdir_path<span class="token punctuation">)</span>

        <span class="token comment"># 获取所有文件的列表</span>
        files <span class="token operator">=</span> <span class="token punctuation">[</span>f <span class="token keyword">for</span> f <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>input_subdir_path<span class="token punctuation">)</span> <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isfile<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>input_subdir_path<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

        <span class="token comment"># 随机选择四分之一的文件</span>
        files_to_move <span class="token operator">=</span> random<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>files<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">4</span><span class="token punctuation">)</span>

        <span class="token comment"># 移动文件</span>
        <span class="token keyword">for</span> file_to_move <span class="token keyword">in</span> files_to_move<span class="token punctuation">:</span>
            src_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>input_subdir_path<span class="token punctuation">,</span> file_to_move<span class="token punctuation">)</span>
            dest_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>output_subdir_path<span class="token punctuation">,</span> file_to_move<span class="token punctuation">)</span>
            shutil<span class="token punctuation">.</span>move<span class="token punctuation">(</span>src_path<span class="token punctuation">,</span> dest_path<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"任务完成！"</span><span class="token punctuation">)</span>


</code></pre> 
<h5><a id="_75"></a>整理数据文件夹结构</h5> 
<p>我们需要将数据集整理为以下结构：</p> 
<pre><code>-----dataset
	-----dataset
           |-----train
           |   |-----class1
           |   |-----class2
           |   |-----.......
           |
           |-----valid
           |   |-----class1
           |   |-----class2
           |   |-----.......
           |
           |-----test
           |   |-----class1
           |   |-----class2
           |   |-----.......

</code></pre> 
<h5><a id="_98"></a>模型训练</h5> 
<pre><code> Epoch   gpu_mem       box       obj       cls    labels  img_size
 1/200     20.8G   0.01576   0.01955  0.007536        22      1280: 100%|██████████| 849/849 [14:42&lt;00:00,  1.04s/it]
           Class     Images     Labels          P          R     mAP@.5 mAP@.5:.95: 100%|██████████| 213/213 [01:14&lt;00:00,  2.87it/s]
             all       3395      17314      0.994      0.957      0.0957      0.0843

 Epoch   gpu_mem       box       obj       cls    labels  img_size
 2/200     20.8G   0.01578   0.01923  0.007006        22      1280: 100%|██████████| 849/849 [14:44&lt;00:00,  1.04s/it]
           Class     Images     Labels          P          R     mAP@.5 mAP@.5:.95: 100%|██████████| 213/213 [01:12&lt;00:00,  2.95it/s]
             all       3395      17314      0.996      0.956      0.0957      0.0845

 Epoch   gpu_mem       box       obj       cls    labels  img_size
 3/200     20.8G   0.01561    0.0191  0.006895        27      1280: 100%|██████████| 849/849 [10:56&lt;00:00,  1.29it/s]
           Class     Images     Labels          P          R     mAP@.5 mAP@.5:.95: 100%|███████   | 187/213 [00:52&lt;00:00,  4.04it/s]
             all       3395      17314      0.996      0.957      0.0957      0.0845
</code></pre> 
<h2><a id="5_117"></a>5.核心代码讲解</h2> 
<h5><a id="51_cls_hrnetpy_119"></a>5.1 cls_hrnet.py</h5> 
<pre><code class="prism language-python">

<span class="token keyword">def</span> <span class="token function">conv3x3</span><span class="token punctuation">(</span>in_planes<span class="token punctuation">,</span> out_planes<span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""3x3 convolution with padding"""</span>
    <span class="token keyword">return</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_planes<span class="token punctuation">,</span> out_planes<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span>stride<span class="token punctuation">,</span>
                     padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">BasicBlock</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    expansion <span class="token operator">=</span> <span class="token number">1</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> inplanes<span class="token punctuation">,</span> planes<span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> downsample<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>BasicBlock<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> conv3x3<span class="token punctuation">(</span>inplanes<span class="token punctuation">,</span> planes<span class="token punctuation">,</span> stride<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bn1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>planes<span class="token punctuation">,</span> momentum<span class="token operator">=</span>BN_MOMENTUM<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>relu <span class="token operator">=</span> nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv2 <span class="token operator">=</span> conv3x3<span class="token punctuation">(</span>planes<span class="token punctuation">,</span> planes<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bn2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>planes<span class="token punctuation">,</span> momentum<span class="token operator">=</span>BN_MOMENTUM<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>downsample <span class="token operator">=</span> downsample
        self<span class="token punctuation">.</span>stride <span class="token operator">=</span> stride

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        residual <span class="token operator">=</span> x

        out <span class="token operator">=</span> self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        out <span class="token operator">=</span> self<span class="token punctuation">.</span>bn1<span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        out <span class="token operator">=</span> self<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>out<span class="token punctuation">)</span>

        out <span class="token operator">=</span> self<span class="token punctuation">.</span>conv2<span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        out <span class="token operator">=</span> self<span class="token punctuation">.</span>bn2<span class="token punctuation">(</span>out<span class="token punctuation">)</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>downsample <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            residual <span class="token operator">=</span> self<span class="token punctuation">.</span>downsample<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

        out <span class="token operator">+=</span> residual
        out <span class="token operator">=</span> self<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>out<span class="token punctuation">)</span>

        <span class="token keyword">return</span> out


<span class="token keyword">class</span> <span class="token class-name">Bottleneck</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    expansion <span class="token operator">=</span> <span class="token number">4</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> inplanes<span class="token punctuation">,</span> planes<span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> downsample<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>Bottleneck<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>inplanes<span class="token punctuation">,</span> planes<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bn1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>planes<span class="token punctuation">,</span> momentum<span class="token operator">=</span>BN_MOMENTUM<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>planes<span class="token punctuation">,</span> planes<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span>stride<span class="token punctuation">,</span>
                               padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bn2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>planes<span class="token punctuation">,</span> momentum<span class="token operator">=</span>BN_MOMENTUM<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>planes<span class="token punctuation">,</span> planes <span class="token operator">*</span> self<span class="token punctuation">.</span>expansion<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
                               bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bn3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>planes <span class="token operator">*</span> self<span class="token punctuation">.</span>expansion<span class="token punctuation">,</span>
                               momentum<span class="token operator">=</span>BN_MOMENTUM<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>relu <span class="token operator">=</span> nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>downsample <span class="token operator">=</span> downsample
        self<span class="token punctuation">.</span>stride <span class="token operator">=</span> stride

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        residual <span class="token operator">=</span> x

        out <span class="token operator">=</span> self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        out <span class="token operator">=</span> self<span class="token punctuation">.</span>bn1<span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        out <span class="token operator">=</span> self<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>out<span class="token punctuation">)</span>

        out <span class="token operator">=</span> self<span class="token punctuation">.</span>conv2<span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        out <span class="token operator">=</span> self<span class="token punctuation">.</span>bn2<span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        out <span class="token operator">=</span> self<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>out<span class="token punctuation">)</span>

        out <span class="token operator">=</span> self<span class="token punctuation">.</span>conv3<span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        out <span class="token operator">=</span> self<span class="token punctuation">.</span>bn3<span class="token punctuation">(</span>out<span class="token punctuation">)</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>downsample <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            residual <span class="token operator">=</span> self<span class="token punctuation">.</span>downsample<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

        out <span class="token operator">+=</span> residual
        out <span class="token operator">=</span> self<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>out<span class="token punctuation">)</span>

        <span class="token keyword">return</span> out


<span class="token keyword">class</span> <span class="token class-name">HighResolutionModule</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> num_branches<span class="token punctuation">,</span> blocks<span class="token punctuation">,</span> num_blocks<span class="token punctuation">,</span> num_inchannels<span class="token punctuation">,</span>
                 num_channels<span class="token punctuation">,</span> fuse_method<span class="token punctuation">,</span> multi_scale_output<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>HighResolutionModule<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_check_branches<span class="token punctuation">(</span>
            num_branches<span class="token punctuation">,</span> blocks<span class="token punctuation">,</span> num_blocks<span class="token punctuation">,</span> num_inchannels<span class="token punctuation">,</span> num_channels<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>num_inchannels <span class="token operator">=</span> num_inchannels
        self<span class="token punctuation">.</span>fuse_method <span class="token operator">=</span> fuse_method
        self<span class="token punctuation">.</span>num_branches <span class="token operator">=</span> num_branches

        self<span class="token punctuation">.</span>multi_scale_output <span class="token operator">=</span> multi_scale_output

        self<span class="token punctuation">.</span>branches <span class="token operator">=</span> self<span class="token punctuation">.</span>_make_branches<span class="token punctuation">(</span>
            num_branches<span class="token punctuation">,</span> blocks<span class="token punctuation">,</span> num_blocks<span class="token punctuation">,</span> num_channels<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fuse_layers <span class="token operator">=</span> self<span class="token punctuation">.</span>_make_fuse_layers<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>relu <span class="token operator">=</span> nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_check_branches</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> num_branches<span class="token punctuation">,</span> blocks<span class="token punctuation">,</span> num_blocks<span class="token punctuation">,</span>
                        num_inchannels<span class="token punctuation">,</span> num_channels<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> num_branches <span class="token operator">!=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>num_blocks<span class="token punctuation">)</span><span class="token punctuation">:</span>
            error_msg <span class="token operator">=</span> <span class="token string">'NUM_BRANCHES({}) &lt;&gt; NUM_BLOCKS({})'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
                num_branches<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>num_blocks<span class="token punctuation">)</span><span class="token punctuation">)</span>
            logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span>error_msg<span class="token punctuation">)</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span>error_msg<span class="token punctuation">)</span>

        <span class="token keyword">if</span> num_branches <span class="token operator">!=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>num_channels<span class="token punctuation">)</span><span class="token punctuation">:</span>
            error_msg <span class="token operator">=</span> <span class="token string">'NUM_BRANCHES({}) &lt;&gt; NUM_CHANNELS({})'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
                num_branches<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>num_channels<span class="token punctuation">)</span><span class="token punctuation">)</span>
            logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span>error_msg<span class="token punctuation">)</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span>error_msg<span class="token punctuation">)</span>

        <span class="token keyword">if</span> num_branches <span class="token operator">!=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>num_inchannels<span class="token punctuation">)</span><span class="token punctuation">:</span>
            error_msg <span class="token operator">=</span> <span class="token string">'NUM_BRANCHES({}) &lt;&gt; NUM_INCHANNELS({})'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
                num_branches<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>num_inchannels<span class="token punctuation">)</span><span class="token punctuation">)</span>
            logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span>error_msg<span class="token punctuation">)</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span>error_msg<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_make_one_branch</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> branch_index<span class="token punctuation">,</span> block<span class="token punctuation">,</span> num_blocks<span class="token punctuation">,</span> num_channels<span class="token punctuation">,</span>
                         stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        downsample <span class="token operator">=</span> <span class="token boolean">None</span>
        <span class="token keyword">if</span> stride <span class="token operator">!=</span> <span class="token number">1</span> <span class="token keyword">or</span> \
           self<span class="token punctuation">.</span>num_inchannels<span class="token punctuation">[</span>branch_index<span class="token punctuation">]</span> <span class="token operator">!=</span> num_channels<span class="token punctuation">[</span>branch_index<span class="token punctuation">]</span> <span class="token operator">*</span> block<span class="token punctuation">.</span>expansion<span class="token punctuation">:</span>
            downsample <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
                nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>self<span class="token punctuation">.</span>num_inchannels<span class="token punctuation">[</span>branch_index<span class="token punctuation">]</span><span class="token punctuation">,</span>
                          num_channels<span class="token punctuation">[</span>branch_index<span class="token punctuation">]</span> <span class="token operator">*</span> block<span class="token punctuation">.</span>expansion<span class="token punctuation">,</span>
                          kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> stride<span class="token operator">=</span>stride<span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>num_channels<span class="token punctuation">[</span>branch_index<span class="token punctuation">]</span> <span class="token operator">*</span> block<span class="token punctuation">.</span>expansion<span class="token punctuation">,</span>
                            momentum<span class="token operator">=</span>BN_MOMENTUM<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span>

        layers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        layers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>block<span class="token punctuation">(</span>self<span class="token punctuation">.</span>num_inchannels<span class="token punctuation">[</span>branch_index<span class="token punctuation">]</span><span class="token punctuation">,</span>
                            num_channels<span class="token punctuation">[</span>branch_index<span class="token punctuation">]</span><span class="token punctuation">,</span> stride<span class="token punctuation">,</span> downsample<span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>num_inchannels<span class="token punctuation">[</span>branch_index<span class="token punctuation">]</span> <span class="token operator">=</span> \
            num_channels<span class="token punctuation">[</span>branch_index<span class="token punctuation">]</span> <span class="token operator">*</span> block<span class="token punctuation">.</span>expansion
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> num_blocks<span class="token punctuation">[</span>branch_index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            layers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>block<span class="token punctuation">(</span>self<span class="token punctuation">.</span>num_inchannels<span class="token punctuation">[</span>branch_index<span class="token punctuation">]</span><span class="token punctuation">,</span>
                                num_channels<span class="token punctuation">[</span>branch_index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span><span class="token operator">*</span>layers<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_make_branches</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> num_branches<span class="token punctuation">,</span> block<span class="token punctuation">,</span> num_blocks<span class="token punctuation">,</span> num_channels<span class="token punctuation">)</span><span class="token punctuation">:</span>
        branches <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_branches<span class="token punctuation">)</span><span class="token punctuation">:</span>
            branches<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
                self<span class="token punctuation">.</span>_make_one_branch<span class="token punctuation">(</span>i<span class="token punctuation">,</span> block<span class="token punctuation">,</span> num_blocks<span class="token punctuation">,</span> num_channels<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> nn<span class="token punctuation">.</span>ModuleList<span class="token punctuation">(</span>branches<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_make_fuse_layers</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>num_branches <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>

        num_branches <span class="token operator">=</span> self<span class="token punctuation">.</span>num_branches
        num_inchannels <span class="token operator">=</span> self<span class="token punctuation">.</span>num_inchannels
        fuse_layers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_branches <span class="token keyword">if</span> self<span class="token punctuation">.</span>multi_scale_output <span class="token keyword">else</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            fuse_layer <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_branches<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> j <span class="token operator">&gt;</span> i<span class="token punctuation">:</span>
                    fuse_layer<span class="token punctuation">.</span>append<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
                        nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>num_inchannels<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span>
                                  num_inchannels<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
                                  <span class="token number">1</span><span class="token punctuation">,</span>
                                  <span class="token number">1</span><span class="token punctuation">,</span>
                                  <span class="token number">0</span><span class="token punctuation">,</span>
                                  bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>num_inchannels<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> 
                                       momentum<span class="token operator">=</span>BN_MOMENTUM<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        nn<span class="token punctuation">.</span>Upsample<span class="token punctuation">(</span>scale_factor<span class="token operator">=</span><span class="token number">2</span><span class="token operator">**</span><span class="token punctuation">(</span>j<span class="token operator">-</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'nearest'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">elif</span> j <span class="token operator">==</span> i<span class="token punctuation">:</span>
                    fuse_layer<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    conv3x3s <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
                    <span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>i<span class="token operator">-</span>j<span class="token punctuation">)</span><span class="token punctuation">:</span>
                        <span class="token keyword">if</span> k <span class="token operator">==</span> i <span class="token operator">-</span> j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">:</span>
                            num_outchannels_conv3x3 <span class="token operator">=</span> num_inchannels<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                            conv3x3s<span class="token punctuation">.</span>append<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
                                nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>num_inchannels<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span>
                                          num_outchannels_conv3x3<span class="token punctuation">,</span>
                                          <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>num_outchannels_conv3x3<span class="token punctuation">,</span> 
                                            momentum<span class="token operator">=</span>BN_MOMENTUM<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token keyword">else</span><span class="token punctuation">:</span>
                            num_outchannels_conv3x3 <span class="token operator">=</span> num_inchannels<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
                            conv3x3s<span class="token punctuation">.</span>append<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
                                nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>num_inchannels<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span>
                                          num_outchannels_conv3x3<span class="token punctuation">,</span>
                                          <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>num_outchannels_conv3x3<span class="token punctuation">,</span>
                                            momentum<span class="token operator">=</span>BN_MOMENTUM<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    fuse_layer<span class="token punctuation">.</span>append<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span><span class="token operator">*</span>conv3x3s<span class="token punctuation">)</span><span class="token punctuation">)</span>
            fuse_layers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>ModuleList<span class="token punctuation">(</span>fuse_layer<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> nn<span class="token punctuation">.</span>ModuleList<span class="token punctuation">(</span>fuse_layers<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">get_num_inchannels</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>num_inchannels

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>num_branches <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>branches<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>num_branches<span class="token punctuation">)</span><span class="token punctuation">:</span>
            x<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>branches<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>

        x_fuse <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>fuse_layers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            y <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">else</span> self<span class="token punctuation">.</span>fuse_layers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_branches<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> i <span class="token operator">==</span> j<span class="token punctuation">:</span>
                    y <span class="token operator">=</span> y <span class="token operator">+</span> x<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    y <span class="token operator">=</span> y <span class="token operator">+</span> self<span class="token punctuation">.</span>fuse_layers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">(</span>x<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span>
            x_fuse<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> x_fuse


blocks_dict <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'BASIC'</span><span class="token punctuation">:</span> BasicBlock<span class="token punctuation">,</span>
    <span class="token string">'BOTTLENECK'</span><span class="token punctuation">:</span> Bottleneck
<span class="token punctuation">}</span>


<span class="token keyword">class</span> <span class="token class-name">HighResolutionNet</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> cfg<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>HighResolutionNet<span class="token punctuation">,</span> self
</code></pre> 
<p>该程序文件是一个HRNet模型的实现，包含了多个模块和类。</p> 
<p>文件中定义了一些辅助函数和常量，如<code>conv3x3</code>函数用于创建3x3的卷积层，<code>BasicBlock</code>和<code>Bottleneck</code>类分别定义了HRNet中的基本块和瓶颈块。</p> 
<p><code>HighResolutionModule</code>类定义了HRNet的高分辨率模块，其中包含了多个分支和融合层。<code>_make_one_branch</code>函数用于创建一个分支，<code>_make_branches</code>函数用于创建多个分支，<code>_make_fuse_layers</code>函数用于创建融合层。<code>forward</code>函数用于前向传播。</p> 
<p><code>HighResolutionNet</code>类定义了整个HRNet模型，包含了多个阶段和层。<code>__init__</code>函数用于初始化模型，<code>_make_layer</code>函数用于创建一个阶段，<code>forward</code>函数用于前向传播。</p> 
<p>总体来说，该程序文件实现了HRNet模型的各个组件和整体结构。</p> 
<h5><a id="52_evaluatepy_366"></a>5.2 evaluate.py</h5> 
<pre><code class="prism language-python">

<span class="token keyword">class</span> <span class="token class-name">Accuracy</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> topk<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>topk <span class="token operator">=</span> topk

    <span class="token keyword">def</span> <span class="token function">compute</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> output<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Computes the precision@k for the specified values of k"""</span>
        <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            maxk <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>topk<span class="token punctuation">)</span>
            batch_size <span class="token operator">=</span> target<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

            _<span class="token punctuation">,</span> pred <span class="token operator">=</span> output<span class="token punctuation">.</span>topk<span class="token punctuation">(</span>maxk<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
            pred <span class="token operator">=</span> pred<span class="token punctuation">.</span>t<span class="token punctuation">(</span><span class="token punctuation">)</span>
            correct <span class="token operator">=</span> pred<span class="token punctuation">.</span>eq<span class="token punctuation">(</span>target<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>expand_as<span class="token punctuation">(</span>pred<span class="token punctuation">)</span><span class="token punctuation">)</span>

            res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            <span class="token keyword">for</span> k <span class="token keyword">in</span> self<span class="token punctuation">.</span>topk<span class="token punctuation">:</span>
                correct_k <span class="token operator">=</span> correct<span class="token punctuation">[</span><span class="token punctuation">:</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> keepdim<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
                res<span class="token punctuation">.</span>append<span class="token punctuation">(</span>correct_k<span class="token punctuation">.</span>mul_<span class="token punctuation">(</span><span class="token number">100.0</span> <span class="token operator">/</span> batch_size<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> res
</code></pre> 
<p>这个程序文件名为evaluate.py，它包含了一个名为accuracy的函数。这个函数用于计算给定的输出和目标的准确率。具体来说，它计算了给定的topk值（默认为1）的准确率。</p> 
<p>函数首先使用torch.no_grad()上下文管理器，以确保在计算准确率时不会进行梯度计算。然后，它确定了最大的topk值和批次大小。接下来，它使用output.topk()函数找到输出中的前k个最大值，并将其转置。然后，它将预测值与目标值进行比较，并计算出预测正确的数量。</p> 
<p>最后，函数将计算的准确率以列表的形式返回。列表中的每个元素都是一个torch.Tensor对象，表示对应的topk值的准确率。这些准确率是通过将正确预测的数量除以批次大小并乘以100得到的。</p> 
<h5><a id="53_functionpy_400"></a>5.3 function.py</h5> 
<pre><code class="prism language-python">
<span class="token keyword">class</span> <span class="token class-name">AverageMeter</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Computes and stores the average and current value"""</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">reset</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>val <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>avg <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span><span class="token builtin">sum</span> <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">def</span> <span class="token function">update</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> val<span class="token punctuation">,</span> n<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>val <span class="token operator">=</span> val
        self<span class="token punctuation">.</span><span class="token builtin">sum</span> <span class="token operator">+=</span> val <span class="token operator">*</span> n
        self<span class="token punctuation">.</span>count <span class="token operator">+=</span> n
        self<span class="token punctuation">.</span>avg <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token builtin">sum</span> <span class="token operator">/</span> self<span class="token punctuation">.</span>count

<span class="token keyword">class</span> <span class="token class-name">Trainer</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> config<span class="token punctuation">,</span> train_loader<span class="token punctuation">,</span> model<span class="token punctuation">,</span> criterion<span class="token punctuation">,</span> optimizer<span class="token punctuation">,</span> epoch<span class="token punctuation">,</span> output_dir<span class="token punctuation">,</span> tb_log_dir<span class="token punctuation">,</span> writer_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>config <span class="token operator">=</span> config
        self<span class="token punctuation">.</span>train_loader <span class="token operator">=</span> train_loader
        self<span class="token punctuation">.</span>model <span class="token operator">=</span> model
        self<span class="token punctuation">.</span>criterion <span class="token operator">=</span> criterion
        self<span class="token punctuation">.</span>optimizer <span class="token operator">=</span> optimizer
        self<span class="token punctuation">.</span>epoch <span class="token operator">=</span> epoch
        self<span class="token punctuation">.</span>output_dir <span class="token operator">=</span> output_dir
        self<span class="token punctuation">.</span>tb_log_dir <span class="token operator">=</span> tb_log_dir
        self<span class="token punctuation">.</span>writer_dict <span class="token operator">=</span> writer_dict

    <span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        batch_time <span class="token operator">=</span> AverageMeter<span class="token punctuation">(</span><span class="token punctuation">)</span>
        data_time <span class="token operator">=</span> AverageMeter<span class="token punctuation">(</span><span class="token punctuation">)</span>
        losses <span class="token operator">=</span> AverageMeter<span class="token punctuation">(</span><span class="token punctuation">)</span>
        top1 <span class="token operator">=</span> AverageMeter<span class="token punctuation">(</span><span class="token punctuation">)</span>
        top5 <span class="token operator">=</span> AverageMeter<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># switch to train mode</span>
        self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>

        end <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">,</span> target<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>train_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># measure data loading time</span>
            data_time<span class="token punctuation">.</span>update<span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> end<span class="token punctuation">)</span>
            <span class="token comment">#target = target - 1 # Specific for imagenet</span>

            <span class="token comment"># compute output</span>
            output <span class="token operator">=</span> self<span class="token punctuation">.</span>model<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span>
            target <span class="token operator">=</span> target<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span>non_blocking<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

            loss <span class="token operator">=</span> self<span class="token punctuation">.</span>criterion<span class="token punctuation">(</span>output<span class="token punctuation">,</span> target<span class="token punctuation">)</span>

            <span class="token comment"># compute gradient and do update step</span>
            self<span class="token punctuation">.</span>optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
            loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token comment"># measure accuracy and record loss</span>
            losses<span class="token punctuation">.</span>update<span class="token punctuation">(</span>loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">input</span><span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

            prec1<span class="token punctuation">,</span> prec5 <span class="token operator">=</span> accuracy<span class="token punctuation">(</span>output<span class="token punctuation">,</span> target<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

            top1<span class="token punctuation">.</span>update<span class="token punctuation">(</span>prec1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">input</span><span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            top5<span class="token punctuation">.</span>update<span class="token punctuation">(</span>prec5<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">input</span><span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

            <span class="token comment"># measure elapsed time</span>
            batch_time<span class="token punctuation">.</span>update<span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> end<span class="token punctuation">)</span>
            end <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token keyword">if</span> i <span class="token operator">%</span> self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>PRINT_FREQ <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                msg <span class="token operator">=</span> <span class="token string">'Epoch: [{0}][{1}/{2}]\t'</span> \
                      <span class="token string">'Time {batch_time.val:.3f}s ({batch_time.avg:.3f}s)\t'</span> \
                      <span class="token string">'Speed {speed:.1f} samples/s\t'</span> \
                      <span class="token string">'Data {data_time.val:.3f}s ({data_time.avg:.3f}s)\t'</span> \
                      <span class="token string">'Loss {loss.val:.5f} ({loss.avg:.5f})\t'</span> \
                      <span class="token string">'Accuracy@1 {top1.val:.3f} ({top1.avg:.3f})\t'</span> \
                      <span class="token string">'Accuracy@5 {top5.val:.3f} ({top5.avg:.3f})\t'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
                          self<span class="token punctuation">.</span>epoch<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>train_loader<span class="token punctuation">)</span><span class="token punctuation">,</span> batch_time<span class="token operator">=</span>batch_time<span class="token punctuation">,</span>
                          speed<span class="token operator">=</span><span class="token builtin">input</span><span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">/</span>batch_time<span class="token punctuation">.</span>val<span class="token punctuation">,</span>
                          data_time<span class="token operator">=</span>data_time<span class="token punctuation">,</span> loss<span class="token operator">=</span>losses<span class="token punctuation">,</span> top1<span class="token operator">=</span>top1<span class="token punctuation">,</span> top5<span class="token operator">=</span>top5<span class="token punctuation">)</span>
                logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>

                <span class="token keyword">if</span> self<span class="token punctuation">.</span>writer_dict<span class="token punctuation">:</span>
                    writer <span class="token operator">=</span> self<span class="token punctuation">.</span>writer_dict<span class="token punctuation">[</span><span class="token string">'writer'</span><span class="token punctuation">]</span>
                    global_steps <span class="token operator">=</span> self<span class="token punctuation">.</span>writer_dict<span class="token punctuation">[</span><span class="token string">'train_global_steps'</span><span class="token punctuation">]</span>
                    writer<span class="token punctuation">.</span>add_scalar<span class="token punctuation">(</span><span class="token string">'train_loss'</span><span class="token punctuation">,</span> losses<span class="token punctuation">.</span>val<span class="token punctuation">,</span> global_steps<span class="token punctuation">)</span>
                    writer<span class="token punctuation">.</span>add_scalar<span class="token punctuation">(</span><span class="token string">'train_top1'</span><span class="token punctuation">,</span> top1<span class="token punctuation">.</span>val<span class="token punctuation">,</span> global_steps<span class="token punctuation">)</span>
                    self<span class="token punctuation">.</span>writer_dict<span class="token punctuation">[</span><span class="token string">'train_global_steps'</span><span class="token punctuation">]</span> <span class="token operator">=</span> global_steps <span class="token operator">+</span> <span class="token number">1</span>

<span class="token keyword">class</span> <span class="token class-name">Validator</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> config<span class="token punctuation">,</span> val_loader<span class="token punctuation">,</span> model<span class="token punctuation">,</span> criterion<span class="token punctuation">,</span> output_dir<span class="token punctuation">,</span> tb_log_dir<span class="token punctuation">,</span> writer_dict<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>config <span class="token operator">=</span> config
        self<span class="token punctuation">.</span>val_loader <span class="token operator">=</span> val_loader
        self<span class="token punctuation">.</span>model <span class="token operator">=</span> model
        self<span class="token punctuation">.</span>criterion <span class="token operator">=</span> criterion
        self<span class="token punctuation">.</span>output_dir <span class="token operator">=</span> output_dir
        self<span class="token punctuation">.</span>tb_log_dir <span class="token operator">=</span> tb_log_dir
        self<span class="token punctuation">.</span>writer_dict <span class="token operator">=</span> writer_dict

    <span class="token keyword">def</span> <span class="token function">validate</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        batch_time <span class="token operator">=</span> AverageMeter<span class="token punctuation">(</span><span class="token punctuation">)</span>
        losses <span class="token operator">=</span> AverageMeter<span class="token punctuation">(</span><span class="token punctuation">)</span>
        top1 <span class="token operator">=</span> AverageMeter<span class="token punctuation">(</span><span class="token punctuation">)</span>
        top5 <span class="token operator">=</span> AverageMeter<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># switch to evaluate mode</span>
        self<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            end <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">,</span> target<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>val_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token comment"># compute output</span>
                output <span class="token operator">=</span> self<span class="token punctuation">.</span>model<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span>

                target <span class="token operator">=</span> target<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span>non_blocking<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

                loss <span class="token operator">=</span> self<span class="token punctuation">.</span>criterion<span class="token punctuation">(</span>output<span class="token punctuation">,</span> target<span class="token punctuation">)</span>

                <span class="token comment"># measure accuracy and record loss</span>
                losses<span class="token punctuation">.</span>update<span class="token punctuation">(</span>loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">input</span><span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                prec1<span class="token punctuation">,</span> prec5 <span class="token operator">=</span> accuracy<span class="token punctuation">(</span>output<span class="token punctuation">,</span> target<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                top1<span class="token punctuation">.</span>update<span class="token punctuation">(</span>prec1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">input</span><span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                top5<span class="token punctuation">.</span>update<span class="token punctuation">(</span>prec5<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">input</span><span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

                <span class="token comment"># measure elapsed time</span>
                batch_time<span class="token punctuation">.</span>update<span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> end<span class="token punctuation">)</span>
                end <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>

            msg <span class="token operator">=</span> <span class="token string">'Test: Time {batch_time.avg:.3f}\t'</span> \
                  <span class="token string">'Loss {loss.avg:.4f}\t'</span> \
                  <span class="token string">'Error@1 {error1:.3f}\t'</span> \
                  <span class="token string">'Error@5 {error5:.3f}\t'</span> \
                  <span class="token string">'Accuracy@1 {top1.avg:.3f}\t'</span> \
                  <span class="token string">'Accuracy@5 {top5.avg:.3f}\t'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
                      batch_time<span class="token operator">=</span>batch_time<span class="token punctuation">,</span> loss<span class="token operator">=</span>losses<span class="token punctuation">,</span> top1<span class="token operator">=</span>top1<span class="token punctuation">,</span> top5<span class="token operator">=</span>top5<span class="token punctuation">,</span>
                      error1<span class="token operator">=</span><span class="token number">100</span><span class="token operator">-</span>top1<span class="token punctuation">.</span>avg<span class="token punctuation">,</span> error5<span class="token operator">=</span><span class="token number">100</span><span class="token operator">-</span>top5<span class="token punctuation">.</span>avg<span class="token punctuation">)</span>
            logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>

            <span class="token keyword">if</span> self<span class="token punctuation">.</span>writer_dict<span class="token punctuation">:</span>
                writer <span class="token operator">=</span> self<span class="token punctuation">.</span>writer_dict<span class="token punctuation">[</span><span class="token string">'writer'</span><span class="token punctuation">]</span>
                global_steps <span class="token operator">=</span> self<span class="token punctuation">.</span>writer_dict<span class="token punctuation">[</span><span class="token string">'valid_global_steps'</span><span class="token punctuation">]</span>
                writer<span class="token punctuation">.</span>add_scalar<span class="token punctuation">(</span><span class="token string">'valid_loss'</span><span class="token punctuation">,</span> losses<span class="token punctuation">.</span>avg<span class="token punctuation">,</span> global_steps<span class="token punctuation">)</span>
                writer<span class="token punctuation">.</span>add_scalar<span class="token punctuation">(</span><span class="token string">'valid_top1'</span><span class="token punctuation">,</span> top1<span class="token punctuation">.</span>avg<span class="token punctuation">,</span> global_steps<span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>writer_dict<span class="token punctuation">[</span><span class="token string">'valid_global_steps'</span><span class="token punctuation">]</span> <span class="token operator">=</span> global_steps <span class="token operator">+</span> <span class="token number">1</span>

</code></pre> 
<p>这个程序文件名为model.py，主要功能是使用timm库中的模型来进行推理和计算模型的FLOPS和参数数量。</p> 
<p>程序首先导入了torch、timm和thop库。然后使用timm.list_models()函数列出了所有可用的模型，并打印出来。</p> 
<p>接下来，程序判断当前设备是否支持CUDA，并创建了一个大小为(1, 3, 640, 640)的随机输入张量dummy_input，并将其发送到设备上。</p> 
<p>然后，程序使用timm.create_model()函数创建了一个名为’hrnet_w64’的模型，设置pretrained为False，并只返回特征部分。接着将模型发送到设备上，并设置为评估模式。</p> 
<p>程序使用model.feature_info.channels()函数打印出模型的特征通道信息。然后，对dummy_input进行推理，并打印出每个特征的大小。</p> 
<p>最后，程序使用thop库的profile函数计算模型在给定输入上的FLOPS和参数数量，并使用clever_format函数格式化输出。最后打印出总的FLOPS和参数数量。</p> 
<h5><a id="53_trainpy_566"></a>5.3 train.py</h5> 
<pre><code class="prism language-python">

<span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>hyp<span class="token punctuation">,</span>  <span class="token comment"># path/to/hyp.yaml or hyp dictionary</span>
          opt<span class="token punctuation">,</span>
          device<span class="token punctuation">,</span>
          callbacks
          <span class="token punctuation">)</span><span class="token punctuation">:</span>
    save_dir<span class="token punctuation">,</span> epochs<span class="token punctuation">,</span> batch_size<span class="token punctuation">,</span> weights<span class="token punctuation">,</span> single_cls<span class="token punctuation">,</span> evolve<span class="token punctuation">,</span> data<span class="token punctuation">,</span> cfg<span class="token punctuation">,</span> resume<span class="token punctuation">,</span> noval<span class="token punctuation">,</span> nosave<span class="token punctuation">,</span> workers<span class="token punctuation">,</span> freeze<span class="token punctuation">,</span> <span class="token operator">=</span> \
        Path<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>save_dir<span class="token punctuation">)</span><span class="token punctuation">,</span> opt<span class="token punctuation">.</span>epochs<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>batch_size<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>weights<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>single_cls<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>evolve<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>data<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>cfg<span class="token punctuation">,</span> \
        opt<span class="token punctuation">.</span>resume<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>noval<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>nosave<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>workers<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>freeze

    <span class="token comment"># Directories</span>
    w <span class="token operator">=</span> save_dir <span class="token operator">/</span> <span class="token string">'weights'</span>  <span class="token comment"># weights dir</span>
    <span class="token punctuation">(</span>w<span class="token punctuation">.</span>parent <span class="token keyword">if</span> evolve <span class="token keyword">else</span> w<span class="token punctuation">)</span><span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>parents<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># make dir</span>
    last<span class="token punctuation">,</span> best <span class="token operator">=</span> w <span class="token operator">/</span> <span class="token string">'last.pt'</span><span class="token punctuation">,</span> w <span class="token operator">/</span> <span class="token string">'best.pt'</span>

    <span class="token comment"># Hyperparameters</span>
    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>hyp<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>hyp<span class="token punctuation">,</span> errors<span class="token operator">=</span><span class="token string">'ignore'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            hyp <span class="token operator">=</span> yaml<span class="token punctuation">.</span>safe_load<span class="token punctuation">(</span>f<span class="token punctuation">)</span>  <span class="token comment"># load hyps dict</span>
    LOGGER<span class="token punctuation">.</span>info<span class="token punctuation">(</span>colorstr<span class="token punctuation">(</span><span class="token string">'hyperparameters: '</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">', '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>k<span class="token punctuation">}</span></span><span class="token string">=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>v<span class="token punctuation">}</span></span><span class="token string">'</span></span> <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> hyp<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># Save run settings</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>save_dir <span class="token operator">/</span> <span class="token string">'hyp.yaml'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        yaml<span class="token punctuation">.</span>safe_dump<span class="token punctuation">(</span>hyp<span class="token punctuation">,</span> f<span class="token punctuation">,</span> sort_keys<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>save_dir <span class="token operator">/</span> <span class="token string">'opt.yaml'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        yaml<span class="token punctuation">.</span>safe_dump<span class="token punctuation">(</span><span class="token builtin">vars</span><span class="token punctuation">(</span>opt<span class="token punctuation">)</span><span class="token punctuation">,</span> f<span class="token punctuation">,</span> sort_keys<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    data_dict <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token comment"># Loggers</span>
    <span class="token keyword">if</span> RANK <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        loggers <span class="token operator">=</span> Loggers<span class="token punctuation">(</span>save_dir<span class="token punctuation">,</span> weights<span class="token punctuation">,</span> opt<span class="token punctuation">,</span> hyp<span class="token punctuation">,</span> LOGGER<span class="token punctuation">)</span>  <span class="token comment"># loggers instance</span>
        <span class="token keyword">if</span> loggers<span class="token punctuation">.</span>wandb<span class="token punctuation">:</span>
            data_dict <span class="token operator">=</span> loggers<span class="token punctuation">.</span>wandb<span class="token punctuation">.</span>data_dict
            <span class="token keyword">if</span> resume<span class="token punctuation">:</span>
                weights<span class="token punctuation">,</span> epochs<span class="token punctuation">,</span> hyp <span class="token operator">=</span> opt<span class="token punctuation">.</span>weights<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>epochs<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>hyp

        <span class="token comment"># Register actions</span>
        <span class="token keyword">for</span> k <span class="token keyword">in</span> methods<span class="token punctuation">(</span>loggers<span class="token punctuation">)</span><span class="token punctuation">:</span>
            callbacks<span class="token punctuation">.</span>register_action<span class="token punctuation">(</span>k<span class="token punctuation">,</span> callback<span class="token operator">=</span><span class="token builtin">getattr</span><span class="token punctuation">(</span>loggers<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># Config</span>
    plots <span class="token operator">=</span> <span class="token keyword">not</span> evolve  <span class="token comment"># create plots</span>
    cuda <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token builtin">type</span> <span class="token operator">!=</span> <span class="token string">'cpu'</span>
    init_seeds<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> RANK<span class="token punctuation">)</span>
    <span class="token keyword">with</span> torch_distributed_zero_first<span class="token punctuation">(</span>LOCAL_RANK<span class="token punctuation">)</span><span class="token punctuation">:</span>
        data_dict <span class="token operator">=</span> data_dict <span class="token keyword">or</span> check_dataset<span class="token punctuation">(</span>data<span class="token punctuation">)</span>  <span class="token comment"># check if None</span>
    train_path<span class="token punctuation">,</span> val_path <span class="token operator">=</span> data_dict<span class="token punctuation">[</span><span class="token string">'train'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data_dict<span class="token punctuation">[</span><span class="token string">'val'</span><span class="token punctuation">]</span>
    nc <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">if</span> single_cls <span class="token keyword">else</span> <span class="token builtin">int</span><span class="token punctuation">(</span>data_dict<span class="token punctuation">[</span><span class="token string">'nc'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># number of classes</span>
    names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'item'</span><span class="token punctuation">]</span> <span class="token keyword">if</span> single_cls <span class="token keyword">and</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data_dict<span class="token punctuation">[</span><span class="token string">'names'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span> <span class="token keyword">else</span> data_dict<span class="token punctuation">[</span><span class="token string">'names'</span><span class="token punctuation">]</span>  <span class="token comment"># class names</span>
    <span class="token keyword">assert</span> <span class="token builtin">len</span><span class="token punctuation">(</span>names<span class="token punctuation">)</span> <span class="token operator">==</span> nc<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>names<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> names found for nc=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>nc<span class="token punctuation">}</span></span><span class="token string"> dataset in </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>data<span class="token punctuation">}</span></span><span class="token string">'</span></span>  <span class="token comment"># check</span>
    is_coco <span class="token operator">=</span> data<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'coco.yaml'</span><span class="token punctuation">)</span> <span class="token keyword">and</span> nc <span class="token operator">==</span> <span class="token number">80</span>  <span class="token comment"># COCO dataset</span>

    <span class="token comment"># Model</span>
    check_suffix<span class="token punctuation">(</span>weights<span class="token punctuation">,</span> <span class="token string">'.pt'</span><span class="token punctuation">)</span>  <span class="token comment"># check weights</span>
    pretrained <span class="token operator">=</span> weights<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'.pt'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> pretrained<span class="token punctuation">:</span>
        <span class="token keyword">with</span> torch_distributed_zero_first<span class="token punctuation">(</span>LOCAL_RANK<span class="token punctuation">)</span><span class="token punctuation">:</span>
            weights <span class="token operator">=</span> attempt_download<span class="token punctuation">(</span>weights<span class="token punctuation">)</span>  <span class="token comment"># download if not found locally</span>
        ckpt <span class="token operator">=</span> torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>weights<span class="token punctuation">,</span> map_location<span class="token operator">=</span>device<span class="token punctuation">)</span>  <span class="token comment"># load checkpoint</span>
        model <span class="token operator">=</span> Model<span class="token punctuation">(</span>cfg <span class="token keyword">or</span> ckpt<span class="token punctuation">[</span><span class="token string">'model'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>yaml<span class="token punctuation">,</span> ch<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> nc<span class="token operator">=</span>nc<span class="token punctuation">,</span> anchors<span class="token operator">=</span>hyp<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'anchors'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>  <span class="token comment"># create</span>
        exclude <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'anchor'</span><span class="token punctuation">]</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cfg <span class="token keyword">or</span> hyp<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'anchors'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token keyword">not</span> resume <span class="token keyword">else</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># exclude keys</span>
        csd <span class="token operator">=</span> ckpt<span class="token punctuation">[</span><span class="token string">'model'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># checkpoint state_dict as FP32</span>
        csd <span class="token operator">=</span> intersect_dicts<span class="token punctuation">(</span>csd<span class="token punctuation">,</span> model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exclude<span class="token operator">=</span>exclude<span class="token punctuation">)</span>  <span class="token comment"># intersect</span>
        model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>csd<span class="token punctuation">,</span> strict<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>  <span class="token comment"># load</span>
        LOGGER<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Transferred </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>csd<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> items from </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>weights<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>  <span class="token comment"># report</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        model <span class="token operator">=</span> Model<span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> ch<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> nc<span class="token operator">=</span>nc<span class="token punctuation">,</span> anchors<span class="token operator">=</span>hyp<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'anchors'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>  <span class="token comment"># create</span>

    <span class="token comment"># Freeze</span>
    freeze <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'model.</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>x<span class="token punctuation">}</span></span><span class="token string">.'</span></span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>freeze<span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment"># layers to freeze</span>
    <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> model<span class="token punctuation">.</span>named_parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        v<span class="token punctuation">.</span>requires_grad <span class="token operator">=</span> <span class="token boolean">True</span>  <span class="token comment"># train all layers</span>
        <span class="token keyword">if</span> <span class="token builtin">any</span><span class="token punctuation">(</span>x <span class="token keyword">in</span> k <span class="token keyword">for</span> x <span class="token keyword">in</span> freeze<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'freezing </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>k<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
            v<span class="token punctuation">.</span>requires_grad <span class="token operator">=</span> <span class="token boolean">False</span>

    <span class="token comment"># Image size</span>
    gs <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>stride<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>  <span class="token comment"># grid size (max stride)</span>
    imgsz <span class="token operator">=</span> check_img_size<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>imgsz<span class="token punctuation">,</span> gs<span class="token punctuation">,</span> floor<span class="token operator">=</span>gs <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># verify imgsz is gs-multiple</span>

    <span class="token comment"># Batch size</span>
    <span class="token keyword">if</span> RANK <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">and</span> batch_size <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>  <span class="token comment"># single-GPU only, estimate best batch size</span>
        batch_size <span class="token operator">=</span> check_train_batch_size<span class="token punctuation">(</span>model<span class="token punctuation">,</span> imgsz<span class="token punctuation">)</span>

    <span class="token comment"># Optimizer</span>
    nbs <span class="token operator">=</span> <span class="token number">64</span>  <span class="token comment"># nominal batch size</span>
    accumulate <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>nbs <span class="token operator">/</span> batch_size<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># accumulate loss before optimizing</span>
    hyp<span class="token punctuation">[</span><span class="token string">'weight_decay'</span><span class="token punctuation">]</span> <span class="token operator">*=</span> batch_size <span class="token operator">*</span> accumulate <span class="token operator">/</span> nbs  <span class="token comment"># scale weight_decay</span>
    LOGGER<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Scaled weight_decay = </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>hyp<span class="token punctuation">[</span><span class="token string">'weight_decay'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    g0<span class="token punctuation">,</span> g1<span class="token punctuation">,</span> g2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># optimizer parameter groups</span>
    <span class="token keyword">for</span> v <span class="token keyword">in</span> model<span class="token punctuation">.</span>modules<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token string">'bias'</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>bias<span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># bias</span>
            g2<span class="token punctuation">.</span>append<span class="token punctuation">(</span>v<span class="token punctuation">.</span>bias<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># weight (no decay)</span>
            g0<span class="token punctuation">.</span>append<span class="token punctuation">(</span>v<span class="token punctuation">.</span>weight<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token string">'weight'</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># weight (with decay)</span>
            g1<span class="token punctuation">.</span>append<span class="token punctuation">(</span>v<span class="token punctuation">.</span>weight<span class="token punctuation">)</span>

    <span class="token keyword">if</span> opt<span class="token punctuation">.</span>adam<span class="token punctuation">:</span>
        optimizer <span class="token operator">=</span> Adam<span class="token punctuation">(</span>g0<span class="token punctuation">,</span> lr<span class="token operator">=</span>hyp<span class="token punctuation">[</span><span class="token string">'lr0'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> betas<span class="token operator">=</span><span class="token punctuation">(</span>hyp<span class="token punctuation">[</span><span class="token string">'momentum'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0.999</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># adjust beta1 to momentum</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        optimizer <span class="token operator">=</span> SGD<span class="token punctuation">(</span>g0<span class="token punctuation">,</span> lr<span class="token operator">=</span>hyp<span class="token punctuation">[</span><span class="token string">'lr0'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> momentum<span class="token operator">=</span>hyp<span class="token punctuation">[</span><span class="token string">'momentum'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> nesterov<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    optimizer<span class="token punctuation">.</span>add_param_group<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'params'</span><span class="token punctuation">:</span> g1<span class="token punctuation">,</span> <span class="token string">'weight_decay'</span><span class="token punctuation">:</span> hyp<span class="token punctuation">[</span><span class="token string">'weight_decay'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment"># add g1 with weight_decay</span>
    optimizer<span class="token punctuation">.</span>add_param_group<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'params'</span><span class="token punctuation">:</span> g2<span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment"># add g2 (biases)</span>
    LOGGER<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>colorstr<span class="token punctuation">(</span><span class="token string">'optimizer:'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">type</span><span class="token punctuation">(</span>optimizer<span class="token punctuation">)</span><span class="token punctuation">.</span>__name__<span class="token punctuation">}</span></span><span class="token string"> with parameter groups "</span></span>
                <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>g0<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> weight, </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>g1<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> weight (no decay), </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>g2<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> bias"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">del</span> g0<span class="token punctuation">,</span> g1<span class="token punctuation">,</span> g2

    <span class="token comment"># Scheduler</span>
    <span class="token keyword">if</span> opt<span class="token punctuation">.</span>linear_lr<span class="token punctuation">:</span>
        lf <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> x <span class="token operator">/</span> <span class="token punctuation">(</span>epochs <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span>
</code></pre> 
<p>该程序文件是用于训练一个YOLOv5模型的。它包含了训练的主要逻辑和一些辅助函数。程序文件的名称是train.py。该文件的主要功能是加载数据集、创建模型、定义优化器和学习率调度器、训练模型、保存模型等。程序文件使用了一些外部库，如argparse、logging、torch等。</p> 
<h5><a id="54_uipy_686"></a>5.4 ui.py</h5> 
<pre><code class="prism language-python">

<span class="token keyword">class</span> <span class="token class-name">ImageClassifier</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> weights<span class="token punctuation">,</span> source<span class="token punctuation">,</span> data<span class="token punctuation">,</span> imgsz<span class="token punctuation">,</span> device<span class="token punctuation">,</span> view_img<span class="token punctuation">,</span> save_txt<span class="token punctuation">,</span> nosave<span class="token punctuation">,</span> augment<span class="token punctuation">,</span> visualize<span class="token punctuation">,</span> update<span class="token punctuation">,</span> project<span class="token punctuation">,</span> name<span class="token punctuation">,</span> exist_ok<span class="token punctuation">,</span> half<span class="token punctuation">,</span> dnn<span class="token punctuation">,</span> vid_stride<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>weights <span class="token operator">=</span> weights
        self<span class="token punctuation">.</span>source <span class="token operator">=</span> source
        self<span class="token punctuation">.</span>data <span class="token operator">=</span> data
        self<span class="token punctuation">.</span>imgsz <span class="token operator">=</span> imgsz
        self<span class="token punctuation">.</span>device <span class="token operator">=</span> device
        self<span class="token punctuation">.</span>view_img <span class="token operator">=</span> view_img
        self<span class="token punctuation">.</span>save_txt <span class="token operator">=</span> save_txt
        self<span class="token punctuation">.</span>nosave <span class="token operator">=</span> nosave
        self<span class="token punctuation">.</span>augment <span class="token operator">=</span> augment
        self<span class="token punctuation">.</span>visualize <span class="token operator">=</span> visualize
        self<span class="token punctuation">.</span>update <span class="token operator">=</span> update
        self<span class="token punctuation">.</span>project <span class="token operator">=</span> project
        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name
        self<span class="token punctuation">.</span>exist_ok <span class="token operator">=</span> exist_ok
        self<span class="token punctuation">.</span>half <span class="token operator">=</span> half
        self<span class="token punctuation">.</span>dnn <span class="token operator">=</span> dnn
        self<span class="token punctuation">.</span>vid_stride <span class="token operator">=</span> vid_stride

    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        source <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>source<span class="token punctuation">)</span>
        save_img <span class="token operator">=</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>nosave <span class="token keyword">and</span> <span class="token keyword">not</span> source<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'.txt'</span><span class="token punctuation">)</span>  <span class="token comment"># save inference images</span>
        is_file <span class="token operator">=</span> Path<span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">.</span>suffix<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token keyword">in</span> <span class="token punctuation">(</span>IMG_FORMATS <span class="token operator">+</span> VID_FORMATS<span class="token punctuation">)</span>
        is_url <span class="token operator">=</span> source<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'rtsp://'</span><span class="token punctuation">,</span> <span class="token string">'rtmp://'</span><span class="token punctuation">,</span> <span class="token string">'http://'</span><span class="token punctuation">,</span> <span class="token string">'https://'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        webcam <span class="token operator">=</span> source<span class="token punctuation">.</span>isnumeric<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">or</span> source<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'.streams'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token punctuation">(</span>is_url <span class="token keyword">and</span> <span class="token keyword">not</span> is_file<span class="token punctuation">)</span>
        screenshot <span class="token operator">=</span> source<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'screen'</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> is_url <span class="token keyword">and</span> is_file<span class="token punctuation">:</span>
            source <span class="token operator">=</span> check_file<span class="token punctuation">(</span>source<span class="token punctuation">)</span>  <span class="token comment"># download</span>

        <span class="token comment"># Directories</span>
        save_dir <span class="token operator">=</span> increment_path<span class="token punctuation">(</span>Path<span class="token punctuation">(</span>self<span class="token punctuation">.</span>project<span class="token punctuation">)</span> <span class="token operator">/</span> self<span class="token punctuation">.</span>name<span class="token punctuation">,</span> exist_ok<span class="token operator">=</span>self<span class="token punctuation">.</span>exist_ok<span class="token punctuation">)</span>  <span class="token comment"># increment run</span>
        <span class="token punctuation">(</span>save_dir <span class="token operator">/</span> <span class="token string">'labels'</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>save_txt <span class="token keyword">else</span> save_dir<span class="token punctuation">)</span><span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>parents<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># make dir</span>

        <span class="token comment"># Load model</span>
        device <span class="token operator">=</span> select_device<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
        model <span class="token operator">=</span> DetectMultiBackend<span class="token punctuation">(</span>self<span class="token punctuation">.</span>weights<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">,</span> dnn<span class="token operator">=</span>self<span class="token punctuation">.</span>dnn<span class="token punctuation">,</span> data<span class="token operator">=</span>self<span class="token punctuation">.</span>data<span class="token punctuation">,</span> fp16<span class="token operator">=</span>self<span class="token punctuation">.</span>half<span class="token punctuation">)</span>
        stride<span class="token punctuation">,</span> names<span class="token punctuation">,</span> pt <span class="token operator">=</span> model<span class="token punctuation">.</span>stride<span class="token punctuation">,</span> model<span class="token punctuation">.</span>names<span class="token punctuation">,</span> model<span class="token punctuation">.</span>pt
        imgsz <span class="token operator">=</span> check_img_size<span class="token punctuation">(</span>self<span class="token punctuation">.</span>imgsz<span class="token punctuation">,</span> s<span class="token operator">=</span>stride<span class="token punctuation">)</span>  <span class="token comment"># check image size</span>

        <span class="token comment"># Dataloader</span>
        bs <span class="token operator">=</span> <span class="token number">1</span>  <span class="token comment"># batch_size</span>
        <span class="token keyword">if</span> webcam<span class="token punctuation">:</span>
            view_img <span class="token operator">=</span> check_imshow<span class="token punctuation">(</span>warn<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
            dataset <span class="token operator">=</span> LoadStreams<span class="token punctuation">(</span>source<span class="token punctuation">,</span> img_size<span class="token operator">=</span>imgsz<span class="token punctuation">,</span> transforms<span class="token operator">=</span>classify_transforms<span class="token punctuation">(</span>imgsz<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> vid_stride<span class="token operator">=</span>self<span class="token punctuation">.</span>vid_stride<span class="token punctuation">)</span>
            bs <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>dataset<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> screenshot<span class="token punctuation">:</span>
            dataset <span class="token operator">=</span> LoadScreenshots<span class="token punctuation">(</span>source<span class="token punctuation">,</span> img_size<span class="token operator">=</span>imgsz<span class="token punctuation">,</span> stride<span class="token operator">=</span>stride<span class="token punctuation">,</span> auto<span class="token operator">=</span>pt<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            dataset <span class="token operator">=</span> LoadImages<span class="token punctuation">(</span>source<span class="token punctuation">,</span> img_size<span class="token operator">=</span>imgsz<span class="token punctuation">,</span> transforms<span class="token operator">=</span>classify_transforms<span class="token punctuation">(</span>imgsz<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> vid_stride<span class="token operator">=</span>self<span class="token punctuation">.</span>vid_stride<span class="token punctuation">)</span>
        vid_path<span class="token punctuation">,</span> vid_writer <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">*</span> bs<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">*</span> bs

        <span class="token comment"># Run inference</span>
        model<span class="token punctuation">.</span>warmup<span class="token punctuation">(</span>imgsz<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token keyword">if</span> pt <span class="token keyword">else</span> bs<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">*</span>imgsz<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># warmup</span>
        seen<span class="token punctuation">,</span> windows<span class="token punctuation">,</span> dt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>Profile<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Profile<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Profile<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> path<span class="token punctuation">,</span> im<span class="token punctuation">,</span> im0s<span class="token punctuation">,</span> vid_cap<span class="token punctuation">,</span> s <span class="token keyword">in</span> dataset<span class="token punctuation">:</span>
            <span class="token keyword">with</span> dt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                im <span class="token operator">=</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>im<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>model<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
                im <span class="token operator">=</span> im<span class="token punctuation">.</span>half<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> model<span class="token punctuation">.</span>fp16 <span class="token keyword">else</span> im<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># uint8 to fp16/32</span>
                <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>im<span class="token punctuation">.</span>shape<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">:</span>
                    im <span class="token operator">=</span> im<span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span>  <span class="token comment"># expand for batch dim</span>

            <span class="token comment"># Inference</span>
            <span class="token keyword">with</span> dt<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                results <span class="token operator">=</span> model<span class="token punctuation">(</span>im<span class="token punctuation">)</span>

            <span class="token comment"># Post-process</span>
            <span class="token keyword">with</span> dt<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                pred <span class="token operator">=</span> F<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>results<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># probabilities</span>

            <span class="token comment"># Process predictions</span>
            <span class="token keyword">for</span> i<span class="token punctuation">,</span> prob <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>pred<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># per image</span>
                seen <span class="token operator">+=</span> <span class="token number">1</span>
                <span class="token keyword">if</span> webcam<span class="token punctuation">:</span>  <span class="token comment"># batch_size &gt;= 1</span>
                    p<span class="token punctuation">,</span> im0<span class="token punctuation">,</span> frame <span class="token operator">=</span> path<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> im0s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dataset<span class="token punctuation">.</span>count
                    s <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">: '</span></span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    p<span class="token punctuation">,</span> im0<span class="token punctuation">,</span> frame <span class="token operator">=</span> path<span class="token punctuation">,</span> im0s<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> <span class="token string">'frame'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

                p <span class="token operator">=</span> Path<span class="token punctuation">(</span>p<span class="token punctuation">)</span>  <span class="token comment"># to Path</span>
                save_path <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>save_dir <span class="token operator">/</span> p<span class="token punctuation">.</span>name<span class="token punctuation">)</span>  <span class="token comment"># im.jpg</span>
                txt_path <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>save_dir <span class="token operator">/</span> <span class="token string">'labels'</span> <span class="token operator">/</span> p<span class="token punctuation">.</span>stem<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token string">''</span> <span class="token keyword">if</span> dataset<span class="token punctuation">.</span>mode <span class="token operator">==</span> <span class="token string">'image'</span> <span class="token keyword">else</span> <span class="token string-interpolation"><span class="token string">f'_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>frame<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>  <span class="token comment"># im.txt</span>

                s <span class="token operator">+=</span> <span class="token string">'%gx%g '</span> <span class="token operator">%</span> im<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>  <span class="token comment"># print string</span>
                annotator <span class="token operator">=</span> Annotator<span class="token punctuation">(</span>im0<span class="token punctuation">,</span> example<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">(</span>names<span class="token punctuation">)</span><span class="token punctuation">,</span> pil<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

                <span class="token comment"># Print results</span>
                top5i <span class="token operator">=</span> prob<span class="token punctuation">.</span>argsort<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> descending<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># top 5 indices</span>
                s <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token string">', '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>names<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>prob<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">'</span></span> <span class="token keyword">for</span> j <span class="token keyword">in</span> top5i<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">, "</span></span>

                <span class="token comment"># Write results</span>
                text <span class="token operator">=</span> <span class="token string">'\n'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>prob<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>names<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">'</span></span> <span class="token keyword">for</span> j <span class="token keyword">in</span> top5i<span class="token punctuation">)</span>
                classname <span class="token operator">=</span> names<span class="token punctuation">[</span>top5i<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
                <span class="token keyword">if</span> classname <span class="token operator">==</span> <span class="token string">'daisy'</span><span class="token punctuation">:</span>
                    ui<span class="token punctuation">.</span>printf<span class="token punctuation">(</span><span class="token string">'检测到雏菊'</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> classname <span class="token operator">==</span> <span class="token string">'dandelion'</span><span class="token punctuation">:</span>
                    ui<span class="token punctuation">.</span>printf<span class="token punctuation">(</span><span class="token string">'检测到蒲公英'</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> classname <span class="token operator">==</span> <span class="token string">'roses'</span><span class="token punctuation">:</span>
                    ui<span class="token punctuation">.</span>printf<span class="token punctuation">(</span><span class="token string">'检测到玫瑰花'</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> classname <span class="token operator">==</span> <span class="token string">'sunflowers'</span><span class="token punctuation">:</span>
                    ui<span class="token punctuation">.</span>printf<span class="token punctuation">(</span><span class="token string">'检测到向日葵'</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> classname <span class="token operator">==</span> <span class="token string">'tulips'</span><span class="token punctuation">:</span>
                    ui<span class="token punctuation">.</span>printf<span class="token punctuation">(</span><span class="token string">'检测到郁金香'</span><span class="token punctuation">)</span>

                <span class="token keyword">if</span> save_img <span class="token keyword">or</span> view_img<span class="token punctuation">:</span>  <span class="token comment"># Add bbox to image</span>
                    annotator<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> text<span class="token punctuation">,</span> txt_color<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> self<span class="token punctuation">.</span>save_txt<span class="token punctuation">:</span>  <span class="token comment"># Write to file</span>
                    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>txt_path<span class="token punctuation">}</span></span><span class="token string">.txt'</span></span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>text <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>

                <span class="token comment"># Stream results</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p>该程序文件是一个使用YOLOv5模型进行目标检测的程序。它使用PyQt5库创建了一个用户界面，可以选择输入图像或视频进行目标检测，并显示检测结果。</p> 
<p>程序首先导入了所需的库和模块，然后定义了一些全局变量和函数。接下来，定义了一个名为<code>run</code>的函数，该函数接受一些参数，包括模型权重路径、输入源、数据集路径等。该函数首先加载模型并选择设备，然后根据输入源的类型加载数据。接着，对输入数据进行预处理、推理和后处理，最后将结果保存或显示出来。</p> 
<p>程序还定义了一个名为<code>parse_opt</code>的函数，该函数用于解析命令行参数，并返回解析结果。</p> 
<p>整个程序的主要功能是使用YOLOv5模型进行目标检测，并将检测结果保存或显示出来。</p> 
<h5><a id="55_classifypredictpy_814"></a>5.5 classify\predict.py</h5> 
<pre><code class="prism language-python">


<span class="token keyword">class</span> <span class="token class-name">YOLOv5Classifier</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> weights<span class="token punctuation">,</span> source<span class="token punctuation">,</span> data<span class="token punctuation">,</span> imgsz<span class="token punctuation">,</span> device<span class="token punctuation">,</span> view_img<span class="token punctuation">,</span> save_txt<span class="token punctuation">,</span> nosave<span class="token punctuation">,</span> augment<span class="token punctuation">,</span> visualize<span class="token punctuation">,</span> update<span class="token punctuation">,</span>
                 project<span class="token punctuation">,</span> name<span class="token punctuation">,</span> exist_ok<span class="token punctuation">,</span> half<span class="token punctuation">,</span> dnn<span class="token punctuation">,</span> vid_stride<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>weights <span class="token operator">=</span> weights
        self<span class="token punctuation">.</span>source <span class="token operator">=</span> source
        self<span class="token punctuation">.</span>data <span class="token operator">=</span> data
        self<span class="token punctuation">.</span>imgsz <span class="token operator">=</span> imgsz
        self<span class="token punctuation">.</span>device <span class="token operator">=</span> device
        self<span class="token punctuation">.</span>view_img <span class="token operator">=</span> view_img
        self<span class="token punctuation">.</span>save_txt <span class="token operator">=</span> save_txt
        self<span class="token punctuation">.</span>nosave <span class="token operator">=</span> nosave
        self<span class="token punctuation">.</span>augment <span class="token operator">=</span> augment
        self<span class="token punctuation">.</span>visualize <span class="token operator">=</span> visualize
        self<span class="token punctuation">.</span>update <span class="token operator">=</span> update
        self<span class="token punctuation">.</span>project <span class="token operator">=</span> project
        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name
        self<span class="token punctuation">.</span>exist_ok <span class="token operator">=</span> exist_ok
        self<span class="token punctuation">.</span>half <span class="token operator">=</span> half
        self<span class="token punctuation">.</span>dnn <span class="token operator">=</span> dnn
        self<span class="token punctuation">.</span>vid_stride <span class="token operator">=</span> vid_stride

    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        source <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>source<span class="token punctuation">)</span>
        save_img <span class="token operator">=</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>nosave <span class="token keyword">and</span> <span class="token keyword">not</span> source<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'.txt'</span><span class="token punctuation">)</span>  <span class="token comment"># save inference images</span>
        is_file <span class="token operator">=</span> Path<span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">.</span>suffix<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token keyword">in</span> <span class="token punctuation">(</span>IMG_FORMATS <span class="token operator">+</span> VID_FORMATS<span class="token punctuation">)</span>
        is_url <span class="token operator">=</span> source<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'rtsp://'</span><span class="token punctuation">,</span> <span class="token string">'rtmp://'</span><span class="token punctuation">,</span> <span class="token string">'http://'</span><span class="token punctuation">,</span> <span class="token string">'https://'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        webcam <span class="token operator">=</span> source<span class="token punctuation">.</span>isnumeric<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">or</span> source<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'.streams'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token punctuation">(</span>is_url <span class="token keyword">and</span> <span class="token keyword">not</span> is_file<span class="token punctuation">)</span>
        screenshot <span class="token operator">=</span> source<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'screen'</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> is_url <span class="token keyword">and</span> is_file<span class="token punctuation">:</span>
            source <span class="token operator">=</span> check_file<span class="token punctuation">(</span>source<span class="token punctuation">)</span>  <span class="token comment"># download</span>

        <span class="token comment"># Directories</span>
        save_dir <span class="token operator">=</span> increment_path<span class="token punctuation">(</span>Path<span class="token punctuation">(</span>self<span class="token punctuation">.</span>project<span class="token punctuation">)</span> <span class="token operator">/</span> self<span class="token punctuation">.</span>name<span class="token punctuation">,</span> exist_ok<span class="token operator">=</span>self<span class="token punctuation">.</span>exist_ok<span class="token punctuation">)</span>  <span class="token comment"># increment run</span>
        <span class="token punctuation">(</span>save_dir <span class="token operator">/</span> <span class="token string">'labels'</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>save_txt <span class="token keyword">else</span> save_dir<span class="token punctuation">)</span><span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>parents<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># make dir</span>

        <span class="token comment"># Load model</span>
        device <span class="token operator">=</span> select_device<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
        model <span class="token operator">=</span> DetectMultiBackend<span class="token punctuation">(</span>self<span class="token punctuation">.</span>weights<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">,</span> dnn<span class="token operator">=</span>self<span class="token punctuation">.</span>dnn<span class="token punctuation">,</span> data<span class="token operator">=</span>self<span class="token punctuation">.</span>data<span class="token punctuation">,</span> fp16<span class="token operator">=</span>self<span class="token punctuation">.</span>half<span class="token punctuation">)</span>
        stride<span class="token punctuation">,</span> names<span class="token punctuation">,</span> pt <span class="token operator">=</span> model<span class="token punctuation">.</span>stride<span class="token punctuation">,</span> model<span class="token punctuation">.</span>names<span class="token punctuation">,</span> model<span class="token punctuation">.</span>pt
        imgsz <span class="token operator">=</span> check_img_size<span class="token punctuation">(</span>self<span class="token punctuation">.</span>imgsz<span class="token punctuation">,</span> s<span class="token operator">=</span>stride<span class="token punctuation">)</span>  <span class="token comment"># check image size</span>

        <span class="token comment"># Dataloader</span>
        bs <span class="token operator">=</span> <span class="token number">1</span>  <span class="token comment"># batch_size</span>
        <span class="token keyword">if</span> webcam<span class="token punctuation">:</span>
            view_img <span class="token operator">=</span> check_imshow<span class="token punctuation">(</span>warn<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
            dataset <span class="token operator">=</span> LoadStreams<span class="token punctuation">(</span>source<span class="token punctuation">,</span> img_size<span class="token operator">=</span>imgsz<span class="token punctuation">,</span> transforms<span class="token operator">=</span>classify_transforms<span class="token punctuation">(</span>imgsz<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                  vid_stride<span class="token operator">=</span>self<span class="token punctuation">.</span>vid_stride<span class="token punctuation">)</span>
            bs <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>dataset<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> screenshot<span class="token punctuation">:</span>
            dataset <span class="token operator">=</span> LoadScreenshots<span class="token punctuation">(</span>source<span class="token punctuation">,</span> img_size<span class="token operator">=</span>imgsz<span class="token punctuation">,</span> stride<span class="token operator">=</span>stride<span class="token punctuation">,</span> auto<span class="token operator">=</span>pt<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            dataset <span class="token operator">=</span> LoadImages<span class="token punctuation">(</span>source<span class="token punctuation">,</span> img_size<span class="token operator">=</span>imgsz<span class="token punctuation">,</span> transforms<span class="token operator">=</span>classify_transforms<span class="token punctuation">(</span>imgsz<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                 vid_stride<span class="token operator">=</span>self<span class="token punctuation">.</span>vid_stride<span class="token punctuation">)</span>
        vid_path<span class="token punctuation">,</span> vid_writer <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">*</span> bs<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">*</span> bs

        <span class="token comment"># Run inference</span>
        model<span class="token punctuation">.</span>warmup<span class="token punctuation">(</span>imgsz<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token keyword">if</span> pt <span class="token keyword">else</span> bs<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">*</span>imgsz<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># warmup</span>
        seen<span class="token punctuation">,</span> windows<span class="token punctuation">,</span> dt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>Profile<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Profile<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Profile<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> path<span class="token punctuation">,</span> im<span class="token punctuation">,</span> im0s<span class="token punctuation">,</span> vid_cap<span class="token punctuation">,</span> s <span class="token keyword">in</span> dataset<span class="token punctuation">:</span>
            <span class="token keyword">with</span> dt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                im <span class="token operator">=</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>im<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>model<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
                im <span class="token operator">=</span> im<span class="token punctuation">.</span>half<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> model<span class="token punctuation">.</span>fp16 <span class="token keyword">else</span> im<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># uint8 to fp16/32</span>
                <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>im<span class="token punctuation">.</span>shape<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">:</span>
                    im <span class="token operator">=</span> im<span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span>  <span class="token comment"># expand for batch dim</span>

            <span class="token comment"># Inference</span>
            <span class="token keyword">with</span> dt<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                results <span class="token operator">=</span> model<span class="token punctuation">(</span>im<span class="token punctuation">)</span>

            <span class="token comment"># Post-process</span>
            <span class="token keyword">with</span> dt<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                pred <span class="token operator">=</span> F<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>results<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># probabilities</span>

            <span class="token comment"># Process predictions</span>
            <span class="token keyword">for</span> i<span class="token punctuation">,</span> prob <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>pred<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># per image</span>
                seen <span class="token operator">+=</span> <span class="token number">1</span>
                <span class="token keyword">if</span> webcam<span class="token punctuation">:</span>  <span class="token comment"># batch_size &gt;= 1</span>
                    p<span class="token punctuation">,</span> im0<span class="token punctuation">,</span> frame <span class="token operator">=</span> path<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> im0s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dataset<span class="token punctuation">.</span>count
                    s <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">: '</span></span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    p<span class="token punctuation">,</span> im0<span class="token punctuation">,</span> frame <span class="token operator">=</span> path<span class="token punctuation">,</span> im0s<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> <span class="token string">'frame'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

                p <span class="token operator">=</span> Path<span class="token punctuation">(</span>p<span class="token punctuation">)</span>  <span class="token comment"># to Path</span>
                save_path <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>save_dir <span class="token operator">/</span> p<span class="token punctuation">.</span>name<span class="token punctuation">)</span>  <span class="token comment"># im.jpg</span>
                txt_path <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>save_dir <span class="token operator">/</span> <span class="token string">'labels'</span> <span class="token operator">/</span> p<span class="token punctuation">.</span>stem<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token string">''</span> <span class="token keyword">if</span> dataset<span class="token punctuation">.</span>mode <span class="token operator">==</span> <span class="token string">'image'</span> <span class="token keyword">else</span> <span class="token string-interpolation"><span class="token string">f'_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>frame<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>  <span class="token comment"># im.txt</span>

                s <span class="token operator">+=</span> <span class="token string">'%gx%g '</span> <span class="token operator">%</span> im<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>  <span class="token comment"># print string</span>
                annotator <span class="token operator">=</span> Annotator<span class="token punctuation">(</span>im0<span class="token punctuation">,</span> example<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">(</span>names<span class="token punctuation">)</span><span class="token punctuation">,</span> pil<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

                <span class="token comment"># Print results</span>
                top5i <span class="token operator">=</span> prob<span class="token punctuation">.</span>argsort<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> descending<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># top 5 indices</span>
                s <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token string">', '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>names<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>prob<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">'</span></span> <span class="token keyword">for</span> j <span class="token keyword">in</span> top5i<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">, "</span></span>

                <span class="token comment"># Write results</span>
                text <span class="token operator">=</span> <span class="token string">'\n'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>prob<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>names<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">'</span></span> <span class="token keyword">for</span> j <span class="token keyword">in</span> top
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p>这个程序文件是一个用于运行YOLOv5分类推理的脚本。它可以用于对图像、视频、目录、YouTube、网络摄像头等进行分类推理。</p> 
<p>程序文件中定义了一些命令行参数，用于指定模型路径、数据源、推理尺寸、设备等。它还包含了一些辅助函数和工具类，用于加载模型、处理输入数据、进行推理和后处理等操作。</p> 
<p>在主函数中，程序首先解析命令行参数，然后调用<code>run</code>函数进行推理。<code>run</code>函数根据命令行参数设置模型、数据加载器和推理参数，然后进行推理。推理过程中，程序会将推理结果保存到文件或显示在屏幕上。</p> 
<p>最后，程序会打印推理速度和保存结果的路径。</p> 
<p>整体来说，这个程序文件是一个用于运行YOLOv5分类推理的脚本，可以方便地对图像、视频等进行分类推理，并保存推理结果。</p> 
<h2><a id="6_927"></a>6.系统整体结构</h2> 
<p>根据以上分析，该程序是一个基于深度学习的HRNet-YOLO的花卉图像识别系统。它包含了目标检测、分类和分割三个主要功能模块。程序的整体构架如下：</p> 
<ol><li> <p>目标检测模块：</p> 
  <ul><li>cls_hrnet.py：实现HRNet-YOLO模型的网络结构。</li><li>evaluate.py：评估模型在测试集上的性能。</li><li>export.py：将模型导出为TorchScript或ONNX格式。</li><li>function.py：定义了一些辅助函数，如计算准确率等。</li><li>model.py：定义了HRNet模型的整体结构。</li><li>train.py：训练模型的主程序。</li><li>ui.py：用户界面，用于交互式操作模型。</li></ul> </li><li> <p>分类模块：</p> 
  <ul><li>classify/predict.py：使用训练好的模型进行图像分类预测。</li><li>classify/train.py：训练图像分类模型。</li><li>classify/val.py：验证图像分类模型的性能。</li></ul> </li><li> <p>分割模块：</p> 
  <ul><li>segment/predict.py：使用训练好的模型进行图像分割预测。</li><li>segment/train.py：训练图像分割模型。</li><li>segment/val.py：验证图像分割模型的性能。</li></ul> </li><li> <p>其他工具模块：</p> 
  <ul><li>models/common.py：定义了一些通用的模型组件。</li><li>models/experimental.py：定义了一些实验性的模型组件。</li><li>models/tf.py：与TensorFlow相关的模型组件。</li><li>models/yolo.py：YOLO模型的定义。</li><li>models/<strong>init</strong>.py：模型模块的初始化文件。</li><li>utils/：包含了一系列辅助函数和工具类，用于数据处理、模型训练、模型评估等。</li></ul> </li></ol> 
<p>下面是每个文件的功能概述：</p> 
<table><thead><tr><th>文件名</th><th>功能</th></tr></thead><tbody><tr><td>cls_hrnet.py</td><td>实现HRNet-YOLO模型的网络结构</td></tr><tr><td>evaluate.py</td><td>评估模型在测试集上的性能</td></tr><tr><td>export.py</td><td>将模型导出为TorchScript或ONNX格式</td></tr><tr><td>function.py</td><td>定义了一些辅助函数，如计算准确率等</td></tr><tr><td>model.py</td><td>定义了HRNet模型的整体结构</td></tr><tr><td>train.py</td><td>训练模型的主程序</td></tr><tr><td>ui.py</td><td>用户界面，用于交互式操作模型</td></tr><tr><td>classify/predict.py</td><td>使用训练好的模型进行图像分类预测</td></tr><tr><td>classify/train.py</td><td>训练图像分类模型</td></tr><tr><td>classify/val.py</td><td>验证图像分类模型的性能</td></tr><tr><td>segment/predict.py</td><td>使用训练好的模型进行图像分割预测</td></tr><tr><td>segment/train.py</td><td>训练图像分割模型</td></tr><tr><td>segment/val.py</td><td>验证图像分割模型的性能</td></tr><tr><td>models/common.py</td><td>定义了一些通用的模型组件</td></tr><tr><td>models/experimental.py</td><td>定义了一些实验性的模型组件</td></tr><tr><td>models/tf.py</td><td>与TensorFlow相关的模型组件</td></tr><tr><td>models/yolo.py</td><td>YOLO模型的定义</td></tr><tr><td>models/<strong>init</strong>.py</td><td>模型模块的初始化文件</td></tr><tr><td>utils/activations.py</td><td>激活函数相关的辅助函数</td></tr><tr><td>utils/augmentations.py</td><td>数据增强相关的辅助函数</td></tr><tr><td>utils/autoanchor.py</td><td>自动锚框相关的辅助函数</td></tr><tr><td>utils/autobatch.py</td><td>自动批处理相关的辅助函数</td></tr><tr><td>utils/callbacks.py</td><td>回调函数相关的辅助函数</td></tr><tr><td>utils/dataloaders.py</td><td>数据加载器相关的辅助函数</td></tr><tr><td>utils/downloads.py</td><td>下载数据集和模型权重的辅助函数</td></tr><tr><td>utils/general.py</td><td>通用的辅助函数</td></tr><tr><td>utils/loss.py</td><td>损失函数相关的辅助函数</td></tr><tr><td>utils/metrics.py</td><td>评估指标相关的辅助函数</td></tr><tr><td>utils/plots.py</td><td>绘图相关的辅助函数</td></tr><tr><td>utils/torch_utils.py</td><td>PyTorch相关的辅助函数</td></tr><tr><td>utils/triton.py</td><td>Triton Inference Server相关的辅助函数</td></tr><tr><td>utils/<strong>init</strong>.py</td><td>工具模块的初始化文件</td></tr><tr><td>utils/aws/resume.py</td><td>AWS相关的辅助函数</td></tr><tr><td>utils/aws/<strong>init</strong>.py</td><td>AWS模块的初始化文件</td></tr><tr><td>utils/flask_rest_api/example_request.py</td><td>Flask REST API的示例请求文件</td></tr><tr><td>utils/flask_rest_api/restapi.py</td><td>Flask REST API的实现文件</td></tr><tr><td>utils/loggers/<strong>init</strong>.py</td><td>日志记录器模块的初始化文件</td></tr><tr><td>utils/loggers/clearml/clearml_utils.py</td><td>ClearML日志记录器的辅助函数</td></tr><tr><td>utils/loggers/clearml/hpo.py</td><td>ClearML日志记录器的超参数优化辅助函数</td></tr><tr><td>utils/loggers/clearml/<strong>init</strong>.py</td><td>ClearML日志记录器模块的初始化文件</td></tr><tr><td>utils/loggers/comet/comet_utils.py</td><td>Comet日志记录器的辅助函数</td></tr><tr><td>utils/loggers/comet/hpo.py</td><td>Comet日志记录器的超参数优化辅助函数</td></tr><tr><td>utils/loggers/comet/<strong>init</strong>.py</td><td>Comet日志记录器模块的初始化文件</td></tr><tr><td>utils/loggers/wandb/wandb_utils.py</td><td>WandB日志记录器的辅助函数</td></tr><tr><td>utils/loggers/wandb/<strong>init</strong>.py</td><td>WandB日志记录器模块的初始化文件</td></tr><tr><td>utils/segment/augmentations.py</td><td>图像分割数据增强相关的辅助函数</td></tr><tr><td>utils/segment/dataloaders.py</td><td>图像分割数据加载器相关的辅助函数</td></tr><tr><td>utils/segment/general.py</td><td>图像分割通用的辅助函数</td></tr><tr><td>utils/segment/loss.py</td><td>图像分割损失函数相关的辅助函数</td></tr><tr><td>utils/segment/metrics.py</td><td>图像分割评估指标相关的辅助函数</td></tr><tr><td>utils/segment/plots.py</td><td>图像分割绘图相关的辅助函数</td></tr><tr><td>utils/segment/<strong>init</strong>.py</td><td>图像分割模块的初始化文件</td></tr></tbody></table> 
<h2><a id="7HRNet_1016"></a>7.HRNet骨干网络简介</h2> 
<p>HRNet是微软亚洲研究院的团队完成的，打通图像分类、图像分割、目标检测、人脸对齐、姿态识别、风格迁移、Image Inpainting、超分、optical flow、Depth estimation、边缘检测等网络结构。<br> <img src="https://images2.imgbox.com/14/db/tzqmDOfd_o.png" alt="在这里插入图片描述"></p> 
<p>王老师在ValseWebinar《物体和关键点检测》中亲自讲解了HRNet，讲解地非常透彻。以下文章主要参考了王老师在演讲中的解读，配合论文+代码部分，来为各位读者介绍这个全能的Backbone-HRNet。<br> 在人体姿态识别这类的任务中，需要生成一个高分辨率的heatmap来进行关键点检测。这就与一般的网络结构比如VGGNet的要求不同，因为VGGNet最终得到的feature map分辨率很低，损失了空间结构。<br> <img src="https://images2.imgbox.com/1f/b7/YZpVXHyW_o.png" alt="在这里插入图片描述"></p> 
<p>获取高分辨率的方式大部分都是如上图所示，采用的是先降分辨率，然后再升分辨率的方法。U-Net、SegNet、DeconvNet、Hourglass本质上都是这种结构。<br> <img src="https://images2.imgbox.com/a2/51/48CayHTn_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_1031"></a>核心</h5> 
<p>普通网络都是这种结构，不同分辨率之间是进行了串联</p> 
<p><img src="https://images2.imgbox.com/20/b3/rUd4s7vW_o.png" alt="在这里插入图片描述"></p> 
<p>王井东老师则是将不同分辨率的feature map进行并联：</p> 
<p><img src="https://images2.imgbox.com/c6/a3/iWeAYpTZ_o.png" alt="在这里插入图片描述"></p> 
<p>在并联的基础上，添加不同分辨率feature map之间的交互(fusion)。</p> 
<p><img src="https://images2.imgbox.com/d7/9e/0bM0fWoT_o.png" alt="在这里插入图片描述"></p> 
<p>具体fusion的方法如下图所示：</p> 
<p><img src="https://images2.imgbox.com/ab/52/WIRYPHvk_o.png" alt="在这里插入图片描述"></p> 
<p>同分辨率的层直接复制。<br> 需要升分辨率的使用bilinear upsample + 1x1卷积将channel数统一。<br> 需要降分辨率的使用strided 3x3 卷积。<br> 三个feature map融合的方式是相加。<br> 至于为何要用strided 3x3卷积，这是因为卷积在降维的时候会出现信息损失，使用strided 3x3卷积是为了通过学习的方式，降低信息的损耗。所以这里没有用maxpool或者组合池化。</p> 
<p><img src="https://images2.imgbox.com/e9/b8/D0IPxpMZ_o.png" alt="在这里插入图片描述"></p> 
<p>另外在读HRNet的时候会有一个问题，有四个分支的到底如何使用这几个分支呢？论文中也给出了几种方式作为最终的特征选择。<br> <img src="https://images2.imgbox.com/5d/77/y0PwtGOn_o.png" alt="在这里插入图片描述"></p> 
<p>(a)图展示的是HRNetV1的特征选择，只使用分辨率最高的特征图。</p> 
<p>(b)图展示的是HRNetV2的特征选择，将所有分辨率的特征图(小的特征图进行upsample)进行concate，主要用于语义分割和面部关键点检测。</p> 
<p>©图展示的是HRNetV2p的特征选择，在HRNetV2的基础上，使用了一个特征金字塔，主要用于目标检测网络。<br> <img src="https://images2.imgbox.com/4c/85/9Y8KgAYE_o.png" alt="在这里插入图片描述"></p> 
<p>再补充一个(d)图</p> 
<p>(d)图展示的也是HRNetV2，采用上图的融合方式，主要用于训练分类网络。</p> 
<p>总结一下HRNet创新点：</p> 
<p>（1）将高低分辨率之间的链接由串联改为并联。<br> （2）在整个网络结构中都保持了高分辨率的表征(最上边那个通路)。<br> （3）在高低分辨率中引入了交互来提高模型性能。</p> 
<h2><a id="8_1085"></a>8.训练结果可视化分析</h2> 
<p>为了对基于深度学习的 HRNet-YOLO 花卉图像识别系统的实验结果进行全面分析，必须从多个角度处理数据。此分析应包含系统架构的概述、用于培训和测试的数据集、性能指标以及对所提供图像中所示结果的详细从不同角度详细分析。</p> 
<h5><a id="_1088"></a>系统架构</h5> 
<p>HRNet（高分辨率网络）与 YOLO（You Only Look Once）相结合提出了一种创新方法，其中 HRNet 在通过网络维持高分辨率表示方面的鲁棒性与 YOLO 的速度和检测功能相结合。这种融合可能旨在增强系统通过复杂细节识别各种花朵的能力，这对于准确分类至关重要。</p> 
<h5><a id="_1091"></a>数据集和训练</h5> 
<p>任何深度学习模型的成功很大程度上取决于数据集的质量和数量。对于花卉图像识别系统，数据集必须包括不同生长阶段、光照条件和方向的各种花卉。从图像中，我们可以推断数据集包括玫瑰、郁金香、向日葵、雏菊和蒲公英。平衡的数据集将包含每个类别相同数量的图像，具有不同的背景和位置，以最大限度地减少任何偏差。</p> 
<h5><a id="_1094"></a>评价指标</h5> 
<p>图像识别系统的关键性能指标包括准确度、精确度、召回率和 F1 分数。准确性将衡量模型正确分类花卉的整体有效性。精确度和召回率分别表示系统正确标记花朵图像的能力以及正确识别特定花朵的所有实例的程度。F1 分数将提供精确度和召回率之间的平衡，这是数据集不平衡时的一个重要因素。<br> 该数据集包含有关基于深度学习的 HRNet-YOLO 花卉图像识别系统在不同时期的性能信息。这些列包括：</p> 
<p>epoch：训练过程中的纪元号。<br> train/loss：每个时期训练期间产生的损失。<br> test/loss：每个时期测试期间产生的损失。<br> metrics/accuracy_top1：top-1 准确度指标，指示模型最高置信度预测正确的测试样本的比例。<br> metrics/accuracy_top5：top-5 准确度指标，指示正确标签属于模型前 5 个预测的测试样本的比例。<br> lr/0：每个时期的学习率。<br> 为了可视化这些数据，我们可以为每个时期的这些指标创建图表。这将帮助我们分析模型的性能和学习率如何随时间演变。</p> 
<h5><a id="_1106"></a>结果可视化</h5> 
<pre><code class="prism language-python"><span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt

<span class="token comment"># Setting up the plots</span>
fig<span class="token punctuation">,</span> axes <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
fig<span class="token punctuation">.</span>suptitle<span class="token punctuation">(</span><span class="token string">'HRNet-YOLO Flower Image Recognition System Performance Analysis'</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">)</span>

<span class="token comment"># Plotting training loss</span>
axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>plot<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'epoch'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token string">'train/loss'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Training Loss'</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'blue'</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">'Training Loss per Epoch'</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_xlabel<span class="token punctuation">(</span><span class="token string">'Epoch'</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">'Loss'</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token comment"># Plotting testing loss</span>
axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>plot<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'epoch'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token string">'test/loss'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Testing Loss'</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'red'</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">'Testing Loss per Epoch'</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_xlabel<span class="token punctuation">(</span><span class="token string">'Epoch'</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">'Loss'</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token comment"># Plotting top-1 accuracy</span>
axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>plot<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'epoch'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token string">'metrics/accuracy_top1'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Top-1 Accuracy'</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'green'</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">'Top-1 Accuracy per Epoch'</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_xlabel<span class="token punctuation">(</span><span class="token string">'Epoch'</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">'Accuracy'</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token comment"># Plotting top-5 accuracy</span>
axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>plot<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'epoch'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token string">'metrics/accuracy_top5'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Top-5 Accuracy'</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'orange'</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">'Top-5 Accuracy per Epoch'</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_xlabel<span class="token punctuation">(</span><span class="token string">'Epoch'</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">'Accuracy'</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token comment"># Plotting learning rate</span>
axes<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>plot<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'epoch'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token string">'lr/0'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Learning Rate'</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'purple'</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">'Learning Rate per Epoch'</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_xlabel<span class="token punctuation">(</span><span class="token string">'Epoch'</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">'Learning Rate'</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token comment"># Adjust layout</span>
plt<span class="token punctuation">.</span>tight_layout<span class="token punctuation">(</span>rect<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.03</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.95</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># Show the plots</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<p><img src="https://images2.imgbox.com/3a/37/fo3kupOn_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_1158"></a>训练结果分析</h5> 
<h6><a id="1_1159"></a>1.训练与测试损失趋势分析</h6> 
<p>训练损失分析：该指标反映了模型在学习过程中对训练数据的识别与失踪能力。从初始的0.48046逐渐下降至0.28212，表明模型在学习过程中逐步提升了对数据训练的识别与失踪能力。下降趋势通常是模型优化过程中的正常现象，但这种也需要清醒的则可能，即模型在训练数据上表现得非常优秀，而在未知的数据上可能失效。<br> 测试损失分析：测试损失最初的波动，从0.80446降到0.33867再升到0.44810，随后逐渐稳定并下降至0.23084，这可能表明模型在开始未见数据的支撑不强，但随着训练的深入研究，模型的泛化能力得到了提升。</p> 
<h6><a id="2_1162"></a>2.准确率分析</h6> 
<p>Top-1准确率：这个选择指标是模型训练的第一个正确的概率。从0.80507梯度提升至0.92626，说明模型对于图像布置的识别能力随着逐渐增强。这种持续提升的也反映改进了的HRNet骨干网络和YOLOv5结合带来的功效。<br> Top-5准确率：由于数据中Top-5准确率始终为1，这可能表明在实验中该指标不是主要关注点，或者模型对于预留类别的区分能力相对关系，即使不是最佳预测，也能在前五个名称中包含正确的类别。</p> 
<h6><a id="3_1165"></a>3.学习率与模型优化</h6> 
<p>学习率从0.00099逐渐下降到0.00095，这种缓慢恢复的策略可能是为了在初期快速恢复，在后期通过较小的学习步长进行精细调整，避免过大的步长导致模型在最优化解附近震荡而不是收敛。</p> 
<h6><a id="4HRNetYOLOv5_1167"></a>4.改进的HRNet骨干网络对YOLOv5的影响</h6> 
<p>HRNet强调在多尺度特征的融合，这对于保留图像识别可能非常重要，因为保留的形状、颜色和纹理在不同尺度下融合表现出各异。通过改进的HRNet骨干网络，YOLOv5可能更有效地提取和这些特征，从而提高识别准确率。</p> 
<h6><a id="5_1169"></a>5.模型泛化能力和鲁棒性分析</h6> 
<p>模型的泛化能力通过测试损失和测试准确率来体现。从数据中可以看出，随着训练的深入，模型在未知数据集上的表现逐渐稳定并提升，表明其具有良好的泛化能力。 测试损失的下降趋势和准确率的提升表明模型在多次迭代后对数据的下降和鲁棒性损失增强。<br> <img src="https://images2.imgbox.com/95/85/Sxh0oyaB_o.jpg" alt="在这里插入图片描述"></p> 
<h6><a id="6_1173"></a>6.未来改进方向</h6> 
<p>根据目前的实验结果，未来的研究可以探索不同的学习率调整策略，例如使用更动态的学习率调整（如学习率回调机制），以期进一步提高模型的学习效率和泛化能力。<br> 可以探索更多的数据修复和增强技术，以提高模型对于初始阶段不同特征的认知和鲁棒性。<br> 还可以考虑对HRNet和YOLOv5的结合方式进行进一步的优化，例如通过改变网络结构或引入新的特征机制融合，以提高模型的整体性能。</p> 
<h2><a id="9_1178"></a>9.系统整合</h2> 
<p>下图<a href="https://s.xiaocichang.com/s/836fee" rel="nofollow">完整源码＆数据集＆环境部署视频教程＆自定义UI界面</a></p> 
<p><img src="https://images2.imgbox.com/37/fc/fjW6mYSU_o.png" alt="在这里插入图片描述"></p> 
<p>参考博客<a href="https://zhuanlan.zhihu.com/p/666708089" rel="nofollow">《基于深度学习的HRNet-YOLO的花卉图像识别系统》</a></p> 
<h2><a id="10_1186"></a>10.参考文献</h2> 
<hr> 
<p>[1]<a href="https://s.wanfangdata.com.cn/paper?q=%E4%BD%9C%E8%80%85:%22%E9%82%93%E5%BF%A0%E8%B1%AA%22" rel="nofollow">邓忠豪</a>,<a href="https://s.wanfangdata.com.cn/paper?q=%E4%BD%9C%E8%80%85:%22%E9%99%88%E6%99%93%E4%B8%9C%22" rel="nofollow">陈晓东</a>.<a href="https://d.wanfangdata.com.cn/periodical/jsjyy201907040" rel="nofollow">基于深度卷积神经网络的肺结节检测算法</a>[J].<a href="https://sns.wanfangdata.com.cn/perio/jsjyy" rel="nofollow">计算机应用</a>.2019,(7).DOI:10.11772/j.issn.1001-9081.2019010056 .</p> 
<p>[2]<a href="https://s.wanfangdata.com.cn/paper?q=%E4%BD%9C%E8%80%85:%22%E5%85%B3%E8%83%A4%22" rel="nofollow">关胤</a>.<a href="https://d.wanfangdata.com.cn/periodical/jsjgcyyy201901027" rel="nofollow">基于残差网络迁移学习的花卉识别系统</a>[J].<a href="https://sns.wanfangdata.com.cn/perio/jsjgcyyy" rel="nofollow">计算机工程与应用</a>.2019,(1).DOI:10.3778/j.issn.1002-8331.1709-0322 .</p> 
<p>[3]<a href="https://s.wanfangdata.com.cn/paper?q=%E4%BD%9C%E8%80%85:%22%E6%9B%BE%E7%87%95%22" rel="nofollow">曾燕</a>,<a href="https://s.wanfangdata.com.cn/paper?q=%E4%BD%9C%E8%80%85:%22%E9%99%88%E5%B2%B3%E6%9E%97%22" rel="nofollow">陈岳林</a>,<a href="https://s.wanfangdata.com.cn/paper?q=%E4%BD%9C%E8%80%85:%22%E8%94%A1%E6%99%93%E4%B8%9C%22" rel="nofollow">蔡晓东</a>.<a href="https://d.wanfangdata.com.cn/periodical/xadzkjdx201805026" rel="nofollow">结合全局与局部池化的深度哈希人脸识别算法</a>[J].<a href="https://sns.wanfangdata.com.cn/perio/xadzkjdx" rel="nofollow">西安电子科技大学学报（自然科学版）</a>.2018,(5).DOI:10.3969/j.issn.1001-2400.2018.05.026 .</p> 
<p>[4]<a href="https://s.wanfangdata.com.cn/paper?q=%E4%BD%9C%E8%80%85:%22%E9%83%AD%E5%AD%90%E7%90%B0%22" rel="nofollow">郭子琰</a>,<a href="https://s.wanfangdata.com.cn/paper?q=%E4%BD%9C%E8%80%85:%22%E8%88%92%E5%BF%83%22" rel="nofollow">舒心</a>,<a href="https://s.wanfangdata.com.cn/paper?q=%E4%BD%9C%E8%80%85:%22%E5%88%98%E5%B8%B8%E7%87%95%22" rel="nofollow">刘常燕</a>,等.<a href="https://d.wanfangdata.com.cn/periodical/wjfz201805035" rel="nofollow">基于ReLU函数的卷积神经网络的花卉识别算法</a>[J].<a href="https://sns.wanfangdata.com.cn/perio/wjfz" rel="nofollow">计算机技术与发展</a>.2018,(5).DOI:10.3969/j.issn.1673-629X.2018.05.035 .</p> 
<p>[5]<a href="https://s.wanfangdata.com.cn/paper?q=%E4%BD%9C%E8%80%85:%22%E7%8E%8B%E5%A8%81%22" rel="nofollow">王威</a>,<a href="https://s.wanfangdata.com.cn/paper?q=%E4%BD%9C%E8%80%85:%22%E5%88%98%E5%B0%8F%E7%BF%A0%22" rel="nofollow">刘小翠</a>,<a href="https://s.wanfangdata.com.cn/paper?q=%E4%BD%9C%E8%80%85:%22%E7%8E%8B%E6%96%B0%22" rel="nofollow">王新</a>.<a href="https://d.wanfangdata.com.cn/periodical/huncjgdzkxxxb201804009" rel="nofollow">基于综合特征的花卉种类识别方法研究</a>[J].<a href="https://sns.wanfangdata.com.cn/perio/huncjgdzkxxxb" rel="nofollow">湖南城市学院学报（自然科学版）</a>.2018,(4).DOI:10.3969/j.issn.1672-7304.2018.04.0009 .</p> 
<p>[6]<a href="https://s.wanfangdata.com.cn/paper?q=%E4%BD%9C%E8%80%85:%22%E6%B2%88%E8%90%8D%22" rel="nofollow">沈萍</a>,<a href="https://s.wanfangdata.com.cn/paper?q=%E4%BD%9C%E8%80%85:%22%E8%B5%B5%E5%A4%87%22" rel="nofollow">赵备</a>.<a href="https://d.wanfangdata.com.cn/periodical/kjtb201703025" rel="nofollow">基于深度学习模型的花卉种类识别</a>[J].<a href="https://sns.wanfangdata.com.cn/perio/kjtb" rel="nofollow">科技通报</a>.2017,(3).DOI:10.13774/j.cnki.kjtb.2017.03.014 .</p> 
<p>[7]<a href="https://s.wanfangdata.com.cn/paper?q=%E4%BD%9C%E8%80%85:%22%E8%8B%97%E9%87%91%E6%B3%89%22" rel="nofollow">苗金泉</a>,<a href="https://s.wanfangdata.com.cn/paper?q=%E4%BD%9C%E8%80%85:%22%E6%9B%B9%E5%8D%AB%E7%BE%A4%22" rel="nofollow">曹卫群</a>.<a href="https://d.wanfangdata.com.cn/periodical/zgtxtxxb-a201411011" rel="nofollow">可扩展的花卉种类识别</a>[J].<a href="https://sns.wanfangdata.com.cn/perio/zgtxtxxb-a" rel="nofollow">中国图象图形学报</a>.2014,(11).DOI:10.11834/jig.20141111 .</p> 
<p>[8]<a href="https://s.wanfangdata.com.cn/paper?q=%E4%BD%9C%E8%80%85:%22%E6%9F%AF%E9%80%8D%22" rel="nofollow">柯逍</a>,<a href="https://s.wanfangdata.com.cn/paper?q=%E4%BD%9C%E8%80%85:%22%E9%99%88%E5%B0%8F%E8%8A%AC%22" rel="nofollow">陈小芬</a>,<a href="https://s.wanfangdata.com.cn/paper?q=%E4%BD%9C%E8%80%85:%22%E6%9D%8E%E7%BB%8D%E6%BB%8B%22" rel="nofollow">李绍滋</a>.<a href="https://d.wanfangdata.com.cn/periodical/jsjkx201011068" rel="nofollow">基于多特征融合的花卉图像检索</a>[J].<a href="https://sns.wanfangdata.com.cn/perio/jsjkx" rel="nofollow">计算机科学</a>.2010,(11).DOI:10.3969/j.issn.1002-137X.2010.11.068 .</p> 
<p>[9]<a href="https://s.wanfangdata.com.cn/paper?q=%E4%BD%9C%E8%80%85:%22%E7%8E%8B%E7%88%BD%22" rel="nofollow">王爽</a>.<a href="https://d.wanfangdata.com.cn/periodical/D01491615" rel="nofollow">基于机器学习的花卉识别算法的研究与实现</a>[J].电子科技大学.2018.</p> 
<p>[10]<a href="https://s.wanfangdata.com.cn/paper?q=%E4%BD%9C%E8%80%85:%22Raul%20Orus%20Perez%22" rel="nofollow">Raul Orus Perez</a>.Using TensorFlow-based Neural Network to estimate GNSS single frequency ionospheric delay (IONONet)[J].Advances in Space Research.2019,63(5).1607-1618.</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b69ccf22d51adfb25b009d7d8b744f8f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【C&#43;&#43;学习笔记】编译优化</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2124c666d9ea3d9500661fa482fbdf68/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Session、Token、Jwt三种登录方案介绍</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>