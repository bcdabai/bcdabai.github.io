<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>STM32 控制蜂鸣器播放音乐的原理和实例 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="STM32 控制蜂鸣器播放音乐的原理和实例" />
<meta property="og:description" content="STM32 控制蜂鸣器播放音乐的原理和实例 本文通过将乐谱里的每个音符的声音频率和声音时长保存在两个数组里面。
1.使用通用定时器TIM4实现无中断的微秒级延时函数，控制每个音符的发声时长。
2.使用系统滴答时钟Systick实现带有中断的输出控制，在中断函数里实现蜂鸣器端口输出电平反转，并且根据当前播放音符的频率重新设置中断产生时间。
一、播放的原理 播放的乐谱：
1.1 C音调乐谱对应的音频（Hz）： 根据乐谱的基础知识可知，低音的下面加点，高音的上面加点，普通的不加点。
//用枚举定义，记录所有的音频。 enum Low_frequency{l_dao=262,l_re=286,l_mi=311,l_fa=349,l_sao=392,l_la=440,l_xi=494}; enum Normal_frequency{dao=523,re=587,mi=659,fa=698,sao=784,la=880,xi=987}; enum High_frequency{h_dao=1046,h_re=1174,h_mi=1318,h_fa=1396,h_sao=1567,h_la=1760,h_xi=1975}; 1.2 乐谱对应的节拍-音长： 本次乐谱的节拍为每分钟72拍，可以算出每个节拍的时长：
然后看乐谱的第一小节：
最后将整个乐谱的音频和音长记录在两个数组里。
。
二、播放音乐的具体实现 2.1 无中断的毫秒延时函数 //TIM_4初始化函数 void TIM_4(void) { TIM_TimeBaseInitTypeDef TIM_TimeBaseStructure; RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM4,ENABLE); TIM_TimeBaseStructure.TIM_Period = 1;	TIM_TimeBaseStructure.TIM_Prescaler=(72-1); TIM_TimeBaseStructure.TIM_CounterMode=TIM_CounterMode_Down; TIM_TimeBaseStructure.TIM_ClockDivision=TIM_CKD_DIV1; TIM_TimeBaseInit(TIM4, &amp;TIM_TimeBaseStructure); } //延时n个us void delay_us(unsigned int nus) { TIM4-&gt;CNT=nus-1; TIM4-&gt;CR1|=TIM_CR1_CEN; while((TIM4-&gt;SR &amp; TIM_FLAG_Update) != SET) ; TIM4-&gt;CR1&amp;=(~TIM_CR1_CEN); TIM4-&gt;SR &amp;=~(TIM_FLAG_Update); } //延时n个毫秒 void delay_ms(unsigned int nms) { int count; for(count=0;count&lt;nms;count&#43;&#43;) delay_us(1000); } 2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/289d31221dac17e9e36d28f54f11af77/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-08-06T23:19:57+08:00" />
<meta property="article:modified_time" content="2020-08-06T23:19:57+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">STM32 控制蜂鸣器播放音乐的原理和实例</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="STM32__0"></a>STM32 控制蜂鸣器播放音乐的原理和实例</h3> 
<p>本文通过将乐谱里的每个音符的声音频率和声音时长保存在两个数组里面。<br> 1.使用通用定时器TIM4实现无中断的微秒级延时函数，控制每个音符的发声时长。<br> 2.使用系统滴答时钟Systick实现带有中断的输出控制，在中断函数里实现蜂鸣器端口输出电平反转，并且根据当前播放音符的频率重新设置中断产生时间。</p> 
<h3><a id="_6"></a>一、播放的原理</h3> 
<p>播放的乐谱：<br> <img src="https://images2.imgbox.com/2e/6d/xFpgyVQ8_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="11_CHz_10"></a>1.1 C音调乐谱对应的音频（Hz）：</h3> 
<p><img src="https://images2.imgbox.com/b2/af/2JaynUp5_o.png" alt="在这里插入图片描述"><br> 根据乐谱的基础知识可知，低音的下面加点，高音的上面加点，普通的不加点。</p> 
<pre><code class="prism language-c"><span class="token comment">//用枚举定义，记录所有的音频。</span>
	   <span class="token keyword">enum</span>  Low_frequency<span class="token punctuation">{<!-- --></span>l_dao<span class="token operator">=</span><span class="token number">262</span><span class="token punctuation">,</span>l_re<span class="token operator">=</span><span class="token number">286</span><span class="token punctuation">,</span>l_mi<span class="token operator">=</span><span class="token number">311</span><span class="token punctuation">,</span>l_fa<span class="token operator">=</span><span class="token number">349</span><span class="token punctuation">,</span>l_sao<span class="token operator">=</span><span class="token number">392</span><span class="token punctuation">,</span>l_la<span class="token operator">=</span><span class="token number">440</span><span class="token punctuation">,</span>l_xi<span class="token operator">=</span><span class="token number">494</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
       <span class="token keyword">enum</span>  Normal_frequency<span class="token punctuation">{<!-- --></span>dao<span class="token operator">=</span><span class="token number">523</span><span class="token punctuation">,</span>re<span class="token operator">=</span><span class="token number">587</span><span class="token punctuation">,</span>mi<span class="token operator">=</span><span class="token number">659</span><span class="token punctuation">,</span>fa<span class="token operator">=</span><span class="token number">698</span><span class="token punctuation">,</span>sao<span class="token operator">=</span><span class="token number">784</span><span class="token punctuation">,</span>la<span class="token operator">=</span><span class="token number">880</span><span class="token punctuation">,</span>xi<span class="token operator">=</span><span class="token number">987</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
       <span class="token keyword">enum</span>  High_frequency<span class="token punctuation">{<!-- --></span>h_dao<span class="token operator">=</span><span class="token number">1046</span><span class="token punctuation">,</span>h_re<span class="token operator">=</span><span class="token number">1174</span><span class="token punctuation">,</span>h_mi<span class="token operator">=</span><span class="token number">1318</span><span class="token punctuation">,</span>h_fa<span class="token operator">=</span><span class="token number">1396</span><span class="token punctuation">,</span>h_sao<span class="token operator">=</span><span class="token number">1567</span><span class="token punctuation">,</span>h_la<span class="token operator">=</span><span class="token number">1760</span><span class="token punctuation">,</span>h_xi<span class="token operator">=</span><span class="token number">1975</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="12__21"></a>1.2 乐谱对应的节拍-音长：</h3> 
<p>本次乐谱的节拍为每分钟72拍，可以算出每个节拍的时长：<br> <img src="https://images2.imgbox.com/ec/53/taRXB8as_o.png" alt=""><br> 然后看乐谱的第一小节：<br> <img src="https://images2.imgbox.com/c7/e5/v5cK8VgJ_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/a3/d0/o97ZLRZY_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/f7/ae/xxpChLgY_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/6a/76/CBKwypro_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/04/29/h0PapCdI_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/44/54/PNNooN5c_o.png" alt="在这里插入图片描述"><br> 最后将整个乐谱的音频和音长记录在两个数组里。<br> 。</p> 
<h3><a id="_37"></a>二、播放音乐的具体实现</h3> 
<h3><a id="21__39"></a>2.1 无中断的毫秒延时函数</h3> 
<pre><code class="prism language-c"><span class="token comment">//TIM_4初始化函数</span>
<span class="token keyword">void</span> <span class="token function">TIM_4</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    TIM_TimeBaseInitTypeDef  TIM_TimeBaseStructure<span class="token punctuation">;</span>
		<span class="token function">RCC_APB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB1Periph_TIM4<span class="token punctuation">,</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
    TIM_TimeBaseStructure<span class="token punctuation">.</span>TIM_Period <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	
    TIM_TimeBaseStructure<span class="token punctuation">.</span>TIM_Prescaler<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">72</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	  TIM_TimeBaseStructure<span class="token punctuation">.</span>TIM_CounterMode<span class="token operator">=</span>TIM_CounterMode_Down<span class="token punctuation">;</span>
	  TIM_TimeBaseStructure<span class="token punctuation">.</span>TIM_ClockDivision<span class="token operator">=</span>TIM_CKD_DIV1<span class="token punctuation">;</span>

    <span class="token function">TIM_TimeBaseInit</span><span class="token punctuation">(</span>TIM4<span class="token punctuation">,</span> <span class="token operator">&amp;</span>TIM_TimeBaseStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//延时n个us</span>
<span class="token keyword">void</span> <span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> nus<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	TIM4<span class="token operator">-&gt;</span>CNT<span class="token operator">=</span>nus<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	TIM4<span class="token operator">-&gt;</span>CR1<span class="token operator">|</span><span class="token operator">=</span>TIM_CR1_CEN<span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>TIM4<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> TIM_FLAG_Update<span class="token punctuation">)</span> <span class="token operator">!=</span> SET<span class="token punctuation">)</span>
		<span class="token punctuation">;</span>
	TIM4<span class="token operator">-&gt;</span>CR1<span class="token operator">&amp;</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token operator">~</span>TIM_CR1_CEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
	TIM4<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span><span class="token operator">=</span><span class="token operator">~</span><span class="token punctuation">(</span>TIM_FLAG_Update<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//延时n个毫秒</span>
<span class="token keyword">void</span> <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> nms<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> count<span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>count<span class="token operator">&lt;</span>nms<span class="token punctuation">;</span>count<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<h3><a id="22_Systick_76"></a>2.2 Systick的中断初始化和中断函数</h3> 
<p>中断初始化：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">SysTick_Init</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token comment">/* SystemFrequency /1000 1ms 中断一次
* SystemFrequency / 100000 10us 中断一次
* SystemFrequency / 1000000 1us 中断一次
*/</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SysTick_Config</span><span class="token punctuation">(</span>SystemCoreClock<span class="token operator">/</span><span class="token number">1000000</span><span class="token operator">*</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">/* Capture error */</span>
	  <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>中断函数：</p> 
<pre><code class="prism language-c"><span class="token comment">//stm32f10x_it.c,官方库函数文件里的中断函数</span>
  <span class="token comment">//以下是需要添加的代码</span>
  <span class="token macro property">#<span class="token directive keyword">define</span> Buzzer_TOGGLE		 {GPIOC-&gt;ODR ^=GPIO_Pin_0;}  </span><span class="token comment">//PC0是连接蜂鸣器的引脚</span>
  <span class="token keyword">extern</span> <span class="token keyword">int</span> C<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">SysTick_Init</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//在 SysTick_Handler函数里面添加的代码</span>
  <span class="token keyword">void</span> <span class="token function">SysTick_Handler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	Buzzer_TOGGLE<span class="token punctuation">;</span>
    <span class="token function">SysTick_Init</span><span class="token punctuation">(</span>C<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="23_mainc_110"></a>2.3 main.c文件的代码</h3> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> Buzzer_TOGGLE		 {GPIOC-&gt;ODR ^=GPIO_Pin_0;}</span><span class="token comment">//PC0连接的是蜂鸣器，可以根据自己的实际情况修改端口</span>
<span class="token keyword">int</span> C<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">key_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">TIM_4</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">Buzzer_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//PC0连接的是蜂鸣器，可以根据自己的实际情况修改端口</span>
<span class="token keyword">void</span> <span class="token function">SysTick_Init</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> nus<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> nms<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">/**
  * @brief  主函数
  * @param  无  
  * @retval 无
  */</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	   <span class="token keyword">enum</span>  Low_frequency<span class="token punctuation">{<!-- --></span>l_dao<span class="token operator">=</span><span class="token number">262</span><span class="token punctuation">,</span>l_re<span class="token operator">=</span><span class="token number">286</span><span class="token punctuation">,</span>l_mi<span class="token operator">=</span><span class="token number">311</span><span class="token punctuation">,</span>l_fa<span class="token operator">=</span><span class="token number">349</span><span class="token punctuation">,</span>l_sao<span class="token operator">=</span><span class="token number">392</span><span class="token punctuation">,</span>l_la<span class="token operator">=</span><span class="token number">440</span><span class="token punctuation">,</span>l_xi<span class="token operator">=</span><span class="token number">494</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
       <span class="token keyword">enum</span>  Normal_frequency<span class="token punctuation">{<!-- --></span>dao<span class="token operator">=</span><span class="token number">523</span><span class="token punctuation">,</span>re<span class="token operator">=</span><span class="token number">587</span><span class="token punctuation">,</span>mi<span class="token operator">=</span><span class="token number">659</span><span class="token punctuation">,</span>fa<span class="token operator">=</span><span class="token number">698</span><span class="token punctuation">,</span>sao<span class="token operator">=</span><span class="token number">784</span><span class="token punctuation">,</span>la<span class="token operator">=</span><span class="token number">880</span><span class="token punctuation">,</span>xi<span class="token operator">=</span><span class="token number">987</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
       <span class="token keyword">enum</span>  High_frequency<span class="token punctuation">{<!-- --></span>h_dao<span class="token operator">=</span><span class="token number">1046</span><span class="token punctuation">,</span>h_re<span class="token operator">=</span><span class="token number">1174</span><span class="token punctuation">,</span>h_mi<span class="token operator">=</span><span class="token number">1318</span><span class="token punctuation">,</span>h_fa<span class="token operator">=</span><span class="token number">1396</span><span class="token punctuation">,</span>h_sao<span class="token operator">=</span><span class="token number">1567</span><span class="token punctuation">,</span>h_la<span class="token operator">=</span><span class="token number">1760</span><span class="token punctuation">,</span>h_xi<span class="token operator">=</span><span class="token number">1975</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> j<span class="token punctuation">;</span>
		<span class="token keyword">int</span> i_f<span class="token punctuation">;</span>
            <span class="token comment">//以下是《渴望》片头曲的一段简谱“好人一生平安”</span>
                  <span class="token keyword">unsigned</span> <span class="token keyword">int</span>  f<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span>re<span class="token punctuation">,</span>mi<span class="token punctuation">,</span>re<span class="token punctuation">,</span>dao<span class="token punctuation">,</span>l_la<span class="token punctuation">,</span>dao<span class="token punctuation">,</span>l_la<span class="token punctuation">,</span><span class="token comment">//每行对应一小节音调</span>
                              l_sao<span class="token punctuation">,</span>l_mi<span class="token punctuation">,</span>l_sao<span class="token punctuation">,</span>l_la<span class="token punctuation">,</span>dao<span class="token punctuation">,</span>
                                  l_la<span class="token punctuation">,</span>dao<span class="token punctuation">,</span>sao<span class="token punctuation">,</span>la<span class="token punctuation">,</span>mi<span class="token punctuation">,</span>sao<span class="token punctuation">,</span>
                                  re<span class="token punctuation">,</span>
                                  mi<span class="token punctuation">,</span>re<span class="token punctuation">,</span>mi<span class="token punctuation">,</span>sao<span class="token punctuation">,</span>mi<span class="token punctuation">,</span>
                                  l_sao<span class="token punctuation">,</span>l_mi<span class="token punctuation">,</span>l_sao<span class="token punctuation">,</span>l_la<span class="token punctuation">,</span>dao<span class="token punctuation">,</span>
                              l_la<span class="token punctuation">,</span>l_la<span class="token punctuation">,</span>dao<span class="token punctuation">,</span>l_la<span class="token punctuation">,</span>l_sao<span class="token punctuation">,</span>l_re<span class="token punctuation">,</span>l_mi<span class="token punctuation">,</span>
                                    l_sao<span class="token punctuation">,</span>
                                    re<span class="token punctuation">,</span>re<span class="token punctuation">,</span>sao<span class="token punctuation">,</span>la<span class="token punctuation">,</span>sao<span class="token punctuation">,</span>
                                    fa<span class="token punctuation">,</span>mi<span class="token punctuation">,</span>sao<span class="token punctuation">,</span>mi<span class="token punctuation">,</span>
                                    la<span class="token punctuation">,</span>sao<span class="token punctuation">,</span>mi<span class="token punctuation">,</span>re<span class="token punctuation">,</span>mi<span class="token punctuation">,</span>l_la<span class="token punctuation">,</span>dao<span class="token punctuation">,</span>
                                    re<span class="token punctuation">,</span>
                                    mi<span class="token punctuation">,</span>re<span class="token punctuation">,</span>mi<span class="token punctuation">,</span>sao<span class="token punctuation">,</span>mi<span class="token punctuation">,</span>
                                    l_sao<span class="token punctuation">,</span>l_mi<span class="token punctuation">,</span>l_sao<span class="token punctuation">,</span>l_la<span class="token punctuation">,</span>dao<span class="token punctuation">,</span>
                                    l_la<span class="token punctuation">,</span>dao<span class="token punctuation">,</span>re<span class="token punctuation">,</span>l_la<span class="token punctuation">,</span>dao<span class="token punctuation">,</span>re<span class="token punctuation">,</span>mi<span class="token punctuation">,</span>
                                    re<span class="token punctuation">,</span>
                                    l_la<span class="token punctuation">,</span>dao<span class="token punctuation">,</span>re<span class="token punctuation">,</span>l_la<span class="token punctuation">,</span>dao<span class="token punctuation">,</span>re<span class="token punctuation">,</span>mi<span class="token punctuation">,</span>
                                    re<span class="token punctuation">,</span>
                                    <span class="token number">0xff</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//以0xff作为音调的结束标志</span>
            <span class="token comment">//以下是简谱中每个音调的节拍</span>
            <span class="token comment">//“4”对应4个延时单位,“2”对应两个延时单位,“1”对应1个延时单位</span>
            <span class="token keyword">unsigned</span> <span class="token keyword">char</span>  JP<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token comment">//每行对应一小节音调的节拍</span>
                            <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span>
                                <span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span>
                                <span class="token number">10</span><span class="token punctuation">,</span>
                                <span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span>
                                <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span>
                            <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span>
                                <span class="token number">10</span><span class="token punctuation">,</span>
                                <span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span>
                                <span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span>
                                <span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span>
                                <span class="token number">10</span><span class="token punctuation">,</span>
                                <span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span>
                                <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span>
                                <span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span>
                                <span class="token number">10</span><span class="token punctuation">,</span>
                                <span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span>
                                <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

	<span class="token comment">// key_init();//按键1的初始化函数，可以不用。</span>
	 <span class="token function">TIM_4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// while(GPIO_ReadInputDataBit(GPIOA,GPIO_Pin_0)==0)//等待按键按下，执行播放音乐</span>
      <span class="token comment">// delay_ms(5);</span>
		 
	 <span class="token function">Buzzer_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
		i_f<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span>f<span class="token punctuation">[</span>i_f<span class="token punctuation">]</span><span class="token operator">!=</span><span class="token number">0xff</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
        C<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token operator">*</span><span class="token number">1000</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">/</span>f<span class="token punctuation">[</span>i_f<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//ms-&gt;us:1000,s-&gt;ms:1000,方波半周期翻转:1/2</span>
		<span class="token function">SysTick_Init</span><span class="token punctuation">(</span>C<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">//翻转时长更新，重新配置翻转时长</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span>j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span>JP<span class="token punctuation">[</span>i_f<span class="token punctuation">]</span><span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span>
	     <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">208</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    i_f<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span> <span class="token function">key_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	GPIO_InitTypeDef keyInit<span class="token punctuation">;</span>
	<span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB2Periph_GPIOA<span class="token punctuation">,</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	keyInit<span class="token punctuation">.</span>GPIO_Pin<span class="token operator">=</span>GPIO_Pin_0<span class="token punctuation">;</span>
	keyInit<span class="token punctuation">.</span>GPIO_Mode<span class="token operator">=</span>GPIO_Mode_IN_FLOATING<span class="token punctuation">;</span>
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span><span class="token operator">&amp;</span>keyInit<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TIM_4</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    TIM_TimeBaseInitTypeDef  TIM_TimeBaseStructure<span class="token punctuation">;</span>
		<span class="token function">RCC_APB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB1Periph_TIM4<span class="token punctuation">,</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
    TIM_TimeBaseStructure<span class="token punctuation">.</span>TIM_Period <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	
    TIM_TimeBaseStructure<span class="token punctuation">.</span>TIM_Prescaler<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">72</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	  TIM_TimeBaseStructure<span class="token punctuation">.</span>TIM_CounterMode<span class="token operator">=</span>TIM_CounterMode_Down<span class="token punctuation">;</span>
	  TIM_TimeBaseStructure<span class="token punctuation">.</span>TIM_ClockDivision<span class="token operator">=</span>TIM_CKD_DIV1<span class="token punctuation">;</span>

    <span class="token function">TIM_TimeBaseInit</span><span class="token punctuation">(</span>TIM4<span class="token punctuation">,</span> <span class="token operator">&amp;</span>TIM_TimeBaseStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Buzzer_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
		GPIO_InitTypeDef GPIO_InitStructure<span class="token punctuation">;</span>
		<span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span> RCC_APB2Periph_GPIOC<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
		GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_0<span class="token punctuation">;</span>	
		GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_Out_PP<span class="token punctuation">;</span>     
		GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span> 
	
		<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOC<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>	
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">SysTick_Init</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token comment">/* SystemFrequency /1000 1ms 中断一次
* SystemFrequency / 100000 10us 中断一次
* SystemFrequency / 1000000 1us 中断一次
*/</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SysTick_Config</span><span class="token punctuation">(</span>SystemCoreClock<span class="token operator">/</span><span class="token number">1000000</span><span class="token operator">*</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">/* Capture error */</span>
	  <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> nus<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	TIM4<span class="token operator">-&gt;</span>CNT<span class="token operator">=</span>nus<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	TIM4<span class="token operator">-&gt;</span>CR1<span class="token operator">|</span><span class="token operator">=</span>TIM_CR1_CEN<span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>TIM4<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> TIM_FLAG_Update<span class="token punctuation">)</span> <span class="token operator">!=</span> SET<span class="token punctuation">)</span>
		<span class="token punctuation">;</span>
	TIM4<span class="token operator">-&gt;</span>CR1<span class="token operator">&amp;</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token operator">~</span>TIM_CR1_CEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
	TIM4<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span><span class="token operator">=</span><span class="token operator">~</span><span class="token punctuation">(</span>TIM_FLAG_Update<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> nms<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> count<span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>count<span class="token operator">&lt;</span>nms<span class="token punctuation">;</span>count<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*********************************************END OF FILE**********************/</span>

</code></pre> 
<p>最后，就可以听到蜂鸣器播放的音乐了。。。。。。</p> 
<h3><a id="_268"></a>三、参考书籍</h3> 
<p>《单片机C语言应用100例》，王东锋等，6.3.4 实例47：用定时器T0的模式0控制播放《好人一生平安》</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/45d4b128ccc93ea3ccc0a38f177bc86d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">哈希表/哈希冲突及解决方法（较全）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f2ea81105f09c85f75cfdbfe2f50b424/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">el-date-picker 最多只能选中一个月  选中第一个日期后  第二个日期给出可选范围限制</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>