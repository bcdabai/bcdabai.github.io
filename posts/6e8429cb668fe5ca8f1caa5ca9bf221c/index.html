<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>LVS负载均衡：LVS-NAT搭建web群集 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="LVS负载均衡：LVS-NAT搭建web群集" />
<meta property="og:description" content="LVS负载均衡：LVS-NAT搭建web群集 一：实验环境介绍二：实验架构三：实验目的四：实验步骤4.1：NFS服务器配置4.2：两台Apache服务的配置4.3：LVS配置 五：实验验证 一：实验环境介绍 VMware软件
一台centos7作为LVS网关，双网卡
两台centos7作为Apache服务器
一台centos7作为NFS存储
一台win10作为客户端
二：实验架构 三：实验目的 win10客户机访问12.0.0.1的网址，通过nat地址转换，轮询的访问到Apache1和Apache2主机
四：实验步骤 4.1：NFS服务器配置 添加两块硬盘，作为Apache1和Apache2的挂载点 [root@nfs ~]# fdisk -l //查看添加的磁盘 格式化磁盘 [root@nfs ~]# fdisk /dev/sdb //n 新建 一路回车 最后w保存退出// [root@nfs ~]# mkfs.xfs /dev/sdb1 //创建文件系统 另一块磁盘做同样操作
创建挂载点、挂载磁盘 [root@nfs ~]# mkdir /opt/apache1 /opt/apache2 [root@nfs ~]# vim /etc/fstab //末行添加 /dev/sdb1 /opt/apache1 xfs defaults 0 0 /dev/sdc1 /opt/apache2 xfs defaults 0 0 [root@nfs ~]# mount -a [root@nfs ~]# df -Th 文件系统 类型 容量 已用 可用 已用% 挂载点 /dev/mapper/centos-root xfs 47G 4." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/6e8429cb668fe5ca8f1caa5ca9bf221c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-09-04T17:59:21+08:00" />
<meta property="article:modified_time" content="2020-09-04T17:59:21+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">LVS负载均衡：LVS-NAT搭建web群集</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>LVS负载均衡：LVS-NAT搭建web群集</h4> 
 <ul><li><a href="#_1" rel="nofollow">一：实验环境介绍</a></li><li><a href="#_7" rel="nofollow">二：实验架构</a></li><li><a href="#_9" rel="nofollow">三：实验目的</a></li><li><a href="#_11" rel="nofollow">四：实验步骤</a></li><li><ul><li><a href="#41NFS_12" rel="nofollow">4.1：NFS服务器配置</a></li><li><a href="#42Apache_93" rel="nofollow">4.2：两台Apache服务的配置</a></li><li><a href="#43LVS_130" rel="nofollow">4.3：LVS配置</a></li></ul> 
  </li><li><a href="#_187" rel="nofollow">五：实验验证</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>一：实验环境介绍</h2> 
<p>VMware软件<br> 一台centos7作为LVS网关，双网卡<br> 两台centos7作为Apache服务器<br> 一台centos7作为NFS存储<br> 一台win10作为客户端</p> 
<h2><a id="_7"></a>二：实验架构</h2> 
<p><img src="https://images2.imgbox.com/bf/69/5K5EN6jg_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_9"></a>三：实验目的</h2> 
<p>win10客户机访问12.0.0.1的网址，通过nat地址转换，轮询的访问到Apache1和Apache2主机</p> 
<h2><a id="_11"></a>四：实验步骤</h2> 
<h3><a id="41NFS_12"></a>4.1：NFS服务器配置</h3> 
<ul><li>添加两块硬盘，作为Apache1和Apache2的挂载点</li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># fdisk -l  //查看添加的磁盘</span>
</code></pre> 
<ul><li>格式化磁盘</li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># fdisk /dev/sdb  </span>
//n 新建
一路回车
最后w保存退出//
<span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># mkfs.xfs /dev/sdb1  //创建文件系统</span>
</code></pre> 
<p>另一块磁盘做同样操作</p> 
<ul><li>创建挂载点、挂载磁盘</li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># mkdir /opt/apache1 /opt/apache2</span>
<span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># vim /etc/fstab</span>
//末行添加
/dev/sdb1 /opt/apache1 xfs defaults 0 0 
/dev/sdc1 /opt/apache2 xfs defaults 0 0 
<span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># mount -a</span>
<span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># df -Th</span>
文件系统                类型      容量  已用  可用 已用% 挂载点
/dev/mapper/centos-root xfs        47G  4.3G   43G   10% /
devtmpfs                devtmpfs  470M     0  470M    0% /dev
tmpfs                   tmpfs     487M     0  487M    0% /dev/shm
tmpfs                   tmpfs     487M  8.6M  478M    2% /run
tmpfs                   tmpfs     487M     0  487M    0% /sys/fs/cgroup
/dev/sda1               xfs      1014M  166M  849M   17% /boot
tmpfs                   tmpfs      98M  8.0K   98M    1% /run/user/42
tmpfs                   tmpfs      98M   32K   98M    1% /run/user/0
/dev/sdb1               xfs       5.0G   33M  5.0G    1% /opt/apache1
/dev/sdc1               xfs       5.0G   33M  5.0G    1% /opt/apache2
/dev/sr0                iso9660   4.3G  4.3G     0  100% /run/media/root/CentOS 7 x86_64
</code></pre> 
<ul><li>安装NFS相关软件</li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># rpm -q nfs-utils 	</span>
nfs-utils-1.3.0-0.48.el7.x86_64	<span class="token string">'//已经安装nfs-utils（nfs组件）'</span>
<span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># rpm -q rpcbind</span>
rpcbind-0.2.0-42.el7.x86_64	//已经安装rpcbind（远端过程调用组件）'
</code></pre> 
<ul><li>配置共享文件</li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># vim /etc/exports	</span>
/opt/apache1    192.168.100.0/24<span class="token punctuation">(</span>rw,sync,no_root_squash<span class="token punctuation">)</span>
/opt/apache2    192.168.100.0/24<span class="token punctuation">(</span>rw,sync,no_root_squash<span class="token punctuation">)</span>
<span class="token string">'//添加上述两个配置'</span>
</code></pre> 
<ul><li>开启服务并查看</li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># systemctl stop firewalld.service </span>
<span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># setenforce 0</span>
<span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># systemctl start nfs</span>
<span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># systemctl start rpcbind</span>
<span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># showmount -e</span>
Export list <span class="token keyword">for</span> nfs:
/opt/apache1 192.168.100.0/24
/opt/apache2  192.168.100.0/24
</code></pre> 
<ul><li>配置NFS服务器的网卡、IP地址<br> 网卡选择为仅主机模式、修改IP地址为192.168.100.120</li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># vim /etc/sysconfig/network-scripts/ifcfg-ens33 </span>
<span class="token string">'//...省略内容，修改为static'</span>
BOOTPROTO<span class="token operator">=</span>static
<span class="token string">'//...省略内容，尾行添加内容'</span>
IPADDR<span class="token operator">=</span>192.168.100.120
NETMASK<span class="token operator">=</span>255.255.255.0
GATEWAY<span class="token operator">=</span>192.168.100.1
<span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart network</span>
</code></pre> 
<h3><a id="42Apache_93"></a>4.2：两台Apache服务的配置</h3> 
<ul><li>两台Apache服务器安装httpd软件</li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@apache1 ~<span class="token punctuation">]</span><span class="token comment"># yum install httpd -y</span>
<span class="token punctuation">[</span>root@apache2 ~<span class="token punctuation">]</span><span class="token comment"># yum install httpd -y</span>
</code></pre> 
<ul><li>挂载NFS服务提供的存储空间<br> 首先两台Apache服务器的网络类型也要修改为仅主机模式，IP地址apache1为192.168.100.110，apache2为192.168.100.111,<br> 操作与上面相同</li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@apache1 ~<span class="token punctuation">]</span><span class="token comment"># vim /etc/fstab</span>
<span class="token string">'//尾行添加挂载配置'</span>
192.168.100.120:/opt/apache1       /var/www/html   nfs     defaults,_netdev        0 0
<span class="token punctuation">[</span>root@apache1 ~<span class="token punctuation">]</span><span class="token comment"># mount -a</span>
<span class="token punctuation">[</span>root@apache1 ~<span class="token punctuation">]</span><span class="token comment"># df -h  //查看是否挂载成功</span>
</code></pre> 
<p>apache2同样操作</p> 
<ul><li>创建测试站点文件</li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@apache1 ~<span class="token punctuation">]</span><span class="token comment"># vim /var/www/html/index.html</span>
<span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>this is apache1 web<span class="token operator">&lt;</span>/h1<span class="token operator">&gt;</span>
<span class="token punctuation">[</span>root@apache2 ~<span class="token punctuation">]</span><span class="token comment"># vim /var/www/html/index.html</span>
<span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>this is apache2 web<span class="token operator">&lt;</span>/h1<span class="token operator">&gt;</span>
</code></pre> 
<ul><li>开启Apache服务</li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@apache1 ~<span class="token punctuation">]</span><span class="token comment"># systemctl stop firewalld.service </span>
<span class="token punctuation">[</span>root@apache1 ~<span class="token punctuation">]</span><span class="token comment"># setenforce 0</span>
<span class="token punctuation">[</span>root@apache1 ~<span class="token punctuation">]</span><span class="token comment"># systemctl start httpd.service</span>
<span class="token punctuation">[</span>root@apache2 ~<span class="token punctuation">]</span><span class="token comment"># systemctl stop firewalld.service </span>
<span class="token punctuation">[</span>root@apache2 ~<span class="token punctuation">]</span><span class="token comment"># setenforce 0</span>
<span class="token punctuation">[</span>root@apache2 ~<span class="token punctuation">]</span><span class="token comment"># systemctl start httpd.service</span>
</code></pre> 
<h3><a id="43LVS_130"></a>4.3：LVS配置</h3> 
<ul><li>安装ipvsadm工具</li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@lvs ~<span class="token punctuation">]</span><span class="token comment"># yum install ipvsadm -y</span>
</code></pre> 
<ul><li>加载ip_vs模块</li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@lvs~<span class="token punctuation">]</span><span class="token comment"># modprobe ip_vs</span>
<span class="token punctuation">[</span>root@lvs~<span class="token punctuation">]</span><span class="token comment"># cat /proc/net/ip_vs</span>
IP Virtual Server version 1.2.1 <span class="token punctuation">(</span>size<span class="token operator">=</span>4096<span class="token punctuation">)</span>
Prot LocalAddress:Port Scheduler Flags
  -<span class="token operator">&gt;</span> RemoteAddress:Port Forward Weight ActiveConn InActConn
</code></pre> 
<ul><li> <p>设置双网卡<br> ens33作为外部网关 地址12.0.0.1<br> ens36作为内部网关 地址192.168.100.1<br> 配置步骤可查看之前的博客</p> </li><li> <p>开启路由转发功能</p> </li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@lvs network-scripts<span class="token punctuation">]</span><span class="token comment"># vim /etc/sysctl.conf</span>
net.ipv4.ip_forward<span class="token operator">=</span>1	<span class="token string">'//尾行插入，注意不要有#号'</span>
<span class="token punctuation">[</span>root@lvs network-scripts<span class="token punctuation">]</span><span class="token comment"># sysctl -p	'//重载路由转发功能'</span>
net.ipv4.ip_forward <span class="token operator">=</span> 1
</code></pre> 
<ul><li>清空防火墙表规则，并添加NAT地址转换规则</li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@lvs network-scripts<span class="token punctuation">]</span><span class="token comment"># iptables -F	</span>
<span class="token punctuation">[</span>root@lvs network-scripts<span class="token punctuation">]</span><span class="token comment"># iptables -t nat -F	'//清空nat地址转换表'</span>
oot@lvs network-scripts<span class="token punctuation">]</span><span class="token comment"># iptables -t nat -A POSTROUTING -o ens36 -s 192.168.100.0/24 -j SNAT --to-source 12.0.0.1 </span>
</code></pre> 
<ul><li>编写LVS调度脚本</li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@lvs ~<span class="token punctuation">]</span><span class="token comment"># ipvsadm --save &gt; /etc/sysconfig/ipvsadm</span>
<span class="token punctuation">[</span>root@lvs ~<span class="token punctuation">]</span><span class="token comment"># systemctl start ipvsadm.service</span>
<span class="token punctuation">[</span>root@lvs network-scripts<span class="token punctuation">]</span><span class="token comment"># cd /opt</span>
<span class="token punctuation">[</span>root@lvs opt<span class="token punctuation">]</span><span class="token comment"># vim nat.sh</span>
<span class="token comment">#!/bin/bash</span>
ipvsadm -C	<span class="token string">'//清空内核虚拟服务器表中的所有记录'</span>
ipvsadm -A -t 12.0.0.1:80 -s rr  
ipvsadm -a -t 12.0.0.1:80 -r 192.168.79.134:80 -m
ipvsadm -a -t 12.0.0.1:80 -r 192.168.79.135:80 -m
ipvsadm
<span class="token punctuation">[</span>root@lvs opt<span class="token punctuation">]</span><span class="token comment"># chmod +x nat.sh </span>
<span class="token punctuation">[</span>root@lvs opt<span class="token punctuation">]</span><span class="token comment"># ./nat.sh</span>
IP Virtual Server version 1.2.1 <span class="token punctuation">(</span>size<span class="token operator">=</span>4096<span class="token punctuation">)</span>
Prot LocalAddress:Port Scheduler Flags
  -<span class="token operator">&gt;</span> RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  lvs:http rr
  -<span class="token operator">&gt;</span> 192.168.79.134:http          Masq    1      0          0         
  -<span class="token operator">&gt;</span> 192.168.79.135:http          Masq    1      0          0   
</code></pre> 
<h2><a id="_187"></a>五：实验验证</h2> 
<p>win10客户端网卡也为仅主机模式，修改IP地址为12.0.0.10<br> 打开游览器访问http://12.0.0.1<br> <img src="https://images2.imgbox.com/46/68/qYwT1zjC_o.png" alt="在这里插入图片描述"><br> 点击刷新<br> <img src="https://images2.imgbox.com/9d/5c/Zh4yMkL7_o.png" alt="在这里插入图片描述"><br> 注：如果不能轮询的访问两个网址，可清空游览器缓存，过一会再访问，或者换一个IP地址（12.0.0.0/8）再次访问。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7cca70ab14ddc13b68449e9b979c03bf/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">2020年算法工程师技术路线图</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7d97d9e613c7dad1fa2fa4ef473d3fec/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">[OC RunLoop_翻译]五、配置运行循环源</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>