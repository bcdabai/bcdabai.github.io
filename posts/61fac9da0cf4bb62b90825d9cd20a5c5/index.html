<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android是如何使用selinux来保护系统属性的 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android是如何使用selinux来保护系统属性的" />
<meta property="og:description" content="Android是如何使用selinux来保护系统属性的 尝试获取Android设备的序列号SerialNo1 Build.SERIAL2 Build.getSerial()3 SystemProperties.get App读取属性流程分析跟踪读取属性的代码流程相关数据结构的初始化 Init初始化属性系统property_initCreateSerializedPropertyInfo__system_property_area_initproperty_info_area.LoadDefaultPath() export_kernel_boot_propsproperty_load_boot_defaults App读取属性是如何被拦截的总结相关源码 尝试获取Android设备的序列号SerialNo 因为业务需求， 我们需要获取到Android设备的序列号(SerialNo)。首先看一下Android提供的用于获取序列号的Api以及Api实现。
1 Build.SERIAL /** * A hardware serial number, if available. Alphanumeric only, case-insensitive. * This field is always set to {@link Build#UNKNOWN}. * * @deprecated Use {@link #getSerial()} instead. **/ @Deprecated // IMPORTANT: This field should be initialized via a function call to // prevent its value being inlined in the app during compilation because // we will later set it to the value based on the app&#39;s target SDK." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/61fac9da0cf4bb62b90825d9cd20a5c5/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-12-24T17:15:26+08:00" />
<meta property="article:modified_time" content="2021-12-24T17:15:26+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android是如何使用selinux来保护系统属性的</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>Android是如何使用selinux来保护系统属性的</h4> 
 <ul><li><a href="#AndroidSerialNo_2" rel="nofollow">尝试获取Android设备的序列号SerialNo</a></li><li><ul><li><a href="#1_BuildSERIAL_6" rel="nofollow">1 Build.SERIAL</a></li><li><a href="#2_BuildgetSerial_26" rel="nofollow">2 Build.getSerial()</a></li><li><a href="#3_SystemPropertiesget_95" rel="nofollow">3 SystemProperties.get</a></li></ul> 
  </li><li><a href="#App_119" rel="nofollow">App读取属性流程分析</a></li><li><ul><li><a href="#_123" rel="nofollow">跟踪读取属性的代码流程</a></li><li><a href="#_281" rel="nofollow">相关数据结构的初始化</a></li></ul> 
  </li><li><a href="#Init_543" rel="nofollow">Init初始化属性系统</a></li><li><ul><li><a href="#property_init_563" rel="nofollow">property_init</a></li><li><ul><li><a href="#CreateSerializedPropertyInfo_591" rel="nofollow">CreateSerializedPropertyInfo</a></li><li><a href="#__system_property_area_init_711" rel="nofollow">__system_property_area_init</a></li><li><a href="#property_info_areaLoadDefaultPath_955" rel="nofollow">property_info_area.LoadDefaultPath()</a></li></ul> 
   </li><li><a href="#export_kernel_boot_props_1006" rel="nofollow">export_kernel_boot_props</a></li><li><a href="#property_load_boot_defaults_1035" rel="nofollow">property_load_boot_defaults</a></li></ul> 
  </li><li><a href="#App_1262" rel="nofollow">App读取属性是如何被拦截的</a></li><li><a href="#_1447" rel="nofollow">总结</a></li><li><a href="#_1453" rel="nofollow">相关源码</a></li></ul> 
</div> 
<p></p> 
<h2><a id="AndroidSerialNo_2"></a>尝试获取Android设备的序列号SerialNo</h2> 
<p>因为业务需求， 我们需要获取到Android设备的序列号(SerialNo)。首先看一下Android提供的用于获取序列号的Api以及Api实现。</p> 
<h3><a id="1_BuildSERIAL_6"></a>1 Build.SERIAL</h3> 
<pre><code class="prism language-java">
    <span class="token comment">/**
     * A hardware serial number, if available. Alphanumeric only, case-insensitive.
     * This field is always set to {@link Build#UNKNOWN}.
     *
     * @deprecated Use {@link #getSerial()} instead.
     **/</span>
    <span class="token annotation punctuation">@Deprecated</span>
    <span class="token comment">// IMPORTANT: This field should be initialized via a function call to</span>
    <span class="token comment">// prevent its value being inlined in the app during compilation because</span>
    <span class="token comment">// we will later set it to the value based on the app's target SDK.</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> SERIAL <span class="token operator">=</span> <span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"no.such.thing"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>早期的Android版本中，可以直接通过调用Build.SERIAL来获取序列号，在高版本中，为了保护个人隐私， 不让第三方应用轻易获取序列号。所以该Api已经过时， 并且它的值也被设置成了"unknown"。</p> 
<h3><a id="2_BuildgetSerial_26"></a>2 Build.getSerial()</h3> 
<p>先看一下该Api的源码, 该源码实现在<code>frameworks/base/core/java/android/os/Build.java</code>：</p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@SuppressAutoDoc</span> <span class="token comment">// No support for device / profile owner.</span>
    <span class="token annotation punctuation">@RequiresPermission</span><span class="token punctuation">(</span><span class="token class-name">Manifest</span><span class="token punctuation">.</span>permission<span class="token punctuation">.</span>READ_PRIVILEGED_PHONE_STATE<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getSerial</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">IDeviceIdentifiersPolicyService</span> service <span class="token operator">=</span> <span class="token class-name">IDeviceIdentifiersPolicyService<span class="token punctuation">.</span>Stub</span>
                <span class="token punctuation">.</span><span class="token function">asInterface</span><span class="token punctuation">(</span><span class="token class-name">ServiceManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span>DEVICE_IDENTIFIERS_SERVICE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Application</span> application <span class="token operator">=</span> <span class="token class-name">ActivityThread</span><span class="token punctuation">.</span><span class="token function">currentApplication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> callingPackage <span class="token operator">=</span> application <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> application<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> service<span class="token punctuation">.</span><span class="token function">getSerialForPackage</span><span class="token punctuation">(</span>callingPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> UNKNOWN<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>调用该Api需要READ_PRIVILEGED_PHONE_STATE权限， 该权限是一个protectLevel为signature的系统级权限，只有系统签名的系统App才能获取该权限， 第三方App是无法获取的。</p> 
<p>该权限定义在<code>frameworks/base/core/res/AndroidManifest.xml</code>中:</p> 
<pre><code class="prism language-xml">    <span class="token comment">&lt;!-- @SystemApi Allows read access to privileged phone state.
         @hide Used internally. --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>android.permission.READ_PRIVILEGED_PHONE_STATE<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>protectionLevel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>signature|privileged<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre> 
<p>所以第三方应用无法通过调用getSerial() 来获取序列号。</p> 
<p>接下来， 我们看一下DeviceIdentifiersPolicyService中getSerial()的实现。 代码位置在：</p> 
<p><code>frameworks/base/services/core/java/com/android/server/os/DeviceIdentifiersPolicyService.java</code></p> 
<p>getSerial方法的实现为：</p> 
<pre><code class="prism language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> <span class="token function">getSerial</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Since this invocation is on the server side a null value is used for the</span>
            <span class="token comment">// callingPackage as the server's package name (typically android) should not be used</span>
            <span class="token comment">// for any device / profile owner checks. The majority of requests for the serial number</span>
            <span class="token comment">// should use the getSerialForPackage method with the calling package specified.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">TelephonyPermissions</span><span class="token punctuation">.</span><span class="token function">checkCallingOrSelfReadDeviceIdentifiers</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span>
                    <span class="token comment">/* callingPackage */</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"getSerial"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token class-name">Build</span><span class="token punctuation">.</span>UNKNOWN<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token class-name">SystemProperties</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"ro.serialno"</span><span class="token punctuation">,</span> <span class="token class-name">Build</span><span class="token punctuation">.</span>UNKNOWN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> <span class="token function">getSerialForPackage</span><span class="token punctuation">(</span><span class="token class-name">String</span> callingPackage<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">TelephonyPermissions</span><span class="token punctuation">.</span><span class="token function">checkCallingOrSelfReadDeviceIdentifiers</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span>
                    callingPackage<span class="token punctuation">,</span> <span class="token string">"getSerial"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token class-name">Build</span><span class="token punctuation">.</span>UNKNOWN<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token class-name">SystemProperties</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"ro.serialno"</span><span class="token punctuation">,</span> <span class="token class-name">Build</span><span class="token punctuation">.</span>UNKNOWN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p><code>TelephonyPermissions.checkCallingOrSelfReadDeviceIdentifiers</code>即是校验调用方的权限，没有权限的话，会直接返回"unknown"。</p> 
<p>从这句代码<code>return SystemProperties.get("ro.serialno", Build.UNKNOWN);</code>来看，DeviceIdentifiersPolicyService也是通过读取系统属性ro.serialno来获取序列号的。这里调用SystemProperties.get的进程为system_server。所以我们想要验证一下， 普通App是否也可以直接读取到这个属性。</p> 
<h3><a id="3_SystemPropertiesget_95"></a>3 SystemProperties.get</h3> 
<p>因为SystemProperties是隐藏Api， 所以我们通过反射来调用。代码如下：</p> 
<pre><code class="prism language-java">    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"android.os.SystemProperties"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Method</span> m <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>m<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"ro.serialno"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>但是执行该代码后，发现无法获取ro.serialno的值，并且会打印如下日志:</p> 
<pre><code class="prism language-shell">E/libc: Access denied finding property <span class="token string">"ro.serialno"</span>
</code></pre> 
<p>该日志说明，我们读取ro.serialno属性的操作被拒绝了。</p> 
<br> 
<h2><a id="App_119"></a>App读取属性流程分析</h2> 
<p>下面我们深入解析一下属性相关的源码。我们从读取属性的流程来跟踪源码，也会解析一下App中属性的初始化以及关键数据结构的创建。</p> 
<h3><a id="_123"></a>跟踪读取属性的代码流程</h3> 
<p>接下来理一下读取系统属性的流程。</p> 
<p>首先看一下入口SystemProperties.get方法，代码所在文件为<code>frameworks/base/core/java/android/os/SystemProperties.java</code></p> 
<pre><code class="prism language-java">    <span class="token comment">/**
     * Get the String value for the given {@code key}.
     *
     * @param key the key to lookup
     * @return an empty string if the {@code key} isn't found
     * @hide
     */</span>
    <span class="token annotation punctuation">@NonNull</span>
    <span class="token annotation punctuation">@SystemApi</span>
    <span class="token annotation punctuation">@TestApi</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>TRACK_KEY_ACCESS<span class="token punctuation">)</span> <span class="token function">onKeyAccess</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">native_get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@UnsupportedAppUsage</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token class-name">String</span> <span class="token function">native_get</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>接下来我们找到native_get的native实现的入口函数，经过搜索， 发现它实现在<code>frameworks/base/core/jni/android_os_SystemProperties.cpp</code>中：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">register_android_os_SystemProperties</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> JNINativeMethod method_table<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">{<!-- --></span> <span class="token string">"native_get"</span><span class="token punctuation">,</span> <span class="token string">"(Ljava/lang/String;)Ljava/lang/String;"</span><span class="token punctuation">,</span>
          <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span> SystemProperties_getS <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span> <span class="token string">"native_get"</span><span class="token punctuation">,</span>
          <span class="token string">"(Ljava/lang/String;Ljava/lang/String;)Ljava/lang/String;"</span><span class="token punctuation">,</span>
          <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span> SystemProperties_getSS <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span> <span class="token string">"native_get_int"</span><span class="token punctuation">,</span> <span class="token string">"(Ljava/lang/String;I)I"</span><span class="token punctuation">,</span>
          <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span> SystemProperties_get_integral<span class="token operator">&lt;</span>jint<span class="token operator">&gt;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span> <span class="token string">"native_get_long"</span><span class="token punctuation">,</span> <span class="token string">"(Ljava/lang/String;J)J"</span><span class="token punctuation">,</span>
          <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span> SystemProperties_get_integral<span class="token operator">&lt;</span>jlong<span class="token operator">&gt;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span> <span class="token string">"native_get_boolean"</span><span class="token punctuation">,</span> <span class="token string">"(Ljava/lang/String;Z)Z"</span><span class="token punctuation">,</span>
          <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span> SystemProperties_get_boolean <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span> <span class="token string">"native_set"</span><span class="token punctuation">,</span> <span class="token string">"(Ljava/lang/String;Ljava/lang/String;)V"</span><span class="token punctuation">,</span>
          <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span> SystemProperties_set <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span> <span class="token string">"native_add_change_callback"</span><span class="token punctuation">,</span> <span class="token string">"()V"</span><span class="token punctuation">,</span>
          <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span> SystemProperties_add_change_callback <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span> <span class="token string">"native_report_sysprop_change"</span><span class="token punctuation">,</span> <span class="token string">"()V"</span><span class="token punctuation">,</span>
          <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span> SystemProperties_report_sysprop_change <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">RegisterMethodsOrDie</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">"android/os/SystemProperties"</span><span class="token punctuation">,</span>
                                method_table<span class="token punctuation">,</span> <span class="token function">NELEM</span><span class="token punctuation">(</span>method_table<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


jstring <span class="token function">SystemProperties_getSS</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jclass clazz<span class="token punctuation">,</span> jstring keyJ<span class="token punctuation">,</span>
                               jstring defJ<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Using ConvertKeyAndForward is sub-optimal for copying the key string,</span>
    <span class="token comment">// but improves reuse and reasoning over code.</span>
    <span class="token keyword">auto</span> handler <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> key<span class="token punctuation">,</span> jstring defJ<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        std<span class="token operator">::</span>string prop_val <span class="token operator">=</span> android<span class="token operator">::</span>base<span class="token operator">::</span><span class="token function">GetProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prop_val<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> env<span class="token operator">-&gt;</span><span class="token function">NewStringUTF</span><span class="token punctuation">(</span>prop_val<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>defJ <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> defJ<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// This function is specified to never return null (or have an</span>
        <span class="token comment">// exception pending).</span>
        <span class="token keyword">return</span> env<span class="token operator">-&gt;</span><span class="token function">NewStringUTF</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">ConvertKeyAndForward</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> keyJ<span class="token punctuation">,</span> defJ<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

jstring <span class="token function">SystemProperties_getS</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jclass clazz<span class="token punctuation">,</span> jstring keyJ<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">SystemProperties_getSS</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span> keyJ<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>SystemProperties_getSS方法中，真正执行获取属性的代码为<code>android::base::GetProperty(key, "")</code>，该方法实现在<code>system/core/base/properties.cpp</code>中：</p> 
<pre><code class="prism language-cpp">std<span class="token operator">::</span>string <span class="token function">GetProperty</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> key<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> default_value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  std<span class="token operator">::</span>string property_value<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__BIONIC__<span class="token punctuation">)</span></span></span>
  <span class="token keyword">const</span> prop_info<span class="token operator">*</span> pi <span class="token operator">=</span> <span class="token function">__system_property_find</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>pi <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token keyword">return</span> default_value<span class="token punctuation">;</span>

  <span class="token function">__system_property_read_callback</span><span class="token punctuation">(</span>pi<span class="token punctuation">,</span>
                                  <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> cookie<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> value<span class="token punctuation">,</span> <span class="token keyword">unsigned</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                    <span class="token keyword">auto</span> property_value <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>std<span class="token operator">::</span>string<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token operator">*</span>property_value <span class="token operator">=</span> value<span class="token punctuation">;</span>
                                  <span class="token punctuation">}</span><span class="token punctuation">,</span>
                                  <span class="token operator">&amp;</span>property_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
  <span class="token keyword">auto</span> it <span class="token operator">=</span> g_properties<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>it <span class="token operator">==</span> g_properties<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> default_value<span class="token punctuation">;</span>
  property_value <span class="token operator">=</span> it<span class="token operator">-&gt;</span>second<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
  <span class="token comment">// If the property exists but is empty, also return the default value.</span>
  <span class="token comment">// Since we can't remove system properties, "empty" is traditionally</span>
  <span class="token comment">// the same as "missing" (this was true for cutils' property_get).</span>
  <span class="token keyword">return</span> property_value<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> default_value <span class="token operator">:</span> property_value<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>GetProperty函数的内部逻辑，会根据<code>__BIONIC__</code>这个宏是否定义，分两个不同的逻辑。可以看到如果该宏已定义的话，会继续调用__system_property_find, 如果该宏未定义，则从全局变量g_properties中读取。</p> 
<p>从逻辑的复杂度来看，g_properties 逻辑比较简单，并且也没有什么保活措施，属性应该是随意读取的，应该是兼容的旧版本。g_properties的值也没有被初始化。</p> 
<p>并且经过追踪<code>__BIONIC__</code>的定义，发现<code>system/core/base/properties.cpp</code>引用了头文件<code>#include "android-base/properties.h"</code>, 这个头文件又引用了<code>#include &lt;sys/cdefs.h&gt;</code>,这个头文件中定义了<code>__BIONIC__</code> ：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__BIONIC__</span> <span class="token expression"><span class="token number">1</span></span></span>
</code></pre> 
<p>所以GetProperty会继续调用__system_property_find。__system_property_find实现在<code>bionic/libc/bionic/system_property_api.cpp</code>中:</p> 
<pre><code class="prism language-cpp">__BIONIC_WEAK_FOR_NATIVE_BRIDGE
<span class="token keyword">const</span> prop_info<span class="token operator">*</span> <span class="token function">__system_property_find</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> system_properties<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>system_properties是一个全局对象，对应的类为SystemProperties:</p> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> SystemProperties system_properties<span class="token punctuation">;</span>
<span class="token keyword">static_assert</span><span class="token punctuation">(</span><span class="token function">__is_trivially_constructible</span><span class="token punctuation">(</span>SystemProperties<span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token string">"System Properties must be trivially constructable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>SystemProperties类定义在<code>bionic/libc/system_properties/include/system_properties/system_properties.h</code>中，实现在<code>bionic/libc/system_properties/system_properties.cpp</code>中， 实现代码比较多， 我们直接看Find方法的实现：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">const</span> prop_info<span class="token operator">*</span> <span class="token class-name">SystemProperties</span><span class="token operator">::</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>initialized_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  prop_area<span class="token operator">*</span> pa <span class="token operator">=</span> contexts_<span class="token operator">-&gt;</span><span class="token function">GetPropAreaForName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pa<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">async_safe_format_log</span><span class="token punctuation">(</span>ANDROID_LOG_ERROR<span class="token punctuation">,</span> <span class="token string">"libc"</span><span class="token punctuation">,</span> <span class="token string">"Access denied finding property \"%s\""</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> pa<span class="token operator">-&gt;</span><span class="token function">find</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>Find方法调用成员变量contexts_的GetPropAreaForName方法来获取一个prop_area，如果无法获取，则打印<code>Access denied finding property</code>日志。 这跟我们上面通过反射SystemProperties.get方法时，打印出来的日志是一致的，这也证明我们跟踪代码的方向是正确的。</p> 
<p>所以可以确定，Android拦截读取属性的逻辑，是在<code>contexts_-&gt;GetPropAreaForName</code>里面实现的。</p> 
<br> 
<h3><a id="_281"></a>相关数据结构的初始化</h3> 
<p>我们接着上面的流程继续深入分析。首先看一下contexts_是如何被初始化的。 该成员变量的初始化，在成员函数Init中：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">bool</span> <span class="token class-name">SystemProperties</span><span class="token operator">::</span><span class="token function">Init</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> filename<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// This is called from __libc_init_common, and should leave errno at 0 (http://b/37248982).</span>
  ErrnoRestorer errno_restorer<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>initialized_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    contexts_<span class="token operator">-&gt;</span><span class="token function">ResetAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> PROP_FILENAME_MAX<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">strcpy</span><span class="token punctuation">(</span>property_filename_<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// property_filename_ 的值为PROP_FILENAME #define PROP_FILENAME "/dev/__properties__"</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_dir</span><span class="token punctuation">(</span>property_filename_<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"/dev/__properties__/property_info"</span><span class="token punctuation">,</span> R_OK<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      contexts_ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token punctuation">(</span>contexts_data_<span class="token punctuation">)</span> <span class="token function">ContextsSerialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>contexts_<span class="token operator">-&gt;</span><span class="token function">Initialize</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> property_filename_<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      contexts_ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token punctuation">(</span>contexts_data_<span class="token punctuation">)</span> <span class="token function">ContextsSplit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>contexts_<span class="token operator">-&gt;</span><span class="token function">Initialize</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> property_filename_<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    contexts_ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token punctuation">(</span>contexts_data_<span class="token punctuation">)</span> <span class="token function">ContextsPreSplit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>contexts_<span class="token operator">-&gt;</span><span class="token function">Initialize</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> property_filename_<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  initialized_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>初始化的时候，首先会将构造方法中的参数filename拷贝到成员变量property_filename_中，可以从调用构造方法的地方追代码，可以得知property_filename_的值为<code>"/dev/__properties__"</code>， 是一个目录 :</p> 
<pre><code class="prism language-bash"><span class="token function">ls</span> -l /dev <span class="token operator">|</span> <span class="token function">grep</span> properties                                          
drwx--x--x  <span class="token number">2</span> root      root             <span class="token number">8920</span> <span class="token number">2021</span>-11-02 <span class="token number">17</span>:42 __properties__
</code></pre> 
<p>尽然它是一个目录， 则会走到<code>if (access("/dev/__properties__/property_info", R_OK) == 0)</code>这个if语句。 这个if语句会判断<code>/dev/__properties__/property_info</code>这个文件是否可读。我们看一下这个文件的权限信息：</p> 
<pre><code class="prism language-bash"><span class="token function">ls</span> -l /dev/__properties__/property_info
-r--r--r-- <span class="token number">1</span> root root <span class="token number">98768</span> <span class="token number">2021</span>-11-02 <span class="token number">17</span>:42 /dev/__properties__/property_info
</code></pre> 
<p>这个文件对于所有的用户都有读权限。 所以会继续执行以下逻辑 :</p> 
<pre><code class="prism language-cpp">      contexts_ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token punctuation">(</span>contexts_data_<span class="token punctuation">)</span> <span class="token function">ContextsSerialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>contexts_<span class="token operator">-&gt;</span><span class="token function">Initialize</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> property_filename_<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
</code></pre> 
<p>我们之所以分析这个逻辑， 就是为了要知道， contexts_对象的真实类型。 现在我们知道， 它的真实类型是ContextsSerialized。</p> 
<p>所以结合上一节的分析， 拦截读取属性的逻辑， 是在ContextsSerialized类的GetPropAreaForName方法中实现的。下面我们去看这个方法的实现。 在文件<code>bionic/libc/system_properties/contexts_serialized.cpp</code> 中：</p> 
<pre><code class="prism language-cpp">prop_area<span class="token operator">*</span> <span class="token class-name">ContextsSerialized</span><span class="token operator">::</span><span class="token function">GetPropAreaForName</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">uint32_t</span> index<span class="token punctuation">;</span>
  property_info_area_file_<span class="token operator">-&gt;</span><span class="token function">GetPropertyInfoIndexes</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>index<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">==</span> <span class="token operator">~</span><span class="token number">0u</span> <span class="token operator">||</span> index <span class="token operator">&gt;=</span> num_context_nodes_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">async_safe_format_log</span><span class="token punctuation">(</span>ANDROID_LOG_ERROR<span class="token punctuation">,</span> <span class="token string">"libc"</span><span class="token punctuation">,</span> <span class="token string">"Could not find context for property \"%s\""</span><span class="token punctuation">,</span>
                          name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">auto</span><span class="token operator">*</span> context_node <span class="token operator">=</span> <span class="token operator">&amp;</span>context_nodes_<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>context_node<span class="token operator">-&gt;</span><span class="token function">pa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// We explicitly do not check no_access_ in this case because unlike the</span>
    <span class="token comment">// case of foreach(), we want to generate an selinux audit for each</span>
    <span class="token comment">// non-permitted property access in this function.</span>
    context_node<span class="token operator">-&gt;</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> context_node<span class="token operator">-&gt;</span><span class="token function">pa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>该方法的核心逻辑有三个。</p> 
<ol><li>通过property_info_area_file_-&gt;GetPropertyInfoIndexes根据属性名称(这里是ro.serialno)获取一个索引inidex；</li><li>通过&amp;context_nodes_[index]获取一个context_node指针；</li><li>通过context_node-&gt;pa()获取prop_area指针， 并将该指针返回。</li></ol> 
<p>property_info_area_file_和context_nodes_都是在ContextsSerialized的Initialize方法中初始化的。我们看一下Initialize方法，以便可以得知property_info_area_file_和context_nodes_到底是做什么的。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">bool</span> <span class="token class-name">ContextsSerialized</span><span class="token operator">::</span><span class="token function">Initialize</span><span class="token punctuation">(</span><span class="token keyword">bool</span> writable<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> filename<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token operator">*</span> fsetxattr_failed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

<span class="token comment">// filename_ 的值为PROP_FILENAME #define PROP_FILENAME "/dev/__properties__"</span>
  filename_ <span class="token operator">=</span> filename<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">InitializeProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>writable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">mkdir</span><span class="token punctuation">(</span>filename_<span class="token punctuation">,</span> S_IRWXU <span class="token operator">|</span> S_IXGRP <span class="token operator">|</span> S_IXOTH<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> open_failed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fsetxattr_failed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token operator">*</span>fsetxattr_failed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_context_nodes_<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>context_nodes_<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> fsetxattr_failed<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        open_failed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>open_failed <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">MapSerialPropertyArea</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> fsetxattr_failed<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">FreeAndUnmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">MapSerialPropertyArea</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">FreeAndUnmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>Initialize方法又调用了InitializeProperties方法。 InitializeProperties方法代码如下:</p> 
<pre><code class="prism language-cpp"><span class="token keyword">bool</span> <span class="token class-name">ContextsSerialized</span><span class="token operator">::</span><span class="token function">InitializeProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>property_info_area_file_<span class="token punctuation">.</span><span class="token function">LoadDefaultPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">InitializeContextNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">FreeAndUnmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>从property_info_area_file_.LoadDefaultPath()来看， 是从一个文件中加载数据。InitializeContextNodes用来初始化ContextNodes。</p> 
<p>我们先看一下LoadDefaultPath这个方法，实现在<code>system/core/property_service/libpropertyinfoparser/property_info_parser.cpp</code>中：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">bool</span> <span class="token class-name">PropertyInfoAreaFile</span><span class="token operator">::</span><span class="token function">LoadDefaultPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token function">LoadPath</span><span class="token punctuation">(</span><span class="token string">"/dev/__properties__/property_info"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token class-name">PropertyInfoAreaFile</span><span class="token operator">::</span><span class="token function">LoadPath</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> filename<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> O_CLOEXEC <span class="token operator">|</span> O_NOFOLLOW <span class="token operator">|</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">struct</span> <span class="token class-name">stat</span> fd_stat<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fstat</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fd_stat<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fd_stat<span class="token punctuation">.</span>st_uid <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>fd_stat<span class="token punctuation">.</span>st_gid <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span>
      <span class="token punctuation">(</span><span class="token punctuation">(</span>fd_stat<span class="token punctuation">.</span>st_mode <span class="token operator">&amp;</span> <span class="token punctuation">(</span>S_IWGRP <span class="token operator">|</span> S_IWOTH<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span>
      <span class="token punctuation">(</span>fd_stat<span class="token punctuation">.</span>st_size <span class="token operator">&lt;</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>off_t<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>PropertyInfoArea<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">auto</span> mmap_size <span class="token operator">=</span> fd_stat<span class="token punctuation">.</span>st_size<span class="token punctuation">;</span>

  <span class="token keyword">void</span><span class="token operator">*</span> map_result <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span> mmap_size<span class="token punctuation">,</span> PROT_READ<span class="token punctuation">,</span> MAP_SHARED<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>map_result <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">auto</span> property_info_area <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>PropertyInfoArea<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>map_result<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>property_info_area<span class="token operator">-&gt;</span><span class="token function">minimum_supported_version</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">||</span>
      property_info_area<span class="token operator">-&gt;</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> mmap_size<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">munmap</span><span class="token punctuation">(</span>map_result<span class="token punctuation">,</span> mmap_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  mmap_base_ <span class="token operator">=</span> map_result<span class="token punctuation">;</span>
  mmap_size_ <span class="token operator">=</span> mmap_size<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>LoadDefaultPath又调用LoadPath, 将<code>/dev/__properties__/property_info</code>这个文件, 通过mmap映射到当前进程的内存空间中， 起始地址为map_result 。然后通过<code>auto property_info_area = reinterpret_cast&lt;PropertyInfoArea*&gt;(map_result);</code>这句代码来看，<code>/dev/__properties__/property_info</code>这个文件中，存放的是序列化的PropertyInfoArea对象。整个文件映射到内存中后，就是一个PropertyInfoArea数组。</p> 
<p>所以到现在我们可以知道，为什么SystemProperties中的contexts_的类型为ContextsSerialized。</p> 
<p>但是现在我们还不知道<code>/dev/__properties__/property_info</code>中到底是什么对象。</p> 
<p>下面我们接着看InitializeContextNodes的实现:</p> 
<pre><code class="prism language-cpp"><span class="token keyword">bool</span> <span class="token class-name">ContextsSerialized</span><span class="token operator">::</span><span class="token function">InitializeContextNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">auto</span> num_context_nodes <span class="token operator">=</span> property_info_area_file_<span class="token operator">-&gt;</span><span class="token function">num_contexts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">auto</span> context_nodes_mmap_size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ContextNode<span class="token punctuation">)</span> <span class="token operator">*</span> num_context_nodes<span class="token punctuation">;</span>
  <span class="token comment">// We want to avoid malloc in system properties, so we take an anonymous map instead (b/31659220).</span>
  <span class="token keyword">void</span><span class="token operator">*</span> <span class="token keyword">const</span> map_result <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span> context_nodes_mmap_size<span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span>
                                MAP_PRIVATE <span class="token operator">|</span> MAP_ANONYMOUS<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>map_result <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">prctl</span><span class="token punctuation">(</span>PR_SET_VMA<span class="token punctuation">,</span> PR_SET_VMA_ANON_NAME<span class="token punctuation">,</span> map_result<span class="token punctuation">,</span> context_nodes_mmap_size<span class="token punctuation">,</span>
        <span class="token string">"System property context nodes"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  context_nodes_ <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>ContextNode<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>map_result<span class="token punctuation">)</span><span class="token punctuation">;</span>
  num_context_nodes_ <span class="token operator">=</span> num_context_nodes<span class="token punctuation">;</span>
  context_nodes_mmap_size_ <span class="token operator">=</span> context_nodes_mmap_size<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_context_nodes<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">new</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>context_nodes_<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">ContextNode</span><span class="token punctuation">(</span>property_info_area_file_<span class="token operator">-&gt;</span><span class="token function">context</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> filename_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>首先从property_info_area_file_中获取contexts的个数。这个property_info_area_file_我们上面说过，他是读取的<code>/dev/__properties__/property_info</code>文件，文件中是序列化的对象，所以可以认为，对象的个数，就是num_context_nodes 。</p> 
<p>然后根据num_context_nodes 计算创建ContextNode所需要的内存空间， 通过mmap匿名映射一块内存，映射后内存的起始地址为map_result, 通过<code>context_nodes_ = reinterpret_cast&lt;ContextNode*&gt;(map_result)</code>这行代码， 将这块内存当做context_nodes_ 数组。</p> 
<p>最后通过for循环，创建各个ContextNode。</p> 
<p>总结一下上面的逻辑：</p> 
<p>从property_info_area_file_中读取序列化的对象PropertyInfoArea，通过这些序列化的对象，创建多个ContextNode，并将这些ContextNode对象，放到一个数组context_nodes_中。可以认为一个PropertyInfoArea对象，对应一个ContextNode对象。</p> 
<p>但是分析到这里，我们还是不知道这些对象到底是什么。要搞明白这个问题， 我们就要知道<code>/dev/__properties__/property_info</code>文件中存放的到底是什么数据。 但是这个文件是序列化的，通过cat命令，打印出来的都是乱码：</p> 
<pre><code class="prism language-bash">device_type�Dwake_on_hotplug0�D�D�D�@������hw<span class="token variable"><span class="token variable">`</span>���x�x�p���������hwui<span class="token operator">|</span>���
Luse_vulkan��
             ���
                ���
��������imei_match����������recovery������status<span class="token punctuation">(</span>�<span class="token variable">`</span></span>�D�<span class="token variable"><span class="token variable">`</span>�8�	��������imei_rpmbH�X������status<span class="token operator">|</span>���������
                        ��������incremental����a����enable������������������init�P�,�,����������userspace_reboot0�@�
                                  �is_supportedl�������<span class="token operator">|</span>���������kernel����Lqemu���T������������������android���L	bootanim�T�4�4�,���������ebpf8�H�	Lsupportedp���������L����qemu����������	e����khungtask��$���$�����������lib_gui������frame_event_history_size@�T�T�T�P�e����llkp�����������������lmk������<span class="token operator">&lt;</span>�<span class="token variable">`</span></span>�����������<span class="token punctuation">(</span>�H�p����D	critical��Dcritical_upgrade�Ddebug<span class="token punctuation">(</span>�D	downgrade_pressureL�Dkill_heaviest_taskp�D	kill_timeout_ms��D	low��D	medium��D	psi_complete_stall_ms��D	psi_partial_stall_ms
</code></pre> 
<p>所以我们还是只能通过读代码去分析。</p> 
<p>下面我们看一下这个文件是如何初始化的。 属性的初始化是在init中， 下面我们继续分析init中属性初始化相关的代码。</p> 
<br> 
<h2><a id="Init_543"></a>Init初始化属性系统</h2> 
<p>init的代码所在文件为<code>system/core/init/init.cpp</code>，从这个文件中搜索<code>property</code>关键字，可以找到如下代码:</p> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">SecondStageMain</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//......</span>
    <span class="token function">property_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//......</span>
    
    <span class="token comment">// Propagate the kernel variables to internal variables</span>
    <span class="token comment">// used by init as well as the current required properties.</span>
    <span class="token function">export_kernel_boot_props</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//......</span>
    <span class="token function">property_load_boot_defaults</span><span class="token punctuation">(</span>load_debug_prop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//......</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="property_init_563"></a>property_init</h3> 
<p>首先看property_init方法的实现：</p> 
<p>property_init这个函数实现在<code>system/core/init/property_service.cpp</code>中:</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">property_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token string">"/dev/__properties__"</span><span class="token punctuation">,</span> S_IRWXU <span class="token operator">|</span> S_IXGRP <span class="token operator">|</span> S_IXOTH<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CreateSerializedPropertyInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__system_property_area_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to initialize property area"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>property_info_area<span class="token punctuation">.</span><span class="token function">LoadDefaultPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to load serialized property info file"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这个方法中的逻辑还算清晰。分四步</p> 
<ol><li>创建/dev/__properties__这个目录</li><li>CreateSerializedPropertyInfo</li><li>__system_property_area_init</li><li>property_info_area.LoadDefaultPath()</li></ol> 
<p>为了得到更多细节， 我们分别看一下这几个方法。</p> 
<h4><a id="CreateSerializedPropertyInfo_591"></a>CreateSerializedPropertyInfo</h4> 
<p>该方法代码如下:</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">CreateSerializedPropertyInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">auto</span> property_infos <span class="token operator">=</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>PropertyInfoEntry<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"/system/etc/selinux/plat_property_contexts"</span><span class="token punctuation">,</span> R_OK<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">LoadPropertyInfoFromFile</span><span class="token punctuation">(</span><span class="token string">"/system/etc/selinux/plat_property_contexts"</span><span class="token punctuation">,</span>
                                      <span class="token operator">&amp;</span>property_infos<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// Don't check for failure here, so we always have a sane list of properties.</span>
        <span class="token comment">// E.g. In case of recovery, the vendor partition will not have mounted and we</span>
        <span class="token comment">// still need the system / platform properties to function.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">LoadPropertyInfoFromFile</span><span class="token punctuation">(</span><span class="token string">"/vendor/etc/selinux/vendor_property_contexts"</span><span class="token punctuation">,</span>
                                      <span class="token operator">&amp;</span>property_infos<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Fallback to nonplat_* if vendor_* doesn't exist.</span>
            <span class="token function">LoadPropertyInfoFromFile</span><span class="token punctuation">(</span><span class="token string">"/vendor/etc/selinux/nonplat_property_contexts"</span><span class="token punctuation">,</span>
                                     <span class="token operator">&amp;</span>property_infos<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"/product/etc/selinux/product_property_contexts"</span><span class="token punctuation">,</span> R_OK<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">LoadPropertyInfoFromFile</span><span class="token punctuation">(</span><span class="token string">"/product/etc/selinux/product_property_contexts"</span><span class="token punctuation">,</span>
                                     <span class="token operator">&amp;</span>property_infos<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"/odm/etc/selinux/odm_property_contexts"</span><span class="token punctuation">,</span> R_OK<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">LoadPropertyInfoFromFile</span><span class="token punctuation">(</span><span class="token string">"/odm/etc/selinux/odm_property_contexts"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>property_infos<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">LoadPropertyInfoFromFile</span><span class="token punctuation">(</span><span class="token string">"/plat_property_contexts"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>property_infos<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">LoadPropertyInfoFromFile</span><span class="token punctuation">(</span><span class="token string">"/vendor_property_contexts"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>property_infos<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Fallback to nonplat_* if vendor_* doesn't exist.</span>
            <span class="token function">LoadPropertyInfoFromFile</span><span class="token punctuation">(</span><span class="token string">"/nonplat_property_contexts"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>property_infos<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">LoadPropertyInfoFromFile</span><span class="token punctuation">(</span><span class="token string">"/product_property_contexts"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>property_infos<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LoadPropertyInfoFromFile</span><span class="token punctuation">(</span><span class="token string">"/odm_property_contexts"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>property_infos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">auto</span> serialized_contexts <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> error <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">BuildTrie</span><span class="token punctuation">(</span>property_infos<span class="token punctuation">,</span> <span class="token string">"u:object_r:default_prop:s0"</span><span class="token punctuation">,</span> <span class="token string">"string"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>serialized_contexts<span class="token punctuation">,</span>
                   <span class="token operator">&amp;</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Unable to serialize property contexts: "</span> <span class="token operator">&lt;&lt;</span> error<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">constexpr</span> <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span> kPropertyInfosPath<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"/dev/__properties__/property_info"</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">WriteStringToFile</span><span class="token punctuation">(</span>serialized_contexts<span class="token punctuation">,</span> kPropertyInfosPath<span class="token punctuation">,</span> <span class="token number">0444</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">PLOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Unable to write serialized property infos to file"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">selinux_android_restorecon</span><span class="token punctuation">(</span>kPropertyInfosPath<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>首先通过access来判断文件/system/etc/selinux/plat_property_contexts是否可读。这里的代码是运行在init进程中的， init进程是root用户的，肯定可以读。我们可以看一下这个文件的权限信息：</p> 
<pre><code class="prism language-cpp">ls <span class="token operator">-</span>lh <span class="token operator">/</span>system<span class="token operator">/</span>etc<span class="token operator">/</span>selinux<span class="token operator">/</span>plat_property_contexts
<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">--</span>r<span class="token operator">--</span> <span class="token number">1</span> root root <span class="token number">46</span>K <span class="token number">2009</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">00</span> <span class="token operator">/</span>system<span class="token operator">/</span>etc<span class="token operator">/</span>selinux<span class="token operator">/</span>plat_property_contexts
</code></pre> 
<p>对所有用户都是可读的。</p> 
<p>既然这个文件可读， 就会执行到if语句里面。 if语句里面，会将多个目录下的xxx_property_contexts文件，读取到property_infos中， property_infos是一个<code>std::vector&lt;PropertyInfoEntry&gt;</code>集合。</p> 
<p>这些文件的是一致的。我们来看一下/system/etc/selinux/plat_property_contexts中的内容。这个文件很长，我们截取一部分来看：</p> 
<pre><code class="prism language-bash">persist.sys.hdmi.keep_awake u:object_r:exported2_system_prop:s0 exact bool
persist.sys.sf.color_mode u:object_r:exported2_system_prop:s0 exact int
persist.sys.sf.color_saturation u:object_r:exported2_system_prop:s0 exact string
persist.sys.sf.native_mode u:object_r:exported2_system_prop:s0 exact int
pm.dexopt.ab-ota u:object_r:exported_pm_prop:s0 exact string

</code></pre> 
<p>可以看到，第一列是属性名称， 第二列是selinux的安全上下文信息。所以到这里，基本上可以确定，我们之所以读取不到ro.serialno属性，是被selinux限制了。</p> 
<p>我用了一台vivo手机，进入adb shell， 读取这几个文件，并没有ro.serialno对象的selinux context信息。但是从Android源码的<code>system/sepolicy/private/property_contexts</code>文件中找到了相关信息：</p> 
<pre><code class="prism language-bash">ro.serialno             u:object_r:serialno_prop:s0
ro.boot.serialno        u:object_r:serialno_prop:s0
</code></pre> 
<p>回到代码逻辑， 我们接着看CreateSerializedPropertyInfo方法中的逻辑。 从上面的部分可以了解到，会将各个xxx_property_contexts文件中的属性以及属性对应的selinux安全上下文读取到property_infos集合中，下面看一下集合中的数据会被存放到何处：</p> 
<pre><code class="prism language-cpp">    <span class="token keyword">auto</span> serialized_contexts <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> error <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">BuildTrie</span><span class="token punctuation">(</span>property_infos<span class="token punctuation">,</span> <span class="token string">"u:object_r:default_prop:s0"</span><span class="token punctuation">,</span> <span class="token string">"string"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>serialized_contexts<span class="token punctuation">,</span>
                   <span class="token operator">&amp;</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Unable to serialize property contexts: "</span> <span class="token operator">&lt;&lt;</span> error<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>这段代码通过BuildTrie函数， 将property_infos集合中的数据，转变成字符串serialized_contexts 。我们暂且不看它是如何转换的，我们先去看最后被存到哪里：</p> 
<pre><code class="prism language-cpp">    <span class="token keyword">constexpr</span> <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span> kPropertyInfosPath<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"/dev/__properties__/property_info"</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">WriteStringToFile</span><span class="token punctuation">(</span>serialized_contexts<span class="token punctuation">,</span> kPropertyInfosPath<span class="token punctuation">,</span> <span class="token number">0444</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">PLOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Unable to write serialized property infos to file"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>这段代码是关键信息。说明这些数据正是被写到<code>/dev/__properties__/property_info</code>中了。所以我们可以反推上面的BuildTrie方法正是将对象进行序列化，然后转变成乱码字符串的。如果没有序列化， <code>/dev/__properties__/property_info</code>中的内容应该就是下面这样的格式:</p> 
<pre><code class="prism language-bash">ro.serialno             u:object_r:serialno_prop:s0
ro.boot.serialno        u:object_r:serialno_prop:s0
</code></pre> 
<p>所以做一下总结:</p> 
<p><strong><code>/dev/__properties__/property_info</code>文件中存储的不是属性的值， 而是属性的selinux上下文。也就是说，每个属性是被哪个selinux上下文来保护的。</strong></p> 
<h4><a id="__system_property_area_init_711"></a>__system_property_area_init</h4> 
<p>上面只是初始化的属性对应的selinux信息，我们还没有看到属性值是怎么存储的。我们接着看__system_property_area_init方法。该方法实现在<code>bionic/libc/bionic/system_property_api.cpp</code>文件中：</p> 
<pre><code class="prism language-cpp">__BIONIC_WEAK_FOR_NATIVE_BRIDGE
<span class="token keyword">int</span> <span class="token function">__system_property_area_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">bool</span> fsetxattr_failed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> system_properties<span class="token punctuation">.</span><span class="token function">AreaInit</span><span class="token punctuation">(</span>PROP_FILENAME<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fsetxattr_failed<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>fsetxattr_failed <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这里的PROP_FILENAME的值为<code>/dev/__properties__</code></p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PROP_FILENAME</span> <span class="token string">"/dev/__properties__"</span></span>
</code></pre> 
<p>__system_property_area_init调用system_properties.AreaInit。这个system_properties我们上面说过，是一个SystemProperties对象，实现在<code>bionic/libc/system_properties/system_properties.cpp</code>中：</p> 
<pre><code class="prism language-cpp">
<span class="token keyword">bool</span> <span class="token class-name">SystemProperties</span><span class="token operator">::</span><span class="token function">AreaInit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> filename<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token operator">*</span> fsetxattr_failed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> PROP_FILENAME_MAX<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">strcpy</span><span class="token punctuation">(</span>property_filename_<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>

  contexts_ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token punctuation">(</span>contexts_data_<span class="token punctuation">)</span> <span class="token function">ContextsSerialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>contexts_<span class="token operator">-&gt;</span><span class="token function">Initialize</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> property_filename_<span class="token punctuation">,</span> fsetxattr_failed<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  initialized_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这个代码我们看上去有点熟悉。 上面我们分析属性读取流程的时候，分析过SystemProperties的Init方法。注意这里的AreaInit和Init是不一样的。 这里的AreaInit是运行在init进程中的，上面的Init是运行在普通应用进程中的。</p> 
<p>这里也会创建ContextsSerialized对象，并且调用该对象的Initialize方法。该方法的前两个参数为传入参数：</p> 
<ol><li>writable, 如果是在init中执行，则传入true, 如果实在App进程中执行，则传入false</li><li>filename, 我们已经知道， 该参数的值为 <code>/dev/__properties__</code></li></ol> 
<p>下面我们再次看一下ContextsSerialized的Initialize方法：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">bool</span> <span class="token class-name">ContextsSerialized</span><span class="token operator">::</span><span class="token function">Initialize</span><span class="token punctuation">(</span><span class="token keyword">bool</span> writable<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> filename<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token operator">*</span> fsetxattr_failed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

<span class="token comment">// filename_ 的值为PROP_FILENAME #define PROP_FILENAME "/dev/__properties__"</span>
  filename_ <span class="token operator">=</span> filename<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">InitializeProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>writable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">mkdir</span><span class="token punctuation">(</span>filename_<span class="token punctuation">,</span> S_IRWXU <span class="token operator">|</span> S_IXGRP <span class="token operator">|</span> S_IXOTH<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> open_failed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fsetxattr_failed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token operator">*</span>fsetxattr_failed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_context_nodes_<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>context_nodes_<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> fsetxattr_failed<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        open_failed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>open_failed <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">MapSerialPropertyArea</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> fsetxattr_failed<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">FreeAndUnmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">MapSerialPropertyArea</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">FreeAndUnmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>InitializeProperties的执行，前面已经讲过了， 就是从<code>/dev/__properties__/property_info</code>文件中读取信息， 然后创建ContextNode数组。 现在我们知道了， 每个ContextNode对象， 就代表一个属性的selinux信息，而不是属性的值。属性的值是单独存到其他地方的，至于存到哪里， 正是我们现在正在分析的问题。</p> 
<p>因为现在是在init进程中执行，writable传入的值为true, 所以会走到对应的分支。 该分支中的关键代码是调用每个ContextNode的Open函数，且第一个参数传入的是true。</p> 
<p>接下来我们看一下ContextNode的Open函数, 实现在<code>bionic/libc/system_properties/context_node.cpp</code>中：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">bool</span> <span class="token class-name">ContextNode</span><span class="token operator">::</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token keyword">bool</span> access_rw<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token operator">*</span> fsetxattr_failed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  lock_<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>pa_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    lock_<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 格式为 /dev/__properties__/u:object_r:serialno_prop:s0</span>
  <span class="token keyword">char</span> filename<span class="token punctuation">[</span>PROP_FILENAME_MAX<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">async_safe_format_buffer</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"%s/%s"</span><span class="token punctuation">,</span> filename_<span class="token punctuation">,</span> context_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> len <span class="token operator">&gt;=</span> PROP_FILENAME_MAX<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    lock_<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>access_rw<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    pa_ <span class="token operator">=</span> prop_area<span class="token operator">::</span><span class="token function">map_prop_area_rw</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> context_<span class="token punctuation">,</span> fsetxattr_failed<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    pa_ <span class="token operator">=</span> prop_area<span class="token operator">::</span><span class="token function">map_prop_area</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  lock_<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> pa_<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>第一句关键代码是<code>async_safe_format_buffer(filename, sizeof(filename), "%s/%s", filename_, context_);</code>, 将filename_和context_这两个成员变量，拼接成filename 。 filename_我们已经知道了，值为<code>/dev/__properties__</code>, 那么这个context_到底是什么呢？</p> 
<p>让我们回忆一下，ContextNode可以看做是和<code>/dev/__properties__/property_info</code>中的序列化对象是对应的。而<code>/dev/__properties__/property_info</code>中每个对象的关键信息如下：</p> 
<pre><code class="prism language-cpp">persist<span class="token punctuation">.</span>sys<span class="token punctuation">.</span>hdmi<span class="token punctuation">.</span>keep_awake u<span class="token operator">:</span>object_r<span class="token operator">:</span>exported2_system_prop<span class="token operator">:</span>s0 exact <span class="token keyword">bool</span>
persist<span class="token punctuation">.</span>sys<span class="token punctuation">.</span>sf<span class="token punctuation">.</span>color_mode u<span class="token operator">:</span>object_r<span class="token operator">:</span>exported2_system_prop<span class="token operator">:</span>s0 exact <span class="token keyword">int</span>
persist<span class="token punctuation">.</span>sys<span class="token punctuation">.</span>sf<span class="token punctuation">.</span>color_saturation u<span class="token operator">:</span>object_r<span class="token operator">:</span>exported2_system_prop<span class="token operator">:</span>s0 exact string
persist<span class="token punctuation">.</span>sys<span class="token punctuation">.</span>sf<span class="token punctuation">.</span>native_mode u<span class="token operator">:</span>object_r<span class="token operator">:</span>exported2_system_prop<span class="token operator">:</span>s0 exact <span class="token keyword">int</span>
pm<span class="token punctuation">.</span>dexopt<span class="token punctuation">.</span>ab<span class="token operator">-</span>ota u<span class="token operator">:</span>object_r<span class="token operator">:</span>exported_pm_prop<span class="token operator">:</span>s0 exact string
</code></pre> 
<p>其中第一列为name, 也就是属性名。 第二列为selinux上下文信息， 也就是这里的context_成员变量。</p> 
<p>所以filename_和context_拼接成的filename的值的格式为 <code>/dev/__properties__/u:object_r:serialno_prop:s0</code>, 当然， 最后的部分context_是根据ContextNode而变化的。</p> 
<p>我找了个root手机， 看了下<code>/dev/__properties__/</code>目录下， 有很多这种格式的文件：</p> 
<pre><code class="prism language-bash"> <span class="token function">ls</span> -l /dev/__properties__
total <span class="token number">796</span>
-r--r--r-- <span class="token number">1</span> root root <span class="token number">131072</span> <span class="token number">1970</span>-05-01 06:58 properties_serial
-r--r--r-- <span class="token number">1</span> root root  <span class="token number">26968</span> <span class="token number">1970</span>-05-01 06:58 property_info
-r--r--r-- <span class="token number">1</span> root root <span class="token number">131072</span> <span class="token number">1970</span>-05-01 06:58 u:object_r:adsprpc_prop:s0
-r--r--r-- <span class="token number">1</span> root root <span class="token number">131072</span> <span class="token number">1970</span>-05-01 06:58 u:object_r:audio_prop:s0
-r--r--r-- <span class="token number">1</span> root root <span class="token number">131072</span> <span class="token number">1970</span>-05-01 06:58 u:object_r:bg_boot_complete_prop:s0
-r--r--r-- <span class="token number">1</span> root root <span class="token number">131072</span> <span class="token number">1970</span>-05-01 06:58 u:object_r:bg_daemon_prop:s0
-r--r--r-- <span class="token number">1</span> root root <span class="token number">131072</span> <span class="token number">1970</span>-05-01 06:58 u:object_r:bluetooth_prop:s0
-r--r--r-- <span class="token number">1</span> root root <span class="token number">131072</span> <span class="token number">1970</span>-05-01 06:58 u:object_r:bootloader_boot_reason_prop:s0

//<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
</code></pre> 
<p>每个文件的权限为<code>-r--r--r--</code>，好像是这些文件对所有用户均可读。 但是经过测试发现， 根本就读不到。这是因为每个文件都具有selinux上下文， selinux会禁止普通进程读取这些文件。我们通过ls -lZ再次查看一下(-Z参数会打印出来每个文件的selinux上下文)：</p> 
<pre><code class="prism language-bash">sagit:/ <span class="token comment"># ls -lZ /dev/__properties__</span>
total <span class="token number">796</span>
-r--r--r-- <span class="token number">1</span> root root u:object_r:properties_serial:s0                <span class="token number">131072</span> <span class="token number">1970</span>-05-01 06:58 properties_serial
-r--r--r-- <span class="token number">1</span> root root u:object_r:property_info:s0                     <span class="token number">26968</span> <span class="token number">1970</span>-05-01 06:58 property_info
-r--r--r-- <span class="token number">1</span> root root u:object_r:adsprpc_prop:s0                     <span class="token number">131072</span> <span class="token number">1970</span>-05-01 06:58 u:object_r:adsprpc_prop:s0
-r--r--r-- <span class="token number">1</span> root root u:object_r:audio_prop:s0                       <span class="token number">131072</span> <span class="token number">1970</span>-05-01 06:58 u:object_r:audio_prop:s0
-r--r--r-- <span class="token number">1</span> root root u:object_r:bg_boot_complete_prop:s0            <span class="token number">131072</span> <span class="token number">1970</span>-05-01 06:58 u:object_r:bg_boot_complete_prop:s0
-r--r--r-- <span class="token number">1</span> root root u:object_r:bg_daemon_prop:s0                   <span class="token number">131072</span> <span class="token number">1970</span>-05-01 06:58 u:object_r:bg_daemon_prop:s0
-r--r--r-- <span class="token number">1</span> root root u:object_r:bluetooth_prop:s0                   <span class="token number">131072</span> <span class="token number">1970</span>-05-01 06:58 u:object_r:bluetooth_prop:s0
-r--r--r-- <span class="token number">1</span> root root u:object_r:bootloader_boot_reason_prop:s0      <span class="token number">131072</span> <span class="token number">1970</span>-05-01 06:58 u:object_r:bootloader_boot_reason_prop:s0
-r--r--r-- <span class="token number">1</span> root root u:object_r:boottime_prop:s0                    <span class="token number">131072</span> <span class="token number">2021</span>-12-16 <span class="token number">13</span>:26 u:object_r:boottime_prop:s0
-r--r--r-- <span class="token number">1</span> root root u:object_r:bservice_prop:s0                    <span class="token number">131072</span> <span class="token number">1970</span>-05-01 06:58 u:object_r:bservice_prop:s0

</code></pre> 
<p>可以看出，文件名和selinux的上下文是一致的。看到这里我们大概已经知道了，具体的属性值可能就是存放到这些文件中的。</p> 
<p>我们回到ContextNode的Open函数，已经知道filename的值为<code>/dev/__properties__/u:object_r:serialno_prop:s0</code>这种格式。下面我们继续看代码。</p> 
<p>因为access_rw值为true, 所以会执行<code>pa_ = prop_area::map_prop_area_rw(filename, context_, fsetxattr_failed);</code>这行代码。</p> 
<p>传入的值filename 和 context_我们已经分析过。 接下来我们看map_prop_area_rw的实现，在<code>bionic/libc/system_properties/prop_area.cpp</code>中：</p> 
<pre><code class="prism language-cpp">prop_area<span class="token operator">*</span> prop_area<span class="token operator">::</span><span class="token function">map_prop_area_rw</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> filename<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> context<span class="token punctuation">,</span>
                                       <span class="token keyword">bool</span><span class="token operator">*</span> fsetxattr_failed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">/* dev is a tmpfs that we can use to carve a shared workspace
   * out of, so let's do that...
   */</span>
  <span class="token keyword">const</span> <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_CREAT <span class="token operator">|</span> O_NOFOLLOW <span class="token operator">|</span> O_CLOEXEC <span class="token operator">|</span> O_EXCL<span class="token punctuation">,</span> <span class="token number">0444</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EACCES<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">/* for consistency with the case where the process has already
       * mapped the page in and segfaults when trying to write to it
       */</span>
      <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fsetxattr</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> XATTR_NAME_SELINUX<span class="token punctuation">,</span> context<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">async_safe_format_log</span><span class="token punctuation">(</span>ANDROID_LOG_ERROR<span class="token punctuation">,</span> <span class="token string">"libc"</span><span class="token punctuation">,</span>
                            <span class="token string">"fsetxattr failed to set context (%s) for \"%s\""</span><span class="token punctuation">,</span> context<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">/*
       * fsetxattr() will fail during system properties tests due to selinux policy.
       * We do not want to create a custom policy for the tester, so we will continue in
       * this function but set a flag that an error has occurred.
       * Init, which is the only daemon that should ever call this function will abort
       * when this error occurs.
       * Otherwise, the tester will ignore it and continue, albeit without any selinux
       * property separation.
       */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>fsetxattr_failed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token operator">*</span>fsetxattr_failed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ftruncate</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> PA_SIZE<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  pa_size_ <span class="token operator">=</span> PA_SIZE<span class="token punctuation">;</span>
  pa_data_size_ <span class="token operator">=</span> pa_size_ <span class="token operator">-</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>prop_area<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">void</span><span class="token operator">*</span> <span class="token keyword">const</span> memory_area <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span> pa_size_<span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span> MAP_SHARED<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>memory_area <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  prop_area<span class="token operator">*</span> pa <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token punctuation">(</span>memory_area<span class="token punctuation">)</span> <span class="token function">prop_area</span><span class="token punctuation">(</span>PROP_AREA_MAGIC<span class="token punctuation">,</span> PROP_AREA_VERSION<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> pa<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>首先调用open打开文件（文件格式为 <code>/dev/__properties__/u:object_r:serialno_prop:s0</code>）， 这里有一个O_CREAT，意思是如果文件不存在的话， 就创建文件。因为这是init第一次初始化系统属性，可以得知，之前肯定是不存在的， 执行完open之后才创建出来的。</p> 
<p>context就是调用该函数时传入的属性对应的selinux上下文，如u:object_r:serialno_prop:s0。然后调用fsetxattr为文件设置selinux上下文。</p> 
<p>到此为止，<code>/dev/__properties__/u:object_r:serialno_prop:s0</code>文件也创建出来了，对应的selinux上下文也设置好了。</p> 
<p>接下来调用mmap将文件映射成一个prop_area对象。</p> 
<p>ContextsSerialized::Initialize中是循环调用ContextNode的，所以会将<code>/dev/__properties__/</code>下所有的文件均创建出来， 并且都会设置好selinux上下文，创建所有的prop_area对象。</p> 
<p>所以可以得知， prop_area， ContextNode，<code>/dev/__properties__/</code>下的每个文件， 还有 <code>/dev/__properties__/property_info</code>中的每个对象， 是一一对应的。</p> 
<p>到现在为止，属性对应的文件和数据结构都已经创建完了，但是我们发现， 这些文件和数据结构都是空的。这里并没有将真正的属性值存储进来。我们接着往下分析。</p> 
<h4><a id="property_info_areaLoadDefaultPath_955"></a>property_info_area.LoadDefaultPath()</h4> 
<p>property_init中调用完__system_property_area_init()之后， 接下来会调用property_info_area.LoadDefaultPath()， 这个逻辑也是将 <code>/dev/__properties__/property_info</code>中的内容读取出来。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">bool</span> <span class="token class-name">PropertyInfoAreaFile</span><span class="token operator">::</span><span class="token function">LoadDefaultPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token function">LoadPath</span><span class="token punctuation">(</span><span class="token string">"/dev/__properties__/property_info"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token class-name">PropertyInfoAreaFile</span><span class="token operator">::</span><span class="token function">LoadPath</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> filename<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> O_CLOEXEC <span class="token operator">|</span> O_NOFOLLOW <span class="token operator">|</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">struct</span> <span class="token class-name">stat</span> fd_stat<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fstat</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fd_stat<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fd_stat<span class="token punctuation">.</span>st_uid <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>fd_stat<span class="token punctuation">.</span>st_gid <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span>
      <span class="token punctuation">(</span><span class="token punctuation">(</span>fd_stat<span class="token punctuation">.</span>st_mode <span class="token operator">&amp;</span> <span class="token punctuation">(</span>S_IWGRP <span class="token operator">|</span> S_IWOTH<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span>
      <span class="token punctuation">(</span>fd_stat<span class="token punctuation">.</span>st_size <span class="token operator">&lt;</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>off_t<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>PropertyInfoArea<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">auto</span> mmap_size <span class="token operator">=</span> fd_stat<span class="token punctuation">.</span>st_size<span class="token punctuation">;</span>

  <span class="token keyword">void</span><span class="token operator">*</span> map_result <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span> mmap_size<span class="token punctuation">,</span> PROT_READ<span class="token punctuation">,</span> MAP_SHARED<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>map_result <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">auto</span> property_info_area <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>PropertyInfoArea<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>map_result<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>property_info_area<span class="token operator">-&gt;</span><span class="token function">minimum_supported_version</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">||</span>
      property_info_area<span class="token operator">-&gt;</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> mmap_size<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">munmap</span><span class="token punctuation">(</span>map_result<span class="token punctuation">,</span> mmap_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  mmap_base_ <span class="token operator">=</span> map_result<span class="token punctuation">;</span>
  mmap_size_ <span class="token operator">=</span> mmap_size<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>感觉和上面__system_property_area_init的逻辑重复了。不知道是不是多余的逻辑。没有看到更多的有用信息，先暂且不管。我们继续往下分析，找到属性值是如何存储到文件中的。</p> 
<h3><a id="export_kernel_boot_props_1006"></a>export_kernel_boot_props</h3> 
<p>上面我们分析过，init.cpp中，调用完property_init之后，会调用export_kernel_boot_props。该函数也定义在<code>system/core/init/init.cpp</code>中：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">export_kernel_boot_props</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">constexpr</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> UNSET <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>src_prop<span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>dst_prop<span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>default_value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> prop_map<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">{<!-- --></span> <span class="token string">"ro.boot.serialno"</span><span class="token punctuation">,</span>   <span class="token string">"ro.serialno"</span><span class="token punctuation">,</span>   UNSET<span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span> <span class="token string">"ro.boot.mode"</span><span class="token punctuation">,</span>       <span class="token string">"ro.bootmode"</span><span class="token punctuation">,</span>   <span class="token string">"unknown"</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span> <span class="token string">"ro.boot.baseband"</span><span class="token punctuation">,</span>   <span class="token string">"ro.baseband"</span><span class="token punctuation">,</span>   <span class="token string">"unknown"</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span> <span class="token string">"ro.boot.bootloader"</span><span class="token punctuation">,</span> <span class="token string">"ro.bootloader"</span><span class="token punctuation">,</span> <span class="token string">"unknown"</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span> <span class="token string">"ro.boot.hardware"</span><span class="token punctuation">,</span>   <span class="token string">"ro.hardware"</span><span class="token punctuation">,</span>   <span class="token string">"unknown"</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span> <span class="token string">"ro.boot.revision"</span><span class="token punctuation">,</span>   <span class="token string">"ro.revision"</span><span class="token punctuation">,</span>   <span class="token string">"0"</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> prop <span class="token operator">:</span> prop_map<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        std<span class="token operator">::</span>string value <span class="token operator">=</span> <span class="token function">GetProperty</span><span class="token punctuation">(</span>prop<span class="token punctuation">.</span>src_prop<span class="token punctuation">,</span> prop<span class="token punctuation">.</span>default_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!=</span> UNSET<span class="token punctuation">)</span>
            <span class="token function">property_set</span><span class="token punctuation">(</span>prop<span class="token punctuation">.</span>dst_prop<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这里看到了我们所关心的ro.serialno， 可见它是从内核启动参数ro.boot.serialno而来的。可见这个属性有特别之处。我们先不管这中特殊情况，继续分析下面的代码，看一下普通的属性是如何写入的。</p> 
<h3><a id="property_load_boot_defaults_1035"></a>property_load_boot_defaults</h3> 
<p>上面我们分析过，init.cpp中，调用完export_kernel_boot_props之后，会调用property_load_boot_defaults，下面我们继续分析这个函数。</p> 
<p>和property_init一样，该函数也定义在<code>system/core/init/property_service.cpp</code>中：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">property_load_boot_defaults</span><span class="token punctuation">(</span><span class="token keyword">bool</span> load_debug_prop<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// TODO(b/117892318): merge prop.default and build.prop files into one</span>
    <span class="token comment">// We read the properties and their values into a map, in order to always allow properties</span>
    <span class="token comment">// loaded in the later property files to override the properties in loaded in the earlier</span>
    <span class="token comment">// property files, regardless of if they are "ro." properties or not.</span>
    std<span class="token operator">::</span>map<span class="token operator">&lt;</span>std<span class="token operator">::</span>string<span class="token punctuation">,</span> std<span class="token operator">::</span>string<span class="token operator">&gt;</span> properties<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">load_properties_from_file</span><span class="token punctuation">(</span><span class="token string">"/system/etc/prop.default"</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>properties<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Try recovery path</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">load_properties_from_file</span><span class="token punctuation">(</span><span class="token string">"/prop.default"</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>properties<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Try legacy path</span>
            <span class="token function">load_properties_from_file</span><span class="token punctuation">(</span><span class="token string">"/default.prop"</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">load_properties_from_file</span><span class="token punctuation">(</span><span class="token string">"/system/build.prop"</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">load_properties_from_file</span><span class="token punctuation">(</span><span class="token string">"/vendor/default.prop"</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">load_properties_from_file</span><span class="token punctuation">(</span><span class="token string">"/vendor/build.prop"</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SelinuxGetVendorAndroidVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> __ANDROID_API_Q__<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">load_properties_from_file</span><span class="token punctuation">(</span><span class="token string">"/odm/etc/build.prop"</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">load_properties_from_file</span><span class="token punctuation">(</span><span class="token string">"/odm/default.prop"</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">load_properties_from_file</span><span class="token punctuation">(</span><span class="token string">"/odm/build.prop"</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">load_properties_from_file</span><span class="token punctuation">(</span><span class="token string">"/product/build.prop"</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">load_properties_from_file</span><span class="token punctuation">(</span><span class="token string">"/product_services/build.prop"</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">load_properties_from_file</span><span class="token punctuation">(</span><span class="token string">"/factory/factory.prop"</span><span class="token punctuation">,</span> <span class="token string">"ro.*"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>load_debug_prop<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Loading "</span> <span class="token operator">&lt;&lt;</span> kDebugRamdiskProp<span class="token punctuation">;</span>
        <span class="token function">load_properties_from_file</span><span class="token punctuation">(</span>kDebugRamdiskProp<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token operator">:</span> properties<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        std<span class="token operator">::</span>string error<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PropertySet</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token operator">&amp;</span>error<span class="token punctuation">)</span> <span class="token operator">!=</span> PROP_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Could not set '"</span> <span class="token operator">&lt;&lt;</span> name <span class="token operator">&lt;&lt;</span> <span class="token string">"' to '"</span> <span class="token operator">&lt;&lt;</span> value
                       <span class="token operator">&lt;&lt;</span> <span class="token string">"' while loading .prop files"</span> <span class="token operator">&lt;&lt;</span> error<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">property_initialize_ro_product_props</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">property_derive_build_fingerprint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">update_sys_usb_config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这个函数的逻辑也很清晰。</p> 
<p>首先将系统各个位置的prop文件读取到<code>std::map&lt;std::string, std::string&gt; properties</code>中。</p> 
<p>非root手机是无法读取这些文件的：</p> 
<pre><code class="prism language-bash"><span class="token function">ls</span> -lh /system/etc/prop.default
-rw------- <span class="token number">1</span> root root <span class="token number">1</span>.5K <span class="token number">2009</span>-01-01 08:00 /system/etc/prop.default
</code></pre> 
<pre><code class="prism language-bash"><span class="token function">ls</span> -lh /system/build.prop
-rw------- <span class="token number">1</span> root root <span class="token number">7</span>.7K <span class="token number">2009</span>-01-01 08:00 /system/build.prop
</code></pre> 
<p>这些文件只对root用户有读写权限。为了编译理解代码， 我找来一台root的手机， 来看下文件中的内容:</p> 
<pre><code class="prism language-bash">ro.mi.development<span class="token operator">=</span>false
ro.miui.version.code_time<span class="token operator">=</span><span class="token number">1567440000</span>
ro.rom.zone<span class="token operator">=</span><span class="token number">1</span>
ro.miui.ui.version.code<span class="token operator">=</span><span class="token number">8</span>
ro.miui.ui.version.name<span class="token operator">=</span>V10
ro.miui.has_security_keyboard<span class="token operator">=</span><span class="token number">1</span>
ro.fota.oem<span class="token operator">=</span>Xiaomi
</code></pre> 
<p>可见这些文件才是真正的属性。</p> 
<p>将这些文件读取到<code>std::map&lt;std::string, std::string&gt; properties</code>中之后， 会通过for循环调用PropertySet将所有属性写入。我们继续分析PropertySet。该函数定义在<code>system/core/init/property_service.cpp</code>中：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> <span class="token keyword">uint32_t</span> <span class="token function">PropertySet</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> value<span class="token punctuation">,</span> std<span class="token operator">::</span>string<span class="token operator">*</span> error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    size_t valuelen <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">IsLegalPropertyName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token operator">*</span>error <span class="token operator">=</span> <span class="token string">"Illegal property name"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> PROP_ERROR_INVALID_NAME<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>valuelen <span class="token operator">&gt;=</span> PROP_VALUE_MAX <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">StartsWith</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"ro."</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token operator">*</span>error <span class="token operator">=</span> <span class="token string">"Property value too long"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> PROP_ERROR_INVALID_VALUE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mbstowcs</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span> value<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>std<span class="token operator">::</span>size_t<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token operator">*</span>error <span class="token operator">=</span> <span class="token string">"Value is not a UTF8 encoded string"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> PROP_ERROR_INVALID_VALUE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    prop_info<span class="token operator">*</span> pi <span class="token operator">=</span> <span class="token punctuation">(</span>prop_info<span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">__system_property_find</span><span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pi <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// ro.* properties are actually "write-once".</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">StartsWith</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"ro."</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token operator">*</span>error <span class="token operator">=</span> <span class="token string">"Read-only property was already set"</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> PROP_ERROR_READ_ONLY_PROPERTY<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">__system_property_update</span><span class="token punctuation">(</span>pi<span class="token punctuation">,</span> value<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> valuelen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> rc <span class="token operator">=</span> <span class="token function">__system_property_add</span><span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> valuelen<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token operator">*</span>error <span class="token operator">=</span> <span class="token string">"__system_property_add failed"</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> PROP_ERROR_SET_FAILED<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Don't write properties to disk until after we have read all default</span>
    <span class="token comment">// properties to prevent them from being overwritten by default values.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>persistent_properties_loaded <span class="token operator">&amp;&amp;</span> <span class="token function">StartsWith</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"persist."</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">WritePersistentProperty</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">property_changed</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> PROP_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这个函数中的核心代码其实很少。 首先通过__system_property_find来获取对应的prop_info, 但是因为是第一次存储属性， 肯定会返回nullptr, 所以会继续调用__system_property_add来增加属性。</p> 
<p>我们继续分析__system_property_add函数，该函数定义在<code>bionic/libc/bionic/system_property_api.cpp</code>中：</p> 
<pre><code class="prism language-cpp">__BIONIC_WEAK_FOR_NATIVE_BRIDGE
<span class="token keyword">int</span> <span class="token function">__system_property_add</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> namelen<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> value<span class="token punctuation">,</span>
                          <span class="token keyword">unsigned</span> <span class="token keyword">int</span> valuelen<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> system_properties<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> namelen<span class="token punctuation">,</span> value<span class="token punctuation">,</span> valuelen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>该函数又调用SystemProperties类的Add方法。该方法实现在<code>bionic/libc/system_properties/system_properties.cpp</code>中：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token class-name">SystemProperties</span><span class="token operator">::</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> namelen<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> value<span class="token punctuation">,</span>
                          <span class="token keyword">unsigned</span> <span class="token keyword">int</span> valuelen<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>valuelen <span class="token operator">&gt;=</span> PROP_VALUE_MAX <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">is_read_only</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>namelen <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>initialized_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  prop_area<span class="token operator">*</span> serial_pa <span class="token operator">=</span> contexts_<span class="token operator">-&gt;</span><span class="token function">GetSerialPropArea</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>serial_pa <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  prop_area<span class="token operator">*</span> pa <span class="token operator">=</span> contexts_<span class="token operator">-&gt;</span><span class="token function">GetPropAreaForName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pa<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">async_safe_format_log</span><span class="token punctuation">(</span>ANDROID_LOG_ERROR<span class="token punctuation">,</span> <span class="token string">"libc"</span><span class="token punctuation">,</span> <span class="token string">"Access denied adding property \"%s\""</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">bool</span> ret <span class="token operator">=</span> pa<span class="token operator">-&gt;</span><span class="token function">add</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> namelen<span class="token punctuation">,</span> value<span class="token punctuation">,</span> valuelen<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// There is only a single mutator, but we want to make sure that</span>
  <span class="token comment">// updates are visible to a reader waiting for the update.</span>
  <span class="token function">atomic_store_explicit</span><span class="token punctuation">(</span>serial_pa<span class="token operator">-&gt;</span><span class="token function">serial</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token function">atomic_load_explicit</span><span class="token punctuation">(</span>serial_pa<span class="token operator">-&gt;</span><span class="token function">serial</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> memory_order_relaxed<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
                        memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__futex_wake</span><span class="token punctuation">(</span>serial_pa<span class="token operator">-&gt;</span><span class="token function">serial</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> INT32_MAX<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>首先调用contexts_-&gt;GetPropAreaForName来获取prop_area，因为当前代码是在init中执行，init进程是root用户，所以肯定有权限获取prop_area。</p> 
<p>根据前面的分析，我们已经知道一个prop_area其实就对应<code>/dev/__properties__/</code>下面的一个文件。比如 ro.serialno属性对应的prop_area，就是<code>/dev/__properties__/u:object_r:serialno_prop:s0</code>文件的内容映射(mmap)。</p> 
<p>然后调用pa-&gt;add， 写入属性。可以认为这里就是真正将属性写入到prop_area中， 因为prop_area是<code>/dev/__properties__/</code>下文件的映射， 所以会直接同步到文件中。</p> 
<p>prop_area的实现比较复杂，使用了trie树，并不是普通的键值对， <code>/dev/__properties__/</code>下的属性文件也不是普通文本文件，而是序列化的对象。所以我们就不再继续跟进代码了。大家可以看下<code>bionic/libc/system_properties/include/system_properties/prop_area.h</code>中的介绍。</p> 
<pre><code class="prism language-cpp"><span class="token comment">// Properties are stored in a hybrid trie/binary tree structure.</span>
<span class="token comment">// Each property's name is delimited at '.' characters, and the tokens are put</span>
<span class="token comment">// into a trie structure.  Siblings at each level of the trie are stored in a</span>
<span class="token comment">// binary tree.  For instance, "ro.secure"="1" could be stored as follows:</span>
<span class="token comment">//</span>
<span class="token comment">// +-----+   children    +----+   children    +--------+</span>
<span class="token comment">// |     |--------------&gt;| ro |--------------&gt;| secure |</span>
<span class="token comment">// +-----+               +----+               +--------+</span>
<span class="token comment">//                       /    \                /   |</span>
<span class="token comment">//                 left /      \ right   left /    |  prop   +===========+</span>
<span class="token comment">//                     v        v            v     +--------&gt;| ro.secure |</span>
<span class="token comment">//                  +-----+   +-----+     +-----+            +-----------+</span>
<span class="token comment">//                  | net |   | sys |     | com |            |     1     |</span>
<span class="token comment">//                  +-----+   +-----+     +-----+            +===========+</span>

<span class="token comment">// Represents a node in the trie.</span>
</code></pre> 
<p>还可以参考一下维基百科上面对trie树的介绍：</p> 
<p><a href="https://zh.wikipedia.org/wiki/Trie" rel="nofollow">https://zh.wikipedia.org/wiki/Trie</a></p> 
<p>到这里我们就已经分析完了init中对属性的初始化过程。总结一下包括如下几个步骤：</p> 
<ol><li>创建<code>/dev/__properties__</code>目录。</li><li>读取系统中的各个xxx_property_contexts文件中的属性名和属性对应的selinux上下文信息，将这些信息序列化到<br> <code>/dev/__properties__/property_info</code>文件中。</li><li>通过读取<code>/dev/__properties__/property_info</code>，创建各种数据结构。其中ContextsSerialized可以看做属性selinux上下文的管理者。它会创建一个ContextNode数组，每个ContextNode代表一个属性以及属性的selinux上下文信息。然后每个ContextNode在Open的时候，会创建对应的<code>/dev/__properties__/${selinux context}</code>文件，为这个文件设置selinux context，然后将这个文件通过mmap映射到内存中，形成一个prop_area对象。</li><li>通过读取各个位置的属性文件(如/system/etc/prop.default，这些文件里面存放的是真正的属性键值对)，将这些属性值设置到对应的prop_area对象中，因为该对象是<code>/dev/__properties__/${selinux context}</code>文件的内存映射， 所以同时也会写到文件中。</li></ol> 
<br> 
<h2><a id="App_1262"></a>App读取属性是如何被拦截的</h2> 
<p>从上面的 <strong>App读取属性流程分析</strong> 一节中我们已经得知了一些属性拦截相关流程，再加上上一节对init中属性系统初始化的分析，我们对整个属性系统的细节已经有了更清晰的了解。</p> 
<p>现在我们对<strong>App读取属性流程分析</strong>这一节进行一些总结：</p> 
<ol><li>App也要对属性系统进行初始化。包括创建ContextsSerialized，解析读取<code>/dev/__properties__/property_info</code>文件创建ContextNode数组。ContextNode中保存的是属性名和属性selinux context的对应关系。</li><li>调用ContextsSerialized的GetPropAreaForName方法时， 因为没有权限，获取的是一个prop_area的空指针。</li></ol> 
<p>下面我们接着下面的代码来分析：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">const</span> prop_info<span class="token operator">*</span> <span class="token class-name">SystemProperties</span><span class="token operator">::</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>initialized_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  prop_area<span class="token operator">*</span> pa <span class="token operator">=</span> contexts_<span class="token operator">-&gt;</span><span class="token function">GetPropAreaForName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pa<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">async_safe_format_log</span><span class="token punctuation">(</span>ANDROID_LOG_ERROR<span class="token punctuation">,</span> <span class="token string">"libc"</span><span class="token punctuation">,</span> <span class="token string">"Access denied finding property \"%s\""</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> pa<span class="token operator">-&gt;</span><span class="token function">find</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>首先进入ContextsSerialized的GetPropAreaForName方法，实现在<code>bionic/libc/system_properties/contexts_serialized.cpp</code>中：</p> 
<pre><code class="prism language-cpp">prop_area<span class="token operator">*</span> <span class="token class-name">ContextsSerialized</span><span class="token operator">::</span><span class="token function">GetPropAreaForName</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">uint32_t</span> index<span class="token punctuation">;</span>
  property_info_area_file_<span class="token operator">-&gt;</span><span class="token function">GetPropertyInfoIndexes</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>index<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">==</span> <span class="token operator">~</span><span class="token number">0u</span> <span class="token operator">||</span> index <span class="token operator">&gt;=</span> num_context_nodes_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">async_safe_format_log</span><span class="token punctuation">(</span>ANDROID_LOG_ERROR<span class="token punctuation">,</span> <span class="token string">"libc"</span><span class="token punctuation">,</span> <span class="token string">"Could not find context for property \"%s\""</span><span class="token punctuation">,</span>
                          name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">auto</span><span class="token operator">*</span> context_node <span class="token operator">=</span> <span class="token operator">&amp;</span>context_nodes_<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>context_node<span class="token operator">-&gt;</span><span class="token function">pa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// We explicitly do not check no_access_ in this case because unlike the</span>
    <span class="token comment">// case of foreach(), we want to generate an selinux audit for each</span>
    <span class="token comment">// non-permitted property access in this function.</span>
    context_node<span class="token operator">-&gt;</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> context_node<span class="token operator">-&gt;</span><span class="token function">pa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>该方法中， 会根据属性名name， 获取对应的ContextNode对象， 通过调用pa方法获取一个prop_area指针，如果为空指针，则会调用Open来初始化这个prop_area指针，然后再次调用pa方法获取prop_area指针，并返回这个指针。</p> 
<p>我们已经知道，因为没有权限读取属性，返回的prop_area肯定是空指针。也就是说，在Open方法中，无法成功创建这个prop_area对象。</p> 
<p>Open方法有两个参数：</p> 
<ol><li>access_rw， 传入false（init初始化属性系统时传入的该参数是true， 因为需要将属性写入，而App执行这个代码时传入的是false， 说明App只能读取）</li><li>fsetxattr_failed，传入nullptr, 这我们不用关心。</li></ol> 
<p>下面我们去看一下Open方法为什么无法创建prop_area对象，该方法实现在<code>bionic/libc/system_properties/context_node.cpp</code>中：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">bool</span> <span class="token class-name">ContextNode</span><span class="token operator">::</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token keyword">bool</span> access_rw<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token operator">*</span> fsetxattr_failed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  lock_<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>pa_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    lock_<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 格式为 /dev/__properties__/u:object_r:serialno_prop:s0</span>
  <span class="token keyword">char</span> filename<span class="token punctuation">[</span>PROP_FILENAME_MAX<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">async_safe_format_buffer</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"%s/%s"</span><span class="token punctuation">,</span> filename_<span class="token punctuation">,</span> context_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> len <span class="token operator">&gt;=</span> PROP_FILENAME_MAX<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    lock_<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>access_rw<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    pa_ <span class="token operator">=</span> prop_area<span class="token operator">::</span><span class="token function">map_prop_area_rw</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> context_<span class="token punctuation">,</span> fsetxattr_failed<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    pa_ <span class="token operator">=</span> prop_area<span class="token operator">::</span><span class="token function">map_prop_area</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  lock_<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> pa_<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>首先根据filename_, context_两个参数拼接出filename， 拼接出的filename的格式为<code>/dev/__properties__/${selinux context}</code>, 比如<code>/dev/__properties__/u:object_r:serialno_prop:s0</code>。</p> 
<p>因为access_rw为false， 会通过prop_area::map_prop_area来获取prop_area指针。下面我们分析一下这个方法。该方法实现在<code>bionic/libc/system_properties/prop_area.cpp</code>中</p> 
<pre><code class="prism language-cpp">prop_area<span class="token operator">*</span> prop_area<span class="token operator">::</span><span class="token function">map_prop_area</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> filename<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> O_CLOEXEC <span class="token operator">|</span> O_NOFOLLOW <span class="token operator">|</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>

  prop_area<span class="token operator">*</span> map_result <span class="token operator">=</span> <span class="token function">map_fd_ro</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> map_result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>逻辑比较简单。 首先通过open打开<code>/dev/__properties__/${selinux context}</code>文件，然后将该文件映射成prop_area。</p> 
<p>之所以会无法获取prop_area对象，是因为open打开文件失败了。因为没有权限访问这个文件。回顾一下init初始化属性系统的时候，会创建这个文件， 并设置selinux上下文。比如:</p> 
<p>文件 <code>/dev/__properties__/u:object_r:serialno_prop:s0</code><br> 对应的selinux context为 <code>u:object_r:serialno_prop:s0</code></p> 
<p>我们看一下Android中定义的和 <code>u:object_r:serialno_prop:s0</code>相关的策略，定义在<code>system/sepolicy/prebuilts/api/29.0/public/domain.te</code>文件中:</p> 
<pre><code class="prism language-bash"><span class="token comment"># Do not allow reading device's serial number from system properties except form</span>
<span class="token comment"># a few whitelisted domains.</span>
neverallow <span class="token punctuation">{<!-- --></span>
  domain
  -adbd
  -dumpstate
  -fastbootd
  -hal_camera_server
  -hal_cas_server
  -hal_drm_server
  -init
  -mediadrmserver
  -recovery
  -shell
  -system_server
  -vendor_init
<span class="token punctuation">}</span> serialno_prop:file r_file_perms<span class="token punctuation">;</span>
</code></pre> 
<p>这个策略的意义是：除了init，adbd等特殊的域(domain)之外，其他域无法访问selinux context为serialno_prop的文件。</p> 
<p>这里的域可以认为是selinux给进程设置的一个标签，每个进程有不同的标签， 每个标签对应不同的策略， 所以就可以实现不同的进程访问不同的文件。</p> 
<p>通过ps -Z可以显示进程的selinux域：</p> 
<p>我们看一下init进程的域为 init：</p> 
<pre><code class="prism language-bash"><span class="token number">1901</span>:/ $ <span class="token function">ps</span> -eZ <span class="token operator">|</span> <span class="token function">grep</span> init
u:r:init:s0                    root              <span class="token number">1</span>      <span class="token number">0</span> <span class="token number">2221092</span>   <span class="token number">3296</span> <span class="token number">0</span>                   <span class="token number">0</span> S init
</code></pre> 
<p>adbd进程的域为adbd：</p> 
<pre><code class="prism language-bash"><span class="token number">1901</span>:/ $ <span class="token function">ps</span> -eZ <span class="token operator">|</span> <span class="token function">grep</span> adb                                                                                                                                            
u:r:adbd:s0                    shell         <span class="token number">12956</span>      <span class="token number">1</span> <span class="token number">2323304</span>   <span class="token number">4588</span> <span class="token number">0</span>                   <span class="token number">0</span> S adbd
</code></pre> 
<p>所以跟根据selinux策略， 他们可以访问<code>/dev/__properties__/u:object_r:serialno_prop:s0</code>读取序列号。</p> 
<p>再看一下普通App的selinux域：</p> 
<pre><code class="prism language-bash"><span class="token number">1901</span>:/ $ <span class="token function">ps</span> -eZ <span class="token operator">|</span> <span class="token function">grep</span> com.smile.gifmaker                                                                                                                             
u:r:untrusted_app_27:s0:c512,c768 u0_a299     <span class="token number">6305</span>    <span class="token number">842</span> <span class="token number">10498244</span> <span class="token number">476308</span> <span class="token number">0</span>                  <span class="token number">0</span> S com.smile.gifmaker
u:r:untrusted_app_27:s0:c512,c768 u0_a299     <span class="token number">6557</span>    <span class="token number">842</span> <span class="token number">6627940</span> <span class="token number">193148</span> <span class="token number">0</span>                   <span class="token number">0</span> S com.smile.gifmaker:messagesdk
u:r:untrusted_app_27:s0:c512,c768 u0_a299     <span class="token number">6773</span>    <span class="token number">842</span> <span class="token number">6705184</span> <span class="token number">202628</span> <span class="token number">0</span>                   <span class="token number">0</span> S com.smile.gifmaker:pushservice
</code></pre> 
<pre><code class="prism language-bash"><span class="token number">1901</span>:/ $ <span class="token function">ps</span> -eZ <span class="token operator">|</span> <span class="token function">grep</span> com.tencent.mobileqq                                                                                                                           
u:r:untrusted_app_27:s0:c512,c768 u0_a296     <span class="token number">6094</span>    <span class="token number">845</span> <span class="token number">1639688</span> <span class="token number">150228</span> <span class="token number">0</span>                   <span class="token number">0</span> S com.tencent.mobileqq:MSF
u:r:untrusted_app_27:s0:c512,c768 u0_a296     <span class="token number">6117</span>    <span class="token number">845</span> <span class="token number">1668920</span> <span class="token number">203432</span> <span class="token number">0</span>                   <span class="token number">0</span> S com.tencent.mobileqq
</code></pre> 
<pre><code class="prism language-bash"><span class="token number">1901</span>:/ $ <span class="token function">ps</span> -eZ <span class="token operator">|</span> <span class="token function">grep</span> com.ss.android.ugc.aweme                                                                                                                       
u:r:untrusted_app_29:s0:c41,c257,c512,c768 u0_a297 <span class="token number">8504</span> <span class="token number">842</span> <span class="token number">11194652</span> <span class="token number">473736</span> <span class="token number">0</span>                <span class="token number">0</span> S com.ss.android.ugc.aweme
u:r:untrusted_app_29:s0:c41,c257,c512,c768 u0_a297 <span class="token number">8888</span> <span class="token number">842</span> <span class="token number">6901604</span> <span class="token number">213232</span> <span class="token number">0</span>                 <span class="token number">0</span> S com.ss.android.ugc.aweme:push
u:r:untrusted_app_29:s0:c41,c257,c512,c768 u0_a297 <span class="token number">8964</span> <span class="token number">842</span> <span class="token number">6903492</span> <span class="token number">214656</span> <span class="token number">0</span>                 <span class="token number">0</span> S com.ss.android.ugc.aweme:pushservice
</code></pre> 
<p>普通App的selinux域都是untrusted_app，根据selinux策略， 普通App是无法访问<code>/dev/__properties__/u:object_r:serialno_prop:s0</code>文件的，也就无法读取文件中的ro.serialno属性。</p> 
<p>到此为止， 我们就明白了Android是如何通过selinux来保护ro.serialno属性不被随意读取的。</p> 
<p>不光是ro.serialno属性，其他属性也会有独立的selinux策略来保护。</p> 
<p>可见，Android对用户隐私数据的保护力度越来越大了，也越来越细。</p> 
<br> 
<h2><a id="_1447"></a>总结</h2> 
<p>本文我们主要通过跟踪<strong>init初始化属性系统</strong>和<strong>App读取属性</strong>这两个关键流程，来对系统属性进行了较为全面的分析，厘清了为什么普通App无法读取关键属性。同时对属性系统中的关键细节进行了分析， 包括一些关键目录，关键文件，关键对象和关键数据结构。</p> 
<br> 
<h2><a id="_1453"></a>相关源码</h2> 
<p><code>frameworks/base/core/java/android/os/Build.java</code><br> <code>frameworks/base/core/res/AndroidManifest.xml</code><br> <code>frameworks/base/services/core/java/com/android/server/os/DeviceIdentifiersPolicyService.java</code><br> <code>frameworks/base/core/java/android/os/SystemProperties.java</code><br> <code>frameworks/base/core/jni/android_os_SystemProperties.cpp</code><br> <code>system/core/base/properties.cpp</code><br> <code>system/core/base/include/android-base/properties.h</code><br> <code>bionic/tools/versioner/current/sys/cdefs.h</code><br> <code>bionic/libc/bionic/system_property_api.cpp</code><br> <code>bionic/libc/system_properties/include/system_properties/system_properties.h</code><br> <code>bionic/libc/system_properties/system_properties.cpp</code><br> <code>bionic/libc/system_properties/contexts_serialized.cpp</code><br> <code>system/core/property_service/libpropertyinfoparser/property_info_parser.cpp</code><br> <code>system/core/init/init.cpp</code><br> <code>system/core/init/property_service.cpp</code><br> <code>system/sepolicy/private/property_contexts</code><br> <code>bionic/libc/bionic/system_property_api.cpp</code><br> <code>bionic/libc/system_properties/context_node.cpp</code><br> <code>bionic/libc/system_properties/prop_area.cpp</code><br> <code>bionic/libc/bionic/system_property_api.cpp</code><br> <code>bionic/libc/system_properties/include/system_properties/prop_area.h</code><br> <code>system/sepolicy/prebuilts/api/29.0/public/domain.te</code></p> 
<p>该文中引用的源码是Android 10的，不同的Android版本可能会有差异</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/04f2b146e9403bd95e3ad3164317b51a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Socket 高效拆解包</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b19e77e9b80ff9f8e392df2f1c7a2ca7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Json格式错误问题：加注释引起的报错</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>