<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【java学习-Spring】Spring-data-jpa(Java Persistence API)和Template - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【java学习-Spring】Spring-data-jpa(Java Persistence API)和Template" />
<meta property="og:description" content="1，概念 1）JPA 场景：整合第三方ORM框架，建立一种标准的方式ORM 访问数据库的统一。
现阶段JPA几乎都是接口，实现都是Hibernate在做。我们都知道，在使用持久化工具的时候，一般都有一个对象来操作数据库，在原生的Hibernate中叫做Session，在MyBatis中叫做SqlSession，而在JPA中叫做EntityManager通过这个对象来操作数据库。
对象关系映射（Object Relational Mapping，简称ORM）
通过使用描述对象和数据库之间映射的元数据，将面向对象语言程序中的对象自动持久化到关系数据库中。
2）占位符 JPA里占位符：?1（必须按顺序传参）或 :userName （推荐，本地sql中出现的冒号需要通过双斜杠转义）。
3）JSR338（Java Specification Requests，JPA规范） JSR 338主要定义了如何通过普通的Java domain进行关系数据库的操作及映射，概括如下：
1&gt;Entity 必须是顶级类@Entity注解的类必须有一个无参的public 或 protected的构造方法不能是final类，且不能有final方法或final变量一个Entity类通常与数据库的一张表进行对应一个Entity实例表现为数据库的一条数据对Entity的操作即对数据库的操作生命周期包含初始、托管、释放、消亡 2&gt;EntityManager 对Entity持久化操作的主要对象通过EntityManagerFactory获取实例一个实例代表一个数据库连接每个线程拥有自己的EntityManager实例主要方法有persist、remove、merge、createQuery、find @PersistenceContext private EntityManager em; 3&gt;EntityManagerFactory 创建EntityManager的工厂EntityManagerFactory的创建成本很高，对于给定的数据库，系统应该只创建一个与之关联的Factory可使用@PersistenceUnit注入 4&gt; EntityTransaction 表示数据库事务，在增、删、改时使用可通过EntityManager.getTransaction()获取 5&gt;Persistence Context 维护一组托管状态的Entity实例与EntityManager是相关联的 6&gt;Persistence Unit 一组Entity及相关设置的逻辑单元定义创建EntityManagerFactory所需要的参数通过persistence.xml定义或者通过一个PersistenceUnitInfo对象 7&gt;总结 通过Persistence Unit创建EntityManagerFactory，再通过EntityManagerFactory获取EntityManager。
2，EntityManager EntityManager是JPA中用于增删改查的接口，它的作用是：对一组实体类（Entity Bean）与底层数据源（tabel或临时表）之间进行 O/R 映射的管理。
1）Entity生命周期 状态名描述作为java对象存在在实体管理器中存在在数据库存在New（瞬时对象）尚未有id，还未和Persistence Context建立关联的对象yesnonoManaged（持久化受管对象）有id值，已经和Persistence Context建立了关联的对象yesyesyesDetached（游离态离线对象）有id值，但没有和Persistence Context建立关联的对象nononoRemoved（删除的对象）有id值，尚且和Persistence Context有关联，但是已经准备好从数据库中删除yesyesno 2）方法 1&gt; 新增数据：em.persist(Object entity); 如果entity的主键不为空，而数据库没有该主键，会抛出异常；
如果entity的主键不为空，而数据库有该主键，且entity的其他字段与数据库不同，persist后不会更新数据库；
2&gt; 根据主键查找数据：em.find(Class entityClass, Object primaryKey); 如果主键格式不正确，会抛出illegalArgumentException异常;
如果主键在数据库未找到数据返回null；
3&gt;删除数据：em.remove(Object entity); 只能将Managed状态的Entity实例删除，由此Entity实例状态变为Removed；" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/ec52d67259484b4af56247427dd035c1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-25T17:43:57+08:00" />
<meta property="article:modified_time" content="2024-01-25T17:43:57+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【java学习-Spring】Spring-data-jpa(Java Persistence API)和Template</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="1_0"></a>1，概念</h2> 
<h3><a id="1JPA_1"></a>1）JPA</h3> 
<p>场景：整合第三方ORM框架，建立一种标准的方式ORM 访问数据库的统一。<br> 现阶段JPA几乎都是接口，实现都是Hibernate在做。我们都知道，在使用持久化工具的时候，一般都有一个对象来操作数据库，在原生的Hibernate中叫做Session，在MyBatis中叫做SqlSession，而在JPA中叫做EntityManager通过这个对象来操作数据库。</p> 
<blockquote> 
 <p>对象关系映射（Object Relational Mapping，简称ORM）<br> 通过使用描述对象和数据库之间映射的元数据，将面向对象语言程序中的对象自动持久化到关系数据库中。</p> 
</blockquote> 
<h3><a id="2_7"></a>2）占位符</h3> 
<p>JPA里占位符：<code>?1</code>（必须按顺序传参）或 <code>:userName</code> （推荐，本地sql中出现的冒号需要通过双斜杠转义）。</p> 
<h3><a id="3JSR338Java_Specification_RequestsJPAhttpsjcporgenjsrall_9"></a>3）<a href="https://jcp.org/en/jsr/all" rel="nofollow">JSR338（Java Specification Requests，JPA规范）</a></h3> 
<p>JSR 338主要定义了如何通过普通的Java domain进行关系数据库的操作及映射，概括如下：</p> 
<h4><a id="1Entity_11"></a>1&gt;Entity</h4> 
<ul><li>必须是顶级类</li><li>@Entity注解的类</li><li>必须有一个无参的public 或 protected的构造方法</li><li>不能是final类，且不能有final方法或final变量</li><li>一个Entity类通常与数据库的一张表进行对应</li><li>一个Entity实例表现为数据库的一条数据</li><li>对Entity的操作即对数据库的操作</li><li>生命周期包含初始、托管、释放、消亡</li></ul> 
<h4><a id="2EntityManager_20"></a>2&gt;EntityManager</h4> 
<ul><li>对Entity持久化操作的主要对象</li><li>通过EntityManagerFactory获取实例</li><li>一个实例代表一个数据库连接</li><li>每个线程拥有自己的EntityManager实例</li><li>主要方法有persist、remove、merge、createQuery、find</li></ul> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@PersistenceContext</span>
<span class="token keyword">private</span>  <span class="token class-name">EntityManager</span> em<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="3EntityManagerFactory_32"></a>3&gt;EntityManagerFactory</h4> 
<ul><li>创建EntityManager的工厂</li><li>EntityManagerFactory的创建成本很高，对于给定的数据库，系统应该只创建一个与之关联的Factory</li><li>可使用@PersistenceUnit注入</li></ul> 
<h4><a id="4_EntityTransaction_36"></a>4&gt; EntityTransaction</h4> 
<ul><li>表示数据库事务，在增、删、改时使用</li><li>可通过EntityManager.getTransaction()获取</li></ul> 
<h4><a id="5Persistence_Context_39"></a>5&gt;Persistence Context</h4> 
<ul><li>维护一组托管状态的Entity实例</li><li>与EntityManager是相关联的</li></ul> 
<h4><a id="6Persistence_Unit_42"></a>6&gt;Persistence Unit</h4> 
<ul><li>一组Entity及相关设置的逻辑单元</li><li>定义创建EntityManagerFactory所需要的参数</li><li>通过persistence.xml定义或者通过一个PersistenceUnitInfo对象</li></ul> 
<h4><a id="7_46"></a>7&gt;总结</h4> 
<p>通过Persistence Unit创建EntityManagerFactory，再通过EntityManagerFactory获取EntityManager。</p> 
<h2><a id="2EntityManager_48"></a>2，EntityManager</h2> 
<p>EntityManager是JPA中用于增删改查的接口，它的作用是：对一组实体类（Entity Bean）与底层数据源（tabel或临时表）之间进行 O/R 映射的管理。</p> 
<h3><a id="1Entity_50"></a>1）Entity生命周期</h3> 
<p><img src="https://images2.imgbox.com/36/5d/TebN8LMw_o.png" alt="在这里插入图片描述"></p> 
<table><thead><tr><th>状态名</th><th>描述</th><th>作为java对象存在</th><th>在实体管理器中存在</th><th>在数据库存在</th></tr></thead><tbody><tr><td>New（瞬时对象）</td><td>尚未有id，还未和Persistence Context建立关联的对象</td><td>yes</td><td>no</td><td>no</td></tr><tr><td>Managed（持久化受管对象）</td><td>有id值，已经和Persistence Context建立了关联的对象</td><td>yes</td><td>yes</td><td>yes</td></tr><tr><td>Detached（游离态离线对象）</td><td>有id值，但没有和Persistence Context建立关联的对象</td><td>no</td><td>no</td><td>no</td></tr><tr><td>Removed（删除的对象）</td><td>有id值，尚且和Persistence Context有关联，但是已经准备好从数据库中删除</td><td>yes</td><td>yes</td><td>no</td></tr></tbody></table> 
<h3><a id="2_58"></a>2）方法</h3> 
<h4><a id="1_empersistObject_entity_59"></a>1&gt; 新增数据：em.persist(Object entity);</h4> 
<p>如果entity的主键不为空，而数据库没有该主键，会抛出异常；<br> 如果entity的主键不为空，而数据库有该主键，且entity的其他字段与数据库不同，persist后不会更新数据库；</p> 
<h4><a id="2_emfindClassT_entityClass_Object_primaryKey_62"></a>2&gt; 根据主键查找数据：em.find(Class entityClass, Object primaryKey);</h4> 
<p>如果主键格式不正确，会抛出illegalArgumentException异常;<br> 如果主键在数据库未找到数据返回null；</p> 
<h4><a id="3emremoveObject_entity_65"></a>3&gt;删除数据：em.remove(Object entity);</h4> 
<p>只能将Managed状态的Entity实例删除，由此Entity实例状态变为Removed；</p> 
<h4><a id="4_DetachedEntityManagedemmergeT_entity_67"></a>4&gt; 将Detached状态的Entity实例转至Managed状态：em.merge(T entity);</h4> 
<h4><a id="5_EntityDetachedemclear_68"></a>5&gt; 将所有的Entity实例状态转至Detached状态：em.clear();</h4> 
<p>场景举例：</p> 
<pre><code>从数据查出对象A
B.list=A.list
修改B.list
save（B)
</code></pre> 
<p>最后发现往往A在数据库种的值也跟着改变了，为避免这种情况，在每次save之前em.clear() 一下</p> 
<h4><a id="6_ManagedEntityemflush_77"></a>6&gt; 将所有Managed状态的Entity实例同步到数据库：em.flush();</h4> 
<h4><a id="7_EntityemrefreshObject_entity_78"></a>7&gt; 刷新获得最新Entity：em.refresh(Object entity);</h4> 
<p>加载Entity实例后，数据库该条数据被修改，refresh该实例，能得到数据库最新的修改，覆盖原来的Entity实例。</p> 
<h4><a id="8_SessionemunwrapSessionclass_80"></a>8&gt; 获取Session对象：em.unwrap(Session.class)</h4> 
<h3><a id="3_82"></a>3）托管方式</h3> 
<p>A. 容器托管（EntityManger &amp;&amp; PersistenceContext）</p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@PersistenceContext</span> 也可以用<span class="token annotation punctuation">@Autowired</span>注解。
    <span class="token class-name">EntityManager</span> em<span class="token punctuation">;</span>
</code></pre> 
<p>@PersistenceContext是jpa专有的注解（推荐），而@Autowired是spring自带的注释。<br> @AutowiredEntityManager不是线程安全的，当多个请求进来的时候，spring会创建多个线程，而@PersistenceContext就是用来为每个线程创建一个EntityManager的，而@Autowired就只创建了一个，为所有线程共用，有可能报错。<br> B. 应用托管（EntityManagerFactory &amp;&amp; PersistenceUnit）</p> 
<pre><code class="prism language-java"><span class="token class-name">EntityManagerFactory</span> 接口主要用来创建 <span class="token class-name">EntityManager</span> 实例。该接口约定了如下<span class="token number">4</span>个方法：
<span class="token function">createEntityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span>：用于创建实体管理器对象实例。
<span class="token function">createEntityManager</span><span class="token punctuation">(</span><span class="token class-name">Map</span> map<span class="token punctuation">)</span>：用于创建实体管理器对象实例的重载方法，<span class="token class-name">Map</span> 参数用于提供 <span class="token class-name">EntityManager</span> 的属性。
<span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span>：检查 <span class="token class-name">EntityManagerFactory</span> 是否处于打开状态。实体管理器工厂创建后一直处于打开状态，除非调用<span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>方法将其关闭。
<span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>：关闭 <span class="token class-name">EntityManagerFactory</span> 。 <span class="token class-name">EntityManagerFactory</span> 关闭后将释放所有资源，<span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span>方法测试将返回 <span class="token boolean">false</span>，其它方法将不能调用，否则将导致<span class="token class-name">IllegalStateException</span>异常。
</code></pre> 
<h2><a id="2_99"></a>2，原理</h2> 
<h3><a id="1Repository_100"></a>1）Repository接口</h3> 
<p><img src="https://images2.imgbox.com/d4/c4/eEZnmMp8_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="Repository_102"></a>Repository</h4> 
<p>最顶层的接口，是一个空接口，目的是为了统一所有的Repository的类型，且能让组件扫描时自动识别。</p> 
<h4><a id="CrudRepository_104"></a>CrudRepository</h4> 
<p>Repository的子接口，提供CRUD 的功能。</p> 
<h4><a id="PagingAndSortingRepository_106"></a>PagingAndSortingRepository</h4> 
<p>CrudRepository的子接口, 添加分页排序。</p> 
<h4><a id="JpaRepository_108"></a>JpaRepository</h4> 
<p>PagingAndSortingRepository的子接口,增加批量操作等。</p> 
<h5><a id="_110"></a>常用方法</h5> 
<pre><code>delete删除或批量删除 
findOne查找单个 
findAllByIdAndName查找所有 
save保存单个或批量保存 
saveAndFlush保存并刷新到数据库
countByInvestUserId
</code></pre> 
<table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td>dao.flush ()</td><td>同步持久上下文环境，即将持久上下文环境的所有未保存实体的状态信息保存到数据库中。</td></tr><tr><td>dao.refresh (Object entity)</td><td>用数据库实体记录的值更新实体对象的状态，即更新实例的属性值。</td></tr><tr><td>dao.clear ()</td><td>清除持久上下文环境，断开所有关联的实体。如果这时还有未提交的更新则会被撤消。</td></tr><tr><td>dao.contains (Object entity)</td><td>判断一个实例是否属于当前持久上下文环境管理的实体。</td></tr><tr><td>dao.isOpen ()</td><td>判断当前的实体管理器是否是打开状态。</td></tr><tr><td>dao.getTransaction ()</td><td>返回资源层的事务对象。EntityTransaction实例可以用于开始和提交多个事务。</td></tr><tr><td>dao.close ()</td><td>关闭实体管理器。之后若调用实体管理器实例的方法或其派生的查询对象的方法都将抛出 IllegalstateException 异常，除了getTransaction 和 isOpen方法(返回 false)。不过，当与实体管理器关联的事务处于活动状态时，调用 close 方法后持久上下文将仍处于被管理状态，直到事务完成。</td></tr></tbody></table> 
<h4><a id="JpaSpecificationExecutor_128"></a>JpaSpecificationExecutor</h4> 
<p>用来做复杂查询的接口。</p> 
<h3><a id="2_130"></a>2）启动过程</h3> 
<p>由于引入了starter-data-jpa，自动配置，spring启动时会实例化一个Repositories，然后扫描包，找出所有继承Repository的接口（除@NoRepositoryBean注解的类），遍历装配。为每一个接口创建相关实例。<br> SimpleJpaRespositry——用来进行默认的DAO操作，是所有Repository的默认实现<br> JpaRepositoryFactoryBean——装配bean，装载了动态代理Proxy，会以对应的DAO的beanName为key注册到DefaultListableBeanFactory中，在需要被注入的时候从这个bean中取出对应的动态代理Proxy注入给DAO<br> JdkDynamicAopProxy——动态代理对应的InvocationHandler，负责拦截DAO接口的所有的方法调用，然后做相应处理，比如findByUsername被调用的时候会先经过这个类的invoke方法</p> 
<p>导入jpa，自动配置扫描包内所有继承了Repository接口的接口，为每一个接口实例一个代理类（SimpleJpaRepository），并为每个方法确定一个query策略，已经其他所需的bean，使用自定的repository时，是使用的代理类，经过一些列的拦截器后，选取一个query执行器JpaQueryExecution，然后创建Query对象，拼接sql，组装参数等DB操作，最后返回Query.getResultList()。</p> 
<h2><a id="3_138"></a>3，使用</h2> 
<h3><a id="1maven_139"></a>1）maven配置以及相关数据库依赖配置</h3> 
<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-data-jpa&lt;/artifactId&gt;
    &lt;version&gt;2.1.7.RELEASE&lt;/version&gt;
&lt;/dependency&gt;
</code></pre> 
<h3><a id="2_147"></a>2）实体类及注解</h3> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name<span class="token operator">=</span>userinfoTab<span class="token punctuation">)</span> 
<span class="token annotation punctuation">@Entity</span> 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Userinfo</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Id</span>  <span class="token comment">//映射到数据库表的主键属性</span>
    <span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span>strategy<span class="token operator">=</span><span class="token class-name">GenerationType</span><span class="token punctuation">.</span>AUTO<span class="token punctuation">)</span>  <span class="token comment">//主键的生成策略(自增）</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> user_id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> user_name<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>length <span class="token operator">=</span> <span class="token number">255</span><span class="token punctuation">)</span> <span class="token comment">//配置单列属性</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> user_tel<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Transient</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> new_time<span class="token punctuation">;</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="1Entity_164"></a>1&gt;@Entity</h4> 
<ol><li>类注解；</li><li>声明实体类；</li><li>不可缺省</li></ol> 
<h4><a id="2TablenameuserinfoTab_168"></a>2&gt;@Table(name=userinfoTab)</h4> 
<ol><li>类注解；</li><li>指定数据块表映射；</li></ol> 
<table><thead><tr><th align="left">参数</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">name</td><td align="left">表名，缺省以类名做表名</td></tr><tr><td align="left">catalog</td><td align="left">设置表所属的数据库目录</td></tr><tr><td align="left">schema</td><td align="left">设置表所属的模式</td></tr></tbody></table> 
<h4><a id="3Id_178"></a>3&gt;<code>@Id</code></h4> 
<ol><li>主键注解；</li><li>不可缺省，除非采用复合主键；<br> 对于复合主键有2种实现方式：<code>@idClass</code> 或 <code>@EmbeddedId</code></li></ol> 
<h4><a id="4GeneratedValue_182"></a>4&gt;<code>@GeneratedValue</code></h4> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span>strategy<span class="token operator">=</span><span class="token class-name">GenerationType</span><span class="token punctuation">.</span>AUTO<span class="token punctuation">)</span> 
</code></pre> 
<ol><li>主键注解；与<code>@Id</code>一起使用</li><li>主键是自动生成策略:</li></ol> 
<table><thead><tr><th align="left">策略</th><th align="left">说明</th><th align="left">备注</th></tr></thead><tbody><tr><td align="left">IDENTITY</td><td align="left">自增方式</td><td align="left">Oracle 不支持这种方式；</td></tr><tr><td align="left">AUTO</td><td align="left">默认值；JPA自动选择合适的策略；</td><td align="left">默认情况下，SqlServer 对应 identity，MySQL 对应 auto increment。</td></tr><tr><td align="left">SEQUENCE</td><td align="left">通过序列产生主键，通过 <code>@SequenceGenerator</code> 注解指定序列名</td><td align="left">MySql 不支持这种方式</td></tr><tr><td align="left">TABLE</td><td align="left">通过表产生主键，使用该策略可以使应用更易于数据库移植。</td><td align="left"></td></tr></tbody></table> 
<h4><a id="5idClass_196"></a>5&gt;@idClass（复合主键）</h4> 
<h5><a id="a__197"></a>a. 复合主键类</h5> 
<p>编写一个复合主键的类CustomerPK，代码如下：CustomerPK.java<br> 作为符合主键类，要满足以下几点要求。</p> 
<ol><li>必须实现Serializable接口。</li><li>必须有默认的public无参数的构造方法。</li><li>必须覆盖equals和hashCode方法。</li></ol> 
<p>@Data自动生成构造函数： CustomerPK()，CustomerPK(String name, String email)；set，get方法；hashCode() ，equals(Object obj) 方法。<br> equals方法用于判断两个对象是否相同，EntityManger通过find方法来查找Entity时，是根据equals的返回值来判断的。本例中，只有对象的name和email值完全相同时或同一个对象时则返回true，否则返回false。hashCode方法返回当前对象的哈希码，生成的hashCode相同的概率越小越好，算法可以进行优化。</p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Serializable</span><span class="token punctuation">;</span>
<span class="token comment">//复合主键对象</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomerPK</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{<!-- --></span>

         <span class="token keyword">private</span> <span class="token class-name">String</span> email<span class="token punctuation">;</span>
         <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="b_IdClass_216"></a>b. @IdClass注解</h5> 
<p>通过@IdClass注释在实体中标注复合主键，实体代码如下：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"customer"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@IdClass</span><span class="token punctuation">(</span><span class="token class-name">CustomerPK</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomerEO</span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">{<!-- --></span>

         <span class="token keyword">private</span> <span class="token class-name">Integer</span> id<span class="token punctuation">;</span>     
         <span class="token annotation punctuation">@Id</span>
         <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
         <span class="token annotation punctuation">@Id</span>
         <span class="token keyword">private</span> <span class="token class-name">String</span> email<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="6EmbeddedId_233"></a>6&gt;@EmbeddedId（复合主键）</h4> 
<ol><li>@Embeddable注释复合主键类</li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Embeddable</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DependentId</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> id
<span class="token punctuation">}</span>
</code></pre> 
<ol start="2"><li>@EmbeddedId引入复合主键</li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Employee</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@EmbeddedId</span>
    <span class="token keyword">private</span> <span class="token class-name">EmployeeId</span> ids<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> email<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="7Embedded_259"></a>7&gt;@Embedded</h4> 
<p>想让两个类的属性生成一个数据表，在一个类里这样加入另一个类即可：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Embedded</span> 
<span class="token keyword">private</span> <span class="token class-name">C</span> c<span class="token punctuation">;</span> 
</code></pre> 
<h4><a id="8MappedSuperclass_267"></a>8&gt;@MappedSuperclass</h4> 
<p>一个类继承另一个类的所有属性，则在父类里这样写：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"serial"</span><span class="token punctuation">)</span> 
<span class="token annotation punctuation">@Entity</span> 
<span class="token annotation punctuation">@MappedSuperclass</span>   <span class="token comment">//增加这一行 </span>
并把父类的所有属性的<span class="token keyword">private</span>改为<span class="token keyword">protected</span>即可 
</code></pre> 
<h4><a id="9__OneToOne_ManyToOne_277"></a>9&gt; 对象关联关系 <code>@OneToOne</code> <code>@ManyToOne</code></h4> 
<p>@OneToOne 并通过@JoinColumn指定了表之间的外键关系</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Entity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">{<!-- --></span>
	<span class="token annotation punctuation">@OneToOne</span>
	<span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"address_id"</span><span class="token punctuation">)</span>
	<span class="token keyword">private</span> <span class="token class-name">Address</span> address<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>@ManyToOne 并通过@JoinColumn指定了表之间的外键关系<br> @OneToMany 并通过@JoinColumn指定了表之间的外键关系<br> @ManyToMany 并通过@JoinTable指定了表之间的外键关系</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Entity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Product</span><span class="token punctuation">{<!-- --></span>
	<span class="token annotation punctuation">@ManyToMany</span> 
	<span class="token comment">//以关联表product_catalog表示关系。</span>
	<span class="token annotation punctuation">@JoinTable</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"product_catalog"</span><span class="token punctuation">,</span>joinColumns <span class="token operator">=</span> <span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"product_id"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> inverseJoinColumns <span class="token operator">=</span> <span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"catalog_id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">private</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Catalog</span><span class="token punctuation">&gt;</span></span> catalogs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Catalog</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@OneToMany</span><span class="token punctuation">(</span>cascade <span class="token operator">=</span> <span class="token class-name">CascadeType</span><span class="token punctuation">.</span>ALL<span class="token punctuation">,</span> mappedBy <span class="token operator">=</span> <span class="token string">"a"</span><span class="token punctuation">,</span> fetch <span class="token operator">=</span> <span class="token class-name">FetchType</span><span class="token punctuation">.</span>EAGER<span class="token punctuation">)</span>
</code></pre> 
<ol><li> <p>fetch属性：<br> 值| 说明<br> –|:–<br> FetchType.EAGER | 即时加载；默认。<br> FetchType.LAZY | 懒加载</p> </li><li> <p>optional属性<br> 表示该属性是否允许为null, 默认为true</p> </li></ol> 
<h4><a id="10Basic_315"></a>10&gt;@Basic</h4> 
<p>表示属性到数据库表字段的简单映射，可缺省。</p> 
<h4><a id="11Column_317"></a>11&gt;@Column</h4> 
<ol><li>字段注解；</li><li>声明数据 库字段和类属性对应关系</li></ol> 
<table><thead><tr><th align="left">属性</th><th align="left">说明</th><th align="left">缺省</th></tr></thead><tbody><tr><td align="left">name</td><td align="left">显示指定数据块映射字段；</td><td align="left">按字段名驼峰转下划线映射</td></tr><tr><td align="left">unique</td><td align="left"></td><td align="left"></td></tr><tr><td align="left">nullable</td><td align="left"></td><td align="left"></td></tr><tr><td align="left">length</td><td align="left"></td><td align="left"></td></tr></tbody></table> 
<h4><a id="12Transient_327"></a>12&gt;@Transient</h4> 
<p>ORM框架将忽略该字段，不映射数据库字段。</p> 
<h4><a id="13Temporal_329"></a>13&gt;@Temporal</h4> 
<p>调整精度： DATE, TIME, 和 TIMESTAMP</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Temporal</span><span class="token punctuation">(</span><span class="token class-name">TemporalType</span><span class="token punctuation">.</span>TIMESTAMP<span class="token punctuation">)</span><span class="token comment">// 时间戳</span>
    <span class="token keyword">public</span> <span class="token class-name">Date</span> <span class="token function">getCreatedTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> createdTime<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

<span class="token annotation punctuation">@Temporal</span><span class="token punctuation">(</span><span class="token class-name">TemporalType</span><span class="token punctuation">.</span>DATE<span class="token punctuation">)</span> <span class="token comment">//时间精确到天</span>
    <span class="token keyword">public</span> <span class="token class-name">Date</span> <span class="token function">getBirth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> birth<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="14Lob_343"></a>14&gt;@Lob</h4> 
<p>声明字段为 Clob 或 Blob 类型。<br> 对应pg中的<code>oid</code>数据类型。</p> 
<h3><a id="3Repository_346"></a>3）Repository接口及注解</h3> 
<h4><a id="JPQLSQL_347"></a>JPQL(面向对象的SQL语法结构)</h4> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserinfoRepository</span> <span class="token keyword">extends</span> <span class="token class-name">JpaRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Userinfo</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Modifying</span>
    <span class="token annotation punctuation">@Query</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"update userinfo set user_name = :name, user_tel = :tel where user_id = :id"</span><span class="token punctuation">,</span>nativeQuery <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">void</span> <span class="token function">updateById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"tel"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> tel<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Query</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"select user_id from userinfo"</span><span class="token punctuation">,</span>nativeQuery <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">getUserIdList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>以上类通常放在dao包下面。<br> 外部使用时：</p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">ThreatRepository</span> threatRepository<span class="token punctuation">;</span>
    threatRepository<span class="token punctuation">.</span><span class="token function">saveAll</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="Querysql_367"></a>@Query（绑定自定义sql到自定义方法上）</h5> 
<p>当进行 find 操作时，JPA 在 EntityManager 中缓存了 find 生成的对象，当再次 find 时会直接返回该对象。<br> @Query 引起的数据库变更 EntityManager 并不能发现，更进一步说，使用其它工具或者其它框架修改数据库中的数据，也不能及时反应到 JPA 的 find 系列方法上来。</p> 
<h5><a id="ModifyingQuerysql_370"></a>@Modifying（标注@Query绑定的sql涉及增删改）</h5> 
<p>加上这个注解，JPA会以更新类语句来执行，而不再是以查询语句执行。　<br> 该注解中有两个属性：</p> 
<ol><li>flushAutomatically：自动刷新，即执行完语句后立即将变化内容从缓存刷新到磁盘。</li><li>clearAutomatically：自动清除缓存，即执行完语句后自动清除掉已经过期的实体，比如，我们删除了一个实体，但是在还没有执行flush操作时，这个实体还存在于实体管理器EntityManager中，但这个实体已经过期没有任何用处，直到flush操作时才会被删除掉。如果希望在删除该实体时立即将该实体从实体管理器中删除，则可以将该属性设置为true，会在更新完数据库后会主动清理一级缓存。<br> 自动清理之后还会带来一个新的问题，clear 操作清理的缓存中，还包括提交后未 flush 的数据，例如调用 save 而不是 saveAndFlush 就有可能不会立即将修改内容更新到数据库中，在 save 之后 flush 之前调用 @Modifying(clearAutomatically = true) 修饰的方法就有可能导致修改丢失。如果再要解决这个问题，还可以再加上另外一个属性 @Modifying(clearAutomatically = true, flushAutomatically = true)，@Modifying 的 flushAutomatically 属性为 true 时，执行 modifying query 之前会先调用 flush 操作，从而避免数据丢失问题。</li><li>在实际运行中，clear 和 flush 操作都可能需要消耗一定的时间，要根据系统实际情况可以选择使用其中的一个或两个属性，以保证系统的正确性。</li></ol> 
<pre><code class="prism language-java"><span class="token class-name">User</span> user <span class="token operator">=</span> userDao<span class="token punctuation">.</span><span class="token function">getOneById</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
userDao<span class="token punctuation">.</span><span class="token function">updateName</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>getId<span class="token punctuation">,</span> <span class="token string">'abc'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">User</span> user2 <span class="token operator">=</span> userDao<span class="token punctuation">.</span><span class="token function">getOneById</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user2<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//输出的是旧数据，不是abc</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token string">'abc'</span><span class="token punctuation">;</span>
<span class="token class-name">User</span> user <span class="token operator">=</span> userDao<span class="token punctuation">.</span><span class="token function">getOneById</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
user<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
userDao<span class="token punctuation">.</span><span class="token function">updateName</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>getId<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">User</span> user2 <span class="token operator">=</span> userDao<span class="token punctuation">.</span><span class="token function">getOneById</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user2<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//输出的是新数据，通过set修改了缓存中的内容</span>
</code></pre> 
<h5><a id="Transactional_395"></a>@Transactional</h5> 
<p>默认情况下，repository 接口中的CRUD方法都是被@Transactional注解修饰了的。</p> 
<ul><li>如果在同一个类中，一个非@Transaction的方法调用有@Transaction的方法不会生效，因为代理问题。</li><li>在类上相当于在每个public方法上加上@Transaction。</li></ul> 
<ol><li>对于查sql，默认为：@Transactional(readOnly = true)，即只读事务；</li><li>增删改sql，默认为：@Transactional(readOnly = false)，即非只读事务；当一个事务是非只读事务的时候，我们可以进行任何操作。。</li><li>如果你需要修改repository 接口中的某些方法的事务属性，可以在该方法上重新加上@Transactional注解，并设置需要的属性。</li></ol> 
<h3><a id="4Native_SQL_Query_403"></a>4）Native SQL Query</h3> 
<p>注意：</p> 
<ol><li>接收数据的实体必须添加：<code>@Entity</code> <code>@Id</code>的注释，属性采用驼峰并对应sql是下划线。<br> 如果jpa开启自动建表的时候，会在数据库生成一些数据为空的表。</li><li>如果不拿实体接收数据，<code>query.getResultList()</code>默认返回<code>List&lt;Object[]&gt;</code></li></ol> 
<h4><a id="1_408"></a>1&gt;查询</h4> 
<pre><code class="prism language-java"><span class="token class-name">StringBuffer</span> sql <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
sql<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"select * from user where id = :id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Query</span> query <span class="token operator">=</span> em<span class="token punctuation">.</span><span class="token function">createNativeQuery</span><span class="token punctuation">(</span>sql<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//通过setParameter注入参数，有效预防sql注入</span>
map<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>query<span class="token operator">::</span><span class="token function">setParameter</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//UserVo必须添加@Entity注解（配置了Java类与数据库映射）。会在数据库自动建表，可以关闭jpa自动建表功能</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserVo</span><span class="token punctuation">&gt;</span></span> users <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">getResultList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>数量查询：</p> 
<pre><code class="prism language-java">sql <span class="token operator">=</span> <span class="token string">"select count(1) from..."</span>
<span class="token class-name">Query</span> query <span class="token operator">=</span> em<span class="token punctuation">.</span><span class="token function">createNativeQuery</span><span class="token punctuation">(</span>sql<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Object</span> count <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">getSingleResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="2_429"></a>2&gt;更新</h4> 
<pre><code class="prism language-java"><span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"update user set name = :name'"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>……<span class="token punctuation">)</span>；
<span class="token class-name">Query</span> query <span class="token operator">=</span> em<span class="token punctuation">.</span><span class="token function">createNativeQuery</span><span class="token punctuation">(</span>sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
map<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>query<span class="token operator">::</span><span class="token function">setParameter</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
query<span class="token punctuation">.</span><span class="token function">executeUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="3_438"></a>3&gt;分页查询</h4> 
<pre><code class="prism language-java"><span class="token class-name">Query</span> query <span class="token operator">=</span> em<span class="token punctuation">.</span><span class="token function">createNativeQuery</span><span class="token punctuation">(</span>sql<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setParameter</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"aaa"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
query<span class="token punctuation">.</span><span class="token function">setFirstResult</span><span class="token punctuation">(</span>page <span class="token operator">*</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
query<span class="token punctuation">.</span><span class="token function">setMaxResults</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
list <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">getResultList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="4_445"></a>4&gt;批量更新</h4> 
<p><a href="https://blog.csdn.net/SunshineTan/article/details/104502542">JdbcTemplate语法：batchUpdate</a></p> 
<h3><a id="5Pageable_447"></a>5）Pageable分页查询</h3> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>domain<span class="token punctuation">.</span></span><span class="token class-name">Pageable</span><span class="token punctuation">;</span>
<span class="token annotation punctuation">@Query</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"SELECT* FROM stu_tab "</span><span class="token punctuation">,</span>nativeQuery <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ThreatEntity</span><span class="token punctuation">&gt;</span></span> <span class="token function">getThreatTrend_3h</span><span class="token punctuation">(</span><span class="token class-name">Pageable</span> pageable<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/testPageable"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token function">testPageable</span><span class="token punctuation">(</span>
        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"page"</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> page<span class="token punctuation">,</span>  <span class="token comment">//页码</span>
        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"size"</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> size<span class="token punctuation">,</span>    <span class="token comment">//每页数量 </span>
        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"sortType"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> sortType<span class="token punctuation">,</span>  <span class="token comment">//排序方式：ASC/DESC</span>
        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"sortableFields"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> sortableFields  <span class="token comment">//排序字段</span>
<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//判断排序类型及排序字段  </span>
    <span class="token class-name">Sort</span> sort <span class="token operator">=</span> <span class="token string">"ASC"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>sortType<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token class-name">Sort</span><span class="token punctuation">.</span><span class="token function">by</span><span class="token punctuation">(</span><span class="token class-name">Sort<span class="token punctuation">.</span>Direction</span><span class="token punctuation">.</span>ASC<span class="token punctuation">,</span> sortableFields<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token class-name">Sort</span><span class="token punctuation">.</span><span class="token function">by</span><span class="token punctuation">(</span><span class="token class-name">Sort<span class="token punctuation">.</span>Direction</span><span class="token punctuation">.</span>DESC<span class="token punctuation">,</span> sortableFields<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//获取pageable</span>
    <span class="token class-name">Pageable</span> pageable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PageRequest</span><span class="token punctuation">(</span>page<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>size<span class="token punctuation">,</span>sort<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> userRepository<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span>pageable<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>踩坑：sql语句中有distinct但无order by。加入pageable后报错如下：</p> 
<pre><code class="prism language-java">SELECT DISTINCT ON expressions must match initial ORDER BY expressions
</code></pre> 
<p>原因是：<br> 1，在sql中当order by和distinct同时使用时，如果指定了 SELECT DISTINCT，那么 ORDER BY 子句中的项就必须出现在选择列表中。<br> 2，在sql中加入order by语句即可解决该问题。<br> 3，pageable 中 的sort会自动在sql后面拼接order by语句。</p> 
<h3><a id="6_480"></a>6）批量插入删除</h3> 
<p>jpa的批量插入效率较低，在要求高性能批量插入的情况下可以使用<a href="https://blog.csdn.net/SunshineTan/article/details/104502542">spring jdbc进行批量插入</a>，可以明显提升插入效率。<br> 同理，jpa中自带的deleteBy…方法性能很差，遍历所有，根据id删除，所以需要自己写本地sql进行删除。</p> 
<h4><a id="jpa_483"></a>jpa批量插入慢原因</h4> 
<p>jpa插入源码：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span> <span class="token keyword">extends</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> <span class="token function">saveAll</span><span class="token punctuation">(</span><span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> entities<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>entities<span class="token punctuation">,</span> <span class="token string">"The given Iterable of entities not be null!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">S</span> entity <span class="token operator">:</span> entities<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">save</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span> <span class="token keyword">extends</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">S</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token class-name">S</span> entity<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>entityInformation<span class="token punctuation">.</span><span class="token function">isNew</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            em<span class="token punctuation">.</span><span class="token function">persist</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> entity<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> em<span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>查看源码可以知道批量插入saveAll 循环对每个对象进行save操作，每次save时会对对象做存在性检查，就是先查一遍，要是不存在才会保存。</p> 
<h3><a id="7inetIPv4__IPv6_jsonb_516"></a>7）inet(IPv4 或者 IPv6 网络地址)，jsonb</h3> 
<h4><a id="1UserType_517"></a>1&gt;UserType和方言</h4> 
<p>JPA不能识别pg的一些类型：inet，jsonb。为了自动转换需要开发者自定义一些类型，称为方言。</p> 
<ol><li>为了让JPA支持jsonb，需要自定义PostgreSQL9Dialect</li></ol> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>hibernate<span class="token punctuation">.</span>dialect<span class="token punctuation">.</span></span><span class="token class-name">PostgreSQL9Dialect</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">Types</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomPostgreSqlDialect</span> <span class="token keyword">extends</span> <span class="token class-name">PostgreSQL9Dialect</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token class-name">CustomPostgreSqlDialect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerColumnType</span><span class="token punctuation">(</span><span class="token class-name">Types</span><span class="token punctuation">.</span>JAVA_OBJECT<span class="token punctuation">,</span> <span class="token string">"jsonb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<ol start="2"><li>指定方言spring.jpa.database-platform: com.xxx.PostgreSqlDialect,如下</li></ol> 
<pre><code class="prism language-java">spring<span class="token operator">:</span>
  datasource<span class="token operator">:</span>
    driver<span class="token operator">-</span><span class="token keyword">class</span><span class="token operator">-</span>name<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>postgresql<span class="token punctuation">.</span></span>Driver</span>
    url<span class="token operator">:</span> jdbc<span class="token operator">:</span>postgresql<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">5432</span><span class="token operator">/</span>postgres
    username<span class="token operator">:</span> postgres
    password<span class="token operator">:</span> <span class="token number">123456</span>
    hikari<span class="token operator">:</span>
      connection<span class="token operator">-</span>timeout<span class="token operator">:</span> <span class="token number">20000</span>
      maximum<span class="token operator">-</span>pool<span class="token operator">-</span>size<span class="token operator">:</span> <span class="token number">5</span>
  jpa<span class="token operator">:</span>
    # 指定数据库管理系统<span class="token punctuation">,</span>可省略
    database<span class="token operator">:</span> MYSQL
    hibernate<span class="token operator">:</span>
      # 自动建表
      ddl<span class="token operator">-</span>auto<span class="token operator">:</span> create
      #命名策略
      naming<span class="token operator">:</span>
        strategy<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>hibernate<span class="token punctuation">.</span>cfg<span class="token punctuation">.</span></span>ImprovedNamingStrategy</span>
      database<span class="token operator">-</span>platform<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>hibernate<span class="token punctuation">.</span>dialect<span class="token punctuation">.</span></span>MySQL5InnoDBDialect</span>
    #打印sql
    show<span class="token operator">-</span>sql<span class="token operator">:</span> <span class="token boolean">true</span> 
    database<span class="token operator">-</span>platform<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>jsonb<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span>CustomPostgreSqlDialect</span>
    properties<span class="token operator">:</span>
      hibernate<span class="token punctuation">.</span>temp<span class="token punctuation">.</span>use_jdbc_metadata_defaults<span class="token operator">:</span> <span class="token boolean">false</span>
logging<span class="token operator">:</span>
  level<span class="token operator">:</span>
    # 打印日志
    <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>hibernate<span class="token punctuation">.</span>type<span class="token punctuation">.</span>descriptor<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span>BasicBinder</span><span class="token operator">:</span> trace
    org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token operator">:</span>
      <span class="token operator">-</span> debug
      <span class="token operator">-</span> info
    org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token operator">:</span> error
    # 打印sql参数
    org<span class="token punctuation">.</span>hibernate<span class="token punctuation">.</span>SQL<span class="token operator">:</span> debug
    <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>hibernate<span class="token punctuation">.</span>engine<span class="token punctuation">.</span></span>QueryParameters</span><span class="token operator">:</span> debug
    <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>hibernate<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>query<span class="token punctuation">.</span></span>HQLQueryPlan</span><span class="token operator">:</span> debug
    <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>hibernate<span class="token punctuation">.</span>type<span class="token punctuation">.</span>descriptor<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span>BasicBinder</span><span class="token operator">:</span> trace 

</code></pre> 
<ol start="3"><li>自定义jsonb数据类型</li></ol> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JsonbMapType</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">UserType</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JsonbListType</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">UserType</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InetType</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">UserType</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
</code></pre> 
<ol start="4"><li>然后就可以在PO中使用这种类型啦。</li></ol> 
<h4><a id="2Po_587"></a>2&gt;Po定义</h4> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@TypeDefs</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token annotation punctuation">@TypeDef</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"JsonbMapType"</span><span class="token punctuation">,</span> typeClass <span class="token operator">=</span> <span class="token class-name">JsonbMapType</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token annotation punctuation">@TypeDef</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"JsonbListType"</span><span class="token punctuation">,</span> typeClass <span class="token operator">=</span> <span class="token class-name">JsonbListType</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token annotation punctuation">@TypeDef</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"InetType"</span><span class="token punctuation">,</span> typeClass <span class="token operator">=</span> <span class="token class-name">InetType</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"test_table"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestObjcetPo</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Id</span>
    <span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span>strategy <span class="token operator">=</span> <span class="token class-name">GenerationType</span><span class="token punctuation">.</span>IDENTITY<span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"id"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Type</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token string">"InetType"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"ip"</span><span class="token punctuation">,</span> columnDefinition <span class="token operator">=</span> <span class="token string">"inet"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> ip<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"test_objcet1s"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Type</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token string">"JsonbListType"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TestObject1</span><span class="token punctuation">&gt;</span></span> testObject1s<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Temporal</span><span class="token punctuation">(</span><span class="token class-name">TemporalType</span><span class="token punctuation">.</span>TIMESTAMP<span class="token punctuation">)</span>
    <span class="token annotation punctuation">@CreationTimestamp</span>  #加了这个注解会自动更新创建时间
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"create_time"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> createTime<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Temporal</span><span class="token punctuation">(</span><span class="token class-name">TemporalType</span><span class="token punctuation">.</span>TIMESTAMP<span class="token punctuation">)</span>
    <span class="token annotation punctuation">@UpdateTimestamp</span> #加了这个注解会自动更新更新时间
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"update_time"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> updateTime<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre> 
<h4><a id="3sqlhostip_624"></a>3&gt;sql查询：host(ip)</h4> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Query</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"SELECT *  FROM test_table WHERE id= :id and host(ip) in (:ipList) "</span><span class="token punctuation">,</span> nativeQuery <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TestObject</span><span class="token punctuation">&gt;</span></span> <span class="token function">getObjectByIdAndIpList</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token keyword">long</span> id<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"ipList"</span><span class="token punctuation">)</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> ipList<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="4jdbcTemplatebatchUpdate_629"></a>4&gt;批量操作：jdbcTemplate.batchUpdate</h4> 
<pre><code class="prism language-java">
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">saveBatch</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TestObject</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">,</span> <span class="token class-name">Date</span> nowTime<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">return</span> jdbcTemplate<span class="token punctuation">.</span><span class="token function">batchUpdate</span><span class="token punctuation">(</span><span class="token string">"insert into test_tabkle ( update_time, soft_infos, ip) "</span> <span class="token operator">+</span>
                    <span class="token string">"values ( ?, to_json(?::json), ?::inet"</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">BatchPreparedStatementSetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setValues</span><span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span> ps<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{<!-- --></span>
                    ps<span class="token punctuation">.</span><span class="token function">setObject</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Timestamp</span><span class="token punctuation">(</span>nowTime<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    ps<span class="token punctuation">.</span><span class="token function">setObject</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSoftInfos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    ps<span class="token punctuation">.</span><span class="token function">setObject</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> potentialRiskList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getBatchSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> potentialRiskList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="8jpa_653"></a>8）jpa的更新操作-传入对象</h3> 
<p>字段有值就更新,没值就用原来的：</p> 
<pre><code class="prism language-java"><span class="token comment">/**
     *复杂JPA操作  使用@Query()自定义sql语句  根据业务id UId去更新整个实体
     * 删除和更新操作，需要@Modifying和@Transactional注解的支持
     *
     * 更新操作中 如果某个字段为null则不更新，否则更新【注意符号和空格位置】
     *
     * @param huaYangArea   传入实体，分别取实体字段进行set
     * @return  更新操作返回sql作用条数
     */</span>
    <span class="token annotation punctuation">@Modifying</span>
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token annotation punctuation">@Query</span><span class="token punctuation">(</span><span class="token string">"update HuaYangArea hy set "</span> <span class="token operator">+</span>
            <span class="token string">"hy.areaName = CASE WHEN :#{#huaYangArea.areaName} IS NULL THEN hy.areaName ELSE :#{#huaYangArea.areaName} END ,"</span> <span class="token operator">+</span>
            <span class="token string">"hy.areaPerson = CASE WHEN :#{#huaYangArea.areaPerson} IS NULL THEN hy.areaPerson ELSE :#{#huaYangArea.areaPerson} END ,"</span> <span class="token operator">+</span>
            <span class="token string">"hy.updateDate = CASE WHEN :#{#huaYangArea.updateDate} IS NULL THEN hy.updateDate ELSE :#{#huaYangArea.updateDate} END ,"</span> <span class="token operator">+</span>
            <span class="token string">"hy.updateId =  CASE WHEN :#{#huaYangArea.updateId} IS NULL THEN hy.updateId ELSE :#{#huaYangArea.updateId} END "</span> <span class="token operator">+</span>
            <span class="token string">"where hy.uid = :#{#huaYangArea.uid}"</span><span class="token punctuation">)</span>
    <span class="token keyword">int</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"huaYangArea"</span><span class="token punctuation">)</span> <span class="token class-name">HuaYangArea</span> huaYangArea<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/47366f6dd8d3160479d18a7cd55b4f6d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">电脑监控系统：企业网络安全解决方案</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0da9b756131e50e5ca1fe67a16bb4584/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">C语言常见面试题：什么是函数指针，函数指针的作用是什么？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>