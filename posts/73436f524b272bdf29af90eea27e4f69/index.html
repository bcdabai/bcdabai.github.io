<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【EFCore仓储模式】介绍一个EFCore的Repository实现 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【EFCore仓储模式】介绍一个EFCore的Repository实现" />
<meta property="og:description" content="阅读本文你的收获 了解仓储模式及泛型仓储的优点学会封装泛型仓储的一般设计思路学习在ASP.NET Core WebAPI项目中使用EntityFrameworkCore.Data.Repository 本文中的案例是微软EntityFrameworkCore的一个仓储模式实现，这个仓储库不是我自己写的，而是使用了一个老外写的EntityFrameworkCore.Data.Repository，大家可以一起来学习一下，如果你觉得合适，可以直接用在你的项目中，很方便。案例代码下载
一、 什么是仓储模式 仓储（Repository）模式自2004年首次作为领域驱动模型DDD设计的一部分引入，仓储本质上是提供数据的抽象，以便应用程序可以使用具有接口的相似的简单抽象集合。从此集合中CURD是通过一系列直接的方法完成，无需处理连接、命令等问题，使用此种模式可帮助实现松耦合，并保持领域对象的持久性无知。
仓储模式是为了在程序的数据访问层和业务逻辑层之间创建的一个抽象层仓储模式是一种数据访问模式，提供一种更松散耦合的数据访问方法将创建数据访问的逻辑写在单独的类中即仓储仓储负责和业务层进行持久化通信 下图为控制器和仓储协同工作的图例：
二、泛型仓储 仓储（Repository）是存在于工作单元和数据库之间单独分离出来的一层，是对数据访问的封装。其优点是
业务层无需知道具体实现，达到分离关注点；提高对数据库访问的维护，对于仓储的改变，并不改变业务的逻辑； 如果我们采用的ORM框架是EF Core，实现仓储模式的话，那么类图设计一般如下：
通常实现仓储的时候，会使用泛型技术封装增删改查的的通用功能，类型T即为具体要进行增删改查处理的实体类型。
使用泛型仓储（Generic Repository）的好处有以下几点：
更好的可重用性：泛型仓储可以在多个实体类型之间共享和重用，减少了重复的代码编写和维护工作。更好的类型安全性：使用泛型仓储可以在编译时就约束数据的类型，减少了运行时类型错误的可能性。更好的简洁性：泛型仓储可以通过使用通用的方法和接口来简化数据访问的逻辑，提供统一的CRUD（增删改查）操作接口。更好的可测试性：泛型仓储使得数据访问逻辑可以更容易地进行单元测试，因为可以使用模拟或者假数据来代替实际的数据存储。更好的扩展性：泛型仓储可以通过继承或者接口实现来扩展其功能，例如添加自定义的查询方法或者过滤器。 三、基于EF Core实现的泛型仓储案例 开发环境：
操作系统： Windows 10 专业版
平台版本是：.NET 6
开发框架：ASP.NET Core WebApi、Entity Framework Core
开发工具：Visual Studio 2022
数据库： MySQL 5.7&#43;
安装NuGet包 使用的NuGet包主要有：
EntityFrameworkCore.Data.Repository – 一个老外封装好的开源EfCore仓储实现EntityFrameworkCore.Data.UnitOfWork-- 跟以上配套的工作单元Pomelo.EntityFrameworkCore.MySql – MySQL数据库提供程序 简单剖析一下 EntityFrameworkCore.Data.Repository 可以看到，作者定义了泛型仓储接口如下：
public interface IRepository&lt;T&gt; : IRepository, IDisposable, ISyncRepository&lt;T&gt;, ISyncRepository, IQueryFactory&lt;T&gt;, IAsyncRepository&lt;T&gt;, IAsyncRepository where T : class { } IRepository&lt; T &gt;接口分别集继承了 ISyncRepository&lt; T &gt; 和 IAsyncRepository&lt; T &gt;这两个接口，分别是同步仓储方法接口和异步仓储方法接口。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/73436f524b272bdf29af90eea27e4f69/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-20T22:42:12+08:00" />
<meta property="article:modified_time" content="2024-01-20T22:42:12+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【EFCore仓储模式】介绍一个EFCore的Repository实现</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>阅读本文你的收获</h3> 
<ol><li>了解仓储模式及泛型仓储的优点</li><li>学会封装泛型仓储的一般设计思路</li><li>学习在ASP.NET Core WebAPI项目中使用EntityFrameworkCore.Data.Repository</li></ol> 
<p>本文中的案例是微软EntityFrameworkCore的一个仓储模式实现，这个仓储库不是我自己写的，而是使用了一个老外写的EntityFrameworkCore.Data.Repository，大家可以一起来学习一下，如果你觉得合适，可以直接用在你的项目中，很方便。<a href="https://download.csdn.net/download/ousetuhou/88760884?spm=1001.2014.3001.5503">案例代码下载</a></p> 
<h3><a id="__7"></a>一、 什么是仓储模式</h3> 
<p>仓储（Repository）模式自2004年首次作为领域驱动模型DDD设计的一部分引入，<strong>仓储本质上是提供数据的抽象，以便应用程序可以使用具有接口的相似的简单抽象集合</strong>。从此集合中CURD是通过一系列直接的方法完成，无需处理连接、命令等问题，使用此种模式可帮助实现松耦合，并保持领域对象的持久性无知。</p> 
<ul><li>仓储模式是为了在程序的数据访问层和业务逻辑层之间创建的一个抽象层</li><li>仓储模式是一种数据访问模式，提供一种更松散耦合的数据访问方法</li><li>将创建数据访问的逻辑写在单独的类中即仓储</li><li>仓储负责和业务层进行持久化通信</li></ul> 
<p>下图为控制器和仓储协同工作的图例：<br> <img src="https://images2.imgbox.com/13/88/6aNKBvLY_o.png" alt="仓储示意图"></p> 
<h3><a id="_19"></a>二、泛型仓储</h3> 
<p>仓储（Repository）是存在于工作单元和数据库之间单独分离出来的一层，是对数据访问的封装。其优点是</p> 
<ul><li>业务层无需知道具体实现，达到分离关注点；</li><li>提高对数据库访问的维护，对于仓储的改变，并不改变业务的逻辑；</li></ul> 
<p>如果我们采用的ORM框架是EF Core，实现仓储模式的话，那么类图设计一般如下：<br> <img src="https://images2.imgbox.com/70/4d/asc2Jwmq_o.png" alt="仓储模式类图">通常实现仓储的时候，会使用泛型技术封装增删改查的的通用功能，类型T即为具体要进行增删改查处理的实体类型。</p> 
<p>使用泛型仓储（Generic Repository）的好处有以下几点：</p> 
<ul><li>更好的可重用性：泛型仓储可以在多个实体类型之间共享和重用，减少了重复的代码编写和维护工作。</li><li>更好的类型安全性：使用泛型仓储可以在编译时就约束数据的类型，减少了运行时类型错误的可能性。</li><li>更好的简洁性：泛型仓储可以通过使用通用的方法和接口来简化数据访问的逻辑，提供统一的CRUD（增删改查）操作接口。</li><li>更好的可测试性：泛型仓储使得数据访问逻辑可以更容易地进行单元测试，因为可以使用模拟或者假数据来代替实际的数据存储。</li><li>更好的扩展性：泛型仓储可以通过继承或者接口实现来扩展其功能，例如添加自定义的查询方法或者过滤器。</li></ul> 
<h3><a id="EF_Core_35"></a>三、基于EF Core实现的泛型仓储案例</h3> 
<p>开发环境：</p> 
<blockquote> 
 <p>操作系统： Windows 10 专业版<br> 平台版本是：.NET 6<br> 开发框架：ASP.NET Core WebApi、Entity Framework Core<br> 开发工具：Visual Studio 2022<br> 数据库： MySQL 5.7+</p> 
</blockquote> 
<h4><a id="NuGet_44"></a>安装NuGet包</h4> 
<p>使用的NuGet包主要有：</p> 
<ol><li>EntityFrameworkCore.Data.Repository – 一个老外封装好的开源EfCore仓储实现</li><li>EntityFrameworkCore.Data.UnitOfWork-- 跟以上配套的工作单元</li><li>Pomelo.EntityFrameworkCore.MySql – MySQL数据库提供程序</li></ol> 
<h4><a id="_EntityFrameworkCoreDataRepository_50"></a>简单剖析一下 EntityFrameworkCore.Data.Repository</h4> 
<p>可以看到，作者定义了泛型仓储接口如下：</p> 
<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IRepository<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IRepository</span><span class="token punctuation">,</span> <span class="token class-name">IDisposable</span><span class="token punctuation">,</span> <span class="token class-name">ISyncRepository<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">ISyncRepository</span><span class="token punctuation">,</span> <span class="token class-name">IQueryFactory<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">IAsyncRepository<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">IAsyncRepository</span></span> <span class="token keyword">where</span> <span class="token class-name">T</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span>
<span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>
</code></pre> 
<p>IRepository&lt; T &gt;接口分别集继承了 ISyncRepository&lt; T &gt; 和 IAsyncRepository&lt; T &gt;这两个接口，分别是同步仓储方法接口和异步仓储方法接口。</p> 
<pre><code class="prism language-csharp"><span class="token comment">//同步仓储方法接口</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ISyncRepository<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ISyncRepository</span><span class="token punctuation">,</span> <span class="token class-name">IRepository</span><span class="token punctuation">,</span> <span class="token class-name">IDisposable</span><span class="token punctuation">,</span> <span class="token class-name">IQueryFactory<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span></span> <span class="token keyword">where</span> <span class="token class-name">T</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token return-type class-name">IList<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> <span class="token function">Search</span><span class="token punctuation">(</span><span class="token class-name">IQuery<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> query<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">IList<span class="token punctuation">&lt;</span>TResult<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">Search</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TResult<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">IQuery<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> TResult<span class="token punctuation">&gt;</span></span> query<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">T</span> <span class="token function">SingleOrDefault</span><span class="token punctuation">(</span><span class="token class-name">IQuery<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> query<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">TResult</span> <span class="token generic-method"><span class="token function">SingleOrDefault</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TResult<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">IQuery<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> TResult<span class="token punctuation">&gt;</span></span> query<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">T</span> <span class="token function">FirstOrDefault</span><span class="token punctuation">(</span><span class="token class-name">IQuery<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> query<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">TResult</span> <span class="token generic-method"><span class="token function">FirstOrDefault</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TResult<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">IQuery<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> TResult<span class="token punctuation">&gt;</span></span> query<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">T</span> <span class="token function">LastOrDefault</span><span class="token punctuation">(</span><span class="token class-name">IQuery<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> query<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">TResult</span> <span class="token generic-method"><span class="token function">LastOrDefault</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TResult<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">IQuery<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> TResult<span class="token punctuation">&gt;</span></span> query<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">Any</span><span class="token punctuation">(</span><span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> predicate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">Count</span><span class="token punctuation">(</span><span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> predicate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name"><span class="token keyword">long</span></span> <span class="token function">LongCount</span><span class="token punctuation">(</span><span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> predicate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">TResult</span> <span class="token generic-method"><span class="token function">Max</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TResult<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> TResult<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> selector<span class="token punctuation">,</span> <span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> predicate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">TResult</span> <span class="token generic-method"><span class="token function">Min</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TResult<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> TResult<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> selector<span class="token punctuation">,</span> <span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> predicate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name"><span class="token keyword">decimal</span></span> <span class="token function">Average</span><span class="token punctuation">(</span><span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> <span class="token keyword">decimal</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> selector<span class="token punctuation">,</span> <span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> predicate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name"><span class="token keyword">decimal</span></span> <span class="token function">Sum</span><span class="token punctuation">(</span><span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> <span class="token keyword">decimal</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> selector<span class="token punctuation">,</span> <span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> predicate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">T</span> <span class="token function">Attach</span><span class="token punctuation">(</span><span class="token class-name">T</span> entity<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">AttachRange</span><span class="token punctuation">(</span><span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> entities<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">T</span> <span class="token function">Add</span><span class="token punctuation">(</span><span class="token class-name">T</span> entity<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">AddRange</span><span class="token punctuation">(</span><span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> entities<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">T</span> <span class="token function">Update</span><span class="token punctuation">(</span><span class="token class-name">T</span> entity<span class="token punctuation">,</span> <span class="token keyword">params</span> <span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> <span class="token keyword">object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> properties<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">Update</span><span class="token punctuation">(</span><span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> predicate<span class="token punctuation">,</span> <span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> T<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> expression<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">UpdateRange</span><span class="token punctuation">(</span><span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> entities<span class="token punctuation">,</span> <span class="token keyword">params</span> <span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> <span class="token keyword">object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> properties<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">T</span> <span class="token function">Remove</span><span class="token punctuation">(</span><span class="token class-name">T</span> entity<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">Remove</span><span class="token punctuation">(</span><span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> predicate<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">RemoveRange</span><span class="token punctuation">(</span><span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> entities<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">ExecuteSqlCommand</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> sql<span class="token punctuation">,</span> <span class="token keyword">params</span> <span class="token class-name"><span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> parameters<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">IList<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> <span class="token function">FromSql</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> sql<span class="token punctuation">,</span> <span class="token keyword">params</span> <span class="token class-name"><span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> parameters<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ChangeTable</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> table<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ChangeState</span><span class="token punctuation">(</span><span class="token class-name">T</span> entity<span class="token punctuation">,</span> <span class="token class-name">EntityState</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">EntityState</span> <span class="token function">GetState</span><span class="token punctuation">(</span><span class="token class-name">T</span> entity<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Reload</span><span class="token punctuation">(</span><span class="token class-name">T</span> entity<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">TrackGraph</span><span class="token punctuation">(</span><span class="token class-name">T</span> rootEntity<span class="token punctuation">,</span> <span class="token class-name">Action<span class="token punctuation">&lt;</span>EntityEntryGraphNode<span class="token punctuation">&gt;</span></span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token generic-method"><span class="token function">TrackGraph</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TState<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">T</span> rootEntity<span class="token punctuation">,</span> <span class="token class-name">TState</span> state<span class="token punctuation">,</span> <span class="token class-name">Func<span class="token punctuation">&lt;</span>EntityEntryGraphNode<span class="token punctuation">&lt;</span>TState<span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">IQueryable<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> <span class="token function">ToQueryable</span><span class="token punctuation">(</span><span class="token class-name">IQuery<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> query<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">IQueryable<span class="token punctuation">&lt;</span>TResult<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">ToQueryable</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TResult<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">IQuery<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> TResult<span class="token punctuation">&gt;</span></span> query<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-csharp"><span class="token comment">//异步仓储方法接口</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IAsyncRepository<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IAsyncRepository</span><span class="token punctuation">,</span> <span class="token class-name">IRepository</span><span class="token punctuation">,</span> <span class="token class-name">IDisposable</span><span class="token punctuation">,</span> <span class="token class-name">IQueryFactory<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span></span> <span class="token keyword">where</span> <span class="token class-name">T</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>IList<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">SearchAsync</span><span class="token punctuation">(</span><span class="token class-name">IQuery<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> query<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token type-expression class-name">CancellationToken</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>IList<span class="token punctuation">&lt;</span>TResult<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">SearchAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TResult<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">IQuery<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> TResult<span class="token punctuation">&gt;</span></span> query<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token type-expression class-name">CancellationToken</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> <span class="token function">SingleOrDefaultAsync</span><span class="token punctuation">(</span><span class="token class-name">IQuery<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> query<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token type-expression class-name">CancellationToken</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>TResult<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">SingleOrDefaultAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TResult<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">IQuery<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> TResult<span class="token punctuation">&gt;</span></span> query<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token type-expression class-name">CancellationToken</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> <span class="token function">FirstOrDefaultAsync</span><span class="token punctuation">(</span><span class="token class-name">IQuery<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> query<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token type-expression class-name">CancellationToken</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>TResult<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">FirstOrDefaultAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TResult<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">IQuery<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> TResult<span class="token punctuation">&gt;</span></span> query<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token type-expression class-name">CancellationToken</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> <span class="token function">LastOrDefaultAsync</span><span class="token punctuation">(</span><span class="token class-name">IQuery<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> query<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token type-expression class-name">CancellationToken</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>TResult<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">LastOrDefaultAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TResult<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">IQuery<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> TResult<span class="token punctuation">&gt;</span></span> query<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token type-expression class-name">CancellationToken</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> <span class="token function">AnyAsync</span><span class="token punctuation">(</span><span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> predicate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token type-expression class-name">CancellationToken</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span> <span class="token function">CountAsync</span><span class="token punctuation">(</span><span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> predicate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token type-expression class-name">CancellationToken</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">long</span><span class="token punctuation">&gt;</span></span> <span class="token function">LongCountAsync</span><span class="token punctuation">(</span><span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> predicate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token type-expression class-name">CancellationToken</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>TResult<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">MaxAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TResult<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> TResult<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> selector<span class="token punctuation">,</span> <span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> predicate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token type-expression class-name">CancellationToken</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>TResult<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">MinAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TResult<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> TResult<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> selector<span class="token punctuation">,</span> <span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> predicate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token type-expression class-name">CancellationToken</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">decimal</span><span class="token punctuation">&gt;</span></span> <span class="token function">AverageAsync</span><span class="token punctuation">(</span><span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> <span class="token keyword">decimal</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> selector<span class="token punctuation">,</span> <span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> predicate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token type-expression class-name">CancellationToken</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">decimal</span><span class="token punctuation">&gt;</span></span> <span class="token function">SumAsync</span><span class="token punctuation">(</span><span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> <span class="token keyword">decimal</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> selector<span class="token punctuation">,</span> <span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> predicate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token type-expression class-name">CancellationToken</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> <span class="token function">AddAsync</span><span class="token punctuation">(</span><span class="token class-name">T</span> entity<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token type-expression class-name">CancellationToken</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">Task</span> <span class="token function">AddRangeAsync</span><span class="token punctuation">(</span><span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> entities<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token type-expression class-name">CancellationToken</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span> <span class="token function">UpdateAsync</span><span class="token punctuation">(</span><span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> predicate<span class="token punctuation">,</span> <span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> T<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> expression<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token type-expression class-name">CancellationToken</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span> <span class="token function">RemoveAsync</span><span class="token punctuation">(</span><span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> predicate<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token type-expression class-name">CancellationToken</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>IList<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">FromSqlAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> sql<span class="token punctuation">,</span> <span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span><span class="token keyword">object</span><span class="token punctuation">&gt;</span></span> parameters <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token type-expression class-name">CancellationToken</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span> <span class="token function">ExecuteSqlCommandAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> sql<span class="token punctuation">,</span> <span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span><span class="token keyword">object</span><span class="token punctuation">&gt;</span></span> parameters <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token type-expression class-name">CancellationToken</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">Task</span> <span class="token function">ReloadAsync</span><span class="token punctuation">(</span><span class="token class-name">T</span> entity<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token type-expression class-name">CancellationToken</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-csharp"><span class="token comment">//泛型仓储的实现（列举一部分实现，感兴趣的可以自己查看源码）</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Repository<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IRepository<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">IRepository</span><span class="token punctuation">,</span> <span class="token class-name">IDisposable</span><span class="token punctuation">,</span> <span class="token class-name">ISyncRepository<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">ISyncRepository</span><span class="token punctuation">,</span> <span class="token class-name">IQueryFactory<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">IAsyncRepository<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">IAsyncRepository</span></span> <span class="token keyword">where</span> <span class="token class-name">T</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">bool</span></span> _disposed<span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token return-type class-name">DbContext</span> DbContext <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token return-type class-name">DbSet<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> DbSet <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">Repository</span><span class="token punctuation">(</span><span class="token class-name">DbContext</span> dbContext<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        DbContext <span class="token operator">=</span> dbContext <span class="token operator">??</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token string">"dbContext"</span><span class="token punctuation">,</span> <span class="token string">"dbContext cannot be null."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        DbSet <span class="token operator">=</span> dbContext<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Set</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">ISingleResultQuery<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> <span class="token function">SingleResultQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> EntityFrameworkCore<span class="token punctuation">.</span>QueryBuilder<span class="token punctuation">.</span>SingleResultQuery<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">IMultipleResultQuery<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> <span class="token function">MultipleResultQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> EntityFrameworkCore<span class="token punctuation">.</span>QueryBuilder<span class="token punctuation">.</span>MultipleResultQuery<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">ISingleResultQuery<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> TResult<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">SingleResultQuery</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TResult<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> SingleResultQuery<span class="token operator">&lt;</span>T<span class="token punctuation">,</span> TResult<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">IMultipleResultQuery<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> TResult<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">MultipleResultQuery</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TResult<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> MultipleResultQuery<span class="token operator">&lt;</span>T<span class="token punctuation">,</span> TResult<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">IList<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> <span class="token function">Search</span><span class="token punctuation">(</span><span class="token class-name">IQuery<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> query<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>query <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token string">"query"</span><span class="token punctuation">,</span> <span class="token string">"query cannot be null."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token function">ToQueryable</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">T</span> <span class="token function">Add</span><span class="token punctuation">(</span><span class="token class-name">T</span> entity<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>entity <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token string">"entity"</span><span class="token punctuation">,</span> <span class="token string">"entity cannot be null."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        DbSet<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> entity<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">AddRange</span><span class="token punctuation">(</span><span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> entities<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>entities <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token string">"entities"</span><span class="token punctuation">,</span> <span class="token string">"entities cannot be null."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>entities<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            DbSet<span class="token punctuation">.</span><span class="token function">AddRange</span><span class="token punctuation">(</span>entities<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">T</span> <span class="token function">Update</span><span class="token punctuation">(</span><span class="token class-name">T</span> entity<span class="token punctuation">,</span> <span class="token keyword">params</span> <span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> <span class="token keyword">object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> properties<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>entity <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token string">"entity"</span><span class="token punctuation">,</span> <span class="token string">"entity cannot be null."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>properties <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> properties<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">EntityEntry<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> entityEntry <span class="token operator">=</span> DbContext<span class="token punctuation">.</span><span class="token function">Entry</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> <span class="token keyword">object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> propertyExpression <span class="token keyword">in</span> properties<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">PropertyEntry</span> propertyEntry<span class="token punctuation">;</span>
                <span class="token keyword">try</span>
                <span class="token punctuation">{<!-- --></span>
                    propertyEntry <span class="token operator">=</span> entityEntry<span class="token punctuation">.</span><span class="token function">Property</span><span class="token punctuation">(</span>propertyExpression<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">catch</span>
                <span class="token punctuation">{<!-- --></span>
                    propertyEntry <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>propertyEntry <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    propertyEntry<span class="token punctuation">.</span>IsModified <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token class-name">ReferenceEntry</span> referenceEntry<span class="token punctuation">;</span>
                <span class="token keyword">try</span>
                <span class="token punctuation">{<!-- --></span>
                    referenceEntry <span class="token operator">=</span> entityEntry<span class="token punctuation">.</span><span class="token function">Reference</span><span class="token punctuation">(</span>propertyExpression<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">catch</span>
                <span class="token punctuation">{<!-- --></span>
                    referenceEntry <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>referenceEntry <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">EntityEntry</span> targetEntry <span class="token operator">=</span> referenceEntry<span class="token punctuation">.</span>TargetEntry<span class="token punctuation">;</span>
                    DbContext<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>targetEntry<span class="token punctuation">.</span>Entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            DbSet<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> entity<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">Update</span><span class="token punctuation">(</span><span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> predicate<span class="token punctuation">,</span> <span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> T<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> expression<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>predicate <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token string">"predicate"</span><span class="token punctuation">,</span> <span class="token string">"predicate cannot be null."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>expression <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token string">"expression"</span><span class="token punctuation">,</span> <span class="token string">"expression cannot be null."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> Queryable<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>DbSet<span class="token punctuation">,</span> predicate<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>expression<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">T</span> <span class="token function">Remove</span><span class="token punctuation">(</span><span class="token class-name">T</span> entity<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>entity <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token string">"entity"</span><span class="token punctuation">,</span> <span class="token string">"entity cannot be null."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        DbSet<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> entity<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">Remove</span><span class="token punctuation">(</span><span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> predicate<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>predicate <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token string">"predicate"</span><span class="token punctuation">,</span> <span class="token string">"predicate cannot be null."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> Queryable<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>DbSet<span class="token punctuation">,</span> predicate<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">RemoveRange</span><span class="token punctuation">(</span><span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> entities<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>entities <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token string">"entities"</span><span class="token punctuation">,</span> <span class="token string">"entities cannot be null."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>entities<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            DbSet<span class="token punctuation">.</span><span class="token function">RemoveRange</span><span class="token punctuation">(</span>entities<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_WebApiEntityFrameworkCoreDataRepository_356"></a>四、 在WebApi项目中使用EntityFrameworkCore.Data.Repository</h3> 
<ol><li>在appsettings.json中配置连接字符串</li></ol> 
<pre><code class="prism language-javascript"><span class="token comment">//配置连接字符串</span>
  <span class="token string-property property">"ConnectionStrings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"default"</span><span class="token operator">:</span> <span class="token string">"Server=localhost;Database=20240114WebApplication;user=root;password=12345;port=3306"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> 
<ol start="2"><li>在Program.cs中注册相关服务</li></ol> 
<pre><code class="prism language-csharp"><span class="token comment">//注册DbContext服务</span>
<span class="token class-name"><span class="token keyword">string</span></span> connectionString <span class="token operator">=</span> builder<span class="token punctuation">.</span>Configuration<span class="token punctuation">.</span><span class="token function">GetConnectionString</span><span class="token punctuation">(</span><span class="token string">"default"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddDbContext</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>MyDbContext<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>
    option <span class="token operator">=&gt;</span> option<span class="token punctuation">.</span><span class="token function">UseMySql</span><span class="token punctuation">(</span>connectionString<span class="token punctuation">,</span> ServerVersion<span class="token punctuation">.</span><span class="token function">AutoDetect</span><span class="token punctuation">(</span>connectionString<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddScoped</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>DbContext<span class="token punctuation">,</span> MyDbContext<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 注册工作单元</span>
builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddUnitOfWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//builder.Services.AddUnitOfWork&lt;MyDbContext&gt;(); // 多数据库支持</span>
<span class="token comment">//注册泛型仓储服务</span>
builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddScoped</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Repository<span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<ol start="3"><li>设计实体类，本例图书管理为例</li></ol> 
<pre><code class="prism language-csharp"> <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Book</span>
 <span class="token punctuation">{<!-- --></span>
     <span class="token keyword">public</span> <span class="token function">Book</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
     <span class="token punctuation">{<!-- --></span>
         Title <span class="token operator">=</span> <span class="token keyword">string</span><span class="token punctuation">.</span>Empty<span class="token punctuation">;</span>
         ISBN <span class="token operator">=</span> <span class="token keyword">string</span><span class="token punctuation">.</span>Empty<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>

     <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Key</span></span><span class="token punctuation">]</span>
     <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">long</span></span> Id <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

     <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Required</span></span><span class="token punctuation">]</span>
     <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">MaxLength</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
     <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Title <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

     <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Required</span></span><span class="token punctuation">]</span>
     <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">MaxLength</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
     <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> ISBN <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

     <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">long</span></span> CategoryId <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

     <span class="token comment">//导航属性</span>
     <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ForeignKey</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"CategoryId"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
     <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">Category</span> Category <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Category</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token function">Category</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        Name <span class="token operator">=</span> <span class="token keyword">string</span><span class="token punctuation">.</span>Empty<span class="token punctuation">;</span>
        Code <span class="token operator">=</span> <span class="token keyword">string</span><span class="token punctuation">.</span>Empty<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Key</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">long</span></span> Id <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 分类代码</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token punctuation">[</span>Required<span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">MaxLength</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Code <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 分类名</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token punctuation">[</span>Required<span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">MaxLength</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token comment">//导航属性</span>
    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">IList<span class="token punctuation">&lt;</span>Book<span class="token punctuation">&gt;</span></span> Books <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="4"><li>实现图书管理API接口</li></ol> 
<p>（1）依赖注入泛型仓储和工作单元对象：</p> 
<pre><code class="prism language-csharp"><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"api/[controller]"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ApiController</span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BooksController</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ControllerBase</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//泛型仓储</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">Repository<span class="token punctuation">&lt;</span>Book<span class="token punctuation">&gt;</span></span> _bookRepository<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">Repository<span class="token punctuation">&lt;</span>Category<span class="token punctuation">&gt;</span></span> _categoryRepository<span class="token punctuation">;</span>
    <span class="token comment">//工作单元</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IUnitOfWork</span> _unitOfWork<span class="token punctuation">;</span>

    <span class="token comment">//构造方法</span>
    <span class="token keyword">public</span> <span class="token function">BooksController</span><span class="token punctuation">(</span><span class="token class-name">Repository<span class="token punctuation">&lt;</span>Book<span class="token punctuation">&gt;</span></span> bookRepository<span class="token punctuation">,</span>
                           <span class="token class-name">Repository<span class="token punctuation">&lt;</span>Category<span class="token punctuation">&gt;</span></span> categoryRepository<span class="token punctuation">,</span>
                           <span class="token class-name">IUnitOfWork</span> unitOfWork<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        _bookRepository <span class="token operator">=</span> bookRepository<span class="token punctuation">;</span>
        _categoryRepository <span class="token operator">=</span> categoryRepository<span class="token punctuation">;</span>
        _unitOfWork <span class="token operator">=</span> unitOfWork<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>（2）实现分页显示：</p> 
<pre><code class="prism language-csharp">  <span class="token comment">//分页查询（使用Include加载导航属性)</span>
  <span class="token punctuation">[</span><span class="token function">HttpGet</span><span class="token punctuation">(</span><span class="token string">"GetPageList"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>ActionResult<span class="token punctuation">&lt;</span>IPagedList<span class="token punctuation">&lt;</span>BookOutput<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetPageList</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">FromQuery</span></span><span class="token punctuation">]</span> <span class="token class-name">BookPageRequestInput</span> input<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//创建查询对象-MultipleResultQuery表示多结果集查询</span>
      <span class="token class-name"><span class="token keyword">var</span></span> query <span class="token operator">=</span> _bookRepository<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">MultipleResultQuery</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>BookOutput<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">Page</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>PageIndex<span class="token punctuation">,</span> input<span class="token punctuation">.</span>PageSize<span class="token punctuation">)</span> <span class="token comment">//分页</span>
                        <span class="token punctuation">.</span><span class="token function">AndFilter</span><span class="token punctuation">(</span>b <span class="token operator">=&gt;</span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrEmpty</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>Title<span class="token punctuation">)</span> <span class="token operator">||</span> b<span class="token punctuation">.</span>Title<span class="token punctuation">.</span><span class="token function">StartsWith</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>Title<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//筛选条件</span>
                        <span class="token punctuation">.</span><span class="token function">Include</span><span class="token punctuation">(</span>q <span class="token operator">=&gt;</span> q<span class="token punctuation">.</span><span class="token function">Include</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>Category<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//级联加载</span>
                        <span class="token punctuation">.</span><span class="token function">OrderByDescending</span><span class="token punctuation">(</span><span class="token string">"Title"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ThenBy</span><span class="token punctuation">(</span><span class="token string">"ISBN"</span><span class="token punctuation">)</span> <span class="token comment">//排序</span>
                        <span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>b <span class="token operator">=&gt;</span> <span class="token keyword">new</span> BookOutput                <span class="token comment">//投影</span>
                        <span class="token punctuation">{<!-- --></span>
                            CategoryId <span class="token operator">=</span> b<span class="token punctuation">.</span>CategoryId<span class="token punctuation">,</span>
                            CategoryCode <span class="token operator">=</span> b<span class="token punctuation">.</span>Category<span class="token punctuation">.</span>Code<span class="token punctuation">,</span>
                            CategoryName <span class="token operator">=</span> b<span class="token punctuation">.</span>Category<span class="token punctuation">.</span>Name<span class="token punctuation">,</span>
                            ISBN <span class="token operator">=</span> b<span class="token punctuation">.</span>ISBN<span class="token punctuation">,</span>
                            Title <span class="token operator">=</span> b<span class="token punctuation">.</span>Title<span class="token punctuation">,</span>
                            Id <span class="token operator">=</span> b<span class="token punctuation">.</span>Id
                        <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token class-name">IMultipleResultQuery<span class="token punctuation">&lt;</span>Book<span class="token punctuation">,</span> BookOutput<span class="token punctuation">&gt;</span></span><span class="token punctuation">;</span> <span class="token comment">//转换类型</span>

      <span class="token comment">//执行查询</span>
      <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">await</span> _bookRepository<span class="token punctuation">.</span><span class="token function">SearchAsync</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">)</span>
                           <span class="token punctuation">.</span><span class="token function">ToPagedList</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span>Paging<span class="token punctuation">.</span>PageIndex<span class="token punctuation">,</span>
                                      query<span class="token punctuation">.</span>Paging<span class="token punctuation">.</span>PageSize<span class="token punctuation">,</span>
                                      query<span class="token punctuation">.</span>Paging<span class="token punctuation">.</span>TotalCount<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token function">Ok</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-csharp">  <span class="token comment">//分页查询（使用IQueryable.Join方法进行联表查询)</span>
  <span class="token punctuation">[</span><span class="token function">HttpGet</span><span class="token punctuation">(</span><span class="token string">"GetBookPage"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>ActionResult<span class="token punctuation">&lt;</span>PagedList<span class="token punctuation">&lt;</span>BookOutput<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetBookPage</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">FromQuery</span></span><span class="token punctuation">]</span> <span class="token class-name">BookPageRequestInput</span> input<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//获取可IQueryable可查询对象</span>
      <span class="token class-name"><span class="token keyword">var</span></span> books <span class="token operator">=</span> _bookRepository<span class="token punctuation">.</span><span class="token function">ToQueryable</span><span class="token punctuation">(</span>_bookRepository<span class="token punctuation">.</span><span class="token function">MultipleResultQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name"><span class="token keyword">var</span></span> categories <span class="token operator">=</span> _categoryRepository<span class="token punctuation">.</span><span class="token function">ToQueryable</span><span class="token punctuation">(</span>_categoryRepository<span class="token punctuation">.</span><span class="token function">MultipleResultQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token class-name"><span class="token keyword">var</span></span> query <span class="token operator">=</span> books<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>categories<span class="token punctuation">,</span> b <span class="token operator">=&gt;</span> b<span class="token punctuation">.</span>CategoryId<span class="token punctuation">,</span> c <span class="token operator">=&gt;</span> c<span class="token punctuation">.</span>Id<span class="token punctuation">,</span>
                     <span class="token punctuation">(</span>b<span class="token punctuation">,</span> c<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">BookOutput</span>
                     <span class="token punctuation">{<!-- --></span>
                         CategoryId <span class="token operator">=</span> b<span class="token punctuation">.</span>CategoryId<span class="token punctuation">,</span>
                         CategoryCode <span class="token operator">=</span> b<span class="token punctuation">.</span>Category<span class="token punctuation">.</span>Code<span class="token punctuation">,</span>
                         CategoryName <span class="token operator">=</span> b<span class="token punctuation">.</span>Category<span class="token punctuation">.</span>Name<span class="token punctuation">,</span>
                         ISBN <span class="token operator">=</span> b<span class="token punctuation">.</span>ISBN<span class="token punctuation">,</span>
                         Title <span class="token operator">=</span> b<span class="token punctuation">.</span>Title<span class="token punctuation">,</span>
                         Id <span class="token operator">=</span> b<span class="token punctuation">.</span>Id
                     <span class="token punctuation">}</span><span class="token punctuation">)</span>
                     <span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>b <span class="token operator">=&gt;</span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrEmpty</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>Title<span class="token punctuation">)</span> <span class="token operator">||</span> b<span class="token punctuation">.</span>Title<span class="token punctuation">.</span><span class="token function">StartsWith</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>Title<span class="token punctuation">)</span><span class="token punctuation">)</span>
                     <span class="token punctuation">.</span><span class="token function">OrderBy</span><span class="token punctuation">(</span>b <span class="token operator">=&gt;</span> b<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token class-name">PagedList<span class="token punctuation">&lt;</span>BookOutput<span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">PagedList<span class="token punctuation">&lt;</span>BookOutput<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      result<span class="token punctuation">.</span>TotalCount <span class="token operator">=</span> <span class="token keyword">await</span> query<span class="token punctuation">.</span><span class="token function">CountAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      result<span class="token punctuation">.</span>Items <span class="token operator">=</span> <span class="token keyword">await</span> query<span class="token punctuation">.</span><span class="token function">Skip</span><span class="token punctuation">(</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>PageIndex <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> input<span class="token punctuation">.</span>PageSize<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Take</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>PageSize<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToListAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>（3）添加图书：</p> 
<pre><code class="prism language-csharp">  <span class="token comment">//POST api/Books</span>
  <span class="token punctuation">[</span>HttpPost<span class="token punctuation">]</span>
  <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>ActionResult<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">Add</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">FromBody</span></span><span class="token punctuation">]</span> <span class="token class-name">BookAddOrUpdateInput</span> input<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
      <span class="token class-name">Book</span> book <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Book</span>
      <span class="token punctuation">{<!-- --></span>
          CategoryId <span class="token operator">=</span> input<span class="token punctuation">.</span>CategoryId<span class="token punctuation">,</span>
          ISBN <span class="token operator">=</span> input<span class="token punctuation">.</span>ISBN<span class="token punctuation">,</span>
          Title <span class="token operator">=</span> input<span class="token punctuation">.</span>Title
      <span class="token punctuation">}</span><span class="token punctuation">;</span>

      <span class="token keyword">await</span> _bookRepository<span class="token punctuation">.</span><span class="token function">AddAsync</span><span class="token punctuation">(</span>book<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">await</span> _unitOfWork<span class="token punctuation">.</span><span class="token function">SaveChangesAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>（4）修改图书：</p> 
<pre><code class="prism language-csharp">   <span class="token comment">//PUT api/Books</span>
   <span class="token punctuation">[</span>HttpPut<span class="token punctuation">]</span>
   <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>ActionResult<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">Update</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">FromBody</span></span><span class="token punctuation">]</span> <span class="token class-name">BookAddOrUpdateInput</span> input<span class="token punctuation">)</span>
   <span class="token punctuation">{<!-- --></span>
       <span class="token class-name"><span class="token keyword">var</span></span> numAffected <span class="token operator">=</span> <span class="token keyword">await</span> _bookRepository<span class="token punctuation">.</span><span class="token function">UpdateAsync</span><span class="token punctuation">(</span>b <span class="token operator">=&gt;</span> b<span class="token punctuation">.</span>Id <span class="token operator">==</span> input<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> b <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Book</span>
       <span class="token punctuation">{<!-- --></span>
           CategoryId <span class="token operator">=</span> input<span class="token punctuation">.</span>CategoryId<span class="token punctuation">,</span>
           ISBN <span class="token operator">=</span> input<span class="token punctuation">.</span>ISBN<span class="token punctuation">,</span>
           Title <span class="token operator">=</span> input<span class="token punctuation">.</span>Title
       <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">await</span> _unitOfWork<span class="token punctuation">.</span><span class="token function">SaveChangesAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token keyword">return</span> result<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
</code></pre> 
<p>（5）删除图书：</p> 
<pre><code class="prism language-csharp">   <span class="token comment">//DELETE api/Books/{id}</span>
   <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpDelete</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"{id}"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
   <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>ActionResult<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">Delete</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">long</span></span> id<span class="token punctuation">)</span>
   <span class="token punctuation">{<!-- --></span>
       <span class="token class-name"><span class="token keyword">var</span></span> numAffected <span class="token operator">=</span> <span class="token keyword">await</span> _bookRepository<span class="token punctuation">.</span><span class="token function">RemoveAsync</span><span class="token punctuation">(</span>b <span class="token operator">=&gt;</span> b<span class="token punctuation">.</span>Id <span class="token operator">==</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">await</span> _unitOfWork<span class="token punctuation">.</span><span class="token function">SaveChangesAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token keyword">return</span> result<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
</code></pre> 
<p>（6）根据ID获取图书：</p> 
<pre><code class="prism language-csharp">  <span class="token comment">//GET api/Books/{id}</span>
  <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpGet</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"{id}"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
  <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>ActionResult<span class="token punctuation">&lt;</span>BookOutput<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">Get</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">long</span></span> id<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//创建查询对象，SingleResultQuery表示单条结果查询</span>
      <span class="token class-name"><span class="token keyword">var</span></span> query <span class="token operator">=</span> _bookRepository<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">SingleResultQuery</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>BookOutput<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">Include</span><span class="token punctuation">(</span>q <span class="token operator">=&gt;</span> q<span class="token punctuation">.</span><span class="token function">Include</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>Category<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">AndFilter</span><span class="token punctuation">(</span>b <span class="token operator">=&gt;</span> b<span class="token punctuation">.</span>Id <span class="token operator">==</span> id<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>b <span class="token operator">=&gt;</span> <span class="token keyword">new</span> BookOutput  <span class="token comment">//投影</span>
                        <span class="token punctuation">{<!-- --></span>
                            CategoryId <span class="token operator">=</span> b<span class="token punctuation">.</span>CategoryId<span class="token punctuation">,</span>
                            CategoryCode <span class="token operator">=</span> b<span class="token punctuation">.</span>Category<span class="token punctuation">.</span>Code<span class="token punctuation">,</span>
                            CategoryName <span class="token operator">=</span> b<span class="token punctuation">.</span>Category<span class="token punctuation">.</span>Name<span class="token punctuation">,</span>
                            ISBN <span class="token operator">=</span> b<span class="token punctuation">.</span>ISBN<span class="token punctuation">,</span>
                            Title <span class="token operator">=</span> b<span class="token punctuation">.</span>Title<span class="token punctuation">,</span>
                            Id <span class="token operator">=</span> b<span class="token punctuation">.</span>Id
                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token keyword">await</span> _bookRepository<span class="token punctuation">.</span><span class="token function">SingleOrDefaultAsync</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<hr> 
<p>本次演示了在ASP.NET Core中使用泛型仓储模式封装EF Core的CRUD方法，推荐大家可以尝试一下EntityFrameworkCore.Data.Repository这个开源仓储实现类。如果本文对你有帮助的话，请点赞+评论+关注，或者转发给需要的朋友。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0653f86250c296bdd87d18286cefd0cb/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">JVM问题分析处理手册</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4682e32e6509a512b1cf647fae417728/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">第五章 漏洞评估 - 《骇客修成秘籍》</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>