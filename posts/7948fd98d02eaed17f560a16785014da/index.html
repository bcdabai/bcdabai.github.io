<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>React16源码: React中的updateClassComponent的源码实现 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="React16源码: React中的updateClassComponent的源码实现" />
<meta property="og:description" content="ClassComponent 的更新 1 ） 概述
在 react 中 class component，是一个非常重要的角色它承担了 react 中 更新整个应用的API setStateforceUpdate 在react当中，只有更新了state之后，整个应用才会重新进行渲染在 class component 中, 它的逻辑相对复杂 2 ）源码
在 packages/react-reconciler/src/ReactFiberBeginWork.js
// 这个方法就是更新 ClassComponent 组件的一个过程 function updateClassComponent( current: Fiber | null, workInProgress: Fiber, Component: any, nextProps, renderExpirationTime: ExpirationTime, ) { // Push context providers early to prevent context stack mismatches. // During mounting we don&#39;t know the child context yet as the instance doesn&#39;t exist. // We will invalidate the child context in finishClassComponent() right after rendering." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/7948fd98d02eaed17f560a16785014da/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-20T16:23:37+08:00" />
<meta property="article:modified_time" content="2024-01-20T16:23:37+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">React16源码: React中的updateClassComponent的源码实现</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h4><a id="ClassComponent__0"></a>ClassComponent 的更新</h4> 
<br> 
<p>1 ） 概述</p> 
<ul><li>在 react 中 class component，是一个非常重要的角色</li><li>它承担了 react 中 更新整个应用的API 
  <ul><li><code>setState</code></li><li><code>forceUpdate</code></li></ul> </li><li>在react当中，只有更新了state之后，整个应用才会重新进行渲染</li><li>在 class component 中, 它的逻辑相对复杂</li></ul> 
<p>2 ）源码</p> 
<p>在 <a href="https://github.com/facebook/react/blob/v16.6.3/packages/react-reconciler/src/ReactFiberBeginWork.js#L428">packages/react-reconciler/src/ReactFiberBeginWork.js</a></p> 
<pre><code class="prism language-js"><span class="token comment">// 这个方法就是更新 ClassComponent 组件的一个过程</span>
<span class="token keyword">function</span> <span class="token function">updateClassComponent</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">current</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">workInProgress</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  <span class="token literal-property property">Component</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
  nextProps<span class="token punctuation">,</span>
  <span class="token literal-property property">renderExpirationTime</span><span class="token operator">:</span> ExpirationTime<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// Push context providers early to prevent context stack mismatches.</span>
  <span class="token comment">// During mounting we don't know the child context yet as the instance doesn't exist.</span>
  <span class="token comment">// We will invalidate the child context in finishClassComponent() right after rendering.</span>
  <span class="token comment">// 先跳过 context 相关的逻辑</span>
  <span class="token keyword">let</span> hasContext<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isLegacyContextProvider</span><span class="token punctuation">(</span>Component<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    hasContext <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token function">pushLegacyContextProvider</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    hasContext <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">prepareToReadContext</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// instance 就是我们 class component，通过new这个class获取的一个对象</span>
  <span class="token keyword">const</span> instance <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
  <span class="token comment">// 在这里面，它声明了一个 shouldUpdate 的一个属性</span>
  <span class="token keyword">let</span> shouldUpdate<span class="token punctuation">;</span> 
  <span class="token comment">// 先判断instance是否存在, 比如说我们第一次通过 ReactDOM.render 进行渲染的过程当中</span>
  <span class="token comment">// 在从上往下第一次渲染的过程当中，第一次更新到 class component 的时候</span>
  <span class="token comment">// 它的instance肯定是不存在的，因为它还没有被更新过，所以它的节点肯定是没有被创建的</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 接下去, 判断一下current是否等于null</span>
    <span class="token comment">// current等于null的情况是代表在进入第一次渲染，因为current它还不存在</span>
    <span class="token comment">// 如果current不等于null, 代表我们至少已经经历过一次渲染了</span>
    <span class="token comment">// 这时候 instance 不存在，而 current 存在，说明第一次渲染的时候没有创建这个instance</span>
    <span class="token comment">// 同样说明这个组件是被 suspended 的，一个组件处于suspended的状态</span>
    <span class="token comment">// 在这里react认为它相当于是第一次被渲染, 在初次渲染的时候，只是抛出了一个promise</span>
    <span class="token comment">// 并没有真正的渲染出它的子节点, 抛出了一个promise之后，接下去的渲染就结束了</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// An class component without an instance only mounts if it suspended</span>
      <span class="token comment">// inside a non- concurrent tree, in an inconsistent state. We want to</span>
      <span class="token comment">// tree it like a new mount, even though an empty version of it already</span>
      <span class="token comment">// committed. Disconnect the alternate pointers.</span>
      current<span class="token punctuation">.</span>alternate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      workInProgress<span class="token punctuation">.</span>alternate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token comment">// Since this is conceptually a new fiber, schedule a Placement effect</span>
      workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">|=</span> Placement<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// In the initial pass we might need to construct the instance.</span>
    <span class="token comment">// 对于没有instance的一个情况，需要去创建 class instance</span>
    <span class="token function">constructClassInstance</span><span class="token punctuation">(</span>
      workInProgress<span class="token punctuation">,</span>
      Component<span class="token punctuation">,</span>
      nextProps<span class="token punctuation">,</span>
      renderExpirationTime<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 并且要mount这个 class instance</span>
    <span class="token function">mountClassInstance</span><span class="token punctuation">(</span>
      workInProgress<span class="token punctuation">,</span>
      Component<span class="token punctuation">,</span>
      nextProps<span class="token punctuation">,</span>
      renderExpirationTime<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 在第一次渲染的时候，会执行上述两个方法，并且 shouldUpdate = true;</span>
    shouldUpdate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// In a resume, we'll already have an instance we can reuse.</span>
    <span class="token comment">// 在 有instance 和 没有 current 的情况下，这种是之前被中断的</span>
    <span class="token comment">// 在执行 class component 的 render 方法的时候 报错，但 instance 已被创建</span>
    <span class="token comment">// 代表着可以复用 instance</span>
    shouldUpdate <span class="token operator">=</span> <span class="token function">resumeMountClassInstance</span><span class="token punctuation">(</span>
      workInProgress<span class="token punctuation">,</span>
      Component<span class="token punctuation">,</span>
      nextProps<span class="token punctuation">,</span>
      renderExpirationTime<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 对于又有 current 又有 instance的情况，说明组件已经被重新渲染了</span>
    <span class="token comment">// 这个 updateClassInstance 方法和 上述 resumeMountClassInstance 类似</span>
    <span class="token comment">// 最大的区别是 内部判断 comonentDidUpdate </span>
    shouldUpdate <span class="token operator">=</span> <span class="token function">updateClassInstance</span><span class="token punctuation">(</span>
      current<span class="token punctuation">,</span>
      workInProgress<span class="token punctuation">,</span>
      Component<span class="token punctuation">,</span>
      nextProps<span class="token punctuation">,</span>
      renderExpirationTime<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 这里最终调用 finishClassComponent</span>
  <span class="token keyword">return</span> <span class="token function">finishClassComponent</span><span class="token punctuation">(</span>
    current<span class="token punctuation">,</span>
    workInProgress<span class="token punctuation">,</span>
    Component<span class="token punctuation">,</span>
    shouldUpdate<span class="token punctuation">,</span>
    hasContext<span class="token punctuation">,</span>
    renderExpirationTime<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li> <p>进入 <code>constructClassInstance</code></p> <pre><code class="prism language-js"><span class="token keyword">function</span> <span class="token function">constructClassInstance</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">workInProgress</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  <span class="token literal-property property">ctor</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
  <span class="token literal-property property">props</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
  <span class="token literal-property property">renderExpirationTime</span><span class="token operator">:</span> ExpirationTime<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> any <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 先跳过 context 相关</span>
  <span class="token keyword">let</span> isLegacyContextConsumer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> unmaskedContext <span class="token operator">=</span> emptyContextObject<span class="token punctuation">;</span>
  <span class="token keyword">let</span> context <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> contextType <span class="token operator">=</span> ctor<span class="token punctuation">.</span>contextType<span class="token punctuation">;</span>
  <span class="token comment">// </span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> contextType <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> contextType <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 跳过 DEV</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        contextType<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">!==</span> <span class="token constant">REACT_CONTEXT_TYPE</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span>didWarnAboutInvalidateContextType<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>ctor<span class="token punctuation">)</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        didWarnAboutInvalidateContextType<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ctor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">warningWithoutStack</span><span class="token punctuation">(</span>
          <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token string">'%s defines an invalid contextType. '</span> <span class="token operator">+</span>
            <span class="token string">'contextType should point to the Context object returned by React.createContext(). '</span> <span class="token operator">+</span>
            <span class="token string">'Did you accidentally pass the Context.Provider instead?'</span><span class="token punctuation">,</span>
          <span class="token function">getComponentName</span><span class="token punctuation">(</span>ctor<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'Component'</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    context <span class="token operator">=</span> <span class="token function">readContext</span><span class="token punctuation">(</span><span class="token punctuation">(</span>contextType<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    unmaskedContext <span class="token operator">=</span> <span class="token function">getUnmaskedContext</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> ctor<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> contextTypes <span class="token operator">=</span> ctor<span class="token punctuation">.</span>contextTypes<span class="token punctuation">;</span>
    isLegacyContextConsumer <span class="token operator">=</span>
      contextTypes <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> contextTypes <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    context <span class="token operator">=</span> isLegacyContextConsumer
      <span class="token operator">?</span> <span class="token function">getMaskedContext</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> unmaskedContext<span class="token punctuation">)</span>
      <span class="token operator">:</span> emptyContextObject<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Instantiate twice to help detect side-effects.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      debugRenderPhaseSideEffects <span class="token operator">||</span>
      <span class="token punctuation">(</span>debugRenderPhaseSideEffectsForStrictMode <span class="token operator">&amp;&amp;</span>
        workInProgress<span class="token punctuation">.</span>mode <span class="token operator">&amp;</span> StrictMode<span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">new</span> <span class="token class-name">ctor</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// eslint-disable-line no-new</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ctor 是 construct 的一个缩写 这个 ctor 就是在 ReactElement当中</span>
  <span class="token comment">// 存在的那个type，也就是 class component 定义的那个class</span>
  <span class="token comment">// 传入 props和context，对应于 ReactBaseClasses.js 里面，Component 函数 接收的这两个参数</span>
  <span class="token comment">// 第三个参数 updater 后面在 adoptClassInstance 里面设置</span>
  <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ctor</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 获取 state</span>
  <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span>
    instance<span class="token punctuation">.</span>state <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> instance<span class="token punctuation">.</span>state <span class="token operator">!==</span> <span class="token keyword">undefined</span>
      <span class="token operator">?</span> instance<span class="token punctuation">.</span>state
      <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">adoptClassInstance</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> ctor<span class="token punctuation">.</span>getDerivedStateFromProps <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> state <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> componentName <span class="token operator">=</span> <span class="token function">getComponentName</span><span class="token punctuation">(</span>ctor<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'Component'</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>didWarnAboutUninitializedState<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>componentName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        didWarnAboutUninitializedState<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>componentName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">warningWithoutStack</span><span class="token punctuation">(</span>
          <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token string">'`%s` uses `getDerivedStateFromProps` but its initial state is '</span> <span class="token operator">+</span>
            <span class="token string">'%s. This is not recommended. Instead, define the initial state by '</span> <span class="token operator">+</span>
            <span class="token string">'assigning an object to `this.state` in the constructor of `%s`. '</span> <span class="token operator">+</span>
            <span class="token string">'This ensures that `getDerivedStateFromProps` arguments have a consistent shape.'</span><span class="token punctuation">,</span>
          componentName<span class="token punctuation">,</span>
          instance<span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">'null'</span> <span class="token operator">:</span> <span class="token string">'undefined'</span><span class="token punctuation">,</span>
          componentName<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// If new component APIs are defined, "unsafe" lifecycles won't be called.</span>
    <span class="token comment">// Warn about these lifecycles if they are present.</span>
    <span class="token comment">// Don't warn about react-lifecycles-compat polyfilled methods though.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token keyword">typeof</span> ctor<span class="token punctuation">.</span>getDerivedStateFromProps <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">||</span>
      <span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>getSnapshotBeforeUpdate <span class="token operator">===</span> <span class="token string">'function'</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">let</span> foundWillMountName <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> foundWillReceivePropsName <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> foundWillUpdateName <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>componentWillMount <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span>
        instance<span class="token punctuation">.</span>componentWillMount<span class="token punctuation">.</span>__suppressDeprecationWarning <span class="token operator">!==</span> <span class="token boolean">true</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        foundWillMountName <span class="token operator">=</span> <span class="token string">'componentWillMount'</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>UNSAFE_componentWillMount <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        foundWillMountName <span class="token operator">=</span> <span class="token string">'UNSAFE_componentWillMount'</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>componentWillReceiveProps <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span>
        instance<span class="token punctuation">.</span>componentWillReceiveProps<span class="token punctuation">.</span>__suppressDeprecationWarning <span class="token operator">!==</span> <span class="token boolean">true</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        foundWillReceivePropsName <span class="token operator">=</span> <span class="token string">'componentWillReceiveProps'</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>UNSAFE_componentWillReceiveProps <span class="token operator">===</span> <span class="token string">'function'</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        foundWillReceivePropsName <span class="token operator">=</span> <span class="token string">'UNSAFE_componentWillReceiveProps'</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>componentWillUpdate <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span>
        instance<span class="token punctuation">.</span>componentWillUpdate<span class="token punctuation">.</span>__suppressDeprecationWarning <span class="token operator">!==</span> <span class="token boolean">true</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        foundWillUpdateName <span class="token operator">=</span> <span class="token string">'componentWillUpdate'</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>UNSAFE_componentWillUpdate <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        foundWillUpdateName <span class="token operator">=</span> <span class="token string">'UNSAFE_componentWillUpdate'</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        foundWillMountName <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">||</span>
        foundWillReceivePropsName <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">||</span>
        foundWillUpdateName <span class="token operator">!==</span> <span class="token keyword">null</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">const</span> componentName <span class="token operator">=</span> <span class="token function">getComponentName</span><span class="token punctuation">(</span>ctor<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'Component'</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> newApiName <span class="token operator">=</span>
          <span class="token keyword">typeof</span> ctor<span class="token punctuation">.</span>getDerivedStateFromProps <span class="token operator">===</span> <span class="token string">'function'</span>
            <span class="token operator">?</span> <span class="token string">'getDerivedStateFromProps()'</span>
            <span class="token operator">:</span> <span class="token string">'getSnapshotBeforeUpdate()'</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>didWarnAboutLegacyLifecyclesAndDerivedState<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>componentName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          didWarnAboutLegacyLifecyclesAndDerivedState<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>componentName<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">warningWithoutStack</span><span class="token punctuation">(</span>
            <span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token string">'Unsafe legacy lifecycles will not be called for components using new component APIs.\n\n'</span> <span class="token operator">+</span>
              <span class="token string">'%s uses %s but also contains the following legacy lifecycles:%s%s%s\n\n'</span> <span class="token operator">+</span>
              <span class="token string">'The above lifecycles should be removed. Learn more about this warning here:\n'</span> <span class="token operator">+</span>
              <span class="token string">'https://fb.me/react-async-component-lifecycle-hooks'</span><span class="token punctuation">,</span>
            componentName<span class="token punctuation">,</span>
            newApiName<span class="token punctuation">,</span>
            foundWillMountName <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\n  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>foundWillMountName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
            foundWillReceivePropsName <span class="token operator">!==</span> <span class="token keyword">null</span>
              <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\n  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>foundWillReceivePropsName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
              <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
            foundWillUpdateName <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\n  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>foundWillUpdateName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Cache unmasked context so we can avoid recreating masked context unless necessary.</span>
  <span class="token comment">// ReactFiberContext usually updates this cache but can't for newly-created instances.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isLegacyContextConsumer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">cacheContext</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> unmaskedContext<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
  <ul><li>进入 <code>adoptClassInstance</code><pre><code class="prism language-js"><span class="token keyword">function</span> <span class="token function">adoptClassInstance</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">workInProgress</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span> <span class="token literal-property property">instance</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{<!-- --></span>
  instance<span class="token punctuation">.</span>updater <span class="token operator">=</span> classComponentUpdater<span class="token punctuation">;</span> <span class="token comment">// 挂载 update 方法</span>
  workInProgress<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> instance<span class="token punctuation">;</span> <span class="token comment">// instance 挂载到 stateNode 以供下次进来时使用，下次进来就会存在了</span>
  <span class="token comment">// The instance needs access to the fiber so that it can schedule updates</span>
  ReactInstanceMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    instance<span class="token punctuation">.</span>_reactInternalInstance <span class="token operator">=</span> fakeInternalInstance<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li><li>进入 <code>ReactInstanceMap</code> 这个就是对 instance 上 <code>_reactInternalFiber</code> 属性的设置<pre><code class="prism language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  key<span class="token punctuation">.</span>_reactInternalFiber <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> key<span class="token punctuation">.</span>_reactInternalFiber<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">has</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> key<span class="token punctuation">.</span>_reactInternalFiber <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  key<span class="token punctuation">.</span>_reactInternalFiber <span class="token operator">=</span> value<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
    <ul><li>这也意味着，通过 <code>this._reactInternalFiber</code> 就可以拿到当前 fiber 对象</li></ul> </li></ul> </li><li> <p>进入 <code>mountClassInstance</code></p> <pre><code class="prism language-js"><span class="token comment">// Invokes the mount life-cycles on a previously never rendered instance.</span>
<span class="token keyword">function</span> <span class="token function">mountClassInstance</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">workInProgress</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  <span class="token literal-property property">ctor</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
  <span class="token literal-property property">newProps</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
  <span class="token literal-property property">renderExpirationTime</span><span class="token operator">:</span> ExpirationTime<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">checkClassInstance</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> ctor<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">const</span> instance <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
  instance<span class="token punctuation">.</span>props <span class="token operator">=</span> newProps<span class="token punctuation">;</span>
  instance<span class="token punctuation">.</span>state <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
  instance<span class="token punctuation">.</span>refs <span class="token operator">=</span> emptyRefsObject<span class="token punctuation">;</span>

  <span class="token keyword">const</span> contextType <span class="token operator">=</span> ctor<span class="token punctuation">.</span>contextType<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> contextType <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> contextType <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    instance<span class="token punctuation">.</span>context <span class="token operator">=</span> <span class="token function">readContext</span><span class="token punctuation">(</span>contextType<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> unmaskedContext <span class="token operator">=</span> <span class="token function">getUnmaskedContext</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> ctor<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    instance<span class="token punctuation">.</span>context <span class="token operator">=</span> <span class="token function">getMaskedContext</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> unmaskedContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>instance<span class="token punctuation">.</span>state <span class="token operator">===</span> newProps<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> componentName <span class="token operator">=</span> <span class="token function">getComponentName</span><span class="token punctuation">(</span>ctor<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'Component'</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>didWarnAboutDirectlyAssigningPropsToState<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>componentName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        didWarnAboutDirectlyAssigningPropsToState<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>componentName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">warningWithoutStack</span><span class="token punctuation">(</span>
          <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token string">'%s: It is not recommended to assign props directly to state '</span> <span class="token operator">+</span>
            <span class="token string">"because updates to props won't be reflected in state. "</span> <span class="token operator">+</span>
            <span class="token string">'In most cases, it is better to use props directly.'</span><span class="token punctuation">,</span>
          componentName<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>mode <span class="token operator">&amp;</span> StrictMode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      ReactStrictModeWarnings<span class="token punctuation">.</span><span class="token function">recordUnsafeLifecycleWarnings</span><span class="token punctuation">(</span>
        workInProgress<span class="token punctuation">,</span>
        instance<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      ReactStrictModeWarnings<span class="token punctuation">.</span><span class="token function">recordLegacyContextWarning</span><span class="token punctuation">(</span>
        workInProgress<span class="token punctuation">,</span>
        instance<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>warnAboutDeprecatedLifecycles<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      ReactStrictModeWarnings<span class="token punctuation">.</span><span class="token function">recordDeprecationWarnings</span><span class="token punctuation">(</span>
        workInProgress<span class="token punctuation">,</span>
        instance<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 获取 updateQueue，初次渲染这个 updateQueue 是空的</span>
  <span class="token comment">// 对于有 setState 的情况，它的 updateQueen 里面可能有多个update</span>
  <span class="token comment">// 这个时候, 需要调用这个 updateQueen 来去得到一个新的state</span>
  <span class="token keyword">let</span> updateQueue <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>updateQueue<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>updateQueue <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 这里 计算出新的state 并赋值给 workInProgress.memoizedState</span>
    <span class="token function">processUpdateQueue</span><span class="token punctuation">(</span>
      workInProgress<span class="token punctuation">,</span>
      updateQueue<span class="token punctuation">,</span>
      newProps<span class="token punctuation">,</span>
      instance<span class="token punctuation">,</span>
      renderExpirationTime<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 同时更新 instance.state</span>
    instance<span class="token punctuation">.</span>state <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// 判断是否有这个生命周期方法</span>
  <span class="token keyword">const</span> getDerivedStateFromProps <span class="token operator">=</span> ctor<span class="token punctuation">.</span>getDerivedStateFromProps<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> getDerivedStateFromProps <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 如果存在该生命周期方法，则计算新的state</span>
    <span class="token comment">// 这个生命周期会在组件更新的过程中被调用</span>
    <span class="token function">applyDerivedStateFromProps</span><span class="token punctuation">(</span>
      workInProgress<span class="token punctuation">,</span>
      ctor<span class="token punctuation">,</span>
      getDerivedStateFromProps<span class="token punctuation">,</span>
      newProps<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    instance<span class="token punctuation">.</span>state <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// In order to support react-lifecycles-compat polyfilled components,</span>
  <span class="token comment">// Unsafe lifecycles should not be invoked for components using the new APIs.</span>
  <span class="token comment">// 判断是否有 componentWillMount 生命周期方法</span>
  <span class="token comment">// 在这个生命周期方法中，会执行 setState 方法</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token keyword">typeof</span> ctor<span class="token punctuation">.</span>getDerivedStateFromProps <span class="token operator">!==</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span>
    <span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>getSnapshotBeforeUpdate <span class="token operator">!==</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>UNSAFE_componentWillMount <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">||</span>
      <span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>componentWillMount <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// </span>
    <span class="token function">callComponentWillMount</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// If we had additional state updates during this life-cycle, let's</span>
    <span class="token comment">// process them now.</span>
    <span class="token comment">// 执行了 这个生命周期方法，就需要重新执行 updateQueue</span>
    <span class="token comment">// 如果在这时执行了 setState, 立马被反映到组件上面</span>
    updateQueue <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>updateQueue<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>updateQueue <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">processUpdateQueue</span><span class="token punctuation">(</span>
        workInProgress<span class="token punctuation">,</span>
        updateQueue<span class="token punctuation">,</span>
        newProps<span class="token punctuation">,</span>
        instance<span class="token punctuation">,</span>
        renderExpirationTime<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      instance<span class="token punctuation">.</span>state <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>componentDidMount <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">|=</span> Update<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
  <ul><li>进入 <code>processUpdateQueue</code><pre><code class="prism language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> processUpdateQueue<span class="token operator">&lt;</span>State<span class="token operator">&gt;</span><span class="token punctuation">(</span>
  <span class="token literal-property property">workInProgress</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  <span class="token literal-property property">queue</span><span class="token operator">:</span> UpdateQueue<span class="token operator">&lt;</span>State<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">props</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
  <span class="token literal-property property">instance</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
  <span class="token literal-property property">renderExpirationTime</span><span class="token operator">:</span> ExpirationTime<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{<!-- --></span>
  hasForceUpdate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token comment">// 克隆 updateQueue</span>
  queue <span class="token operator">=</span> <span class="token function">ensureWorkInProgressQueueIsAClone</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> queue<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    currentlyProcessingQueue <span class="token operator">=</span> queue<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// These values may change as we process the queue.</span>
  <span class="token keyword">let</span> newBaseState <span class="token operator">=</span> queue<span class="token punctuation">.</span>baseState<span class="token punctuation">;</span>
  <span class="token keyword">let</span> newFirstUpdate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> newExpirationTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>

  <span class="token comment">// Iterate through the list of updates to compute the result.</span>
  <span class="token keyword">let</span> update <span class="token operator">=</span> queue<span class="token punctuation">.</span>firstUpdate<span class="token punctuation">;</span> 
  <span class="token keyword">let</span> resultState <span class="token operator">=</span> newBaseState<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>update <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> updateExpirationTime <span class="token operator">=</span> update<span class="token punctuation">.</span>expirationTime<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>updateExpirationTime <span class="token operator">&lt;</span> renderExpirationTime<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// This update does not have sufficient priority. Skip it.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>newFirstUpdate <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// This is the first skipped update. It will be the first update in</span>
        <span class="token comment">// the new list.</span>
        newFirstUpdate <span class="token operator">=</span> update<span class="token punctuation">;</span>
        <span class="token comment">// Since this is the first update that was skipped, the current result</span>
        <span class="token comment">// is the new base state.</span>
        newBaseState <span class="token operator">=</span> resultState<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Since this update will remain in the list, update the remaining</span>
      <span class="token comment">// expiration time.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>newExpirationTime <span class="token operator">&lt;</span> updateExpirationTime<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        newExpirationTime <span class="token operator">=</span> updateExpirationTime<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// This update does have sufficient priority. Process it and compute</span>
      <span class="token comment">// a new result.</span>
      resultState <span class="token operator">=</span> <span class="token function">getStateFromUpdate</span><span class="token punctuation">(</span>
        workInProgress<span class="token punctuation">,</span>
        queue<span class="token punctuation">,</span>
        update<span class="token punctuation">,</span>
        resultState<span class="token punctuation">,</span>
        props<span class="token punctuation">,</span>
        instance<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> callback <span class="token operator">=</span> update<span class="token punctuation">.</span>callback<span class="token punctuation">;</span>
      <span class="token comment">// 判断是否有 callback</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">|=</span> Callback<span class="token punctuation">;</span> <span class="token comment">// 加上 Callback 这块</span>
        <span class="token comment">// Set this to null, in case it was mutated during an aborted render.</span>
        update<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 防止在中断的渲染中被修改</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span>lastEffect <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          queue<span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> queue<span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> update<span class="token punctuation">;</span> <span class="token comment">// 链表操作</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          queue<span class="token punctuation">.</span>lastEffect<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> update<span class="token punctuation">;</span>
          queue<span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> update<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Continue to the next update.</span>
    update <span class="token operator">=</span> update<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Separately, iterate though the list of captured updates.</span>
  <span class="token keyword">let</span> newFirstCapturedUpdate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  update <span class="token operator">=</span> queue<span class="token punctuation">.</span>firstCapturedUpdate<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>update <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> updateExpirationTime <span class="token operator">=</span> update<span class="token punctuation">.</span>expirationTime<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>updateExpirationTime <span class="token operator">&lt;</span> renderExpirationTime<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// This update does not have sufficient priority. Skip it.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>newFirstCapturedUpdate <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// This is the first skipped captured update. It will be the first</span>
        <span class="token comment">// update in the new list.</span>
        newFirstCapturedUpdate <span class="token operator">=</span> update<span class="token punctuation">;</span>
        <span class="token comment">// If this is the first update that was skipped, the current result is</span>
        <span class="token comment">// the new base state.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newFirstUpdate <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          newBaseState <span class="token operator">=</span> resultState<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Since this update will remain in the list, update the remaining</span>
      <span class="token comment">// expiration time.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>newExpirationTime <span class="token operator">&lt;</span> updateExpirationTime<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        newExpirationTime <span class="token operator">=</span> updateExpirationTime<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// This update does have sufficient priority. Process it and compute</span>
      <span class="token comment">// a new result.</span>
      resultState <span class="token operator">=</span> <span class="token function">getStateFromUpdate</span><span class="token punctuation">(</span>
        workInProgress<span class="token punctuation">,</span>
        queue<span class="token punctuation">,</span>
        update<span class="token punctuation">,</span>
        resultState<span class="token punctuation">,</span>
        props<span class="token punctuation">,</span>
        instance<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> callback <span class="token operator">=</span> update<span class="token punctuation">.</span>callback<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">|=</span> Callback<span class="token punctuation">;</span>
        <span class="token comment">// Set this to null, in case it was mutated during an aborted render.</span>
        update<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span>lastCapturedEffect <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          queue<span class="token punctuation">.</span>firstCapturedEffect <span class="token operator">=</span> queue<span class="token punctuation">.</span>lastCapturedEffect <span class="token operator">=</span> update<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          queue<span class="token punctuation">.</span>lastCapturedEffect<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> update<span class="token punctuation">;</span>
          queue<span class="token punctuation">.</span>lastCapturedEffect <span class="token operator">=</span> update<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    update <span class="token operator">=</span> update<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>newFirstUpdate <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    queue<span class="token punctuation">.</span>lastUpdate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>newFirstCapturedUpdate <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    queue<span class="token punctuation">.</span>lastCapturedUpdate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">|=</span> Callback<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>newFirstUpdate <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> newFirstCapturedUpdate <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// We processed every update, without skipping. That means the new base</span>
    <span class="token comment">// state is the same as the result state.</span>
    newBaseState <span class="token operator">=</span> resultState<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  queue<span class="token punctuation">.</span>baseState <span class="token operator">=</span> newBaseState<span class="token punctuation">;</span>
  queue<span class="token punctuation">.</span>firstUpdate <span class="token operator">=</span> newFirstUpdate<span class="token punctuation">;</span>
  queue<span class="token punctuation">.</span>firstCapturedUpdate <span class="token operator">=</span> newFirstCapturedUpdate<span class="token punctuation">;</span>

  <span class="token comment">// Set the remaining expiration time to be whatever is remaining in the queue.</span>
  <span class="token comment">// This should be fine because the only two other things that contribute to</span>
  <span class="token comment">// expiration time are props and context. We're already in the middle of the</span>
  <span class="token comment">// begin phase by the time we start processing the queue, so we've already</span>
  <span class="token comment">// dealt with the props. Context in components that specify</span>
  <span class="token comment">// shouldComponentUpdate is tricky; but we'll have to account for</span>
  <span class="token comment">// that regardless.</span>
  workInProgress<span class="token punctuation">.</span>expirationTime <span class="token operator">=</span> newExpirationTime<span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> resultState<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    currentlyProcessingQueue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
    <ul><li>进入 <code>ensureWorkInProgressQueueIsAClone</code></li></ul> <pre><code class="prism language-js"><span class="token keyword">function</span> ensureWorkInProgressQueueIsAClone<span class="token operator">&lt;</span>State<span class="token operator">&gt;</span><span class="token punctuation">(</span>
  <span class="token literal-property property">workInProgress</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  <span class="token literal-property property">queue</span><span class="token operator">:</span> UpdateQueue<span class="token operator">&lt;</span>State<span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> UpdateQueue<span class="token operator">&lt;</span>State<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> current <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// If the work-in-progress queue is equal to the current queue,</span>
    <span class="token comment">// we need to clone it first.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>queue <span class="token operator">===</span> current<span class="token punctuation">.</span>updateQueue<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 要保证 workInProgress.updateQueue 是一个克隆的queue, 而非直接进行修改</span>
      queue <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token function">cloneUpdateQueue</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 拷贝 queue</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> queue<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> </li><li>进入 <code>getStateFromUpdate</code><pre><code class="prism language-js"><span class="token keyword">function</span> getStateFromUpdate<span class="token operator">&lt;</span>State<span class="token operator">&gt;</span><span class="token punctuation">(</span>
  <span class="token literal-property property">workInProgress</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  <span class="token literal-property property">queue</span><span class="token operator">:</span> UpdateQueue<span class="token operator">&lt;</span>State<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">update</span><span class="token operator">:</span> Update<span class="token operator">&lt;</span>State<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">prevState</span><span class="token operator">:</span> State<span class="token punctuation">,</span>
  <span class="token literal-property property">nextProps</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
  <span class="token literal-property property">instance</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> any <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>update<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">case</span> <span class="token literal-property property">ReplaceState</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> payload <span class="token operator">=</span> update<span class="token punctuation">.</span>payload<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> payload <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Updater function</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>
            debugRenderPhaseSideEffects <span class="token operator">||</span>
            <span class="token punctuation">(</span>debugRenderPhaseSideEffectsForStrictMode <span class="token operator">&amp;&amp;</span>
              workInProgress<span class="token punctuation">.</span>mode <span class="token operator">&amp;</span> StrictMode<span class="token punctuation">)</span>
          <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">payload</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> prevState<span class="token punctuation">,</span> nextProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">payload</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> prevState<span class="token punctuation">,</span> nextProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// State object</span>
      <span class="token keyword">return</span> payload<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 这里 a &amp; ~b 表示: a &amp; 除了b之外的所有属性</span>
    <span class="token keyword">case</span> <span class="token literal-property property">CaptureUpdate</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">=</span>
        <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;</span> <span class="token operator">~</span>ShouldCapture<span class="token punctuation">)</span> <span class="token operator">|</span> DidCapture<span class="token punctuation">;</span> <span class="token comment">// 这里最终剩下的 只有 DidCapture</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Intentional fallthrough</span>
    <span class="token keyword">case</span> <span class="token literal-property property">UpdateState</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> payload <span class="token operator">=</span> update<span class="token punctuation">.</span>payload<span class="token punctuation">;</span>
      <span class="token keyword">let</span> partialState<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> payload <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Updater function</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>
            debugRenderPhaseSideEffects <span class="token operator">||</span>
            <span class="token punctuation">(</span>debugRenderPhaseSideEffectsForStrictMode <span class="token operator">&amp;&amp;</span>
              workInProgress<span class="token punctuation">.</span>mode <span class="token operator">&amp;</span> StrictMode<span class="token punctuation">)</span>
          <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">payload</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> prevState<span class="token punctuation">,</span> nextProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果是 function 则调用 payload 传入之前的参数 计算出 state</span>
        partialState <span class="token operator">=</span> <span class="token function">payload</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> prevState<span class="token punctuation">,</span> nextProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Partial state object</span>
        partialState <span class="token operator">=</span> payload<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 处理特殊情况</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>partialState <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> partialState <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Null and undefined are treated as no-ops.</span>
        <span class="token keyword">return</span> prevState<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Merge the partial state and the previous state.</span>
      <span class="token comment">// 合并</span>
      <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> prevState<span class="token punctuation">,</span> partialState<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token literal-property property">ForceUpdate</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      hasForceUpdate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> prevState<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> prevState<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> </li></ul> </li><li> <p>进入 <code>finishClassComponent</code></p> <pre><code class="prism language-js"><span class="token keyword">function</span> <span class="token function">finishClassComponent</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">current</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">workInProgress</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  <span class="token literal-property property">Component</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
  <span class="token literal-property property">shouldUpdate</span><span class="token operator">:</span> boolean<span class="token punctuation">,</span>
  <span class="token literal-property property">hasContext</span><span class="token operator">:</span> boolean<span class="token punctuation">,</span>
  <span class="token literal-property property">renderExpirationTime</span><span class="token operator">:</span> ExpirationTime<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// Refs should update even if shouldComponentUpdate returns false</span>
  <span class="token comment">// 这个先跳过</span>
  <span class="token function">markRef</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 判断 workInProgress.effectTag 上是否有 DidCapture</span>
  <span class="token keyword">const</span> didCaptureError <span class="token operator">=</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;</span> DidCapture<span class="token punctuation">)</span> <span class="token operator">!==</span> NoEffect<span class="token punctuation">;</span>
  <span class="token comment">// 在没有更新也没有错误捕获的情况下</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldUpdate <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>didCaptureError<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Context providers should defer to sCU for rendering</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hasContext<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">invalidateContextProvider</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> Component<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 跳过更新</span>
    <span class="token keyword">return</span> <span class="token function">bailoutOnAlreadyFinishedWork</span><span class="token punctuation">(</span>
      current<span class="token punctuation">,</span>
      workInProgress<span class="token punctuation">,</span>
      renderExpirationTime<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> instance <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>

  <span class="token comment">// Rerender</span>
  ReactCurrentOwner<span class="token punctuation">.</span>current <span class="token operator">=</span> workInProgress<span class="token punctuation">;</span>
  <span class="token keyword">let</span> nextChildren<span class="token punctuation">;</span>
  <span class="token comment">// 有任何错误捕获, 但没有配置这个api的时候</span>
  <span class="token comment">// 这个 getDerivedStateFromError 生命周期的api和 componentDidCatch 有区别, 后者在下次更新的时候处理，中间可能instance不存在(因为出错了)</span>
  <span class="token comment">// 就继续可能引发在这个class component上面设置的 ref拿到一个null, 操作ref的时候就会出现错误</span>
  <span class="token comment">// 在前者这个新的生命周期的api中, 在本次渲染中，生成 state, 渲染出属性, 这样对于 instance 对象依然存在 对应 ref 就可以拿到实际的对象</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    didCaptureError <span class="token operator">&amp;&amp;</span>
    <span class="token keyword">typeof</span> Component<span class="token punctuation">.</span>getDerivedStateFromError <span class="token operator">!==</span> <span class="token string">'function'</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// If we captured an error, but getDerivedStateFrom catch is not defined,</span>
    <span class="token comment">// unmount all the children. componentDidCatch will schedule an update to</span>
    <span class="token comment">// re-render a fallback. This is temporary until we migrate everyone to</span>
    <span class="token comment">// the new API.</span>
    <span class="token comment">// TODO: Warn in a future release.</span>
    nextChildren <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>enableProfilerTimer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">stopProfilerTimerIfRunning</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      ReactCurrentFiber<span class="token punctuation">.</span><span class="token function">setCurrentPhase</span><span class="token punctuation">(</span><span class="token string">'render'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      nextChildren <span class="token operator">=</span> instance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        debugRenderPhaseSideEffects <span class="token operator">||</span>
        <span class="token punctuation">(</span>debugRenderPhaseSideEffectsForStrictMode <span class="token operator">&amp;&amp;</span>
          workInProgress<span class="token punctuation">.</span>mode <span class="token operator">&amp;</span> StrictMode<span class="token punctuation">)</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        instance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      ReactCurrentFiber<span class="token punctuation">.</span><span class="token function">setCurrentPhase</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 调用 render 方法，计算出新的 children</span>
      nextChildren <span class="token operator">=</span> instance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// React DevTools reads this flag.</span>
  workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">|=</span> PerformedWork<span class="token punctuation">;</span> <span class="token comment">// 增加 PerformedWork</span>
  <span class="token comment">// 不是第一次渲染，并且有错误捕获</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> didCaptureError<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// If we're recovering from an error, reconcile without reusing any of</span>
    <span class="token comment">// the existing children. Conceptually, the normal children and the children</span>
    <span class="token comment">// that are shown on error are two different sets, so we shouldn't reuse</span>
    <span class="token comment">// normal children even if their identities match.</span>
    <span class="token function">forceUnmountCurrentAndReconcile</span><span class="token punctuation">(</span>
      current<span class="token punctuation">,</span>
      workInProgress<span class="token punctuation">,</span>
      nextChildren<span class="token punctuation">,</span>
      renderExpirationTime<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 正常情况调用 调和 children</span>
    <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>
      current<span class="token punctuation">,</span>
      workInProgress<span class="token punctuation">,</span>
      nextChildren<span class="token punctuation">,</span>
      renderExpirationTime<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Memoize state using the values we just used to render.</span>
  <span class="token comment">// TODO: Restructure so we never read values from the instance.</span>
  workInProgress<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> instance<span class="token punctuation">.</span>state<span class="token punctuation">;</span>

  <span class="token comment">// The context might have changed so we need to recalculate it.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hasContext<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">invalidateContextProvider</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> Component<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> workInProgress<span class="token punctuation">.</span>child<span class="token punctuation">;</span> <span class="token comment">// 把 render 方法渲染出来的第一个子节点 返回给 nextUnitOfWork, 就可以在 workLoop 中继续进行更新的流程</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p>简单总结</p> 
  <ul><li>以上是更新 class component 的整体流程</li><li>一开始要使用 <code>constructClassInstance</code> 创建 class instance</li><li>内部会根据不同情况调用不同方法</li><li>并且要调用 <code>mountClassInstance</code> 来挂载</li><li>如果是第一次渲染被中断的情况 
    <ul><li>如果存在 instance 则重复使用 instance</li><li>它调用的生命周期方法仍然是 第一次渲染的生命周期方法</li><li>也就是 <code>componentDidMount</code></li></ul> </li><li>如果不是第一次渲染的情况 
    <ul><li>调用 updateClassInstance 方法</li><li>这种会最终调用 <code>componentDidUpdate</code> 方法</li></ul> </li><li>它们中间的流程类似 
    <ul><li>判断各种情况，创建新的 instance 或 复用之前的</li><li>通过 <code>processUpdateQueue</code> 来获取新的 state</li><li>会把它赋值到 instance 和 fiber 上面进行记录</li><li>最终都会调用 <code>finishClassComponent</code> 
      <ul><li>这里面做一些错误判断的处理</li><li>以及是否可以跳过更新的过程</li><li>还有重新调和子节点 (通用流程)</li></ul> </li></ul> </li></ul> </li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a59f418e58ed65fa9862ee5547eff39a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">GPT属于AI，是LLM的一种实现</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e294f69e91f5d2a1481d4bf913d0ef32/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">数据分析师必会的SQL命令！</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>