<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>RBAC鉴权实验操作 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="RBAC鉴权实验操作" />
<meta property="og:description" content="文章目录 一、RBAC概念
二、实验步骤（serviceaccoount使用案例介绍）
1.创建sa并绑定到pod
2.创建pod
3.验证（拒绝访问）
4.对sa做授权
5.再次请求验证
三、自定义角色
1.创建角色，控制权限
2.角色绑定
总结
一、RBAC概念 1.RBAC官网介绍：使用 RBAC 鉴权 | Kubernetes
2.RBAC（基于角色的访问控制）：是一种基于组织中各个用户的角色来调节对计算机或网络资源的访问方法。
作用：防止k8s里的pod能随意获取整个集群里的信息和访问集群里的资源
2.UserAccount和ServiceAccount介绍
二、实验步骤（serviceaccoount使用案例介绍） 1.创建sa并绑定到pod [root@k8smaster ingress]# kubectl create sa sa-lay serviceaccount/sa-lay created [root@k8smaster ~]# kubectl get sa NAME SECRETS AGE default 1 103d sa-lay 1 2d3h 2.创建pod [root@k8smaster sa]# cat sa-pod.yaml apiVersion: v1 kind: Pod metadata: name: sa-lay namespace: default labels: app: sa-lay spec: serviceAccountName: sa-lay containers: - name: sa-nginx ports: - containerPort: 80 image: nginx imagePullPolicy: IfNotPresent [root@k8smaster sa]# kubectl apply -f sa-pod." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/420898f8d92191a6dd05948cae5b523c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-27T21:39:30+08:00" />
<meta property="article:modified_time" content="2023-08-27T21:39:30+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">RBAC鉴权实验操作</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <blockquote> 
 <p></p> 
</blockquote> 
<div> 
 <h4 id="%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95">文章目录</h4> 
 <p id="%E4%B8%80%E3%80%81RBAC%E6%A6%82%E5%BF%B5-toc" style="margin-left:0px;"><a href="#%E4%B8%80%E3%80%81RBAC%E6%A6%82%E5%BF%B5" rel="nofollow">一、RBAC概念</a></p> 
 <p id="%C2%A0%E4%BA%8C%E3%80%81%E5%AE%9E%E9%AA%8C%E6%AD%A5%E9%AA%A4%EF%BC%88serviceaccoount%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B%E4%BB%8B%E7%BB%8D%EF%BC%89-toc" style="margin-left:0px;"><a href="#%C2%A0%E4%BA%8C%E3%80%81%E5%AE%9E%E9%AA%8C%E6%AD%A5%E9%AA%A4%EF%BC%88serviceaccoount%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B%E4%BB%8B%E7%BB%8D%EF%BC%89" rel="nofollow"> 二、实验步骤（serviceaccoount使用案例介绍）</a></p> 
 <p id="1.%E5%88%9B%E5%BB%BAsa%E5%B9%B6%E7%BB%91%E5%AE%9A%E5%88%B0pod-toc" style="margin-left:40px;"><a href="#1.%E5%88%9B%E5%BB%BAsa%E5%B9%B6%E7%BB%91%E5%AE%9A%E5%88%B0pod" rel="nofollow">1.创建sa并绑定到pod</a></p> 
 <p id="2.%E5%88%9B%E5%BB%BApod-toc" style="margin-left:40px;"><a href="#2.%E5%88%9B%E5%BB%BApod" rel="nofollow">2.创建pod</a></p> 
 <p id="3.%E9%AA%8C%E8%AF%81%EF%BC%88%E6%8B%92%E7%BB%9D%E8%AE%BF%E9%97%AE%EF%BC%89-toc" style="margin-left:40px;"><a href="#3.%E9%AA%8C%E8%AF%81%EF%BC%88%E6%8B%92%E7%BB%9D%E8%AE%BF%E9%97%AE%EF%BC%89" rel="nofollow">3.验证（拒绝访问）</a></p> 
 <p id="4.%E5%AF%B9sa%E5%81%9A%E6%8E%88%E6%9D%83-toc" style="margin-left:40px;"><a href="#4.%E5%AF%B9sa%E5%81%9A%E6%8E%88%E6%9D%83" rel="nofollow">4.对sa做授权</a></p> 
 <p id="5.%E5%86%8D%E6%AC%A1%E8%AF%B7%E6%B1%82%E9%AA%8C%E8%AF%81-toc" style="margin-left:40px;"><a href="#5.%E5%86%8D%E6%AC%A1%E8%AF%B7%E6%B1%82%E9%AA%8C%E8%AF%81" rel="nofollow">5.再次请求验证</a></p> 
 <p id="%E4%B8%89%E3%80%81%E8%87%AA%E5%AE%9A%E4%B9%89%E8%A7%92%E8%89%B2-toc" style="margin-left:0px;"><a href="#%E4%B8%89%E3%80%81%E8%87%AA%E5%AE%9A%E4%B9%89%E8%A7%92%E8%89%B2" rel="nofollow">三、自定义角色</a></p> 
 <p id="1.%E5%88%9B%E5%BB%BA%E8%A7%92%E8%89%B2%EF%BC%8C%E6%8E%A7%E5%88%B6%E6%9D%83%E9%99%90-toc" style="margin-left:40px;"><a href="#1.%E5%88%9B%E5%BB%BA%E8%A7%92%E8%89%B2%EF%BC%8C%E6%8E%A7%E5%88%B6%E6%9D%83%E9%99%90" rel="nofollow">1.创建角色，控制权限</a></p> 
 <p id="2.%E8%A7%92%E8%89%B2%E7%BB%91%E5%AE%9A-toc" style="margin-left:40px;"><a href="#2.%E8%A7%92%E8%89%B2%E7%BB%91%E5%AE%9A" rel="nofollow">2.角色绑定</a></p> 
 <p id="-toc" style="margin-left:40px;"></p> 
 <p id="%E6%80%BB%E7%BB%93-toc" style="margin-left:0px;"><a href="#%E6%80%BB%E7%BB%93" rel="nofollow">总结</a></p> 
</div> 
<hr> 
<h2 id="%E4%B8%80%E3%80%81RBAC%E6%A6%82%E5%BF%B5">一、RBAC概念</h2> 
<p>1.RBAC官网介绍：<a href="https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/rbac/" rel="nofollow" title="使用 RBAC 鉴权 | Kubernetes">使用 RBAC 鉴权 | Kubernetes</a></p> 
<p>2.RBAC（基于角色的访问控制）：是一种基于组织中各个用户的角色来调节对计算机或网络资源的访问方法。</p> 
<p>作用：防止k8s里的pod能随意获取整个集群里的信息和访问集群里的资源</p> 
<p><img alt="" height="610" src="https://images2.imgbox.com/c9/8e/rYP0tPAV_o.png" width="1200"></p> 
<p>2.UserAccount和ServiceAccount介绍</p> 
<p><img alt="" height="531" src="https://images2.imgbox.com/ff/ac/EpAkXWhl_o.png" width="1200"></p> 
<hr> 
<h2 id="%C2%A0%E4%BA%8C%E3%80%81%E5%AE%9E%E9%AA%8C%E6%AD%A5%E9%AA%A4%EF%BC%88serviceaccoount%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B%E4%BB%8B%E7%BB%8D%EF%BC%89"> 二、实验步骤（serviceaccoount使用案例介绍）</h2> 
<h3 id="1.%E5%88%9B%E5%BB%BAsa%E5%B9%B6%E7%BB%91%E5%AE%9A%E5%88%B0pod"><a id="1_20"></a>1.创建sa并绑定到pod</h3> 
<pre><code class="language-c">[root@k8smaster ingress]# kubectl create sa sa-lay
serviceaccount/sa-lay created
[root@k8smaster ~]# kubectl get sa
NAME      SECRETS   AGE
default   1         103d
sa-lay    1         2d3h
</code></pre> 
<h3 id="2.%E5%88%9B%E5%BB%BApod"><a id="2_34"></a>2.创建pod</h3> 
<pre><code class="language-c">[root@k8smaster sa]# cat sa-pod.yaml

apiVersion: v1
kind: Pod
metadata:
  name: sa-lay
  namespace: default
  labels:
    app: sa-lay
spec:
  serviceAccountName: sa-lay
  containers:
  - name: sa-nginx
    ports:
    - containerPort: 80
    image: nginx
    imagePullPolicy: IfNotPresent
    
[root@k8smaster sa]# kubectl apply -f sa-pod.yaml 
pod/sa-lay created
</code></pre> 
<h3 id="3.%E9%AA%8C%E8%AF%81%EF%BC%88%E6%8B%92%E7%BB%9D%E8%AE%BF%E9%97%AE%EF%BC%89">3.验证（拒绝访问）</h3> 
<p>访问apiserver，没权限</p> 
<p>sa能通过https方式成功认证API，但是没有权限访问k8s资源，所以code状态码是403，表示没有权限操作k8s资源</p> 
<pre><code class="hljs">[root@k8smaster sa]# kubectl exec -it sa-lay -- bash
root@sa-lay:/# cd /var/run/secrets/kubernetes.io/serviceaccount
root@sa-lay:/var/run/secrets/kubernetes.io/serviceaccount# ls
ca.crt	namespace  token
root@sa-lay:/var/run/secrets/kubernetes.io/serviceaccount# curl --cacert ./ca.crt -H "Authorization: Bearer $(cat ./token)" https://kubernetes/api/v1/namespaces/kube-system
{
  "kind": "Status",
  "apiVersion": "v1",
  "metadata": {
    
  },
  "status": "Failure",
  "message": "namespaces \"kube-system\" is forbidden: User \"system:serviceaccount:default:sa-lay\" cannot get resource \"namespaces\" in API group \"\" in the namespace \"kube-system\"",
  "reason": "Forbidden",
  "details": {
    "name": "kube-system",
    "kind": "namespaces"
  },
  "code": 403
</code></pre> 
<h3 id="4.%E5%AF%B9sa%E5%81%9A%E6%8E%88%E6%9D%83">4.对sa做授权</h3> 
<pre><code class="hljs">[root@k8smaster sa]# kubectl create clusterrolebinding sa-test-admin --clusterrole=cluster-admin --serviceaccount=default:sa-lay
clusterrolebinding.rbac.authorization.k8s.io/sa-test-admin created</code></pre> 
<h3 id="5.%E5%86%8D%E6%AC%A1%E8%AF%B7%E6%B1%82%E9%AA%8C%E8%AF%81">5.再次请求验证</h3> 
<pre><code class="hljs">[root@k8smaster sa]# kubectl exec -it sa-lay -- bash
root@sa-lay:/# cd /var/run/secrets/kubernetes.io/serviceaccount
root@sa-lay:/var/run/secrets/kubernetes.io/serviceaccount# curl --cacert ./ca.crt -H "Authorization: Bearer $(cat ./token)" https://kubernetes/api/v1/namespaces/kube-system
{
  "kind": "Namespace",
  "apiVersion": "v1",
  "metadata": {
    "name": "kube-system",
    "uid": "1afd57db-8217-4eab-9015-42629f340013",
    "resourceVersion": "17",
    "creationTimestamp": "2023-05-15T12:19:01Z",
    "managedFields": [
      {
        "manager": "kube-apiserver",
        "operation": "Update",
        "apiVersion": "v1",
        "time": "2023-05-15T12:19:01Z",
        "fieldsType": "FieldsV1",
        "fieldsV1": {"f:status":{"f:phase":{}}}
      }
    ]
  },
  "spec": {
    "finalizers": [
      "kubernetes"
    ]
  },
  "status": {
    "phase": "Active"
  }</code></pre> 
<h2 id="%E4%B8%89%E3%80%81%E8%87%AA%E5%AE%9A%E4%B9%89%E8%A7%92%E8%89%B2">三、自定义角色</h2> 
<h3 id="1.%E5%88%9B%E5%BB%BA%E8%A7%92%E8%89%B2%EF%BC%8C%E6%8E%A7%E5%88%B6%E6%9D%83%E9%99%90">1.创建角色，控制权限</h3> 
<pre><code class="hljs">[root@k8smaster sa]# cat role.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: default
  name: pod-reader
rules:
- apiGroups: [""] # "" 标明 core API 组
  resources: ["pods"]
  verbs: ["get", "watch", "list"]
[root@k8smaster sa]# kubectl apply -f role.yaml 
role.rbac.authorization.k8s.io/pod-reader created</code></pre> 
<h3 id="2.%E8%A7%92%E8%89%B2%E7%BB%91%E5%AE%9A">2.角色绑定</h3> 
<pre><code class="hljs">[root@k8smaster sa]# kubectl create rolebinding sa-test-lay --role=pod-reader --serviceaccount=default:sa-lay
rolebinding.rbac.authorization.k8s.io/sa-test-lay created</code></pre> 
<h3></h3> 
<pre><code class="hljs">[root@k8smaster sa]# kubectl get rolebinding
NAME          ROLE              AGE
sa-test-lay   Role/pod-reader   38s</code></pre> 
<hr> 
<h2 id="%E6%80%BB%E7%BB%93"><a id="_45"></a>总结</h2> 
<p>以上就是使用RBAC将角色和对应的权限绑定的实验操作</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/eaf446a2b9b2dac3ead7f51000da5f12/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">jquery 常用方法 -- 动画篇</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d6469e1ffb977fcb6267e5cf6de1ab52/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">RT-2(robotics-transformer2)论文翻译——1</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>