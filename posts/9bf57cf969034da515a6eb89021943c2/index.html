<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>springboott整合mybatis-plus和sharding-jdbc实现分库分表和读写分离（含完整项目代码） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="springboott整合mybatis-plus和sharding-jdbc实现分库分表和读写分离（含完整项目代码）" />
<meta property="og:description" content="springboott整合mybatis-plus和sharding-jdbc实现分库分表和读写分离（含完整项目代码） 一、整合sharding-jdbc 关于springboot整合sharding-jdbc官网有4种方式，而网上千篇一律都是用.properties文件。我在这里主要是用yml&#43;bean两种方式结合，bean主要是为了实现分片键分片规则更灵活。
1.1引入maven依赖 这里有个小坑，我一开始引入是最新的sharding-jdbc和mybatis-plus的依赖，结果启动项目直接报错。所以个人不建议引用最新的包。
&lt;dependency&gt; &lt;groupId&gt;org.apache.shardingsphere&lt;/groupId&gt; &lt;artifactId&gt;sharding-jdbc-spring-boot-starter&lt;/artifactId&gt; &lt;version&gt;4.0.0-RC1&lt;/version&gt; &lt;/dependency&gt; 1.2配置分库分表和读写分离（核心） spring: shardingsphere: datasource: names: &#34;search-center-00,search-center-00-slave,search-center-01,search-center-01-slave&#34; search-center-00: type: com.alibaba.druid.pool.DruidDataSource driver-class-name: com.mysql.cj.jdbc.Driver url: jdbc:mysql://localhost:3306/search_center_00?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=UTC username: root password: 123456 search-center-00-slave: type: com.alibaba.druid.pool.DruidDataSource driver-class-name: com.mysql.cj.jdbc.Driver url: jdbc:mysql://localhost:3307/search_center_00?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=UTC username: root password: 123456 search-center-01: type: com.alibaba.druid.pool.DruidDataSource driver-class-name: com.mysql.cj.jdbc.Driver url: jdbc:mysql://localhost:3306/search_center_01?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=UTC username: root password: 123456 search-center-01-slave: type: com.alibaba.druid.pool.DruidDataSource driver-class-name: com.mysql.cj.jdbc.Driver url: jdbc:mysql://localhost:3307/search_center_01?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=UTC username: root password: 123456 sharding: master-slave-rules: search-center-00: master-data-source-name: search-center-00 slave-data-source-names: search-center-00-slave search-center-01: master-data-source-name: search-center-01 slave-data-source-names: search-center-01-slave tables: user: actual-data-nodes: search-center-$-&gt;{(0." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/9bf57cf969034da515a6eb89021943c2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-10-04T15:33:49+08:00" />
<meta property="article:modified_time" content="2021-10-04T15:33:49+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">springboott整合mybatis-plus和sharding-jdbc实现分库分表和读写分离（含完整项目代码）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="springboottmybatisplusshardingjdbc_0"></a>springboott整合mybatis-plus和sharding-jdbc实现分库分表和读写分离（含完整项目代码）</h3> 
<h4><a id="shardingjdbc_2"></a>一、整合sharding-jdbc</h4> 
<p>关于springboot整合sharding-jdbc官网有4种方式，而网上千篇一律都是用.properties文件。我在这里主要是用yml+bean两种方式结合，bean主要是为了实现分片键分片规则更灵活。</p> 
<h5><a id="11maven_6"></a>1.1引入maven依赖</h5> 
<p>这里有个小坑，我一开始引入是最新的sharding-jdbc和mybatis-plus的依赖，结果启动项目直接报错。所以个人不建议引用最新的包。</p> 
<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;org.apache.shardingsphere&lt;/groupId&gt;
    &lt;artifactId&gt;sharding-jdbc-spring-boot-starter&lt;/artifactId&gt;
    &lt;version&gt;4.0.0-RC1&lt;/version&gt;
&lt;/dependency&gt;
</code></pre> 
<h5><a id="12_18"></a>1.2配置分库分表和读写分离（核心）</h5> 
<pre><code>spring:
  shardingsphere:
    datasource:
      names: "search-center-00,search-center-00-slave,search-center-01,search-center-01-slave"
      search-center-00:
        type: com.alibaba.druid.pool.DruidDataSource
        driver-class-name: com.mysql.cj.jdbc.Driver
        url: jdbc:mysql://localhost:3306/search_center_00?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=UTC
        username: root
        password: 123456
      search-center-00-slave:
        type: com.alibaba.druid.pool.DruidDataSource
        driver-class-name: com.mysql.cj.jdbc.Driver
        url: jdbc:mysql://localhost:3307/search_center_00?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=UTC
        username: root
        password: 123456
      search-center-01:
        type: com.alibaba.druid.pool.DruidDataSource
        driver-class-name: com.mysql.cj.jdbc.Driver
        url: jdbc:mysql://localhost:3306/search_center_01?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=UTC
        username: root
        password: 123456
      search-center-01-slave:
        type: com.alibaba.druid.pool.DruidDataSource
        driver-class-name: com.mysql.cj.jdbc.Driver
        url: jdbc:mysql://localhost:3307/search_center_01?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=UTC
        username: root
        password: 123456
    sharding:
      master-slave-rules:
        search-center-00:
          master-data-source-name: search-center-00
          slave-data-source-names: search-center-00-slave
        search-center-01:
          master-data-source-name: search-center-01
          slave-data-source-names: search-center-01-slave
      tables:
        user:
          actual-data-nodes: search-center-$-&gt;{(0..1).collect{t -&gt;t.toString().padLeft(2,'0')}}.user_$-&gt;{(0..1).collect{t -&gt;t.toString().padLeft(2,'0')}}
          database-strategy:
            standard:
              shardingColumn: id
              precise-algorithm-class-name: com.gory.searchcenter.config.DatabaseAlgorithm
          table-strategy:
            standard:
              sharding-column: id
              precise-algorithm-class-name: com.gory.searchcenter.config.TableAlgorithm
    props:
      sql:
        show: true
</code></pre> 
<p>names:自定义数据库名称，然后对这些名称进行具体的配置，如：url，password，username等</p> 
<p>tables:对每个表进行分库分表。例如，这里对user表进行分库分表，</p> 
<p>actual-data-nodes：则是user表分库分表的节点分配。</p> 
<p>database-strategy：是分库的策略，我这里是根据id，然后通过bean方式更加灵活配置分库规则，</p> 
<p>table-strategy：则是分表的策略，配置和分库大概一致。</p> 
<p>master-slave-rules:设置主从实现读写分离，</p> 
<pre><code>DatabaseAlgorithm
</code></pre> 
<pre><code>public class DatabaseAlgorithm implements PreciseShardingAlgorithm&lt;Long&gt; {
    @Override
    public String doSharding(Collection&lt;String&gt; databaseNames, PreciseShardingValue&lt;Long&gt; shardingValue) {
        Long shardResult = Math.abs((long) shardingValue.getValue().hashCode()) % 2;
        for (String databaseName : databaseNames) {
            String shardValue = String.format("%02d", shardResult);
            if (databaseName.endsWith(shardValue)){
                System.out.println("shardingValue:"+shardingValue+", databaseName:" + databaseName);
                return databaseName;
            }
        }
        throw new UnsupportedOperationException();
    }

}
</code></pre> 
<pre><code>TableAlgorithm
</code></pre> 
<pre><code>public class TableAlgorithm implements PreciseShardingAlgorithm&lt;Long&gt; {

    /**
     * @param tableNames 有效的数据源 或者 表 的名字  tableNames 就为配置文件中的 配置的数据源信息 -&gt; ds0 , ds1
     * @param shardingValue SQL 分片列 对应的实际值
     * @return 返回相应的表名
     */
    @Override
    public String doSharding(Collection&lt;String&gt; tableNames, PreciseShardingValue&lt;Long&gt; shardingValue) {
        Long shardResult = Math.abs((long) shardingValue.getValue().hashCode()) / 2 % 2;
        for (String tableName : tableNames) {
            String shardValue = String.format("%02d", shardResult);
            if (tableName.endsWith(shardValue)){
                System.out.println("shardingValue:"+shardingValue+", tableName:" + tableName);
                return tableName;
            }
        }
        throw new UnsupportedOperationException();
    }

}
</code></pre> 
<p>随便说一下，这里的分片主键id是用雪花算法设值的。你的分片键的赋值最好和你的分片规则对应上。</p> 
<h4><a id="mybatisplus_137"></a>二、整合mybatis-plus</h4> 
<p>上一节已经说过了，引入最新的maven依赖会报错，所以我还是不建议用最新的。</p> 
<h5><a id="21_maven_141"></a>2.1 引入maven依赖</h5> 
<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;com.baomidou&lt;/groupId&gt;
    &lt;artifactId&gt;mybatis-plus-boot-starter&lt;/artifactId&gt;
    &lt;version&gt;3.2.0&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.baomidou&lt;/groupId&gt;
    &lt;artifactId&gt;mybatis-plus-generator&lt;/artifactId&gt;
    &lt;version&gt;3.5.1&lt;/version&gt;
&lt;/dependency&gt;
</code></pre> 
<h5><a id="22_mybatisplus_156"></a>2.2 mybatis-plus的配置</h5> 
<pre><code>mybatis-plus:
  mapper-locations: classpath:/mapper/*.xml
  configuration:
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
</code></pre> 
<p>再启动类加上包扫表注解</p> 
<pre><code>@MapperScan({"com.gory.searchcenter.mapper"})
</code></pre> 
<h4><a id="_171"></a>三、数据库主从配置</h4> 
<p>在上两节已经能完成分库分表了，但是因为数据库没设置主从，从表没有数据库，导致查询没有数据。因为此文章主要是为了学习，所以mysql的配置是在window环境的。</p> 
<h5><a id="31myini_175"></a>3.1my.ini配置</h5> 
<h6><a id="_177"></a>主库</h6> 
<p>#主库id不能重复</p> 
<p>server_id=1</p> 
<p>#开启bin-log</p> 
<p>log_bin=E:\lib\mysql-5.7.30-winx64\master-bin.log</p> 
<p>#mysql清除过期日志的时间与从库设置一致<br> expire_logs_days = 1</p> 
<p>#设置需要同步的数据库<br> binlog-do-db=search_center_00<br> binlog-do-db=search_center_01<br> ------------------------------------------------------------ |</p> 
<h6><a id="_196"></a>从库</h6> 
<p>server_id=2</p> 
<p>#开启bin-log</p> 
<p>log_bin=E:\lib\mysql-5.7.30-winx64-slave\slave-bin.log</p> 
<p>expire_logs_days = 1</p> 
<p>#设置需要同步的数据库<br> binlog-do-db=search_center_00<br> binlog-do-db=search_center_01<br> ------------------------------------------------------------ |</p> 
<p>值得一提，设置多个同步表，不能用逗号隔开。</p> 
<h5><a id="31_sql_213"></a>3.1 sql配置</h5> 
<h6><a id="_215"></a>主库</h6> 
<p>开通从服务器（ Slave ）访问主服务器（ Master ）的权限</p> 
<p>grant replication slave on <em>.</em> to ‘root’@‘127.0.0.1’ identified by ‘123456’;</p> 
<p>查看授权信息</p> 
<p>show master status ;</p> 
<h6><a id="_225"></a>从库</h6> 
<p>停止同步</p> 
<p>stop slave;</p> 
<p>设置主库的信息，将从库和主库联系起来</p> 
<p>change master to<br> master_host=’127.0.0.1’,<br> master_user=’root’,<br> master_password=’123456’,<br> master_log_file=’log-bin.000008’,<br> master_log_pos=107;<br> master_log_file和master_log_pos这两个 配置是和主 服务器 show master status对应的</p> 
<p>启动同步</p> 
<p>start salve;</p> 
<p>查看slave启动状态</p> 
<p>show slave status；</p> 
<p>如果出现，则表明，启动成功。</p> 
<p>Slave_IO_Running:Yes</p> 
<p>Slave_SQL_Running:Yes</p> 
<h4><a id="_255"></a>四、完整的项目代码</h4> 
<p>完整的代码：https://github.com/gorylee/SearchCenter</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/58bb53a6d7acdd5ff8ce5bb20a8e72d4/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【c语言进阶】如此清晰的指针讲解让你再也不怕学不会指针了，硬核指针讲解。</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c24fced2581ffe2aeaf5801143980637/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">c&#43;&#43;智能指针(面试)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>