<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>新版mmdetection3d将3D bbox绘制到图像 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="新版mmdetection3d将3D bbox绘制到图像" />
<meta property="og:description" content="环境信息 使用 python mmdet3d/utils/collect_env.py收集环境信息
sys.platform: linux Python: 3.7.12 | packaged by conda-forge | (default, Oct 26 2021, 06:08:21) [GCC 9.4.0] CUDA available: True numpy_random_seed: 2147483648 GPU 0,1: NVIDIA GeForce RTX 3090 CUDA_HOME: /usr/local/cuda NVCC: Cuda compilation tools, release 11.3, V11.3.109 GCC: gcc (Ubuntu 7.5.0-6ubuntu2) 7.5.0 PyTorch: 1.8.1&#43;cu111 PyTorch compiling details: PyTorch built with: - GCC 7.3 - C&#43;&#43; Version: 201402 - Intel(R) Math Kernel Library Version 2020.0.0 Product Build 20191122 for Intel(R) 64 architecture applications - Intel(R) MKL-DNN v1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/f3b8817863e2bff2babb21657c7d5723/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-19T09:52:38+08:00" />
<meta property="article:modified_time" content="2023-11-19T09:52:38+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">新版mmdetection3d将3D bbox绘制到图像</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>环境信息</h3> 
<p>使用 <code>python mmdet3d/utils/collect_env.py</code>收集环境信息</p> 
<pre><code class="prism language-python">sys<span class="token punctuation">.</span>platform<span class="token punctuation">:</span> linux
Python<span class="token punctuation">:</span> <span class="token number">3.7</span><span class="token number">.12</span> <span class="token operator">|</span> packaged by conda<span class="token operator">-</span>forge <span class="token operator">|</span> <span class="token punctuation">(</span>default<span class="token punctuation">,</span> Oct <span class="token number">26</span> <span class="token number">2021</span><span class="token punctuation">,</span> <span class="token number">06</span><span class="token punctuation">:</span><span class="token number">08</span><span class="token punctuation">:</span><span class="token number">21</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>GCC <span class="token number">9.4</span><span class="token number">.0</span><span class="token punctuation">]</span>
CUDA available<span class="token punctuation">:</span> <span class="token boolean">True</span>
numpy_random_seed<span class="token punctuation">:</span> <span class="token number">2147483648</span>
GPU <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">:</span> NVIDIA GeForce RTX <span class="token number">3090</span>
CUDA_HOME<span class="token punctuation">:</span> <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>cuda
NVCC<span class="token punctuation">:</span> Cuda compilation tools<span class="token punctuation">,</span> release <span class="token number">11.3</span><span class="token punctuation">,</span> V11<span class="token punctuation">.</span><span class="token number">3.109</span>
GCC<span class="token punctuation">:</span> gcc <span class="token punctuation">(</span>Ubuntu <span class="token number">7.5</span><span class="token number">.0</span><span class="token operator">-</span>6ubuntu2<span class="token punctuation">)</span> <span class="token number">7.5</span><span class="token number">.0</span>
PyTorch<span class="token punctuation">:</span> <span class="token number">1.8</span><span class="token number">.1</span><span class="token operator">+</span>cu111
PyTorch compiling details<span class="token punctuation">:</span> PyTorch built <span class="token keyword">with</span><span class="token punctuation">:</span>
  <span class="token operator">-</span> GCC <span class="token number">7.3</span>
  <span class="token operator">-</span> C<span class="token operator">+</span><span class="token operator">+</span> Version<span class="token punctuation">:</span> <span class="token number">201402</span>
  <span class="token operator">-</span> Intel<span class="token punctuation">(</span>R<span class="token punctuation">)</span> Math Kernel Library Version <span class="token number">2020.0</span><span class="token number">.0</span> Product Build <span class="token number">20191122</span> <span class="token keyword">for</span> Intel<span class="token punctuation">(</span>R<span class="token punctuation">)</span> <span class="token number">64</span> architecture applications
  <span class="token operator">-</span> Intel<span class="token punctuation">(</span>R<span class="token punctuation">)</span> MKL<span class="token operator">-</span>DNN v1<span class="token punctuation">.</span><span class="token number">7.0</span> <span class="token punctuation">(</span>Git Hash 7aed236906b1f7a05c0917e5257a1af05e9ff683<span class="token punctuation">)</span>
  <span class="token operator">-</span> OpenMP <span class="token number">201511</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>k<span class="token punctuation">.</span>a<span class="token punctuation">.</span> OpenMP <span class="token number">4.5</span><span class="token punctuation">)</span>
  <span class="token operator">-</span> NNPACK <span class="token keyword">is</span> enabled
  <span class="token operator">-</span> CPU capability usage<span class="token punctuation">:</span> AVX2
  <span class="token operator">-</span> CUDA Runtime <span class="token number">11.1</span>
  <span class="token operator">-</span> NVCC architecture flags<span class="token punctuation">:</span> <span class="token operator">-</span>gencode<span class="token punctuation">;</span>arch<span class="token operator">=</span>compute_37<span class="token punctuation">,</span>code<span class="token operator">=</span>sm_37<span class="token punctuation">;</span><span class="token operator">-</span>gencode<span class="token punctuation">;</span>arch<span class="token operator">=</span>compute_50<span class="token punctuation">,</span>code<span class="token operator">=</span>sm_50<span class="token punctuation">;</span><span class="token operator">-</span>gencode<span class="token punctuation">;</span>arch<span class="token operator">=</span>compute_60<span class="token punctuation">,</span>code<span class="token operator">=</span>sm_60<span class="token punctuation">;</span><span class="token operator">-</span>gencode<span class="token punctuation">;</span>arch<span class="token operator">=</span>compute_70<span class="token punctuation">,</span>code<span class="token operator">=</span>sm_70<span class="token punctuation">;</span><span class="token operator">-</span>gencode<span class="token punctuation">;</span>arch<span class="token operator">=</span>compute_75<span class="token punctuation">,</span>code<span class="token operator">=</span>sm_75<span class="token punctuation">;</span><span class="token operator">-</span>gencode<span class="token punctuation">;</span>arch<span class="token operator">=</span>compute_80<span class="token punctuation">,</span>code<span class="token operator">=</span>sm_80<span class="token punctuation">;</span><span class="token operator">-</span>gencode<span class="token punctuation">;</span>arch<span class="token operator">=</span>compute_86<span class="token punctuation">,</span>code<span class="token operator">=</span>sm_86
  <span class="token operator">-</span> CuDNN <span class="token number">8.0</span><span class="token number">.5</span>
  <span class="token operator">-</span> Magma <span class="token number">2.5</span><span class="token number">.2</span>
  <span class="token operator">-</span> Build settings<span class="token punctuation">:</span> BLAS_INFO<span class="token operator">=</span>mkl<span class="token punctuation">,</span> BUILD_TYPE<span class="token operator">=</span>Release<span class="token punctuation">,</span> CUDA_VERSION<span class="token operator">=</span><span class="token number">11.1</span><span class="token punctuation">,</span> CUDNN_VERSION<span class="token operator">=</span><span class="token number">8.0</span><span class="token number">.5</span><span class="token punctuation">,</span> CXX_COMPILER<span class="token operator">=</span><span class="token operator">/</span>opt<span class="token operator">/</span>rh<span class="token operator">/</span>devtoolset<span class="token operator">-</span><span class="token number">7</span><span class="token operator">/</span>root<span class="token operator">/</span>usr<span class="token operator">/</span><span class="token builtin">bin</span><span class="token operator">/</span>c<span class="token operator">+</span><span class="token operator">+</span><span class="token punctuation">,</span> CXX_FLAGS<span class="token operator">=</span> <span class="token operator">-</span>Wno<span class="token operator">-</span>deprecated <span class="token operator">-</span>fvisibility<span class="token operator">-</span>inlines<span class="token operator">-</span>hidden <span class="token operator">-</span>DUSE_PTHREADPOOL <span class="token operator">-</span>fopenmp <span class="token operator">-</span>DNDEBUG <span class="token operator">-</span>DUSE_KINETO <span class="token operator">-</span>DUSE_FBGEMM <span class="token operator">-</span>DUSE_QNNPACK <span class="token operator">-</span>DUSE_PYTORCH_QNNPACK <span class="token operator">-</span>DUSE_XNNPACK <span class="token operator">-</span>O2 <span class="token operator">-</span>fPIC <span class="token operator">-</span>Wno<span class="token operator">-</span>narrowing <span class="token operator">-</span>Wall <span class="token operator">-</span>Wextra <span class="token operator">-</span>Werror<span class="token operator">=</span><span class="token keyword">return</span><span class="token operator">-</span><span class="token builtin">type</span> <span class="token operator">-</span>Wno<span class="token operator">-</span>missing<span class="token operator">-</span>field<span class="token operator">-</span>initializers <span class="token operator">-</span>Wno<span class="token operator">-</span><span class="token builtin">type</span><span class="token operator">-</span>limits <span class="token operator">-</span>Wno<span class="token operator">-</span>array<span class="token operator">-</span>bounds <span class="token operator">-</span>Wno<span class="token operator">-</span>unknown<span class="token operator">-</span>pragmas <span class="token operator">-</span>Wno<span class="token operator">-</span>sign<span class="token operator">-</span>compare <span class="token operator">-</span>Wno<span class="token operator">-</span>unused<span class="token operator">-</span>parameter <span class="token operator">-</span>Wno<span class="token operator">-</span>unused<span class="token operator">-</span>variable <span class="token operator">-</span>Wno<span class="token operator">-</span>unused<span class="token operator">-</span>function <span class="token operator">-</span>Wno<span class="token operator">-</span>unused<span class="token operator">-</span>result <span class="token operator">-</span>Wno<span class="token operator">-</span>unused<span class="token operator">-</span>local<span class="token operator">-</span>typedefs <span class="token operator">-</span>Wno<span class="token operator">-</span>strict<span class="token operator">-</span>overflow <span class="token operator">-</span>Wno<span class="token operator">-</span>strict<span class="token operator">-</span>aliasing <span class="token operator">-</span>Wno<span class="token operator">-</span>error<span class="token operator">=</span>deprecated<span class="token operator">-</span>declarations <span class="token operator">-</span>Wno<span class="token operator">-</span>stringop<span class="token operator">-</span>overflow <span class="token operator">-</span>Wno<span class="token operator">-</span>psabi <span class="token operator">-</span>Wno<span class="token operator">-</span>error<span class="token operator">=</span>pedantic <span class="token operator">-</span>Wno<span class="token operator">-</span>error<span class="token operator">=</span>redundant<span class="token operator">-</span>decls <span class="token operator">-</span>Wno<span class="token operator">-</span>error<span class="token operator">=</span>old<span class="token operator">-</span>style<span class="token operator">-</span>cast <span class="token operator">-</span>fdiagnostics<span class="token operator">-</span>color<span class="token operator">=</span>always <span class="token operator">-</span>faligned<span class="token operator">-</span>new <span class="token operator">-</span>Wno<span class="token operator">-</span>unused<span class="token operator">-</span>but<span class="token operator">-</span><span class="token builtin">set</span><span class="token operator">-</span>variable <span class="token operator">-</span>Wno<span class="token operator">-</span>maybe<span class="token operator">-</span>uninitialized <span class="token operator">-</span>fno<span class="token operator">-</span>math<span class="token operator">-</span>errno <span class="token operator">-</span>fno<span class="token operator">-</span>trapping<span class="token operator">-</span>math <span class="token operator">-</span>Werror<span class="token operator">=</span><span class="token builtin">format</span> <span class="token operator">-</span>Wno<span class="token operator">-</span>stringop<span class="token operator">-</span>overflow<span class="token punctuation">,</span> LAPACK_INFO<span class="token operator">=</span>mkl<span class="token punctuation">,</span> PERF_WITH_AVX<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> PERF_WITH_AVX2<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> PERF_WITH_AVX512<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> TORCH_VERSION<span class="token operator">=</span><span class="token number">1.8</span><span class="token number">.1</span><span class="token punctuation">,</span> USE_CUDA<span class="token operator">=</span>ON<span class="token punctuation">,</span> USE_CUDNN<span class="token operator">=</span>ON<span class="token punctuation">,</span> USE_EXCEPTION_PTR<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> USE_GFLAGS<span class="token operator">=</span>OFF<span class="token punctuation">,</span> USE_GLOG<span class="token operator">=</span>OFF<span class="token punctuation">,</span> USE_MKL<span class="token operator">=</span>ON<span class="token punctuation">,</span> USE_MKLDNN<span class="token operator">=</span>ON<span class="token punctuation">,</span> USE_MPI<span class="token operator">=</span>OFF<span class="token punctuation">,</span> USE_NCCL<span class="token operator">=</span>ON<span class="token punctuation">,</span> USE_NNPACK<span class="token operator">=</span>ON<span class="token punctuation">,</span> USE_OPENMP<span class="token operator">=</span>ON<span class="token punctuation">,</span> 

TorchVision<span class="token punctuation">:</span> <span class="token number">0.9</span><span class="token number">.1</span><span class="token operator">+</span>cu111
OpenCV<span class="token punctuation">:</span> <span class="token number">4.6</span><span class="token number">.0</span>
MMEngine<span class="token punctuation">:</span> <span class="token number">0.9</span><span class="token number">.1</span>
MMDetection<span class="token punctuation">:</span> <span class="token number">3.2</span><span class="token number">.0</span>
MMDetection3D<span class="token punctuation">:</span> <span class="token number">1.3</span><span class="token number">.0</span><span class="token operator">+</span>9d3e162
spconv2<span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token boolean">True</span>

</code></pre> 
<p>以前写过mmdetection3d中的可视化，但mmdetection3d更新后代码已经不适用了，正好我把我的工作全转移到新版mmdetection3d上来了，因此重新写了一下推理结果可视化。整体思路还是构建模型、构建数据、推理、绘制，下面分步讲解</p> 
<h3><a id="1_39"></a>1、构建模型</h3> 
<p>我用jupyter实现，首先需要确保jupyter的工作路径在mmdetection3d的工作路径下，不然会存在找不到mmdet3d的问题</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> sys
<span class="token keyword">import</span> os
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> cv2
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

<span class="token comment"># 添加工作路径，不然找不到mmdet3d</span>
os<span class="token punctuation">.</span>chdir<span class="token punctuation">(</span><span class="token string">'/home/wistful/work/open_mmlab_mmdetection3d'</span><span class="token punctuation">)</span>
sys<span class="token punctuation">.</span>path<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">'/home/wistful/work/open_mmlab_mmdetection3d'</span><span class="token punctuation">)</span>


<span class="token comment"># load config</span>
config_file <span class="token operator">=</span> <span class="token string">'configs/point_cls_voxel/pointpillars_hv_secfpn_8x2-160e_kitti-3d-3class.py'</span>
checkpoint_file <span class="token operator">=</span> <span class="token string">'/home/wistful/work/open_mmlab_mmdetection3d/work_dirs/pointpillars_hv_secfpn_8x2-160e_kitti-3d-3class/epoch_80.pth'</span>

<span class="token comment"># 构建模型</span>
<span class="token keyword">from</span> mmdet3d<span class="token punctuation">.</span>apis <span class="token keyword">import</span> init_model<span class="token punctuation">,</span> inference_detector
device <span class="token operator">=</span> <span class="token string">'cuda:0'</span>
model <span class="token operator">=</span> init_model<span class="token punctuation">(</span>config_file<span class="token punctuation">,</span> checkpoint<span class="token operator">=</span>checkpoint_file<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>

</code></pre> 
<p>至此模型已经构建，下一步是构建数据，送入模型以获取推理结果</p> 
<h4><a id="2_68"></a>2、构建数据</h4> 
<p>新版mmdet3d的模型输入分为两个部分<code>batch_inputs_dict</code>, <code>batch_data_samples</code>。<code>batch_inputs_dict</code>包含了模型推理所需的数据（点云、图像），<code>batch_data_samples</code>包含了训练时需要的bbox等信息。因此，需要构建<code>batch_inputs_dict</code>，我写了一个简单的函数，可以调用</p> 
<p>build_dataloader.py文件：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> mmdet3d<span class="token punctuation">.</span>registry <span class="token keyword">import</span> DATASETS
<span class="token keyword">from</span> tools<span class="token punctuation">.</span>misc<span class="token punctuation">.</span>browse_dataset <span class="token keyword">import</span> build_data_cfg
<span class="token keyword">from</span> mmengine<span class="token punctuation">.</span>registry <span class="token keyword">import</span> init_default_scope


<span class="token keyword">def</span> <span class="token function">load_datasets</span><span class="token punctuation">(</span>config_file<span class="token punctuation">,</span> aug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token builtin">set</span><span class="token operator">=</span><span class="token string">'train'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Args:
        config_file: 配置文件路径
        aug:是否数据增强（待测试）
        set:要读取的数据集，'train','test','val'

    Returns:
    """</span>
    cfg <span class="token operator">=</span> build_data_cfg<span class="token punctuation">(</span>config_file<span class="token punctuation">,</span> aug<span class="token operator">=</span>aug<span class="token punctuation">,</span> cfg_options<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>
    init_default_scope<span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'default_scope'</span><span class="token punctuation">,</span> <span class="token string">'mmdet3d'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 选择需要读取的数据集</span>
    <span class="token keyword">if</span> <span class="token builtin">set</span> <span class="token operator">==</span> <span class="token string">'train'</span><span class="token punctuation">:</span>
        dataloader <span class="token operator">=</span> cfg<span class="token punctuation">.</span>train_dataloader<span class="token punctuation">.</span>dataset
    <span class="token keyword">elif</span> <span class="token builtin">set</span> <span class="token operator">==</span> <span class="token string">'val'</span><span class="token punctuation">:</span>
        dataloader <span class="token operator">=</span> cfg<span class="token punctuation">.</span>val_dataloader<span class="token punctuation">.</span>dataset
    <span class="token keyword">elif</span> <span class="token builtin">set</span> <span class="token operator">==</span> <span class="token string">'test'</span><span class="token punctuation">:</span>
        dataloader <span class="token operator">=</span> cfg<span class="token punctuation">.</span>test_dataloader<span class="token punctuation">.</span>dataset

    <span class="token keyword">return</span> DATASETS<span class="token punctuation">.</span>build<span class="token punctuation">(</span>dataloader<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">build_batch_dict</span><span class="token punctuation">(</span>datasets<span class="token punctuation">,</span> batch_size<span class="token punctuation">,</span> device<span class="token punctuation">,</span> images<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Args:
        device: 指定设备

        datasets: 传入数据集
        batch_size: 批次大小
        images: 加入图像

    Returns:

    """</span>
    <span class="token comment"># TODO: 编写加入图像的代码</span>
    points <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    images <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    batch_data_samples <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>batch_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 确保在同一个device上</span>
        points<span class="token punctuation">.</span>append<span class="token punctuation">(</span>datasets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'inputs'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'points'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span>

        data_samples <span class="token operator">=</span> datasets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'data_samples'</span><span class="token punctuation">]</span>
        <span class="token comment"># if data_samples.gt_instances_3d</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data_samples<span class="token punctuation">.</span>gt_instances_3d<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
            data_samples<span class="token punctuation">.</span>gt_instances_3d<span class="token punctuation">.</span>bboxes_3d <span class="token operator">=</span> data_samples<span class="token punctuation">.</span>gt_instances_3d<span class="token punctuation">.</span>bboxes_3d<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
            data_samples<span class="token punctuation">.</span>gt_instances_3d<span class="token punctuation">.</span>labels_3d <span class="token operator">=</span> data_samples<span class="token punctuation">.</span>gt_instances_3d<span class="token punctuation">.</span>labels_3d<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
    batch_inputs_dict <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    batch_inputs_dict<span class="token punctuation">[</span><span class="token string">'points'</span><span class="token punctuation">]</span> <span class="token operator">=</span> points

    <span class="token comment"># batch_data_samples = data_samples</span>
    <span class="token keyword">return</span> batch_inputs_dict<span class="token punctuation">,</span> batch_data_samples


<span class="token keyword">def</span> <span class="token function">cyclic_load_data_item</span><span class="token punctuation">(</span>datasets<span class="token punctuation">,</span> index<span class="token punctuation">,</span> device<span class="token punctuation">,</span> images<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Args:
        device: 指定设备
        datasets: 传入数据集
        index: 索引
        images: 加入图像

    Returns:
        单条数据，适用于循环遍历整个数据集
    """</span>
    <span class="token comment"># TODO: 编写加入图像的代码</span>
    points <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    images <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    points<span class="token punctuation">.</span>append<span class="token punctuation">(</span>datasets<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'inputs'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'points'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span>

    batch_inputs_dict <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    batch_inputs_dict<span class="token punctuation">[</span><span class="token string">'points'</span><span class="token punctuation">]</span> <span class="token operator">=</span> points

    data_samples <span class="token operator">=</span> datasets<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'data_samples'</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data_samples<span class="token punctuation">.</span>gt_instances_3d<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">:</span>
        data_samples<span class="token punctuation">.</span>gt_instances_3d<span class="token punctuation">.</span>bboxes_3d <span class="token operator">=</span> data_samples<span class="token punctuation">.</span>gt_instances_3d<span class="token punctuation">.</span>bboxes_3d<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        data_samples<span class="token punctuation">.</span>gt_instances_3d<span class="token punctuation">.</span>labels_3d <span class="token operator">=</span> data_samples<span class="token punctuation">.</span>gt_instances_3d<span class="token punctuation">.</span>labels_3d<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
    batch_data_samples <span class="token operator">=</span> <span class="token punctuation">[</span>data_samples<span class="token punctuation">]</span>
    <span class="token keyword">return</span> batch_inputs_dict<span class="token punctuation">,</span> batch_data_samples

</code></pre> 
<p>下面利用这个函数，实现构建数据集</p> 
<pre><code class="prism language-python"><span class="token comment"># 构建数据集</span>
<span class="token keyword">from</span> custom_API<span class="token punctuation">.</span>build_dataloader <span class="token keyword">import</span> load_datasets <span class="token comment"># 我放在了custom_API路径下，如何导入取决于读者如何存放</span>
 
<span class="token builtin">set</span> <span class="token operator">=</span> <span class="token string">'test'</span>

<span class="token comment"># set字段表示构建的数据集</span>
datasets <span class="token operator">=</span> load_datasets<span class="token punctuation">(</span>dataset_config<span class="token punctuation">,</span> aug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token builtin">set</span><span class="token operator">=</span><span class="token builtin">set</span><span class="token punctuation">)</span> <span class="token comment"># aug字段表示不使用数据增强</span>
</code></pre> 
<p>至此，datasets为一个列表，长度就是数据集的总样本数。eg:datasets[0]里面就包含了第1个样本的全部信息，下面可以看一下输出</p> 
<p><img src="https://images2.imgbox.com/67/32/gOxg052k_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3_178"></a>3、推理与绘制</h3> 
<p>我们已经得到了整个数据集，那么我们就可以使用数据集中的任意一条数据进行推理，根据这个思路，我们也能很方便的推理完整个数据集。绘制部分的代码我使用的是旧版mmdetection3d中的代码，下面是代码：</p> 
<pre><code class="prism language-python"><span class="token comment"># draw_box.py</span>
<span class="token keyword">import</span> os

<span class="token keyword">from</span> custom_API<span class="token punctuation">.</span>draw_utils <span class="token keyword">import</span> draw_lidar_bbox3d_on_img<span class="token punctuation">,</span> draw_depth_bbox3d_on_img<span class="token punctuation">,</span> draw_camera_bbox3d_on_img
<span class="token keyword">import</span> mmcv
<span class="token keyword">from</span> os <span class="token keyword">import</span> path <span class="token keyword">as</span> osp
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

<span class="token keyword">def</span> <span class="token function">show_multi_modality_result</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span>
                               gt_bboxes<span class="token punctuation">,</span>
                               pred_bboxes<span class="token punctuation">,</span>
                               batch_data_samples<span class="token punctuation">,</span>
                               out_dir<span class="token punctuation">,</span>
                               filename<span class="token punctuation">,</span>
                               <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'train'</span><span class="token punctuation">,</span>
                               box_mode<span class="token operator">=</span><span class="token string">'lidar'</span><span class="token punctuation">,</span>
                               img_metas<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                               show<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                               gt_bbox_color<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">61</span><span class="token punctuation">,</span> <span class="token number">102</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                               pred_bbox_color<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">241</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">72</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Convert multi-modality detection results into 2D results.
    将3D边框投影到2D图像平面并且可视化
    Project the predicted 3D bbox to 2D image plane and visualize them.

    Args:
        img (np.ndarray): The numpy array of image in cv2 fashion.
        gt_bboxes (:obj:`BaseInstance3DBoxes`): Ground truth boxes.
        pred_bboxes (:obj:`BaseInstance3DBoxes`): Predicted boxes.
        proj_mat (numpy.array, shape=[4, 4]): The projection matrix # 投影矩阵
            according to the camera intrinsic parameters.
        out_dir (str): Path of output directory.
        filename (str): Filename of the current frame.
        box_mode (str, optional): Coordinate system the boxes are in.
            Should be one of 'depth', 'lidar' and 'camera'.
            Defaults to 'lidar'.
        img_metas (dict, optional): Used in projecting depth bbox.
            Defaults to None.
        show (bool, optional): Visualize the results online. Defaults to False.
        颜色为B G R，不是RGB！！！
        gt_bbox_color (str or tuple(int), optional): Color of bbox lines.
           The tuple of color should be in BGR order. Default: (255, 102, 61).
        pred_bbox_color (str or tuple(int), optional): Color of bbox lines.
           The tuple of color should be in BGR order. Default: (72, 101, 241).
    """</span>
    <span class="token comment"># 根据传入3D框所处的坐标系调用对应的投影方法，获取投影框</span>
    <span class="token keyword">if</span> box_mode <span class="token operator">==</span> <span class="token string">'depth'</span><span class="token punctuation">:</span>
        draw_bbox <span class="token operator">=</span> draw_depth_bbox3d_on_img
    <span class="token keyword">elif</span> box_mode <span class="token operator">==</span> <span class="token string">'lidar'</span><span class="token punctuation">:</span>
        draw_bbox <span class="token operator">=</span> draw_lidar_bbox3d_on_img
    <span class="token keyword">elif</span> box_mode <span class="token operator">==</span> <span class="token string">'camera'</span><span class="token punctuation">:</span>
        draw_bbox <span class="token operator">=</span> draw_camera_bbox3d_on_img
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> NotImplementedError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'unsupported box mode </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>box_mode<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

    <span class="token comment"># 在out_dir下创建每个文件名字的文件夹</span>
    <span class="token comment"># result_path = osp.join(out_dir, filename)</span>
    <span class="token comment"># mmcv.mkdir_or_exist(result_path)</span>
    out_dir <span class="token operator">=</span> out_dir <span class="token operator">+</span> <span class="token builtin">type</span> <span class="token operator">+</span> <span class="token string">'/'</span>
    <span class="token comment"># 判断目录是否存在</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>out_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>out_dir<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>
        <span class="token comment"># os.makedirs(out_dir)</span>
    <span class="token comment"># mmcv.mkdir_or_exist(result_path)</span>

    <span class="token comment"># if score_thr &gt; 0:</span>
    <span class="token comment">#     inds = pred_scores &gt; score_thr</span>
    <span class="token comment">#     pred_bboxes = pred_bboxes[inds]</span>
    <span class="token comment"># 获取投影矩阵</span>
    proj_mat <span class="token operator">=</span> batch_data_samples<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lidar2img
    proj_mat <span class="token operator">=</span> proj_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    proj_mat <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>proj_mat<span class="token punctuation">)</span>
    <span class="token keyword">if</span> show<span class="token punctuation">:</span>
        show_img <span class="token operator">=</span> img<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> gt_bboxes <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            show_img <span class="token operator">=</span> draw_bbox<span class="token punctuation">(</span>
                gt_bboxes<span class="token punctuation">,</span> show_img<span class="token punctuation">,</span> proj_mat<span class="token punctuation">,</span> img_metas<span class="token punctuation">,</span> color<span class="token operator">=</span>gt_bbox_color<span class="token punctuation">)</span>
        <span class="token keyword">if</span> pred_bboxes <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            show_img <span class="token operator">=</span> draw_bbox<span class="token punctuation">(</span>
                pred_bboxes<span class="token punctuation">,</span>
                show_img<span class="token punctuation">,</span>
                proj_mat<span class="token punctuation">,</span>
                img_metas<span class="token punctuation">,</span>
                color<span class="token operator">=</span>pred_bbox_color<span class="token punctuation">)</span>
        mmcv<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>show_img<span class="token punctuation">,</span> win_name<span class="token operator">=</span><span class="token string">'project_bbox3d_img'</span><span class="token punctuation">,</span> wait_time<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> img <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token comment"># print('写入原图像')</span>
        mmcv<span class="token punctuation">.</span>imwrite<span class="token punctuation">(</span>img<span class="token punctuation">,</span> osp<span class="token punctuation">.</span>join<span class="token punctuation">(</span>out_dir<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>filename<span class="token punctuation">}</span></span><span class="token string">.png'</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> gt_bboxes <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token comment"># 写入地面真相</span>
        gt_img <span class="token operator">=</span> draw_bbox<span class="token punctuation">(</span>
            gt_bboxes<span class="token punctuation">,</span> img<span class="token punctuation">,</span> proj_mat<span class="token punctuation">,</span> img_metas<span class="token punctuation">,</span> color<span class="token operator">=</span>gt_bbox_color<span class="token punctuation">)</span>
        mmcv<span class="token punctuation">.</span>imwrite<span class="token punctuation">(</span>gt_img<span class="token punctuation">,</span> osp<span class="token punctuation">.</span>join<span class="token punctuation">(</span>out_dir<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>filename<span class="token punctuation">}</span></span><span class="token string">_gt.png'</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> pred_bboxes <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        pred_img <span class="token operator">=</span> draw_bbox<span class="token punctuation">(</span>
            pred_bboxes<span class="token punctuation">,</span> img<span class="token punctuation">,</span> proj_mat<span class="token punctuation">,</span> img_metas<span class="token punctuation">,</span> color<span class="token operator">=</span>pred_bbox_color<span class="token punctuation">)</span>
        mmcv<span class="token punctuation">.</span>imwrite<span class="token punctuation">(</span>pred_img<span class="token punctuation">,</span> osp<span class="token punctuation">.</span>join<span class="token punctuation">(</span>out_dir<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>filename<span class="token punctuation">}</span></span><span class="token string">_pred.png'</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> pred_bboxes <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">and</span> gt_bboxes <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token comment"># print('draw_gt_bbox')</span>
        gt_img <span class="token operator">=</span> draw_bbox<span class="token punctuation">(</span>
            gt_bboxes<span class="token punctuation">,</span> img<span class="token punctuation">,</span> proj_mat<span class="token punctuation">,</span> img_metas<span class="token punctuation">,</span> color<span class="token operator">=</span>gt_bbox_color<span class="token punctuation">)</span>
        gt_and_pred_img <span class="token operator">=</span> draw_bbox<span class="token punctuation">(</span>
            pred_bboxes<span class="token punctuation">,</span> gt_img<span class="token punctuation">,</span> proj_mat<span class="token punctuation">,</span> img_metas<span class="token punctuation">,</span> color<span class="token operator">=</span>pred_bbox_color<span class="token punctuation">)</span>
        mmcv<span class="token punctuation">.</span>imwrite<span class="token punctuation">(</span>gt_and_pred_img<span class="token punctuation">,</span> osp<span class="token punctuation">.</span>join<span class="token punctuation">(</span>out_dir<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>filename<span class="token punctuation">}</span></span><span class="token string">_pred_gt.png'</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># draw_utils.py</span>
<span class="token comment"># Copyright (c) OpenMMLab. All rights reserved.</span>
<span class="token keyword">import</span> copy

<span class="token keyword">import</span> cv2
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> torch
<span class="token keyword">from</span> matplotlib <span class="token keyword">import</span> pyplot <span class="token keyword">as</span> plt


<span class="token keyword">def</span> <span class="token function">project_pts_on_img</span><span class="token punctuation">(</span>points<span class="token punctuation">,</span>
                       raw_img<span class="token punctuation">,</span>
                       lidar2img_rt<span class="token punctuation">,</span>
                       max_distance<span class="token operator">=</span><span class="token number">70</span><span class="token punctuation">,</span>
                       thickness<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Project the 3D points cloud on 2D image.

    Args:
        points (numpy.array): 3D points cloud (x, y, z) to visualize.
        raw_img (numpy.array): The numpy array of image.
        lidar2img_rt (numpy.array, shape=[4, 4]): The projection matrix
            according to the camera intrinsic parameters.
        max_distance (float, optional): the max distance of the points cloud.
            Default: 70.
        thickness (int, optional): The thickness of 2D points. Default: -1.
    """</span>
    img <span class="token operator">=</span> raw_img<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    num_points <span class="token operator">=</span> points<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    pts_4d <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>points<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">(</span>num_points<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    pts_2d <span class="token operator">=</span> pts_4d @ lidar2img_rt<span class="token punctuation">.</span>T

    <span class="token comment"># cam_points is Tensor of Nx4 whose last column is 1</span>
    <span class="token comment"># transform camera coordinate to image coordinate</span>
    pts_2d<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>clip<span class="token punctuation">(</span>pts_2d<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a_min<span class="token operator">=</span><span class="token number">1e-5</span><span class="token punctuation">,</span> a_max<span class="token operator">=</span><span class="token number">99999</span><span class="token punctuation">)</span>
    pts_2d<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">/=</span> pts_2d<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
    pts_2d<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/=</span> pts_2d<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>

    fov_inds <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pts_2d<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token operator">&amp;</span> <span class="token punctuation">(</span>pts_2d<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token operator">&amp;</span> <span class="token punctuation">(</span>pts_2d<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token operator">&amp;</span> <span class="token punctuation">(</span>pts_2d<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    imgfov_pts_2d <span class="token operator">=</span> pts_2d<span class="token punctuation">[</span>fov_inds<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span>  <span class="token comment"># u, v, d</span>

    cmap <span class="token operator">=</span> plt<span class="token punctuation">.</span>cm<span class="token punctuation">.</span>get_cmap<span class="token punctuation">(</span><span class="token string">'hsv'</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>
    cmap <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>cmap<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">255</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>imgfov_pts_2d<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        depth <span class="token operator">=</span> imgfov_pts_2d<span class="token punctuation">[</span>i<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
        color <span class="token operator">=</span> cmap<span class="token punctuation">[</span>np<span class="token punctuation">.</span>clip<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>max_distance <span class="token operator">*</span> <span class="token number">10</span> <span class="token operator">/</span> depth<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>
        cv2<span class="token punctuation">.</span>circle<span class="token punctuation">(</span>
            img<span class="token punctuation">,</span>
            center<span class="token operator">=</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>imgfov_pts_2d<span class="token punctuation">[</span>i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token builtin">int</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>imgfov_pts_2d<span class="token punctuation">[</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            radius<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
            color<span class="token operator">=</span><span class="token builtin">tuple</span><span class="token punctuation">(</span>color<span class="token punctuation">)</span><span class="token punctuation">,</span>
            thickness<span class="token operator">=</span>thickness<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">'project_pts_img'</span><span class="token punctuation">,</span> img<span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span><span class="token punctuation">)</span>

    cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">plot_rect3d_on_img</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span>
                       num_rects<span class="token punctuation">,</span>
                       rect_corners<span class="token punctuation">,</span>
                       color<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                       thickness<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Plot the boundary lines of 3D rectangular on 2D images.

    Args:
        img (numpy.array): The numpy array of image.
        num_rects (int): Number of 3D rectangulars.
        rect_corners (numpy.array): Coordinates of the corners of 3D
            rectangulars. Should be in the shape of [num_rect, 8, 2].
        color (tuple[int], optional): The color to draw bboxes.
            Default: (0, 255, 0).
        thickness (int, optional): The thickness of bboxes. Default: 1.
    """</span>
    line_indices <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># thickness = 0.5</span>
    <span class="token comment"># print('rect_corners type:', rect_corners.dtype)</span>
    <span class="token comment"># print('img type',type(img))</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_rects<span class="token punctuation">)</span><span class="token punctuation">:</span>
        corners <span class="token operator">=</span> rect_corners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>
        <span class="token comment"># print("opencv corners type:", corners.dtype)</span>

        <span class="token keyword">for</span> start<span class="token punctuation">,</span> end <span class="token keyword">in</span> line_indices<span class="token punctuation">:</span>
            <span class="token comment"># cv2.line(img, (corners[start, 0], corners[start, 1]),</span>
            <span class="token comment">#          (corners[end, 0], corners[end, 1]), color, thickness,</span>
            <span class="token comment">#          cv2.LINE_AA)</span>
            <span class="token comment"># print("change:", type(int(corners[start, 0])))</span>
            cv2<span class="token punctuation">.</span>line<span class="token punctuation">(</span>img<span class="token punctuation">,</span>
                     <span class="token builtin">tuple</span><span class="token punctuation">(</span>corners<span class="token punctuation">[</span>start<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                     <span class="token builtin">tuple</span><span class="token punctuation">(</span>corners<span class="token punctuation">[</span>end<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                     color<span class="token punctuation">,</span>
                     thickness<span class="token punctuation">,</span>
                     cv2<span class="token punctuation">.</span>LINE_AA<span class="token punctuation">)</span>
            <span class="token comment"># cv2.line(img,</span>
            <span class="token comment">#          (int(corners[start, 0]), int(corners[start, 1])),</span>
            <span class="token comment">#          (int(corners[end, 0]), int(corners[end, 1])),</span>
            <span class="token comment">#          color,</span>
            <span class="token comment">#          thickness,</span>
            <span class="token comment">#          cv2.LINE_AA)</span>

    <span class="token comment"># return img.astype(np.uint8)</span>
    <span class="token keyword">return</span> img


<span class="token keyword">def</span> <span class="token function">draw_lidar_bbox3d_on_img</span><span class="token punctuation">(</span>bboxes3d<span class="token punctuation">,</span>
                             raw_img<span class="token punctuation">,</span>
                             lidar2img_rt<span class="token punctuation">,</span>
                             img_metas<span class="token punctuation">,</span>
                             color<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                             thickness<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Project the 3D bbox on 2D plane and draw on input image.

    Args:
        bboxes3d (:obj:`LiDARInstance3DBoxes`):
            3d bbox in lidar coordinate system to visualize.
        raw_img (numpy.array): The numpy array of image.
        lidar2img_rt (numpy.array, shape=[4, 4]): The projection matrix
            according to the camera intrinsic parameters.
        img_metas (dict): Useless here.
        color (tuple[int], optional): The color to draw bboxes.
            Default: (0, 255, 0).
        thickness (int, optional): The thickness of bboxes. Default: 1.
    """</span>
    img <span class="token operator">=</span> raw_img<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    corners_3d <span class="token operator">=</span> bboxes3d<span class="token punctuation">.</span>corners<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    num_bbox <span class="token operator">=</span> corners_3d<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    pts_4d <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span>
        <span class="token punctuation">[</span>corners_3d<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
         np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">(</span>num_bbox <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    lidar2img_rt <span class="token operator">=</span> copy<span class="token punctuation">.</span>deepcopy<span class="token punctuation">(</span>lidar2img_rt<span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>lidar2img_rt<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">)</span><span class="token punctuation">:</span>
        lidar2img_rt <span class="token operator">=</span> lidar2img_rt<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    pts_2d <span class="token operator">=</span> pts_4d @ lidar2img_rt<span class="token punctuation">.</span>T

    pts_2d<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>clip<span class="token punctuation">(</span>pts_2d<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a_min<span class="token operator">=</span><span class="token number">1e-5</span><span class="token punctuation">,</span> a_max<span class="token operator">=</span><span class="token number">1e5</span><span class="token punctuation">)</span>
    pts_2d<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">/=</span> pts_2d<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
    pts_2d<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/=</span> pts_2d<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
    imgfov_pts_2d <span class="token operator">=</span> pts_2d<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>num_bbox<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> plot_rect3d_on_img<span class="token punctuation">(</span>img<span class="token punctuation">,</span> num_bbox<span class="token punctuation">,</span> imgfov_pts_2d<span class="token punctuation">,</span> color<span class="token punctuation">,</span> thickness<span class="token punctuation">)</span>


<span class="token comment"># TODO: remove third parameter in all functions here in favour of img_metas</span>
<span class="token keyword">def</span> <span class="token function">draw_depth_bbox3d_on_img</span><span class="token punctuation">(</span>bboxes3d<span class="token punctuation">,</span>
                             raw_img<span class="token punctuation">,</span>
                             calibs<span class="token punctuation">,</span>
                             img_metas<span class="token punctuation">,</span>
                             color<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                             thickness<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Project the 3D bbox on 2D plane and draw on input image.

    Args:
        bboxes3d (:obj:`DepthInstance3DBoxes`, shape=[M, 7]):
            3d bbox in depth coordinate system to visualize.
        raw_img (numpy.array): The numpy array of image.
        calibs (dict): Camera calibration information, Rt and K.
        img_metas (dict): Used in coordinates transformation.
        color (tuple[int], optional): The color to draw bboxes.
            Default: (0, 255, 0).
        thickness (int, optional): The thickness of bboxes. Default: 1.
    """</span>
    <span class="token keyword">from</span> mmdet3d<span class="token punctuation">.</span>structures <span class="token keyword">import</span> points_cam2img
    <span class="token keyword">from</span> mmdet3d<span class="token punctuation">.</span>models <span class="token keyword">import</span> apply_3d_transformation

    img <span class="token operator">=</span> raw_img<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    img_metas <span class="token operator">=</span> copy<span class="token punctuation">.</span>deepcopy<span class="token punctuation">(</span>img_metas<span class="token punctuation">)</span>
    corners_3d <span class="token operator">=</span> bboxes3d<span class="token punctuation">.</span>corners
    num_bbox <span class="token operator">=</span> corners_3d<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    points_3d <span class="token operator">=</span> corners_3d<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>

    <span class="token comment"># first reverse the data transformations</span>
    xyz_depth <span class="token operator">=</span> apply_3d_transformation<span class="token punctuation">(</span>
        points_3d<span class="token punctuation">,</span> <span class="token string">'DEPTH'</span><span class="token punctuation">,</span> img_metas<span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token comment"># project to 2d to get image coords (uv)</span>
    uv_origin <span class="token operator">=</span> points_cam2img<span class="token punctuation">(</span>xyz_depth<span class="token punctuation">,</span>
                               xyz_depth<span class="token punctuation">.</span>new_tensor<span class="token punctuation">(</span>img_metas<span class="token punctuation">[</span><span class="token string">'depth2img'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    uv_origin <span class="token operator">=</span> <span class="token punctuation">(</span>uv_origin <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    imgfov_pts_2d <span class="token operator">=</span> uv_origin<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>num_bbox<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> plot_rect3d_on_img<span class="token punctuation">(</span>img<span class="token punctuation">,</span> num_bbox<span class="token punctuation">,</span> imgfov_pts_2d<span class="token punctuation">,</span> color<span class="token punctuation">,</span> thickness<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">draw_camera_bbox3d_on_img</span><span class="token punctuation">(</span>bboxes3d<span class="token punctuation">,</span>
                              raw_img<span class="token punctuation">,</span>
                              cam2img<span class="token punctuation">,</span>
                              img_metas<span class="token punctuation">,</span>
                              color<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                              thickness<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Project the 3D bbox on 2D plane and draw on input image.

    Args:
        bboxes3d (:obj:`CameraInstance3DBoxes`, shape=[M, 7]):
            3d bbox in camera coordinate system to visualize.
        raw_img (numpy.array): The numpy array of image.
        cam2img (dict): Camera intrinsic matrix,
            denoted as `K` in depth bbox coordinate system.
        img_metas (dict): Useless here.
        color (tuple[int], optional): The color to draw bboxes.
            Default: (0, 255, 0).
        thickness (int, optional): The thickness of bboxes. Default: 1.
    """</span>
    <span class="token keyword">from</span> mmdet3d<span class="token punctuation">.</span>structures <span class="token keyword">import</span> points_cam2img

    img <span class="token operator">=</span> raw_img<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    cam2img <span class="token operator">=</span> copy<span class="token punctuation">.</span>deepcopy<span class="token punctuation">(</span>cam2img<span class="token punctuation">)</span>
    corners_3d <span class="token operator">=</span> bboxes3d<span class="token punctuation">.</span>corners
    num_bbox <span class="token operator">=</span> corners_3d<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    points_3d <span class="token operator">=</span> corners_3d<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>cam2img<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">)</span><span class="token punctuation">:</span>
        cam2img <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>cam2img<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">assert</span> <span class="token punctuation">(</span>cam2img<span class="token punctuation">.</span>shape <span class="token operator">==</span> torch<span class="token punctuation">.</span>Size<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">or</span> cam2img<span class="token punctuation">.</span>shape <span class="token operator">==</span> torch<span class="token punctuation">.</span>Size<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    cam2img <span class="token operator">=</span> cam2img<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># project to 2d to get image coords (uv)</span>
    uv_origin <span class="token operator">=</span> points_cam2img<span class="token punctuation">(</span>points_3d<span class="token punctuation">,</span> cam2img<span class="token punctuation">)</span>
    uv_origin <span class="token operator">=</span> <span class="token punctuation">(</span>uv_origin <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    imgfov_pts_2d <span class="token operator">=</span> uv_origin<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>num_bbox<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> plot_rect3d_on_img<span class="token punctuation">(</span>img<span class="token punctuation">,</span> num_bbox<span class="token punctuation">,</span> imgfov_pts_2d<span class="token punctuation">,</span> color<span class="token punctuation">,</span> thickness<span class="token punctuation">)</span>

</code></pre> 
<p>下面是推理和绘制的完整代码，必要的注释已经给出。</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> custom_API<span class="token punctuation">.</span>draw_box <span class="token keyword">import</span> show_multi_modality_result <span class="token comment">#如何导入取决于读者如何存放</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'datasets length:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>datasets<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
data_root <span class="token operator">=</span> <span class="token string">'data/kitti/'</span> <span class="token comment"># 数据集根路径</span>
save_root <span class="token operator">=</span> <span class="token string">'/home/wistful/work/open_mmlab_mmdetection3d/visual_dir/predict_imgs/'</span> <span class="token comment"># 保存可视化结果的根路径</span>

data_num <span class="token operator">=</span> <span class="token number">100</span>  <span class="token comment"># 最大不能超过数据集长度</span>
<span class="token comment"># 判断一开始是读取的哪个数据集</span>
<span class="token keyword">if</span> <span class="token builtin">set</span> <span class="token operator">==</span> <span class="token string">'train'</span> <span class="token keyword">or</span> <span class="token builtin">set</span> <span class="token operator">==</span> <span class="token string">'val'</span><span class="token punctuation">:</span>
    new_set <span class="token operator">=</span> <span class="token string">'training'</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    new_set <span class="token operator">=</span> <span class="token string">'testing'</span>
<span class="token comment"># 推理整个数据集的前data_num条数据</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> tqdm<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>data_num<span class="token punctuation">)</span><span class="token punctuation">,</span> desc<span class="token operator">=</span><span class="token string">'process situation'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># cyclic_load_data_item代码位于第2步</span>
    batch_inputs_dict<span class="token punctuation">,</span> batch_data_samples <span class="token operator">=</span> cyclic_load_data_item<span class="token punctuation">(</span>datasets<span class="token punctuation">,</span> index<span class="token operator">=</span>i<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>  <span class="token comment"># 读取一条数据，并构建批次</span>
    points <span class="token operator">=</span> batch_inputs_dict<span class="token punctuation">[</span><span class="token string">'points'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># 获取点云，因为是单条数据，所以直接取0</span>

    <span class="token comment"># 获取检测结果</span>
    result<span class="token punctuation">,</span> data <span class="token operator">=</span> inference_detector<span class="token punctuation">(</span>model<span class="token punctuation">,</span> points<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    bboxes_3d <span class="token operator">=</span> result<span class="token punctuation">.</span>pred_instances_3d<span class="token punctuation">.</span>bboxes_3d
    labels_3d <span class="token operator">=</span> result<span class="token punctuation">.</span>pred_instances_3d<span class="token punctuation">.</span>labels_3d
    scores_3d <span class="token operator">=</span> result<span class="token punctuation">.</span>pred_instances_3d<span class="token punctuation">.</span>scores_3d

    <span class="token comment"># 设置阈值</span>
    thr <span class="token operator">=</span> <span class="token number">0.4</span>
    score <span class="token operator">=</span> <span class="token punctuation">(</span>scores_3d <span class="token operator">&gt;</span> thr<span class="token punctuation">)</span>
    bboxes_3d <span class="token operator">=</span> bboxes_3d<span class="token punctuation">[</span>score<span class="token punctuation">]</span> <span class="token comment"># 根据阈值筛选</span>

    <span class="token comment"># 读取原始图像</span>
    img_file_path <span class="token operator">=</span> data_root <span class="token operator">+</span> new_set <span class="token operator">+</span> <span class="token string">'/image_2/'</span> <span class="token operator">+</span> batch_data_samples<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>img_path<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>img_file_path<span class="token punctuation">)</span>

    img_name <span class="token operator">=</span> batch_data_samples<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>img_path<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment"># 取一下文件名</span>
    <span class="token comment"># 保存多模态结果（调用的旧版mmdet代码接口）</span>
    show_multi_modality_result<span class="token punctuation">(</span>img<span class="token operator">=</span>image<span class="token punctuation">,</span>
                               box_mode<span class="token operator">=</span><span class="token string">'lidar'</span><span class="token punctuation">,</span>
                               gt_bboxes<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                               pred_bboxes<span class="token operator">=</span>bboxes_3d<span class="token punctuation">,</span>
                               batch_data_samples<span class="token operator">=</span>batch_data_samples<span class="token punctuation">,</span>
                               out_dir<span class="token operator">=</span>save_root<span class="token punctuation">,</span>
                               filename<span class="token operator">=</span>img_name<span class="token punctuation">,</span>
                               <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">set</span><span class="token punctuation">,</span>
                               show<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

    <span class="token comment"># result = model(batch_inputs_dict, batch_data_samples) # model的输入与具体模型有关</span>
</code></pre> 
<p>运行上述代码后，会在设置的save_root下生成可视化图片<br> <img src="https://images2.imgbox.com/ad/fa/dokzXCCF_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/28/68/PQmN5VTS_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2ae28844b5fa4d279ae411d06a287d34/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Linux——定时清空日志内容和删除日志文件</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/58d3ec3487b398d4f73862a158e4d1c7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【S029】FPGA动态重配置ICAPE2以及双引导功能实现</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>