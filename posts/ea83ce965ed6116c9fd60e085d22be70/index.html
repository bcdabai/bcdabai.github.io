<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>vue服务端渲染SSR - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="vue服务端渲染SSR" />
<meta property="og:description" content="一：ssr的理解
1、服务端渲染 Server Side Render
SSR解决方案，后端渲染出完整的首屏的dom结构返回，前端拿到的内容包括首屏及完整spa结构，应用激活后依然按照spa方式运行，这种页面渲染方式被称为服务端渲染 (server side render)
二：Vue SSR实战
1、新建工程
vue-cli创建工程即可
vue create ssr 2、安装依赖
npm install vue vue-server-renderer express -D 3、启动脚本
创建一个express服务器，将vue ssr集成进来，./server/02-simple-ssr.js
// 导入express作为渲染服务器 const express = require(&#34;express&#34;); // 导入Vue用于声明待渲染实例 const Vue = require(&#34;vue&#34;); // 导入createRenderer用于获取渲染器 const { createRenderer } = require(&#34;vue-server-renderer&#34;); // 创建express实例 const app = express(); // 获取渲染器 const renderer = createRenderer(); // 待渲染vue实例 const vm = new Vue({ data: { name: &#34;开课吧&#34; }, template: ` &lt;div &gt; &lt;h1&gt;{{name}}&lt;/h1&gt; &lt;/div&gt; ` }); app." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/ea83ce965ed6116c9fd60e085d22be70/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-20T10:21:20+08:00" />
<meta property="article:modified_time" content="2023-06-20T10:21:20+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">vue服务端渲染SSR</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><strong>一：ssr的理解</strong><br> 1、服务端渲染 Server Side Render<br> SSR解决方案，后端渲染出完整的首屏的dom结构返回，前端拿到的内容包括首屏及完整spa结构，应用激活后依然按照spa方式运行，这种页面渲染方式被称为服务端渲染 (server side render)<br> <img src="https://images2.imgbox.com/47/5a/Lwmj2GEW_o.png" alt="在这里插入图片描述"><br> <strong>二：Vue SSR实战</strong><br> 1、新建工程<br> vue-cli创建工程即可</p> 
<pre><code class="prism language-bash">vue create ssr
</code></pre> 
<p>2、安装依赖</p> 
<pre><code class="prism language-bash"><span class="token function">npm</span> <span class="token function">install</span> vue vue-server-renderer express -D
</code></pre> 
<p>3、启动脚本<br> 创建一个express服务器，将vue ssr集成进来，./server/02-simple-ssr.js</p> 
<pre><code class="prism language-bash">// 导入express作为渲染服务器
const express <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">"express"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
// 导入Vue用于声明待渲染实例
const Vue <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">"vue"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
// 导入createRenderer用于获取渲染器
const <span class="token punctuation">{<!-- --></span> createRenderer <span class="token punctuation">}</span> <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">"vue-server-renderer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
// 创建express实例
const app <span class="token operator">=</span> express<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
// 获取渲染器
const renderer <span class="token operator">=</span> createRenderer<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
// 待渲染vue实例
const vm <span class="token operator">=</span> new Vue<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
 data: <span class="token punctuation">{<!-- --></span>
  name: <span class="token string">"开课吧"</span>
<span class="token punctuation">}</span>,
 template: <span class="token variable"><span class="token variable">`</span>
  <span class="token operator">&lt;</span>div <span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>name<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>
  <span class="token operator">&lt;</span>/div<span class="token operator">&gt;</span>
 <span class="token variable">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app.get<span class="token punctuation">(</span><span class="token string">"/"</span>, async function<span class="token punctuation">(</span>req, res<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 // renderToString可以将vue实例转换为html字符串
 // 若未传递回调函数，则返回Promise
 try <span class="token punctuation">{<!-- --></span>
  const html <span class="token operator">=</span> await renderer.renderToString<span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
  res.send<span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> catch <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  res.status<span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>.send<span class="token punctuation">(</span><span class="token string">"Internal Server Error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app.listen<span class="token punctuation">(</span><span class="token number">3000</span>, <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
 // eslint-disable-next-line no-console
 console.log<span class="token punctuation">(</span><span class="token string">"启动成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>三：路由</strong><br> 路由支持仍然使用vue-router<br> 1、安装<br> 若未引入vue-router则需要安装</p> 
<pre><code class="prism language-bash"><span class="token function">npm</span> i vue-router -s
vue <span class="token function">add</span> router
</code></pre> 
<p>2、配置<br> 创建@/router/index.js</p> 
<pre><code class="prism language-bash"><span class="token function">import</span> Vue from <span class="token string">"vue"</span><span class="token punctuation">;</span>
<span class="token function">import</span> Router from <span class="token string">"vue-router"</span><span class="token punctuation">;</span>
<span class="token function">import</span> Home from <span class="token string">"@/views/Home"</span><span class="token punctuation">;</span>
<span class="token function">import</span> About from <span class="token string">"@/views/About"</span><span class="token punctuation">;</span>
Vue.use<span class="token punctuation">(</span>Router<span class="token punctuation">)</span><span class="token punctuation">;</span>
//导出工厂函数
<span class="token builtin class-name">export</span> <span class="token keyword">function</span> <span class="token function-name function">createRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token builtin class-name">return</span> new Router<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  routes: <span class="token punctuation">[</span>
  <span class="token punctuation">{<!-- --></span> path: <span class="token string">"/"</span>, component: Home <span class="token punctuation">}</span>,
  <span class="token punctuation">{<!-- --></span> path: <span class="token string">"/about"</span>, component: About <span class="token punctuation">}</span>
 <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>四：构建</strong><br> 对于客户端应用程序和服务器应用程序，我们都要使用 webpack 打包 - 服务器需要服务器 bundle然后用于服务器端渲染(SSR)，而客户端 bundle会发送给浏览器，用于混合静态标记。<br> 1、构建流程<br> <img src="https://images2.imgbox.com/9d/1b/bJJYtufN_o.png" alt="在这里插入图片描述"><br> 2、代码结构</p> 
<pre><code class="prism language-bash">src
├── main.js <span class="token comment"># 用于创建vue实例</span>
├── entry-client.js <span class="token comment"># 客户端入口，用于静态内容“激活”</span>
└── entry-server.js <span class="token comment"># 服务端入口，用于首屏内容渲染</span>
</code></pre> 
<p>3、Vue实例创建<br> main.js 是负责创建vue实例，每次请求均会有独立的vue实例创建。创建main.js：</p> 
<pre><code class="prism language-bash"><span class="token function">import</span> Vue from <span class="token string">"vue"</span><span class="token punctuation">;</span>
<span class="token function">import</span> App from <span class="token string">"./App.vue"</span><span class="token punctuation">;</span>
<span class="token function">import</span> <span class="token punctuation">{<!-- --></span> createRouter <span class="token punctuation">}</span> from <span class="token string">"./router"</span><span class="token punctuation">;</span>
// 导出Vue实例工厂函数，为每次请求创建独立实例
// 上下文用于给vue实例传递参数
<span class="token builtin class-name">export</span> <span class="token keyword">function</span> createApp<span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 const router <span class="token operator">=</span> createRouter<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 const app <span class="token operator">=</span> new Vue<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  router,
  context,
  render: h <span class="token operator">=</span><span class="token operator">&gt;</span> h<span class="token punctuation">(</span>App<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token builtin class-name">return</span> <span class="token punctuation">{<!-- --></span> app, router <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>4、服务端入口<br> 服务端入口文件src/entry-server.js</p> 
<pre><code class="prism language-bash"><span class="token function">import</span> <span class="token punctuation">{<!-- --></span> createApp <span class="token punctuation">}</span> from <span class="token string">"./main"</span><span class="token punctuation">;</span>
// 返回一个函数，接收请求上下文，返回创建的vue实例
<span class="token builtin class-name">export</span> default context <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
 // 这里返回一个Promise，确保路由或组件准备就绪
 <span class="token builtin class-name">return</span> new Promise<span class="token punctuation">((</span>resolve, reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
  const <span class="token punctuation">{<!-- --></span> app, router <span class="token punctuation">}</span> <span class="token operator">=</span> createApp<span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  // 跳转到首屏的地址
  router.push<span class="token punctuation">(</span>context.url<span class="token punctuation">)</span><span class="token punctuation">;</span>
  // 路由就绪，返回结果
  router.onReady<span class="token punctuation">((</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
   resolve<span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>, reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>5、客户端入口<br> 客户端入口只需创建vue实例并执行挂载，这一步称为激活。创建entry-client.js：</p> 
<pre><code class="prism language-bash"><span class="token function">import</span> <span class="token punctuation">{<!-- --></span> createApp <span class="token punctuation">}</span> from <span class="token string">"./main"</span><span class="token punctuation">;</span>
// 创建vue、router实例
const <span class="token punctuation">{<!-- --></span> app, router <span class="token punctuation">}</span> <span class="token operator">=</span> createApp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
// 路由就绪，执行挂载
router.onReady<span class="token punctuation">((</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
 app.<span class="token variable">$mount</span><span class="token punctuation">(</span><span class="token string">"#app"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>6、webpack配置<br> 安装依赖</p> 
<pre><code class="prism language-bash"><span class="token function">npm</span> <span class="token function">install</span> webpack-node-externals lodash.merge -D
</code></pre> 
<p>具体配置，vue.config.js</p> 
<pre><code class="prism language-bash">// 两个插件分别负责打包客户端和服务端
const VueSSRServerPlugin <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">"vue-server-renderer/server-plugin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
const VueSSRClientPlugin <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">"vue-server-renderer/client-plugin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
const nodeExternals <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">"webpack-node-externals"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
const merge <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">"lodash.merge"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
// 根据传入环境变量决定入口文件和相应配置项
const TARGET_NODE <span class="token operator">=</span> process.env.WEBPACK_TARGET <span class="token operator">==</span><span class="token operator">=</span> <span class="token string">"node"</span><span class="token punctuation">;</span>
const target <span class="token operator">=</span> TARGET_NODE ? <span class="token string">"server"</span> <span class="token builtin class-name">:</span> <span class="token string">"client"</span><span class="token punctuation">;</span>
module.exports <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
 css: <span class="token punctuation">{<!-- --></span>
  extract: <span class="token boolean">false</span>
<span class="token punctuation">}</span>,
 outputDir: <span class="token string">'./dist/'</span>+target,
 configureWebpack: <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  // 将 entry 指向应用程序的 server / client 文件
  entry: <span class="token variable"><span class="token variable">`</span>./src/entry-$<span class="token punctuation">{<!-- --></span>target<span class="token punctuation">}</span>.js<span class="token variable">`</span></span>,
  // 对 bundle renderer 提供 <span class="token builtin class-name">source</span> map 支持
  devtool: <span class="token string">'source-map'</span>,
  // target设置为node使webpack以Node适用的方式处理动态导入，
  // 并且还会在编译Vue组件时告知<span class="token variable"><span class="token variable">`</span>vue-loader<span class="token variable">`</span></span>输出面向服务器代码。
  target: TARGET_NODE ? <span class="token string">"node"</span> <span class="token builtin class-name">:</span> <span class="token string">"web"</span>,
  // 是否模拟node全局变量
  node: TARGET_NODE ? undefined <span class="token builtin class-name">:</span> false,
  output: <span class="token punctuation">{<!-- --></span>
   // 此处使用Node风格导出模块
   libraryTarget: TARGET_NODE ? <span class="token string">"commonjs2"</span> <span class="token builtin class-name">:</span> undefined
 <span class="token punctuation">}</span>,
  // https://webpack.js.org/configuration/externals/<span class="token comment">#function</span>
  // https://github.com/liady/webpack-node-externals
  // 外置化应用程序依赖模块。可以使服务器构建速度更快，并生成较小的打包文件。
  externals: TARGET_NODE
   ? nodeExternals<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
     // 不要外置化webpack需要处理的依赖模块。
     // 可以在这里添加更多的文件类型。例如，未处理 *.vue 原始文件，
     // 还应该将修改<span class="token variable"><span class="token variable">`</span>global<span class="token variable">`</span></span>（例如polyfill）的依赖模块列入白名单
     whitelist: <span class="token punctuation">[</span>/<span class="token punctuation">\</span>.css$/<span class="token punctuation">]</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token builtin class-name">:</span> undefined,
  optimization: <span class="token punctuation">{<!-- --></span>
   splitChunks: undefined
 <span class="token punctuation">}</span>,
  // 这是将服务器的整个输出构建为单个 JSON 文件的插件。
  // 服务端默认文件名为 <span class="token variable"><span class="token variable">`</span>vue-ssr-server-bundle.json<span class="token variable">`</span></span>
  // 客户端默认文件名为 <span class="token variable"><span class="token variable">`</span>vue-ssr-client-manifest.json<span class="token variable">`</span></span>。
  plugins: <span class="token punctuation">[</span>TARGET_NODE ? new VueSSRServerPlugin<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin class-name">:</span> new VueSSRClientPlugin<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>,
 chainWebpack: config <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
  // cli4项目添加
  <span class="token keyword">if</span> <span class="token punctuation">(</span>TARGET_NODE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    config.optimization.delete<span class="token punctuation">(</span><span class="token string">'splitChunks'</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
  
  config.module
  .rule<span class="token punctuation">(</span><span class="token string">"vue"</span><span class="token punctuation">)</span>
  .use<span class="token punctuation">(</span><span class="token string">"vue-loader"</span><span class="token punctuation">)</span>
  .tap<span class="token punctuation">(</span>options <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
    merge<span class="token punctuation">(</span>options, <span class="token punctuation">{<!-- --></span>
     optimizeSSR: <span class="token boolean">false</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>7、脚本配置<br> 安装依赖</p> 
<pre><code class="prism language-bash"><span class="token function">npm</span> i cross-env -D
</code></pre> 
<p>定义创建脚本，package.json</p> 
<pre><code class="prism language-bash"><span class="token string">"scripts"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
  <span class="token string">"build:client"</span><span class="token builtin class-name">:</span> <span class="token string">"vue-cli-service build"</span>,
  <span class="token string">"build:server"</span><span class="token builtin class-name">:</span> <span class="token string">"cross-env WEBPACK_TARGET=node vue-cli-service build"</span>,
  <span class="token string">"build"</span><span class="token builtin class-name">:</span> <span class="token string">"npm run build:server &amp;&amp; npm run build:client"</span>
<span class="token punctuation">}</span>,
</code></pre> 
<blockquote> 
 <p>执行打包：npm run build</p> 
</blockquote> 
<p>8、宿主文件<br> 最后需要定义宿主文件，修改./public/index.html</p> 
<pre><code class="prism language-bash"><span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html <span class="token assign-left variable">lang</span><span class="token operator">=</span><span class="token string">"en"</span><span class="token operator">&gt;</span>
 <span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>meta <span class="token assign-left variable">charset</span><span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>meta http-equiv<span class="token operator">=</span><span class="token string">"X-UA-Compatible"</span> <span class="token assign-left variable">content</span><span class="token operator">=</span><span class="token string">"IE=edge"</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>meta <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token string">"viewport"</span> <span class="token assign-left variable">content</span><span class="token operator">=</span><span class="token string">"width=device-width,initial-scale=1.0"</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>Document<span class="token operator">&lt;</span>/title<span class="token operator">&gt;</span>
 <span class="token operator">&lt;</span>/head<span class="token operator">&gt;</span>
 <span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">!</span>--vue-ssr-outlet--<span class="token operator">&gt;</span>
 <span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
</code></pre> 
<p>9、服务器启动文件<br> 修改服务器启动文件，现在需要处理所有路由，./server/04-ssr.js</p> 
<pre><code class="prism language-bash">// 加载本地文件
const fs <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">"fs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
// 处理url
const path <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
const express <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
const server <span class="token operator">=</span> express<span class="token punctuation">(</span><span class="token punctuation">)</span>
// 获取绝对路径
const resolve <span class="token operator">=</span> <span class="token function">dir</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token builtin class-name">return</span> path.resolve<span class="token punctuation">(</span>__dirname, <span class="token function">dir</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
// 第 <span class="token number">1</span> 步：开放dist/client目录，关闭默认下载index页的选项，不然到不了后面路由
// /index.html
server.use<span class="token punctuation">(</span>express.static<span class="token punctuation">(</span>resolve<span class="token punctuation">(</span><span class="token string">'../dist/client'</span><span class="token punctuation">)</span>, <span class="token punctuation">{<!-- --></span>index: false<span class="token punctuation">}</span><span class="token punctuation">))</span>
// 第 <span class="token number">2</span> 步：获得一个createBundleRenderer
const <span class="token punctuation">{<!-- --></span> createBundleRenderer <span class="token punctuation">}</span> <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">"vue-server-renderer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
// 第 <span class="token number">3</span> 步：导入服务端打包文件
const bundle <span class="token operator">=</span> require<span class="token punctuation">(</span>resolve<span class="token punctuation">(</span><span class="token string">"../dist/server/vue-ssr-server-bundle.json"</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
// 第 <span class="token number">4</span> 步：创建渲染器
const template <span class="token operator">=</span> fs.readFileSync<span class="token punctuation">(</span>resolve<span class="token punctuation">(</span><span class="token string">"../public/index.html"</span><span class="token punctuation">)</span>, <span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
const clientManifest <span class="token operator">=</span> require<span class="token punctuation">(</span>resolve<span class="token punctuation">(</span><span class="token string">"../dist/client/vue-ssr-client-
manifest.json"</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
const renderer <span class="token operator">=</span> createBundleRenderer<span class="token punctuation">(</span>bundle, <span class="token punctuation">{<!-- --></span>
 runInNewContext: false, // https://ssr.vuejs.org/zh/api/<span class="token comment">#runinnewcontext</span>
 template, // 宿主文件
 clientManifest // 客户端清单
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
// 路由是通配符，表示所有url都接受
server.get<span class="token punctuation">(</span><span class="token string">'*'</span>, async <span class="token punctuation">(</span>req,res<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span>
  console.log<span class="token punctuation">(</span>req.url<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 // 设置url和title两个重要参数
 const context <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  title:<span class="token string">'ssr test'</span>,
  url:req.url // 首屏地址
<span class="token punctuation">}</span>
 const html <span class="token operator">=</span> await renderer.renderToString<span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
 res.send<span class="token punctuation">(</span>html<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
server.listen<span class="token punctuation">(</span><span class="token number">3000</span>, <span class="token function-name function">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 // eslint-disable-next-line no-console
 console.log<span class="token punctuation">(</span><span class="token variable"><span class="token variable">`</span>server started at localhost:$<span class="token punctuation">{<!-- --></span>port<span class="token punctuation">}</span><span class="token variable">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>10、整合Vuex<br> 安装vuex</p> 
<pre><code class="prism language-bash"><span class="token function">npm</span> <span class="token function">install</span> -S vuex
</code></pre> 
<p>store/index.js</p> 
<pre><code class="prism language-bash"><span class="token function">import</span> Vue from <span class="token string">'vue'</span>
<span class="token function">import</span> Vuex from <span class="token string">'vuex'</span>
Vue.use<span class="token punctuation">(</span>Vuex<span class="token punctuation">)</span>
<span class="token builtin class-name">export</span> <span class="token keyword">function</span> <span class="token function-name function">createStore</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token builtin class-name">return</span> new Vuex.Store<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  state: <span class="token punctuation">{<!-- --></span>
    count:108
 <span class="token punctuation">}</span>,
  mutations: <span class="token punctuation">{<!-- --></span>
add<span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
      state.count <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>挂载store，main.js</p> 
<pre><code class="prism language-bash"><span class="token function">import</span> <span class="token punctuation">{<!-- --></span> createStore <span class="token punctuation">}</span> from <span class="token string">'./store'</span>
<span class="token builtin class-name">export</span> <span class="token keyword">function</span> createApp <span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  // 创建实例
  const store <span class="token operator">=</span> createStore<span class="token punctuation">(</span><span class="token punctuation">)</span>
  const app <span class="token operator">=</span> new Vue<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    store, // 挂载
    render: h <span class="token operator">=</span><span class="token operator">&gt;</span> h<span class="token punctuation">(</span>App<span class="token punctuation">)</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token builtin class-name">return</span> <span class="token punctuation">{<!-- --></span> app, router, store <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>使用，.src/components/Index.vue</p> 
<pre><code class="prism language-bash"><span class="token operator">&lt;</span>h2 @click<span class="token operator">=</span><span class="token string">"<span class="token variable">$store</span>.commit('add')"</span><span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token variable">$store</span>.state.count<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>
</code></pre> 
<p>11、数据预取<br> 服务器端渲染的是应用程序的"快照"，如果应用依赖于一些异步数据，那么在开始渲染之前，需要先预取和解析好这些数据。<br> 异步数据获取，store/index.js</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">export</span> <span class="token keyword">function</span> <span class="token function-name function">createStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token builtin class-name">return</span> new Vuex.Store<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  mutations: <span class="token punctuation">{<!-- --></span>
   // 加一个初始化
   init<span class="token punctuation">(</span>state, count<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    state.count <span class="token operator">=</span> count<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>,
 <span class="token punctuation">}</span>,
  actions: <span class="token punctuation">{<!-- --></span>
   // 加一个异步请求count的action
   getCount<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> commit <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token builtin class-name">return</span> new Promise<span class="token punctuation">(</span>resolve <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
     setTimeout<span class="token punctuation">((</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
      commit<span class="token punctuation">(</span><span class="token string">"init"</span>, Math.random<span class="token punctuation">(</span><span class="token punctuation">)</span> * <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      resolve<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>, <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>,
 <span class="token punctuation">}</span>,
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>组件中的数据预取逻辑，Index.vue</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">export</span> default <span class="token punctuation">{<!-- --></span>
 asyncData<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> store, route <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> // 约定预取逻辑编写在预取钩子asyncData中
  // 触发 action 后，返回 Promise 以便确定请求结果
  <span class="token builtin class-name">return</span> store.dispatch<span class="token punctuation">(</span><span class="token string">"getCount"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>服务端数据预取，entry-server.js</p> 
<pre><code class="prism language-bash"><span class="token function">import</span> <span class="token punctuation">{<!-- --></span> createApp <span class="token punctuation">}</span> from <span class="token string">"./app"</span><span class="token punctuation">;</span>
<span class="token builtin class-name">export</span> default context <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
 <span class="token builtin class-name">return</span> new Promise<span class="token punctuation">((</span>resolve, reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
  // 拿出store和router实例
  const <span class="token punctuation">{<!-- --></span> app, router, store <span class="token punctuation">}</span> <span class="token operator">=</span> createApp<span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  router.push<span class="token punctuation">(</span>context.url<span class="token punctuation">)</span><span class="token punctuation">;</span>
  router.onReady<span class="token punctuation">((</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
   // 获取匹配的路由组件数组
   const matchedComponents <span class="token operator">=</span> router.getMatchedComponents<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   
   // 若无匹配则抛出异常
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>matchedComponents.length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token builtin class-name">return</span> reject<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> code: <span class="token number">404</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
   // 对所有匹配的路由组件调用可能存在的<span class="token variable"><span class="token variable">`</span>asyncData<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token variable">`</span></span>
   Promise.all<span class="token punctuation">(</span>
    matchedComponents.map<span class="token punctuation">(</span>Component <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>Component.asyncData<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token builtin class-name">return</span> Component.asyncData<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
       store,
       route: router.currentRoute,
     <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>,
  <span class="token punctuation">)</span>
   .then<span class="token punctuation">((</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
     // 所有预取钩子 resolve 后，
     // store 已经填充入渲染应用所需状态
     // 将状态附加到上下文，且 <span class="token variable"><span class="token variable">`</span>template<span class="token variable">`</span></span> 选项用于 renderer 时，
     // 状态将自动序列化为 <span class="token variable"><span class="token variable">`</span>window.__INITIAL_STATE__<span class="token variable">`</span></span>，并注入 HTML。
     context.state <span class="token operator">=</span> store.state<span class="token punctuation">;</span>
     
     resolve<span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
   .catch<span class="token punctuation">(</span>reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>, reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>客户端在挂载到应用程序之前，store 就应该获取到状态，entry-client.js</p> 
<pre><code class="prism language-bash">// 导出store
const <span class="token punctuation">{<!-- --></span> app, router, store <span class="token punctuation">}</span> <span class="token operator">=</span> createApp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
// 当使用 template 时，context.state 将作为 window.__INITIAL_STATE__ 状态自动嵌入到最
终的 HTML // 在客户端挂载到应用程序之前，store 就应该获取到状态：
<span class="token keyword">if</span> <span class="token punctuation">(</span>window.__INITIAL_STATE__<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 store.replaceState<span class="token punctuation">(</span>window.__INITIAL_STATE__<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>客户端数据预取处理，main.js</p> 
<pre><code class="prism language-bash">Vue.mixin<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
 <span class="token function-name function">beforeMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  const <span class="token punctuation">{<!-- --></span> asyncData <span class="token punctuation">}</span> <span class="token operator">=</span> this.<span class="token variable">$options</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>asyncData<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   // 将获取数据操作分配给 promise
   // 以便在组件中，我们可以在数据准备就绪后
   // 通过运行 <span class="token variable"><span class="token variable">`</span>this.dataPromise.then<span class="token punctuation">(</span><span class="token punctuation">..</span>.<span class="token punctuation">)</span><span class="token variable">`</span></span> 来执行其他任务
   this.dataPromise <span class="token operator">=</span> asyncData<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    store: this.<span class="token variable">$store</span>,
    route: this.<span class="token variable">$route</span>,
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>,
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b47820ecf77a82bbdaf47511716e6085/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">小程序mqtt实现聊天功能</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/125b5bf9bea10d0689c675d0a8747795/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【Redis】哨兵机制</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>