<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>server系统上开启热点服务器,使用Hi3861完成连接wifi热点并启动TCPSocketServer - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="server系统上开启热点服务器,使用Hi3861完成连接wifi热点并启动TCPSocketServer" />
<meta property="og:description" content="这次使用Hi3861来完成Wifi热点的连接，并启动TCP SocketServer，接收消息并将消息反馈TcpCLient。
一、连接Wifi热点。主要做法是启动开发板Wifi，然后设置热点和密码等配置信息，再连接热点。
1、先定义两个Wifi监听器，一个连接改变、一个状态改变，并注册监听器。其中重要的是OnWifiConnectionChanged连接状态事件处理函数。该函数会在连接成功后设置全局变量g_connected=1，代表已经连接成功。WifiEvent eventListener = {
.OnWifiConnectionChanged = OnWifiConnectionChanged,
.OnWifiScanStateChanged = OnWifiScanStateChanged
};
WifiErrorCode errCode = RegisterWifiEvent(&amp;eventListener);
void OnWifiConnectionChanged(int state, WifiLinkedInfo* info) {
if (!info) return;
if (state == WIFI_STATE_AVALIABLE) {
g_connected = 1;
} else {
g_connected = 0;
}
}
2、启动WifiEnableWifi();
3、设置Wifi热点信息，并返回NetworkIdWifiDeviceConfig apConfig = {};
strcpy(apConfig.ssid, &#34;MyWifi&#34;);
strcpy(apConfig.preSharedKey, &#34;12345678&#34;);
apConfig.securityType = WIFI_SEC_TYPE_PSK;
int netId = -1;
AddDeviceConfig(&amp;apConfig, &amp;netId);
4、连接热点，注意此时的g_connected变量，true代表已连接，false代表未连接。这个状态在事件处理函数中设置。未连接成功时，系统会循环等待，知道事件设置该值。ConnectTo(netId);
while (!g_connected) {
osDelay(10);
}
二、进行联网，找到wlan0的network interface，然后启动DHCP客户端，获取IP地址。struct netif* iface = netifapi_netif_find(&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/dc490c65045c8b37529b13ba591ea3fc/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-08-11T17:22:38+08:00" />
<meta property="article:modified_time" content="2021-08-11T17:22:38+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">server系统上开启热点服务器,使用Hi3861完成连接wifi热点并启动TCPSocketServer</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div style="font-size:16px;"> 
 <p>这次使用Hi3861来完成Wifi热点的连接，并启动TCP SocketServer，接收消息并将消息反馈TcpCLient。</p> 
 <p>一、连接Wifi热点。主要做法是启动开发板Wifi，然后设置热点和密码等配置信息，再连接热点。</p> 
 <p>1、先定义两个Wifi监听器，一个连接改变、一个状态改变，并注册监听器。其中重要的是OnWifiConnectionChanged连接状态事件处理函数。该函数会在连接成功后设置全局变量g_connected=1，代表已经连接成功。WifiEvent eventListener = {<!-- --></p> 
 <p>.OnWifiConnectionChanged = OnWifiConnectionChanged,</p> 
 <p>.OnWifiScanStateChanged = OnWifiScanStateChanged</p> 
 <p>};</p> 
 <p>WifiErrorCode errCode = RegisterWifiEvent(&amp;eventListener);</p> 
 <p>void OnWifiConnectionChanged(int state, WifiLinkedInfo* info) {<!-- --></p> 
 <p>if (!info) return;</p> 
 <p>if (state == WIFI_STATE_AVALIABLE) {<!-- --></p> 
 <p>g_connected = 1;</p> 
 <p>} else {<!-- --></p> 
 <p>g_connected = 0;</p> 
 <p>}</p> 
 <p>}</p> 
 <p>2、启动WifiEnableWifi();</p> 
 <p>3、设置Wifi热点信息，并返回NetworkIdWifiDeviceConfig apConfig = {};</p> 
 <p>strcpy(apConfig.ssid, "MyWifi");</p> 
 <p>strcpy(apConfig.preSharedKey, "12345678");</p> 
 <p>apConfig.securityType = WIFI_SEC_TYPE_PSK;</p> 
 <p>int netId = -1;</p> 
 <p>AddDeviceConfig(&amp;apConfig, &amp;netId);</p> 
 <p>4、连接热点，注意此时的g_connected变量，true代表已连接，false代表未连接。这个状态在事件处理函数中设置。未连接成功时，系统会循环等待，知道事件设置该值。ConnectTo(netId);</p> 
 <p>while (!g_connected) {<!-- --></p> 
 <p>osDelay(10);</p> 
 <p>}</p> 
 <p>二、进行联网，找到wlan0的network interface，然后启动DHCP客户端，获取IP地址。struct netif* iface = netifapi_netif_find("wlan0");</p> 
 <p>if (iface) {<!-- --></p> 
 <p>err_t ret = netifapi_dhcp_start(iface);</p> 
 <p>osDelay(300);</p> 
 <p>}</p> 
 <p>三、启动TcpSocketServer，并收发消息</p> 
 <p>1、创建SocketServer，设置服务端口，并启动监听int sockfd = socket(AF_INET, SOCK_STREAM, 0);</p> 
 <p>struct sockaddr_in serverAddr = {0};</p> 
 <p>serverAddr.sin_family = AF_INET;</p> 
 <p>serverAddr.sin_port = htons(port);</p> 
 <p>serverAddr.sin_addr.s_addr = htonl(INADDR_ANY);</p> 
 <p>bind(sockfd, (struct sockaddr *)&amp;serverAddr, sizeof(serverAddr));</p> 
 <p>int backlog = 1;</p> 
 <p>listen(sockfd, backlog)</p> 
 <p>2、客户端连接。接收客户端消息并发送回去。注意连接后，会创建一个新的Socket File Description。int connfd = -1;</p> 
 <p>connfd = accept(sockfd, (struct sockaddr *)&amp;clientAddr, &amp;clientAddrLen);</p> 
 <p>recv(connfd, request, sizeof(request), 0);</p> 
 <p>send(connfd, request, strlen(request), 0);</p> 
 <p>3、关闭TcpSocketServerlwip_close(connfd);</p> 
 <p>lwip_close(socketfd);</p> 
 <p>四、联网结束，关闭DHCP客户端，断开Wifi，移除热点的配置信息，禁用Wifi。err_t ret = netifapi_dhcp_stop(iface);</p> 
 <p>Disconnect();</p> 
 <p>RemoveDevice(netId);</p> 
 <p>DisableWifi();</p> 
 <p>五、测试情况如下：</p> 
 <p>1、启动开发板，连接Wifi热点，启动TcpServer</p> 
 <p align="center"><img src="https://images2.imgbox.com/93/40/MiNvRFL7_o.png" alt="39813dda5a113771a94f2cb0c6d5d060.png">2、TcpClient(网络调试助手)连接开发板的TcpServer(HiBurn)。</p> 
 <p align="center"><img src="https://images2.imgbox.com/4e/0a/bVY2esVh_o.png" alt="d6fa9c680741bf759bd21c7a35d7ae7c.png"></p> 
 <p align="center"><img src="https://images2.imgbox.com/7f/93/ku0wowdJ_o.png" alt="c7f809ea4e81f2e6bca0bddfd6a12e2f.png">3、TcpClient输入数据并发送，TcpServer接收后再发送回TcpClient。</p> 
 <p align="center"><img src="https://images2.imgbox.com/74/8f/oJNWPFmO_o.png" alt="2acb36a2f54684de655f343d34e43dca.png"></p> 
 <p align="center"><img src="https://images2.imgbox.com/08/57/QUvbXlw8_o.png" alt="ed7acd37ee2b2758dea978cfdc104664.png"></p> 
 <p>六、全部源代码，我都注释了，希望大家能够有所参考。</p> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/27059ff531177a613a64e721f1624d28/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">客户端加密服务器端解密文件,基于RSA实现的客户端数据加密，服务端数据解密...</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e37daa249dac9d2043847dd8eab37bbb/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">消防系统数据服务器,数据中心消防安全措施必须齐全完备</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>