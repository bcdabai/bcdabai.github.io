<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>大数据之Hadoop - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="大数据之Hadoop" />
<meta property="og:description" content="Hadoop的简介 Apache Hadoop是一款支持数据密集型分布式应用程序并以Apache 2.0许可协议发布的开源软件框架，有助于使用许多电脑组成的网络来解决数据、计算密集型的问题。基于MapReduce计算模型，它为大数据的分布式存储与处理提供了一个软件框架。所有的Hadoop模块都有一个基本假设，即硬件故障是常见情况，应该由框架自动处理。
Apache Hadoop的核心模块分为存储和计算模块，前者被称为Hadoop分布式文件系统（HDFS），后者即MapReduce计算模型。Hadoop框架先将文件分成数据块并分布式地存储在集群的计算节点中，接着将负责计算任务的代码传送给各节点，让其能够并行地处理数据。这种方法有效利用了数据局部性，令各节点分别处理其能够访问的数据。与传统的超级电脑架构相比，这使得数据集的处理速度更快、效率更高。
Hadoop组件 HDFS HDFS分布式存储框架，适合海量数据的存储 HDFS的原理：是一种允许文件通过网络在多台主机上分享的文件系统，可让多机器上的多用户分享文件和存储空间
通透性；让实际上是通过网络来访问文件的动作，由程序与用户看来，就像是访问本地的磁盘一般。
容错；即使系统中有某些节点宕机，整体来说系统仍然可以持续运作而不会有数据损失【通过副本机制实现】。
分布式文件管理系统很多，hdfs只是其中一种，不合适小文件。
HDFS的节点 一、管理节点NameNode NameNode是整个文件系统的管理节点，它维护着整个文件系统的目录树，文件目录的元信息和每个文件对应的数据块列表，接收用户的操作请求。
①维护每个DataNode的心跳，用于查看数据节点是否存活
②用于管理HDFS中所有的文件信息，包括文件的路径、文件的block块信息、文件的大小及其权限
③响应客户端的请求，根据上传或下载返回请求的结果
二、数据节点DataNode DataNode节点提供真实文件数据的存储服务 ①用于存储客户端上传的具体文件，文件上传过程会进行数据的切分，根据block块大小会将文件切分成多块，并且block块会存储在多个DataNode中
②响应客户端的上传请求和下载请求
③检测和管理存储在本节点上的block块信息
Block块为HDFS中基本的存储单位，但并不是最小的存储单位 一个文件的长度大小是size，那么从文件的偏移开始，按照固定的大小，顺序对文件进行划分并编号，划分好的每一个块称为一个block。
BLock块大小： ​ 1.在Hadoop1.X中大小默认为64M
​ 2.在Hadoop2.X中大小默认为128M
为什么BLock块大小为128M？ ​ 问题：
1. 如果一个文件不进行做拆分，对应一个DataNode中存储一个完整的文件，对导致DataNode存取压力过大，由于计算本地化，所以计算压力也会很大，由此需要拆分 2. 如果拆分过大？ 会导致1问题，同时下载速度也会很慢 3. 如果拆分过小？ 对应一个拆分过的文件会特别多，那么对应的元数据信息也会很多，会导致NameNode压力过大，检索数据信息时间会很长 基于以上问题如何设计？ 规定：一个数据的检索时间最长不超过10ms,规定检索时间为BLock数据下载时间的1%为1秒
数据下载时间由网络及磁盘决定，由于磁盘和网络传输时间在100M/s，基于这个理论值得到 block块大小是在128M
设置BLock块大小 hdfs-site.xml中dfs.blocksize属性
副本数 Replication。多副本。默认是三个
设置hdfs-site.xml的dfs.replication属性
副本机制与机架？ 如果当前集群设置副本数为3 那么对应存放位置为在同一个机架中会存放两个份，其他机架中保存一份，可以保证数据的安全。
为什么block块不每个机架存放一份？ 由于后续做数据计算时，会将计算结果进行汇总，如果数据过于分散，那么后续网络传输压力会很大。
三、Secondary NameNode Secondary NameNode是NameNode的备份节点
①由于NameNode需要保存元数据信息，并且元数据信息是放在内存中的
②数据存放在内存中会有安全性问题，需要持久化
③由于NameNode对外请求压力大，并不适合做持久化工作，所以交由Secondary NameNode
HDFS的读写 一、HDFS的读流程 1.首先调用FileSystem对象的open方法，其实是一个DistributedFileSystem的实例
2.DistributedFileSystem通过rpc获得文件的第一个block的locations，同一block按照副本数会返回多个locations，这些locations按照hadoop拓扑结构排序，距离客户端近的排在前面.
3.前两步会返回一个FSDataInputStream对象，该对象会被封装成DFSInputStream对象，DFSInputStream可以方便的管理datanode和namenode数据流。客户端调用read方法，DFSInputStream最会找出离客户端最近的datanode并连接。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/8c3deceecc70fe328a6e8e57ceb51659/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-27T21:31:27+08:00" />
<meta property="article:modified_time" content="2022-12-27T21:31:27+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">大数据之Hadoop</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="Hadoop_0"></a>Hadoop的简介</h3> 
<p><img src="https://images2.imgbox.com/2f/32/sdTTnAVb_o.png" alt="在这里插入图片描述"></p> 
<p>Apache Hadoop是一款支持数据密集型分布式应用程序并以Apache 2.0许可协议发布的开源软件框架，有助于使用许多电脑组成的网络来解决数据、计算密集型的问题。基于MapReduce计算模型，它为大数据的分布式存储与处理提供了一个软件框架。所有的Hadoop模块都有一个基本假设，即硬件故障是常见情况，应该由框架自动处理。</p> 
<p>Apache Hadoop的核心模块分为存储和计算模块，前者被称为Hadoop分布式文件系统（HDFS），后者即MapReduce计算模型。Hadoop框架先将文件分成数据块并分布式地存储在集群的计算节点中，接着将负责计算任务的代码传送给各节点，让其能够并行地处理数据。这种方法有效利用了数据局部性，令各节点分别处理其能够访问的数据。与传统的超级电脑架构相比，这使得数据集的处理速度更快、效率更高。</p> 
<h3><a id="Hadoop_8"></a>Hadoop组件</h3> 
<h4><a id="HDFS_10"></a>HDFS</h4> 
<h5><a id="HDFS_12"></a>HDFS分布式存储框架，适合海量数据的存储</h5> 
<p>HDFS的原理：是一种允许文件通过网络在多台主机上分享的文件系统，可让多机器上的多用户分享文件和存储空间</p> 
<p>通透性；让实际上是通过网络来访问文件的动作，由程序与用户看来，就像是访问本地的磁盘一般。</p> 
<p>容错；即使系统中有某些节点宕机，整体来说系统仍然可以持续运作而不会有数据损失【通过副本机制实现】。</p> 
<p>分布式文件管理系统很多，hdfs只是其中一种，不合适小文件。</p> 
<h5><a id="HDFS_22"></a>HDFS的节点</h5> 
<h6><a id="NameNode_24"></a>一、管理节点NameNode</h6> 
<p>NameNode是整个文件系统的管理节点，它维护着整个文件系统的目录树，文件目录的元信息和每个文件对应的数据块列表，接收用户的操作请求。</p> 
<p>①维护每个DataNode的心跳，用于查看数据节点是否存活</p> 
<p>②用于管理HDFS中所有的文件信息，包括文件的路径、文件的block块信息、文件的大小及其权限</p> 
<p>③响应客户端的请求，根据上传或下载返回请求的结果</p> 
<h6><a id="DataNode_34"></a>二、数据节点DataNode</h6> 
<h6><a id="DataNode_36"></a>DataNode节点提供真实文件数据的存储服务</h6> 
<p>①用于存储客户端上传的具体文件，文件上传过程会进行数据的切分，根据block块大小会将文件切分成多块，并且block块会存储在多个DataNode中</p> 
<p>②响应客户端的上传请求和下载请求</p> 
<p>③检测和管理存储在本节点上的block块信息</p> 
<h6><a id="BlockHDFS_44"></a>Block块为HDFS中基本的存储单位，但并不是最小的存储单位</h6> 
<p>一个文件的长度大小是size，那么从文件的偏移开始，按照固定的大小，顺序对文件进行划分并编号，划分好的每一个块称为一个block。</p> 
<h6><a id="BLock_48"></a>BLock块大小：</h6> 
<p>​ 1.在Hadoop1.X中大小默认为64M</p> 
<p>​ 2.在Hadoop2.X中大小默认为128M</p> 
<h6><a id="BLock128M_54"></a>为什么BLock块大小为128M？</h6> 
<p>​ 问题：</p> 
<pre><code>		1. 如果一个文件不进行做拆分，对应一个DataNode中存储一个完整的文件，对导致DataNode存取压力过大，由于计算本地化，所以计算压力也会很大，由此需要拆分
		2. 如果拆分过大？ 会导致1问题，同时下载速度也会很慢
		3. 如果拆分过小？ 对应一个拆分过的文件会特别多，那么对应的元数据信息也会很多，会导致NameNode压力过大，检索数据信息时间会很长
</code></pre> 
<h6><a id="_62"></a>基于以上问题如何设计？</h6> 
<p>规定：一个数据的检索时间最长不超过10ms,规定检索时间为BLock数据下载时间的1%为1秒</p> 
<p>数据下载时间由网络及磁盘决定，由于磁盘和网络传输时间在100M/s，基于这个理论值得到 block块大小是在128M</p> 
<h6><a id="BLock_68"></a>设置BLock块大小</h6> 
<p>hdfs-site.xml中dfs.blocksize属性</p> 
<h6><a id="_72"></a>副本数</h6> 
<p>Replication。多副本。默认是三个</p> 
<p>设置hdfs-site.xml的dfs.replication属性</p> 
<h6><a id="_78"></a>副本机制与机架？</h6> 
<p>如果当前集群设置副本数为3 那么对应存放位置为在同一个机架中会存放两个份，其他机架中保存一份，可以保证数据的安全。</p> 
<h6><a id="block_82"></a>为什么block块不每个机架存放一份？</h6> 
<p>由于后续做数据计算时，会将计算结果进行汇总，如果数据过于分散，那么后续网络传输压力会很大。</p> 
<h6><a id="Secondary_NameNode_86"></a>三、Secondary NameNode</h6> 
<p>Secondary NameNode是NameNode的备份节点</p> 
<p>①由于NameNode需要保存元数据信息，并且元数据信息是放在内存中的</p> 
<p>②数据存放在内存中会有安全性问题，需要持久化</p> 
<p>③由于NameNode对外请求压力大，并不适合做持久化工作，所以交由Secondary NameNode</p> 
<h5><a id="HDFS_96"></a>HDFS的读写</h5> 
<h6><a id="HDFS_98"></a>一、HDFS的读流程</h6> 
<p><img src="https://images2.imgbox.com/93/57/KAgDRL0h_o.png" alt="在这里插入图片描述"><br> 1.首先调用FileSystem对象的open方法，其实是一个DistributedFileSystem的实例</p> 
<p>2.DistributedFileSystem通过rpc获得文件的第一个block的locations，同一block按照副本数会返回多个locations，这些locations按照hadoop拓扑结构排序，距离客户端近的排在前面.</p> 
<p>3.前两步会返回一个FSDataInputStream对象，该对象会被封装成DFSInputStream对象，DFSInputStream可以方便的管理datanode和namenode数据流。客户端调用read方法，DFSInputStream最会找出离客户端最近的datanode并连接。</p> 
<p>4.数据从datanode源源不断的流向客户端。</p> 
<p>5.如果第一块的数据读完了，就会关闭指向第一块的datanode连接，接着读取下一块。这些操作对客户端来说是透明的，客户端的角度看来只是读一个持续不断的流。</p> 
<p>6.如果第一批block都读完了，DFSInputStream就会去namenode拿下一批blocks的location，然后继续读，如果所有的块都读完，这时就会关闭掉所有的流</p> 
<p>如果在读数据的时候，DFSInputStream和datanode的通讯发生异常，就会尝试正在读的block的排第二近的datanode,并且会记录哪个datanode发生错误，剩余的blocks读的时候就会直接跳过该datanode。DFSInputStream也会检查block数据校验和，如果发现一个坏的block,就会先报告到namenode节点，然后DFSInputStream在其他的datanode上读该block的镜像</p> 
<p>该设计的方向就是客户端直接连接datanode来检索数据并且namenode来负责为每一个block提供最优的datanode，namenode仅仅处理block location的请求，这些信息都加载在namenode的内存中，hdfs通过datanode集群可以承受大量客户端的并发访问。</p> 
<h6><a id="HDFS_117"></a>二、HDFS的写流程</h6> 
<p><img src="https://images2.imgbox.com/13/d8/lOv7Odju_o.png" alt="在这里插入图片描述"><br> 1.客户端通过调用DistributedFileSystem的create方法创建新文件,并向NameNode发送请求，namenode接收到请求后会做各种校验，比如文件是否存在，客户端有无权限去创建等。如果校验通过，namenode就会记录下新文件，否则就会抛出IO异常</p> 
<p>2.NameNode在客户端中创建DFSOutputStream对象，DFSOutputStream可以协调namenode和datanode并会把数据切成一个个小packet,每个Packet大小为64K,packet会由多个chunks组成，每个chunk大小为512字节，并伴随一个4字节的校验码，然后将packet存放至dataQuene中</p> 
<p>3.当dataQuene中存在数据时，会向NameNode请求上传第一个BLock块</p> 
<p>4.NameNode接收到请求后，返回BLock块存储位置列表</p> 
<p>5.客户端接收到列表后，根据机架感知（拓扑结构），以及负载均衡，寻找最优的一个DataNode节点进行连接</p> 
<p>6.客户端会与最近的DataNode创建通道(pipeline)，之后该DataNode会与其他的DataNode创建通道</p> 
<p>7.开始上传第一个packet数据，dataQuene会将packet数据发送到本地的ackQueue</p> 
<p>8.本地的ackQueue会将packet上传至DataNode的ackQueue</p> 
<p>9.当第一个DataNode接收到packet，会将packet从ackQueue中分发至其他DataNode的ackQueue</p> 
<p>10.当pipeline中的所有datanode都表示已经收到的时候，这时本地akc queue才会把对应的packet包移除掉。</p> 
<p>11.当第一个BLock块中所有的packet数据上传完成，会重新向NameNode申请上传下一个BLock块所在的Locations位置,按之前的顺序再次提交，直到所有的BLock上传完成后通知namenode把文件标示为已完成</p> 
<h6><a id="_141"></a>问题：如果上传过程中出现问题？</h6> 
<p>如果在写的过程中某个datanode发生错误，会采取以下几步：</p> 
<p>​ 1) pipeline被关闭掉；</p> 
<p>​ 2)为了防止丢包ack queue里的packet会同步到data queue里；</p> 
<p>​ 3)把产生错误的datanode上当前在写但未完成的block删掉；</p> 
<p>​ 4）block剩下的部分被写到剩下的两个正常的datanode中；</p> 
<p>​ 5）namenode找到另外的datanode去创建这个块的复制</p> 
<h4><a id="MapReduce_155"></a>MapReduce</h4> 
<h5><a id="MapReduce_157"></a>MapReduce作用</h5> 
<p>将用户的业务逻辑和Hadoop中的组件结合起来形成一个分布式程序</p> 
<h5><a id="JAVAHadoop_161"></a>JAVA类型与Hadoop类型对应</h5> 
<p>Java中的数据类型通过序列化以后，会产生大量的描述数据信息，在网络传输过程中，会占用大量资源，所以Hadoop实现了自己的一套数据结构，并且能够和Java中的数据类型进行对应</p> 
<p>Hadoop text 对应 JAVA中的 String</p> 
<table><thead><tr><th>Java类型</th><th>Writable</th></tr></thead><tbody><tr><td>字符串（String）</td><td>Text</td></tr><tr><td>布尔型（boolean）</td><td>BooleanWritable</td></tr><tr><td>字节型（byte）</td><td>ByteWritable</td></tr><tr><td>整型（int）</td><td>IntWritable</td></tr><tr><td>VIntWritable</td><td>IntWritable</td></tr><tr><td>浮点型（float）</td><td>FloatWritable</td></tr><tr><td>长整型（long）</td><td>LongWritable</td></tr><tr><td>VLongWritable</td><td>LongWritable</td></tr><tr><td>双精度浮点型（double）</td><td>DoubleWritable</td></tr><tr><td>空值NULL</td><td>NullWritable</td></tr></tbody></table> 
<h5><a id="MapReduce_180"></a>MapReduce代码解析</h5> 
<p>1.Map端</p> 
<p>​ ① 输入数据为KV数据对，其中K为其数据读取的偏移量，Value为当前输入源的一行数据</p> 
<p>​ ②输出为KV数据对</p> 
<p>​ ③所有的业务逻辑都是在Map方法中实现的</p> 
<p>​ ④执行过程中每一行数据都会调用一次map方法</p> 
<p>​ ⑤一个切片数产生一个MapTask任务</p> 
<p>2.Reduce端</p> 
<p>​ ①输入数据为Map端输出的数据</p> 
<p>​ ②所有的业务逻辑都在Reduce方法中实现</p> 
<p>​ ③如果ReduceTask数量为n个，那么对应输出文件也为n个</p> 
<p>​ ④Reduce中会将Map端输出的相同的Key放置一起，对应其Value是一个Iterable迭代器</p> 
<p>3.Driver端</p> 
<p>​ Driver的作用是将当前的程序打包提交给yarn集群(如果是在集群中运行)，并通过Yarn中的ResourceManager创建当前程序的ApplicationMaster</p> 
<p>具体代码步骤：</p> 
<p>​ ① 创建job，并设置Job中的配置，包括类，当前Job名称</p> 
<p>​ ②通过job设置Mapper和 Reducer(Reducer并不是必须的)</p> 
<p>​ ③设置Mapper输出的KV类以及最终输出的KV类</p> 
<p>​ ④设置输入输出的数据路径</p> 
<p>​ ⑤提交job</p> 
<h5><a id="_220"></a>切片</h5> 
<p><img src="https://images2.imgbox.com/01/25/fjnAObGd_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_223"></a>切片源码</h5> 
<p>1、</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InputSplit</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSplits</span><span class="token punctuation">(</span><span class="token class-name">JobContext</span> job<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
     <span class="token comment">// 设置一个时间管理器，用于统计切片所花费的时间</span>
    <span class="token class-name">StopWatch</span> sw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StopWatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// getFormatMinSplitSize=1L getMinSplitSize =1L =&gt; minSize = 1</span>
    <span class="token keyword">long</span> minSize <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token function">getFormatMinSplitSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getMinSplitSize</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// maxSize=9223372036854775807L </span>
    <span class="token keyword">long</span> maxSize <span class="token operator">=</span> <span class="token function">getMaxSplitSize</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// generate splits</span>
    <span class="token comment">// 创建List用来存储split</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InputSplit</span><span class="token punctuation">&gt;</span></span> splits <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InputSplit</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 通过listStatus获取输入路径下所有的文件</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FileStatus</span><span class="token punctuation">&gt;</span></span> files <span class="token operator">=</span> <span class="token function">listStatus</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">FileStatus</span> file<span class="token operator">:</span> files<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       <span class="token comment">// 获取文件所在路径</span>
      <span class="token class-name">Path</span> path <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">// 获取文件长度</span>
      <span class="token keyword">long</span> length <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getLen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">BlockLocation</span><span class="token punctuation">[</span><span class="token punctuation">]</span> blkLocations<span class="token punctuation">;</span>
        <span class="token comment">// 判断file对象类型</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>file <span class="token keyword">instanceof</span> <span class="token class-name">LocatedFileStatus</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 本地文件系统</span>
          blkLocations <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">LocatedFileStatus</span><span class="token punctuation">)</span> file<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBlockLocations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
           <span class="token comment">// HDFS上的文件系统</span>
          <span class="token class-name">FileSystem</span> fs <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">getFileSystem</span><span class="token punctuation">(</span>job<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          blkLocations <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">getFileBlockLocations</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
          <span class="token comment">// 判断文件是否可以切分，有的文件会是压缩格式</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSplitable</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// blockSize值为当前文件大小，如果当文件大小超过128M时，大小为128M</span>
          <span class="token keyword">long</span> blockSize <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getBlockSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 经过对比后 blockSize=splitSize</span>
          <span class="token keyword">long</span> splitSize <span class="token operator">=</span> <span class="token function">computeSplitSize</span><span class="token punctuation">(</span>blockSize<span class="token punctuation">,</span> minSize<span class="token punctuation">,</span> maxSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
		  <span class="token comment">// 当前文件长度赋予 bytesRemaining表示剩余长度</span>
          <span class="token keyword">long</span> bytesRemaining <span class="token operator">=</span> length<span class="token punctuation">;</span>
          <span class="token comment">// SPLIT_SLOP=1.1</span>
          <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> bytesRemaining<span class="token punctuation">)</span><span class="token operator">/</span>splitSize <span class="token operator">&gt;</span> <span class="token constant">SPLIT_SLOP</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token comment">// 当前文件大小超过切片大小的1.1倍，开始切分数据</span>
            <span class="token keyword">int</span> blkIndex <span class="token operator">=</span> <span class="token function">getBlockIndex</span><span class="token punctuation">(</span>blkLocations<span class="token punctuation">,</span> length<span class="token operator">-</span>bytesRemaining<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 创建切片 length-bytesRemaining表示开始位置  splitSize表示切片长度</span>
             splits<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">makeSplit</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> length<span class="token operator">-</span>bytesRemaining<span class="token punctuation">,</span>   splitSize<span class="token punctuation">,</span>
                        blkLocations<span class="token punctuation">[</span>blkIndex<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getHosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        blkLocations<span class="token punctuation">[</span>blkIndex<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getCachedHosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 将剩余长度减去所切去的切片长度</span>
              bytesRemaining <span class="token operator">-=</span> splitSize<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>bytesRemaining <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> blkIndex <span class="token operator">=</span> <span class="token function">getBlockIndex</span><span class="token punctuation">(</span>blkLocations<span class="token punctuation">,</span> length<span class="token operator">-</span>bytesRemaining<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 如果剩余字节数小于 128M * 1.1 之后作为一个切片保存</span>
              splits<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">makeSplit</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> length<span class="token operator">-</span>bytesRemaining<span class="token punctuation">,</span> bytesRemaining<span class="token punctuation">,</span>
                       blkLocations<span class="token punctuation">[</span>blkIndex<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getHosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                       blkLocations<span class="token punctuation">[</span>blkIndex<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getCachedHosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// not splitable</span>
           <span class="token comment">// 如果不能切片，那么会创建一个切片用于处理数据</span>
          splits<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">makeSplit</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> length<span class="token punctuation">,</span> blkLocations<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getHosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                      blkLocations<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getCachedHosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span> 
        <span class="token comment">// 如果文件为空，那么也会创建一个切片</span>
        <span class="token comment">//Create empty hosts array for zero length files</span>
        splits<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">makeSplit</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> length<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Save the number of input files for metrics/loadgen</span>
    job<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setLong</span><span class="token punctuation">(</span><span class="token constant">NUM_INPUT_FILES</span><span class="token punctuation">,</span> files<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sw<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Total # of splits generated by getSplits: "</span> <span class="token operator">+</span> splits<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token operator">+</span> <span class="token string">", TimeTaken: "</span> <span class="token operator">+</span> sw<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> splits<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>总结：</p> 
<p>​ ① 切片大小并不总是为128M</p> 
<p>​ ②一个文件小于128M也会产生一个切片</p> 
<p>​ ③ 一个切片对应一个MapTask任务</p> 
<p>2、</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InputSplit</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSplits</span><span class="token punctuation">(</span><span class="token class-name">JobContext</span> job<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">StopWatch</span> sw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StopWatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> minSize <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token function">getFormatMinSplitSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getMinSplitSize</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> maxSize <span class="token operator">=</span> <span class="token function">getMaxSplitSize</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// generate splits</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InputSplit</span><span class="token punctuation">&gt;</span></span> splits <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InputSplit</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FileStatus</span><span class="token punctuation">&gt;</span></span> files <span class="token operator">=</span> <span class="token function">listStatus</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">FileStatus</span> file<span class="token operator">:</span> files<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token class-name">Path</span> path <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">long</span> length <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getLen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">BlockLocation</span><span class="token punctuation">[</span><span class="token punctuation">]</span> blkLocations<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>file <span class="token keyword">instanceof</span> <span class="token class-name">LocatedFileStatus</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          blkLocations <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">LocatedFileStatus</span><span class="token punctuation">)</span> file<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBlockLocations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          <span class="token class-name">FileSystem</span> fs <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">getFileSystem</span><span class="token punctuation">(</span>job<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          blkLocations <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">getFileBlockLocations</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSplitable</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">long</span> blockSize <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getBlockSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">long</span> splitSize <span class="token operator">=</span> <span class="token function">computeSplitSize</span><span class="token punctuation">(</span>blockSize<span class="token punctuation">,</span> minSize<span class="token punctuation">,</span> maxSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">long</span> bytesRemaining <span class="token operator">=</span> length<span class="token punctuation">;</span>
          <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> bytesRemaining<span class="token punctuation">)</span><span class="token operator">/</span>splitSize <span class="token operator">&gt;</span> <span class="token constant">SPLIT_SLOP</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> blkIndex <span class="token operator">=</span> <span class="token function">getBlockIndex</span><span class="token punctuation">(</span>blkLocations<span class="token punctuation">,</span> length<span class="token operator">-</span>bytesRemaining<span class="token punctuation">)</span><span class="token punctuation">;</span>
            splits<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">makeSplit</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> length<span class="token operator">-</span>bytesRemaining<span class="token punctuation">,</span> splitSize<span class="token punctuation">,</span>
                        blkLocations<span class="token punctuation">[</span>blkIndex<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getHosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        blkLocations<span class="token punctuation">[</span>blkIndex<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getCachedHosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bytesRemaining <span class="token operator">-=</span> splitSize<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>bytesRemaining <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> blkIndex <span class="token operator">=</span> <span class="token function">getBlockIndex</span><span class="token punctuation">(</span>blkLocations<span class="token punctuation">,</span> length<span class="token operator">-</span>bytesRemaining<span class="token punctuation">)</span><span class="token punctuation">;</span>
            splits<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">makeSplit</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> length<span class="token operator">-</span>bytesRemaining<span class="token punctuation">,</span> bytesRemaining<span class="token punctuation">,</span>
                       blkLocations<span class="token punctuation">[</span>blkIndex<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getHosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                       blkLocations<span class="token punctuation">[</span>blkIndex<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getCachedHosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// not splitable</span>
          splits<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">makeSplit</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> length<span class="token punctuation">,</span> blkLocations<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getHosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                      blkLocations<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getCachedHosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span> 
        <span class="token comment">//Create empty hosts array for zero length files</span>
        splits<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">makeSplit</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> length<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Save the number of input files for metrics/loadgen</span>
    job<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setLong</span><span class="token punctuation">(</span><span class="token constant">NUM_INPUT_FILES</span><span class="token punctuation">,</span> files<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sw<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Total # of splits generated by getSplits: "</span> <span class="token operator">+</span> splits<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token operator">+</span> <span class="token string">", TimeTaken: "</span> <span class="token operator">+</span> sw<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> splits<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_375"></a>序列化</h5> 
<p>为什么要做序列化？</p> 
<p>在网络传输过程中，对象需要转换成二进制形式才能在网络中传输，将对象转成二进制形式的过程叫做序列化，将二进制结果转换成对象过程叫做反序列化</p> 
<h5><a id="Map_381"></a>Map端读取文件过程</h5> 
<p>在MR代码中选择FileInputFormat进入，再去进入父类InputFormat，发现父类中定义了两个抽象方法</p> 
<pre><code class="prism language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InputSplit</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSplits</span><span class="token punctuation">(</span><span class="token class-name">JobContext</span> context
                               <span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span>
                               
<span class="token class-name">RecordReader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token function">createRecordReader</span><span class="token punctuation">(</span><span class="token class-name">InputSplit</span> split<span class="token punctuation">,</span>
                                     <span class="token class-name">TaskAttemptContext</span> context
                                    <span class="token punctuation">)</span>
</code></pre> 
<p>然后通过createRecordReader查看其子实现类中的方法，由于TextInputFormat继承与FileInputFormat，而MR程序中调用的是FileInputFormat，所以可以查看其子类TextInputFormat中的createRecordReader方法</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">RecordReader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LongWritable</span><span class="token punctuation">,</span> <span class="token class-name">Text</span><span class="token punctuation">&gt;</span></span> 
    <span class="token function">createRecordReader</span><span class="token punctuation">(</span><span class="token class-name">InputSplit</span> split<span class="token punctuation">,</span>
                       <span class="token class-name">TaskAttemptContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
          
<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LineRecordReader</span><span class="token punctuation">(</span>recordDelimiterBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>进入LineRecordReader类中,查看initialize方法</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token class-name">InputSplit</span> genericSplit<span class="token punctuation">,</span>
                         <span class="token class-name">TaskAttemptContext</span> context<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 获取FileSplit可以获取到切片的路径以及开始位置和长度</span>
    <span class="token class-name">FileSplit</span> split <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">FileSplit</span><span class="token punctuation">)</span> genericSplit<span class="token punctuation">;</span>
    <span class="token class-name">Configuration</span> job <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>maxLineLength <span class="token operator">=</span> job<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token constant">MAX_LINE_LENGTH</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 路径以及开始位置和长度</span>
    start <span class="token operator">=</span> split<span class="token punctuation">.</span><span class="token function">getStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    end <span class="token operator">=</span> start <span class="token operator">+</span> split<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">Path</span> file <span class="token operator">=</span> split<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// open the file and seek to the start of the split</span>
    <span class="token comment">// 获取FileSystem读取文件</span>
    <span class="token keyword">final</span> <span class="token class-name">FileSystem</span> fs <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getFileSystem</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">;</span>
    fileIn <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">CompressionCodec</span> codec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompressionCodecFactory</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCodec</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//判断切片是否为压缩格式</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">!=</span>codec<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      isCompressedInput <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>	
      decompressor <span class="token operator">=</span> <span class="token class-name">CodecPool</span><span class="token punctuation">.</span><span class="token function">getDecompressor</span><span class="token punctuation">(</span>codec<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>codec <span class="token keyword">instanceof</span> <span class="token class-name">SplittableCompressionCodec</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token class-name">SplitCompressionInputStream</span> cIn <span class="token operator">=</span>
          <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">SplittableCompressionCodec</span><span class="token punctuation">)</span>codec<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createInputStream</span><span class="token punctuation">(</span>
            fileIn<span class="token punctuation">,</span> decompressor<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">,</span>
            <span class="token class-name">SplittableCompressionCodec</span><span class="token punctuation">.</span><span class="token constant">READ_MODE</span><span class="token punctuation">.</span><span class="token constant">BYBLOCK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompressedSplitLineReader</span><span class="token punctuation">(</span>cIn<span class="token punctuation">,</span> job<span class="token punctuation">,</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>recordDelimiterBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        start <span class="token operator">=</span> cIn<span class="token punctuation">.</span><span class="token function">getAdjustedStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        end <span class="token operator">=</span> cIn<span class="token punctuation">.</span><span class="token function">getAdjustedEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        filePosition <span class="token operator">=</span> cIn<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          
        in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SplitLineReader</span><span class="token punctuation">(</span>codec<span class="token punctuation">.</span><span class="token function">createInputStream</span><span class="token punctuation">(</span>fileIn<span class="token punctuation">,</span>
            decompressor<span class="token punctuation">)</span><span class="token punctuation">,</span> job<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>recordDelimiterBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        filePosition <span class="token operator">=</span> fileIn<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      fileIn<span class="token punctuation">.</span><span class="token function">seek</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建一个SplitLineReader对象，用于读取一行数据</span>
      in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UncompressedSplitLineReader</span><span class="token punctuation">(</span>
          fileIn<span class="token punctuation">,</span> job<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>recordDelimiterBytes<span class="token punctuation">,</span> split<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      filePosition <span class="token operator">=</span> fileIn<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// If this is not the first split, we always throw away first record</span>
    <span class="token comment">// because we always (except the last split) read one extra line in</span>
    <span class="token comment">// next() method.</span>
    <span class="token comment">// 开始读取数据</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// new Text() 可以解释Map端Value输入总是用Text类型</span>
      start <span class="token operator">+=</span> in<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">maxBytesToConsume</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 将读取长度赋予给偏移量，可以解释Map端输入Key为LongWritable类型</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pos <span class="token operator">=</span> start<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_467"></a>小文件合并</h5> 
<h6><a id="_469"></a>读取数据过程中，如果小文件过多会导致什么问题?</h6> 
<blockquote> 
 <p>根据切片逻辑，一个小文件对应一个切片，一个切片又对应一个MapTask</p> 
 <pre><code>  1. 当小文件过多时，导致ApplicationMaster向ResourceManager申请资源过多，会导致资源浪费。同时如果ResourceManager本身资源不充足情况下，申请过多的MapTask会导致当前程序一直处于接收状态，无法运行
  2. 申请MapTask本身也需要消耗时间，当小文件数据量过少时，反而导致运行时间过长
</code></pre> 
</blockquote> 
<h6><a id="_476"></a>解决方法：</h6> 
<blockquote> 
 <p>在读取文件时，可以对小文件进行合并操作</p> 
</blockquote> 
<blockquote> 
 <p>修改切片大小方式：切片大小可以通过computeSplitSize方法进行查看，通过修改"mapreduce.input.fileinputformat.split.maxsize" 和"mapreduce.input.fileinputformat.split.minsize"可以解决</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/56/69/2j2gQL30_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="_485"></a>源码</h6> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InputSplit</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSplits</span><span class="token punctuation">(</span><span class="token class-name">JobContext</span> job<span class="token punctuation">)</span> 
  <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">long</span> minSizeNode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">long</span> minSizeRack <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">long</span> maxSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token class-name">Configuration</span> conf <span class="token operator">=</span> job<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
。。。
  <span class="token keyword">if</span> <span class="token punctuation">(</span>maxSplitSize <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    maxSize <span class="token operator">=</span> maxSplitSize<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 可以获取到我们逻辑中设置的参数</span>
    maxSize <span class="token operator">=</span> conf<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token string">"mapreduce.input.fileinputformat.split.maxsize"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// If maxSize is not configured, a single split will be generated per</span>
    <span class="token comment">// node.</span>
  <span class="token punctuation">}</span>
 。。。

  <span class="token comment">// all the files in input set</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FileStatus</span><span class="token punctuation">&gt;</span></span> stats <span class="token operator">=</span> <span class="token function">listStatus</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InputSplit</span><span class="token punctuation">&gt;</span></span> splits <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InputSplit</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> splits<span class="token punctuation">;</span>    
  <span class="token punctuation">}</span>

  <span class="token comment">// In one single iteration, process all the paths in a single pool.</span>
  <span class="token comment">// Processing one pool at a time ensures that a split contains paths</span>
  <span class="token comment">// from a single pool only.</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MultiPathFilter</span> onepool <span class="token operator">:</span> pools<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FileStatus</span><span class="token punctuation">&gt;</span></span> myPaths <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FileStatus</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
。。。
    <span class="token comment">// 通过getMoreSplits方法获取切片</span>
    <span class="token comment">// create splits for all files in this pool.</span>
    <span class="token function">getMoreSplits</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> myPaths<span class="token punctuation">,</span> maxSize<span class="token punctuation">,</span> minSizeNode<span class="token punctuation">,</span> minSizeRack<span class="token punctuation">,</span> splits<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// create splits for all files that are not in any pool.</span>
  <span class="token function">getMoreSplits</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> stats<span class="token punctuation">,</span> maxSize<span class="token punctuation">,</span> minSizeNode<span class="token punctuation">,</span> minSizeRack<span class="token punctuation">,</span> splits<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>getMoreSplits 方法</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">getMoreSplits</span><span class="token punctuation">(</span><span class="token class-name">JobContext</span> job<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FileStatus</span><span class="token punctuation">&gt;</span></span> stats<span class="token punctuation">,</span>
                             <span class="token keyword">long</span> maxSize<span class="token punctuation">,</span> <span class="token keyword">long</span> minSizeNode<span class="token punctuation">,</span> <span class="token keyword">long</span> minSizeRack<span class="token punctuation">,</span>
                             <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InputSplit</span><span class="token punctuation">&gt;</span></span> splits<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// populate all the blocks for all files</span>
    <span class="token keyword">long</span> totLength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">FileStatus</span> stat <span class="token operator">:</span> stats<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 创建一个OneFileInfo对象，所以查看OneFileInfo对象的构造方法 </span>
      files<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OneFileInfo</span><span class="token punctuation">(</span>stat<span class="token punctuation">,</span> conf<span class="token punctuation">,</span> <span class="token function">isSplitable</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> stat<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                 rackToBlocks<span class="token punctuation">,</span> blockToNodes<span class="token punctuation">,</span> nodeToBlocks<span class="token punctuation">,</span>
                                 rackToNodes<span class="token punctuation">,</span> maxSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
      totLength <span class="token operator">+=</span> files<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>OneFileInfo对象的构造方法</p> 
<pre><code class="prism language-java"><span class="token class-name">OneFileInfo</span><span class="token punctuation">(</span><span class="token class-name">FileStatus</span> stat<span class="token punctuation">,</span> <span class="token class-name">Configuration</span> conf<span class="token punctuation">,</span>
                <span class="token keyword">boolean</span> isSplitable<span class="token punctuation">,</span>
                <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">OneBlockInfo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> rackToBlocks<span class="token punctuation">,</span>
                <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token class-name">OneBlockInfo</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> blockToNodes<span class="token punctuation">,</span>
                <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">OneBlockInfo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> nodeToBlocks<span class="token punctuation">,</span>
                <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> rackToNodes<span class="token punctuation">,</span>
                <span class="token keyword">long</span> maxSize<span class="token punctuation">)</span>
                <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>fileSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

      <span class="token comment">// get block locations from file system</span>
      <span class="token class-name">BlockLocation</span><span class="token punctuation">[</span><span class="token punctuation">]</span> locations<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>stat <span class="token keyword">instanceof</span> <span class="token class-name">LocatedFileStatus</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        locations <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">LocatedFileStatus</span><span class="token punctuation">)</span> stat<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBlockLocations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">FileSystem</span> fs <span class="token operator">=</span> stat<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFileSystem</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        locations <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">getFileBlockLocations</span><span class="token punctuation">(</span>stat<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> stat<span class="token punctuation">.</span><span class="token function">getLen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
。。。
	<span class="token comment">// 如果文件可切分，那么再进行切分</span>
	 <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OneBlockInfo</span><span class="token punctuation">&gt;</span></span> blocksList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OneBlockInfo</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
              locations<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> locatio<span class="token operator">!</span><span class="token punctuation">[</span>在这里插入图片描述<span class="token punctuation">]</span><span class="token punctuation">(</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>img<span class="token operator">-</span>blog<span class="token punctuation">.</span>csdnimg<span class="token punctuation">.</span>cn<span class="token operator">/</span>b773c16937dc46998cc5c00db7064ddc<span class="token punctuation">.</span>png#pic_center<span class="token punctuation">)</span>
ns<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            fileSize <span class="token operator">+=</span> locations<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// each split can be a maximum of maxSize</span>
            <span class="token comment">// 获取文件长度</span>
            <span class="token keyword">long</span> left <span class="token operator">=</span> locations<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> myOffset <span class="token operator">=</span> locations<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> myLength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 如果当切片大小没有设置情况下，等于整个文件长度</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>maxSize <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                myLength <span class="token operator">=</span> left<span class="token punctuation">;</span>
              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                 <span class="token comment">// 如果当文件大小在切片的 1到2倍之间 文件一分为二</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>left <span class="token operator">&gt;</span> maxSize <span class="token operator">&amp;&amp;</span> left <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token operator">*</span> maxSize<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                  <span class="token comment">// if remainder is between max and 2*max - then</span>
                  <span class="token comment">// instead of creating splits of size max, left-max we</span>
                  <span class="token comment">// create splits of size left/2 and left/2. This is</span>
                  <span class="token comment">// a heuristic to avoid creating really really small</span>
                  <span class="token comment">// splits.</span>
                  myLength <span class="token operator">=</span> left <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 取文件和切片的最小值，如果文件是大于切片数的两倍取切片大小，小于取文件大小</span>
                  myLength <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>maxSize<span class="token punctuation">,</span> left<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">}</span>
              
 。。。。
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h6><a id="FileInputFormat_609"></a>输入类为什么为FileInputFormat</h6> 
<p>从job.waitForCompletion提交开始进入，进入方法内后有submit方法，再进入该方法内</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
         <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">ensureState</span><span class="token punctuation">(</span><span class="token class-name">JobState</span><span class="token punctuation">.</span><span class="token constant">DEFINE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置当前API为最新的API</span>
    <span class="token function">setUseNewAPI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建连接</span>
    <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取提交对象 submitter</span>
    <span class="token keyword">final</span> <span class="token class-name">JobSubmitter</span> submitter <span class="token operator">=</span> 
        <span class="token function">getJobSubmitter</span><span class="token punctuation">(</span>cluster<span class="token punctuation">.</span><span class="token function">getFileSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cluster<span class="token punctuation">.</span><span class="token function">getClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    status <span class="token operator">=</span> ugi<span class="token punctuation">.</span><span class="token function">doAs</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrivilegedExceptionAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JobStatus</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">public</span> <span class="token class-name">JobStatus</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> 
      <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 做具体的提交工作，运行之前的配置步骤都会在该方法中</span>
        <span class="token keyword">return</span> submitter<span class="token punctuation">.</span><span class="token function">submitJobInternal</span><span class="token punctuation">(</span><span class="token class-name">Job</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> cluster<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 改变状态为运行状态</span>
    state <span class="token operator">=</span> <span class="token class-name">JobState</span><span class="token punctuation">.</span><span class="token constant">RUNNING</span><span class="token punctuation">;</span>
    <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"The url to track the job: "</span> <span class="token operator">+</span> <span class="token function">getTrackingURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
</code></pre> 
<p>进入submitJobInternal方法</p> 
<pre><code class="prism language-java"><span class="token class-name">JobStatus</span> <span class="token function">submitJobInternal</span><span class="token punctuation">(</span><span class="token class-name">Job</span> job<span class="token punctuation">,</span> <span class="token class-name">Cluster</span> cluster<span class="token punctuation">)</span> 
<span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>

<span class="token comment">// 用于检查输出空间，如果文件已存在，那么会抛出异常</span>
 <span class="token function">checkSpecs</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">;</span>

。。。
	  <span class="token comment">// Create the splits for the job</span>
      <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Creating splits at "</span> <span class="token operator">+</span> jtFs<span class="token punctuation">.</span><span class="token function">makeQualified</span><span class="token punctuation">(</span>submitJobDir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 用于创建具体的切片数</span>
      <span class="token keyword">int</span> maps <span class="token operator">=</span> <span class="token function">writeSplits</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> submitJobDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
      conf<span class="token punctuation">.</span><span class="token function">setInt</span><span class="token punctuation">(</span><span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span><span class="token constant">NUM_MAPS</span><span class="token punctuation">,</span> maps<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"number of splits:"</span> <span class="token operator">+</span> maps<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>进入writeSplits方法内</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">writeSplits</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span></span>JobContext</span> job<span class="token punctuation">,</span>
    <span class="token class-name">Path</span> jobSubmitDir<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span>
    <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{<!-- --></span>
  <span class="token class-name">JobConf</span> jConf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">JobConf</span><span class="token punctuation">)</span>job<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> maps<span class="token punctuation">;</span>
  <span class="token comment">// 由于之前已设置当前API为最新所以对应结果为TRUE</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>jConf<span class="token punctuation">.</span><span class="token function">getUseNewMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    maps <span class="token operator">=</span> <span class="token function">writeNewSplits</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> jobSubmitDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    maps <span class="token operator">=</span> <span class="token function">writeOldSplits</span><span class="token punctuation">(</span>jConf<span class="token punctuation">,</span> jobSubmitDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> maps<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>进入writeNewSplits方法内</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">InputSplit</span><span class="token punctuation">&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">writeNewSplits</span><span class="token punctuation">(</span><span class="token class-name">JobContext</span> job<span class="token punctuation">,</span> <span class="token class-name">Path</span> jobSubmitDir<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span>
    <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{<!-- --></span>
  <span class="token class-name">Configuration</span> conf <span class="token operator">=</span> job<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// job.getInputFormatClass() 获取对应配置信息为 JobContextImpl类中的   conf.getClass(INPUT_FORMAT_CLASS_ATTR, TextInputFormat.class);结果</span>
  <span class="token class-name">InputFormat</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> input <span class="token operator">=</span>
    <span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>job<span class="token punctuation">.</span><span class="token function">getInputFormatClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> conf<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// 获取到其对象后调用getSplits方法获取最后的切片列表</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InputSplit</span><span class="token punctuation">&gt;</span></span> splits <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">getSplits</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> splits<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputSplit</span><span class="token punctuation">[</span>splits<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// sort the splits into order based on size, so that the biggest</span>
  <span class="token comment">// go first</span>
  <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SplitComparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">JobSplitWriter</span><span class="token punctuation">.</span><span class="token function">createSplitFiles</span><span class="token punctuation">(</span>jobSubmitDir<span class="token punctuation">,</span> conf<span class="token punctuation">,</span> 
      jobSubmitDir<span class="token punctuation">.</span><span class="token function">getFileSystem</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">,</span> array<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> array<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="Shuffle_697"></a>Shuffle过程</h5> 
<h6><a id="shuffle_699"></a>shuffle过程上：</h6> 
<p><img src="https://images2.imgbox.com/d5/d9/hv0Tybvp_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="shuffle_704"></a>shuffle过程下：</h6> 
<p><img src="https://images2.imgbox.com/08/03/FFveri47_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>代码断点：</p> 
 <p>​ ①跑代码时，对应查看Reduce方法中Key的顺序，需要将ReduceTask数量设置为1个</p> 
 <p>​ ②通过查看结果，可以知道Key为有序，并且是按照字典顺序进行排序，字典排序是根据ASC码表进行比较，并且比较是是按对应位置进行比较大小，例如如下顺序：</p> 
 <p>​ 1 11 2 3</p> 
</blockquote> 
<h6><a id="Combiner_717"></a>Combiner预聚合</h6> 
<p>作用：将Reduce端的逻辑提前到Map端进行处理，可以在很大程度上降低网络IO,但是注意，并不是所有的reduce函数处理逻辑都可以提前</p> 
<p>具体执行效果如下：</p> 
<p>​ Map input records=1098250<br> ​ Map output records=2280970<br> ​ Map output bytes=25597490<br> ​ Map output materialized bytes=232<br> ​ Input split bytes=468<br> ​ Combine input records=2280970<br> ​ Combine output records=16<br> ​ Reduce input groups=4<br> ​ Reduce shuffle bytes=232<br> ​ Reduce input records=16<br> ​ Reduce output records=4</p> 
<h6><a id="MapTask_735"></a>MapTask</h6> 
<p>查看MapTask源码步骤</p> 
<p>由于Driver端主要是用于数据提交，所以入口在Mapper端，而Mapper端中通常数据写出是由Writer方法调用，所以通过该方法进入源码</p> 
<p>通过点击context.write进入后是一个抽象类，需要查看其子实现，由于其子实现类有多个，如果一时间无法判断，那么可以通过在多个类中打断点来查看具体执行，为哪个子实现类的方法。</p> 
<blockquote> 
 <p>TaskInputOutputContext.write -&gt; WrappedMapper-&gt;TaskInputOutputContextImpl -&gt; RecordWriter-&gt; MapTask(NewOutputCollector)</p> 
</blockquote> 
<p>NewOutputCollector类中方法：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 该collector为MapOutputCollector的实现类MapOutputBuffer对象</span>
    collector<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span>
                      <span class="token comment">// 通过HashPartitioner类中的getPartition实现具体分区逻辑</span>
                    partitioner<span class="token punctuation">.</span><span class="token function">getPartition</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> partitions<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>分区逻辑</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getPartition</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">,</span>
                        <span class="token keyword">int</span> numReduceTasks<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 可以从此看出ReduceTask与分区的关系</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span> <span class="token operator">%</span> numReduceTasks<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>进入 MapOutputCollector类中查看方法</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context
                <span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">,</span> <span class="token keyword">int</span> partition
                   <span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span>
<span class="token comment">// 会调用flush方法</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span>
 
<span class="token comment">// 用于当整个MapTask关闭时，将缓存中的数据刷写到磁盘中，并做merge</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> 
                           <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">;</span>
</code></pre> 
<p>首先进入MapOutputBuffer中的collect方法</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> partition
                                     <span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
      reporter<span class="token punctuation">.</span><span class="token function">progress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 判断Map端输入的类型与Driver端设置的类型是否一致</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> keyClass<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"Type mismatch in key from map: expected "</span>
                              <span class="token operator">+</span> keyClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", received "</span>
                              <span class="token operator">+</span> key<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
     <span class="token comment">// 判断Map端输入的类型与Driver端设置的类型是否一致</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> valClass<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"Type mismatch in value from map: expected "</span>
                              <span class="token operator">+</span> valClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", received "</span>
                              <span class="token operator">+</span> value<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token comment">// 用来判断分区数是否正常</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>partition <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> partition <span class="token operator">&gt;=</span> partitions<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"Illegal partition for "</span> <span class="token operator">+</span> key <span class="token operator">+</span> <span class="token string">" ("</span> <span class="token operator">+</span>
            partition <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    
      <span class="token function">checkSpillException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 查看当前类的init方法  知道 bufferRemaining为当前缓存大小（100M）的80%（阈值）</span>
      bufferRemaining <span class="token operator">-=</span> <span class="token constant">METASIZE</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>bufferRemaining <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// start spill if the thread is not running and the soft limit has been</span>
        <span class="token comment">// reached</span>
        spillLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
              <span class="token comment">// 如果溢写操作已执行</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>spillInProgress<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token keyword">final</span> <span class="token keyword">int</span> kvbidx <span class="token operator">=</span> <span class="token number">4</span> <span class="token operator">*</span> kvindex<span class="token punctuation">;</span>
              <span class="token keyword">final</span> <span class="token keyword">int</span> kvbend <span class="token operator">=</span> <span class="token number">4</span> <span class="token operator">*</span> kvend<span class="token punctuation">;</span>
              <span class="token comment">// serialized, unspilled bytes always lie between kvindex and</span>
              <span class="token comment">// bufindex, crossing the equator. Note that any void space</span>
              <span class="token comment">// created by a reset must be included in "used" bytes</span>
              <span class="token keyword">final</span> <span class="token keyword">int</span> bUsed <span class="token operator">=</span> <span class="token function">distanceTo</span><span class="token punctuation">(</span>kvbidx<span class="token punctuation">,</span> bufindex<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">final</span> <span class="token keyword">boolean</span> bufsoftlimit <span class="token operator">=</span> bUsed <span class="token operator">&gt;=</span> softLimit<span class="token punctuation">;</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>kvbend <span class="token operator">+</span> <span class="token constant">METASIZE</span><span class="token punctuation">)</span> <span class="token operator">%</span> kvbuffer<span class="token punctuation">.</span>length <span class="token operator">!=</span>
                  equator <span class="token operator">-</span> <span class="token punctuation">(</span>equator <span class="token operator">%</span> <span class="token constant">METASIZE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// spill finished, reclaim space</span>
                <span class="token comment">// 当执行完成以后，开启重置操作</span>
                  <span class="token function">resetSpill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                bufferRemaining <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>
                    <span class="token function">distanceTo</span><span class="token punctuation">(</span>bufindex<span class="token punctuation">,</span> kvbidx<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token constant">METASIZE</span><span class="token punctuation">,</span>
                    softLimit <span class="token operator">-</span> bUsed<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token constant">METASIZE</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>bufsoftlimit <span class="token operator">&amp;&amp;</span> kvindex <span class="token operator">!=</span> kvend<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// spill records, if any collected; check latter, as it may</span>
                <span class="token comment">// be possible for metadata alignment to hit spill pcnt</span>
                <span class="token comment">// 开始溢写</span>
                  <span class="token function">startSpill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> avgRec <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>
                  <span class="token punctuation">(</span>mapOutputByteCounter<span class="token punctuation">.</span><span class="token function">getCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span>
                  mapOutputRecordCounter<span class="token punctuation">.</span><span class="token function">getCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                
     。。。
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">MapOutputCollector<span class="token punctuation">.</span>Context</span> context
                <span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{<!-- --></span>
  job <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getJobConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  reporter <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getReporter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  mapTask <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getMapTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  mapOutputFile <span class="token operator">=</span> mapTask<span class="token punctuation">.</span><span class="token function">getMapOutputFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  sortPhase <span class="token operator">=</span> mapTask<span class="token punctuation">.</span><span class="token function">getSortPhase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  spilledRecordsCounter <span class="token operator">=</span> reporter<span class="token punctuation">.</span><span class="token function">getCounter</span><span class="token punctuation">(</span><span class="token class-name">TaskCounter</span><span class="token punctuation">.</span><span class="token constant">SPILLED_RECORDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  partitions <span class="token operator">=</span> job<span class="token punctuation">.</span><span class="token function">getNumReduceTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  rfs <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">LocalFileSystem</span><span class="token punctuation">)</span><span class="token class-name">FileSystem</span><span class="token punctuation">.</span><span class="token function">getLocal</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRaw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//sanity checks</span>
  <span class="token keyword">final</span> <span class="token keyword">float</span> spillper <span class="token operator">=</span>
      <span class="token comment">// 阈值0.8</span>
    job<span class="token punctuation">.</span><span class="token function">getFloat</span><span class="token punctuation">(</span><span class="token class-name">JobContext</span><span class="token punctuation">.</span><span class="token constant">MAP_SORT_SPILL_PERCENT</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token number">0.8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token keyword">int</span> sortmb <span class="token operator">=</span> job<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token class-name">JobContext</span><span class="token punctuation">.</span><span class="token constant">IO_SORT_MB</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 1024 * 1024</span>
  indexCacheMemoryLimit <span class="token operator">=</span> job<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token class-name">JobContext</span><span class="token punctuation">.</span><span class="token constant">INDEX_CACHE_MEMORY_LIMIT</span><span class="token punctuation">,</span>
                                     <span class="token constant">INDEX_CACHE_MEMORY_LIMIT_DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>spillper <span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token number">1.0</span> <span class="token operator">||</span> spillper <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"Invalid \""</span> <span class="token operator">+</span> <span class="token class-name">JobContext</span><span class="token punctuation">.</span><span class="token constant">MAP_SORT_SPILL_PERCENT</span> <span class="token operator">+</span>
        <span class="token string">"\": "</span> <span class="token operator">+</span> spillper<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
    <span class="token comment">// 0x7FF为2047 当sortmb=100和2047做位运算，如果不等于sortmb那么抛出异常，限定sortmb最大只能为2G</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sortmb <span class="token operator">&amp;</span> <span class="token number">0x7FF</span><span class="token punctuation">)</span> <span class="token operator">!=</span> sortmb<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span>
        <span class="token string">"Invalid \""</span> <span class="token operator">+</span> <span class="token class-name">JobContext</span><span class="token punctuation">.</span><span class="token constant">IO_SORT_MB</span> <span class="token operator">+</span> <span class="token string">"\": "</span> <span class="token operator">+</span> sortmb<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
    <span class="token comment">// 定义当前类为QuickSort.class,快排</span>
  sorter <span class="token operator">=</span> <span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>job<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token string">"map.sort.class"</span><span class="token punctuation">,</span>
        <span class="token class-name">QuickSort</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">IndexedSorter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> job<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// buffers and accounting</span>
  <span class="token comment">// 创建了sortmb=100M的字节数值  100M * 2的10次方</span>
  <span class="token keyword">int</span> maxMemUsage <span class="token operator">=</span> sortmb <span class="token operator">&lt;&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span>
  maxMemUsage <span class="token operator">-=</span> maxMemUsage <span class="token operator">%</span> <span class="token constant">METASIZE</span><span class="token punctuation">;</span>
   
  <span class="token comment">// 创建内存缓冲区的大小 </span>
  kvbuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>maxMemUsage<span class="token punctuation">]</span><span class="token punctuation">;</span>
  bufvoid <span class="token operator">=</span> kvbuffer<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  kvmeta <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>kvbuffer<span class="token punctuation">)</span>
     <span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token class-name">ByteOrder</span><span class="token punctuation">.</span><span class="token function">nativeOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">.</span><span class="token function">asIntBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setEquator</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  bufstart <span class="token operator">=</span> bufend <span class="token operator">=</span> bufindex <span class="token operator">=</span> equator<span class="token punctuation">;</span>
  kvstart <span class="token operator">=</span> kvend <span class="token operator">=</span> kvindex<span class="token punctuation">;</span>

  maxRec <span class="token operator">=</span> kvmeta<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token constant">NMETA</span><span class="token punctuation">;</span>
    <span class="token comment">// 阈值内的内存大小 softLimit</span>
  softLimit <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>kvbuffer<span class="token punctuation">.</span>length <span class="token operator">*</span> spillper<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 当前缓存剩余量，一开始为100M * 80%</span>
  bufferRemaining <span class="token operator">=</span> softLimit<span class="token punctuation">;</span>
  <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token class-name">JobContext</span><span class="token punctuation">.</span><span class="token constant">IO_SORT_MB</span> <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> sortmb<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"soft limit at "</span> <span class="token operator">+</span> softLimit<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"bufstart = "</span> <span class="token operator">+</span> bufstart <span class="token operator">+</span> <span class="token string">"; bufvoid = "</span> <span class="token operator">+</span> bufvoid<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"kvstart = "</span> <span class="token operator">+</span> kvstart <span class="token operator">+</span> <span class="token string">"; length = "</span> <span class="token operator">+</span> maxRec<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// k/v serialization</span>
  comparator <span class="token operator">=</span> job<span class="token punctuation">.</span><span class="token function">getOutputKeyComparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  keyClass <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>job<span class="token punctuation">.</span><span class="token function">getMapOutputKeyClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  valClass <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>job<span class="token punctuation">.</span><span class="token function">getMapOutputValueClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  serializationFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SerializationFactory</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">;</span>
  keySerializer <span class="token operator">=</span> serializationFactory<span class="token punctuation">.</span><span class="token function">getSerializer</span><span class="token punctuation">(</span>keyClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
  keySerializer<span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span>bb<span class="token punctuation">)</span><span class="token punctuation">;</span>
  valSerializer <span class="token operator">=</span> serializationFactory<span class="token punctuation">.</span><span class="token function">getSerializer</span><span class="token punctuation">(</span>valClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
  valSerializer<span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span>bb<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 记录输出的数据量</span>
  <span class="token comment">// output counters</span>
  mapOutputByteCounter <span class="token operator">=</span> reporter<span class="token punctuation">.</span><span class="token function">getCounter</span><span class="token punctuation">(</span><span class="token class-name">TaskCounter</span><span class="token punctuation">.</span><span class="token constant">MAP_OUTPUT_BYTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  mapOutputRecordCounter <span class="token operator">=</span>
    reporter<span class="token punctuation">.</span><span class="token function">getCounter</span><span class="token punctuation">(</span><span class="token class-name">TaskCounter</span><span class="token punctuation">.</span><span class="token constant">MAP_OUTPUT_RECORDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  fileOutputByteCounter <span class="token operator">=</span> reporter
      <span class="token punctuation">.</span><span class="token function">getCounter</span><span class="token punctuation">(</span><span class="token class-name">TaskCounter</span><span class="token punctuation">.</span><span class="token constant">MAP_OUTPUT_MATERIALIZED_BYTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 如果有预聚合功能，那么会提前创建一个combinerRunner 有这个类再去创建一个combineCollector</span>
  <span class="token comment">// combiner</span>
  <span class="token keyword">final</span> <span class="token class-name">Counters<span class="token punctuation">.</span>Counter</span> combineInputCounter <span class="token operator">=</span>
    reporter<span class="token punctuation">.</span><span class="token function">getCounter</span><span class="token punctuation">(</span><span class="token class-name">TaskCounter</span><span class="token punctuation">.</span><span class="token constant">COMBINE_INPUT_RECORDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  combinerRunner <span class="token operator">=</span> <span class="token class-name">CombinerRunner</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> <span class="token function">getTaskID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
                                         combineInputCounter<span class="token punctuation">,</span>
                                         reporter<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>combinerRunner <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">final</span> <span class="token class-name">Counters<span class="token punctuation">.</span>Counter</span> combineOutputCounter <span class="token operator">=</span>
      reporter<span class="token punctuation">.</span><span class="token function">getCounter</span><span class="token punctuation">(</span><span class="token class-name">TaskCounter</span><span class="token punctuation">.</span><span class="token constant">COMBINE_OUTPUT_RECORDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    combineCollector<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CombineOutputCollector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>combineOutputCounter<span class="token punctuation">,</span> reporter<span class="token punctuation">,</span> job<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    combineCollector <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
   <span class="token comment">// 溢写执行标记</span>
  spillInProgress <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  minSpillsForCombine <span class="token operator">=</span> job<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token class-name">JobContext</span><span class="token punctuation">.</span><span class="token constant">MAP_COMBINE_MIN_SPILLS</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  spillThread<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  spillThread<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"SpillThread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  spillLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 执行了溢写进程</span>
    spillThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>spillThreadRunning<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      spillDone<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"Spill thread failed to initialize"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
    spillLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>sortSpillException <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"Spill thread failed to initialize"</span><span class="token punctuation">,</span>
        sortSpillException<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>startSpill()</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startSpill</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">assert</span> <span class="token operator">!</span>spillInProgress<span class="token punctuation">;</span>
      kvend <span class="token operator">=</span> <span class="token punctuation">(</span>kvindex <span class="token operator">+</span> <span class="token constant">NMETA</span><span class="token punctuation">)</span> <span class="token operator">%</span> kvmeta<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      bufend <span class="token operator">=</span> bufmark<span class="token punctuation">;</span>
      <span class="token comment">// 设置溢写标记  </span>
      spillInProgress <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Spilling map output"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"bufstart = "</span> <span class="token operator">+</span> bufstart <span class="token operator">+</span> <span class="token string">"; bufend = "</span> <span class="token operator">+</span> bufmark <span class="token operator">+</span>
               <span class="token string">"; bufvoid = "</span> <span class="token operator">+</span> bufvoid<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"kvstart = "</span> <span class="token operator">+</span> kvstart <span class="token operator">+</span> <span class="token string">"("</span> <span class="token operator">+</span> <span class="token punctuation">(</span>kvstart <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">+</span>
               <span class="token string">"); kvend = "</span> <span class="token operator">+</span> kvend <span class="token operator">+</span> <span class="token string">"("</span> <span class="token operator">+</span> <span class="token punctuation">(</span>kvend <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">+</span>
               <span class="token string">"); length = "</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token function">distanceTo</span><span class="token punctuation">(</span>kvend<span class="token punctuation">,</span> kvstart<span class="token punctuation">,</span>
                     kvmeta<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> maxRec<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 开启溢写进程 ，进入 run（）方法</span>
    spillReady<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>SpillThread的run（）</p> 
<pre><code class="prism language-java"><span class="token keyword">protected</span> <span class="token keyword">class</span> <span class="token class-name">SpillThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{<!-- --></span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    。。。
  	<span class="token comment">// 该方法在溢写时，会对数据进行做排序操作，并生成溢写文件</span>
          <span class="token function">sortAndSpill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    。。。
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="_996"></a>获取分区类代码</h6> 
<pre><code class="prism language-java">collector<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span>
                        partitioner<span class="token punctuation">.</span><span class="token function">getPartition</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> partitions<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>通过partitioner对象查看其创建过程</p> 
<pre><code class="prism language-java">partitioner <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span></span>Partitioner</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
          <span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>jobContext<span class="token punctuation">.</span><span class="token function">getPartitionerClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> job<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>通过查看jobContext.getPartitionerClass()方法</p> 
<pre><code class="prism language-java"><span class="token class-name">JobContextImpl</span>类中：
<span class="token keyword">public</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Partitioner</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getPartitionerClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
     <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Partitioner</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> 
       <span class="token comment">// PARTITIONER_CLASS_ATTR = "mapreduce.job.partitioner.class" 默认为 HashPartitioner.class</span>
      conf<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token constant">PARTITIONER_CLASS_ATTR</span><span class="token punctuation">,</span> <span class="token class-name">HashPartitioner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<h6><a id="_1022"></a>排序</h6> 
<pre><code class="prism language-java">sorter <span class="token operator">=</span> <span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>job<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token string">"map.sort.class"</span><span class="token punctuation">,</span>
            <span class="token class-name">QuickSort</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">IndexedSorter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> job<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">U</span><span class="token punctuation">&gt;</span></span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> 
                                         <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">U</span><span class="token punctuation">&gt;</span></span> defaultValue<span class="token punctuation">,</span> 
                                         <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">&gt;</span></span> xface<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> theClass <span class="token operator">=</span> <span class="token function">getClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> defaultValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>theClass <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>xface<span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>theClass<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>theClass<span class="token operator">+</span><span class="token string">" not "</span><span class="token operator">+</span>xface<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>theClass <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> theClass<span class="token punctuation">.</span><span class="token function">asSubclass</span><span class="token punctuation">(</span>xface<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h6><a id="Outputformat_1041"></a>Outputformat</h6> 
<p>TextOutputFormat</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">)</span>
  <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>

  <span class="token keyword">boolean</span> nullKey <span class="token operator">=</span> key <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> key <span class="token keyword">instanceof</span> <span class="token class-name">NullWritable</span><span class="token punctuation">;</span>
  <span class="token keyword">boolean</span> nullValue <span class="token operator">=</span> value <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> value <span class="token keyword">instanceof</span> <span class="token class-name">NullWritable</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>nullKey <span class="token operator">&amp;&amp;</span> nullValue<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nullKey<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">writeObject</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>nullKey <span class="token operator">||</span> nullValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>keyValueSeparator<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nullValue<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">writeObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>newline<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_1067"></a>总结</h5> 
<p><img src="https://images2.imgbox.com/78/8f/cNlm9W3M_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="Mapreduce_1072"></a>Mapreduce的计算流程</h6> 
<p>map阶段 —&gt; shuffle阶段 —&gt; reduce阶段</p> 
<h6><a id="1map_1076"></a>1、map阶段</h6> 
<p>在进行map计算之前，mapreduce会根据输入文件计算输入分片（input split），每个输入分片（input split）针对一个map任务，默认一个block对应一个切片。一个切片对应一个MapTask, 切片完成后开始执行自定义map代码逻辑</p> 
<h6><a id="2shuffle_1080"></a>2、shuffle阶段</h6> 
<p><img src="https://images2.imgbox.com/b5/31/HVdysmcs_o.jpg" alt="在这里插入图片描述"></p> 
<ul><li>Mapper任务结束后产生&lt;K2,V2&gt;的输出，这些输出先存放在缓存中，每个map有一个环形内存缓冲区，用于存储任务的输出。默认大小100MB（io.sort.mb属性），一旦达到阀值0.8(io.sort.spil l.percent)，一个后台线程就把内容写到(spill)Linux本地磁盘中的指定目录（mapred.local.dir）下的新建的一个溢出写文件。</li><li>写磁盘前，要进行partition、sort和combine等操作。通过分区，将不同类型的数据分开处理，之后对不同分区的数据进行排序，如果有Combiner，还要对排序后的数据进行combine。等最后记录写完，将全部溢出文件合并为一个分区且排序的文件。</li></ul> 
<h6><a id="3Reduce_1088"></a>3、Reduce阶段</h6> 
<p>当MapTask执行完成之后开始执行ReduceTask</p> 
<ul><li>执行ReduceTask之前会先从Map端拉取</li><li>从map端复制来的数据首先写到reduce端的缓存中，同样缓存占用到达一定阈值后会将数据写到磁盘中，同样会进行partition、combine、排序等过程。如果形成了多个磁盘文件还会进行合并，最后一次合并的结果作为reduce的输入而不是写入到磁盘中。</li><li>最后将合并后的结果作为输入传入Reduce任务中。</li><li>最后就是Reduce过程了，在这个过程中产生了最终的输出结果，并将其写到HDFS上。</li></ul> 
<h6><a id="MR_1097"></a>MR优化</h6> 
<p>MapReduce优化方法主要从六个方面考虑：数据输入、Map阶段、Reduce阶段、IO传输、数据倾斜问题和常用的调优参数</p> 
<h6><a id="_1101"></a>一、数据输入</h6> 
<p>1、合并小文件：因为大量小文件会产生大量的Map任务，而任务的装载比较耗<br> 时，从而导致MR运行较慢<br> 2、采用CombineTextInputFormat来作为输入框架默认的TextInputFormat切片机制是对任务按文件规划切片，不管文件多小，都会是一个单独的切片，都会交给一个MapTask，这样如果有大量小文件，就会产生大量的MapTask，处理效率极其低下。CombineTextInputFormat用于小文件过多的场景，它可以将多个小文件从逻辑上规划到一个切片中，这样，多个小文件就可以交给一个MapTask处理</p> 
<h6><a id="Map_1107"></a>二、Map阶段</h6> 
<blockquote> 
 <p>1、减少溢写（Spill）次数，通过调整参数</p> 
 <ul><li>io.sort.mb：环形缓存区大小</li><li>sort.spill.percent：达到多少表示满，百分比（80%）增大触发spill的内存上限，减少spill次数，从而减少磁盘IO</li></ul> 
</blockquote> 
<blockquote> 
 <p>2、减少合并（Merge）次数，调节参数</p> 
 <ul><li>io.sort.factor：增大每次合并文件的个数，这样减少merge次数</li></ul> 
</blockquote> 
<blockquote> 
 <p>3、在map之后，不影响业务逻辑前提下，先进行Combine处理，减少I/O</p> 
</blockquote> 
<h6><a id="Reduce_1120"></a>三、Reduce阶段</h6> 
<p>1、合理设置Map和Reduce数</p> 
<blockquote> 
 <ul><li>通过设置切片大小改变Map数量</li><li>当Reduce中处理的数据量过大时，可以通过改变ReduceTask数量来增加ReduceTask个数从而分散数据量</li></ul> 
</blockquote> 
<p>2、设置Map、Reduce共存</p> 
<blockquote> 
 <p>调整slowstart.completedmaps参数，使Map运行到一定程度后，Reduce也开始运行，减少Reduce的<br> 等待时间</p> 
</blockquote> 
<p>3、规避使用Reduce</p> 
<blockquote> 
 <p>在不需要使用Reduce时，就不要使用，这样减少shuffle</p> 
</blockquote> 
<h6><a id="IO_1136"></a>四、I/O传输</h6> 
<p>1、采用数据压缩的方式，减少网络IO的时间</p> 
<blockquote> 
 <p>安装Snappy和LZO压缩编码器</p> 
</blockquote> 
<p>2、使用SequenceFile二进制文件</p> 
<h6><a id="_1144"></a>五、数据倾斜</h6> 
<p>1、数据倾斜现象</p> 
<blockquote> 
 <p>数据倾斜通常是发生在Reduce阶段，当Reduce端执行过程中，少量ReduceTask执行缓慢，可以判断为产生的数据倾斜，原因是部分Reduce接收到的相同Key对应的数据量过多，整体数据向少量Reduce倾斜</p> 
</blockquote> 
<p>2、减少数据倾斜的方法</p> 
<blockquote> 
 <ul><li> <p>方法1：抽样和范围分区<br> 可以通过对原始数据进行抽样得到的结果集来预设分区边界值</p> </li><li> <p>方法2：自定义分区<br> 基于输出键的背景知识进行自定义分区。例如，如果Map输出键的单词来源于一本书。且其中某几个专<br> 业词汇较多。那么就可以自定义分区将这这些专业词汇发送给固定的一部分Reduce实例。而将其他的都<br> 发送给剩余的Reduce实例</p> </li><li> <p>方法3：Combine<br> 使用Combine可以大量地减小数据倾斜。在可能的情况下，Combine的目的就是聚合并精简数据</p> </li><li> <p>方法4：Key值过滤</p> <p>通过在Map端对结果中不需要的并产生数据倾斜的Key值进行过滤，从而减少Reduce端处理的压力</p> </li></ul> 
</blockquote> 
<h6><a id="_1167"></a>其他</h6> 
<p>开启JVM重用</p> 
<blockquote> 
 <p>对于大量小文件Job，可以开启JVM重用会减少45%运行时间。<br> JVM重用原理：一个Map运行在一个JVM上，开启重用的话，该Map在JVM上运行完毕后，JVM继续运行<br> 其他Map，减少开启时间<br> 具体设置：mapreduce.job.jvm.numtasks值在10-20之间。</p> 
</blockquote> 
<h6><a id="Shuffle_1176"></a>Shuffle优化</h6> 
<ul><li>配置方面： 
  <ol><li>增大map阶段的缓冲区大小。</li><li>map阶段输出结果使压缩；压缩算法使用lzo。</li><li>增加reduce阶段copy数据线程数。</li><li>增加副本数，从而提高计算时的数据本地化。</li></ol> </li><li>程序方面： 
  <ol><li>在不影响计算结果的情况下建议使用combiner。</li><li>输出结果的序列化类型尽量选择占用字节少的类型。</li></ol> </li><li>架构方面： 
  <ol><li>将http改为udp,因为http还要进行3次握手操作。</li></ol> </li></ul> 
<h4><a id="Yarn_1189"></a>Yarn</h4> 
<h5><a id="Yarn_1191"></a>Yarn工作流程</h5> 
<p><img src="https://images2.imgbox.com/e9/0a/c1MuZ7Q8_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="_1196"></a>阶段描述</h6> 
<h6><a id="_1198"></a>任务提交阶段</h6> 
<ul><li>1.客户端请求执行应用程序</li><li>2.ResourceManager返回客户端应用程序提交路径，以及JobID</li><li>3.客户端接收到请求后，将当前应用程序jar包 以及切片数及其配置信息发送至HDFS指定路径</li><li>4.客户端发送请求，启动ApplicationManager</li><li>5.ApplicationManager启动后将job添加至资源队列ResourceSchedule中</li></ul> 
<h6><a id="_1206"></a>任务初始化阶段</h6> 
<ul><li>6.当资源队列中有空闲资源，通知Manager启动应用程序</li><li>7.Application Manager将任务进行初始化成Task</li><li>8.NodeManager接收到ApplicationManager指令后，创建Container，并在Container中启动ApplicationMaster</li><li>9.ApplicationMaster去HDFS中获取当前应用程序的配置信息及程序jar包</li></ul> 
<h6><a id="_1213"></a>任务分配阶段及任务执行阶段</h6> 
<ul><li>10.ApplicationMaster根据切片信息，向ResourceManager请求资源，启动MapTask，ApplicationMaster接收请求后通知NodeManager启动Container指令</li><li>11.AppMaster向对应的NodeManager中启动MapTask</li><li>12.MapTask启动后会向HDFS读取数据</li><li>13.MapTask执行完成会产生一个临时文件</li><li>14.MapTask结束后，AppMaster会向ResourceManager申请启动ReduceTask</li><li>15.ResourceManager通知NodeManager启动Container指令</li><li>16.AppMaster向对应的NodeManager中启动ReduceTask</li><li>17.拉取对应MapTask输出的数据</li><li>18.根据输出路径将结果数据写入HDFS</li></ul> 
<h6><a id="_1225"></a>任务结束</h6> 
<ul><li>19.当ReduceTask执行完,AppMaster会向ResourceManager申请关闭资源</li></ul> 
<h5><a id="Yarn_1229"></a>Yarn常用命令</h5> 
<p>yarn application -list 查看yarn中的应用程序（job）</p> 
<p>yarn application -kill applicationID 强制退出applicationID</p> 
<h5><a id="Yarn_1235"></a>Yarn资源调度</h5> 
<h6><a id="_1237"></a>调度器种类</h6> 
<p>有三种调度器可以选择： FIFO Scheduler ， Capacity Scheduler ， FairScheduler</p> 
<h6><a id="FIFO_Scheduler_1241"></a>FIFO Scheduler</h6> 
<p>最简单也是最容易理解的调度器，也不需要任何配置，但它并不适用于共享集<br> 群。大的应用可能会占用所有集群资源，这就导致其它应用被阻塞<br> <img src="https://images2.imgbox.com/11/8e/wmobQf5F_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="Capacity_Scheduler_1248"></a>Capacity Scheduler</h6> 
<p>capacity scheduler（容量调度器，apache版本默认使用的调度器）通过为每个组织分配专门的队列，然后再为每个队列分配一定的集群资源，这样整个集群就可以通过设置多个队列的方式给多个组织提供服务了。除此之外，队列内部又可以垂直划分，这样一个组织内部的多个成员就可以共享这个队列资源了，在一个队列内部，资源的调度是采用的是先进先出(FIFO)策略</p> 
<p><img src="https://images2.imgbox.com/d2/81/xSbQfQpx_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="FairScheduler_1256"></a>FairScheduler</h6> 
<p>Fair Scheduler（公平调度器，CDH版本的hadoop默认使用的调度器）</p> 
<p>Fair调度器的设计目标是为所有的应用分配公平的资源（对公平的定义可以通过参数来设置）。公平调度在也可以在多个队列间工作。举个例子，假设有两个用户A和B，他们分别拥有一个队列。当A启动一个job而B没有任务时，A会获得全部集群资源；当B启动一个job后，A的job会继续运行，不过一会儿之后两个任务会各自获得一半的集群资源。如果此时B再启动第二个job并且其它job还在运行，则它将会和B的第一个job共享B这个队列的资源，也就是B的两个job会用于四分之一的集群资源，而A的job仍然用于集群一半的资源，结果就是资源最终在两个用户之间平等的共享。</p> 
<p><img src="https://images2.imgbox.com/17/70/JczFc9jA_o.png" alt="在这里插入图片描述"></p> 
<p>Fair Scheduler 不需要保留集群的资源，因为它会动态在所有正在运行的作业之间平衡资源</p> 
<h6><a id="_1268"></a>调度器区别</h6> 
<ul><li> <p>FIFO调度器：支持单队列 、先进先出 生产环境不会用。</p> </li><li> <p>容量调度器：支持多队列，保证先进入的任务优先执行。</p> </li><li> <p>公平调度器：支持多队列，保证每个任务公平享有队列资源。</p> </li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0a32d871c8b019dd4df75d1afa5a7b6f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">事实证明,OpenCV中对RGB图像数据的存储顺序是BGR</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6e01d92d7509d8c80eb87c7ce98440cc/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">离线使用huggingface bert对文本编码</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>