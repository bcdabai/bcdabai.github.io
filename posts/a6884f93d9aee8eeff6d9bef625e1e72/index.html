<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【Android Framework系列】第3章 Zygote进程相关 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【Android Framework系列】第3章 Zygote进程相关" />
<meta property="og:description" content="1 Zygote简介 Zygote是Android中最重要的一个进程，Zygote进程和Init进程、SystemServer进程是Android最重要的三大进程。Zygote是Android系统创建新进程的核心进程，负责启动Dalvik虚拟机，加载一些必要的系统资源和系统类，启动system_server进程，随后进入等待处理app应用请求。
在Android系统中，应用程序进程都是由Zygote进程孵化出来的，而Zygote进程是由Init进程启动的。Zygote进程在启动时会创建一个Dalvik虚拟机实例，每当它孵化一个新的应用程序进程时，都会将这个Dalvik虚拟机实例复制到新的应用程序进程里面去，从而使得每一个应用程序进程都有一个独立的Dalvik虚拟机实例。
Zygote涉及的类：
frameworks/base/cmds/app_process/app_main.cpp frameworks/base/core/jni/AndroidRuntime.cpp frameworks/base/core/java/com/android/internal/os/ - Zygote.java - ZygoteInit.java - ZygoteServer.java - ZygoteConnection.java 2 Zygote启动 本文基于Android10（Q）的源码做分析
2.1 init进程解析init.rc脚本 Zygote由init进程解析init.rc脚本启动的。脚本传入app_process的main方法做分割，根据字符串命令做相应逻辑。
现在机器分为32位和64位，Zygote的启动脚本init.rc也各有区别:
init.zygote32.rc：zygote进程对应的执行程序是app_process(纯32bit模式)init.zygote64.rc：zygote进程对应的执行程序是app_process64(纯64bit模式)init.zygote32_64.rc：启动两个zygote进程，对应的执行程序分别是app_process32(主模式)、app_process64init.zygote64_32.rc：启动两个zygote进程，对应的执行程序分别是app_process64(主模式)、app_process32 zygote要执行的程序便是system/bin/app_process，它的源代码在app_main.cpp。我们先来看看app_main是如何处理脚本命令：
frameworks/base/cmds/app_process/app_main.cpp
165 #if defined(__LP64__) 166 static const char ABI_LIST_PROPERTY[] = &#34;ro.product.cpu.abilist64&#34;; 167 static const char ZYGOTE_NICE_NAME[] = &#34;zygote64&#34;; 168 #else 169 static const char ABI_LIST_PROPERTY[] = &#34;ro.product.cpu.abilist32&#34;; 170 static const char ZYGOTE_NICE_NAME[] = &#34;zygote&#34;; 171 #endif 172 173 int main(int argc, char* const argv[]) 174 { ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/a6884f93d9aee8eeff6d9bef625e1e72/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-28T15:58:16+08:00" />
<meta property="article:modified_time" content="2023-06-28T15:58:16+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【Android Framework系列】第3章 Zygote进程相关</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="1_Zygote_0"></a>1 Zygote简介</h2> 
<p>Zygote是Android中最重要的一个进程，<code>Zygote进程和Init进程、SystemServer进程是Android最重要的三大进程</code>。<strong>Zygote是Android系统创建新进程的核心进程，负责启动Dalvik虚拟机，加载一些必要的系统资源和系统类，启动system_server进程，随后进入等待处理app应用请求。</strong><br> 在Android系统中，应用程序进程都是由Zygote进程孵化出来的，而Zygote进程是由Init进程启动的。Zygote进程在启动时会创建一个Dalvik虚拟机实例，每当它孵化一个新的应用程序进程时，都会将这个Dalvik虚拟机实例复制到新的应用程序进程里面去，从而使得每一个应用程序进程都有一个独立的Dalvik虚拟机实例。</p> 
<p><strong>Zygote涉及的类：</strong></p> 
<pre><code class="prism language-c">frameworks<span class="token operator">/</span>base<span class="token operator">/</span>cmds<span class="token operator">/</span>app_process<span class="token operator">/</span>app_main<span class="token punctuation">.</span>cpp
frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>jni<span class="token operator">/</span>AndroidRuntime<span class="token punctuation">.</span>cpp
frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>com<span class="token operator">/</span>android<span class="token operator">/</span>internal<span class="token operator">/</span>os<span class="token operator">/</span>
  <span class="token operator">-</span> Zygote<span class="token punctuation">.</span>java
  <span class="token operator">-</span> ZygoteInit<span class="token punctuation">.</span>java
  <span class="token operator">-</span> ZygoteServer<span class="token punctuation">.</span>java
  <span class="token operator">-</span> ZygoteConnection<span class="token punctuation">.</span>java
</code></pre> 
<h2><a id="2_Zygote_14"></a>2 Zygote启动</h2> 
<p><strong>本文基于<code>Android10（Q）</code>的源码做分析</strong></p> 
<h3><a id="21_initinitrc_16"></a>2.1 init进程解析init.rc脚本</h3> 
<p>Zygote由<code>init进程</code>解析<code>init.rc</code>脚本启动的。脚本传入<code>app_process的main方法</code>做分割，根据字符串命令做相应逻辑。</p> 
<blockquote> 
 <p>现在机器分为32位和64位，Zygote的启动脚本init.rc也各有区别:</p> 
 <ul><li>init.zygote32.rc：zygote进程对应的执行程序是app_process(纯32bit模式)</li><li>init.zygote64.rc：zygote进程对应的执行程序是app_process64(纯64bit模式)</li><li>init.zygote32_64.rc：启动两个zygote进程，对应的执行程序分别是app_process32(主模式)、app_process64</li><li>init.zygote64_32.rc：启动两个zygote进程，对应的执行程序分别是app_process64(主模式)、app_process32</li></ul> 
</blockquote> 
<p>zygote要执行的程序便是<code>system/bin/app_process</code>，它的源代码在<code>app_main.cpp</code>。我们先来看看app_main是如何处理脚本命令：<br> frameworks/base/cmds/app_process/app_main.cpp</p> 
<pre><code class="prism language-c"><span class="token number">165</span>  #<span class="token keyword">if</span> <span class="token function">defined</span><span class="token punctuation">(</span>__LP64__<span class="token punctuation">)</span>
<span class="token number">166</span>  <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span> ABI_LIST_PROPERTY<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"ro.product.cpu.abilist64"</span><span class="token punctuation">;</span>
<span class="token number">167</span>  <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span> ZYGOTE_NICE_NAME<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"zygote64"</span><span class="token punctuation">;</span>
<span class="token number">168</span>  #<span class="token keyword">else</span>
<span class="token number">169</span>  <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span> ABI_LIST_PROPERTY<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"ro.product.cpu.abilist32"</span><span class="token punctuation">;</span>
<span class="token number">170</span>  <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span> ZYGOTE_NICE_NAME<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"zygote"</span><span class="token punctuation">;</span>
<span class="token number">171</span>  #endif
<span class="token number">172</span>
<span class="token number">173</span>  <span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token keyword">const</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token number">174</span>  <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">256</span>      <span class="token comment">// Parse runtime arguments.  Stop at first unrecognized option.</span>
<span class="token number">257</span>      bool zygote <span class="token operator">=</span> false<span class="token punctuation">;</span>
<span class="token number">258</span>      bool startSystemServer <span class="token operator">=</span> false<span class="token punctuation">;</span>
<span class="token number">259</span>      bool application <span class="token operator">=</span> false<span class="token punctuation">;</span>
<span class="token number">260</span>      String8 niceName<span class="token punctuation">;</span>
<span class="token number">261</span>      String8 className<span class="token punctuation">;</span>
<span class="token number">262</span>  
<span class="token number">263</span>      <span class="token operator">++</span>i<span class="token punctuation">;</span>  <span class="token comment">// Skip unused "parent dir" argument.</span>
<span class="token number">264</span>      <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> argc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">265</span>          <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> arg <span class="token operator">=</span> argv<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token number">266</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> <span class="token string">"--zygote"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">267</span>              zygote <span class="token operator">=</span> true<span class="token punctuation">;</span>
<span class="token number">268</span>              niceName <span class="token operator">=</span> ZYGOTE_NICE_NAME<span class="token punctuation">;</span>
<span class="token number">269</span>          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> <span class="token string">"--start-system-server"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">270</span>              startSystemServer <span class="token operator">=</span> true<span class="token punctuation">;</span>
<span class="token number">271</span>          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> <span class="token string">"--application"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">272</span>              application <span class="token operator">=</span> true<span class="token punctuation">;</span>
<span class="token number">273</span>          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> <span class="token string">"--nice-name="</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">274</span>              niceName<span class="token punctuation">.</span><span class="token function">setTo</span><span class="token punctuation">(</span>arg <span class="token operator">+</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">275</span>          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> <span class="token string">"--"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">276</span>              className<span class="token punctuation">.</span><span class="token function">setTo</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">277</span>              <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token number">278</span>          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">279</span>              <span class="token operator">--</span>i<span class="token punctuation">;</span>
<span class="token number">280</span>              <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token number">281</span>          <span class="token punctuation">}</span>
<span class="token number">282</span>      <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">309</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>startSystemServer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">310</span>              args<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">String8</span><span class="token punctuation">(</span><span class="token string">"start-system-server"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">311</span>          <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">331</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>niceName<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">332</span>          runtime<span class="token punctuation">.</span><span class="token function">setArgv0</span><span class="token punctuation">(</span>niceName<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> true <span class="token comment">/* setProcName */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">333</span>      <span class="token punctuation">}</span>
<span class="token number">334</span>  
<span class="token number">335</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>zygote<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">336</span>          runtime<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">"com.android.internal.os.ZygoteInit"</span><span class="token punctuation">,</span> args<span class="token punctuation">,</span> zygote<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">337</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>className<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">338</span>          runtime<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">"com.android.internal.os.RuntimeInit"</span><span class="token punctuation">,</span> args<span class="token punctuation">,</span> zygote<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">339</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">340</span>          <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Error: no class name or --zygote supplied.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">341</span>          <span class="token function">app_usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">342</span>          <span class="token function">LOG_ALWAYS_FATAL</span><span class="token punctuation">(</span><span class="token string">"app_process: no class name or --zygote supplied."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">343</span>      <span class="token punctuation">}</span>
<span class="token number">344</span>  <span class="token punctuation">}</span>
</code></pre> 
<p>我们拿<code>init.zygote64.rc</code>为例：</p> 
<pre><code class="prism language-c"><span class="token number">1</span> service zygote <span class="token operator">/</span>system<span class="token operator">/</span>bin<span class="token operator">/</span>app_process64 <span class="token operator">-</span>Xzygote <span class="token operator">/</span>system<span class="token operator">/</span>bin <span class="token operator">--</span>zygote <span class="token operator">--</span>start<span class="token operator">-</span>system<span class="token operator">-</span>server
<span class="token number">2</span>     class main
<span class="token number">3</span>     priority <span class="token operator">-</span><span class="token number">20</span>
<span class="token number">4</span>     user root
<span class="token number">5</span>     group root readproc reserved_disk
<span class="token number">6</span>     socket zygote stream <span class="token number">660</span> root system
<span class="token number">7</span>     socket usap_pool_primary stream <span class="token number">660</span> root system
<span class="token number">8</span>     onrestart write <span class="token operator">/</span>sys<span class="token operator">/</span>android_power<span class="token operator">/</span>request_state wake
<span class="token number">9</span>     onrestart write <span class="token operator">/</span>sys<span class="token operator">/</span>power<span class="token operator">/</span>state on
<span class="token number">10</span>     onrestart restart audioserver
<span class="token number">11</span>     onrestart restart cameraserver
<span class="token number">12</span>     onrestart restart media
<span class="token number">13</span>     onrestart restart netd
<span class="token number">14</span>     onrestart restart wificond
<span class="token number">15</span>     writepid <span class="token operator">/</span>dev<span class="token operator">/</span>cpuset<span class="token operator">/</span>foreground<span class="token operator">/</span>tasks
</code></pre> 
<p>主要是这个脚本命令：<code>service zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server</code></p> 
<blockquote> 
 <p>实际上会被分割成：<br> service：服务标识<br> zygote：表示要开启的服务名字<br> /system/bin/app_process64：服务对应的路径<br> -Xzygote：作为虚拟机启动时所需要的参数,在AndroidRuntime.cpp中的 startVm() 中调用JNI_CreateJavaVM 使用到<br> /system/bin：代表虚拟机程序所在目录,因为 app_process 可以不和虚拟机在一个目录,所以 app_process 需要知道虚拟机所在的目录<br> –zygote ：指明以 ZygoteInit 类作为入口,否则需要指定需要执行的类名<br> –start-system-server：仅在有 --zygote 参数时可用,告知 ZygoteInit 启动完毕后孵化出的第一个进程是 SystemServer</p> 
</blockquote> 
<ol><li>第一个if中<code>"--zygote"</code>命中，<code>zygote变量</code>置为<code>true</code>表示要启动<code>zygote进程</code>，并将<code>进程名</code>改成了<code>zygote</code>或<code>zygote64</code></li><li>第二个if中<code>"--start-system-server"</code>命中，<code>startSystemServer变量</code>置为<code>true</code>表示要启动<code>SystemServer进程</code></li></ol> 
<p><code>app_main.cpp</code>的<code>main方法</code>执行后，<code>ZygoteInit</code>已经通过<code>runtime.start("com.android.internal.os.ZygoteInit", args, zygote);</code>被启动了</p> 
<h3><a id="22_AndroidRuntimeZygoteInit_120"></a>2.2 AndroidRuntime启动ZygoteInit</h3> 
<p>其中<code>runtime</code>就是<code>AndroidRuntime</code>类，我们来看看<code>AndroidRuntime</code>的<code>start方法</code>：<br> /frameworks/base/core/jni/AndroidRuntime.cpp</p> 
<pre><code class="prism language-c"><span class="token number">1112</span>  <span class="token comment">/*
1113   * Start the Android runtime.  This involves starting the virtual machine
1114   * and calling the "static void main(String[] args)" method in the class
1115   * named by "className".
1116   *
1117   * Passes the main function two arguments, the class name and the specified
1118   * options string.
1119   */</span>
<span class="token number">1120</span>  <span class="token keyword">void</span> AndroidRuntime<span class="token operator">::</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> className<span class="token punctuation">,</span> <span class="token keyword">const</span> Vector<span class="token operator">&lt;</span>String8<span class="token operator">&gt;</span><span class="token operator">&amp;</span> options<span class="token punctuation">,</span> bool zygote<span class="token punctuation">)</span>
<span class="token number">1121</span>  <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">1164</span>      <span class="token comment">/* start the virtual machine */</span>
<span class="token number">1165</span>      JniInvocation jni_invocation<span class="token punctuation">;</span>
<span class="token number">1166</span>      jni_invocation<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1167</span>      JNIEnv<span class="token operator">*</span> env<span class="token punctuation">;</span>
<span class="token number">1168</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">startVm</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mJavaVM<span class="token punctuation">,</span> <span class="token operator">&amp;</span>env<span class="token punctuation">,</span> zygote<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">1169</span>          <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token number">1170</span>      <span class="token punctuation">}</span>
<span class="token number">1171</span>      <span class="token function">onVmCreated</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1172</span>  
<span class="token number">1173</span>      <span class="token comment">/*
1174       * Register android functions.
1175       */</span>
<span class="token number">1176</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">startReg</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">1177</span>          <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Unable to register all android natives\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1178</span>          <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token number">1179</span>      <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">1203</span>  
<span class="token number">1204</span>      <span class="token comment">/*
1205       * Start VM.  This thread becomes the main thread of the VM, and will
1206       * not return until the VM exits.
1207       */</span>
<span class="token number">1208</span>      <span class="token keyword">char</span><span class="token operator">*</span> slashClassName <span class="token operator">=</span> <span class="token function">toSlashClassName</span><span class="token punctuation">(</span>className <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">?</span> className <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1209</span>      jclass startClass <span class="token operator">=</span> env<span class="token operator">-&gt;</span><span class="token function">FindClass</span><span class="token punctuation">(</span>slashClassName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1210</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>startClass <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">1211</span>          <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"JavaVM unable to locate class '%s'\n"</span><span class="token punctuation">,</span> slashClassName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1212</span>          <span class="token comment">/* keep going */</span>
<span class="token number">1213</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">1214</span>          jmethodID startMeth <span class="token operator">=</span> env<span class="token operator">-&gt;</span><span class="token function">GetStaticMethodID</span><span class="token punctuation">(</span>startClass<span class="token punctuation">,</span> <span class="token string">"main"</span><span class="token punctuation">,</span>
<span class="token number">1215</span>              <span class="token string">"([Ljava/lang/String;)V"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1216</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>startMeth <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">1217</span>              <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"JavaVM unable to find main() in '%s'\n"</span><span class="token punctuation">,</span> className<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1218</span>              <span class="token comment">/* keep going */</span>
<span class="token number">1219</span>          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">1220</span>              env<span class="token operator">-&gt;</span><span class="token function">CallStaticVoidMethod</span><span class="token punctuation">(</span>startClass<span class="token punctuation">,</span> startMeth<span class="token punctuation">,</span> strArray<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1226</span>          <span class="token punctuation">}</span>
<span class="token number">1227</span>      <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">1235</span>  <span class="token punctuation">}</span>
</code></pre> 
<p>对虚拟机和JNI方法的一些注册后，通过<code>CallStaticVoidMethod</code>来调用传过来的类名的<code>main函数</code>，我们传递过来的类名是<code>com.android.internal.os.ZygoteInit</code><br> <strong>AndroidRuntime中主要做了这三件事：</strong></p> 
<blockquote> 
 <ol><li>startVm() 创建虚拟机</li><li>startReg() 动态注册 java 调用 native 的 jni</li><li>反射调用 ZygoteInit 的 main()</li></ol> 
</blockquote> 
<h3><a id="23_ZygoteInit_180"></a>2.3 ZygoteInit初始化</h3> 
<p><code>AndroidRuntime</code>在<code>Native层</code>创建了<code>Zygote</code>，并且通过<code>AndroidRuntime.start()</code>从<code>Native层</code>转到<code>Java层ZygoteInit的main()</code>入口，<code>ZygoteInit的main()方法</code>是Android启动的<code>第一个Java进程主方法</code><br> /frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</p> 
<pre><code class="prism language-java"><span class="token number">818</span>      <span class="token annotation punctuation">@UnsupportedAppUsage</span>
<span class="token number">819</span>      <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">820</span>          <span class="token class-name">ZygoteServer</span> zygoteServer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">833</span>          <span class="token class-name">Runnable</span> caller<span class="token punctuation">;</span>
<span class="token number">834</span>          <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">847</span>              <span class="token keyword">boolean</span> startSystemServer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token number">848</span>              <span class="token class-name">String</span> zygoteSocketName <span class="token operator">=</span> <span class="token string">"zygote"</span><span class="token punctuation">;</span>
<span class="token number">849</span>              <span class="token class-name">String</span> abiList <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token number">850</span>              <span class="token keyword">boolean</span> enableLazyPreload <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token number">851</span>              <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> argv<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">852</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"start-system-server"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">853</span>                      startSystemServer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token number">854</span>                  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"--enable-lazy-preload"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">855</span>                      enableLazyPreload <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token number">856</span>                  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>ABI_LIST_ARG<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">857</span>                      abiList <span class="token operator">=</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>ABI_LIST_ARG<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">858</span>                  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>SOCKET_NAME_ARG<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">859</span>                      zygoteSocketName <span class="token operator">=</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>SOCKET_NAME_ARG<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">860</span>                  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">861</span>                      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Unknown command line argument: "</span> <span class="token operator">+</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">862</span>                  <span class="token punctuation">}</span>
<span class="token number">863</span>              <span class="token punctuation">}</span>
<span class="token number">864</span>  
<span class="token number">865</span>              <span class="token keyword">final</span> <span class="token keyword">boolean</span> isPrimaryZygote <span class="token operator">=</span> zygoteSocketName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Zygote</span><span class="token punctuation">.</span>PRIMARY_SOCKET_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">866</span>  
<span class="token number">867</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>abiList <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">868</span>                  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"No ABI list supplied."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">869</span>              <span class="token punctuation">}</span>
<span class="token number">870</span>  
<span class="token number">871</span>              <span class="token comment">// In some configurations, we avoid preloading resources and classes eagerly.</span>
<span class="token number">872</span>              <span class="token comment">// In such cases, we will preload things prior to our first fork.</span>
<span class="token number">873</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>enableLazyPreload<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">877</span>                  <span class="token function">preload</span><span class="token punctuation">(</span>bootTimingsTraceLog<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">881</span>              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">882</span>                  <span class="token class-name">Zygote</span><span class="token punctuation">.</span><span class="token function">resetNicePriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">883</span>              <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">896</span>              <span class="token class-name">Zygote</span><span class="token punctuation">.</span><span class="token function">initNativeState</span><span class="token punctuation">(</span>isPrimaryZygote<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">897</span>  
<span class="token number">898</span>              <span class="token class-name">ZygoteHooks</span><span class="token punctuation">.</span><span class="token function">stopZygoteNoThreadCreation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">899</span>  
<span class="token number">900</span>              zygoteServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZygoteServer</span><span class="token punctuation">(</span>isPrimaryZygote<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">901</span>  
<span class="token number">902</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>startSystemServer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">903</span>                  <span class="token class-name">Runnable</span> r <span class="token operator">=</span> <span class="token function">forkSystemServer</span><span class="token punctuation">(</span>abiList<span class="token punctuation">,</span> zygoteSocketName<span class="token punctuation">,</span> zygoteServer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">904</span>  
<span class="token number">905</span>                  <span class="token comment">// {@code r == null} in the parent (zygote) process, and {@code r != null} in the</span>
<span class="token number">906</span>                  <span class="token comment">// child (system_server) process.</span>
<span class="token number">907</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">908</span>                      r<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">909</span>                      <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token number">910</span>                  <span class="token punctuation">}</span>
<span class="token number">911</span>              <span class="token punctuation">}</span>
<span class="token number">912</span>  
<span class="token number">913</span>              <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Accepting command socket connections"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">914</span>  
<span class="token number">915</span>              <span class="token comment">// The select loop returns early in the child process after a fork and</span>
<span class="token number">916</span>              <span class="token comment">// loops forever in the zygote.</span>
<span class="token number">917</span>              caller <span class="token operator">=</span> zygoteServer<span class="token punctuation">.</span><span class="token function">runSelectLoop</span><span class="token punctuation">(</span>abiList<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">918</span>          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">919</span>              <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"System zygote died with exception"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">920</span>              <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
<span class="token number">921</span>          <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">922</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>zygoteServer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">923</span>                  zygoteServer<span class="token punctuation">.</span><span class="token function">closeServerSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">924</span>              <span class="token punctuation">}</span>
<span class="token number">925</span>          <span class="token punctuation">}</span>
<span class="token number">926</span>  
<span class="token number">927</span>          <span class="token comment">// We're in the child process and have exited the select loop. Proceed to execute the</span>
<span class="token number">928</span>          <span class="token comment">// command.</span>
<span class="token number">929</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>caller <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">930</span>              caller<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">931</span>          <span class="token punctuation">}</span>
<span class="token number">932</span>      <span class="token punctuation">}</span>
</code></pre> 
<p>主要做了3件事：</p> 
<blockquote> 
 <ol><li><code>preload()预先加载系统资源，如系统类、资源、系统共享库等</code></li><li><code>创建 ZygoteServer，其实就是 ServerSocket 循环等待通知 fork 子进程</code></li><li><code>创建 SystemServer进程</code></li></ol> 
</blockquote> 
<h4><a id="231_preload_269"></a>2.3.1 preload()</h4> 
<p><code>preload()</code>：资源准备，包括类加载，资源加载等</p> 
<pre><code class="prism language-c"><span class="token number">135</span>      <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">preload</span><span class="token punctuation">(</span>TimingsTraceLog bootTimingsTraceLog<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">138</span>          <span class="token function">beginPreload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">141</span>          <span class="token function">preloadClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">144</span>          <span class="token function">cacheNonBootClasspathClassLoaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">147</span>          <span class="token function">preloadResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">150</span>          <span class="token function">nativePreloadAppProcessHALs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">153</span>          <span class="token function">maybePreloadGraphicsDriver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">155</span>          <span class="token function">preloadSharedLibraries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">156</span>          <span class="token function">preloadTextResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">157</span>          <span class="token comment">// Ask the WebViewFactory to do any initialization that must run in the zygote process,</span>
<span class="token number">158</span>          <span class="token comment">// for memory sharing purposes.</span>
<span class="token number">159</span>          WebViewFactory<span class="token punctuation">.</span><span class="token function">prepareWebViewInZygote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">160</span>          <span class="token function">endPreload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">161</span>          <span class="token function">warmUpJcaProviders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">164</span>          sPreloadComplete <span class="token operator">=</span> true<span class="token punctuation">;</span>
<span class="token number">165</span>      <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">244</span>      <span class="token comment">/**
245       * Performs Zygote process initialization. Loads and initializes commonly used classes.
246       *
247       * Most classes only cause a few hundred bytes to be allocated, but a few will allocate a dozen
248       * Kbytes (in one case, 500+K).
249       */</span>
<span class="token number">250</span>      private <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">preloadClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">251</span>          final VMRuntime runtime <span class="token operator">=</span> VMRuntime<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">252</span>  
<span class="token number">253</span>          InputStream is<span class="token punctuation">;</span>
<span class="token number">254</span>          try <span class="token punctuation">{<!-- --></span>
<span class="token number">255</span>              is <span class="token operator">=</span> new <span class="token function">FileInputStream</span><span class="token punctuation">(</span>PRELOADED_CLASSES<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">256</span>          <span class="token punctuation">}</span> <span class="token function">catch</span> <span class="token punctuation">(</span>FileNotFoundException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">257</span>              Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Couldn't find "</span> <span class="token operator">+</span> PRELOADED_CLASSES <span class="token operator">+</span> <span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">258</span>              <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token number">259</span>          <span class="token punctuation">}</span>
<span class="token number">260</span>  
<span class="token number">261</span>          Log<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Preloading classes..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">262</span>          <span class="token keyword">long</span> startTime <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">263</span>  
<span class="token number">264</span>          <span class="token comment">// Drop root perms while running static initializers.</span>
<span class="token number">265</span>          final <span class="token keyword">int</span> reuid <span class="token operator">=</span> Os<span class="token punctuation">.</span><span class="token function">getuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">266</span>          final <span class="token keyword">int</span> regid <span class="token operator">=</span> Os<span class="token punctuation">.</span><span class="token function">getgid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">267</span>  
<span class="token number">268</span>          <span class="token comment">// We need to drop root perms only if we're already root. In the case of "wrapped"</span>
<span class="token number">269</span>          <span class="token comment">// processes (see WrapperInit), this function is called from an unprivileged uid</span>
<span class="token number">270</span>          <span class="token comment">// and gid.</span>
<span class="token number">271</span>          boolean droppedPriviliges <span class="token operator">=</span> false<span class="token punctuation">;</span>
<span class="token number">272</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>reuid <span class="token operator">==</span> ROOT_UID <span class="token operator">&amp;&amp;</span> regid <span class="token operator">==</span> ROOT_GID<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">273</span>              try <span class="token punctuation">{<!-- --></span>
<span class="token number">274</span>                  Os<span class="token punctuation">.</span><span class="token function">setregid</span><span class="token punctuation">(</span>ROOT_GID<span class="token punctuation">,</span> UNPRIVILEGED_GID<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">275</span>                  Os<span class="token punctuation">.</span><span class="token function">setreuid</span><span class="token punctuation">(</span>ROOT_UID<span class="token punctuation">,</span> UNPRIVILEGED_UID<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">276</span>              <span class="token punctuation">}</span> <span class="token function">catch</span> <span class="token punctuation">(</span>ErrnoException ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">277</span>                  throw new <span class="token function">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Failed to drop root"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">278</span>              <span class="token punctuation">}</span>
<span class="token number">279</span>  
<span class="token number">280</span>              droppedPriviliges <span class="token operator">=</span> true<span class="token punctuation">;</span>
<span class="token number">281</span>          <span class="token punctuation">}</span>
<span class="token number">282</span>  
<span class="token number">283</span>          <span class="token comment">// Alter the target heap utilization.  With explicit GCs this</span>
<span class="token number">284</span>          <span class="token comment">// is not likely to have any effect.</span>
<span class="token number">285</span>          <span class="token keyword">float</span> defaultUtilization <span class="token operator">=</span> runtime<span class="token punctuation">.</span><span class="token function">getTargetHeapUtilization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">286</span>          runtime<span class="token punctuation">.</span><span class="token function">setTargetHeapUtilization</span><span class="token punctuation">(</span><span class="token number">0.8f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">287</span>  
<span class="token number">288</span>          try <span class="token punctuation">{<!-- --></span>
<span class="token number">289</span>              BufferedReader br <span class="token operator">=</span>
<span class="token number">290</span>                      new <span class="token function">BufferedReader</span><span class="token punctuation">(</span>new <span class="token function">InputStreamReader</span><span class="token punctuation">(</span>is<span class="token punctuation">)</span><span class="token punctuation">,</span> Zygote<span class="token punctuation">.</span>SOCKET_BUFFER_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">291</span>  
<span class="token number">292</span>              <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">293</span>              String line<span class="token punctuation">;</span>
<span class="token number">294</span>              <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>line <span class="token operator">=</span> br<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">295</span>                  <span class="token comment">// Skip comments and blank lines.</span>
<span class="token number">296</span>                  line <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">297</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"#"</span><span class="token punctuation">)</span> <span class="token operator">||</span> line<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">298</span>                      <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token number">299</span>                  <span class="token punctuation">}</span>
<span class="token number">300</span>  
<span class="token number">301</span>                  Trace<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span>Trace<span class="token punctuation">.</span>TRACE_TAG_DALVIK<span class="token punctuation">,</span> line<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">302</span>                  try <span class="token punctuation">{<!-- --></span>
<span class="token number">303</span>                      <span class="token keyword">if</span> <span class="token punctuation">(</span>false<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">304</span>                          Log<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Preloading "</span> <span class="token operator">+</span> line <span class="token operator">+</span> <span class="token string">"..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">305</span>                      <span class="token punctuation">}</span>
<span class="token number">306</span>                      <span class="token comment">// Load and explicitly initialize the given class. Use</span>
<span class="token number">307</span>                      <span class="token comment">// Class.forName(String, boolean, ClassLoader) to avoid repeated stack lookups</span>
<span class="token number">308</span>                      <span class="token comment">// (to derive the caller's class-loader). Use true to force initialization, and</span>
<span class="token number">309</span>                      <span class="token comment">// null for the boot classpath class-loader (could as well cache the</span>
<span class="token number">310</span>                      <span class="token comment">// class-loader of this class in a variable).</span>
<span class="token number">311</span>                      Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> true<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">312</span>                      count<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token number">313</span>                  <span class="token punctuation">}</span> <span class="token function">catch</span> <span class="token punctuation">(</span>ClassNotFoundException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">314</span>                      Log<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Class not found for preloading: "</span> <span class="token operator">+</span> line<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">315</span>                  <span class="token punctuation">}</span> <span class="token function">catch</span> <span class="token punctuation">(</span>UnsatisfiedLinkError e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">316</span>                      Log<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Problem preloading "</span> <span class="token operator">+</span> line <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">317</span>                  <span class="token punctuation">}</span> <span class="token function">catch</span> <span class="token punctuation">(</span>Throwable t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">318</span>                      Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Error preloading "</span> <span class="token operator">+</span> line <span class="token operator">+</span> <span class="token string">"."</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">319</span>                      <span class="token keyword">if</span> <span class="token punctuation">(</span>t instanceof Error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">320</span>                          <span class="token function">throw</span> <span class="token punctuation">(</span>Error<span class="token punctuation">)</span> t<span class="token punctuation">;</span>
<span class="token number">321</span>                      <span class="token punctuation">}</span>
<span class="token number">322</span>                      <span class="token keyword">if</span> <span class="token punctuation">(</span>t instanceof RuntimeException<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">323</span>                          <span class="token function">throw</span> <span class="token punctuation">(</span>RuntimeException<span class="token punctuation">)</span> t<span class="token punctuation">;</span>
<span class="token number">324</span>                      <span class="token punctuation">}</span>
<span class="token number">325</span>                      throw new <span class="token function">RuntimeException</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">326</span>                  <span class="token punctuation">}</span>
<span class="token number">327</span>                  Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>Trace<span class="token punctuation">.</span>TRACE_TAG_DALVIK<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">328</span>              <span class="token punctuation">}</span>
<span class="token number">329</span>  
<span class="token number">330</span>              Log<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"...preloaded "</span> <span class="token operator">+</span> count <span class="token operator">+</span> <span class="token string">" classes in "</span>
<span class="token number">331</span>                      <span class="token operator">+</span> <span class="token punctuation">(</span>SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"ms."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">332</span>          <span class="token punctuation">}</span> <span class="token function">catch</span> <span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">333</span>              Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Error reading "</span> <span class="token operator">+</span> PRELOADED_CLASSES <span class="token operator">+</span> <span class="token string">"."</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">334</span>          <span class="token punctuation">}</span> finally <span class="token punctuation">{<!-- --></span>
<span class="token number">335</span>              IoUtils<span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span>is<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">336</span>              <span class="token comment">// Restore default.</span>
<span class="token number">337</span>              runtime<span class="token punctuation">.</span><span class="token function">setTargetHeapUtilization</span><span class="token punctuation">(</span>defaultUtilization<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">338</span>  
<span class="token number">339</span>              <span class="token comment">// Fill in dex caches with classes, fields, and methods brought in by preloading.</span>
<span class="token number">340</span>              Trace<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span>Trace<span class="token punctuation">.</span>TRACE_TAG_DALVIK<span class="token punctuation">,</span> <span class="token string">"PreloadDexCaches"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">341</span>              runtime<span class="token punctuation">.</span><span class="token function">preloadDexCaches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">342</span>              Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>Trace<span class="token punctuation">.</span>TRACE_TAG_DALVIK<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">343</span>  
<span class="token number">344</span>              <span class="token comment">// Bring back root. We'll need it later if we're in the zygote.</span>
<span class="token number">345</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>droppedPriviliges<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">346</span>                  try <span class="token punctuation">{<!-- --></span>
<span class="token number">347</span>                      Os<span class="token punctuation">.</span><span class="token function">setreuid</span><span class="token punctuation">(</span>ROOT_UID<span class="token punctuation">,</span> ROOT_UID<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">348</span>                      Os<span class="token punctuation">.</span><span class="token function">setregid</span><span class="token punctuation">(</span>ROOT_GID<span class="token punctuation">,</span> ROOT_GID<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">349</span>                  <span class="token punctuation">}</span> <span class="token function">catch</span> <span class="token punctuation">(</span>ErrnoException ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">350</span>                      throw new <span class="token function">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Failed to restore root"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">351</span>                  <span class="token punctuation">}</span>
<span class="token number">352</span>              <span class="token punctuation">}</span>
<span class="token number">353</span>          <span class="token punctuation">}</span>
<span class="token number">354</span>      <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token number">382</span>      <span class="token comment">/**
383       * Load in commonly used resources, so they can be shared across processes.
384       *
385       * These tend to be a few Kbytes, but are frequently in the 20-40K range, and occasionally even
386       * larger.
387       */</span>
<span class="token number">388</span>      private <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">preloadResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">389</span>          final VMRuntime runtime <span class="token operator">=</span> VMRuntime<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">390</span>  
<span class="token number">391</span>          try <span class="token punctuation">{<!-- --></span>
<span class="token number">392</span>              mResources <span class="token operator">=</span> Resources<span class="token punctuation">.</span><span class="token function">getSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">393</span>              mResources<span class="token punctuation">.</span><span class="token function">startPreloading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">394</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>PRELOAD_RESOURCES<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">395</span>                  Log<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Preloading resources..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">396</span>  
<span class="token number">397</span>                  <span class="token keyword">long</span> startTime <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">398</span>                  TypedArray ar <span class="token operator">=</span> mResources<span class="token punctuation">.</span><span class="token function">obtainTypedArray</span><span class="token punctuation">(</span>
<span class="token number">399</span>                          com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>array<span class="token punctuation">.</span>preloaded_drawables<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">400</span>                  <span class="token keyword">int</span> N <span class="token operator">=</span> <span class="token function">preloadDrawables</span><span class="token punctuation">(</span>ar<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">401</span>                  ar<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">402</span>                  Log<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"...preloaded "</span> <span class="token operator">+</span> N <span class="token operator">+</span> <span class="token string">" resources in "</span>
<span class="token number">403</span>                          <span class="token operator">+</span> <span class="token punctuation">(</span>SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"ms."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">404</span>  
<span class="token number">405</span>                  startTime <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">406</span>                  ar <span class="token operator">=</span> mResources<span class="token punctuation">.</span><span class="token function">obtainTypedArray</span><span class="token punctuation">(</span>
<span class="token number">407</span>                          com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>array<span class="token punctuation">.</span>preloaded_color_state_lists<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">408</span>                  N <span class="token operator">=</span> <span class="token function">preloadColorStateLists</span><span class="token punctuation">(</span>ar<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">409</span>                  ar<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">410</span>                  Log<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"...preloaded "</span> <span class="token operator">+</span> N <span class="token operator">+</span> <span class="token string">" resources in "</span>
<span class="token number">411</span>                          <span class="token operator">+</span> <span class="token punctuation">(</span>SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"ms."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">412</span>  
<span class="token number">413</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span>mResources<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>
<span class="token number">414</span>                          com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>bool<span class="token punctuation">.</span>config_freeformWindowManagement<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">415</span>                      startTime <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">416</span>                      ar <span class="token operator">=</span> mResources<span class="token punctuation">.</span><span class="token function">obtainTypedArray</span><span class="token punctuation">(</span>
<span class="token number">417</span>                              com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>array<span class="token punctuation">.</span>preloaded_freeform_multi_window_drawables<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">418</span>                      N <span class="token operator">=</span> <span class="token function">preloadDrawables</span><span class="token punctuation">(</span>ar<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">419</span>                      ar<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">420</span>                      Log<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"...preloaded "</span> <span class="token operator">+</span> N <span class="token operator">+</span> <span class="token string">" resource in "</span>
<span class="token number">421</span>                              <span class="token operator">+</span> <span class="token punctuation">(</span>SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"ms."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">422</span>                  <span class="token punctuation">}</span>
<span class="token number">423</span>              <span class="token punctuation">}</span>
<span class="token number">424</span>              mResources<span class="token punctuation">.</span><span class="token function">finishPreloading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">425</span>          <span class="token punctuation">}</span> <span class="token function">catch</span> <span class="token punctuation">(</span>RuntimeException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">426</span>              Log<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Failure preloading resources"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">427</span>          <span class="token punctuation">}</span>
<span class="token number">428</span>      <span class="token punctuation">}</span>
</code></pre> 
<p><code>preloadClasses()</code>方法主要是从/system/etc/preloaded-classes文件中读取需要预加载的类名，然后通过Class.forname将该类加载到内存中，并会执行其中的一些静态方法(Java的类加载机制)。这里的重点是preloaded-classes文件，这个文件一般使用Android原生的文件，其路径在frameworks/base/config/preloaded-classes。</p> 
<p><code>preloadResources()</code>方法主要是做了以下几件事：<br> 1.在Resources.startPreloading()方法中，调用updateConfiguration()方法为系统创建Configuration，这是后面应用和系统的一些配置来源。<br> 2.从preloaded_drawables中获取预加载的drawables资源，并将其加载到内存中。preloaded_drawables字段在frameworks/base/core/res/res/values/arrays.xml中定义。<br> 3.从preloaded_color_state_lists中获取预加载的color资源，并将其加载到内存中，preloaded_color_state_lists字段也是定义在frameworks/base/core/res/res/values/arrays.xml中。<br> 4.如果支持自由窗口模式，则将preloaded_freeform_multi_window_drawables字段中定义的预加载的freeform drawables也加载进来。</p> 
<h4><a id="232_ZygoteServer_458"></a>2.3.2 ZygoteServer</h4> 
<p>ZygoteInit的main方法内实例化了ZygoteServer对象，并调用了其中<code>runSelectLoop()</code>、<code>closeServerSocket()</code>方法。<br> /frameworks/base/core/java/com/android/internal/os/ZygoteServer.java</p> 
<pre><code class="prism language-java"><span class="token number">48</span>  <span class="token keyword">class</span> <span class="token class-name">ZygoteServer</span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">88</span>      <span class="token comment">/**
89       * Listening socket that accepts new server connections.
90       */</span>
<span class="token number">91</span>      <span class="token keyword">private</span> <span class="token class-name">LocalServerSocket</span> mZygoteSocket<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">142</span>      <span class="token comment">/**
143       * Initialize the Zygote server with the Zygote server socket, USAP pool server socket, and USAP
144       * pool event FD.
145       *
146       * @param isPrimaryZygote  If this is the primary Zygote or not.
147       */</span>
<span class="token number">148</span>      <span class="token class-name">ZygoteServer</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> isPrimaryZygote<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">151</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>isPrimaryZygote<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">152</span>              mZygoteSocket <span class="token operator">=</span> <span class="token class-name">Zygote</span><span class="token punctuation">.</span><span class="token function">createManagedSocketFromInitSocket</span><span class="token punctuation">(</span><span class="token class-name">Zygote</span><span class="token punctuation">.</span>PRIMARY_SOCKET_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">153</span>              mUsapPoolSocket <span class="token operator">=</span>
<span class="token number">154</span>                      <span class="token class-name">Zygote</span><span class="token punctuation">.</span><span class="token function">createManagedSocketFromInitSocket</span><span class="token punctuation">(</span>
<span class="token number">155</span>                              <span class="token class-name">Zygote</span><span class="token punctuation">.</span>USAP_POOL_PRIMARY_SOCKET_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">156</span>          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">157</span>              mZygoteSocket <span class="token operator">=</span> <span class="token class-name">Zygote</span><span class="token punctuation">.</span><span class="token function">createManagedSocketFromInitSocket</span><span class="token punctuation">(</span><span class="token class-name">Zygote</span><span class="token punctuation">.</span>SECONDARY_SOCKET_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">158</span>              mUsapPoolSocket <span class="token operator">=</span>
<span class="token number">159</span>                      <span class="token class-name">Zygote</span><span class="token punctuation">.</span><span class="token function">createManagedSocketFromInitSocket</span><span class="token punctuation">(</span>
<span class="token number">160</span>                              <span class="token class-name">Zygote</span><span class="token punctuation">.</span>USAP_POOL_SECONDARY_SOCKET_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">161</span>          <span class="token punctuation">}</span>
<span class="token number">166</span>      <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">176</span>      <span class="token comment">/**
177       * Registers a server socket for zygote command connections. This opens the server socket
178       * at the specified name in the abstract socket namespace.
179       */</span>
<span class="token number">180</span>      <span class="token keyword">void</span> <span class="token function">registerServerSocketAtAbstractName</span><span class="token punctuation">(</span><span class="token class-name">String</span> socketName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">181</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>mZygoteSocket <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">182</span>              <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">183</span>                  mZygoteSocket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalServerSocket</span><span class="token punctuation">(</span>socketName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">184</span>                  mCloseSocketFd <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token number">185</span>              <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">186</span>                  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
<span class="token number">187</span>                          <span class="token string">"Error binding to abstract socket '"</span> <span class="token operator">+</span> socketName <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">188</span>              <span class="token punctuation">}</span>
<span class="token number">189</span>          <span class="token punctuation">}</span>
<span class="token number">190</span>      <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">210</span>      <span class="token comment">/**
211       * Close and clean up zygote sockets. Called on shutdown and on the
212       * child's exit path.
213       */</span>
<span class="token number">214</span>      <span class="token keyword">void</span> <span class="token function">closeServerSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">215</span>          <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">216</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>mZygoteSocket <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">217</span>                  <span class="token class-name">FileDescriptor</span> fd <span class="token operator">=</span> mZygoteSocket<span class="token punctuation">.</span><span class="token function">getFileDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">218</span>                  mZygoteSocket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">219</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mCloseSocketFd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">220</span>                      <span class="token class-name">Os</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">221</span>                  <span class="token punctuation">}</span>
<span class="token number">222</span>              <span class="token punctuation">}</span>
<span class="token number">223</span>          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">224</span>              <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Zygote:  error closing sockets"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">225</span>          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ErrnoException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">226</span>              <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Zygote:  error closing descriptor"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">227</span>          <span class="token punctuation">}</span>
<span class="token number">228</span>  
<span class="token number">229</span>          mZygoteSocket <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token number">230</span>      <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">368</span>      <span class="token comment">/**
369       * Runs the zygote process's select loop. Accepts new connections as
370       * they happen, and reads commands from connections one spawn-request's
371       * worth at a time.
372       */</span>
<span class="token number">373</span>      <span class="token class-name">Runnable</span> <span class="token function">runSelectLoop</span><span class="token punctuation">(</span><span class="token class-name">String</span> abiList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">374</span>          <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FileDescriptor</span><span class="token punctuation">&gt;</span></span> socketFDs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FileDescriptor</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">375</span>          <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ZygoteConnection</span><span class="token punctuation">&gt;</span></span> peers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ZygoteConnection</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">376</span>  
<span class="token number">377</span>          socketFDs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mZygoteSocket<span class="token punctuation">.</span><span class="token function">getFileDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">378</span>          peers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">379</span>  
<span class="token number">380</span>          <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">381</span>              <span class="token function">fetchUsapPoolPolicyPropsWithMinInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">382</span>  
<span class="token number">383</span>              <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> usapPipeFDs <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token number">384</span>              <span class="token class-name">StructPollfd</span><span class="token punctuation">[</span><span class="token punctuation">]</span> pollFDs <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token number">385</span>  
<span class="token number">386</span>              <span class="token comment">// Allocate enough space for the poll structs, taking into account</span>
<span class="token number">387</span>              <span class="token comment">// the state of the USAP pool for this Zygote (could be a</span>
<span class="token number">388</span>              <span class="token comment">// regular Zygote, a WebView Zygote, or an AppZygote).</span>
<span class="token number">389</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>mUsapPoolEnabled<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">390</span>                  usapPipeFDs <span class="token operator">=</span> <span class="token class-name">Zygote</span><span class="token punctuation">.</span><span class="token function">getUsapPipeFDs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">391</span>                  pollFDs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StructPollfd</span><span class="token punctuation">[</span>socketFDs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> usapPipeFDs<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token number">392</span>              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">393</span>                  pollFDs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StructPollfd</span><span class="token punctuation">[</span>socketFDs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token number">394</span>              <span class="token punctuation">}</span>
<span class="token number">395</span>  
<span class="token number">396</span>              <span class="token comment">/*
397               * For reasons of correctness the USAP pool pipe and event FDs
398               * must be processed before the session and server sockets.  This
399               * is to ensure that the USAP pool accounting information is
400               * accurate when handling other requests like API blacklist
401               * exemptions.
402               */</span>
<span class="token number">403</span>  
<span class="token number">404</span>              <span class="token keyword">int</span> pollIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">405</span>              <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">FileDescriptor</span> socketFD <span class="token operator">:</span> socketFDs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">406</span>                  pollFDs<span class="token punctuation">[</span>pollIndex<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StructPollfd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">407</span>                  pollFDs<span class="token punctuation">[</span>pollIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> socketFD<span class="token punctuation">;</span>
<span class="token number">408</span>                  pollFDs<span class="token punctuation">[</span>pollIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> POLLIN<span class="token punctuation">;</span>
<span class="token number">409</span>                  <span class="token operator">++</span>pollIndex<span class="token punctuation">;</span>
<span class="token number">410</span>              <span class="token punctuation">}</span>
<span class="token number">411</span>  
<span class="token number">412</span>              <span class="token keyword">final</span> <span class="token keyword">int</span> usapPoolEventFDIndex <span class="token operator">=</span> pollIndex<span class="token punctuation">;</span>
<span class="token number">413</span>  
<span class="token number">414</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>mUsapPoolEnabled<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">415</span>                  pollFDs<span class="token punctuation">[</span>pollIndex<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StructPollfd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">416</span>                  pollFDs<span class="token punctuation">[</span>pollIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> mUsapPoolEventFD<span class="token punctuation">;</span>
<span class="token number">417</span>                  pollFDs<span class="token punctuation">[</span>pollIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> POLLIN<span class="token punctuation">;</span>
<span class="token number">418</span>                  <span class="token operator">++</span>pollIndex<span class="token punctuation">;</span>
<span class="token number">419</span>  
<span class="token number">420</span>                  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> usapPipeFD <span class="token operator">:</span> usapPipeFDs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">421</span>                      <span class="token class-name">FileDescriptor</span> managedFd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">422</span>                      managedFd<span class="token punctuation">.</span>setInt$<span class="token punctuation">(</span>usapPipeFD<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">423</span>  
<span class="token number">424</span>                      pollFDs<span class="token punctuation">[</span>pollIndex<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StructPollfd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">425</span>                      pollFDs<span class="token punctuation">[</span>pollIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> managedFd<span class="token punctuation">;</span>
<span class="token number">426</span>                      pollFDs<span class="token punctuation">[</span>pollIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> POLLIN<span class="token punctuation">;</span>
<span class="token number">427</span>                      <span class="token operator">++</span>pollIndex<span class="token punctuation">;</span>
<span class="token number">428</span>                  <span class="token punctuation">}</span>
<span class="token number">429</span>              <span class="token punctuation">}</span>
<span class="token number">430</span>  
<span class="token number">431</span>              <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">432</span>                  <span class="token class-name">Os</span><span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>pollFDs<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">433</span>              <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ErrnoException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">434</span>                  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"poll failed"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">435</span>              <span class="token punctuation">}</span>
<span class="token number">436</span>  
<span class="token number">437</span>              <span class="token keyword">boolean</span> usapPoolFDRead <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token number">438</span>  
<span class="token number">439</span>              <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>pollIndex <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">440</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pollFDs<span class="token punctuation">[</span>pollIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLIN<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">441</span>                      <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token number">442</span>                  <span class="token punctuation">}</span>
<span class="token number">443</span>  
<span class="token number">444</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span>pollIndex <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">445</span>                      <span class="token comment">// Zygote server socket</span>
<span class="token number">446</span>  
<span class="token number">447</span>                      <span class="token class-name">ZygoteConnection</span> newPeer <span class="token operator">=</span> <span class="token function">acceptCommandPeer</span><span class="token punctuation">(</span>abiList<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">448</span>                      peers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>newPeer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">449</span>                      socketFDs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>newPeer<span class="token punctuation">.</span><span class="token function">getFileDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">450</span>  
<span class="token number">451</span>                  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pollIndex <span class="token operator">&lt;</span> usapPoolEventFDIndex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">452</span>                      <span class="token comment">// Session socket accepted from the Zygote server socket</span>
<span class="token number">453</span>  
<span class="token number">454</span>                      <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">455</span>                          <span class="token class-name">ZygoteConnection</span> connection <span class="token operator">=</span> peers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pollIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">456</span>                          <span class="token keyword">final</span> <span class="token class-name">Runnable</span> command <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">processOneCommand</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">457</span>  
<span class="token number">458</span>                          <span class="token comment">// TODO (chriswailes): Is this extra check necessary?</span>
<span class="token number">459</span>                          <span class="token keyword">if</span> <span class="token punctuation">(</span>mIsForkChild<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">460</span>                              <span class="token comment">// We're in the child. We should always have a command to run at this</span>
<span class="token number">461</span>                              <span class="token comment">// stage if processOneCommand hasn't called "exec".</span>
<span class="token number">462</span>                              <span class="token keyword">if</span> <span class="token punctuation">(</span>command <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">463</span>                                  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"command == null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">464</span>                              <span class="token punctuation">}</span>
<span class="token number">465</span>  
<span class="token number">466</span>                              <span class="token keyword">return</span> command<span class="token punctuation">;</span>
<span class="token number">467</span>                          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">468</span>                              <span class="token comment">// We're in the server - we should never have any commands to run.</span>
<span class="token number">469</span>                              <span class="token keyword">if</span> <span class="token punctuation">(</span>command <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">470</span>                                  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"command != null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">471</span>                              <span class="token punctuation">}</span>
<span class="token number">472</span>  
<span class="token number">473</span>                              <span class="token comment">// We don't know whether the remote side of the socket was closed or</span>
<span class="token number">474</span>                              <span class="token comment">// not until we attempt to read from it from processOneCommand. This</span>
<span class="token number">475</span>                              <span class="token comment">// shows up as a regular POLLIN event in our regular processing loop.</span>
<span class="token number">476</span>                              <span class="token keyword">if</span> <span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">isClosedByPeer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">477</span>                                  connection<span class="token punctuation">.</span><span class="token function">closeSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">478</span>                                  peers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>pollIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">479</span>                                  socketFDs<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>pollIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">480</span>                              <span class="token punctuation">}</span>
<span class="token number">481</span>                          <span class="token punctuation">}</span>
<span class="token number">482</span>                      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">483</span>                          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mIsForkChild<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">484</span>                              <span class="token comment">// We're in the server so any exception here is one that has taken place</span>
<span class="token number">485</span>                              <span class="token comment">// pre-fork while processing commands or reading / writing from the</span>
<span class="token number">486</span>                              <span class="token comment">// control socket. Make a loud noise about any such exceptions so that</span>
<span class="token number">487</span>                              <span class="token comment">// we know exactly what failed and why.</span>
<span class="token number">488</span>  
<span class="token number">489</span>                              <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Exception executing zygote command: "</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">490</span>  
<span class="token number">491</span>                              <span class="token comment">// Make sure the socket is closed so that the other end knows</span>
<span class="token number">492</span>                              <span class="token comment">// immediately that something has gone wrong and doesn't time out</span>
<span class="token number">493</span>                              <span class="token comment">// waiting for a response.</span>
<span class="token number">494</span>                              <span class="token class-name">ZygoteConnection</span> conn <span class="token operator">=</span> peers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>pollIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">495</span>                              conn<span class="token punctuation">.</span><span class="token function">closeSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">496</span>  
<span class="token number">497</span>                              socketFDs<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>pollIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">498</span>                          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">499</span>                              <span class="token comment">// We're in the child so any exception caught here has happened post</span>
<span class="token number">500</span>                              <span class="token comment">// fork and before we execute ActivityThread.main (or any other main()</span>
<span class="token number">501</span>                              <span class="token comment">// method). Log the details of the exception and bring down the process.</span>
<span class="token number">502</span>                              <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Caught post-fork exception in child process."</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">503</span>                              <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
<span class="token number">504</span>                          <span class="token punctuation">}</span>
<span class="token number">505</span>                      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">506</span>                          <span class="token comment">// Reset the child flag, in the event that the child process is a child-</span>
<span class="token number">507</span>                          <span class="token comment">// zygote. The flag will not be consulted this loop pass after the Runnable</span>
<span class="token number">508</span>                          <span class="token comment">// is returned.</span>
<span class="token number">509</span>                          mIsForkChild <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token number">510</span>                      <span class="token punctuation">}</span>
<span class="token number">511</span>                  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">512</span>                      <span class="token comment">// Either the USAP pool event FD or a USAP reporting pipe.</span>
<span class="token number">513</span>  
<span class="token number">514</span>                      <span class="token comment">// If this is the event FD the payload will be the number of USAPs removed.</span>
<span class="token number">515</span>                      <span class="token comment">// If this is a reporting pipe FD the payload will be the PID of the USAP</span>
<span class="token number">516</span>                      <span class="token comment">// that was just specialized.</span>
<span class="token number">517</span>                      <span class="token keyword">long</span> messagePayload <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token number">518</span>  
<span class="token number">519</span>                      <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">520</span>                          <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token class-name">Zygote</span><span class="token punctuation">.</span>USAP_MANAGEMENT_MESSAGE_BYTES<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token number">521</span>                          <span class="token keyword">int</span> readBytes <span class="token operator">=</span> <span class="token class-name">Os</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>pollFDs<span class="token punctuation">[</span>pollIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>fd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> buffer<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">522</span>  
<span class="token number">523</span>                          <span class="token keyword">if</span> <span class="token punctuation">(</span>readBytes <span class="token operator">==</span> <span class="token class-name">Zygote</span><span class="token punctuation">.</span>USAP_MANAGEMENT_MESSAGE_BYTES<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">524</span>                              <span class="token class-name">DataInputStream</span> inputStream <span class="token operator">=</span>
<span class="token number">525</span>                                      <span class="token keyword">new</span> <span class="token class-name">DataInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">526</span>  
<span class="token number">527</span>                              messagePayload <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">readLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">528</span>                          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">529</span>                              <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Incomplete read from USAP management FD of size "</span>
<span class="token number">530</span>                                      <span class="token operator">+</span> readBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">531</span>                              <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token number">532</span>                          <span class="token punctuation">}</span>
<span class="token number">533</span>                      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">534</span>                          <span class="token keyword">if</span> <span class="token punctuation">(</span>pollIndex <span class="token operator">==</span> usapPoolEventFDIndex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">535</span>                              <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Failed to read from USAP pool event FD: "</span>
<span class="token number">536</span>                                      <span class="token operator">+</span> ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">537</span>                          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">538</span>                              <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Failed to read from USAP reporting pipe: "</span>
<span class="token number">539</span>                                      <span class="token operator">+</span> ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">540</span>                          <span class="token punctuation">}</span>
<span class="token number">541</span>  
<span class="token number">542</span>                          <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token number">543</span>                      <span class="token punctuation">}</span>
<span class="token number">544</span>  
<span class="token number">545</span>                      <span class="token keyword">if</span> <span class="token punctuation">(</span>pollIndex <span class="token operator">&gt;</span> usapPoolEventFDIndex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">546</span>                          <span class="token class-name">Zygote</span><span class="token punctuation">.</span><span class="token function">removeUsapTableEntry</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> messagePayload<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">547</span>                      <span class="token punctuation">}</span>
<span class="token number">548</span>  
<span class="token number">549</span>                      usapPoolFDRead <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token number">550</span>                  <span class="token punctuation">}</span>
<span class="token number">551</span>              <span class="token punctuation">}</span>
<span class="token number">552</span>  
<span class="token number">553</span>              <span class="token comment">// Check to see if the USAP pool needs to be refilled.</span>
<span class="token number">554</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>usapPoolFDRead<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">555</span>                  <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> sessionSocketRawFDs <span class="token operator">=</span>
<span class="token number">556</span>                          socketFDs<span class="token punctuation">.</span><span class="token function">subList</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> socketFDs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">557</span>                                  <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">558</span>                                  <span class="token punctuation">.</span><span class="token function">mapToInt</span><span class="token punctuation">(</span>fd <span class="token operator">-&gt;</span> fd<span class="token punctuation">.</span>getInt$<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">559</span>                                  <span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">560</span>  
<span class="token number">561</span>                  <span class="token keyword">final</span> <span class="token class-name">Runnable</span> command <span class="token operator">=</span> <span class="token function">fillUsapPool</span><span class="token punctuation">(</span>sessionSocketRawFDs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">562</span>  
<span class="token number">563</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span>command <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">564</span>                      <span class="token keyword">return</span> command<span class="token punctuation">;</span>
<span class="token number">565</span>                  <span class="token punctuation">}</span>
<span class="token number">566</span>              <span class="token punctuation">}</span>
<span class="token number">567</span>          <span class="token punctuation">}</span>
<span class="token number">568</span>      <span class="token punctuation">}</span>
<span class="token number">569</span>  <span class="token punctuation">}</span>
</code></pre> 
<p>主要做3件事：</p> 
<ol><li><code>创建ZygoteServer</code>：ZygoteServer初始化，内部对ServerSocket进行了初始化，为Zygote提供了通信的能力。</li><li><code>zygoteServer.runSelectLoop()</code>：当zygote进程返回到main()方法后执行，从名字上和注释来看，这个方法应该是一个死循环，是不断进行循环执行命令的方法，主要做了两件事：​<br> 1.每次循环都重新构建监听文件列表，主要是ZygoteServer的socket文件(ZygoteServer的socket和其他应用进程连接过来的socket)和usap文件节点(目前看来，zygote默认是没有使用，作用未明，不做分析)。<br> ​2.监听文件列表，并从中获取命令执行。</li><li><code>zygoteServer.closeServerSocket()</code>：在循环后，关闭ServerSocket</li></ol> 
<h4><a id="233_SystemServer_737"></a>2.3.3 创建SystemServer进程</h4> 
<pre><code class="prism language-java"><span class="token number">718</span>      <span class="token comment">/**
719       * Prepare the arguments and forks for the system server process.
720       *
721       * @return A {@code Runnable} that provides an entrypoint into system_server code in the child
722       * process; {@code null} in the parent.
723       */</span>
<span class="token number">724</span>      <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Runnable</span> <span class="token function">forkSystemServer</span><span class="token punctuation">(</span><span class="token class-name">String</span> abiList<span class="token punctuation">,</span> <span class="token class-name">String</span> socketName<span class="token punctuation">,</span>
<span class="token number">725</span>              <span class="token class-name">ZygoteServer</span> zygoteServer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">726</span>          <span class="token keyword">long</span> capabilities <span class="token operator">=</span> <span class="token function">posixCapabilitiesAsBits</span><span class="token punctuation">(</span>
<span class="token number">727</span>                  <span class="token class-name">OsConstants</span><span class="token punctuation">.</span>CAP_IPC_LOCK<span class="token punctuation">,</span>
<span class="token number">728</span>                  <span class="token class-name">OsConstants</span><span class="token punctuation">.</span>CAP_KILL<span class="token punctuation">,</span>
<span class="token number">729</span>                  <span class="token class-name">OsConstants</span><span class="token punctuation">.</span>CAP_NET_ADMIN<span class="token punctuation">,</span>
<span class="token number">730</span>                  <span class="token class-name">OsConstants</span><span class="token punctuation">.</span>CAP_NET_BIND_SERVICE<span class="token punctuation">,</span>
<span class="token number">731</span>                  <span class="token class-name">OsConstants</span><span class="token punctuation">.</span>CAP_NET_BROADCAST<span class="token punctuation">,</span>
<span class="token number">732</span>                  <span class="token class-name">OsConstants</span><span class="token punctuation">.</span>CAP_NET_RAW<span class="token punctuation">,</span>
<span class="token number">733</span>                  <span class="token class-name">OsConstants</span><span class="token punctuation">.</span>CAP_SYS_MODULE<span class="token punctuation">,</span>
<span class="token number">734</span>                  <span class="token class-name">OsConstants</span><span class="token punctuation">.</span>CAP_SYS_NICE<span class="token punctuation">,</span>
<span class="token number">735</span>                  <span class="token class-name">OsConstants</span><span class="token punctuation">.</span>CAP_SYS_PTRACE<span class="token punctuation">,</span>
<span class="token number">736</span>                  <span class="token class-name">OsConstants</span><span class="token punctuation">.</span>CAP_SYS_TIME<span class="token punctuation">,</span>
<span class="token number">737</span>                  <span class="token class-name">OsConstants</span><span class="token punctuation">.</span>CAP_SYS_TTY_CONFIG<span class="token punctuation">,</span>
<span class="token number">738</span>                  <span class="token class-name">OsConstants</span><span class="token punctuation">.</span>CAP_WAKE_ALARM<span class="token punctuation">,</span>
<span class="token number">739</span>                  <span class="token class-name">OsConstants</span><span class="token punctuation">.</span>CAP_BLOCK_SUSPEND
<span class="token number">740</span>          <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">741</span>          <span class="token comment">/* Containers run without some capabilities, so drop any caps that are not available. */</span>
<span class="token number">742</span>          <span class="token class-name">StructCapUserHeader</span> header <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StructCapUserHeader</span><span class="token punctuation">(</span>
<span class="token number">743</span>                  <span class="token class-name">OsConstants</span><span class="token punctuation">.</span>_LINUX_CAPABILITY_VERSION_3<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">744</span>          <span class="token class-name">StructCapUserData</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data<span class="token punctuation">;</span>
<span class="token number">745</span>          <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">746</span>              data <span class="token operator">=</span> <span class="token class-name">Os</span><span class="token punctuation">.</span><span class="token function">capget</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">747</span>          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ErrnoException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">748</span>              <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Failed to capget()"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">749</span>          <span class="token punctuation">}</span>
<span class="token number">750</span>          capabilities <span class="token operator">&amp;=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>effective<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>effective<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">751</span>  
<span class="token number">752</span>          <span class="token comment">/* Hardcoded command line to start the system server */</span>
<span class="token number">753</span>          <span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">754</span>                  <span class="token string">"--setuid=1000"</span><span class="token punctuation">,</span>
<span class="token number">755</span>                  <span class="token string">"--setgid=1000"</span><span class="token punctuation">,</span>
<span class="token number">756</span>                  <span class="token string">"--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1023,"</span>
<span class="token number">757</span>                          <span class="token operator">+</span> <span class="token string">"1024,1032,1065,3001,3002,3003,3006,3007,3009,3010"</span><span class="token punctuation">,</span>
<span class="token number">758</span>                  <span class="token string">"--capabilities="</span> <span class="token operator">+</span> capabilities <span class="token operator">+</span> <span class="token string">","</span> <span class="token operator">+</span> capabilities<span class="token punctuation">,</span>
<span class="token number">759</span>                  <span class="token string">"--nice-name=system_server"</span><span class="token punctuation">,</span>
<span class="token number">760</span>                  <span class="token string">"--runtime-args"</span><span class="token punctuation">,</span>
<span class="token number">761</span>                  <span class="token string">"--target-sdk-version="</span> <span class="token operator">+</span> <span class="token class-name">VMRuntime</span><span class="token punctuation">.</span>SDK_VERSION_CUR_DEVELOPMENT<span class="token punctuation">,</span>
<span class="token number">762</span>                  <span class="token string">"com.android.server.SystemServer"</span><span class="token punctuation">,</span>
<span class="token number">763</span>          <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token number">764</span>          <span class="token class-name">ZygoteArguments</span> parsedArgs <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token number">765</span>  
<span class="token number">766</span>          <span class="token keyword">int</span> pid<span class="token punctuation">;</span>
<span class="token number">767</span>  
<span class="token number">768</span>          <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">769</span>              parsedArgs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZygoteArguments</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">770</span>              <span class="token class-name">Zygote</span><span class="token punctuation">.</span><span class="token function">applyDebuggerSystemProperty</span><span class="token punctuation">(</span>parsedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">771</span>              <span class="token class-name">Zygote</span><span class="token punctuation">.</span><span class="token function">applyInvokeWithSystemProperty</span><span class="token punctuation">(</span>parsedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">772</span>  
<span class="token number">773</span>              <span class="token keyword">boolean</span> profileSystemServer <span class="token operator">=</span> <span class="token class-name">SystemProperties</span><span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>
<span class="token number">774</span>                      <span class="token string">"dalvik.vm.profilesystemserver"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">775</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>profileSystemServer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">776</span>                  parsedArgs<span class="token punctuation">.</span>mRuntimeFlags <span class="token operator">|=</span> <span class="token class-name">Zygote</span><span class="token punctuation">.</span>PROFILE_SYSTEM_SERVER<span class="token punctuation">;</span>
<span class="token number">777</span>              <span class="token punctuation">}</span>
<span class="token number">778</span>  
<span class="token number">779</span>              <span class="token comment">/* Request to fork the system server process */</span>
<span class="token number">780</span>              pid <span class="token operator">=</span> <span class="token class-name">Zygote</span><span class="token punctuation">.</span><span class="token function">forkSystemServer</span><span class="token punctuation">(</span>
<span class="token number">781</span>                      parsedArgs<span class="token punctuation">.</span>mUid<span class="token punctuation">,</span> parsedArgs<span class="token punctuation">.</span>mGid<span class="token punctuation">,</span>
<span class="token number">782</span>                      parsedArgs<span class="token punctuation">.</span>mGids<span class="token punctuation">,</span>
<span class="token number">783</span>                      parsedArgs<span class="token punctuation">.</span>mRuntimeFlags<span class="token punctuation">,</span>
<span class="token number">784</span>                      <span class="token keyword">null</span><span class="token punctuation">,</span>
<span class="token number">785</span>                      parsedArgs<span class="token punctuation">.</span>mPermittedCapabilities<span class="token punctuation">,</span>
<span class="token number">786</span>                      parsedArgs<span class="token punctuation">.</span>mEffectiveCapabilities<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">787</span>          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalArgumentException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">788</span>              <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">789</span>          <span class="token punctuation">}</span>
<span class="token number">790</span>  
<span class="token number">791</span>          <span class="token comment">/* For child process */</span>
<span class="token number">792</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">793</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasSecondZygote</span><span class="token punctuation">(</span>abiList<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">794</span>                  <span class="token function">waitForSecondaryZygote</span><span class="token punctuation">(</span>socketName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">795</span>              <span class="token punctuation">}</span>
<span class="token number">796</span>  
<span class="token number">797</span>              zygoteServer<span class="token punctuation">.</span><span class="token function">closeServerSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">798</span>              <span class="token keyword">return</span> <span class="token function">handleSystemServerProcess</span><span class="token punctuation">(</span>parsedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">799</span>          <span class="token punctuation">}</span>
<span class="token number">800</span>  
<span class="token number">801</span>          <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token number">802</span>      <span class="token punctuation">}</span>
</code></pre> 
<p><code>forkSystemServer()</code>：<br> ①调用Zygote.forkSystemServer()方法去fork一个新的进程出来。<br> ②fork()后的子进程是SystemServer进程，则等待zygote的启动完成，并执行真正的SystemServer代码。</p> 
<h3><a id="24_Zygote_829"></a>2.4 Zygote启动流程图</h3> 
<p><img src="https://images2.imgbox.com/2e/5b/R1pWYtxo_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="3__831"></a>3 总结</h2> 
<p>所有的进程都由Zygote创建，zygote主要用来孵化<code>system_server进程</code>和<code>应用程序进程</code>。在孵化出第一个进程system_server后通过<code>runSelectLoop</code>等待并处理消息，分裂应用程序进程仍由system_server控制，<code>等待 AMS 给他发消息（告诉 zygote 创建进程）</code>，如app启动时创建子进程。</p> 
<p>从AndroidRuntime到ZygoteInit，主要分为3大过程：</p> 
<blockquote> 
 <p>1、<code>创建虚拟机——startVm()</code>:调用JNI虚拟机创建函数<br> 2、<code>注册JNI函数——startReg()</code>：前面已经创建虚拟机，这里给这个虚拟机注册一些JNI函数（后续java世界用到的函数是native实现，这里需要提前注册注册这些函数）<br> 3、此时就要<code>执行CallStaticViodMethod</code>，通过这个函数将进入android精心打造的java世界，这个函数将调用com.android.internal.os.ZygoteInit的main函数</p> 
</blockquote> 
<p>在 ZygoteInit.main函数中进入Java世界，主要有4个关键步骤：</p> 
<blockquote> 
 <p>1、<code>预加载类和资源——preload()</code><br> 主要是preloadClasses和preloadResources，其中preloadClasses一般是加载时间超过1250ms的类，因而需要在zygote预加载<br> 2、<code>建立IPC通信服务——初始化ZygoteServer，内部初始化了ZygoteSocket</code><br> zygote及系统中其他程序的通信并没有使用Binder，而是采用基于AF_UNIX类型的Socket，作用正是建立这个Socket<br> 3、<code>启动system_server——forkSystemServer()</code><br> 这个函数会创建Java世界中系统Service所驻留的进程system_server,该进程是framework的核心，也是zygote孵化出的第一个进程。如果它死了，就会导致zygote自杀。<br> 4、<code>等待请求——runSelectLoop()</code><br> zygote从startSystemServer返回后，将进入第四个关键函数runSelectLoop，在第一个函数ZygoteServer中注册了一个用于IPC的Socket将在这里使用，这里Zygote采用高效的I/O多路复用机制，保证在没有客户端请求时或者数据处理时休眠，否则响应客户端的请求。<code>等待 AMS 给他发消息（告诉 zygote 创建进程）</code>。此时zygote完成了java世界的初创工作，调用runSelectLoop便开始休眠了，当收到请求或者数据处理便会随时醒来，继续工作。</p> 
</blockquote> 
<h2><a id="4__849"></a>4 面试题</h2> 
<h3><a id="1_init_850"></a>1 init进程作用是什么</h3> 
<p>init进程起着承上启下的作用，Android本身是基于Linux而来的，init进程是Linux系统中用户空间的第一个进程。init进程属于一个守护进程，准确的说，它是Linux系统中用户控制的第一个进程，它的进程号为1（进程号为0的为内核进程），它的生命周期贯穿整个Linux内核运行的始终。Android中所有其它的进程共同的鼻祖均为init进程。<br> Android Q(10.0) 的init入口函数由原先的init.cpp 调整到了main.cpp，把各个阶段的操作分离开来，使代码更加简洁命令。<br> 作为天子第1号进程，init被赋予了很多重要的职责，主要分为三个阶段：</p> 
<blockquote> 
 <ol><li>init进程第一阶段做的主要工作是<code>挂载分区</code>，创建设备节点和一些关键目录，初始化日志输出系统,启用SELinux安全策略。</li><li>init进程第二阶段主要工作是<code>初始化属性系统</code>，解析SELinux的匹配规则，处理子进程终止信号，启动系统属性服务，可以说每一项都很关键，如果说第一阶段是为属性系统，SELinux做准备，那么第二阶段就是真正去把这些功能落实。</li><li>init进行第三阶段主要是<code>解析init.rc来启动其他进程</code>，进入无限循环，进行<code>子进程实时监控(守护)</code>。</li></ol> 
</blockquote> 
<p>其中第三阶段通过initrc启动其他进程，我们常见的比如<code>启动Zygote进程</code>、<code>启动SeviceManager进程</code>等。</p> 
<h3><a id="2_ZygoteZygote_859"></a>2 Zygote进程最原始的进程是什么进程(或者Zygote进程由来)</h3> 
<p>Zygote最开始是<code>app_process</code>，它是在 init 进程启动时被启动的，在<code>app_main.cpp</code>才被修改为 Zygote。</p> 
<h3><a id="3_Zygote__861"></a>3 Zygote 是在内核空间还是在用户空间？</h3> 
<p>因为 init 进程的创建在用户空间，而 Zygote 是由 init 进程创建启动的，所以<code>Zygote是在用户空间。</code></p> 
<h3><a id="4_ZygoteSocketBinder_863"></a>4 Zygote为什么需要用到Socket通信而不是Binder</h3> 
<p>Zygote是Android中的一个重要进程，它是启动应用程序进程的父进程。Zygote使用Socket来与应用程序进程进行通信，而不是使用Android中的IPC机制Binder，这是因为Socket和Binder有不同的优缺点，而在Zygote进程中使用Socket可以更好地满足Zygote进程的需求。</p> 
<ol><li><code>Zygote 用 binder 通信会导致死锁</code><br> 假设 Zygote 使用 Binder 通信，因为 Binder 是支持多线程的，存在并发问题，而并发问题的解决方案就是加锁，如果进程 fork 是在多线程情况下运行，Binder 等待锁在锁机制下就可能会出现死锁。</li><li><code>Zygote 用 binder 通信会导致读写错误</code><br> 根本原因在于要 new 一个 ProcessState 用于 Binder 通信时，需要 mmap 申请一片内存用以提供给内核进行数据交换使用。而如果直接 fork 了的话，子进程在进行 binder 通信时，内核还是会继续使用父进程申请的地址写数据，而此时会触发子进程 COW（Copy on Write），从而导致地址空间已经重新映射，而子进程还尝试访问之前父进程 mmap 的地址，会导致 SIGSEGV、SEGV_MAPERR段错误。</li><li><code>Zygote初始化时，Binder还没开始初始化。</code></li><li><code>Socket具有良好的跨平台性</code>，能够在不同的操作系统和语言之间进行通信。这对于Zygote进程来说非常重要，因为它需要在不同的设备和架构上运行，并且需要与不同的应用程序进程进行通信。使用Socket可以让Zygote进程更加灵活和可扩展，因为它不需要考虑Binder所带来的特定限制和要求。</li><li><code>Socket具有简单的API和易于使用的特点</code>。Zygote进程需要快速启动并与应用程序进程建立通信，Socket提供了快速、可靠的通信方式，并且使用Socket API也很容易实现。相比之下，Binder需要更多的配置和维护工作，这对于Zygote进程来说可能会增加不必要的复杂性和开销。</li><li><code>Socket在数据传输时具有更低的延迟和更高的吞吐量</code>，这对于Zygote进程来说非常重要。Zygote进程需要在较短的时间内启动应用程序进程，并且需要传输大量的数据和代码，Socket的高性能和低延迟使其成为更好的选择。</li></ol> 
<p><strong>总之，Zygote进程使用Socket而不是Binder是基于其优点和需求而做出的选择。虽然Binder在Android中扮演着重要的角色，但在某些情况下，使用Socket可以提供更好的性能和更大的灵活性。再者，Binder当初并不成熟，团队成员对于进程间通讯更倾向于用Socket，后面为了做了很多优化，才使得Binder通讯变得成熟稳定。</strong></p> 
<h3><a id="5_App_875"></a>5 每个App都会将系统的资源，系统的类都加载一遍吗</h3> 
<p>zygote进程的作用：<br> 1.创建一个Service端的Socket，开启一个ServerSocket实现和别的进程通信。<br> 2.加载系统类，系统资源。<br> 3.启动System Server进程</p> 
<p><strong>Zygote进程预加载系统资源后，然后通过它孵化出其他的虚拟机进程，进而共享虚拟机内存和框架层资源<code>（共享内存）</code>，这样大幅度提高应用程序的启动和运行速度。</strong></p> 
<h3><a id="6_PMS_PMS_883"></a>6 PMS 是干什么的，你是怎么理解PMS</h3> 
<p><strong>包管理，包解析，结果缓存，提供查询接口。</strong></p> 
<ol><li>遍历<code>/data/app</code>的文件夹</li><li>解压<code>apk</code>文件</li><li>dom解析<code>AndroidManifest.xml</code>文件。</li></ol> 
<h3><a id="7_AMS_AMS_890"></a>7 为什么会有AMS AMS的作用</h3> 
<ol><li>查询PMS</li><li>反射生成对象</li><li>管理Activity生命周期</li></ol> 
<p>AMS缓存中心：<code>ActivityThread</code></p> 
<h3><a id="8_AMSActivityAMS_897"></a>8 AMS如何管理Activity，探探AMS的执行原理</h3> 
<p>Activity在应用端由<code>ActivityClientRecord</code>负责描述其生命周期的过程与状态，但最终这些过程与状态是由<code>ActivityManagerService(以下简称AMS)</code>来管理和控制的</p> 
<ol><li><code>BroadcastRecord</code>：描述了应用进程的BroadcastReceiver，由<code>BroadcastQueue</code>负责管理。</li><li><code>ServiceRecord</code>：描述了Service服务组件，由<code>ActiveServices</code>负责管理。</li><li><code>ContentProviderRecord</code>：描述ContentProvider内容提供者，由<code>ProviderMap</code>管理。</li><li><code>ActivityRecord</code>：用于描述Activity，由<code>ActivityStackSupervisor</code>进行管理。</li></ol>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/be73a6f87705b4238c76c8533a6c819e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">JAVA生成唯一订单编号方案（两种方式)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0d16a58d3ba9f9d666c806c95c8aa2db/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">wangEditor5 富文本编辑器基于 vue3、Nuxt3</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>