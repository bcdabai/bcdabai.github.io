<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>在PHP中使用协程(yield )实现多任务调度 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="在PHP中使用协程(yield )实现多任务调度" />
<meta property="og:description" content="PHP5.5一个比较好的新功能是加入了对迭代生成器和协程的支持。对于生成器，PHP的文档和各种其他的博客文章已经有了非常详细的讲解。协程相对受到的关注就少了，因为协程虽然有很强大的功能但相对比较复杂, 也比较难被理解，解释起来也比较困难。 这篇文章将尝试通过介绍如何使用协程来实施任务调度, 来解释在PHP中的协程。
迭代生成器 生成器也是一个函数，不同的是这个函数的返回值是依次输出，而不是只返回一个单独的值。或者，换句话说，生成器使你更方便的实现了迭代器接口。下面通过实现一个xrange函数来简单说明：
&lt;?php function xrange($start, $end, $step = 1) { for ($i = $start; $i &lt;= $end; $i &#43;= $step) { yield $i; } } foreach (xrange(1, 1000000) as $num) { echo $num, &#34;\n&#34;; } 上面这个xrange（）函数提供了和PHP的内建函数range()一样的功能。但是不同的是range()函数返回的是一个包含属组值从1到100万的数组（注：请查看手册）。而xrange（）函数返回的是依次输出这些值的一个迭代器，而且并不会真正以数组形式返回. 这种方法的优点是显而易见的。它可以让你在处理大数据集合的时候不用一次性的加载到内存中。甚至你可以处理无限大的数据流。当然，也可以不同通过生成器来实现这个功能，而是可以通过继承Iterator接口实现。但通过使用生成器实现起来会更方便，不用再去实现iterator接口中的5个方法了。生成器为可中断的函数 要从生成器认识协程，理解它们内部是如何工作是非常重要的: 生成器是一种可中断的函数，在它里面，yield构成了中断点。 紧接着上面的例子，如果你调用xrange(1,1000000)的话，xrange()函数里代码其实并没有真正地运行。相反，PHP只是返回了一个实现了迭代器接口的生成器类实例：
&lt;?php $range = xrange(1, 1000000); var_dump($range); // object(Generator)#1 var_dump($range instanceof Iterator); // bool(true) 你对对象调用迭代器方法一次，其中的代码运行一次。例如，如果你调用$range-&gt;rewind(), 那么xrange()里的代码就会运行到控制流第一次出现yield的地方。而函数内传递给yield语句的返回值可以通过$range-&gt;current()获取。 为了继续执行生成器中的代码，你必须调用$range-&gt;next()方法。这将再次启动生成器，直到下一次yield语句出现。因此，连续调用next()和current()方法 你将能从生成器里获得所有的值，直到再没有yield语句出现。对xrange()来说，这种情形出现在$i超过$end时。在这中情况下, 控制流将到达函数的终点，因此将不执行任何代码。一旦这种情况发生，vaild()方法将返回假，这时迭代结束。 协程 协程给上面功能添加的主要功能就是回送数据给生成器的能力(调用者发送数据给被调用的生成器函数)。这就把生成器到调用者的单向通信转变为两者之间的双向通信。 你可以调用生成器的send()方法传递数据给协程。下面的logger()协程是这种通信如何运行的例子：
&lt;?php function logger($fileName) { $fileHandle = fopen($fileName, &#39;a&#39;); while (true) { fwrite($fileHandle, yield ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/5d8c8d843e902dccbf4651aa7c923e8c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2017-02-20T17:30:50+08:00" />
<meta property="article:modified_time" content="2017-02-20T17:30:50+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">在PHP中使用协程(yield )实现多任务调度</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>PHP5.5一个比较好的新功能是加入了对迭代生成器和协程的支持。对于生成器，PHP的文档和各种其他的博客文章已经有了非常详细的讲解。协程相对受到的关注就少了，因为协程虽然有很强大的功能但相对比较复杂, 也比较难被理解，解释起来也比较困难。 这篇文章将尝试通过介绍如何使用协程来实施任务调度, 来解释在PHP中的协程。</p> 
</blockquote> 
<p><strong>迭代生成器</strong> <br> 生成器也是一个函数，不同的是这个函数的返回值是依次输出，而不是只返回一个单独的值。或者，换句话说，生成器使你更方便的实现了迭代器接口。下面通过实现一个xrange函数来简单说明：</p> 
<pre class="prettyprint"><code class=" hljs xml"><span class="php"><span class="hljs-preprocessor">&lt;?php</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">xrange</span><span class="hljs-params">(<span class="hljs-variable">$start</span>, <span class="hljs-variable">$end</span>, <span class="hljs-variable">$step</span> = <span class="hljs-number">1</span>)</span> {<!-- --></span>
    <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-variable">$start</span>; <span class="hljs-variable">$i</span> &lt;= <span class="hljs-variable">$end</span>; <span class="hljs-variable">$i</span> += <span class="hljs-variable">$step</span>) {
        <span class="hljs-keyword">yield</span> <span class="hljs-variable">$i</span>;
    }
}
<span class="hljs-keyword">foreach</span> (xrange(<span class="hljs-number">1</span>, <span class="hljs-number">1000000</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">$num</span>) {
    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$num</span>, <span class="hljs-string">"\n"</span>;
}</span></code></pre> 
<p>上面这个xrange（）函数提供了和PHP的内建函数range()一样的功能。但是不同的是range()函数返回的是一个包含属组值从1到100万的数组（注：请查看手册）。而xrange（）函数返回的是依次输出这些值的一个迭代器，而且并不会真正以数组形式返回. <br> 这种方法的优点是显而易见的。它可以让你在处理大数据集合的时候不用一次性的加载到内存中。甚至你可以处理无限大的数据流。当然，也可以不同通过生成器来实现这个功能，而是可以通过继承Iterator接口实现。但通过使用生成器实现起来会更方便，不用再去实现iterator接口中的5个方法了。生成器为可中断的函数 <br> 要从生成器认识协程，理解它们内部是如何工作是非常重要的: 生成器是一种可中断的函数，在它里面，yield构成了中断点。 <br> 紧接着上面的例子，如果你调用xrange(1,1000000)的话，xrange()函数里代码其实并没有真正地运行。相反，PHP只是返回了一个实现了迭代器接口的生成器类实例：</p> 
<pre class="prettyprint"><code class=" hljs xml"><span class="php"><span class="hljs-function"><span class="hljs-params">&lt;?php
    <span class="hljs-variable">$range</span> = xrange<span class="hljs-params">(<span class="hljs-number">1</span>, <span class="hljs-number">1000000</span>)</span>;
    var_dump<span class="hljs-params">(<span class="hljs-variable">$range</span>)</span>; // object<span class="hljs-params">(Generator)</span>#<span class="hljs-number">1</span>
    var_dump<span class="hljs-params">(<span class="hljs-variable">$range</span> instanceof Iterator)</span>; // bool<span class="hljs-params">(true)</span></span></span></span></code></pre> 
<p>你对对象调用迭代器方法一次，其中的代码运行一次。例如，如果你调用$range-&gt;rewind(), 那么xrange()里的代码就会运行到控制流第一次出现yield的地方。而函数内传递给yield语句的返回值可以通过$range-&gt;current()获取。 <br> 为了继续执行生成器中的代码，你必须调用$range-&gt;next()方法。这将再次启动生成器，直到下一次yield语句出现。因此，连续调用next()和current()方法 你将能从生成器里获得所有的值，直到再没有yield语句出现。对xrange()来说，这种情形出现在$i超过$end时。在这中情况下, 控制流将到达函数的终点，因此将不执行任何代码。一旦这种情况发生，vaild()方法将返回假，这时迭代结束。 <br> <strong>协程</strong> <br> 协程给上面功能添加的主要功能就是回送数据给生成器的能力(调用者发送数据给被调用的生成器函数)。这就把生成器到调用者的单向通信转变为两者之间的双向通信。 <br> 你可以调用生成器的send()方法传递数据给协程。下面的logger()协程是这种通信如何运行的例子：</p> 
<pre class="prettyprint"><code class=" hljs php"><span class="hljs-preprocessor">&lt;?php</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">logger</span><span class="hljs-params">(<span class="hljs-variable">$fileName</span>)</span> {<!-- --></span>
    <span class="hljs-variable">$fileHandle</span> = fopen(<span class="hljs-variable">$fileName</span>, <span class="hljs-string">'a'</span>);
    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) {
        fwrite(<span class="hljs-variable">$fileHandle</span>, <span class="hljs-keyword">yield</span> . <span class="hljs-string">"\n"</span>);
    }
}
<span class="hljs-variable">$logger</span> = logger(<span class="hljs-keyword">__DIR__</span> . <span class="hljs-string">'/log'</span>);
<span class="hljs-variable">$logger</span>-&gt;send(<span class="hljs-string">'Foo'</span>);
<span class="hljs-variable">$logger</span>-&gt;send(<span class="hljs-string">'Bar'</span>)</code></pre> 
<p>正如你能看到，这儿yield没有作为一个语句来使用，而是用作一个表达式, 即它能被演变成一个值。这个值就是调用者传递给send()方法的值。 在这个例子里，yield表达式将首先被”Foo”替代写入Log, 然后被”Bar”替代写入Log。 <br> 上面的例子里yield仅作为接收者。但它其实既可接收也可发送。接收和发送通信如何进行的例子如下：</p> 
<pre class="prettyprint"><code class=" hljs xml"><span class="php"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">&lt;?php
function gen<span class="hljs-params">()</span> {
    <span class="hljs-variable">$ret</span> = <span class="hljs-params">(yield <span class="hljs-string">'yield1'</span>)</span>;
    var_dump<span class="hljs-params">(<span class="hljs-variable">$ret</span>)</span>;
    <span class="hljs-variable">$ret</span> = <span class="hljs-params">(yield <span class="hljs-string">'yield2'</span>)</span>;
    var_dump<span class="hljs-params">(<span class="hljs-variable">$ret</span>)</span>;
}
<span class="hljs-variable">$gen</span> = gen<span class="hljs-params">()</span>;
var_dump<span class="hljs-params">(<span class="hljs-variable">$gen</span>-&gt;current<span class="hljs-params">()</span>)</span>; // string<span class="hljs-params">(<span class="hljs-number">6</span>)</span> <span class="hljs-string">"yield1"</span>
var_dump<span class="hljs-params">(<span class="hljs-variable">$gen</span>-&gt;send<span class="hljs-params">(<span class="hljs-string">'ret1'</span>)</span>)</span>; // string<span class="hljs-params">(<span class="hljs-number">4</span>)</span> <span class="hljs-string">"ret1"</span>   <span class="hljs-params">(the first var_dump in gen)</span>
                              // string<span class="hljs-params">(<span class="hljs-number">6</span>)</span> <span class="hljs-string">"yield2"</span> <span class="hljs-params">(the var_dump of the -&gt;send<span class="hljs-params">()</span> return value)</span>
var_dump<span class="hljs-params">(<span class="hljs-variable">$gen</span>-&gt;send<span class="hljs-params">(<span class="hljs-string">'ret2'</span>)</span>)</span>; // string<span class="hljs-params">(<span class="hljs-number">4</span>)</span> <span class="hljs-string">"ret2"</span>   <span class="hljs-params">(again from within gen)</span>
                              // NULL              <span class="hljs-params">(the return value of -&gt;send<span class="hljs-params">()</span>)</span></span></span></span></span></code></pre> 
<p>要马上理解输出的精确顺序有点困难，因此确定你知道为什按照这种方式输出。我要特别指出的有两点： <br> 第一点，yield表达式两边的括号在PHP7以前不是可选的, 也就是说在PHP5.5和PHP5.6中圆括号是必须的。 <br> 第二点，你可能已经注意到调用current()之前没有调用rewind()。这是因为生成迭代对象的时候已经隐含地执行了rewind操作。 <br> 多任务协作 <br> 如果阅读了上面的logger()例子，你也许会疑惑“为了双向通信我为什么要使用协程呢？我完全可以使用过程的方法实现同样的功能啊?”, 是的, 你是对的, 但上面的例子只是为了演示了基本用法，这个例子其实并没有真正的展示出使用协程的优点。 <br> 正如上面介绍里提到的，协程是非常强大的概念，不过却应用的很稀少而且常常十分复杂。要给出一些简单而真实的例子很难。 <br> 在这篇文章里，我决定去做的是使用协程实现多任务协作。我们要解决的问题是你想并发地运行多任务(或者“程序”）。不过我们都知道CPU在一个时刻只能运行一个任务（不考虑多核的情况）。因此处理器需要在不同的任务之间进行切换，而且总是让每个任务运行 “一小会儿”。 <br> 多任务协作这个术语中的“协作”说明了如何进行这种切换的：它要求当前正在运行的任务自动把控制传回给调度器，这样就可以运行其他任务了。这与“抢占”多任务相反，抢占多任务是这样的：调度器可以中断运行了一段时间的任务，不管它喜欢还是不喜欢。协作多任务在Windows的早期版本（windows95)和Mac OS中有使用，不过它们后来都切换到使用抢先多任务了。理由相当明确：如果你依靠程序自动交出控制的话，那么一些设计有问题的软件将很容易为自身占用整个CPU，不与其他任务共享。 <br> 现在你应当明白协程和任务调度之间的联系：yield指令提供了任务中断自身的一种方法，然后把控制交回给任务调度器。因此协程可以运行多个其他任务。更进一步来说，yield可以用来在任务和调度器之间进行通信。 <br> 我们的目的是 对 “任务”用更轻量级的包装的协程函数:</p> 
<pre class="prettyprint"><code class=" hljs php"><span class="hljs-preprocessor">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Task</span> {<!-- --></span>
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$taskId</span>;
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$coroutine</span>;
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$sendValue</span> = <span class="hljs-keyword">null</span>;
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$beforeFirstYield</span> = <span class="hljs-keyword">true</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(<span class="hljs-variable">$taskId</span>, Generator <span class="hljs-variable">$coroutine</span>)</span> {<!-- --></span>
        <span class="hljs-variable">$this</span>-&gt;taskId = <span class="hljs-variable">$taskId</span>;
        <span class="hljs-variable">$this</span>-&gt;coroutine = <span class="hljs-variable">$coroutine</span>;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getTaskId</span><span class="hljs-params">()</span> {<!-- --></span>
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span>-&gt;taskId;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setSendValue</span><span class="hljs-params">(<span class="hljs-variable">$sendValue</span>)</span> {<!-- --></span>
        <span class="hljs-variable">$this</span>-&gt;sendValue = <span class="hljs-variable">$sendValue</span>;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> {<!-- --></span>
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$this</span>-&gt;beforeFirstYield) {
            <span class="hljs-variable">$this</span>-&gt;beforeFirstYield = <span class="hljs-keyword">false</span>;
            <span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span>-&gt;coroutine-&gt;current();
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-variable">$retval</span> = <span class="hljs-variable">$this</span>-&gt;coroutine-&gt;send(<span class="hljs-variable">$this</span>-&gt;sendValue);
            <span class="hljs-variable">$this</span>-&gt;sendValue = <span class="hljs-keyword">null</span>;
            <span class="hljs-keyword">return</span> <span class="hljs-variable">$retval</span>;
        }
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isFinished</span><span class="hljs-params">()</span> {<!-- --></span>
        <span class="hljs-keyword">return</span> !<span class="hljs-variable">$this</span>-&gt;coroutine-&gt;valid();
    }
}</code></pre> 
<p>一个任务是用任务ID标记的一个协程。使用setSendValue()方法，你可以指定哪些值将被发送到下次的恢复（在之后你会了解到我们需要这个）。 run()函数确实没有做什么，除了调用send()方法的协同程序。要理解为什么添加beforeFirstYieldflag，需要考虑下面的代码片段：</p> 
<pre class="prettyprint"><code class=" hljs xml"><span class="php"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-params">&lt;?php function gen<span class="hljs-params">()</span> { yield <span class="hljs-string">'foo'</span>; yield <span class="hljs-string">'bar'</span>; } <span class="hljs-variable">$gen</span> = gen<span class="hljs-params">()</span>; var_dump<span class="hljs-params">(<span class="hljs-variable">$gen</span>-&gt;send<span class="hljs-params">(<span class="hljs-string">'something'</span>)</span>)</span>; // As the send<span class="hljs-params">()</span> happens before the first yield there is an implicit rewind<span class="hljs-params">()</span> call, // so what really happens is this: <span class="hljs-variable">$gen</span>-&gt;rewind<span class="hljs-params">()</span>; var_dump<span class="hljs-params">(<span class="hljs-variable">$gen</span>-&gt;send<span class="hljs-params">(<span class="hljs-string">'something'</span>)</span>)</span>; // The rewind<span class="hljs-params">()</span> will advance to the first yield <span class="hljs-params">(and ignore its value)</span>, the send<span class="hljs-params">()</span> will // advance to the second yield <span class="hljs-params">(and dump its value)</span>. Thus we loose the first yielded value!</span></span></span></span></span></code></pre> 
<p>通过添加 beforeFirstYieldcondition 我们可以确定 first yield 的值 被返回。 <br> 调度器现在不得不比多任务循环要做稍微多点了，然后才运行多任务：</p> 
<pre class="prettyprint"><code class=" hljs php"><span class="hljs-preprocessor">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Scheduler</span> {<!-- --></span>
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$maxTaskId</span> = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$taskMap</span> = []; <span class="hljs-comment">// taskId =&gt; task</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$taskQueue</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">()</span> {<!-- --></span>
        <span class="hljs-variable">$this</span>-&gt;taskQueue = <span class="hljs-keyword">new</span> SplQueue();
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">newTask</span><span class="hljs-params">(Generator <span class="hljs-variable">$coroutine</span>)</span> {<!-- --></span>
        <span class="hljs-variable">$tid</span> = ++<span class="hljs-variable">$this</span>-&gt;maxTaskId;
        <span class="hljs-variable">$task</span> = <span class="hljs-keyword">new</span> Task(<span class="hljs-variable">$tid</span>, <span class="hljs-variable">$coroutine</span>);
        <span class="hljs-variable">$this</span>-&gt;taskMap[<span class="hljs-variable">$tid</span>] = <span class="hljs-variable">$task</span>;
        <span class="hljs-variable">$this</span>-&gt;schedule(<span class="hljs-variable">$task</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$tid</span>;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">schedule</span><span class="hljs-params">(Task <span class="hljs-variable">$task</span>)</span> {<!-- --></span>
        <span class="hljs-variable">$this</span>-&gt;taskQueue-&gt;enqueue(<span class="hljs-variable">$task</span>);
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> {<!-- --></span>
        <span class="hljs-keyword">while</span> (!<span class="hljs-variable">$this</span>-&gt;taskQueue-&gt;isEmpty()) {
            <span class="hljs-variable">$task</span> = <span class="hljs-variable">$this</span>-&gt;taskQueue-&gt;dequeue();
            <span class="hljs-variable">$task</span>-&gt;run();
            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$task</span>-&gt;isFinished()) {
                <span class="hljs-keyword">unset</span>(<span class="hljs-variable">$this</span>-&gt;taskMap[<span class="hljs-variable">$task</span>-&gt;getTaskId()]);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-variable">$this</span>-&gt;schedule(<span class="hljs-variable">$task</span>);
            }
        }
    }
}
<span class="hljs-preprocessor">?&gt;</span></code></pre> 
<p>newTask()方法（使用下一个空闲的任务id）创建一个新任务，然后把这个任务放入任务map数组里。接着它通过把任务放入任务队列里来实现对任务的调度。接着run()方法扫描任务队列，运行任务。如果一个任务结束了，那么它将从队列里删除，否则它将在队列的末尾再次被调度。 <br> 让我们看看下面具有两个简单（并且没有什么意义）任务的调度器：</p> 
<pre class="prettyprint"><code class=" hljs php"><span class="hljs-preprocessor">&lt;?php</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">task1</span><span class="hljs-params">()</span> {<!-- --></span>
    <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">1</span>; <span class="hljs-variable">$i</span> &lt;= <span class="hljs-number">10</span>; ++<span class="hljs-variable">$i</span>) {
        <span class="hljs-keyword">echo</span> <span class="hljs-string">"This is task 1 iteration $i.\n"</span>;
        <span class="hljs-keyword">yield</span>;
    }
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">task2</span><span class="hljs-params">()</span> {<!-- --></span>
    <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">1</span>; <span class="hljs-variable">$i</span> &lt;= <span class="hljs-number">5</span>; ++<span class="hljs-variable">$i</span>) {
        <span class="hljs-keyword">echo</span> <span class="hljs-string">"This is task 2 iteration $i.\n"</span>;
        <span class="hljs-keyword">yield</span>;
    }
}
<span class="hljs-variable">$scheduler</span> = <span class="hljs-keyword">new</span> Scheduler;
<span class="hljs-variable">$scheduler</span>-&gt;newTask(task1());
<span class="hljs-variable">$scheduler</span>-&gt;newTask(task2());
<span class="hljs-variable">$scheduler</span>-&gt;run();</code></pre> 
<p>两个任务都仅仅回显一条信息，然后使用yield把控制回传给调度器。输出结果如下： <br> This is task 1 iteration 1. <br> This is task 2 iteration 1. <br> This is task 1 iteration 2. <br> This is task 2 iteration 2. <br> This is task 1 iteration 3. <br> This is task 2 iteration 3. <br> This is task 1 iteration 4. <br> This is task 2 iteration 4. <br> This is task 1 iteration 5. <br> This is task 2 iteration 5. <br> This is task 1 iteration 6. <br> This is task 1 iteration 7. <br> This is task 1 iteration 8. <br> This is task 1 iteration 9. <br> This is task 1 iteration 10. <br> 输出确实如我们所期望的：对前五个迭代来说，两个任务是交替运行的，接着第二个任务结束后，只有第一个任务继续运行。 <br> 与调度器之间通信 <br> 既然调度器已经运行了，那么我们来看下一项：任务和调度器之间的通信。 <br> 我们将使用进程用来和操作系统会话的同样的方式来通信：系统调用。我们需要系统调用的理由是操作系统与进程相比它处在不同的权限级别上。因此为了执行特权级别的操作（如杀死另一个进程），就不得不以某种方式把控制传回给内核，这样内核就可以执行所说的操作了。再说一遍，这种行为在内部是通过使用中断指令来实现的。过去使用的是通用的int指令，如今使用的是更特殊并且更快速的syscall/sysenter指令。 <br> 我们的任务调度系统将反映这种设计：不是简单地把调度器传递给任务（这样就允许它做它想做的任何事），我们将通过给yield表达式传递信息来与系统调用通信。这儿yield即是中断，也是传递信息给调度器（和从调度器传递出信息）的方法。 <br> 为了说明系统调用，我将对可调用的系统调用做一个小小的封装：</p> 
<pre class="prettyprint"><code class=" hljs php"><span class="hljs-preprocessor">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SystemCall</span> {<!-- --></span>
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$callback</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(callable <span class="hljs-variable">$callback</span>)</span> {<!-- --></span>
        <span class="hljs-variable">$this</span>-&gt;callback = <span class="hljs-variable">$callback</span>;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">(Task <span class="hljs-variable">$task</span>, Scheduler <span class="hljs-variable">$scheduler</span>)</span> {<!-- --></span>
        <span class="hljs-variable">$callback</span> = <span class="hljs-variable">$this</span>-&gt;callback; <span class="hljs-comment">// Can't call it directly in PHP :/</span>
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$callback</span>(<span class="hljs-variable">$task</span>, <span class="hljs-variable">$scheduler</span>);
    }
}</code></pre> 
<p>它将像其他任何可调用那样(使用_invoke)运行，不过它要求调度器把正在调用的任务和自身传递给这个函数。为了解决这个问题我们不得不微微的修改调度器的run方法：</p> 
<pre class="prettyprint"><code class=" hljs php"><span class="hljs-preprocessor">&lt;?php</span>
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> {<!-- --></span>
    <span class="hljs-keyword">while</span> (!<span class="hljs-variable">$this</span>-&gt;taskQueue-&gt;isEmpty()) {
        <span class="hljs-variable">$task</span> = <span class="hljs-variable">$this</span>-&gt;taskQueue-&gt;dequeue();
        <span class="hljs-variable">$retval</span> = <span class="hljs-variable">$task</span>-&gt;run();
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$retval</span> <span class="hljs-keyword">instanceof</span> SystemCall) {
            <span class="hljs-variable">$retval</span>(<span class="hljs-variable">$task</span>, <span class="hljs-variable">$this</span>);
            <span class="hljs-keyword">continue</span>;
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$task</span>-&gt;isFinished()) {
            <span class="hljs-keyword">unset</span>(<span class="hljs-variable">$this</span>-&gt;taskMap[<span class="hljs-variable">$task</span>-&gt;getTaskId()]);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-variable">$this</span>-&gt;schedule(<span class="hljs-variable">$task</span>);
        }
    }
}</code></pre> 
<p>第一个系统调用除了返回任务ID外什么都没有做：</p> 
<pre class="prettyprint"><code class=" hljs php"><span class="hljs-preprocessor">&lt;?php</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getTaskId</span><span class="hljs-params">()</span> {<!-- --></span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SystemCall(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(Task <span class="hljs-variable">$task</span>, Scheduler <span class="hljs-variable">$scheduler</span>)</span> {<!-- --></span>
        <span class="hljs-variable">$task</span>-&gt;setSendValue(<span class="hljs-variable">$task</span>-&gt;getTaskId());
        <span class="hljs-variable">$scheduler</span>-&gt;schedule(<span class="hljs-variable">$task</span>);
    });
}</code></pre> 
<p>这个函数设置任务id为下一次发送的值，并再次调度了这个任务。由于使用了系统调用，所以调度器不能自动调用任务，我们需要手工调度任务（稍后你将明白为什么这么做）。要使用这个新的系统调用的话，我们要重新编写以前的例子：</p> 
<pre class="prettyprint"><code class=" hljs php"><span class="hljs-preprocessor">&lt;?php</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">task</span><span class="hljs-params">(<span class="hljs-variable">$max</span>)</span> {<!-- --></span>
    <span class="hljs-variable">$tid</span> = (<span class="hljs-keyword">yield</span> getTaskId()); <span class="hljs-comment">// &lt;-- here's the syscall!</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">1</span>; <span class="hljs-variable">$i</span> &lt;= <span class="hljs-variable">$max</span>; ++<span class="hljs-variable">$i</span>) {
        <span class="hljs-keyword">echo</span> <span class="hljs-string">"This is task $tid iteration $i.\n"</span>;
        <span class="hljs-keyword">yield</span>;
    }
}
<span class="hljs-variable">$scheduler</span> = <span class="hljs-keyword">new</span> Scheduler;
<span class="hljs-variable">$scheduler</span>-&gt;newTask(task(<span class="hljs-number">10</span>));
<span class="hljs-variable">$scheduler</span>-&gt;newTask(task(<span class="hljs-number">5</span>));
<span class="hljs-variable">$scheduler</span>-&gt;run();</code></pre> 
<p>这段代码将给出与前一个例子相同的输出。注意系统调用同其他任何调用一样正常地运行，不过预先增加了yield。要创建新的任务，然后再杀死它们的话，需要两个以上的系统调用：</p> 
<pre class="prettyprint"><code class=" hljs php"><span class="hljs-preprocessor">&lt;?php</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">newTask</span><span class="hljs-params">(Generator <span class="hljs-variable">$coroutine</span>)</span> {<!-- --></span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SystemCall(
        <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(Task <span class="hljs-variable">$task</span>, Scheduler <span class="hljs-variable">$scheduler</span>)</span> <span class="hljs-title">use</span> <span class="hljs-params">(<span class="hljs-variable">$coroutine</span>)</span> {<!-- --></span>
            <span class="hljs-variable">$task</span>-&gt;setSendValue(<span class="hljs-variable">$scheduler</span>-&gt;newTask(<span class="hljs-variable">$coroutine</span>));
            <span class="hljs-variable">$scheduler</span>-&gt;schedule(<span class="hljs-variable">$task</span>);
        }
    );
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">killTask</span><span class="hljs-params">(<span class="hljs-variable">$tid</span>)</span> {<!-- --></span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SystemCall(
        <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(Task <span class="hljs-variable">$task</span>, Scheduler <span class="hljs-variable">$scheduler</span>)</span> <span class="hljs-title">use</span> <span class="hljs-params">(<span class="hljs-variable">$tid</span>)</span> {<!-- --></span>
            <span class="hljs-variable">$task</span>-&gt;setSendValue(<span class="hljs-variable">$scheduler</span>-&gt;killTask(<span class="hljs-variable">$tid</span>));
            <span class="hljs-variable">$scheduler</span>-&gt;schedule(<span class="hljs-variable">$task</span>);
        }
    );
}</code></pre> 
<p>killTask函数需要在调度器里增加一个方法：</p> 
<pre class="prettyprint"><code class=" hljs php"><span class="hljs-preprocessor">&lt;?php</span>
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">killTask</span><span class="hljs-params">(<span class="hljs-variable">$tid</span>)</span> {<!-- --></span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$this</span>-&gt;taskMap[<span class="hljs-variable">$tid</span>])) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
    }
    <span class="hljs-keyword">unset</span>(<span class="hljs-variable">$this</span>-&gt;taskMap[<span class="hljs-variable">$tid</span>]);
    <span class="hljs-comment">// This is a bit ugly and could be optimized so it does not have to walk the queue,</span>
    <span class="hljs-comment">// but assuming that killing tasks is rather rare I won't bother with it now</span>
    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$this</span>-&gt;taskQueue <span class="hljs-keyword">as</span> <span class="hljs-variable">$i</span> =&gt; <span class="hljs-variable">$task</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$task</span>-&gt;getTaskId() === <span class="hljs-variable">$tid</span>) {
            <span class="hljs-keyword">unset</span>(<span class="hljs-variable">$this</span>-&gt;taskQueue[<span class="hljs-variable">$i</span>]);
            <span class="hljs-keyword">break</span>;
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
}</code></pre> 
<p>用来测试新功能的微脚本：</p> 
<pre class="prettyprint"><code class=" hljs php"><span class="hljs-preprocessor">&lt;?php</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">childTask</span><span class="hljs-params">()</span> {<!-- --></span>
    <span class="hljs-variable">$tid</span> = (<span class="hljs-keyword">yield</span> getTaskId());
    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) {
        <span class="hljs-keyword">echo</span> <span class="hljs-string">"Child task $tid still alive!\n"</span>;
        <span class="hljs-keyword">yield</span>;
    }
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">task</span><span class="hljs-params">()</span> {<!-- --></span>
    <span class="hljs-variable">$tid</span> = (<span class="hljs-keyword">yield</span> getTaskId());
    <span class="hljs-variable">$childTid</span> = (<span class="hljs-keyword">yield</span> newTask(childTask()));
    <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">1</span>; <span class="hljs-variable">$i</span> &lt;= <span class="hljs-number">6</span>; ++<span class="hljs-variable">$i</span>) {
        <span class="hljs-keyword">echo</span> <span class="hljs-string">"Parent task $tid iteration $i.\n"</span>;
        <span class="hljs-keyword">yield</span>;
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$i</span> == <span class="hljs-number">3</span>) <span class="hljs-keyword">yield</span> killTask(<span class="hljs-variable">$childTid</span>);
    }
}
<span class="hljs-variable">$scheduler</span> = <span class="hljs-keyword">new</span> Scheduler;
<span class="hljs-variable">$scheduler</span>-&gt;newTask(task());
<span class="hljs-variable">$scheduler</span>-&gt;run();
<span class="hljs-preprocessor">?&gt;</span></code></pre> 
<p>这段代码将打印以下信息： <br> Parent task 1 iteration 1. <br> Child task 2 still alive! <br> Parent task 1 iteration 2. <br> Child task 2 still alive! <br> Parent task 1 iteration 3. <br> Child task 2 still alive! <br> Parent task 1 iteration 4. <br> Parent task 1 iteration 5. <br> Parent task 1 iteration 6. <br> 经过三次迭代以后子任务将被杀死，因此这就是”Child is still alive”消息结束的时候。可能应当指出的是这不是真正的父子关系。 因为甚至在父任务结束后子任务仍然可以运行。或者子任务可以杀死父任务。可以修改调度器使它具有更层级化的任务结构，不过 在这篇文章里我没有这么做。 <br> 你可以实现许多进程管理调用。例如 wait（它一直等待到任务结束运行时）,exec（它替代当前任务）和fork（它创建一个 当前任务的克隆）。fork非常酷，而且你可以使用PHP的协程真正地实现它，因为它们都支持克隆。 <br> 然而让我们把这些留给有兴趣的读者吧，我们来看下一个议题。 <br> <strong>非阻塞IO</strong> <br> 很明显，我们的任务管理系统的真正很酷的应用是web服务器。它有一个任务是在套接字上侦听是否有新连接，当有新连接要建立的时候 ，它创建一个新任务来处理新连接。 <br> web服务器最难的部分通常是像读数据这样的套接字操作是阻塞的。例如PHP将等待到客户端完成发送为止。对一个WEB服务器来说，这 根本不行；这就意味着服务器在一个时间点上只能处理一个连接。 <br> 解决方案是确保在真正对套接字读写之前该套接字已经“准备就绪”。为了查找哪个套接字已经准备好读或者写了，可以使用 流选择函数。 <br> 首先，让我们添加两个新的 syscall，它们将等待直到指定 socket 准备好：</p> 
<pre class="prettyprint"><code class=" hljs php"><span class="hljs-preprocessor">&lt;?php</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">waitForRead</span><span class="hljs-params">(<span class="hljs-variable">$socket</span>)</span> {<!-- --></span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SystemCall(
        <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(Task <span class="hljs-variable">$task</span>, Scheduler <span class="hljs-variable">$scheduler</span>)</span> <span class="hljs-title">use</span> <span class="hljs-params">(<span class="hljs-variable">$socket</span>)</span> {<!-- --></span>
            <span class="hljs-variable">$scheduler</span>-&gt;waitForRead(<span class="hljs-variable">$socket</span>, <span class="hljs-variable">$task</span>);
        }
    );
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">waitForWrite</span><span class="hljs-params">(<span class="hljs-variable">$socket</span>)</span> {<!-- --></span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SystemCall(
        <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(Task <span class="hljs-variable">$task</span>, Scheduler <span class="hljs-variable">$scheduler</span>)</span> <span class="hljs-title">use</span> <span class="hljs-params">(<span class="hljs-variable">$socket</span>)</span> {<!-- --></span>
            <span class="hljs-variable">$scheduler</span>-&gt;waitForWrite(<span class="hljs-variable">$socket</span>, <span class="hljs-variable">$task</span>);
        }
    );
}</code></pre> 
<p>这些 syscall 只是在调度器中代理其各自的方法：</p> 
<pre class="prettyprint"><code class=" hljs php"><span class="hljs-preprocessor">&lt;?php</span>
<span class="hljs-comment">// resourceID =&gt; [socket, tasks]</span>
<span class="hljs-keyword">protected</span> <span class="hljs-variable">$waitingForRead</span> = [];
<span class="hljs-keyword">protected</span> <span class="hljs-variable">$waitingForWrite</span> = [];
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">waitForRead</span><span class="hljs-params">(<span class="hljs-variable">$socket</span>, Task <span class="hljs-variable">$task</span>)</span> {<!-- --></span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$this</span>-&gt;waitingForRead[(int) <span class="hljs-variable">$socket</span>])) {
        <span class="hljs-variable">$this</span>-&gt;waitingForRead[(int) <span class="hljs-variable">$socket</span>][<span class="hljs-number">1</span>][] = <span class="hljs-variable">$task</span>;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable">$this</span>-&gt;waitingForRead[(int) <span class="hljs-variable">$socket</span>] = [<span class="hljs-variable">$socket</span>, [<span class="hljs-variable">$task</span>]];
    }
}
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">waitForWrite</span><span class="hljs-params">(<span class="hljs-variable">$socket</span>, Task <span class="hljs-variable">$task</span>)</span> {<!-- --></span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$this</span>-&gt;waitingForWrite[(int) <span class="hljs-variable">$socket</span>])) {
        <span class="hljs-variable">$this</span>-&gt;waitingForWrite[(int) <span class="hljs-variable">$socket</span>][<span class="hljs-number">1</span>][] = <span class="hljs-variable">$task</span>;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable">$this</span>-&gt;waitingForWrite[(int) <span class="hljs-variable">$socket</span>] = [<span class="hljs-variable">$socket</span>, [<span class="hljs-variable">$task</span>]];
    }
}</code></pre> 
<p>waitingForRead 及 waitingForWrite 属性是两个承载等待的socket 及等待它们的任务的数组。有趣的部分在于下面的方法，它将检查 socket 是否可用，并重新安排各自任务：</p> 
<pre class="prettyprint"><code class=" hljs php"><span class="hljs-preprocessor">&lt;?php</span>
<span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ioPoll</span><span class="hljs-params">(<span class="hljs-variable">$timeout</span>)</span> {<!-- --></span>
    <span class="hljs-variable">$rSocks</span> = [];
    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$this</span>-&gt;waitingForRead <span class="hljs-keyword">as</span> <span class="hljs-keyword">list</span>(<span class="hljs-variable">$socket</span>)) {
        <span class="hljs-variable">$rSocks</span>[] = <span class="hljs-variable">$socket</span>;
    }
    <span class="hljs-variable">$wSocks</span> = [];
    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$this</span>-&gt;waitingForWrite <span class="hljs-keyword">as</span> <span class="hljs-keyword">list</span>(<span class="hljs-variable">$socket</span>)) {
        <span class="hljs-variable">$wSocks</span>[] = <span class="hljs-variable">$socket</span>;
    }
    <span class="hljs-variable">$eSocks</span> = []; <span class="hljs-comment">// dummy</span>
    <span class="hljs-keyword">if</span> (!stream_select(<span class="hljs-variable">$rSocks</span>, <span class="hljs-variable">$wSocks</span>, <span class="hljs-variable">$eSocks</span>, <span class="hljs-variable">$timeout</span>)) {
        <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$rSocks</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$socket</span>) {
        <span class="hljs-keyword">list</span>(, <span class="hljs-variable">$tasks</span>) = <span class="hljs-variable">$this</span>-&gt;waitingForRead[(int) <span class="hljs-variable">$socket</span>];
        <span class="hljs-keyword">unset</span>(<span class="hljs-variable">$this</span>-&gt;waitingForRead[(int) <span class="hljs-variable">$socket</span>]);
        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$tasks</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$task</span>) {
            <span class="hljs-variable">$this</span>-&gt;schedule(<span class="hljs-variable">$task</span>);
        }
    }
    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$wSocks</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$socket</span>) {
        <span class="hljs-keyword">list</span>(, <span class="hljs-variable">$tasks</span>) = <span class="hljs-variable">$this</span>-&gt;waitingForWrite[(int) <span class="hljs-variable">$socket</span>];
        <span class="hljs-keyword">unset</span>(<span class="hljs-variable">$this</span>-&gt;waitingForWrite[(int) <span class="hljs-variable">$socket</span>]);
        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$tasks</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$task</span>) {
            <span class="hljs-variable">$this</span>-&gt;schedule(<span class="hljs-variable">$task</span>);
        }
    }
}</code></pre> 
<p>stream_select 函数接受承载读取、写入以及待检查的socket的数组（我们无需考虑最后一类）。数组将按引用传递，函数只会保留那些状态改变了的数组元素。我们可以遍历这些数组，并重新安排与之相关的任务。 <br> 为了正常地执行上面的轮询动作，我们将在调度器里增加一个特殊的任务：</p> 
<pre class="prettyprint"><code class=" hljs php"><span class="hljs-preprocessor">&lt;?php</span>
<span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ioPollTask</span><span class="hljs-params">()</span> {<!-- --></span>
    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$this</span>-&gt;taskQueue-&gt;isEmpty()) {
            <span class="hljs-variable">$this</span>-&gt;ioPoll(<span class="hljs-keyword">null</span>);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-variable">$this</span>-&gt;ioPoll(<span class="hljs-number">0</span>);
        }
        <span class="hljs-keyword">yield</span>;
    }
}</code></pre> 
<p>需要在某个地方注册这个任务，例如，你可以在run()方法的开始增加<span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-3-Frame" tabindex="0" style="position: relative;"> 
   
   <span class="math" id="MathJax-Span-1" style="width: 8.857em; display: inline-block;"><span style="display: inline-block; position: relative; width: 7.346em; height: 0px; font-size: 120%;"><span style="position: absolute; clip: rect(1.669em, 1007.29em, 2.815em, -999.997em); top: -2.497em; left: 0em;"><span class="mrow" id="MathJax-Span-2"><span class="mi" id="MathJax-Span-3" style="font-family: STIXGeneral-Italic;">t<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span><span class="mi" id="MathJax-Span-4" style="font-family: STIXGeneral-Italic;">h</span><span class="mi" id="MathJax-Span-5" style="font-family: STIXGeneral-Italic;">i</span><span class="mi" id="MathJax-Span-6" style="font-family: STIXGeneral-Italic;">s</span><span class="mo" id="MathJax-Span-7" style="font-family: STIXGeneral-Regular;">−</span><span class="mo" id="MathJax-Span-8" style="font-family: STIXGeneral-Regular; padding-left: 0.315em;">&gt;</span><span class="mi" id="MathJax-Span-9" style="font-family: STIXGeneral-Italic; padding-left: 0.315em;">n</span><span class="mi" id="MathJax-Span-10" style="font-family: STIXGeneral-Italic;">e</span><span class="mi" id="MathJax-Span-11" style="font-family: STIXGeneral-Italic;">w</span><span class="mi" id="MathJax-Span-12" style="font-family: STIXGeneral-Italic;">T<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.055em;"></span></span><span class="mi" id="MathJax-Span-13" style="font-family: STIXGeneral-Italic;">a</span><span class="mi" id="MathJax-Span-14" style="font-family: STIXGeneral-Italic;">s</span><span class="mi" id="MathJax-Span-15" style="font-family: STIXGeneral-Italic;">k<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span><span class="mo" id="MathJax-Span-16" style="font-family: STIXGeneral-Regular;">(</span></span><span style="display: inline-block; width: 0px; height: 2.503em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.191em;"></span></span> 
  <span class="MJX_Assistive_MathML"> 
    
    
      t 
     
    
      h 
     
    
      i 
     
    
      s 
     
    
      − 
     
    
      &gt; 
     
    
      n 
     
    
      e 
     
    
      w 
     
    
      T 
     
    
      a 
     
    
      s 
     
    
      k 
     
    
      ( 
     
   </span></span><script type="math/tex" id="MathJax-Element-3">this->newTask(</script>this-&gt;ioPollTask())。然后就像其他 任务一样每执行完整任务循环一次就执行轮询操作一次（这么做一定不是最好的方法）。ioPollTask将使用0秒的超时来调用ioPoll， 这意味着stream_select将立即返回（而不是等待）。 <br> 只有任务队列为空时，我们才使用null超时，这意味着它一直等到某个套接口准备就绪。如果我们没有这么做，那么轮询任务将一而再， 再而三的循环运行，直到有新的连接建立。这将导致100%的CPU利用率。相反，让操作系统做这种等待会更有效。 <br> 现在编写服务器就相对容易了：</p> 
<pre class="prettyprint"><code class=" hljs xml"><span class="php"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-params"><span class="hljs-params"><span class="hljs-params"><span class="hljs-params"><span class="hljs-params"><span class="hljs-params"><span class="hljs-params"><span class="hljs-params"><span class="hljs-params"><span class="hljs-params"><span class="hljs-params"><span class="hljs-params">&lt;?php function server<span class="hljs-params">(<span class="hljs-variable">$port</span>)</span> { echo <span class="hljs-string">"Starting server at port $port...\n"</span>; <span class="hljs-variable">$socket</span> = @stream_socket_server<span class="hljs-params">(<span class="hljs-string">"tcp://localhost:$port"</span>, <span class="hljs-variable">$errNo</span>, <span class="hljs-variable">$errStr</span>)</span>; if <span class="hljs-params">(!<span class="hljs-variable">$socket</span>)</span> throw new Exception<span class="hljs-params">(<span class="hljs-variable">$errStr</span>, <span class="hljs-variable">$errNo</span>)</span>; stream_set_blocking<span class="hljs-params">(<span class="hljs-variable">$socket</span>, <span class="hljs-number">0</span>)</span>; while <span class="hljs-params">(true)</span> { yield waitForRead<span class="hljs-params">(<span class="hljs-variable">$socket</span>)</span>; <span class="hljs-variable">$clientSocket</span> = stream_socket_accept<span class="hljs-params">(<span class="hljs-variable">$socket</span>, <span class="hljs-number">0</span>)</span>; yield newTask<span class="hljs-params">(handleClient<span class="hljs-params">(<span class="hljs-variable">$clientSocket</span>)</span>)</span>; } } function handleClient<span class="hljs-params">(<span class="hljs-variable">$socket</span>)</span> { yield waitForRead<span class="hljs-params">(<span class="hljs-variable">$socket</span>)</span>; <span class="hljs-variable">$data</span> = fread<span class="hljs-params">(<span class="hljs-variable">$socket</span>, <span class="hljs-number">8192</span>)</span>; <span class="hljs-variable">$msg</span> = <span class="hljs-string">"Received following request:\n\n$data"</span>; <span class="hljs-variable">$msgLength</span> = strlen<span class="hljs-params">(<span class="hljs-variable">$msg</span>)</span>; <span class="hljs-variable">$response</span> = &lt;&lt;&lt;RES HTTP/<span class="hljs-number">1.1</span> <span class="hljs-number">200</span> OK\r Content-Type: text/plain\r Content-Length: <span class="hljs-variable">$msgLength</span>\r Connection: close\r \r <span class="hljs-variable">$msg</span> RES; yield waitForWrite<span class="hljs-params">(<span class="hljs-variable">$socket</span>)</span>; fwrite<span class="hljs-params">(<span class="hljs-variable">$socket</span>, <span class="hljs-variable">$response</span>)</span>; fclose<span class="hljs-params">(<span class="hljs-variable">$socket</span>)</span>; } <span class="hljs-variable">$scheduler</span> = new Scheduler; <span class="hljs-variable">$scheduler</span>-&gt;newTask<span class="hljs-params">(server<span class="hljs-params">(<span class="hljs-number">8000</span>)</span>)</span>; <span class="hljs-variable">$scheduler</span>-&gt;run<span class="hljs-params">()</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></code></pre> 
<p>;</p> 
<p>这段代码将接收到localhost:8000上的连接，然后仅仅返回发送来的内容作为HTTP响应。要做“实际”的事情的话就爱哪个非常复杂（处理 HTTP请求可能已经超出了这篇文章的范围）。上面的代码片段只是演示了一般性的概念。 <br> 你可以使用类似于ab -n 10000 -c 100 localhost:8000/这样命令来测试服务器。这条命令将向服务器发送10000个请求，并且其中100个请求将同时到达。使用这样的数目，我得到了处于中间的10毫秒的响应时间。不过还有一个问题：有少数几个请求真正处理的很慢（如5秒）， 这就是为什么总吞吐量只有2000请求/秒（如果是10毫秒的响应时间的话，总的吞吐量应该更像是10000请求/秒 <br> 协程堆栈 <br> 如果你试图用我们的调度系统建立更大的系统的话，你将很快遇到问题：我们习惯了把代码分解为更小的函数，然后调用它们。然而， 如果使用了协程的话，就不能这么做了。例如，看下面代码：</p> 
<pre class="prettyprint"><code class=" hljs php"><span class="hljs-preprocessor">&lt;?php</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">echoTimes</span><span class="hljs-params">(<span class="hljs-variable">$msg</span>, <span class="hljs-variable">$max</span>)</span> {<!-- --></span>
    <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">1</span>; <span class="hljs-variable">$i</span> &lt;= <span class="hljs-variable">$max</span>; ++<span class="hljs-variable">$i</span>) {
        <span class="hljs-keyword">echo</span> <span class="hljs-string">"$msg iteration $i\n"</span>;
        <span class="hljs-keyword">yield</span>;
    }
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">task</span><span class="hljs-params">()</span> {<!-- --></span>
    echoTimes(<span class="hljs-string">'foo'</span>, <span class="hljs-number">10</span>); <span class="hljs-comment">// print foo ten times</span>
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"---\n"</span>;
    echoTimes(<span class="hljs-string">'bar'</span>, <span class="hljs-number">5</span>); <span class="hljs-comment">// print bar five times</span>
    <span class="hljs-keyword">yield</span>; <span class="hljs-comment">// force it to be a coroutine</span>
}
<span class="hljs-variable">$scheduler</span> = <span class="hljs-keyword">new</span> Scheduler;
<span class="hljs-variable">$scheduler</span>-&gt;newTask(task());
<span class="hljs-variable">$scheduler</span>-&gt;run();</code></pre> 
<p>这段代码试图把重复循环“输出n次“的代码嵌入到一个独立的协程里，然后从主任务里调用它。然而它无法运行。正如在这篇文章的开始 所提到的，调用生成器（或者协程）将没有真正地做任何事情，它仅仅返回一个对象。这也出现在上面的例子里。echoTimes调用除了放回一个（无用的）协程对象外不做任何事情。 <br> 为了仍然允许这么做，我们需要在这个裸协程上写一个小小的封装。我们将调用它：“协程堆栈”。因为它将管理嵌套的协程调用堆栈。 这将是通过生成协程来调用子协程成为可能： <br> <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-4-Frame" tabindex="0" style="position: relative;"> 
   
   <span class="math" id="MathJax-Span-17" style="width: 14.951em; display: inline-block;"><span style="display: inline-block; position: relative; width: 12.451em; height: 0px; font-size: 120%;"><span style="position: absolute; clip: rect(1.669em, 1012.4em, 2.867em, -999.997em); top: -2.497em; left: 0em;"><span class="mrow" id="MathJax-Span-18"><span class="mi" id="MathJax-Span-19" style="font-family: STIXGeneral-Italic;">r<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span><span class="mi" id="MathJax-Span-20" style="font-family: STIXGeneral-Italic;">e</span><span class="mi" id="MathJax-Span-21" style="font-family: STIXGeneral-Italic;">t<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span><span class="mi" id="MathJax-Span-22" style="font-family: STIXGeneral-Italic;">v</span><span class="mi" id="MathJax-Span-23" style="font-family: STIXGeneral-Italic;">a</span><span class="mi" id="MathJax-Span-24" style="font-family: STIXGeneral-Italic;">l<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span><span class="mo" id="MathJax-Span-25" style="font-family: STIXGeneral-Regular; padding-left: 0.315em;">=</span><span class="mo" id="MathJax-Span-26" style="font-family: STIXGeneral-Regular; padding-left: 0.315em;">(</span><span class="mi" id="MathJax-Span-27" style="font-family: STIXGeneral-Italic;">y</span><span class="mi" id="MathJax-Span-28" style="font-family: STIXGeneral-Italic;">i</span><span class="mi" id="MathJax-Span-29" style="font-family: STIXGeneral-Italic;">e</span><span class="mi" id="MathJax-Span-30" style="font-family: STIXGeneral-Italic;">l<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span><span class="mi" id="MathJax-Span-31" style="font-family: STIXGeneral-Italic;">d<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.055em;"></span></span><span class="mi" id="MathJax-Span-32" style="font-family: STIXGeneral-Italic;">s</span><span class="mi" id="MathJax-Span-33" style="font-family: STIXGeneral-Italic;">o</span><span class="mi" id="MathJax-Span-34" style="font-family: STIXGeneral-Italic;">m</span><span class="mi" id="MathJax-Span-35" style="font-family: STIXGeneral-Italic;">e</span><span class="mi" id="MathJax-Span-36" style="font-family: STIXGeneral-Italic;">C<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span><span class="mi" id="MathJax-Span-37" style="font-family: STIXGeneral-Italic;">o</span><span class="mi" id="MathJax-Span-38" style="font-family: STIXGeneral-Italic;">r<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span><span class="mi" id="MathJax-Span-39" style="font-family: STIXGeneral-Italic;">o</span><span class="mi" id="MathJax-Span-40" style="font-family: STIXGeneral-Italic;">u</span><span class="mi" id="MathJax-Span-41" style="font-family: STIXGeneral-Italic;">t<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span><span class="mi" id="MathJax-Span-42" style="font-family: STIXGeneral-Italic;">i</span><span class="mi" id="MathJax-Span-43" style="font-family: STIXGeneral-Italic;">n</span><span class="mi" id="MathJax-Span-44" style="font-family: STIXGeneral-Italic;">e</span><span class="mo" id="MathJax-Span-45" style="font-family: STIXGeneral-Regular;">(</span></span><span style="display: inline-block; width: 0px; height: 2.503em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;"></span></span> 
  <span class="MJX_Assistive_MathML"> 
    
    
      r 
     
    
      e 
     
    
      t 
     
    
      v 
     
    
      a 
     
    
      l 
     
    
      = 
     
    
      ( 
     
    
      y 
     
    
      i 
     
    
      e 
     
    
      l 
     
    
      d 
     
    
      s 
     
    
      o 
     
    
      m 
     
    
      e 
     
    
      C 
     
    
      o 
     
    
      r 
     
    
      o 
     
    
      u 
     
    
      t 
     
    
      i 
     
    
      n 
     
    
      e 
     
    
      ( 
     
   </span></span><script type="math/tex" id="MathJax-Element-4">retval = (yield someCoroutine(</script>foo, $bar)); <br> 使用yield，子协程也能再次返回值： <br> yield retval(“I’m a return value!”); <br> retval函数除了返回一个值的封装外没有做任何其他事情。这个封装将表示它是一个返回值。</p> 
<pre class="prettyprint"><code class=" hljs php"><span class="hljs-preprocessor">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CoroutineReturnValue</span> {<!-- --></span>
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$value</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(<span class="hljs-variable">$value</span>)</span> {<!-- --></span>
        <span class="hljs-variable">$this</span>-&gt;value = <span class="hljs-variable">$value</span>;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getValue</span><span class="hljs-params">()</span> {<!-- --></span>
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span>-&gt;value;
    }
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">retval</span><span class="hljs-params">(<span class="hljs-variable">$value</span>)</span> {<!-- --></span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> CoroutineReturnValue(<span class="hljs-variable">$value</span>);
}</code></pre> 
<p>为了把协程转变为协程堆栈（它支持子调用），我们将不得不编写另外一个函数（很明显，它是另一个协程）：</p> 
<pre class="prettyprint"><code class=" hljs php"><span class="hljs-preprocessor">&lt;?php</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">stackedCoroutine</span><span class="hljs-params">(Generator <span class="hljs-variable">$gen</span>)</span> {<!-- --></span>
    <span class="hljs-variable">$stack</span> = <span class="hljs-keyword">new</span> SplStack;
    <span class="hljs-keyword">for</span> (;;) {
        <span class="hljs-variable">$value</span> = <span class="hljs-variable">$gen</span>-&gt;current();
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$value</span> <span class="hljs-keyword">instanceof</span> Generator) {
            <span class="hljs-variable">$stack</span>-&gt;push(<span class="hljs-variable">$gen</span>);
            <span class="hljs-variable">$gen</span> = <span class="hljs-variable">$value</span>;
            <span class="hljs-keyword">continue</span>;
        }
        <span class="hljs-variable">$isReturnValue</span> = <span class="hljs-variable">$value</span> <span class="hljs-keyword">instanceof</span> CoroutineReturnValue;
        <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$gen</span>-&gt;valid() || <span class="hljs-variable">$isReturnValue</span>) {
            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$stack</span>-&gt;isEmpty()) {
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-variable">$gen</span> = <span class="hljs-variable">$stack</span>-&gt;pop();
            <span class="hljs-variable">$gen</span>-&gt;send(<span class="hljs-variable">$isReturnValue</span> ? <span class="hljs-variable">$value</span>-&gt;getValue() : <span class="hljs-keyword">NULL</span>);
            <span class="hljs-keyword">continue</span>;
        }
        <span class="hljs-variable">$gen</span>-&gt;send(<span class="hljs-keyword">yield</span> <span class="hljs-variable">$gen</span>-&gt;key() =&gt; <span class="hljs-variable">$value</span>);
    }
}</code></pre> 
<p>这个函数在调用者和当前正在运行的子协程之间扮演着简单代理的角色。在<span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-5-Frame" tabindex="0" style="position: relative;"> 
   
   <span class="math" id="MathJax-Span-46" style="width: 9.221em; display: inline-block;"><span style="display: inline-block; position: relative; width: 7.659em; height: 0px; font-size: 120%;"><span style="position: absolute; clip: rect(1.669em, 1007.66em, 2.867em, -999.997em); top: -2.497em; left: 0em;"><span class="mrow" id="MathJax-Span-47"><span class="mi" id="MathJax-Span-48" style="font-family: STIXGeneral-Italic;">g</span><span class="mi" id="MathJax-Span-49" style="font-family: STIXGeneral-Italic;">e</span><span class="mi" id="MathJax-Span-50" style="font-family: STIXGeneral-Italic;">n</span><span class="mo" id="MathJax-Span-51" style="font-family: STIXGeneral-Regular;">−</span><span class="mo" id="MathJax-Span-52" style="font-family: STIXGeneral-Regular; padding-left: 0.315em;">&gt;</span><span class="mi" id="MathJax-Span-53" style="font-family: STIXGeneral-Italic; padding-left: 0.315em;">s</span><span class="mi" id="MathJax-Span-54" style="font-family: STIXGeneral-Italic;">e</span><span class="mi" id="MathJax-Span-55" style="font-family: STIXGeneral-Italic;">n</span><span class="mi" id="MathJax-Span-56" style="font-family: STIXGeneral-Italic;">d<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.055em;"></span></span><span class="mo" id="MathJax-Span-57" style="font-family: STIXGeneral-Regular;">(</span><span class="mi" id="MathJax-Span-58" style="font-family: STIXGeneral-Italic;">y</span><span class="mi" id="MathJax-Span-59" style="font-family: STIXGeneral-Italic;">i</span><span class="mi" id="MathJax-Span-60" style="font-family: STIXGeneral-Italic;">e</span><span class="mi" id="MathJax-Span-61" style="font-family: STIXGeneral-Italic;">l<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span><span class="mi" id="MathJax-Span-62" style="font-family: STIXGeneral-Italic;">d<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.055em;"></span></span></span><span style="display: inline-block; width: 0px; height: 2.503em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;"></span></span> 
  <span class="MJX_Assistive_MathML"> 
    
    
      g 
     
    
      e 
     
    
      n 
     
    
      − 
     
    
      &gt; 
     
    
      s 
     
    
      e 
     
    
      n 
     
    
      d 
     
    
      ( 
     
    
      y 
     
    
      i 
     
    
      e 
     
    
      l 
     
    
      d 
     
   </span></span><script type="math/tex" id="MathJax-Element-5">gen->send(yield </script>gen-&gt;key()=&gt;<span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-6-Frame" tabindex="0" style="position: relative;"> 
   
   <span class="math" id="MathJax-Span-63" style="width: 38.753em; display: inline-block;"><span style="display: inline-block; position: relative; width: 32.294em; height: 0px; font-size: 120%;"><span style="position: absolute; clip: rect(4.013em, 1032.29em, 8.284em, -999.997em); top: -4.945em; left: 0em;"><span class="mrow" id="MathJax-Span-64"><span style="display: inline-block; position: relative; width: 32.294em; height: 0px;"><span style="position: absolute; clip: rect(3.076em, 1031.98em, 4.378em, -999.997em); top: -4.008em; left: 0em;"><span class="mi" id="MathJax-Span-65" style="font-family: STIXGeneral-Italic;">v</span><span class="mi" id="MathJax-Span-66" style="font-family: STIXGeneral-Italic;">a</span><span class="mi" id="MathJax-Span-67" style="font-family: STIXGeneral-Italic;">l<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span><span class="mi" id="MathJax-Span-68" style="font-family: STIXGeneral-Italic;">u</span><span class="mi" id="MathJax-Span-69" style="font-family: STIXGeneral-Italic;">e</span><span class="mo" id="MathJax-Span-70" style="font-family: STIXGeneral-Regular;">)</span><span class="texatom" id="MathJax-Span-71"><span class="mrow" id="MathJax-Span-72"><span class="mo" id="MathJax-Span-73"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>；</span></span></span></span><span class="texatom" id="MathJax-Span-74"><span class="mrow" id="MathJax-Span-75"><span class="mo" id="MathJax-Span-76"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>这</span></span></span></span><span class="texatom" id="MathJax-Span-77"><span class="mrow" id="MathJax-Span-78"><span class="mo" id="MathJax-Span-79"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>行</span></span></span></span><span class="texatom" id="MathJax-Span-80"><span class="mrow" id="MathJax-Span-81"><span class="mo" id="MathJax-Span-82"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>完</span></span></span></span><span class="texatom" id="MathJax-Span-83"><span class="mrow" id="MathJax-Span-84"><span class="mo" id="MathJax-Span-85"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>成</span></span></span></span><span class="texatom" id="MathJax-Span-86"><span class="mrow" id="MathJax-Span-87"><span class="mo" id="MathJax-Span-88"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>了</span></span></span></span><span class="texatom" id="MathJax-Span-89"><span class="mrow" id="MathJax-Span-90"><span class="mo" id="MathJax-Span-91"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>代</span></span></span></span><span class="texatom" id="MathJax-Span-92"><span class="mrow" id="MathJax-Span-93"><span class="mo" id="MathJax-Span-94"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>理</span></span></span></span><span class="texatom" id="MathJax-Span-95"><span class="mrow" id="MathJax-Span-96"><span class="mo" id="MathJax-Span-97"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>功</span></span></span></span><span class="texatom" id="MathJax-Span-98"><span class="mrow" id="MathJax-Span-99"><span class="mo" id="MathJax-Span-100"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>能</span></span></span></span><span class="texatom" id="MathJax-Span-101"><span class="mrow" id="MathJax-Span-102"><span class="mo" id="MathJax-Span-103"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>。</span></span></span></span><span class="texatom" id="MathJax-Span-104"><span class="mrow" id="MathJax-Span-105"><span class="mo" id="MathJax-Span-106"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>另</span></span></span></span><span class="texatom" id="MathJax-Span-107"><span class="mrow" id="MathJax-Span-108"><span class="mo" id="MathJax-Span-109"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>外</span></span></span></span><span class="texatom" id="MathJax-Span-110"><span class="mrow" id="MathJax-Span-111"><span class="mo" id="MathJax-Span-112"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>它</span></span></span></span><span class="texatom" id="MathJax-Span-113"><span class="mrow" id="MathJax-Span-114"><span class="mo" id="MathJax-Span-115"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>检</span></span></span></span><span class="texatom" id="MathJax-Span-116"><span class="mrow" id="MathJax-Span-117"><span class="mo" id="MathJax-Span-118"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>查</span></span></span></span><span class="texatom" id="MathJax-Span-119"><span class="mrow" id="MathJax-Span-120"><span class="mo" id="MathJax-Span-121"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>返</span></span></span></span><span class="texatom" id="MathJax-Span-122"><span class="mrow" id="MathJax-Span-123"><span class="mo" id="MathJax-Span-124"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>回</span></span></span></span><span class="texatom" id="MathJax-Span-125"><span class="mrow" id="MathJax-Span-126"><span class="mo" id="MathJax-Span-127"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>值</span></span></span></span><span class="texatom" id="MathJax-Span-128"><span class="mrow" id="MathJax-Span-129"><span class="mo" id="MathJax-Span-130"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>是</span></span></span></span><span class="texatom" id="MathJax-Span-131"><span class="mrow" id="MathJax-Span-132"><span class="mo" id="MathJax-Span-133"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>否</span></span></span></span><span class="texatom" id="MathJax-Span-134"><span class="mrow" id="MathJax-Span-135"><span class="mo" id="MathJax-Span-136"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>是</span></span></span></span><span class="texatom" id="MathJax-Span-137"><span class="mrow" id="MathJax-Span-138"><span class="mo" id="MathJax-Span-139"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>生</span></span></span></span><span class="texatom" id="MathJax-Span-140"><span class="mrow" id="MathJax-Span-141"><span class="mo" id="MathJax-Span-142"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>成</span></span></span></span><span class="texatom" id="MathJax-Span-143"><span class="mrow" id="MathJax-Span-144"><span class="mo" id="MathJax-Span-145"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>器</span></span></span></span><span class="texatom" id="MathJax-Span-146"><span class="mrow" id="MathJax-Span-147"><span class="mo" id="MathJax-Span-148"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>，</span></span></span></span><span class="texatom" id="MathJax-Span-149"><span class="mrow" id="MathJax-Span-150"><span class="mo" id="MathJax-Span-151"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>万</span></span></span></span><span class="texatom" id="MathJax-Span-152"><span class="mrow" id="MathJax-Span-153"><span class="mo" id="MathJax-Span-154"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>一</span></span></span></span><span class="texatom" id="MathJax-Span-155"><span class="mrow" id="MathJax-Span-156"><span class="mo" id="MathJax-Span-157"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>是</span></span></span></span><span class="texatom" id="MathJax-Span-158"><span class="mrow" id="MathJax-Span-159"><span class="mo" id="MathJax-Span-160"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>生</span></span></span></span><span class="texatom" id="MathJax-Span-161"><span class="mrow" id="MathJax-Span-162"><span class="mo" id="MathJax-Span-163"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>成</span></span></span></span><span class="texatom" id="MathJax-Span-164"><span class="mrow" id="MathJax-Span-165"><span class="mo" id="MathJax-Span-166"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>器</span></span></span></span><span class="texatom" id="MathJax-Span-167"><span class="mrow" id="MathJax-Span-168"><span class="mo" id="MathJax-Span-169"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>的</span></span></span></span><span class="texatom" id="MathJax-Span-170"><span class="mrow" id="MathJax-Span-171"><span class="mo" id="MathJax-Span-172"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>话</span></span></span></span><span class="texatom" id="MathJax-Span-173"><span class="mrow" id="MathJax-Span-174"><span class="mo" id="MathJax-Span-175"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>，</span></span></span></span><span class="texatom" id="MathJax-Span-176"><span class="mrow" id="MathJax-Span-177"><span class="mo" id="MathJax-Span-178"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>它</span></span></span></span><span class="texatom" id="MathJax-Span-179"><span class="mrow" id="MathJax-Span-180"><span class="mo" id="MathJax-Span-181"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>将</span></span></span></span><span class="texatom" id="MathJax-Span-182"><span class="mrow" id="MathJax-Span-183"><span class="mo" id="MathJax-Span-184"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>开</span></span></span></span><span class="texatom" id="MathJax-Span-185"><span class="mrow" id="MathJax-Span-186"><span class="mo" id="MathJax-Span-187"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>始</span></span></span></span><span class="texatom" id="MathJax-Span-188"><span class="mrow" id="MathJax-Span-189"><span class="mo" id="MathJax-Span-190"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>运</span></span></span></span><span class="texatom" id="MathJax-Span-191"><span class="mrow" id="MathJax-Span-192"><span class="mo" id="MathJax-Span-193"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>行</span></span></span></span><span class="texatom" id="MathJax-Span-194"><span class="mrow" id="MathJax-Span-195"><span class="mo" id="MathJax-Span-196"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>这</span></span></span></span><span class="texatom" id="MathJax-Span-197"><span class="mrow" id="MathJax-Span-198"><span class="mo" id="MathJax-Span-199"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>个</span></span></span></span><span class="texatom" id="MathJax-Span-200"><span class="mrow" id="MathJax-Span-201"><span class="mo" id="MathJax-Span-202"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>生</span></span></span></span><span class="texatom" id="MathJax-Span-203"><span class="mrow" id="MathJax-Span-204"><span class="mo" id="MathJax-Span-205"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>成</span></span></span></span><span class="texatom" id="MathJax-Span-206"><span class="mrow" id="MathJax-Span-207"><span class="mo" id="MathJax-Span-208"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>器</span></span></span></span><span class="texatom" id="MathJax-Span-209"><span class="mrow" id="MathJax-Span-210"><span class="mo" id="MathJax-Span-211"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>，</span></span></span></span><span class="texatom" id="MathJax-Span-212"><span class="mrow" id="MathJax-Span-213"><span class="mo" id="MathJax-Span-214"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>并</span></span></span></span><span class="texatom" id="MathJax-Span-215"><span class="mrow" id="MathJax-Span-216"><span class="mo" id="MathJax-Span-217"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>把</span></span></span></span><span class="texatom" id="MathJax-Span-218"><span class="mrow" id="MathJax-Span-219"><span class="mo" id="MathJax-Span-220"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>前</span></span></span></span><span class="texatom" id="MathJax-Span-221"><span class="mrow" id="MathJax-Span-222"><span class="mo" id="MathJax-Span-223"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>一</span></span></span></span><span class="texatom" id="MathJax-Span-224"><span class="mrow" id="MathJax-Span-225"><span class="mo" id="MathJax-Span-226"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>个</span></span></span></span><span class="texatom" id="MathJax-Span-227"><span class="mrow" id="MathJax-Span-228"><span class="mo" id="MathJax-Span-229"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>协</span></span></span></span><span class="texatom" id="MathJax-Span-230"><span class="mrow" id="MathJax-Span-231"><span class="mo" id="MathJax-Span-232"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>程</span></span></span></span><span class="texatom" id="MathJax-Span-233"><span class="mrow" id="MathJax-Span-234"><span class="mo" id="MathJax-Span-235"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>压</span></span></span></span><span class="texatom" id="MathJax-Span-236"><span class="mrow" id="MathJax-Span-237"><span class="mo" id="MathJax-Span-238"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>入</span></span></span></span><span class="texatom" id="MathJax-Span-239"><span class="mrow" id="MathJax-Span-240"><span class="mo" id="MathJax-Span-241"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>堆</span></span></span></span><span class="texatom" id="MathJax-Span-242"><span class="mrow" id="MathJax-Span-243"><span class="mo" id="MathJax-Span-244"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>栈</span></span></span></span><span class="texatom" id="MathJax-Span-245"><span class="mrow" id="MathJax-Span-246"><span class="mo" id="MathJax-Span-247"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>里</span></span></span></span><span style="display: inline-block; width: 0px; height: 4.013em;"></span></span><span style="position: absolute; clip: rect(3.076em, 1032.29em, 4.378em, -999.997em); top: -2.549em; left: 0em;"><span class="texatom" id="MathJax-Span-248"><span class="mrow" id="MathJax-Span-249"><span class="mo" id="MathJax-Span-250"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>。</span></span></span></span><span class="texatom" id="MathJax-Span-251"><span class="mrow" id="MathJax-Span-252"><span class="mo" id="MathJax-Span-253"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>一</span></span></span></span><span class="texatom" id="MathJax-Span-254"><span class="mrow" id="MathJax-Span-255"><span class="mo" id="MathJax-Span-256"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>旦</span></span></span></span><span class="texatom" id="MathJax-Span-257"><span class="mrow" id="MathJax-Span-258"><span class="mo" id="MathJax-Span-259"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>它</span></span></span></span><span class="texatom" id="MathJax-Span-260"><span class="mrow" id="MathJax-Span-261"><span class="mo" id="MathJax-Span-262"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>获</span></span></span></span><span class="texatom" id="MathJax-Span-263"><span class="mrow" id="MathJax-Span-264"><span class="mo" id="MathJax-Span-265"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>得</span></span></span></span><span class="texatom" id="MathJax-Span-266"><span class="mrow" id="MathJax-Span-267"><span class="mo" id="MathJax-Span-268"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>了</span></span></span></span><span class="mi" id="MathJax-Span-269" style="font-family: STIXGeneral-Italic;">C<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span><span class="mi" id="MathJax-Span-270" style="font-family: STIXGeneral-Italic;">o</span><span class="mi" id="MathJax-Span-271" style="font-family: STIXGeneral-Italic;">r<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span><span class="mi" id="MathJax-Span-272" style="font-family: STIXGeneral-Italic;">o</span><span class="mi" id="MathJax-Span-273" style="font-family: STIXGeneral-Italic;">u</span><span class="mi" id="MathJax-Span-274" style="font-family: STIXGeneral-Italic;">t<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span><span class="mi" id="MathJax-Span-275" style="font-family: STIXGeneral-Italic;">i</span><span class="mi" id="MathJax-Span-276" style="font-family: STIXGeneral-Italic;">n</span><span class="mi" id="MathJax-Span-277" style="font-family: STIXGeneral-Italic;">e</span><span class="mi" id="MathJax-Span-278" style="font-family: STIXGeneral-Italic;">R</span><span class="mi" id="MathJax-Span-279" style="font-family: STIXGeneral-Italic;">e</span><span class="mi" id="MathJax-Span-280" style="font-family: STIXGeneral-Italic;">t<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span><span class="mi" id="MathJax-Span-281" style="font-family: STIXGeneral-Italic;">u</span><span class="mi" id="MathJax-Span-282" style="font-family: STIXGeneral-Italic;">r<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span><span class="mi" id="MathJax-Span-283" style="font-family: STIXGeneral-Italic;">n</span><span class="mi" id="MathJax-Span-284" style="font-family: STIXGeneral-Italic;">V<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.055em;"></span></span><span class="mi" id="MathJax-Span-285" style="font-family: STIXGeneral-Italic;">a</span><span class="mi" id="MathJax-Span-286" style="font-family: STIXGeneral-Italic;">l<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span><span class="mi" id="MathJax-Span-287" style="font-family: STIXGeneral-Italic;">u</span><span class="mi" id="MathJax-Span-288" style="font-family: STIXGeneral-Italic;">e</span><span class="texatom" id="MathJax-Span-289"><span class="mrow" id="MathJax-Span-290"><span class="mo" id="MathJax-Span-291"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>的</span></span></span></span><span class="texatom" id="MathJax-Span-292"><span class="mrow" id="MathJax-Span-293"><span class="mo" id="MathJax-Span-294"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>话</span></span></span></span><span class="texatom" id="MathJax-Span-295"><span class="mrow" id="MathJax-Span-296"><span class="mo" id="MathJax-Span-297"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>，</span></span></span></span><span class="texatom" id="MathJax-Span-298"><span class="mrow" id="MathJax-Span-299"><span class="mo" id="MathJax-Span-300"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>它</span></span></span></span><span class="texatom" id="MathJax-Span-301"><span class="mrow" id="MathJax-Span-302"><span class="mo" id="MathJax-Span-303"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>将</span></span></span></span><span class="texatom" id="MathJax-Span-304"><span class="mrow" id="MathJax-Span-305"><span class="mo" id="MathJax-Span-306"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>再</span></span></span></span><span class="texatom" id="MathJax-Span-307"><span class="mrow" id="MathJax-Span-308"><span class="mo" id="MathJax-Span-309"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>次</span></span></span></span><span class="texatom" id="MathJax-Span-310"><span class="mrow" id="MathJax-Span-311"><span class="mo" id="MathJax-Span-312"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>请</span></span></span></span><span class="texatom" id="MathJax-Span-313"><span class="mrow" id="MathJax-Span-314"><span class="mo" id="MathJax-Span-315"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>求</span></span></span></span><span class="texatom" id="MathJax-Span-316"><span class="mrow" id="MathJax-Span-317"><span class="mo" id="MathJax-Span-318"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>堆</span></span></span></span><span class="texatom" id="MathJax-Span-319"><span class="mrow" id="MathJax-Span-320"><span class="mo" id="MathJax-Span-321"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>栈</span></span></span></span><span class="texatom" id="MathJax-Span-322"><span class="mrow" id="MathJax-Span-323"><span class="mo" id="MathJax-Span-324"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>弹</span></span></span></span><span class="texatom" id="MathJax-Span-325"><span class="mrow" id="MathJax-Span-326"><span class="mo" id="MathJax-Span-327"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>出</span></span></span></span><span class="texatom" id="MathJax-Span-328"><span class="mrow" id="MathJax-Span-329"><span class="mo" id="MathJax-Span-330"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>，</span></span></span></span><span class="texatom" id="MathJax-Span-331"><span class="mrow" id="MathJax-Span-332"><span class="mo" id="MathJax-Span-333"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>然</span></span></span></span><span class="texatom" id="MathJax-Span-334"><span class="mrow" id="MathJax-Span-335"><span class="mo" id="MathJax-Span-336"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>后</span></span></span></span><span class="texatom" id="MathJax-Span-337"><span class="mrow" id="MathJax-Span-338"><span class="mo" id="MathJax-Span-339"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>继</span></span></span></span><span class="texatom" id="MathJax-Span-340"><span class="mrow" id="MathJax-Span-341"><span class="mo" id="MathJax-Span-342"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>续</span></span></span></span><span class="texatom" id="MathJax-Span-343"><span class="mrow" id="MathJax-Span-344"><span class="mo" id="MathJax-Span-345"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>执</span></span></span></span><span class="texatom" id="MathJax-Span-346"><span class="mrow" id="MathJax-Span-347"><span class="mo" id="MathJax-Span-348"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>行</span></span></span></span><span class="texatom" id="MathJax-Span-349"><span class="mrow" id="MathJax-Span-350"><span class="mo" id="MathJax-Span-351"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>前</span></span></span></span><span class="texatom" id="MathJax-Span-352"><span class="mrow" id="MathJax-Span-353"><span class="mo" id="MathJax-Span-354"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>一</span></span></span></span><span class="texatom" id="MathJax-Span-355"><span class="mrow" id="MathJax-Span-356"><span class="mo" id="MathJax-Span-357"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>个</span></span></span></span><span class="texatom" id="MathJax-Span-358"><span class="mrow" id="MathJax-Span-359"><span class="mo" id="MathJax-Span-360"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>协</span></span></span></span><span class="texatom" id="MathJax-Span-361"><span class="mrow" id="MathJax-Span-362"><span class="mo" id="MathJax-Span-363"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>程</span></span></span></span><span class="texatom" id="MathJax-Span-364"><span class="mrow" id="MathJax-Span-365"><span class="mo" id="MathJax-Span-366"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>。</span></span></span></span><span class="texatom" id="MathJax-Span-367"><span class="mrow" id="MathJax-Span-368"><span class="mo" id="MathJax-Span-369"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>为</span></span></span></span><span class="texatom" id="MathJax-Span-370"><span class="mrow" id="MathJax-Span-371"><span class="mo" id="MathJax-Span-372"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>了</span></span></span></span><span class="texatom" id="MathJax-Span-373"><span class="mrow" id="MathJax-Span-374"><span class="mo" id="MathJax-Span-375"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>使</span></span></span></span><span class="texatom" id="MathJax-Span-376"><span class="mrow" id="MathJax-Span-377"><span class="mo" id="MathJax-Span-378"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>协</span></span></span></span><span class="texatom" id="MathJax-Span-379"><span class="mrow" id="MathJax-Span-380"><span class="mo" id="MathJax-Span-381"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>程</span></span></span></span><span class="texatom" id="MathJax-Span-382"><span class="mrow" id="MathJax-Span-383"><span class="mo" id="MathJax-Span-384"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>堆</span></span></span></span><span class="texatom" id="MathJax-Span-385"><span class="mrow" id="MathJax-Span-386"><span class="mo" id="MathJax-Span-387"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>栈</span></span></span></span><span class="texatom" id="MathJax-Span-388"><span class="mrow" id="MathJax-Span-389"><span class="mo" id="MathJax-Span-390"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>在</span></span></span></span><span class="texatom" id="MathJax-Span-391"><span class="mrow" id="MathJax-Span-392"><span class="mo" id="MathJax-Span-393"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>任</span></span></span></span><span class="texatom" id="MathJax-Span-394"><span class="mrow" id="MathJax-Span-395"><span class="mo" id="MathJax-Span-396"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>务</span></span></span></span><span class="texatom" id="MathJax-Span-397"><span class="mrow" id="MathJax-Span-398"><span class="mo" id="MathJax-Span-399"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>里</span></span></span></span><span class="texatom" id="MathJax-Span-400"><span class="mrow" id="MathJax-Span-401"><span class="mo" id="MathJax-Span-402"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>可</span></span></span></span><span class="texatom" id="MathJax-Span-403"><span class="mrow" id="MathJax-Span-404"><span class="mo" id="MathJax-Span-405"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>用</span></span></span></span><span style="display: inline-block; width: 0px; height: 4.013em;"></span></span><span style="position: absolute; clip: rect(3.076em, 1004.01em, 4.378em, -999.997em); top: -1.039em; left: 0em;"><span class="texatom" id="MathJax-Span-406"><span class="mrow" id="MathJax-Span-407"><span class="mo" id="MathJax-Span-408"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>，</span></span></span></span><span class="texatom" id="MathJax-Span-409"><span class="mrow" id="MathJax-Span-410"><span class="mo" id="MathJax-Span-411"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>任</span></span></span></span><span class="texatom" id="MathJax-Span-412"><span class="mrow" id="MathJax-Span-413"><span class="mo" id="MathJax-Span-414"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>务</span></span></span></span><span class="texatom" id="MathJax-Span-415"><span class="mrow" id="MathJax-Span-416"><span class="mo" id="MathJax-Span-417"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>构</span></span></span></span><span class="texatom" id="MathJax-Span-418"><span class="mrow" id="MathJax-Span-419"><span class="mo" id="MathJax-Span-420"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>造</span></span></span></span><span class="texatom" id="MathJax-Span-421"><span class="mrow" id="MathJax-Span-422"><span class="mo" id="MathJax-Span-423"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>器</span></span></span></span><span class="texatom" id="MathJax-Span-424"><span class="mrow" id="MathJax-Span-425"><span class="mo" id="MathJax-Span-426"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>里</span></span></span></span><span class="texatom" id="MathJax-Span-427"><span class="mrow" id="MathJax-Span-428"><span class="mo" id="MathJax-Span-429"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>的</span></span></span></span><span style="display: inline-block; width: 0px; height: 4.013em;"></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.951em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -3.872em; border-left: 0px solid; width: 0px; height: 4.878em;"></span></span> 
  <span class="MJX_Assistive_MathML"> 
    
    
      v 
     
    
      a 
     
    
      l 
     
    
      u 
     
    
      e 
     
    
      ) 
     
     
     
       ； 
      
     
     
     
       这 
      
     
     
     
       行 
      
     
     
     
       完 
      
     
     
     
       成 
      
     
     
     
       了 
      
     
     
     
       代 
      
     
     
     
       理 
      
     
     
     
       功 
      
     
     
     
       能 
      
     
     
     
       。 
      
     
     
     
       另 
      
     
     
     
       外 
      
     
     
     
       它 
      
     
     
     
       检 
      
     
     
     
       查 
      
     
     
     
       返 
      
     
     
     
       回 
      
     
     
     
       值 
      
     
     
     
       是 
      
     
     
     
       否 
      
     
     
     
       是 
      
     
     
     
       生 
      
     
     
     
       成 
      
     
     
     
       器 
      
     
     
     
       ， 
      
     
     
     
       万 
      
     
     
     
       一 
      
     
     
     
       是 
      
     
     
     
       生 
      
     
     
     
       成 
      
     
     
     
       器 
      
     
     
     
       的 
      
     
     
     
       话 
      
     
     
     
       ， 
      
     
     
     
       它 
      
     
     
     
       将 
      
     
     
     
       开 
      
     
     
     
       始 
      
     
     
     
       运 
      
     
     
     
       行 
      
     
     
     
       这 
      
     
     
     
       个 
      
     
     
     
       生 
      
     
     
     
       成 
      
     
     
     
       器 
      
     
     
     
       ， 
      
     
     
     
       并 
      
     
     
     
       把 
      
     
     
     
       前 
      
     
     
     
       一 
      
     
     
     
       个 
      
     
     
     
       协 
      
     
     
     
       程 
      
     
     
     
       压 
      
     
     
     
       入 
      
     
     
     
       堆 
      
     
     
     
       栈 
      
     
     
     
       里 
      
     
     
     
       。 
      
     
     
     
       一 
      
     
     
     
       旦 
      
     
     
     
       它 
      
     
     
     
       获 
      
     
     
     
       得 
      
     
     
     
       了 
      
     
    
      C 
     
    
      o 
     
    
      r 
     
    
      o 
     
    
      u 
     
    
      t 
     
    
      i 
     
    
      n 
     
    
      e 
     
    
      R 
     
    
      e 
     
    
      t 
     
    
      u 
     
    
      r 
     
    
      n 
     
    
      V 
     
    
      a 
     
    
      l 
     
    
      u 
     
    
      e 
     
     
     
       的 
      
     
     
     
       话 
      
     
     
     
       ， 
      
     
     
     
       它 
      
     
     
     
       将 
      
     
     
     
       再 
      
     
     
     
       次 
      
     
     
     
       请 
      
     
     
     
       求 
      
     
     
     
       堆 
      
     
     
     
       栈 
      
     
     
     
       弹 
      
     
     
     
       出 
      
     
     
     
       ， 
      
     
     
     
       然 
      
     
     
     
       后 
      
     
     
     
       继 
      
     
     
     
       续 
      
     
     
     
       执 
      
     
     
     
       行 
      
     
     
     
       前 
      
     
     
     
       一 
      
     
     
     
       个 
      
     
     
     
       协 
      
     
     
     
       程 
      
     
     
     
       。 
      
     
     
     
       为 
      
     
     
     
       了 
      
     
     
     
       使 
      
     
     
     
       协 
      
     
     
     
       程 
      
     
     
     
       堆 
      
     
     
     
       栈 
      
     
     
     
       在 
      
     
     
     
       任 
      
     
     
     
       务 
      
     
     
     
       里 
      
     
     
     
       可 
      
     
     
     
       用 
      
     
     
     
       ， 
      
     
     
     
       任 
      
     
     
     
       务 
      
     
     
     
       构 
      
     
     
     
       造 
      
     
     
     
       器 
      
     
     
     
       里 
      
     
     
     
       的 
      
     
   </span></span><script type="math/tex" id="MathJax-Element-6">value)；这行完成了代理功能。另外它检查返回值是否是生成器，万一是生成器的话，它将开始运行这个生成器，并把前一个协程压入堆栈里。一旦它获得了CoroutineReturnValue的话，它将再次请求堆栈弹出，然后继续执行前一个协程。  
为了使协程堆栈在任务里可用，任务构造器里的</script>this-coroutine =<span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-7-Frame" tabindex="0" style="position: relative;"> 
   
   <span class="math" id="MathJax-Span-430" style="width: 12.138em; display: inline-block;"><span style="display: inline-block; position: relative; width: 10.107em; height: 0px; font-size: 120%;"><span style="position: absolute; clip: rect(1.565em, 1010.11em, 2.867em, -999.997em); top: -2.497em; left: 0em;"><span class="mrow" id="MathJax-Span-431"><span class="mi" id="MathJax-Span-432" style="font-family: STIXGeneral-Italic;">c</span><span class="mi" id="MathJax-Span-433" style="font-family: STIXGeneral-Italic;">o</span><span class="mi" id="MathJax-Span-434" style="font-family: STIXGeneral-Italic;">r<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span><span class="mi" id="MathJax-Span-435" style="font-family: STIXGeneral-Italic;">o</span><span class="mi" id="MathJax-Span-436" style="font-family: STIXGeneral-Italic;">u</span><span class="mi" id="MathJax-Span-437" style="font-family: STIXGeneral-Italic;">t<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span><span class="mi" id="MathJax-Span-438" style="font-family: STIXGeneral-Italic;">i</span><span class="mi" id="MathJax-Span-439" style="font-family: STIXGeneral-Italic;">n</span><span class="mi" id="MathJax-Span-440" style="font-family: STIXGeneral-Italic;">e</span><span class="mo" id="MathJax-Span-441" style="font-family: STIXGeneral-Regular;">;</span><span class="texatom" id="MathJax-Span-442" style="padding-left: 0.211em;"><span class="mrow" id="MathJax-Span-443"><span class="mo" id="MathJax-Span-444"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>这</span></span></span></span><span class="texatom" id="MathJax-Span-445"><span class="mrow" id="MathJax-Span-446"><span class="mo" id="MathJax-Span-447"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>行</span></span></span></span><span class="texatom" id="MathJax-Span-448"><span class="mrow" id="MathJax-Span-449"><span class="mo" id="MathJax-Span-450"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>需</span></span></span></span><span class="texatom" id="MathJax-Span-451"><span class="mrow" id="MathJax-Span-452"><span class="mo" id="MathJax-Span-453"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>要</span></span></span></span><span class="texatom" id="MathJax-Span-454"><span class="mrow" id="MathJax-Span-455"><span class="mo" id="MathJax-Span-456"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>替</span></span></span></span><span class="texatom" id="MathJax-Span-457"><span class="mrow" id="MathJax-Span-458"><span class="mo" id="MathJax-Span-459"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>代</span></span></span></span><span class="texatom" id="MathJax-Span-460"><span class="mrow" id="MathJax-Span-461"><span class="mo" id="MathJax-Span-462"><span style='font-family: STIXGeneral, "Arial Unicode MS", serif; font-size: 83%; font-style: normal; font-weight: normal;'>为</span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.503em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.316em;"></span></span> 
  <span class="MJX_Assistive_MathML"> 
    
    
      c 
     
    
      o 
     
    
      r 
     
    
      o 
     
    
      u 
     
    
      t 
     
    
      i 
     
    
      n 
     
    
      e 
     
    
      ; 
     
     
     
       这 
      
     
     
     
       行 
      
     
     
     
       需 
      
     
     
     
       要 
      
     
     
     
       替 
      
     
     
     
       代 
      
     
     
     
       为 
      
     
   </span></span><script type="math/tex" id="MathJax-Element-7">coroutine;这行需要替代为</script>this-&gt;coroutine = StackedCoroutine($coroutine);。 <br> 现在我们可以稍微改进上面web服务器例子：把wait+read(和wait+write和warit+accept)这样的动作分组为函数。为了分组相关的 功能，我将使用下面类：</p> 
<pre class="prettyprint"><code class=" hljs php"><span class="hljs-preprocessor">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CoSocket</span> {<!-- --></span>
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$socket</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(<span class="hljs-variable">$socket</span>)</span> {<!-- --></span>
        <span class="hljs-variable">$this</span>-&gt;socket = <span class="hljs-variable">$socket</span>;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">accept</span><span class="hljs-params">()</span> {<!-- --></span>
        <span class="hljs-keyword">yield</span> waitForRead(<span class="hljs-variable">$this</span>-&gt;socket);
        <span class="hljs-keyword">yield</span> retval(<span class="hljs-keyword">new</span> CoSocket(stream_socket_accept(<span class="hljs-variable">$this</span>-&gt;socket, <span class="hljs-number">0</span>)));
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read</span><span class="hljs-params">(<span class="hljs-variable">$size</span>)</span> {<!-- --></span>
        <span class="hljs-keyword">yield</span> waitForRead(<span class="hljs-variable">$this</span>-&gt;socket);
        <span class="hljs-keyword">yield</span> retval(fread(<span class="hljs-variable">$this</span>-&gt;socket, <span class="hljs-variable">$size</span>));
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">write</span><span class="hljs-params">(<span class="hljs-variable">$string</span>)</span> {<!-- --></span>
        <span class="hljs-keyword">yield</span> waitForWrite(<span class="hljs-variable">$this</span>-&gt;socket);
        fwrite(<span class="hljs-variable">$this</span>-&gt;socket, <span class="hljs-variable">$string</span>);
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">close</span><span class="hljs-params">()</span> {<!-- --></span>
        @fclose(<span class="hljs-variable">$this</span>-&gt;socket);
    }
}</code></pre> 
<p>现在服务器可以编写的稍微简洁点了：</p> 
<pre class="prettyprint"><code class=" hljs php"><span class="hljs-preprocessor">&lt;?php</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">server</span><span class="hljs-params">(<span class="hljs-variable">$port</span>)</span> {<!-- --></span>
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"Starting server at port $port...\n"</span>;
    <span class="hljs-variable">$socket</span> = @stream_socket_server(<span class="hljs-string">"tcp://localhost:$port"</span>, <span class="hljs-variable">$errNo</span>, <span class="hljs-variable">$errStr</span>);
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$socket</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-keyword">Exception</span>(<span class="hljs-variable">$errStr</span>, <span class="hljs-variable">$errNo</span>);
    stream_set_blocking(<span class="hljs-variable">$socket</span>, <span class="hljs-number">0</span>);
    <span class="hljs-variable">$socket</span> = <span class="hljs-keyword">new</span> CoSocket(<span class="hljs-variable">$socket</span>);
    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) {
        <span class="hljs-keyword">yield</span> newTask(
            handleClient(<span class="hljs-keyword">yield</span> <span class="hljs-variable">$socket</span>-&gt;accept())
        );
    }
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleClient</span><span class="hljs-params">(<span class="hljs-variable">$socket</span>)</span> {<!-- --></span>
    <span class="hljs-variable">$data</span> = (<span class="hljs-keyword">yield</span> <span class="hljs-variable">$socket</span>-&gt;read(<span class="hljs-number">8192</span>));
    <span class="hljs-variable">$msg</span> = <span class="hljs-string">"Received following request:\n\n$data"</span>;
    <span class="hljs-variable">$msgLength</span> = strlen(<span class="hljs-variable">$msg</span>);
    <span class="hljs-variable">$response</span> = <span class="hljs-string">&lt;&lt;&lt;RES
HTTP/1.1 200 OK\r
Content-Type: text/plain\r
Content-Length: $msgLength\r
Connection: close\r
\r
$msg
RES;</span>
    <span class="hljs-keyword">yield</span> <span class="hljs-variable">$socket</span>-&gt;write(<span class="hljs-variable">$response</span>);
    <span class="hljs-keyword">yield</span> <span class="hljs-variable">$socket</span>-&gt;close();
}</code></pre> 
<p>错误处理 <br> 作为一个优秀的程序员，相信你已经察觉到上面的例子缺少错误处理。几乎所有的 socket 都是易出错的。我这样做的原因一方面固然是因为错误处理的乏味（特别是 socket！），另一方面也在于它很容易使代码体积膨胀。 <br> 不过，我仍然了一讲一下常见的协程错误处理：协程允许使用 throw() 方法在其内部抛出一个错误。尽管此方法还未在 PHP 中实现，但我很快就会提交它，就在今天。 <br> throw() 方法接受一个 Exception，并将其抛出到协程的当前悬挂点，看看下面代码：</p> 
<pre class="prettyprint"><code class=" hljs php"><span class="hljs-preprocessor">&lt;?php</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gen</span><span class="hljs-params">()</span> {<!-- --></span>
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"Foo\n"</span>;
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">yield</span>;
    } <span class="hljs-keyword">catch</span> (<span class="hljs-keyword">Exception</span> <span class="hljs-variable">$e</span>) {
        <span class="hljs-keyword">echo</span> <span class="hljs-string">"Exception: {$e-&gt;getMessage()}\n"</span>;
    }
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"Bar\n"</span>;
}
<span class="hljs-variable">$gen</span> = gen();
<span class="hljs-variable">$gen</span>-&gt;rewind();                     <span class="hljs-comment">// echos "Foo"</span>
<span class="hljs-variable">$gen</span>-&gt;<span class="hljs-keyword">throw</span>(<span class="hljs-keyword">new</span> <span class="hljs-keyword">Exception</span>(<span class="hljs-string">'Test'</span>)); <span class="hljs-comment">// echos "Exception: Test"</span>
                                    <span class="hljs-comment">// and "Bar"</span></code></pre> 
<p>这非常棒，因为我们可以使用系统调用以及子协程调用异常抛出。对与系统调用，Scheduler::run() 方法需要一些小调整：</p> 
<pre class="prettyprint"><code class=" hljs php"><span class="hljs-preprocessor">&lt;?php</span>
<span class="hljs-keyword">if</span> (<span class="hljs-variable">$retval</span> <span class="hljs-keyword">instanceof</span> SystemCall) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-variable">$retval</span>(<span class="hljs-variable">$task</span>, <span class="hljs-variable">$this</span>);
    } <span class="hljs-keyword">catch</span> (<span class="hljs-keyword">Exception</span> <span class="hljs-variable">$e</span>) {
        <span class="hljs-variable">$task</span>-&gt;setException(<span class="hljs-variable">$e</span>);
        <span class="hljs-variable">$this</span>-&gt;schedule(<span class="hljs-variable">$task</span>);
    }
    <span class="hljs-keyword">continue</span>;
}</code></pre> 
<p>Task 类也许要添加 throw 调用处理：</p> 
<pre class="prettyprint"><code class=" hljs php"><span class="hljs-preprocessor">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Task</span> {<!-- --></span>
    <span class="hljs-comment">// ...</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$exception</span> = <span class="hljs-keyword">null</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setException</span><span class="hljs-params">(<span class="hljs-variable">$exception</span>)</span> {<!-- --></span>
        <span class="hljs-variable">$this</span>-&gt;<span class="hljs-keyword">exception</span> = <span class="hljs-variable">$exception</span>;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> {<!-- --></span>
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$this</span>-&gt;beforeFirstYield) {
            <span class="hljs-variable">$this</span>-&gt;beforeFirstYield = <span class="hljs-keyword">false</span>;
            <span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span>-&gt;coroutine-&gt;current();
        } <span class="hljs-keyword">elseif</span> (<span class="hljs-variable">$this</span>-&gt;<span class="hljs-keyword">exception</span>) {
            <span class="hljs-variable">$retval</span> = <span class="hljs-variable">$this</span>-&gt;coroutine-&gt;<span class="hljs-keyword">throw</span>(<span class="hljs-variable">$this</span>-&gt;<span class="hljs-keyword">exception</span>);
            <span class="hljs-variable">$this</span>-&gt;<span class="hljs-keyword">exception</span> = <span class="hljs-keyword">null</span>;
            <span class="hljs-keyword">return</span> <span class="hljs-variable">$retval</span>;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-variable">$retval</span> = <span class="hljs-variable">$this</span>-&gt;coroutine-&gt;send(<span class="hljs-variable">$this</span>-&gt;sendValue);
            <span class="hljs-variable">$this</span>-&gt;sendValue = <span class="hljs-keyword">null</span>;
            <span class="hljs-keyword">return</span> <span class="hljs-variable">$retval</span>;
        }
    }
    <span class="hljs-comment">// ...</span>
}</code></pre> 
<p>现在，我们已经可以在系统调用中使用异常抛出了！例如，要调用 killTask，让我们在传递 ID 不可用时抛出一个异常：</p> 
<pre class="prettyprint"><code class=" hljs php"><span class="hljs-preprocessor">&lt;?php</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">killTask</span><span class="hljs-params">(<span class="hljs-variable">$tid</span>)</span> {<!-- --></span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SystemCall(
        <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(Task <span class="hljs-variable">$task</span>, Scheduler <span class="hljs-variable">$scheduler</span>)</span> <span class="hljs-title">use</span> <span class="hljs-params">(<span class="hljs-variable">$tid</span>)</span> {<!-- --></span>
            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$scheduler</span>-&gt;killTask(<span class="hljs-variable">$tid</span>)) {
                <span class="hljs-variable">$scheduler</span>-&gt;schedule(<span class="hljs-variable">$task</span>);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidArgumentException(<span class="hljs-string">'Invalid task ID!'</span>);
            }
        }
    );
}</code></pre> 
<p>试试看：</p> 
<pre class="prettyprint"><code class=" hljs php"><span class="hljs-preprocessor">&lt;?php</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">task</span><span class="hljs-params">()</span> {<!-- --></span>
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">yield</span> killTask(<span class="hljs-number">500</span>);
    } <span class="hljs-keyword">catch</span> (<span class="hljs-keyword">Exception</span> <span class="hljs-variable">$e</span>) {
        <span class="hljs-keyword">echo</span> <span class="hljs-string">'Tried to kill task 500 but failed: '</span>, <span class="hljs-variable">$e</span>-&gt;getMessage(), <span class="hljs-string">"\n"</span>;
    }
}</code></pre> 
<p>这些代码现在尚不能正常运作，因为 stackedCoroutine 函数无法正确处理异常。要修复需要做些调整：</p> 
<pre class="prettyprint"><code class=" hljs php"><span class="hljs-preprocessor">&lt;?php</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">stackedCoroutine</span><span class="hljs-params">(Generator <span class="hljs-variable">$gen</span>)</span> {<!-- --></span>
    <span class="hljs-variable">$stack</span> = <span class="hljs-keyword">new</span> SplStack;
    <span class="hljs-variable">$exception</span> = <span class="hljs-keyword">null</span>;
    <span class="hljs-keyword">for</span> (;;) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$exception</span>) {
                <span class="hljs-variable">$gen</span>-&gt;<span class="hljs-keyword">throw</span>(<span class="hljs-variable">$exception</span>);
                <span class="hljs-variable">$exception</span> = <span class="hljs-keyword">null</span>;
                <span class="hljs-keyword">continue</span>;
            }
            <span class="hljs-variable">$value</span> = <span class="hljs-variable">$gen</span>-&gt;current();
            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$value</span> <span class="hljs-keyword">instanceof</span> Generator) {
                <span class="hljs-variable">$stack</span>-&gt;push(<span class="hljs-variable">$gen</span>);
                <span class="hljs-variable">$gen</span> = <span class="hljs-variable">$value</span>;
                <span class="hljs-keyword">continue</span>;
            }
            <span class="hljs-variable">$isReturnValue</span> = <span class="hljs-variable">$value</span> <span class="hljs-keyword">instanceof</span> CoroutineReturnValue;
            <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$gen</span>-&gt;valid() || <span class="hljs-variable">$isReturnValue</span>) {
                <span class="hljs-keyword">if</span> (<span class="hljs-variable">$stack</span>-&gt;isEmpty()) {
                    <span class="hljs-keyword">return</span>;
                }
                <span class="hljs-variable">$gen</span> = <span class="hljs-variable">$stack</span>-&gt;pop();
                <span class="hljs-variable">$gen</span>-&gt;send(<span class="hljs-variable">$isReturnValue</span> ? <span class="hljs-variable">$value</span>-&gt;getValue() : <span class="hljs-keyword">NULL</span>);
                <span class="hljs-keyword">continue</span>;
            }
            <span class="hljs-keyword">try</span> {
                <span class="hljs-variable">$sendValue</span> = (<span class="hljs-keyword">yield</span> <span class="hljs-variable">$gen</span>-&gt;key() =&gt; <span class="hljs-variable">$value</span>);
            } <span class="hljs-keyword">catch</span> (<span class="hljs-keyword">Exception</span> <span class="hljs-variable">$e</span>) {
                <span class="hljs-variable">$gen</span>-&gt;<span class="hljs-keyword">throw</span>(<span class="hljs-variable">$e</span>);
                <span class="hljs-keyword">continue</span>;
            }
            <span class="hljs-variable">$gen</span>-&gt;send(<span class="hljs-variable">$sendValue</span>);
        } <span class="hljs-keyword">catch</span> (<span class="hljs-keyword">Exception</span> <span class="hljs-variable">$e</span>) {
            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$stack</span>-&gt;isEmpty()) {
                <span class="hljs-keyword">throw</span> <span class="hljs-variable">$e</span>;
            }
            <span class="hljs-variable">$gen</span> = <span class="hljs-variable">$stack</span>-&gt;pop();
            <span class="hljs-variable">$exception</span> = <span class="hljs-variable">$e</span>;
        }
    }
}</code></pre> 
<p><strong>结束语</strong> <br> 在这篇文章里，我使用多任务协作构建了一个任务调度器，其中包括执行“系统调用”，做非阻塞操作和处理错误。所有这些里真正很酷的事情是任务的结果代码看起来完全同步，甚至任务正在执行大量的异步操作的时候也是这样。如果你打算从套接口读取数据的话，你将不需要传递某个回调函数或者注册一个事件侦听器。相反，你只要书写yield $socket-&gt;read()。这儿大部分都是你常常也要编写的，只在它的前面增加yield。 <br> 当我第一次听到所有这一切的时候，我发现这个概念完全令人折服，而且正是这个激励我在PHP中实现了它。同时我发现协程真正令人心慌。在令人敬畏的代码和很大一堆代码之间只有单薄的一行，我认为协程正好处在这一行上。讲讲使用上面所述的方法书写异步代码是否真的有益对我来说很难。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/51bbe89fb952f7acfbcfa91c1a0b0880/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">SDUT 1867 最短路径问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/46a93e642fa31c4fe954ac006a75f086/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【Android自定义view系列】圆形百分比进度条</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>