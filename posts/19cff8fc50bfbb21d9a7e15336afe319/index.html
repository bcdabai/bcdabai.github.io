<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>使用 Java 携手 SpringBoot &#43; PhantomJS &#43; ECharts 在服务端生成图表并存为图片 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="使用 Java 携手 SpringBoot &#43; PhantomJS &#43; ECharts 在服务端生成图表并存为图片" />
<meta property="og:description" content="目录
1、简介
2、PhantomJS 下载安装
3、PhantomJS 测试脚本
4、Echarts 环境配置
脚本使用
5、SpringBoot 调用 PhantomJS
5.1、在 pom.xml 引入 freemarker，用于解析 ftl 模板文件。
5.2、在 templates 目录下 创建 echarts 目录，并放入 EChartsLineOption.ftl 模板文件，可通过 ftl 模板调整参数完成自定义图片。示例为折线图，有需要别的图表类型自行更换 Option 内容即可。
5.3、创建 EchartsUtil 工具类，编写 generateEChartsBase64() 方法，用于生成 base64 编码图片。
5.4、创建 RESTUtil 工具类，用于发送 Http 请求。
5.5、创建 FreemarkerUtil 工具类，用于读取解析 ftl 模板文件。
5.6、创建 Base64Util 工具类，将生成的 bae64 转为 java.io.File 文件
5.7、编写 EChartsService 服务层业务代码，调用工具类生成图片。
1、简介 PhantomJS 是一个不需要浏览器的富客户端
官方介绍：PhantomJS是一个基于 WebKit 的服务器端JavaScript API。它全面支持web而不需浏览器支持，支持各种Web标准：DOM处理，CSS选择器, JSON，Canvas，和SVG。PhantomJS常用于页面自动化，网络监测，网页截屏，以及无界面测试等
通常我们使用PhantomJS作为爬虫工具。传统的爬虫只能单纯地爬取html的代码，对于js渲染的页面，就无法爬取，如Echarts统计图。而PhantomJS正可以解决此类问题。
我们可以这么理解 PhantomJS，PhantomJS是一个无界面、可运行脚本的谷歌浏览器。
2、PhantomJS 下载安装 PhantomJS安装非常简单，直接在官网 http://phantomjs." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/19cff8fc50bfbb21d9a7e15336afe319/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-04T16:05:21+08:00" />
<meta property="article:modified_time" content="2024-01-04T16:05:21+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">使用 Java 携手 SpringBoot &#43; PhantomJS &#43; ECharts 在服务端生成图表并存为图片</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="1%E3%80%81%E7%AE%80%E4%BB%8B-toc" style="margin-left:80px;"><a href="#1%E3%80%81%E7%AE%80%E4%BB%8B" rel="nofollow">1、简介</a></p> 
<p id="%C2%A02%E3%80%81PhantomJS%20%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85-toc" style="margin-left:80px;"><a href="#%C2%A02%E3%80%81PhantomJS%20%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85" rel="nofollow"> 2、PhantomJS 下载安装</a></p> 
<p id="3%E3%80%81PhantomJS%20%E6%B5%8B%E8%AF%95%E8%84%9A%E6%9C%AC-toc" style="margin-left:80px;"><a href="#3%E3%80%81PhantomJS%20%E6%B5%8B%E8%AF%95%E8%84%9A%E6%9C%AC" rel="nofollow">3、PhantomJS 测试脚本</a></p> 
<p id="4%E3%80%81Echarts%20%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE-toc" style="margin-left:80px;"><a href="#4%E3%80%81Echarts%20%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE" rel="nofollow">4、Echarts 环境配置</a></p> 
<p id="h06q-toc" style="margin-left:120px;"><a href="#h06q" rel="nofollow">脚本使用</a></p> 
<p id="5%E3%80%81SpringBoot%20%E8%B0%83%E7%94%A8%20PhantomJS-toc" style="margin-left:80px;"><a href="#5%E3%80%81SpringBoot%20%E8%B0%83%E7%94%A8%20PhantomJS" rel="nofollow">5、SpringBoot 调用 PhantomJS</a></p> 
<p id="5.1%E3%80%81%E5%9C%A8%20pom.xml%20%E5%BC%95%E5%85%A5%20freemarker%EF%BC%8C%E7%94%A8%E4%BA%8E%E8%A7%A3%E6%9E%90%20ftl%20%E6%A8%A1%E6%9D%BF%E6%96%87%E4%BB%B6%E3%80%82-toc" style="margin-left:120px;"><a href="#5.1%E3%80%81%E5%9C%A8%20pom.xml%20%E5%BC%95%E5%85%A5%20freemarker%EF%BC%8C%E7%94%A8%E4%BA%8E%E8%A7%A3%E6%9E%90%20ftl%20%E6%A8%A1%E6%9D%BF%E6%96%87%E4%BB%B6%E3%80%82" rel="nofollow">5.1、在 pom.xml 引入 freemarker，用于解析 ftl 模板文件。</a></p> 
<p id="%C2%A05.2%E3%80%81%E5%9C%A8%20templates%20%E7%9B%AE%E5%BD%95%E4%B8%8B%20%E5%88%9B%E5%BB%BA%20echarts%20%E7%9B%AE%E5%BD%95%EF%BC%8C%E5%B9%B6%E6%94%BE%E5%85%A5%20EChartsLineOption.ftl%20%E6%A8%A1%E6%9D%BF%E6%96%87%E4%BB%B6%EF%BC%8C%E5%8F%AF%E9%80%9A%E8%BF%87%20ftl%20%E6%A8%A1%E6%9D%BF%E8%B0%83%E6%95%B4%E5%8F%82%E6%95%B0%E5%AE%8C%E6%88%90%E8%87%AA%E5%AE%9A%E4%B9%89%E5%9B%BE%E7%89%87%E3%80%82%E7%A4%BA%E4%BE%8B%E4%B8%BA%E6%8A%98%E7%BA%BF%E5%9B%BE%EF%BC%8C%E6%9C%89%E9%9C%80%E8%A6%81%E5%88%AB%E7%9A%84%E5%9B%BE%E8%A1%A8%E7%B1%BB%E5%9E%8B%E8%87%AA%E8%A1%8C%E6%9B%B4%E6%8D%A2%20Option%20%E5%86%85%E5%AE%B9%E5%8D%B3%E5%8F%AF%E3%80%82-toc" style="margin-left:120px;"><a href="#%C2%A05.2%E3%80%81%E5%9C%A8%20templates%20%E7%9B%AE%E5%BD%95%E4%B8%8B%20%E5%88%9B%E5%BB%BA%20echarts%20%E7%9B%AE%E5%BD%95%EF%BC%8C%E5%B9%B6%E6%94%BE%E5%85%A5%20EChartsLineOption.ftl%20%E6%A8%A1%E6%9D%BF%E6%96%87%E4%BB%B6%EF%BC%8C%E5%8F%AF%E9%80%9A%E8%BF%87%20ftl%20%E6%A8%A1%E6%9D%BF%E8%B0%83%E6%95%B4%E5%8F%82%E6%95%B0%E5%AE%8C%E6%88%90%E8%87%AA%E5%AE%9A%E4%B9%89%E5%9B%BE%E7%89%87%E3%80%82%E7%A4%BA%E4%BE%8B%E4%B8%BA%E6%8A%98%E7%BA%BF%E5%9B%BE%EF%BC%8C%E6%9C%89%E9%9C%80%E8%A6%81%E5%88%AB%E7%9A%84%E5%9B%BE%E8%A1%A8%E7%B1%BB%E5%9E%8B%E8%87%AA%E8%A1%8C%E6%9B%B4%E6%8D%A2%20Option%20%E5%86%85%E5%AE%B9%E5%8D%B3%E5%8F%AF%E3%80%82" rel="nofollow"> 5.2、在 templates 目录下 创建 echarts 目录，并放入 EChartsLineOption.ftl 模板文件，可通过 ftl 模板调整参数完成自定义图片。示例为折线图，有需要别的图表类型自行更换 Option 内容即可。</a></p> 
<p id="%C2%A05.3%E3%80%81%E5%88%9B%E5%BB%BA%20EchartsUtil%20%E5%B7%A5%E5%85%B7%E7%B1%BB%EF%BC%8C%E7%BC%96%E5%86%99%20generateEChartsBase64()%20%E6%96%B9%E6%B3%95%EF%BC%8C%E7%94%A8%E4%BA%8E%E7%94%9F%E6%88%90%20base64%20%E7%BC%96%E7%A0%81%E5%9B%BE%E7%89%87%E3%80%82-toc" style="margin-left:120px;"><a href="#%C2%A05.3%E3%80%81%E5%88%9B%E5%BB%BA%20EchartsUtil%20%E5%B7%A5%E5%85%B7%E7%B1%BB%EF%BC%8C%E7%BC%96%E5%86%99%20generateEChartsBase64%28%29%20%E6%96%B9%E6%B3%95%EF%BC%8C%E7%94%A8%E4%BA%8E%E7%94%9F%E6%88%90%20base64%20%E7%BC%96%E7%A0%81%E5%9B%BE%E7%89%87%E3%80%82" rel="nofollow"> 5.3、创建 EchartsUtil 工具类，编写 generateEChartsBase64() 方法，用于生成 base64 编码图片。</a></p> 
<p id="5.4%E3%80%81%E5%88%9B%E5%BB%BA%20RESTUtil%20%E5%B7%A5%E5%85%B7%E7%B1%BB%EF%BC%8C%E7%94%A8%E4%BA%8E%E5%8F%91%E9%80%81%20Http%20%E8%AF%B7%E6%B1%82%E3%80%82-toc" style="margin-left:120px;"><a href="#5.4%E3%80%81%E5%88%9B%E5%BB%BA%20RESTUtil%20%E5%B7%A5%E5%85%B7%E7%B1%BB%EF%BC%8C%E7%94%A8%E4%BA%8E%E5%8F%91%E9%80%81%20Http%20%E8%AF%B7%E6%B1%82%E3%80%82" rel="nofollow">5.4、创建 RESTUtil 工具类，用于发送 Http 请求。</a></p> 
<p id="%C2%A05.5%E3%80%81%E5%88%9B%E5%BB%BA%20FreemarkerUtil%20%E5%B7%A5%E5%85%B7%E7%B1%BB%EF%BC%8C%E7%94%A8%E4%BA%8E%E8%AF%BB%E5%8F%96%E8%A7%A3%E6%9E%90%20ftl%20%E6%A8%A1%E6%9D%BF%E6%96%87%E4%BB%B6%E3%80%82-toc" style="margin-left:120px;"><a href="#%C2%A05.5%E3%80%81%E5%88%9B%E5%BB%BA%20FreemarkerUtil%20%E5%B7%A5%E5%85%B7%E7%B1%BB%EF%BC%8C%E7%94%A8%E4%BA%8E%E8%AF%BB%E5%8F%96%E8%A7%A3%E6%9E%90%20ftl%20%E6%A8%A1%E6%9D%BF%E6%96%87%E4%BB%B6%E3%80%82" rel="nofollow"> 5.5、创建 FreemarkerUtil 工具类，用于读取解析 ftl 模板文件。</a></p> 
<p id="5.6%E3%80%81%E5%88%9B%E5%BB%BA%20Base64Util%20%E5%B7%A5%E5%85%B7%E7%B1%BB%EF%BC%8C%E5%B0%86%E7%94%9F%E6%88%90%E7%9A%84%20bae64%20%E8%BD%AC%E4%B8%BA%20java.io.File%20%E6%96%87%E4%BB%B6-toc" style="margin-left:120px;"><a href="#5.6%E3%80%81%E5%88%9B%E5%BB%BA%20Base64Util%20%E5%B7%A5%E5%85%B7%E7%B1%BB%EF%BC%8C%E5%B0%86%E7%94%9F%E6%88%90%E7%9A%84%20bae64%20%E8%BD%AC%E4%B8%BA%20java.io.File%20%E6%96%87%E4%BB%B6" rel="nofollow">5.6、创建 Base64Util 工具类，将生成的 bae64 转为 java.io.File 文件</a></p> 
<p id="%C2%A05.7%E3%80%81%E7%BC%96%E5%86%99%20EChartsService%20%E6%9C%8D%E5%8A%A1%E5%B1%82%E4%B8%9A%E5%8A%A1%E4%BB%A3%E7%A0%81%EF%BC%8C%E8%B0%83%E7%94%A8%E5%B7%A5%E5%85%B7%E7%B1%BB%E7%94%9F%E6%88%90%E5%9B%BE%E7%89%87%E3%80%82-toc" style="margin-left:120px;"><a href="#%C2%A05.7%E3%80%81%E7%BC%96%E5%86%99%20EChartsService%20%E6%9C%8D%E5%8A%A1%E5%B1%82%E4%B8%9A%E5%8A%A1%E4%BB%A3%E7%A0%81%EF%BC%8C%E8%B0%83%E7%94%A8%E5%B7%A5%E5%85%B7%E7%B1%BB%E7%94%9F%E6%88%90%E5%9B%BE%E7%89%87%E3%80%82" rel="nofollow"> 5.7、编写 EChartsService 服务层业务代码，调用工具类生成图片。</a></p> 
<hr id="hr-toc"> 
<p></p> 
<h4 id="1%E3%80%81%E7%AE%80%E4%BB%8B">1、简介</h4> 
<blockquote> 
 <p><strong>PhantomJS </strong>是一个不需要浏览器的富客户端</p> 
 <p>        官方介绍：PhantomJS是一个基于 WebKit 的<a href="https://cloud.tencent.com/act/pro/promotion-cvm?from_column=20065&amp;from=20065" rel="nofollow" title="服务器">服务器</a>端JavaScript API。它全面支持web而不需浏览器支持，支持各种Web标准：DOM处理，CSS选择器, JSON，Canvas，和SVG。PhantomJS常用于页面自动化，网络监测，网页截屏，以及无界面测试等</p> 
 <p>        通常我们使用PhantomJS作为爬虫工具。传统的爬虫只能单纯地爬取html的代码，对于js渲染的页面，就无法爬取，如Echarts统计图。而PhantomJS正可以解决此类问题。</p> 
 <p>        我们可以这么理解 PhantomJS，PhantomJS是一个无界面、可运行脚本的谷歌浏览器。</p> 
</blockquote> 
<h4 id="%C2%A02%E3%80%81PhantomJS%20%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85"> 2、<strong>PhantomJS 下载安装</strong></h4> 
<p>        PhantomJS安装非常简单，直接在官网 http://phantomjs.org/download.html 下载最新的安装包， 安装包有Windows，Mac OS X, Linux 64/32 bit，选择对应的版本下载解压即可使用，在下载包里有个example文件夹，里面对应了许多示例供参考。</p> 
<p>        将下载后解压的文件夹放在 <strong>D:\Program Files\PhantomJS</strong>，为方便使用，我们将 PhantomJS 添加至环境变量中，并将下载到的安装包放在对应的目录下。</p> 
<pre><code class="language-java">Windows：
右键我的电脑
-&gt;属性
-&gt;高级系统设置
-&gt;高级
-&gt;环境变量
-&gt;用户变量/系统变量
-&gt; 在 Path 添加 D:\Program Files\PhantomJS\bin\

Linux:
vi /etc/profile
export PATH=$PATH:/usr/local/phantomjs/bin</code></pre> 
<p><img alt="" height="597" src="https://images2.imgbox.com/7c/82/AHzjfVvD_o.png" width="1080"></p> 
<h4 id="3%E3%80%81PhantomJS%20%E6%B5%8B%E8%AF%95%E8%84%9A%E6%9C%AC">3、<strong>PhantomJS 测试脚本</strong></h4> 
<p>打开 CMD，进入 example 目录，运行命令 phantomjs hello.js, 输出 “Hello World” 则代表配置成功。</p> 
<p><img alt="" height="509" src="https://images2.imgbox.com/ef/02/jobcFJTU_o.png" width="974"></p> 
<h4 id="4%E3%80%81Echarts%20%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE">4、<strong>Echarts 环境配置</strong></h4> 
<p>生成图片的核心脚本在于 <strong>echarts-convert.js</strong> ，同时结合 <strong>echarts.min.js、jquery.min.js、china.js </strong>三个脚本来生成图片。</p> 
<p>由于 js 源码内容过长，我已将 js 脚本及其项目源码放在 <strong>GitHub、Gitee、Coding</strong> 等代码开源平台，<strong>文末附带源码链接</strong>，有需要的可自行下载。</p> 
<p>将脚本下载完后，放在 <strong>D:\Program Files\echartsconvert</strong>，以便于 <strong>PhantomJS </strong>调用脚本生成图片。</p> 
<p><img alt="" height="604" src="https://images2.imgbox.com/f5/f7/zO7Nau6t_o.png" width="1080"></p> 
<h5 id="h06q"><strong>脚本使用</strong></h5> 
<p>在 `<strong>echarts-convert.js</strong>` 同级目录下，运行命令 ` <strong>phantomjs echarts-convert.js -s </strong>`，如果控制台出现"<strong>echarts-convert server start success. [pid]=xxxx</strong>"则表示启动成功，默认端口 <span style="color:#fe2c24;"><strong>9090</strong></span>，关闭 CMD 则关闭脚本程序。</p> 
<p>Linux的脚本启动样例：</p> 
<pre><code class="language-bash">nohup phantomjs echarts-convert.js -s &gt;&gt; /opt/software/phantomjs/log/output.log 2&gt;&amp;1 &amp;</code></pre> 
<p><img alt="" height="509" src="https://images2.imgbox.com/59/3a/rbgALKN2_o.png" width="974"></p> 
<h4 id="5%E3%80%81SpringBoot%20%E8%B0%83%E7%94%A8%20PhantomJS">5、<strong>SpringBoot 调用 PhantomJS</strong></h4> 
<p><img alt="" height="584" src="https://images2.imgbox.com/d8/de/Lo8CtS4H_o.png" width="1080"></p> 
<h5 id="5.1%E3%80%81%E5%9C%A8%20pom.xml%20%E5%BC%95%E5%85%A5%20freemarker%EF%BC%8C%E7%94%A8%E4%BA%8E%E8%A7%A3%E6%9E%90%20ftl%20%E6%A8%A1%E6%9D%BF%E6%96%87%E4%BB%B6%E3%80%82">5.1、在 pom.xml 引入 freemarker，用于解析 ftl 模板文件。</h5> 
<pre><code class="language-XML">&lt;!-- 解析ftl模板文件 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.freemarker&lt;/groupId&gt;
    &lt;artifactId&gt;freemarker&lt;/artifactId&gt;
    &lt;version&gt;2.3.31&lt;/version&gt;
&lt;/dependency&gt;</code></pre> 
<h5 id="%C2%A05.2%E3%80%81%E5%9C%A8%20templates%20%E7%9B%AE%E5%BD%95%E4%B8%8B%20%E5%88%9B%E5%BB%BA%20echarts%20%E7%9B%AE%E5%BD%95%EF%BC%8C%E5%B9%B6%E6%94%BE%E5%85%A5%20EChartsLineOption.ftl%20%E6%A8%A1%E6%9D%BF%E6%96%87%E4%BB%B6%EF%BC%8C%E5%8F%AF%E9%80%9A%E8%BF%87%20ftl%20%E6%A8%A1%E6%9D%BF%E8%B0%83%E6%95%B4%E5%8F%82%E6%95%B0%E5%AE%8C%E6%88%90%E8%87%AA%E5%AE%9A%E4%B9%89%E5%9B%BE%E7%89%87%E3%80%82%E7%A4%BA%E4%BE%8B%E4%B8%BA%E6%8A%98%E7%BA%BF%E5%9B%BE%EF%BC%8C%E6%9C%89%E9%9C%80%E8%A6%81%E5%88%AB%E7%9A%84%E5%9B%BE%E8%A1%A8%E7%B1%BB%E5%9E%8B%E8%87%AA%E8%A1%8C%E6%9B%B4%E6%8D%A2%20Option%20%E5%86%85%E5%AE%B9%E5%8D%B3%E5%8F%AF%E3%80%82"> 5.2、在 <strong>templates </strong>目录下 创建 <strong>echarts </strong>目录，并放入 <strong>EChartsLineOption.ftl</strong> 模板文件，可通过 <strong>ftl </strong>模板调整参数完成自定义图片。示例为折线图，有需要别的图表类型自行更换 <strong>Option </strong>内容即可。</h5> 
<pre><code class="language-XML">{
backgroundColor: '#000000',
color: ['#FEE108', '#9e9e9e'],
title: {
text: '${title}',
left: 25,
top: 10,
textStyle: {
color: '#FFFFFF',
fontSize: 14,
fontWeight: 'normal'
}
},
grid: {
top: '60px',
left: '60px',
right: '80px',
bottom: '80px'
},
xAxis: {
type: 'category',
axisLine: {
onZero: false,
lineStyle: {
color: '#FFFFFF'
}
},
splitLine: {
show: false
},
axisTick: {
inside: true
},
axisLabel: {
color: '#FFFFFF'
},
data: ${categories}
},
yAxis: {
type: 'value',
position: 'right',
splitLine: {
show: false
},
axisLine: {
lineStyle: {
color: '#FFFFFF'
}
},
axisLabel: {
color: '#FFFFFF',
formatter:function (value, index) {
return value.toFixed(0);
}
},
min: function (value, index) {
return value.min - 1;
},
max: function (value, index) {
return value.max + 1;
}
},
series: [
{
type: 'line',
symbol: 'none',
data: ${values},
},{
type: 'line',
markLine: {
symbol: ['none', 'none'],
label: {
show: false,
fontSize: 0
},
data: [{
yAxis: 0,
lineStyle: {
color: '#9e9e9e'
}
}]
}
}],
graphic: [{
type: 'text',
right: '48',
top: '10',
style: {
fill: '#FFFFFF',
text: '雪雨天气',
font: '14px sans-serif',
}
},{
type: 'text',
right: '70',
bottom: '80',
style: {
fill: '#333333',
text: '天气为王',
font: '48px sans-serif',
}
}]
}</code></pre> 
<h5 id="%C2%A05.3%E3%80%81%E5%88%9B%E5%BB%BA%20EchartsUtil%20%E5%B7%A5%E5%85%B7%E7%B1%BB%EF%BC%8C%E7%BC%96%E5%86%99%20generateEChartsBase64()%20%E6%96%B9%E6%B3%95%EF%BC%8C%E7%94%A8%E4%BA%8E%E7%94%9F%E6%88%90%20base64%20%E7%BC%96%E7%A0%81%E5%9B%BE%E7%89%87%E3%80%82"> 5.3、创建 <strong>EchartsUtil </strong>工具类，编写 <strong>generateEChartsBase64()</strong> 方法，用于生成 <strong>base64 </strong>编码图片。</h5> 
<pre><code class="language-java">package louis.echarts.util;

import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.JSONObject;
import lombok.extern.slf4j.Slf4j;
import org.springframework.util.StringUtils;

/**
* @Description ECharts 工具类
* @Author Louis
* @Date 2022/07/10 16:36
*/
@Slf4j
public final class EChartsUtil {

    private static final String SUCCESS_CODE = "1";

    /**
    * @Description 生成ECharts图片的Base64编码
    * @Param [option]
    * @Return java.lang.String
    * @Author Louis
    * @Date 2022/07/10 16:40
    */
    public static String generateEChartsBase64(String phantomjsUrl, String option) {
        // 手动拼接option示例
        // String option = "{title:{text:'ECharts 示例'},tooltip:{},legend:{data:['销量']},xAxis:{data:['衬衫','羊毛衫','雪纺衫','裤子','高跟鞋','袜子']},yAxis:{},series:[{name:'销量',type:'bar',data:[5,20,36,10,10,20]}]}";
        if (!StringUtils.hasText(option)) {
            return null;
        }
        // 替换掉换行符，将双引号替换为单引号
        option = option.replaceAll("\\r\\n", "").replaceAll("\"", "'");
        // 将option字符串作为参数发送给echartsConvert服务器
        String result = RESTUtil.sendPostRequest(phantomjsUrl, "opt=" + option);
        // 解析echartsConvert响应
        JSONObject response = JSON.parseObject(result);
        // 如果echartsConvert正常返回
        if (SUCCESS_CODE.equals(response.getString("code"))) {
            return response.getString("data");
        } else {
            // 未正常返回
            log.error("ECharts Convert 服务器异常：{}", response);
        }
        return null;
    }

}</code></pre> 
<h5 id="5.4%E3%80%81%E5%88%9B%E5%BB%BA%20RESTUtil%20%E5%B7%A5%E5%85%B7%E7%B1%BB%EF%BC%8C%E7%94%A8%E4%BA%8E%E5%8F%91%E9%80%81%20Http%20%E8%AF%B7%E6%B1%82%E3%80%82">5.4、创建 <strong>RESTUtil </strong>工具类，用于发送 <strong>Http </strong>请求。</h5> 
<pre><code class="language-java">package louis.echarts.util;

import cn.hutool.http.HttpUtil;

/**
 * @ClassName RESTUtil
 * @Description 发送REST请求工具类
 * @Author Louis
 * @Date 2022/7/10 16:14
 */
public final class RESTUtil {

    public static String sendPostRequest(String url, String params) {
        return HttpUtil.createPost(url).body(params).execute().body();
    }

}</code></pre> 
<h5 id="%C2%A05.5%E3%80%81%E5%88%9B%E5%BB%BA%20FreemarkerUtil%20%E5%B7%A5%E5%85%B7%E7%B1%BB%EF%BC%8C%E7%94%A8%E4%BA%8E%E8%AF%BB%E5%8F%96%E8%A7%A3%E6%9E%90%20ftl%20%E6%A8%A1%E6%9D%BF%E6%96%87%E4%BB%B6%E3%80%82"> 5.5、创建 <strong>FreemarkerUtil </strong>工具类，用于读取解析 <strong>ftl </strong>模板文件。</h5> 
<pre><code class="language-java">package bots.util;

import freemarker.template.Configuration;
import freemarker.template.Template;
import lombok.extern.slf4j.Slf4j;

import java.io.*;
import java.util.Map;

/**
* @Description Freemarker 工具类
* @Author Louis
* @Date 2022/07/10 17:16
*/
@Slf4j
public final class FreemarkerUtil {

    // 类加载器，用于获取项目目录
    private static final ClassLoader CLASS_LOADER = FreemarkerUtil.class.getClassLoader();
    // 模板存放的目录
    private static final String BASE_PATH = "templates/echarts";

    /**
    * @Description 加载模板并生成ECharts的option数据字符串
    * @Param [templateFileName, data]
    * @Return java.lang.String
    * @Author Louis
    * @Date 2022/07/10 17:16
    */
    public static String generate(String templateFileName, Map&lt;String, Object&gt; data) {
        Configuration configuration = new Configuration(Configuration.VERSION_2_3_31);
        // 设置默认编码
        configuration.setDefaultEncoding("UTF-8");
        // 将 data 写入模板并返回
        try {
            StringWriter writer = new StringWriter();
            // 设置模板所在目录，设置目录打成jar包后无法读取，所以使用类加载器
            // configuration.setDirectoryForTemplateLoading(new File(BASE_PATH));
            configuration.setClassLoaderForTemplateLoading(CLASS_LOADER, BASE_PATH);
            // 生成模板对象
            Template template = configuration.getTemplate(templateFileName);
            template.process(data, writer);
            writer.flush();
            return writer.getBuffer().toString();
        } catch (Exception e) {
            log.error("解析模板异常：{}", e);
        }
        return null;
    }

}</code></pre> 
<h5 id="5.6%E3%80%81%E5%88%9B%E5%BB%BA%20Base64Util%20%E5%B7%A5%E5%85%B7%E7%B1%BB%EF%BC%8C%E5%B0%86%E7%94%9F%E6%88%90%E7%9A%84%20bae64%20%E8%BD%AC%E4%B8%BA%20java.io.File%20%E6%96%87%E4%BB%B6">5.6、创建 <strong>Base64Util </strong>工具类，将生成的 <strong>bae64 </strong>转为<strong> java.io.File </strong>文件</h5> 
<pre><code class="language-java">package louis.echarts.util;

import lombok.extern.slf4j.Slf4j;

import java.io.File;
import java.io.FileOutputStream;
import java.io.OutputStream;
import java.util.Base64;

/**
* @Description Base64 工具类
* @Author Louis
* @Date 2022/07/10 17:24
*/
@Slf4j
public final class Base64Util {

    /**
    * @Description 将Base64字符串转为文件对象
    * @Param [base64]
    * @Return java.io.File
    * @Author Louis
    * @Date 2022/07/10 17:25
    */
    public static File base64ToFile(String base64) {
        try {
            // Base64解码
            byte[] b = Base64.getDecoder().decode(base64);
            for(int i = 0; i &lt; b.length; ++i ){
                if(b[i] &lt; 0){
                    //调整异常数据
                    b[i] += 256;
                }
            }
            // 对文件重命名，设定为当前系统时间的毫秒数加UUID
            String newFileName = System.currentTimeMillis() + "-" + CommonUtil.randomUUID() + ".png";
            // 放在本地临时文件目录
            String localFilePath = String.format("%stemp%s%s%s%s%s%s", File.separator, File.separator, DateUtil.currentYear(), File.separator, DateUtil.currentMonth(), File.separator, DateUtil.currentDay());
            File filePath = new File(localFilePath);
            if (!filePath.exists()) {
                //　mkdirs(): 创建多层目录
                filePath.mkdirs();
            }
            // 文件全限定名
            String path = localFilePath + File.separator + newFileName;
            // 将数据通过流写入文件
            OutputStream out = new FileOutputStream(path);
            out.write(b);
            out.flush();
            out.close();
            return new File(path);
        } catch (Exception e) {
            log.error(e.toString());
        }
        return null;
    }

}</code></pre> 
<h5 id="%C2%A05.7%E3%80%81%E7%BC%96%E5%86%99%20EChartsService%20%E6%9C%8D%E5%8A%A1%E5%B1%82%E4%B8%9A%E5%8A%A1%E4%BB%A3%E7%A0%81%EF%BC%8C%E8%B0%83%E7%94%A8%E5%B7%A5%E5%85%B7%E7%B1%BB%E7%94%9F%E6%88%90%E5%9B%BE%E7%89%87%E3%80%82"> 5.7、编写 <strong>EChartsService </strong>服务层业务代码，调用工具类生成图片。</h5> 
<pre><code class="language-java">package louis.echarts.service;

import com.alibaba.fastjson.JSON;
import lombok.extern.slf4j.Slf4j;
import louis.echarts.util.Base64Util;
import louis.echarts.util.EChartsUtil;
import louis.echarts.util.FreemarkerUtil;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

import java.io.File;
import java.util.Arrays;
import java.util.HashMap;
import java.util.List;

/**
 * @Description ECharts 图表服务层
 * @Author Louis
 * @Date 2022/07/10 17:14
 */
@Slf4j
@Service
public class EChartsService {

    // PhontomJS 服务网址
    @Value("${phantomjs.url}")
    private String phantomjsUrl;

    /**
    * @Description 生成图表
    * @Return java.io.File
    * @Author Louis
    * @Date 2022/07/10 17:30:19
    */
    public File generateEcharts(){
        // 数据参数，可以自己通过API查询json数据
        String title = "上海天气折线图";
        List&lt;String&gt; categories = Arrays.asList("2022-07-10", "2022-07-11", "2022-07-12", "2022-07-13", "2022-07-14", "2022-07-15", "2022-07-16", "2022-07-17", "2022-07-18", "2022-07-19", "2022-07-20", "2022-07-21", "2022-07-22");
        List&lt;String&gt; values = Arrays.asList("38", "33", "33", "31", "30", "32", "34", "37", "38", "37", "36", "38", "37");
        // 模板参数
        HashMap&lt;String, Object&gt; data = new HashMap&lt;&gt;();
        data.put("title", title);
        data.put("categories", JSON.toJSONString(categories));
        data.put("values", JSON.toJSONString(values));
        // 调用模板加载数据
        String option = FreemarkerUtil.generate("EChartsLineOption.ftl", data);
        // 生成图片的base64编码
        String base64 = EChartsUtil.generateEChartsBase64(phantomjsUrl, option);
        // 将base64转为文件
        return Base64Util.base64ToFile(base64);
    }

}</code></pre> 
<p> 5.8、运行 <strong>SpringBoot </strong>核心启动类，注入 EChartsService， 调用 <strong>EChartsService </strong>服务层的 <strong>generateEcharts()</strong> 方法。运行完毕后，打开系统文件资源管理器，发现在 <strong>D:\Temp\2022\7\10</strong> 目录下已经生成一张 <strong>.png</strong> 图片，可通过 <strong>ftl </strong>模板调整参数完成自定义图片。<strong>generateEcharts() </strong>方法返回的 <strong>java.io.File</strong> 对象可直接用于业务文件流操作使用。</p> 
<p><img alt="" height="601" src="https://images2.imgbox.com/1e/c6/rAORF76T_o.png" width="1080"></p> 
<p><img alt="" height="400" src="https://images2.imgbox.com/97/01/UYPJwe6N_o.png" width="800"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e2178756678b4c2590a52087d7d60d99/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">redis重启后数据丢失问题解决（亲测好用）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b966d92085e1e2893a74afff031cafe3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">二进制安装包安装Prometheus插件安装（mysql_exporter）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>