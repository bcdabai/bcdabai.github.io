<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>2023黑马头条.微服务项目.跟学笔记(四) - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="2023黑马头条.微服务项目.跟学笔记(四)" />
<meta property="og:description" content="2023黑马头条.微服务项目.跟学笔记 四 自媒体文章-自动审核今日内容介绍1.自媒体文章自动审核流程2.内容安全第三方接口2.1 概述2.2 准备工作2.3 文本内容审核接口2.4 图片审核接口2.5 项目集成 3.app端文章保存接口3.1 表结构说明3.2 分布式id3.3 思路分析3.4 feign接口 4.自媒体文章自动审核功能实现4.1 表结构说明4.2 实现4.3 单元测试4.4 feign远程接口调用方式4.5 服务降级处理 5.发布文章提交审核集成5.1 同步调用与异步调用5.2 Springboot集成异步线程调用 6.文章审核功能-综合测试6.1 服务启动列表6.2 测试情况列表 7.新需求-自管理敏感词7.1 需求分析7.2 敏感词-过滤7.3 DFA实现原理7.4 自管理敏感词集成到文章审核中 8.新需求-图片识别文字审核敏感词8.1 需求分析8.2 图片文字识别8.3 Tess4j案例8.4 管理敏感词和图片文字识别集成到文章审核 9.文章详情-静态文件生成9.1 思路分析9.2 实现步骤 10.今日作业以及思考 自媒体文章-自动审核 今日内容介绍 1.自媒体文章自动审核流程 文章数据流
流程:
自动审核的流程如下:
1 自媒体端发布文章后，开始审核文章
2 审核的主要是审核文章的内容（文本内容和图片）
3 借助第三方提供的接口审核文本
4 借助第三方提供的接口审核图片，由于图片存储到minIO中，需要先下载才能审核
5 如果审核失败，则需要修改自媒体文章的状态，status:2 审核失败 status:3 转到人工审核
6 如果审核成功，则需要在文章微服务中创建app端需要的文章
2.内容安全第三方接口 2.1 概述 内容安全是识别服务，支持对图片、视频、文本、语音等对象进行多样化场景检测，有效降低内容违规风险。
目前很多平台都支持内容检测，如阿里云、腾讯云、百度AI、网易云等国内大型互联网公司都对外提供了API。
按照性能和收费来看，黑马头条项目使用的就是阿里云的内容安全接口，使用到了图片和文本的审核。
阿里云收费标准：https://www.aliyun.com/price/product/?spm=a2c4g.11186623.2.10.4146401eg5oeu8#/lvwang/detail
2.2 准备工作 您在使用内容检测API之前，需要先注册阿里云账号，添加Access Key并签约云盾内容安全。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/3f75a79a6338758d94f7eac9673b9e85/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-07T18:03:40+08:00" />
<meta property="article:modified_time" content="2023-07-07T18:03:40+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">2023黑马头条.微服务项目.跟学笔记(四)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>2023黑马头条.微服务项目.跟学笔记 四</h4> 
 <ul><li><ul><li><a href="#_1" rel="nofollow">自媒体文章-自动审核</a></li><li><a href="#_2" rel="nofollow">今日内容介绍</a></li><li><ul><li><a href="#1_4" rel="nofollow">1.自媒体文章自动审核流程</a></li><li><a href="#2_25" rel="nofollow">2.内容安全第三方接口</a></li><li><ul><li><a href="#21__26" rel="nofollow">2.1 概述</a></li><li><a href="#22__36" rel="nofollow">2.2 准备工作</a></li><li><a href="#23__70" rel="nofollow">2.3 文本内容审核接口</a></li><li><a href="#24__79" rel="nofollow">2.4 图片审核接口</a></li><li><a href="#25__88" rel="nofollow">2.5 项目集成</a></li></ul> 
    </li><li><a href="#3app_184" rel="nofollow">3.app端文章保存接口</a></li><li><ul><li><a href="#31__186" rel="nofollow">3.1 表结构说明</a></li><li><a href="#32_id_200" rel="nofollow">3.2 分布式id</a></li><li><a href="#33__241" rel="nofollow">3.3 思路分析</a></li><li><a href="#34_feign_256" rel="nofollow">3.4 feign接口</a></li></ul> 
    </li><li><a href="#4_570" rel="nofollow">4.自媒体文章自动审核功能实现</a></li><li><ul><li><a href="#41__571" rel="nofollow">4.1 表结构说明</a></li><li><a href="#42__580" rel="nofollow">4.2 实现</a></li><li><a href="#43__869" rel="nofollow">4.3 单元测试</a></li><li><a href="#44_feign_935" rel="nofollow">4.4 feign远程接口调用方式</a></li><li><a href="#45__945" rel="nofollow">4.5 服务降级处理</a></li></ul> 
    </li><li><a href="#5_1052" rel="nofollow">5.发布文章提交审核集成</a></li><li><ul><li><a href="#51__1053" rel="nofollow">5.1 同步调用与异步调用</a></li><li><a href="#52_Springboot_1063" rel="nofollow">5.2 Springboot集成异步线程调用</a></li></ul> 
    </li><li><a href="#6_1122" rel="nofollow">6.文章审核功能-综合测试</a></li><li><ul><li><a href="#61__1123" rel="nofollow">6.1 服务启动列表</a></li><li><a href="#62__1135" rel="nofollow">6.2 测试情况列表</a></li></ul> 
    </li><li><a href="#7_1172" rel="nofollow">7.新需求-自管理敏感词</a></li><li><ul><li><a href="#71__1173" rel="nofollow">7.1 需求分析</a></li><li><a href="#72__1187" rel="nofollow">7.2 敏感词-过滤</a></li><li><a href="#73_DFA_1197" rel="nofollow">7.3 DFA实现原理</a></li><li><a href="#74__1212" rel="nofollow">7.4 自管理敏感词集成到文章审核中</a></li></ul> 
    </li><li><a href="#8_1333" rel="nofollow">8.新需求-图片识别文字审核敏感词</a></li><li><ul><li><a href="#81__1334" rel="nofollow">8.1 需求分析</a></li><li><a href="#82__1340" rel="nofollow">8.2 图片文字识别</a></li><li><a href="#83_Tess4j_1356" rel="nofollow">8.3 Tess4j案例</a></li><li><a href="#84__1409" rel="nofollow">8.4 管理敏感词和图片文字识别集成到文章审核</a></li></ul> 
    </li><li><a href="#9_1869" rel="nofollow">9.文章详情-静态文件生成</a></li><li><ul><li><a href="#91__1870" rel="nofollow">9.1 思路分析</a></li><li><a href="#92__1873" rel="nofollow">9.2 实现步骤</a></li></ul> 
   </li></ul> 
  </li></ul> 
  </li><li><a href="#10_2051" rel="nofollow">10.今日作业以及思考</a></li></ul> 
</div> 
<p></p> 
<h3><a id="_1"></a>自媒体文章-自动审核</h3> 
<h3><a id="_2"></a>今日内容介绍</h3> 
<p><img src="https://images2.imgbox.com/89/03/FZV866dA_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="1_4"></a>1.自媒体文章自动审核流程</h4> 
<p>文章数据流<br> <img src="https://images2.imgbox.com/5a/ed/qJ9aXe83_o.png" alt="在这里插入图片描述"></p> 
<p>流程:<br> <img src="https://images2.imgbox.com/74/49/7HpAt0ha_o.png" alt="在这里插入图片描述"><br> 自动审核的流程如下:<br> <img src="https://images2.imgbox.com/58/0d/VjEgrVwh_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>1 自媒体端发布文章后，开始审核文章</p> 
 <p>2 审核的主要是审核文章的内容（文本内容和图片）</p> 
 <p>3 借助第三方提供的接口审核文本</p> 
 <p>4 借助第三方提供的接口审核图片，由于图片存储到minIO中，需要先下载才能审核</p> 
 <p>5 如果审核失败，则需要修改自媒体文章的状态，status:2 审核失败 status:3 转到人工审核</p> 
 <p>6 如果审核成功，则需要在文章微服务中创建app端需要的文章</p> 
</blockquote> 
<h4><a id="2_25"></a>2.内容安全第三方接口</h4> 
<h5><a id="21__26"></a>2.1 概述</h5> 
<p>内容安全是识别服务，支持对图片、视频、文本、语音等对象进行多样化场景检测，有效降低内容违规风险。</p> 
<p>目前很多平台都支持内容检测，如阿里云、腾讯云、百度AI、网易云等国内大型互联网公司都对外提供了API。</p> 
<p>按照性能和收费来看，黑马头条项目使用的就是阿里云的内容安全接口，使用到了图片和文本的审核。</p> 
<p>阿里云收费标准：<a href="https://www.aliyun.com/price/product/?spm=a2c4g.11186623.2.10.4146401eg5oeu8" rel="nofollow">https://www.aliyun.com/price/product/?spm=a2c4g.11186623.2.10.4146401eg5oeu8#/lvwang/detail</a></p> 
<h5><a id="22__36"></a>2.2 准备工作</h5> 
<p>您在使用内容检测API之前，需要先注册阿里云账号，添加Access Key并签约云盾内容安全。</p> 
<p><strong>操作步骤</strong></p> 
<ol><li> <p>前往<a href="https://www.aliyun.com/" rel="nofollow">阿里云官网</a>注册账号。如果已有注册账号，请跳过此步骤。</p> <p>进入阿里云首页后，如果没有阿里云的账户需要先进行注册，才可以进行登录。由于注册较为简单，课程和讲义不在进行体现（注册可以使用多种方式，如淘宝账号、支付宝账号、微博账号等…）。</p> <p>需要实名认证和活体认证。</p> </li><li> <p>打开<a href="https://promotion.aliyun.com/ntms/act/lvwangdemo.html" rel="nofollow">云盾内容安全产品试用页面</a>，单击<strong>立即开通</strong>，正式开通服务。</p> </li></ol> 
<p><img src="https://images2.imgbox.com/cb/7f/y7EvAcGX_o.png" alt="在这里插入图片描述"><br> 内容安全控制台<br> <img src="https://images2.imgbox.com/6d/06/JFBItycM_o.png" alt="在这里插入图片描述"></p> 
<ol start="3"><li>在<a href="https://ak-console.aliyun.com/#/accesskey" rel="nofollow">AccessKey管理页面</a>管理您的AccessKeyID和AccessKeySecret。</li></ol> 
<p><img src="https://images2.imgbox.com/1d/68/1ATAdIxM_o.png" alt="在这里插入图片描述"></p> 
<p>管理自己的AccessKey,可以新建和删除AccessKey</p> 
<p><img src="https://images2.imgbox.com/c6/dd/tWNwly1l_o.png" alt="在这里插入图片描述"></p> 
<p>查看自己的AccessKey，</p> 
<p>AccessKey默认是隐藏的，第一次申请的时候可以保存AccessKey，点击显示，通过验证手机号后也可以查看</p> 
<p><img src="https://images2.imgbox.com/73/a1/EsyCEbMn_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="23__70"></a>2.3 文本内容审核接口</h5> 
<p>文本垃圾内容检测：https://help.aliyun.com/document_detail/70439.html?spm=a2c4g.11186623.6.659.35ac3db3l0wV5k</p> 
<p><img src="https://images2.imgbox.com/69/d9/Rl7JWBYn_o.png" alt="在这里插入图片描述"></p> 
<p>文本垃圾内容Java SDK: https://help.aliyun.com/document_detail/53427.html?spm=a2c4g.11186623.6.717.466d7544QbU8Lr</p> 
<h5><a id="24__79"></a>2.4 图片审核接口</h5> 
<p>图片垃圾内容检测：https://help.aliyun.com/document_detail/70292.html?spm=a2c4g.11186623.6.616.5d7d1e7f9vDRz4</p> 
<p><img src="https://images2.imgbox.com/3d/36/CKR4YBxU_o.png" alt="在这里插入图片描述"></p> 
<p>图片垃圾内容Java SDK: https://help.aliyun.com/document_detail/53424.html?spm=a2c4g.11186623.6.715.c8f69b12ey35j4</p> 
<h5><a id="25__88"></a>2.5 项目集成</h5> 
<p><img src="https://images2.imgbox.com/8a/bf/8drMoZ4r_o.png" alt="在这里插入图片描述"><br> 添加依赖</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.aliyun<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>aliyun-java-sdk-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.1.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.aliyun<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>aliyun-java-sdk-green<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.6.6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.fastjson2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>fastjson2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.0.9<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.aliyun.oss<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>aliyun-sdk-oss<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.8.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>①：拷贝资料文件夹中的类到common模块下面，并添加到自动配置<br> <img src="https://images2.imgbox.com/cc/39/tK6HVRo0_o.png" alt="在这里插入图片描述"></p> 
<p>包括了GreenImageScan和GreenTextScan及对应的工具类<br> <img src="https://images2.imgbox.com/e5/2b/8R1PCLPK_o.png" alt="在这里插入图片描述"></p> 
<p>添加到自动配置中<br> <img src="https://images2.imgbox.com/08/65/08Sg4BL1_o.png" alt="在这里插入图片描述"></p> 
<p>②： accessKeyId和secret（需自己申请）</p> 
<p>在heima-leadnews-wemedia中的nacos配置中心添加以下配置：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">aliyun</span><span class="token punctuation">:</span>
 <span class="token key atrule">accessKeyId</span><span class="token punctuation">:</span> LTAI5tCWHCcfvqQzu8k2oKmX
 <span class="token key atrule">secret</span><span class="token punctuation">:</span> auoKUFsghimbfVQHpy7gtRyBkoR4vc
<span class="token comment">#aliyun.scenes=porn,terrorism,ad,qrcode,live,logo</span>
 <span class="token key atrule">scenes</span><span class="token punctuation">:</span> terrorism
</code></pre> 
<p>③：在自媒体微服务中测试类中注入审核文本和图片的bean进行测试</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>wemedia</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>common<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span></span><span class="token class-name">GreenImageScan</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>common<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span></span><span class="token class-name">GreenTextScan</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>file<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">FileStorageService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runner<span class="token punctuation">.</span></span><span class="token class-name">RunWith</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SpringBootTest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span></span><span class="token class-name">SpringRunner</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@SpringBootTest</span><span class="token punctuation">(</span>classes <span class="token operator">=</span> <span class="token class-name">WemediaApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AliyunTest</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">GreenTextScan</span> greenTextScan<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">GreenImageScan</span> greenImageScan<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">FileStorageService</span> fileStorageService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testScanText</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Map</span> map <span class="token operator">=</span> greenTextScan<span class="token punctuation">.</span><span class="token function">greeTextScan</span><span class="token punctuation">(</span><span class="token string">"我是一个好人,冰毒"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testScanImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> fileStorageService<span class="token punctuation">.</span><span class="token function">downLoadFile</span><span class="token punctuation">(</span><span class="token string">"http://192.168.200.130:9000/leadnews/2021/04/26/ef3cbe458db249f7bd6fb4339e593e55.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> map <span class="token operator">=</span> greenImageScan<span class="token punctuation">.</span><span class="token function">imageScan</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="3app_184"></a>3.app端文章保存接口</h4> 
<h5><a id="31__186"></a>3.1 表结构说明</h5> 
<p>ap_article 文章信息表<br> <img src="https://images2.imgbox.com/db/01/Bx1WqAbm_o.png" alt="在这里插入图片描述"></p> 
<p>ap_article_config 文章配置表<br> <img src="https://images2.imgbox.com/ad/bb/8dUVpQNi_o.png" alt="在这里插入图片描述"></p> 
<p>ap_article_content 文章内容表<br> <img src="https://images2.imgbox.com/55/50/LkCDBCC0_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="32_id_200"></a>3.2 分布式id</h5> 
<p>随着业务的增长，文章表可能要占用很大的物理存储空间，为了解决该问题，后期使用数据库分片技术。将一个数据库进行拆分，通过数据库中间件连接。如果数据库中该表选用ID自增策略，则可能产生重复的ID，此时应该使用分布式ID生成策略来生成ID。<br> <img src="https://images2.imgbox.com/b9/ee/vH23mwst_o.png" alt="在这里插入图片描述"></p> 
<p>分布式id-技术选型<br> <img src="https://images2.imgbox.com/5a/f9/RZ9Dufbn_o.png" alt="在这里插入图片描述"></p> 
<p>snowflake是Twitter开源的分布式ID生成算法，结果是一个long型的ID。其核心思想是：使用41bit作为毫秒数，10bit作为机器的ID（5个bit是数据中心，5个bit的机器ID），12bit作为毫秒内的流水号（意味着每个节点在每毫秒可以产生 4096 个 ID），最后还有一个符号位，永远是0</p> 
<p><img src="https://images2.imgbox.com/0d/f2/AvvWBzFo_o.png" alt="在这里插入图片描述"></p> 
<p>文章端相关的表都使用雪花算法生成id,包括ap_article、 ap_article_config、 ap_article_content</p> 
<p>mybatis-plus已经集成了雪花算法，完成以下两步即可在项目中集成雪花算法</p> 
<p>第一：在实体类中的id上加入如下配置，指定类型为id_worker</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@TableId</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"id"</span><span class="token punctuation">,</span>type <span class="token operator">=</span> <span class="token class-name">IdType</span><span class="token punctuation">.</span><span class="token constant">ID_WORKER</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
</code></pre> 
<p>第二：在application.yml文件中配置数据中心id和机器id<br> <img src="https://images2.imgbox.com/7d/5d/PFaz2wKn_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-yaml"><span class="token key atrule">mybatis-plus</span><span class="token punctuation">:</span>
  <span class="token key atrule">mapper-locations</span><span class="token punctuation">:</span> classpath<span class="token important">*:mapper/*.xml</span>
  <span class="token comment"># 设置别名包扫描路径，通过该属性可以给包中的类注册别名</span>
  <span class="token key atrule">type-aliases-package</span><span class="token punctuation">:</span> com.heima.model.article.pojos
  <span class="token key atrule">global-config</span><span class="token punctuation">:</span>
    <span class="token key atrule">datacenter-id</span><span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token key atrule">workerId</span><span class="token punctuation">:</span> <span class="token number">1</span>
</code></pre> 
<p>datacenter-id:数据中心id(取值范围：0-31)</p> 
<p>workerId:机器id(取值范围：0-31)</p> 
<h5><a id="33__241"></a>3.3 思路分析</h5> 
<p>在文章审核成功以后需要在app的article库中新增文章数据</p> 
<p>1.保存文章信息 ap_article</p> 
<p>2.保存文章配置信息 ap_article_config</p> 
<p>3.保存文章内容 ap_article_content</p> 
<p>实现思路：<br> <img src="https://images2.imgbox.com/3e/2c/EtdjYLTW_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="34_feign_256"></a>3.4 feign接口</h5> 
<table><thead><tr><th></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td>接口路径</td><td>/api/v1/article/save</td></tr><tr><td>请求方式</td><td>POST</td></tr><tr><td>参数</td><td>ArticleDto</td></tr><tr><td>响应结果</td><td>ResponseResult</td></tr></tbody></table> 
<p><img src="https://images2.imgbox.com/f6/3b/qDzU0rRO_o.png" alt="在这里插入图片描述"><br> 步骤如下:<br> <img src="https://images2.imgbox.com/c0/9d/78wemor1_o.png" alt="在这里插入图片描述"></p> 
<p>ArticleDto</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>model<span class="token punctuation">.</span>article<span class="token punctuation">.</span>dtos</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>model<span class="token punctuation">.</span>article<span class="token punctuation">.</span>pojos<span class="token punctuation">.</span></span><span class="token class-name">ApArticle</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ArticleDto</span>  <span class="token keyword">extends</span> <span class="token class-name">ApArticle</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * 文章内容
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> content<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>成功：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"code"</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
  <span class="token string-property property">"errorMessage"</span> <span class="token operator">:</span> <span class="token string">"操作成功"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"data"</span><span class="token operator">:</span><span class="token string">"1302864436297442242"</span>
 <span class="token punctuation">}</span>
</code></pre> 
<p>失败：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"code"</span><span class="token operator">:</span><span class="token number">501</span><span class="token punctuation">,</span>
  <span class="token string-property property">"errorMessage"</span><span class="token operator">:</span><span class="token string">"参数失效"</span><span class="token punctuation">,</span>
 <span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"code"</span><span class="token operator">:</span><span class="token number">501</span><span class="token punctuation">,</span>
  <span class="token string-property property">"errorMessage"</span><span class="token operator">:</span><span class="token string">"文章没有找到"</span><span class="token punctuation">,</span>
 <span class="token punctuation">}</span>
</code></pre> 
<p>功能实现：</p> 
<p>①：在heima-leadnews-feign-api中新增接口</p> 
<p>第一：先导入feign的依赖</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>第二：定义文章端的接口</p> 
<pre><code class="prism language-json"><span class="token keyword">package</span> com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>apis<span class="token punctuation">.</span>article<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>model<span class="token punctuation">.</span>article<span class="token punctuation">.</span>dtos<span class="token punctuation">.</span>ArticleDto<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>model<span class="token punctuation">.</span>common<span class="token punctuation">.</span>dtos<span class="token punctuation">.</span>ResponseResult<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span>FeignClient<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>PostMapping<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>RequestBody<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException<span class="token punctuation">;</span>


@<span class="token function">FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"leadnews-article"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IArticleClient</span> <span class="token punctuation">{<!-- --></span>

    @<span class="token function">PostMapping</span><span class="token punctuation">(</span><span class="token string">"/api/v1/article/save"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> ResponseResult <span class="token function">saveArticle</span><span class="token punctuation">(</span>@RequestBody ArticleDto dto<span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>②：在heima-leadnews-article中实现该方法</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>article<span class="token punctuation">.</span>feign</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>apis<span class="token punctuation">.</span>article<span class="token punctuation">.</span></span><span class="token class-name">IArticleClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>article<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">ApArticleService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>model<span class="token punctuation">.</span>article<span class="token punctuation">.</span>dtos<span class="token punctuation">.</span></span><span class="token class-name">ArticleDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>model<span class="token punctuation">.</span>common<span class="token punctuation">.</span>dtos<span class="token punctuation">.</span></span><span class="token class-name">ResponseResult</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ArticleClient</span> <span class="token keyword">implements</span> <span class="token class-name">IArticleClient</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ApArticleService</span> apArticleService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/api/v1/article/save"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ResponseResult</span> <span class="token function">saveArticle</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">ArticleDto</span> dto<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> apArticleService<span class="token punctuation">.</span><span class="token function">saveArticle</span><span class="token punctuation">(</span>dto<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>③：拷贝mapper</p> 
<p>在资料文件夹中拷贝ApArticleConfigMapper类到mapper文件夹中</p> 
<p>同时，修改ApArticleConfig类，添加如下构造函数</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>model<span class="token punctuation">.</span>article<span class="token punctuation">.</span>pojos</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">IdType</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">TableField</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">TableId</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">TableName</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">NoArgsConstructor</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Serializable</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * &lt;p&gt;
 * APP已发布文章配置表
 * &lt;/p&gt;
 *
 * @author itheima
 */</span>

<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@TableName</span><span class="token punctuation">(</span><span class="token string">"ap_article_config"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApArticleConfig</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{<!-- --></span>


    <span class="token keyword">public</span> <span class="token class-name">ApArticleConfig</span><span class="token punctuation">(</span><span class="token class-name">Long</span> articleId<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>articleId <span class="token operator">=</span> articleId<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>isComment <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>isForward <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>isDelete <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>isDown <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@TableId</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"id"</span><span class="token punctuation">,</span>type <span class="token operator">=</span> <span class="token class-name">IdType</span><span class="token punctuation">.</span><span class="token constant">ID_WORKER</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 文章id
     */</span>
    <span class="token annotation punctuation">@TableField</span><span class="token punctuation">(</span><span class="token string">"article_id"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> articleId<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 是否可评论
     * true: 可以评论   1
     * false: 不可评论  0
     */</span>
    <span class="token annotation punctuation">@TableField</span><span class="token punctuation">(</span><span class="token string">"is_comment"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> isComment<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 是否转发
     * true: 可以转发   1
     * false: 不可转发  0
     */</span>
    <span class="token annotation punctuation">@TableField</span><span class="token punctuation">(</span><span class="token string">"is_forward"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> isForward<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 是否下架
     * true: 下架   1
     * false: 没有下架  0
     */</span>
    <span class="token annotation punctuation">@TableField</span><span class="token punctuation">(</span><span class="token string">"is_down"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> isDown<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 是否已删除
     * true: 删除   1
     * false: 没有删除  0
     */</span>
    <span class="token annotation punctuation">@TableField</span><span class="token punctuation">(</span><span class="token string">"is_delete"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> isDelete<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>④：在ApArticleService中新增方法</p> 
<pre><code class="prism language-java"><span class="token comment">/**
     * 保存app端相关文章
     * @param dto
     * @return
     */</span>
<span class="token class-name">ResponseResult</span> <span class="token function">saveArticle</span><span class="token punctuation">(</span><span class="token class-name">ArticleDto</span> dto<span class="token punctuation">)</span> <span class="token punctuation">;</span>
</code></pre> 
<p>实现类：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">ApArticleConfigMapper</span> apArticleConfigMapper<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">ApArticleContentMapper</span> apArticleContentMapper<span class="token punctuation">;</span>

<span class="token comment">/**
     * 保存app端相关文章
     * @param dto
     * @return
     */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ResponseResult</span> <span class="token function">saveArticle</span><span class="token punctuation">(</span><span class="token class-name">ArticleDto</span> dto<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//1.检查参数</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>dto <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">ResponseResult</span><span class="token punctuation">.</span><span class="token function">errorResult</span><span class="token punctuation">(</span><span class="token class-name">AppHttpCodeEnum</span><span class="token punctuation">.</span><span class="token constant">PARAM_INVALID</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">ApArticle</span> apArticle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApArticle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>dto<span class="token punctuation">,</span>apArticle<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//2.判断是否存在id</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">//2.1 不存在id  保存  文章  文章配置  文章内容</span>

        <span class="token comment">//保存文章</span>
        <span class="token function">save</span><span class="token punctuation">(</span>apArticle<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//保存配置</span>
        <span class="token class-name">ApArticleConfig</span> apArticleConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApArticleConfig</span><span class="token punctuation">(</span>apArticle<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        apArticleConfigMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>apArticleConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//保存 文章内容</span>
        <span class="token class-name">ApArticleContent</span> apArticleContent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApArticleContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        apArticleContent<span class="token punctuation">.</span><span class="token function">setArticleId</span><span class="token punctuation">(</span>apArticle<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        apArticleContent<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        apArticleContentMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>apArticleContent<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//2.2 存在id   修改  文章  文章内容</span>

        <span class="token comment">//修改  文章</span>
        <span class="token function">updateById</span><span class="token punctuation">(</span>apArticle<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//修改文章内容</span>
        <span class="token class-name">ApArticleContent</span> apArticleContent <span class="token operator">=</span> apArticleContentMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token class-name">Wrappers</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApArticleContent</span><span class="token punctuation">&gt;</span></span><span class="token function">lambdaQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">ApArticleContent</span><span class="token operator">::</span><span class="token function">getArticleId</span><span class="token punctuation">,</span> dto<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        apArticleContent<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        apArticleContentMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>apArticleContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">//3.结果返回  文章的id</span>
    <span class="token keyword">return</span> <span class="token class-name">ResponseResult</span><span class="token punctuation">.</span><span class="token function">okResult</span><span class="token punctuation">(</span>apArticle<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>⑤：测试</p> 
<p>编写junit单元测试，或使用postman进行测试</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"title"</span><span class="token operator">:</span><span class="token string">"黑马头条项目背景22222222222222"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"authoId"</span><span class="token operator">:</span><span class="token number">1102</span><span class="token punctuation">,</span>
    <span class="token string-property property">"layout"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string-property property">"labels"</span><span class="token operator">:</span><span class="token string">"黑马头条"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"publishTime"</span><span class="token operator">:</span><span class="token string">"2028-03-14T11:35:49.000Z"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"images"</span><span class="token operator">:</span> <span class="token string">"http://192.168.200.130:9000/leadnews/2021/04/26/5ddbdb5c68094ce393b08a47860da275.jpg"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"content"</span><span class="token operator">:</span><span class="token string">"22222222222222222黑马头条项目背景,黑马头条项目背景,黑马头条项目背景,黑马头条项目背景，黑马头条项目背景"</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>测试地址如下：http://localhost:51802/api/v1/article/save<br> 保存成功<br> <img src="https://images2.imgbox.com/c8/4f/LaoeKVMR_o.png" alt="在这里插入图片描述"><br> 数据库表ap_article保存成功<br> <img src="https://images2.imgbox.com/bd/6b/1y2qF8EE_o.png" alt="在这里插入图片描述"><br> 我们再尝试一下修改</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"id"</span><span class="token operator">:</span><span class="token number">1676188422777188353</span><span class="token punctuation">,</span>
    <span class="token string-property property">"title"</span><span class="token operator">:</span><span class="token string">"今日黑马头条项目"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"authorId"</span><span class="token operator">:</span><span class="token number">1102</span><span class="token punctuation">,</span>
    <span class="token string-property property">"layout"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string-property property">"labels"</span><span class="token operator">:</span><span class="token string">"黑马头条"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"publishTime"</span><span class="token operator">:</span><span class="token string">"2023-07-04T11:35:49.000Z"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"images"</span><span class="token operator">:</span> <span class="token string">"http://192.168.200.130:9000/leadnews/2021/04/26/5ddbdb5c68094ce393b08a47860da275.jpg"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"content"</span><span class="token operator">:</span><span class="token string">"22222222222222222黑马头条项目背景,黑马头条项目背景,黑马头条项目背景,黑马头条项目背景，黑马头条项目背景"</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>修改如下:<br> <img src="https://images2.imgbox.com/8a/74/nq8JcG9X_o.png" alt="在这里插入图片描述"><br> 我们看表ap_article，修改成功<br> <img src="https://images2.imgbox.com/a4/2d/BcCUSQcz_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="4_570"></a>4.自媒体文章自动审核功能实现</h4> 
<h5><a id="41__571"></a>4.1 表结构说明</h5> 
<p>wm_news 自媒体文章表</p> 
<p><img src="https://images2.imgbox.com/b6/af/9gKOUVcn_o.png" alt="在这里插入图片描述"></p> 
<p>status字段：0 草稿 1 待审核 2 审核失败 3 人工审核 4 人工审核通过 8 审核通过（待发布） 9 已发布</p> 
<h5><a id="42__580"></a>4.2 实现</h5> 
<p><img src="https://images2.imgbox.com/70/b5/ez8JmXKk_o.png" alt="在这里插入图片描述"></p> 
<p>在heima-leadnews-wemedia中的service新增接口</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>wemedia<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">WmNewsAutoScanService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 自媒体文章审核
     * @param id  自媒体文章id
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">autoScanWmNews</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>实现类：</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>wemedia<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSONArray</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>apis<span class="token punctuation">.</span>article<span class="token punctuation">.</span></span><span class="token class-name">IArticleClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>common<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span></span><span class="token class-name">GreenImageScan</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>common<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span></span><span class="token class-name">GreenTextScan</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>file<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">FileStorageService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>model<span class="token punctuation">.</span>article<span class="token punctuation">.</span>dtos<span class="token punctuation">.</span></span><span class="token class-name">ArticleDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>model<span class="token punctuation">.</span>common<span class="token punctuation">.</span>dtos<span class="token punctuation">.</span></span><span class="token class-name">ResponseResult</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>model<span class="token punctuation">.</span>wemedia<span class="token punctuation">.</span>pojos<span class="token punctuation">.</span></span><span class="token class-name">WmChannel</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>model<span class="token punctuation">.</span>wemedia<span class="token punctuation">.</span>pojos<span class="token punctuation">.</span></span><span class="token class-name">WmNews</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>model<span class="token punctuation">.</span>wemedia<span class="token punctuation">.</span>pojos<span class="token punctuation">.</span></span><span class="token class-name">WmUser</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>wemedia<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">WmChannelMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>wemedia<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">WmNewsMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>wemedia<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">WmUserMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>wemedia<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">WmNewsAutoScanService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span></span><span class="token class-name">StringUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">BeanUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Transactional</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>stream<span class="token punctuation">.</span></span><span class="token class-name">Collectors</span></span><span class="token punctuation">;</span>


<span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WmNewsAutoScanServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">WmNewsAutoScanService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">WmNewsMapper</span> wmNewsMapper<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 自媒体文章审核
     *
     * @param id 自媒体文章id
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">autoScanWmNews</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//1.查询自媒体文章</span>
        <span class="token class-name">WmNews</span> wmNews <span class="token operator">=</span> wmNewsMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>wmNews <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"WmNewsAutoScanServiceImpl-文章不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">WmNews<span class="token punctuation">.</span>Status</span><span class="token punctuation">.</span><span class="token constant">SUBMIT</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">//从内容中提取纯文本内容和图片</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> textAndImages <span class="token operator">=</span> <span class="token function">handleTextAndImages</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//2.审核文本内容  阿里云接口</span>
            <span class="token keyword">boolean</span> isTextScan <span class="token operator">=</span> <span class="token function">handleTextScan</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> textAndImages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>wmNews<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isTextScan<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">;</span>

            <span class="token comment">//3.审核图片  阿里云接口</span>
            <span class="token keyword">boolean</span> isImageScan <span class="token operator">=</span>  <span class="token function">handleImageScan</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> textAndImages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"images"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>wmNews<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isImageScan<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">;</span>

            <span class="token comment">//4.审核成功，保存app端的相关的文章数据</span>
            <span class="token class-name">ResponseResult</span> responseResult <span class="token operator">=</span> <span class="token function">saveAppArticle</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>responseResult<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"WmNewsAutoScanServiceImpl-文章审核，保存app端相关文章数据失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//回填article_id</span>
            wmNews<span class="token punctuation">.</span><span class="token function">setArticleId</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">)</span> responseResult<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">updateWmNews</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> <span class="token number">9</span><span class="token punctuation">,</span><span class="token string">"审核成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">IArticleClient</span> articleClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">WmChannelMapper</span> wmChannelMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">WmUserMapper</span> wmUserMapper<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 保存app端相关的文章数据
     * @param wmNews
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">ResponseResult</span> <span class="token function">saveAppArticle</span><span class="token punctuation">(</span><span class="token class-name">WmNews</span> wmNews<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token class-name">ArticleDto</span> dto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArticleDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//属性的拷贝</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">,</span>dto<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//文章的布局</span>
        dto<span class="token punctuation">.</span><span class="token function">setLayout</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//频道</span>
        <span class="token class-name">WmChannel</span> wmChannel <span class="token operator">=</span> wmChannelMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">.</span><span class="token function">getChannelId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>wmChannel <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            dto<span class="token punctuation">.</span><span class="token function">setChannelName</span><span class="token punctuation">(</span>wmChannel<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//作者</span>
        dto<span class="token punctuation">.</span><span class="token function">setAuthorId</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">WmUser</span> wmUser <span class="token operator">=</span> wmUserMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>wmUser <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            dto<span class="token punctuation">.</span><span class="token function">setAuthorName</span><span class="token punctuation">(</span>wmUser<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//设置文章id</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">.</span><span class="token function">getArticleId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            dto<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">.</span><span class="token function">getArticleId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        dto<span class="token punctuation">.</span><span class="token function">setCreatedTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ResponseResult</span> responseResult <span class="token operator">=</span> articleClient<span class="token punctuation">.</span><span class="token function">saveArticle</span><span class="token punctuation">(</span>dto<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> responseResult<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">FileStorageService</span> fileStorageService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">GreenImageScan</span> greenImageScan<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 审核图片
     * @param images
     * @param wmNews
     * @return
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">handleImageScan</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> images<span class="token punctuation">,</span> <span class="token class-name">WmNews</span> wmNews<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>images <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> images<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> flag<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//下载图片 minIO</span>
        <span class="token comment">//图片去重</span>
        images <span class="token operator">=</span> images<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">distinct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> imageList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> image <span class="token operator">:</span> images<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> fileStorageService<span class="token punctuation">.</span><span class="token function">downLoadFile</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">;</span>
            imageList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token comment">//审核图片</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Map</span> map <span class="token operator">=</span> greenImageScan<span class="token punctuation">.</span><span class="token function">imageScan</span><span class="token punctuation">(</span>imageList<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>map <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token comment">//审核失败</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"suggestion"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"block"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token function">updateWmNews</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"当前文章中存在违规内容"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">//不确定信息  需要人工审核</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"suggestion"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"review"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token function">updateWmNews</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"当前文章中存在不确定内容"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> flag<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">GreenTextScan</span> greenTextScan<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 审核纯文本内容
     * @param content
     * @param wmNews
     * @return
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">handleTextScan</span><span class="token punctuation">(</span><span class="token class-name">String</span> content<span class="token punctuation">,</span> <span class="token class-name">WmNews</span> wmNews<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"-"</span><span class="token operator">+</span>content<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> flag<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Map</span> map <span class="token operator">=</span> greenTextScan<span class="token punctuation">.</span><span class="token function">greeTextScan</span><span class="token punctuation">(</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"-"</span><span class="token operator">+</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>map <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token comment">//审核失败</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"suggestion"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"block"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token function">updateWmNews</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"当前文章中存在违规内容"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">//不确定信息  需要人工审核</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"suggestion"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"review"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token function">updateWmNews</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"当前文章中存在不确定内容"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> flag<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 修改文章内容
     * @param wmNews
     * @param status
     * @param reason
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">updateWmNews</span><span class="token punctuation">(</span><span class="token class-name">WmNews</span> wmNews<span class="token punctuation">,</span> <span class="token keyword">short</span> status<span class="token punctuation">,</span> <span class="token class-name">String</span> reason<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        wmNews<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        wmNews<span class="token punctuation">.</span><span class="token function">setReason</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
        wmNewsMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 1。从自媒体文章的内容中提取文本和图片
     * 2.提取文章的封面图片
     * @param wmNews
     * @return
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">handleTextAndImages</span><span class="token punctuation">(</span><span class="token class-name">WmNews</span> wmNews<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token comment">//存储纯文本内容</span>
        <span class="token class-name">StringBuilder</span> stringBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> images <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//1。从自媒体文章的内容中提取文本和图片</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&gt;</span></span> maps <span class="token operator">=</span> <span class="token class-name">JSONArray</span><span class="token punctuation">.</span><span class="token function">parseArray</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map</span> map <span class="token operator">:</span> maps<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"text"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    stringBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"image"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    images<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//2.提取文章的封面图片</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">.</span><span class="token function">getImages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> split <span class="token operator">=</span> wmNews<span class="token punctuation">.</span><span class="token function">getImages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            images<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>split<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> resultMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">,</span>stringBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"images"</span><span class="token punctuation">,</span>images<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> resultMap<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="43__869"></a>4.3 单元测试</h5> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>wemedia<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>wemedia<span class="token punctuation">.</span></span><span class="token class-name">WemediaApplication</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runner<span class="token punctuation">.</span></span><span class="token class-name">RunWith</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SpringBootTest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span></span><span class="token class-name">SpringRunner</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token import static"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span></span><span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token operator">*</span></span><span class="token punctuation">;</span>


<span class="token annotation punctuation">@SpringBootTest</span><span class="token punctuation">(</span>classes <span class="token operator">=</span> <span class="token class-name">WemediaApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WmNewsAutoScanServiceTest</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">WmNewsAutoScanService</span> wmNewsAutoScanService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">autoScanWmNews</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        wmNewsAutoScanService<span class="token punctuation">.</span><span class="token function">autoScanWmNews</span><span class="token punctuation">(</span><span class="token number">6238</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>对WmNewsAutoScanService创建单元测试<br> <img src="https://images2.imgbox.com/52/07/LPIHN4nM_o.png" alt="在这里插入图片描述"><br> 测试参数如下:<br> <img src="https://images2.imgbox.com/8e/c2/so0cX9bZ_o.png" alt="在这里插入图片描述"><br> 传入id 6234<br> <img src="https://images2.imgbox.com/a3/4e/AmsxtprZ_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>wemedia<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>wemedia<span class="token punctuation">.</span></span><span class="token class-name">WemediaApplication</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runner<span class="token punctuation">.</span></span><span class="token class-name">RunWith</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">AutoConfigureCache</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SpringBootTest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span></span><span class="token class-name">SpringRunner</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token import static"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@SpringBootTest</span><span class="token punctuation">(</span>classes <span class="token operator">=</span> <span class="token class-name">WemediaApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">WmNewsAutoScanServiceTest</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">WmNewsAutoScanService</span> wmNewsAutoScanService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">autoScanWmNews</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        wmNewsAutoScanService<span class="token punctuation">.</span><span class="token function">autoScanWmNews</span><span class="token punctuation">(</span><span class="token number">6234</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>运行完后ap_article多了一条数据<br> <img src="https://images2.imgbox.com/80/0f/BSldxBJG_o.png" alt="在这里插入图片描述"><br> leadnews_wemedia.wm_news表审核成功<br> <img src="https://images2.imgbox.com/bb/7a/ncjKgBoo_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="44_feign_935"></a>4.4 feign远程接口调用方式</h5> 
<p><img src="https://images2.imgbox.com/24/ed/4aaLZ1LY_o.png" alt="在这里插入图片描述"></p> 
<p>在heima-leadnews-wemedia服务中已经依赖了heima-leadnews-feign-apis工程，只需要在自媒体的引导类中开启feign的远程调用即可</p> 
<p>注解为：<code>@EnableFeignClients(basePackages = "com.heima.apis")</code> 需要指向apis这个包<br> <img src="https://images2.imgbox.com/f6/f9/NhsjWrJw_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="45__945"></a>4.5 服务降级处理</h5> 
<p><img src="https://images2.imgbox.com/a0/ae/Mqia1w5Q_o.png" alt="在这里插入图片描述"></p> 
<ul><li> <p>服务降级是服务自我保护的一种方式，或者保护下游服务的一种方式，用于确保服务不会受请求突增影响变得不可用，确保服务不会崩溃</p> </li><li> <p>服务降级虽然会导致请求失败，但是不会导致阻塞。</p> </li></ul> 
<p>实现步骤：</p> 
<p>①：在heima-leadnews-feign-api编写降级逻辑</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>apis<span class="token punctuation">.</span>article<span class="token punctuation">.</span>fallback</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>apis<span class="token punctuation">.</span>article<span class="token punctuation">.</span></span><span class="token class-name">IArticleClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>model<span class="token punctuation">.</span>article<span class="token punctuation">.</span>dtos<span class="token punctuation">.</span></span><span class="token class-name">ArticleDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>model<span class="token punctuation">.</span>common<span class="token punctuation">.</span>dtos<span class="token punctuation">.</span></span><span class="token class-name">ResponseResult</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>model<span class="token punctuation">.</span>common<span class="token punctuation">.</span>enums<span class="token punctuation">.</span></span><span class="token class-name">AppHttpCodeEnum</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * feign失败配置
 * @author itheima
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IArticleClientFallback</span> <span class="token keyword">implements</span> <span class="token class-name">IArticleClient</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ResponseResult</span> <span class="token function">saveArticle</span><span class="token punctuation">(</span><span class="token class-name">ArticleDto</span> dto<span class="token punctuation">)</span>  <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">ResponseResult</span><span class="token punctuation">.</span><span class="token function">errorResult</span><span class="token punctuation">(</span><span class="token class-name">AppHttpCodeEnum</span><span class="token punctuation">.</span><span class="token constant">SERVER_ERROR</span><span class="token punctuation">,</span><span class="token string">"获取数据失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在自媒体微服务中添加类，扫描降级代码类的包</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>wemedia<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">ComponentScan</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@ComponentScan</span><span class="token punctuation">(</span><span class="token string">"com.heima.apis.article.fallback"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InitConfig</span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>
</code></pre> 
<p>②：远程接口中指向降级代码</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>apis<span class="token punctuation">.</span>article</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>apis<span class="token punctuation">.</span>article<span class="token punctuation">.</span>fallback<span class="token punctuation">.</span></span><span class="token class-name">IArticleClientFallback</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>model<span class="token punctuation">.</span>article<span class="token punctuation">.</span>dtos<span class="token punctuation">.</span></span><span class="token class-name">ArticleDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>model<span class="token punctuation">.</span>common<span class="token punctuation">.</span>dtos<span class="token punctuation">.</span></span><span class="token class-name">ResponseResult</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span></span><span class="token class-name">FeignClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PostMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestBody</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"leadnews-article"</span><span class="token punctuation">,</span>fallback <span class="token operator">=</span> <span class="token class-name">IArticleClientFallback</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IArticleClient</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/api/v1/article/save"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ResponseResult</span> <span class="token function">saveArticle</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">ArticleDto</span> dto<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>③：客户端开启降级heima-leadnews-wemedia</p> 
<p>在wemedia的nacos配置中心里添加如下内容，开启服务降级，也可以指定服务响应的超时的时间</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token comment"># 开启feign对hystrix熔断降级的支持</span>
  <span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token comment"># 修改调用超时时间</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">default</span><span class="token punctuation">:</span>
        <span class="token key atrule">connectTimeout</span><span class="token punctuation">:</span> <span class="token number">2000</span>
        <span class="token key atrule">readTimeout</span><span class="token punctuation">:</span> <span class="token number">2000</span>
</code></pre> 
<p>④：测试</p> 
<p>在ApArticleServiceImpl类中saveArticle方法添加代码<br> <img src="https://images2.imgbox.com/d8/52/OxdntKAb_o.png" alt="在这里插入图片描述"><br> 代码如下:</p> 
<pre><code class="prism language-java"><span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在自媒体端进行审核测试，会出现服务降级的现象<br> 启动文章微服务即可，我们以id = 6232的数据来测试<br> <img src="https://images2.imgbox.com/c1/2e/TifYohqs_o.png" alt="在这里插入图片描述"><br> 在WmNewsAutoScanServiceImpl.java中打上断点，发现确实是降级了<br> <img src="https://images2.imgbox.com/0e/d4/CeRRT1FC_o.png" alt="在这里插入图片描述"><br> 后台抛出异常<br> <img src="https://images2.imgbox.com/70/bd/petkUMB5_o.png" alt="在这里插入图片描述"><br> 最后别忘记还原ApArticleServiceImpl.java，还原降级<br> <img src="https://images2.imgbox.com/ba/46/wIteczha_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="5_1052"></a>5.发布文章提交审核集成</h4> 
<h5><a id="51__1053"></a>5.1 同步调用与异步调用</h5> 
<p>同步：就是在发出一个调用时，在没有得到结果之前， 该调用就不返回（实时处理）</p> 
<p>异步：调用在发出之后，这个调用就直接返回了，没有返回结果（分时处理）<br> <img src="https://images2.imgbox.com/d4/15/pwJpD6BH_o.png" alt="在这里插入图片描述"></p> 
<p>异步线程的方式审核文章</p> 
<h5><a id="52_Springboot_1063"></a>5.2 Springboot集成异步线程调用</h5> 
<p>①：在自动审核的方法上加上@Async注解（标明要异步调用）</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@Async</span>  <span class="token comment">//标明当前方法是一个异步方法</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">autoScanWmNews</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">//代码略</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>②：在文章发布成功后调用审核的方法</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">WmNewsAutoScanService</span> wmNewsAutoScanService<span class="token punctuation">;</span>

<span class="token comment">/**
 * 发布修改文章或保存为草稿
 * @param dto
 * @return
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ResponseResult</span> <span class="token function">submitNews</span><span class="token punctuation">(</span><span class="token class-name">WmNewsDto</span> dto<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">//代码略</span>

    <span class="token comment">//审核文章</span>
    wmNewsAutoScanService<span class="token punctuation">.</span><span class="token function">autoScanWmNews</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token class-name">ResponseResult</span><span class="token punctuation">.</span><span class="token function">okResult</span><span class="token punctuation">(</span><span class="token class-name">AppHttpCodeEnum</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>③：在自媒体引导类中使用@EnableAsync注解开启异步调用</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@MapperScan</span><span class="token punctuation">(</span><span class="token string">"com.heima.wemedia.mapper"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token string">"com.heima.apis"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableAsync</span>  <span class="token comment">//开启异步调用</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WemediaApplication</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">WemediaApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">MybatisPlusInterceptor</span> <span class="token function">mybatisPlusInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">MybatisPlusInterceptor</span> interceptor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MybatisPlusInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        interceptor<span class="token punctuation">.</span><span class="token function">addInnerInterceptor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PaginationInnerInterceptor</span><span class="token punctuation">(</span><span class="token class-name">DbType</span><span class="token punctuation">.</span><span class="token constant">MYSQL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> interceptor<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="6_1122"></a>6.文章审核功能-综合测试</h4> 
<h5><a id="61__1123"></a>6.1 服务启动列表</h5> 
<p>1，nacos服务端</p> 
<p>2，article微服务</p> 
<p>3，wemedia微服务</p> 
<p>4，启动wemedia网关微服务</p> 
<p>5，启动前端系统wemedia</p> 
<h5><a id="62__1135"></a>6.2 测试情况列表</h5> 
<p>1，自媒体前端发布一篇正常的文章<br> <img src="https://images2.imgbox.com/24/c0/wDCIztQ4_o.png" alt="在这里插入图片描述"></p> 
<p>审核成功后，app端的article相关数据是否可以正常保存，自媒体文章状态和app端文章id是否回显<br> <img src="https://images2.imgbox.com/43/19/wYSOawL7_o.png" alt="在这里插入图片描述"></p> 
<p>2，自媒体前端发布一篇包含敏感词的文章</p> 
<p>正常是审核失败， wm_news表中的状态是否改变，成功和失败原因正常保存</p> 
<p>3，自媒体前端发布一篇包含敏感图片的文章</p> 
<p>正常是审核失败， wm_news表中的状态是否改变，成功和失败原因正常保存</p> 
<p>最后我们测试一下异步调用出错，是否会影响发布文章本身。<br> 修改WmNewsAutoScanServiceImpl.java</p> 
<pre><code class="prism language-java"><span class="token comment">// 测试异步调用失败</span>
        <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/36/d5/35IrAbb1_o.png" alt="在这里插入图片描述"><br> 我们测试一下，再发布一篇文章<br> <img src="https://images2.imgbox.com/f7/20/A6EYROcZ_o.png" alt="在这里插入图片描述"><br> 发现文章发布成功<br> <img src="https://images2.imgbox.com/91/f9/HukXArnI_o.png" alt="在这里插入图片描述"></p> 
<p>由于是异步，首先返回了结果，但是事实上news表中有数据<br> <img src="https://images2.imgbox.com/e8/3a/xeEaCtmk_o.png" alt="在这里插入图片描述"><br> 而文章表没数据<br> <img src="https://images2.imgbox.com/66/da/Nu7n87TJ_o.png" alt="在这里插入图片描述"></p> 
<p>这是正确的，因为1/0是错误的算数运算。</p> 
<h4><a id="7_1172"></a>7.新需求-自管理敏感词</h4> 
<h5><a id="71__1173"></a>7.1 需求分析</h5> 
<p>文章审核功能已经交付了，文章也能正常发布审核。突然，产品经理过来说要开会。</p> 
<p>会议的内容核心有以下内容：</p> 
<ul><li> <p>文章审核不能过滤一些敏感词：</p> <p>私人侦探、针孔摄象、信用卡提现、广告代理、代开发票、刻章办、出售答案、小额贷款…</p> </li></ul> 
<p>需要完成的功能：</p> 
<p>需要自己维护一套敏感词，在文章审核的时候，需要验证文章是否包含这些敏感词</p> 
<h5><a id="72__1187"></a>7.2 敏感词-过滤</h5> 
<p>技术选型</p> 
<table><thead><tr><th><strong>方案</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td>数据库模糊查询</td><td>效率太低</td></tr><tr><td>String.indexOf(“”)查找</td><td>数据库量大的话也是比较慢</td></tr><tr><td>全文检索</td><td>分词再匹配</td></tr><tr><td>DFA算法</td><td>确定有穷自动机(一种数据结构)</td></tr></tbody></table> 
<h5><a id="73_DFA_1197"></a>7.3 DFA实现原理</h5> 
<p>DFA全称为：Deterministic Finite Automaton,即确定有穷自动机。</p> 
<p>存储：一次性的把所有的敏感词存储到了多个map中，就是下图表示这种结构</p> 
<p>敏感词：冰毒、大麻、大坏蛋<br> <img src="https://images2.imgbox.com/2f/06/VW8pf0K2_o.png" alt="在这里插入图片描述"></p> 
<p>检索的过程<br> <img src="https://images2.imgbox.com/02/73/3ySDeAns_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="74__1212"></a>7.4 自管理敏感词集成到文章审核中</h5> 
<p>①：创建敏感词表，导入资料中wm_sensitive到leadnews_wemedia库中<br> <img src="https://images2.imgbox.com/5e/ee/HUgUGlSc_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>model<span class="token punctuation">.</span>wemedia<span class="token punctuation">.</span>pojos</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">IdType</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">TableField</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">TableId</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">TableName</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Serializable</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * &lt;p&gt;
 * 敏感词信息表
 * &lt;/p&gt;
 *
 * @author itheima
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@TableName</span><span class="token punctuation">(</span><span class="token string">"wm_sensitive"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WmSensitive</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 主键
     */</span>
    <span class="token annotation punctuation">@TableId</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"id"</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token class-name">IdType</span><span class="token punctuation">.</span><span class="token constant">AUTO</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> id<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 敏感词
     */</span>
    <span class="token annotation punctuation">@TableField</span><span class="token punctuation">(</span><span class="token string">"sensitives"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> sensitives<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 创建时间
     */</span>
    <span class="token annotation punctuation">@TableField</span><span class="token punctuation">(</span><span class="token string">"created_time"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> createdTime<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>②：拷贝对应的wm_sensitive的mapper到项目中</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>wemedia<span class="token punctuation">.</span>mapper</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>core<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">BaseMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>model<span class="token punctuation">.</span>wemedia<span class="token punctuation">.</span>pojos<span class="token punctuation">.</span></span><span class="token class-name">WmSensitive</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">Mapper</span></span><span class="token punctuation">;</span>


<span class="token annotation punctuation">@Mapper</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">WmSensitiveMapper</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WmSensitive</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>
</code></pre> 
<p>③：在文章审核的代码中添加自管理敏感词审核</p> 
<p>第一：在WmNewsAutoScanServiceImpl中的autoScanWmNews方法上添加如下代码</p> 
<pre><code class="prism language-java"><span class="token comment">//从内容中提取纯文本内容和图片</span>
<span class="token comment">//.....省略</span>

<span class="token comment">//自管理的敏感词过滤</span>
<span class="token keyword">boolean</span> isSensitive <span class="token operator">=</span> <span class="token function">handleSensitiveScan</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> textAndImages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> wmNews<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isSensitive<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

<span class="token comment">//2.审核文本内容  阿里云接口</span>
<span class="token comment">//.....省略</span>
</code></pre> 
<p>新增自管理敏感词审核代码</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">WmSensitiveMapper</span> wmSensitiveMapper<span class="token punctuation">;</span>

<span class="token comment">/**
     * 自管理的敏感词审核
     * @param content
     * @param wmNews
     * @return
     */</span>
<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">handleSensitiveScan</span><span class="token punctuation">(</span><span class="token class-name">String</span> content<span class="token punctuation">,</span> <span class="token class-name">WmNews</span> wmNews<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token comment">//获取所有的敏感词</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WmSensitive</span><span class="token punctuation">&gt;</span></span> wmSensitives <span class="token operator">=</span> wmSensitiveMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span><span class="token class-name">Wrappers</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WmSensitive</span><span class="token punctuation">&gt;</span></span><span class="token function">lambdaQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token class-name">WmSensitive</span><span class="token operator">::</span><span class="token function">getSensitives</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> sensitiveList <span class="token operator">=</span> wmSensitives<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">WmSensitive</span><span class="token operator">::</span><span class="token function">getSensitives</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//初始化敏感词库</span>
    <span class="token class-name">SensitiveWordUtil</span><span class="token punctuation">.</span><span class="token function">initMap</span><span class="token punctuation">(</span>sensitiveList<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//查看文章中是否包含敏感词</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token class-name">SensitiveWordUtil</span><span class="token punctuation">.</span><span class="token function">matchWords</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">updateWmNews</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token string">"当前文章中存在违规内容"</span><span class="token operator">+</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
        flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> flag<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>测试一下，首先重启所有文章和自媒体微服务，带上敏感词<br> <img src="https://images2.imgbox.com/70/47/jhX5SFfA_o.png" alt="在这里插入图片描述"><br> 然后我们发布一下<br> <img src="https://images2.imgbox.com/b5/39/9cdnoBH8_o.png" alt="在这里插入图片描述"><br> 审核结果如下:<br> <img src="https://images2.imgbox.com/d4/ef/uE6Nd9yE_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="8_1333"></a>8.新需求-图片识别文字审核敏感词</h4> 
<h5><a id="81__1334"></a>8.1 需求分析</h5> 
<p>产品经理召集开会，文章审核功能已经交付了，文章也能正常发布审核。对于上次提出的自管理敏感词也很满意，这次会议核心的内容如下：</p> 
<ul><li>文章中包含的图片要识别文字，过滤掉图片文字的敏感词<br> <img src="https://images2.imgbox.com/8f/aa/jPnwJyom_o.png" alt="在这里插入图片描述"></li></ul> 
<h5><a id="82__1340"></a>8.2 图片文字识别</h5> 
<p>什么是OCR?</p> 
<p>OCR （Optical Character Recognition，光学字符识别）是指电子设备（例如扫描仪或数码相机）检查纸上打印的字符，通过检测暗、亮的模式确定其形状，然后用字符识别方法将形状翻译成计算机文字的过程</p> 
<table><thead><tr><th><strong>方案</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td>百度OCR</td><td>收费</td></tr><tr><td>Tesseract-OCR</td><td>Google维护的开源OCR引擎，支持Java，Python等语言调用</td></tr><tr><td>Tess4J</td><td>封装了Tesseract-OCR ，支持Java调用</td></tr></tbody></table> 
<p>具体的训练方式，请参考官方提供的文档: https://tesser act-ocr. github. io/ tessdoc/</p> 
<h5><a id="83_Tess4j_1356"></a>8.3 Tess4j案例</h5> 
<p>新建tess4j-demo放在heima-leadnews-test模块下<br> <img src="https://images2.imgbox.com/0a/36/9AYHhbnX_o.png" alt="在这里插入图片描述"></p> 
<p>①：创建项目导入tess4j对应的依赖</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>net.sourceforge.tess4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>tess4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.1.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>②：导入中文字体库， 把资料中的tessdata文件夹拷贝到自己的工作空间下<br> <img src="https://images2.imgbox.com/29/e4/I2Zl2yrq_o.png" alt="在这里插入图片描述"></p> 
<p>③：编写测试类进行测试</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>tess4j</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">net<span class="token punctuation">.</span>sourceforge<span class="token punctuation">.</span>tess4j<span class="token punctuation">.</span></span><span class="token class-name">ITesseract</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">net<span class="token punctuation">.</span>sourceforge<span class="token punctuation">.</span>tess4j<span class="token punctuation">.</span></span><span class="token class-name">Tesseract</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">File</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//获取本地图片</span>
            <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"D:\\26.png"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//创建Tesseract对象</span>
            <span class="token class-name">ITesseract</span> tesseract <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tesseract</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//设置字体库路径</span>
            tesseract<span class="token punctuation">.</span><span class="token function">setDatapath</span><span class="token punctuation">(</span><span class="token string">"D:\\workspace\\tessdata"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//中文识别</span>
            tesseract<span class="token punctuation">.</span><span class="token function">setLanguage</span><span class="token punctuation">(</span><span class="token string">"chi_sim"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//执行ocr识别</span>
            <span class="token class-name">String</span> result <span class="token operator">=</span> tesseract<span class="token punctuation">.</span><span class="token function">doOCR</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//替换回车和tal键  使结果为一行</span>
            result <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">"\\r|\\n"</span><span class="token punctuation">,</span><span class="token string">"-"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"识别的结果为："</span><span class="token operator">+</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>运行结果如下:<br> <img src="https://images2.imgbox.com/3f/32/XgmHSEBM_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="84__1409"></a>8.4 管理敏感词和图片文字识别集成到文章审核</h5> 
<p>①：在heima-leadnews-common中创建工具类，简单封装一下tess4j</p> 
<p>需要先导入pom</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>net.sourceforge.tess4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>tess4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.1.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>工具类</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>common<span class="token punctuation">.</span>tess4j</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Getter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Setter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">net<span class="token punctuation">.</span>sourceforge<span class="token punctuation">.</span>tess4j<span class="token punctuation">.</span></span><span class="token class-name">ITesseract</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">net<span class="token punctuation">.</span>sourceforge<span class="token punctuation">.</span>tess4j<span class="token punctuation">.</span></span><span class="token class-name">Tesseract</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">net<span class="token punctuation">.</span>sourceforge<span class="token punctuation">.</span>tess4j<span class="token punctuation">.</span></span><span class="token class-name">TesseractException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>context<span class="token punctuation">.</span>properties<span class="token punctuation">.</span></span><span class="token class-name">ConfigurationProperties</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>awt<span class="token punctuation">.</span>image<span class="token punctuation">.</span></span><span class="token class-name">BufferedImage</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Getter</span>
<span class="token annotation punctuation">@Setter</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"tess4j"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Tess4jClient</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> dataPath<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> language<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">doOCR</span><span class="token punctuation">(</span><span class="token class-name">BufferedImage</span> image<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TesseractException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//创建Tesseract对象</span>
        <span class="token class-name">ITesseract</span> tesseract <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tesseract</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置字体库路径</span>
        tesseract<span class="token punctuation">.</span><span class="token function">setDatapath</span><span class="token punctuation">(</span>dataPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//中文识别</span>
        tesseract<span class="token punctuation">.</span><span class="token function">setLanguage</span><span class="token punctuation">(</span>language<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//执行ocr识别</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> tesseract<span class="token punctuation">.</span><span class="token function">doOCR</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//替换回车和tal键  使结果为一行</span>
        result <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">"\\r|\\n"</span><span class="token punctuation">,</span> <span class="token string">"-"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>在spring.factories配置中添加该类,完整如下：</p> 
<pre><code class="prism language-java"><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span></span>EnableAutoConfiguration</span><span class="token operator">=</span>\
  <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>common<span class="token punctuation">.</span>exception<span class="token punctuation">.</span></span>ExceptionCatch</span><span class="token punctuation">,</span>\
  <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>common<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span></span>SwaggerConfiguration</span><span class="token punctuation">,</span>\
  <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>common<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span></span>Swagger2Configuration</span><span class="token punctuation">,</span>\
  <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>common<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span></span>GreenTextScan</span><span class="token punctuation">,</span>\
  <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>common<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span></span>GreenImageScan</span><span class="token punctuation">,</span>\
  <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>common<span class="token punctuation">.</span>tess4j<span class="token punctuation">.</span></span>Tess4jClient</span>
</code></pre> 
<p>②：在heima-leadnews-wemedia中的配置中添加两个属性<br> <img src="https://images2.imgbox.com/07/1c/T5Dzfhqs_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-yaml"><span class="token key atrule">tess4j</span><span class="token punctuation">:</span>
  <span class="token key atrule">data-path</span><span class="token punctuation">:</span> D<span class="token punctuation">:</span>\workspace\tessdata
  <span class="token key atrule">language</span><span class="token punctuation">:</span> chi_sim
</code></pre> 
<p>③：在WmNewsAutoScanServiceImpl中的handleImageScan方法上添加如下代码</p> 
<pre><code class="prism language-java"><span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> image <span class="token operator">:</span> images<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> fileStorageService<span class="token punctuation">.</span><span class="token function">downLoadFile</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//图片识别文字审核---begin-----</span>

        <span class="token comment">//从byte[]转换为butteredImage</span>
        <span class="token class-name">ByteArrayInputStream</span> in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BufferedImage</span> imageFile <span class="token operator">=</span> <span class="token class-name">ImageIO</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//识别图片的文字</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> tess4jClient<span class="token punctuation">.</span><span class="token function">doOCR</span><span class="token punctuation">(</span>imageFile<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//审核是否包含自管理的敏感词</span>
        <span class="token keyword">boolean</span> isSensitive <span class="token operator">=</span> <span class="token function">handleSensitiveScan</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> wmNews<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isSensitive<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> isSensitive<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//图片识别文字审核---end-----</span>


        imageList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>最后附上文章审核的完整代码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>wemedia<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSONArray</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>core<span class="token punctuation">.</span>toolkit<span class="token punctuation">.</span></span><span class="token class-name">Wrappers</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>apis<span class="token punctuation">.</span>article<span class="token punctuation">.</span></span><span class="token class-name">IArticleClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>common<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span></span><span class="token class-name">GreenImageScan</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>common<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span></span><span class="token class-name">GreenTextScan</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>common<span class="token punctuation">.</span>tess4j<span class="token punctuation">.</span></span><span class="token class-name">Tess4jClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>file<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">FileStorageService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>model<span class="token punctuation">.</span>article<span class="token punctuation">.</span>dtos<span class="token punctuation">.</span></span><span class="token class-name">ArticleDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>model<span class="token punctuation">.</span>common<span class="token punctuation">.</span>dtos<span class="token punctuation">.</span></span><span class="token class-name">ResponseResult</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>model<span class="token punctuation">.</span>wemedia<span class="token punctuation">.</span>pojos<span class="token punctuation">.</span></span><span class="token class-name">WmChannel</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>model<span class="token punctuation">.</span>wemedia<span class="token punctuation">.</span>pojos<span class="token punctuation">.</span></span><span class="token class-name">WmNews</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>model<span class="token punctuation">.</span>wemedia<span class="token punctuation">.</span>pojos<span class="token punctuation">.</span></span><span class="token class-name">WmSensitive</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>model<span class="token punctuation">.</span>wemedia<span class="token punctuation">.</span>pojos<span class="token punctuation">.</span></span><span class="token class-name">WmUser</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">SensitiveWordUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>wemedia<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">WmChannelMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>wemedia<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">WmNewsMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>wemedia<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">WmSensitiveMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>wemedia<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">WmUserMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>wemedia<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">WmNewsAutoScanService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span></span><span class="token class-name">StringUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">BeanUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>scheduling<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Async</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Transactional</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>imageio<span class="token punctuation">.</span></span><span class="token class-name">ImageIO</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>awt<span class="token punctuation">.</span>image<span class="token punctuation">.</span></span><span class="token class-name">BufferedImage</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ByteArrayInputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>stream<span class="token punctuation">.</span></span><span class="token class-name">Collectors</span></span><span class="token punctuation">;</span>


<span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WmNewsAutoScanServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">WmNewsAutoScanService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">WmNewsMapper</span> wmNewsMapper<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 自媒体文章审核
     *
     * @param id 自媒体文章id
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Async</span>  <span class="token comment">//标明当前方法是一个异步方法</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">autoScanWmNews</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

<span class="token comment">//        int a = 1/0;</span>

        <span class="token comment">//1.查询自媒体文章</span>
        <span class="token class-name">WmNews</span> wmNews <span class="token operator">=</span> wmNewsMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>wmNews <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"WmNewsAutoScanServiceImpl-文章不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>wmNews<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">WmNews<span class="token punctuation">.</span>Status</span><span class="token punctuation">.</span><span class="token constant">SUBMIT</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//从内容中提取纯文本内容和图片</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> textAndImages <span class="token operator">=</span> <span class="token function">handleTextAndImages</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//自管理的敏感词过滤</span>
            <span class="token keyword">boolean</span> isSensitive <span class="token operator">=</span> <span class="token function">handleSensitiveScan</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> textAndImages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> wmNews<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isSensitive<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

            <span class="token comment">//2.审核文本内容  阿里云接口</span>
            <span class="token keyword">boolean</span> isTextScan <span class="token operator">=</span> <span class="token function">handleTextScan</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> textAndImages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> wmNews<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isTextScan<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

            <span class="token comment">//3.审核图片  阿里云接口</span>
            <span class="token keyword">boolean</span> isImageScan <span class="token operator">=</span> <span class="token function">handleImageScan</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> textAndImages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"images"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> wmNews<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isImageScan<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

            <span class="token comment">//4.审核成功，保存app端的相关的文章数据</span>
            <span class="token class-name">ResponseResult</span> responseResult <span class="token operator">=</span> <span class="token function">saveAppArticle</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>responseResult<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"WmNewsAutoScanServiceImpl-文章审核，保存app端相关文章数据失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//回填article_id</span>
            wmNews<span class="token punctuation">.</span><span class="token function">setArticleId</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">)</span> responseResult<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">updateWmNews</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token string">"审核成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">WmSensitiveMapper</span> wmSensitiveMapper<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 自管理的敏感词审核
     * @param content
     * @param wmNews
     * @return
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">handleSensitiveScan</span><span class="token punctuation">(</span><span class="token class-name">String</span> content<span class="token punctuation">,</span> <span class="token class-name">WmNews</span> wmNews<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

        <span class="token comment">//获取所有的敏感词</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WmSensitive</span><span class="token punctuation">&gt;</span></span> wmSensitives <span class="token operator">=</span> wmSensitiveMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span><span class="token class-name">Wrappers</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WmSensitive</span><span class="token punctuation">&gt;</span></span><span class="token function">lambdaQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token class-name">WmSensitive</span><span class="token operator">::</span><span class="token function">getSensitives</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> sensitiveList <span class="token operator">=</span> wmSensitives<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">WmSensitive</span><span class="token operator">::</span><span class="token function">getSensitives</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//初始化敏感词库</span>
        <span class="token class-name">SensitiveWordUtil</span><span class="token punctuation">.</span><span class="token function">initMap</span><span class="token punctuation">(</span>sensitiveList<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//查看文章中是否包含敏感词</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token class-name">SensitiveWordUtil</span><span class="token punctuation">.</span><span class="token function">matchWords</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">updateWmNews</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token string">"当前文章中存在违规内容"</span><span class="token operator">+</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
            flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> flag<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">IArticleClient</span> articleClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">WmChannelMapper</span> wmChannelMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">WmUserMapper</span> wmUserMapper<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 保存app端相关的文章数据
     *
     * @param wmNews
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">ResponseResult</span> <span class="token function">saveAppArticle</span><span class="token punctuation">(</span><span class="token class-name">WmNews</span> wmNews<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token class-name">ArticleDto</span> dto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArticleDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//属性的拷贝</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">,</span> dto<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//文章的布局</span>
        dto<span class="token punctuation">.</span><span class="token function">setLayout</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//频道</span>
        <span class="token class-name">WmChannel</span> wmChannel <span class="token operator">=</span> wmChannelMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">.</span><span class="token function">getChannelId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>wmChannel <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            dto<span class="token punctuation">.</span><span class="token function">setChannelName</span><span class="token punctuation">(</span>wmChannel<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//作者</span>
        dto<span class="token punctuation">.</span><span class="token function">setAuthorId</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">WmUser</span> wmUser <span class="token operator">=</span> wmUserMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>wmUser <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            dto<span class="token punctuation">.</span><span class="token function">setAuthorName</span><span class="token punctuation">(</span>wmUser<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//设置文章id</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>wmNews<span class="token punctuation">.</span><span class="token function">getArticleId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            dto<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">.</span><span class="token function">getArticleId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        dto<span class="token punctuation">.</span><span class="token function">setCreatedTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ResponseResult</span> responseResult <span class="token operator">=</span> articleClient<span class="token punctuation">.</span><span class="token function">saveArticle</span><span class="token punctuation">(</span>dto<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> responseResult<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">FileStorageService</span> fileStorageService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">GreenImageScan</span> greenImageScan<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">Tess4jClient</span> tess4jClient<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 审核图片
     *
     * @param images
     * @param wmNews
     * @return
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">handleImageScan</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> images<span class="token punctuation">,</span> <span class="token class-name">WmNews</span> wmNews<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>images <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> images<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> flag<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//下载图片 minIO</span>
        <span class="token comment">//图片去重</span>
        images <span class="token operator">=</span> images<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">distinct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> imageList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> image <span class="token operator">:</span> images<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> fileStorageService<span class="token punctuation">.</span><span class="token function">downLoadFile</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//图片识别文字审核---begin-----</span>

                <span class="token comment">//从byte[]转换为butteredImage</span>
                <span class="token class-name">ByteArrayInputStream</span> in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">BufferedImage</span> imageFile <span class="token operator">=</span> <span class="token class-name">ImageIO</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//识别图片的文字</span>
                <span class="token class-name">String</span> result <span class="token operator">=</span> tess4jClient<span class="token punctuation">.</span><span class="token function">doOCR</span><span class="token punctuation">(</span>imageFile<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//审核是否包含自管理的敏感词</span>
                <span class="token keyword">boolean</span> isSensitive <span class="token operator">=</span> <span class="token function">handleSensitiveScan</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> wmNews<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isSensitive<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> isSensitive<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">//图片识别文字审核---end-----</span>


                imageList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token comment">//审核图片</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Map</span> map <span class="token operator">=</span> greenImageScan<span class="token punctuation">.</span><span class="token function">imageScan</span><span class="token punctuation">(</span>imageList<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//审核失败</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"suggestion"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"block"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token function">updateWmNews</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"当前文章中存在违规内容"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">//不确定信息  需要人工审核</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"suggestion"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"review"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token function">updateWmNews</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"当前文章中存在不确定内容"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> flag<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">GreenTextScan</span> greenTextScan<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 审核纯文本内容
     *
     * @param content
     * @param wmNews
     * @return
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">handleTextScan</span><span class="token punctuation">(</span><span class="token class-name">String</span> content<span class="token punctuation">,</span> <span class="token class-name">WmNews</span> wmNews<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"-"</span> <span class="token operator">+</span> content<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> flag<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Map</span> map <span class="token operator">=</span> greenTextScan<span class="token punctuation">.</span><span class="token function">greeTextScan</span><span class="token punctuation">(</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"-"</span> <span class="token operator">+</span> content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//审核失败</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"suggestion"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"block"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token function">updateWmNews</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"当前文章中存在违规内容"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">//不确定信息  需要人工审核</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"suggestion"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"review"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token function">updateWmNews</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"当前文章中存在不确定内容"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> flag<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 修改文章内容
     *
     * @param wmNews
     * @param status
     * @param reason
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">updateWmNews</span><span class="token punctuation">(</span><span class="token class-name">WmNews</span> wmNews<span class="token punctuation">,</span> <span class="token keyword">short</span> status<span class="token punctuation">,</span> <span class="token class-name">String</span> reason<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        wmNews<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        wmNews<span class="token punctuation">.</span><span class="token function">setReason</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
        wmNewsMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 1。从自媒体文章的内容中提取文本和图片
     * 2.提取文章的封面图片
     *
     * @param wmNews
     * @return
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">handleTextAndImages</span><span class="token punctuation">(</span><span class="token class-name">WmNews</span> wmNews<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token comment">//存储纯文本内容</span>
        <span class="token class-name">StringBuilder</span> stringBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> images <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//1。从自媒体文章的内容中提取文本和图片</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&gt;</span></span> maps <span class="token operator">=</span> <span class="token class-name">JSONArray</span><span class="token punctuation">.</span><span class="token function">parseArray</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map</span> map <span class="token operator">:</span> maps<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"text"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    stringBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"image"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    images<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//2.提取文章的封面图片</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>wmNews<span class="token punctuation">.</span><span class="token function">getImages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> split <span class="token operator">=</span> wmNews<span class="token punctuation">.</span><span class="token function">getImages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            images<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>split<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> resultMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">,</span> stringBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"images"</span><span class="token punctuation">,</span> images<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> resultMap<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上传一次违规图片测试一下<br> <img src="https://images2.imgbox.com/f1/6d/3J3a2QqY_o.png" alt="在这里插入图片描述"><br> 发现没有问题<br> <img src="https://images2.imgbox.com/e7/9a/V7RJBkW9_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="9_1869"></a>9.文章详情-静态文件生成</h4> 
<h5><a id="91__1870"></a>9.1 思路分析</h5> 
<p>文章端创建app相关文章时，生成文章详情静态页上传到MinIO中<br> <img src="https://images2.imgbox.com/88/9f/DWrfwoHD_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="92__1873"></a>9.2 实现步骤</h5> 
<p>1.新建ArticleFreemarkerService创建静态文件并上传到minIO中</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>article<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>model<span class="token punctuation">.</span>article<span class="token punctuation">.</span>pojos<span class="token punctuation">.</span></span><span class="token class-name">ApArticle</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ArticleFreemarkerService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 生成静态文件上传到minIO中
     * @param apArticle
     * @param content
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">buildArticleToMinIO</span><span class="token punctuation">(</span><span class="token class-name">ApArticle</span> apArticle<span class="token punctuation">,</span><span class="token class-name">String</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>实现</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>article<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSON</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSONArray</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>core<span class="token punctuation">.</span>toolkit<span class="token punctuation">.</span></span><span class="token class-name">Wrappers</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>article<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">ApArticleContentMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>article<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">ApArticleService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>article<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">ArticleFreemarkerService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>file<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">FileStorageService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>model<span class="token punctuation">.</span>article<span class="token punctuation">.</span>pojos<span class="token punctuation">.</span></span><span class="token class-name">ApArticle</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">freemarker<span class="token punctuation">.</span>template<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">freemarker<span class="token punctuation">.</span>template<span class="token punctuation">.</span></span><span class="token class-name">Template</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span></span><span class="token class-name">StringUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">BeanUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>scheduling<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Async</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Transactional</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ByteArrayInputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">InputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">StringWriter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ArticleFreemarkerServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">ArticleFreemarkerService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ApArticleContentMapper</span> apArticleContentMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">Configuration</span> configuration<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">FileStorageService</span> fileStorageService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ApArticleService</span> apArticleService<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 生成静态文件上传到minIO中
     * @param apArticle
     * @param content
     */</span>
    <span class="token annotation punctuation">@Async</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">buildArticleToMinIO</span><span class="token punctuation">(</span><span class="token class-name">ApArticle</span> apArticle<span class="token punctuation">,</span> <span class="token class-name">String</span> content<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//已知文章的id</span>
        <span class="token comment">//4.1 获取文章内容</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">//4.2 文章内容通过freemarker生成html文件</span>
            <span class="token class-name">Template</span> template <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token class-name">StringWriter</span> out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                template <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getTemplate</span><span class="token punctuation">(</span><span class="token string">"article.ftl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//数据模型</span>
                <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> contentDataModel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                contentDataModel<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">,</span> <span class="token class-name">JSONArray</span><span class="token punctuation">.</span><span class="token function">parseArray</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//合成</span>
                template<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>contentDataModel<span class="token punctuation">,</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">//4.3 把html文件上传到minio中</span>
            <span class="token class-name">InputStream</span> in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>out<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> path <span class="token operator">=</span> fileStorageService<span class="token punctuation">.</span><span class="token function">uploadHtmlFile</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> apArticle<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".html"</span><span class="token punctuation">,</span> in<span class="token punctuation">)</span><span class="token punctuation">;</span>


            <span class="token comment">//4.4 修改ap_article表，保存static_url字段</span>
            apArticleService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Wrappers</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApArticle</span><span class="token punctuation">&gt;</span></span><span class="token function">lambdaUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">ApArticle</span><span class="token operator">::</span><span class="token function">getId</span><span class="token punctuation">,</span>apArticle<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">ApArticle</span><span class="token operator">::</span><span class="token function">getStaticUrl</span><span class="token punctuation">,</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>2.在ApArticleService的saveArticle实现方法中添加调用生成文件的方法</p> 
<pre><code class="prism language-java"><span class="token comment">/**
     * 保存app端相关文章
     * @param dto
     * @return
     */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ResponseResult</span> <span class="token function">saveArticle</span><span class="token punctuation">(</span><span class="token class-name">ArticleDto</span> dto<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">//        try {<!-- --></span>
    <span class="token comment">//            Thread.sleep(3000);</span>
    <span class="token comment">//        } catch (InterruptedException e) {<!-- --></span>
    <span class="token comment">//            e.printStackTrace();</span>
    <span class="token comment">//        }</span>
    <span class="token comment">//1.检查参数</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>dto <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">ResponseResult</span><span class="token punctuation">.</span><span class="token function">errorResult</span><span class="token punctuation">(</span><span class="token class-name">AppHttpCodeEnum</span><span class="token punctuation">.</span><span class="token constant">PARAM_INVALID</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">ApArticle</span> apArticle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApArticle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>dto<span class="token punctuation">,</span>apArticle<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//2.判断是否存在id</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">//2.1 不存在id  保存  文章  文章配置  文章内容</span>

        <span class="token comment">//保存文章</span>
        <span class="token function">save</span><span class="token punctuation">(</span>apArticle<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//保存配置</span>
        <span class="token class-name">ApArticleConfig</span> apArticleConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApArticleConfig</span><span class="token punctuation">(</span>apArticle<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        apArticleConfigMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>apArticleConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//保存 文章内容</span>
        <span class="token class-name">ApArticleContent</span> apArticleContent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApArticleContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        apArticleContent<span class="token punctuation">.</span><span class="token function">setArticleId</span><span class="token punctuation">(</span>apArticle<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        apArticleContent<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        apArticleContentMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>apArticleContent<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//2.2 存在id   修改  文章  文章内容</span>

        <span class="token comment">//修改  文章</span>
        <span class="token function">updateById</span><span class="token punctuation">(</span>apArticle<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//修改文章内容</span>
        <span class="token class-name">ApArticleContent</span> apArticleContent <span class="token operator">=</span> apArticleContentMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token class-name">Wrappers</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApArticleContent</span><span class="token punctuation">&gt;</span></span><span class="token function">lambdaQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">ApArticleContent</span><span class="token operator">::</span><span class="token function">getArticleId</span><span class="token punctuation">,</span> dto<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        apArticleContent<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        apArticleContentMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>apArticleContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//异步调用 生成静态文件上传到minio中</span>
    articleFreemarkerService<span class="token punctuation">.</span><span class="token function">buildArticleToMinIO</span><span class="token punctuation">(</span>apArticle<span class="token punctuation">,</span>dto<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">//3.结果返回  文章的id</span>
    <span class="token keyword">return</span> <span class="token class-name">ResponseResult</span><span class="token punctuation">.</span><span class="token function">okResult</span><span class="token punctuation">(</span>apArticle<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>3.文章微服务开启异步调用<br> <img src="https://images2.imgbox.com/e5/78/8DM8ctBe_o.png" alt="在这里插入图片描述"><br> 我们发布一篇文章<br> <img src="https://images2.imgbox.com/03/3c/sYbnLXZ2_o.png" alt="在这里插入图片描述"><br> 数据库插入成功leadnews_article.ap_article<br> <img src="https://images2.imgbox.com/8c/25/cC6HDQGe_o.png" alt="在这里插入图片描述"><br> 访问这个URL，访问成功<br> <img src="https://images2.imgbox.com/c1/17/aVWKGBoR_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="10_2051"></a>10.今日作业以及思考</h2> 
<p><img src="https://images2.imgbox.com/ff/c7/szyHIE19_o.png" alt="在这里插入图片描述"><br> 这道作业题，后续更新(AT模式)</p> 
<p><img src="https://images2.imgbox.com/bc/8a/vy5k06nf_o.png" alt="在这里插入图片描述"></p> 
<p>这个思考题第五天课程解决。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/447bf403121f3ef24855c6ceea1e1a6b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">格利尔实习经历记录（2023.6.30-7.10）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/681288e6e379d43ae5340d7211b93158/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">简单尝试将go项目用宝塔部署到服务器</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>