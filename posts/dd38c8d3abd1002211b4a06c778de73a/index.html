<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>6.830 / 6.814: Syllabus 2021 - MIT Lab 1 - SimpleDB - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="6.830 / 6.814: Syllabus 2021 - MIT Lab 1 - SimpleDB" />
<meta property="og:description" content="文章目录 1.参考链接：2.SimpleDB Architecture and Implementation Guide2.2Fields and Tuples2.3Catalog2.4BufferPool2.5HeapFile access method2.6Operators 1.参考链接： 1.1 课程链接：http://db.lcs.mit.edu/6.830/assign.php
1.2 lab1链接：https://gitee.com/zhou-zhiqiang/db-class/blob/master/lab1.md
1.3 HearmingBear Lab1链接：https://blog.csdn.net/hjw199666/article/details/103486328
1.4 我的仓库地址：https://gitee.com/zhou-zhiqiang/db-class
2.SimpleDB Architecture and Implementation Guide 2.2Fields and Tuples src/java/simpledb/storage/TupleDesc.java
package simpledb.storage; import simpledb.common.Type; import java.io.Serializable; import java.util.Arrays; import java.util.Iterator; import java.util.NoSuchElementException; /** * TupleDesc describes the schema of a tuple. * */ public class TupleDesc implements Serializable { /** * the parameter used to hold tuple * */ private final TDItem[] tdItems; /** * A help class to facilitate organizing the information of each field * * */ public static class TDItem implements Serializable { private static final long serialVersionUID = 1L; /** * The type of the field * * */ public final Type fieldType; /** * The name of the field * * */ public final String fieldName; public TDItem(Type t, String n) { this." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/dd38c8d3abd1002211b4a06c778de73a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-07-10T22:26:07+08:00" />
<meta property="article:modified_time" content="2021-07-10T22:26:07+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">6.830 / 6.814: Syllabus 2021 - MIT Lab 1 - SimpleDB</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><ul><li><a href="#1_5" rel="nofollow">1.参考链接：</a></li><li><a href="#2SimpleDB_Architecture_and_Implementation_Guide_11" rel="nofollow">2.SimpleDB Architecture and Implementation Guide</a></li><li><ul><li><a href="#22Fields_and_Tuples_12" rel="nofollow">2.2Fields and Tuples</a></li><li><a href="#23Catalog_432" rel="nofollow">2.3Catalog</a></li><li><a href="#24BufferPool_668" rel="nofollow">2.4BufferPool</a></li><li><a href="#25HeapFile_access_method_722" rel="nofollow">2.5HeapFile access method</a></li><li><a href="#26Operators_1459" rel="nofollow">2.6Operators</a></li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h4><a id="1_5"></a>1.参考链接：</h4> 
<p>1.1 课程链接：<a href="http://db.lcs.mit.edu/6.830/assign.php" rel="nofollow">http://db.lcs.mit.edu/6.830/assign.php</a><br> 1.2 lab1链接：<a href="https://gitee.com/zhou-zhiqiang/db-class/blob/master/lab1.md" rel="nofollow">https://gitee.com/zhou-zhiqiang/db-class/blob/master/lab1.md</a><br> 1.3 HearmingBear Lab1链接：<a href="https://blog.csdn.net/hjw199666/article/details/103486328">https://blog.csdn.net/hjw199666/article/details/103486328</a><br> 1.4 我的仓库地址：<a href="https://gitee.com/zhou-zhiqiang/db-class" rel="nofollow">https://gitee.com/zhou-zhiqiang/db-class</a></p> 
<h4><a id="2SimpleDB_Architecture_and_Implementation_Guide_11"></a>2.SimpleDB Architecture and Implementation Guide</h4> 
<h5><a id="22Fields_and_Tuples_12"></a>2.2Fields and Tuples</h5> 
<p>src/java/simpledb/storage/TupleDesc.java</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">;</span>

<span class="token keyword">import</span> simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span>Type<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>Serializable<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Arrays<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Iterator<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>NoSuchElementException<span class="token punctuation">;</span>

<span class="token comment">/**
 * TupleDesc describes the schema of a tuple.
 *
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TupleDesc</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * the parameter used to hold tuple
     * */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> TDItem<span class="token punctuation">[</span><span class="token punctuation">]</span> tdItems<span class="token punctuation">;</span>

    <span class="token comment">/**
     * A help class to facilitate organizing the information of each field
     *
     * */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">TDItem</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1</span>L<span class="token punctuation">;</span>

        <span class="token comment">/**
         * The type of the field
         *
         * */</span>
        <span class="token keyword">public</span> <span class="token keyword">final</span> Type fieldType<span class="token punctuation">;</span>

        <span class="token comment">/**
         * The name of the field
         *
         * */</span>
        <span class="token keyword">public</span> <span class="token keyword">final</span> String fieldName<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token function">TDItem</span><span class="token punctuation">(</span>Type t<span class="token punctuation">,</span> String n<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>fieldName <span class="token operator">=</span> n<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>fieldType <span class="token operator">=</span> t<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> fieldName <span class="token operator">+</span> <span class="token string">"("</span> <span class="token operator">+</span> fieldType <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return
     * An iterator which iterates over all the field TDItems that are included in this TupleDesc
     *
     * */</span>
    <span class="token keyword">public</span> Iterator<span class="token generics function"><span class="token punctuation">&lt;</span>TDItem<span class="token punctuation">&gt;</span></span> <span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>Iterator<span class="token generics function"><span class="token punctuation">&lt;</span>TDItem<span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>tdItems<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1</span>L<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Create a new TupleDesc with typeAr.length fields with fields of the specified types, with associated named fields.
     *
     * @param typeAr
     *            array specifying the number of and types of fields in this
     *            TupleDesc. It must contain at least one entry.
     * @param fieldAr
     *            array specifying the names of the fields. Note that names may
     *            be null.
     */</span>
    <span class="token keyword">public</span> <span class="token function">TupleDesc</span><span class="token punctuation">(</span>Type<span class="token punctuation">[</span><span class="token punctuation">]</span> typeAr<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> fieldAr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        tdItems <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TDItem</span><span class="token punctuation">[</span>typeAr<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> typeAr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            tdItems<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TDItem</span><span class="token punctuation">(</span>typeAr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>fieldAr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Constructor. Create a new tuple desc with typeAr.length fields with
     * fields of the specified types, with anonymous (unnamed) fields.
     *
     * @param typeAr
     *            array specifying the number of and types of fields in this
     *            TupleDesc. It must contain at least one entry.
     */</span>
    <span class="token keyword">public</span> <span class="token function">TupleDesc</span><span class="token punctuation">(</span>Type<span class="token punctuation">[</span><span class="token punctuation">]</span> typeAr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        tdItems <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TDItem</span><span class="token punctuation">[</span>typeAr<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> typeAr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            tdItems<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TDItem</span><span class="token punctuation">(</span>typeAr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return the number of fields in this TupleDesc
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">numFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> tdItems<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Gets the (possibly null) field name of the ith field of this TupleDesc.
     *
     * @param i
     *            index of the field name to return. It must be a valid index.
     * @return the name of the ith field
     * @throws NoSuchElementException
     *             if i is not a valid field reference.
     */</span>
    <span class="token keyword">public</span> String <span class="token function">getFieldName</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token keyword">throws</span> NoSuchElementException <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> tdItems<span class="token punctuation">.</span>length <span class="token operator">||</span> i <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchElementException</span><span class="token punctuation">(</span><span class="token string">"pos "</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">" is not a valid index"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> tdItems<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fieldName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>




    <span class="token comment">/**
     * Gets the type of the ith field of this TupleDesc.
     *
     * @param i
     *            The index of the field to get the type of. It must be a valid
     *            index.
     * @return the type of the ith field
     * @throws NoSuchElementException
     *             if i is not a valid field reference.
     */</span>
    <span class="token keyword">public</span> Type <span class="token function">getFieldType</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token keyword">throws</span> NoSuchElementException <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> tdItems<span class="token punctuation">.</span>length <span class="token operator">||</span> i <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchElementException</span><span class="token punctuation">(</span><span class="token string">"pos "</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">" is not a valid index"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> tdItems<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fieldType<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Find the index of the field with a given name.
     *
     * @param name
     *            name of the field.
     * @return the index of the field that is first to have the given name.
     * @throws NoSuchElementException
     *             if no field with a matching name is found.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">fieldNameToIndex</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token keyword">throws</span> NoSuchElementException <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> tdItems<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tdItems<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fieldName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> i<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchElementException</span><span class="token punctuation">(</span><span class="token string">"not find filedName "</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return The size (in bytes) of tuples corresponding to this TupleDesc.
     *         Note that tuples from a given TupleDesc are of a fixed size.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> tdItems<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            size <span class="token operator">+=</span> tdItems<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fieldType<span class="token punctuation">.</span><span class="token function">getLen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> size<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Merge two TupleDescs into one, with td1.numFields + td2.numFields fields,
     * with the first td1.numFields coming from td1 and the remaining from td2.
     *
     * @param td1
     *            The TupleDesc with the first fields of the new TupleDesc
     * @param td2
     *            The TupleDesc with the last fields of the TupleDesc
     * @return the new TupleDesc
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> TupleDesc <span class="token function">merge</span><span class="token punctuation">(</span>TupleDesc td1<span class="token punctuation">,</span> TupleDesc td2<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">int</span> n <span class="token operator">=</span> td1<span class="token punctuation">.</span><span class="token function">numFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> td2<span class="token punctuation">.</span><span class="token function">numFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Type<span class="token punctuation">[</span><span class="token punctuation">]</span> type <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Type</span><span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">;</span>
        String<span class="token punctuation">[</span><span class="token punctuation">]</span> strings <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> td1<span class="token punctuation">.</span><span class="token function">numFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            type<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> td1<span class="token punctuation">.</span><span class="token function">getFieldType</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            strings<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> td1<span class="token punctuation">.</span><span class="token function">getFieldName</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            index<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> td2<span class="token punctuation">.</span><span class="token function">numFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            type<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> td2<span class="token punctuation">.</span><span class="token function">getFieldType</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            strings<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> td2<span class="token punctuation">.</span><span class="token function">getFieldName</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            index<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TupleDesc</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span>strings<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Compares the specified object with this TupleDesc for equality. Two
     * TupleDescs are considered equal if they have the same number of items
     * and if the i-th type in this TupleDesc is equal to the i-th type in o
     * for every i.
     *
     * @param o
     *            the Object to be compared for equality with this TupleDesc.
     * @return true if the object is equal to this TupleDesc.
     */</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span>Object o<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInstance</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            TupleDesc two <span class="token operator">=</span> <span class="token punctuation">(</span>TupleDesc<span class="token punctuation">)</span> o<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">numFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> two<span class="token punctuation">.</span><span class="token function">numFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">numFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tdItems<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fieldType<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>two<span class="token punctuation">.</span>tdItems<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fieldType<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// If you want to use TupleDesc as keys for HashMap, implement this so</span>
        <span class="token comment">// that equal objects have equals hashCode() results</span>
<span class="token comment">//        int h = 0;</span>
<span class="token comment">//        for (int i = 0; i &lt; tdItems.length; i++){<!-- --></span>
<span class="token comment">//            h = 31 * h + tdItems[i].toString().hashCode();</span>
<span class="token comment">//        }</span>
<span class="token comment">//        return h;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token string">"unimplemented"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Returns a String describing this descriptor. It should be of the form
     * "fieldType[0](fieldName[0]), ..., fieldType[M](fieldName[M])", although
     * the exact format does not matter.
     *
     * @return String describing this descriptor.
     */</span>
    <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        StringBuilder stringBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> tdItems<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            stringBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>tdItems<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">", "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        stringBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>tdItems<span class="token punctuation">[</span>tdItems<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> stringBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>变量定义：<br> private final TDItem[] tdItems;//描述元组的列字段<br> 关键方法：<br> merge：合并两个元组</p> 
<p>src/java/simpledb/storage/Tuple.java</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>Serializable<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Arrays<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Iterator<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Objects<span class="token punctuation">;</span>

<span class="token comment">/**
 * Tuple maintains information about the contents of a tuple. Tuples have a
 * specified schema specified by a TupleDesc object and contain Field objects
 * with the data for each field.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Tuple</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1</span>L<span class="token punctuation">;</span>
    <span class="token keyword">private</span> TupleDesc tupleDesc<span class="token punctuation">;</span>
    <span class="token keyword">private</span> RecordId recordId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> Field<span class="token punctuation">[</span><span class="token punctuation">]</span> fields<span class="token punctuation">;</span>
    <span class="token comment">/**
     * Create a new tuple with the specified schema (type).
     *
     * @param td
     *            the schema of this tuple. It must be a valid TupleDesc
     *            instance with at least one field.
     */</span>
    <span class="token keyword">public</span> <span class="token function">Tuple</span><span class="token punctuation">(</span>TupleDesc td<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        tupleDesc <span class="token operator">=</span> td<span class="token punctuation">;</span>
        fields <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Field</span><span class="token punctuation">[</span>td<span class="token punctuation">.</span><span class="token function">numFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return The TupleDesc representing the schema of this tuple.
     */</span>
    <span class="token keyword">public</span> TupleDesc <span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> tupleDesc<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return The RecordId representing the location of this tuple on disk. May
     *         be null.
     */</span>
    <span class="token keyword">public</span> RecordId <span class="token function">getRecordId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> recordId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Set the RecordId information for this tuple.
     *
     * @param rid
     *            the new RecordId for this tuple.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setRecordId</span><span class="token punctuation">(</span>RecordId rid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        recordId <span class="token operator">=</span> rid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Change the value of the ith field of this tuple.
     *
     * @param i
     *            index of the field to change. It must be a valid index.
     * @param f
     *            new value for the field.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setField</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> Field f<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        fields<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> f<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return the value of the ith field, or null if it has not been set.
     *
     * @param i
     *            field index to return. Must be a valid index.
     */</span>
    <span class="token keyword">public</span> Field <span class="token function">getField</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> fields<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Returns the contents of this Tuple as a string. Note that to pass the
     * system tests, the format needs to be as follows:
     *
     * column1\tcolumn2\tcolumn3\t...\tcolumnN
     *
     * where \t is any whitespace (except a newline)
     */</span>
    <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        StringBuilder sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> tupleDesc<span class="token punctuation">.</span><span class="token function">numFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"\t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span>tupleDesc<span class="token punctuation">.</span><span class="token function">numFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return
     *        An iterator which iterates over all the fields of this tuple
     * */</span>
    <span class="token keyword">public</span> Iterator<span class="token generics function"><span class="token punctuation">&lt;</span>Field<span class="token punctuation">&gt;</span></span> <span class="token function">fields</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>Iterator<span class="token generics function"><span class="token punctuation">&lt;</span>Field<span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>fields<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * reset the TupleDesc of this tuple (only affecting the TupleDesc)
     * */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">resetTupleDesc</span><span class="token punctuation">(</span>TupleDesc td<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        tupleDesc <span class="token operator">=</span> td<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span>Object o<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">==</span> o<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> o<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        Tuple tuple <span class="token operator">=</span> <span class="token punctuation">(</span>Tuple<span class="token punctuation">)</span> o<span class="token punctuation">;</span>
        <span class="token keyword">return</span> Objects<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>tupleDesc<span class="token punctuation">,</span> tuple<span class="token punctuation">.</span>tupleDesc<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> Objects<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>recordId<span class="token punctuation">,</span> tuple<span class="token punctuation">.</span>recordId<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> Arrays<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>fields<span class="token punctuation">,</span> tuple<span class="token punctuation">.</span>fields<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> result <span class="token operator">=</span> Objects<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span>tupleDesc<span class="token punctuation">,</span> recordId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        result <span class="token operator">=</span> <span class="token number">31</span> <span class="token operator">*</span> result <span class="token operator">+</span> Arrays<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span>fields<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>变量定义：<br> private TupleDesc tupleDesc;//元组描述<br> private RecordId recordId;//记录id<br> private final Field[] fields;//字段值数组</p> 
<p>ant runtest -Dtest=TupleDescTest<br> BUILD SUCCESSFUL<br> ant runtest -Dtest=TupleTest<br> BUILD FAILED</p> 
<h5><a id="23Catalog_432"></a>2.3Catalog</h5> 
<p>src/java/simpledb/common/Catalog.java</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> simpledb<span class="token punctuation">.</span>common<span class="token punctuation">;</span>

<span class="token keyword">import</span> simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>DbFile<span class="token punctuation">;</span>
<span class="token keyword">import</span> simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>HeapFile<span class="token punctuation">;</span>
<span class="token keyword">import</span> simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>TupleDesc<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>BufferedReader<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>File<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>FileReader<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>ArrayList<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Iterator<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>NoSuchElementException<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>UUID<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>ConcurrentHashMap<span class="token punctuation">;</span>

<span class="token comment">/**
 * The Catalog keeps track of all available tables in the database and their
 * associated schemas.
 * For now, this is a stub catalog that must be populated with tables by a
 * user program before it can be used -- eventually, this should be converted
 * to a catalog that reads a catalog table from disk.
 * 
 * @Threadsafe
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Catalog</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> ConcurrentHashMap<span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">,</span>Table<span class="token punctuation">&gt;</span></span> hashTable<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Table</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1</span>L<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">final</span> DbFile dbFile<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">final</span> String tableName<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">final</span> String pk<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token function">Table</span><span class="token punctuation">(</span>DbFile file<span class="token punctuation">,</span>String name<span class="token punctuation">,</span>String pkeyField<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            dbFile <span class="token operator">=</span> file<span class="token punctuation">;</span>
            tableName <span class="token operator">=</span> name<span class="token punctuation">;</span>
            pk <span class="token operator">=</span> pkeyField<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> tableName <span class="token operator">+</span> <span class="token string">"("</span> <span class="token operator">+</span> dbFile<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> pk <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * Constructor.
     * Creates a new, empty catalog.
     */</span>
    <span class="token keyword">public</span> <span class="token function">Catalog</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        hashTable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Add a new table to the catalog.
     * This table's contents are stored in the specified DbFile.
     * @param file the contents of the table to add;  file.getId() is the identfier of
     *    this file/tupledesc param for the calls getTupleDesc and getFile
     * @param name the name of the table -- may be an empty string.  May not be null.  If a name
     * conflict exists, use the last table to be added as the table for a given name.
     * @param pkeyField the name of the primary key field
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addTable</span><span class="token punctuation">(</span>DbFile file<span class="token punctuation">,</span> String name<span class="token punctuation">,</span> String pkeyField<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        Table t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Table</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span>name<span class="token punctuation">,</span>pkeyField<span class="token punctuation">)</span><span class="token punctuation">;</span>
        hashTable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addTable</span><span class="token punctuation">(</span>DbFile file<span class="token punctuation">,</span> String name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">addTable</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Add a new table to the catalog.
     * This table has tuples formatted using the specified TupleDesc and its
     * contents are stored in the specified DbFile.
     * @param file the contents of the table to add;  file.getId() is the identfier of
     *    this file/tupledesc param for the calls getTupleDesc and getFile
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addTable</span><span class="token punctuation">(</span>DbFile file<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">addTable</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token punctuation">(</span>UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return the id of the table with a specified name,
     * @throws NoSuchElementException if the table doesn't exist
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getTableId</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token keyword">throws</span> NoSuchElementException <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        Integer res <span class="token operator">=</span> hashTable<span class="token punctuation">.</span><span class="token function">searchValues</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>value<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>tableName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> value<span class="token punctuation">.</span>dbFile<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>res <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchElementException</span><span class="token punctuation">(</span><span class="token string">"not found id for table "</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Returns the tuple descriptor (schema) of the specified table
     * @param tableid The id of the table, as specified by the DbFile.getId()
     *     function passed to addTable
     * @throws NoSuchElementException if the table doesn't exist
     */</span>
    <span class="token keyword">public</span> TupleDesc <span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token keyword">int</span> tableid<span class="token punctuation">)</span> <span class="token keyword">throws</span> NoSuchElementException <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        Table t <span class="token operator">=</span> hashTable<span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span>tableid<span class="token punctuation">,</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> t<span class="token punctuation">.</span>dbFile<span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchElementException</span><span class="token punctuation">(</span><span class="token string">"not found tuple desc for table "</span> <span class="token operator">+</span> tableid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Returns the DbFile that can be used to read the contents of the
     * specified table.
     * @param tableid The id of the table, as specified by the DbFile.getId()
     *     function passed to addTable
     */</span>
    <span class="token keyword">public</span> DbFile <span class="token function">getDatabaseFile</span><span class="token punctuation">(</span><span class="token keyword">int</span> tableid<span class="token punctuation">)</span> <span class="token keyword">throws</span> NoSuchElementException <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        Table t <span class="token operator">=</span> hashTable<span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span>tableid<span class="token punctuation">,</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> t<span class="token punctuation">.</span>dbFile<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchElementException</span><span class="token punctuation">(</span><span class="token string">"not found db file for table "</span> <span class="token operator">+</span> tableid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> String <span class="token function">getPrimaryKey</span><span class="token punctuation">(</span><span class="token keyword">int</span> tableid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        Table t <span class="token operator">=</span> hashTable<span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span>tableid<span class="token punctuation">,</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> t<span class="token punctuation">.</span>pk<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchElementException</span><span class="token punctuation">(</span><span class="token string">"not found primary key for table "</span> <span class="token operator">+</span> tableid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> Iterator<span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">&gt;</span></span> <span class="token function">tableIdIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> hashTable<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> String <span class="token function">getTableName</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        Table t <span class="token operator">=</span> hashTable<span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> t<span class="token punctuation">.</span>tableName<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchElementException</span><span class="token punctuation">(</span><span class="token string">"not found name for table "</span> <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/** Delete all tables from the catalog */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        hashTable<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/**
     * Reads the schema from a file and creates the appropriate tables in the database.
     * @param catalogFile
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">loadSchema</span><span class="token punctuation">(</span>String catalogFile<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        String line <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
        String baseFolder<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>catalogFile<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            BufferedReader br <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span>catalogFile<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>line <span class="token operator">=</span> br<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//assume line is of the format name (field type, field type, ...)</span>
                String name <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> line<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"("</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//System.out.println("TABLE NAME: " + name);</span>
                String fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>line<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"("</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> line<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">")"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                String<span class="token punctuation">[</span><span class="token punctuation">]</span> els <span class="token operator">=</span> fields<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">&gt;</span></span> names <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Type<span class="token punctuation">&gt;</span></span> types <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                String primaryKey <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>String e <span class="token operator">:</span> els<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    String<span class="token punctuation">[</span><span class="token punctuation">]</span> els2 <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    names<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>els2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>els2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span><span class="token string">"int"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        types<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>Type<span class="token punctuation">.</span>INT_TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>els2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span><span class="token string">"string"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        types<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>Type<span class="token punctuation">.</span>STRING_TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Unknown type "</span> <span class="token operator">+</span> els2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        System<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>els2<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>els2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"pk"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            primaryKey <span class="token operator">=</span> els2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Unknown annotation "</span> <span class="token operator">+</span> els2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            System<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                Type<span class="token punctuation">[</span><span class="token punctuation">]</span> typeAr <span class="token operator">=</span> types<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Type</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                String<span class="token punctuation">[</span><span class="token punctuation">]</span> namesAr <span class="token operator">=</span> names<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                TupleDesc t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TupleDesc</span><span class="token punctuation">(</span>typeAr<span class="token punctuation">,</span> namesAr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                HeapFile tabHf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HeapFile</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>baseFolder<span class="token operator">+</span><span class="token string">"/"</span><span class="token operator">+</span>name <span class="token operator">+</span> <span class="token string">".dat"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">addTable</span><span class="token punctuation">(</span>tabHf<span class="token punctuation">,</span>name<span class="token punctuation">,</span>primaryKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Added table : "</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">" with schema "</span> <span class="token operator">+</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IndexOutOfBoundsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span>println <span class="token punctuation">(</span><span class="token string">"Invalid catalog entry : "</span> <span class="token operator">+</span> line<span class="token punctuation">)</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


</code></pre> 
<p>变量定义：<br> private final ConcurrentHashMap&lt;Integer,Table&gt; hashTable;//定义目录表<br> 方法定义：<br> loadSchema：从文件中读取schema并创建相关表到数据库。</p> 
<p>ant runtest -Dtest=CatalogTest<br> BUILD SUCCESSFUL</p> 
<h5><a id="24BufferPool_668"></a>2.4BufferPool</h5> 
<p>src/java/simpledb/storage/BufferPool.java</p> 
<pre><code class="prism language-java">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DEFAULT_PAGE_SIZE <span class="token operator">=</span> <span class="token number">4096</span><span class="token punctuation">;</span>
 
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> pageSize <span class="token operator">=</span> DEFAULT_PAGE_SIZE<span class="token punctuation">;</span>
    
    <span class="token comment">/** Default number of pages passed to the constructor. This is used by
    other classes. BufferPool should use the numPages argument to the
    constructor instead. */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DEFAULT_PAGES <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>
 
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> numPages<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> ConcurrentHashMap<span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">,</span>Page<span class="token punctuation">&gt;</span></span> pageStore<span class="token punctuation">;</span>
 
    <span class="token comment">/**
     * Creates a BufferPool that caches up to numPages pages.
     *
     * @param numPages maximum number of pages in this buffer pool.
     */</span>
    <span class="token keyword">public</span> <span class="token function">BufferPool</span><span class="token punctuation">(</span><span class="token keyword">int</span> numPages<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>numPages <span class="token operator">=</span> numPages<span class="token punctuation">;</span>
        pageStore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">,</span>Page<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">/**
     * Retrieve the specified page with the associated permissions.
     * Will acquire a lock and may block if that lock is held by another
     * transaction.
     * &lt;p&gt;
     * The retrieved page should be looked up in the buffer pool.  If it
     * is present, it should be returned.  If it is not present, it should
     * be added to the buffer pool and returned.  If there is insufficient
     * space in the buffer pool, a page should be evicted and the new page
     * should be added in its place.
     *
     * @param tid the ID of the transaction requesting the page
     * @param pid the ID of the requested page
     * @param perm the requested permissions on the page
     */</span>
    <span class="token keyword">public</span>  Page <span class="token function">getPage</span><span class="token punctuation">(</span>TransactionId tid<span class="token punctuation">,</span> PageId pid<span class="token punctuation">,</span> Permissions perm<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> TransactionAbortedException<span class="token punctuation">,</span> DbException <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>pageStore<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>pid<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            DbFile dbfile <span class="token operator">=</span> Database<span class="token punctuation">.</span><span class="token function">getCatalog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDatabaseFile</span><span class="token punctuation">(</span>pid<span class="token punctuation">.</span><span class="token function">getTableId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Page page <span class="token operator">=</span> dbfile<span class="token punctuation">.</span><span class="token function">readPage</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pageStore<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>pid<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> pageStore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pid<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h5><a id="25HeapFile_access_method_722"></a>2.5HeapFile access method</h5> 
<p>src/java/simpledb/storage/HeapPageId.java</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">;</span>

<span class="token comment">/** Unique identifier for HeapPage objects. */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HeapPageId</span> <span class="token keyword">implements</span> <span class="token class-name">PageId</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> tableId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> pgNo<span class="token punctuation">;</span>
    <span class="token comment">/**
     * Constructor. Create a page id structure for a specific page of a
     * specific table.
     *
     * @param tableId The table that is being referenced
     * @param pgNo The page number in that table.
     */</span>
    <span class="token keyword">public</span> <span class="token function">HeapPageId</span><span class="token punctuation">(</span><span class="token keyword">int</span> tableId<span class="token punctuation">,</span> <span class="token keyword">int</span> pgNo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tableId <span class="token operator">=</span> tableId<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pgNo <span class="token operator">=</span> pgNo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/** @return the table associated with this PageId */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getTableId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> tableId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return the page number in the table getTableId() associated with
     *   this PageId
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getPageNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> pgNo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return a hash code for this page, represented by a combination of
     *   the table number and the page number (needed if a PageId is used as a
     *   key in a hash table in the BufferPool, for example.)
     * @see BufferPool
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        String hash <span class="token operator">=</span> <span class="token string">""</span> <span class="token operator">+</span> tableId <span class="token operator">+</span> pgNo<span class="token punctuation">;</span>
        <span class="token keyword">return</span> hash<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Compares one PageId to another.
     *
     * @param o The object to compare against (must be a PageId)
     * @return true if the objects are equal (e.g., page numbers and table
     *   ids are the same)
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span>Object o<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token keyword">instanceof</span> <span class="token class-name">PageId</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            PageId pi <span class="token operator">=</span> <span class="token punctuation">(</span>PageId<span class="token punctuation">)</span> o<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pi<span class="token punctuation">.</span><span class="token function">getTableId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> tableId <span class="token operator">&amp;&amp;</span> pi<span class="token punctuation">.</span><span class="token function">getPageNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> pgNo<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     *  Return a representation of this object as an array of
     *  integers, for writing to disk.  Size of returned array must contain
     *  number of integers that corresponds to number of args to one of the
     *  constructors.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">getTableId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">getPageNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> data<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre> 
<p>变量定义：<br> private final int tableId;//表id<br> private final int pgNo;//页面号</p> 
<p>src/java/simpledb/storage/RecordId.java</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>Serializable<span class="token punctuation">;</span>

<span class="token comment">/**
 * A RecordId is a reference to a specific tuple on a specific page of a
 * specific table.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RecordId</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1</span>L<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> PageId pid<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> tupleno<span class="token punctuation">;</span>
    <span class="token comment">/**
     * Creates a new RecordId referring to the specified PageId and tuple
     * number.
     * 
     * @param pid
     *            the pageid of the page on which the tuple resides
     * @param tupleno
     *            the tuple number within the page.
     */</span>
    <span class="token keyword">public</span> <span class="token function">RecordId</span><span class="token punctuation">(</span>PageId pid<span class="token punctuation">,</span> <span class="token keyword">int</span> tupleno<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pid <span class="token operator">=</span> pid<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tupleno <span class="token operator">=</span> tupleno<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return the tuple number this RecordId references.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getTupleNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> tupleno<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return the page id this RecordId references.
     */</span>
    <span class="token keyword">public</span> PageId <span class="token function">getPageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> pid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Two RecordId objects are considered equal if they represent the same
     * tuple.
     * 
     * @return True if this and o represent the same tuple
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span>Object o<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token keyword">instanceof</span> <span class="token class-name">RecordId</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            RecordId ro <span class="token operator">=</span> <span class="token punctuation">(</span>RecordId<span class="token punctuation">)</span>o<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ro<span class="token punctuation">.</span><span class="token function">getPageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> ro<span class="token punctuation">.</span><span class="token function">getTupleNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> tupleno<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * You should implement the hashCode() so that two equal RecordId instances
     * (with respect to equals()) have the same hashCode().
     * 
     * @return An int that is the same for equal RecordId objects.
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        String hash <span class="token operator">=</span> <span class="token string">""</span> <span class="token operator">+</span> pid<span class="token punctuation">.</span><span class="token function">getTableId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> pid<span class="token punctuation">.</span><span class="token function">getPageNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> tupleno<span class="token punctuation">;</span>
        <span class="token keyword">return</span> hash<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre> 
<p>变量定义：<br> private final PageId pid;//页id<br> private final int tupleno;//tuple号</p> 
<p>src/java/simpledb/storage/HeapPage.java</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> simpledb<span class="token punctuation">;</span>
 
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>*<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>*<span class="token punctuation">;</span>
 
<span class="token comment">/**
 * Each instance of HeapPage stores data for one page of HeapFiles and 
 * implements the Page interface that is used by BufferPool.
 *
 * @see HeapFile
 * @see BufferPool
 *
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HeapPage</span> <span class="token keyword">implements</span> <span class="token class-name">Page</span> <span class="token punctuation">{<!-- --></span>
 
    <span class="token keyword">final</span> HeapPageId pid<span class="token punctuation">;</span>
    <span class="token keyword">final</span> TupleDesc td<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token keyword">byte</span> header<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> Tuple tuples<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token keyword">int</span> numSlots<span class="token punctuation">;</span>
 
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> oldData<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> Byte oldDataLock<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Byte</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token comment">/**
     * Create a HeapPage from a set of bytes of data read from disk.
     * The format of a HeapPage is a set of header bytes indicating
     * the slots of the page that are in use, some number of tuple slots.
     *  Specifically, the number of tuples is equal to: &lt;p&gt;
     *          floor((BufferPool.getPageSize()*8) / (tuple size * 8 + 1))
     * &lt;p&gt; where tuple size is the size of tuples in this
     * database table, which can be determined via {@link Catalog#getTupleDesc}.
     * The number of 8-bit header words is equal to:
     * &lt;p&gt;
     *      ceiling(no. tuple slots / 8)
     * &lt;p&gt;
     * @see Database#getCatalog
     * @see Catalog#getTupleDesc
     * @see BufferPool#getPageSize()
     */</span>
    <span class="token keyword">public</span> <span class="token function">HeapPage</span><span class="token punctuation">(</span>HeapPageId id<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pid <span class="token operator">=</span> id<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>td <span class="token operator">=</span> Database<span class="token punctuation">.</span><span class="token function">getCatalog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span>id<span class="token punctuation">.</span><span class="token function">getTableId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>numSlots <span class="token operator">=</span> <span class="token function">getNumTuples</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        DataInputStream dis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token comment">// allocate and read the header slots of this page</span>
        header <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token function">getHeaderSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>header<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            header<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> dis<span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        tuples <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tuple</span><span class="token punctuation">[</span>numSlots<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">// allocate and read the actual records of this page</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>tuples<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
                tuples<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">readNextTuple</span><span class="token punctuation">(</span>dis<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>NoSuchElementException e<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        dis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token function">setBeforeImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">/** Retrieve the number of tuples on this page.
        @return the number of tuples on this page
    */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">getNumTuples</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>        
        <span class="token comment">// some code goes here</span>
        <span class="token comment">//_tuples per page_ = floor((_page size_ * 8) / (_tuple size_ * 8 + 1))</span>
        <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">(</span>BufferPool<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">*</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>td<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> num<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">/**
     * Computes the number of bytes in the header of a page in a HeapFile with each tuple occupying tupleSize bytes
     * @return the number of bytes in the header of a page in a HeapFile with each tuple occupying tupleSize bytes
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">getHeaderSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>        
        
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// headerBytes = ceiling(tupsPerPage/8)</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span><span class="token function">getNumTuples</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1.0</span><span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/** Return a view of this page before it was modified
        -- used by recovery */</span>
    <span class="token keyword">public</span> HeapPage <span class="token function">getBeforeImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> oldDataRef <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">synchronized</span><span class="token punctuation">(</span>oldDataLock<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                oldDataRef <span class="token operator">=</span> oldData<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HeapPage</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span>oldDataRef<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//should never happen -- we parsed it OK before!</span>
            System<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setBeforeImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">synchronized</span><span class="token punctuation">(</span>oldDataLock<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
        oldData <span class="token operator">=</span> <span class="token function">getPageData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">/**
     * @return the PageId associated with this page.
     */</span>
    <span class="token keyword">public</span> HeapPageId <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> pid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">/**
     * Suck up tuples from the source file.
     */</span>
    <span class="token keyword">private</span> Tuple <span class="token function">readNextTuple</span><span class="token punctuation">(</span>DataInputStream dis<span class="token punctuation">,</span> <span class="token keyword">int</span> slotId<span class="token punctuation">)</span> <span class="token keyword">throws</span> NoSuchElementException <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// if associated bit is not set, read forward to the next tuple, and</span>
        <span class="token comment">// return null.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isSlotUsed</span><span class="token punctuation">(</span>slotId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>td<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    dis<span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchElementException</span><span class="token punctuation">(</span><span class="token string">"error reading empty tuple"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
 
        <span class="token comment">// read fields in the tuple</span>
        Tuple t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tuple</span><span class="token punctuation">(</span>td<span class="token punctuation">)</span><span class="token punctuation">;</span>
        RecordId rid <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RecordId</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> slotId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        t<span class="token punctuation">.</span><span class="token function">setRecordId</span><span class="token punctuation">(</span>rid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">&lt;</span>td<span class="token punctuation">.</span><span class="token function">numFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Field f <span class="token operator">=</span> td<span class="token punctuation">.</span><span class="token function">getFieldType</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>dis<span class="token punctuation">)</span><span class="token punctuation">;</span>
                t<span class="token punctuation">.</span><span class="token function">setField</span><span class="token punctuation">(</span>j<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">java<span class="token punctuation">.</span>text<span class="token punctuation">.</span>ParseException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchElementException</span><span class="token punctuation">(</span><span class="token string">"parsing error!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
 
        <span class="token keyword">return</span> t<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">/**
     * Generates a byte array representing the contents of this page.
     * Used to serialize this page to disk.
     * &lt;p&gt;
     * The invariant here is that it should be possible to pass the byte
     * array generated by getPageData to the HeapPage constructor and
     * have it produce an identical HeapPage object.
     *
     * @see #HeapPage
     * @return A byte array correspond to the bytes of this page.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getPageData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> len <span class="token operator">=</span> BufferPool<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ByteArrayOutputStream baos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        DataOutputStream dos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataOutputStream</span><span class="token punctuation">(</span>baos<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token comment">// create the header of the page</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>header<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                dos<span class="token punctuation">.</span><span class="token function">writeByte</span><span class="token punctuation">(</span>header<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// this really shouldn't happen</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
 
        <span class="token comment">// create the tuples</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>tuples<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 
            <span class="token comment">// empty slot</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isSlotUsed</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">&lt;</span>td<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                        dos<span class="token punctuation">.</span><span class="token function">writeByte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
 
                <span class="token punctuation">}</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
 
            <span class="token comment">// non-empty slot</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">&lt;</span>td<span class="token punctuation">.</span><span class="token function">numFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Field f <span class="token operator">=</span> tuples<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    f<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>dos<span class="token punctuation">)</span><span class="token punctuation">;</span>
                
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
 
        <span class="token comment">// padding</span>
        <span class="token keyword">int</span> zerolen <span class="token operator">=</span> BufferPool<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>header<span class="token punctuation">.</span>length <span class="token operator">+</span> td<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> tuples<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//- numSlots * td.getSize();</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> zeroes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span>zerolen<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            dos<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>zeroes<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> zerolen<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
 
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            dos<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
 
        <span class="token keyword">return</span> baos<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">/**
     * Static method to generate a byte array corresponding to an empty
     * HeapPage.
     * Used to add new, empty pages to the file. Passing the results of
     * this method to the HeapPage constructor will create a HeapPage with
     * no valid tuples in it.
     *
     * @return The returned ByteArray.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">createEmptyPageData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> len <span class="token operator">=</span> BufferPool<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//all 0</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">/**
     * Delete the specified tuple from the page; the corresponding header bit should be updated to reflect
     *   that it is no longer stored on any page.
     * @throws DbException if this tuple is not on this page, or tuple slot is
     *         already empty.
     * @param t The tuple to delete
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteTuple</span><span class="token punctuation">(</span>Tuple t<span class="token punctuation">)</span> <span class="token keyword">throws</span> DbException <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// not necessary for lab1</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">/**
     * Adds the specified tuple to the page;  the tuple should be updated to reflect
     *  that it is now stored on this page.
     * @throws DbException if the page is full (no empty slots) or tupledesc
     *         is mismatch.
     * @param t The tuple to add.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insertTuple</span><span class="token punctuation">(</span>Tuple t<span class="token punctuation">)</span> <span class="token keyword">throws</span> DbException <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// not necessary for lab1</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">/**
     * Marks this page as dirty/not dirty and record that transaction
     * that did the dirtying
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">markDirty</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> dirty<span class="token punctuation">,</span> TransactionId tid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
	<span class="token comment">// not necessary for lab1</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">/**
     * Returns the tid of the transaction that last dirtied this page, or null if the page is not dirty
     */</span>
    <span class="token keyword">public</span> TransactionId <span class="token function">isDirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
	<span class="token comment">// Not necessary for lab1</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>      
    <span class="token punctuation">}</span>
 
    <span class="token comment">/**
     * Returns the number of empty slots on this page.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getNumEmptySlots</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>numSlots<span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isSlotUsed</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token operator">++</span>cnt<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> cnt<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">/**
     * Returns true if associated slot on this page is filled.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isSlotUsed</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// use bitmap</span>
        <span class="token keyword">int</span> quot <span class="token operator">=</span> i<span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> remainder <span class="token operator">=</span> i<span class="token operator">%</span><span class="token number">8</span><span class="token punctuation">;</span>
 
        <span class="token keyword">int</span> bitidx <span class="token operator">=</span> header<span class="token punctuation">[</span>quot<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> bit <span class="token operator">=</span> <span class="token punctuation">(</span>bitidx<span class="token operator">&gt;&gt;</span>remainder<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> bit <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">/**
     * Abstraction to fill or clear a slot on this page.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">markSlotUsed</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">boolean</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// not necessary for lab1</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">/**
     * @return an iterator over all tuples on this page (calling remove on this iterator throws an UnsupportedOperationException)
     * (note that this iterator shouldn't return tuples in empty slots!)
     */</span>
    <span class="token keyword">public</span> Iterator<span class="token generics function"><span class="token punctuation">&lt;</span>Tuple<span class="token punctuation">&gt;</span></span> <span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Tuple<span class="token punctuation">&gt;</span></span> filledTuples <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics function"><span class="token punctuation">&lt;</span>Tuple<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>numSlots<span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isSlotUsed</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                filledTuples<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>tuples<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> filledTuples<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
<span class="token punctuation">}</span>
 
</code></pre> 
<p>src/java/simpledb/storage/HeapFile.java</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> simpledb<span class="token punctuation">;</span>
 
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>*<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>*<span class="token punctuation">;</span>
 
<span class="token comment">/**
 * HeapFile is an implementation of a DbFile that stores a collection of tuples
 * in no particular order. Tuples are stored on pages, each of which is a fixed
 * size, and the file is simply a collection of those pages. HeapFile works
 * closely with HeapPage. The format of HeapPages is described in the HeapPage
 * constructor.
 * 
 * @see simpledb.HeapPage#HeapPage
 * @author Sam Madden
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HeapFile</span> <span class="token keyword">implements</span> <span class="token class-name">DbFile</span> <span class="token punctuation">{<!-- --></span>
 
    <span class="token keyword">private</span> <span class="token keyword">final</span> File file<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> TupleDesc td<span class="token punctuation">;</span>
    <span class="token comment">/**
     * Constructs a heap file backed by the specified file.
     * 
     * @param f
     *            the file that stores the on-disk backing store for this heap
     *            file.
     */</span>
    <span class="token keyword">public</span> <span class="token function">HeapFile</span><span class="token punctuation">(</span>File f<span class="token punctuation">,</span> TupleDesc td<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>file <span class="token operator">=</span> f<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>td <span class="token operator">=</span> td<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">/**
     * Returns the File backing this HeapFile on disk.
     * 
     * @return the File backing this HeapFile on disk.
     */</span>
    <span class="token keyword">public</span> File <span class="token function">getFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> file<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">/**
     * Returns an ID uniquely identifying this HeapFile. Implementation note:
     * you will need to generate this tableid somewhere to ensure that each
     * HeapFile has a "unique id," and that you always return the same value for
     * a particular HeapFile. We suggest hashing the absolute file name of the
     * file underlying the heapfile, i.e. f.getAbsoluteFile().hashCode().
     * 
     * @return an ID uniquely identifying this HeapFile.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> file<span class="token punctuation">.</span><span class="token function">getAbsoluteFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">/**
     * Returns the TupleDesc of the table stored in this DbFile.
     * 
     * @return TupleDesc of this DbFile.
     */</span>
    <span class="token keyword">public</span> TupleDesc <span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> td<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">// see DbFile.java for javadocs</span>
    <span class="token keyword">public</span> Page <span class="token function">readPage</span><span class="token punctuation">(</span>PageId pid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">int</span> tableId <span class="token operator">=</span> pid<span class="token punctuation">.</span><span class="token function">getTableId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> pgNo <span class="token operator">=</span> pid<span class="token punctuation">.</span><span class="token function">getPageNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        RandomAccessFile f <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">try</span><span class="token punctuation">{<!-- --></span>
            f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span><span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>pgNo<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>BufferPool<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> f<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                f<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"table %d page %d is invalid"</span><span class="token punctuation">,</span> tableId<span class="token punctuation">,</span> pgNo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span>BufferPool<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            f<span class="token punctuation">.</span><span class="token function">seek</span><span class="token punctuation">(</span>pgNo <span class="token operator">*</span> BufferPool<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// big end</span>
            <span class="token keyword">int</span> read <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>BufferPool<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>read <span class="token operator">!=</span> BufferPool<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"table %d page %d read %d bytes"</span><span class="token punctuation">,</span> tableId<span class="token punctuation">,</span> pgNo<span class="token punctuation">,</span> read<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            HeapPageId id <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HeapPageId</span><span class="token punctuation">(</span>pid<span class="token punctuation">.</span><span class="token function">getTableId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>pid<span class="token punctuation">.</span><span class="token function">getPageNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HeapPage</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span><span class="token punctuation">{<!-- --></span>
                f<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"table %d page %d is invalid"</span><span class="token punctuation">,</span> tableId<span class="token punctuation">,</span> pgNo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">// see DbFile.java for javadocs</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">writePage</span><span class="token punctuation">(</span>Page page<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// not necessary for lab1</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">/**
     * Returns the number of pages in this HeapFile.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">numPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1.0</span><span class="token operator">/</span>BufferPool<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> num<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">// see DbFile.java for javadocs</span>
    <span class="token keyword">public</span> ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Page<span class="token punctuation">&gt;</span></span> <span class="token function">insertTuple</span><span class="token punctuation">(</span>TransactionId tid<span class="token punctuation">,</span> Tuple t<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> DbException<span class="token punctuation">,</span> IOException<span class="token punctuation">,</span> TransactionAbortedException <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token comment">// not necessary for lab1</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">// see DbFile.java for javadocs</span>
    <span class="token keyword">public</span> ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Page<span class="token punctuation">&gt;</span></span> <span class="token function">deleteTuple</span><span class="token punctuation">(</span>TransactionId tid<span class="token punctuation">,</span> Tuple t<span class="token punctuation">)</span> <span class="token keyword">throws</span> DbException<span class="token punctuation">,</span>
            TransactionAbortedException <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token comment">// not necessary for lab1</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">// see DbFile.java for javadocs</span>
    <span class="token keyword">public</span> DbFileIterator <span class="token function">iterator</span><span class="token punctuation">(</span>TransactionId tid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HeapFileIterator</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">HeapFileIterator</span> <span class="token keyword">implements</span> <span class="token class-name">DbFileIterator</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> HeapFile heapFile<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> TransactionId tid<span class="token punctuation">;</span>
        <span class="token keyword">private</span> Iterator<span class="token generics function"><span class="token punctuation">&lt;</span>Tuple<span class="token punctuation">&gt;</span></span> it<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> whichPage<span class="token punctuation">;</span>
 
        <span class="token keyword">public</span> <span class="token function">HeapFileIterator</span><span class="token punctuation">(</span>HeapFile file<span class="token punctuation">,</span>TransactionId tid<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>heapFile <span class="token operator">=</span> file<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>tid <span class="token operator">=</span> tid<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> DbException<span class="token punctuation">,</span> TransactionAbortedException <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// TODO Auto-generated method stub</span>
            whichPage <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            it <span class="token operator">=</span> <span class="token function">getPageTuples</span><span class="token punctuation">(</span>whichPage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
 
        <span class="token keyword">private</span> Iterator<span class="token generics function"><span class="token punctuation">&lt;</span>Tuple<span class="token punctuation">&gt;</span></span> <span class="token function">getPageTuples</span><span class="token punctuation">(</span><span class="token keyword">int</span> pageNumber<span class="token punctuation">)</span> <span class="token keyword">throws</span> TransactionAbortedException<span class="token punctuation">,</span> DbException<span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>pageNumber <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> pageNumber <span class="token operator">&lt;</span> heapFile<span class="token punctuation">.</span><span class="token function">numPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                HeapPageId pid <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HeapPageId</span><span class="token punctuation">(</span>heapFile<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>pageNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
                HeapPage page <span class="token operator">=</span> <span class="token punctuation">(</span>HeapPage<span class="token punctuation">)</span>Database<span class="token punctuation">.</span><span class="token function">getBufferPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPage</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span> pid<span class="token punctuation">,</span> Permissions<span class="token punctuation">.</span>READ_ONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> page<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">DbException</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"heapfile %d does not contain page %d!"</span><span class="token punctuation">,</span> pageNumber<span class="token punctuation">,</span>heapFile<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
 
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> DbException<span class="token punctuation">,</span> TransactionAbortedException <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// TODO Auto-generated method stub</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>it <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
 
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>whichPage <span class="token operator">&lt;</span> <span class="token punctuation">(</span>heapFile<span class="token punctuation">.</span><span class="token function">numPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    whichPage<span class="token operator">++</span><span class="token punctuation">;</span>
                    it <span class="token operator">=</span> <span class="token function">getPageTuples</span><span class="token punctuation">(</span>whichPage<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
 
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> Tuple <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> DbException<span class="token punctuation">,</span> TransactionAbortedException<span class="token punctuation">,</span> NoSuchElementException <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// TODO Auto-generated method stub</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>it <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchElementException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
 
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> DbException<span class="token punctuation">,</span> TransactionAbortedException <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// TODO Auto-generated method stub</span>
            <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
 
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// TODO Auto-generated method stub</span>
            it <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
 
    <span class="token punctuation">}</span>
 
<span class="token punctuation">}</span>
 
</code></pre> 
<p>ant runtest -Dtest=HeapPageIdTest<br> ant runtest -Dtest=TupleDescTest<br> ant runtest -Dtest=HeapPageReadTest<br> ant runtest -Dtest=HeapFileReadTest<br> BUILD SUCCESSFUL。</p> 
<h5><a id="26Operators_1459"></a>2.6Operators</h5> 
<p>src/java/simpledb/execution/SeqScan.java</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> simpledb<span class="token punctuation">.</span>execution<span class="token punctuation">;</span>

<span class="token keyword">import</span> simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span>Database<span class="token punctuation">;</span>
<span class="token keyword">import</span> simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span>DbException<span class="token punctuation">;</span>
<span class="token keyword">import</span> simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>DbFileIterator<span class="token punctuation">;</span>
<span class="token keyword">import</span> simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>Tuple<span class="token punctuation">;</span>
<span class="token keyword">import</span> simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>TupleDesc<span class="token punctuation">;</span>
<span class="token keyword">import</span> simpledb<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>TransactionAbortedException<span class="token punctuation">;</span>
<span class="token keyword">import</span> simpledb<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>TransactionId<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>NoSuchElementException<span class="token punctuation">;</span>

<span class="token comment">/**
 * SeqScan is an implementation of a sequential scan access method that reads
 * each tuple of a table in no particular order (e.g., as they are laid out on
 * disk).
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SeqScan</span> <span class="token keyword">implements</span> <span class="token class-name">OpIterator</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1</span>L<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> TransactionId tid<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> tableId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> String tableAlias<span class="token punctuation">;</span>
    <span class="token keyword">private</span> DbFileIterator it<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Creates a sequential scan over the specified table as a part of the
     * specified transaction.
     *
     * @param tid
     *            The transaction this scan is running as a part of.
     * @param tableid
     *            the table to scan.
     * @param tableAlias
     *            the alias of this table (needed by the parser); the returned
     *            tupleDesc should have fields with name tableAlias.fieldName
     *            (note: this class is not responsible for handling a case where
     *            tableAlias or fieldName are null. It shouldn't crash if they
     *            are, but the resulting name can be null.fieldName,
     *            tableAlias.null, or null.null).
     */</span>
    <span class="token keyword">public</span> <span class="token function">SeqScan</span><span class="token punctuation">(</span>TransactionId tid<span class="token punctuation">,</span> <span class="token keyword">int</span> tableid<span class="token punctuation">,</span> String tableAlias<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tid <span class="token operator">=</span> tid<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tableId <span class="token operator">=</span> tableid<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tableAlias <span class="token operator">=</span> tableAlias<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return
     *       return the table name of the table the operator scans. This should
     *       be the actual name of the table in the catalog of the database
     * */</span>
    <span class="token keyword">public</span> String <span class="token function">getTableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> Database<span class="token punctuation">.</span><span class="token function">getCatalog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTableName</span><span class="token punctuation">(</span>tableId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return Return the alias of the table this operator scans.
     * */</span>
    <span class="token keyword">public</span> String <span class="token function">getAlias</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> tableAlias<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Reset the tableid, and tableAlias of this operator.
     * @param tableid
     *            the table to scan.
     * @param tableAlias
     *            the alias of this table (needed by the parser); the returned
     *            tupleDesc should have fields with name tableAlias.fieldName
     *            (note: this class is not responsible for handling a case where
     *            tableAlias or fieldName are null. It shouldn't crash if they
     *            are, but the resulting name can be null.fieldName,
     *            tableAlias.null, or null.null).
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">reset</span><span class="token punctuation">(</span><span class="token keyword">int</span> tableid<span class="token punctuation">,</span> String tableAlias<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tableId <span class="token operator">=</span> tableid<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tableAlias <span class="token operator">=</span> tableAlias<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">SeqScan</span><span class="token punctuation">(</span>TransactionId tid<span class="token punctuation">,</span> <span class="token keyword">int</span> tableId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span> tableId<span class="token punctuation">,</span> Database<span class="token punctuation">.</span><span class="token function">getCatalog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTableName</span><span class="token punctuation">(</span>tableId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> DbException<span class="token punctuation">,</span> TransactionAbortedException <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        it <span class="token operator">=</span> Database<span class="token punctuation">.</span><span class="token function">getCatalog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDatabaseFile</span><span class="token punctuation">(</span>tableId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        it<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Returns the TupleDesc with field names from the underlying HeapFile,
     * prefixed with the tableAlias string from the constructor. This prefix
     * becomes useful when joining tables containing a field(s) with the same
     * name.  The alias and name should be separated with a "." character
     * (e.g., "alias.fieldName").
     *
     * @return the TupleDesc with field names from the underlying HeapFile,
     *         prefixed with the tableAlias string from the constructor.
     */</span>
    <span class="token keyword">public</span> TupleDesc <span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> Database<span class="token punctuation">.</span><span class="token function">getCatalog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span>tableId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> TransactionAbortedException<span class="token punctuation">,</span> DbException <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>it <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> Tuple <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> NoSuchElementException<span class="token punctuation">,</span>
            TransactionAbortedException<span class="token punctuation">,</span> DbException <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>it <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchElementException</span><span class="token punctuation">(</span><span class="token string">"no next tuple"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        Tuple t <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchElementException</span><span class="token punctuation">(</span><span class="token string">"no next tuple"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> t<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        it <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> DbException<span class="token punctuation">,</span> NoSuchElementException<span class="token punctuation">,</span>
            TransactionAbortedException <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// some code goes here</span>
        it<span class="token punctuation">.</span><span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>变量定义：<br> private final TransactionId tid;<br> private int tableId;<br> private String tableAlias;<br> private DbFileIterator it;</p> 
<p>ant runsystest -Dtest=ScanTest<br> BUILD SUCCESSFUL</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/48f42a44b76e22d73e38563b5a488947/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">利用Vue Grid Layout实现div可拖动布局</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b6cb57577c30283b6e41420a76ee98ac/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">ROS pluginlib步骤</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>