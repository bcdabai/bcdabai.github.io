<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ã€Arduino TFTã€‘åŸºäº ESP32S3 S7789 240x240 TFTå®ç°çš„SD2 å¤©æ°”æ—¶é’Ÿ - ç¼–ç¨‹å¤§ç™½çš„åšå®¢</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ã€Arduino TFTã€‘åŸºäº ESP32S3 S7789 240x240 TFTå®ç°çš„SD2 å¤©æ°”æ—¶é’Ÿ" />
<meta property="og:description" content="å¿˜è®°è¿‡å»ï¼Œè¶…è¶Šè‡ªå·±
â¤ï¸ åšå®¢ä¸»é¡µ å•ç‰‡æœºèœé¸Ÿå“¥ï¼Œä¸€ä¸ªé‡ç”Ÿéä¸“ä¸šç¡¬ä»¶IOTçˆ±å¥½è€… â¤ï¸â¤ï¸ æœ¬ç¯‡åˆ›å»ºè®°å½• 2023-10-21 â¤ï¸â¤ï¸ æœ¬ç¯‡æ›´æ–°è®°å½• 2023-10-21 â¤ï¸ğŸ‰ æ¬¢è¿å…³æ³¨ ğŸ”ç‚¹èµ ğŸ‘æ”¶è— â­ï¸ç•™è¨€ğŸ“ğŸ™ æ­¤åšå®¢å‡ç”±åšä¸»å•ç‹¬ç¼–å†™ï¼Œä¸å­˜åœ¨ä»»ä½•å•†ä¸šå›¢é˜Ÿè¿è¥ï¼Œå¦‚å‘ç°é”™è¯¯ï¼Œè¯·ç•™è¨€è½°ç‚¸å“¦ï¼åŠæ—¶ä¿®æ­£ï¼æ„Ÿè°¢æ”¯æŒï¼ğŸ”¥ Arduino ESP8266æ•™ç¨‹ç´¯è®¡å¸®åŠ©è¿‡è¶…è¿‡1W&#43;åŒå­¦å…¥é—¨å­¦ä¹ ç¡¬ä»¶ç½‘ç»œç¼–ç¨‹ï¼Œå…¥é€‰è¿‡é€‰ä¿®è¯¾ç¨‹ï¼ŒåˆŠç™»è¿‡æ— çº¿ç”µæ‚å¿— ğŸ”¥é›¶åŸºç¡€ä»å…¥é—¨åˆ°ç†Ÿæ‚‰Arduinoå¹³å°ä¸‹å¼€å‘ESP8266ï¼ŒåŒæ—¶ä¼šæ¶‰åŠç½‘ç»œç¼–ç¨‹çŸ¥è¯†ã€‚ä¸“æ æ–‡ç« ç´¯è®¡è¶…è¿‡60ç¯‡ï¼Œåˆ†ä¸ºåŸºç¡€ç¯‡ã€ç½‘ç»œç¯‡ã€åº”ç”¨ç¯‡ã€é«˜çº§ç¯‡ï¼Œæ¶µç›–ESP8266å¤§éƒ¨åˆ†å¼€å‘æŠ€å·§ã€‚ å¿«é€Ÿå¯¼èˆª
å•ç‰‡æœºèœé¸Ÿçš„åšå®¢å¿«é€Ÿç´¢å¼•(å¿«é€Ÿæ‰¾åˆ°ä½ è¦çš„)
å¦‚æœè§‰å¾—æœ‰ç”¨ï¼Œéº»çƒ¦ç‚¹èµæ”¶è—ï¼Œæ‚¨çš„æ”¯æŒæ˜¯åšä¸»åˆ›ä½œçš„åŠ¨åŠ›ã€‚
æ–‡ç« ç›®å½• 1. å‰è¨€2. è½¯ä»¶ä»£ç 2.1 TFTå±å¹•çš„é…ç½®æ–‡ä»¶2.2 ä¸»å·¥ç¨‹ä»£ç 2.3 tftæ˜¾ç¤ºä»£ç 2.4 ç¡çœ æ¨¡å¼2.5 è·å–å¤©æ°”ä¿¡æ¯ 1. å‰è¨€ ä»¿é€ ç½‘ä¸Šå¼€æºçš„SD2 å¤©æ°”æ—¶é’Ÿï¼Œä¼˜åŒ–äº†éƒ¨åˆ†ä»£ç ï¼Œ V1.0 æœ€åŸºæœ¬åŠŸèƒ½ï¼Œæ”¯æŒå¤œé—´ç¡çœ æ¨¡å¼ã€‚åæœŸä¼šç»§ç»­ä¼˜åŒ–ã€‚
2. è½¯ä»¶ä»£ç  2.1 TFTå±å¹•çš„é…ç½®æ–‡ä»¶ // USER DEFINED SETTINGS // Set driver type, fonts to be loaded, pins used and SPI control method etc // // See the User_Setup_Select.h file if you wish to be able to define multiple // setups and then easily select which setup file is used by the compiler." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/bfc3c0d1711e4bfa691edb7780e5c13f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-10-21T17:18:03+08:00" />
<meta property="article:modified_time" content="2023-10-21T17:18:03+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="ç¼–ç¨‹å¤§ç™½çš„åšå®¢" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">ç¼–ç¨‹å¤§ç™½çš„åšå®¢</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ã€Arduino TFTã€‘åŸºäº ESP32S3 S7789 240x240 TFTå®ç°çš„SD2 å¤©æ°”æ—¶é’Ÿ</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>å¿˜è®°è¿‡å»ï¼Œè¶…è¶Šè‡ªå·±</p> 
 <ul><li>â¤ï¸ åšå®¢ä¸»é¡µ <a href="https://blog.csdn.net/dpjcn1990">å•ç‰‡æœºèœé¸Ÿå“¥ï¼Œä¸€ä¸ªé‡ç”Ÿéä¸“ä¸šç¡¬ä»¶IOTçˆ±å¥½è€…</a> â¤ï¸</li><li>â¤ï¸ æœ¬ç¯‡åˆ›å»ºè®°å½• 2023-10-21 â¤ï¸</li><li>â¤ï¸ æœ¬ç¯‡æ›´æ–°è®°å½• 2023-10-21 â¤ï¸</li><li>ğŸ‰ æ¬¢è¿å…³æ³¨ ğŸ”ç‚¹èµ ğŸ‘æ”¶è— â­ï¸ç•™è¨€ğŸ“</li><li>ğŸ™ æ­¤åšå®¢å‡ç”±åšä¸»å•ç‹¬ç¼–å†™ï¼Œä¸å­˜åœ¨ä»»ä½•å•†ä¸šå›¢é˜Ÿè¿è¥ï¼Œå¦‚å‘ç°é”™è¯¯ï¼Œè¯·ç•™è¨€è½°ç‚¸å“¦ï¼åŠæ—¶ä¿®æ­£ï¼æ„Ÿè°¢æ”¯æŒï¼</li><li>ğŸ”¥ Arduino ESP8266æ•™ç¨‹ç´¯è®¡å¸®åŠ©è¿‡è¶…è¿‡1W+åŒå­¦å…¥é—¨å­¦ä¹ ç¡¬ä»¶ç½‘ç»œç¼–ç¨‹ï¼Œå…¥é€‰è¿‡é€‰ä¿®è¯¾ç¨‹ï¼ŒåˆŠç™»è¿‡æ— çº¿ç”µæ‚å¿— ğŸ”¥é›¶åŸºç¡€ä»å…¥é—¨åˆ°ç†Ÿæ‚‰Arduinoå¹³å°ä¸‹å¼€å‘ESP8266ï¼ŒåŒæ—¶ä¼šæ¶‰åŠç½‘ç»œç¼–ç¨‹çŸ¥è¯†ã€‚ä¸“æ æ–‡ç« ç´¯è®¡è¶…è¿‡60ç¯‡ï¼Œåˆ†ä¸ºåŸºç¡€ç¯‡ã€ç½‘ç»œç¯‡ã€åº”ç”¨ç¯‡ã€é«˜çº§ç¯‡ï¼Œæ¶µç›–ESP8266å¤§éƒ¨åˆ†å¼€å‘æŠ€å·§ã€‚</li></ul> 
</blockquote> 
<p><strong>å¿«é€Ÿå¯¼èˆª</strong><br> <a href="https://blog.csdn.net/dpjcn1990/article/details/92831918">å•ç‰‡æœºèœé¸Ÿçš„åšå®¢å¿«é€Ÿç´¢å¼•(å¿«é€Ÿæ‰¾åˆ°ä½ è¦çš„)</a></p> 
<p>å¦‚æœè§‰å¾—æœ‰ç”¨ï¼Œéº»çƒ¦ç‚¹èµæ”¶è—ï¼Œæ‚¨çš„æ”¯æŒæ˜¯åšä¸»åˆ›ä½œçš„åŠ¨åŠ›ã€‚</p> 
<p></p> 
<div class="toc"> 
 <h4>æ–‡ç« ç›®å½•</h4> 
 <ul><li><ul><li><a href="#1__15" rel="nofollow">1. å‰è¨€</a></li><li><a href="#2__19" rel="nofollow">2. è½¯ä»¶ä»£ç </a></li><li><ul><li><a href="#21_TFT_21" rel="nofollow">2.1 TFTå±å¹•çš„é…ç½®æ–‡ä»¶</a></li><li><a href="#22__430" rel="nofollow">2.2 ä¸»å·¥ç¨‹ä»£ç </a></li><li><a href="#23_tft_580" rel="nofollow">2.3 tftæ˜¾ç¤ºä»£ç </a></li><li><a href="#24__945" rel="nofollow">2.4 ç¡çœ æ¨¡å¼</a></li><li><a href="#25__1035" rel="nofollow">2.5 è·å–å¤©æ°”ä¿¡æ¯</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="1__15"></a>1. å‰è¨€</h3> 
<p><img src="https://images2.imgbox.com/98/13/7MjVYtzL_o.gif" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> ä»¿é€ ç½‘ä¸Šå¼€æºçš„SD2 å¤©æ°”æ—¶é’Ÿï¼Œä¼˜åŒ–äº†éƒ¨åˆ†ä»£ç ï¼Œ V1.0 æœ€åŸºæœ¬åŠŸèƒ½ï¼Œæ”¯æŒå¤œé—´ç¡çœ æ¨¡å¼ã€‚åæœŸä¼šç»§ç»­ä¼˜åŒ–ã€‚</p> 
<h3><a id="2__19"></a>2. è½¯ä»¶ä»£ç </h3> 
<p><img src="https://images2.imgbox.com/ba/3c/1ii9KddF_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<h4><a id="21_TFT_21"></a>2.1 TFTå±å¹•çš„é…ç½®æ–‡ä»¶</h4> 
<pre><code class="prism language-c"><span class="token comment">//                            USER DEFINED SETTINGS</span>
<span class="token comment">//   Set driver type, fonts to be loaded, pins used and SPI control method etc</span>
<span class="token comment">//</span>
<span class="token comment">//   See the User_Setup_Select.h file if you wish to be able to define multiple</span>
<span class="token comment">//   setups and then easily select which setup file is used by the compiler.</span>
<span class="token comment">//</span>
<span class="token comment">//   If this file is edited correctly then all the library example sketches should</span>
<span class="token comment">//   run without the need to make any more changes for a particular hardware setup!</span>
<span class="token comment">//   Note that some sketches are designed for a particular TFT pixel width/height</span>

<span class="token comment">// User defined information reported by "Read_User_Setup" test &amp; diagnostics example</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">USER_SETUP_INFO</span> <span class="token string">"User_Setup"</span></span>

<span class="token comment">// Define to disable all #warnings in library (can be put in User_Setup_Select.h)</span>
<span class="token comment">//#define DISABLE_ALL_LIBRARY_WARNINGS</span>

<span class="token comment">// ##################################################################################</span>
<span class="token comment">//</span>
<span class="token comment">// Section 1. Call up the right driver file and any options for it</span>
<span class="token comment">//</span>
<span class="token comment">// ##################################################################################</span>

<span class="token comment">// Define STM32 to invoke optimised processor support (only for STM32)</span>
<span class="token comment">//#define STM32</span>

<span class="token comment">// Defining the STM32 board allows the library to optimise the performance</span>
<span class="token comment">// for UNO compatible "MCUfriend" style shields</span>
<span class="token comment">//#define NUCLEO_64_TFT</span>
<span class="token comment">//#define NUCLEO_144_TFT</span>

<span class="token comment">// STM32 8 bit parallel only:</span>
<span class="token comment">// If STN32 Port A or B pins 0-7 are used for 8 bit parallel data bus bits 0-7</span>
<span class="token comment">// then this will improve rendering performance by a factor of ~8x</span>
<span class="token comment">//#define STM_PORTA_DATA_BUS</span>
<span class="token comment">//#define STM_PORTB_DATA_BUS</span>

<span class="token comment">// Tell the library to use parallel mode (otherwise SPI is assumed)</span>
<span class="token comment">//#define TFT_PARALLEL_8_BIT</span>
<span class="token comment">//#defined TFT_PARALLEL_16_BIT // **** 16 bit parallel ONLY for RP2040 processor ****</span>

<span class="token comment">// Display type -  only define if RPi display</span>
<span class="token comment">//#define RPI_DISPLAY_TYPE // 20MHz maximum SPI</span>

<span class="token comment">// Only define one driver, the other ones must be commented out</span>
<span class="token comment">//#define ILI9341_DRIVER       // Generic driver for common displays</span>
<span class="token comment">//#define ILI9341_2_DRIVER     // Alternative ILI9341 driver, see https://github.com/Bodmer/TFT_eSPI/issues/1172</span>
<span class="token comment">//#define ST7735_DRIVER      // Define additional parameters below for this display</span>
<span class="token comment">//#define ILI9163_DRIVER     // Define additional parameters below for this display</span>
<span class="token comment">//#define S6D02A1_DRIVER</span>
<span class="token comment">//#define RPI_ILI9486_DRIVER // 20MHz maximum SPI</span>
<span class="token comment">//#define HX8357D_DRIVER</span>
<span class="token comment">//#define ILI9481_DRIVER</span>
<span class="token comment">//#define ILI9486_DRIVER</span>
<span class="token comment">//#define ILI9488_DRIVER     // WARNING: Do not connect ILI9488 display SDO to MISO if other devices share the SPI bus (TFT SDO does NOT tristate when CS is high)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_DRIVER</span>      <span class="token comment">// Full configuration option, define additional parameters below for this display</span></span>
<span class="token comment">//#define ST7789_2_DRIVER    // Minimal configuration option, define additional parameters below for this display</span>
<span class="token comment">//#define R61581_DRIVER</span>
<span class="token comment">//#define RM68140_DRIVER</span>
<span class="token comment">//#define ST7796_DRIVER</span>
<span class="token comment">//#define SSD1351_DRIVER</span>
<span class="token comment">//#define SSD1963_480_DRIVER</span>
<span class="token comment">//#define SSD1963_800_DRIVER</span>
<span class="token comment">//#define SSD1963_800ALT_DRIVER</span>
<span class="token comment">//#define ILI9225_DRIVER</span>
<span class="token comment">//#define GC9A01_DRIVER</span>

<span class="token comment">// Some displays support SPI reads via the MISO pin, other displays have a single</span>
<span class="token comment">// bi-directional SDA pin and the library will try to read this via the MOSI line.</span>
<span class="token comment">// To use the SDA line for reading data from the TFT uncomment the following line:</span>

<span class="token comment">// #define TFT_SDA_READ      // This option is for ESP32 ONLY, tested with ST7789 and GC9A01 display only</span>

<span class="token comment">// For ST7735, ST7789 and ILI9341 ONLY, define the colour order IF the blue and red are swapped on your display</span>
<span class="token comment">// Try ONE option at a time to find the correct colour order for your display</span>

<span class="token comment">//  #define TFT_RGB_ORDER TFT_RGB  // Colour order Red-Green-Blue</span>
<span class="token comment">//  #define TFT_RGB_ORDER TFT_BGR  // Colour order Blue-Green-Red</span>
<span class="token comment">//  #define TFT_INVERSION_OFF</span>
<span class="token comment">// For M5Stack ESP32 module with integrated ILI9341 display ONLY, remove // in line below</span>

<span class="token comment">// #define M5STACK</span>

<span class="token comment">// For ST7789, ST7735, ILI9163 and GC9A01 ONLY, define the pixel width and height in portrait orientation</span>
<span class="token comment">// #define TFT_WIDTH  80</span>
<span class="token comment">// #define TFT_WIDTH  128</span>
<span class="token comment">// #define TFT_WIDTH  172 // ST7789 172 x 320</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TFT_WIDTH</span>  <span class="token expression"><span class="token number">240</span> </span><span class="token comment">// ST7789 240 x 240 and 240 x 320</span></span>
<span class="token comment">// #define TFT_HEIGHT 160</span>
<span class="token comment">// #define TFT_HEIGHT 128</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TFT_HEIGHT</span> <span class="token expression"><span class="token number">240</span> </span><span class="token comment">// ST7789 240 x 240</span></span>
<span class="token comment">// #define TFT_HEIGHT 320 // ST7789 240 x 320</span>
<span class="token comment">// #define TFT_HEIGHT 240 // GC9A01 240 x 240</span>

<span class="token comment">// For ST7735 ONLY, define the type of display, originally this was based on the</span>
<span class="token comment">// colour of the tab on the screen protector film but this is not always true, so try</span>
<span class="token comment">// out the different options below if the screen does not display graphics correctly,</span>
<span class="token comment">// e.g. colours wrong, mirror images, or stray pixels at the edges.</span>
<span class="token comment">// Comment out ALL BUT ONE of these options for a ST7735 display driver, save this</span>
<span class="token comment">// this User_Setup file, then rebuild and upload the sketch to the board again:</span>

<span class="token comment">// #define ST7735_INITB</span>
<span class="token comment">// #define ST7735_GREENTAB</span>
<span class="token comment">// #define ST7735_GREENTAB2</span>
<span class="token comment">// #define ST7735_GREENTAB3</span>
<span class="token comment">// #define ST7735_GREENTAB128    // For 128 x 128 display</span>
<span class="token comment">// #define ST7735_GREENTAB160x80 // For 160 x 80 display (BGR, inverted, 26 offset)</span>
<span class="token comment">// #define ST7735_ROBOTLCD       // For some RobotLCD arduino shields (128x160, BGR, https://docs.arduino.cc/retired/getting-started-guides/TFT)</span>
<span class="token comment">// #define ST7735_REDTAB</span>
<span class="token comment">// #define ST7735_BLACKTAB</span>
<span class="token comment">// #define ST7735_REDTAB160x80   // For 160 x 80 display with 24 pixel offset</span>

<span class="token comment">// If colours are inverted (white shows as black) then uncomment one of the next</span>
<span class="token comment">// 2 lines try both options, one of the options should correct the inversion.</span>

<span class="token comment">// #define TFT_INVERSION_ON</span>
<span class="token comment">// #define TFT_INVERSION_OFF</span>


<span class="token comment">// ##################################################################################</span>
<span class="token comment">//</span>
<span class="token comment">// Section 2. Define the pins that are used to interface with the display here</span>
<span class="token comment">//</span>
<span class="token comment">// ##################################################################################</span>

<span class="token comment">// If a backlight control signal is available then define the TFT_BL pin in Section 2</span>
<span class="token comment">// below. The backlight will be turned ON when tft.begin() is called, but the library</span>
<span class="token comment">// needs to know if the LEDs are ON with the pin HIGH or LOW. If the LEDs are to be</span>
<span class="token comment">// driven with a PWM signal or turned OFF/ON then this must be handled by the user</span>
<span class="token comment">// sketch. e.g. with digitalWrite(TFT_BL, LOW);</span>

<span class="token comment">// #define TFT_BL   32            // LED back-light control pin</span>
<span class="token comment">// #define TFT_BACKLIGHT_ON HIGH  // Level to turn ON back-light (HIGH or LOW)</span>



<span class="token comment">// We must use hardware SPI, a minimum of 3 GPIO pins is needed.</span>
<span class="token comment">// Typical setup for ESP8266 NodeMCU ESP-12 is :</span>
<span class="token comment">//</span>
<span class="token comment">// Display SDO/MISO  to NodeMCU pin D6 (or leave disconnected if not reading TFT)</span>
<span class="token comment">// Display LED       to NodeMCU pin VIN (or 5V, see below)</span>
<span class="token comment">// Display SCK       to NodeMCU pin D5</span>
<span class="token comment">// Display SDI/MOSI  to NodeMCU pin D7</span>
<span class="token comment">// Display DC (RS/AO)to NodeMCU pin D3</span>
<span class="token comment">// Display RESET     to NodeMCU pin D4 (or RST, see below)</span>
<span class="token comment">// Display CS        to NodeMCU pin D8 (or GND, see below)</span>
<span class="token comment">// Display GND       to NodeMCU pin GND (0V)</span>
<span class="token comment">// Display VCC       to NodeMCU 5V or 3.3V</span>
<span class="token comment">//</span>
<span class="token comment">// The TFT RESET pin can be connected to the NodeMCU RST pin or 3.3V to free up a control pin</span>
<span class="token comment">//</span>
<span class="token comment">// The DC (Data Command) pin may be labelled AO or RS (Register Select)</span>
<span class="token comment">//</span>
<span class="token comment">// With some displays such as the ILI9341 the TFT CS pin can be connected to GND if no more</span>
<span class="token comment">// SPI devices (e.g. an SD Card) are connected, in this case comment out the #define TFT_CS</span>
<span class="token comment">// line below so it is NOT defined. Other displays such at the ST7735 require the TFT CS pin</span>
<span class="token comment">// to be toggled during setup, so in these cases the TFT_CS line must be defined and connected.</span>
<span class="token comment">//</span>
<span class="token comment">// The NodeMCU D0 pin can be used for RST</span>
<span class="token comment">//</span>
<span class="token comment">//</span>
<span class="token comment">// Note: only some versions of the NodeMCU provide the USB 5V on the VIN pin</span>
<span class="token comment">// If 5V is not available at a pin you can use 3.3V but backlight brightness</span>
<span class="token comment">// will be lower.</span>


<span class="token comment">// ###### EDIT THE PIN NUMBERS IN THE LINES FOLLOWING TO SUIT YOUR ESP8266 SETUP ######</span>

<span class="token comment">// // For NodeMCU - use pin numbers in the form PIN_Dx where Dx is the NodeMCU pin designation</span>
<span class="token comment">// #define TFT_CS   PIN_D8  // Chip select control pin D8</span>
<span class="token comment">// #define TFT_DC   PIN_D3  // Data Command control pin</span>
<span class="token comment">// #define TFT_RST  PIN_D4  // Reset pin (could connect to NodeMCU RST, see next line)</span>
<span class="token comment">// //#define TFT_RST  -1    // Set TFT_RST to -1 if the display RESET is connected to NodeMCU RST or 3.3V</span>

<span class="token comment">//#define TFT_BL PIN_D1  // LED back-light (only for ST7789 with backlight control pin)</span>

<span class="token comment">//#define TOUCH_CS PIN_D2     // Chip select pin (T_CS) of touch screen</span>

<span class="token comment">//#define TFT_WR PIN_D2       // Write strobe for modified Raspberry Pi TFT only</span>


<span class="token comment">// ######  FOR ESP8266 OVERLAP MODE EDIT THE PIN NUMBERS IN THE FOLLOWING LINES  ######</span>

<span class="token comment">// Overlap mode shares the ESP8266 FLASH SPI bus with the TFT so has a performance impact</span>
<span class="token comment">// but saves pins for other functions. It is best not to connect MISO as some displays</span>
<span class="token comment">// do not tristate that line when chip select is high!</span>
<span class="token comment">// Note: Only one SPI device can share the FLASH SPI lines, so a SPI touch controller</span>
<span class="token comment">// cannot be connected as well to the same SPI signals.</span>
<span class="token comment">// On NodeMCU 1.0 SD0=MISO, SD1=MOSI, CLK=SCLK to connect to TFT in overlap mode</span>
<span class="token comment">// On NodeMCU V3  S0 =MISO, S1 =MOSI, S2 =SCLK</span>
<span class="token comment">// In ESP8266 overlap mode the following must be defined</span>

<span class="token comment">//#define TFT_SPI_OVERLAP</span>

<span class="token comment">// In ESP8266 overlap mode the TFT chip select MUST connect to pin D3</span>
<span class="token comment">//#define TFT_CS   PIN_D3</span>
<span class="token comment">//#define TFT_DC   PIN_D5  // Data Command control pin</span>
<span class="token comment">//#define TFT_RST  PIN_D4  // Reset pin (could connect to NodeMCU RST, see next line)</span>
<span class="token comment">//#define TFT_RST  -1  // Set TFT_RST to -1 if the display RESET is connected to NodeMCU RST or 3.3V</span>


<span class="token comment">// ###### EDIT THE PIN NUMBERS IN THE LINES FOLLOWING TO SUIT YOUR ESP32 SETUP   ######</span>

<span class="token comment">// For ESP32 Dev board (only tested with ILI9341 display)</span>
<span class="token comment">// The hardware SPI can be mapped to any pins</span>

<span class="token comment">// #define TFT_MISO 19</span>
<span class="token comment">// #define TFT_MOSI 23</span>
<span class="token comment">// #define TFT_SCLK 18</span>
<span class="token comment">// #define TFT_CS   15  // Chip select control pin</span>
<span class="token comment">// #define TFT_DC    2  // Data Command control pin</span>
<span class="token comment">// #define TFT_RST   4  // Reset pin (could connect to RST pin)</span>
<span class="token comment">// #define TFT_RST  -1  // Set TFT_RST to -1 if display RESET is connected to ESP32 board RST</span>

<span class="token comment">// For ESP32 Dev board (only tested with GC9A01 display)</span>
<span class="token comment">// The hardware SPI can be mapped to any pins</span>

<span class="token comment">//#define TFT_MOSI 15 // In some display driver board, it might be written as "SDA" and so on.</span>
<span class="token comment">//#define TFT_SCLK 14</span>
<span class="token comment">//#define TFT_CS   5  // Chip select control pin</span>
<span class="token comment">//#define TFT_DC   27  // Data Command control pin</span>
<span class="token comment">//#define TFT_RST  33  // Reset pin (could connect to Arduino RESET pin)</span>
<span class="token comment">//#define TFT_BL   22  // LED back-light</span>

<span class="token comment">//#define TOUCH_CS 21     // Chip select pin (T_CS) of touch screen</span>

<span class="token comment">//#define TFT_WR 22    // Write strobe for modified Raspberry Pi TFT only</span>

<span class="token comment">// For the M5Stack module use these #define lines</span>
<span class="token comment">//#define TFT_MISO 19</span>
<span class="token comment">//#define TFT_MOSI 23</span>
<span class="token comment">//#define TFT_SCLK 18</span>
<span class="token comment">//#define TFT_CS   14  // Chip select control pin</span>
<span class="token comment">//#define TFT_DC   27  // Data Command control pin</span>
<span class="token comment">//#define TFT_RST  33  // Reset pin (could connect to Arduino RESET pin)</span>
<span class="token comment">//#define TFT_BL   32  // LED back-light (required for M5Stack)</span>

<span class="token comment">// ######       EDIT THE PINs BELOW TO SUIT YOUR ESP32 PARALLEL TFT SETUP        ######</span>

<span class="token comment">// The library supports 8 bit parallel TFTs with the ESP32, the pin</span>
<span class="token comment">// selection below is compatible with ESP32 boards in UNO format.</span>
<span class="token comment">// Wemos D32 boards need to be modified, see diagram in Tools folder.</span>
<span class="token comment">// Only ILI9481 and ILI9341 based displays have been tested!</span>

<span class="token comment">// Parallel bus is only supported for the STM32 and ESP32</span>
<span class="token comment">// Example below is for ESP32 Parallel interface with UNO displays</span>

<span class="token comment">// Tell the library to use 8 bit parallel mode (otherwise SPI is assumed)</span>
<span class="token comment">//#define TFT_PARALLEL_8_BIT</span>

<span class="token comment">// The ESP32 and TFT the pins used for testing are:</span>
<span class="token comment">//#define TFT_CS   33  // Chip select control pin (library pulls permanently low</span>
<span class="token comment">//#define TFT_DC   15  // Data Command control pin - must use a pin in the range 0-31</span>
<span class="token comment">//#define TFT_RST  32  // Reset pin, toggles on startup</span>

<span class="token comment">//#define TFT_WR    4  // Write strobe control pin - must use a pin in the range 0-31</span>
<span class="token comment">//#define TFT_RD    2  // Read strobe control pin</span>

<span class="token comment">//#define TFT_D0   12  // Must use pins in the range 0-31 for the data bus</span>
<span class="token comment">//#define TFT_D1   13  // so a single register write sets/clears all bits.</span>
<span class="token comment">//#define TFT_D2   26  // Pins can be randomly assigned, this does not affect</span>
<span class="token comment">//#define TFT_D3   25  // TFT screen update performance.</span>
<span class="token comment">//#define TFT_D4   17</span>
<span class="token comment">//#define TFT_D5   16</span>
<span class="token comment">//#define TFT_D6   27</span>
<span class="token comment">//#define TFT_D7   14</span>

<span class="token comment">// ######       EDIT THE PINs BELOW TO SUIT YOUR STM32 SPI TFT SETUP        ######</span>

<span class="token comment">// The TFT can be connected to SPI port 1 or 2</span>
<span class="token comment">//#define TFT_SPI_PORT 1 // SPI port 1 maximum clock rate is 55MHz</span>
<span class="token comment">//#define TFT_MOSI PA7</span>
<span class="token comment">//#define TFT_MISO PA6</span>
<span class="token comment">//#define TFT_SCLK PA5</span>

<span class="token comment">//#define TFT_SPI_PORT 2 // SPI port 2 maximum clock rate is 27MHz</span>
<span class="token comment">//#define TFT_MOSI PB15</span>
<span class="token comment">//#define TFT_MISO PB14</span>
<span class="token comment">//#define TFT_SCLK PB13</span>

<span class="token comment">// Can use Ardiuno pin references, arbitrary allocation, TFT_eSPI controls chip select</span>
<span class="token comment">//#define TFT_CS   D5 // Chip select control pin to TFT CS</span>
<span class="token comment">//#define TFT_DC   D6 // Data Command control pin to TFT DC (may be labelled RS = Register Select)</span>
<span class="token comment">//#define TFT_RST  D7 // Reset pin to TFT RST (or RESET)</span>
<span class="token comment">// OR alternatively, we can use STM32 port reference names PXnn</span>
<span class="token comment">//#define TFT_CS   PE11 // Nucleo-F767ZI equivalent of D5</span>
<span class="token comment">//#define TFT_DC   PE9  // Nucleo-F767ZI equivalent of D6</span>
<span class="token comment">//#define TFT_RST  PF13 // Nucleo-F767ZI equivalent of D7</span>

<span class="token comment">//#define TFT_RST  -1   // Set TFT_RST to -1 if the display RESET is connected to processor reset</span>
                        <span class="token comment">// Use an Arduino pin for initial testing as connecting to processor reset</span>
                        <span class="token comment">// may not work (pulse too short at power up?)</span>


<span class="token comment">// #define TFT_MISO 19</span>
<span class="token comment">// #define TFT_MOSI 23 // In some display driver board, it might be written as "SDA" and so on.</span>
<span class="token comment">// #define TFT_SCLK 18</span>
<span class="token comment">// #define TFT_CS   -1  // Chip select control pin</span>
<span class="token comment">// #define TFT_DC   16  // Data Command control pin</span>
<span class="token comment">// #define TFT_RST  17  // Reset pin (could connect to Arduino RESET pin)</span>
<span class="token comment">// #define TFT_BL   4  // LED back-light</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TFT_CS</span>   <span class="token expression"><span class="token operator">-</span><span class="token number">1</span> </span><span class="token comment">//     10 or 34 (FSPI CS0)</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TFT_MOSI</span> <span class="token expression"><span class="token number">11</span> </span><span class="token comment">//     11 or 35 (FSPI D)</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TFT_SCLK</span> <span class="token expression"><span class="token number">12</span> </span><span class="token comment">//     12 or 36 (FSPI CLK)</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TFT_MISO</span> <span class="token expression"><span class="token operator">-</span><span class="token number">1</span> </span><span class="token comment">//     13 or 37 (FSPI Q)</span></span>

<span class="token comment">// Use pins in range 0-31</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TFT_DC</span>    <span class="token expression"><span class="token number">7</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TFT_RST</span>   <span class="token expression"><span class="token number">6</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TFT_BL</span>   <span class="token expression"><span class="token number">4</span>  </span><span class="token comment">// LED back-light</span></span>

<span class="token comment">// ##################################################################################</span>
<span class="token comment">//</span>
<span class="token comment">// Section 3. Define the fonts that are to be used here</span>
<span class="token comment">//</span>
<span class="token comment">// ##################################################################################</span>

<span class="token comment">// Comment out the #defines below with // to stop that font being loaded</span>
<span class="token comment">// The ESP8366 and ESP32 have plenty of memory so commenting out fonts is not</span>
<span class="token comment">// normally necessary. If all fonts are loaded the extra FLASH space required is</span>
<span class="token comment">// about 17Kbytes. To save FLASH space only enable the fonts you need!</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LOAD_GLCD</span>   <span class="token comment">// Font 1. Original Adafruit 8 pixel font needs ~1820 bytes in FLASH</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LOAD_FONT2</span>  <span class="token comment">// Font 2. Small 16 pixel high font, needs ~3534 bytes in FLASH, 96 characters</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LOAD_FONT4</span>  <span class="token comment">// Font 4. Medium 26 pixel high font, needs ~5848 bytes in FLASH, 96 characters</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LOAD_FONT6</span>  <span class="token comment">// Font 6. Large 48 pixel font, needs ~2666 bytes in FLASH, only characters 1234567890:-.apm</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LOAD_FONT7</span>  <span class="token comment">// Font 7. 7 segment 48 pixel font, needs ~2438 bytes in FLASH, only characters 1234567890:-.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LOAD_FONT8</span>  <span class="token comment">// Font 8. Large 75 pixel font needs ~3256 bytes in FLASH, only characters 1234567890:-.</span></span>
<span class="token comment">//#define LOAD_FONT8N // Font 8. Alternative to Font 8 above, slightly narrower, so 3 digits fit a 160 pixel TFT</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LOAD_GFXFF</span>  <span class="token comment">// FreeFonts. Include access to the 48 Adafruit_GFX free fonts FF1 to FF48 and custom fonts</span></span>

<span class="token comment">// Comment out the #define below to stop the SPIFFS filing system and smooth font code being loaded</span>
<span class="token comment">// this will save ~20kbytes of FLASH</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SMOOTH_FONT</span></span>


<span class="token comment">// ##################################################################################</span>
<span class="token comment">//</span>
<span class="token comment">// Section 4. Other options</span>
<span class="token comment">//</span>
<span class="token comment">// ##################################################################################</span>

<span class="token comment">// For RP2040 processor and SPI displays, uncomment the following line to use the PIO interface.</span>
<span class="token comment">//#define RP2040_PIO_SPI // Leave commented out to use standard RP2040 SPI port interface</span>

<span class="token comment">// For RP2040 processor and 8 or 16 bit parallel displays:</span>
<span class="token comment">// The parallel interface write cycle period is derived from a division of the CPU clock</span>
<span class="token comment">// speed so scales with the processor clock. This means that the divider ratio may need</span>
<span class="token comment">// to be increased when overclocking. I may also need to be adjusted dependant on the</span>
<span class="token comment">// display controller type (ILI94341, HX8357C etc). If RP2040_PIO_CLK_DIV is not defined</span>
<span class="token comment">// the library will set default values which may not suit your display.</span>
<span class="token comment">// The display controller data sheet will specify the minimum write cycle period. The</span>
<span class="token comment">// controllers often work reliably for shorter periods, however if the period is too short</span>
<span class="token comment">// the display may not initialise or graphics will become corrupted.</span>
<span class="token comment">// PIO write cycle frequency = (CPU clock/(4 * RP2040_PIO_CLK_DIV))</span>
<span class="token comment">//#define RP2040_PIO_CLK_DIV 1 // 32ns write cycle at 125MHz CPU clock</span>
<span class="token comment">//#define RP2040_PIO_CLK_DIV 2 // 64ns write cycle at 125MHz CPU clock</span>
<span class="token comment">//#define RP2040_PIO_CLK_DIV 3 // 96ns write cycle at 125MHz CPU clock</span>

<span class="token comment">// For the RP2040 processor define the SPI port channel used (default 0 if undefined)</span>
<span class="token comment">//#define TFT_SPI_PORT 1 // Set to 0 if SPI0 pins are used, or 1 if spi1 pins used</span>

<span class="token comment">// For the STM32 processor define the SPI port channel used (default 1 if undefined)</span>
<span class="token comment">//#define TFT_SPI_PORT 2 // Set to 1 for SPI port 1, or 2 for SPI port 2</span>

<span class="token comment">// Define the SPI clock frequency, this affects the graphics rendering speed. Too</span>
<span class="token comment">// fast and the TFT driver will not keep up and display corruption appears.</span>
<span class="token comment">// With an ILI9341 display 40MHz works OK, 80MHz sometimes fails</span>
<span class="token comment">// With a ST7735 display more than 27MHz may not work (spurious pixels and lines)</span>
<span class="token comment">// With an ILI9163 display 27 MHz works OK.</span>

<span class="token comment">// #define SPI_FREQUENCY   1000000</span>
<span class="token comment">// #define SPI_FREQUENCY   5000000</span>
<span class="token comment">// #define SPI_FREQUENCY  10000000</span>
<span class="token comment">// #define SPI_FREQUENCY  20000000</span>
<span class="token comment">// #define SPI_FREQUENCY  27000000</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SPI_FREQUENCY</span>  <span class="token expression"><span class="token number">27000000</span></span></span>
<span class="token comment">// #define SPI_FREQUENCY  40000000</span>
<span class="token comment">// #define SPI_FREQUENCY  55000000 // STM32 SPI1 only (SPI2 maximum is 27MHz)</span>
<span class="token comment">// #define SPI_FREQUENCY  80000000</span>

<span class="token comment">// Optional reduced SPI frequency for reading TFT</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SPI_READ_FREQUENCY</span>  <span class="token expression"><span class="token number">20000000</span></span></span>

<span class="token comment">// The XPT2046 requires a lower SPI clock rate of 2.5MHz so we define that here:</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SPI_TOUCH_FREQUENCY</span>  <span class="token expression"><span class="token number">2500000</span></span></span>

<span class="token comment">// The ESP32 has 2 free SPI ports i.e. VSPI and HSPI, the VSPI is the default.</span>
<span class="token comment">// If the VSPI port is in use and pins are not accessible (e.g. TTGO T-Beam)</span>
<span class="token comment">// then uncomment the following line:</span>
<span class="token comment">//#define USE_HSPI_PORT</span>

<span class="token comment">// Comment out the following #define if "SPI Transactions" do not need to be</span>
<span class="token comment">// supported. When commented out the code size will be smaller and sketches will</span>
<span class="token comment">// run slightly faster, so leave it commented out unless you need it!</span>

<span class="token comment">// Transaction support is needed to work with SD library but not needed with TFT_SdFat</span>
<span class="token comment">// Transaction support is required if other SPI devices are connected.</span>

<span class="token comment">// Transactions are automatically enabled by the library for an ESP32 (to use HAL mutex)</span>
<span class="token comment">// so changing it here has no effect</span>

<span class="token comment">// #define SUPPORT_TRANSACTIONS</span>

</code></pre> 
<h4><a id="22__430"></a>2.2 ä¸»å·¥ç¨‹ä»£ç </h4> 
<pre><code class="prism language-c"><span class="token comment">/* *****************************************************************
 *
 * å‚è€ƒ SmallDesktopDisplay åšçš„wifiå¤©æ°”æ—¶é’Ÿ
 * åˆ› å»º æ—¥ æœŸï¼š2023.10.20
 * æœ€åæ›´æ”¹æ—¥æœŸï¼š2023.10.20
 * æ›´ æ”¹ è¯´ æ˜ï¼š
 *            V1.0 æœ€åŸºæœ¬åŠŸèƒ½ï¼Œæ”¯æŒå¤œé—´ç¡çœ æ¨¡å¼
 *
 * å¼• è„š åˆ† é…ï¼š
 *             SCK   GPIO18
 *             MOSI  GPIO23
 *             RES   GPIO17
 *             DC    GPIO16
 *             LCDBL GPIO4
 *
 * *****************************************************************/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Arduino.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ArduinoJson.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;TimeLib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;WiFi.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;WiFiUdp.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;HTTPClient.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;TFT_eSPI.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;SPI.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;TJpg_Decoder.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;esp_sleep.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"number.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"weathernum.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">Version</span>  <span class="token string">"CL V1.0"</span></span>

<span class="token comment">/* *****************************************************************
 *  å­—åº“ã€å›¾ç‰‡åº“
 * *****************************************************************/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"font/ZdyLwFont_20.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"img/misaka.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"img/temperature.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"img/humidity.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"img/pangzi/i0.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"img/pangzi/i1.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"img/pangzi/i2.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"img/pangzi/i3.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"img/pangzi/i4.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"img/pangzi/i5.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"img/pangzi/i6.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"img/pangzi/i7.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"img/pangzi/i8.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"img/pangzi/i9.h"</span></span>
<span class="token comment">/* *****************************************************************
 *  å­—åº“ã€å›¾ç‰‡åº“
 * *****************************************************************/</span>
<span class="token keyword">const</span> <span class="token keyword">char</span> ssid<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"CMCC-pm3h"</span><span class="token punctuation">;</span>            <span class="token comment">// WIFIåç§°</span>
<span class="token keyword">const</span> <span class="token keyword">char</span> password<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"hw2htwv4"</span><span class="token punctuation">;</span>    <span class="token comment">// WIFIå¯†ç </span>
String cityCode <span class="token operator">=</span> <span class="token string">"101280101"</span><span class="token punctuation">;</span>           <span class="token comment">// å¤©æ°”åŸå¸‚ä»£ç ï¼Œå¹¿å·</span>

<span class="token comment">// ç¡çœ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ENABLE_SLEEP</span>                 <span class="token expression"><span class="token number">0</span>     </span><span class="token comment">// æ˜¯å¦å¯ç”¨å¤œé—´ç¡çœ æ¨¡å¼</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SLEEP_COUNT_NIGHT_MAX</span>        <span class="token expression"><span class="token number">12</span>    </span><span class="token comment">// éœ€è¦è·³è¿‡å‡ æ¬¡ï¼Œ20-8ç‚¹ä¸æ›´æ–°</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SLEEP_TIME_START</span>             <span class="token expression"><span class="token number">20</span>    </span><span class="token comment">// 20ç‚¹å¼€å§‹ä¼‘çœ </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SLEEP_TIME_END</span>               <span class="token expression"><span class="token number">7</span>     </span><span class="token comment">// 8ç‚¹ç»“æŸä¼‘çœ </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SLEEP_TIME_NIGHT</span>             <span class="token expression"><span class="token number">60</span>    </span><span class="token comment">// å¤œé—´ä¼‘çœ 60min</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SLEEP_TIME_DAY</span>               <span class="token expression"><span class="token number">10</span>    </span><span class="token comment">// ç™½å¤©ä¼‘çœ 10min</span></span>

TFT_eSPI tft <span class="token operator">=</span> <span class="token function">TFT_eSPI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">// å¼•è„šè¯·è‡ªè¡Œé…ç½®tft_espiåº“ä¸­çš„ User_Setup.hæ–‡ä»¶</span>
TFT_eSprite clk <span class="token operator">=</span> <span class="token function">TFT_eSprite</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tft<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">time_t</span> time_old <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//ä¸Šæ¬¡æ—¶é—´åˆ·æ–°æ—¶é—´</span>
<span class="token class-name">time_t</span> weather_old <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//ä¸Šæ¬¡å¤©æ°”è·å–æ—¶é—´</span>
<span class="token class-name">time_t</span> banner_old <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//ä¸Šæ¬¡banneråˆ·æ–°æ—¶é—´</span>
<span class="token class-name">time_t</span> time_now <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//å½“å‰ç§’</span>
<span class="token class-name">time_t</span> hour_old <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token class-name">time_t</span> hour_now <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
bool isChangeMode <span class="token operator">=</span> false<span class="token punctuation">;</span> <span class="token comment">// å®šä¹‰æ˜¯å¦åˆ‡æ¢åŠ¨å›¾æ ·å¼</span>

Number      dig<span class="token punctuation">;</span>
WeatherNum  wrat<span class="token punctuation">;</span>

<span class="token class-name">uint32_t</span> targetTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> tempNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token comment">//æ¸©åº¦ç™¾åˆ†æ¯”</span>
<span class="token keyword">int</span> humiNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token comment">//æ¹¿åº¦ç™¾åˆ†æ¯”</span>
<span class="token keyword">int</span> tempCol <span class="token operator">=</span><span class="token number">0xffff</span><span class="token punctuation">;</span>   <span class="token comment">//æ¸©åº¦æ˜¾ç¤ºé¢œè‰²</span>
<span class="token keyword">int</span> humiCol <span class="token operator">=</span><span class="token number">0xffff</span><span class="token punctuation">;</span>   <span class="token comment">//æ¹¿åº¦æ˜¾ç¤ºé¢œè‰²</span>

<span class="token keyword">void</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  Serial<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token number">115200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//  #if ENABLE_SLEEP //ä¸ä¼‘çœ </span>
<span class="token comment">//    sleep_at_night(0); //è‡ªåŠ¨ä¼‘çœ æ£€æŸ¥</span>
<span class="token comment">//  #endif</span>
  <span class="token function">print_wakeup_reason</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">tft_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//å±å¹•åˆå§‹åŒ–</span>

  <span class="token comment">//è¿æ¥wifiï¼Œå¹¶åˆ·æ–°è¿›åº¦æ¡</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">wifi_connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// wifiè¿æ¥å¤±è´¥è¿›å…¥ä¼‘çœ ï¼Œä¼‘çœ æ—¶é•¿ SLEEP_TIME_DAY</span>
    <span class="token function">esp_sleep</span><span class="token punctuation">(</span>SLEEP_TIME_DAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">ntp_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//ntpæœåŠ¡åˆå§‹åŒ–</span>
  <span class="token comment">//getCityCode(); //æ ¹æ®IPè‡ªåŠ¨è·å–åŸå¸‚ä»£ç ï¼Œç”¨äºåç»­å¤©æ°”æ˜¾ç¤º</span>
  <span class="token function">tft_display_loading_complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// å°†è¿›åº¦æ¡åˆ·åˆ°100%</span>
  <span class="token function">tft_display_layout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// ç»˜åˆ¶å±å¹•å¸ƒå±€</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  time_now <span class="token operator">=</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  hour_now <span class="token operator">=</span> <span class="token function">hour</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//åˆ·æ–°æ—¶é—´ä¿¡æ¯ï¼Œæ¯ç§’åˆ·æ–°</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>time_now <span class="token operator">!=</span> time_old<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    time_old <span class="token operator">=</span> time_now<span class="token punctuation">;</span>
    <span class="token function">tft_display_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//æ•´ç‚¹æŠ¥æ—¶</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>hour_now <span class="token operator">!=</span> hour_old<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      hour_old <span class="token operator">=</span> hour_now<span class="token punctuation">;</span>
      isChangeMode <span class="token operator">=</span> true<span class="token punctuation">;</span>
      <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ENABLE_SLEEP </span><span class="token comment">//ä¸ä¼‘çœ </span></span>
        <span class="token comment">//å¤œé—´ä¼‘çœ </span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>hour_now <span class="token operator">&gt;=</span> SLEEP_TIME_START <span class="token operator">||</span> hour_now <span class="token operator">&lt;=</span> SLEEP_TIME_END<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
          <span class="token function">sleep_at_night</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç«‹å³ä¼‘çœ </span>
        <span class="token punctuation">}</span>
      <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// åˆ·æ–°å¤©æ°”ä¿¡æ¯ï¼Œæ¯30åˆ†é’Ÿåˆ·æ–°</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>time_now <span class="token operator">-</span> weather_old <span class="token operator">&gt;</span> <span class="token number">30</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    weather_old <span class="token operator">=</span> time_now<span class="token punctuation">;</span>
    <span class="token function">getCityWeather</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// åˆ·æ–°bannerï¼Œæ¯3ç§’åˆ·æ–°</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>time_now <span class="token operator">-</span> banner_old <span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    banner_old <span class="token operator">=</span> time_now<span class="token punctuation">;</span>
    <span class="token function">tft_display_banner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// åˆ·æ–°gif</span>
  <span class="token function">tft_display_gif</span><span class="token punctuation">(</span>isChangeMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>isChangeMode<span class="token punctuation">)</span> isChangeMode<span class="token operator">=</span> false<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<h4><a id="23_tft_580"></a>2.3 tftæ˜¾ç¤ºä»£ç </h4> 
<pre><code class="prism language-c"><span class="token class-name">uint16_t</span> bgColor <span class="token operator">=</span> TFT_BLACK<span class="token punctuation">;</span>   <span class="token comment">// é»‘è‰²èƒŒæ™¯è‰²</span>
<span class="token keyword">int</span> Anim <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>           <span class="token comment">//å¤ªç©ºäººå›¾æ ‡æ˜¾ç¤ºæŒ‡é’ˆè®°å½•</span>
<span class="token keyword">int</span> AprevTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token comment">//å¤ªç©ºäººæ›´æ–°æ—¶é—´è®°å½•</span>

<span class="token comment">//åˆå§‹åŒ–å±å¹•</span>
<span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">tft_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  tft<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// TFTåˆå§‹åŒ–</span>
  tft<span class="token punctuation">.</span><span class="token function">setRotation</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// æ—‹è½¬è§’åº¦0-3</span>
  tft<span class="token punctuation">.</span><span class="token function">setTextColor</span><span class="token punctuation">(</span>TFT_BLACK<span class="token punctuation">,</span> TFT_WHITE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//è®¾ç½®å­—ä½“é¢œè‰²</span>
  tft<span class="token punctuation">.</span><span class="token function">fillScreen</span><span class="token punctuation">(</span>TFT_BLACK<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ¸…å±</span>
  
  TJpgDec<span class="token punctuation">.</span><span class="token function">setJpgScale</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// è®¾ç½®æ”¾å¤§å€æ•°</span>
  TJpgDec<span class="token punctuation">.</span><span class="token function">setSwapBytes</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// å®ƒçš„ä½œç”¨æ˜¯è®¾ç½®TFTæ¶²æ™¶å±çš„åƒç´ å­—èŠ‚åºã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œåƒç´ å­—èŠ‚åºå¯èƒ½éœ€è¦è¢«äº¤æ¢ï¼Œä»¥ç¡®ä¿å›¾åƒæ­£ç¡®æ˜¾ç¤ºã€‚è¿™æ®µä»£ç ä¸­çš„trueè¡¨ç¤ºéœ€è¦äº¤æ¢å­—èŠ‚åºï¼Œè€Œfalseåˆ™è¡¨ç¤ºä¸éœ€è¦äº¤æ¢å­—èŠ‚åºã€‚</span>
  TJpgDec<span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span>tft_output<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// å›è°ƒå‡½æ•°</span>
<span class="token punctuation">}</span>

<span class="token keyword">extern</span> bool <span class="token function">tft_output</span><span class="token punctuation">(</span><span class="token class-name">int16_t</span> x<span class="token punctuation">,</span> <span class="token class-name">int16_t</span> y<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> w<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> h<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> <span class="token operator">*</span>bitmap<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>y <span class="token operator">&gt;=</span> tft<span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// è¿™å¥ä»£ç æ˜¯å°†ä¸€ä¸ªä½å›¾(bitmap)æ˜¾ç¤ºåœ¨TFTå±å¹•ä¸Šï¼Œå…¶ä¸­xå’Œyæ˜¯ä½å›¾å·¦ä¸Šè§’çš„åæ ‡ï¼Œwå’Œhæ˜¯ä½å›¾çš„å®½åº¦å’Œé«˜åº¦ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒå°†ä½å›¾çš„åƒç´ æ•°æ®æ¨é€åˆ°TFTå±å¹•ä¸Šï¼Œä»è€Œåœ¨æŒ‡å®šçš„ä½ç½®æ˜¾ç¤ºå‡ºæ¥ã€‚</span>
  tft<span class="token punctuation">.</span><span class="token function">pushImage</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> bitmap<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// è¿›åº¦æ¡</span>
byte loadNum <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">tft_display_loading</span><span class="token punctuation">(</span>byte delayTime<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  clk<span class="token punctuation">.</span><span class="token function">setColorDepth</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token comment">// è®¾ç½®TFTå±å¹•çš„é¢œè‰²æ·±åº¦ä¸º8ä½ã€‚TFTå±å¹•çš„é¢œè‰²æ·±åº¦æŒ‡çš„æ˜¯æ¯ä¸ªåƒç´ ç‚¹å¯ä»¥æ˜¾ç¤ºçš„é¢œè‰²æ•°é‡ï¼Œ8ä½é¢œè‰²æ·±åº¦å¯ä»¥æ˜¾ç¤º256ç§é¢œè‰²ã€‚</span>
  clk<span class="token punctuation">.</span><span class="token function">createSprite</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                           <span class="token comment">// åˆ›å»ºSprite</span>
  clk<span class="token punctuation">.</span><span class="token function">fillSprite</span><span class="token punctuation">(</span>TFT_BLACK<span class="token punctuation">)</span><span class="token punctuation">;</span>                           <span class="token comment">// å¡«å……é¢œè‰²ï¼šé»‘è‰²</span>

  clk<span class="token punctuation">.</span><span class="token function">drawRoundRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> TFT_WHITE<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// ç”»ä¸€ä¸ªåœ†è§’çŸ©å½¢æ¡†ï¼Œç™½è‰²</span>
  clk<span class="token punctuation">.</span><span class="token function">fillRoundRect</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> loadNum<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> TFT_WHITE<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// ç”»ä¸€ä¸ªå¡«å……çš„åœ†è§’çŸ©å½¢ï¼Œç™½è‰²</span>
  clk<span class="token punctuation">.</span><span class="token function">setTextDatum</span><span class="token punctuation">(</span>CC_DATUM<span class="token punctuation">)</span><span class="token punctuation">;</span>                          <span class="token comment">// è®¾ç½®æ–‡æœ¬æ˜¾ç¤ºåŸºå‡†ä¸ºå±…ä¸­å¯¹é½</span>
  clk<span class="token punctuation">.</span><span class="token function">setTextColor</span><span class="token punctuation">(</span>TFT_GREEN<span class="token punctuation">,</span> TFT_BLACK<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">// è®¾ç½®æ–‡æœ¬çš„å‰æ™¯è‰²å’ŒèƒŒæ™¯è‰²</span>
  clk<span class="token punctuation">.</span><span class="token function">drawString</span><span class="token punctuation">(</span><span class="token string">"Connecting to WiFi"</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// æ˜¾ç¤ºâ€œConnecting to WiFiâ€è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œä½ç½®ä¸º(100,40)ï¼Œå­—ä½“å¤§å°ä¸º2ã€‚</span>
  clk<span class="token punctuation">.</span><span class="token function">pushSprite</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">110</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                             <span class="token comment">// Spriteä¸­å†…å®¹ä¸€æ¬¡æ¨å‘å±å¹•</span>
  clk<span class="token punctuation">.</span><span class="token function">deleteSprite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                  <span class="token comment">// åˆ é™¤Sprite</span>
  loadNum <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>loadNum <span class="token operator">&gt;=</span> <span class="token number">194</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    loadNum <span class="token operator">=</span> <span class="token number">194</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">delay</span><span class="token punctuation">(</span>delayTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// å°†è¿›åº¦æ¡åˆ·åˆ°100%</span>
<span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">tft_display_loading_complete</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>loadNum <span class="token operator">&lt;</span> <span class="token number">194</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//è®©åŠ¨ç”»èµ°å®Œ</span>
    <span class="token function">tft_display_loading</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span> 

<span class="token comment">// ç»˜åˆ¶å±å¹•å¸ƒå±€</span>
<span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">tft_display_layout</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  tft<span class="token punctuation">.</span><span class="token function">fillScreen</span><span class="token punctuation">(</span>bgColor<span class="token punctuation">)</span><span class="token punctuation">;</span>                                   <span class="token comment">//æ¸…å±</span>
  TJpgDec<span class="token punctuation">.</span><span class="token function">drawJpg</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">183</span><span class="token punctuation">,</span>temperature<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>temperature<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//æ¸©åº¦å›¾æ ‡</span>
  TJpgDec<span class="token punctuation">.</span><span class="token function">drawJpg</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">213</span><span class="token punctuation">,</span>humidity<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>humidity<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//æ¹¿åº¦å›¾æ ‡</span>
<span class="token punctuation">}</span>

<span class="token comment">// åˆ·æ–°æ—¶é—´æ˜¾ç¤º</span>
<span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">tft_display_time</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  <span class="token keyword">int</span> timeY <span class="token operator">=</span> <span class="token number">82</span><span class="token punctuation">;</span>
  <span class="token comment">// è®°å½•ä¸Šä¸€æ¬¡æ—¶é—´</span>
  <span class="token keyword">static</span> String hourMinute_old <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> String second_old <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> String week_old <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> String monthDay_old <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> Hour_old   <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> Minute_old <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> Second_old <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">;</span>

  String hourMinute_now <span class="token operator">=</span> <span class="token function">hourMinute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  String week_now <span class="token operator">=</span> <span class="token function">week</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  String monthDay_now <span class="token operator">=</span> <span class="token function">monthDay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//--------------------ä¸­é—´æ—¶é—´åŒºæ˜¾ç¤ºå¼€å§‹--------------------</span>
  <span class="token comment">// æ—¶åˆ†</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>hourMinute_now <span class="token operator">!=</span> hourMinute_old<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    hourMinute_old <span class="token operator">=</span> hourMinute_now<span class="token punctuation">;</span>
    <span class="token comment">// å°æ—¶åˆ·æ–°</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">hour</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span> Hour_old<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
       dig<span class="token punctuation">.</span><span class="token function">printfW3660</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> timeY<span class="token punctuation">,</span> <span class="token function">hour</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       dig<span class="token punctuation">.</span><span class="token function">printfW3660</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">,</span> timeY<span class="token punctuation">,</span> <span class="token function">hour</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       Hour_old <span class="token operator">=</span> <span class="token function">hour</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// åˆ†é’Ÿåˆ·æ–°</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">minute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span> Minute_old <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
       dig<span class="token punctuation">.</span><span class="token function">printfO3660</span><span class="token punctuation">(</span><span class="token number">101</span><span class="token punctuation">,</span> timeY<span class="token punctuation">,</span> <span class="token function">minute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       dig<span class="token punctuation">.</span><span class="token function">printfO3660</span><span class="token punctuation">(</span><span class="token number">141</span><span class="token punctuation">,</span> timeY<span class="token punctuation">,</span> <span class="token function">minute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       Minute_old <span class="token operator">=</span> <span class="token function">minute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ç§’</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">second</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span> Second_old<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
      dig<span class="token punctuation">.</span><span class="token function">printfW1830</span><span class="token punctuation">(</span><span class="token number">182</span><span class="token punctuation">,</span> timeY <span class="token operator">+</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token function">second</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      dig<span class="token punctuation">.</span><span class="token function">printfW1830</span><span class="token punctuation">(</span><span class="token number">202</span><span class="token punctuation">,</span> timeY <span class="token operator">+</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token function">second</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      Second_old <span class="token operator">=</span> <span class="token function">second</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//--------------------ä¸­é—´æ—¶é—´åŒºæ˜¾ç¤ºç»“æŸ--------------------</span>

  clk<span class="token punctuation">.</span><span class="token function">setColorDepth</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  clk<span class="token punctuation">.</span><span class="token function">loadFont</span><span class="token punctuation">(</span>ZdyLwFont_20<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// åŠ è½½æ±‰å­—å­—ä½“</span>
  <span class="token comment">// æ˜ŸæœŸ</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>week_now <span class="token operator">!=</span> week_old<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    week_old <span class="token operator">=</span> week_now<span class="token punctuation">;</span>
    clk<span class="token punctuation">.</span><span class="token function">createSprite</span><span class="token punctuation">(</span><span class="token number">58</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    clk<span class="token punctuation">.</span><span class="token function">fillSprite</span><span class="token punctuation">(</span>bgColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    clk<span class="token punctuation">.</span><span class="token function">setTextDatum</span><span class="token punctuation">(</span>CC_DATUM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    clk<span class="token punctuation">.</span><span class="token function">setTextColor</span><span class="token punctuation">(</span>TFT_WHITE<span class="token punctuation">,</span> bgColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    clk<span class="token punctuation">.</span><span class="token function">drawString</span><span class="token punctuation">(</span><span class="token function">week</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    clk<span class="token punctuation">.</span><span class="token function">pushSprite</span><span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    clk<span class="token punctuation">.</span><span class="token function">deleteSprite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// æœˆæ—¥</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>monthDay_now <span class="token operator">!=</span> monthDay_old<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    monthDay_old <span class="token operator">=</span> monthDay_now<span class="token punctuation">;</span>
    clk<span class="token punctuation">.</span><span class="token function">createSprite</span><span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    clk<span class="token punctuation">.</span><span class="token function">fillSprite</span><span class="token punctuation">(</span>bgColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    clk<span class="token punctuation">.</span><span class="token function">setTextDatum</span><span class="token punctuation">(</span>CC_DATUM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    clk<span class="token punctuation">.</span><span class="token function">setTextColor</span><span class="token punctuation">(</span>TFT_WHITE<span class="token punctuation">,</span> bgColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    clk<span class="token punctuation">.</span><span class="token function">drawString</span><span class="token punctuation">(</span><span class="token function">monthDay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">49</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    clk<span class="token punctuation">.</span><span class="token function">pushSprite</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    clk<span class="token punctuation">.</span><span class="token function">deleteSprite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  clk<span class="token punctuation">.</span><span class="token function">unloadFont</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment">// å¸è½½å­—ä½“</span>
<span class="token punctuation">}</span>

<span class="token comment">//æ¹¿åº¦å›¾æ ‡æ˜¾ç¤ºå‡½æ•°</span>
<span class="token keyword">void</span> <span class="token function">humidityWin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  clk<span class="token punctuation">.</span><span class="token function">setColorDepth</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  humiNum <span class="token operator">=</span> humiNum<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>
  clk<span class="token punctuation">.</span><span class="token function">createSprite</span><span class="token punctuation">(</span><span class="token number">52</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//åˆ›å»ºçª—å£</span>
  clk<span class="token punctuation">.</span><span class="token function">fillSprite</span><span class="token punctuation">(</span><span class="token number">0x0000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//å¡«å……ç‡</span>
  clk<span class="token punctuation">.</span><span class="token function">drawRoundRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">52</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">0xFFFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//ç©ºå¿ƒåœ†è§’çŸ©å½¢  èµ·å§‹ä½x,y,é•¿åº¦ï¼Œå®½åº¦ï¼Œåœ†å¼§åŠå¾„ï¼Œé¢œè‰²</span>
  clk<span class="token punctuation">.</span><span class="token function">fillRoundRect</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>humiNum<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span>humiCol<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//å®å¿ƒåœ†è§’çŸ©å½¢</span>
  clk<span class="token punctuation">.</span><span class="token function">pushSprite</span><span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">,</span><span class="token number">222</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//çª—å£ä½ç½®</span>
  clk<span class="token punctuation">.</span><span class="token function">deleteSprite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//æ¸©åº¦å›¾æ ‡æ˜¾ç¤ºå‡½æ•°</span>
<span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">tempWin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  clk<span class="token punctuation">.</span><span class="token function">setColorDepth</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  clk<span class="token punctuation">.</span><span class="token function">createSprite</span><span class="token punctuation">(</span><span class="token number">52</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//åˆ›å»ºçª—å£</span>
  clk<span class="token punctuation">.</span><span class="token function">fillSprite</span><span class="token punctuation">(</span><span class="token number">0x0000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//å¡«å……ç‡</span>
  clk<span class="token punctuation">.</span><span class="token function">drawRoundRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">52</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">0xFFFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//ç©ºå¿ƒåœ†è§’çŸ©å½¢  èµ·å§‹ä½x,y,é•¿åº¦ï¼Œå®½åº¦ï¼Œåœ†å¼§åŠå¾„ï¼Œé¢œè‰²</span>
  clk<span class="token punctuation">.</span><span class="token function">fillRoundRect</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>tempNum<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span>tempCol<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//å®å¿ƒåœ†è§’çŸ©å½¢</span>
  clk<span class="token punctuation">.</span><span class="token function">pushSprite</span><span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">,</span><span class="token number">192</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//çª—å£ä½ç½®</span>
  clk<span class="token punctuation">.</span><span class="token function">deleteSprite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

String scrollText<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// å¤©æ°”ä¿¡æ¯å†™åˆ°å±å¹•ä¸Š</span>
<span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">tft_display_weather</span><span class="token punctuation">(</span>String <span class="token operator">*</span>cityDZ<span class="token punctuation">,</span> String <span class="token operator">*</span>dataSK<span class="token punctuation">,</span> String <span class="token operator">*</span>dataFC<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  DynamicJsonDocument <span class="token function">doc</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">deserializeJson</span><span class="token punctuation">(</span>doc<span class="token punctuation">,</span> <span class="token operator">*</span>dataSK<span class="token punctuation">)</span><span class="token punctuation">;</span>
  JsonObject sk <span class="token operator">=</span> doc<span class="token punctuation">.</span>as<span class="token operator">&lt;</span>JsonObject<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/***ç»˜åˆ¶ç›¸å…³æ–‡å­—***/</span>
  clk<span class="token punctuation">.</span><span class="token function">setColorDepth</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  clk<span class="token punctuation">.</span><span class="token function">loadFont</span><span class="token punctuation">(</span>ZdyLwFont_20<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// åŠ è½½æ±‰å­—å­—ä½“</span>

  <span class="token comment">// æ¸©åº¦</span>
  clk<span class="token punctuation">.</span><span class="token function">createSprite</span><span class="token punctuation">(</span><span class="token number">58</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// åˆ›å»ºSprite</span>
  clk<span class="token punctuation">.</span><span class="token function">fillSprite</span><span class="token punctuation">(</span>bgColor<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// å¡«å……é¢œè‰²</span>
  clk<span class="token punctuation">.</span><span class="token function">setTextDatum</span><span class="token punctuation">(</span>CC_DATUM<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//  æ˜¾ç¤ºå¯¹é½æ–¹å¼</span>
  clk<span class="token punctuation">.</span><span class="token function">setTextColor</span><span class="token punctuation">(</span>TFT_WHITE<span class="token punctuation">,</span> bgColor<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ–‡æœ¬çš„å‰æ™¯è‰²å’ŒèƒŒæ™¯è‰²</span>
  clk<span class="token punctuation">.</span><span class="token function">drawString</span><span class="token punctuation">(</span>sk<span class="token punctuation">[</span><span class="token string">"temp"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>as<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"â„ƒ"</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ˜¾ç¤ºæ–‡æœ¬</span>
  clk<span class="token punctuation">.</span><span class="token function">pushSprite</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">184</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Spriteä¸­å†…å®¹ä¸€æ¬¡æ¨å‘å±å¹•</span>
  clk<span class="token punctuation">.</span><span class="token function">deleteSprite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// åˆ é™¤Sprite</span>
  tempNum <span class="token operator">=</span> sk<span class="token punctuation">[</span><span class="token string">"temp"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>as<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  tempNum <span class="token operator">=</span> tempNum<span class="token operator">+</span><span class="token number">10</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>tempNum<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">)</span>
    tempCol<span class="token operator">=</span><span class="token number">0x00FF</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>tempNum<span class="token operator">&lt;</span><span class="token number">28</span><span class="token punctuation">)</span>
    tempCol<span class="token operator">=</span><span class="token number">0x0AFF</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>tempNum<span class="token operator">&lt;</span><span class="token number">34</span><span class="token punctuation">)</span>
    tempCol<span class="token operator">=</span><span class="token number">0x0F0F</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>tempNum<span class="token operator">&lt;</span><span class="token number">41</span><span class="token punctuation">)</span>
    tempCol<span class="token operator">=</span><span class="token number">0xFF0F</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>tempNum<span class="token operator">&lt;</span><span class="token number">49</span><span class="token punctuation">)</span>
    tempCol<span class="token operator">=</span><span class="token number">0xF00F</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">{<!-- --></span>
    tempCol<span class="token operator">=</span><span class="token number">0xF00F</span><span class="token punctuation">;</span>
    tempNum<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">tempWin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// æ¹¿åº¦</span>
  clk<span class="token punctuation">.</span><span class="token function">createSprite</span><span class="token punctuation">(</span><span class="token number">58</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  clk<span class="token punctuation">.</span><span class="token function">fillSprite</span><span class="token punctuation">(</span>bgColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  clk<span class="token punctuation">.</span><span class="token function">setTextDatum</span><span class="token punctuation">(</span>CC_DATUM<span class="token punctuation">)</span><span class="token punctuation">;</span>
  clk<span class="token punctuation">.</span><span class="token function">setTextColor</span><span class="token punctuation">(</span>TFT_WHITE<span class="token punctuation">,</span> bgColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  clk<span class="token punctuation">.</span><span class="token function">drawString</span><span class="token punctuation">(</span>sk<span class="token punctuation">[</span><span class="token string">"SD"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>as<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  clk<span class="token punctuation">.</span><span class="token function">pushSprite</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">214</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  clk<span class="token punctuation">.</span><span class="token function">deleteSprite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  humiNum <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span><span class="token punctuation">(</span>sk<span class="token punctuation">[</span><span class="token string">"SD"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>as<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span>humiNum<span class="token operator">&gt;</span><span class="token number">90</span><span class="token punctuation">)</span>
    humiCol<span class="token operator">=</span><span class="token number">0x00FF</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>humiNum<span class="token operator">&gt;</span><span class="token number">70</span><span class="token punctuation">)</span>
    humiCol<span class="token operator">=</span><span class="token number">0x0AFF</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>humiNum<span class="token operator">&gt;</span><span class="token number">40</span><span class="token punctuation">)</span>
    humiCol<span class="token operator">=</span><span class="token number">0x0F0F</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>humiNum<span class="token operator">&gt;</span><span class="token number">20</span><span class="token punctuation">)</span>
    humiCol<span class="token operator">=</span><span class="token number">0xFF0F</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    humiCol<span class="token operator">=</span><span class="token number">0xF00F</span><span class="token punctuation">;</span>
  <span class="token function">humidityWin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//åŸå¸‚åç§°</span>
  clk<span class="token punctuation">.</span><span class="token function">createSprite</span><span class="token punctuation">(</span><span class="token number">94</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  clk<span class="token punctuation">.</span><span class="token function">fillSprite</span><span class="token punctuation">(</span>bgColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  clk<span class="token punctuation">.</span><span class="token function">setTextDatum</span><span class="token punctuation">(</span>CC_DATUM<span class="token punctuation">)</span><span class="token punctuation">;</span>
  clk<span class="token punctuation">.</span><span class="token function">setTextColor</span><span class="token punctuation">(</span>TFT_WHITE<span class="token punctuation">,</span> bgColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  clk<span class="token punctuation">.</span><span class="token function">drawString</span><span class="token punctuation">(</span>sk<span class="token punctuation">[</span><span class="token string">"cityname"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>as<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">44</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  clk<span class="token punctuation">.</span><span class="token function">pushSprite</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  clk<span class="token punctuation">.</span><span class="token function">deleteSprite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// PM2.5ç©ºæ°”æŒ‡æ•°</span>
  <span class="token class-name">uint16_t</span> pm25BgColor <span class="token operator">=</span> tft<span class="token punctuation">.</span><span class="token function">color565</span><span class="token punctuation">(</span><span class="token number">156</span><span class="token punctuation">,</span> <span class="token number">202</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ä¼˜</span>
  String aqiTxt <span class="token operator">=</span> <span class="token string">"ä¼˜"</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> pm25V <span class="token operator">=</span> sk<span class="token punctuation">[</span><span class="token string">"aqi"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>pm25V <span class="token operator">&gt;</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    pm25BgColor <span class="token operator">=</span> tft<span class="token punctuation">.</span><span class="token function">color565</span><span class="token punctuation">(</span><span class="token number">136</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// é‡åº¦</span>
    aqiTxt <span class="token operator">=</span> <span class="token string">"é‡åº¦"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pm25V <span class="token operator">&gt;</span> <span class="token number">150</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    pm25BgColor <span class="token operator">=</span> tft<span class="token punctuation">.</span><span class="token function">color565</span><span class="token punctuation">(</span><span class="token number">186</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">121</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// ä¸­åº¦</span>
    aqiTxt <span class="token operator">=</span> <span class="token string">"ä¸­åº¦"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pm25V <span class="token operator">&gt;</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    pm25BgColor <span class="token operator">=</span> tft<span class="token punctuation">.</span><span class="token function">color565</span><span class="token punctuation">(</span><span class="token number">242</span><span class="token punctuation">,</span> <span class="token number">159</span><span class="token punctuation">,</span> <span class="token number">57</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// è½»</span>
    aqiTxt <span class="token operator">=</span> <span class="token string">"è½»åº¦"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pm25V <span class="token operator">&gt;</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    pm25BgColor <span class="token operator">=</span> tft<span class="token punctuation">.</span><span class="token function">color565</span><span class="token punctuation">(</span><span class="token number">247</span><span class="token punctuation">,</span> <span class="token number">219</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// è‰¯</span>
    aqiTxt <span class="token operator">=</span> <span class="token string">"è‰¯"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// å…ˆç»˜åˆ¶èƒŒæ™¯é¢œè‰²</span>
  clk<span class="token punctuation">.</span><span class="token function">createSprite</span><span class="token punctuation">(</span><span class="token number">56</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  clk<span class="token punctuation">.</span><span class="token function">fillSprite</span><span class="token punctuation">(</span>bgColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  clk<span class="token punctuation">.</span><span class="token function">fillRoundRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span>pm25BgColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å†ç»˜åˆ¶æ–‡æœ¬</span>
  clk<span class="token punctuation">.</span><span class="token function">setTextDatum</span><span class="token punctuation">(</span>CC_DATUM<span class="token punctuation">)</span><span class="token punctuation">;</span>
  clk<span class="token punctuation">.</span><span class="token function">setTextColor</span><span class="token punctuation">(</span><span class="token number">0x0000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  clk<span class="token punctuation">.</span><span class="token function">drawString</span><span class="token punctuation">(</span>aqiTxt<span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  clk<span class="token punctuation">.</span><span class="token function">pushSprite</span><span class="token punctuation">(</span><span class="token number">104</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  clk<span class="token punctuation">.</span><span class="token function">deleteSprite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  scrollText<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"å®æ—¶å¤©æ°” "</span> <span class="token operator">+</span> sk<span class="token punctuation">[</span><span class="token string">"weather"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>as<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  scrollText<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"ç©ºæ°”è´¨é‡ "</span> <span class="token operator">+</span> aqiTxt<span class="token punctuation">;</span>
  scrollText<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"é£å‘ "</span> <span class="token operator">+</span> sk<span class="token punctuation">[</span><span class="token string">"WD"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>as<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> sk<span class="token punctuation">[</span><span class="token string">"WS"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>as<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//å¤©æ°”å›¾æ ‡</span>
  wrat<span class="token punctuation">.</span><span class="token function">printfWeather</span><span class="token punctuation">(</span><span class="token number">170</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token function">atoi</span><span class="token punctuation">(</span><span class="token punctuation">(</span>sk<span class="token punctuation">[</span><span class="token string">"weathercode"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>as<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// å·¦ä¸Šè§’æ»šåŠ¨å­—å¹•</span>
  <span class="token comment">// è§£æç¬¬äºŒæ®µJSON</span>
  <span class="token function">deserializeJson</span><span class="token punctuation">(</span>doc<span class="token punctuation">,</span> <span class="token operator">*</span>cityDZ<span class="token punctuation">)</span><span class="token punctuation">;</span>
  JsonObject dz <span class="token operator">=</span> doc<span class="token punctuation">.</span>as<span class="token operator">&lt;</span>JsonObject<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//Serial.println(sk["ws"].as&lt;String&gt;());</span>
  <span class="token comment">//æ¨ªå‘æ»šåŠ¨æ–¹å¼</span>
  <span class="token comment">//String aa = "ä»Šæ—¥å¤©æ°”:" + dz["weather"].as&lt;String&gt;() + "ï¼Œæ¸©åº¦:æœ€ä½" + dz["tempn"].as&lt;String&gt;() + "ï¼Œæœ€é«˜" + dz["temp"].as&lt;String&gt;() + " ç©ºæ°”è´¨é‡:" + aqiTxt + "ï¼Œé£å‘:" + dz["wd"].as&lt;String&gt;() + dz["ws"].as&lt;String&gt;();</span>
  <span class="token comment">//scrollTextWidth = clk.textWidth(scrollText);</span>
  <span class="token comment">//Serial.println(aa);</span>
  scrollText<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"ä»Šæ—¥"</span> <span class="token operator">+</span> dz<span class="token punctuation">[</span><span class="token string">"weather"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>as<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">deserializeJson</span><span class="token punctuation">(</span>doc<span class="token punctuation">,</span> <span class="token operator">*</span>dataFC<span class="token punctuation">)</span><span class="token punctuation">;</span>
  JsonObject fc <span class="token operator">=</span> doc<span class="token punctuation">.</span>as<span class="token operator">&lt;</span>JsonObject<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  scrollText<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"æœ€ä½æ¸©åº¦"</span> <span class="token operator">+</span> fc<span class="token punctuation">[</span><span class="token string">"fd"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>as<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"â„ƒ"</span><span class="token punctuation">;</span>
  scrollText<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"æœ€é«˜æ¸©åº¦"</span> <span class="token operator">+</span> fc<span class="token punctuation">[</span><span class="token string">"fc"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>as<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"â„ƒ"</span><span class="token punctuation">;</span>

  <span class="token comment">//Serial.println(scrollText[0]);</span>

  clk<span class="token punctuation">.</span><span class="token function">unloadFont</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> currentIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> prevTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
TFT_eSprite clkb <span class="token operator">=</span> <span class="token function">TFT_eSprite</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tft<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// å¤©æ°”æ»šåŠ¨æ¡æ˜¾ç¤º</span>
<span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">tft_display_banner</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>scrollText<span class="token punctuation">[</span>currentIndex<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      clkb<span class="token punctuation">.</span><span class="token function">setColorDepth</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      clkb<span class="token punctuation">.</span><span class="token function">loadFont</span><span class="token punctuation">(</span>ZdyLwFont_20<span class="token punctuation">)</span><span class="token punctuation">;</span>
      clkb<span class="token punctuation">.</span><span class="token function">createSprite</span><span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      clkb<span class="token punctuation">.</span><span class="token function">fillSprite</span><span class="token punctuation">(</span>bgColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
      clkb<span class="token punctuation">.</span><span class="token function">setTextWrap</span><span class="token punctuation">(</span>false<span class="token punctuation">)</span><span class="token punctuation">;</span>
      clkb<span class="token punctuation">.</span><span class="token function">setTextDatum</span><span class="token punctuation">(</span>CC_DATUM<span class="token punctuation">)</span><span class="token punctuation">;</span>
      clkb<span class="token punctuation">.</span><span class="token function">setTextColor</span><span class="token punctuation">(</span>TFT_WHITE<span class="token punctuation">,</span> bgColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
      clkb<span class="token punctuation">.</span><span class="token function">drawString</span><span class="token punctuation">(</span>scrollText<span class="token punctuation">[</span>currentIndex<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">74</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      clkb<span class="token punctuation">.</span><span class="token function">pushSprite</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      clkb<span class="token punctuation">.</span><span class="token function">deleteSprite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      clkb<span class="token punctuation">.</span><span class="token function">unloadFont</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span><span class="token punctuation">(</span>currentIndex<span class="token operator">&gt;=</span><span class="token number">5</span><span class="token punctuation">)</span>
        currentIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">//å›ç¬¬ä¸€ä¸ª</span>
      <span class="token keyword">else</span>
        currentIndex <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">//å‡†å¤‡åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ª</span>
    <span class="token punctuation">}</span>
    prevTime <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// åˆ·æ–°gif</span>
<span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">tft_display_gif</span><span class="token punctuation">(</span>bool isChangeMode<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">160</span><span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token number">160</span><span class="token punctuation">;</span>
  <span class="token comment">//x msåˆ‡æ¢ä¸€æ¬¡</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">millis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> AprevTime <span class="token operator">&gt;</span> <span class="token number">37</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Anim<span class="token operator">++</span><span class="token punctuation">;</span>
    AprevTime <span class="token operator">=</span> <span class="token function">millis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>Anim<span class="token operator">==</span><span class="token number">10</span><span class="token punctuation">)</span>
    Anim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">switch</span><span class="token punctuation">(</span>Anim<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
      TJpgDec<span class="token punctuation">.</span><span class="token function">drawJpg</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>i0<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>i0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
      TJpgDec<span class="token punctuation">.</span><span class="token function">drawJpg</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>i1<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>i1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
      TJpgDec<span class="token punctuation">.</span><span class="token function">drawJpg</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>i2<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>i2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
      TJpgDec<span class="token punctuation">.</span><span class="token function">drawJpg</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>i3<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>i3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>
      TJpgDec<span class="token punctuation">.</span><span class="token function">drawJpg</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>i4<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>i4<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span>
      TJpgDec<span class="token punctuation">.</span><span class="token function">drawJpg</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>i5<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>i5<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">6</span><span class="token operator">:</span>
      TJpgDec<span class="token punctuation">.</span><span class="token function">drawJpg</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>i6<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>i6<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">7</span><span class="token operator">:</span>
      TJpgDec<span class="token punctuation">.</span><span class="token function">drawJpg</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>i7<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>i7<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">8</span><span class="token operator">:</span>
      TJpgDec<span class="token punctuation">.</span><span class="token function">drawJpg</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>i8<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>i8<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">9</span><span class="token operator">:</span>
      TJpgDec<span class="token punctuation">.</span><span class="token function">drawJpg</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>i9<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>i9<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ˜¾ç¤ºAnimé”™è¯¯"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h4><a id="24__945"></a>2.4 ç¡çœ æ¨¡å¼</h4> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TFT_COMMAND_HWRESET</span>                      <span class="token expression"><span class="token number">0x61</span>  </span><span class="token comment">//tft command: HWRESET(61h): Hardeware Reset</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TFT_COMMAND_SWRESET</span>                      <span class="token expression"><span class="token number">0x01</span>  </span><span class="token comment">//tft command: SWRESET(01h): Software Reset</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TFT_COMMAND_SLPIN</span>                        <span class="token expression"><span class="token number">0x10</span>  </span><span class="token comment">//tft command: SLPIN(10h): Sleep In mode</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TFT_COMMAND_DLPOFFSAVE</span>                   <span class="token expression"><span class="token number">0xBD</span>  </span><span class="token comment">//tft command: DLPOFFSAVE (BDh): Display off power save</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TFT_COMMANDDATA_DOFSAVE</span>                  <span class="token expression"><span class="token number">0x00</span>  </span><span class="token comment">//tft command data: Power save for display off mode. When DOFSAVE=0, power consumption in display off mode will be saved.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TFT_COMMAND_DELAY</span>                          <span class="token expression"><span class="token number">10</span>  </span><span class="token comment">//delay 10ms for next command</span></span>

<span class="token comment">//æ‰“å¼€æ˜¾ç¤º</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">tft_display_reset</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  tft<span class="token punctuation">.</span><span class="token function">writecommand</span><span class="token punctuation">(</span>TFT_COMMAND_HWRESET<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Hardeware Reset</span>
  <span class="token function">delayMicroseconds</span><span class="token punctuation">(</span>TFT_COMMAND_DELAY<span class="token punctuation">)</span><span class="token punctuation">;</span>

  tft<span class="token punctuation">.</span><span class="token function">writecommand</span><span class="token punctuation">(</span>TFT_COMMAND_SWRESET<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Software Reset</span>
  <span class="token function">delayMicroseconds</span><span class="token punctuation">(</span>TFT_COMMAND_DELAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//å…³é—­æ˜¾ç¤º</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">tft_display_off</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  tft<span class="token punctuation">.</span><span class="token function">writecommand</span><span class="token punctuation">(</span>TFT_COMMAND_SLPIN<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//tft è®¾ç½®ä¸º Sleep In mode</span>
  <span class="token function">delayMicroseconds</span><span class="token punctuation">(</span>TFT_COMMAND_DELAY<span class="token punctuation">)</span><span class="token punctuation">;</span>

  tft<span class="token punctuation">.</span><span class="token function">writecommand</span><span class="token punctuation">(</span>TFT_COMMAND_DLPOFFSAVE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//tft è®¾ç½®ä¸º Display off power save</span>
  <span class="token function">delayMicroseconds</span><span class="token punctuation">(</span>TFT_COMMAND_DELAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  tft<span class="token punctuation">.</span><span class="token function">writedata</span><span class="token punctuation">(</span>TFT_COMMANDDATA_DOFSAVE<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">delayMicroseconds</span><span class="token punctuation">(</span>TFT_COMMAND_DELAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">uS_TO_S_FACTOR</span> <span class="token expression"><span class="token number">1000000</span>  </span><span class="token comment">/* Conversion factor for micro seconds to seconds */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TIME_TO_SLEEP</span>  <span class="token expression"><span class="token number">5</span>        </span><span class="token comment">/* Time ESP32 will go to sleep (in seconds) */</span></span>

<span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">print_wakeup_reason</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  <span class="token class-name">esp_sleep_wakeup_cause_t</span> wakeup_reason<span class="token punctuation">;</span>

  wakeup_reason <span class="token operator">=</span> <span class="token function">esp_sleep_get_wakeup_cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">switch</span><span class="token punctuation">(</span>wakeup_reason<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">case</span> ESP_SLEEP_WAKEUP_EXT0 <span class="token operator">:</span> Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Wakeup caused by external signal using RTC_IO"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> ESP_SLEEP_WAKEUP_EXT1 <span class="token operator">:</span> Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Wakeup caused by external signal using RTC_CNTL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> ESP_SLEEP_WAKEUP_TIMER <span class="token operator">:</span> Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Wakeup caused by timer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> ESP_SLEEP_WAKEUP_TOUCHPAD <span class="token operator">:</span> Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Wakeup caused by touchpad"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> ESP_SLEEP_WAKEUP_ULP <span class="token operator">:</span> Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Wakeup caused by ULP program"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span> <span class="token operator">:</span> Serial<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Wakeup was not caused by deep sleep: %d\n"</span><span class="token punctuation">,</span>wakeup_reason<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// ç³»ç»Ÿä¼‘çœ </span>
<span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">esp_sleep</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> minutes<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  <span class="token function">tft_display_off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//å…³é—­æ˜¾ç¤º</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>minutes <span class="token operator">&gt;</span> <span class="token number">70</span><span class="token punctuation">)</span> minutes <span class="token operator">=</span> <span class="token number">70</span><span class="token punctuation">;</span>
  <span class="token class-name">uint32_t</span> timeOut <span class="token operator">=</span> minutes <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000000</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>timeOut<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">esp_sleep_enable_timer_wakeup</span><span class="token punctuation">(</span>timeOut<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// å®šæ—¶æ—¶é—´,å•ä½Î¼ç§’, ç±»å‹uint64_t, æ‰€ä»¥å®šæ—¶æ—¶é—´è¦åœ¨584942å¹´ä»¥å†…</span>
  Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"è¿›å…¥ç¡çœ æ¨¡å¼"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"æ—¶é—´ç¡çœ ï¼ˆåˆ†é’Ÿï¼‰ï¼š"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>minutes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">esp_deep_sleep_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

RTC_DATA_ATTR <span class="token keyword">int</span> RTC_sleep_count_night <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// 20-8ç‚¹ä¸æ›´æ–°</span>

<span class="token comment">//å¤œé—´ä¼‘çœ , 0-è‡ªåŠ¨ï¼Œ1-ç«‹å³</span>
<span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">sleep_at_night</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> type<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  <span class="token comment">//ç«‹å³ä¼‘çœ </span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"need sleep"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    RTC_sleep_count_night <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">esp_sleep</span><span class="token punctuation">(</span>SLEEP_TIME_NIGHT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//è‡ªåŠ¨åˆ¤æ–­æ˜¯å¦ä¼‘çœ </span>
  Serial<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"RTC_sleep_count_night: %d\n"</span><span class="token punctuation">,</span> RTC_sleep_count_night<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ç»§ç»­ä¼‘çœ </span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>RTC_sleep_count_night <span class="token operator">&lt;</span> SLEEP_COUNT_NIGHT_MAX<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"auto sleep"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">++</span>RTC_sleep_count_night<span class="token punctuation">;</span>
    <span class="token function">esp_sleep</span><span class="token punctuation">(</span>SLEEP_TIME_NIGHT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"weak up"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//ä¸ä¼‘çœ åˆ™ç‚¹äº®å±å¹•</span>
  <span class="token function">tft_display_reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="25__1035"></a>2.5 è·å–å¤©æ°”ä¿¡æ¯</h4> 
<pre><code class="prism language-c"><span class="token comment">//è·å–åŸå¸‚ä»£ç </span>
<span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">getCityCode</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  String URL <span class="token operator">=</span> <span class="token string">"http://wgeo.weather.com.cn/ip/?_="</span> <span class="token operator">+</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//åˆ›å»º HTTPClient å¯¹è±¡</span>
  HTTPClient httpClient<span class="token punctuation">;</span>
  <span class="token comment">//é…ç½®è¯·æ±‚åœ°å€ã€‚æ­¤å¤„ä¹Ÿå¯ä»¥ä¸ä½¿ç”¨ç«¯å£å·å’ŒPATHè€Œå•çº¯çš„</span>
  httpClient<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span>URL<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//è®¾ç½®è¯·æ±‚å¤´ä¸­çš„User-Agent</span>
  httpClient<span class="token punctuation">.</span><span class="token function">setUserAgent</span><span class="token punctuation">(</span><span class="token string">"Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ä¸åŠ è¿™ä¸€å¥æ‹¿ä¸åˆ°å¯¹åº”ç¼–å· æ„Ÿè§‰è¿™é‡Œæ˜¯ç‰¹æ„å¤„ç†äº† ä¸å»ºè®®ä¸€ç›´è°ƒç”¨</span>
  httpClient<span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token string">"Referer"</span><span class="token punctuation">,</span> <span class="token string">"http://www.weather.com.cn/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//å¯åŠ¨è¿æ¥å¹¶å‘é€HTTPè¯·æ±‚</span>
  <span class="token keyword">int</span> httpCode <span class="token operator">=</span> httpClient<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Send GET request to URL: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>URL<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//å¦‚æœæœåŠ¡å™¨å“åº”OKåˆ™ä»æœåŠ¡å™¨è·å–å“åº”ä½“ä¿¡æ¯å¹¶é€šè¿‡ä¸²å£è¾“å‡º</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>httpCode <span class="token operator">==</span> HTTP_CODE_OK<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    String str <span class="token operator">=</span> httpClient<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Get Response: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> aa <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"id="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>aa <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
      <span class="token comment">//cityCode = str.substring(aa+4,aa+4+9).toInt();</span>
      cityCode <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>aa <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> aa <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>cityCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
      Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"è·å–åŸå¸‚ä»£ç å¤±è´¥"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"è¯·æ±‚åŸå¸‚ä»£ç é”™è¯¯ï¼š"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>httpCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//å…³é—­ä¸æœåŠ¡å™¨è¿æ¥</span>
  httpClient<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">// è·å–åŸå¸‚å¤©æ°”</span>
<span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">getCityWeather</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  String URL <span class="token operator">=</span> <span class="token string">"http://d1.weather.com.cn/weather_index/"</span> <span class="token operator">+</span> cityCode <span class="token operator">+</span> <span class="token string">".html?_="</span> <span class="token operator">+</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//åˆ›å»º HTTPClient å¯¹è±¡</span>
  HTTPClient httpClient<span class="token punctuation">;</span>
  httpClient<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span>URL<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//è®¾ç½®è¯·æ±‚å¤´ä¸­çš„User-Agent</span>
  httpClient<span class="token punctuation">.</span><span class="token function">setUserAgent</span><span class="token punctuation">(</span><span class="token string">"Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  httpClient<span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token string">"Referer"</span><span class="token punctuation">,</span> <span class="token string">"http://www.weather.com.cn/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//å¯åŠ¨è¿æ¥å¹¶å‘é€HTTPè¯·æ±‚</span>
  <span class="token keyword">int</span> httpCode <span class="token operator">=</span> httpClient<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ­£åœ¨è·å–å¤©æ°”æ•°æ®"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>URL<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//å¦‚æœæœåŠ¡å™¨å“åº”OKåˆ™ä»æœåŠ¡å™¨è·å–å“åº”ä½“ä¿¡æ¯å¹¶é€šè¿‡ä¸²å£è¾“å‡º</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>httpCode <span class="token operator">==</span> HTTP_CODE_OK<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    String str <span class="token operator">=</span> httpClient<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> indexStart <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"weatherinfo\":"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> indexEnd <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"};var alarmDZ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    String jsonCityDZ <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>indexStart <span class="token operator">+</span> <span class="token number">13</span><span class="token punctuation">,</span> indexEnd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jsonCityDZ<span class="token punctuation">)</span><span class="token punctuation">;</span>

    indexStart <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"dataSK ="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    indexEnd <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">";var dataZS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    String jsonDataSK <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>indexStart <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">,</span> indexEnd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jsonDataSK<span class="token punctuation">)</span><span class="token punctuation">;</span>

    indexStart <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"\"f\":["</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    indexEnd <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">",{\"fa"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    String jsonFC <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>indexStart <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">,</span> indexEnd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jsonFC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">tft_display_weather</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>jsonCityDZ<span class="token punctuation">,</span> <span class="token operator">&amp;</span>jsonDataSK<span class="token punctuation">,</span> <span class="token operator">&amp;</span>jsonFC<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"è·å–æˆåŠŸ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"è¯·æ±‚åŸå¸‚å¤©æ°”é”™è¯¯ï¼š"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>httpCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//å…³é—­ä¸æœåŠ¡å™¨è¿æ¥</span>
  httpClient<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/cc650276d17388744d68b3cfd9db10bf/" rel="prev">
			<span class="pager__subtitle">Â«&thinsp;Previous</span>
			<p class="pager__title">Roså›¾åƒå¤„ç†ï¼ˆä¸€ï¼‰</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4a7b8cc89fdcaf3d35106178a839c6b3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;Â»</span>
			<p class="pager__title">officeå®çš„ç®€å•åˆ¶ä½œ</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 ç¼–ç¨‹å¤§ç™½çš„åšå®¢.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>