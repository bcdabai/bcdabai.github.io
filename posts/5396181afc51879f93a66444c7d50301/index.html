<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>K8s部署轻量级日志收集系统EFK（elasticsearch &#43; filebeat &#43; kibana） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="K8s部署轻量级日志收集系统EFK（elasticsearch &#43; filebeat &#43; kibana）" />
<meta property="og:description" content="文章目录 K8s部署EFK（elasticsear &#43; filebeat &#43; kibana）日志收集一.准备镜像二.搭建Elasticsearch &#43; kibana1.在可执行kubectl命令的服务器准备安装的yml文件2.在elasticsearch-kibana目录下创建配置文件elasticsearch.yml3.创建kibana配置文件kibana.yml4.在k8s中创建elasticsearch和kibana的配置文件configmap5.检查是否有StorageClass6.创建es-kibana的yaml配置文件: es-statefulset.yaml7.创建es-kibana cluserip的svc8.创建es-kibana的nodeport类型的svc 三.配置NFS服务器1).安装NFS服务2).k8s注册nfs服务 四.创建filebeat服务1.创建filebeat主配置文件filebeat.settings.configmap.yml2.创建Filebeat索引生命周期策略配置文件3.Filebeat操作权限4.Filebeat Daemonset配置文件 五.检查File beat与es，Kibana是否配置成功1.首先在侧边栏找到Stack Management2.选择索引管理，查看是否有以filebeat-demo加时间戳为名的索引3.创建索引模式4.查看日志 K8s部署EFK（elasticsear &#43; filebeat &#43; kibana）日志收集 一.准备镜像 # 在本机拉取镜像 docker pull docker.elastic.co/elasticsearch/elasticsearch:7.17.2 docker pull docker.elastic.co/kibana/kibana:7.17.2 docker pull docker.elastic.co/beats/filebeat:7.17.2 # 对镜像重打标签 将${harbor_url}和${harbor_project}换成自己的harbor私服地址和目录 docker tag docker.elastic.co/elasticsearch/elasticsearch:7.17.2 ${harbor_url}/${harbor_project}/elasticsearch:7.17.2 docker tag docker.elastic.co/kibana/kibana:7.17.2 ${harbor_url}/${harbor_project}/kibana:7.17.2 docker tag docker.elastic.co/beats/filebeat:7.17.2 ${harbor_url}/${harbor_project}/filebeat:7.17.2 # 登陆自己的harbor服务器 docker login -u admin -p ${password} ${harbor_url} # 上传至harbor仓库 docker push ${harbor_url}/${harbor_project}/elasticsearch:7.17.2 docker push ${harbor_url}/${harbor_project}/kibana:7.17.2 docker push ${harbor_url}/${harbor_project}/filebeat:7.17.2 此处的目的是避免某些服务器从docker外网仓库拉取不了镜像，从而导致pod一直运行不了，当然也可以不用这一步，可以直接使用官方的镜像地址" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/5396181afc51879f93a66444c7d50301/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-29T11:28:55+08:00" />
<meta property="article:modified_time" content="2023-12-29T11:28:55+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">K8s部署轻量级日志收集系统EFK（elasticsearch &#43; filebeat &#43; kibana）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#K8sEFKelasticsear__filebeat__kibana_2" rel="nofollow">K8s部署EFK（elasticsear + filebeat + kibana）日志收集</a></li><li><ul><li><ul><li><a href="#_4" rel="nofollow">一.准备镜像</a></li><li><a href="#Elasticsearch__kibana_45" rel="nofollow">二.搭建Elasticsearch + kibana</a></li><li><ul><li><ul><li><a href="#1kubectlyml_47" rel="nofollow">1.在可执行kubectl命令的服务器准备安装的yml文件</a></li><li><a href="#2elasticsearchkibanaelasticsearchyml_51" rel="nofollow">2.在elasticsearch-kibana目录下创建配置文件elasticsearch.yml</a></li><li><a href="#3kibanakibanayml_70" rel="nofollow">3.创建kibana配置文件kibana.yml</a></li><li><a href="#4k8selasticsearchkibanaconfigmap_84" rel="nofollow">4.在k8s中创建elasticsearch和kibana的配置文件configmap</a></li><li><a href="#5StorageClass_92" rel="nofollow">5.检查是否有StorageClass</a></li><li><a href="#6eskibanayaml_esstatefulsetyaml_128" rel="nofollow">6.创建es-kibana的yaml配置文件: es-statefulset.yaml</a></li><li><a href="#7eskibana____cluseripsvc_220" rel="nofollow">7.创建es-kibana cluserip的svc</a></li><li><a href="#8eskibananodeportsvc_256" rel="nofollow">8.创建es-kibana的nodeport类型的svc</a></li></ul> 
    </li></ul> 
    </li><li><a href="#NFS_320" rel="nofollow">三.配置NFS服务器</a></li><li><ul><li><ul><li><a href="#1NFS_322" rel="nofollow">1).安装NFS服务</a></li><li><a href="#2k8snfs_382" rel="nofollow">2).k8s注册nfs服务</a></li></ul> 
    </li></ul> 
    </li><li><a href="#filebeat_525" rel="nofollow">四.创建filebeat服务</a></li><li><ul><li><ul><li><a href="#1filebeatfilebeatsettingsconfigmapyml_527" rel="nofollow">1.创建filebeat主配置文件filebeat.settings.configmap.yml</a></li><li><a href="#2Filebeat_619" rel="nofollow">2.创建Filebeat索引生命周期策略配置文件</a></li><li><a href="#3Filebeat_665" rel="nofollow">3.Filebeat操作权限</a></li><li><a href="#4Filebeat_Daemonset_725" rel="nofollow">4.Filebeat Daemonset配置文件</a></li></ul> 
    </li></ul> 
    </li><li><a href="#File_beatesKibana_867" rel="nofollow">五.检查File beat与es，Kibana是否配置成功</a></li><li><ul><li><ul><li><a href="#1Stack_Management_869" rel="nofollow">1.首先在侧边栏找到Stack Management</a></li><li><a href="#2filebeatdemo_873" rel="nofollow">2.选择索引管理，查看是否有以filebeat-demo加时间戳为名的索引</a></li><li><a href="#3_879" rel="nofollow">3.创建索引模式</a></li><li><a href="#4_885" rel="nofollow">4.查看日志</a></li></ul> 
    </li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="K8sEFKelasticsear__filebeat__kibana_2"></a>K8s部署EFK（elasticsear + filebeat + kibana）日志收集</h2> 
<h4><a id="_4"></a>一.准备镜像</h4> 
<pre><code class="prism language-shell"><span class="token comment"># 在本机拉取镜像</span>
<span class="token function">docker</span> pull docker.elastic.co/elasticsearch/elasticsearch:7.17.2
<span class="token function">docker</span> pull docker.elastic.co/kibana/kibana:7.17.2
<span class="token function">docker</span> pull docker.elastic.co/beats/filebeat:7.17.2

<span class="token comment"># 对镜像重打标签 将${harbor_url}和${harbor_project}换成自己的harbor私服地址和目录</span>
<span class="token function">docker</span> tag docker.elastic.co/elasticsearch/elasticsearch:7.17.2 <span class="token variable">${harbor_url}</span>/<span class="token variable">${harbor_project}</span>/elasticsearch:7.17.2
<span class="token function">docker</span> tag docker.elastic.co/kibana/kibana:7.17.2 <span class="token variable">${harbor_url}</span>/<span class="token variable">${harbor_project}</span>/kibana:7.17.2
<span class="token function">docker</span> tag docker.elastic.co/beats/filebeat:7.17.2 <span class="token variable">${harbor_url}</span>/<span class="token variable">${harbor_project}</span>/filebeat:7.17.2

<span class="token comment"># 登陆自己的harbor服务器</span>
<span class="token function">docker</span> login <span class="token parameter variable">-u</span> admin <span class="token parameter variable">-p</span> <span class="token variable">${password}</span> <span class="token variable">${harbor_url}</span>

<span class="token comment"># 上传至harbor仓库</span>
<span class="token function">docker</span> push <span class="token variable">${harbor_url}</span>/<span class="token variable">${harbor_project}</span>/elasticsearch:7.17.2
<span class="token function">docker</span> push <span class="token variable">${harbor_url}</span>/<span class="token variable">${harbor_project}</span>/kibana:7.17.2
<span class="token function">docker</span> push <span class="token variable">${harbor_url}</span>/<span class="token variable">${harbor_project}</span>/filebeat:7.17.2

</code></pre> 
<blockquote> 
 <p>此处的目的是避免某些服务器从docker外网仓库拉取不了镜像，从而导致pod一直运行不了，当然也可以不用这一步，可以直接使用官方的镜像地址</p> 
</blockquote> 
<p>如果此处的Harbor目录是私有的，则需要在k8s集群中创建docker拉取harbor私库的密钥</p> 
<pre><code class="prism language-shell"><span class="token comment"># -n 后是指定的空间，根据自己的情况去更改,不加-n，默认是default空间，因为本次EFK安装在kube-system命名空间下，所以-n为kube-system。</span>
kubectl create secret docker-registry harbor-pull-secret --docker-server<span class="token operator">=</span><span class="token variable">${harbor_url}</span> --docker-username<span class="token operator">=</span>admin --docker-password<span class="token operator">=</span><span class="token variable">${password}</span> <span class="token parameter variable">-n</span> kube-system
</code></pre> 
<blockquote> 
 <p>kube-system为集群默认存在的空间，不用手动创建</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token comment">#检查密钥是否创建成功</span>
kubectl get secrets <span class="token parameter variable">-n</span> kube-system
</code></pre> 
<p><img src="https://images2.imgbox.com/d3/49/t8A1T9S5_o.png" alt="image-20231011094101732"></p> 
<h4><a id="Elasticsearch__kibana_45"></a>二.搭建Elasticsearch + kibana</h4> 
<h6><a id="1kubectlyml_47"></a>1.在可执行kubectl命令的服务器准备安装的yml文件</h6> 
<p><img src="https://images2.imgbox.com/5c/55/93HD4eLs_o.png" alt="image-20231011095203812"></p> 
<h6><a id="2elasticsearchkibanaelasticsearchyml_51"></a>2.在elasticsearch-kibana目录下创建配置文件elasticsearch.yml</h6> 
<pre><code class="prism language-yaml"><span class="token key atrule">cluster.name</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>es
<span class="token key atrule">node.name</span><span class="token punctuation">:</span> <span class="token string">"node-1"</span>
<span class="token key atrule">path.data</span><span class="token punctuation">:</span> /usr/share/elasticsearch/data
<span class="token comment">#path.logs: /var/log/elasticsearch</span>
<span class="token key atrule">bootstrap.memory_lock</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">network.host</span><span class="token punctuation">:</span> 0.0.0.0
<span class="token key atrule">http.port</span><span class="token punctuation">:</span> <span class="token number">9200</span>
<span class="token key atrule">discovery.seed_hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token string">"[::1]"</span><span class="token punctuation">]</span>
<span class="token key atrule">cluster.initial_master_nodes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"node-1"</span><span class="token punctuation">]</span>
<span class="token comment">#增加参数，使head插件可以访问es</span>
<span class="token key atrule">http.cors.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">http.cors.allow-origin</span><span class="token punctuation">:</span> <span class="token string">"*"</span>
<span class="token key atrule">http.cors.allow-headers</span><span class="token punctuation">:</span> Authorization<span class="token punctuation">,</span>X<span class="token punctuation">-</span>Requested<span class="token punctuation">-</span>With<span class="token punctuation">,</span>Content<span class="token punctuation">-</span>Length<span class="token punctuation">,</span>Content<span class="token punctuation">-</span>Type
<span class="token key atrule">xpack.monitoring.collection.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre> 
<h6><a id="3kibanakibanayml_70"></a>3.创建kibana配置文件kibana.yml</h6> 
<pre><code class="prism language-yaml"><span class="token key atrule">server.port</span><span class="token punctuation">:</span> <span class="token number">5601</span>
<span class="token key atrule">server.host</span><span class="token punctuation">:</span> <span class="token string">"0.0.0.0"</span>
<span class="token key atrule">elasticsearch.hosts</span><span class="token punctuation">:</span> <span class="token string">"http://es-kibana-0.es-kibana.kube-system:9200"</span>
<span class="token key atrule">kibana.index</span><span class="token punctuation">:</span> <span class="token string">".kibana"</span>
<span class="token key atrule">i18n.locale</span><span class="token punctuation">:</span> <span class="token string">"zh-CN"</span>
<span class="token key atrule">monitoring.ui.elasticsearch.hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"http://es-kibana-0.es-kibana.kube-system:9200"</span><span class="token punctuation">]</span>
<span class="token key atrule">monitoring.ui.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre> 
<blockquote> 
 <p>其中elasticsearch.hosts的地址构成为pod名:es-kibana-0,service名:es-kibana,命名空间:kube-system,以及service中配置的端口号9200</p> 
</blockquote> 
<h6><a id="4k8selasticsearchkibanaconfigmap_84"></a>4.在k8s中创建elasticsearch和kibana的配置文件configmap</h6> 
<pre><code class="prism language-shell"><span class="token comment">#在编写yml配置文件的目录执行该命令</span>
kubectl create configmap es-config <span class="token parameter variable">-n</span> kube-system --from-file<span class="token operator">=</span>elasticsearch.yml
kubectl create configmap kibana-config <span class="token parameter variable">-n</span> kube-system --from-file<span class="token operator">=</span>kibana.yml
</code></pre> 
<h6><a id="5StorageClass_92"></a>5.检查是否有StorageClass</h6> 
<pre><code class="prism language-shell">kubectl get sc
<span class="token comment">#如下图所示是有StorageClass的</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/72/9e/Nh5a0ZZ5_o.png" alt="image-20231011113436713"></p> 
<p>如果有则跳过第三步，没有则需要按照第三步配置NFS服务器</p> 
<p>创建es存储pvc，pv配置文件：es-pvc.yaml</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> es<span class="token punctuation">-</span>pv<span class="token punctuation">-</span>claim
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> es
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ReadWriteMany
  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> <span class="token string">"nfs-storage"</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token key atrule">requests</span><span class="token punctuation">:</span>
      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 20Gi
</code></pre> 
<pre><code class="prism language-shell">kubectl apply <span class="token parameter variable">-f</span> es-pvc.yaml
</code></pre> 
<h6><a id="6eskibanayaml_esstatefulsetyaml_128"></a>6.创建es-kibana的yaml配置文件: es-statefulset.yaml</h6> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> es<span class="token punctuation">-</span>kibana
  <span class="token key atrule">name</span><span class="token punctuation">:</span> es<span class="token punctuation">-</span>kibana
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> es<span class="token punctuation">-</span>kibana
  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> <span class="token string">"es-kibana"</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> es<span class="token punctuation">-</span>kibana
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> Harbor私库地址 <span class="token punctuation">]</span>/elasticsearch<span class="token punctuation">:</span>7.17.2
          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
          <span class="token key atrule">name</span><span class="token punctuation">:</span> elasticsearch
          <span class="token key atrule">resources</span><span class="token punctuation">:</span>
            <span class="token key atrule">requests</span><span class="token punctuation">:</span>
              <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">"800Mi"</span>
              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"800m"</span>
            <span class="token key atrule">limits</span><span class="token punctuation">:</span>
              <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">"1Gi"</span>
              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"1000m"</span>
          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> es<span class="token punctuation">-</span>config
              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/elasticsearch/config/elasticsearch.yml
              <span class="token key atrule">subPath</span><span class="token punctuation">:</span> elasticsearch.yml
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> es<span class="token punctuation">-</span>persistent<span class="token punctuation">-</span>storage
              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/elasticsearch/data
          <span class="token key atrule">env</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> TZ
              <span class="token key atrule">value</span><span class="token punctuation">:</span> Asia/Shanghai
        <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> Harbor私库地址 <span class="token punctuation">]</span>/kibana<span class="token punctuation">:</span>7.17.2
          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
          <span class="token key atrule">name</span><span class="token punctuation">:</span> kibana
          <span class="token key atrule">env</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> TZ
              <span class="token key atrule">value</span><span class="token punctuation">:</span> Asia/Shanghai
          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kibana<span class="token punctuation">-</span>config
              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/kibana/config/kibana.yml
              <span class="token key atrule">subPath</span><span class="token punctuation">:</span> kibana.yml
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> es<span class="token punctuation">-</span>config
          <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> es<span class="token punctuation">-</span>config
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kibana<span class="token punctuation">-</span>config
          <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> kibana<span class="token punctuation">-</span>config
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> es<span class="token punctuation">-</span>persistent<span class="token punctuation">-</span>storage
          <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>
            <span class="token key atrule">claimName</span><span class="token punctuation">:</span> es<span class="token punctuation">-</span>pv<span class="token punctuation">-</span>claim
      <span class="token comment">#hostNetwork: true</span>
      <span class="token comment">#dnsPolicy: ClusterFirstWithHostNet</span>
      <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>
        <span class="token key atrule">kubernetes.io/hostname</span><span class="token punctuation">:</span> k8s<span class="token punctuation">-</span>uni<span class="token punctuation">-</span>node3
</code></pre> 
<pre><code class="prism language-shell"><span class="token comment">#创建pod</span>
kubectl create <span class="token parameter variable">-f</span> es-statefulset.yaml

<span class="token comment"># 查看</span>
kubectl get pod <span class="token parameter variable">-o</span> wide <span class="token parameter variable">-n</span> kube-system<span class="token operator">|</span><span class="token function">grep</span> es

<span class="token comment"># 使用curl命令测试elasticsearch是否正常</span>
kubectl get pod <span class="token parameter variable">-o</span> wide <span class="token parameter variable">-n</span> kube-system<span class="token operator">|</span><span class="token function">grep</span> es
</code></pre> 
<p><img src="https://images2.imgbox.com/9e/46/O00inUOD_o.png" alt="image-20231011120051319"></p> 
<p>然后在集群内部服务器上测试是否能通信</p> 
<p><img src="https://images2.imgbox.com/79/ae/eTXOn0ZT_o.png" alt="image-20231011135418126"></p> 
<p>当然也可以在Rancher上查看pod是否运行成功</p> 
<p><img src="https://images2.imgbox.com/b9/34/r34iJmIt_o.png" alt="image-20231011135532459"></p> 
<p>这个pod一次运行了两个容器，分别是kibanah和elasticsearch，并且把elasticsearch容器中的/usr/share/elasticsearch/data目录下的内容，挂载到了es-pv-claim下，我们可以在第三步中的NFS服务器共享目录中找到挂载的数据。</p> 
<p><img src="https://images2.imgbox.com/7d/81/flk2C6a4_o.png" alt="image-20231011115625957"></p> 
<h6><a id="7eskibana____cluseripsvc_220"></a>7.创建es-kibana cluserip的svc</h6> 
<pre><code class="prism language-shell"><span class="token function">vi</span> es-cluster-none-svc.yaml
</code></pre> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> es<span class="token punctuation">-</span>kibana
  <span class="token key atrule">name</span><span class="token punctuation">:</span> es<span class="token punctuation">-</span>kibana
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> es9200
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9200</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9200</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> es9300
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9300</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9300</span>
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> es<span class="token punctuation">-</span>kibana
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
</code></pre> 
<pre><code class="prism language-shell">kubectl apply <span class="token parameter variable">-f</span> es-cluster-none-svc.yaml
</code></pre> 
<blockquote> 
 <p>这个配置文件描述了一个名为 <code>es-kibana</code> 的 Kubernetes Service，该 Service 不分配 Cluster IP（<code>ClusterIP: None</code>），它会将流量路由到具有特定标签 <code>app: es-kibana</code> 的 Pod，这些 Pod 的端口 9200 和 9300 将被公开，并且可以通过相应的 <code>targetPort</code> 进行访问。用于集群内部访问</p> 
</blockquote> 
<h6><a id="8eskibananodeportsvc_256"></a>8.创建es-kibana的nodeport类型的svc</h6> 
<pre><code class="prism language-shell"><span class="token function">vi</span> es-nodeport-svc.yaml
</code></pre> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> es<span class="token punctuation">-</span>kibana
  <span class="token key atrule">name</span><span class="token punctuation">:</span> es<span class="token punctuation">-</span>kibana<span class="token punctuation">-</span>nodeport<span class="token punctuation">-</span>svc
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 9200<span class="token punctuation">-</span><span class="token number">9200</span>
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9200</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9200</span>
      <span class="token comment">#nodePort: 9200</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 5601<span class="token punctuation">-</span><span class="token number">5601</span>
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5601</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">5601</span>
      <span class="token comment">#nodePort: 5601</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> es<span class="token punctuation">-</span>kibana
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
</code></pre> 
<pre><code class="prism language-shell">kubectl apply <span class="token parameter variable">-f</span> es-nodeport-svc.yaml
</code></pre> 
<blockquote> 
 <p>这个配置文件创建了一个名为 “es-kibana-nodeport-svc” 的 Kubernetes Service。该 Service 使用 NodePort 类型，允许从集群外部访问服务。Service 公开了两个端口，9200 和 5601，分别将流量路由到具有相应标签的 Pod 的对应端口。Pod 的选择基于标签 <code>app: es-kibana</code>。用于暴露端口，从集群外部访问es和kibana</p> 
</blockquote> 
<p>外网暴露的端口是k8s随机分配的，有两种办法可以查看</p> 
<pre><code class="prism language-shell"><span class="token comment">#在服务器使用命令查看</span>
kubectl get svc <span class="token parameter variable">-n</span> kube-system<span class="token operator">|</span><span class="token function">grep</span> es-kibana
</code></pre> 
<p><img src="https://images2.imgbox.com/3c/c0/5tVMbmmo_o.png" alt="image-20231011141800714"></p> 
<p>Rancher上查看</p> 
<p><img src="https://images2.imgbox.com/c9/1c/i3xHFg8v_o.png" alt="image-20231011141916201"></p> 
<p>可以看到Kibana的端口为31200，然后就能使用nodeip+port访问</p> 
<p><img src="https://images2.imgbox.com/e1/76/talcrQXn_o.png" alt="image-20231011142531139"></p> 
<p>检查es是否注册上Kibana，点击侧边栏找到堆栈检测，然后点Nodes</p> 
<p><img src="https://images2.imgbox.com/a2/e0/D8xj0OaD_o.png" alt="image-20231011142819072"></p> 
<p><img src="https://images2.imgbox.com/14/92/nrTFKetQ_o.png" alt="image-20231011142914922"></p> 
<p>至此，Elasticsearch + kibana已经搭建完成，可以进行第四步。</p> 
<hr> 
<h4><a id="NFS_320"></a>三.配置NFS服务器</h4> 
<h6><a id="1NFS_322"></a>1).安装NFS服务</h6> 
<p>Ubuntu：</p> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> <span class="token function">apt</span> update
<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> nfs-kernel-server
</code></pre> 
<p>Centos：</p> 
<pre><code class="prism language-shell">yum update
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> nfs-utils
</code></pre> 
<pre><code class="prism language-shell"><span class="token comment"># 创建或使用用已有的文件夹作为nfs文件存储点</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /home/data/nfs/share
<span class="token function">vi</span> /etc/exports
</code></pre> 
<p>写入如下内容</p> 
<blockquote> 
 <p>/home/data/nfs/share *(rw,no_root_squash,sync,no_subtree_check)</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/e2/81/qz7n6bJI_o.png" alt="image-20230913174358481"></p> 
<pre><code class="prism language-shell"><span class="token comment"># 配置生效并查看是否生效</span>
exportfs <span class="token parameter variable">-r</span>
exportfs
</code></pre> 
<p><img src="https://images2.imgbox.com/55/e3/oSM8dFjR_o.png" alt="image-20230913174639129"></p> 
<pre><code class="prism language-shell"><span class="token comment"># 启动rpcbind、nfs服务</span>
<span class="token comment">#Centos</span>
systemctl restart rpcbind <span class="token operator">&amp;&amp;</span> systemctl <span class="token builtin class-name">enable</span> rpcbind
systemctl restart nfs <span class="token operator">&amp;&amp;</span> systemctl <span class="token builtin class-name">enable</span> nfs
<span class="token comment">#Ubuntu</span>
systemctl restart rpcbind <span class="token operator">&amp;&amp;</span> systemctl <span class="token builtin class-name">enable</span> rpcbind
systemctl start nfs-kernel-server <span class="token operator">&amp;&amp;</span> systemctl <span class="token builtin class-name">enable</span> nfs-kernel-server

<span class="token comment"># 查看 RPC 服务的注册状况</span>
rpcinfo <span class="token parameter variable">-p</span> localhost
</code></pre> 
<p><img src="https://images2.imgbox.com/2f/92/Lcyb1iuq_o.png" alt="image-20230913175507036"></p> 
<pre><code class="prism language-shell"><span class="token comment"># showmount测试</span>
showmount <span class="token parameter variable">-e</span> localhost
</code></pre> 
<p><img src="https://images2.imgbox.com/4a/e9/4vt0e429_o.png" alt="image-20230913175649184"></p> 
<p>以上都没有问题则说明安装成功</p> 
<h6><a id="2k8snfs_382"></a>2).k8s注册nfs服务</h6> 
<p>新建storageclass-nfs.yaml文件，粘贴如下内容:</p> 
<pre><code class="prism language-yaml"><span class="token comment">## 创建了一个存储类</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> storage.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> StorageClass                  <span class="token comment">#存储类的资源名称</span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>storage                 <span class="token comment">#存储类的名称，自定义</span>
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">storageclass.kubernetes.io/is-default-class</span><span class="token punctuation">:</span> <span class="token string">"true"</span>          <span class="token comment">#注解，是否是默认的存储，注意：KubeSphere默认就需要个默认存储，因此这里注解要设置为“默认”的存储系统，表示为"true"，代表默认。</span>
<span class="token key atrule">provisioner</span><span class="token punctuation">:</span> k8s<span class="token punctuation">-</span>sigs.io/nfs<span class="token punctuation">-</span>subdir<span class="token punctuation">-</span>external<span class="token punctuation">-</span>provisioner         <span class="token comment">#存储分配器的名字，自定义</span>
<span class="token key atrule">parameters</span><span class="token punctuation">:</span>
  <span class="token key atrule">archiveOnDelete</span><span class="token punctuation">:</span> <span class="token string">"true"</span>  <span class="token comment">## 删除pv的时候，pv的内容是否要备份</span>

<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
  <span class="token comment"># replace with namespace where provisioner is deployed</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>                 <span class="token comment">#只运行一个副本应用</span>
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span> <span class="token comment">#描述了如何用新的POD替换现有的POD</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> Recreate            <span class="token comment">#Recreate表示重新创建Pod</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment">#选择后端Pod</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner          <span class="token comment">#创建账户</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
          <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>hangzhou.aliyuncs.com/lfy_k8s_images/nfs<span class="token punctuation">-</span>subdir<span class="token punctuation">-</span>external<span class="token punctuation">-</span>provisioner<span class="token punctuation">:</span>v4.0.2      <span class="token comment">#使用NFS存储分配器的镜像</span>
          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>root           <span class="token comment">#定义个存储卷，</span>
              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /persistentvolumes   <span class="token comment">#表示挂载容器内部的路径</span>
          <span class="token key atrule">env</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PROVISIONER_NAME          <span class="token comment">#定义存储分配器的名称</span>
              <span class="token key atrule">value</span><span class="token punctuation">:</span> k8s<span class="token punctuation">-</span>sigs.io/nfs<span class="token punctuation">-</span>subdir<span class="token punctuation">-</span>external<span class="token punctuation">-</span>provisioner         <span class="token comment">#需要和上面定义的保持名称一致</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NFS_SERVER                                       <span class="token comment">#指定NFS服务器的地址，你需要改成你的NFS服务器的IP地址</span>
              <span class="token key atrule">value</span><span class="token punctuation">:</span> 192.168.0.0 <span class="token comment">## 指定自己nfs服务器地址</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NFS_PATH
              <span class="token key atrule">value</span><span class="token punctuation">:</span> /home/data/nfs/share  <span class="token comment">## nfs服务器共享的目录            #指定NFS服务器共享的目录</span>
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>root           <span class="token comment">#存储卷的名称，和前面定义的保持一致</span>
          <span class="token key atrule">nfs</span><span class="token punctuation">:</span>
            <span class="token key atrule">server</span><span class="token punctuation">:</span> 192.168.0.0            <span class="token comment">#NFS服务器的地址，和上面保持一致，这里需要改为你的IP地址</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /home/data/nfs/share               <span class="token comment">#NFS共享的存储目录，和上面保持一致</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount                 <span class="token comment">#创建个SA账号</span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner        <span class="token comment">#和上面的SA账号保持一致</span>
  <span class="token comment"># replace with namespace where provisioner is deployed</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token punctuation">---</span>
<span class="token comment">#以下就是ClusterRole，ClusterRoleBinding，Role，RoleBinding都是权限绑定配置，不在解释。直接复制即可。</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>runner
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">""</span> <span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">"nodes"</span> <span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span> <span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">""</span> <span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">"persistentvolumes"</span> <span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"delete"</span> <span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">""</span> <span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">"persistentvolumeclaims"</span> <span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"update"</span> <span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">"storage.k8s.io"</span> <span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">"storageclasses"</span> <span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span> <span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">""</span> <span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">"events"</span> <span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">,</span> <span class="token string">"patch"</span> <span class="token punctuation">]</span>
<span class="token punctuation">---</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> run<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
    <span class="token comment"># replace with namespace where provisioner is deployed</span>
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>runner
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
<span class="token punctuation">---</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> leader<span class="token punctuation">-</span>locking<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
  <span class="token comment"># replace with namespace where provisioner is deployed</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">""</span> <span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">"endpoints"</span> <span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">,</span> <span class="token string">"patch"</span> <span class="token punctuation">]</span>
<span class="token punctuation">---</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> leader<span class="token punctuation">-</span>locking<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
  <span class="token comment"># replace with namespace where provisioner is deployed</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
    <span class="token comment"># replace with namespace where provisioner is deployed</span>
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
  <span class="token key atrule">name</span><span class="token punctuation">:</span> leader<span class="token punctuation">-</span>locking<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
</code></pre> 
<p>需要修改的就只有服务器地址和共享的目录</p> 
<p>创建StorageClass</p> 
<pre><code class="prism language-shell">kubectl apply <span class="token parameter variable">-f</span> storageclass-nfs.yaml

<span class="token comment"># 查看是否存在</span>
kubectl get sc
</code></pre> 
<p><img src="https://images2.imgbox.com/87/6e/InOLtAZO_o.png" alt="image-20231011113436713"></p> 
<hr> 
<h4><a id="filebeat_525"></a>四.创建filebeat服务</h4> 
<h6><a id="1filebeatfilebeatsettingsconfigmapyml_527"></a>1.创建filebeat主配置文件filebeat.settings.configmap.yml</h6> 
<pre><code class="prism language-shell"><span class="token function">vi</span> filebeat.settings.configmap.yml
</code></pre> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">name</span><span class="token punctuation">:</span> filebeat<span class="token punctuation">-</span>config
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> filebeat
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">filebeat.yml</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>
    <span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> container
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /var/log/containers/<span class="token important">*.log</span>
      <span class="token key atrule">include_lines</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'ERROR'</span><span class="token punctuation">,</span> <span class="token string">'WARN'</span><span class="token punctuation">]</span>
      <span class="token key atrule">multiline</span><span class="token punctuation">:</span>
        <span class="token key atrule">pattern</span><span class="token punctuation">:</span> ^\d<span class="token punctuation">{<!-- --></span><span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">-</span>\d<span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">-</span>\d<span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">}</span>\s\d<span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">:</span>\d<span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">:</span>\d<span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">}</span>
        <span class="token key atrule">negate</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">match</span><span class="token punctuation">:</span> after
      <span class="token key atrule">processors</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">add_kubernetes_metadata</span><span class="token punctuation">:</span>
          <span class="token key atrule">in_cluster</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">host</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>NODE_NAME<span class="token punctuation">}</span>
          <span class="token key atrule">matchers</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">logs_path</span><span class="token punctuation">:</span>
              <span class="token key atrule">logs_path</span><span class="token punctuation">:</span> <span class="token string">"/var/log/containers/"</span>

      <span class="token punctuation">-</span> <span class="token key atrule">add_cloud_metadata</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">add_kubernetes_metadata</span><span class="token punctuation">:</span>
          <span class="token key atrule">matchers</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">logs_path</span><span class="token punctuation">:</span>
              <span class="token key atrule">logs_path</span><span class="token punctuation">:</span> <span class="token string">"/var/log/containers/"</span>
      <span class="token punctuation">-</span> <span class="token key atrule">add_docker_metadata</span><span class="token punctuation">:</span>
    <span class="token key atrule">output.elasticsearch</span><span class="token punctuation">:</span>
      <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"http://[k8s节点ip]:32494"</span><span class="token punctuation">]</span>
      <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"filebeat-demo-%{[agent.version]}-%{+yyyy.MM.dd}"</span>
    <span class="token key atrule">setup.template.name</span><span class="token punctuation">:</span> <span class="token string">"filebeat-demo"</span>
    <span class="token key atrule">setup.template.pattern</span><span class="token punctuation">:</span> <span class="token string">"filebeat-demo-*"</span>
    <span class="token key atrule">setup.ilm.rollover_alias</span><span class="token punctuation">:</span> <span class="token string">"filebeat-demo"</span>
    <span class="token key atrule">setup.ilm</span><span class="token punctuation">:</span>
      <span class="token key atrule">policy_file</span><span class="token punctuation">:</span> /etc/indice<span class="token punctuation">-</span>lifecycle.json
</code></pre> 
<pre><code class="prism language-shell"><span class="token comment">#执行</span>
kubectl apply  <span class="token parameter variable">-f</span> filebeat.settings.configmap.yml
</code></pre> 
<blockquote> 
 <p><code>filebeat.inputs</code>: 定义输入配置，这里配置了从容器日志中收集数据。</p> 
 <ul><li> <p><code>type</code>: 定义输入类型为 container，表示从容器日志中收集数据。</p> </li><li> <p><code>enabled</code>: 启用该输入配置。</p> </li><li> <p><code>paths</code>: 指定要监视的日志文件路径，这里是容器日志路径。k8s容器的日志默认是保存在在服务器的/var/log/containers/下的。</p> </li><li> <p><code>multiline</code>: 多行日志配置，用于将多行日志合并为单个事件。正则表示如果前面几个数字不是4个数字开头，那么就会合并到一行,解决Java堆栈错误日志收集问题</p> </li><li> <p><code>processors</code>: 定义处理器，用于添加元数据。add_kubernetes_metadata:为日志事件添加 Kubernetes 相关的元数据信息，例如 Pod 名称、命名空间、标签等。</p> </li></ul> 
 <p><code>output.elasticsearch</code>: 定义输出配置，将收集到的日志发送到 Elasticsearch。</p> 
 <ul><li><code>hosts</code>: 指定 Elasticsearch 节点的地址和端口。端口号为第二步安装es时，nodeport暴露的端口号。</li><li><code>indices</code>: 定义索引模式，这里以日期为后缀，创建每日索引。</li></ul> 
 <p><code>setup.ilm</code>: 配置索引生命周期管理 (ILM)，用于管理索引的生命周期。</p> 
 <ul><li>policy_file:后面定义的是生命周期配置文件的地址</li></ul> 
</blockquote> 
<blockquote> 
 <p>此处禁用了filebeat默认的索引格式。默认的索引格式为filebeat-%{[agent.version]}-%{+yyyy.MM.dd}，在Kibana上呈现的就是filebeat-2023.10.21-000001这样的索引命名格式，而且默认的索引模板和索引生命周期都与index中设置的filebeat-demo-%{[agent.version]}-%{+yyyy.MM.dd}无关。故出现的问题就是我们所需的日志内容在索引filebeat-demo-%{[agent.version]}-%{+yyyy.MM.dd}中，但是并不能被准确分片和使用索引生命周期管理。</p> 
 <p><strong>#相关模板字段意义</strong></p> 
 <p>setup.template.name: “filebeat-demo” # 设置一个新的模板，模板的名称为filebeat-demo</p> 
 <p>setup.template.pattern: “filebeat-demo-*” # 模板匹配那些索引，这里表示以filebeat-demo开头的所有的索引</p> 
 <p>setup.ilm.rollover_alias: “filebeat-demo” #索引生命周期写别名。默认值为 <code>filebeat-%{[agent.version]}</code>。设置此选项将更改别名为filebeat-demo。用以滚动更新大索引文件的分片</p> 
</blockquote> 
<blockquote> 
 <p>同时该配置过滤了其他info级别的日志，只收集了’ERROR’, 'WARN’级别的日志，相关配置：</p> 
 <p>include_lines: [‘ERROR’, ‘WARN’] 该配置可根据实际使用情况进行删改</p> 
</blockquote> 
<p>下图为，索引格式配置正确的示范截图：<br> <img src="https://images2.imgbox.com/e6/49/zjM2Fhlp_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/6b/24/jgaasNLA_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/0c/ad/c13WnmDs_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="2Filebeat_619"></a>2.创建Filebeat索引生命周期策略配置文件</h6> 
<p>为了防止大量的数据存储，可以利用 indice 的生命周期来配置数据保留。 如下所示的文件中，配置成每天或每次超过5GB的时候就对 indice 进行轮转，并删除所有超过30天的 indice 文件。</p> 
<pre><code class="prism language-shell"><span class="token function">vi</span> filebeat.indice-lifecycle.configmap.yml
</code></pre> 
<pre><code class="prism language-yaml"><span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">name</span><span class="token punctuation">:</span> filebeat<span class="token punctuation">-</span>indice<span class="token punctuation">-</span>lifecycle
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> filebeat
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">indice-lifecycle.json</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token key atrule">"policy"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token key atrule">"phases"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token key atrule">"hot"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token key atrule">"actions"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
              <span class="token key atrule">"rollover"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token key atrule">"max_size"</span><span class="token punctuation">:</span> <span class="token string">"5GB"</span> <span class="token punctuation">,</span>
                <span class="token key atrule">"max_age"</span><span class="token punctuation">:</span> <span class="token string">"1d"</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token key atrule">"delete"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token key atrule">"min_age"</span><span class="token punctuation">:</span> <span class="token string">"30d"</span><span class="token punctuation">,</span>
            <span class="token key atrule">"actions"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
              <span class="token key atrule">"delete"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-shell"><span class="token comment">#执行</span>
kubectl apply  <span class="token parameter variable">-f</span> filebeat.indice-lifecycle.configmap.yml
</code></pre> 
<h6><a id="3Filebeat_665"></a>3.Filebeat操作权限</h6> 
<pre><code class="prism language-shell"><span class="token function">vi</span> filebeat.permission.yml
</code></pre> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> filebeat
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">""</span> <span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> namespaces
      <span class="token punctuation">-</span> pods
      <span class="token punctuation">-</span> nodes
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> get
      <span class="token punctuation">-</span> watch
      <span class="token punctuation">-</span> list
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> filebeat
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
    <span class="token key atrule">name</span><span class="token punctuation">:</span> filebeat
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> filebeat
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">name</span><span class="token punctuation">:</span> filebeat
</code></pre> 
<pre><code class="prism language-shell"><span class="token comment">#执行</span>
kubectl apply  <span class="token parameter variable">-f</span> filebeat.permission.yml
</code></pre> 
<blockquote> 
 <ol><li><strong>ClusterRole</strong>: 
   <ul><li><strong>作用</strong>：定义了一个 ClusterRole，它是一种权限集合，指定了 Filebeat 在集群范围内可以执行的操作，如获取（get）、监视（watch）、列出（list）等。</li><li>权限： 
     <ul><li>可以对命名空间执行 get、watch、list 操作。</li><li>可以对 Pod 执行 get、watch、list 操作。</li><li>可以对节点执行 get、watch、list 操作。</li></ul> </li></ul> </li><li><strong>ClusterRoleBinding</strong>: 
   <ul><li><strong>作用</strong>：定义了一个 ClusterRoleBinding，将 ClusterRole (<code>filebeat</code>) 绑定到特定的 ServiceAccount (<code>filebeat</code>)。</li><li><strong>意义</strong>：将 ClusterRole 与 ServiceAccount 绑定，以使 Filebeat 具有在 Kubernetes 中执行相应操作的权限。</li></ul> </li><li><strong>ServiceAccount</strong>: 
   <ul><li><strong>作用</strong>：定义了一个 ServiceAccount (<code>filebeat</code>)，它是 Kubernetes 中用于身份验证和授权的实体。</li><li><strong>意义</strong>：创建了一个用于 Filebeat 的身份实体，使得 Filebeat 在 Kubernetes 中能够以其身份运行。</li></ul> </li></ol> 
</blockquote> 
<h6><a id="4Filebeat_Daemonset_725"></a>4.Filebeat Daemonset配置文件</h6> 
<pre><code class="prism language-shell"><span class="token function">vi</span> filebeat.daemonset.yml
</code></pre> 
<pre><code class="prism language-yaml"><span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">name</span><span class="token punctuation">:</span> filebeat
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> filebeat
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> filebeat
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> filebeat
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> filebeat
      <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> filebeat
          <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> Harbor私服地址 <span class="token punctuation">]</span>/filebeat<span class="token punctuation">:</span>7.17.2
          <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
              <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"/etc/filebeat.yml"</span><span class="token punctuation">,</span>
              <span class="token string">"-e"</span><span class="token punctuation">,</span>
          <span class="token punctuation">]</span>
          <span class="token key atrule">env</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NODE_NAME
              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
                <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>
                  <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> spec.nodeName
          <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
            <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">0</span>
          <span class="token key atrule">resources</span><span class="token punctuation">:</span>
            <span class="token key atrule">limits</span><span class="token punctuation">:</span>
              <span class="token key atrule">memory</span><span class="token punctuation">:</span> 200Mi
            <span class="token key atrule">requests</span><span class="token punctuation">:</span>
              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m
              <span class="token key atrule">memory</span><span class="token punctuation">:</span> 100Mi
          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config
              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/filebeat.yml
              <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
              <span class="token key atrule">subPath</span><span class="token punctuation">:</span> filebeat.yml
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> filebeat<span class="token punctuation">-</span>indice<span class="token punctuation">-</span>lifecycle
              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/indice<span class="token punctuation">-</span>lifecycle.json
              <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
              <span class="token key atrule">subPath</span><span class="token punctuation">:</span> indice<span class="token punctuation">-</span>lifecycle.json
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> data
              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/filebeat/data
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> varlog
              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/log
              <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> varlibdockercontainers
              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/lib/docker/containers
              <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> dockersock
              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/run/docker.sock
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config
          <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
            <span class="token key atrule">defaultMode</span><span class="token punctuation">:</span> <span class="token number">0600</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> filebeat<span class="token punctuation">-</span>config
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> filebeat<span class="token punctuation">-</span>indice<span class="token punctuation">-</span>lifecycle
          <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
            <span class="token key atrule">defaultMode</span><span class="token punctuation">:</span> <span class="token number">0600</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> filebeat<span class="token punctuation">-</span>indice<span class="token punctuation">-</span>lifecycle
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> varlog
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /var/log
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> varlibdockercontainers
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /var/lib/docker/containers
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> dockersock
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /var/run/docker.sock
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> data
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /var/lib/filebeat<span class="token punctuation">-</span>data
            <span class="token key atrule">type</span><span class="token punctuation">:</span> DirectoryOrCreate
</code></pre> 
<pre><code class="prism language-shell"><span class="token comment">#执行</span>
kubectl apply  <span class="token parameter variable">-f</span> filebeat.daemonset.yml
</code></pre> 
<blockquote> 
 <p>volumeMounts配置示意：</p> 
 <ol><li><strong>name: config</strong>: 
   <ul><li><strong>作用</strong>: 创建一个挂载点，将 ConfigMap 中的 <code>filebeat.yml</code> 配置文件挂载到容器中的 <code>/etc/filebeat.yml</code> 路径。</li><li><strong>readOnly</strong>: 设置为 true，表示只读访问该配置文件。</li></ul> </li><li><strong>name: filebeat-indice-lifecycle</strong>: 
   <ul><li><strong>作用</strong>: 创建一个挂载点，将 ConfigMap 中的 <code>indice-lifecycle.json</code> 文件挂载到容器中的 <code>/etc/indice-lifecycle.json</code> 路径。</li><li><strong>readOnly</strong>: 设置为 true，表示只读访问该文件。</li></ul> </li><li><strong>name: data</strong>: 
   <ul><li><strong>作用</strong>: 创建一个挂载点，将宿主机的 <code>/var/lib/filebeat-data</code> 目录挂载到容器中的 <code>/usr/share/filebeat/data</code> 路径。</li><li><strong>type: DirectoryOrCreate</strong>: 指定挂载类型为目录，如果该目录不存在则创建。</li></ul> </li><li><strong>name: varlog</strong>: 
   <ul><li><strong>作用</strong>: 创建一个挂载点，将宿主机的 <code>/var/log</code> 目录挂载到容器中的 <code>/var/log</code> 路径。</li><li><strong>readOnly</strong>: 设置为 true，表示只读访问该目录。</li></ul> </li><li><strong>name: varlibdockercontainers</strong>: 
   <ul><li><strong>作用</strong>: 创建一个挂载点，将宿主机的 <code>/var/lib/docker/containers</code> 目录挂载到容器中的 <code>/var/lib/docker/containers</code> 路径。</li><li><strong>readOnly</strong>: 设置为 true，表示只读访问该目录。</li></ul> </li><li><strong>name: dockersock</strong>: 
   <ul><li><strong>作用</strong>: 创建一个挂载点，将宿主机的 Docker socket 文件 <code>/var/run/docker.sock</code> 挂载到容器中的 <code>/var/run/docker.sock</code> 路径。</li></ul> </li></ol> 
</blockquote> 
<blockquote> 
 <p>volumes配置示意：</p> 
 <ol><li><strong>name: config</strong>: 
   <ul><li><strong>作用</strong>: 与volumeMounts中的name: config相对应。</li><li><strong>defaultMode: 0600</strong>: 表示只有文件所有者可读写，其他用户无权限。</li><li><strong>name</strong>:filebeat-config对应第一步创建的filebeat.settings.configmap.yml中的Configmap的名字</li></ul> </li><li><strong>name: filebeat-indice-lifecycle</strong>: 
   <ul><li><strong>作用</strong>: 与volumeMounts中的filebeat-indice-lifecycle相对应。</li><li><strong>defaultMode: 0600</strong>: 表示只有文件所有者可读写，其他用户无权限。</li><li><strong>name</strong>:filebeat-indice-lifecycle对应第二步创建的filebeat.indice-lifecycle.configmap.yml中的Configmap的名字</li></ul> </li><li><strong>name: data</strong> 
   <ul><li><strong>作用</strong>：与volumeMounts中的name: data相对应。</li><li><strong>path</strong>:需要挂载的目录路径</li><li><strong>type</strong>:DirectoryOrCreatea表示容器启动时会检查宿主机是否存在该目录，不存在则创建。因为Filebeat在每个节点的宿主机上都会运行，所以直接挂载到宿主机目录</li></ul> </li></ol> 
</blockquote> 
<p>检查是否执行成功</p> 
<pre><code class="prism language-shell">kubectl get pod <span class="token parameter variable">-o</span> wide <span class="token parameter variable">-n</span> kube-system<span class="token operator">|</span><span class="token function">grep</span> filebeat
<span class="token comment">#如下图，全为Running则表示运行成功</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/7b/dc/UoHhloBC_o.png" alt="image-20231011160048266"></p> 
<p>也可以在Rancher上查看</p> 
<p><img src="https://images2.imgbox.com/88/be/XABxOJx8_o.png" alt="image-20231011160211682"></p> 
<h4><a id="File_beatesKibana_867"></a>五.检查File beat与es，Kibana是否配置成功</h4> 
<h6><a id="1Stack_Management_869"></a>1.首先在侧边栏找到Stack Management</h6> 
<p><img src="https://images2.imgbox.com/f1/64/xA2rU986_o.png" alt="image-20231011160552133"></p> 
<h6><a id="2filebeatdemo_873"></a>2.选择索引管理，查看是否有以filebeat-demo加时间戳为名的索引</h6> 
<p><img src="https://images2.imgbox.com/71/20/fkO4duhD_o.png" alt="image-20231011160630025"></p> 
<p><img src="https://images2.imgbox.com/26/33/tkCgpGdD_o.png" alt="image-20231011160754049"></p> 
<h6><a id="3_879"></a>3.创建索引模式</h6> 
<p><img src="https://images2.imgbox.com/53/e2/hUchyw3c_o.png" alt="image-20231011160851049"></p> 
<p><img src="https://images2.imgbox.com/f7/c2/2ZJxXkQZ_o.png" alt="image-20231011160950466"></p> 
<h6><a id="4_885"></a>4.查看日志</h6> 
<p>点击侧边栏，选择discover，就能看到Filebeat收集到的容器日志，可以按照自己的需求进行日志筛选</p> 
<p>![image-20231011161136329](https://img-blog.csdnimg.cn/img_convert/0a9c729591485d61f7355b02c1f3b103.png</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1a557f7c2b7b61bb145aa633c152095b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Linux（CentOS）安装MinIo，详细教程，附防火墙端口开放操作</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1149d4d72132b6fd978076042e2c77d6/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">flutter学习-day23-使用extended_image处理图片的加载和操作</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>