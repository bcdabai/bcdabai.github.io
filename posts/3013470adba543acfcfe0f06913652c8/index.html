<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>centos 7.9 部署 harbor 镜像仓库实践 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="centos 7.9 部署 harbor 镜像仓库实践" />
<meta property="og:description" content="centos 7.9 harbor 部署镜像仓库 tags: registry
文章目录 centos 7.9 harbor 部署镜像仓库1. 安装 docker1.1 配置 docker 2. 安装 docker-compose3. 下载 harbor4. 定制配置文件 harbor.yml5. 配置证书5.1 生成证书颁发机构证书5.2 生成服务器证书5.3 向 Harbor 和 Docker 提供证书 6. 部署 harbor7. 测试 1. 安装 docker Docker 安装 1.1 配置 docker $ cat /etc/docker/daemon.json { &#34;exec-opts&#34;: [&#34;native.cgroupdriver=systemd&#34;], &#34;log-driver&#34;: &#34;json-file&#34;, &#34;log-opts&#34;: { &#34;max-size&#34;: &#34;100m&#34; }, &#34;registry-mirrors&#34;: [ &#34;https://hub-mirror.c.163.com&#34;, &#34;https://mirror.baidubce.com&#34; ] } 启动 docker
systemctl start docker &amp;&amp; systemctl enable docker 2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/3013470adba543acfcfe0f06913652c8/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-12T13:32:40+08:00" />
<meta property="article:modified_time" content="2023-08-12T13:32:40+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">centos 7.9 部署 harbor 镜像仓库实践</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="centos_79_harbor__0"></a>centos 7.9 harbor 部署镜像仓库</h2> 
<p>tags: registry<br> <img src="https://images2.imgbox.com/08/d1/Z2RxmTY2_o.png" alt=""></p> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#centos_79_harbor__0" rel="nofollow">centos 7.9 harbor 部署镜像仓库</a></li><li><ul><li><a href="#1__docker_8" rel="nofollow">1. 安装 docker</a></li><li><ul><li><a href="#11__docker_11" rel="nofollow">1.1 配置 docker</a></li></ul> 
   </li><li><a href="#2__dockercompose_32" rel="nofollow">2. 安装 docker-compose</a></li><li><a href="#3__harbor_45" rel="nofollow">3. 下载 harbor</a></li><li><a href="#4__harboryml_66" rel="nofollow">4. 定制配置文件 harbor.yml</a></li><li><a href="#5__124" rel="nofollow">5. 配置证书</a></li><li><ul><li><a href="#51__125" rel="nofollow">5.1 生成证书颁发机构证书</a></li><li><a href="#52__134" rel="nofollow">5.2 生成服务器证书</a></li><li><a href="#53__Harbor__Docker__166" rel="nofollow">5.3 向 Harbor 和 Docker 提供证书</a></li></ul> 
   </li><li><a href="#6__harbor_191" rel="nofollow">6. 部署 harbor</a></li><li><a href="#7__262" rel="nofollow">7. 测试</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="1__docker_8"></a>1. 安装 docker</h3> 
<ul><li><a href="https://blog.csdn.net/xixihahalelehehe/article/details/104293170">Docker 安装</a></li></ul> 
<h4><a id="11__docker_11"></a>1.1 配置 docker</h4> 
<pre><code class="prism language-bash">$ <span class="token function">cat</span> /etc/docker/daemon.json 
<span class="token punctuation">{<!-- --></span>
   <span class="token string">"exec-opts"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"native.cgroupdriver=systemd"</span><span class="token punctuation">]</span>,
   <span class="token string">"log-driver"</span><span class="token builtin class-name">:</span> <span class="token string">"json-file"</span>,
   <span class="token string">"log-opts"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
   <span class="token string">"max-size"</span><span class="token builtin class-name">:</span>  <span class="token string">"100m"</span>
    <span class="token punctuation">}</span>,
   <span class="token string">"registry-mirrors"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token string">"https://hub-mirror.c.163.com"</span>,
    <span class="token string">"https://mirror.baidubce.com"</span>
  <span class="token punctuation">]</span>
 <span class="token punctuation">}</span>
</code></pre> 
<p>启动 docker</p> 
<pre><code class="prism language-bash">systemctl start <span class="token function">docker</span> <span class="token operator">&amp;&amp;</span> systemctl <span class="token builtin class-name">enable</span> <span class="token function">docker</span>
</code></pre> 
<h3><a id="2__dockercompose_32"></a>2. 安装 docker-compose</h3> 
<p>下载最新版本：<a href="https://github.com/docker/compose/releases/">https://github.com/docker/compose/releases</a></p> 
<pre><code class="prism language-bash"> <span class="token function">sudo</span> <span class="token function">curl</span> <span class="token parameter variable">-L</span> <span class="token string">"https://github.com/docker/compose/releases/download/v2.20.3/docker-compose-linux-x86_64"</span> <span class="token parameter variable">-o</span> /usr/local/bin/docker-compose
 <span class="token function">sudo</span> <span class="token function">chmod</span> +x /usr/local/bin/docker-compose	
 <span class="token function">sudo</span> <span class="token function">ln</span> <span class="token parameter variable">-s</span> /usr/local/bin/docker-compose /usr/bin/docker-compose
</code></pre> 
<pre><code class="prism language-bash">$ <span class="token function">docker-compose</span> <span class="token parameter variable">--version</span>
Docker Compose version v2.20.3
</code></pre> 
<h3><a id="3__harbor_45"></a>3. 下载 harbor</h3> 
<p>下载最新harbor：<a href="https://github.com/goharbor/harbor/releases">https://github.com/goharbor/harbor/releases</a></p> 
<pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">curl</span> <span class="token parameter variable">-L</span> <span class="token string">"https://github.com/goharbor/harbor/releases/download/v2.8.3/harbor-offline-installer-v2.8.3.tgz"</span> <span class="token parameter variable">-o</span> harbor-offline-installer-v2.8.3.tgz


</code></pre> 
<pre><code class="prism language-bash">$ <span class="token function">tar</span> xzvf harbor-offline-installer-v2.8.3.tgz
harbor/harbor.v2.8.3.tar.gz
harbor/prepare
harbor/LICENSE
harbor/install.sh
harbor/common.sh
harbor/harbor.yml.tmpl

$ <span class="token function">ls</span> harbor
common.sh  harbor.v2.8.3.tar.gz  harbor.yml.tmpl  install.sh  LICENSE  prepare
</code></pre> 
<h3><a id="4__harboryml_66"></a>4. 定制配置文件 harbor.yml</h3> 
<pre><code class="prism language-bash"><span class="token function">cp</span> harbor.yml.tmpl harbor.yml
</code></pre> 
<pre><code class="prism language-bash">$ <span class="token function">vim</span> harbor.yml
hostname: harbor.demo.com
http:
  port: <span class="token number">80</span>
https:
  port: <span class="token number">443</span>
  certificate: /data/cert/harbor.demo.com.crt
  private_key: /data/cert/harbor.demo.com.key
harbor_admin_password: Harbor12345
database:
  password: root123
  max_idle_conns: <span class="token number">100</span>
  max_open_conns: <span class="token number">900</span>
data_volume: /data
trivy:
  ignore_unfixed: <span class="token boolean">false</span>
  skip_update: <span class="token boolean">false</span>
  offline_scan: <span class="token boolean">false</span>
  security_check: vuln
  insecure: <span class="token boolean">false</span>
jobservice:
  max_job_workers: <span class="token number">10</span>
notification:
  webhook_job_max_retry: <span class="token number">10</span>
chart:
  absolute_url: disabled
log:
  level: info
  local:
    rotate_count: <span class="token number">50</span>
    rotate_size: 200M
    location: /var/log/harbor
_version: <span class="token number">2.6</span>.0
proxy:
  http_proxy:
  https_proxy:
  no_proxy:
  components:
    - core
    - jobservice
    - trivy
upload_purging:
  enabled: <span class="token boolean">true</span>
  age: 168h
  interval: 24h
  dryrun: <span class="token boolean">false</span>
cache:
  enabled: <span class="token boolean">false</span>
  expire_hours: <span class="token number">24</span>
</code></pre> 
<h3><a id="5__124"></a>5. 配置证书</h3> 
<h4><a id="51__125"></a>5.1 生成证书颁发机构证书</h4> 
<p>生成 CA 证书私钥ca.key</p> 
<pre><code class="prism language-bash">openssl genrsa <span class="token parameter variable">-out</span> ca.key <span class="token number">4096</span>
</code></pre> 
<p>#生成 CA 证书</p> 
<pre><code class="prism language-bash">openssl req <span class="token parameter variable">-x509</span> <span class="token parameter variable">-new</span> <span class="token parameter variable">-nodes</span> <span class="token parameter variable">-sha512</span> <span class="token parameter variable">-days</span> <span class="token number">3650</span> <span class="token parameter variable">-subj</span> <span class="token string">"/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=harbor.demo.com"</span> <span class="token parameter variable">-key</span> ca.key <span class="token parameter variable">-out</span> ca.crt
</code></pre> 
<h4><a id="52__134"></a>5.2 生成服务器证书</h4> 
<p>生成私钥</p> 
<pre><code class="prism language-bash">openssl genrsa <span class="token parameter variable">-out</span> harbor.demo.com.key <span class="token number">4096</span>
</code></pre> 
<p>生成证书签名请求 (CSR)</p> 
<pre><code class="prism language-bash">openssl req <span class="token parameter variable">-sha512</span> <span class="token parameter variable">-new</span> <span class="token parameter variable">-subj</span> <span class="token string">"/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=harbor.demo.com"</span>  <span class="token parameter variable">-key</span> harbor.demo.com.key <span class="token parameter variable">-out</span> harbor.demo.com.csr
</code></pre> 
<p>生成 <code>x509 v3</code> 扩展文件</p> 
<pre><code class="prism language-bash"><span class="token function">cat</span> <span class="token operator">&gt;</span> v3.ext <span class="token operator">&lt;&lt;-</span><span class="token string">EOF
authorityKeyIdentifier=keyid,issuer
basicConstraints=CA:FALSE
keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment
extendedKeyUsage = serverAuth
subjectAltName = @alt_names

[alt_names]
DNS.1=harbor.demo.com
DNS.2=harbor.demo
DNS.3=hostname
EOF</span>
</code></pre> 
<p>使用该<code>v3.ext</code>文件为您的 Harbor 主机生成证书</p> 
<pre><code class="prism language-bash">openssl x509 <span class="token parameter variable">-req</span> <span class="token parameter variable">-sha512</span> <span class="token parameter variable">-days</span> <span class="token number">3650</span> <span class="token parameter variable">-extfile</span> v3.ext <span class="token parameter variable">-CA</span> ca.crt <span class="token parameter variable">-CAkey</span> ca.key <span class="token parameter variable">-CAcreateserial</span> <span class="token parameter variable">-in</span> harbor.demo.com.csr <span class="token parameter variable">-out</span> harbor.demo.com.crt
</code></pre> 
<h4><a id="53__Harbor__Docker__166"></a>5.3 向 Harbor 和 Docker 提供证书</h4> 
<p>将服务器证书和密钥复制到 Harbor 主机上的 certficates 文件夹中</p> 
<pre><code class="prism language-bash"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /data/cert
<span class="token function">cp</span> harbor.demo.com.crt /data/cert/
<span class="token function">cp</span> harbor.demo.com.key /data/cert/
</code></pre> 
<p>转换<code>harbor.demo.com.crt</code>为<code>harbor.demo.com.key.cert</code>，供 docker使用</p> 
<pre><code class="prism language-bash">openssl x509 <span class="token parameter variable">-inform</span> PEM <span class="token parameter variable">-in</span> harbor.demo.com.crt <span class="token parameter variable">-out</span> harbor.demo.com.cert
</code></pre> 
<p>将服务器证书、密钥和 CA 文件复制到 Harbor 主机上的 <code>docker</code> 证书文件夹中。您必须首先创建适当的文件夹</p> 
<pre><code class="prism language-bash"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/docker/certs.d/harbor.demo.com/
<span class="token function">cp</span> harbor.demo.com.cert /etc/docker/certs.d/harbor.demo.com/
<span class="token function">cp</span> harbor.demo.com.key /etc/docker/certs.d/harbor.demo.com/
<span class="token function">cp</span> ca.crt /etc/docker/certs.d/harbor.demo.com/
</code></pre> 
<p>配置生效</p> 
<pre><code class="prism language-bash">systemctl daemon-reload <span class="token operator">&amp;&amp;</span>  systemctl restart <span class="token function">docker</span> <span class="token operator">&amp;&amp;</span> systemctl status <span class="token function">docker</span>
</code></pre> 
<h3><a id="6__harbor_191"></a>6. 部署 harbor</h3> 
<p>运行<code>prepare</code>脚本以启用 HTTPS</p> 
<pre><code class="prism language-bash">./prepare
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-bash">prepare base <span class="token function">dir</span> is <span class="token builtin class-name">set</span> to /root/harbor
Unable to <span class="token function">find</span> image <span class="token string">'goharbor/prepare:v2.8.3'</span> locally
v2.8.3: Pulling from goharbor/prepare
d46c4d5563bc: Pulling fs layer
2014728b1023: Pulling fs layer
aab288eb9305: Pulling fs layer
f5624bd14a09: Waiting
d706af45859a: Waiting
758da3aa4679: Waiting
af6231a55025: Waiting
8c758607ff4a: Waiting
fb477479c0dd: Waiting
99767f301e98: Waiting
v2.8.3: Pulling from goharbor/prepare
d46c4d5563bc: Pull complete
2014728b1023: Pull complete
aab288eb9305: Pull complete
f5624bd14a09: Pull complete
d706af45859a: Pull complete
758da3aa4679: Pull complete
af6231a55025: Pull complete
8c758607ff4a: Pull complete
fb477479c0dd: Pull complete
99767f301e98: Pull complete
Digest: sha256:43e0c17257f4ebe982edd0fbf8e8f2081c81550769dc92ed06ed16e1641fc8a9
Status: Downloaded newer image <span class="token keyword">for</span> goharbor/prepare:v2.8.3
Generated configuration file: /config/portal/nginx.conf
Generated configuration file: /config/log/logrotate.conf
Generated configuration file: /config/log/rsyslog_docker.conf
Generated configuration file: /config/nginx/nginx.conf
Generated configuration file: /config/core/env
Generated configuration file: /config/core/app.conf
Generated configuration file: /config/registry/config.yml
Generated configuration file: /config/registryctl/env
Generated configuration file: /config/registryctl/config.yml
Generated configuration file: /config/db/env
Generated configuration file: /config/jobservice/env
Generated configuration file: /config/jobservice/config.yml
Generated and saved secret to file: /data/secret/keys/secretkey
Successfully called func: create_root_cert
Generated configuration file: /compose_location/docker-compose.yml
Clean up the input <span class="token function">dir</span>
</code></pre> 
<p>启动</p> 
<pre><code class="prism language-bash"><span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span>
</code></pre> 
<p>查看容器状态</p> 
<pre><code class="prism language-bash">$ <span class="token function">docker-compose</span> <span class="token function">ps</span>
NAME                COMMAND                  SERVICE             STATUS              PORTS
harbor-core         <span class="token string">"/harbor/entrypoint.…"</span>   core                running <span class="token punctuation">(</span>healthy<span class="token punctuation">)</span>
harbor-db           <span class="token string">"/docker-entrypoint.…"</span>   postgresql          running <span class="token punctuation">(</span>healthy<span class="token punctuation">)</span>
harbor-jobservice   <span class="token string">"/harbor/entrypoint.…"</span>   jobservice          running <span class="token punctuation">(</span>healthy<span class="token punctuation">)</span>
harbor-log          <span class="token string">"/bin/sh -c /usr/loc…"</span>   log                 running <span class="token punctuation">(</span>healthy<span class="token punctuation">)</span>   <span class="token number">127.0</span>.0.1:1514-<span class="token operator">&gt;</span><span class="token number">10514</span>/tcp
harbor-portal       <span class="token string">"nginx -g 'daemon of…"</span>   portal              running <span class="token punctuation">(</span>healthy<span class="token punctuation">)</span>
nginx               <span class="token string">"nginx -g 'daemon of…"</span>   proxy               running <span class="token punctuation">(</span>healthy<span class="token punctuation">)</span>   <span class="token number">0.0</span>.0.0:80-<span class="token operator">&gt;</span><span class="token number">8080</span>/tcp, :::80-<span class="token operator">&gt;</span><span class="token number">8080</span>/tcp, <span class="token number">0.0</span>.0.0:443-<span class="token operator">&gt;</span><span class="token number">8443</span>/tcp, :::443-<span class="token operator">&gt;</span><span class="token number">8443</span>/tcp
redis               <span class="token string">"redis-server /etc/r…"</span>   redis               running <span class="token punctuation">(</span>healthy<span class="token punctuation">)</span>
registry            <span class="token string">"/home/harbor/entryp…"</span>   registry            running <span class="token punctuation">(</span>healthy<span class="token punctuation">)</span>
registryctl         <span class="token string">"/home/harbor/start.…"</span>   registryctl         running <span class="token punctuation">(</span>healthy<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="7__262"></a>7. 测试</h3> 
<p>命令行登陆</p> 
<pre><code class="prism language-bash">$  <span class="token function">docker</span> login harbor.demo.com
Username: admin
Password: Harbor12345
WARNING<span class="token operator">!</span> Your password will be stored unencrypted <span class="token keyword">in</span> /root/.docker/config.json.
Configure a credential helper to remove this warning. See
https://docs.docker.com/engine/reference/commandline/login/<span class="token comment">#credentials-store</span>

Login Succeeded
</code></pre> 
<p>界面登陆</p> 
<ul><li><code>https://harbor.demo.com</code></li><li>admin/Harbor12345<br> <img src="https://images2.imgbox.com/53/bc/1cxTQALB_o.png" alt=""><br> <img src="https://images2.imgbox.com/0e/92/llxaxDbb_o.png" alt=""></li></ul> 
<p>终于部署结束了，如果你想参考更多关于 harbor 内容，请参考：</p> 
<ul><li><a href="https://ghostwritten.blog.csdn.net/article/details/121381151" rel="nofollow">harbor 部署入门指南</a></li><li><a href="https://goharbor.io/" rel="nofollow">官方 Harbor</a></li><li><a href="https://cloud.tencent.com/developer/column/76096/tag-10649" rel="nofollow">亨利笔记</a></li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a15904dfbd4ee8595dc1d248ae2d44f4/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">C&#43;&#43; map/set的模拟实现（基于红黑树）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/041fd6c30a86553d43a9b3a8ad4ee3f6/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">基于java的网上订餐管理系统设计与实现</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>