<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>yolov8seg 瑞芯微RKNN芯片、地平线Horizon芯片、TensorRT部署 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="yolov8seg 瑞芯微RKNN芯片、地平线Horizon芯片、TensorRT部署" />
<meta property="og:description" content="特别说明：参考官方开源的yolov8代码、瑞芯微官方文档、地平线的官方文档，如有侵权告知删，谢谢。
模型、测试图像、测试结果、完整代码，放在github上，参考链接 模型和代码。
由于之前写了三篇yolov8检测部署板端芯片相关的博文，有网友让写一篇yolov8seg部署博客，一直迟迟未行动，最近忙中借闲匆匆对yolov8seg进行了梳理，尝试了对yolov8seg进行部署验证和仿真测试。总体感受，yolov8的检测由于使用DFL，使得（检测&#43;后处理）相对慢不少，如果把DFL模块相关的放模型里做导致模型慢不少，如果放后处理中做后处理慢（到底是放模型中做还是放后处理中做，根据整个系统的资源合理放置，本示例中是放在模型中进行的）；yolov8seg 还需处理mask系数，同时分割结果还需乘以系数，使得对板端部署不是很友好。
特别说明：本示例中模型的训练使用的数据并不是很多，模型效果无法保证，只是用来测试部署用的，如果换一张图像可能存在检测不到属于正常现象。分割相关的后处理可能对板端部署还不是很优化，欢迎共同探讨优化。
1 模型和训练 训练代码参考官方开源的yolov8seg 训练代码，由于SiLU在有些板端芯片上还不支持，因此将其改为ReLU，训练数据集是coco的一部分训练的，主要是用来测试流程用，模型效果无法保证，换一张图像测试检测不到正常。
2 导出 yolov8seg 的 onnx 本实例提供的导出onnx方式只适配本示例对应仓库的代码，如果用官方导出的onnx，请自行写后处理代码。谢谢
后处理中有些算在板端芯片上效率低或者不支持，导出 onnx 需要将板端芯片不友好或不支持算子规避掉。导出onnx修改的部分。
第一步：
将pt只保存权重值，增加代码如下图。
# 保存权重值 import torch self.model.fuse() self.model.eval() torch.save(self.model.state_dict(), &#39;./weights/yolov8n-seg_relu_80class_dict.pt&#39;) 修改后运行以下代码（在weights文件夹下生成yolov8n-seg_relu_80class_dict.pt）：
model = YOLO(&#39;./weights/yolov8n-seg_relu_80class.pt&#39;) result = model(task=&#39;segment&#39;, mode=&#39;predict&#39;, source=&#39;./images/test.jpg&#39;, line_width=3, show=True, save=True, device=&#39;cpu&#39;) 第二步：
导出onnx，去除不需要的算子。修改代码如下。
（1）修改检测头
修改该模块的完整代码：
class Detect(nn.Module): &#34;&#34;&#34;YOLOv8 Detect head for detection models.&#34;&#34;&#34; dynamic = False # force grid reconstruction export = False # export mode shape = None anchors = torch." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/a8d5743b9662995ad48a2f1bbc84048d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-02T10:03:13+08:00" />
<meta property="article:modified_time" content="2024-01-02T10:03:13+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">yolov8seg 瑞芯微RKNN芯片、地平线Horizon芯片、TensorRT部署</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>  特别说明：参考官方开源的yolov8代码、瑞芯微官方文档、地平线的官方文档，如有侵权告知删，谢谢。</p> 
<p>  模型、测试图像、测试结果、完整代码，放在github上，<strong>参考链接</strong> <a href="https://github.com/cqu20160901/yolov8seg_onnx_tensorRT_rknn_horizon">模型和代码</a>。</p> 
<p>  由于之前写了三篇yolov8检测部署板端芯片相关的博文，有网友让写一篇yolov8seg部署博客，一直迟迟未行动，最近忙中借闲匆匆对yolov8seg进行了梳理，尝试了对yolov8seg进行部署验证和仿真测试。总体感受，yolov8的检测由于使用DFL，使得（检测+后处理）相对慢不少，如果把DFL模块相关的放模型里做导致模型慢不少，如果放后处理中做后处理慢（到底是放模型中做还是放后处理中做，根据整个系统的资源合理放置，本示例中是放在模型中进行的）；yolov8seg 还需处理mask系数，同时分割结果还需乘以系数，使得对板端部署不是很友好。</p> 
<p>  <strong><em>特别说明</em>：本示例中模型的训练使用的数据并不是很多，模型效果无法保证，只是用来测试部署用的，如果换一张图像可能存在检测不到属于正常现象。分割相关的后处理可能对板端部署还不是很优化，欢迎共同探讨优化。</strong></p> 
<h2><a id="1__8"></a>1 模型和训练</h2> 
<p>  训练代码参考官方开源的yolov8seg 训练代码，由于SiLU在有些板端芯片上还不支持，因此将其改为ReLU，训练数据集是coco的一部分训练的，主要是用来测试流程用，模型效果无法保证，换一张图像测试检测不到正常。</p> 
<h2><a id="2__yolov8seg__onnx_10"></a>2 导出 yolov8seg 的 onnx</h2> 
<p>  <em><strong>本实例提供的导出onnx方式只适配本示例对应仓库的代码，如果用官方导出的onnx，请自行写后处理代码。谢谢</strong></em></p> 
<p>  后处理中有些算在板端芯片上效率低或者不支持，导出 onnx 需要将板端芯片不友好或不支持算子规避掉。导出onnx修改的部分。<br> 第一步：<br> 将pt只保存权重值，增加代码如下图。<br> <img src="https://images2.imgbox.com/77/8a/fYBp70IZ_o.png" alt="导出权重字典"></p> 
<pre><code class="prism language-python">        <span class="token comment"># 保存权重值</span>
        <span class="token keyword">import</span> torch
        self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>fuse<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'./weights/yolov8n-seg_relu_80class_dict.pt'</span><span class="token punctuation">)</span>
</code></pre> 
<p>修改后运行以下代码（在weights文件夹下生成yolov8n-seg_relu_80class_dict.pt）：</p> 
<pre><code class="prism language-python">model <span class="token operator">=</span> YOLO<span class="token punctuation">(</span><span class="token string">'./weights/yolov8n-seg_relu_80class.pt'</span><span class="token punctuation">)</span>
result <span class="token operator">=</span> model<span class="token punctuation">(</span>task<span class="token operator">=</span><span class="token string">'segment'</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'predict'</span><span class="token punctuation">,</span> source<span class="token operator">=</span><span class="token string">'./images/test.jpg'</span><span class="token punctuation">,</span> line_width<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> show<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> save<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> device<span class="token operator">=</span><span class="token string">'cpu'</span><span class="token punctuation">)</span>
</code></pre> 
<p>第二步：<br> 导出onnx，去除不需要的算子。修改代码如下。<br> （1）修改检测头<br> <img src="https://images2.imgbox.com/8d/27/q5G1SJkL_o.png" alt="在这里插入图片描述"><br> 修改该模块的完整代码：</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">Detect</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""YOLOv8 Detect head for detection models."""</span>
    dynamic <span class="token operator">=</span> <span class="token boolean">False</span>  <span class="token comment"># force grid reconstruction</span>
    export <span class="token operator">=</span> <span class="token boolean">False</span>  <span class="token comment"># export mode</span>
    shape <span class="token operator">=</span> <span class="token boolean">None</span>
    anchors <span class="token operator">=</span> torch<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># init</span>
    strides <span class="token operator">=</span> torch<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># init</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> nc<span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">,</span> ch<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># detection layer</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>nc <span class="token operator">=</span> nc  <span class="token comment"># number of classes</span>
        self<span class="token punctuation">.</span>nl <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>  <span class="token comment"># number of detection layers</span>
        self<span class="token punctuation">.</span>reg_max <span class="token operator">=</span> <span class="token number">16</span>  <span class="token comment"># DFL channels (ch[0] // 16 to scale 4/8/12/16/20 for n/s/m/l/x)</span>
        self<span class="token punctuation">.</span>no <span class="token operator">=</span> nc <span class="token operator">+</span> self<span class="token punctuation">.</span>reg_max <span class="token operator">*</span> <span class="token number">4</span>  <span class="token comment"># number of outputs per anchor</span>
        self<span class="token punctuation">.</span>stride <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>self<span class="token punctuation">.</span>nl<span class="token punctuation">)</span>  <span class="token comment"># strides computed during build</span>
        c2<span class="token punctuation">,</span> c3 <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> ch<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">//</span> <span class="token number">4</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>reg_max <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token punctuation">(</span>ch<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>nc<span class="token punctuation">)</span>  <span class="token comment"># channels</span>
        self<span class="token punctuation">.</span>cv2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>ModuleList<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>Conv<span class="token punctuation">(</span>x<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Conv<span class="token punctuation">(</span>c2<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>c2<span class="token punctuation">,</span> <span class="token number">4</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>reg_max<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> ch<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cv3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>ModuleList<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>Conv<span class="token punctuation">(</span>x<span class="token punctuation">,</span> c3<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Conv<span class="token punctuation">(</span>c3<span class="token punctuation">,</span> c3<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>c3<span class="token punctuation">,</span> self<span class="token punctuation">.</span>nc<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> ch<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>dfl <span class="token operator">=</span> DFL<span class="token punctuation">(</span>self<span class="token punctuation">.</span>reg_max<span class="token punctuation">)</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>reg_max <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token keyword">else</span> nn<span class="token punctuation">.</span>Identity<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 导出 onnx 增加</span>
        self<span class="token punctuation">.</span>conv1x1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>requires_grad_<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv1x1<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span>x<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Concatenates and returns predicted bounding boxes and class probabilities."""</span>
        shape <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shape  <span class="token comment"># BCHW</span>
        y <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>nl<span class="token punctuation">)</span><span class="token punctuation">:</span>
            t1 <span class="token operator">=</span> self<span class="token punctuation">.</span>cv2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
            t2 <span class="token operator">=</span> self<span class="token punctuation">.</span>cv3<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
            y<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv1x1<span class="token punctuation">(</span>t1<span class="token punctuation">.</span>view<span class="token punctuation">(</span>t1<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>softmax<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment"># y.append(t2.sigmoid())</span>
            y<span class="token punctuation">.</span>append<span class="token punctuation">(</span>t2<span class="token punctuation">)</span>
        <span class="token keyword">return</span> y

        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>nl<span class="token punctuation">)</span><span class="token punctuation">:</span>
            x<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>cv2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>cv3<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>training<span class="token punctuation">:</span>
            <span class="token keyword">return</span> x
        <span class="token keyword">elif</span> self<span class="token punctuation">.</span>dynamic <span class="token keyword">or</span> self<span class="token punctuation">.</span>shape <span class="token operator">!=</span> shape<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>anchors<span class="token punctuation">,</span> self<span class="token punctuation">.</span>strides <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> make_anchors<span class="token punctuation">(</span>x<span class="token punctuation">,</span> self<span class="token punctuation">.</span>stride<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>shape <span class="token operator">=</span> shape

        x_cat <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>xi<span class="token punctuation">.</span>view<span class="token punctuation">(</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>no<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">for</span> xi <span class="token keyword">in</span> x<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>export <span class="token keyword">and</span> self<span class="token punctuation">.</span><span class="token builtin">format</span> <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token string">'saved_model'</span><span class="token punctuation">,</span> <span class="token string">'pb'</span><span class="token punctuation">,</span> <span class="token string">'tflite'</span><span class="token punctuation">,</span> <span class="token string">'edgetpu'</span><span class="token punctuation">,</span> <span class="token string">'tfjs'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># avoid TF FlexSplitV ops</span>
            box <span class="token operator">=</span> x_cat<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span>self<span class="token punctuation">.</span>reg_max <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">]</span>
            cls <span class="token operator">=</span> x_cat<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>reg_max <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            box<span class="token punctuation">,</span> cls <span class="token operator">=</span> x_cat<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>reg_max <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>nc<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        dbox <span class="token operator">=</span> dist2bbox<span class="token punctuation">(</span>self<span class="token punctuation">.</span>dfl<span class="token punctuation">(</span>box<span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>anchors<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> xywh<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>strides
        y <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>dbox<span class="token punctuation">,</span> cls<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>           <span class="token comment"># 官方代码</span>
        <span class="token comment"># y = torch.cat((self.dfl(box), cls.sigmoid()), 1)    # 导出本实例的onnx使用</span>
        <span class="token keyword">return</span> y <span class="token keyword">if</span> self<span class="token punctuation">.</span>export <span class="token keyword">else</span> <span class="token punctuation">(</span>y<span class="token punctuation">,</span> x<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">bias_init</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Initialize Detect() biases, WARNING: requires stride availability."""</span>
        m <span class="token operator">=</span> self  <span class="token comment"># self.model[-1]  # Detect() module</span>
        <span class="token comment"># cf = torch.bincount(torch.tensor(np.concatenate(dataset.labels, 0)[:, 0]).long(), minlength=nc) + 1</span>
        <span class="token comment"># ncf = math.log(0.6 / (m.nc - 0.999999)) if cf is None else torch.log(cf / cf.sum())  # nominal class frequency</span>
        <span class="token keyword">for</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> s <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>cv2<span class="token punctuation">,</span> m<span class="token punctuation">.</span>cv3<span class="token punctuation">,</span> m<span class="token punctuation">.</span>stride<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># from</span>
            a<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>bias<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1.0</span>  <span class="token comment"># box</span>
            b<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>bias<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token punctuation">:</span>m<span class="token punctuation">.</span>nc<span class="token punctuation">]</span> <span class="token operator">=</span> math<span class="token punctuation">.</span>log<span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">/</span> m<span class="token punctuation">.</span>nc <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">640</span> <span class="token operator">/</span> s<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># cls (.01 objects, 80 classes, 640 img)</span>

</code></pre> 
<p>（2）修改分割头<br> <img src="https://images2.imgbox.com/d8/93/6et0miCj_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">Segment</span><span class="token punctuation">(</span>Detect<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""YOLOv8 Segment head for segmentation models."""</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> nc<span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">,</span> nm<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> npr<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span> ch<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Initialize the YOLO model attributes such as the number of masks, prototypes, and the convolution layers."""</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>nc<span class="token punctuation">,</span> ch<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>nm <span class="token operator">=</span> nm  <span class="token comment"># number of masks</span>
        self<span class="token punctuation">.</span>npr <span class="token operator">=</span> npr  <span class="token comment"># number of protos</span>
        self<span class="token punctuation">.</span>proto <span class="token operator">=</span> Proto<span class="token punctuation">(</span>ch<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>npr<span class="token punctuation">,</span> self<span class="token punctuation">.</span>nm<span class="token punctuation">)</span>  <span class="token comment"># protos</span>
        self<span class="token punctuation">.</span>detect <span class="token operator">=</span> Detect<span class="token punctuation">.</span>forward

        c4 <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>ch<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">//</span> <span class="token number">4</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>nm<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cv4 <span class="token operator">=</span> nn<span class="token punctuation">.</span>ModuleList<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>Conv<span class="token punctuation">(</span>x<span class="token punctuation">,</span> c4<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Conv<span class="token punctuation">(</span>c4<span class="token punctuation">,</span> c4<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>c4<span class="token punctuation">,</span> self<span class="token punctuation">.</span>nm<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> ch<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Return model outputs and mask coefficients if training, otherwise return outputs and mask coefficients."""</span>
        p <span class="token operator">=</span> self<span class="token punctuation">.</span>proto<span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># mask protos</span>
        bs <span class="token operator">=</span> p<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># batch size</span>

        <span class="token comment"># mc = torch.cat([self.cv4[i](x[i]).view(bs, self.nm, -1) for i in range(self.nl)], 2)  # mask coefficients</span>
        mc <span class="token operator">=</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>cv4<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>nl<span class="token punctuation">)</span><span class="token punctuation">]</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>detect<span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span>
        <span class="token keyword">return</span> x<span class="token punctuation">,</span> mc<span class="token punctuation">,</span> p
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>training<span class="token punctuation">:</span>
            <span class="token keyword">return</span> x<span class="token punctuation">,</span> mc<span class="token punctuation">,</span> p
        <span class="token keyword">return</span> <span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">,</span> mc<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>export <span class="token keyword">else</span> <span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> mc<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> mc<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre> 
<p>（3）添加生成onnx代码<br> <img src="https://images2.imgbox.com/42/36/lRYKCc00_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">_new</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> cfg<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> task<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Initializes a new model and infers the task type from the model definitions.
        Args:
            cfg (str): model configuration file
            task (str) or (None): model task
            verbose (bool): display model info on load
        """</span>
        cfg_dict <span class="token operator">=</span> yaml_model_load<span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cfg <span class="token operator">=</span> cfg
        self<span class="token punctuation">.</span>task <span class="token operator">=</span> task <span class="token keyword">or</span> guess_model_task<span class="token punctuation">(</span>cfg_dict<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>model <span class="token operator">=</span> TASK_MAP<span class="token punctuation">[</span>self<span class="token punctuation">.</span>task<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span>cfg_dict<span class="token punctuation">,</span> verbose<span class="token operator">=</span>verbose <span class="token keyword">and</span> RANK <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># build model</span>
        self<span class="token punctuation">.</span>overrides<span class="token punctuation">[</span><span class="token string">'model'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>cfg

        <span class="token comment"># Below added to allow export from yamls</span>
        args <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token operator">**</span>DEFAULT_CFG_DICT<span class="token punctuation">,</span> <span class="token operator">**</span>self<span class="token punctuation">.</span>overrides<span class="token punctuation">}</span>  <span class="token comment"># combine model and default args, preferring model args</span>
        self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>args <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>k<span class="token punctuation">:</span> v <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> args<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> k <span class="token keyword">in</span> DEFAULT_CFG_KEYS<span class="token punctuation">}</span>  <span class="token comment"># attach args to model</span>
        self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>task <span class="token operator">=</span> self<span class="token punctuation">.</span>task

        <span class="token keyword">import</span> torch
        self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>fuse<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">'./weights/yolov8n-seg_relu_80class_dict.pt'</span><span class="token punctuation">,</span> map_location<span class="token operator">=</span><span class="token string">'cpu'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strict<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"===========  onnx =========== "</span><span class="token punctuation">)</span>
        dummy_input <span class="token operator">=</span> torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">640</span><span class="token punctuation">,</span> <span class="token number">640</span><span class="token punctuation">)</span>
        input_names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"data"</span><span class="token punctuation">]</span>
        output_names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"cls1"</span><span class="token punctuation">,</span> <span class="token string">"reg1"</span><span class="token punctuation">,</span> <span class="token string">"cls2"</span><span class="token punctuation">,</span> <span class="token string">"reg2"</span><span class="token punctuation">,</span> <span class="token string">"cls3"</span><span class="token punctuation">,</span> <span class="token string">"reg3"</span><span class="token punctuation">,</span> <span class="token string">"mc1"</span><span class="token punctuation">,</span> <span class="token string">"mc2"</span><span class="token punctuation">,</span> <span class="token string">"mc3"</span><span class="token punctuation">,</span> <span class="token string">"seg"</span><span class="token punctuation">]</span>
        torch<span class="token punctuation">.</span>onnx<span class="token punctuation">.</span>export<span class="token punctuation">(</span>self<span class="token punctuation">.</span>model<span class="token punctuation">,</span> dummy_input<span class="token punctuation">,</span> <span class="token string">"./weights/yolov8n-seg_relu_80class.onnx"</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> input_names<span class="token operator">=</span>input_names<span class="token punctuation">,</span> output_names<span class="token operator">=</span>output_names<span class="token punctuation">,</span> opset_version<span class="token operator">=</span><span class="token number">11</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"======================== convert onnx Finished! .... "</span><span class="token punctuation">)</span>

</code></pre> 
<p>修改完以上三块，运行以下代码（生成onnx模型）：</p> 
<pre><code class="prism language-python">model <span class="token operator">=</span> YOLO<span class="token punctuation">(</span><span class="token string">'./ultralytics/models/v8/yolov8-seg.yaml'</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>注意：以上修改顺序一定不能错，两次运行的代码也不一样，请注意，请注意，请注意。</strong></p> 
<h2><a id="3_yolov8seg_pytoch_onnx__183"></a>3 yolov8seg 的pytoch 和onnx 测试结果</h2> 
<p>（1）pytorch测试结果<br> <img src="https://images2.imgbox.com/60/5e/RsbSZTqu_o.jpg" alt="在这里插入图片描述"></p> 
<p>（2）onnx测试结果<br> <img src="https://images2.imgbox.com/72/3e/0G2mA7dj_o.jpg" alt="在这里插入图片描述"></p> 
<h2><a id="4_rknnhorizon_190"></a>4 瑞芯微rknn和地平线horizon仿真测试参考</h2> 
<p>  瑞芯微环境搭建和详细步骤参考 <a href="https://blog.csdn.net/zhangqian_1/article/details/126831502">【瑞芯微RKNN模型转换和PC端仿真】</a>。</p> 
<p>  地平线环境搭建和详细步骤参考<a href="https://blog.csdn.net/zhangqian_1/article/details/128243698">【地平线Horizon模型转换和PC端仿真测试】</a>。</p> 
<h2><a id="5__196"></a>5 相关链接</h2> 
<p><a href="https://blog.csdn.net/zhangqian_1/article/details/128918268">yolov8 检测瑞芯微RKNN和地平线Horizon芯片仿真测试部署</a></p> 
<p><a href="https://blog.csdn.net/zhangqian_1/article/details/131130085">yolov8 瑞芯微 RKNN 的 C++部署</a></p> 
<p><a href="https://blog.csdn.net/zhangqian_1/article/details/130754564">yolov8 导出官方模型进行瑞芯微RKNN和地平线Horizon芯片仿真测试部署</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a41653d712c54c85b10bdbebe588a15c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">单线复用场景下，详解IPTV透传原理</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/838bb1e9d6ac9d58cbcfd29e9be8aaf9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Python数据分析案例17——电影人气预测(特征工程构建)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>