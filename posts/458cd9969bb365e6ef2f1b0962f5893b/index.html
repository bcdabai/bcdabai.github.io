<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>full join 太费时间了 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="full join 太费时间了" />
<meta property="og:description" content="需求：将表 A,B,C 合并到一个结果集中
表A如图：
N	D 1	eeee 3	dddd 5	cccc 7	bbbb 9	aaaa 11	dddd 13	eeee 15	wwww 17	qqqq 19	tttttt 表B如图：
N	E 5	rrrrrr 4	fffff 3	ssssss 2	jjjjjj 1	kkkkkk 7	uuuuuu 表C如图：
N	F 5	oooo 4	lllll 3	hhss 2	ddfj 1	kdsfkkk 7	sduuu 8	ewrtwy 12	sdgfsd 22	dfgee 要得到的结果集如图：
N	D	E	F 1	eeee	kkkkkk	kdsfkkk 22	dfgee 11	dddd	13	eeee	2	jjjjjj	ddfj 5	cccc	rrrrrr	oooo 4	fffff	lllll 17	qqqq	8	ewrtwy 3	dddd	ssssss	hhss 7	bbbb	uuuuuu	sduuu 9	aaaa	15	wwww	19	tttttt	12	sdgfsd 两种思路：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/458cd9969bb365e6ef2f1b0962f5893b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2012-05-18T13:29:51+08:00" />
<meta property="article:modified_time" content="2012-05-18T13:29:51+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">full join 太费时间了</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>需求：将表 A,B,C 合并到一个结果集中</p> 
<p>表A如图：</p> 
<p></p> 
<pre><code class="language-html">N	D
1	eeee
3	dddd
5	cccc
7	bbbb
9	aaaa
11	dddd
13	eeee
15	wwww
17	qqqq
19	tttttt</code></pre> 
<p></p> 
<p>表B如图：</p> 
<p></p> 
<pre><code class="language-html">N	E
5	rrrrrr
4	fffff
3	ssssss
2	jjjjjj
1	kkkkkk
7	uuuuuu</code></pre> 
<p>表C如图：</p> 
<p></p> 
<pre><code class="language-html">N	F
5	oooo
4	lllll
3	hhss
2	ddfj
1	kdsfkkk
7	sduuu
8	ewrtwy
12	sdgfsd
22	dfgee</code></pre> 
<p>要得到的结果集如图：<img src="" alt=""><img src="" alt=""></p> 
<p><img src="" alt=""><br> </p> 
<pre><code class="language-html">N	D	E	F
1	eeee	kkkkkk	kdsfkkk
22	 	 	dfgee
11	dddd	 	 
13	eeee	 	 
2	 	jjjjjj	ddfj
5	cccc	rrrrrr	oooo
4	 	fffff	lllll
17	qqqq	 	 
8	 	 	ewrtwy
3	dddd	ssssss	hhss
7	bbbb	uuuuuu	sduuu
9	aaaa	 	 
15	wwww	 	 
19	tttttt	 	 
12	 	 	sdgfsd</code></pre> 
<img src="" alt=""> 
<br> 
<p></p> 
<p>两种思路：</p> 
<p>1, full join</p> 
<p>语句为：</p> 
<p></p> 
<pre><code class="language-html">select  nvl(a.n,nvl(b.n,c.n)) as N,
            a.d,b.e,c.f
from A full join B on A.N=B.N 
       full join c on b.n=c.n;</code></pre> 
<br> 
<p></p> 2, 先union all ，再列转行 
<p>语句为：</p> 
<p></p> 
<pre><code class="language-html">select n ,max(case when nn='a' then d end) as d,
          max(case when nn='b' then d end) as e,
          max(case when nn='c' then d end) as f
from (
  select n,d as d,'a' as nn from a
  union all
  select n,e as d,'b' as nn from b
  union all
  select n,f as d,'c' as nn from c
)
group by n;</code></pre> 
<p></p> 
<p><br> </p> 实际的问题是我要将70个左右的窄表连接成一个宽表，full join 几乎都编译不过，为此我对比了下2种情况的执行计划 
<p>使用 full join 的语句</p> 
<p></p> 
<pre><code class="language-html">explain plan for
select  nvl(a.n,nvl(b.n,c.n)) as N,
            a.d,b.e,c.f
from A full join B on A.N=B.N full join c on b.n=c.n;
select * from table(dbms_xplan.display());</code></pre> 
<p></p> 
<p>执行结果为</p> 
<p></p> 
<pre><code class="language-html">Plan hash value: 2877137913
 
--------------------------------------------------------------------------------
| Id  | Operation               | Name | Rows  | Bytes | Cost (%CPU)| Time     |
--------------------------------------------------------------------------------
|   0 | SELECT STATEMENT        |      |    19 |  1197 |   122   (4)| 00:00:02 |
|   1 |  VIEW                   |      |    19 |  1197 |   122   (4)| 00:00:02 |
|   2 |   UNION-ALL             |      |       |       |            |          |
|*  3 |    HASH JOIN OUTER      |      |    11 |  1342 |    61   (4)| 00:00:01 |
|   4 |     VIEW                |      |    11 |   825 |    57   (2)| 00:00:01 |
|   5 |      UNION-ALL          |      |       |       |            |          |
|*  6 |       HASH JOIN OUTER   |      |    10 |    60 |    29   (4)| 00:00:01 |
|   7 |        TABLE ACCESS FULL| A    |    10 |    30 |    14   (0)| 00:00:01 |
|   8 |        TABLE ACCESS FULL| B    |     5 |    15 |    14   (0)| 00:00:01 |
|*  9 |       HASH JOIN ANTI    |      |     1 |     6 |    29   (4)| 00:00:01 |
|  10 |        TABLE ACCESS FULL| B    |     5 |    15 |    14   (0)| 00:00:01 |
|  11 |        TABLE ACCESS FULL| A    |    10 |    30 |    14   (0)| 00:00:01 |
|  12 |     TABLE ACCESS FULL   | C    |     9 |   423 |     3   (0)| 00:00:01 |
|* 13 |    HASH JOIN ANTI       |      |     8 |   272 |    61   (4)| 00:00:01 |
|  14 |     TABLE ACCESS FULL   | C    |     9 |   189 |     3   (0)| 00:00:01 |
|  15 |     VIEW                |      |    11 |   143 |    57   (2)| 00:00:01 |
|  16 |      UNION-ALL          |      |       |       |            |          |
|* 17 |       HASH JOIN OUTER   |      |    10 |    60 |    29   (4)| 00:00:01 |
|  18 |        TABLE ACCESS FULL| A    |    10 |    30 |    14   (0)| 00:00:01 |
|  19 |        TABLE ACCESS FULL| B    |     5 |    15 |    14   (0)| 00:00:01 |
|* 20 |       HASH JOIN ANTI    |      |     1 |     6 |    29   (4)| 00:00:01 |
|  21 |        TABLE ACCESS FULL| B    |     5 |    15 |    14   (0)| 00:00:01 |
|  22 |        TABLE ACCESS FULL| A    |    10 |    30 |    14   (0)| 00:00:01 |
--------------------------------------------------------------------------------
 
Predicate Information (identified by operation id):
---------------------------------------------------
 
   3 - access("B"."N"="C"."N"(+))
   6 - access("A"."N"="B"."N"(+))
   9 - access("A"."N"="B"."N")
  13 - access("B"."N"="C"."N")
  17 - access("A"."N"="B"."N"(+))
  20 - access("A"."N"="B"."N")
 
Note
-----
   - dynamic sampling used for this statement</code></pre> 
<br> 使用union all 的语句 
<p></p> 
<p></p> 
<pre><code class="language-html">explain plan for
select n ,max(case when nn='a' then d end) as d,
          max(case when nn='b' then d end) as e,
          max(case when nn='c' then d end) as f
from (
   select n,d as d,'a' as nn from a
   union all
   select n,e as d,'b' as nn from b
   union all
   select n,f as d,'c' as nn from c
)
group by n;
select * from table(dbms_xplan.display());</code></pre> 
<br> 执行结果为： 
<p></p> 
<p></p> 
<pre><code class="language-html">1	Plan hash value: 1237158055
2	 
3	-----------------------------------------------------------------------------
4	| Id  | Operation            | Name | Rows  | Bytes | Cost (%CPU)| Time     |
5	-----------------------------------------------------------------------------
6	|   0 | SELECT STATEMENT     |      |    24 |   576 |    32   (4)| 00:00:01 |
7	|   1 |  HASH GROUP BY       |      |    24 |   576 |    32   (4)| 00:00:01 |
8	|   2 |   VIEW               |      |    24 |   576 |    31   (0)| 00:00:01 |
9	|   3 |    UNION-ALL         |      |       |       |            |          |
10	|   4 |     TABLE ACCESS FULL| A    |    10 |    30 |    14   (0)| 00:00:01 |
11	|   5 |     TABLE ACCESS FULL| B    |     5 |    15 |    14   (0)| 00:00:01 |
12	|   6 |     TABLE ACCESS FULL| C    |     9 |   189 |     3   (0)| 00:00:01 |
13	-----------------------------------------------------------------------------
14	 
15	Note
16	-----
17	   - dynamic sampling used for this statement</code></pre> 
<p></p> 
<p><br> </p> 
<p>对比2种处理方式，union all 的方式明显优于 full join。也可以看出简单的sql语句效率不一定好。</p> 
<br> 
<p><br> <br> </p> 
<p><br> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6a4e368345839397797c5d45fe8f9e76/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Win7系统IIS7&#43;Tomcat7集成</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/481cfb9d8db57051448a04cb9f6ea4eb/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">oracle下字段拆分，字段合并的一种方式</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>