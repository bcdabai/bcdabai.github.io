<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>深度学习之超分辨率算法——VDSR - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="深度学习之超分辨率算法——VDSR" />
<meta property="og:description" content="比较于之前的FSRCNN来说，VDSR我认为主要引入了以下优秀特点 首先是卷积层数的上的增加，卷积层数直接代表着模型提取特征的能力强弱小卷积核的进一步引入，利用卷积核3x3堆叠层数，模型一共20层。引入残差网络 缺点： 原文依然采用的MSE损失，单纯比较像素之间的差异。图像相对比较平滑。训练依然采用是SRCNN的训练方法，先上采样到高分辨率尺寸大小再进行训练。 两张图理解：
（输入尺寸等于输出尺寸的模型实现） 使用数据集:train.h5 model.py import torch import torch.nn as nn from math import sqrt class VDSR(nn.Module): def __init__(self): super(VDSR, self).__init__() # 残差网络 self.residual_layer = self.make_layer(Conv_ReLU_Block, 18) # 输入 self.input = nn.Conv2d(in_channels=1, out_channels=64, kernel_size=(3,3), stride=(1,1), padding=(1,1), bias=False) self.output = nn.Conv2d(in_channels=64, out_channels=1, kernel_size=(3,3), stride=(1,1), padding=(1,1), bias=False) self.relu = nn.ReLU(inplace=True) self.init_weights() def init_weights(self): # 模型初始化参数 for m in self.modules(): if isinstance(m, nn.Conv2d): n = m.kernel_size[0] * m.kernel_size[1] * m." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/69342ec1829f2e5720b0dc64add04358/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-05-25T17:06:29+08:00" />
<meta property="article:modified_time" content="2021-05-25T17:06:29+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">深度学习之超分辨率算法——VDSR</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <ul><li>比较于之前的FSRCNN来说，VDSR我认为主要引入了以下优秀特点 
  <ul><li>首先是卷积层数的上的增加，卷积层数直接代表着模型提取特征的能力强弱</li><li>小卷积核的进一步引入，利用卷积核3x3堆叠层数，模型一共20层。</li><li>引入残差网络</li></ul> </li><li>缺点： 
  <ul><li>原文依然采用的MSE损失，单纯比较像素之间的差异。图像相对比较平滑。</li><li>训练依然采用是SRCNN的训练方法，先上采样到高分辨率尺寸大小再进行训练。</li></ul> </li></ul> 
<p><img src="https://images2.imgbox.com/37/a3/zVFACPcI_o.png" alt="在这里插入图片描述"><br> 两张图理解：</p> 
<p><img src="https://images2.imgbox.com/75/c3/cQgAOCxd_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_12"></a>（输入尺寸等于输出尺寸的模型实现）</h4> 
<ul><li>使用数据集:train.h5</li></ul> 
<h4><a id="modelpy_14"></a>model.py</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">from</span> math <span class="token keyword">import</span> sqrt

<span class="token keyword">class</span> <span class="token class-name">VDSR</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>VDSR<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 残差网络</span>
        self<span class="token punctuation">.</span>residual_layer <span class="token operator">=</span> self<span class="token punctuation">.</span>make_layer<span class="token punctuation">(</span>Conv_ReLU_Block<span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span>

        <span class="token comment"># 输入</span>
        self<span class="token punctuation">.</span><span class="token builtin">input</span> <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> out_channels<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span>  kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>output <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> out_channels<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>  kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>relu <span class="token operator">=</span> nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>init_weights<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">init_weights</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 模型初始化参数</span>
        <span class="token keyword">for</span> m <span class="token keyword">in</span> self<span class="token punctuation">.</span>modules<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">)</span><span class="token punctuation">:</span>
                n <span class="token operator">=</span> m<span class="token punctuation">.</span>kernel_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> m<span class="token punctuation">.</span>kernel_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> m<span class="token punctuation">.</span>out_channels
                m<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data<span class="token punctuation">.</span>normal_<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> sqrt<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">.</span> <span class="token operator">/</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">make_layer</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> block<span class="token punctuation">,</span> num_of_layer<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 做18层网络呀.....</span>
        layers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_of_layer<span class="token punctuation">)</span><span class="token punctuation">:</span>
            layers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>block<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span><span class="token operator">*</span>layers<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        residual <span class="token operator">=</span> x
        <span class="token comment"># 1</span>
        out <span class="token operator">=</span> self<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token builtin">input</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># 18</span>
        out <span class="token operator">=</span> self<span class="token punctuation">.</span>residual_layer<span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        <span class="token comment"># 1</span>
        out <span class="token operator">=</span> self<span class="token punctuation">.</span>output<span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        <span class="token comment"># 残差</span>
        out <span class="token operator">=</span> residual<span class="token operator">+</span>out
        <span class="token keyword">return</span> out


<span class="token keyword">class</span> <span class="token class-name">Conv_ReLU_Block</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>Conv_ReLU_Block<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>sequential <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> out_channels<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>sequential<span class="token punctuation">(</span>x<span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    x<span class="token operator">=</span>  torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">224</span><span class="token punctuation">,</span><span class="token number">224</span><span class="token punctuation">)</span>
    net <span class="token operator">=</span> VDSR<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>net<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="datasetpy__80"></a>dataset.py （数据读取方式）</h4> 
<pre><code class="prism language-python">
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">as</span> data
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> h5py
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np


<span class="token keyword">class</span> <span class="token class-name">DatasetFromHdf5</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>Dataset<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> file_path<span class="token operator">=</span><span class="token string">"./data/train.h5"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>DatasetFromHdf5<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        hf <span class="token operator">=</span> h5py<span class="token punctuation">.</span>File<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>data <span class="token operator">=</span> hf<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>target <span class="token operator">=</span> hf<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'label'</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">:</span>
        image <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>index<span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        label <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>self<span class="token punctuation">.</span>target<span class="token punctuation">[</span>index<span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> image<span class="token punctuation">,</span>label

        
    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>data<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    data <span class="token operator">=</span> DatasetFromHdf5<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
    image <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    label <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>image<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
    <span class="token comment"># 显示图片</span>
    image <span class="token operator">=</span> Image<span class="token punctuation">.</span>fromarray<span class="token punctuation">(</span>image<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token number">255</span><span class="token punctuation">)</span>
    label <span class="token operator">=</span> Image<span class="token punctuation">.</span>fromarray<span class="token punctuation">(</span>label<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">)</span>
    image<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    label<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li>train.py</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">import</span> argparse<span class="token punctuation">,</span> os
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> random
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>backends<span class="token punctuation">.</span>cudnn <span class="token keyword">as</span> cudnn
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>optim <span class="token keyword">as</span> optim
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>autograd <span class="token keyword">import</span> Variable
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">import</span> DataLoader
<span class="token keyword">from</span> vdsr <span class="token keyword">import</span> VDSR
<span class="token keyword">from</span> dataset <span class="token keyword">import</span> DatasetFromHdf5

<span class="token keyword">def</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Training settings</span>
    parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">"the VDSR of Pytorch"</span><span class="token punctuation">)</span>

    <span class="token comment"># batch_size 每次投入模型的图像数据数</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--batch_size"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Training batch size"</span><span class="token punctuation">)</span>
    <span class="token comment"># 训练轮次</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--epochs"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Number of epochs to train for"</span><span class="token punctuation">)</span>
    <span class="token comment"># 学习率</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--lr"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">float</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0.0001</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Learning Rate. Default=0.1"</span><span class="token punctuation">)</span>
    <span class="token comment"># 动态学习率调整系数</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--step"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Sets the learning rate to the initial LR decayed by momentum every n epochs, Default: n=10"</span><span class="token punctuation">)</span>
    <span class="token comment"># 使用cuda</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--cuda"</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">"store_true"</span><span class="token punctuation">,</span>default<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span><span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Use cuda?"</span><span class="token punctuation">)</span>
    <span class="token comment"># 已训练权重</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--resume"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Path to checkpoint (default: none)"</span><span class="token punctuation">)</span>
    <span class="token comment"># 开始轮次</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--start-epoch"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Manual epoch number (useful on restarts)"</span><span class="token punctuation">)</span>
    <span class="token comment"># 梯度裁剪系数</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--clip"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">float</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Clipping Gradients. Default=0.4"</span><span class="token punctuation">)</span>
    <span class="token comment"># 单线程</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--num_workers"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Number of threads for data loader to use, Default: 1"</span><span class="token punctuation">)</span>
    <span class="token comment"># 优化器动量</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--momentum"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">float</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Momentum, Default: 0.9"</span><span class="token punctuation">)</span>
    <span class="token comment"># 正则化系数</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--weight-decay"</span><span class="token punctuation">,</span> <span class="token string">"--wd"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">float</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Weight decay, Default: 1e-4"</span><span class="token punctuation">)</span>
    <span class="token comment">#  预训练</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--pretrained'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'path to pretrained model (default: none)'</span><span class="token punctuation">)</span>
    <span class="token comment"># 默认GPU为0</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--gpus"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">"0"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"gpu ids (default: 0)"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> parser

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    parser <span class="token operator">=</span> init<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 获得所有参数</span>
    opt <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>opt<span class="token punctuation">)</span>
    <span class="token comment"># cuda设置gpu参数</span>
    cuda <span class="token operator">=</span> opt<span class="token punctuation">.</span>cuda

    <span class="token comment"># gpu配置</span>
    <span class="token keyword">if</span> cuda<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"=&gt; use gpu id: '{}'"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>opt<span class="token punctuation">.</span>gpus<span class="token punctuation">)</span><span class="token punctuation">)</span>
        os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"CUDA_VISIBLE_DEVICES"</span><span class="token punctuation">]</span> <span class="token operator">=</span> opt<span class="token punctuation">.</span>gpus
        <span class="token keyword">if</span> <span class="token operator">not</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">"No GPU found or Wrong gpu id, please run without --cuda"</span><span class="token punctuation">)</span>
    <span class="token comment"># 随机种子参数</span>
    opt<span class="token punctuation">.</span>seed <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Random Seed: "</span><span class="token punctuation">,</span> opt<span class="token punctuation">.</span>seed<span class="token punctuation">)</span>
    torch<span class="token punctuation">.</span>manual_seed<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>seed<span class="token punctuation">)</span>

    <span class="token keyword">if</span> cuda<span class="token punctuation">:</span>
        <span class="token comment"># 设置固定生成随机数的种子，使得每次运行该.py</span>
        <span class="token comment"># 文件时生成的随机数相同</span>
        torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>manual_seed<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>seed<span class="token punctuation">)</span>

    <span class="token comment"># 设置加速，优化运行效率</span>
    cudnn<span class="token punctuation">.</span>benchmark <span class="token operator">=</span> <span class="token boolean">True</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"===&gt; Loading datasets"</span><span class="token punctuation">)</span>
    train_set <span class="token operator">=</span> DatasetFromHdf5<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># training_data_loader = DataLoader(dataset=train_set,num_workers=opt.num_workers, batch_size=opt.batch_size, shuffle=True)</span>
    training_data_loader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>dataset<span class="token operator">=</span>train_set<span class="token punctuation">,</span> batch_size<span class="token operator">=</span>opt<span class="token punctuation">.</span>batch_size<span class="token punctuation">,</span>
                                      shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"===&gt; Building model"</span><span class="token punctuation">)</span>
    model <span class="token operator">=</span> VDSR<span class="token punctuation">(</span><span class="token punctuation">)</span>


    criterion <span class="token operator">=</span> nn<span class="token punctuation">.</span>MSELoss<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"===&gt; Setting GPU"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> cuda<span class="token punctuation">:</span>
        model <span class="token operator">=</span> model<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
        criterion <span class="token operator">=</span> criterion<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># optionally resume from a checkpoint</span>
    <span class="token keyword">if</span> opt<span class="token punctuation">.</span>resume<span class="token punctuation">:</span>
        <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isfile<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>resume<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"=&gt; loading checkpoint '{}'"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>opt<span class="token punctuation">.</span>resume<span class="token punctuation">)</span><span class="token punctuation">)</span>
            checkpoint <span class="token operator">=</span> torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>resume<span class="token punctuation">)</span>
            opt<span class="token punctuation">.</span>start_epoch <span class="token operator">=</span> checkpoint<span class="token punctuation">[</span><span class="token string">"epoch"</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span>
            model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>checkpoint<span class="token punctuation">[</span><span class="token string">"model"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"=&gt; no checkpoint found at '{}'"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>opt<span class="token punctuation">.</span>resume<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># optionally copy weights from a checkpoint</span>
    <span class="token keyword">if</span> opt<span class="token punctuation">.</span>pretrained<span class="token punctuation">:</span>

        <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isfile<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>pretrained<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"=&gt; loading model '{}'"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>opt<span class="token punctuation">.</span>pretrained<span class="token punctuation">)</span><span class="token punctuation">)</span>
            weights <span class="token operator">=</span> torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>pretrained<span class="token punctuation">)</span>
            model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>weights<span class="token punctuation">[</span><span class="token string">'model'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"=&gt; no model found at '{}'"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>opt<span class="token punctuation">.</span>pretrained<span class="token punctuation">)</span><span class="token punctuation">)</span>  

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"===&gt; Setting Optimizer"</span><span class="token punctuation">)</span>

    optimizer <span class="token operator">=</span> optim<span class="token punctuation">.</span>SGD<span class="token punctuation">(</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>opt<span class="token punctuation">.</span>lr<span class="token punctuation">,</span> momentum<span class="token operator">=</span>opt<span class="token punctuation">.</span>momentum<span class="token punctuation">,</span> weight_decay<span class="token operator">=</span>opt<span class="token punctuation">.</span>weight_decay<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"===&gt; Training"</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>opt<span class="token punctuation">.</span>start_epoch<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>epochs <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        train<span class="token punctuation">(</span>opt<span class="token punctuation">,</span>training_data_loader<span class="token punctuation">,</span> optimizer<span class="token punctuation">,</span> model<span class="token punctuation">,</span> criterion<span class="token punctuation">,</span> epoch<span class="token punctuation">)</span>
        save_checkpoint<span class="token punctuation">(</span>model<span class="token punctuation">,</span> epoch<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">adjust_learning_rate</span><span class="token punctuation">(</span>opt<span class="token punctuation">,</span> epoch<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Sets the learning rate to the initial LR decayed by 10 every 10 epochs"""</span>
    lr <span class="token operator">=</span> opt<span class="token punctuation">.</span>lr <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0.1</span> <span class="token operator">**</span> <span class="token punctuation">(</span>epoch <span class="token operator">//</span>opt<span class="token punctuation">.</span>step<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> lr

<span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>opt<span class="token punctuation">,</span>training_data_loader<span class="token punctuation">,</span> optimizer<span class="token punctuation">,</span> model<span class="token punctuation">,</span> criterion<span class="token punctuation">,</span> epoch<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># lr = adjust_learning_rate(opt, epoch-1)</span>
    lr <span class="token operator">=</span> opt<span class="token punctuation">.</span>lr
    <span class="token keyword">for</span> param_group <span class="token keyword">in</span> optimizer<span class="token punctuation">.</span>param_groups<span class="token punctuation">:</span>
        param_group<span class="token punctuation">[</span><span class="token string">"lr"</span><span class="token punctuation">]</span> <span class="token operator">=</span> lr

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Epoch = {}, lr = {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>epoch<span class="token punctuation">,</span> optimizer<span class="token punctuation">.</span>param_groups<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"lr"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> iteration<span class="token punctuation">,</span> batch <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>training_data_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">input</span><span class="token punctuation">,</span> target <span class="token operator">=</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>batch<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>batch<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> opt<span class="token punctuation">.</span>cuda<span class="token punctuation">:</span>
            <span class="token builtin">input</span> <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
            target <span class="token operator">=</span> target<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># print("meodel:",model(input).shape)</span>
        <span class="token comment"># print(target.shape)</span>
        loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>model<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span><span class="token punctuation">,</span> target<span class="token punctuation">)</span>
        optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
        loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
        torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>clip_grad_norm_<span class="token punctuation">(</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>opt<span class="token punctuation">.</span>clip<span class="token punctuation">)</span>
        optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> iteration<span class="token operator">%</span><span class="token number">100</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"===&gt; Epoch[{}]({}/{}): Loss: {:.10f}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>epoch<span class="token punctuation">,</span> iteration<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>training_data_loader<span class="token punctuation">)</span><span class="token punctuation">,</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">save_checkpoint</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> epoch<span class="token punctuation">)</span><span class="token punctuation">:</span>
    model_out_path <span class="token operator">=</span> <span class="token string">"checkpoint/"</span> <span class="token operator">+</span> <span class="token string">"model_epoch_{}.pth"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>epoch<span class="token punctuation">)</span>
    state <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"epoch"</span><span class="token punctuation">:</span> epoch <span class="token punctuation">,</span><span class="token string">"model"</span><span class="token punctuation">:</span> model<span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token operator">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string">"checkpoint/"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span><span class="token string">"checkpoint/"</span><span class="token punctuation">)</span>

    torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>state<span class="token punctuation">,</span> model_out_path<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Checkpoint saved to {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>model_out_path<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="evalpy_285"></a>eval.py</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> argparse<span class="token punctuation">,</span> os
<span class="token keyword">import</span> torch
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>autograd <span class="token keyword">import</span> Variable
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> time<span class="token punctuation">,</span> math<span class="token punctuation">,</span> glob
<span class="token keyword">import</span> scipy<span class="token punctuation">.</span>io <span class="token keyword">as</span> sio

parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">"PyTorch VDSR Eval"</span><span class="token punctuation">)</span>
parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--cuda"</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">"store_true"</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"use cuda?"</span><span class="token punctuation">)</span>
parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--model"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">"model/model_epoch_100.pth"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"model path"</span><span class="token punctuation">)</span>
parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--dataset"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">"Set5"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"dataset name, Default: Set5"</span><span class="token punctuation">)</span>
parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--gpus"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">"0"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"gpu ids (default: 0)"</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">PSNR</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> gt<span class="token punctuation">,</span> shave_border<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    height<span class="token punctuation">,</span> width <span class="token operator">=</span> pred<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
    pred <span class="token operator">=</span> pred<span class="token punctuation">[</span>shave_border<span class="token punctuation">:</span>height <span class="token operator">-</span> shave_border<span class="token punctuation">,</span> shave_border<span class="token punctuation">:</span>width <span class="token operator">-</span> shave_border<span class="token punctuation">]</span>
    gt <span class="token operator">=</span> gt<span class="token punctuation">[</span>shave_border<span class="token punctuation">:</span>height <span class="token operator">-</span> shave_border<span class="token punctuation">,</span> shave_border<span class="token punctuation">:</span>width <span class="token operator">-</span> shave_border<span class="token punctuation">]</span>
    imdff <span class="token operator">=</span> pred <span class="token operator">-</span> gt
    rmse <span class="token operator">=</span> math<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>imdff <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> rmse <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">100</span>
    <span class="token keyword">return</span> <span class="token number">20</span> <span class="token operator">*</span> math<span class="token punctuation">.</span>log10<span class="token punctuation">(</span><span class="token number">255.0</span> <span class="token operator">/</span> rmse<span class="token punctuation">)</span>

opt <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>
cuda <span class="token operator">=</span> opt<span class="token punctuation">.</span>cuda

<span class="token keyword">if</span> cuda<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"=&gt; use gpu id: '{}'"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>opt<span class="token punctuation">.</span>gpus<span class="token punctuation">)</span><span class="token punctuation">)</span>
    os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"CUDA_VISIBLE_DEVICES"</span><span class="token punctuation">]</span> <span class="token operator">=</span> opt<span class="token punctuation">.</span>gpus
    <span class="token keyword">if</span> <span class="token operator">not</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">"No GPU found or Wrong gpu id, please run without --cuda"</span><span class="token punctuation">)</span>

model <span class="token operator">=</span> torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>model<span class="token punctuation">,</span> map_location<span class="token operator">=</span><span class="token keyword">lambda</span> storage<span class="token punctuation">,</span> loc<span class="token punctuation">:</span> storage<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"model"</span><span class="token punctuation">]</span>

scales <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span>

image_list <span class="token operator">=</span> glob<span class="token punctuation">.</span>glob<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>dataset<span class="token operator">+</span><span class="token string">"_mat/*.*"</span><span class="token punctuation">)</span> 

<span class="token keyword">for</span> scale <span class="token keyword">in</span> scales<span class="token punctuation">:</span>
    avg_psnr_predicted <span class="token operator">=</span> <span class="token number">0.0</span>
    avg_psnr_bicubic <span class="token operator">=</span> <span class="token number">0.0</span>
    avg_elapsed_time <span class="token operator">=</span> <span class="token number">0.0</span>
    count <span class="token operator">=</span> <span class="token number">0.0</span>
    <span class="token keyword">for</span> image_name <span class="token keyword">in</span> image_list<span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">str</span><span class="token punctuation">(</span>scale<span class="token punctuation">)</span> <span class="token keyword">in</span> image_name<span class="token punctuation">:</span>
            count <span class="token operator">+=</span> <span class="token number">1</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Processing "</span><span class="token punctuation">,</span> image_name<span class="token punctuation">)</span>
            <span class="token comment"># 加载模型</span>
            im_gt_y <span class="token operator">=</span> sio<span class="token punctuation">.</span>loadmat<span class="token punctuation">(</span>image_name<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'im_gt_y'</span><span class="token punctuation">]</span>
            <span class="token comment"># 双线性插值</span>
            im_b_y <span class="token operator">=</span> sio<span class="token punctuation">.</span>loadmat<span class="token punctuation">(</span>image_name<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'im_b_y'</span><span class="token punctuation">]</span>
                       
            im_gt_y <span class="token operator">=</span> im_gt_y<span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">)</span>
            im_b_y <span class="token operator">=</span> im_b_y<span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">)</span>

            psnr_bicubic <span class="token operator">=</span> PSNR<span class="token punctuation">(</span>im_gt_y<span class="token punctuation">,</span> im_b_y<span class="token punctuation">,</span>shave_border<span class="token operator">=</span>scale<span class="token punctuation">)</span>
            avg_psnr_bicubic <span class="token operator">+=</span> psnr_bicubic


            im_input <span class="token operator">=</span> im_b_y<span class="token operator">/</span><span class="token number">255</span><span class="token punctuation">.</span>

            im_input <span class="token operator">=</span>torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>im_input<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> im_input<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> im_input<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

            <span class="token keyword">if</span> cuda<span class="token punctuation">:</span>
                model <span class="token operator">=</span> model<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
                im_input <span class="token operator">=</span> im_input<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                model <span class="token operator">=</span> model<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span>

            start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
            HR <span class="token operator">=</span> model<span class="token punctuation">(</span>im_input<span class="token punctuation">)</span>
            elapsed_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time
            avg_elapsed_time <span class="token operator">+=</span> elapsed_time

            HR <span class="token operator">=</span> HR<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span>

            im_h_y <span class="token operator">=</span> HR<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>

            im_h_y <span class="token operator">=</span> im_h_y <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">.</span>
            im_h_y<span class="token punctuation">[</span>im_h_y <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
            im_h_y<span class="token punctuation">[</span>im_h_y <span class="token operator">&gt;</span> <span class="token number">255</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">255</span><span class="token punctuation">.</span>
            im_h_y <span class="token operator">=</span> im_h_y<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span>

            psnr_predicted <span class="token operator">=</span> PSNR<span class="token punctuation">(</span>im_gt_y<span class="token punctuation">,</span> im_h_y<span class="token punctuation">,</span>shave_border<span class="token operator">=</span>scale<span class="token punctuation">)</span>
            avg_psnr_predicted <span class="token operator">+=</span> psnr_predicted

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Scale="</span><span class="token punctuation">,</span> scale<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Dataset="</span><span class="token punctuation">,</span> opt<span class="token punctuation">.</span>dataset<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"PSNR_predicted="</span><span class="token punctuation">,</span> avg_psnr_predicted<span class="token operator">/</span>count<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"PSNR_bicubic="</span><span class="token punctuation">,</span> avg_psnr_bicubic<span class="token operator">/</span>count<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"It takes average {}s for processing"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>avg_elapsed_time<span class="token operator">/</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre> 
<h4><a id="VDSR_380"></a>像素重采样的VDSR</h4> 
<ul><li> <p>原文VDSR训练时，直接将原图上采样后"高分辨率"图像加入到模型中进行计算。</p> </li><li> <p>使用训练集VOC2012，RGB图</p> </li><li> <p>训练集目录如下：</p> </li><li> <p>data存放数据假设bat_size = 1（1,3，224,224）</p> </li><li> <p>SRF_2下：target:（1,3，448,448）</p> </li><li> <p>SRF_3下：target(1,3,224<em>3,224</em>3)<br> <img src="https://images2.imgbox.com/e4/8c/6aZZwbfP_o.png" alt="在这里插入图片描述"></p> </li><li> <p>dataset.py</p> </li></ul> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">DatasetFromVoc</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>Dataset<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> file_path<span class="token operator">=</span><span class="token string">"./train"</span><span class="token punctuation">,</span>scale<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>DatasetFromVoc<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> scale<span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">:</span>
            dir_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>file_path<span class="token punctuation">,</span><span class="token string">"SRF_2"</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> scale<span class="token operator">==</span><span class="token number">3</span><span class="token punctuation">:</span>
            dir_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>file_path<span class="token punctuation">,</span><span class="token string">"SRF_3"</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            dir_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>file_path<span class="token punctuation">,</span><span class="token string">"SRF_4"</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>data_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>dir_path<span class="token punctuation">,</span><span class="token string">"data"</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>target_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>dir_path<span class="token punctuation">,</span><span class="token string">"target"</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>dataset <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> img_name <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
            img_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_path<span class="token punctuation">,</span>img_name<span class="token punctuation">)</span>
            img_target <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>target_path<span class="token punctuation">,</span>img_name<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>img_path<span class="token punctuation">,</span>img_target<span class="token punctuation">]</span><span class="token punctuation">)</span>


    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">:</span>
        img_path<span class="token punctuation">,</span>label_path <span class="token operator">=</span> self<span class="token punctuation">.</span>dataset<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
        img_data <span class="token operator">=</span> cv<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>img_path<span class="token punctuation">)</span>
        label_data <span class="token operator">=</span> cv<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>label_path<span class="token punctuation">)</span>
        <span class="token comment"># print(img_data.shape)</span>
        <span class="token comment"># print(label_data.shape)</span>
        img_data <span class="token operator">=</span> img_data<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        label_data <span class="token operator">=</span> label_data<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        img_data <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>img_data<span class="token punctuation">,</span>dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">255</span><span class="token punctuation">.</span>
        label_data <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>label_data<span class="token punctuation">,</span>dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">255</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> img_data<span class="token punctuation">,</span>label_data

    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>

        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>dataset<span class="token punctuation">)</span>

</code></pre> 
<h4><a id="vsnrpy_430"></a>vsnr.py</h4> 
<p>模型中我采取ESPCN的输出方式，采用像素混洗的方法，最后输出的时候才进行上采样，节约计算量。<br> 进一步改进：损失函数应该加入感受损失</p> 
<pre><code class="prism language-python">
<span class="token keyword">class</span> <span class="token class-name">VDSR_ESPCN</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>input_channel<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>scale<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>VDSR_ESPCN<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 残差网络</span>
        self<span class="token punctuation">.</span>residual_layer <span class="token operator">=</span> self<span class="token punctuation">.</span>make_layer<span class="token punctuation">(</span>Conv_ReLU_Block<span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span>

        <span class="token comment"># 输入</span>
        self<span class="token punctuation">.</span><span class="token builtin">input</span> <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token operator">=</span>input_channel<span class="token punctuation">,</span> out_channels<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span>  kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>output <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> out_channels<span class="token operator">=</span>input_channel<span class="token punctuation">,</span>  kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>relu <span class="token operator">=</span> nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>last_part <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>input_channel<span class="token punctuation">,</span> input_channel<span class="token operator">*</span> <span class="token punctuation">(</span>scale <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>PixelShuffle<span class="token punctuation">(</span>scale<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>init_weights<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">init_weights</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 模型初始化参数</span>
        <span class="token keyword">for</span> m <span class="token keyword">in</span> self<span class="token punctuation">.</span>modules<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">)</span><span class="token punctuation">:</span>
                n <span class="token operator">=</span> m<span class="token punctuation">.</span>kernel_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> m<span class="token punctuation">.</span>kernel_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> m<span class="token punctuation">.</span>out_channels
                m<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data<span class="token punctuation">.</span>normal_<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> sqrt<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">.</span> <span class="token operator">/</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">make_layer</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> block<span class="token punctuation">,</span> num_of_layer<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 做18层网络呀.....</span>
        layers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_of_layer<span class="token punctuation">)</span><span class="token punctuation">:</span>
            layers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>block<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span><span class="token operator">*</span>layers<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        residual <span class="token operator">=</span> x
        <span class="token comment"># 1</span>
        out <span class="token operator">=</span> self<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token builtin">input</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># 18</span>
        out <span class="token operator">=</span> self<span class="token punctuation">.</span>residual_layer<span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        <span class="token comment"># 1</span>
        out <span class="token operator">=</span> self<span class="token punctuation">.</span>output<span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        <span class="token comment"># 残差</span>
        out <span class="token operator">=</span> residual<span class="token operator">+</span>out
        <span class="token comment"># print(out.shape)</span>
        out <span class="token operator">=</span> self<span class="token punctuation">.</span>last_part<span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        <span class="token keyword">return</span> out


<span class="token keyword">class</span> <span class="token class-name">Conv_ReLU_Block</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>Conv_ReLU_Block<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>sequential <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> out_channels<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>sequential<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="trian_VDSR_ESPCNpy_494"></a>trian_VDSR_ESPCN.py</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> argparse<span class="token punctuation">,</span> os
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> random
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>backends<span class="token punctuation">.</span>cudnn <span class="token keyword">as</span> cudnn
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>optim <span class="token keyword">as</span> optim
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">import</span> DataLoader
<span class="token keyword">from</span> vdsr <span class="token keyword">import</span> VDSR_ESPCN
<span class="token keyword">from</span> dataset <span class="token keyword">import</span> DatasetFromVoc

<span class="token keyword">def</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Training settings</span>
    parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">"the VDSR of Pytorch"</span><span class="token punctuation">)</span>

    <span class="token comment"># batch_size 每次投入模型的图像数据数</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--batch_size"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Training batch size"</span><span class="token punctuation">)</span>
    <span class="token comment"># 训练轮次</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--epochs"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Number of epochs to train for"</span><span class="token punctuation">)</span>
    <span class="token comment"># 学习率</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--lr"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">float</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0.0001</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Learning Rate. Default=0.1"</span><span class="token punctuation">)</span>
    <span class="token comment"># 动态学习率调整系数</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--step"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Sets the learning rate to the initial LR decayed by momentum every n epochs, Default: n=10"</span><span class="token punctuation">)</span>
    <span class="token comment"># 使用cuda</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--cuda"</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">"store_true"</span><span class="token punctuation">,</span>default<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span><span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Use cuda?"</span><span class="token punctuation">)</span>
    <span class="token comment"># 已训练权重</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--resume"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Path to checkpoint (default: none)"</span><span class="token punctuation">)</span>
    <span class="token comment"># 开始轮次</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--start-epoch"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Manual epoch number (useful on restarts)"</span><span class="token punctuation">)</span>
    <span class="token comment"># 梯度裁剪系数</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--clip"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">float</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Clipping Gradients. Default=0.4"</span><span class="token punctuation">)</span>
    <span class="token comment"># 单线程</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--num_workers"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Number of threads for data loader to use, Default: 1"</span><span class="token punctuation">)</span>
    <span class="token comment"># 优化器动量</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--momentum"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">float</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Momentum, Default: 0.9"</span><span class="token punctuation">)</span>
    <span class="token comment"># 正则化系数</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--weight-decay"</span><span class="token punctuation">,</span> <span class="token string">"--wd"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">float</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Weight decay, Default: 1e-4"</span><span class="token punctuation">)</span>
    <span class="token comment">#  预训练a</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--pretrained'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'path to pretrained model (default: none)'</span><span class="token punctuation">)</span>
    <span class="token comment"># 默认GPU为0</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--gpus"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">"0"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"gpu ids (default: 0)"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> parser

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    parser <span class="token operator">=</span> init<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 获得所有参数</span>
    opt <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>opt<span class="token punctuation">)</span>
    <span class="token comment"># cuda设置gpu参数</span>
    cuda <span class="token operator">=</span> opt<span class="token punctuation">.</span>cuda

    <span class="token comment"># gpu配置</span>
    <span class="token keyword">if</span> cuda<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"=&gt; use gpu id: '{}'"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>opt<span class="token punctuation">.</span>gpus<span class="token punctuation">)</span><span class="token punctuation">)</span>
        os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"CUDA_VISIBLE_DEVICES"</span><span class="token punctuation">]</span> <span class="token operator">=</span> opt<span class="token punctuation">.</span>gpus
        <span class="token keyword">if</span> <span class="token operator">not</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">"No GPU found or Wrong gpu id, please run without --cuda"</span><span class="token punctuation">)</span>
    <span class="token comment"># 随机种子参数</span>
    opt<span class="token punctuation">.</span>seed <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Random Seed: "</span><span class="token punctuation">,</span> opt<span class="token punctuation">.</span>seed<span class="token punctuation">)</span>
    torch<span class="token punctuation">.</span>manual_seed<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>seed<span class="token punctuation">)</span>

    <span class="token keyword">if</span> cuda<span class="token punctuation">:</span>
        <span class="token comment"># 设置固定生成随机数的种子，使得每次运行该.py</span>
        <span class="token comment"># 文件时生成的随机数相同</span>
        torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>manual_seed<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>seed<span class="token punctuation">)</span>

    <span class="token comment"># 设置加速，优化运行效率</span>
    cudnn<span class="token punctuation">.</span>benchmark <span class="token operator">=</span> <span class="token boolean">True</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"===&gt; Loading datasets"</span><span class="token punctuation">)</span>
    train_set <span class="token operator">=</span> DatasetFromVoc<span class="token punctuation">(</span>scale<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>

    <span class="token comment"># training_data_loader = DataLoader(dataset=train_set,num_workers=opt.num_workers, batch_size=opt.batch_size, shuffle=True)</span>
    training_data_loader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>dataset<span class="token operator">=</span>train_set<span class="token punctuation">,</span> batch_size<span class="token operator">=</span>opt<span class="token punctuation">.</span>batch_size<span class="token punctuation">,</span>
                                      shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"===&gt; Building model"</span><span class="token punctuation">)</span>
    model <span class="token operator">=</span> VDSR_ESPCN<span class="token punctuation">(</span>scale<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>input_channel<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>


    criterion <span class="token operator">=</span> nn<span class="token punctuation">.</span>MSELoss<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"===&gt; Setting GPU"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> cuda<span class="token punctuation">:</span>
        model <span class="token operator">=</span> model<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
        criterion <span class="token operator">=</span> criterion<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># optionally resume from a checkpoint</span>
    <span class="token keyword">if</span> opt<span class="token punctuation">.</span>resume<span class="token punctuation">:</span>
        <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isfile<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>resume<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"=&gt; loading checkpoint '{}'"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>opt<span class="token punctuation">.</span>resume<span class="token punctuation">)</span><span class="token punctuation">)</span>
            checkpoint <span class="token operator">=</span> torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>resume<span class="token punctuation">)</span>
            opt<span class="token punctuation">.</span>start_epoch <span class="token operator">=</span> checkpoint<span class="token punctuation">[</span><span class="token string">"epoch"</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span>
            model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>checkpoint<span class="token punctuation">[</span><span class="token string">"model"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"=&gt; no checkpoint found at '{}'"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>opt<span class="token punctuation">.</span>resume<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># optionally copy weights from a checkpoint</span>
    <span class="token keyword">if</span> opt<span class="token punctuation">.</span>pretrained<span class="token punctuation">:</span>

        <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isfile<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>pretrained<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"=&gt; loading model '{}'"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>opt<span class="token punctuation">.</span>pretrained<span class="token punctuation">)</span><span class="token punctuation">)</span>
            weights <span class="token operator">=</span> torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>pretrained<span class="token punctuation">)</span>
            model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>weights<span class="token punctuation">[</span><span class="token string">'model'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"=&gt; no model found at '{}'"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>opt<span class="token punctuation">.</span>pretrained<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"===&gt; Setting Optimizer"</span><span class="token punctuation">)</span>

    optimizer <span class="token operator">=</span> optim<span class="token punctuation">.</span>SGD<span class="token punctuation">(</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>opt<span class="token punctuation">.</span>lr<span class="token punctuation">,</span> momentum<span class="token operator">=</span>opt<span class="token punctuation">.</span>momentum<span class="token punctuation">,</span> weight_decay<span class="token operator">=</span>opt<span class="token punctuation">.</span>weight_decay<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"===&gt; Training"</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>opt<span class="token punctuation">.</span>start_epoch<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>epochs <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        train<span class="token punctuation">(</span>opt<span class="token punctuation">,</span>training_data_loader<span class="token punctuation">,</span> optimizer<span class="token punctuation">,</span> model<span class="token punctuation">,</span> criterion<span class="token punctuation">,</span> epoch<span class="token punctuation">)</span>
        save_checkpoint<span class="token punctuation">(</span>model<span class="token punctuation">,</span> epoch<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">adjust_learning_rate</span><span class="token punctuation">(</span>opt<span class="token punctuation">,</span> epoch<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Sets the learning rate to the initial LR decayed by 10 every 10 epochs"""</span>
    lr <span class="token operator">=</span> opt<span class="token punctuation">.</span>lr <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0.1</span> <span class="token operator">**</span> <span class="token punctuation">(</span>epoch <span class="token operator">//</span>opt<span class="token punctuation">.</span>step<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> lr

<span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>opt<span class="token punctuation">,</span>training_data_loader<span class="token punctuation">,</span> optimizer<span class="token punctuation">,</span> model<span class="token punctuation">,</span> criterion<span class="token punctuation">,</span> epoch<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># lr = adjust_learning_rate(opt, epoch-1)</span>
    lr <span class="token operator">=</span> opt<span class="token punctuation">.</span>lr
    <span class="token keyword">for</span> param_group <span class="token keyword">in</span> optimizer<span class="token punctuation">.</span>param_groups<span class="token punctuation">:</span>
        param_group<span class="token punctuation">[</span><span class="token string">"lr"</span><span class="token punctuation">]</span> <span class="token operator">=</span> lr

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Epoch = {}, lr = {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>epoch<span class="token punctuation">,</span> optimizer<span class="token punctuation">.</span>param_groups<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"lr"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> iteration<span class="token punctuation">,</span> batch <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>training_data_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">input</span><span class="token punctuation">,</span> target <span class="token operator">=</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>batch<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>batch<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> opt<span class="token punctuation">.</span>cuda<span class="token punctuation">:</span>
            <span class="token builtin">input</span> <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
            target <span class="token operator">=</span> target<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># print("meodel:",model(input).shape)</span>
        <span class="token comment"># print(target.shape)</span>
        loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>model<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span><span class="token punctuation">,</span> target<span class="token punctuation">)</span>
        optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
        loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
        torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>clip_grad_norm_<span class="token punctuation">(</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>opt<span class="token punctuation">.</span>clip<span class="token punctuation">)</span>
        optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> iteration<span class="token operator">%</span><span class="token number">100</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"===&gt; Epoch[{}]({}/{}): Loss: {:.10f}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>epoch<span class="token punctuation">,</span> iteration<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>training_data_loader<span class="token punctuation">)</span><span class="token punctuation">,</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">save_checkpoint</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> epoch<span class="token punctuation">)</span><span class="token punctuation">:</span>
    model_out_path <span class="token operator">=</span> <span class="token string">"checkpoint_vdsrespcn/"</span> <span class="token operator">+</span> <span class="token string">"model_epoch_{}.pth"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>epoch<span class="token punctuation">)</span>
    state <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"epoch"</span><span class="token punctuation">:</span> epoch <span class="token punctuation">,</span><span class="token string">"model"</span><span class="token punctuation">:</span> model<span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token operator">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string">"checkpoint_vdsrespcn/"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span><span class="token string">"checkpoint_vdsrespcn/"</span><span class="token punctuation">)</span>

    torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>state<span class="token punctuation">,</span> model_out_path<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Checkpoint saved to {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>model_out_path<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>


</code></pre> 
<p>训练比较久…<br> <img src="https://images2.imgbox.com/a9/79/EKL1nu2o_o.png" alt="!](https://img-blog.csdnimg.cn/20210525165057668.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjkxNzM1Mg==,size_16,color_FFFFFF,t_70)"></p> 
<ul><li>以上我自己的改写，具体测试还在进行汇总，关于单通道的图片PSNR达到27.65</li><li>小伙伴们有问题欢迎加微信一起解决哦</li><li><img src="https://images2.imgbox.com/8e/1f/441Jfkxy_o.png" alt="在这里插入图片描述"></li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a9171a74b23e8d6d2317e9e9c227713d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">android9.0后台检查,Notes: Android上检测应用是否被调到了后台/前台</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0e9ef87c96877bc7c61a9360d7259386/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Ajax笔记</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>