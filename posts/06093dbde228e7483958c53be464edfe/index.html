<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>C&#43;&#43;分割路径和文件名 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="C&#43;&#43;分割路径和文件名" />
<meta property="og:description" content="C&#43;&#43;基础功能：将文件路径进行分割，分别获取文件所在的文件夹名称、文件名称、以及文件扩展名
拓展：判断文件路径所在的文件夹是否存在，若不存在则创建文件夹
参考了简书上 1037号森林里一段干木头 的文章，在此附上链接并致谢！
Reference: https://www.jianshu.com/p/fadc2b4cba25
————————————————————————————————————————————
一. 分别获取文件所在的文件夹名称、文件名称、以及文件扩展名
代码：
#include &lt;iostream&gt; using namespace std; int main() { std::string path = &#34;D:\\mydoc\\VS-proj\\SMTDetector\\x64\\Release\\0001.bmp&#34;; int index = path.find_last_of(&#34;\\&#34;); Get folderpath std::string folderPath = path.substr(0, index); //Get filename with extension std::string filename = path.substr(index&#43;1, -1); //get extension of the file int index2 = path.find_last_of(&#34;.&#34;); std::string extendName = path.substr(index2 &#43; 1, -1); std::cout &lt;&lt; &#34;path:\t&#34; &lt;&lt; path &lt;&lt; std::endl; std::cout &lt;&lt; &#34;folderPath:\t&#34; &lt;&lt; folderPath &lt;&lt; std::endl; std::cout &lt;&lt; &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/06093dbde228e7483958c53be464edfe/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-24T15:30:01+08:00" />
<meta property="article:modified_time" content="2022-05-24T15:30:01+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">C&#43;&#43;分割路径和文件名</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>C++基础功能：将文件路径进行分割，分别获取文件所在的文件夹名称、文件名称、以及文件扩展名</p> 
<p>拓展：判断文件路径所在的文件夹是否存在，若不存在则创建文件夹</p> 
<p>参考了简书上 <strong>1037号森林里一段干木头</strong> 的文章，在此附上链接并致谢！<br> Reference: <a href="https://www.jianshu.com/p/fadc2b4cba25" rel="nofollow">https://www.jianshu.com/p/fadc2b4cba25</a><br> ————————————————————————————————————————————</p> 
<p><strong>一. 分别获取文件所在的文件夹名称、文件名称、以及文件扩展名</strong></p> 
<p>代码：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>string path <span class="token operator">=</span> <span class="token string">"D:\\mydoc\\VS-proj\\SMTDetector\\x64\\Release\\0001.bmp"</span><span class="token punctuation">;</span>
    
    <span class="token keyword">int</span> index <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">find_last_of</span><span class="token punctuation">(</span><span class="token string">"\\"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">Get folderpath </span>
    std<span class="token double-colon punctuation">::</span>string folderPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//Get filename with extension</span>
    std<span class="token double-colon punctuation">::</span>string filename <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span>index<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//get extension of the file</span>
    <span class="token keyword">int</span> index2 <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">find_last_of</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>string extendName <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span>index2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"path:\t"</span> <span class="token operator">&lt;&lt;</span> path <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"folderPath:\t"</span> <span class="token operator">&lt;&lt;</span> folderPath <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"filename:\t"</span> <span class="token operator">&lt;&lt;</span> filename <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"extendName:\t"</span> <span class="token operator">&lt;&lt;</span> extendName <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>

     <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre> 
<p>output:<br> <img src="https://images2.imgbox.com/fe/cb/8AXRJxEz_o.png" alt="在这里插入图片描述"><br> ————————————————————————————————————————————</p> 
<p>方法二：直接利用c++的——splitpath()函数实现获取盘符，路径，文件名以及带“.”的扩展名。<br> 参考 <a href="https://blog.csdn.net/jiratao/article/details/9764679">C/C++解析文件路径，获取盘符、路径、文件名及扩展名</a></p> 
<pre><code class="prism language-cpp"><span class="token comment">C++解析路径，获取盘符，路径，文件名以及扩展名</span>

<span class="token comment">//API:</span>

<span class="token comment">//void _splitpath(const char* path, char* drive, char* dir, char* fname, char* ext);</span>
<span class="token comment">//</span>
<span class="token comment">//void _wsplitpath(const wchar_t* path, wchar_t* drive, wchar_t* dir, wchar_t* fname, wchar_t* ext);</span>

<span class="token comment">其中，各个参数：</span>
<span class="token comment">// </span>
<span class="token comment">path：全路径（IN）</span>
<span class="token comment"></span>
<span class="token comment">drive：盘符（OUT）</span>
<span class="token comment"></span>
<span class="token comment">dir：除去盘符和文件名，中间的那段路径（OUT）</span>
<span class="token comment"></span>
<span class="token comment">fname：文件名，不包含扩展名（OUT）</span>
<span class="token comment"></span>
<span class="token comment">ext：文件扩展名，包含那个点.（OUT）</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span> <span class="token comment">//_makepath()  _splitpath()</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span> <span class="token comment">//printf()</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CHAR_SIZE</span> <span class="token expression"><span class="token number">1024</span></span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span> path_buffer<span class="token punctuation">[</span>CHAR_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> drive<span class="token punctuation">[</span>CHAR_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> dir<span class="token punctuation">[</span>CHAR_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> filename<span class="token punctuation">[</span>CHAR_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> ext<span class="token punctuation">[</span>CHAR_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token function">_makepath_s</span><span class="token punctuation">(</span>path_buffer<span class="token punctuation">,</span><span class="token string">"d"</span><span class="token punctuation">,</span><span class="token string">"/pathTest/aa/"</span><span class="token punctuation">,</span><span class="token string">"test"</span><span class="token punctuation">,</span><span class="token string">"txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Path created with __makepath: %s\n"</span><span class="token punctuation">,</span> path_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">_splitpath_s</span><span class="token punctuation">(</span>path_buffer<span class="token punctuation">,</span> drive<span class="token punctuation">,</span> dir<span class="token punctuation">,</span> filename<span class="token punctuation">,</span> ext<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Path splited:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"  Drive: %s\n"</span><span class="token punctuation">,</span> drive<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"  Dir: %s\n"</span><span class="token punctuation">,</span> dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"  Filename: %s\n"</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"  Ext: %s\n"</span><span class="token punctuation">,</span> ext<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>output:<br> <img src="https://images2.imgbox.com/0c/4f/WSs2PW6L_o.png" alt="在这里插入图片描述"></p> 
<p><strong>二.</strong> <strong>拓展：检测文件所在的文件夹是否存在，如果不存在创建文件夹</strong></p> 
<p>如上述所列的文件路径:</p> 
<pre><code class="prism language-cpp">std<span class="token double-colon punctuation">::</span>string path <span class="token operator">=</span> <span class="token string">"D:\\mydoc\\VS-proj\\SMTDetector\\x64\\Release\\0001.bmp"</span><span class="token punctuation">;</span>
</code></pre> 
<p>以下代码实现检测 D:\mydoc\VS-proj\SMTDetector\x64\Release 路径是否存在，如果不存在则创建这一路径。</p> 
<p>代码：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"dirent.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;direct.h&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std

<span class="token comment">To check whether the folder of the file_full_path exists,if not,make the folder.</span>
<span class="token keyword">int</span> <span class="token function">DirExistCheck</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> path<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//Get folder name </span>
    std<span class="token double-colon punctuation">::</span>string folderPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">find_last_of</span><span class="token punctuation">(</span><span class="token string">"\\"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"folderPath: "</span> <span class="token operator">&lt;&lt;</span> folderPath <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    DIR<span class="token operator">*</span> filepath <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>filepath <span class="token operator">=</span> <span class="token function">opendir</span><span class="token punctuation">(</span>folderPath<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> 
    <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"filepath not exist!"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">_mkdir</span><span class="token punctuation">(</span>folderPath<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ret= 0 create successful，ret= -1 failed</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"filepath successful created!"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"filepath exists!"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">std::string path = "D:\\mydoc\\VS-proj\\SMTDetector\\x64\\Release\\0001.bmp";</span>
    std<span class="token double-colon punctuation">::</span>string path <span class="token operator">=</span> <span class="token raw-string string">R"(D:\11\0001.bmp)"</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"path: "</span> <span class="token operator">&lt;&lt;</span> path <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

    <span class="token keyword">int</span> index <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">find_last_of</span><span class="token punctuation">(</span><span class="token string">"\\"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">Get folderpath </span>
    std<span class="token double-colon punctuation">::</span>string folderPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">DirExistCheck</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>此处用到了第三方库dirent，是需要头文件dirent.h，对于windows用户，获取方法有：</p> 
<ol><li>自己github下载源码，<a href="https://github.com/tronkko/dirent">dirent源码链接：</a>，然后cmake编译之后，将编译后的dirent.h所在的路径<br> $dirent_src_path/build/install/include 添加到上述代码的工程的附加包含目录中</li></ol> 
<hr> 
<ol start="2"><li>直接用上面原作者的，<a href="https://github.com/tronkko/dirent">dirent源码链接：</a>，其实作者已经编译好了，下载github工程后，直接去<br> /include/direct.h中就可以找到，哈哈哈哈哈哈</li></ol> 
<hr> 
<ol start="3"><li>也可以直接复制下面的代码到工程中创建头文件dirent.h，本人自己用源码编译的（VS2019，应该是可以向下兼容），一千多行，放在本文最后附录吧，哈哈哈哈哈哈哈哈哈哈。</li></ol> 
<hr> 
<p>对于linux用户，不用这么麻烦，因为dirent.h就是系统下的一个头文件，在目录/usr/include下，所以直接在代码中大胆#include &lt;dirent.h&gt;吧。</p> 
<p>————————————————————————————————————————————</p> 
<p><strong>三. 扩展：dirent库的介绍及使用</strong></p> 
<p>介绍：</p> 
<p>Dirent is a C/C++ programming interface that allows programmers to retrieve information about files and directories under Linux/UNIX. This project provides Linux compatible Dirent interface for Microsoft Windows.</p> 
<p>dirent结构体及函数：<a href="https://blog.csdn.net/wangshubo1989/article/details/52994327">dirent–文件以及文件夹相关操作(跨平台)</a></p> 
<p>————————————————————————————————————————————<br> <strong>四. 附录：</strong><br> dirent.h源码：</p> 
<pre><code class="prism language-cpp"><span class="token comment">/*
 * Dirent interface for Microsoft Visual Studio
 *
 * Copyright (C) 1998-2019 Toni Ronkko
 * This file is part of dirent.  Dirent may be freely distributed
 * under the MIT license.  For all details and documentation, see
 * https://github.com/tronkko/dirent
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">DIRENT_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DIRENT_H</span></span>

<span class="token comment">/* Hide warnings about unreferenced local functions */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__clang__<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">clang diagnostic ignored </span><span class="token string">"-Wunused-function"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>_MSC_VER<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">warning</span><span class="token punctuation">(</span>disable <span class="token operator">:</span> <span class="token number">4505</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__GNUC__<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">GCC diagnostic ignored </span><span class="token string">"-Wunused-function"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/*
 * Include windows.h without Windows Sockets 1.1 to prevent conflicts with
 * Windows Sockets 2.0.
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">WIN32_LEAN_AND_MEAN</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">WIN32_LEAN_AND_MEAN</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;windows.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdarg.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;wchar.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;malloc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>

<span class="token comment">/* Indicates that d_type field is available in dirent structure */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_DIRENT_HAVE_D_TYPE</span></span>

<span class="token comment">/* Indicates that d_namlen field is available in dirent structure */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_DIRENT_HAVE_D_NAMLEN</span></span>

<span class="token comment">/* Entries missing from MSVC 6.0 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>FILE_ATTRIBUTE_DEVICE<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FILE_ATTRIBUTE_DEVICE</span> <span class="token expression"><span class="token number">0x40</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/* File type and permission flags for stat(), general mask */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>S_IFMT<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">S_IFMT</span> <span class="token expression">_S_IFMT</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/* Directory bit */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>S_IFDIR<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">S_IFDIR</span> <span class="token expression">_S_IFDIR</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/* Character device bit */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>S_IFCHR<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">S_IFCHR</span> <span class="token expression">_S_IFCHR</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/* Pipe bit */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>S_IFFIFO<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">S_IFFIFO</span> <span class="token expression">_S_IFFIFO</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/* Regular file bit */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>S_IFREG<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">S_IFREG</span> <span class="token expression">_S_IFREG</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/* Read permission */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>S_IREAD<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">S_IREAD</span> <span class="token expression">_S_IREAD</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/* Write permission */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>S_IWRITE<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">S_IWRITE</span> <span class="token expression">_S_IWRITE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/* Execute permission */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>S_IEXEC<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">S_IEXEC</span> <span class="token expression">_S_IEXEC</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/* Pipe */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>S_IFIFO<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">S_IFIFO</span> <span class="token expression">_S_IFIFO</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/* Block device */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>S_IFBLK<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">S_IFBLK</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/* Link */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>S_IFLNK<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">S_IFLNK</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/* Socket */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>S_IFSOCK<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">S_IFSOCK</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/* Read user permission */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>S_IRUSR<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">S_IRUSR</span> <span class="token expression">S_IREAD</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/* Write user permission */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>S_IWUSR<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">S_IWUSR</span> <span class="token expression">S_IWRITE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/* Execute user permission */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>S_IXUSR<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">S_IXUSR</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/* Read group permission */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>S_IRGRP<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">S_IRGRP</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/* Write group permission */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>S_IWGRP<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">S_IWGRP</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/* Execute group permission */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>S_IXGRP<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">S_IXGRP</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/* Read others permission */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>S_IROTH<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">S_IROTH</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/* Write others permission */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>S_IWOTH<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">S_IWOTH</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/* Execute others permission */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>S_IXOTH<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">S_IXOTH</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/* Maximum length of file name */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>PATH_MAX<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PATH_MAX</span> <span class="token expression">MAX_PATH</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>FILENAME_MAX<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FILENAME_MAX</span> <span class="token expression">MAX_PATH</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>NAME_MAX<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NAME_MAX</span> <span class="token expression">FILENAME_MAX</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/* File type flags for d_type */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DT_UNKNOWN</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DT_REG</span> <span class="token expression">S_IFREG</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DT_DIR</span> <span class="token expression">S_IFDIR</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DT_FIFO</span> <span class="token expression">S_IFIFO</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DT_SOCK</span> <span class="token expression">S_IFSOCK</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DT_CHR</span> <span class="token expression">S_IFCHR</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DT_BLK</span> <span class="token expression">S_IFBLK</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DT_LNK</span> <span class="token expression">S_IFLNK</span></span>

<span class="token comment">/* Macros for converting between st_mode and d_type */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">IFTODT</span><span class="token expression"><span class="token punctuation">(</span>mode<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span><span class="token operator">&amp;</span>S_IFMT<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">DTTOIF</span><span class="token expression"><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span></span></span>

<span class="token comment">/*
 * File type macros.  Note that block devices, sockets and links cannot be
 * distinguished on Windows and the macros S_ISBLK, S_ISSOCK and S_ISLNK are
 * only defined for compatibility.  These macros should always return false
 * on Windows.
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>S_ISFIFO<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">S_ISFIFO</span><span class="token expression"><span class="token punctuation">(</span>mode<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span><span class="token operator">&amp;</span>S_IFMT<span class="token punctuation">)</span> <span class="token operator">==</span> S_IFIFO<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>S_ISDIR<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">S_ISDIR</span><span class="token expression"><span class="token punctuation">(</span>mode<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span><span class="token operator">&amp;</span>S_IFMT<span class="token punctuation">)</span> <span class="token operator">==</span> S_IFDIR<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>S_ISREG<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">S_ISREG</span><span class="token expression"><span class="token punctuation">(</span>mode<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span><span class="token operator">&amp;</span>S_IFMT<span class="token punctuation">)</span> <span class="token operator">==</span> S_IFREG<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>S_ISLNK<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">S_ISLNK</span><span class="token expression"><span class="token punctuation">(</span>mode<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span><span class="token operator">&amp;</span>S_IFMT<span class="token punctuation">)</span> <span class="token operator">==</span> S_IFLNK<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>S_ISSOCK<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">S_ISSOCK</span><span class="token expression"><span class="token punctuation">(</span>mode<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span><span class="token operator">&amp;</span>S_IFMT<span class="token punctuation">)</span> <span class="token operator">==</span> S_IFSOCK<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>S_ISCHR<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">S_ISCHR</span><span class="token expression"><span class="token punctuation">(</span>mode<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span><span class="token operator">&amp;</span>S_IFMT<span class="token punctuation">)</span> <span class="token operator">==</span> S_IFCHR<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>S_ISBLK<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">S_ISBLK</span><span class="token expression"><span class="token punctuation">(</span>mode<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span><span class="token operator">&amp;</span>S_IFMT<span class="token punctuation">)</span> <span class="token operator">==</span> S_IFBLK<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/* Return the exact length of the file name without zero terminator */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">_D_EXACT_NAMLEN</span><span class="token expression"><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token operator">-&gt;</span>d_namlen<span class="token punctuation">)</span></span></span>

<span class="token comment">/* Return the maximum size of a file name */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">_D_ALLOC_NAMLEN</span><span class="token expression"><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>PATH_MAX<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__cplusplus</span></span>
<span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/* Wide-character version */</span>
<span class="token keyword">struct</span> <span class="token class-name">_wdirent</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* Always zero */</span>
    <span class="token keyword">long</span> d_ino<span class="token punctuation">;</span>

    <span class="token comment">/* File position within stream */</span>
    <span class="token keyword">long</span> d_off<span class="token punctuation">;</span>

    <span class="token comment">/* Structure size */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> d_reclen<span class="token punctuation">;</span>

    <span class="token comment">/* Length of name without \0 */</span>
    size_t d_namlen<span class="token punctuation">;</span>

    <span class="token comment">/* File type */</span>
    <span class="token keyword">int</span> d_type<span class="token punctuation">;</span>

    <span class="token comment">/* File name */</span>
    <span class="token keyword">wchar_t</span> d_name<span class="token punctuation">[</span>PATH_MAX <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_wdirent</span> _wdirent<span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">_WDIR</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* Current directory entry */</span>
    <span class="token keyword">struct</span> <span class="token class-name">_wdirent</span> ent<span class="token punctuation">;</span>

    <span class="token comment">/* Private file data */</span>
    WIN32_FIND_DATAW data<span class="token punctuation">;</span>

    <span class="token comment">/* True if data is valid */</span>
    <span class="token keyword">int</span> cached<span class="token punctuation">;</span>

    <span class="token comment">/* Win32 search handle */</span>
    HANDLE handle<span class="token punctuation">;</span>

    <span class="token comment">/* Initial directory name */</span>
    <span class="token keyword">wchar_t</span><span class="token operator">*</span> patt<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_WDIR</span> _WDIR<span class="token punctuation">;</span>

<span class="token comment">/* Multi-byte character version */</span>
<span class="token keyword">struct</span> <span class="token class-name">dirent</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* Always zero */</span>
    <span class="token keyword">long</span> d_ino<span class="token punctuation">;</span>

    <span class="token comment">/* File position within stream */</span>
    <span class="token keyword">long</span> d_off<span class="token punctuation">;</span>

    <span class="token comment">/* Structure size */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> d_reclen<span class="token punctuation">;</span>

    <span class="token comment">/* Length of name without \0 */</span>
    size_t d_namlen<span class="token punctuation">;</span>

    <span class="token comment">/* File type */</span>
    <span class="token keyword">int</span> d_type<span class="token punctuation">;</span>

    <span class="token comment">/* File name */</span>
    <span class="token keyword">char</span> d_name<span class="token punctuation">[</span>PATH_MAX <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">dirent</span> dirent<span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">DIR</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">dirent</span> ent<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">_WDIR</span><span class="token operator">*</span> wdirp<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">DIR</span> DIR<span class="token punctuation">;</span>

<span class="token comment">/* Dirent functions */</span>
<span class="token keyword">static</span> DIR<span class="token operator">*</span>   <span class="token function">opendir</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> dirname<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> _WDIR<span class="token operator">*</span> <span class="token function">_wopendir</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">wchar_t</span><span class="token operator">*</span> dirname<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">dirent</span><span class="token operator">*</span>   <span class="token function">readdir</span><span class="token punctuation">(</span>DIR<span class="token operator">*</span> dirp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">_wdirent</span><span class="token operator">*</span> <span class="token function">_wreaddir</span><span class="token punctuation">(</span>_WDIR<span class="token operator">*</span> dirp<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">readdir_r</span><span class="token punctuation">(</span>DIR<span class="token operator">*</span> dirp<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">dirent</span><span class="token operator">*</span> entry<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">dirent</span><span class="token operator">*</span><span class="token operator">*</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">_wreaddir_r</span><span class="token punctuation">(</span>_WDIR<span class="token operator">*</span> dirp<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">_wdirent</span><span class="token operator">*</span> entry<span class="token punctuation">,</span>
                       <span class="token keyword">struct</span> <span class="token class-name">_wdirent</span><span class="token operator">*</span><span class="token operator">*</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">closedir</span><span class="token punctuation">(</span>DIR<span class="token operator">*</span> dirp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">_wclosedir</span><span class="token punctuation">(</span>_WDIR<span class="token operator">*</span> dirp<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">rewinddir</span><span class="token punctuation">(</span>DIR<span class="token operator">*</span> dirp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">_wrewinddir</span><span class="token punctuation">(</span>_WDIR<span class="token operator">*</span> dirp<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">scandir</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> dirname<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">dirent</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> namelist<span class="token punctuation">,</span>
                   <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>filter<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">dirent</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                   <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>compare<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">dirent</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">,</span>
                                  <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">dirent</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">alphasort</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">dirent</span><span class="token operator">*</span><span class="token operator">*</span> a<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">dirent</span><span class="token operator">*</span><span class="token operator">*</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">versionsort</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">dirent</span><span class="token operator">*</span><span class="token operator">*</span> a<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">dirent</span><span class="token operator">*</span><span class="token operator">*</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* For compatibility with Symbian */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">wdirent</span> <span class="token expression">_wdirent</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">WDIR</span> <span class="token expression">_WDIR</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">wopendir</span> <span class="token expression">_wopendir</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">wreaddir</span> <span class="token expression">_wreaddir</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">wclosedir</span> <span class="token expression">_wclosedir</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">wrewinddir</span> <span class="token expression">_wrewinddir</span></span>

<span class="token comment">/* Internal utility functions */</span>
<span class="token keyword">static</span> WIN32_FIND_DATAW<span class="token operator">*</span> <span class="token function">dirent_first</span><span class="token punctuation">(</span>_WDIR<span class="token operator">*</span> dirp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> WIN32_FIND_DATAW<span class="token operator">*</span> <span class="token function">dirent_next</span><span class="token punctuation">(</span>_WDIR<span class="token operator">*</span> dirp<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">dirent_mbstowcs_s</span><span class="token punctuation">(</span>size_t<span class="token operator">*</span> pReturnValue<span class="token punctuation">,</span> <span class="token keyword">wchar_t</span><span class="token operator">*</span> wcstr<span class="token punctuation">,</span>
                             size_t sizeInWords<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> mbstr<span class="token punctuation">,</span>
                             size_t count<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">dirent_wcstombs_s</span><span class="token punctuation">(</span>size_t<span class="token operator">*</span> pReturnValue<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> mbstr<span class="token punctuation">,</span>
                             size_t sizeInBytes<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">wchar_t</span><span class="token operator">*</span> wcstr<span class="token punctuation">,</span>
                             size_t count<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">dirent_set_errno</span><span class="token punctuation">(</span><span class="token keyword">int</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * Open directory stream DIRNAME for read and return a pointer to the
 * internal working area that is used to retrieve individual directory
 * entries.
 */</span>
<span class="token keyword">static</span> _WDIR<span class="token operator">*</span> <span class="token function">_wopendir</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">wchar_t</span><span class="token operator">*</span> dirname<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    _WDIR<span class="token operator">*</span> dirp<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">WINAPI_FAMILY_PARTITION</span><span class="token punctuation">(</span>WINAPI_PARTITION_DESKTOP<span class="token punctuation">)</span></span></span>
    <span class="token comment">/* Desktop */</span>
    DWORD n<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    <span class="token comment">/* WinRT */</span>
    size_t n<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token keyword">wchar_t</span><span class="token operator">*</span> p<span class="token punctuation">;</span>

    <span class="token comment">/* Must have directory name */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dirname <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> dirname<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'\0'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">dirent_set_errno</span><span class="token punctuation">(</span>ENOENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* Allocate new _WDIR structure */</span>
    dirp <span class="token operator">=</span> <span class="token punctuation">(</span>_WDIR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">_WDIR</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dirp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token comment">/* Reset _WDIR structure */</span>
    dirp<span class="token operator">-&gt;</span>handle <span class="token operator">=</span> INVALID_HANDLE_VALUE<span class="token punctuation">;</span>
    dirp<span class="token operator">-&gt;</span>patt   <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    dirp<span class="token operator">-&gt;</span>cached <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">/*
     * Compute the length of full path plus zero terminator
     *
     * Note that on WinRT there's no way to convert relative paths
     * into absolute paths, so just assume it is an absolute path.
     */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">WINAPI_FAMILY_PARTITION</span><span class="token punctuation">(</span>WINAPI_PARTITION_DESKTOP<span class="token punctuation">)</span></span></span>
    <span class="token comment">/* Desktop */</span>
    n <span class="token operator">=</span> <span class="token function">GetFullPathNameW</span><span class="token punctuation">(</span>dirname<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    <span class="token comment">/* WinRT */</span>
    n <span class="token operator">=</span> <span class="token function">wcslen</span><span class="token punctuation">(</span>dirname<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    <span class="token comment">/* Allocate room for absolute directory name and search pattern */</span>
    dirp<span class="token operator">-&gt;</span>patt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">wchar_t</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">wchar_t</span><span class="token punctuation">)</span> <span class="token operator">*</span> n <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dirp<span class="token operator">-&gt;</span>patt <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">goto</span> exit_closedir<span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token comment">/*
     * Convert relative directory name to an absolute one.  This
     * allows rewinddir() to function correctly even when current
     * working directory is changed between opendir() and rewinddir().
     *
     * Note that on WinRT there's no way to convert relative paths
     * into absolute paths, so just assume it is an absolute path.
     */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">WINAPI_FAMILY_PARTITION</span><span class="token punctuation">(</span>WINAPI_PARTITION_DESKTOP<span class="token punctuation">)</span></span></span>
    <span class="token comment">/* Desktop */</span>
    n <span class="token operator">=</span> <span class="token function">GetFullPathNameW</span><span class="token punctuation">(</span>dirname<span class="token punctuation">,</span> n<span class="token punctuation">,</span> dirp<span class="token operator">-&gt;</span>patt<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">goto</span> exit_closedir<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    <span class="token comment">/* WinRT */</span>
    <span class="token function">wcsncpy_s</span><span class="token punctuation">(</span>dirp<span class="token operator">-&gt;</span>patt<span class="token punctuation">,</span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> dirname<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    <span class="token comment">/* Append search pattern \* to the directory name */</span>
    p <span class="token operator">=</span> dirp<span class="token operator">-&gt;</span>patt <span class="token operator">+</span> n<span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> <span class="token char">'\\'</span><span class="token operator">:</span>
        <span class="token keyword">case</span> <span class="token char">'/'</span><span class="token operator">:</span>
        <span class="token keyword">case</span> <span class="token char">':'</span><span class="token operator">:</span>
            <span class="token comment">/* Directory ends in path separator, e.g. c:\temp\ */</span>
            <span class="token comment">/*NOP*/</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token comment">/* Directory name doesn't end in path separator */</span>
            <span class="token operator">*</span>p<span class="token operator">++</span> <span class="token operator">=</span> <span class="token char">'\\'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">*</span>p<span class="token operator">++</span> <span class="token operator">=</span> <span class="token char">'*'</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>p   <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>

    <span class="token comment">/* Open directory stream and retrieve the first entry */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">dirent_first</span><span class="token punctuation">(</span>dirp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">goto</span> exit_closedir<span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token comment">/* Success */</span>
    <span class="token keyword">return</span> dirp<span class="token punctuation">;</span>

    <span class="token comment">/* Failure */</span>
exit_closedir<span class="token operator">:</span>
    <span class="token function">_wclosedir</span><span class="token punctuation">(</span>dirp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * Read next directory entry.
 *
 * Returns pointer to static directory entry which may be overwritten by
 * subsequent calls to _wreaddir().
 */</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">_wdirent</span><span class="token operator">*</span> <span class="token function">_wreaddir</span><span class="token punctuation">(</span>_WDIR<span class="token operator">*</span> dirp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">_wdirent</span><span class="token operator">*</span> entry<span class="token punctuation">;</span>

    <span class="token comment">/*
     * Read directory entry to buffer.  We can safely ignore the return
     * value as entry will be set to NULL in case of error.
     */</span>
    <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token function">_wreaddir_r</span><span class="token punctuation">(</span>dirp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dirp<span class="token operator">-&gt;</span>ent<span class="token punctuation">,</span> <span class="token operator">&amp;</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Return pointer to statically allocated directory entry */</span>
    <span class="token keyword">return</span> entry<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * Read next directory entry.
 *
 * Returns zero on success.  If end of directory stream is reached, then
 * sets result to NULL and returns zero.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">_wreaddir_r</span><span class="token punctuation">(</span>_WDIR<span class="token operator">*</span> dirp<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">_wdirent</span><span class="token operator">*</span> entry<span class="token punctuation">,</span>
                       <span class="token keyword">struct</span> <span class="token class-name">_wdirent</span><span class="token operator">*</span><span class="token operator">*</span> result<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    WIN32_FIND_DATAW<span class="token operator">*</span> datap<span class="token punctuation">;</span>

    <span class="token comment">/* Read next directory entry */</span>
    datap <span class="token operator">=</span> <span class="token function">dirent_next</span><span class="token punctuation">(</span>dirp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>datap<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        size_t n<span class="token punctuation">;</span>
        DWORD  attr<span class="token punctuation">;</span>

        <span class="token comment">/*
         * Copy file name as wide-character string.  If the file name is too
         * long to fit in to the destination buffer, then truncate file name
         * to PATH_MAX characters and zero-terminate the buffer.
         */</span>
        n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> PATH_MAX <span class="token operator">&amp;&amp;</span> datap<span class="token operator">-&gt;</span>cFileName<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            entry<span class="token operator">-&gt;</span>d_name<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">=</span> datap<span class="token operator">-&gt;</span>cFileName<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">;</span>
            n<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        entry<span class="token operator">-&gt;</span>d_name<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment">/* Length of file name excluding zero terminator */</span>
        entry<span class="token operator">-&gt;</span>d_namlen <span class="token operator">=</span> n<span class="token punctuation">;</span>

        <span class="token comment">/* File type */</span>
        attr <span class="token operator">=</span> datap<span class="token operator">-&gt;</span>dwFileAttributes<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>attr <span class="token operator">&amp;</span> FILE_ATTRIBUTE_DEVICE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            entry<span class="token operator">-&gt;</span>d_type <span class="token operator">=</span> DT_CHR<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>attr <span class="token operator">&amp;</span> FILE_ATTRIBUTE_DIRECTORY<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            entry<span class="token operator">-&gt;</span>d_type <span class="token operator">=</span> DT_DIR<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            entry<span class="token operator">-&gt;</span>d_type <span class="token operator">=</span> DT_REG<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* Reset dummy fields */</span>
        entry<span class="token operator">-&gt;</span>d_ino    <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        entry<span class="token operator">-&gt;</span>d_off    <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        entry<span class="token operator">-&gt;</span>d_reclen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">_wdirent</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* Set result address */</span>
        <span class="token operator">*</span>result <span class="token operator">=</span> entry<span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* Return NULL to indicate end of directory */</span>
        <span class="token operator">*</span>result <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token comment">/*OK*/</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * Close directory stream opened by opendir() function.  This invalidates
 * the DIR structure as well as any directory entry read previously by
 * _wreaddir().
 */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">_wclosedir</span><span class="token punctuation">(</span>_WDIR<span class="token operator">*</span> dirp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ok<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dirp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* Release search handle */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dirp<span class="token operator">-&gt;</span>handle <span class="token operator">!=</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token function">FindClose</span><span class="token punctuation">(</span>dirp<span class="token operator">-&gt;</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token comment">/* Release search pattern */</span>
        <span class="token function">free</span><span class="token punctuation">(</span>dirp<span class="token operator">-&gt;</span>patt<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* Release directory structure */</span>
        <span class="token function">free</span><span class="token punctuation">(</span>dirp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ok <span class="token operator">=</span> <span class="token comment">/*success*/</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* Invalid directory stream */</span>
        <span class="token function">dirent_set_errno</span><span class="token punctuation">(</span>EBADF<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ok <span class="token operator">=</span> <span class="token comment">/*failure*/</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ok<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * Rewind directory stream such that _wreaddir() returns the very first
 * file name again.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">_wrewinddir</span><span class="token punctuation">(</span>_WDIR<span class="token operator">*</span> dirp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dirp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* Release existing search handle */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dirp<span class="token operator">-&gt;</span>handle <span class="token operator">!=</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token function">FindClose</span><span class="token punctuation">(</span>dirp<span class="token operator">-&gt;</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token comment">/* Open new search handle */</span>
        <span class="token function">dirent_first</span><span class="token punctuation">(</span>dirp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/* Get first directory entry (internal) */</span>
<span class="token keyword">static</span> WIN32_FIND_DATAW<span class="token operator">*</span> <span class="token function">dirent_first</span><span class="token punctuation">(</span>_WDIR<span class="token operator">*</span> dirp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    WIN32_FIND_DATAW<span class="token operator">*</span> datap<span class="token punctuation">;</span>
    DWORD             error<span class="token punctuation">;</span>

    <span class="token comment">/* Open directory and retrieve the first entry */</span>
    dirp<span class="token operator">-&gt;</span>handle <span class="token operator">=</span> <span class="token function">FindFirstFileExW</span><span class="token punctuation">(</span>dirp<span class="token operator">-&gt;</span>patt<span class="token punctuation">,</span> FindExInfoStandard<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dirp<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span>
                                    FindExSearchNameMatch<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dirp<span class="token operator">-&gt;</span>handle <span class="token operator">!=</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* a directory entry is now waiting in memory */</span>
        datap        <span class="token operator">=</span> <span class="token operator">&amp;</span>dirp<span class="token operator">-&gt;</span>data<span class="token punctuation">;</span>
        dirp<span class="token operator">-&gt;</span>cached <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* Failed to open directory: no directory entry in memory */</span>
        dirp<span class="token operator">-&gt;</span>cached <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        datap        <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

        <span class="token comment">/* Set error code */</span>
        error <span class="token operator">=</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> ERROR_ACCESS_DENIED<span class="token operator">:</span>
                <span class="token comment">/* No read access to directory */</span>
                <span class="token function">dirent_set_errno</span><span class="token punctuation">(</span>EACCES<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token keyword">case</span> ERROR_DIRECTORY<span class="token operator">:</span>
                <span class="token comment">/* Directory name is invalid */</span>
                <span class="token function">dirent_set_errno</span><span class="token punctuation">(</span>ENOTDIR<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token keyword">case</span> ERROR_PATH_NOT_FOUND<span class="token operator">:</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token comment">/* Cannot find the file */</span>
                <span class="token function">dirent_set_errno</span><span class="token punctuation">(</span>ENOENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> datap<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * Get next directory entry (internal).
 *
 * Returns
 */</span>
<span class="token keyword">static</span> WIN32_FIND_DATAW<span class="token operator">*</span> <span class="token function">dirent_next</span><span class="token punctuation">(</span>_WDIR<span class="token operator">*</span> dirp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    WIN32_FIND_DATAW<span class="token operator">*</span> p<span class="token punctuation">;</span>

    <span class="token comment">/* Get next directory entry */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dirp<span class="token operator">-&gt;</span>cached <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* A valid directory entry already in memory */</span>
        p            <span class="token operator">=</span> <span class="token operator">&amp;</span>dirp<span class="token operator">-&gt;</span>data<span class="token punctuation">;</span>
        dirp<span class="token operator">-&gt;</span>cached <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>dirp<span class="token operator">-&gt;</span>handle <span class="token operator">!=</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* Get the next directory entry from stream */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FindNextFileW</span><span class="token punctuation">(</span>dirp<span class="token operator">-&gt;</span>handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dirp<span class="token operator">-&gt;</span>data<span class="token punctuation">)</span> <span class="token operator">!=</span> FALSE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">/* Got a file */</span>
            p <span class="token operator">=</span> <span class="token operator">&amp;</span>dirp<span class="token operator">-&gt;</span>data<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">/* The very last entry has been processed or an error occurred
             */</span>
            <span class="token function">FindClose</span><span class="token punctuation">(</span>dirp<span class="token operator">-&gt;</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
            dirp<span class="token operator">-&gt;</span>handle <span class="token operator">=</span> INVALID_HANDLE_VALUE<span class="token punctuation">;</span>
            p            <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* End of directory stream reached */</span>
        p <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> p<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * Open directory stream using plain old C-string.
 */</span>
<span class="token keyword">static</span> DIR<span class="token operator">*</span> <span class="token function">opendir</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> dirname<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">DIR</span><span class="token operator">*</span> dirp<span class="token punctuation">;</span>

    <span class="token comment">/* Must have directory name */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dirname <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> dirname<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'\0'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">dirent_set_errno</span><span class="token punctuation">(</span>ENOENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* Allocate memory for DIR structure */</span>
    dirp <span class="token operator">=</span> <span class="token punctuation">(</span>DIR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">DIR</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dirp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span>     error<span class="token punctuation">;</span>
        <span class="token keyword">wchar_t</span> wname<span class="token punctuation">[</span>PATH_MAX <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        size_t  n<span class="token punctuation">;</span>

        <span class="token comment">/* Convert directory name to wide-character string */</span>
        error <span class="token operator">=</span>
            <span class="token function">dirent_mbstowcs_s</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>n<span class="token punctuation">,</span> wname<span class="token punctuation">,</span> PATH_MAX <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> dirname<span class="token punctuation">,</span> PATH_MAX <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">/*
             * Cannot convert file name to wide-character string.  This
             * occurs if the string contains invalid multi-byte sequences or
             * the output buffer is too small to contain the resulting
             * string.
             */</span>
            <span class="token keyword">goto</span> exit_free<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* Open directory stream using wide-character name */</span>
        dirp<span class="token operator">-&gt;</span>wdirp <span class="token operator">=</span> <span class="token function">_wopendir</span><span class="token punctuation">(</span>wname<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dirp<span class="token operator">-&gt;</span>wdirp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">goto</span> exit_free<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* Success */</span>
    <span class="token keyword">return</span> dirp<span class="token punctuation">;</span>

    <span class="token comment">/* Failure */</span>
exit_free<span class="token operator">:</span>
    <span class="token function">free</span><span class="token punctuation">(</span>dirp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * Read next directory entry.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">dirent</span><span class="token operator">*</span> <span class="token function">readdir</span><span class="token punctuation">(</span>DIR<span class="token operator">*</span> dirp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">dirent</span><span class="token operator">*</span> entry<span class="token punctuation">;</span>

    <span class="token comment">/*
     * Read directory entry to buffer.  We can safely ignore the return
     * value as entry will be set to NULL in case of error.
     */</span>
    <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token function">readdir_r</span><span class="token punctuation">(</span>dirp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dirp<span class="token operator">-&gt;</span>ent<span class="token punctuation">,</span> <span class="token operator">&amp;</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Return pointer to statically allocated directory entry */</span>
    <span class="token keyword">return</span> entry<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * Read next directory entry into called-allocated buffer.
 *
 * Returns zero on success.  If the end of directory stream is reached, then
 * sets result to NULL and returns zero.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">readdir_r</span><span class="token punctuation">(</span>DIR<span class="token operator">*</span> dirp<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">dirent</span><span class="token operator">*</span> entry<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">dirent</span><span class="token operator">*</span><span class="token operator">*</span> result<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    WIN32_FIND_DATAW<span class="token operator">*</span> datap<span class="token punctuation">;</span>

    <span class="token comment">/* Read next directory entry */</span>
    datap <span class="token operator">=</span> <span class="token function">dirent_next</span><span class="token punctuation">(</span>dirp<span class="token operator">-&gt;</span>wdirp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>datap<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        size_t n<span class="token punctuation">;</span>
        <span class="token keyword">int</span>    error<span class="token punctuation">;</span>

        <span class="token comment">/* Attempt to convert file name to multi-byte string */</span>
        error <span class="token operator">=</span> <span class="token function">dirent_wcstombs_s</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>n<span class="token punctuation">,</span> entry<span class="token operator">-&gt;</span>d_name<span class="token punctuation">,</span> PATH_MAX <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
                                  datap<span class="token operator">-&gt;</span>cFileName<span class="token punctuation">,</span> PATH_MAX <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
         * If the file name cannot be represented by a multi-byte string,
         * then attempt to use old 8+3 file name.  This allows traditional
         * Unix-code to access some file names despite of unicode
         * characters, although file names may seem unfamiliar to the user.
         *
         * Be ware that the code below cannot come up with a short file
         * name unless the file system provides one.  At least
         * VirtualBox shared folders fail to do this.
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">&amp;&amp;</span> datap<span class="token operator">-&gt;</span>cAlternateFileName<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token char">'\0'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            error <span class="token operator">=</span> <span class="token function">dirent_wcstombs_s</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>n<span class="token punctuation">,</span> entry<span class="token operator">-&gt;</span>d_name<span class="token punctuation">,</span> PATH_MAX <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
                                      datap<span class="token operator">-&gt;</span>cAlternateFileName<span class="token punctuation">,</span> PATH_MAX <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            DWORD attr<span class="token punctuation">;</span>

            <span class="token comment">/* Length of file name excluding zero terminator */</span>
            entry<span class="token operator">-&gt;</span>d_namlen <span class="token operator">=</span> n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>

            <span class="token comment">/* File attributes */</span>
            attr <span class="token operator">=</span> datap<span class="token operator">-&gt;</span>dwFileAttributes<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>attr <span class="token operator">&amp;</span> FILE_ATTRIBUTE_DEVICE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                entry<span class="token operator">-&gt;</span>d_type <span class="token operator">=</span> DT_CHR<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>attr <span class="token operator">&amp;</span> FILE_ATTRIBUTE_DIRECTORY<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                entry<span class="token operator">-&gt;</span>d_type <span class="token operator">=</span> DT_DIR<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                entry<span class="token operator">-&gt;</span>d_type <span class="token operator">=</span> DT_REG<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">/* Reset dummy fields */</span>
            entry<span class="token operator">-&gt;</span>d_ino    <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            entry<span class="token operator">-&gt;</span>d_off    <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            entry<span class="token operator">-&gt;</span>d_reclen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">dirent</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">/*
             * Cannot convert file name to multi-byte string so construct
             * an erroneous directory entry and return that.  Note that
             * we cannot return NULL as that would stop the processing
             * of directory entries completely.
             */</span>
            entry<span class="token operator">-&gt;</span>d_name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'?'</span><span class="token punctuation">;</span>
            entry<span class="token operator">-&gt;</span>d_name<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
            entry<span class="token operator">-&gt;</span>d_namlen  <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            entry<span class="token operator">-&gt;</span>d_type    <span class="token operator">=</span> DT_UNKNOWN<span class="token punctuation">;</span>
            entry<span class="token operator">-&gt;</span>d_ino     <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            entry<span class="token operator">-&gt;</span>d_off     <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            entry<span class="token operator">-&gt;</span>d_reclen  <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* Return pointer to directory entry */</span>
        <span class="token operator">*</span>result <span class="token operator">=</span> entry<span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* No more directory entries */</span>
        <span class="token operator">*</span>result <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token comment">/*OK*/</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * Close directory stream.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">closedir</span><span class="token punctuation">(</span>DIR<span class="token operator">*</span> dirp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ok<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dirp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* Close wide-character directory stream */</span>
        ok          <span class="token operator">=</span> <span class="token function">_wclosedir</span><span class="token punctuation">(</span>dirp<span class="token operator">-&gt;</span>wdirp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dirp<span class="token operator">-&gt;</span>wdirp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

        <span class="token comment">/* Release multi-byte character version */</span>
        <span class="token function">free</span><span class="token punctuation">(</span>dirp<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* Invalid directory stream */</span>
        <span class="token function">dirent_set_errno</span><span class="token punctuation">(</span>EBADF<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ok <span class="token operator">=</span> <span class="token comment">/*failure*/</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ok<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * Rewind directory stream to beginning.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">rewinddir</span><span class="token punctuation">(</span>DIR<span class="token operator">*</span> dirp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* Rewind wide-character string directory stream */</span>
    <span class="token function">_wrewinddir</span><span class="token punctuation">(</span>dirp<span class="token operator">-&gt;</span>wdirp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * Scan directory for entries.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">scandir</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> dirname<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">dirent</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> namelist<span class="token punctuation">,</span>
                   <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>filter<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">dirent</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                   <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>compare<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">dirent</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">dirent</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">dirent</span><span class="token operator">*</span><span class="token operator">*</span> files     <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    size_t          size      <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    size_t          allocated <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> size_t    init_size <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    DIR<span class="token operator">*</span>            dir       <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">dirent</span><span class="token operator">*</span>  entry<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">dirent</span><span class="token operator">*</span>  tmp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    size_t          i<span class="token punctuation">;</span>
    <span class="token keyword">int</span>             result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">/* Open directory stream */</span>
    dir <span class="token operator">=</span> <span class="token function">opendir</span><span class="token punctuation">(</span>dirname<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dir<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* Read directory entries to memory */</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">/* Enlarge pointer table to make room for another pointer */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&gt;=</span> allocated<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">void</span><span class="token operator">*</span>  p<span class="token punctuation">;</span>
                size_t num_entries<span class="token punctuation">;</span>

                <span class="token comment">/* Compute number of entries in the enlarged pointer table
                 */</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;</span> init_size<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">/* Allocate initial pointer table */</span>
                    num_entries <span class="token operator">=</span> init_size<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">/* Double the size */</span>
                    num_entries <span class="token operator">=</span> size <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">/* Allocate first pointer table or enlarge existing table */</span>
                p <span class="token operator">=</span> <span class="token function">realloc</span><span class="token punctuation">(</span>files<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">*</span> num_entries<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">/* Got the memory */</span>
                    files     <span class="token operator">=</span> <span class="token punctuation">(</span>dirent<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token punctuation">;</span>
                    allocated <span class="token operator">=</span> num_entries<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">/* Out of memory */</span>
                    result <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">/* Allocate room for temporary directory entry */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tmp <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                tmp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">dirent</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">dirent</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>tmp <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">/* Cannot allocate temporary directory entry */</span>
                    result <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">/* Read directory entry to temporary area */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">readdir_r</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> tmp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>entry<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token comment">/*OK*/</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">/* Did we get an entry? */</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>entry <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">int</span> pass<span class="token punctuation">;</span>

                    <span class="token comment">/* Determine whether to include the entry in result */</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>filter<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">/* Let the filter function decide */</span>
                        pass <span class="token operator">=</span> <span class="token function">filter</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">/* No filter function, include everything */</span>
                        pass <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>pass<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">/* Store the temporary entry to pointer table */</span>
                        files<span class="token punctuation">[</span>size<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
                        tmp           <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

                        <span class="token comment">/* Keep up with the number of files */</span>
                        result<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">/*
                     * End of directory stream reached =&gt; sort entries and
                     * exit.
                     */</span>
                    <span class="token function">qsort</span><span class="token punctuation">(</span>files<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                          <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span>compare<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">/* Error reading directory entry */</span>
                result <span class="token operator">=</span> <span class="token comment">/*Error*/</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* Cannot open directory */</span>
        result <span class="token operator">=</span> <span class="token comment">/*Error*/</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* Release temporary directory entry */</span>
    <span class="token function">free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Release allocated memory on error */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token function">free</span><span class="token punctuation">(</span>files<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token function">free</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">;</span>
        files <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* Close directory stream */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dir<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token function">closedir</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token comment">/* Pass pointer table to caller */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>namelist<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token operator">*</span>namelist <span class="token operator">=</span> files<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* Alphabetical sorting */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">alphasort</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">dirent</span><span class="token operator">*</span><span class="token operator">*</span> a<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">dirent</span><span class="token operator">*</span><span class="token operator">*</span> b<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">strcoll</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>a<span class="token punctuation">)</span><span class="token operator">-&gt;</span>d_name<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>b<span class="token punctuation">)</span><span class="token operator">-&gt;</span>d_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* Sort versions */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">versionsort</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">dirent</span><span class="token operator">*</span><span class="token operator">*</span> a<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">dirent</span><span class="token operator">*</span><span class="token operator">*</span> b<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* FIXME: implement strverscmp and use that */</span>
    <span class="token keyword">return</span> <span class="token function">alphasort</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* Convert multi-byte string to wide character string */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">dirent_mbstowcs_s</span><span class="token punctuation">(</span>size_t<span class="token operator">*</span> pReturnValue<span class="token punctuation">,</span> <span class="token keyword">wchar_t</span><span class="token operator">*</span> wcstr<span class="token punctuation">,</span>
                             size_t sizeInWords<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> mbstr<span class="token punctuation">,</span>
                             size_t count<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> error<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>_MSC_VER<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> _MSC_VER <span class="token operator">&gt;=</span> <span class="token number">1400</span></span></span>

    <span class="token comment">/* Microsoft Visual Studio 2005 or later */</span>
    error <span class="token operator">=</span> <span class="token function">mbstowcs_s</span><span class="token punctuation">(</span>pReturnValue<span class="token punctuation">,</span> wcstr<span class="token punctuation">,</span> sizeInWords<span class="token punctuation">,</span> mbstr<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>

    <span class="token comment">/* Older Visual Studio or non-Microsoft compiler */</span>
    size_t n<span class="token punctuation">;</span>

    <span class="token comment">/* Convert to wide-character string (or count characters) */</span>
    n <span class="token operator">=</span> <span class="token function">mbstowcs</span><span class="token punctuation">(</span>wcstr<span class="token punctuation">,</span> mbstr<span class="token punctuation">,</span> sizeInWords<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>wcstr <span class="token operator">||</span> n <span class="token operator">&lt;</span> count<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* Zero-terminate output buffer */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>wcstr <span class="token operator">&amp;&amp;</span> sizeInWords<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&gt;=</span> sizeInWords<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> n <span class="token operator">=</span> sizeInWords <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
            wcstr<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* Length of resulting multi-byte string WITH zero terminator */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pReturnValue<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token operator">*</span>pReturnValue <span class="token operator">=</span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token comment">/* Success */</span>
        error <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* Could not convert string */</span>
        error <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token keyword">return</span> error<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* Convert wide-character string to multi-byte string */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">dirent_wcstombs_s</span><span class="token punctuation">(</span>size_t<span class="token operator">*</span> pReturnValue<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> mbstr<span class="token punctuation">,</span>
                             size_t         sizeInBytes<span class="token punctuation">,</span> <span class="token comment">/* max size of mbstr */</span>
                             <span class="token keyword">const</span> <span class="token keyword">wchar_t</span><span class="token operator">*</span> wcstr<span class="token punctuation">,</span> size_t count<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> error<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>_MSC_VER<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> _MSC_VER <span class="token operator">&gt;=</span> <span class="token number">1400</span></span></span>

    <span class="token comment">/* Microsoft Visual Studio 2005 or later */</span>
    error <span class="token operator">=</span> <span class="token function">wcstombs_s</span><span class="token punctuation">(</span>pReturnValue<span class="token punctuation">,</span> mbstr<span class="token punctuation">,</span> sizeInBytes<span class="token punctuation">,</span> wcstr<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>

    <span class="token comment">/* Older Visual Studio or non-Microsoft compiler */</span>
    size_t n<span class="token punctuation">;</span>

    <span class="token comment">/* Convert to multi-byte string (or count the number of bytes needed) */</span>
    n <span class="token operator">=</span> <span class="token function">wcstombs</span><span class="token punctuation">(</span>mbstr<span class="token punctuation">,</span> wcstr<span class="token punctuation">,</span> sizeInBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mbstr <span class="token operator">||</span> n <span class="token operator">&lt;</span> count<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* Zero-terminate output buffer */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mbstr <span class="token operator">&amp;&amp;</span> sizeInBytes<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&gt;=</span> sizeInBytes<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> n <span class="token operator">=</span> sizeInBytes <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
            mbstr<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* Length of resulting multi-bytes string WITH zero-terminator */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pReturnValue<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token operator">*</span>pReturnValue <span class="token operator">=</span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token comment">/* Success */</span>
        error <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* Cannot convert string */</span>
        error <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token keyword">return</span> error<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* Set errno variable */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">dirent_set_errno</span><span class="token punctuation">(</span><span class="token keyword">int</span> error<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>_MSC_VER<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> _MSC_VER <span class="token operator">&gt;=</span> <span class="token number">1400</span></span></span>

    <span class="token comment">/* Microsoft Visual Studio 2005 and later */</span>
    <span class="token function">_set_errno</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>

    <span class="token comment">/* Non-Microsoft compiler or older Microsoft compiler */</span>
    errno <span class="token operator">=</span> error<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__cplusplus</span></span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/*DIRENT_H*/</span></span>

</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7a99ebebae0dfd4ec425f0d695f4f2f7/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">vmare平台上esxi主机，搭建虚拟机ping不通网关</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f294d66f587a58f77443b63d685f6e17/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">面向对象编程</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>