<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Tensorflow2.0入门教程19：模型的保存与恢复 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Tensorflow2.0入门教程19：模型的保存与恢复" />
<meta property="og:description" content="一、模型保存： 1.保存模型参数
2.保存整个模型
回调函数保存
手动保存
1.回调函数：tf.keras.callbacks.ModelCheckpoint 训练期间保存模型（以 checkpoints 形式保存）,Checkpoint是一个二进制文件，它保存了权重、偏置项、梯度以及其他所有的变量的取值，扩展名为.ckpt
keras.callbacks.ModelCheckpoint(filepath, monitor=‘val_loss’, verbose=0, save_best_only=False, save_weights_only=False, mode=‘auto’, period=1)
filepath：string，保存模型文件的路径。monitor：要监测的数量。verbose：详细信息模式，0或1。save_best_only：如果save_best_only=True，被监测数量的最佳型号不会被覆盖。mode：{auto，min，max}之一。如果save_best_only=True，那么是否覆盖保存文件的决定就取决于被监测数据的最大或者最小值。对于val_acc，这应该是max，对于val_loss这应该是min，等等。在auto模式中，方向是从监测数量的名称自动推断出来的。save_weights_only：如果为True，则仅保存模型的权重（model.save_weights(filepath)），否则保存完整模型（model.save(filepath)）。period:检查点之间的间隔（epoch数）。 import tensorflow as tf (train_images, train_labels), (test_images, test_labels) = tf.keras.datasets.mnist.load_data() train_labels = train_labels[:1000] test_labels = test_labels[:1000] train_images = train_images[:1000].reshape(-1, 28 * 28) / 255.0 test_images = test_images[:1000].reshape(-1, 28 * 28) / 255.0 # 定义一个简单的序列模型 def create_model(): model = tf.keras.models.Sequential([ tf.keras.layers.Dense(128, activation=&#39;relu&#39;, input_shape=(784,)), tf.keras.layers.Dropout(0.2), tf.keras.layers.Dense(10, activation=&#39;softmax&#39;) ]) model.compile(optimizer=&#39;adam&#39;, loss=&#39;sparse_categorical_crossentropy&#39;, metrics=[&#39;accuracy&#39;]) return model 保存模型参数 model1 = create_model() checkpoint_path1 = &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/ebcc3ad34ee1484e942f215d04c2bf4f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-03-16T18:34:40+08:00" />
<meta property="article:modified_time" content="2020-03-16T18:34:40+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Tensorflow2.0入门教程19：模型的保存与恢复</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_1"></a>一、模型保存：</h2> 
<ul><li> <p>1.保存模型参数</p> </li><li> <p>2.保存整个模型</p> 
  <ul><li> <p>回调函数保存</p> </li><li> <p>手动保存</p> </li></ul> </li></ul> 
<h3><a id="1tfkerascallbacksModelCheckpoint_11"></a>1.回调函数：tf.keras.callbacks.ModelCheckpoint</h3> 
<p>训练期间保存模型（以 checkpoints 形式保存）,Checkpoint是一个二进制文件，它保存了权重、偏置项、梯度以及其他所有的变量的取值，扩展名为.ckpt</p> 
<p>keras.callbacks.ModelCheckpoint(filepath, monitor=‘val_loss’, verbose=0, save_best_only=False, save_weights_only=False, mode=‘auto’, period=1)</p> 
<ul><li>filepath：string，保存模型文件的路径。</li><li>monitor：要监测的数量。</li><li>verbose：详细信息模式，0或1。</li><li>save_best_only：如果save_best_only=True，被监测数量的最佳型号不会被覆盖。</li><li>mode：{auto，min，max}之一。如果save_best_only=True，那么是否覆盖保存文件的决定就取决于被监测数据的最大或者最小值。对于val_acc，这应该是max，对于val_loss这应该是min，等等。在auto模式中，方向是从监测数量的名称自动推断出来的。</li><li>save_weights_only：如果为True，则仅保存模型的权重（model.save_weights(filepath)），否则保存完整模型（model.save(filepath)）。</li><li>period:检查点之间的间隔（epoch数）。</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
</code></pre> 
<pre><code class="prism language-python"><span class="token punctuation">(</span>train_images<span class="token punctuation">,</span> train_labels<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>test_images<span class="token punctuation">,</span> test_labels<span class="token punctuation">)</span> <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>datasets<span class="token punctuation">.</span>mnist<span class="token punctuation">.</span>load_data<span class="token punctuation">(</span><span class="token punctuation">)</span>

train_labels <span class="token operator">=</span> train_labels<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">1000</span><span class="token punctuation">]</span>
test_labels <span class="token operator">=</span> test_labels<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">1000</span><span class="token punctuation">]</span>

train_images <span class="token operator">=</span> train_images<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">1000</span><span class="token punctuation">]</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">28</span> <span class="token operator">*</span> <span class="token number">28</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">255.0</span>
test_images <span class="token operator">=</span> test_images<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">1000</span><span class="token punctuation">]</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">28</span> <span class="token operator">*</span> <span class="token number">28</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">255.0</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># 定义一个简单的序列模型</span>
<span class="token keyword">def</span> <span class="token function">create_model</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    model <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>models<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span><span class="token punctuation">[</span>
    tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>Dense<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">,</span> input_shape<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">784</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>Dense<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'softmax'</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>

    model<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span>optimizer<span class="token operator">=</span><span class="token string">'adam'</span><span class="token punctuation">,</span>
                loss<span class="token operator">=</span><span class="token string">'sparse_categorical_crossentropy'</span><span class="token punctuation">,</span>
                metrics<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'accuracy'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> model
</code></pre> 
<h4><a id="_58"></a>保存模型参数</h4> 
<pre><code class="prism language-python">model1 <span class="token operator">=</span> create_model<span class="token punctuation">(</span><span class="token punctuation">)</span>
checkpoint_path1 <span class="token operator">=</span> <span class="token string">"training_1/cp.ckpt"</span>
cp_callback <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>callbacks<span class="token punctuation">.</span>ModelCheckpoint<span class="token punctuation">(</span>checkpoint_path1<span class="token punctuation">,</span> save_weights_only<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>verbose<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
model1<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>train_images<span class="token punctuation">,</span>train_labels<span class="token punctuation">,</span>epochs<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>validation_data<span class="token operator">=</span><span class="token punctuation">(</span>test_images<span class="token punctuation">,</span>test_labels<span class="token punctuation">)</span><span class="token punctuation">,</span>callbacks <span class="token operator">=</span> <span class="token punctuation">[</span>cp_callback<span class="token punctuation">]</span><span class="token punctuation">,</span>verbose<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>Train on 1000 samples, validate on 1000 samples
Epoch 1/10
1000/1000 - 0s - loss: 1.5260 - accuracy: 0.5590 - val_loss: 1.0336 - val_accuracy: 0.7450
Epoch 2/10
1000/1000 - 0s - loss: 0.6987 - accuracy: 0.8240 - val_loss: 0.6933 - val_accuracy: 0.8130
Epoch 3/10
1000/1000 - 0s - loss: 0.4780 - accuracy: 0.8760 - val_loss: 0.5774 - val_accuracy: 0.8360
Epoch 4/10
1000/1000 - 0s - loss: 0.3682 - accuracy: 0.9010 - val_loss: 0.5263 - val_accuracy: 0.8450
Epoch 5/10
1000/1000 - 0s - loss: 0.3029 - accuracy: 0.9250 - val_loss: 0.4847 - val_accuracy: 0.8420
Epoch 6/10
1000/1000 - 0s - loss: 0.2572 - accuracy: 0.9340 - val_loss: 0.4661 - val_accuracy: 0.8560
Epoch 7/10
1000/1000 - 0s - loss: 0.2252 - accuracy: 0.9490 - val_loss: 0.4509 - val_accuracy: 0.8540
Epoch 8/10
1000/1000 - 0s - loss: 0.1855 - accuracy: 0.9600 - val_loss: 0.4275 - val_accuracy: 0.8570
Epoch 9/10
1000/1000 - 0s - loss: 0.1605 - accuracy: 0.9670 - val_loss: 0.4292 - val_accuracy: 0.8590
Epoch 10/10
1000/1000 - 0s - loss: 0.1421 - accuracy: 0.9710 - val_loss: 0.4227 - val_accuracy: 0.8650
&lt;tensorflow.python.keras.callbacks.History at 0x25617446d68&gt;
</code></pre> 
<p>checkpoint 回调选项：</p> 
<ul><li> <p>回调提供了几个选项，为 checkpoint 提供唯一名称并调整 checkpoint 频率。</p> </li><li> <p>训练一个新模型，每两个 epochs 保存一次唯一命名的 checkpoint ：</p> </li></ul> 
<pre><code class="prism language-python">model2 <span class="token operator">=</span> create_model<span class="token punctuation">(</span><span class="token punctuation">)</span>
checkpoint_path2 <span class="token operator">=</span> <span class="token string">"training_2/cp-{epoch:04d}.ckpt"</span>
cp_callback <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>callbacks<span class="token punctuation">.</span>ModelCheckpoint<span class="token punctuation">(</span>checkpoint_path2<span class="token punctuation">,</span>period<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>monitor<span class="token operator">=</span><span class="token string">"val_accuracy"</span><span class="token punctuation">,</span>
                                                 save_best_only<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>mode<span class="token operator">=</span><span class="token string">"max"</span><span class="token punctuation">,</span>save_weights_only<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>verbose<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
model2<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>train_images<span class="token punctuation">,</span>train_labels<span class="token punctuation">,</span>epochs<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>validation_data<span class="token operator">=</span><span class="token punctuation">(</span>test_images<span class="token punctuation">,</span>test_labels<span class="token punctuation">)</span><span class="token punctuation">,</span>callbacks <span class="token operator">=</span> <span class="token punctuation">[</span>cp_callback<span class="token punctuation">]</span><span class="token punctuation">,</span>verbose<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>WARNING:tensorflow:`period` argument is deprecated. Please use `save_freq` to specify the frequency in number of samples seen.
Train on 1000 samples, validate on 1000 samples
Epoch 1/10
1000/1000 - 0s - loss: 1.6386 - accuracy: 0.5140 - val_loss: 1.1132 - val_accuracy: 0.7000
Epoch 2/10
1000/1000 - 0s - loss: 0.7385 - accuracy: 0.8020 - val_loss: 0.7291 - val_accuracy: 0.7950
Epoch 3/10
1000/1000 - 0s - loss: 0.4973 - accuracy: 0.8720 - val_loss: 0.5980 - val_accuracy: 0.8280
Epoch 4/10
1000/1000 - 0s - loss: 0.3961 - accuracy: 0.8930 - val_loss: 0.5367 - val_accuracy: 0.8410
Epoch 5/10
1000/1000 - 0s - loss: 0.3182 - accuracy: 0.9170 - val_loss: 0.4925 - val_accuracy: 0.8560
Epoch 6/10
1000/1000 - 0s - loss: 0.2772 - accuracy: 0.9250 - val_loss: 0.5132 - val_accuracy: 0.8410
Epoch 7/10
1000/1000 - 0s - loss: 0.2298 - accuracy: 0.9470 - val_loss: 0.4731 - val_accuracy: 0.8530
Epoch 8/10
1000/1000 - 0s - loss: 0.2083 - accuracy: 0.9480 - val_loss: 0.4472 - val_accuracy: 0.8590
Epoch 9/10
1000/1000 - 0s - loss: 0.1766 - accuracy: 0.9670 - val_loss: 0.4370 - val_accuracy: 0.8610
Epoch 10/10
1000/1000 - 0s - loss: 0.1465 - accuracy: 0.9660 - val_loss: 0.4363 - val_accuracy: 0.8660
&lt;tensorflow.python.keras.callbacks.History at 0x25617a7def0&gt;
</code></pre> 
<h4><a id="_134"></a>保存整个模型</h4> 
<pre><code class="prism language-python">model3 <span class="token operator">=</span> create_model<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># checkpoint_path3 = "training_3"</span>
checkpoint_path1 <span class="token operator">=</span> <span class="token string">"training_3.h5"</span>
cp_callback <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>callbacks<span class="token punctuation">.</span>ModelCheckpoint<span class="token punctuation">(</span>checkpoint_path3<span class="token punctuation">,</span> save_weights_only<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>verbose<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
model3<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>train_images<span class="token punctuation">,</span>train_labels<span class="token punctuation">,</span>epochs<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>validation_data<span class="token operator">=</span><span class="token punctuation">(</span>test_images<span class="token punctuation">,</span>test_labels<span class="token punctuation">)</span><span class="token punctuation">,</span>callbacks <span class="token operator">=</span> <span class="token punctuation">[</span>cp_callback<span class="token punctuation">]</span><span class="token punctuation">,</span>verbose<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>Train on 1000 samples, validate on 1000 samples
Epoch 1/10
INFO:tensorflow:Assets written to: training_3\assets
1000/1000 - 1s - loss: 1.5397 - accuracy: 0.5510 - val_loss: 1.0164 - val_accuracy: 0.7510
Epoch 2/10
INFO:tensorflow:Assets written to: training_3\assets
1000/1000 - 1s - loss: 0.6896 - accuracy: 0.8190 - val_loss: 0.6884 - val_accuracy: 0.8020
Epoch 3/10
INFO:tensorflow:Assets written to: training_3\assets
1000/1000 - 1s - loss: 0.4903 - accuracy: 0.8640 - val_loss: 0.5970 - val_accuracy: 0.8200
Epoch 4/10
INFO:tensorflow:Assets written to: training_3\assets
1000/1000 - 1s - loss: 0.3805 - accuracy: 0.9050 - val_loss: 0.5356 - val_accuracy: 0.8390
Epoch 5/10
INFO:tensorflow:Assets written to: training_3\assets
1000/1000 - 0s - loss: 0.3025 - accuracy: 0.9240 - val_loss: 0.4885 - val_accuracy: 0.8510
Epoch 6/10
INFO:tensorflow:Assets written to: training_3\assets
1000/1000 - 1s - loss: 0.2783 - accuracy: 0.9250 - val_loss: 0.4767 - val_accuracy: 0.8500
Epoch 7/10
INFO:tensorflow:Assets written to: training_3\assets
1000/1000 - 1s - loss: 0.2241 - accuracy: 0.9400 - val_loss: 0.4600 - val_accuracy: 0.8490
Epoch 8/10
INFO:tensorflow:Assets written to: training_3\assets
1000/1000 - 0s - loss: 0.2078 - accuracy: 0.9500 - val_loss: 0.4576 - val_accuracy: 0.8490
Epoch 9/10
INFO:tensorflow:Assets written to: training_3\assets
1000/1000 - 0s - loss: 0.1631 - accuracy: 0.9670 - val_loss: 0.4456 - val_accuracy: 0.8630
Epoch 10/10
INFO:tensorflow:Assets written to: training_3\assets
1000/1000 - 0s - loss: 0.1491 - accuracy: 0.9700 - val_loss: 0.4264 - val_accuracy: 0.8570
&lt;tensorflow.python.keras.callbacks.History at 0x2561908add8&gt;
</code></pre> 
<h3><a id="2_180"></a>2.手动保存</h3> 
<pre><code class="prism language-python">model4 <span class="token operator">=</span> create_model<span class="token punctuation">(</span><span class="token punctuation">)</span>
model4<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>train_images<span class="token punctuation">,</span>train_labels<span class="token punctuation">,</span>epochs<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>validation_data<span class="token operator">=</span><span class="token punctuation">(</span>test_images<span class="token punctuation">,</span>test_labels<span class="token punctuation">)</span><span class="token punctuation">,</span>verbose<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>Train on 1000 samples, validate on 1000 samples
Epoch 1/10
1000/1000 - 0s - loss: 1.5830 - accuracy: 0.5460 - val_loss: 1.0903 - val_accuracy: 0.6990
Epoch 2/10
1000/1000 - 0s - loss: 0.7136 - accuracy: 0.8010 - val_loss: 0.7605 - val_accuracy: 0.7720
Epoch 3/10
1000/1000 - 0s - loss: 0.4949 - accuracy: 0.8690 - val_loss: 0.5975 - val_accuracy: 0.8190
Epoch 4/10
1000/1000 - 0s - loss: 0.3896 - accuracy: 0.8920 - val_loss: 0.5583 - val_accuracy: 0.8350
Epoch 5/10
1000/1000 - 0s - loss: 0.3083 - accuracy: 0.9200 - val_loss: 0.5231 - val_accuracy: 0.8460
Epoch 6/10
1000/1000 - 0s - loss: 0.2686 - accuracy: 0.9330 - val_loss: 0.4792 - val_accuracy: 0.8460
Epoch 7/10
1000/1000 - 0s - loss: 0.2288 - accuracy: 0.9370 - val_loss: 0.4640 - val_accuracy: 0.8560
Epoch 8/10
1000/1000 - 0s - loss: 0.1974 - accuracy: 0.9530 - val_loss: 0.4606 - val_accuracy: 0.8570
Epoch 9/10
1000/1000 - 0s - loss: 0.1637 - accuracy: 0.9680 - val_loss: 0.4609 - val_accuracy: 0.8480
Epoch 10/10
1000/1000 - 0s - loss: 0.1481 - accuracy: 0.9710 - val_loss: 0.4347 - val_accuracy: 0.8660
&lt;tensorflow.python.keras.callbacks.History at 0x25619f2b5c0&gt;
</code></pre> 
<h4><a id="_213"></a>保存权重</h4> 
<pre><code class="prism language-python">model4<span class="token punctuation">.</span>save_weights<span class="token punctuation">(</span><span class="token string">'./checkpoints/my_checkpoint'</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="_220"></a>保存整个模型</h4> 
<pre><code class="prism language-python">model5 <span class="token operator">=</span> create_model<span class="token punctuation">(</span><span class="token punctuation">)</span>
model5<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>train_images<span class="token punctuation">,</span>train_labels<span class="token punctuation">,</span>epochs<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>validation_data<span class="token operator">=</span><span class="token punctuation">(</span>test_images<span class="token punctuation">,</span>test_labels<span class="token punctuation">)</span><span class="token punctuation">,</span>verbose<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>Train on 1000 samples, validate on 1000 samples
Epoch 1/10
1000/1000 - 0s - loss: 1.5685 - accuracy: 0.5620 - val_loss: 1.0435 - val_accuracy: 0.7190
Epoch 2/10
1000/1000 - 0s - loss: 0.6908 - accuracy: 0.8280 - val_loss: 0.7122 - val_accuracy: 0.7970
Epoch 3/10
1000/1000 - 0s - loss: 0.4719 - accuracy: 0.8750 - val_loss: 0.6066 - val_accuracy: 0.8010
Epoch 4/10
1000/1000 - 0s - loss: 0.3819 - accuracy: 0.8930 - val_loss: 0.5493 - val_accuracy: 0.8250
Epoch 5/10
1000/1000 - 0s - loss: 0.3040 - accuracy: 0.9230 - val_loss: 0.5098 - val_accuracy: 0.8350
Epoch 6/10
1000/1000 - 0s - loss: 0.2652 - accuracy: 0.9350 - val_loss: 0.4669 - val_accuracy: 0.8480
Epoch 7/10
1000/1000 - 0s - loss: 0.2081 - accuracy: 0.9490 - val_loss: 0.4626 - val_accuracy: 0.8440
Epoch 8/10
1000/1000 - 0s - loss: 0.1879 - accuracy: 0.9610 - val_loss: 0.4384 - val_accuracy: 0.8530
Epoch 9/10
1000/1000 - 0s - loss: 0.1588 - accuracy: 0.9650 - val_loss: 0.4378 - val_accuracy: 0.8510
Epoch 10/10
1000/1000 - 0s - loss: 0.1538 - accuracy: 0.9660 - val_loss: 0.4495 - val_accuracy: 0.8540
&lt;tensorflow.python.keras.callbacks.History at 0x2561cd88e10&gt;
</code></pre> 
<pre><code class="prism language-python">model5<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">'model5'</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>INFO:tensorflow:Assets written to: model5\assets
</code></pre> 
<p>在部署模型时，我们的第一步往往是将训练好的整个模型完整导出为一系列标准格式的文件，然后即可在不同的平台上部署模型文件。无需建立模型的源代码即可再次运行模型，适用于模型的分享和部署。TensorFlow Serving（服务器端部署模型）、TensorFlow Lite（移动端部署模型）以及 TensorFlow.js 都会用到这一格式。</p> 
<p>将模型保存为HDF5文件</p> 
<ul><li>HDF（Hierarchical Data Format）指一种为存储和处理大容量科学数据设计的文件格式及相应库文件。</li><li>https://support.hdfgroup.org/HDF5/</li></ul> 
<pre><code class="prism language-python"><span class="token comment"># 创建一个新的模型实例</span>
model6 <span class="token operator">=</span> create_model<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 训练模型</span>
model6<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>train_images<span class="token punctuation">,</span> train_labels<span class="token punctuation">,</span> epochs<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>

<span class="token comment"># 将整个模型保存为HDF5文件</span>
model6<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">'my_model.h5'</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>Train on 1000 samples
Epoch 1/5
1000/1000 [==============================] - 0s 254us/sample - loss: 1.6071 - accuracy: 0.5330
Epoch 2/5
1000/1000 [==============================] - 0s 56us/sample - loss: 0.7051 - accuracy: 0.8150
Epoch 3/5
1000/1000 [==============================] - 0s 59us/sample - loss: 0.4864 - accuracy: 0.8680
Epoch 4/5
1000/1000 [==============================] - 0s 56us/sample - loss: 0.3656 - accuracy: 0.9130
Epoch 5/5
1000/1000 [==============================] - 0s 59us/sample - loss: 0.3108 - accuracy: 0.9150
</code></pre> 
<h2><a id="_294"></a>二、模型恢复</h2> 
<h3><a id="_296"></a>恢复模型参数</h3> 
<p>创建一个新的未经训练的模型。仅恢复模型的权重时，必须具有与原始模型具有相同网络结构的模型。由于模型具有相同的结构，您可以共享权重，尽管它是模型的不同实例。 现在重建一个新的未经训练的模型，并在测试集上进行评估。未经训练的模型将在机会水平（chance levels）上执行（准确度约为10％）：</p> 
<pre><code class="prism language-python"><span class="token comment"># 创建一个基本模型实例</span>
model7 <span class="token operator">=</span> create_model<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 评估模型</span>
loss<span class="token punctuation">,</span> acc <span class="token operator">=</span> model7<span class="token punctuation">.</span>evaluate<span class="token punctuation">(</span>test_images<span class="token punctuation">,</span>  test_labels<span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Untrained model, accuracy: {:5.2f}%"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">*</span>acc<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>1000/1 - 0s - loss: 2.3194 - accuracy: 0.0990
Untrained model, accuracy:  9.90%
</code></pre> 
<p>然后从 checkpoint 加载权重并重新评估：</p> 
<pre><code class="prism language-python"><span class="token comment"># 加载权重</span>
model7<span class="token punctuation">.</span>load_weights<span class="token punctuation">(</span>checkpoint_path1<span class="token punctuation">)</span>

<span class="token comment"># 重新评估模型</span>
loss<span class="token punctuation">,</span>acc <span class="token operator">=</span> model7<span class="token punctuation">.</span>evaluate<span class="token punctuation">(</span>test_images<span class="token punctuation">,</span>  test_labels<span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Restored model, accuracy: {:5.2f}%"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">*</span>acc<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>1000/1 - 0s - loss: 0.5116 - accuracy: 0.8650
Restored model, accuracy: 86.50%
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">import</span> os
checkpoint_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>checkpoint_path2<span class="token punctuation">)</span>
latest <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>latest_checkpoint<span class="token punctuation">(</span>checkpoint_dir<span class="token punctuation">)</span>
latest
</code></pre> 
<pre><code>'training_2\\cp-0010.ckpt'
</code></pre> 
<pre><code class="prism language-python">model8<span class="token operator">=</span> create_model<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 加载最后一次保存模型的权重</span>
model8<span class="token punctuation">.</span>load_weights<span class="token punctuation">(</span>latest<span class="token punctuation">)</span>

<span class="token comment"># 重新评估模型</span>
loss<span class="token punctuation">,</span>acc <span class="token operator">=</span> model3<span class="token punctuation">.</span>evaluate<span class="token punctuation">(</span>test_images<span class="token punctuation">,</span>  test_labels<span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Restored model, accuracy: {:5.2f}%"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">*</span>acc<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>1000/1 - 0s - loss: 0.4467 - accuracy: 0.8570
Restored model, accuracy: 85.70%
</code></pre> 
<p>指定文件名恢复</p> 
<pre><code class="prism language-python"><span class="token comment"># model.ckpt-8</span>
model9<span class="token operator">=</span> create_model<span class="token punctuation">(</span><span class="token punctuation">)</span>
model9<span class="token punctuation">.</span>load_weights<span class="token punctuation">(</span><span class="token string">'training_2\cp-0002.ckpt'</span><span class="token punctuation">)</span>

<span class="token comment"># 重新评估模型</span>
loss<span class="token punctuation">,</span>acc <span class="token operator">=</span> model9<span class="token punctuation">.</span>evaluate<span class="token punctuation">(</span>test_images<span class="token punctuation">,</span>  test_labels<span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Restored model, accuracy: {:5.2f}%"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">*</span>acc<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>1000/1 - 0s - loss: 0.8354 - accuracy: 0.7950
Restored model, accuracy: 79.50%
</code></pre> 
<h3><a id="_376"></a>恢复整个模型</h3> 
<p>从HDF5文件中恢复模型</p> 
<pre><code class="prism language-python"><span class="token comment"># 重新创建完全相同的模型，包括其权重和优化程序</span>
new_model <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>models<span class="token punctuation">.</span>load_model<span class="token punctuation">(</span><span class="token string">'my_model.h5'</span><span class="token punctuation">)</span>
<span class="token comment"># 显示网络结构</span>
new_model<span class="token punctuation">.</span>summary<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>Model: "sequential_14"
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
dense_28 (Dense)             (None, 128)               100480    
_________________________________________________________________
dropout_14 (Dropout)         (None, 128)               0         
_________________________________________________________________
dense_29 (Dense)             (None, 10)                1290      
=================================================================
Total params: 101,770
Trainable params: 101,770
Non-trainable params: 0
_________________________________________________________________
</code></pre> 
<pre><code class="prism language-python">loss<span class="token punctuation">,</span> acc <span class="token operator">=</span> new_model<span class="token punctuation">.</span>evaluate<span class="token punctuation">(</span>test_images<span class="token punctuation">,</span>  test_labels<span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Restored model, accuracy: {:5.2f}%"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">*</span>acc<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>1000/1 - 0s - loss: 0.5647 - accuracy: 0.8430
Restored model, accuracy: 84.30%
</code></pre> 
<p>恢复回调函数保存的整个模型</p> 
<pre><code class="prism language-python">new_model <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>models<span class="token punctuation">.</span>load_model<span class="token punctuation">(</span><span class="token string">'training_3'</span><span class="token punctuation">)</span>
<span class="token comment"># 显示网络结构</span>
new_model<span class="token punctuation">.</span>summary<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>Model: "sequential_9"
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
dense_18 (Dense)             (None, 128)               100480    
_________________________________________________________________
dropout_9 (Dropout)          (None, 128)               0         
_________________________________________________________________
dense_19 (Dense)             (None, 10)                1290      
=================================================================
Total params: 101,770
Trainable params: 101,770
Non-trainable params: 0
_________________________________________________________________
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9f53b7097e0f8755a5811e55334bbe31/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">spring cloud启动、token</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/cbad9b238dbeaf80dbcf9cfef1df97c5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">记录一次k8s集群挂掉之后如何恢复</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>