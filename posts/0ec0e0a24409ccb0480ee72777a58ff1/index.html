<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>k8s部署metrics server资源监控及日志查看 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="k8s部署metrics server资源监控及日志查看" />
<meta property="og:description" content="k8s部署metrics server资源监控及日志查看 查看资源的常用命令kubectl getkubectl describe Metrics Server部署通过yaml文件部署metrics-server部署报错排查替换镜像下载地址metrics-server资源访问权限修改 查看日志的常用命令kubelet日志Pod日志 查看资源的常用命令 kubectl get 查看资源信息
kubectl get &lt;资源类型&gt; &lt;资源名称&gt; kubectl get &lt;资源类型&gt; &lt;资源名称&gt; -o wide #显示详细信息 kubectl get &lt;资源类型&gt; &lt;资源名称&gt; -o yaml #导出yaml文件配置 例如
kubectl get node kubectl get node k8s-master 查看节点标签信息
#给节点打标签 [root@k8s-master ~]# kubectl label node k8s-node1 node-role.kubernetes.io/node1= [root@k8s-master ~]# kubectl get node NAME STATUS ROLES AGE VERSION k8s-master Ready control-plane,master 33h v1.23.0 k8s-node1 Ready node1 33h v1.23.0 k8s-node2 Ready &lt;none&gt; 33h v1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/0ec0e0a24409ccb0480ee72777a58ff1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-25T00:42:24+08:00" />
<meta property="article:modified_time" content="2022-07-25T00:42:24+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">k8s部署metrics server资源监控及日志查看</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>k8s部署metrics server资源监控及日志查看</h4> 
 <ul><li><a href="#_2" rel="nofollow">查看资源的常用命令</a></li><li><ul><li><a href="#kubectl_get_3" rel="nofollow">kubectl get</a></li><li><a href="#kubectl_describe_42" rel="nofollow">kubectl describe</a></li></ul> 
  </li><li><a href="#Metrics_Server_106" rel="nofollow">Metrics Server部署</a></li><li><ul><li><a href="#yamlmetricsserver_107" rel="nofollow">通过yaml文件部署metrics-server</a></li><li><a href="#_138" rel="nofollow">部署报错排查</a></li><li><ul><li><a href="#_160" rel="nofollow">替换镜像下载地址</a></li><li><a href="#metricsserver_214" rel="nofollow">metrics-server资源访问权限修改</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_305" rel="nofollow">查看日志的常用命令</a></li><li><ul><li><a href="#kubelet_307" rel="nofollow">kubelet日志</a></li><li><a href="#Pod_317" rel="nofollow">Pod日志</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_2"></a>查看资源的常用命令</h2> 
<h3><a id="kubectl_get_3"></a>kubectl get</h3> 
<p>查看资源信息</p> 
<pre><code class="prism language-bash">kubectl get <span class="token operator">&lt;</span>资源类型<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>资源名称<span class="token operator">&gt;</span>
kubectl get <span class="token operator">&lt;</span>资源类型<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>资源名称<span class="token operator">&gt;</span> -o wide  <span class="token comment">#显示详细信息</span>
kubectl get <span class="token operator">&lt;</span>资源类型<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>资源名称<span class="token operator">&gt;</span> -o yaml  <span class="token comment">#导出yaml文件配置</span>
</code></pre> 
<p>例如</p> 
<pre><code class="prism language-bash">kubectl get <span class="token function">node</span>
kubectl get <span class="token function">node</span> k8s-master 
</code></pre> 
<p>查看节点标签信息</p> 
<pre><code class="prism language-bash"><span class="token comment">#给节点打标签</span>
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl label node k8s-node1 node-role.kubernetes.io/node1=</span>

<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get node</span>
NAME         STATUS   ROLES                  AGE   VERSION
k8s-master   Ready    control-plane,master   33h   v1.23.0
k8s-node1    Ready    node1                  33h   v1.23.0
k8s-node2    Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>                 33h   v1.23.0

<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get node k8s-master --show-labels</span>
</code></pre> 
<p>几个常用缩写</p> 
<pre><code class="prism language-bash">kubectl get cs <span class="token comment"># 查看control-manager和scheduler组件状态</span>
kubectl get po  <span class="token comment"># 相当于kubectl get pods</span>
kubectl get svc  <span class="token comment"># 相当于kubectl get service</span>
</code></pre> 
<p>查看集群中所有API资源信息</p> 
<pre><code class="prism language-bash">kubectl api-resources
</code></pre> 
<h3><a id="kubectl_describe_42"></a>kubectl describe</h3> 
<p>查看资源详细描述</p> 
<pre><code class="prism language-bash">kubectl describe <span class="token operator">&lt;</span>资源类型<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>资源名称<span class="token operator">&gt;</span>
</code></pre> 
<p>可以把<code>kubectl get</code>与<code>kubectl describe</code>结合使用：</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get po</span>
NAME                         READY   STATUS    RESTARTS   AGE
web-demo1-5ff6d576bb-5292c   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4h4m
web-demo1-5ff6d576bb-92gqk   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4h4m
web-demo1-5ff6d576bb-d26cf   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4h4m
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment">#</span>
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod web-demo1-5ff6d576bb-5292c -o wide</span>
NAME                         READY   STATUS    RESTARTS   AGE     IP               NODE        NOMINATED NODE   READINESS GATES
web-demo1-5ff6d576bb-5292c   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4h10m   <span class="token number">10.244</span>.169.134   k8s-node2   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment">#</span>
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe pod web-demo1-5ff6d576bb-5292c</span>
Name: <span class="token punctuation">..</span>.
Namespace: <span class="token punctuation">..</span>.
Node: <span class="token punctuation">..</span>.
Start Time: <span class="token punctuation">..</span>.
Labels: <span class="token punctuation">..</span>.
IP: <span class="token punctuation">..</span>.
COntainers: <span class="token punctuation">..</span>.
Conditions: <span class="token punctuation">..</span>.
Volumes: <span class="token punctuation">..</span>.
Tolerations: <span class="token punctuation">..</span>.


<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get node</span>
NAME         STATUS   ROLES                  AGE   VERSION
k8s-master   Ready    control-plane,master   34h   v1.23.0
k8s-node1    Ready    node1                  34h   v1.23.0
k8s-node2    Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>                 34h   v1.23.0
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment">#</span>
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get node k8s-node2 -o wide</span>
NAME        STATUS   ROLES    AGE   VERSION   INTERNAL-IP       EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION           CONTAINER-RUNTIME
k8s-node2   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   34h   v1.23.0   <span class="token number">192.168</span>.136.98    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        CentOS Linux <span class="token number">7</span> <span class="token punctuation">(</span>Core<span class="token punctuation">)</span>   <span class="token number">3.10</span>.0-1160.el7.x86_64   docker://20.10.17
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment">#</span>
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe node k8s-node2</span>
Name: <span class="token punctuation">..</span>.
Roles: <span class="token punctuation">..</span>.
Labels: <span class="token punctuation">..</span>.
Taints: <span class="token punctuation">..</span>.
Conditions: <span class="token punctuation">..</span>.
Addresses: <span class="token punctuation">..</span>.
Capacity:
  cpu: <span class="token punctuation">..</span>.
  memory: <span class="token punctuation">..</span>.
System Info: <span class="token punctuation">..</span>.
PodCIDR: <span class="token punctuation">..</span>.
Events: <span class="token punctuation">..</span>.
</code></pre> 
<p>使用<code>kubectl top</code>命令可以监控集群资源利用率，但是需要先安装<strong>Metrics Server</strong>，否则会报错。</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl top node</span>
error: Metrics API not available
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl top pod</span>
error: Metrics API not available
</code></pre> 
<h2><a id="Metrics_Server_106"></a>Metrics Server部署</h2> 
<h3><a id="yamlmetricsserver_107"></a>通过yaml文件部署metrics-server</h3> 
<p>下载yaml配置文件：</p> 
<pre><code class="prism language-bash"><span class="token function">wget</span> https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
</code></pre> 
<p>修改配置文件<code>components.yaml</code>，添加<code>--kubelet-insecure-tls</code>参数，告诉metrics server不验证kubelet提供的https证书。</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">args</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>cert<span class="token punctuation">-</span>dir=/tmp
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>secure<span class="token punctuation">-</span>port=4443
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>kubelet<span class="token punctuation">-</span>preferred<span class="token punctuation">-</span>address<span class="token punctuation">-</span>types=InternalIP<span class="token punctuation">,</span>ExternalIP<span class="token punctuation">,</span>Hostname
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>kubelet<span class="token punctuation">-</span>use<span class="token punctuation">-</span>node<span class="token punctuation">-</span>status<span class="token punctuation">-</span>port
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>kubelet<span class="token punctuation">-</span>insecure<span class="token punctuation">-</span>tls
</code></pre> 
<p>部署Metrics Server</p> 
<pre><code class="prism language-bash">kubectl apply -f components.yaml
</code></pre> 
<p>检查是否部署成功</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get apiservices | grep metrics</span>
v1beta1.metrics.k8s.io                 kube-system/metrics-server   False <span class="token punctuation">(</span>MissingEndpoints<span class="token punctuation">)</span>   8m27s
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get --raw /apis/metrics.k8s.io/v1beta1/nodes</span>
Error from server <span class="token punctuation">(</span>ServiceUnavailable<span class="token punctuation">)</span>: the server is currently unable to handle the request
</code></pre> 
<p>如果状态为True且能够返回数据，说明Metrics Server运行正常。可以看到，本次部署失败了。</p> 
<h3><a id="_138"></a>部署报错排查</h3> 
<p>查看镜像部署状态：</p> 
<pre><code class="prism language-bash">kubectl get po -n kube-system
NAME                                       READY   STATUS             RESTARTS       AGE
<span class="token punctuation">..</span>.
metrics-server-574849569f-svt2v            <span class="token number">0</span>/1     ImagePullBackOff   <span class="token number">0</span>              8m8s
</code></pre> 
<p>查看Pod日志：</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl logs metrics-server-574849569f-svt2v -n kube-system</span>
Error from server <span class="token punctuation">(</span>BadRequest<span class="token punctuation">)</span>: container <span class="token string">"metrics-server"</span> <span class="token keyword">in</span> pod <span class="token string">"metrics-server-574849569f-svt2v"</span> is waiting to start: trying and failing to pull image
</code></pre> 
<blockquote> 
 <p>结合上面的输出分析，应该是镜像拉取失败了，需要将yaml文件中的镜像下载地址替换为国内的镜像仓库地址。</p> 
</blockquote> 
<p>删除当前出错的Metrics Server部署：</p> 
<pre><code class="prism language-bash">kubectl delete -f components.yaml
</code></pre> 
<h4><a id="_160"></a>替换镜像下载地址</h4> 
<p>替换镜像下载地址为</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>shenzhen.aliyuncs.com/zengfengjin/metrics<span class="token punctuation">-</span>server<span class="token punctuation">:</span>v0.5.0
</code></pre> 
<p>重新部署</p> 
<pre><code class="prism language-bash">kubectl apply -f components.yaml
</code></pre> 
<p>安装成功，Pod状态变为<strong>Running</strong>，但是一直没有<strong>Ready</strong>。</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get deployment,po -n kube-system</span>
NAME                                      READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/calico-kube-controllers   <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           35h
deployment.apps/coredns                   <span class="token number">2</span>/2     <span class="token number">2</span>            <span class="token number">2</span>           35h
deployment.apps/metrics-server            <span class="token number">0</span>/1     <span class="token number">1</span>            <span class="token number">0</span>           87s

NAME                                           READY   STATUS    RESTARTS        AGE
<span class="token punctuation">..</span>.
pod/metrics-server-798c598bb8-rv827            <span class="token number">0</span>/1     Running   <span class="token number">0</span>               87s
</code></pre> 
<p>检查Metrics Server的Pod日志：</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl logs metrics-server-798c598bb8-rv827 -n kube-system</span>
E0724 <span class="token number">14</span>:26:19.149545       <span class="token number">1</span> scraper.go:139<span class="token punctuation">]</span> <span class="token string">"Failed to scrape node"</span> <span class="token assign-left variable">err</span><span class="token operator">=</span><span class="token string">"GET <span class="token entity" title='\"'>\"</span>https://192.168.x.x:10250/stats/summary?only_cpu_and_memory=true<span class="token entity" title='\"'>\"</span>: bad status code <span class="token entity" title='\"'>\"</span>403 Forbidden<span class="token entity" title='\"'>\"</span>"</span> <span class="token assign-left variable">node</span><span class="token operator">=</span><span class="token string">"k8s-node1"</span>

<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe pod metrics-server-798c598bb8-rv827 -n kube-system</span>
<span class="token punctuation">..</span>.
Events:
  Type     Reason     Age                   From               Message
  ----     ------     ----                  ----               -------
  Normal   Scheduled  6m25s                 default-scheduler  Successfully assigned kube-system/metrics-server-798c598bb8-rv827 to k8s-node2
  Normal   Pulling    6m24s                 kubelet            Pulling image <span class="token string">"registry.cn-shenzhen.aliyuncs.com/zengfengjin/metrics-server:v0.5.0"</span>
  Normal   Pulled     5m51s                 kubelet            Successfully pulled image <span class="token string">"registry.cn-shenzhen.aliyuncs.com/zengfengjin/metrics-server:v0.5.0"</span> <span class="token keyword">in</span> <span class="token number">32</span>.739844006s
  Normal   Created    5m51s                 kubelet            Created container metrics-server
  Normal   Started    5m51s                 kubelet            Started container metrics-server
  Warning  Unhealthy  75s <span class="token punctuation">(</span>x29 over 5m25s<span class="token punctuation">)</span>  kubelet            Readiness probe failed: HTTP probe failed with statuscode: <span class="token number">500</span>
</code></pre> 
<p>注意到以下GET请求被拒绝（<strong>403 Forbidden</strong>）</p> 
<pre><code class="prism language-bash">GET <span class="token punctuation">\</span>"https://192.168.x.x:10250/stats
</code></pre> 
<blockquote> 
 <p>原因是我们下载的yaml文件是最新的，是基于<strong>0.6.x</strong>写的，而镜像下载地址被手动改成了<strong>0.5.x</strong>。在Metrics Server中，<strong>0.5.x</strong>的配置文件中需要的权限配置与<strong>0.6.x</strong>不一样。<strong>0.5.x</strong>中需要对<code>nodes/stats</code>的访问权限，但是<strong>0.6.x</strong>中改成了<code>nodes/metrics</code>。</p> 
</blockquote> 
<p>删除当前出错的Metrics Server部署：</p> 
<pre><code class="prism language-bash">kubectl delete -f components.yaml
</code></pre> 
<h4><a id="metricsserver_214"></a>metrics-server资源访问权限修改</h4> 
<p>检查配置文件中metrics-server角色权限：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>metrics<span class="token punctuation">-</span>server
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">""</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> nodes/metrics
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> get
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">""</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> pods
  <span class="token punctuation">-</span> nodes
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> get
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
</code></pre> 
<p>增加访问<code>nodes/stats</code>的权限，修改为</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>metrics<span class="token punctuation">-</span>server
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">""</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> nodes/metrics
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> get
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">""</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> nodes/stats
  <span class="token punctuation">-</span> pods
  <span class="token punctuation">-</span> nodes
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> get
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
</code></pre> 
<p>重新部署</p> 
<pre><code class="prism language-bash">kubectl apply -f components.yaml

<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get deployment,po -n kube-system</span>
NAME                                      READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/calico-kube-controllers   <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           35h
deployment.apps/coredns                   <span class="token number">2</span>/2     <span class="token number">2</span>            <span class="token number">2</span>           36h
deployment.apps/metrics-server            <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           37s

NAME                                           READY   STATUS             RESTARTS        AGE
pod/metrics-server-798c598bb8-j69cc            <span class="token number">1</span>/1     Running            <span class="token number">0</span>               36s
</code></pre> 
<p>检查部署是否成功</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get apiservices | grep metrics</span>
v1beta1.metrics.k8s.io                 kube-system/metrics-server   True        80s
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get --raw /apis/metrics.k8s.io/v1beta1/nodes</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"kind"</span><span class="token builtin class-name">:</span><span class="token string">"NodeMetricsList"</span>,<span class="token string">"apiVersion"</span><span class="token builtin class-name">:</span><span class="token string">"metrics.k8s.io/v1beta1"</span>,<span class="token string">"metadata"</span>:<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>,<span class="token string">"items"</span>:<span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">"metadata"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"k8s-master"</span>,<span class="token string">"creationTimestamp"</span><span class="token builtin class-name">:</span><span class="token string">"2022-07-24T15:06:31Z"</span>,<span class="token string">"labels"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"beta.kubernetes.io/arch"</span><span class="token builtin class-name">:</span><span class="token string">"amd64"</span>,<span class="token string">"beta.kubernetes.io/os"</span><span class="token builtin class-name">:</span><span class="token string">"linux"</span>,<span class="token string">"kubernetes.io/arch"</span><span class="token builtin class-name">:</span><span class="token string">"amd64"</span>,<span class="token string">"kubernetes.io/hostname"</span><span class="token builtin class-name">:</span><span class="token string">"k8s-master"</span>,<span class="token string">"kubernetes.io/os"</span><span class="token builtin class-name">:</span><span class="token string">"linux"</span>,<span class="token string">"node-role.kubernetes.io/control-plane"</span><span class="token builtin class-name">:</span><span class="token string">""</span>,<span class="token string">"node-role.kubernetes.io/master"</span><span class="token builtin class-name">:</span><span class="token string">""</span>,<span class="token string">"node.kubernetes.io/exclude-from-external-load-balancers"</span><span class="token builtin class-name">:</span><span class="token string">""</span><span class="token punctuation">}</span><span class="token punctuation">}</span>,<span class="token string">"timestamp"</span><span class="token builtin class-name">:</span><span class="token string">"2022-07-24T15:06:11Z"</span>,<span class="token string">"window"</span><span class="token builtin class-name">:</span><span class="token string">"10s"</span>,<span class="token string">"usage"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"cpu"</span><span class="token builtin class-name">:</span><span class="token string">"201981233n"</span>,<span class="token string">"memory"</span><span class="token builtin class-name">:</span><span class="token string">"1244120Ki"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>,<span class="token punctuation">{<!-- --></span><span class="token string">"metadata"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"k8s-node1"</span>,<span class="token string">"creationTimestamp"</span><span class="token builtin class-name">:</span><span class="token string">"2022-07-24T15:06:31Z"</span>,<span class="token string">"labels"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"beta.kubernetes.io/arch"</span><span class="token builtin class-name">:</span><span class="token string">"amd64"</span>,<span class="token string">"beta.kubernetes.io/os"</span><span class="token builtin class-name">:</span><span class="token string">"linux"</span>,<span class="token string">"kubernetes.io/arch"</span><span class="token builtin class-name">:</span><span class="token string">"amd64"</span>,<span class="token string">"kubernetes.io/hostname"</span><span class="token builtin class-name">:</span><span class="token string">"k8s-node1"</span>,<span class="token string">"kubernetes.io/os"</span><span class="token builtin class-name">:</span><span class="token string">"linux"</span>,<span class="token string">"node-role.kubernetes.io/node1"</span><span class="token builtin class-name">:</span><span class="token string">""</span><span class="token punctuation">}</span><span class="token punctuation">}</span>,<span class="token string">"timestamp"</span><span class="token builtin class-name">:</span><span class="token string">"2022-07-24T15:06:14Z"</span>,<span class="token string">"window"</span><span class="token builtin class-name">:</span><span class="token string">"20s"</span>,<span class="token string">"usage"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"cpu"</span><span class="token builtin class-name">:</span><span class="token string">"86504224n"</span>,<span class="token string">"memory"</span><span class="token builtin class-name">:</span><span class="token string">"846880Ki"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>,<span class="token punctuation">{<!-- --></span><span class="token string">"metadata"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"k8s-node2"</span>,<span class="token string">"creationTimestamp"</span><span class="token builtin class-name">:</span><span class="token string">"2022-07-24T15:06:31Z"</span>,<span class="token string">"labels"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"beta.kubernetes.io/arch"</span><span class="token builtin class-name">:</span><span class="token string">"amd64"</span>,<span class="token string">"beta.kubernetes.io/os"</span><span class="token builtin class-name">:</span><span class="token string">"linux"</span>,<span class="token string">"kubernetes.io/arch"</span><span class="token builtin class-name">:</span><span class="token string">"amd64"</span>,<span class="token string">"kubernetes.io/hostname"</span><span class="token builtin class-name">:</span><span class="token string">"k8s-node2"</span>,<span class="token string">"kubernetes.io/os"</span><span class="token builtin class-name">:</span><span class="token string">"linux"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>,<span class="token string">"timestamp"</span><span class="token builtin class-name">:</span><span class="token string">"2022-07-24T15:06:10Z"</span>,<span class="token string">"window"</span><span class="token builtin class-name">:</span><span class="token string">"10s"</span>,<span class="token string">"usage"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"cpu"</span><span class="token builtin class-name">:</span><span class="token string">"77667531n"</span>,<span class="token string">"memory"</span><span class="token builtin class-name">:</span><span class="token string">"883624Ki"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
</code></pre> 
<p>查看资源监控</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl top node</span>
NAME         CPU<span class="token punctuation">(</span>cores<span class="token punctuation">)</span>   CPU%   MEMORY<span class="token punctuation">(</span>bytes<span class="token punctuation">)</span>   MEMORY%
k8s-master   208m         <span class="token number">10</span>%    1217Mi          <span class="token number">70</span>%
k8s-node1    83m          <span class="token number">4</span>%     829Mi           <span class="token number">48</span>%
k8s-node2    80m          <span class="token number">4</span>%     864Mi           <span class="token number">50</span>%
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment">#</span>
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl top pod</span>
NAME                         CPU<span class="token punctuation">(</span>cores<span class="token punctuation">)</span>   MEMORY<span class="token punctuation">(</span>bytes<span class="token punctuation">)</span>
web-demo1-5ff6d576bb-5292c   1m           5Mi
web-demo1-5ff6d576bb-92gqk   1m           7Mi
web-demo1-5ff6d576bb-d26cf   1m           3Mi
</code></pre> 
<h2><a id="_305"></a>查看日志的常用命令</h2> 
<h3><a id="kubelet_307"></a>kubelet日志</h3> 
<p>kubelet组件使用systemd管理服务，查看日志的命令为</p> 
<pre><code class="prism language-bash">journalctl -u kubelet -f
</code></pre> 
<p>或者查看系统日志</p> 
<pre><code class="prism language-bash"><span class="token function">tail</span> -f /var/log/messages
</code></pre> 
<h3><a id="Pod_317"></a>Pod日志</h3> 
<p>其他k8s组件采用容器部署，查看日志的命令为</p> 
<pre><code class="prism language-bash">kubectl get po -n <span class="token operator">&lt;</span>命名空间<span class="token operator">&gt;</span>
kubectl logs <span class="token operator">&lt;</span>Pod名称<span class="token operator">&gt;</span> -n <span class="token operator">&lt;</span>命名空间<span class="token operator">&gt;</span>
kubectl logs <span class="token operator">&lt;</span>Pod名称<span class="token operator">&gt;</span> -n <span class="token operator">&lt;</span>命名空间<span class="token operator">&gt;</span> -f <span class="token comment">#实时查看</span>
</code></pre> 
<p>标准输出在宿主机的路径为</p> 
<pre><code class="prism language-bash">/var/lib/docker/containers/<span class="token operator">&lt;</span>container-id<span class="token operator">&gt;</span>/<span class="token operator">&lt;</span>container-id<span class="token operator">&gt;</span>-json.log
</code></pre> 
<p>查看容器ID的方法为</p> 
<pre><code class="prism language-bash">kubectl get pods -o wide
<span class="token comment">#到Pod所在节点查看容器ID</span>
<span class="token function">docker</span> <span class="token function">ps</span> <span class="token operator">|</span> <span class="token function">grep</span> web-demo1-5ff6d576bb-92gqk
</code></pre> 
<p>也可以进入容器终端日志目录查看日志</p> 
<pre><code class="prism language-bash">kubectl <span class="token builtin class-name">exec</span> -it <span class="token operator">&lt;</span>Pod名称<span class="token operator">&gt;</span> --bash
</code></pre> 
<p><strong>参考文章</strong><br> 【1】https://stackoverflow.com/questions/70362216/getting-error-while-implementing-metric-server-inside-the-kubernetes<br> 【2】https://github.com/kubernetes-sigs/metrics-server/releases</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c569b909fded47e2c342562dae52f0b3/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Redis经典面试题总结</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e0d8ae18abcf3dd5b16ff6d197ea29a5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Spring-Boot框架</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>