<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux下使用bash脚本监控程序并自动在screen中重启 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Linux下使用bash脚本监控程序并自动在screen中重启" />
<meta property="og:description" content="起因 最近写了一个爬取程序，但是时不时的会因为网络波动断掉，又经常想不起来取检查，因此有时候一断就是浪费了好几天的时间，因此多方查找总结，自己写了一个bash脚本，可以实现：
每隔一段时间检查一遍程序是否还在运行如果停止则自动在对应的screen窗口中运行对应的指令 监控脚本 #!/bin/sh CheckProcess() { if [ `ps -ef|grep $1 | grep -v grep |wc -l` -gt 0 ]; then echo &#34;${1}正在运行&#34; else echo &#34;$(date &#34;&#43;%Y-%m-%d %H:%M:%S&#34;) ${1}已停止&#34; echo &#34;正在重启${1}&#34; # 重启指令 fi } while [[ true ]]; do echo &#34;$(date &#34;&#43;%Y-%m-%d %H:%M:%S&#34;)&#34; do CheckProcess &#34;ProcessName&#34; done sleep 5m done 下面来对这段代码进行讲解：
首先来看 if 判断条件中的这句话
if [ `ps -ef|grep $1 | grep -v grep |wc -l` -gt 0 ] -gt是一个比较函数，意思是测试一个数是否大于另一个数；大于，为真；否则，为假。ps -ef|grep $1 | grep -v grep |wc -l的作用是打印出系统中所有包含参数 $1 的命令，例如我需要监控的程序的命令行输入为：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/84d710054e6b7d6baebd73a5ca0d2837/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-12-07T17:52:03+08:00" />
<meta property="article:modified_time" content="2021-12-07T17:52:03+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux下使用bash脚本监控程序并自动在screen中重启</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>起因</h3> 
<p>最近写了一个爬取程序，但是时不时的会因为网络波动断掉，又经常想不起来取检查，因此有时候一断就是浪费了好几天的时间，因此多方查找总结，自己写了一个bash脚本，可以实现：</p> 
<ol><li>每隔一段时间检查一遍程序是否还在运行</li><li>如果停止则自动在对应的screen窗口中运行对应的指令</li></ol> 
<h3><a id="_5"></a>监控脚本</h3> 
<pre><code class="prism language-bash"><span class="token shebang important">#!/bin/sh</span>
<span class="token function-name function">CheckProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>   
    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable"><span class="token variable">`</span><span class="token function">ps</span> -ef<span class="token operator">|</span><span class="token function">grep</span> $1 <span class="token operator">|</span> <span class="token function">grep</span> -v <span class="token function">grep</span> <span class="token operator">|</span><span class="token function">wc</span> -l<span class="token variable">`</span></span>  -gt <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">${1}</span>正在运行"</span>
    <span class="token keyword">else</span>
        <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> <span class="token string">"+%Y-%m-%d %H:%M:%S"</span><span class="token variable">)</span></span> <span class="token variable">${1}</span>已停止"</span>
        <span class="token builtin class-name">echo</span> <span class="token string">"正在重启<span class="token variable">${1}</span>"</span>
        <span class="token comment"># 重启指令</span>
    <span class="token keyword">fi</span>
<span class="token punctuation">}</span>

<span class="token keyword">while</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token boolean">true</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> <span class="token string">"+%Y-%m-%d %H:%M:%S"</span><span class="token variable">)</span></span>"</span>
    <span class="token keyword">do</span>
        CheckProcess <span class="token string">"ProcessName"</span>
    <span class="token keyword">done</span>
    <span class="token function">sleep</span> 5m
<span class="token keyword">done</span>
</code></pre> 
<p>下面来对这段代码进行讲解：<br> 首先来看 if 判断条件中的这句话</p> 
<pre><code class="prism language-bash"><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable"><span class="token variable">`</span><span class="token function">ps</span> -ef<span class="token operator">|</span><span class="token function">grep</span> $1 <span class="token operator">|</span> <span class="token function">grep</span> -v <span class="token function">grep</span> <span class="token operator">|</span><span class="token function">wc</span> -l<span class="token variable">`</span></span>  -gt <span class="token number">0</span> <span class="token punctuation">]</span>
</code></pre> 
<ul><li><code>-gt</code>是一个比较函数，意思是测试一个数是否大于另一个数；大于，为真；否则，为假。</li><li><code>ps -ef|grep $1 | grep -v grep |wc -l</code>的作用是打印出系统中所有包含参数 <code>$1</code> 的命令，例如我需要监控的程序的命令行输入为：<br> <code>python main.py 2019-01</code>，那么我此处的 $1 就可以设置为<code>2019-01</code>，这行命令就会打印出所有包含<code>2019-01</code>的命令的<strong>数量</strong></li><li>结合以上两条，如果我需要检测的命令能打印出来，说明程序正在运行，数量就会大于1，if会判断为真</li><li>Tips: 由于我的进程名比较特别不会有重复，如果你的进程名会和别的不要检测的进程名重复的话，建议修改一下代码换成监控pid，或者使用完整的进程</li></ul> 
<h3><a id="Screen_39"></a>在Screen中重启进程</h3> 
<p>由于同时要挂多个进程，因此使用了screen指令。<br> 使用以下命令可以在后台开启screen窗口并运行程序：<br> 首先使用<code>screen -R AAA</code>创建一个AAA的窗口<br> 然后使用</p> 
<pre><code class="prism language-bash"><span class="token function">screen</span> -x -S AAA -p <span class="token number">0</span> -X stuff <span class="token string">"你的命令<span class="token entity" title="\n">\n</span>"</span>
</code></pre> 
<p>即可在后台静默打开AAA窗口并运行命令来重启程序了。</p> 
<h3><a id="_50"></a>整合</h3> 
<p>建议分别打印前面两步的指令，验证一下是否和自己所想的一致，确认完毕以后就可以拼接作为一个监控脚本了：</p> 
<pre><code class="prism language-bash"><span class="token comment"># 首先创建脚本文件(并退出)</span>
<span class="token function">vim</span> monitor.sh
<span class="token comment"># 然后设置权限</span>
<span class="token function">chmod</span> +x monitor.sh
</code></pre> 
<p>接着将完整的指令输入<code>monitor.sh</code>中</p> 
<pre><code class="prism language-bash"><span class="token shebang important">#!/bin/sh</span>
<span class="token function-name function">CheckProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>   
    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable"><span class="token variable">`</span><span class="token function">ps</span> -ef<span class="token operator">|</span><span class="token function">grep</span> $1 <span class="token operator">|</span> <span class="token function">grep</span> -v <span class="token function">grep</span> <span class="token operator">|</span><span class="token function">wc</span> -l<span class="token variable">`</span></span>  -gt <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">${1}</span>正在运行"</span>
    <span class="token keyword">else</span>
        <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> <span class="token string">"+%Y-%m-%d %H:%M:%S"</span><span class="token variable">)</span></span> <span class="token variable">${1}</span>已停止"</span>      
        <span class="token builtin class-name">echo</span> <span class="token string">"正在重启<span class="token variable">${1}</span>"</span>
        <span class="token function">screen</span> -x -S AAA -p <span class="token number">0</span> -X stuff <span class="token string">"你的命令<span class="token entity" title="\n">\n</span>"</span>
    <span class="token keyword">fi</span>
<span class="token punctuation">}</span>

<span class="token keyword">while</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token boolean">true</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> <span class="token string">"+%Y-%m-%d %H:%M:%S"</span><span class="token variable">)</span></span>"</span>
    <span class="token keyword">do</span>
        CheckProcess <span class="token string">"ProcessName"</span>
    <span class="token keyword">done</span>
    <span class="token function">sleep</span> 5m
<span class="token keyword">done</span>
</code></pre> 
<p>然后就大功告成啦！</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2ae8f58fb5219c877752920fa2f36c9e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">java 什么是迭代器</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/301b9ebd2d721507c56db459a10e1b8c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Golang---interface</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>