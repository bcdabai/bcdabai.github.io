<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>php在windows使用grpc和protobuf入门（超详细） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="php在windows使用grpc和protobuf入门（超详细）" />
<meta property="og:description" content="背景：php作为客户端使用grpc和protobuf调用其他服务
1、自己先了解：grpc、protobuf
2、环境：php7.3、composer
设置php全局变量
php -version查看PHP版本是php7.3.4nts，所以要选（NTS）那个
3、给php安装grpc扩展
下载grpc扩展：
PECL :: Package :: gRPC 1.42.0 for Windows
或者根据自己的php版本去库里选择：https://pecl.php.net/package/gRPC
​
下载后解压，把php_grpc.dll这个文件复制到php\php7.3.4nts\ext这个目录下
​ 找到php.ini这个文件加入 extension=php_grpc.dll
​ phpstorm终端输入php -m 查看扩展是否安装成功；
或者用 var_dump(phpinfo()); 看看有没有
​
4、新建项目目录：protobuf_test
引入grpc和protobuf的PHP类库，在目录下新建文件composer.json，如下：
{ &#34;name&#34;: &#34;xxs/grpc&#34;, &#34;require&#34;: { &#34;grpc/grpc&#34;: &#34;^v1.4.0&#34;, &#34;google/protobuf&#34;: &#34;^v3.3.0&#34; }, &#34;autoload&#34;:{ &#34;psr-4&#34;:{ &#34;GPBMetadata\\&#34;:&#34;GPBMetadata/&#34;, &#34;Helloworld\\&#34;:&#34;Helloworld/&#34; } } } 【composer 需配置全局变量】在目录下执行composer install
顺带执行：composer dump-autoload
如下图，我这里执行完是1.52.0和3.22.2，composer ^ 符号的解释：php composer 版本号 ^ 与～_小镇学者的博客-CSDN博客
​
5、下载protoc.exe可执行程序
Releases · protocolbuffers/protobuf · GitHub
我下载的v22.2：https://github.com/protocolbuffers/protobuf/releases/download/v22.2/protoc-22.2-win64.zip" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/cb986ce6d99720dddb9e54a24af7f474/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-27T15:07:36+08:00" />
<meta property="article:modified_time" content="2023-03-27T15:07:36+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">php在windows使用grpc和protobuf入门（超详细）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p><strong>背景：php作为客户端使用grpc和protobuf调用其他服务</strong></p> 
<p></p> 
<p><strong>1、自己先了解：grpc、protobuf</strong></p> 
<p></p> 
<p><strong>2、环境：php7.3、composer</strong></p> 
<p>设置php全局变量</p> 
<p><img alt="" height="419" src="https://images2.imgbox.com/78/0e/Iw46ABxr_o.png" width="934"></p> 
<p><strong>php -version</strong>查看PHP版本是php7.3.4nts，所以要选（NTS）那个</p> 
<p><img alt="" height="86" src="https://images2.imgbox.com/fd/5b/OiTDf6Ak_o.png" width="927"></p> 
<p></p> 
<p><strong>3、给php安装grpc扩展</strong></p> 
<p>下载grpc扩展：</p> 
<p><a href="https://pecl.php.net/package/gRPC/1.42.0/windows" rel="nofollow" title="PECL :: Package :: gRPC 1.42.0 for Windows">PECL :: Package :: gRPC 1.42.0 for Windows</a></p> 
<p>或者根据自己的php版本去库里选择：<a href="https://pecl.php.net/package/gRPC/1.42.0/windows" rel="nofollow" title="https://pecl.php.net/package/gRPC">https://pecl.php.net/package/gRPC</a></p> 
<p><img alt="" height="109" src="https://images2.imgbox.com/54/d0/Q3lNfas5_o.png" width="934">​</p> 
<p>下载后解压，把<strong>php_grpc.dll</strong>这个文件复制到<strong>php\php7.3.4nts\ext</strong>这个目录下</p> 
<p><img alt="" height="208" src="https://images2.imgbox.com/32/ac/8KFCyewm_o.png" width="925">​ 找到php.ini这个文件加入 <strong>extension=php_grpc.dll</strong></p> 
<p><img alt="" height="189" src="https://images2.imgbox.com/15/1e/8ZFjqhZb_o.png" width="553">​ </p> 
<p>phpstorm终端输入<strong>php -m</strong> 查看扩展是否安装成功；</p> 
<p>或者用 var_dump(phpinfo()); 看看有没有</p> 
<p></p> 
<p><img alt="" height="458" src="https://images2.imgbox.com/fd/b0/tFhqiwgZ_o.png" width="904">​</p> 
<p></p> 
<p><strong>4、新建项目目录：protobuf_test</strong></p> 
<p>引入grpc和protobuf的PHP类库，在目录下新建文件<strong>composer.json</strong>，如下：</p> 
<div> 
 <pre><code>{
    "name": "xxs/grpc",
    "require": {
        "grpc/grpc": "^v1.4.0",
        "google/protobuf": "^v3.3.0"
    },
    "autoload":{
        "psr-4":{
            "GPBMetadata\\":"GPBMetadata/",
            "Helloworld\\":"Helloworld/"
        }
    }
}</code></pre> 
</div> 
<p>【composer 需配置全局变量】在目录下执行<strong>composer install</strong></p> 
<p>顺带执行：<strong>composer  dump-autoload</strong></p> 
<p>如下图，我这里执行完是1.52.0和3.22.2，composer ^ 符号的解释：<a href="https://blog.csdn.net/Kevin_Gates/article/details/127913793" title="php composer 版本号 ^ 与～_小镇学者的博客-CSDN博客">php composer 版本号 ^ 与～_小镇学者的博客-CSDN博客</a></p> 
<p><img alt="" height="386" src="https://images2.imgbox.com/b8/37/4BhvKeQx_o.png" width="934">​</p> 
<p></p> 
<p><strong>5、下载protoc.exe可执行程序</strong></p> 
<p><a href="https://github.com/protocolbuffers/protobuf/releases" title="Releases · protocolbuffers/protobuf · GitHub">Releases · protocolbuffers/protobuf · GitHub</a></p> 
<p>我下载的v22.2：<a href="https://github.com/protocolbuffers/protobuf/releases/download/v22.2/protoc-22.2-win64.zip" title="https://github.com/protocolbuffers/protobuf/releases/download/v22.2/protoc-22.2-win64.zip">https://github.com/protocolbuffers/protobuf/releases/download/v22.2/protoc-22.2-win64.zip</a></p> 
<p>解压后复制bin目录的路径，去配置全局变量，我的是D:\protoc22.2\bin</p> 
<p><img alt="" height="432" src="https://images2.imgbox.com/21/e9/L6RqLqrd_o.png" width="949">​ win+R打开cmd查看：<strong>protoc --version  </strong></p> 
<p></p> 
<p><strong>6、万事具备，只欠东风！！！</strong></p> 
<p>官方的grpc未提供windows下的php plugin的exe文件，这个用来生成客户端文件，看了一堆博客，几乎没有这一步……</p> 
<p>去这里下载 <a href="https://github.com/lifenglsf/grpc_for_windows" title="https://github.com/lifenglsf/grpc_for_windows">https://github.com/lifenglsf/grpc_for_windows</a></p> 
<p><img alt="" height="469" src="https://images2.imgbox.com/47/44/hBeQfwsA_o.png" width="949">​</p> 
<p>解压复制到项目底下grpc_for_windows/x64/grpc_php_plugin.exe</p> 
<p><img alt="" height="477" src="https://images2.imgbox.com/9d/e5/zBOT9q2w_o.png" width="930">​ </p> 
<p><strong>7、新建文件protobuf_test/helloworld.proto</strong></p> 
<div> 
 <pre><code>syntax = "proto3";
package helloworld;

// The greeting service definition.
service Greeter {
  // Sends a greeting
  rpc SayHello (HelloRequest) returns (HelloReply) {}

  rpc SayHelloStreamReply (HelloRequest) returns (stream HelloReply) {}
}

// The request message containing the user's name.
message HelloRequest {
  string name = 1;
}

// The response message containing the greetings
message HelloReply {
  string message = 1;
}</code></pre> 
</div> 
<p></p> 
<p><strong>8、终端protobuf_test下执行命令</strong></p> 
<div> 
 <pre><code>protoc --proto_path=. --php_out=. --grpc_out=. --plugin=protoc-gen-grpc=./grpc_for_windows/x64/grpc_php_plugin.exe ./helloworld.proto</code></pre> 
</div> 
<p>生成代码结构，如果没有grpc_php_plugin.exe这个插件是不会生成GreeterClient.php这个客户端文件的，我们的目的就是用php作为客户端调用服务的！</p> 
<p><img alt="" height="367" src="https://images2.imgbox.com/c0/be/RoygQtFe_o.png" width="457">​</p> 
<p></p> 
<p><strong>9、为了方便测试自己搞个测试服</strong></p> 
<p>定义服务protobuf_test/Helloworld/GreeterStub.php,如上图；代码如下:</p> 
<div> 
 <pre><code class="language-php">&lt;?php
namespace Helloworld;
/**
 * The greeting service definition.
 */
class GreeterStub {
    /**
     * Sends a greeting
     * @param \Helloworld\HelloRequest $request client request
     * @param \Grpc\ServerContext $context server request context
     * @return \Helloworld\HelloReply for response data, null if if error occured
     *     initial metadata (if any) and status (if not ok) should be set to $context
     */
    public function SayHello(
        \Helloworld\HelloRequest $request,
        \Grpc\ServerContext $context
    ): ?\Helloworld\HelloReply {
        $context-&gt;setStatus(\Grpc\Status::unimplemented());
        return null;
    }

    /**
     * Get the method descriptors of the service for server registration
     *
     * @return array of \Grpc\MethodDescriptor for the service methods
     */
    public final function getMethodDescriptors(): array
    {
        return [
            '/helloworld.Greeter/SayHello' =&gt; new \Grpc\MethodDescriptor(
                $this,
                'SayHello',
                '\Helloworld\HelloRequest',
                \Grpc\MethodDescriptor::UNARY_CALL
            ),
        ];
    }
}</code>
实现这个服务，protobuf_test/server.php
</pre> 
</div> 
<div> 
 <pre><code class="language-php">&lt;?php
require dirname(__FILE__) . '/vendor/autoload.php';
class Greeter extends Helloworld\GreeterStub
{
    public function SayHello(
        \Helloworld\HelloRequest $request,
        \Grpc\ServerContext $serverContext
    ): ?\Helloworld\HelloReply {
        $name = $request-&gt;getName();
        echo 'Received request: ' . $name . PHP_EOL;
        $response = new \Helloworld\HelloReply();
        $response-&gt;setMessage("Hello " . $name);
        return $response;
    }
}
$port = 50051;
$server = new \Grpc\RpcServer();
$server-&gt;addHttp2Port('0.0.0.0:'.$port);
$server-&gt;handle(new Greeter());
echo 'Listening on port :' . $port . PHP_EOL;
$server-&gt;run();</code></pre> 
</div> 
<p></p> 
<p><strong>10、protobuf_test/client.php 调用服务</strong></p> 
<div> 
 <pre><code class="language-php">&lt;?php
require dirname(__FILE__) . '/vendor/autoload.php';
function greet($hostname, $name)
{
    $client = new Helloworld\GreeterClient($hostname, [
        'credentials' =&gt; Grpc\ChannelCredentials::createInsecure(),
    ]);
    $request = new Helloworld\HelloRequest();
    $request-&gt;setName($name);
    list($response, $status) = $client-&gt;SayHello($request)-&gt;wait();
    if ($status-&gt;code !== Grpc\STATUS_OK) {
        echo "ERROR: " . $status-&gt;code . ", " . $status-&gt;details . PHP_EOL;
        exit(1);
    }
    echo $response-&gt;getMessage() . PHP_EOL;
}
$name = !empty($argv[1]) ? $argv[1] : 'world';
$hostname = !empty($argv[2]) ? $argv[2] : 'localhost:50051';
greet($hostname, $name);</code></pre> 
</div> 
<p><strong>11、最终文件结构</strong></p> 
<p><img alt="" height="822" src="https://images2.imgbox.com/5c/ca/VB7kH1me_o.png" width="314">​</p> 
<p></p> 
<p><strong>12、测试</strong></p> 
<p>开启服务：php server.php</p> 
<p><img alt="" height="169" src="https://images2.imgbox.com/70/2f/ITUqaSP2_o.png" width="779">​</p> 
<p> 在开一个终端：php client.php</p> 
<p><img alt="" height="172" src="https://images2.imgbox.com/bd/4a/qSV9mUkW_o.png" width="779">​</p> 
<p>得到响应 Hello world</p> 
<p></p> 
<p><strong>13、参数说明</strong></p> 
<p># --php_out php代码输出路径，里面包含request，response，client代码</p> 
<p># --proto_path="protos文件目录"</p> 
<p># --grpc_out GPBMetadata输出路径，用于保存.proto的二进制元数据</p> 
<p># --plugin 生成代码插件的类型与插件的绝对路径路径</p> 
<p></p> 
<p><strong>14、收工大吉</strong></p> 
<p>参考：</p> 
<p><a href="https://blog.csdn.net/weixin_39682289/article/details/118904033" title="gRPC（2）- PHP使用gRPC_php grpc_share_9527的博客-CSDN博客">gRPC（2）- PHP使用gRPC_php grpc_share_9527的博客-CSDN博客</a></p> 
<p><a href="https://blog.csdn.net/uisoul/article/details/90483050" title="PHP中使用gRPC客户端_grpc php 客户端_IM魂影的博客-CSDN博客">PHP中使用gRPC客户端_grpc php 客户端_IM魂影的博客-CSDN博客</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9f1f51a87faa278d8bc48ec677c025ac/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">PID参数解析&#43;调参经验笔记（经验法）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/07ea21670a9540495096009451de2e9b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Redis剖析 — 过期策略和内存淘汰机制</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>