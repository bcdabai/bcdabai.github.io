<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【IoT】分区表（Partition Tables）：ESP32 FLASH 分区功能简析 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【IoT】分区表（Partition Tables）：ESP32 FLASH 分区功能简析" />
<meta property="og:description" content="1、背景：
ESP32 是一款蓝牙与 WIFI 合一的 IoT 芯片，并且支持 OTA 在线升级功能，在实际产品开发过程中需要对 FLASH 分区定制才能更好地满足产品需求，做刚刚好的产品。
ESP32 系统可以运行多个应用程序，同时包括大量的数据（校正数据、文件系统、参数保存等），分区表存放在 FLASH 偏移地址 0x8000。
2、分区表简析
分区表长度为 0xC00 字节，最多支持 95 个分区入口，使用 MD5 校验，笔者使用的 ESP32 模组是 ESP-WROOM-32，该模组集成了 4MB SPI Flash，在编译esp32程序时，通过make menuconfig -&gt; PartitionTable 可以看到三种分区选择：
工厂程序（无OTA分区）：
偏移地址 0x10000 处存放出厂固件，bootloader 启动时默认加载该偏移地址应用程序
# Espressif ESP32 Partition Table # Name, Type, SubType, Offset, Size nvs, data, nvs, 0x9000, 0x6000 phy_init, data, phy, 0xf000, 0x1000 factory, app, factory, 0x10000, 1M 工厂程序（双OTA分区）：
otadata 分区存储 OTA 升级数据，用于启动时判断加载哪个入口的应用程序：factory、ota_0，ota_1" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/dc40576e568c5a66702a241820320660/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-07-15T12:18:48+08:00" />
<meta property="article:modified_time" content="2018-07-15T12:18:48+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【IoT】分区表（Partition Tables）：ESP32 FLASH 分区功能简析</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p><strong>1、背景：</strong></p> 
<p>ESP32 是一款蓝牙与 WIFI 合一的 IoT 芯片，并且支持 OTA 在线升级功能，在实际产品开发过程中需要对 FLASH 分区定制才能更好地满足产品需求，做刚刚好的产品。</p> 
<p>ESP32 系统可以运行多个应用程序，同时包括大量的数据（校正数据、文件系统、参数保存等），分区表存放在 FLASH 偏移地址 0x8000。</p> 
<p><strong>2、分区表简析</strong></p> 
<p> </p> 
<p>分区表长度为 0xC00 字节，最多支持 95 个分区入口，使用 MD5 校验，笔者使用的 ESP32 模组是 ESP-WROOM-32，该模组集成了 4MB SPI Flash，在编译esp32程序时，通过make menuconfig -&gt; PartitionTable 可以看到三种分区选择：</p> 
<p>工厂程序（无OTA分区）：</p> 
<p>偏移地址 0x10000 处存放出厂固件，bootloader 启动时默认加载该偏移地址应用程序</p> 
<pre class="has"><code class="language-html"># Espressif ESP32 Partition Table
# Name,   Type, SubType, Offset,  Size
nvs,      data, nvs,     0x9000,  0x6000
phy_init, data, phy,     0xf000,  0x1000
factory,  app,  factory, 0x10000, 1M</code></pre> 
<p>工厂程序（双OTA分区）：</p> 
<p>otadata 分区存储 OTA 升级数据，用于启动时判断加载哪个入口的应用程序：factory、ota_0，ota_1</p> 
<pre class="has"><code class="language-html"># Espressif ESP32 Partition Table
# Name,   Type, SubType, Offset,  Size
nvs,      data, nvs,     0x9000,  0x4000
otadata,  data, ota,     0xd000,  0x2000
phy_init, data, phy,     0xf000,  0x1000
factory,  0,    0,       0x10000, 1M
ota_0,    0,    ota_0,   ,        1M
ota_1,    0,    ota_1,   ,        1M</code></pre> 
<p>用户自定义分区：</p> 
<pre class="has"><code class="language-html"># Name,   Type, SubType, Offset,   Size
nvs,      data, nvs,     0x9000,  0x4000
otadata,  data, ota,     0xd000,  0x2000
phy_init, data, phy,     0xf000,  0x1000
factory,  app,  factory, 0x10000,  1M
ota_0,    app,  ota_0,   ,         1M
ota_1,    app,  ota_1,   ,         1M</code></pre> 
<p>menuconfig 中的配置只是修改配置文件中的宏，实际上 ESP32 SDK 对应 FLASH 分区配置的源码路径是：</p> 
<p>\esp-idf\components\partition_table</p> 
<p>该路径下有文件：</p> 
<p>partitions_singleapp</p> 
<p>partitions_singleapp_coredump</p> 
<p>partitions_two_ota</p> 
<p>partitions_two_ota_coredump</p> 
<p>都是用来对Flash分区进行配置的。</p> 
<p>以 partitions_two_ota_coredump 为例，使用 partitions_two_ota_coredump 配置分区时4M SPI Flash的分区情况如下图所示：  </p> 
<p><img alt="" class="has" src="https://images2.imgbox.com/82/9d/owXon24R_o.png"></p> 
<p><strong>3、生成分区二进制文件</strong></p> 
<p>分区文件是 CSV 格式，但是需要生成二进制文件才能被写入 FLASH，工具 <a class="reference external" href="https://github.com/espressif/esp-idf/blob/be81d2c/components/partition_table/gen_esp32part.py">gen_esp32part.py</a> 被用于文件转化（CVS 和 二进制）。</p> 
<p>转化 CVS 为二进制文件：</p> 
<pre class="has"><code class="language-html">python gen_esp32part.py input_partitions.csv binary_partitions.bin</code></pre> 
<p>转化二进制为 CVS 文件：</p> 
<pre class="has"><code class="language-html">python gen_esp32part.py binary_partitions.bin input_partitions.csv</code></pre> 
<p> </p> 
<p>refer：</p> 
<p>https://esp-idf.readthedocs.io/en/latest/api-guides/partition-tables.html</p> 
<p>https://blog.csdn.net/abc517789065/article/details/79891568</p> 
<p>https://github.com/espressif/esp-idf/blob/be81d2c/components/partition_table/gen_esp32part.py</p> 
<p> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c5c3a677d34774fa167225eb86607656/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">深入浅出 VuePress（一）：如何做到在 Markdown 中使用 Vue 语法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/120e6e678a09416af64f7afda8c6f5c4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">常见的HTTP状态码(HTTP Status Code)说明</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>