<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>mysql mgr 启动_使用MySQL Shell创建MGR - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="mysql mgr 启动_使用MySQL Shell创建MGR" />
<meta property="og:description" content="本篇知识点：
配置MGR所需的参数
使用MySQL Shell配置MGR
shell.connect()
var 设定临时变量
dba.createCluster()
dba.getCluster()
dba.addInstance()
dba.removeInstance()
dba.switchToMultiPrimaryMode()
dba.switchToSinglePrimaryMode()
完全依靠MySQL Shell自动生成参数究竟靠不靠谱？
MGR 原理探索
环境信息
IPportroleinfo
192.168.188.81
3306
node1
null
192.168.188.82
3306
node2
null
192.168.188.83
3306
node3
null
CentOS Linux release 7.6.1810 (Core)
MySQL Ver 8.0.20 for Linux on x86_64 (MySQL Community Server - GPL)
MySQL Router Ver 8.0.20 for Linux on x86_64 (MySQL Community - GPL)
MySQL Shell Ver 8.0.20 for Linux on x86_64 - for MySQL 8." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/d1e1954da1e8a27e8b347e775fc6ddbf/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-02-07T10:20:31+08:00" />
<meta property="article:modified_time" content="2021-02-07T10:20:31+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">mysql mgr 启动_使用MySQL Shell创建MGR</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div style="font-size:16px;"> 
 <p>本篇知识点：</p> 
 <p>配置MGR所需的参数</p> 
 <p>使用MySQL Shell配置MGR</p> 
 <p>shell.connect()</p> 
 <p>var 设定临时变量</p> 
 <p>dba.createCluster()</p> 
 <p>dba.getCluster()</p> 
 <p>dba.addInstance()</p> 
 <p>dba.removeInstance()</p> 
 <p>dba.switchToMultiPrimaryMode()</p> 
 <p>dba.switchToSinglePrimaryMode()</p> 
 <p>完全依靠MySQL Shell自动生成参数究竟靠不靠谱？</p> 
 <p>MGR 原理探索</p> 
 <p>环境信息</p> 
 <p>IPportroleinfo</p> 
 <p>192.168.188.81</p> 
 <p>3306</p> 
 <p>node1</p> 
 <p>null</p> 
 <p>192.168.188.82</p> 
 <p>3306</p> 
 <p>node2</p> 
 <p>null</p> 
 <p>192.168.188.83</p> 
 <p>3306</p> 
 <p>node3</p> 
 <p>null</p> 
 <p>CentOS Linux release 7.6.1810 (Core)</p> 
 <p>MySQL Ver 8.0.20 for Linux on x86_64 (MySQL Community Server - GPL)</p> 
 <p>MySQL Router Ver 8.0.20 for Linux on x86_64 (MySQL Community - GPL)</p> 
 <p>MySQL Shell Ver 8.0.20 for Linux on x86_64 - for MySQL 8.0.20 (MySQL Community Server (GPL))</p> 
 <p>软件位置</p> 
 <p>在三个节点上部署好MySQL、MySQL Router、MySQL Shell。</p> 
 <p>[[email protected] opt]# ln -s /opt/mysql-router-8.0.20-linux-glibc2.12-x86_64 /usr/local/myrouter</p> 
 <p>[[email protected] opt]# ln -s /opt/mysql-shell-8.0.20-linux-glibc2.12-x86-64bit /usr/local/mysh</p> 
 <p>[[email protected] opt]# ln -s /opt/mysql-8.0.20-linux-glibc2.12-x86_64 /usr/local/mysql</p> 
 <p>[[email protected] opt]# ll /usr/local/</p> 
 <p>total 40</p> 
 <p>drwxr-xr-x 2 root root 4096 Apr 11 2018 bin</p> 
 <p>drwxr-xr-x 2 root root 4096 Apr 11 2018 etc</p> 
 <p>drwxr-xr-x 2 root root 4096 Apr 11 2018 games</p> 
 <p>drwxr-xr-x 2 root root 4096 Apr 11 2018 include</p> 
 <p>drwxr-xr-x 2 root root 4096 Apr 11 2018 lib</p> 
 <p>drwxr-xr-x 2 root root 4096 Apr 11 2018 lib64</p> 
 <p>drwxr-xr-x 2 root root 4096 Apr 11 2018 libexec</p> 
 <p>lrwxrwxrwx 1 root root 47 May 3 20:18 myrouter -&gt; /opt/mysql-router-8.0.20-linux-glibc2.12-x86_64</p> 
 <p>lrwxrwxrwx 1 root root 49 May 3 20:18 mysh -&gt; /opt/mysql-shell-8.0.20-linux-glibc2.12-x86-64bit</p> 
 <p>lrwxrwxrwx 1 root root 41 May 3 20:12 mysql -&gt; /opt/mysql-8.0.20-linux-glibc2.12-x86_64/</p> 
 <p>drwxr-xr-x 2 root root 4096 Apr 11 2018 sbin</p> 
 <p>drwxr-xr-x 5 root root 4096 Dec 4 2018 share</p> 
 <p>drwxr-xr-x 2 root root 4096 Apr 11 2018 src</p> 
 <p>配置MySQL参数</p> 
 <p>以支持启用MGR.</p> 
 <p>[[email protected] ~]# uuidgen</p> 
 <p>78cba89c-7a2c-4442-ba43-51aa387a4fd0</p> 
 <p>## add to my3306.cnf</p> 
 <p>binlog_checksum=none</p> 
 <p>binlog_transaction_dependency_tracking=WRITESET</p> 
 <p>transaction_write_set_extraction=XXHASH64</p> 
 <p>loose-group_replication_group_name="78cba89c-7a2c-4442-ba43-51aa387a4fd0" #must be use UUID format</p> 
 <p>loose-group_replication_start_on_boot=off</p> 
 <p>loose-group_replication_local_address="192.168.188.81:13306"</p> 
 <p>loose-group_replication_group_seeds="192.168.188.81:13306,192.168.188.82:13306,192.168.188.83:13306"</p> 
 <p>loose-group_replication_bootstrap_group=off</p> 
 <p>启动实例。</p> 
 <p>配置数据库</p> 
 <p>以下操作需要在所有节点进行。</p> 
 <p>[[email protected] ~]# mysql -S /data/mysql/mysql3306/tmp/mysql.sock</p> 
 <p>mysql&gt; set global super_read_only=0;</p> 
 <p>Query OK, 0 rows affected (0.00 sec)</p> 
 <p>mysql&gt; create user [email protected]%‘ identified by ‘kk‘;</p> 
 <p>Query OK, 0 rows affected (0.02 sec)</p> 
 <p>mysql&gt; grant all privileges on *.* to [email protected]%‘ with grant option;</p> 
 <p>Query OK, 0 rows affected (0.02 sec)</p> 
 <p>mysql&gt; reset master;</p> 
 <p>Query OK, 0 rows affected (0.04 sec)</p> 
 <p>使用MySQL Shell配置MGR</p> 
 <p>操作只需要在node1上操作即可。</p> 
 <p>[[email protected] ~]# mysqlsh</p> 
 <p>\MySQL Shell 8.0.20</p> 
 <p>Copyright (c) 2016, 2020, Oracle and/or its affiliates. All rights reserved.</p> 
 <p>Oracle is a registered trademark of Oracle Corporation and/or its affiliates.</p> 
 <p>Other names may be trademarks of their respective owners.</p> 
 <p>Type ‘\help‘ or ‘\?‘ for help; ‘\quit‘ to exit.</p> 
 <p>MySQL JS &gt;</p> 
 <p>不要慌。mysh支持tab补齐。</p> 
 <p>下面开始配置</p> 
 <p>MySQL JS &gt; shell.connect([email protected]:3306‘) #连接到实例</p> 
 <p>Creating a session to [email protected]:3306‘</p> 
 <p>Please provide the password for [email protected]:3306‘: **</p> 
 <p>Save password for [email protected]:3306‘? [Y]es/[N]o/Ne[v]er (default No): y</p> 
 <p>Fetching schema names for autocompletion... Press ^C to stop.</p> 
 <p>Your MySQL connection id is 10</p> 
 <p>Server version: 8.0.20 MySQL Community Server - GPL</p> 
 <p>No default schema selected; type \use to set one.</p> 
 <p>MySQL 192.168.188.81:3306 ssl JS &gt; var c = dba.createCluster(‘kkcc‘) #创建cluster</p> 
 <p>A new InnoDB cluster will be created on instance ‘192.168.188.81:3306‘.</p> 
 <p>Validating instance configuration at 192.168.188.81:3306...</p> 
 <p>This instance reports its own address as ms81:3306</p> 
 <p>Instance configuration is suitable.</p> 
 <p>NOTE: Group Replication will communicate with other members using ‘ms81:33061‘. Use the localAddress option to override.</p> 
 <p>Creating InnoDB cluster ‘kkcc‘ on ‘ms81:3306‘...</p> 
 <p>Adding Seed Instance...</p> 
 <p>Cluster successfully created. Use Cluster.addInstance() to add MySQL instances.</p> 
 <p>At least 3 instances are needed for the cluster to be able to withstand up to</p> 
 <p>one server failure.</p> 
 <p>MySQL 192.168.188.81:3306 ssl JS &gt; c. #试一下tab补齐</p> 
 <p>addInstance() listRouters() setInstanceOption()</p> 
 <p>checkInstanceState() name setOption()</p> 
 <p>describe() options() setPrimaryInstance()</p> 
 <p>disconnect() rejoinInstance() setupAdminAccount()</p> 
 <p>dissolve() removeInstance() setupRouterAccount()</p> 
 <p>forceQuorumUsingPartitionOf() removeRouterMetadata() status()</p> 
 <p>getName() rescan() switchToMultiPrimaryMode()</p> 
 <p>help() resetRecoveryAccountsPassword() switchToSinglePrimaryMode()</p> 
 <p>MySQL 192.168.188.81:3306 ssl JS &gt; c.addInstance([email protected]:3306‘)#添加节点到集群</p> 
 <p>Please provide the password for [email protected]:3306‘: **</p> 
 <p>Save password for [email protected]:3306‘? [Y]es/[N]o/Ne[v]er (default No): y</p> 
 <p>NOTE: The target instance ‘ms82:3306‘ has not been pre-provisioned (GTID set is empty). The Shell is unable to decide whether incremental state recovery can correctly provision it.</p> 
 <p>The safest and most convenient way to provision a new instance is through automatic clone provisioning, which will completely overwrite the state of ‘ms82:3306‘ with a physical snapshot from an existing cluster member. To use this method by default, set the ‘recoveryMethod‘ option to ‘clone‘.</p> 
 <p>The incremental state recovery may be safely used if you are sure all updates ever executed in the cluster were done with GTIDs enabled, there are no purged transactions and the new instance contains the same GTID set as the cluster or a subset of it. To use this method by default, set the ‘recoveryMethod‘ option to ‘incremental‘.</p> 
 <p>Please select a recovery method [C]lone/[I]ncremental recovery/[A]bort (default Clone): C</p> 
 <p>NOTE: Group Replication will communicate with other members using ‘ms82:33061‘. Use the localAddress option to override.</p> 
 <p>Validating instance configuration at 192.168.188.82:3306...</p> 
 <p>This instance reports its own address as ms82:3306</p> 
 <p>Instance configuration is suitable.</p> 
 <p>A new instance will be added to the InnoDB cluster. Depending on the amount of</p> 
 <p>data on the cluster this might take from a few seconds to several hours.</p> 
 <p>Adding instance to the cluster...</p> 
 <p>Monitoring recovery process of the new cluster member. Press ^C to stop monitoring and let it continue in background.</p> 
 <p>Clone based state recovery is now in progress.</p> 
 <p>NOTE: A server restart is expected to happen as part of the clone process. If the</p> 
 <p>server does not support the RESTART command or does not come back after a</p> 
 <p>while, you may need to manually start it back.</p> 
 <p>* Waiting for clone to finish...</p> 
 <p>NOTE: ms82:3306 is being cloned from ms81:3306</p> 
 <p>** Stage DROP DATA: Completed</p> 
 <p>** Clone Transfer</p> 
 <p>FILE COPY ############################################################ 100% Completed</p> 
 <p>PAGE COPY ############################################################ 100% Completed</p> 
 <p>REDO COPY ############################################################ 100% Completed</p> 
 <p>NOTE: ms82:3306 is shutting down...</p> 
 <p>##############然后等待一会……漫长的等待</p> 
 <p>##############结果出现了奇怪的提示：</p> 
 <p>* Waiting for server restart... timeout</p> 
 <p>WARNING: Clone process appears to have finished and tried to restart the MySQL server, but it has not yet started back up.</p> 
 <p>Please make sure the MySQL server at ‘ms82:3306‘ is restarted and call .rescan() to complete the process. To increase the timeout, change shell.options["dba.restartWaitTimeout"].</p> 
 <p>Cluster.addInstance: Timeout waiting for server to restart (MYSQLSH 51156)</p> 
 <p>MySQL实例自己完成Clone，而后重启，然而重启失败。</p> 
 <p>仔细想想，mysqld启动的服务进程怎么做到重启呢？ 后经过查询得知，该提示并不是失败，只是没有监控进程重启mysqld而已。 那么用mysqld_safe是不是就好了？一会试一下。</p> 
 <p>查看一下状态</p> 
 <p>MySQL 192.168.188.81:3306 ssl JS &gt; c.status()</p> 
 <p>{<!-- --></p> 
 <p>"clusterName": "kkcc",</p> 
 <p>"defaultReplicaSet": {<!-- --></p> 
 <p>"name": "default",</p> 
 <p>"primary": "ms81:3306",</p> 
 <p>"ssl": "REQUIRED",</p> 
 <p>"status": "OK_NO_TOLERANCE",</p> 
 <p>"statusText": "Cluster is NOT tolerant to any failures.",</p> 
 <p>"topology": {<!-- --></p> 
 <p>"ms81:3306": {<!-- --></p> 
 <p>"address": "ms81:3306",</p> 
 <p>"mode": "R/W",</p> 
 <p>"readReplicas": {},</p> 
 <p>"replicationLag": null,</p> 
 <p>"role": "HA",</p> 
 <p>"status": "ONLINE",</p> 
 <p>"version": "8.0.20"</p> 
 <p>}</p> 
 <p>},</p> 
 <p>"topologyMode": "Single-Primary"</p> 
 <p>},</p> 
 <p>"groupInformationSourceMember": "ms81:3306"</p> 
 <p>}</p> 
 <p>MySQL 192.168.188.81:3306 ssl JS &gt;</p> 
 <p>手动去node2上启动mysqld</p> 
 <p>[[email protected] ~]# mysqld --defaults-file=/data/mysql/mysql3306/my3306.cnf &amp;</p> 
 <p>再回来node1上使用mysh查询MGR状态</p> 
 <p>MySQL 192.168.188.81:3306 ssl JS &gt; c.status()</p> 
 <p>{<!-- --></p> 
 <p>"clusterName": "kkcc",</p> 
 <p>"defaultReplicaSet": {<!-- --></p> 
 <p>"name": "default",</p> 
 <p>"primary": "ms81:3306",</p> 
 <p>"ssl": "REQUIRED",</p> 
 <p>"status": "OK_NO_TOLERANCE",</p> 
 <p>"statusText": "Cluster is NOT tolerant to any failures.",</p> 
 <p>"topology": {<!-- --></p> 
 <p>"ms81:3306": {<!-- --></p> 
 <p>"address": "ms81:3306",</p> 
 <p>"mode": "R/W",</p> 
 <p>"readReplicas": {},</p> 
 <p>"replicationLag": null,</p> 
 <p>"role": "HA",</p> 
 <p>"status": "ONLINE",</p> 
 <p>"version": "8.0.20"</p> 
 <p>}</p> 
 <p>},</p> 
 <p>"topologyMode": "Single-Primary"</p> 
 <p>},</p> 
 <p>"groupInformationSourceMember": "ms81:3306"</p> 
 <p>}</p> 
 <p>怎么回事呢？没加上？ 重加一下试试</p> 
 <p>MySQL 192.168.188.81:3306 ssl JS &gt; c.addInstance([email protected]:3306‘)</p> 
 <p>ERROR: Instance ‘ms82:3306‘ is part of the Group Replication group but is not in the metadata. Please use .rescan() to update the metadata.</p> 
 <p>Cluster.addInstance: Metadata inconsistent (RuntimeError)</p> 
 <p>不得不说mysh做的还不错，提示信息非常给力。</p> 
 <p>MySQL 192.168.188.81:3306 ssl JS &gt; c.rescan()</p> 
 <p>Rescanning the cluster...</p> 
 <p>Result of the rescanning operation for the ‘kkcc‘ cluster:</p> 
 <p>{<!-- --></p> 
 <p>"name": "kkcc",</p> 
 <p>"newTopologyMode": null,</p> 
 <p>"newlyDiscoveredInstances": [</p> 
 <p>{<!-- --></p> 
 <p>"host": "ms82:3306",</p> 
 <p>"member_id": "12a0149c-8d3a-11ea-b02e-0242c0a8bc52",</p> 
 <p>"name": null,</p> 
 <p>"version": "8.0.20"</p> 
 <p>}</p> 
 <p>],</p> 
 <p>"unavailableInstances": []</p> 
 <p>}</p> 
 <p>A new instance ‘ms82:3306‘ was discovered in the cluster.</p> 
 <p>Would you like to add it to the cluster metadata? [Y/n]: y</p> 
 <p>Adding instance to the cluster metadata...</p> 
 <p>The instance ‘ms82:3306‘ was successfully added to the cluster metadata.</p> 
 <p>MySQL 192.168.188.81:3306 ssl JS &gt; c.status()</p> 
 <p>{<!-- --></p> 
 <p>"clusterName": "kkcc",</p> 
 <p>"defaultReplicaSet": {<!-- --></p> 
 <p>"name": "default",</p> 
 <p>"primary": "ms81:3306",</p> 
 <p>"ssl": "REQUIRED",</p> 
 <p>"status": "OK_NO_TOLERANCE",</p> 
 <p>"statusText": "Cluster is NOT tolerant to any failures.",</p> 
 <p>"topology": {<!-- --></p> 
 <p>"ms81:3306": {<!-- --></p> 
 <p>"address": "ms81:3306",</p> 
 <p>"mode": "R/W",</p> 
 <p>"readReplicas": {},</p> 
 <p>"replicationLag": null,</p> 
 <p>"role": "HA",</p> 
 <p>"status": "ONLINE",</p> 
 <p>"version": "8.0.20"</p> 
 <p>},</p> 
 <p>"ms82:3306": {<!-- --></p> 
 <p>"address": "ms82:3306",</p> 
 <p>"mode": "R/O",</p> 
 <p>"readReplicas": {},</p> 
 <p>"replicationLag": null,</p> 
 <p>"role": "HA",</p> 
 <p>"status": "ONLINE",</p> 
 <p>"version": "8.0.20"</p> 
 <p>}</p> 
 <p>},</p> 
 <p>"topologyMode": "Single-Primary"</p> 
 <p>},</p> 
 <p>"groupInformationSourceMember": "ms81:3306"</p> 
 <p>}</p> 
 <p>就是这么简单？！</p> 
 <p>故技重施，将node3加进来。 在这里我决定验证一下自己的猜测，将node3使用mysqld_safe的方式启动后，再加入集群。</p> 
 <p>[[email protected] ~]# mysqld_safe --defaults-file=/data/mysql/mysql3306/my3306.cnf &amp;</p> 
 <p>[2] 68</p> 
 <p>[[email protected] ~]# 2020-05-03T12:49:40.439139Z mysqld_safe Logging to ‘/data/mysql/mysql3306/logs/error.log‘.</p> 
 <p>2020-05-03T12:49:40.471550Z mysqld_safe Starting mysqld daemon with databases from /data/mysql/mysql3306/data</p> 
 <p>[[email protected] ~]# mysql -S /data/mysql/mysql3306/tmp/mysql.sock</p> 
 <p>mysql&gt; set global super_read_only=0;</p> 
 <p>Query OK, 0 rows affected (0.00 sec)</p> 
 <p>MySQL 192.168.188.81:3306 ssl JS &gt; c.addInstance([email protected]:3306‘)</p> 
 <p>NOTE: The target instance ‘ms83:3306‘ has not been pre-provisioned (GTID set is empty). The Shell is unable to decide whether incremental state recovery can correctly provision it.</p> 
 <p>The safest and most convenient way to provision a new instance is through automatic clone provisioning, which will completely overwrite the state of ‘ms83:3306‘ with a physical snapshot from an existing cluster member. To use this method by default, set the ‘recoveryMethod‘ option to ‘clone‘.</p> 
 <p>The incremental state recovery may be safely used if you are sure all updates ever executed in the cluster were done with GTIDs enabled, there are no purged transactions and the new instance contains the same GTID set as the cluster or a subset of it. To use this method by default, set the ‘recoveryMethod‘ option to ‘incremental‘.</p> 
 <p>Please select a recovery method [C]lone/[I]ncremental recovery/[A]bort (default Clone): C</p> 
 <p>NOTE: Group Replication will communicate with other members using ‘ms83:33061‘. Use the localAddress option to override.</p> 
 <p>Validating instance configuration at 192.168.188.83:3306...</p> 
 <p>This instance reports its own address as ms83:3306</p> 
 <p>Instance configuration is suitable.</p> 
 <p>A new instance will be added to the InnoDB cluster. Depending on the amount of</p> 
 <p>data on the cluster this might take from a few seconds to several hours.</p> 
 <p>Adding instance to the cluster...</p> 
 <p>ERROR: Unable to enable clone on the instance ‘ms82:3306‘: Recovery user ‘mysql_innodb_cluster_813306‘ not created by InnoDB Cluster</p> 
 <p>Monitoring recovery process of the new cluster member. Press ^C to stop monitoring and let it continue in background.</p> 
 <p>WARNING: Error while waiting for recovery of the added instance: MySQL Error 2013: Lost connection to MySQL server at ‘reading initial communication packet‘, system error: 104</p> 
 <p>Cluster.addInstance: Cannot set Group Replication recovery user to ‘mysql_innodb_cluster_833306‘. Error executing CHANGE MASTER statement: ms83:3306: MySQL server has gone away (RuntimeError)</p> 
 <p>mysql&gt; select user,host from mysql.user;</p> 
 <p>+-----------------------------+-----------+</p> 
 <p>| user | host |</p> 
 <p>+-----------------------------+-----------+</p> 
 <p>| kk | % |</p> 
 <p>| mysql_innodb_cluster_813306 | % |</p> 
 <p>| mysql.infoschema | localhost |</p> 
 <p>| mysql.session | localhost |</p> 
 <p>| mysql.sys | localhost |</p> 
 <p>| root | localhost |</p> 
 <p>+-----------------------------+-----------+</p> 
 <p>6 rows in set (0.00 sec)</p> 
 <p>不得其解。</p> 
 <p>准备通过跟踪node3的mysql日志，所以使用removeInstance() ，再重新添加回来。</p> 
 <p>MySQL 192.168.188.81:3306 ssl JS &gt; c.removeInstance([email protected]:3306‘)</p> 
 <p>The instance will be removed from the InnoDB cluster. Depending on the instance</p> 
 <p>being the Seed or not, the Metadata session might become invalid. If so, please</p> 
 <p>start a new session to the Metadata Storage R/W instance.</p> 
 <p>Instance ‘192.168.188.83:3306‘ is attempting to leave the cluster...</p> 
 <p>The instance ‘192.168.188.83:3306‘ was successfully removed from the cluster.</p> 
 <p>MySQL 192.168.188.81:3306 ssl JS &gt; c.addInstance([email protected]:3306‘)</p> 
 <p>The safest and most convenient way to provision a new instance is through automatic clone provisioning, which will completely overwrite the state of ‘ms83:3306‘ with a physical snapshot from an existing cluster member. To use this method by default, set the ‘recoveryMethod‘ option to ‘clone‘.</p> 
 <p>The incremental state recovery may be safely used if you are sure all updates ever executed in the cluster were done with GTIDs enabled, there are no purged transactions and the new instance contains the same GTID set as the cluster or a subset of it. To use this method by default, set the ‘recoveryMethod‘ option to ‘incremental‘.</p> 
 <p>Incremental state recovery was selected because it seems to be safely usable.</p> 
 <p>NOTE: Group Replication will communicate with other members using ‘ms83:33061‘. Use the localAddress option to override.</p> 
 <p>Validating instance configuration at 192.168.188.83:3306...</p> 
 <p>This instance reports its own address as ms83:3306</p> 
 <p>Instance configuration is suitable.</p> 
 <p>A new instance will be added to the InnoDB cluster. Depending on the amount of</p> 
 <p>data on the cluster this might take from a few seconds to several hours.</p> 
 <p>Adding instance to the cluster...</p> 
 <p>Monitoring recovery process of the new cluster member. Press ^C to stop monitoring and let it continue in background.</p> 
 <p>State recovery already finished for ‘ms83:3306‘</p> 
 <p>The instance ‘192.168.188.83:3306‘ was successfully added to the cluster.</p> 
 <p>结果成功了？ ？？？？？</p> 
 <p>查看下集群状态 有些不可思议。这东西看来还是薛定谔的successful。</p> 
 <p>MySQL 192.168.188.81:3306 ssl JS &gt; c.status()</p> 
 <p>{<!-- --></p> 
 <p>"clusterName": "kkcc",</p> 
 <p>"defaultReplicaSet": {<!-- --></p> 
 <p>"name": "default",</p> 
 <p>"primary": "ms81:3306",</p> 
 <p>"ssl": "REQUIRED",</p> 
 <p>"status": "OK",</p> 
 <p>"statusText": "Cluster is ONLINE and can tolerate up to ONE failure.",</p> 
 <p>"topology": {<!-- --></p> 
 <p>"ms81:3306": {<!-- --></p> 
 <p>"address": "ms81:3306",</p> 
 <p>"mode": "R/W",</p> 
 <p>"readReplicas": {},</p> 
 <p>"replicationLag": null,</p> 
 <p>"role": "HA",</p> 
 <p>"status": "ONLINE",</p> 
 <p>"version": "8.0.20"</p> 
 <p>},</p> 
 <p>"ms82:3306": {<!-- --></p> 
 <p>"address": "ms82:3306",</p> 
 <p>"mode": "R/W",</p> 
 <p>"readReplicas": {},</p> 
 <p>"replicationLag": null,</p> 
 <p>"role": "HA",</p> 
 <p>"status": "ONLINE",</p> 
 <p>"version": "8.0.20"</p> 
 <p>},</p> 
 <p>"ms83:3306": {<!-- --></p> 
 <p>"address": "ms83:3306",</p> 
 <p>"mode": "R/O",</p> 
 <p>"readReplicas": {},</p> 
 <p>"replicationLag": null,</p> 
 <p>"role": "HA",</p> 
 <p>"status": "ONLINE",</p> 
 <p>"version": "8.0.20"</p> 
 <p>}</p> 
 <p>},</p> 
 <p>"topologyMode": "Single-Primary"</p> 
 <p>},</p> 
 <p>"groupInformationSourceMember": "ms81:3306"</p> 
 <p>}</p> 
 <p>MySQL 192.168.188.81:3306 ssl JS &gt;</p> 
 <p>node3刚才忘了关闭super read only， 关闭后再查看集群状态</p> 
 <p>MySQL 192.168.188.81:3306 ssl JS &gt; c.status()</p> 
 <p>{<!-- --></p> 
 <p>"clusterName": "kkcc",</p> 
 <p>"defaultReplicaSet": {<!-- --></p> 
 <p>"name": "default",</p> 
 <p>"primary": "ms81:3306",</p> 
 <p>"ssl": "REQUIRED",</p> 
 <p>"status": "OK",</p> 
 <p>"statusText": "Cluster is ONLINE and can tolerate up to ONE failure.",</p> 
 <p>"topology": {<!-- --></p> 
 <p>"ms81:3306": {<!-- --></p> 
 <p>"address": "ms81:3306",</p> 
 <p>"mode": "R/W",</p> 
 <p>"readReplicas": {},</p> 
 <p>"replicationLag": null,</p> 
 <p>"role": "HA",</p> 
 <p>"status": "ONLINE",</p> 
 <p>"version": "8.0.20"</p> 
 <p>},</p> 
 <p>"ms82:3306": {<!-- --></p> 
 <p>"address": "ms82:3306",</p> 
 <p>"mode": "R/W",</p> 
 <p>"readReplicas": {},</p> 
 <p>"replicationLag": null,</p> 
 <p>"role": "HA",</p> 
 <p>"status": "ONLINE",</p> 
 <p>"version": "8.0.20"</p> 
 <p>},</p> 
 <p>"ms83:3306": {<!-- --></p> 
 <p>"address": "ms83:3306",</p> 
 <p>"mode": "R/W",</p> 
 <p>"readReplicas": {},</p> 
 <p>"replicationLag": null,</p> 
 <p>"role": "HA",</p> 
 <p>"status": "ONLINE",</p> 
 <p>"version": "8.0.20"</p> 
 <p>}</p> 
 <p>},</p> 
 <p>"topologyMode": "Single-Primary"</p> 
 <p>},</p> 
 <p>"groupInformationSourceMember": "ms81:3306"</p> 
 <p>}</p> 
 <p>这时候我发现node1的mysql datadir中的自动参数文件有了变化：</p> 
 <p>[[email protected] tmp]# cat !$</p> 
 <p>cat mysqld-auto.cnf</p> 
 <p>{<!-- --></p> 
 <p>"Version" : 1 ,</p> 
 <p>"mysql_server" : {<!-- --></p> 
 <p>"super_read_only" : {<!-- --></p> 
 <p>"Value" : "ON" ,</p> 
 <p>"Metadata" : {<!-- --></p> 
 <p>"Timestamp" : 1588509644223646 , "User" : "kk" , "Host" : "ms81" } } ,</p> 
 <p>"auto_increment_increment" : {<!-- --></p> 
 <p>"Value" : "1" ,</p> 
 <p>"Metadata" : {<!-- --></p> 
 <p>"Timestamp" : 1588509644226925 , "User" : "kk" , "Host" : "ms81" } } ,</p> 
 <p>"auto_increment_offset" : {<!-- --></p> 
 <p>"Value" : "2" ,</p> 
 <p>"Metadata" : {<!-- --></p> 
 <p>"Timestamp" : 1588509644227187 , "User" : "kk" , "Host" : "ms81" } } ,</p> 
 <p>"mysql_server_static_options" : {<!-- --></p> 
 <p>"group_replication_enforce_update_everywhere_checks" : {<!-- --></p> 
 <p>"Value" : "OFF" ,</p> 
 <p>"Metadata" : {<!-- --></p> 
 <p>"Timestamp" : 1588509644225058 , "User" : "kk" , "Host" : "ms81" } } ,</p> 
 <p>"group_replication_exit_state_action" : {<!-- --></p> 
 <p>"Value" : "READ_ONLY" ,</p> 
 <p>"Metadata" : {<!-- --></p> 
 <p>"Timestamp" : 1588509644226310 , "User" : "kk" , "Host" : "ms81" } } ,</p> 
 <p>"group_replication_group_name" : {<!-- --></p> 
 <p>"Value" : "4e28262a-8d3b-11ea-b463-0242c0a8bc51" ,</p> 
 <p>"Metadata" : {<!-- --></p> 
 <p>"Timestamp" : 1588509644224103 , "User" : "kk" , "Host" : "ms81" } } ,</p> 
 <p>"group_replication_group_seeds" : {<!-- --></p> 
 <p>"Value" : "192.168.188.81:13306,192.168.188.82:13306,192.168.188.83:13306,ms83:33061" ,</p> 
 <p>"Metadata" : {<!-- --></p> 
 <p>"Timestamp" : 1588510707329774 , "User" : "kk" , "Host" : "ms81" } } ,</p> 
 <p>"group_replication_local_address" : {<!-- --></p> 
 <p>"Value" : "ms81:33061" ,</p> 
 <p>"Metadata" : {<!-- --></p> 
 <p>"Timestamp" : 1588509644225954 , "User" : "kk" , "Host" : "ms81" } } ,</p> 
 <p>"group_replication_recovery_use_ssl" : {<!-- --></p> 
 <p>"Value" : "ON" ,</p> 
 <p>"Metadata" : {<!-- --></p> 
 <p>"Timestamp" : 1588509644225355 , "User" : "kk" , "Host" : "ms81" } } ,</p> 
 <p>"group_replication_single_primary_mode" : {<!-- --></p> 
 <p>"Value" : "ON" ,</p> 
 <p>"Metadata" : {<!-- --></p> 
 <p>"Timestamp" : 1588509644224519 , "User" : "kk" , "Host" : "ms81" } } ,</p> 
 <p>"group_replication_ssl_mode" : {<!-- --></p> 
 <p>"Value" : "REQUIRED" ,</p> 
 <p>"Metadata" : {<!-- --></p> 
 <p>"Timestamp" : 1588509644225700 , "User" : "kk" , "Host" : "ms81" } } ,</p> 
 <p>"group_replication_start_on_boot" : {<!-- --></p> 
 <p>"Value" : "ON" ,</p> 
 <p>"Metadata" : {<!-- --></p> 
 <p>"Timestamp" : 1588509644226625 , "User" : "kk" , "Host" : "ms81" } }</p> 
 <p>}</p> 
 <p>}</p> 
 <p>}</p> 
 <p>是否可以在开始阶段无需在my3306.cnf中配置MGR的参数了呢？ 尝试一下</p> 
 <p>插曲：探索自动参数配置</p> 
 <p>只在my3306.cnf 增加下列配置，不添加任何MGR的参数配置 然后重新初始化实例并通过MySQL Shell配置MGR。</p> 
 <p>binlog_checksum=none</p> 
 <p>transaction_write_set_extraction=XXHASH64</p> 
 <p>binlog_transaction_dependency_tracking=WRITESET</p> 
 <p>#下面的无需添加</p> 
 <p>####: for MGR</p> 
 <p>#MGR</p> 
 <p>## remomber change binlog_checksum to none.</p> 
 <p>#loose-group_replication_group_name="78cba89c-7a2c-4442-ba43-51aa387a4fd0" #must be use UUID format</p> 
 <p>#loose-group_replication_start_on_boot=off</p> 
 <p>#loose-group_replication_local_address="192.168.188.81:13306"</p> 
 <p>#loose-group_replication_group_seeds="192.168.188.81:13306,192.168.188.82:13306,192.168.188.83:13306"</p> 
 <p>#loose-group_replication_bootstrap_group=off</p> 
 <p>#</p> 
 <p>##MGR multi master</p> 
 <p>##loose-group_replication_single_primary_mode=off</p> 
 <p>##loose-group_replication_enforce_update_everywhere_checks=on</p> 
 <p>#</p> 
 <p>配置过程同上一样，略。</p> 
 <p>结果是——搭建亲测可行！但是会不会有隐患？来探索一下！</p> 
 <p>mysh执行每一步操作后，都去观察一下节点的自动参数文件。</p> 
 <p>node1 执行 dba.createCluster(‘kkcc‘) 只摘取部分关注内容</p> 
 <p>[[email protected] ~]# cat /data/mysql/mysql3306/data/mysqld-auto.cnf</p> 
 <p>{<!-- --></p> 
 <p>...</p> 
 <p>...</p> 
 <p>"group_replication_exit_state_action" : {<!-- --></p> 
 <p>"Value" : "READ_ONLY" ,</p> 
 <p>"Metadata" : { "Timestamp" : 1588580303031336 , "User" : "kk" , "Host" : "ms81" } } ,</p> 
 <p>"group_replication_group_name" : {<!-- --></p> 
 <p>"Value" : "d21637cb-8ddf-11ea-80c5-0242c0a8bc51" ,</p> 
 <p>"Metadata" : { "Timestamp" : 1588580303028133 , "User" : "kk" , "Host" : "ms81" } } ,</p> 
 <p>"group_replication_local_address" : {<!-- --></p> 
 <p>"Value" : "ms81:33061" ,</p> 
 <p>"Metadata" : { "Timestamp" : 1588580303030759 , "User" : "kk" , "Host" : "ms81" } } ,</p> 
 <p>...</p> 
 <p>...</p> 
 <p>}</p> 
 <p>node1 cluster.addInstance([email protected]:3306‘)</p> 
 <p>[[email protected] ~]# cat /data/mysql/mysql3306/data/mysqld-auto.cnf</p> 
 <p>{<!-- --></p> 
 <p>...</p> 
 <p>...</p> 
 <p>"group_replication_exit_state_action" : {<!-- --></p> 
 <p>"Value" : "READ_ONLY" ,</p> 
 <p>"Metadata" : { "Timestamp" : 1588580303031336 , "User" : "kk" , "Host" : "ms81" } } ,</p> 
 <p>"group_replication_group_name" : {<!-- --></p> 
 <p>"Value" : "d21637cb-8ddf-11ea-80c5-0242c0a8bc51" ,</p> 
 <p>"Metadata" : { "Timestamp" : 1588580303028133 , "User" : "kk" , "Host" : "ms81" } } ,</p> 
 <p>"group_replication_group_seeds" : {<!-- --></p> 
 <p>"Value" : "ms82:33061" ,</p> 
 <p>"Metadata" : { "Timestamp" : 1588580470437362 , "User" : "kk" , "Host" : "ms81" } } ,</p> 
 <p>"group_replication_local_address" : {<!-- --></p> 
 <p>"Value" : "ms81:33061" ,</p> 
 <p>...</p> 
 <p>...</p> 
 <p>}</p> 
 <p>node1 cluster.addInstance([email protected]:3306‘)</p> 
 <p>[[email protected] ~]# cat /data/mysql/mysql3306/data/mysqld-auto.cnf</p> 
 <p>{<!-- --></p> 
 <p>...</p> 
 <p>...</p> 
 <p>"group_replication_exit_state_action" : {<!-- --></p> 
 <p>"Value" : "READ_ONLY" ,</p> 
 <p>"Metadata" : { "Timestamp" : 1588580303031336 , "User" : "kk" , "Host" : "ms81" } } ,</p> 
 <p>"group_replication_group_name" : {<!-- --></p> 
 <p>"Value" : "d21637cb-8ddf-11ea-80c5-0242c0a8bc51" ,</p> 
 <p>"Metadata" : { "Timestamp" : 1588580303028133 , "User" : "kk" , "Host" : "ms81" } } ,</p> 
 <p>"group_replication_group_seeds" : {<!-- --></p> 
 <p>"Value" : "ms82:33061" ,</p> 
 <p>"Metadata" : { "Timestamp" : 1588580470437362 , "User" : "kk" , "Host" : "ms81" } } ,</p> 
 <p>"group_replication_local_address" : {<!-- --></p> 
 <p>"Value" : "ms81:33061" ,</p> 
 <p>"Metadata" : { "Timestamp" : 1588580303030759 , "User" : "kk" , "Host" : "ms81" } } ,</p> 
 <p>...</p> 
 <p>...</p> 
 <p>}</p> 
 <p>可以发现，在自动参数文件中，group_replication_group_seeds 参数随着addInstance()的进行，不停在变化，但添加完三个节点后，参数值并不符合预期。 预期：添加完全部节点后，group_replication_group_seeds.value列表应该包含全部节点信息。</p> 
 <p>检查一下node2的自动参数文件</p> 
 <p>[[email protected] ~]# cat /data/mysql/mysql3306/data/mysqld-auto.cnf</p> 
 <p>{<!-- --></p> 
 <p>...</p> 
 <p>...</p> 
 <p>"group_replication_group_name" : {<!-- --></p> 
 <p>"Value" : "d21637cb-8ddf-11ea-80c5-0242c0a8bc51" ,</p> 
 <p>"Metadata" : { "Timestamp" : 1588580461884041 , "User" : "kk" , "Host" : "ms81.net188" } } ,</p> 
 <p>"group_replication_group_seeds" : {<!-- --></p> 
 <p>"Value" : "ms81:33061" ,</p> 
 <p>"Metadata" : { "Timestamp" : 1588580461885900 , "User" : "kk" , "Host" : "ms81.net188" } } ,</p> 
 <p>"group_replication_local_address" : {<!-- --></p> 
 <p>"Value" : "ms82:33061" ,</p> 
 <p>"Metadata" : { "Timestamp" : 1588580461885604 , "User" : "kk" , "Host" : "ms81.net188" } } ,</p> 
 <p>...</p> 
 <p>...</p> 
 <p>}</p> 
 <p>检查一下node3的自动参数文件</p> 
 <p>[[email protected] ~]# cat /data/mysql/mysql3306/data/mysqld-auto.cnf</p> 
 <p>{<!-- --></p> 
 <p>...</p> 
 <p>...</p> 
 <p>"group_replication_group_name" : {<!-- --></p> 
 <p>"Value" : "d21637cb-8ddf-11ea-80c5-0242c0a8bc51" ,</p> 
 <p>"Metadata" : { "Timestamp" : 1588580588630977 , "User" : "kk" , "Host" : "ms81.net188" } } ,</p> 
 <p>"group_replication_group_seeds" : {<!-- --></p> 
 <p>"Value" : "ms81:33061,ms82:33061" ,</p> 
 <p>"Metadata" : { "Timestamp" : 1588580588632583 , "User" : "kk" , "Host" : "ms81.net188" } } ,</p> 
 <p>"group_replication_local_address" : {<!-- --></p> 
 <p>"Value" : "ms83:33061" ,</p> 
 <p>"Metadata" : { "Timestamp" : 1588580588632308 , "User" : "kk" , "Host" : "ms81.net188" } } ,</p> 
 <p>...</p> 
 <p>...</p> 
 <p>}</p> 
 <p>各节点的自动参数配置文件中对于group_replication_group_seeds.value的定义都不同，初步感觉这样虽然能够搭建，但是有很大的坑的样子。</p> 
 <p>重启MGR所有节点，然后查看集群状态 这里看到的东西就很不专业。</p> 
 <p>mysql&gt; select * from performance_schema.replication_group_members;</p> 
 <p>+---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</p> 
 <p>| CHANNEL_NAME | MEMBER_ID | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE | MEMBER_ROLE | MEMBER_VERSION |</p> 
 <p>+---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</p> 
 <p>| group_replication_applier | ba635fa9-8dde-11ea-a514-0242c0a8bc51 | ms81 | 3306 | OFFLINE | | |</p> 
 <p>+---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</p> 
 <p>1 row in set (0.01 sec)</p> 
 <p>mysql&gt; select * from performance_schema.replication_group_members;</p> 
 <p>+---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</p> 
 <p>| CHANNEL_NAME | MEMBER_ID | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE | MEMBER_ROLE | MEMBER_VERSION |</p> 
 <p>+---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</p> 
 <p>| group_replication_applier | cffc069a-8dde-11ea-934f-0242c0a8bc52 | ms82 | 3306 | OFFLINE | | |</p> 
 <p>+---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</p> 
 <p>1 row in set (0.01 sec)</p> 
 <p>mysql&gt; select * from performance_schema.replication_group_members;</p> 
 <p>+---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</p> 
 <p>| CHANNEL_NAME | MEMBER_ID | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE | MEMBER_ROLE | MEMBER_VERSION |</p> 
 <p>+---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</p> 
 <p>| group_replication_applier | de51695d-8dde-11ea-b113-0242c0a8bc53 | ms83 | 3306 | OFFLINE | | |</p> 
 <p>+---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</p> 
 <p>1 row in set (0.01 sec)</p> 
 <p>手动在node3上启动GR， 因为看着node3的配置seeds是最全的</p> 
 <p>mysql&gt; set global group_replication_bootstrap_group=on;</p> 
 <p>Query OK, 0 rows affected (0.00 sec)</p> 
 <p>mysql&gt; start group_replication;</p> 
 <p>Query OK, 0 rows affected (3.10 sec)</p> 
 <p>mysql&gt; select * from performance_schema.replication_group_members;</p> 
 <p>+---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</p> 
 <p>| CHANNEL_NAME | MEMBER_ID | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE | MEMBER_ROLE | MEMBER_VERSION |</p> 
 <p>+---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</p> 
 <p>| group_replication_applier | de51695d-8dde-11ea-b113-0242c0a8bc53 | ms83 | 3306 | ONLINE | PRIMARY | 8.0.20 |</p> 
 <p>+---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</p> 
 <p>1 row in set (0.00 sec)</p> 
 <p>在node1、node2上手动启动GR，失败</p> 
 <p>mysql&gt; start group_replication;</p> 
 <p>ERROR 3092 (HY000): The server is not configured properly to be an active member of the group. Please see more details on error log.</p> 
 <p>查看node1、node2节点error.log 一种啼笑皆非的感觉油然而生。</p> 
 <p>node1</p> 
 <p>2020-05-04T17:10:13.231895+08:00 0 [ERROR] [MY-011735] [Repl] Plugin group_replication reported: ‘[GCS] Error connecting to all peers. Member join failed. Local port: 33061‘</p> 
 <p>2020-05-04T17:10:14.265194+08:00 0 [ERROR] [MY-011735] [Repl] Plugin group_replication reported: ‘[GCS] The member was unable to join the group. Local port: 33061‘</p> 
 <p>node2</p> 
 <p>2020-05-04T17:11:57.011948+08:00 0 [ERROR] [MY-011735] [Repl] Plugin group_replication reported: ‘[GCS] Error connecting to all peers. Member join failed. Local port: 33061‘</p> 
 <p>2020-05-04T17:11:58.040501+08:00 0 [ERROR] [MY-011735] [Repl] Plugin group_replication reported: ‘[GCS] The member was unable to join the group. Local port: 33061‘</p> 
 <p>node3</p> 
 <p>2020-05-04T17:08:42.787670+08:00 0 [ERROR] [MY-011735] [Repl] Plugin group_replication reported: ‘[GCS] Error on opening a connection to ms81:33061 on local port: 33061.‘</p> 
 <p>2020-05-04T17:08:42.788441+08:00 0 [ERROR] [MY-011735] [Repl] Plugin group_replication reported: ‘[GCS] Error on opening a connection to ms82:33061 on local port: 33061.‘</p> 
 <p>2020-05-04T17:08:42.788545+08:00 0 [ERROR] [MY-011735] [Repl] Plugin group_replication reported: ‘[GCS] Error connecting to all peers. Member join failed. Local port: 33061‘</p> 
 <p>看来直接依靠mysh搞出来的集群，要想通过手动方式启动是不可能的(除非修改cnf文件哈)</p> 
 <p>那试试用mysh启动这个集群。</p> 
 <p>再次重启全部节点，尝试使用mysh进行管理</p> 
 <p>MySQL JS &gt; shell.connect([email protected]:3306‘)</p> 
 <p>MySQL 192.168.188.81:3306 ssl JS &gt; var c = dba.getCluster(‘kkcc‘)</p> 
 <p>Dba.getCluster: This function is not available through a session to a standalone instance (metadata exists, instance belongs to that metadata, but GR is not active) (RuntimeError)</p> 
 <p>看来MySQL Shell自己并不能启动GR的样子…… 那这个设计就很傻了不是？</p> 
 <p>node1上手动启动GR</p> 
 <p>mysql&gt; set global group_replication_bootstrap_group=on;</p> 
 <p>Query OK, 0 rows affected (0.00 sec)</p> 
 <p>mysql&gt; start group_replication;</p> 
 <p>Query OK, 0 rows affected (3.11 sec)</p> 
 <p>mysql&gt; select * from performance_schema.replication_group_members;</p> 
 <p>+---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</p> 
 <p>| CHANNEL_NAME | MEMBER_ID | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE | MEMBER_ROLE | MEMBER_VERSION |</p> 
 <p>+---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</p> 
 <p>| group_replication_applier | ba635fa9-8dde-11ea-a514-0242c0a8bc51 | ms81 | 3306 | ONLINE | PRIMARY | 8.0.20 |</p> 
 <p>+---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</p> 
 <p>1 row in set (0.00 sec)</p> 
 <p>mysh上查看集群状态</p> 
 <p>MySQL 192.168.188.81:3306 ssl JS &gt; dba.getCluster()</p> 
 <p>MySQL 192.168.188.81:3306 ssl JS &gt; var c = dba.getCluster(‘kkcc‘)</p> 
 <p>MySQL 192.168.188.81:3306 ssl JS &gt; c.status()</p> 
 <p>{<!-- --></p> 
 <p>"clusterName": "kkcc",</p> 
 <p>"defaultReplicaSet": {<!-- --></p> 
 <p>"name": "default",</p> 
 <p>"primary": "ms81:3306",</p> 
 <p>"ssl": "REQUIRED",</p> 
 <p>"status": "OK_NO_TOLERANCE",</p> 
 <p>"statusText": "Cluster is NOT tolerant to any failures. 1 member is not active",</p> 
 <p>"topology": {<!-- --></p> 
 <p>"ms81:3306": {<!-- --></p> 
 <p>"address": "ms81:3306",</p> 
 <p>"mode": "R/W",</p> 
 <p>"readReplicas": {},</p> 
 <p>"replicationLag": null,</p> 
 <p>"role": "HA",</p> 
 <p>"status": "ONLINE",</p> 
 <p>"version": "8.0.20"</p> 
 <p>},</p> 
 <p>"ms82:3306": {<!-- --></p> 
 <p>"address": "ms82:3306",</p> 
 <p>"mode": "R/O",</p> 
 <p>"readReplicas": {},</p> 
 <p>"role": "HA",</p> 
 <p>"status": "(MISSING)"</p> 
 <p>}</p> 
 <p>},</p> 
 <p>"topologyMode": "Single-Primary"</p> 
 <p>},</p> 
 <p>"groupInformationSourceMember": "ms81:3306"</p> 
 <p>}</p> 
 <p>这么说来……mysh果然还是个初级中的初级啊。</p> 
 <p>node2 手动启动GR</p> 
 <p>mysql&gt; start group_replication;</p> 
 <p>Query OK, 0 rows affected (5.93 sec)</p> 
 <p>mysql&gt; select * from performance_schema.replication_group_members;</p> 
 <p>+---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</p> 
 <p>| CHANNEL_NAME | MEMBER_ID | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE | MEMBER_ROLE | MEMBER_VERSION |</p> 
 <p>+---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</p> 
 <p>| group_replication_applier | ba635fa9-8dde-11ea-a514-0242c0a8bc51 | ms81 | 3306 | ONLINE | PRIMARY | 8.0.20 |</p> 
 <p>| group_replication_applier | cffc069a-8dde-11ea-934f-0242c0a8bc52 | ms82 | 3306 | ONLINE | SECONDARY | 8.0.20 |</p> 
 <p>+---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</p> 
 <p>2 rows in set (0.00 sec)</p> 
 <p>MySQL 192.168.188.81:3306 ssl JS &gt; c.status()</p> 
 <p>{<!-- --></p> 
 <p>"clusterName": "kkcc",</p> 
 <p>"defaultReplicaSet": {<!-- --></p> 
 <p>"name": "default",</p> 
 <p>"primary": "ms81:3306",</p> 
 <p>"ssl": "REQUIRED",</p> 
 <p>"status": "OK_NO_TOLERANCE",</p> 
 <p>"statusText": "Cluster is NOT tolerant to any failures.",</p> 
 <p>"topology": {<!-- --></p> 
 <p>"ms81:3306": {<!-- --></p> 
 <p>"address": "ms81:3306",</p> 
 <p>"mode": "R/W",</p> 
 <p>"readReplicas": {},</p> 
 <p>"replicationLag": null,</p> 
 <p>"role": "HA",</p> 
 <p>"status": "ONLINE",</p> 
 <p>"version": "8.0.20"</p> 
 <p>},</p> 
 <p>"ms82:3306": {<!-- --></p> 
 <p>"address": "ms82:3306",</p> 
 <p>"mode": "R/O",</p> 
 <p>"readReplicas": {},</p> 
 <p>"replicationLag": null,</p> 
 <p>"role": "HA",</p> 
 <p>"status": "ONLINE",</p> 
 <p>"version": "8.0.20"</p> 
 <p>}</p> 
 <p>},</p> 
 <p>"topologyMode": "Single-Primary"</p> 
 <p>},</p> 
 <p>"groupInformationSourceMember": "ms81:3306"</p> 
 <p>}</p> 
 <p>node3 手动启动GR</p> 
 <p>mysql&gt; start group_replication;</p> 
 <p>Query OK, 0 rows affected (4.67 sec)</p> 
 <p>mysql&gt; select * from performance_schema.replication_group_members;</p> 
 <p>+---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</p> 
 <p>| CHANNEL_NAME | MEMBER_ID | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE | MEMBER_ROLE | MEMBER_VERSION |</p> 
 <p>+---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</p> 
 <p>| group_replication_applier | ba635fa9-8dde-11ea-a514-0242c0a8bc51 | ms81 | 3306 | ONLINE | PRIMARY | 8.0.20 |</p> 
 <p>| group_replication_applier | cffc069a-8dde-11ea-934f-0242c0a8bc52 | ms82 | 3306 | ONLINE | SECONDARY | 8.0.20 |</p> 
 <p>| group_replication_applier | de51695d-8dde-11ea-b113-0242c0a8bc53 | ms83 | 3306 | ONLINE | SECONDARY | 8.0.20 |</p> 
 <p>+---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</p> 
 <p>3 rows in set (0.00 sec)</p> 
 <p>MySQL 192.168.188.81:3306 ssl JS &gt; c.status()</p> 
 <p>{<!-- --></p> 
 <p>"clusterName": "kkcc",</p> 
 <p>"defaultReplicaSet": {<!-- --></p> 
 <p>"name": "default",</p> 
 <p>"primary": "ms81:3306",</p> 
 <p>"ssl": "REQUIRED",</p> 
 <p>"status": "OK",</p> 
 <p>"statusText": "Cluster is ONLINE and can tolerate up to ONE failure.",</p> 
 <p>"topology": {<!-- --></p> 
 <p>"ms81:3306": {<!-- --></p> 
 <p>"address": "ms81:3306",</p> 
 <p>"mode": "R/W",</p> 
 <p>"readReplicas": {},</p> 
 <p>"replicationLag": null,</p> 
 <p>"role": "HA",</p> 
 <p>"status": "ONLINE",</p> 
 <p>"version": "8.0.20"</p> 
 <p>},</p> 
 <p>"ms82:3306": {<!-- --></p> 
 <p>"address": "ms82:3306",</p> 
 <p>"mode": "R/O",</p> 
 <p>"readReplicas": {},</p> 
 <p>"replicationLag": null,</p> 
 <p>"role": "HA",</p> 
 <p>"status": "ONLINE",</p> 
 <p>"version": "8.0.20"</p> 
 <p>}</p> 
 <p>},</p> 
 <p>"topologyMode": "Single-Primary"</p> 
 <p>},</p> 
 <p>"groupInformationSourceMember": "ms81:3306"</p> 
 <p>}</p> 
 <p>mysh这一段反而找不到node3了…… 我的天呐，您是要笑死我嘛？</p> 
 <p>重新扫描node3</p> 
 <p>MySQL 192.168.188.81:3306 ssl JS &gt; c.rescan()</p> 
 <p>Rescanning the cluster...</p> 
 <p>Result of the rescanning operation for the ‘kkcc‘ cluster:</p> 
 <p>{<!-- --></p> 
 <p>"name": "kkcc",</p> 
 <p>"newTopologyMode": null,</p> 
 <p>"newlyDiscoveredInstances": [</p> 
 <p>{<!-- --></p> 
 <p>"host": "ms83:3306",</p> 
 <p>"member_id": "de51695d-8dde-11ea-b113-0242c0a8bc53",</p> 
 <p>"name": null,</p> 
 <p>"version": "8.0.20"</p> 
 <p>}</p> 
 <p>],</p> 
 <p>"unavailableInstances": []</p> 
 <p>}</p> 
 <p>A new instance ‘ms83:3306‘ was discovered in the cluster.</p> 
 <p>Would you like to add it to the cluster metadata? [Y/n]: y</p> 
 <p>Adding instance to the cluster metadata...</p> 
 <p>The instance ‘ms83:3306‘ was successfully added to the cluster metadata.</p> 
 <p>MySQL 192.168.188.81:3306 ssl JS &gt; c.status()</p> 
 <p>{<!-- --></p> 
 <p>"clusterName": "kkcc",</p> 
 <p>"defaultReplicaSet": {<!-- --></p> 
 <p>"name": "default",</p> 
 <p>"primary": "ms81:3306",</p> 
 <p>"ssl": "REQUIRED",</p> 
 <p>"status": "OK",</p> 
 <p>"statusText": "Cluster is ONLINE and can tolerate up to ONE failure.",</p> 
 <p>"topology": {<!-- --></p> 
 <p>"ms81:3306": {<!-- --></p> 
 <p>"address": "ms81:3306",</p> 
 <p>"mode": "R/W",</p> 
 <p>"readReplicas": {},</p> 
 <p>"replicationLag": null,</p> 
 <p>"role": "HA",</p> 
 <p>"status": "ONLINE",</p> 
 <p>"version": "8.0.20"</p> 
 <p>},</p> 
 <p>"ms82:3306": {<!-- --></p> 
 <p>"address": "ms82:3306",</p> 
 <p>"mode": "R/O",</p> 
 <p>"readReplicas": {},</p> 
 <p>"replicationLag": null,</p> 
 <p>"role": "HA",</p> 
 <p>"status": "ONLINE",</p> 
 <p>"version": "8.0.20"</p> 
 <p>},</p> 
 <p>"ms83:3306": {<!-- --></p> 
 <p>"address": "ms83:3306",</p> 
 <p>"mode": "R/O",</p> 
 <p>"readReplicas": {},</p> 
 <p>"replicationLag": null,</p> 
 <p>"role": "HA",</p> 
 <p>"status": "ONLINE",</p> 
 <p>"version": "8.0.20"</p> 
 <p>}</p> 
 <p>},</p> 
 <p>"topologyMode": "Single-Primary"</p> 
 <p>},</p> 
 <p>"groupInformationSourceMember": "ms81:3306"</p> 
 <p>}</p> 
 <p>插曲的结论：还是老老实实自己手动写配置文件吧，祝愿MySQL Shell早日长大成人。</p> 
 <p>使用mysh切换MGR模式</p> 
 <p>MySQL 192.168.188.81:3306 ssl JS &gt; c.switchToMultiPrimaryMode()</p> 
 <p>Switching cluster ‘kkcc‘ to Multi-Primary mode...</p> 
 <p>Instance ‘ms81:3306‘ remains PRIMARY.</p> 
 <p>Instance ‘ms82:3306‘ was switched from SECONDARY to PRIMARY.</p> 
 <p>Instance ‘ms83:3306‘ was switched from SECONDARY to PRIMARY.</p> 
 <p>The cluster successfully switched to Multi-Primary mode.</p> 
 <p>MySQL 192.168.188.81:3306 ssl JS &gt; c.status()</p> 
 <p>{<!-- --></p> 
 <p>"clusterName": "kkcc",</p> 
 <p>"defaultReplicaSet": {<!-- --></p> 
 <p>"name": "default",</p> 
 <p>"ssl": "REQUIRED",</p> 
 <p>"status": "OK",</p> 
 <p>"statusText": "Cluster is ONLINE and can tolerate up to ONE failure.",</p> 
 <p>"topology": {<!-- --></p> 
 <p>"ms81:3306": {<!-- --></p> 
 <p>"address": "ms81:3306",</p> 
 <p>"mode": "R/W",</p> 
 <p>"readReplicas": {},</p> 
 <p>"replicationLag": null,</p> 
 <p>"role": "HA",</p> 
 <p>"status": "ONLINE",</p> 
 <p>"version": "8.0.20"</p> 
 <p>},</p> 
 <p>"ms82:3306": {<!-- --></p> 
 <p>"address": "ms82:3306",</p> 
 <p>"mode": "R/W",</p> 
 <p>"readReplicas": {},</p> 
 <p>"replicationLag": null,</p> 
 <p>"role": "HA",</p> 
 <p>"status": "ONLINE",</p> 
 <p>"version": "8.0.20"</p> 
 <p>},</p> 
 <p>"ms83:3306": {<!-- --></p> 
 <p>"address": "ms83:3306",</p> 
 <p>"mode": "R/W",</p> 
 <p>"readReplicas": {},</p> 
 <p>"replicationLag": null,</p> 
 <p>"role": "HA",</p> 
 <p>"status": "ONLINE",</p> 
 <p>"version": "8.0.20"</p> 
 <p>}</p> 
 <p>},</p> 
 <p>"topologyMode": "Multi-Primary"</p> 
 <p>},</p> 
 <p>"groupInformationSourceMember": "ms81:3306"</p> 
 <p>}</p> 
 <p>MySQL 192.168.188.81:3306 ssl JS &gt; c.switchToSinglePrimaryMode()</p> 
 <p>Switching cluster ‘kkcc‘ to Single-Primary mode...</p> 
 <p>Instance ‘ms81:3306‘ remains PRIMARY.</p> 
 <p>Instance ‘ms82:3306‘ was switched from PRIMARY to SECONDARY.</p> 
 <p>Instance ‘ms83:3306‘ was switched from PRIMARY to SECONDARY.</p> 
 <p>WARNING: Existing connections that expected a R/W connection must be disconnected, i.e. instances that became SECONDARY.</p> 
 <p>The cluster successfully switched to Single-Primary mode.</p> 
 <p>MySQL 192.168.188.81:3306 ssl JS &gt; c.status()</p> 
 <p>{<!-- --></p> 
 <p>"clusterName": "kkcc",</p> 
 <p>"defaultReplicaSet": {<!-- --></p> 
 <p>"name": "default",</p> 
 <p>"primary": "ms81:3306",</p> 
 <p>"ssl": "REQUIRED",</p> 
 <p>"status": "OK",</p> 
 <p>"statusText": "Cluster is ONLINE and can tolerate up to ONE failure.",</p> 
 <p>"topology": {<!-- --></p> 
 <p>"ms81:3306": {<!-- --></p> 
 <p>"address": "ms81:3306",</p> 
 <p>"mode": "R/W",</p> 
 <p>"readReplicas": {},</p> 
 <p>"replicationLag": null,</p> 
 <p>"role": "HA",</p> 
 <p>"status": "ONLINE",</p> 
 <p>"version": "8.0.20"</p> 
 <p>},</p> 
 <p>"ms82:3306": {<!-- --></p> 
 <p>"address": "ms82:3306",</p> 
 <p>"mode": "R/O",</p> 
 <p>"readReplicas": {},</p> 
 <p>"replicationLag": null,</p> 
 <p>"role": "HA",</p> 
 <p>"status": "ONLINE",</p> 
 <p>"version": "8.0.20"</p> 
 <p>},</p> 
 <p>"ms83:3306": {<!-- --></p> 
 <p>"address": "ms83:3306",</p> 
 <p>"mode": "R/O",</p> 
 <p>"readReplicas": {},</p> 
 <p>"replicationLag": null,</p> 
 <p>"role": "HA",</p> 
 <p>"status": "ONLINE",</p> 
 <p>"version": "8.0.20"</p> 
 <p>}</p> 
 <p>},</p> 
 <p>"topologyMode": "Single-Primary"</p> 
 <p>},</p> 
 <p>"groupInformationSourceMember": "ms81:3306"</p> 
 <p>}</p> 
 <p>MGR 原理探索</p> 
 <p>事务探索</p> 
 <p>node1</p> 
 <p>mysql&gt; show master status;</p> 
 <p>+------------------+----------+--------------+------------------+-------------------------------------------+</p> 
 <p>| File | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</p> 
 <p>+------------------+----------+--------------+------------------+-------------------------------------------+</p> 
 <p>| mysql-bin.000001 | 47924 | | | 4e28262a-8d3b-11ea-b463-0242c0a8bc51:1-78 |</p> 
 <p>+------------------+----------+--------------+------------------+-------------------------------------------+</p> 
 <p>1 row in set (0.00 sec)</p> 
 <p>mysql&gt; create database kk;</p> 
 <p>Query OK, 1 row affected (0.03 sec)</p> 
 <p>mysql&gt; show master status;</p> 
 <p>+------------------+----------+--------------+------------------+-------------------------------------------+</p> 
 <p>| File | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</p> 
 <p>+------------------+----------+--------------+------------------+-------------------------------------------+</p> 
 <p>| mysql-bin.000001 | 48107 | | | 4e28262a-8d3b-11ea-b463-0242c0a8bc51:1-79 |</p> 
 <p>+------------------+----------+--------------+------------------+-------------------------------------------+</p> 
 <p>1 row in set (0.00 sec)</p> 
 <p>node2</p> 
 <p>mysql&gt; show master status;</p> 
 <p>+------------------+----------+--------------+------------------+-------------------------------------------+</p> 
 <p>| File | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</p> 
 <p>+------------------+----------+--------------+------------------+-------------------------------------------+</p> 
 <p>| mysql-bin.000002 | 22955 | | | 4e28262a-8d3b-11ea-b463-0242c0a8bc51:1-79 |</p> 
 <p>+------------------+----------+--------------+------------------+-------------------------------------------+</p> 
 <p>1 row in set (0.00 sec)</p> 
 <p>mysql&gt; show slave status\G</p> 
 <p>Empty set (0.00 sec)</p> 
 <p>mysql&gt; use kk</p> 
 <p>Database changed</p> 
 <p>mysql&gt; create table k1(id int);</p> 
 <p>Query OK, 0 rows affected (0.06 sec)</p> 
 <p>mysql&gt; create table k3(id int);</p> 
 <p>Query OK, 0 rows affected (0.06 sec)</p> 
 <p>mysql&gt; use kk</p> 
 <p>Database changed</p> 
 <p>mysql&gt; show slave status\G</p> 
 <p>Empty set (0.00 sec)</p> 
 <p>mysql&gt; show master status;</p> 
 <p>+------------------+----------+--------------+------------------+-----------------------------------------------------------+</p> 
 <p>| File | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set</p> 
 <p>|</p> 
 <p>+------------------+----------+--------------+------------------+-----------------------------------------------------------+</p> 
 <p>| mysql-bin.000002 | 23519 | | | 4e28262a-8d3b-11ea-b463-0242c0a8bc51:1-80:1000074-1000075 |</p> 
 <p>+------------------+----------+--------------+------------------+-----------------------------------------------------------+</p> 
 <p>1 row in set (0.00 sec)</p> 
 <p>node3</p> 
 <p>mysql&gt; create table k4(id int);</p> 
 <p>Query OK, 0 rows affected (0.06 sec)</p> 
 <p>mysql&gt; show master status;</p> 
 <p>+------------------+----------+--------------+------------------+-------------------------------------------------------------------+</p> 
 <p>| File | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</p> 
 <p>+------------------+----------+--------------+------------------+-------------------------------------------------------------------+</p> 
 <p>| mysql-bin.000002 | 10442 | | | 4e28262a-8d3b-11ea-b463-0242c0a8bc51:1-80:1000074-1000075:2000074 |</p> 
 <p>+------------------+----------+--------------+------------------+-------------------------------------------------------------------+</p> 
 <p>1 row in set (0.00 sec)</p> 
 <p>每个节点自己有一个gtid区间， 当用完了还会再申请新的区间</p> 
 <p>MGR原理的内容后续再追加，太长了。</p> 
 <p>原文：https://www.cnblogs.com/konggg/p/12827507.html</p> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/17ac5f594aaea93b495d3ab8b27e1d7b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">mysql 类型转换 索引_经过字段类型转化后的查询不走索引</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9f2838a9f6c43d07f98c09e5450fc551/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Flink-windows10测试环境配置</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>