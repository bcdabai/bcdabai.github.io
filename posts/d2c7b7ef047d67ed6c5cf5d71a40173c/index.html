<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>宜搭免登获取表单数据详细教程（含源码） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="宜搭免登获取表单数据详细教程（含源码）" />
<meta property="og:description" content="一、首先要准备接口资料 1、宜搭应用的应用参数和秘钥
2、钉钉开发者 AppKey和AppSecret
开发者中心记得开放权限
3、最后还需要准备一个钉钉的userid,随意一个组织内成员的userid都可以，需要登录钉钉OA后台：钉钉管理后台 - 钉钉统一身份认证
切换到旧版 二、下面开始上代码 1、登录阿里云账号，开通云函数计算FC
把下面代码丢进去
这个是getToken函数，获取token鉴权接口
var getRawBody = require(&#39;raw-body&#39;); const Url = require(&#39;url&#39;); const API_SERVER = &#39;https://api.dingtalk.com&#39;; const API_VERSION = &#39;v1.0&#39;; exports.handler = (req, resp, context) =&gt; { resp.setHeader(&#39;Content-type&#39;, &#39;application/json&#39;); getRawBody(req, function (err, body) { post( `${API_SERVER}/${API_VERSION}/oauth2/accessToken`, { appKey: &#39;dinglg-xxxxxx&#39;, //钉钉开发者appkey appSecret: &#39;h1g7F3-xxxxxx&#39;, //钉钉开发者appsecret }, function (data) { data = JSON.parse(data); if (data.expireIn) { var respBody = new Buffer.from(JSON.stringify(data)); resp.setStatusCode(200); resp.send(respBody); } else { var respBody = new Buffer." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/d2c7b7ef047d67ed6c5cf5d71a40173c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-22T15:36:22+08:00" />
<meta property="article:modified_time" content="2022-12-22T15:36:22+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">宜搭免登获取表单数据详细教程（含源码）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h3>一、首先要准备接口资料</h3> 
<p>1、宜搭应用的应用参数和秘钥</p> 
<p><img alt="" height="369" src="https://images2.imgbox.com/59/53/DZoiW5yk_o.png" width="1200"></p> 
<p>2、钉钉开发者 AppKey和AppSecret</p> 
<p><img alt="" height="362" src="https://images2.imgbox.com/f2/13/g7n6MqDp_o.png" width="1200"></p> 
<p> <img alt="" height="650" src="https://images2.imgbox.com/23/a8/2h2sLbS7_o.png" width="1200"></p> 
<p> 开发者中心记得开放权限</p> 
<p><img alt="" height="895" src="https://images2.imgbox.com/94/95/GJmqMJAU_o.png" width="1200"></p> 
<p> 3、最后还需要准备一个钉钉的userid,随意一个组织内成员的userid都可以，需要登录钉钉OA后台：<a href="https://oa.dingtalk.com/index.htm" rel="nofollow" title="钉钉管理后台 - 钉钉统一身份认证">钉钉管理后台 - 钉钉统一身份认证</a></p> 
<p>切换到旧版        </p> 
<p><img alt="" height="662" src="https://images2.imgbox.com/d8/b4/YTwzmcoN_o.png" width="1070"></p> 
<p> <img alt="" height="516" src="https://images2.imgbox.com/cf/d8/2Ey7L5PG_o.png" width="808"></p> 
<p> <img alt="" height="909" src="https://images2.imgbox.com/cb/65/zfRqBpmc_o.png" width="1200"></p> 
<h3> 二、下面开始上代码</h3> 
<p>1、登录阿里云账号，开通云函数计算FC</p> 
<p><img alt="" height="909" src="https://images2.imgbox.com/92/9c/nseUn7KK_o.png" width="1200"></p> 
<p> 把下面代码丢进去</p> 
<p>这个是getToken函数，获取token鉴权接口</p> 
<pre><code class="language-javascript">var getRawBody = require('raw-body');
const Url = require('url');
const API_SERVER = 'https://api.dingtalk.com';
const API_VERSION = 'v1.0';

exports.handler = (req, resp, context) =&gt; {
  resp.setHeader('Content-type', 'application/json');
  getRawBody(req, function (err, body) {
    post(
      `${API_SERVER}/${API_VERSION}/oauth2/accessToken`,
      {
        appKey: 'dinglg-xxxxxx', //钉钉开发者appkey
        appSecret: 'h1g7F3-xxxxxx', //钉钉开发者appsecret
      },
      function (data) {
        data = JSON.parse(data);
        if (data.expireIn) {
          var respBody = new Buffer.from(JSON.stringify(data));
          resp.setStatusCode(200);
          resp.send(respBody);
        } else {
          var respBody = new Buffer.from(
            JSON.stringify({
              success: 'false',
              errMsg: '获取失败',
              errCode: '400',
            })
          );
          resp.setStatusCode(200);
          resp.send(respBody);
        }
      }
    );
  });
};

function post(url, data, fn) {
  data = data || {};
  let parse_u = Url.parse(url, true);
  let isHttp = parse_u.protocol == 'http:';
  let options;
  options = {
    host: parse_u.hostname,
    port: parse_u.port || (isHttp ? 80 : 443),
    path: parse_u.path,
    method: 'POST',
    json: true,
    headers: {
      'Content-Type': 'application/json',
    },
  };
  let req = require(isHttp ? 'http' : 'https').request(options, function (res) {
    let _data = '';
    res.on('data', function (chunk) {
      _data += chunk;
    });
    res.on('end', function () {
      fn != undefined &amp;&amp; fn(_data);
    });
  });
  req.write(JSON.stringify(data));
  req.end();
}</code></pre> 
<p>这个是getData函数，获取数据接口</p> 
<pre><code class="language-javascript">var getRawBody = require('raw-body');
const Url = require('url');
const API_SERVER = 'https://api.dingtalk.com';
const API_VERSION = 'v1.0';
const systemToken = '9F766B81QLK3FUZ2FZB7-xxxxx'; //宜搭应用秘钥
const userId = '165-xxxxx'; //以宜搭平台的身份访问接口

exports.handler = (req, resp, context) =&gt; {
    resp.setHeader('Content-type', 'application/json');
    getRawBody(req, function (err, body) {
        let pageSize = req.queries.pageSize ? req.queries.pageSize : 10;
        let currentPage = req.queries.currentPage ? req.queries.currentPage : 1;
        post(
            `${API_SERVER}/${API_VERSION}/yida/forms/instances/search`,
            {
                appType: req.queries.appType,
                formUuid: req.queries.formUuid,
                searchFieldJson: req.queries.searchFieldJson,
                systemToken: systemToken,
                userId: userId,
                currentPage: currentPage,
                pageSize: pageSize
            },
            function (data) {
                data = JSON.parse(data);
                //将searchFormDatas接口的返回值直接塞到response中。
                var respBody = new Buffer.from(JSON.stringify(data));
                resp.setStatusCode(200);
                resp.send(respBody);
            },
            req.queries.accessToken
        );
    });
}

function post(url, data, fn, accessToken) {
    data = data || {};
    let parse_u = Url.parse(url, true);
    let isHttp = parse_u.protocol == 'http:';
    let options;
    options = {
        host: parse_u.hostname,
        port: parse_u.port || (isHttp ? 80 : 443),
        path: parse_u.path,
        method: 'POST',
        json: true,
        headers: {
            'Content-Type': 'application/json',
            'x-acs-dingtalk-access-token': accessToken
        },
    };
    let req = require(isHttp ? 'http' : 'https').request(options, function (res) {
        let _data = '';
        res.on('data', function (chunk) {
            _data += chunk;
        });
        res.on('end', function () {
            fn != undefined &amp;&amp; fn(_data);
        });
    });
    req.write(JSON.stringify(data));
    req.end();
}</code></pre> 
<p>这个是saveData函数，存数据接口</p> 
<pre><code class="language-javascript">var getRawBody = require('raw-body');
const Url = require('url');
const API_SERVER = 'https://api.dingtalk.com';
const API_VERSION = 'v1.0';
const systemToken = '9F766B81QLK3FUZ-xxxxxx'; //应用秘钥
const userId = '165459-xxxxxxx'; //以宜搭平台的身份访问接口,Userid

exports.handler = (req, resp, context) =&gt; {
    resp.setHeader('Content-type', 'application/json');
    getRawBody(req, function (err, body) {
        post(
            `${API_SERVER}/${API_VERSION}/yida/forms/instances`,
            {
                appType: req.queries.appType,
                formUuid: req.queries.formUuid,
                formDataJson: req.queries.formDataJson,
                systemToken: systemToken,
                userId: userId,
            },
            function (data) {
                data = JSON.parse(data);
                //将saveFormDatas接口的返回值直接塞到response中。
                var respBody = new Buffer.from(JSON.stringify(data));
                resp.setStatusCode(200);
                resp.send(respBody);
            },
            req.queries.accessToken
        );
    });
}

function post(url, data, fn, accessToken) {
    data = data || {};
    let parse_u = Url.parse(url, true);
    let isHttp = parse_u.protocol == 'http:';
    let options;
    options = {
        host: parse_u.hostname,
        port: parse_u.port || (isHttp ? 80 : 443),
        path: parse_u.path,
        method: 'POST',
        json: true,
        headers: {
            'Content-Type': 'application/json',
            'x-acs-dingtalk-access-token': accessToken
        },
    };
    let req = require(isHttp ? 'http' : 'https').request(options, function (res) {
        let _data = '';
        res.on('data', function (chunk) {
            _data += chunk;
        });
        res.on('end', function () {
            fn != undefined &amp;&amp; fn(_data);
        });
    });
    req.write(JSON.stringify(data));
    req.end();
}</code></pre> 
<p>保存后，获取公网接口URL，三个接口连接保存下来，以备后用</p> 
<p><img alt="" height="879" src="https://images2.imgbox.com/a7/ca/MUadmD5b_o.png" width="1200"></p> 
<p> 三、宜搭上代码</p> 
<p>新建两个数据源</p> 
<p><img alt="" height="401" src="https://images2.imgbox.com/51/62/aTAYh4cN_o.png" width="508"></p> 
<p><img alt="" height="864" src="https://images2.imgbox.com/09/b2/ISXRKcIL_o.png" width="767">请求函数didfetch上代码</p> 
<pre><code class="language-javascript">function didFetch(content) {
  if (content.expireIn) {
    this.setCookie('accessToken', content.accessToken, content.expireIn);
  } else {
    this.utils.toast({
      title: 'accessToken获取失败！',
      type: 'error',
    });
  }
}</code></pre> 
<p> 需要封装cookie方法，把token存起来</p> 
<pre><code class="language-javascript">/*********************封装cookie方法***************************************/
export function setCookie(name, value, time) {
  // 存储cookie
  let d = new Date();
  d.setTime(d.getTime() + time * 1000);
  let expires = 'expires=' + d.toGMTString();
  document.cookie = `${name}=${value}; ${expires}; path=/`;
}

export function getCookie(name) {
  // 获取cookie
  let newName = name + '=';
  let ca = document.cookie.split(';');
  for (let i = 0; i &lt; ca.length; i++) {
    let c = ca[i].trim();
    if (c.indexOf(newName) == 0) {
      return c.substring(newName.length, c.length);
    }
  }
  return '';
}</code></pre> 
<p> 然后新建一个方法，实现免登把数据存起来，查询方式一样的，少一个参数</p> 
<pre><code class="language-javascript">export async function onClick(){
  if (!this.getCookie('accessToken')) {
    await this.dataSourceMap.getToken.load();
  }
  let obj = {
    "textField_laqhmmhk": this.$('textField_a').get("value"),
    "textField_laqhmmhl": this.$('textField_b').get("value")
  }

  let subData = {
    accessToken: getCookie('accessToken'),// 获取openid返回的accessToken
    formUuid: "FORM-XN966G7160Z46N-xxxxx", //表单id、访客信息表
    appType: "APP_M8516-xxxxxx",//应用app id
    formDataJson: JSON.stringify(obj)
  }
  dataSourceMap.savedata.load(subData).then(res =&gt; {
    console.log('res', res);
  })

}</code></pre> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/61a742e65c5fc2c2cd5c70b700c1d529/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">网站设置为黑白色的方法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0d12a7d80f29f83b1099bb752b8464d9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">[MySQL]-压力测试之性能监测指标</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>