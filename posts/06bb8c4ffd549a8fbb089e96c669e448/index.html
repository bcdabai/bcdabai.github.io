<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Arduino ESP8266 SPI-FFS存储区域 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Arduino ESP8266 SPI-FFS存储区域" />
<meta property="og:description" content="Arduino ESP8266 SPI-FFS存储区域 首先请原谅我分开来写，文章老是不过审核。
前言 在前面博文关于ESP8266WiFiWebServer的例程中，大家可以发现，博主基本上都是手动拼装html内容返回，html的内容被固定写在我们的Arduino ESP代码中。
那么这样就有两点弊端：
ESP8266代码相当臃肿
为了开发方便，web server网页除了自身的html内容之外，还包括一些css文件，甚至引入了JQuery库以及一些图片相关资源。如果把这些内容也直接写入到ESP8266代码中，会导致8266整体代码变大，甚至可能超过flash规定的大小；业务职责分离不明确
一般来说，在一个开发团队中，有人负责开发ESP8266业务需求，有人负责开发WebServer网页内容，有人负责硬件部分。直接把html的内容直接写入到ESP8266代码中，就会导致业务职责混乱，并且如果要修改html内容的时候还得一个个改掉arduino的文件，也有可能改错标识符之类的。理想情况应该是，只需要更新web server的html文件就好，原来的esp8266 arduino逻辑不用更新；
基于以上两点弊端，正式引入本篇章需要研究的ESP8266 文件系统（SPI Flash FileSystem，简称为SPIFFS）。
先来看一个概念图：
文件系统可以帮助我们存储一些变更频率不频繁的文件例如网页、配置或者是某些固化的数据等。
其实，我们用得更多的是存储网页，将网页和相关资源（如：图片、html、css、javaScript）存入到flash的SPIFFS区域。
原理如下图：
2. FLASH存储分配 在讲解SPIFFS之前，我们来看看在Arduino环境下ESP8266的flash存储分配，请看下图：
具体可以分为几部分：
1.代码区
又叫做程序存储区，其中又区分为当前代码区（current Sketch），更新代码区（OTA update）；
文件系统
这个就是我们这节重点讲解的SPI Flash File System，简称SPIFFS闪存文件系统。
即使文件系统与程序存储在同一个闪存芯片上，烧入新的代码也不会修改文件系统内容。这允许使用文件系统来存储Web服务器的代码数据、配置文件或内容。而这个SPIFFS文件系统的大小可以通过烧写环境来配置，目前一般有1M，2M，3M等等。博主建议如果是NodeMcu板子，可以配置成3M；
为了使用文件系统，需要把下面的头文件包含在代码中：
#include &lt;FS.h&gt; 1.EEPROM
具体讲解请回顾 ESP8266开发之旅 基础篇④ ESP8266与EEPROM
WiFi Config
这个区域就是我们设置WiFi模块配置的时候存储的数据。
3. SPIFFS文件系统 3.1 文件系统限制
ESP8266的文件系统实现必须满足芯片的限制，其中最重要是有限的RAM。SPIFFS之所以被ESP8266选择作为文件系统，是因为它是为小型系统专门设计的，同时是以一些简化和限制为代价的。
首先，SPIFFS不支持目录，它只存储一个“扁平化”的文件列表。但是与传统的文件系统相反，斜杠字符“/”在文件名中是允许的，因此处理目录列表的函数（例如，openDir(“/website”)）基本上只是过滤文件名，并保留以前缀（/website/）开始的那些文件。
然后，对于文件名，总共有32个字符限制。一个“\0”字符被保留用于c字符串终止符，因此留给我们31个可用字符长度。
综合起来，这意味着建议保持短文件名，不要使用深嵌套的目录，因为每个文件的完整路径（包括目录、“/”字符、基本名称、点和扩展名）最多只能是31个字符长度。例如，/website/images/bird_thumbnail.jpg 达到了34个字符长度，如果使用它，将导致一些问题。
警告：这个限制很容易达到，如果忽略，问题可能会被忽略，因为在编译和运行时不会出现错误信息。
3.2 文件系统文件添加方式
使用文件系统目的就是为了存储文件，那么存储文件的方式其实可以分为3种：
直接代码中调用FS提供的API在SPIFFS上创建文件；
通过 ESP8266FS 工具把文件上传到SPIFFS；
通过OTA Update的方式上传到SPIFFS；
本质上，无论是通过ESP8266FS或者OTA Update的方式把文件上传到SPIFFS，其底层都是通过调用FS提供的API去完成，所以我们只需要了解FS常用API即可。
4. SPIFFS库 了解一下SPIFFS文件系统常用的操作方法，以下是博主总结的百度脑图：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/06bb8c4ffd549a8fbb089e96c669e448/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-06-02T08:30:29+08:00" />
<meta property="article:modified_time" content="2022-06-02T08:30:29+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Arduino ESP8266 SPI-FFS存储区域</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="centerfont_colorcralArduino_ESP8266_SPIFFS_0"></a> 
 <center> 
  <font color="cral">Arduino ESP8266 SPI-FFS存储区域</font> 
 </center></h3> 
<blockquote> 
 <p>首先请原谅我分开来写，文章老是不过审核。</p> 
</blockquote> 
<h5><a id="_2"></a>前言</h5> 
<blockquote> 
 <p>在前面博文关于ESP8266WiFiWebServer的例程中，大家可以发现，博主基本上都是手动拼装html内容返回，html的内容被固定写在我们的Arduino ESP代码中。<br> 那么这样就有两点弊端：</p> 
</blockquote> 
<ol><li>ESP8266代码相当臃肿<br> 为了开发方便，web server网页除了自身的html内容之外，还包括一些css文件，甚至引入了JQuery库以及一些图片相关资源。如果把这些内容也直接写入到ESP8266代码中，会导致8266整体代码变大，甚至可能超过flash规定的大小；</li><li>业务职责分离不明确<br> 一般来说，在一个开发团队中，有人负责开发ESP8266业务需求，有人负责开发WebServer网页内容，有人负责硬件部分。直接把html的内容直接写入到ESP8266代码中，就会导致业务职责混乱，并且如果要修改html内容的时候还得一个个改掉arduino的文件，也有可能改错标识符之类的。理想情况应该是，只需要更新web server的html文件就好，原来的esp8266 arduino逻辑不用更新；<br> 基于以上两点弊端，正式引入本篇章需要研究的ESP8266 文件系统（SPI Flash FileSystem，简称为SPIFFS）。<br> 先来看一个概念图：<br> 文件系统可以帮助我们存储一些变更频率不频繁的文件例如网页、配置或者是某些固化的数据等。<br> 其实，我们用得更多的是存储网页，将网页和相关资源（如：图片、html、css、javaScript）存入到flash的SPIFFS区域。<br> 原理如下图：<br> <img src="https://images2.imgbox.com/27/55/UlSz4xzl_o.png" alt="在这里插入图片描述"></li></ol> 
<h3><a id="2_FLASH_16"></a>2. FLASH存储分配</h3> 
<p>在讲解SPIFFS之前，我们来看看在Arduino环境下ESP8266的flash存储分配，请看下图：<br> <img src="https://images2.imgbox.com/28/8a/Zvjjubrb_o.png" alt="在这里插入图片描述"><br> 具体可以分为几部分：<br> 1.代码区<br> 又叫做程序存储区，其中又区分为当前代码区（current Sketch），更新代码区（OTA update）；<br> 文件系统<br> 这个就是我们这节重点讲解的SPI Flash File System，简称SPIFFS闪存文件系统。<br> 即使文件系统与程序存储在同一个闪存芯片上，烧入新的代码也不会修改文件系统内容。这允许使用文件系统来存储Web服务器的代码数据、配置文件或内容。而这个SPIFFS文件系统的大小可以通过烧写环境来配置，目前一般有1M，2M，3M等等。博主建议如果是NodeMcu板子，可以配置成3M；</p> 
<p>为了使用文件系统，需要把下面的头文件包含在代码中：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;FS.h&gt;</span></span>
</code></pre> 
<p>1.EEPROM<br> 具体讲解请回顾 ESP8266开发之旅 基础篇④ ESP8266与EEPROM<br> WiFi Config<br> 这个区域就是我们设置WiFi模块配置的时候存储的数据。</p> 
<h3><a id="3_SPIFFS_34"></a>3. SPIFFS文件系统</h3> 
<p>3.1 文件系统限制<br> ESP8266的文件系统实现必须满足芯片的限制，其中最重要是有限的RAM。SPIFFS之所以被ESP8266选择作为文件系统，是因为它是为小型系统专门设计的，同时是以一些简化和限制为代价的。<br> 首先，SPIFFS不支持目录，它只存储一个“扁平化”的文件列表。但是与传统的文件系统相反，斜杠字符“/”在文件名中是允许的，因此处理目录列表的函数（例如，openDir(“/website”)）基本上只是过滤文件名，并保留以前缀（/website/）开始的那些文件。<br> 然后，对于文件名，总共有32个字符限制。一个“\0”字符被保留用于c字符串终止符，因此留给我们31个可用字符长度。<br> 综合起来，这意味着建议保持短文件名，不要使用深嵌套的目录，因为每个文件的完整路径（包括目录、“/”字符、基本名称、点和扩展名）最多只能是31个字符长度。例如，/website/images/bird_thumbnail.jpg 达到了34个字符长度，如果使用它，将导致一些问题。<br> 警告：这个限制很容易达到，如果忽略，问题可能会被忽略，因为在编译和运行时不会出现错误信息。</p> 
<p>3.2 文件系统文件添加方式<br> 使用文件系统目的就是为了存储文件，那么存储文件的方式其实可以分为3种：</p> 
<p>直接代码中调用FS提供的API在SPIFFS上创建文件；<br> 通过 ESP8266FS 工具把文件上传到SPIFFS；<br> 通过OTA Update的方式上传到SPIFFS；<br> 本质上，无论是通过ESP8266FS或者OTA Update的方式把文件上传到SPIFFS，其底层都是通过调用FS提供的API去完成，所以我们只需要了解FS常用API即可。</p> 
<h3><a id="4_SPIFFS_50"></a>4. SPIFFS库</h3> 
<p>了解一下SPIFFS文件系统常用的操作方法，以下是博主总结的百度脑图：<br> 方法分为3大类：</p> 
<ol><li>SPIFFS专用方法</li><li>Dir对象专用方法</li><li>File对象专用方法</li></ol> 
<p>4.1 SPIFFS专用方法<br> 4.1.1 begin —— 挂载SPIFFS文件系统<br> 函数说明</p> 
<pre><code class="prism language-cpp"><span class="token comment">/**
* 挂载SPIFFS文件系统
* @return  bool  如果文件系统挂载成功，返回true，否则返回false
*/</span>
<span class="token keyword">bool</span> <span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>注意点：</p> 
<blockquote> 
 <p>它必须在其他任何FS API被调用之前先调用；<br> Arduino IDE配置时需要启用SPIFFS；</p> 
</blockquote> 
<p>4.1.2 format —— 格式化文件系统<br> 函数说明：</p> 
<pre><code class="prism language-cpp"><span class="token comment">/**
 * 格式化文件系统
 * @return  bool 如果格式化成功则返回true
 */</span>
<span class="token keyword">bool</span> <span class="token function">format</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>注意点：</p> 
<p>可以在执行begin（）之前或者之后调用<br> 4.1.3 open —— 打开文件<br> 函数说明：</p> 
<pre><code class="prism language-cpp"><span class="token comment">/**
 * 打开文件，某种模式下会创建文件
 * @param path 文件路径
 * @param mode 存取模式
 * @return File 返回一个File对象
 */</span>
File <span class="token function">open</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> path<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
File <span class="token function">open</span><span class="token punctuation">(</span><span class="token keyword">const</span> String<span class="token operator">&amp;</span> path<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>注意点：</p> 
<ol><li>路径必须是以斜线开头的绝对路径（如：/dir/filename.txt）；</li><li>模式参数是个用字符串指定的存取模式，其值为“r”、“w”、“a”、“r+”、“w+”和“a+”之中的一个。<br> r 以只读方式操作文件，读位置在文件的开始位置，文件不存在返回空对象；<br> r+ 以可读可写方式打开文件，读写位置在文件的开始位置，文件不存在返回空对象；<br> w 截取文件长度到0或者创建新文件，只能写操作，写位置在文件的开始位置；<br> w+ 截取文件长度到0或者创建新文件，可读可写操作，写位置在文件的开始位置；<br> a 在文件末尾追加内容或者文件不存在就创建新文件，追加位置在当前文件的末尾，只能写操作；<br> a+ 在文件末尾追加内容或者文件不存在就创建新文件，追加位置在当前文件的末尾，可读写操作；</li></ol> 
<ul><li>如果要检查文件是否打开成功，请使用以下代码：</li></ul> 
<pre><code class="prism language-cpp">File f <span class="token operator">=</span> SPIFFS<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/f.txt"</span><span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>f<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"file open failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>4.1.4 exists —— 路径是否存在<br> 函数说明：</p> 
<pre><code class="prism language-cpp"><span class="token comment">/**
 * 路径是否存在
 * @param path 文件路径
 * @return bool 如果指定的路径存在，则返回true，否则返回false
 */</span>
<span class="token keyword">bool</span> <span class="token function">exists</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">bool</span> <span class="token function">exists</span><span class="token punctuation">(</span><span class="token keyword">const</span> String<span class="token operator">&amp;</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>4.1.5 <code>openDir</code> —— 打开绝对路径文件夹<br> 函数说明：</p> 
<pre><code class="prism language-cpp"><span class="token comment">/**
 * 打开绝对路径文件夹
 * @param path 文件路径
 * @return Dir 打开绝对路径文件夹，返回一个Dir对象
 */</span>
Dir <span class="token function">openDir</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
Dir <span class="token function">openDir</span><span class="token punctuation">(</span><span class="token keyword">const</span> String<span class="token operator">&amp;</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>4.1.6 <code>remove</code> —— 删除绝对路径的文件<br> 函数说明：</p> 
<pre><code class="prism language-cpp"><span class="token comment">/**
 * 删除绝对路径的文件
 * @param path 文件路径
 * @return bool 如果删除成功则返回true，否则返回false
 */</span>
<span class="token keyword">bool</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">bool</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">const</span> String<span class="token operator">&amp;</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<hr> 
<table><tbody><tr><th bgcolor="#F5F5DC" rowspan="3"><font face="“宋体”" color="coreal" size="4">  天下之事常成于困约， 而败于奢靡。 —— 陆 游</font></th></tr></tbody></table>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/eee34727e5d3253310a9199d9a6b765f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【Android学习】将Android项目打包成APK</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/192d10c99eb47088ea445fdc55e231b4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">(wps)表格下拉选择多个选项</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>