<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>STM32MP157 AP6236 WiFi蓝牙模块 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="STM32MP157 AP6236 WiFi蓝牙模块" />
<meta property="og:description" content="STM32MP157 AP6236 WiFi蓝牙模块 1. 介绍2. 修改设备树3. 配置Linux内核3.1 配置支持WiFi设备3.2 配置支持IEEE 802.113.3 配置支持蓝牙 4. 配置Buildroot5. 板子配置6. 验证6.1 WiFi6.2 蓝牙 移植参考开发板为100ASK_STM32MP157_V11。
1. 介绍 AP6236是采用BCM43430B0方案，2.4G单频单通道SDIO接口支持BT4.2单频蓝牙WiFi二合一模块。
2. 修改设备树 BCM43430B0 WiFi采用SDIO接口，蓝牙采用uart接口。下面我们给出必要配置，需要根据理解修改自己的设备树。SDIO接口使用的是sdmmc3， uart接口使用的是usart1 。因为i2c4的引脚和usart1 的引脚有重叠，所以我们先将其disabled以免影响。使能sdmmc3后mmc设备号发生了改变，sdmmc3对应0，sdmmc2(SD卡)对应1，sdmmc1(EMMC)对应2，所以后面需要修改Linux启动参数。
#include &lt;dt-bindings/rtc/rtc-stm32.h&gt; / { aliases { serial2 = &amp;usart1; }; vdd_wifi: regulator-vdd-wifi { pinctrl-names = &#34;default&#34;; pinctrl-0 = &lt;&amp;vdd_wifi_pins_a&gt;; compatible = &#34;regulator-fixed&#34;; regulator-name = &#34;vdd_wifi&#34;; regulator-min-microvolt = &lt;3300000&gt;; regulator-max-microvolt = &lt;3300000&gt;; startup-delay-us = &lt;70000&gt;; regulator-boot-on; regulator-pull-down; }; wifi_pwrseq: wifi-pwrseq { compatible = &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/920ec0700f9be8a17aa1414e1ce7701d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-28T21:24:00+08:00" />
<meta property="article:modified_time" content="2023-06-28T21:24:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">STM32MP157 AP6236 WiFi蓝牙模块</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>STM32MP157 AP6236 WiFi蓝牙模块</h4> 
 <ul><li><a href="#1__3" rel="nofollow">1. 介绍</a></li><li><a href="#2__7" rel="nofollow">2. 修改设备树</a></li><li><a href="#3_Linux_135" rel="nofollow">3. 配置Linux内核</a></li><li><ul><li><a href="#31__WiFi_139" rel="nofollow">3.1 配置支持WiFi设备</a></li><li><a href="#32__IEEE_80211_156" rel="nofollow">3.2 配置支持IEEE 802.11</a></li><li><a href="#33___164" rel="nofollow">3.3 配置支持蓝牙</a></li></ul> 
  </li><li><a href="#4_Buildroot_178" rel="nofollow">4. 配置Buildroot</a></li><li><a href="#5__191" rel="nofollow">5. 板子配置</a></li><li><a href="#6__207" rel="nofollow">6. 验证</a></li><li><ul><li><a href="#61_WiFi_208" rel="nofollow">6.1 WiFi</a></li><li><a href="#62__231" rel="nofollow">6.2 蓝牙</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<p>移植参考开发板为100ASK_STM32MP157_V11。</p> 
<h2><a id="1__3"></a>1. 介绍</h2> 
<p>AP6236是采用BCM43430B0方案，2.4G单频单通道SDIO接口支持BT4.2单频蓝牙WiFi二合一模块。</p> 
<h2><a id="2__7"></a>2. 修改设备树</h2> 
<p>BCM43430B0 WiFi采用SDIO接口，蓝牙采用uart接口。下面我们给出必要配置，需要根据理解修改自己的设备树。SDIO接口使用的是sdmmc3， uart接口使用的是usart1 。因为i2c4的引脚和usart1 的引脚有重叠，所以我们先将其disabled以免影响。使能sdmmc3后mmc设备号发生了改变，sdmmc3对应0，sdmmc2(SD卡)对应1，sdmmc1(EMMC)对应2，所以后面需要修改Linux启动参数。</p> 
<pre><code class="prism language-bash"><span class="token comment">#include &lt;dt-bindings/rtc/rtc-stm32.h&gt;</span>

/ <span class="token punctuation">{<!-- --></span>
	aliases <span class="token punctuation">{<!-- --></span>
		serial2 <span class="token operator">=</span> <span class="token operator">&amp;</span>usart1<span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>

	vdd_wifi: regulator-vdd-wifi <span class="token punctuation">{<!-- --></span>
		pinctrl-names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">;</span>
		pinctrl-0 <span class="token operator">=</span> <span class="token operator">&lt;&amp;</span>vdd_wifi_pins_a<span class="token operator">&gt;</span><span class="token punctuation">;</span>
		compatible <span class="token operator">=</span> <span class="token string">"regulator-fixed"</span><span class="token punctuation">;</span>
		regulator-name <span class="token operator">=</span> <span class="token string">"vdd_wifi"</span><span class="token punctuation">;</span>
		regulator-min-microvolt <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">330000</span><span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span><span class="token punctuation">;</span>
		regulator-max-microvolt <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">330000</span><span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span><span class="token punctuation">;</span>
		startup-delay-us <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">7000</span><span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span><span class="token punctuation">;</span>
		regulator-boot-on<span class="token punctuation">;</span>
		regulator-pull-down<span class="token punctuation">;</span>
	 <span class="token punctuation">}</span><span class="token punctuation">;</span>

	wifi_pwrseq: wifi-pwrseq <span class="token punctuation">{<!-- --></span>
		compatible <span class="token operator">=</span> <span class="token string">"mmc-pwrseq-simple"</span><span class="token punctuation">;</span>
		reset-gpios <span class="token operator">=</span> <span class="token operator">&lt;&amp;</span>gpioi <span class="token number">3</span> GPIO_ACTIVE_LOW<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token operator">&amp;</span>pinctrl <span class="token punctuation">{<!-- --></span>
	vdd_wifi_pins_a: vdd_wifi <span class="token punctuation">{<!-- --></span>
		gpio <span class="token punctuation">{<!-- --></span>
			pinmux <span class="token operator">=</span> <span class="token operator">&lt;</span>STM32_PINMUX<span class="token punctuation">(</span><span class="token string">'H'</span>, <span class="token number">4</span>, GPIO<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
			drive-push-down<span class="token punctuation">;</span>
			bias-pull-up<span class="token punctuation">;</span>
			output-low<span class="token punctuation">;</span>
			slew-rate <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token operator">&amp;</span>pinctrl_z <span class="token punctuation">{<!-- --></span>
	usart1_pins_a: usart1-0 <span class="token punctuation">{<!-- --></span>
		pins1 <span class="token punctuation">{<!-- --></span>
			pinmux <span class="token operator">=</span> <span class="token operator">&lt;</span>STM32_PINMUX<span class="token punctuation">(</span><span class="token string">'Z'</span>, <span class="token number">1</span>, AF7<span class="token punctuation">)</span><span class="token operator">&gt;</span>, /* USART1_RX */
					 <span class="token operator">&lt;</span>STM32_PINMUX<span class="token punctuation">(</span><span class="token string">'Z'</span>, <span class="token number">3</span>, AF7<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span> /* USART1_CTS */
			bias-disable<span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
		pins2 <span class="token punctuation">{<!-- --></span>
			pinmux <span class="token operator">=</span> <span class="token operator">&lt;</span>STM32_PINMUX<span class="token punctuation">(</span><span class="token string">'Z'</span>, <span class="token number">2</span>, AF7<span class="token punctuation">)</span><span class="token operator">&gt;</span>, /* USART1_TX */
					 <span class="token operator">&lt;</span>STM32_PINMUX<span class="token punctuation">(</span><span class="token string">'Z'</span>, <span class="token number">5</span>, AF7<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span> /* USART1_RTS */
			bias-disable<span class="token punctuation">;</span>
			drive-push-pull<span class="token punctuation">;</span>
			slew-rate <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>

	usart1_idle_pins_a: usart1-idle-1 <span class="token punctuation">{<!-- --></span>
		pins1 <span class="token punctuation">{<!-- --></span>
			pinmux <span class="token operator">=</span> <span class="token operator">&lt;</span>STM32_PINMUX<span class="token punctuation">(</span><span class="token string">'Z'</span>, <span class="token number">2</span>, ANALOG<span class="token punctuation">)</span><span class="token operator">&gt;</span>, /* USART1_TX */
				 <span class="token operator">&lt;</span>STM32_PINMUX<span class="token punctuation">(</span><span class="token string">'Z'</span>, <span class="token number">3</span>, ANALOG<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span> /* USART1_CTS */
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
		pins2 <span class="token punctuation">{<!-- --></span>
			pinmux <span class="token operator">=</span> <span class="token operator">&lt;</span>STM32_PINMUX<span class="token punctuation">(</span><span class="token string">'Z'</span>, <span class="token number">5</span>, AF7<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span> /* USART1_RTS */
			bias-disable<span class="token punctuation">;</span>
			drive-push-pull<span class="token punctuation">;</span>
			slew-rate <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
		pins3 <span class="token punctuation">{<!-- --></span>
			pinmux <span class="token operator">=</span> <span class="token operator">&lt;</span>STM32_PINMUX<span class="token punctuation">(</span><span class="token string">'Z'</span>, <span class="token number">1</span>, AF7<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span> /* USART1_RX */
			bias-disable<span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>

	usart1_sleep_pins_a: usart1-sleep-0 <span class="token punctuation">{<!-- --></span>
		pins <span class="token punctuation">{<!-- --></span>
			pinmux <span class="token operator">=</span> <span class="token operator">&lt;</span>STM32_PINMUX<span class="token punctuation">(</span><span class="token string">'Z'</span>, <span class="token number">1</span>, ANALOG<span class="token punctuation">)</span><span class="token operator">&gt;</span>, /* USART1_RX */
					 <span class="token operator">&lt;</span>STM32_PINMUX<span class="token punctuation">(</span><span class="token string">'Z'</span>, <span class="token number">2</span>, ANALOG<span class="token punctuation">)</span><span class="token operator">&gt;</span>, /* USART1_TX */
					 <span class="token operator">&lt;</span>STM32_PINMUX<span class="token punctuation">(</span><span class="token string">'Z'</span>, <span class="token number">3</span>, ANALOG<span class="token punctuation">)</span><span class="token operator">&gt;</span>, /* USART1_CTS */
					 <span class="token operator">&lt;</span>STM32_PINMUX<span class="token punctuation">(</span><span class="token string">'Z'</span>, <span class="token number">5</span>, ANALOG<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span> /* USART1_RTS */
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token operator">&amp;</span>rtc <span class="token punctuation">{<!-- --></span>
	st,lsco <span class="token operator">=</span> <span class="token operator">&lt;</span>RTC_OUT2_RMP<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	pinctrl-0 <span class="token operator">=</span> <span class="token operator">&lt;&amp;</span>rtc_out2_rmp_pins_a<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	pinctrl-names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">;</span>
	status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token operator">&amp;</span>sdmmc3 <span class="token punctuation">{<!-- --></span>
	pinctrl-names <span class="token operator">=</span> <span class="token string">"default"</span>, <span class="token string">"opendrain"</span>, <span class="token string">"sleep"</span><span class="token punctuation">;</span>
	pinctrl-0 <span class="token operator">=</span> <span class="token operator">&lt;&amp;</span>sdmmc3_b4_pins_a<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	pinctrl-1 <span class="token operator">=</span> <span class="token operator">&lt;&amp;</span>sdmmc3_b4_od_pins_a<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	pinctrl-2 <span class="token operator">=</span> <span class="token operator">&lt;&amp;</span>sdmmc3_b4_sleep_pins_a<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	arm,primecell-periphid <span class="token operator">=</span> <span class="token operator">&lt;</span>0x1015318<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span><span class="token punctuation">;</span>
	non-removable<span class="token punctuation">;</span>
	st,neg-edge<span class="token punctuation">;</span>
	bus-width <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator"><span class="token file-descriptor important">4</span>&gt;</span><span class="token punctuation">;</span>
	vmmc-supply <span class="token operator">=</span> <span class="token operator">&lt;&amp;</span>vdd_wifi<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	mmc-pwrseq <span class="token operator">=</span> <span class="token operator">&lt;&amp;</span>wifi_pwrseq<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	<span class="token comment">#address-cells = &lt;1&gt;;</span>
	<span class="token comment">#size-cells = &lt;0&gt;;</span>
	keep-power-in-suspend<span class="token punctuation">;</span>
	status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>

	brcmf: bcrmf@1 <span class="token punctuation">{<!-- --></span>
		reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span><span class="token punctuation">;</span>
		compatible <span class="token operator">=</span> <span class="token string">"brcm,bcm4329-fmac"</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token operator">&amp;</span>usart1 <span class="token punctuation">{<!-- --></span>
	pinctrl-names <span class="token operator">=</span> <span class="token string">"default"</span>, <span class="token string">"sleep"</span>, <span class="token string">"idle"</span><span class="token punctuation">;</span>
	pinctrl-0 <span class="token operator">=</span> <span class="token operator">&lt;&amp;</span>usart1_pins_a<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	pinctrl-1 <span class="token operator">=</span> <span class="token operator">&lt;&amp;</span>usart1_sleep_pins_a<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	pinctrl-2 <span class="token operator">=</span> <span class="token operator">&lt;&amp;</span>usart1_idle_pins_a<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	uart-has-rtscts<span class="token punctuation">;</span>
	status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
	
	bluetooth <span class="token punctuation">{<!-- --></span>
		shutdown-gpios <span class="token operator">=</span> <span class="token operator">&lt;&amp;</span>gpioa <span class="token number">14</span> GPIO_ACTIVE_HIGH<span class="token operator">&gt;</span><span class="token punctuation">;</span>
		compatible <span class="token operator">=</span> <span class="token string">"brcm,bcm43438-bt"</span><span class="token punctuation">;</span>
		max-speed <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">300000</span><span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h2><a id="3_Linux_135"></a>3. 配置Linux内核</h2> 
<p>ST官方提供的BSP支持包中的配置已默认支持了BCM43436B0模块，我们下面简单列出必要的配置。</p> 
<h3><a id="31__WiFi_139"></a>3.1 配置支持WiFi设备</h3> 
<pre><code class="prism language-bash">Device Drivers  ---<span class="token operator">&gt;</span> 
	<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Network device support  ---<span class="token operator">&gt;</span> 
		<span class="token punctuation">[</span>*<span class="token punctuation">]</span>   Wireless LAN  ---<span class="token operator">&gt;</span> 
			<span class="token punctuation">[</span>*<span class="token punctuation">]</span>   Broadcom devices
			<span class="token operator">&lt;</span>M<span class="token operator">&gt;</span>     Broadcom FullMAC WLAN driver
			<span class="token punctuation">[</span>*<span class="token punctuation">]</span>     SDIO bus interface support <span class="token keyword">for</span> FullMAC driver

	<span class="token operator">&lt;</span>*<span class="token operator">&gt;</span> Broadcom specific AMBA  ---<span class="token operator">&gt;</span>  
		 --- Broadcom specific AMBA
		 <span class="token punctuation">[</span>*<span class="token punctuation">]</span>   Support <span class="token keyword">for</span> <span class="token for-or-select variable">BCMA</span> <span class="token keyword">in</span> a SoC
		 <span class="token punctuation">[</span>*<span class="token punctuation">]</span>   ChipCommon-attached serial flash support
		 <span class="token punctuation">[</span>*<span class="token punctuation">]</span>   BCMA Broadcom GBIT MAC COMMON core driver
		 <span class="token punctuation">[</span>*<span class="token punctuation">]</span>   BCMA GPIO driver 
</code></pre> 
<h3><a id="32__IEEE_80211_156"></a>3.2 配置支持IEEE 802.11</h3> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>*<span class="token punctuation">]</span> Networking support  ---<span class="token operator">&gt;</span> 
	-*-   Wireless  ---<span class="token operator">&gt;</span> 
		<span class="token operator">&lt;</span>M<span class="token operator">&gt;</span>   cfg80211 - wireless configuration API
		<span class="token operator">&lt;</span>M<span class="token operator">&gt;</span>   Generic IEEE <span class="token number">802.11</span> Networking Stack <span class="token punctuation">(</span>mac80211<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="33___164"></a>3.3 配置支持蓝牙</h3> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>*<span class="token punctuation">]</span> Networking support  ---<span class="token operator">&gt;</span> 
	 <span class="token operator">&lt;</span>M<span class="token operator">&gt;</span>   Bluetooth subsystem support  ---<span class="token operator">&gt;</span>
	 	<span class="token punctuation">[</span>*<span class="token punctuation">]</span>   Bluetooth Classic <span class="token punctuation">(</span>BR/EDR<span class="token punctuation">)</span> features
	 	<span class="token punctuation">[</span>*<span class="token punctuation">]</span>   Bluetooth Low Energy <span class="token punctuation">(</span>LE<span class="token punctuation">)</span> features
	 	<span class="token operator">&lt;</span>M<span class="token operator">&gt;</span>     Bluetooth 6LoWPAN support
	 	<span class="token punctuation">[</span>*<span class="token punctuation">]</span>   Export Bluetooth internals <span class="token keyword">in</span> debugfs
	 	Bluetooth device drivers  ---<span class="token operator">&gt;</span>
	 		<span class="token operator">&lt;</span>M<span class="token operator">&gt;</span> HCI UART driver
	 		<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Broadcom protocol support
</code></pre> 
<h2><a id="4_Buildroot_178"></a>4. 配置Buildroot</h2> 
<p>测试使用WiFi和蓝牙需要用到bluez和wpa_supplicant工具，直接从Buildroot中添加这两个工具。另外我们将根文件系统分区调大至500M，因为我们要将内核的模块全部安装到跟文件系统。</p> 
<pre><code class="prism language-bash">Target packages  ---<span class="token operator">&gt;</span>
	Networking applications  ---<span class="token operator">&gt;</span>
		<span class="token punctuation">[</span>*<span class="token punctuation">]</span> bluez-utils
		<span class="token punctuation">[</span>*<span class="token punctuation">]</span>   build tools
		<span class="token punctuation">[</span>*<span class="token punctuation">]</span>     <span class="token function">install</span> deprecated tools
		<span class="token punctuation">[</span>*<span class="token punctuation">]</span> wireless tools
		<span class="token punctuation">[</span>*<span class="token punctuation">]</span> wpa_supplicant  ---<span class="token operator">&gt;</span>
			<span class="token punctuation">[</span>*<span class="token punctuation">]</span>   Enable nl80211 support
</code></pre> 
<h2><a id="5__191"></a>5. 板子配置</h2> 
<p>编译并下载，启动开发板。由于EMMC的设备号发生了改变，所以需要更改u-boot的Linux的启动参数。</p> 
<pre><code class="prism language-bash"><span class="token comment">#SD卡设置</span>
setenv bootcmd <span class="token string">'ext4load mmc 1:8 c2000000 uImage; ext4load mmc 1:8 c4000000 stm32mp157d-100ask.dtb; bootm c2000000 - c4000000'</span>
setenv bootargs <span class="token string">'console=ttySTM0,115200 root=/dev/mmcblk1p9 rootwait rw'</span>
<span class="token comment">#EMMC设置</span>
setenv bootcmd <span class="token string">'ext4load mmc 2:6 c2000000 uImage; ext4load mmc 2:6 c4000000 stm32mp157d-100ask.dtb; bootm c2000000 - c4000000'</span>
setenv bootargs <span class="token string">'console=ttySTM0,115200 root=/dev/mmcblk2p7 rootwait rw'</span>
</code></pre> 
<p>由于我们编译Linux内核将一些组件编译成了模块，所以要使用这些组件的功能必须将模块安装进跟文件系统中。使用<code>make ARCH=arm INSTALL_MOD_PATH="$PWD/install_artifact" modules_install</code>命令将Linux模块安装在install_artifact目录中，然后我们将install_artifact目录下的所有文件拷贝到根文件系统的根目录下。<br> <img src="https://images2.imgbox.com/0c/22/8Brt9vRN_o.png" alt="在这里插入图片描述"><br> 重启开发板，打印显示没有找到相应的固件。<br> <img src="https://images2.imgbox.com/bb/94/vTpceiGN_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/26/b1/72vf2FjL_o.png" alt="在这里插入图片描述"><br> 我们需要<code>BCM43430B0.hcd、brcmfmac43430b0-sdio.txt、brcmfmac43430b0-sdio.bin、brcmfmac43430b0-sdio.st,stm32mp157d-100ask.txt、brcmfmac43430b0-sdio.st,stm32mp157d-100ask.bin </code>这几个文件复制到/lib/firmware/brcm目录中，其中brcmfmac43430b0-sdio.txt和brcmfmac43430b0-sdio.st,stm32mp157d-100ask.txt、brcmfmac43430b0-sdio.bin和brcmfmac43430b0-sdio.st,stm32mp157d-100ask.bin是一样的只是文件名不同。这几个文件可在网上自找，也可在我的BSP工程的rootfs-patch文件夹中获取。<br> <img src="https://images2.imgbox.com/3a/d3/EyjdnoCF_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="6__207"></a>6. 验证</h2> 
<h3><a id="61_WiFi_208"></a>6.1 WiFi</h3> 
<p>修改/etc/wpa_supplicant.conf文件，配置要连接的WiFi。</p> 
<pre><code class="prism language-bash"><span class="token comment">#ctrl_interface=/var/run/wpa_supplicant</span>
<span class="token assign-left variable">ap_scan</span><span class="token operator">=</span><span class="token number">1</span>

<span class="token assign-left variable">network</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
  <span class="token assign-left variable">ssid</span><span class="token operator">=</span><span class="token string">"WiFi名"</span>
  <span class="token assign-left variable">psk</span><span class="token operator">=</span><span class="token string">"密码"</span>
  <span class="token assign-left variable">priority</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>修改/etc/network/interfaces文件，添加如下配置自动获取IP并连接WiFi。</p> 
<pre><code class="prism language-bash">auto wlan0
iface wlan0 inet dhcp
pre-up wpa_supplicant -B -Dnl80211 -iwlan0 -c/etc/wpa_supplicant.conf
post-down <span class="token function">killall</span> -q wpa_supplicant
</code></pre> 
<p>重启开发板，可以看到wlan0网卡启动正常，上网正常。<br> <img src="https://images2.imgbox.com/ea/76/Q9NXG7rP_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="62__231"></a>6.2 蓝牙</h3> 
<p>使用hciconfig -a查看蓝牙设备，启动蓝牙hciconfig hci0 up。<br> <img src="https://images2.imgbox.com/7a/9f/wRjds1DN_o.png" alt="在这里插入图片描述"><br> 打开手机蓝牙设为可被发现，使用hcitool scan扫描附件蓝牙设备，l2ping搜索到的设备正常。<br> <img src="https://images2.imgbox.com/99/bd/eeZlAlqU_o.png" alt="在这里插入图片描述"></p> 
<p><strong>移植源码获取：</strong></p> 
<pre><code class="prism language-bash"><span class="token function">git</span> clone https://github.com/Sonboy97/arm-ostl-linux-gnueabi.git
版本：cc0bae894417d0985d6567dd7674cea303848cdd
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/16005a3e0efe7664840238d1d529cc4b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">STM32MP157 u-boot2021.10移植</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/94412035726653a04d488c2fd51926ad/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">STM32F4_MPU6050六轴传感器详解</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>