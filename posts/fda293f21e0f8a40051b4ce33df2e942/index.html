<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>干货速看！同行盆友来稿：一文带你搭建K8S高可用集群，以及在上面搭建Prometheus和Grafana。 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="干货速看！同行盆友来稿：一文带你搭建K8S高可用集群，以及在上面搭建Prometheus和Grafana。" />
<meta property="og:description" content="写在开篇 kubeadm工具快速部署k8s集群实现故障自动发现、转移及修复，集群中部署prometheus&#43;grafan可实现自动收集集群的各项新性能指标数据，可视化界面提升客户对各项性能指标的直观感知，实现高效快速故障排查及解决。
一、kubeadm搭建k8s集群 1、Kubeadm简介： （1）什么是kebeadm? 作为Kubernetes官方提供的集群部署管理工具，采用“一键式”指令进行集群的快速初始化和安装，极大地简化了部署过程，消除了集群安装的痛点。可以快速部署一套k8s集群。
（2）Kubeadm基本原理： 在启动的过程可以查看到拉取组件镜像的过程。之所以kubeadm能成为最快搭建k8s集群的工具就在于它将组件都容器化部署。
使用两条命令可以快捷部署一套k8s集群：
kubeadm init：初始化集群并启动master相关组件，在计划用做master的节点上执行。
kubeadm join：将节点加入上述集群，在计划用做node的节点上执行。
（3）K8s集群角色中包含的组件： K8s-master:
kube-apiserver
controller-manager
Scheduler
Etcd
K8s-node:
Kubelet
Kube-proxy
Docker
1.1 项目实验环境要求 可根据实际生产环境的需求配备适配的基础环境，本次项目仅作为实验参考
集群角色机器数量操作系统硬件配置iP地址网络策略备注K8s-master1台CentOS7.x-86_x642个cpu2GB内存40GB硬盘192.168.1.15配置弹性公网；集群间网络可互访禁止swap分区K8s-node11台CentOS7.x-86_x642个cpu2GB内存40GB硬盘192.168.1.16配置弹性公网；集群间网络可互访禁止swap分区K8s-node21台CentOS7.x-86_x642个cpu2GB内存40GB硬盘192.168.1.17配置弹性公网；集群间网络可互访禁止swap分区 1.2 实操步骤 1.2.1 环境准备 ###三台机器均执行以下操作 ###关闭防火墙： systemctl stop firewalld systemctl disable firewalld ###关闭selinux： sed -i &#39;s/enforcing/disabled/&#39; /etc/selinux/config # 永久 setenforce 0 # 临时操作 ###关闭swap： swapoff -a # 临时操作 vim /etc/fstab # 永久操作 ###关闭swap： swapoff -a # 临时 vim /etc/fstab # 永久 ###设置主机名： hostnamectl set-hostname k8s-master hostnamectl set-hostname k8s-node1 hostnamectl set-hostname k8s-node2 ###将桥接的ipv4流量传递到iptables的链： cat &gt; /etc/sysctl." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/fda293f21e0f8a40051b4ce33df2e942/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-06T22:48:19+08:00" />
<meta property="article:modified_time" content="2022-07-06T22:48:19+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">干货速看！同行盆友来稿：一文带你搭建K8S高可用集群，以及在上面搭建Prometheus和Grafana。</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h4><a id="_0"></a>写在开篇</h4> 
<p>kubeadm工具快速部署k8s集群实现故障自动发现、转移及修复，集群中部署prometheus+grafan可实现自动收集集群的各项新性能指标数据，可视化界面提升客户对各项性能指标的直观感知，实现高效快速故障排查及解决。</p> 
<h3><a id="kubeadmk8s_3"></a>一、kubeadm搭建k8s集群</h3> 
<h4><a id="1Kubeadm_5"></a>1、Kubeadm简介：</h4> 
<h5><a id="1kebeadm_7"></a>（1）什么是kebeadm?</h5> 
<p>作为Kubernetes官方提供的集群部署管理工具，采用“一键式”指令进行集群的快速初始化和安装，极大地简化了部署过程，消除了集群安装的痛点。可以快速部署一套k8s集群。</p> 
<h5><a id="2Kubeadm_11"></a>（2）Kubeadm基本原理：</h5> 
<p>在启动的过程可以查看到拉取组件镜像的过程。之所以kubeadm能成为最快搭建k8s集群的工具就在于它将组件都容器化部署。<br> 使用两条命令可以快捷部署一套k8s集群：<br> kubeadm init：初始化集群并启动master相关组件，在计划用做master的节点上执行。<br> kubeadm join：将节点加入上述集群，在计划用做node的节点上执行。</p> 
<h5><a id="3K8s_18"></a>（3）K8s集群角色中包含的组件：</h5> 
<p>K8s-master:<br> kube-apiserver<br> controller-manager<br> Scheduler<br> Etcd<br> K8s-node:<br> Kubelet<br> Kube-proxy<br> Docker</p> 
<h5><a id="11__30"></a>1.1 项目实验环境要求</h5> 
<p>可根据实际生产环境的需求配备适配的基础环境，本次项目仅作为实验参考</p> 
<table><thead><tr><th>集群角色</th><th>机器数量</th><th>操作系统</th><th>硬件配置</th><th>iP地址</th><th>网络策略</th><th>备注</th></tr></thead><tbody><tr><td>K8s-master</td><td>1台</td><td>CentOS7.x-86_x64</td><td>2个cpu2GB内存40GB硬盘</td><td>192.168.1.15</td><td>配置弹性公网；集群间网络可互访</td><td>禁止swap分区</td></tr><tr><td>K8s-node1</td><td>1台</td><td>CentOS7.x-86_x64</td><td>2个cpu2GB内存40GB硬盘</td><td>192.168.1.16</td><td>配置弹性公网；集群间网络可互访</td><td>禁止swap分区</td></tr><tr><td>K8s-node2</td><td>1台</td><td>CentOS7.x-86_x64</td><td>2个cpu2GB内存40GB硬盘</td><td>192.168.1.17</td><td>配置弹性公网；集群间网络可互访</td><td>禁止swap分区</td></tr></tbody></table> 
<h5><a id="12__40"></a>1.2 实操步骤</h5> 
<h6><a id="121__42"></a>1.2.1 环境准备</h6> 
<pre><code class="prism language-python"><span class="token comment">###三台机器均执行以下操作</span>
<span class="token comment">###关闭防火墙：</span>
systemctl stop firewalld
systemctl disable firewalld
<span class="token comment">###关闭selinux：</span>
sed <span class="token operator">-</span>i <span class="token string">'s/enforcing/disabled/'</span> <span class="token operator">/</span>etc<span class="token operator">/</span>selinux<span class="token operator">/</span>config  <span class="token comment"># 永久</span>
setenforce <span class="token number">0</span>  <span class="token comment"># 临时操作</span>
<span class="token comment">###关闭swap：</span>
swapoff <span class="token operator">-</span>a  <span class="token comment"># 临时操作</span>
vim <span class="token operator">/</span>etc<span class="token operator">/</span>fstab  <span class="token comment"># 永久操作</span>
<span class="token comment">###关闭swap：</span>
swapoff <span class="token operator">-</span>a  <span class="token comment"># 临时</span>
vim <span class="token operator">/</span>etc<span class="token operator">/</span>fstab  <span class="token comment"># 永久</span>
<span class="token comment">###设置主机名：</span>
hostnamectl <span class="token builtin">set</span><span class="token operator">-</span>hostname k8s<span class="token operator">-</span>master
hostnamectl <span class="token builtin">set</span><span class="token operator">-</span>hostname k8s<span class="token operator">-</span>node1
hostnamectl <span class="token builtin">set</span><span class="token operator">-</span>hostname k8s<span class="token operator">-</span>node2
<span class="token comment">###将桥接的ipv4流量传递到iptables的链：   </span>
cat <span class="token operator">&gt;</span> <span class="token operator">/</span>etc<span class="token operator">/</span>sysctl<span class="token punctuation">.</span>d<span class="token operator">/</span>k8s<span class="token punctuation">.</span>conf <span class="token operator">&lt;&lt;</span> EOF
net<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>bridge<span class="token operator">-</span>nf<span class="token operator">-</span>call<span class="token operator">-</span>ip6tables <span class="token operator">=</span> <span class="token number">1</span>
net<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>bridge<span class="token operator">-</span>nf<span class="token operator">-</span>call<span class="token operator">-</span>iptables <span class="token operator">=</span> <span class="token number">1</span>
EOF
 sysctl <span class="token operator">-</span><span class="token operator">-</span>system
<span class="token comment">###时间同步：假设时间不同步可以使用date set保证节点时间同步</span>
</code></pre> 
<h6><a id="122_docker_71"></a>1.2.2 安装docker</h6> 
<p>官网建议安装docker-19.03.9版本适配k8s集群</p> 
<p>内网建议使用二进制安装，外网可以使用ali源或清华源进行安装</p> 
<pre><code class="prism language-python"><span class="token comment">###三台机器均执行以下操作</span>
<span class="token comment">###使用ali源下载并安装</span>
Wget https<span class="token punctuation">:</span><span class="token operator">//</span>mirrors<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com<span class="token operator">/</span>docker<span class="token operator">-</span>ce<span class="token operator">/</span>linux<span class="token operator">/</span>centos<span class="token operator">/</span>docker<span class="token operator">-</span>ce<span class="token punctuation">.</span>repo <span class="token operator">-</span>O <span class="token operator">/</span>etc<span class="token operator">/</span>yum<span class="token punctuation">.</span>repos<span class="token punctuation">.</span>d<span class="token operator">/</span>docker<span class="token operator">-</span>ce<span class="token punctuation">.</span>repo
yum <span class="token operator">-</span>y install docker<span class="token operator">-</span>ce
systemctl enable docker <span class="token operator">&amp;</span><span class="token operator">&amp;</span> systemctl start docker
<span class="token comment">###使用二进制包安装</span>
外网机器下载二进制包（下载完毕可使用文件传输工具将包传送到内网机器上）：
Wget https<span class="token punctuation">:</span><span class="token operator">//</span>download<span class="token punctuation">.</span>docker<span class="token punctuation">.</span>com<span class="token operator">/</span>linux<span class="token operator">/</span>static<span class="token operator">/</span>stable<span class="token operator">/</span>x86_64<span class="token operator">/</span>docker<span class="token operator">-</span><span class="token number">19.03</span><span class="token number">.9</span><span class="token punctuation">.</span>tgz 
<span class="token comment">###内网机器安装部署docker：</span>
tar zxvf docker<span class="token operator">-</span><span class="token number">19.03</span><span class="token number">.9</span><span class="token punctuation">.</span>tgz 
mv docker<span class="token operator">/</span><span class="token operator">*</span> <span class="token operator">/</span>usr<span class="token operator">/</span><span class="token builtin">bin</span> 
<span class="token comment">###配置system管理docker：</span>
cat <span class="token operator">&gt;</span> <span class="token operator">/</span>usr<span class="token operator">/</span>lib<span class="token operator">/</span>systemd<span class="token operator">/</span>system<span class="token operator">/</span>docker<span class="token punctuation">.</span>service <span class="token operator">&lt;&lt;</span> EOF 
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span> 
Description<span class="token operator">=</span>Docker Application Container Engine 
Documentation<span class="token operator">=</span>https<span class="token punctuation">:</span><span class="token operator">//</span>docs<span class="token punctuation">.</span>docker<span class="token punctuation">.</span>com 
After<span class="token operator">=</span>network<span class="token operator">-</span>online<span class="token punctuation">.</span>target firewalld<span class="token punctuation">.</span>service 
Wants<span class="token operator">=</span>network<span class="token operator">-</span>online<span class="token punctuation">.</span>target 
<span class="token punctuation">[</span>Service<span class="token punctuation">]</span> 
Type<span class="token operator">=</span>notify 
ExecStart<span class="token operator">=</span><span class="token operator">/</span>usr<span class="token operator">/</span><span class="token builtin">bin</span><span class="token operator">/</span>dockerd 
ExecReload<span class="token operator">=</span><span class="token operator">/</span><span class="token builtin">bin</span><span class="token operator">/</span>kill <span class="token operator">-</span>s HUP $MAINPID 
LimitNOFILE<span class="token operator">=</span>infinity 
LimitNPROC<span class="token operator">=</span>infinity 
LimitCORE<span class="token operator">=</span>infinity 
TimeoutStartSec<span class="token operator">=</span><span class="token number">0</span> 
Delegate<span class="token operator">=</span>yes 
KillMode<span class="token operator">=</span>process 
Restart<span class="token operator">=</span>on<span class="token operator">-</span>failure 
StartLimitBurst<span class="token operator">=</span><span class="token number">3</span> 
StartLimitInterval<span class="token operator">=</span>60s 
<span class="token punctuation">[</span>Install<span class="token punctuation">]</span> 
WantedBy<span class="token operator">=</span>multi<span class="token operator">-</span>user<span class="token punctuation">.</span>target 
EOF
<span class="token comment">###配置docker加速器：</span>
mkdir <span class="token operator">/</span>etc<span class="token operator">/</span>docker 
cat <span class="token operator">&gt;</span> <span class="token operator">/</span>etc<span class="token operator">/</span>docker<span class="token operator">/</span>daemon<span class="token punctuation">.</span>json <span class="token operator">&lt;&lt;</span> EOF 
<span class="token punctuation">{<!-- --></span> 
<span class="token string">"registry-mirrors"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"https://b9pmyelo.mirror.aliyuncs.com"</span><span class="token punctuation">]</span> 
<span class="token punctuation">}</span>
EOF 
<span class="token comment">###后台加载daemon.json</span>
systemctl daemon<span class="token operator">-</span><span class="token builtin">reload</span>
<span class="token comment">###启动docker</span>
systemctl start docker
</code></pre> 
<h6><a id="123_kubeadm_125"></a>1.2.3 安装kubeadm</h6> 
<p>获取yum软件源安装kubeadm</p> 
<p>本人使用华为云自带的yum软件源安装部署，仅作为实验参考</p> 
<pre><code class="prism language-python"><span class="token comment">###外网环境安装kubeadm：</span>
添加ali yum软件源
 cat <span class="token operator">&gt;</span> <span class="token operator">/</span>etc<span class="token operator">/</span>yum<span class="token punctuation">.</span>repos<span class="token punctuation">.</span>d<span class="token operator">/</span>kubernetes<span class="token punctuation">.</span>repo <span class="token operator">&lt;&lt;</span> EOF
<span class="token punctuation">[</span>kubernetes<span class="token punctuation">]</span>
name<span class="token operator">=</span>Kubernetes
baseurl<span class="token operator">=</span>https<span class="token punctuation">:</span><span class="token operator">//</span>mirrors<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com<span class="token operator">/</span>kubernetes<span class="token operator">/</span>yum<span class="token operator">/</span>repos<span class="token operator">/</span>kubernetes<span class="token operator">-</span>el7<span class="token operator">-</span>x86_64
enabled<span class="token operator">=</span><span class="token number">1</span>
gpgcheck<span class="token operator">=</span><span class="token number">0</span>
repo_gpgcheck<span class="token operator">=</span><span class="token number">0</span>
gpgkey<span class="token operator">=</span>https<span class="token punctuation">:</span><span class="token operator">//</span>mirrors<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com<span class="token operator">/</span>kubernetes<span class="token operator">/</span>yum<span class="token operator">/</span>doc<span class="token operator">/</span>yum<span class="token operator">-</span>key<span class="token punctuation">.</span>gpg https<span class="token punctuation">:</span><span class="token operator">//</span>mirrors<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com<span class="token operator">/</span>kubernetes<span class="token operator">/</span>yum<span class="token operator">/</span>doc<span class="token operator">/</span>rpm<span class="token operator">-</span>package<span class="token operator">-</span>key<span class="token punctuation">.</span>gpg
EOF
yum install <span class="token operator">-</span>y kubelet<span class="token operator">-</span><span class="token number">1.18</span><span class="token number">.0</span> kubeadm<span class="token operator">-</span><span class="token number">1.18</span><span class="token number">.0</span> kubectl<span class="token operator">-</span><span class="token number">1.18</span><span class="token number">.0</span>
systemctl enable kubelet
<span class="token comment">###内网环境安装kubeadm：</span>
<span class="token number">1</span>、可以使用外网机器下载网络yum源并制作成本地源打包上传到内网机器上安装。
<span class="token number">2</span>、外网机器部署kubeadm获取到组件的镜像。Docker save将其保存为本地镜像供给内网使用（这里不详细解读操作，可以百度获取相关信息）
安装部署k8s<span class="token operator">-</span>master：
<span class="token comment">###yum软件包完成kubeadm安装后通过命令行传参的方式初始化master。(当然也可以通过配置文件kubeadm.conf的方式进行初始化（即将命令行的参数写在配置文件中，通过配置文件引导初始化集群，本实验为了方便选择命令传参进行初始化）</span>
kubeadm init \                       
  <span class="token operator">-</span><span class="token operator">-</span>apiserver<span class="token operator">-</span>advertise<span class="token operator">-</span>address<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.15</span> \
  <span class="token operator">-</span><span class="token operator">-</span>image<span class="token operator">-</span>repository registry<span class="token punctuation">.</span>aliyuncs<span class="token punctuation">.</span>com<span class="token operator">/</span>google_containers \
  <span class="token operator">-</span><span class="token operator">-</span>kubernetes<span class="token operator">-</span>version v1<span class="token punctuation">.</span><span class="token number">18.0</span> \ 指定版本
  <span class="token operator">-</span><span class="token operator">-</span>service<span class="token operator">-</span>cidr<span class="token operator">=</span><span class="token number">10.96</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">12</span> \ <span class="token comment">#cidr网段指的是插件的网段.配置的网段和集群内的物理网段不可以起冲突</span>
  <span class="token operator">-</span><span class="token operator">-</span>pod<span class="token operator">-</span>network<span class="token operator">-</span>cidr<span class="token operator">=</span><span class="token number">10.244</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">16</span> \ <span class="token comment">#pod分配的网段,配置的网段和集群内的物理网段不可以起冲突</span>
  <span class="token operator">-</span><span class="token operator">-</span>ignore<span class="token operator">-</span>preflight<span class="token operator">-</span>errors<span class="token operator">=</span><span class="token builtin">all</span>   <span class="token comment">#指的是忽略错误信息</span>
<span class="token comment">###在集群初始化的过程中，底层都历经哪些步骤呢？</span>
<span class="token number">1</span>、<span class="token punctuation">[</span>preflight<span class="token punctuation">]</span>环境检查 <span class="token comment">#前期环境的部署情况</span>
<span class="token number">2</span>、<span class="token punctuation">[</span>kubelet<span class="token operator">-</span>start<span class="token punctuation">]</span>生成配置文件并启动 配置文件所在路径<span class="token operator">/</span>var<span class="token operator">/</span>lib<span class="token operator">/</span>kubelet<span class="token operator">/</span>config<span class="token punctuation">.</span>yml
<span class="token number">3</span>、<span class="token punctuation">[</span>cert<span class="token punctuation">]</span>有apiserver<span class="token punctuation">,</span>etcd<span class="token punctuation">,</span>proxy证书
<span class="token number">4</span>、<span class="token punctuation">[</span>kubeconfig<span class="token punctuation">]</span>这个格式都用于K8S的认证文件 是组件之间的相互链接的关键
<span class="token number">5</span>、<span class="token punctuation">[</span>control<span class="token operator">-</span>plan<span class="token punctuation">]</span> 静态创建pod静态pod目录 <span class="token operator">/</span>etc<span class="token operator">/</span>kubenetes<span class="token operator">/</span>mainfests 用于拉取pod
<span class="token number">6</span>、<span class="token punctuation">[</span>etcd<span class="token punctuation">]</span>etcd静态pod启动etcd
实现kubelet开机自启<span class="token punctuation">:</span>
Systemctl enable kubelet
<span class="token comment">###Master初始化的过程中会提示在其他节点执行自主添加进集群的命令</span>
在node节点上输入以下命令可自主添加进k8s集群
kubeadm join <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.15</span><span class="token punctuation">:</span><span class="token number">6443</span> <span class="token operator">-</span><span class="token operator">-</span>token 0exccz<span class="token punctuation">.</span>8q01ow3wqgmw5d6o \
    <span class="token operator">-</span><span class="token operator">-</span>discovery<span class="token operator">-</span>token<span class="token operator">-</span>ca<span class="token operator">-</span>cert<span class="token operator">-</span><span class="token builtin">hash</span> sha256<span class="token punctuation">:</span>83003fe9ea8097c62610b35904f2ea1b23832bbd7f98e2a3fbe4c03ee912ed2d
<span class="token comment">###token是有效期的，关闭终端找不到此提示命令，可以通过一条命令再次生成。</span>
kubeadm token create <span class="token operator">-</span><span class="token operator">-</span><span class="token keyword">print</span><span class="token operator">-</span>join<span class="token operator">-</span>command
<span class="token comment">###加上--ttl ，可以设置永久不过期。</span>
<span class="token comment">###查看token的有效时间 kubeadm token list</span>

</code></pre> 
<h6><a id="124_cni_177"></a>1.2.4 部署容器网络cni</h6> 
<p>Calico是一个纯三层的数据中心网络方案，calico支持广泛的平台，包括kubernets,openstack等等。</p> 
<p>Calico在每个计算节点利用linux kernel实现一个高效的虚拟路由器来负责数据转发，而每个vrouter通过bgp协议负责把自己上运行的workload的路由信息向整个calico网络内传播</p> 
<pre><code class="prism language-python"><span class="token comment">###外网环境：</span>
wget https<span class="token punctuation">:</span><span class="token operator">//</span>docs<span class="token punctuation">.</span>projectcalico<span class="token punctuation">.</span>org<span class="token operator">/</span>manifests<span class="token operator">/</span>calico<span class="token punctuation">.</span>yaml
vim calico<span class="token punctuation">.</span>yaml
   <span class="token operator">/</span><span class="token number">192</span>
    去注释 <span class="token operator">-</span> name<span class="token punctuation">:</span> CALICO_IPV4POOL_CIDR
                  value<span class="token punctuation">:</span> <span class="token string">"10.244.0.0/16"</span>
  <span class="token operator">/</span><span class="token number">169</span>
     去注释
kubectl <span class="token builtin">apply</span> <span class="token operator">-</span>f calico<span class="token punctuation">.</span>yaml
Kubectl get pods <span class="token operator">-</span>n kube<span class="token operator">-</span>system <span class="token operator">-</span>w  动态查看pod状态
<span class="token comment">###内网环境：</span>
<span class="token number">1</span>、可以使用外网机器下载网络yum源并制作成本地源打包上传到内网机器上安装。
<span class="token number">2</span>、外网机器部署calico获取到组件的镜像。Docker save将其保存为本地镜像供给内网使用（这里不详细解读操作，可以百度获取相关信息）
</code></pre> 
<h6><a id="125_dashboar_199"></a>1.2.5 部署dashboar</h6> 
<p>是默认k8s UI界面，主要用于查看集群资源</p> 
<pre><code class="prism language-python"><span class="token comment">###下载并编辑dashboar的文本文档</span>
wget https<span class="token punctuation">:</span><span class="token operator">//</span>raw<span class="token punctuation">.</span>githubusercontent<span class="token punctuation">.</span>com<span class="token operator">/</span>kubernetes<span class="token operator">/</span>dashboard<span class="token operator">/</span>v2<span class="token punctuation">.</span><span class="token number">0.3</span><span class="token operator">/</span>aio<span class="token operator">/</span>deploy<span class="token operator">/</span>recommended<span class="token punctuation">.</span>yaml
vim recommended<span class="token punctuation">.</span>yaml
kind<span class="token punctuation">:</span> Service
apiVersion<span class="token punctuation">:</span> v1
metadata<span class="token punctuation">:</span>
  labels<span class="token punctuation">:</span>
    k8s<span class="token operator">-</span>app<span class="token punctuation">:</span> kubernetes<span class="token operator">-</span>dashboard
  name<span class="token punctuation">:</span> kubernetes<span class="token operator">-</span>dashboard
  namespace<span class="token punctuation">:</span> kubernetes<span class="token operator">-</span>dashboard
spec<span class="token punctuation">:</span>
  ports<span class="token punctuation">:</span>
    <span class="token operator">-</span> port<span class="token punctuation">:</span> <span class="token number">443</span>
      nodePort<span class="token punctuation">:</span> <span class="token number">30001</span><span class="token punctuation">(</span>添加的<span class="token punctuation">)</span>
      targetPort<span class="token punctuation">:</span> <span class="token number">8443</span>
  selector<span class="token punctuation">:</span>
    k8s<span class="token operator">-</span>app<span class="token punctuation">:</span> kubernetes<span class="token operator">-</span>dashboard
  <span class="token builtin">type</span><span class="token punctuation">:</span> NodePort<span class="token punctuation">(</span>添加的<span class="token punctuation">)</span>
<span class="token comment">###创建pod</span>
kubectl <span class="token builtin">apply</span> <span class="token operator">-</span>f recommended<span class="token punctuation">.</span>yaml
<span class="token comment">###查看pod状态信息</span>
kubectl get pods <span class="token operator">-</span>n kubernetes<span class="token operator">-</span>dashboard
<span class="token comment">###登录UI界面：</span>
火狐浏览器登录https<span class="token punctuation">:</span><span class="token operator">//</span>公网ip<span class="token punctuation">:</span><span class="token number">30001</span>，选择tonken验证
我们可以创建一个用户拿到token值
<span class="token comment">###创建用户</span>
创建service account并绑定默认cluster<span class="token operator">-</span>admin管理员集群角色：
 kubectl create serviceaccount dashboard<span class="token operator">-</span>admin <span class="token operator">-</span>n kube<span class="token operator">-</span>system
<span class="token comment">###用户授权</span>
 kubectl create clusterrolebinding dashboard<span class="token operator">-</span>admin <span class="token operator">-</span><span class="token operator">-</span>clusterrole<span class="token operator">=</span>cluster<span class="token operator">-</span>admin <span class="token operator">-</span><span class="token operator">-</span>serviceaccount<span class="token operator">=</span>kube<span class="token operator">-</span>system<span class="token punctuation">:</span>dashboard<span class="token operator">-</span>admin
<span class="token comment">###将token粘贴在网页验证的位置</span>
<span class="token comment">###获取用户Token</span>
kubectl describe secrets <span class="token operator">-</span>n kube<span class="token operator">-</span>system $<span class="token punctuation">(</span>kubectl <span class="token operator">-</span>n kube<span class="token operator">-</span>system get secret <span class="token operator">|</span> awk <span class="token string">'/dashboard-admin/{print $1}'</span><span class="token punctuation">)</span>
</code></pre> 
<h6><a id="126_KeepalivedMaster_239"></a>1.2.6 Keepalived搭建Master高可用</h6> 
<p>Nginx是一个主流Web服务和反向代理服务器，这里用四层实现对apiserver实现负载均衡</p> 
<p>Keepalived基于VIP绑定实现服务器双机热备</p> 
<p>Keepalived主要根据Nginx运行状态判断是否需要故障转移（偏移VIP），例如当Nginx主节点挂掉，VIP会自动绑定在Nginx备节点，从而保证VIP一直可用，实现Nginx高可用。</p> 
<pre><code class="prism language-python"><span class="token comment">###主/备安装软件包</span>
yum install epel<span class="token operator">-</span>release <span class="token operator">-</span>y 
yum install nginx keepalived <span class="token operator">-</span>y 
主<span class="token operator">/</span>备nginx配置文件
cat <span class="token operator">&gt;</span> <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>nginx<span class="token punctuation">.</span>conf <span class="token operator">&lt;&lt;</span> <span class="token string">"EOF"</span> 
user nginx<span class="token punctuation">;</span> 
worker_processes auto<span class="token punctuation">;</span> 
error_log <span class="token operator">/</span>var<span class="token operator">/</span>log<span class="token operator">/</span>nginx<span class="token operator">/</span>error<span class="token punctuation">.</span>log<span class="token punctuation">;</span> 
pid <span class="token operator">/</span>run<span class="token operator">/</span>nginx<span class="token punctuation">.</span>pid<span class="token punctuation">;</span> 
include <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>nginx<span class="token operator">/</span>modules<span class="token operator">/</span><span class="token operator">*</span><span class="token punctuation">.</span>conf<span class="token punctuation">;</span> 
events <span class="token punctuation">{<!-- --></span> 
worker_connections <span class="token number">1024</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
<span class="token comment">#四层负载均衡，为两台Master apiserver组件提供负载均衡 </span>
stream <span class="token punctuation">{<!-- --></span> 
log_format main '$remote_addr $upstream_addr <span class="token operator">-</span> <span class="token punctuation">[</span>$time_local<span class="token punctuation">]</span> $status 
$upstream_bytes_sent'<span class="token punctuation">;</span> 
access_log <span class="token operator">/</span>var<span class="token operator">/</span>log<span class="token operator">/</span>nginx<span class="token operator">/</span>k8s<span class="token operator">-</span>access<span class="token punctuation">.</span>log main<span class="token punctuation">;</span> 
upstream k8s<span class="token operator">-</span>apiserver <span class="token punctuation">{<!-- --></span> 
server <span class="token number">192.168</span><span class="token number">.31</span><span class="token number">.71</span><span class="token punctuation">:</span><span class="token number">6443</span><span class="token punctuation">;</span> <span class="token comment"># Master1 APISERVER IP:PORT </span>
server <span class="token number">192.168</span><span class="token number">.31</span><span class="token number">.74</span><span class="token punctuation">:</span><span class="token number">6443</span><span class="token punctuation">;</span> <span class="token comment"># Master2 APISERVER IP:PORT </span>
<span class="token punctuation">}</span>
server <span class="token punctuation">{<!-- --></span> 
listen <span class="token number">6443</span><span class="token punctuation">;</span> 
proxy_pass k8s<span class="token operator">-</span>apiserver<span class="token punctuation">;</span> 
<span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
http <span class="token punctuation">{<!-- --></span>
log_format main <span class="token string">'$remote_addr - $remote_user [$time_local] "$request" '</span> 
<span class="token string">'$status $body_bytes_sent "$http_referer" '</span> 
<span class="token string">'"$http_user_agent" "$http_x_forwarded_for"'</span><span class="token punctuation">;</span> 
access_log <span class="token operator">/</span>var<span class="token operator">/</span>log<span class="token operator">/</span>nginx<span class="token operator">/</span>access<span class="token punctuation">.</span>log main<span class="token punctuation">;</span> 
sendfile on<span class="token punctuation">;</span> 
tcp_nopush on<span class="token punctuation">;</span> 
tcp_nodelay on<span class="token punctuation">;</span> 
keepalive_timeout <span class="token number">65</span><span class="token punctuation">;</span> 
types_hash_max_size <span class="token number">2048</span><span class="token punctuation">;</span> 
include <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>mime<span class="token punctuation">.</span>types<span class="token punctuation">;</span> 
default_type application<span class="token operator">/</span>octet<span class="token operator">-</span>stream<span class="token punctuation">;</span> 
server <span class="token punctuation">{<!-- --></span> 
listen <span class="token number">80</span> default_server<span class="token punctuation">;</span> 
server_name _<span class="token punctuation">;</span><span class="token number">3.</span> keepalived配置文件（Nginx Master） 
vrrp_script：指定检查nginx工作状态脚本（根据nginx状态判断是否故障转移） 
virtual_ipaddress：虚拟IP（
VIP） 
检查nginx状态脚本： 
location <span class="token operator">/</span> <span class="token punctuation">{<!-- --></span> 
<span class="token punctuation">}</span> 
<span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
EOF 
主Keepalived配置文件
cat <span class="token operator">&gt;</span> <span class="token operator">/</span>etc<span class="token operator">/</span>keepalived<span class="token operator">/</span>keepalived<span class="token punctuation">.</span>conf <span class="token operator">&lt;&lt;</span> EOF 
global_defs <span class="token punctuation">{<!-- --></span> 
notification_email <span class="token punctuation">{<!-- --></span> 
acassen@firewall<span class="token punctuation">.</span>loc 
failover@firewall<span class="token punctuation">.</span>loc 
sysadmin@firewall<span class="token punctuation">.</span>loc 
<span class="token punctuation">}</span>
notification_email_from Alexandre<span class="token punctuation">.</span>Cassen@firewall<span class="token punctuation">.</span>loc 
smtp_server <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span> 
smtp_connect_timeout <span class="token number">30</span> 
router_id NGINX_MASTER 
<span class="token punctuation">}</span>
vrrp_script check_nginx <span class="token punctuation">{<!-- --></span>       
<span class="token comment">#指定检查nginx工作状态脚本（根据nginx状态判断是否故障转移</span>
script <span class="token string">"/etc/keepalived/check_nginx.sh"</span> 
<span class="token punctuation">}</span>
vrrp_instance VI_1 <span class="token punctuation">{<!-- --></span> 
state MASTER 
interface ens33 <span class="token comment"># 修改为实际网卡名 </span>
virtual_router_id <span class="token number">51</span> <span class="token comment"># VRRP 路由 ID实例，每个实例是唯一的 </span>
priority <span class="token number">100</span> <span class="token comment"># 优先级，备服务器设置 90 </span>
advert_int <span class="token number">1</span> <span class="token comment"># 指定VRRP 心跳包通告间隔时间，默认1秒 </span>
authentication <span class="token punctuation">{<!-- --></span> 
auth_type PASS 
auth_pass <span class="token number">1111</span> 
<span class="token punctuation">}</span>
<span class="token comment"># 虚拟IP </span>
virtual_ipaddress <span class="token punctuation">{<!-- --></span> 
<span class="token comment">#虚拟IP（VIP） </span>
<span class="token number">192.168</span><span class="token number">.31</span><span class="token number">.88</span><span class="token operator">/</span><span class="token number">24</span> 
<span class="token punctuation">}</span>
track_script <span class="token punctuation">{<!-- --></span>   <span class="token comment">#</span>
check_nginx 
<span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
EOF
Nginx健康检查脚本
cat <span class="token operator">&gt;</span> <span class="token operator">/</span>etc<span class="token operator">/</span>keepalived<span class="token operator">/</span>check_nginx<span class="token punctuation">.</span>sh <span class="token operator">&lt;&lt;</span> <span class="token string">"EOF"</span> 
<span class="token comment">#!/bin/bash </span>
count<span class="token operator">=</span>$<span class="token punctuation">(</span>ps <span class="token operator">-</span>ef <span class="token operator">|</span>grep nginx <span class="token operator">|</span>egrep <span class="token operator">-</span>cv <span class="token string">"grep|$$"</span><span class="token punctuation">)</span> 
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"$count"</span> <span class="token operator">-</span>eq <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>then 
exit <span class="token number">1</span> 
<span class="token keyword">else</span>
exit <span class="token number">0</span> 
fi
EOF 
chmod <span class="token operator">+</span>x <span class="token operator">/</span>etc<span class="token operator">/</span>keepalived<span class="token operator">/</span>check_nginx<span class="token punctuation">.</span>sh 
备Keepalived配置文件
cat <span class="token operator">&gt;</span> <span class="token operator">/</span>etc<span class="token operator">/</span>keepalived<span class="token operator">/</span>keepalived<span class="token punctuation">.</span>conf <span class="token operator">&lt;&lt;</span> EOF 
global_defs <span class="token punctuation">{<!-- --></span> 
notification_email <span class="token punctuation">{<!-- --></span> 
acassen@firewall<span class="token punctuation">.</span>loc 
failover@firewall<span class="token punctuation">.</span>loc 
sysadmin@firewall<span class="token punctuation">.</span>loc 
<span class="token punctuation">}</span>
notification_email_from Alexandre<span class="token punctuation">.</span>Cassen@firewall<span class="token punctuation">.</span>loc 
smtp_server <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span> 
smtp_connect_timeout <span class="token number">30</span> 
router_id NGINX_BACKUP 
<span class="token punctuation">}</span>
vrrp_script check_nginx <span class="token punctuation">{<!-- --></span> 
script <span class="token string">"/etc/keepalived/check_nginx.sh"</span> 
<span class="token punctuation">}</span>
vrrp_instance VI_1 <span class="token punctuation">{<!-- --></span> 
state BACKUP 
interface ens33 
virtual_router_id <span class="token number">51</span> <span class="token comment"># VRRP 路由 ID实例，每个实例是唯一的 </span>
priority <span class="token number">90</span> 
advert_int <span class="token number">1</span> 
authentication <span class="token punctuation">{<!-- --></span> 
auth_type PASS 
auth_pass <span class="token number">1111</span> 
<span class="token punctuation">}</span>
virtual_ipaddress <span class="token punctuation">{<!-- --></span> 
<span class="token number">192.168</span><span class="token number">.31</span><span class="token number">.88</span><span class="token operator">/</span><span class="token number">24</span> 
<span class="token punctuation">}</span>
track_script <span class="token punctuation">{<!-- --></span> 
check_nginx 
<span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
EOF
<span class="token comment">### 备nginx健康检查脚本如主所示，不重复解释 </span>
</code></pre> 
<h3><a id="k8sPrometheus_384"></a>二、k8s搭建Prometheus</h3> 
<h4><a id="1promethues_386"></a>1.promethues简介</h4> 
<h5><a id="1prometheus_388"></a>（1）什么是prometheus？</h5> 
<p>​ 是一套开源监控、报警、时间序列、数据库的组合采集的样本，以时间序列的方式存在内存（TSDB时序数据库，不属于非关系型或关系型数据库）中，并定时持久化存储在硬盘中。</p> 
<h5><a id="2Prometheus_392"></a>（2）Prometheus适用场景和不适用场景</h5> 
<p>​ 天生适用于k8s,promethus可以很好记录任何纯数据自时间序列，适用于以机器为中心的监视，也适用于高度动态的面向服务的体系结构的监视。</p> 
<p>​ 适用于为微服务架构，优势在于每个 prometheus server是独立的，不依赖与任何介质，当它挂掉的时候自己会书写一份日志。用户可以通过日志排除故障并重启prometheus。</p> 
<p>​ 不适合用于一些精准性需求很高的场合</p> 
<h5><a id="3Prometheus_400"></a>（3）Prometheus关键组件</h5> 
<p><em><strong>*Promethus server*</strong></em></p> 
<p>Promethus server 是promethus组件的核心部分</p> 
<p>负责实现监控数据的获取、存储以及查询,提供PromQL查询语言支持</p> 
<p>Retrieval:采样模块，prometheus的服务器在哪里拉取数据，检索拉取到的数据分发给 TSDB进行存储</p> 
<p>TSDB:存储模块默认本地存储为TSDB</p> 
<p>HTTP server : 提供http接口查询和面板，默认端口为9090</p> 
<p><em><strong>*Nodeport业务数据源*</strong></em></p> 
<p>业务数据源通过pull/push两种方式推送数据到promethus server</p> 
<p>支持其他数据源的指标导入到prometheus，支持数据库，硬件，消息中间件，存储系统。http服务器,jmx等</p> 
<p>负责收集目标对象的性能数据，并通过http接口供prometheus server获取</p> 
<p>只要符合接口格式，就可以被采集</p> 
<p><em><strong>*Mysqld_exporter*</strong></em></p> 
<p>用于监控mysql指标的一个导出器，支持对mysql5.5以上进行监控。</p> 
<p><em><strong>*altermanager报警管理器*</strong></em></p> 
<p>Promethus通过配置报警规则，如果符合报警规则，那么就将报警推送到altermanager。</p> 
<p><em><strong>*可视化监控界面*</strong></em></p> 
<p>promethus收集到数据之后，由webui界面进行可视化图标展示,目前我们可以通过自定义的api客户端进行调用数据展示,也可以直接使用grafana解决方案来展示。</p> 
<p><em><strong>*short-lived jobs:*</strong></em><br> 存在时间不足以被删除的短暂或批量业务，无法通过pull的方式拉取，需要使用push的方式，与pushgeteway结合使用。</p> 
<p><em><strong>*Service Discovery:*</strong></em><br> 服务发现，prometheus支持多种服务发现机制： 文件，DNS，k8s，openstack,等，基于服务发现的过程，通过第三方接口，prometheus查询到需要监控的target列表，然后轮询这些target获取监控数据。</p> 
<p><em><strong>*客户端SDK*</strong></em><br> 官方提供的客户端类库有go，java，python，ruby</p> 
<p><em><strong>*pushgateway*</strong></em><br> 支持临时性的job主动推送指标的中间网关，prometheus默认通过pull方式从exporters拉取，但有些情况我们是不允许promethes</p> 
<p>与exporters直接进行通信的，这时候我们可以使用pushgateway由客户端主动push数据到pushgateway，在由prometheus拉取。很</p> 
<p>多时候我们需要自定义一些组件来采集</p> 
<p><em><strong>*proDash*</strong></em><br> 使用rails开发的dashboard，用于可视化指标数据</p> 
<h5><a id="4_455"></a>（4）工作过程</h5> 
<ul><li>prometheus server 定期从配置好的jobs或者exporters中拉metrics.或者接受来自pushgateway发过来的metrics,或者从其他的 prometheus server中拉取metrics。</li><li>prometheus server 在本地存储收集到的metrics,并运行已经定义好的arlt.rules,记录新的时间序列或者向alertmanager推送报警。</li><li>Alertmanager根据配置文件，对接受的警报进行处理，发出告警。</li><li>在图形界面中，可视化采集数据，可以使用别人写好的grafana模板。</li></ul> 
<h5><a id="11_462"></a>1.1实操步骤</h5> 
<h6><a id="112_master_464"></a>1.1.2 master创建一个命名空间</h6> 
<pre><code class="prism language-python"><span class="token comment">### master创建namespace</span>
<span class="token punctuation">[</span>root@k8s<span class="token operator">-</span>master<span class="token operator">-</span><span class="token number">01</span><span class="token punctuation">]</span><span class="token comment">#Vim prometheus_grafana_namespaces.yaml</span>
apiVersion<span class="token punctuation">:</span> v1
kind<span class="token punctuation">:</span> Namespace 
metadata<span class="token punctuation">:</span> 
name<span class="token punctuation">:</span> prom<span class="token operator">-</span>grafana 
labels<span class="token punctuation">:</span> 
name<span class="token punctuation">:</span> prom<span class="token operator">-</span>grafana
<span class="token punctuation">[</span>root@k8s<span class="token operator">-</span>master<span class="token operator">-</span><span class="token number">01</span> <span class="token punctuation">]</span><span class="token comment"># kubectl create -f prom-grafana-namespaces.yaml</span>

<span class="token comment">### master创建一个SA账号</span>
<span class="token punctuation">[</span>root@k8s<span class="token operator">-</span>master<span class="token operator">-</span><span class="token number">01</span><span class="token punctuation">]</span><span class="token comment"># kubectl create serviceaccount drifter -n prom-grafana</span>

<span class="token comment">### matser节点把sa 账号drifter通过clusterrolebing绑定到clusterrole上</span>
<span class="token punctuation">[</span>root@k8s<span class="token operator">-</span>master<span class="token operator">-</span><span class="token number">01</span> <span class="token punctuation">]</span><span class="token comment"># kubectl create clusterrolebinding drifter-clusterrolebinding -n prom-grafana --clusterrole=cluster-admin  --serviceaccount=prom-grafana:drifter</span>

<span class="token comment">####在集群的任意节点上创建一个数据目录</span>
mkdir <span class="token operator">/</span>data
chmod <span class="token number">777</span> <span class="token operator">/</span>data<span class="token operator">/</span>
</code></pre> 
<h6><a id="113_masterconfigmapprometheus_488"></a>1.1.3 master创建一个configmap存储卷，用来存放prometheus配置信息</h6> 
<pre><code>[root@k8s-master-01]#vim prometheus-cfg.yaml
---
kind: ConfigMap
apiVersion: v1
metadata:
  labels:
    app: prometheus
  name: prometheus-config
  namespace: monitor-sa
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      scrape_timeout: 10s
      evaluation_interval: 1m
    scrape_configs:
    - job_name: 'kubernetes-node'
      kubernetes_sd_configs:
      - role: node
      relabel_configs:
      - source_labels: [__address__]
        regex: '(.*):10250'
        replacement: '${1}:9100'
        target_label: __address__
        action: replace
      - action: labelmap
        regex: __meta_kubernetes_node_label_(.+)
    - job_name: 'kubernetes-node-cadvisor'
      kubernetes_sd_configs:
      - role:  node
      scheme: https
      tls_config:
        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      relabel_configs:
      - action: labelmap
        regex: __meta_kubernetes_node_label_(.+)
      - target_label: __address__
        replacement: kubernetes.default.svc:443
      - source_labels: [__meta_kubernetes_node_name]
        regex: (.+)
        target_label: __metrics_path__
        replacement: /api/v1/nodes/${1}/proxy/metrics/cadvisor
    - job_name: 'kubernetes-apiserver'
      kubernetes_sd_configs:
      - role: endpoints
      scheme: https
      tls_config:
        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      relabel_configs:
      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
        action: keep
        regex: default;kubernetes;https
    - job_name: 'kubernetes-service-endpoints'
      kubernetes_sd_configs:
      - role: endpoints
      relabel_configs:
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]
        action: replace
        target_label: __scheme__
        regex: (https?)
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
      - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]
        action: replace
        target_label: __address__
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: $1:$2
      - action: labelmap
        regex: __meta_kubernetes_service_label_(.+)
      - source_labels: [__meta_kubernetes_namespace]
        action: replace
        target_label: kubernetes_namespace
      - source_labels: [__meta_kubernetes_service_name]
        action: replace
        target_label: kubernetes_name

### 创建存储卷pod
kubectl create -f prometheus-cfg.yaml
</code></pre> 
<h6><a id="114deploymentprometheus_server_578"></a>1.1.4通过deployment部署prometheus server</h6> 
<pre><code>[root@k8s-master-01]#Vim  prometheus-deployment.yaml
[root@k8s-master-01 ]# more prometheus-deployment.yaml
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: prometheus-server
  namespace: prom-grafana
  labels:
    app: prometheus
spec:
  replicas: 1
  selector:
    matchLabels:
      app: prometheus
      component: server
    #matchExpressions:
    #- {key: app, operator: In, values: [prometheus]}
    #- {key: component, operator: In, values: [server]}
  template:
    metadata:
      labels:
        app: prometheus
        component: server
      annotations:
        prometheus.io/scrape: 'false'
    spec:
      nodeName: k8s-node-02  #prometheus调度到这个节点上。
      serviceAccountName: drifter
      containers:
      - name: prometheus
        image: prom/prometheus:v2.2.1
        imagePullPolicy: IfNotPresent
        command:
          - prometheus
          - --config.file=/etc/prometheus/prometheus.yml
          - --storage.tsdb.path=/prometheus
          - --storage.tsdb.retention=720h
        ports:
        - containerPort: 9090
          protocol: TCP
        volumeMounts:
        - mountPath: /etc/prometheus/prometheus.yml
          name: prometheus-config
          subPath: prometheus.yml
        - mountPath: /prometheus/
          name: prometheus-storage-volume
      volumes:
        - name: prometheus-config
          configMap:
            name: prometheus-config
            items:
              - key: prometheus.yml
                path: prometheus.yml
                mode: 0644
        - name: prometheus-storage-volume
          hostPath:
           path: /data
           type: Directory

###创建prometheus server pod
kubectl create -f prometheus-deployment.yaml

###查看prometheus server pod状态信息
kubectl get pod -n prom-grafana


</code></pre> 
<h6><a id="115_prometheus_650"></a>1.1.5 对外暴露prometheus端口</h6> 
<pre><code>###prometheus pod创建一个service
[root@k8s-master-01]#vim  prometheus-svc.yaml
---
apiVersion: v1
kind: Service
metadata:
  name: prometheus-server
  namespace: prom-grafana
  labels:
    app: prometheus
spec:
#  type: NodePort     
  type: ClusterIP     
  ports:
    - port: 9090
      targetPort: 9090
#      protocol: TCP
  selector:
    app: prometheus
    component: prometheus-server

###对外暴露prometheus端口
[root@k8s-master-01]#kubectl create -f prometheus-svc.yaml

###查看pod状态信息
[root@k8s-master-01]#kubectl get svc -n prom-grafana
NAME                TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE
prometheus-server   ClusterIP   10.103.172.209   &lt;none&gt;        9090/TCP   4m57s
</code></pre> 
<h6><a id="116prometheus_683"></a>1.1.6prometheus热更新</h6> 
<pre><code>
为了每次修改配置文件可以热加载prometheus，也就是不停止prometheus，就可以使配置生效，如修改prometheus-cfg.yaml，想要使配置生效可用如下热加载命令：
curl -X POST http://100.119.255.145:9090/-/reload

###热加载速度比较慢，可以暴力重启prometheus，如修改上面的prometheus-cfg.yaml文件之后，可执行如下强制删除：
[root@k8s-master-01]#kubectl delete -f prometheus-cfg.yaml
[root@k8s-master-01]#kubectl delete -f prometheus-deployment.yaml

###然后再通过apply更新：
[root@k8s-master-01]#kubectl apply -f prometheus-cfg.yaml
[root@k8s-master-01]#kubectl apply -f prometheus-deployment.yaml
注意：线上最好热加载，暴力删除可能造成监控数据的丢失
</code></pre> 
<h6><a id="117_masternodeporter_700"></a>1.1.7 master节点部署node-porter组件</h6> 
<p>采集机器（物理机、虚拟机、云主机等）的监控指标数据，能够采集到的指标包括CPU, 内存，磁盘，网络，文件数等信息。</p> 
<pre><code class="prism language-python"><span class="token punctuation">[</span>root@k8s<span class="token operator">-</span>master<span class="token operator">-</span><span class="token number">01</span><span class="token punctuation">]</span><span class="token comment">#vim node-export.yaml</span>
apiVersion<span class="token punctuation">:</span> apps<span class="token operator">/</span>v1
kind<span class="token punctuation">:</span> DaemonSet
metadata<span class="token punctuation">:</span>
  name<span class="token punctuation">:</span> node<span class="token operator">-</span>exporter
  namespace<span class="token punctuation">:</span> prom<span class="token operator">-</span>grafana
  labels<span class="token punctuation">:</span>
    name<span class="token punctuation">:</span> node<span class="token operator">-</span>exporter
spec<span class="token punctuation">:</span>
  selector<span class="token punctuation">:</span>
    matchLabels<span class="token punctuation">:</span>
     name<span class="token punctuation">:</span> node<span class="token operator">-</span>exporter
  template<span class="token punctuation">:</span>
    metadata<span class="token punctuation">:</span>
      labels<span class="token punctuation">:</span>
        name<span class="token punctuation">:</span> node<span class="token operator">-</span>exporter
    spec<span class="token punctuation">:</span>
      hostPID<span class="token punctuation">:</span> true
      hostIPC<span class="token punctuation">:</span> true
      hostNetwork<span class="token punctuation">:</span> true
      containers<span class="token punctuation">:</span>
      <span class="token operator">-</span> name<span class="token punctuation">:</span> node<span class="token operator">-</span>exporter
        image<span class="token punctuation">:</span> prom<span class="token operator">/</span>node<span class="token operator">-</span>exporter<span class="token punctuation">:</span>v0<span class="token punctuation">.</span><span class="token number">16.0</span>
        ports<span class="token punctuation">:</span>
        <span class="token operator">-</span> containerPort<span class="token punctuation">:</span> <span class="token number">9100</span>
        resources<span class="token punctuation">:</span>
          requests<span class="token punctuation">:</span>
            cpu<span class="token punctuation">:</span> <span class="token number">0.15</span>
        securityContext<span class="token punctuation">:</span>
          privileged<span class="token punctuation">:</span> true
        args<span class="token punctuation">:</span>
        <span class="token operator">-</span> <span class="token operator">-</span><span class="token operator">-</span>path<span class="token punctuation">.</span>procfs
        <span class="token operator">-</span> <span class="token operator">/</span>host<span class="token operator">/</span>proc
        <span class="token operator">-</span> <span class="token operator">-</span><span class="token operator">-</span>path<span class="token punctuation">.</span>sysfs
        <span class="token operator">-</span> <span class="token operator">/</span>host<span class="token operator">/</span>sys
        <span class="token operator">-</span> <span class="token operator">-</span><span class="token operator">-</span>collector<span class="token punctuation">.</span>filesystem<span class="token punctuation">.</span>ignored<span class="token operator">-</span>mount<span class="token operator">-</span>points
        <span class="token operator">-</span> <span class="token string">'"^/(sys|proc|dev|host|etc)($|/)"'</span>
        volumeMounts<span class="token punctuation">:</span>
        <span class="token operator">-</span> name<span class="token punctuation">:</span> dev
          mountPath<span class="token punctuation">:</span> <span class="token operator">/</span>host<span class="token operator">/</span>dev
        <span class="token operator">-</span> name<span class="token punctuation">:</span> proc
          mountPath<span class="token punctuation">:</span> <span class="token operator">/</span>host<span class="token operator">/</span>proc
        <span class="token operator">-</span> name<span class="token punctuation">:</span> sys
          mountPath<span class="token punctuation">:</span> <span class="token operator">/</span>host<span class="token operator">/</span>sys
        <span class="token operator">-</span> name<span class="token punctuation">:</span> rootfs
          mountPath<span class="token punctuation">:</span> <span class="token operator">/</span>rootfs
      tolerations<span class="token punctuation">:</span>
      <span class="token operator">-</span> key<span class="token punctuation">:</span> <span class="token string">"node-role.kubernetes.io/master"</span>
        operator<span class="token punctuation">:</span> <span class="token string">"Exists"</span>
        effect<span class="token punctuation">:</span> <span class="token string">"NoSchedule"</span>
      volumes<span class="token punctuation">:</span>
        <span class="token operator">-</span> name<span class="token punctuation">:</span> proc
          hostPath<span class="token punctuation">:</span>
            path<span class="token punctuation">:</span> <span class="token operator">/</span>proc
        <span class="token operator">-</span> name<span class="token punctuation">:</span> dev
          hostPath<span class="token punctuation">:</span>
            path<span class="token punctuation">:</span> <span class="token operator">/</span>dev
        <span class="token operator">-</span> name<span class="token punctuation">:</span> sys
          hostPath<span class="token punctuation">:</span>
            path<span class="token punctuation">:</span> <span class="token operator">/</span>sys
        <span class="token operator">-</span> name<span class="token punctuation">:</span> rootfs
          hostPath<span class="token punctuation">:</span>
            path<span class="token punctuation">:</span> <span class="token operator">/</span>
 <span class="token punctuation">[</span>root@k8s<span class="token operator">-</span>master<span class="token operator">-</span><span class="token number">01</span><span class="token punctuation">]</span><span class="token comment">#kubectl create -f node-export.yaml</span>
 <span class="token punctuation">[</span>root@k8s<span class="token operator">-</span>master<span class="token operator">-</span><span class="token number">01</span><span class="token punctuation">]</span><span class="token comment">#kubectl get pods -n prom-grafana 查看到pod处于running状态则证明pod创建成功</span>
node<span class="token operator">-</span>export默认的监听端口是<span class="token number">9100</span>，可以看到当前主机获取到的所有监控数据（如图）
</code></pre> 
<h3><a id="k8sGrafana_773"></a>三、k8s搭建Grafana</h3> 
<h4><a id="1grafana_775"></a>1.grafana介绍</h4> 
<h5><a id="1grafana_777"></a>（1）什么是grafana</h5> 
<p>简单来说，是一个多用途的监控工具，同时邮件等方式进行有效的预警通知，丰富直观的可视化界面，是一种数据源配置是其优点所在,是一个跨平台的源的度量分析和可视化工具,可与通过将采集的数据查询然后可视化的展示并及时通知。</p> 
<p>1、展示方式：</p> 
<p>客户端可视化有丰富的仪表盘比如热图、折线图等多种展示方式</p> 
<p>2、数据源:Graphite，InfluxDB，OpenTSDB，Prometheus，Elasticsearch，CloudWatch和KairosDB等</p> 
<p>3、通知提醒：可视方式展示重要指标的报警规则，它将不断计算发送通知，在数据达到阈值时Slack、PagerDuty等获得通知</p> 
<p>4、混合展示：在同一图表中混合使用不同数据源，可以基于每个查询指定数据源，甚至自定义数据源</p> 
<p>5、注释：使用来自不同数据源的丰富事件注释图表，将鼠标悬停在事件上会显示完整的事件元数据和标记</p> 
<p>6、过滤器：Ad-hoc过滤器允许动态创建新的键/值过滤器，这些过滤器会自动应用于使用该数据源的所有查询。</p> 
<h5><a id="2Grafana_795"></a>（2）Grafana结构</h5> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-D9s2ZoRP-1657117614572)(file:///C:\Users\ZOOWEM~1\AppData\Local\Temp\ksohtml4440\wps1.jpg)]</p> 
<h5><a id="3_799"></a>（3）通俗解释工作过程</h5> 
<p>Export监控指标并获取指标数据推送到prometheus，prometheus拉取数据并连接到grafana，直观展示被监控状态。</p> 
<h5><a id="12__803"></a>1.2 实操步骤</h5> 
<h6><a id="121_mastergrafana_805"></a>1.2.1 master上安装grafana</h6> 
<p>外网可以自动下载镜像，内网可以上传下载好镜像</p> 
<pre><code class="prism language-python"><span class="token punctuation">[</span>root@k8s<span class="token operator">-</span>master<span class="token operator">-</span><span class="token number">01</span><span class="token punctuation">]</span><span class="token comment">#vim  grafana.yaml</span>
apiVersion<span class="token punctuation">:</span> apps<span class="token operator">/</span>v1
kind<span class="token punctuation">:</span> Deployment
metadata<span class="token punctuation">:</span>
  name<span class="token punctuation">:</span> grafana<span class="token operator">-</span>server
  namespace<span class="token punctuation">:</span> prom<span class="token operator">-</span>grafana
spec<span class="token punctuation">:</span>
  replicas<span class="token punctuation">:</span> <span class="token number">1</span>
  selector<span class="token punctuation">:</span>
    matchLabels<span class="token punctuation">:</span>
      task<span class="token punctuation">:</span> monitoring
      k8s<span class="token operator">-</span>app<span class="token punctuation">:</span> grafana
  template<span class="token punctuation">:</span>
    metadata<span class="token punctuation">:</span>
      labels<span class="token punctuation">:</span>
        task<span class="token punctuation">:</span> monitoring
        k8s<span class="token operator">-</span>app<span class="token punctuation">:</span> grafana
    spec<span class="token punctuation">:</span>
      imagePullSecrets<span class="token punctuation">:</span>
      <span class="token operator">-</span> name<span class="token punctuation">:</span> registry<span class="token operator">-</span>pps
      containers<span class="token punctuation">:</span>
      <span class="token operator">-</span> name<span class="token punctuation">:</span> grafana<span class="token operator">-</span>server
        image<span class="token punctuation">:</span> registry<span class="token punctuation">.</span>drifter<span class="token punctuation">.</span>net<span class="token operator">/</span>grafana<span class="token punctuation">:</span><span class="token number">5.0</span><span class="token number">.4</span>
        ports<span class="token punctuation">:</span>
        <span class="token operator">-</span> containerPort<span class="token punctuation">:</span> <span class="token number">3000</span>
          protocol<span class="token punctuation">:</span> TCP
        volumeMounts<span class="token punctuation">:</span>
        <span class="token operator">-</span> mountPath<span class="token punctuation">:</span> <span class="token operator">/</span>etc<span class="token operator">/</span>ssl<span class="token operator">/</span>certs
          name<span class="token punctuation">:</span> ca<span class="token operator">-</span>certificates
          readOnly<span class="token punctuation">:</span> true
        <span class="token operator">-</span> mountPath<span class="token punctuation">:</span> <span class="token operator">/</span>var
          name<span class="token punctuation">:</span> grafana<span class="token operator">-</span>storage
        env<span class="token punctuation">:</span>
        <span class="token operator">-</span> name<span class="token punctuation">:</span> INFLUXDB_HOST
          value<span class="token punctuation">:</span> monitoring<span class="token operator">-</span>influxdb
        <span class="token operator">-</span> name<span class="token punctuation">:</span> GF_SERVER_HTTP_PORT
          value<span class="token punctuation">:</span> <span class="token string">"3000"</span>
        <span class="token operator">-</span> name<span class="token punctuation">:</span> GF_AUTH_BASIC_ENABLED
          value<span class="token punctuation">:</span> <span class="token string">"false"</span>
        <span class="token operator">-</span> name<span class="token punctuation">:</span> GF_AUTH_ANONYMOUS_ENABLED
          value<span class="token punctuation">:</span> <span class="token string">"true"</span>
        <span class="token operator">-</span> name<span class="token punctuation">:</span> GF_AUTH_ANONYMOUS_ORG_ROLE
          value<span class="token punctuation">:</span> Admin
        <span class="token operator">-</span> name<span class="token punctuation">:</span> GF_SERVER_ROOT_URL
          value<span class="token punctuation">:</span> <span class="token operator">/</span>
      volumes<span class="token punctuation">:</span>
      <span class="token operator">-</span> name<span class="token punctuation">:</span> ca<span class="token operator">-</span>certificates
        hostPath<span class="token punctuation">:</span>
          path<span class="token punctuation">:</span> <span class="token operator">/</span>etc<span class="token operator">/</span>ssl<span class="token operator">/</span>certs
      <span class="token operator">-</span> name<span class="token punctuation">:</span> grafana<span class="token operator">-</span>storage
        emptyDir<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
</code></pre> 
<h6><a id="122_pod_863"></a>1.2.2 创建pod</h6> 
<pre><code class="prism language-python"><span class="token punctuation">[</span>root@k8s<span class="token operator">-</span>master<span class="token operator">-</span><span class="token number">01</span><span class="token punctuation">]</span><span class="token comment">#kubectl  create  -f grafana.yaml</span>
deployment<span class="token punctuation">.</span>apps<span class="token operator">/</span>grafana<span class="token operator">-</span>server created
</code></pre> 
<h6><a id="123_grafana_pod__runningpod_870"></a>1.2.3 查看grafana pod 状态 ，处于running状态则pod创建成功</h6> 
<pre><code class="prism language-python"><span class="token punctuation">[</span>root@k8s<span class="token operator">-</span>master<span class="token operator">-</span><span class="token number">01</span><span class="token punctuation">]</span><span class="token comment">#kubectl get pods -n prom-grafana</span>
NAME                                 READY   STATUS    RESTARTS   AGE
grafana<span class="token operator">-</span>server<span class="token operator">-</span>657495c99d<span class="token operator">-</span>x5hnn      <span class="token number">1</span><span class="token operator">/</span><span class="token number">1</span>     Running   <span class="token number">0</span>          23s
</code></pre> 
<h6><a id="124_grafana_878"></a>1.2.4 对外暴露grafana端口</h6> 
<pre><code class="prism language-python"><span class="token punctuation">[</span>root@k8s<span class="token operator">-</span>master<span class="token operator">-</span><span class="token number">01</span><span class="token punctuation">]</span><span class="token comment"># vim grafana-svc.yaml</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
apiVersion<span class="token punctuation">:</span> v1
kind<span class="token punctuation">:</span> Service
metadata<span class="token punctuation">:</span>
  labels<span class="token punctuation">:</span>
    kubernetes<span class="token punctuation">.</span>io<span class="token operator">/</span>cluster<span class="token operator">-</span>service<span class="token punctuation">:</span> <span class="token string">'true'</span>
    kubernetes<span class="token punctuation">.</span>io<span class="token operator">/</span>name<span class="token punctuation">:</span> grafana<span class="token operator">-</span>server
  name<span class="token punctuation">:</span> grafana<span class="token operator">-</span>server
  namespace<span class="token punctuation">:</span> prom<span class="token operator">-</span>grafana
spec<span class="token punctuation">:</span>
  ports<span class="token punctuation">:</span>
  <span class="token operator">-</span> port<span class="token punctuation">:</span> <span class="token number">80</span>
    targetPort<span class="token punctuation">:</span> <span class="token number">3000</span>
  selector<span class="token punctuation">:</span>
    k8s<span class="token operator">-</span>app<span class="token punctuation">:</span> grafana
<span class="token comment">#  type: NodePort</span>
  <span class="token builtin">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token punctuation">[</span>root@k8s<span class="token operator">-</span>master<span class="token operator">-</span><span class="token number">01</span><span class="token punctuation">]</span><span class="token comment"># kubectl create -f grafana-svc.yaml</span>

</code></pre> 
<h6><a id="125__903"></a>1.2.5 查看暴露的端口</h6> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@k8s-master-01<span class="token punctuation">]</span><span class="token comment"># kubectl get svc -n prom-grafana</span>
NAME                TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>    AGE
grafana-server      ClusterIP   <span class="token number">10.102</span>.129.245   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">3000</span>/TCP   2m3s
prometheus-server   ClusterIP   <span class="token number">10.96</span>.17.72      <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9090</span>/TCP   12m
</code></pre> 
<h6><a id="126__911"></a>1.2.6 访问效果</h6> 
<ul><li>访问prometheus</li></ul> 
<p><img src="https://images2.imgbox.com/78/f9/KI4OMsky_o.png" alt="在这里插入图片描述"></p> 
<ul><li>访问grafana</li></ul> 
<p><img src="https://images2.imgbox.com/73/a0/bHI01DZW_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="httpsmpweixinqqcomsaiCIsR4gbJucdQnC6pHw_920"></a>本篇转载于：https://mp.weixin.qq.com/s/a-iCI-sR4gbJucdQnC6pHw</h3>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8400e65fd0c96de14d0fab67ddf2432a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">用tkinter做一个简单图形界面</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3da771a464fe6f563eb2a47d345dcacb/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">理解this的指向</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>