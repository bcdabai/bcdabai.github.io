<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>windows openssl安装和基本使用(代码演示) - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="windows openssl安装和基本使用(代码演示)" />
<meta property="og:description" content="概述 本文主要讲到了openssl的基本使用方法，开发环境为windows，开发工具为VS2019.本文主要是说明openssl如何使用，不介绍任何理论知识，如果有不懂的，请自行百度。个人建议下一个everything查询工具，真的很好用，比window自带的查询快了很多，可以查询自己想要的文件
OPENSSL安装 安装过程网上有很多，OPENSSL安装，注意你安装的OPENSSL的版本以及位数（32位或者64位），假如我安装的是64位的openssl，安装目录为D:\Program Files\OpenSSL-Win64，你可以自行选择你的安装目录，安装完成后，查看安装的openssl版本，使用控制台输入openssl version即可
秘钥key和公钥的生成 在控制命令行中输入以下命令：
openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -sha256 -days 365 网上有很多生成秘钥和公钥的文章，不过都没成功，最后在stackoverflow找到了可以用的方法，原文地址为：openssl秘钥和公钥的生成，以下是截图
Enter PEM pass phrase：提示输入pem文件的密码，注意，后面要用到这个密码，可以使用自己常用的密码，输入后会再次确认密码，然后就是一些基本信息，可以默认为空。截图如下，基本上这时候就得到了秘钥key.pem和公钥cert.pem，后面要用到这2个文件。，生成的位置为当前目录，比如我的就是在C:\Users\86138,即控制台的显示目录。
项目设置 使用VS创建一个控制台项目，创建一个客户端和服务器项目，由于我下载的是64位，openssl3.0版本。因此我项目也是64位的。
项目的配置，服务器端和客户端都是相同配置，这里我就只说一个即可，主要是设置openssl的lib和头文件的路径，这和使用任外部库都是一样的。截图如下，注意我的openssl安装位置为D:\Program Files\OpenSSL-Win64，请选择你安装位置即可。
预处理器里添加2个定义：CRT_SECURE_NO_WARNINGS;_WINSOCK_DEPRECATED_NO_WARNINGS;
附加依赖项：libssl.lib;openssl.lib;libcrypto.lib;liblegacy.lib;
最后将前面生成的cert.pem和key.pem放到exe目录下，为什么放到这个目录，是因为下面的代码用到的这2个文件是当前目录，不管怎么样，只要能找到这2个文件即可。
配置很简单，就上面几步，基本上就可以了。
代码部分 客户端代码 #include &lt;stdio.h&gt; #include &lt;errno.h&gt; #include &lt;malloc.h&gt; #include &lt;string.h&gt; # include &lt;winsock2.h&gt; #include &lt;ws2tcpip.h&gt; #include &lt;openssl/ssl.h&gt; #include &lt;openssl/err.h&gt; #define FAIL -1 #pragma comment(lib, &#34;Ws2_32.lib&#34;) //Added the LoadCertificates how in the server-side makes. int OpenConnection(const char* hostname, int port) { SOCKET sd; struct hostent* host; struct sockaddr_in addr; WORD wVersionRequested; WSADATA wsaData; int err; /* Use the MAKEWORD(lowbyte, highbyte) macro declared in Windef." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/eef1875c1dddba8e5164215fbb412273/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-22T10:02:57+08:00" />
<meta property="article:modified_time" content="2022-09-22T10:02:57+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">windows openssl安装和基本使用(代码演示)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>概述</h2> 
<p>本文主要讲到了openssl的基本使用方法，开发环境为windows，开发工具为VS2019.本文主要是说明openssl如何使用，不介绍任何理论知识，如果有不懂的，请自行百度。<strong>个人建议下一个everything查询工具，真的很好用，比window自带的查询快了很多，可以查询自己想要的文件</strong></p> 
<h2><a id="OPENSSL_2"></a>OPENSSL安装</h2> 
<p>安装过程网上有很多，<a href="https://www.cnblogs.com/dingshaohua/p/12271280.html" rel="nofollow">OPENSSL安装</a>，注意你安装的OPENSSL的版本以及位数（32位或者64位），假如我安装的是64位的openssl，安装目录为<strong>D:\Program Files\OpenSSL-Win64</strong>，你可以自行选择你的安装目录，安装完成后，查看安装的openssl版本，使用控制台输入<strong>openssl version</strong>即可<br> <img src="https://images2.imgbox.com/5d/7e/ve6hKSeW_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="key_5"></a>秘钥key和公钥的生成</h2> 
<p>在控制命令行中输入以下命令：</p> 
<pre><code class="prism language-c">openssl req <span class="token operator">-</span>x509 <span class="token operator">-</span>newkey rsa<span class="token operator">:</span><span class="token number">4096</span> <span class="token operator">-</span>keyout key<span class="token punctuation">.</span>pem <span class="token operator">-</span>out cert<span class="token punctuation">.</span>pem <span class="token operator">-</span>sha256 <span class="token operator">-</span>days <span class="token number">365</span>
</code></pre> 
<p>网上有很多生成秘钥和公钥的文章，不过都没成功，最后在stackoverflow找到了可以用的方法，原文地址为：<a href="https://stackoverflow.com/questions/10175812/how-to-generate-a-self-signed-ssl-certificate-using-openssl" rel="nofollow">openssl秘钥和公钥的生成</a>，以下是截图<br> <img src="https://images2.imgbox.com/64/21/LKMtcpb5_o.png" alt="在这里插入图片描述"><br> <strong>Enter PEM pass phrase</strong>：提示输入pem文件的密码，<strong>注意，后面要用到这个密码，可以使用自己常用的密码，输入后会再次确认密码</strong>，然后就是一些基本信息，可以默认为空。截图如下，基本上这时候就得到了<strong>秘钥key.pem和公钥cert.pem，后面要用到这2个文件。，生成的位置为当前目录，比如我的就是在C:\Users\86138,即控制台的显示目录</strong>。<br> <img src="https://images2.imgbox.com/ca/c5/tFV1e3RR_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_14"></a>项目设置</h2> 
<p>使用VS创建一个控制台项目，创建一个客户端和服务器项目，由于我下载的是64位，openssl3.0版本。因此我项目也是64位的。<br> <img src="https://images2.imgbox.com/3c/43/b1uz9rZA_o.png" alt="在这里插入图片描述"><br> 项目的配置，服务器端和客户端都是相同配置，这里我就只说一个即可，主要是设置openssl的lib和头文件的路径，这和使用任外部库都是一样的。截图如下，<strong>注意我的openssl安装位置为D:\Program Files\OpenSSL-Win64，请选择你安装位置即可。</strong><br> <img src="https://images2.imgbox.com/cb/27/8Mwxu2ri_o.png" alt="在这里插入图片描述"><br> 预处理器里添加2个定义：<strong>CRT_SECURE_NO_WARNINGS;_WINSOCK_DEPRECATED_NO_WARNINGS;</strong><br> <img src="https://images2.imgbox.com/89/f6/flDHgoN7_o.png" alt="在这里插入图片描述"><br> 附加依赖项：<strong>libssl.lib;openssl.lib;libcrypto.lib;liblegacy.lib;</strong><br> <img src="https://images2.imgbox.com/2d/6c/Iy0adyp9_o.png" alt="在这里插入图片描述"><br> <strong>最后将前面生成的cert.pem和key.pem放到exe目录下，为什么放到这个目录，是因为下面的代码用到的这2个文件是当前目录，不管怎么样，只要能找到这2个文件即可。</strong><br> <img src="https://images2.imgbox.com/44/16/KSFzJxZb_o.png" alt="在这里插入图片描述"><br> 配置很简单，就上面几步，基本上就可以了。</p> 
<h2><a id="_26"></a>代码部分</h2> 
<h3><a id="_27"></a>客户端代码</h3> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;malloc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">include</span> <span class="token string">&lt;winsock2.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ws2tcpip.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;openssl/ssl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;openssl/err.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FAIL</span>    <span class="token expression"><span class="token operator">-</span><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">comment</span><span class="token punctuation">(</span>lib<span class="token punctuation">,</span> </span><span class="token string">"Ws2_32.lib"</span><span class="token expression"><span class="token punctuation">)</span></span></span>
<span class="token comment">//Added the LoadCertificates how in the server-side makes.    </span>
<span class="token keyword">int</span> <span class="token function">OpenConnection</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> hostname<span class="token punctuation">,</span> <span class="token keyword">int</span> port<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	SOCKET sd<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">hostent</span><span class="token operator">*</span> host<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> addr<span class="token punctuation">;</span>

	WORD wVersionRequested<span class="token punctuation">;</span>
	WSADATA wsaData<span class="token punctuation">;</span>
	<span class="token keyword">int</span> err<span class="token punctuation">;</span>

	<span class="token comment">/* Use the MAKEWORD(lowbyte, highbyte) macro declared in Windef.h */</span>
	wVersionRequested <span class="token operator">=</span> <span class="token function">MAKEWORD</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	err <span class="token operator">=</span> <span class="token function">WSAStartup</span><span class="token punctuation">(</span>wVersionRequested<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wsaData<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">/* Tell the user that we could not find a usable */</span>
		<span class="token comment">/* Winsock DLL.                                  */</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"WSAStartup failed with error: %d\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	sd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/bzero(&amp;addr, sizeof(addr));</span>
	addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
	addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
	addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span>hostname<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span>sd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span> ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">//close(sd);</span>
		<span class="token function">perror</span><span class="token punctuation">(</span>hostname<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> sd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

SSL_CTX<span class="token operator">*</span> <span class="token function">InitCTX</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//SSL_METHOD* method;</span>
	SSL_CTX<span class="token operator">*</span> ctx<span class="token punctuation">;</span>

	<span class="token comment">//OpenSSL_add_all_algorithms();  /* Load cryptos, et.al. */</span>
	<span class="token function">SSL_load_error_strings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">/* Bring in and register error messages */</span>
	SSL_METHOD <span class="token keyword">const</span><span class="token operator">*</span> meth <span class="token operator">=</span> <span class="token function">SSLv23_client_method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* Create new client-method instance */</span>
	<span class="token comment">//method = TLSv1_method();</span>
	ctx <span class="token operator">=</span> <span class="token function">SSL_CTX_new</span><span class="token punctuation">(</span>meth<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">/* Create new context */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ctx <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">ERR_print_errors_fp</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Eroor: %s\n"</span><span class="token punctuation">,</span> <span class="token constant">stderr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> ctx<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">ShowCerts</span><span class="token punctuation">(</span>SSL<span class="token operator">*</span> ssl<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	X509<span class="token operator">*</span> cert<span class="token punctuation">;</span>
	<span class="token keyword">char</span><span class="token operator">*</span> line1<span class="token punctuation">,</span> <span class="token operator">*</span> line2<span class="token punctuation">;</span>

	cert <span class="token operator">=</span> <span class="token function">SSL_get_peer_certificate</span><span class="token punctuation">(</span>ssl<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* get the server's certificate */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>cert <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Server certificates:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		line1 <span class="token operator">=</span> <span class="token function">X509_NAME_oneline</span><span class="token punctuation">(</span><span class="token function">X509_get_subject_name</span><span class="token punctuation">(</span>cert<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Subject: %s\n"</span><span class="token punctuation">,</span> line1<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//free(line);       /* free the malloc'ed string */</span>
		line2 <span class="token operator">=</span> <span class="token function">X509_NAME_oneline</span><span class="token punctuation">(</span><span class="token function">X509_get_issuer_name</span><span class="token punctuation">(</span>cert<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Issuer: %s\n"</span><span class="token punctuation">,</span> line2<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//free(line);       /* free the malloc'ed string */</span>
		<span class="token comment">//X509_free(cert);     /* free the malloc'ed certificate copy */</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"No certificates.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> strings<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	SSL_CTX<span class="token operator">*</span> ctx<span class="token punctuation">;</span>
	SOCKET server<span class="token punctuation">;</span>
	SSL<span class="token operator">*</span> ssl<span class="token punctuation">;</span>
	<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> bytes<span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token keyword">const</span> <span class="token operator">*</span>hostname<span class="token punctuation">,</span> <span class="token operator">*</span>portnum<span class="token punctuation">;</span>

	<span class="token function">SSL_library_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	hostname <span class="token operator">=</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">;</span>
	portnum <span class="token operator">=</span> <span class="token string">"1030"</span><span class="token punctuation">;</span>

	ctx <span class="token operator">=</span> <span class="token function">InitCTX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	server <span class="token operator">=</span> <span class="token function">OpenConnection</span><span class="token punctuation">(</span>hostname<span class="token punctuation">,</span> <span class="token function">atoi</span><span class="token punctuation">(</span>portnum<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	ssl <span class="token operator">=</span> <span class="token function">SSL_new</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">/* create new SSL connection state */</span>
	<span class="token comment">//SSL_set_fd(ssl, server);    /* attach the socket descriptor */</span>
	BIO<span class="token operator">*</span> bio <span class="token operator">=</span> <span class="token function">BIO_new_socket</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> BIO_NOCLOSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">SSL_set_bio</span><span class="token punctuation">(</span>ssl<span class="token punctuation">,</span> bio<span class="token punctuation">,</span> bio<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">SSL_set_connect_state</span><span class="token punctuation">(</span>ssl<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SSL_connect</span><span class="token punctuation">(</span>ssl<span class="token punctuation">)</span> <span class="token operator">==</span> FAIL<span class="token punctuation">)</span>   <span class="token comment">/* perform the connection */</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Eroor: %s\n"</span><span class="token punctuation">,</span> <span class="token constant">stderr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">ERR_print_errors_fp</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Connected with %s encryption\n"</span><span class="token punctuation">,</span> <span class="token function">SSL_get_cipher</span><span class="token punctuation">(</span>ssl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">ShowCerts</span><span class="token punctuation">(</span>ssl<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* get any certs */</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">char</span> p<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"please input sned msg: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">gets</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"strlen:%d，%s\n"</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">SSL_write</span><span class="token punctuation">(</span>ssl<span class="token punctuation">,</span> p<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">/* encrypt &amp; send message */</span>
			bytes <span class="token operator">=</span> <span class="token function">SSL_read</span><span class="token punctuation">(</span>ssl<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* get reply &amp; decrypt */</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>bytes <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				buf<span class="token punctuation">[</span>bytes<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Received: \"%s\"\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span> 
			<span class="token punctuation">{<!-- --></span>
				SSL_ERROR_WANT_READ<span class="token punctuation">;</span>
				<span class="token keyword">int</span> error <span class="token operator">=</span> <span class="token function">SSL_get_error</span><span class="token punctuation">(</span>ssl<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"error:%d\n"</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			
		<span class="token punctuation">}</span>
		<span class="token function">SSL_shutdown</span><span class="token punctuation">(</span>ssl<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">SSL_free</span><span class="token punctuation">(</span>ssl<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">/* release connection state */</span>
	<span class="token punctuation">}</span>

	<span class="token function">SSL_CTX_free</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">/* release context */</span>
	<span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="_178"></a>服务器端代码</h2> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;malloc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">include</span> <span class="token string">&lt;winsock2.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">include</span> <span class="token string">&lt;ws2tcpip.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"openssl/ssl.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"openssl/err.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span>  <span class="token expression">__cplusplus</span></span>
<span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"openssl/applink.c"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span>  <span class="token expression">__cplusplus</span></span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FAIL</span>    <span class="token expression"><span class="token operator">-</span><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">comment</span><span class="token punctuation">(</span>lib<span class="token punctuation">,</span> </span><span class="token string">"Ws2_32.lib"</span><span class="token expression"><span class="token punctuation">)</span></span></span>

<span class="token keyword">int</span> <span class="token function">OpenListener</span><span class="token punctuation">(</span>WORD port<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	SOCKET  m_socket<span class="token punctuation">;</span>

	WORD wVersionRequested<span class="token punctuation">;</span>
	WSADATA wsaData<span class="token punctuation">;</span>
	<span class="token keyword">int</span> err<span class="token punctuation">;</span>

	<span class="token comment">/* Use the MAKEWORD(lowbyte, highbyte) macro declared in Windef.h */</span>
	wVersionRequested <span class="token operator">=</span> <span class="token function">MAKEWORD</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	err <span class="token operator">=</span> <span class="token function">WSAStartup</span><span class="token punctuation">(</span>wVersionRequested<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wsaData<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">/* Tell the user that we could not find a usable */</span>
		<span class="token comment">/* Winsock DLL.                                  */</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"WSAStartup failed with error: %d\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	m_socket <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>m_socket <span class="token operator">==</span> INVALID_SOCKET<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Error at socket(): %ld\n"</span><span class="token punctuation">,</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> sain<span class="token punctuation">;</span>
	<span class="token comment">//bzero(&amp;addr, sizeof(addr));</span>
	sain<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
	sain<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
	sain<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>m_socket<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>sain<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> SOCKET_ERROR<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"can't bind port"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//abort();</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">listen</span><span class="token punctuation">(</span>m_socket<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Can't configure listening port"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//abort();</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> m_socket<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

SSL_CTX<span class="token operator">*</span> <span class="token function">InitServerCTX</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	SSL_CTX<span class="token operator">*</span> ctx <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">OPENSSL_VERSION_NUMBER <span class="token operator">&gt;=</span> <span class="token number">0x10000000L</span></span></span>
	<span class="token keyword">const</span> SSL_METHOD<span class="token operator">*</span> method<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
	SSL_METHOD<span class="token operator">*</span> method<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

	<span class="token function">SSL_library_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//OpenSSL_add_all_algorithms();  /* load &amp; register all cryptos, etc. */</span>
	<span class="token function">SSL_load_error_strings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">/* load all error messages */</span>
	<span class="token comment">//method = SSLv23_method(); /* create new server-method instance */</span>
	method <span class="token operator">=</span> <span class="token function">SSLv23_server_method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	ctx <span class="token operator">=</span> <span class="token function">SSL_CTX_new</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">/* create new context from method */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ctx <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">ERR_print_errors_fp</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> ctx<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">LoadCertificates</span><span class="token punctuation">(</span>SSL_CTX<span class="token operator">*</span> ctx<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> CertFile<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> KeyFile<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//New lines</span>
	<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">SSL_CTX_load_verify_locations</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> CertFile<span class="token punctuation">,</span> KeyFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token function">ERR_print_errors_fp</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SSL_CTX_set_default_verify_paths</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token function">ERR_print_errors_fp</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//End new lines</span>
	<span class="token comment">/* set the local certificate from CertFile */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SSL_CTX_use_certificate_file</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> CertFile<span class="token punctuation">,</span> SSL_FILETYPE_PEM<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">ERR_print_errors_fp</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//abort();</span>
	<span class="token punctuation">}</span>
	<span class="token comment">/* set the private key from KeyFile (may be the same as CertFile) */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SSL_CTX_use_PrivateKey_file</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> KeyFile<span class="token punctuation">,</span> SSL_FILETYPE_PEM<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">ERR_print_errors_fp</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">/* verify private key */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">SSL_CTX_check_private_key</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Private key does not match the public certificate\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"LoadCertificates success\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">ShowCerts</span><span class="token punctuation">(</span>SSL<span class="token operator">*</span> ssl<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	X509<span class="token operator">*</span> cert<span class="token punctuation">;</span>
	<span class="token keyword">char</span><span class="token operator">*</span> line<span class="token punctuation">;</span>

	cert <span class="token operator">=</span> <span class="token function">SSL_get_peer_certificate</span><span class="token punctuation">(</span>ssl<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* Get certificates (if available) */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>cert <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Server certificates:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		line <span class="token operator">=</span> <span class="token function">X509_NAME_oneline</span><span class="token punctuation">(</span><span class="token function">X509_get_subject_name</span><span class="token punctuation">(</span>cert<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Subject: %s\n"</span><span class="token punctuation">,</span> line<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">free</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>
		line <span class="token operator">=</span> <span class="token function">X509_NAME_oneline</span><span class="token punctuation">(</span><span class="token function">X509_get_issuer_name</span><span class="token punctuation">(</span>cert<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Issuer: %s\n"</span><span class="token punctuation">,</span> line<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">free</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">X509_free</span><span class="token punctuation">(</span>cert<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"No certificates.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Servlet</span><span class="token punctuation">(</span>SSL<span class="token operator">*</span> ssl<span class="token punctuation">,</span> SOCKET client<span class="token punctuation">)</span> <span class="token comment">/* Serve the connection -- threadable */</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> reply<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> sd<span class="token punctuation">,</span> bytes<span class="token punctuation">;</span>
	<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> HTMLecho <span class="token operator">=</span> <span class="token string">"hello client"</span><span class="token punctuation">;</span>

	<span class="token function">ShowCerts</span><span class="token punctuation">(</span>ssl<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">/* get any certificates */</span>
	<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">SSL_accept</span><span class="token punctuation">(</span>ssl<span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">//bytes = recv(client, buf, sizeof(buf), 0);</span>
		bytes <span class="token operator">=</span> <span class="token function">SSL_read</span><span class="token punctuation">(</span>ssl<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
		<span class="token keyword">if</span> <span class="token punctuation">(</span>bytes <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			buf<span class="token punctuation">[</span>bytes<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Client msg: %s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">sprintf</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span> HTMLecho<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">/* construct reply */</span>
			<span class="token function">SSL_write</span><span class="token punctuation">(</span>ssl<span class="token punctuation">,</span> reply<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>reply<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* send reply */</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token comment">//其他情况</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token comment">//printf("read byte &lt; 0\n");</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token function">SSL_shutdown</span><span class="token punctuation">(</span>ssl<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">SSL_free</span><span class="token punctuation">(</span>ssl<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> strings<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	SSL_CTX<span class="token operator">*</span> ctx<span class="token punctuation">;</span>
	SOCKET server<span class="token punctuation">;</span>
	<span class="token keyword">char</span><span class="token operator">*</span> portnum<span class="token punctuation">;</span>
	server <span class="token operator">=</span> <span class="token function">OpenListener</span><span class="token punctuation">(</span><span class="token number">1030</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/* create server socket */</span>

	<span class="token function">SSL_library_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	portnum <span class="token operator">=</span> strings<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	ctx <span class="token operator">=</span> <span class="token function">InitServerCTX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">/* initialize SSL */</span>
	<span class="token function">LoadCertificates</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"cert.pem"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"key.pem"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* load certs */</span>

	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> addr<span class="token punctuation">;</span>
		<span class="token class-name">socklen_t</span> len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
		SSL<span class="token operator">*</span> ssl<span class="token punctuation">;</span>

		SOCKET client <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* accept connection   as usual */</span>

		<span class="token class-name">socklen_t</span> len1<span class="token punctuation">;</span>
		<span class="token keyword">struct</span> <span class="token class-name">sockaddr_storage</span> addr1<span class="token punctuation">;</span>
		<span class="token comment">//add1.sin_family = AF_INET;</span>
		<span class="token keyword">char</span> ipstr<span class="token punctuation">[</span>INET6_ADDRSTRLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> port<span class="token punctuation">;</span>

		len1 <span class="token operator">=</span> <span class="token keyword">sizeof</span> addr<span class="token punctuation">;</span>
		<span class="token keyword">int</span> r<span class="token punctuation">;</span>

		r <span class="token operator">=</span> <span class="token function">getpeername</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>addr1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len1<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// deal with both IPv4 and IPv6:</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>addr1<span class="token punctuation">.</span>ss_family <span class="token operator">==</span> AF_INET<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span><span class="token operator">*</span> s <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>addr1<span class="token punctuation">;</span>
			port <span class="token operator">=</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>sin_port<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">inet_ntop</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token operator">-&gt;</span>sin_addr<span class="token punctuation">,</span> ipstr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> ipstr<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{<!-- --></span> <span class="token comment">// AF_INET6</span>
			<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span><span class="token operator">*</span> s <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>addr1<span class="token punctuation">;</span>
			port <span class="token operator">=</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>sin6_port<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">inet_ntop</span><span class="token punctuation">(</span>AF_INET6<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token operator">-&gt;</span>sin6_addr<span class="token punctuation">,</span> ipstr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> ipstr<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Peer IP address: %s,port:%d\n"</span><span class="token punctuation">,</span> ipstr<span class="token punctuation">,</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
		ssl <span class="token operator">=</span> <span class="token function">SSL_new</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">/* get new SSL state with context */</span>
		<span class="token comment">//SSL_set_fd(ssl, client);      /* set connection socket to SSL state */</span>
		BIO<span class="token operator">*</span> bio <span class="token operator">=</span> <span class="token function">BIO_new_socket</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> BIO_NOCLOSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">SSL_set_bio</span><span class="token punctuation">(</span>ssl<span class="token punctuation">,</span> bio<span class="token punctuation">,</span> bio<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token function">Servlet</span><span class="token punctuation">(</span>ssl<span class="token punctuation">,</span> client<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">/* service connection */</span>
	<span class="token punctuation">}</span>
	<span class="token function">SSL_CTX_free</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">/* release context */</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="_406"></a>总结</h2> 
<p>可能遇到的问题<br> 1.要确保代码中applink.c文件的存在,否则服务器端代码会提示Unlink的错误<br> 2.服务器端代码要求输入密码，请使用生成秘钥时的密码</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d5fa6d3ac51faa7bbaf24fd1cde64f62/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Kafka开启SASL认证</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9756d4823bbd3abb89f2c60f82af71b8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Java.lang.Byte类之parseByte(String s, int radix)方法的简介说明</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>