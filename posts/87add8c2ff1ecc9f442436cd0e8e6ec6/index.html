<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ES倒排序索引 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ES倒排序索引" />
<meta property="og:description" content="前言 在学习Elasticsearch的使用前，我们先来了解下es是如何实现全文搜索的。
倒排索引是 Elasticsearch 中非常 重要的索引结构，从 文档单词到文档 ID 的过程
为什么要使用倒排索引 先看下面的商品数据goods
id
标题
描述
1
小米手机
小米手机性价比贼高，为发烧而生
2
苹果手机
高端手机，生态丰富
3
三只松鼠零食大礼包
便宜实惠，高端品牌质量有保证
4
小米电脑
小米电脑性价比贼高，便宜好用
如果我们要模糊查含有手机关键词的商品，以mysql查询为例，应该是下面的语句
select * from goods where 标题 like &#39;%手机%&#39; or 描述 like &#39;%手机%&#39; 了解mysql的都知道，用上面的语句查询，索引会失效导致全表查询，如果数据量大的话就会很慢很慢。
怎么解决呢？用倒排索引
倒排索引原理 倒排索引主要包含两个过程：创建倒排索引、倒排索引搜索
创建倒排索引 先对 文档的内容进行分词，形成一个个的 token，也就是 单词，然后保存这些 token 与文档的对应关系。
如上面的商品数据goods，保存后如下所示
token
对应文档
小米
1,4
手机
1,2
苹果
2
电脑
4
三只松鼠
3
零食
3
大礼包
3
便宜
3,4" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/87add8c2ff1ecc9f442436cd0e8e6ec6/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-17T20:56:52+08:00" />
<meta property="article:modified_time" content="2022-11-17T20:56:52+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ES倒排序索引</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2 id="JYDtw">前言</h2> 
<p id="u49b4e8ff">在学习Elasticsearch的使用前，我们先来了解下es是如何实现全文搜索的。</p> 
<p id="u23a61f90">倒排索引是 Elasticsearch 中非常 重要的索引结构，从 文档单词到文档 ID 的过程</p> 
<h2 id="SGG0C">为什么要使用倒排索引</h2> 
<p id="ua2591758">先看下面的商品数据goods</p> 
<table id="sbuOp"><tbody><tr><td> <p id="u959e4333">id</p> </td><td> <p id="u6a0d98c8">标题</p> </td><td> <p id="u11bd197a">描述</p> </td></tr><tr><td> <p id="u9e2bd3dc">1</p> </td><td> <p id="u0cc00f45">小米手机</p> </td><td> <p id="ud8d1969c">小米手机性价比贼高，为发烧而生</p> </td></tr><tr><td> <p id="u09b42091">2</p> </td><td> <p id="u0ddd61a8">苹果手机</p> </td><td> <p id="u4e72b1bb">高端手机，生态丰富</p> </td></tr><tr><td> <p id="u89459043">3</p> </td><td> <p id="u28945249">三只松鼠零食大礼包</p> </td><td> <p id="u3d5452e2">便宜实惠，高端品牌质量有保证</p> </td></tr><tr><td> <p id="u13e2afce">4</p> </td><td> <p id="ue1b317f1">小米电脑</p> </td><td> <p id="u6a0c3c73">小米电脑性价比贼高，便宜好用</p> </td></tr></tbody></table> 
<p id="u6203dd3e">如果我们要模糊查含有手机关键词的商品，以mysql查询为例，应该是下面的语句</p> 
<pre id="zQo8M">select * from goods where 标题 like '%手机%' or 描述 like '%手机%'</pre> 
<p id="uda66eb80">了解mysql的都知道，用上面的语句查询，索引会失效导致全表查询，如果数据量大的话就会很慢很慢。</p> 
<p id="u3f411ff7">怎么解决呢？用倒排索引</p> 
<h2 id="LrsAU">倒排索引原理</h2> 
<p id="u33f319ab">倒排索引主要包含两个过程：<strong>创建倒排索引、倒排索引搜索</strong></p> 
<h3 id="Xf4c9">创建倒排索引</h3> 
<p id="u56a08ba9">先对 文档的内容进行分词，形成一个个的 token，也就是 单词，然后保存这些 token 与文档的对应关系。</p> 
<p id="u24a7bf11">如上面的商品数据goods，保存后如下所示</p> 
<p id="u9610719e"></p> 
<table id="lE52q"><tbody><tr><td> <p id="u0f1c2399">token</p> </td><td> <p id="u2ee72ac8">对应文档</p> </td></tr><tr><td> <p id="uc4efefc7">小米</p> </td><td> <p id="u6be49f86">1,4</p> </td></tr><tr><td> <p id="u405e031c">手机</p> </td><td> <p id="u8a21b827">1,2</p> </td></tr><tr><td> <p id="u66c22bea">苹果</p> </td><td> <p id="u48c9b8c8">2</p> </td></tr><tr><td> <p id="u06121105">电脑</p> </td><td> <p id="u9e51fd6d">4</p> </td></tr><tr><td> <p id="ucbd4f73f">三只松鼠</p> </td><td> <p id="u5e577870">3</p> </td></tr><tr><td> <p id="u6c22cd23">零食</p> </td><td> <p id="u0c485829">3</p> </td></tr><tr><td> <p id="u957b4e13">大礼包</p> </td><td> <p id="u69f11009">3</p> </td></tr><tr><td> <p id="u00a94f58">便宜</p> </td><td> <p id="ub660c668">3,4</p> </td></tr><tr><td> <p id="u33441e7a">性价比</p> </td><td> <p id="u2f0cc661">1,4</p> </td></tr><tr><td> <p id="u5a08b30f">...</p> </td><td> <p id="u6ce561ff">...</p> </td></tr></tbody></table> 
<h3 id="QzeP8">倒排索引搜索</h3> 
<p id="uae938024">对搜索词先分词，得到多个Token，然后去倒排索引中进行匹配</p> 
<p id="u0f4366e0">如搜索词：性价比手机</p> 
<p id="ua97d5d49">分词后：性价比、手机</p> 
<p id="u9bf1604b">性价比匹配到的文档是1、4；手机匹配到的文档是1、2</p> 
<p id="uc0cfb5bc">最终搜索到的文档就是1</p> 
<table id="R105G"><tbody><tr><td> <p id="u17a9eeac">1</p> </td><td> <p id="uee7343b3">小米手机</p> </td><td> <p id="ue2ee7381">小米手机性价比贼高，为发烧而生</p> </td></tr></tbody></table> 
<h2 id="OlE0s">实践</h2> 
<p id="u984c8907">简单实现下倒排索引的搜索引擎，中文分词比较麻烦，这里先使用英文，默认英文分词都是空格。</p> 
<h3 id="eRmCL">搜索引擎类</h3> 
<pre id="qjowa">class SearchEngines
{
  // 搜索数据
  private $searchData;
  // 搜索
  public function search($keyword)
  {
    // 转小写
    $keyword = strtolower($keyword);
    // 对搜索词进行分词
    $keywords = explode(' ', $keyword);
    $ids = [];
    foreach ($keywords as $keyword) {
      // 查找搜索词对应文档
      $tmpIds = [];
      foreach ($this-&gt;searchData[$keyword] as $id) {
        $tmpIds[] = $id;
      }
      // 第一个不取交集
      if (!$ids) {
        $ids = $tmpIds;
        continue;
      }
      // 取搜索词对应文档的交集
      $ids = array_intersect($ids, $tmpIds);
    }
    return $ids;
  }

  // 插入数据
  public function save($id, $keyword)
  {
    // 对关键词进行分词
    $keywords = explode(' ', $keyword);

    foreach ($keywords as $keyword){
      // 都改为小写
      $keyword = strtolower($keyword);
      if (!isset($this-&gt;searchData[$keyword])) {
        $this-&gt;searchData[$keyword] = [];
      }
      if (!in_array($id, $this-&gt;searchData[$keyword])) {
        $this-&gt;searchData[$keyword][] = $id;
      }
    }

  }
}</pre> 
<h3 id="P5rEI">数据插入</h3> 
<pre id="N8cwo">$insertData = [
    1 =&gt; [
        'id' =&gt; 1,
        'title' =&gt; 'Xiaomi phones',
        'desc' =&gt; 'Xiaomi\'s mobile phone is more cost-effective than thieves, and is born of fever'
    ],
    2 =&gt; [
        'id' =&gt; 2,
        'title' =&gt; 'iPhone',
        'desc' =&gt; 'High end mobile phones with rich ecology'
    ],
    3 =&gt; [
        'id' =&gt; 3,
        'title' =&gt; 'Three Squirrels Snack Pack',
        'desc' =&gt; 'food'
    ],
    4 =&gt; [
        'id' =&gt; 4,
        'title' =&gt; 'Xiaomi Computer',
        'desc' =&gt; 'Xiaomi computers are more cost-effective than thieves, and cheap and easy to use'
    ]
];

$searchEngines = new SearchEngines();
foreach ($insertData as $data) {
    $searchEngines-&gt;save($data['id'], $data['title']." ".$data['desc']);
}</pre> 
<h3 id="MM2nF">关键词搜索</h3> 
<pre id="HyV3L">$ids = $searchEngines-&gt;search('cost-effective phone');
foreach ($ids as $id) {
  echo $insertData[$id]['title'];
}</pre> 
<h3 id="GxwXj">执行结果</h3> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/33/08/Kii3OGAV_o.png"></p> 
<p id="ub905daae"></p> 
<p id="u3d70eb25"></p> 
<p> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/edec63c20100a80cef7c9fe98189a572/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Elasticsearch与Kibana安装</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d59c577479c79d20c85ff6a5c170e0e3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">ES增删改查入门</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>