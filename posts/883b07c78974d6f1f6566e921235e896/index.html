<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>部署Redis作为MySQL缓存 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="部署Redis作为MySQL缓存" />
<meta property="og:description" content="server1：192.168.1.11 安装nginx和php为用户提供服务访问入口
server3：192.168.1.13 安装mysql，存储数据
server2：192.168.1.12 安装redis作为缓存服务器，缓存mysql数据
一、搭建LNMP&#43;Redis 1. server1安装nginx和php以及php相关插件 安装nginx
解压
tar zxf nginx-1.18.0.tar.gz vim auto/cc/gcc ###这一步是为了取消debug模式，比较省空间，可以不做 安装依赖
yum install -y pcre-devel zlib-devel 编译
./configure --prefix=/usr/local/nginx 安装
make &amp;&amp; make install 安装php及相关插件 gearman（后面会用到，为了实现redis更新mysql内容）
配置nginx为系统服务
vim /usr/lib/systemd/system/nginx.service 软连接，将nginx配置文件连接到/etc下
ln -s /usr/local/nginx/conf/nginx.conf /etc/ 修改nginx配置文件如下
vim /etc/nginx.conf 开启nginx测试
systemctl start nginx.service 浏览器测试访问 开启php，编写php页面测试
systemctl start php-fpm.service 浏览器测试访问
2. server2安装redis 上一篇讲过安装redis步骤，这里就跳过了，详情见
https://blog.csdn.net/qq_36023219/article/details/106179458
打开redis
3. server3安装数据库 这里直接用官方yum源自带的mariadb
yum install -y mariadb-server 启动服务
systemctl start mariadb." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/883b07c78974d6f1f6566e921235e896/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-05-20T12:43:27+08:00" />
<meta property="article:modified_time" content="2020-05-20T12:43:27+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">部署Redis作为MySQL缓存</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <hr> 
<p>server1：192.168.1.11  安装nginx和php为用户提供服务访问入口</p> 
<p>server3：192.168.1.13  安装mysql，存储数据</p> 
<p>server2：192.168.1.12  安装redis作为缓存服务器，缓存mysql数据</p> 
<hr> 
<p> </p> 
<h3>一、搭建LNMP+Redis</h3> 
<h3>1. server1安装nginx和php以及php相关插件</h3> 
<p>安装nginx</p> 
<p>解压</p> 
<pre><code class="language-bash">tar zxf nginx-1.18.0.tar.gz</code></pre> 
<p><img alt="" height="74" src="https://images2.imgbox.com/b1/95/YFaBwayv_o.png" width="1047"></p> 
<pre><code class="language-bash">vim auto/cc/gcc   ###这一步是为了取消debug模式，比较省空间，可以不做</code></pre> 
<p><img alt="" height="61" src="https://images2.imgbox.com/3f/59/NAchsiKe_o.png" width="806"></p> 
<p>安装依赖</p> 
<pre><code class="language-bash">yum install -y pcre-devel zlib-devel</code></pre> 
<p> </p> 
<p>编译</p> 
<pre><code class="language-bash">./configure --prefix=/usr/local/nginx
</code></pre> 
<p><img alt="" height="266" src="https://images2.imgbox.com/5b/24/BvlZtch7_o.png" width="1065"></p> 
<p>安装</p> 
<pre><code class="language-bash">make &amp;&amp; make install</code></pre> 
<p><img alt="" height="504" src="https://images2.imgbox.com/26/67/GVCx7RUO_o.png" width="1069"></p> 
<p><img alt="" height="200" src="https://images2.imgbox.com/bc/ba/zmeI8DXe_o.png" width="1064"></p> 
<p>安装php及相关插件  gearman（后面会用到，为了实现redis更新mysql内容）</p> 
<p><img alt="" height="328" src="https://images2.imgbox.com/11/e6/tGj1bses_o.png" width="1064"></p> 
<p>配置nginx为系统服务</p> 
<pre><code class="language-bash">vim /usr/lib/systemd/system/nginx.service
</code></pre> 
<p><img alt="" height="365" src="https://images2.imgbox.com/28/17/gPw6yeUk_o.png" width="1037"></p> 
<p>软连接，将nginx配置文件连接到/etc下</p> 
<pre><code class="language-bash">ln -s /usr/local/nginx/conf/nginx.conf /etc/
</code></pre> 
<p>修改nginx配置文件如下</p> 
<pre><code class="language-bash">vim /etc/nginx.conf</code></pre> 
<p><img alt="" height="52" src="https://images2.imgbox.com/58/94/qUXw10rg_o.png" width="918"></p> 
<p><img alt="" height="107" src="https://images2.imgbox.com/30/79/HssEqMoa_o.png" width="1059"></p> 
<p><img alt="" height="195" src="https://images2.imgbox.com/a4/bc/i5Dyc1PE_o.png" width="1059"></p> 
<p>开启nginx测试</p> 
<pre><code class="language-bash">systemctl start nginx.service</code></pre> 
<p>浏览器测试访问 </p> 
<p><img alt="" height="341" src="https://images2.imgbox.com/d8/eb/6VsjXnvQ_o.png" width="1122"></p> 
<p>开启php，编写php页面测试</p> 
<pre><code class="language-bash">systemctl start php-fpm.service</code></pre> 
<p><img alt="" height="43" src="https://images2.imgbox.com/78/64/nW5bBgew_o.png" width="838"></p> 
<p><img alt="" height="179" src="https://images2.imgbox.com/06/2e/ns8Aurww_o.png" width="761"></p> 
<p>浏览器测试访问</p> 
<p><img alt="" height="822" src="https://images2.imgbox.com/0f/a0/g17U7gS9_o.png" width="1107"></p> 
<p> </p> 
<h3>2. server2安装redis</h3> 
<p>上一篇讲过安装redis步骤，这里就跳过了，详情见</p> 
<p><a href="https://blog.csdn.net/qq_36023219/article/details/106179458">https://blog.csdn.net/qq_36023219/article/details/106179458</a></p> 
<p>打开redis</p> 
<p><img alt="" height="273" src="https://images2.imgbox.com/fe/a9/W0afaRCL_o.png" width="1060"></p> 
<h3>3. server3安装数据库</h3> 
<p>这里直接用官方yum源自带的mariadb</p> 
<pre><code class="language-bash">yum install -y mariadb-server</code></pre> 
<p><img alt="" height="386" src="https://images2.imgbox.com/23/76/oKj0QHzO_o.png" width="1062"></p> 
<p>启动服务</p> 
<pre><code class="language-bash">systemctl start mariadb.service </code></pre> 
<p>安全初始化</p> 
<pre><code class="language-bash">mysql_secure_installation  ###初始密码为空，直接回车即可</code></pre> 
<p><img alt="" height="701" src="https://images2.imgbox.com/e4/40/tPRXt4I2_o.png" width="1047"></p> 
<p>登陆数据库</p> 
<pre><code class="language-bash">mysql -uroot -p密码
</code></pre> 
<p><img alt="" height="337" src="https://images2.imgbox.com/e5/70/MTbadSMa_o.png" width="826"></p> 
<p>授权</p> 
<pre><code class="language-sql">grant all on *.* to redis@'%' identified by 'redhat';

flush privileges;</code></pre> 
<p><img alt="" height="113" src="https://images2.imgbox.com/32/e6/rxu38Wsc_o.png" width="881"></p> 
<p> </p> 
<h2>二、编写php测试页面，创建测试数据</h2> 
<pre><code class="language-bash">vim index.php</code></pre> 
<p><img alt="" height="742" src="https://images2.imgbox.com/bb/5d/ZXrneRdk_o.png" width="1034"></p> 
<p>根据自己实际情况更改redis和mysql绑定的ip端口，创建对应的数据库，比如我这里是testdb，所以下一步，在mysql创建对应数据库，以及内容</p> 
<pre><code class="language-sql">use testdb
CREATE TABLE `test` (`id` int(7) NOT NULL AUTO_INCREMENT, `name` char(8) DEFAULT NULL, PRIMARY KEY (`id`)) ENGINE=InnoDB AUTO_INCREMENT=10 DEFAULT CHARSET=utf8;
INSERT INTO `test` VALUES (1,'sven'),(2,'jim'),(3,'zhu'),(4,'wang'),(5,'ftd'),(6,'test'),(7,'test01'),(8,'test02'),(9,'test03');
</code></pre> 
<p><img alt="" height="208" src="https://images2.imgbox.com/e1/83/pnnM4gnC_o.png" width="1075"></p> 
<p> </p> 
<p>测试</p> 
<p>浏览器访问</p> 
<p><img alt="" height="426" src="https://images2.imgbox.com/28/73/LoXNhvPx_o.png" width="657"></p> 
<p>这是第一次访问，redis中没有key，从mysql中缓存数据到redis</p> 
<p> </p> 
<p>再访问</p> 
<p><img alt="" height="411" src="https://images2.imgbox.com/58/98/sRceinEF_o.png" width="479"></p> 
<p>第二次访问，因为redis'中有key，所以直接从redis中获取数据</p> 
<p> </p> 
<p>到此为止已经实现了redis缓存mysql数据，但如果mysql数据更新了，而redis不会去主动同步mysql数据，会造成redis缓存和mysql数据不同步。</p> 
<p>解决方法：通过mysql触发器，当更新时触发同步，使得redis和mysql数据一致。</p> 
<p> </p> 
<h2>三、gearman实现mysql和redis同步</h2> 
<h3>1. 介绍</h3> 
<p>Gearman是一个支持分布式的任务分发框架：</p> 
<ul><li>Gearman Job Server：Gearman核心程序，需要编译安装并以守护进程形式运行在后台。</li><li>Gearman Client：可以理解为任务的请求者。</li><li>Gearman Worker：任务的真正执行者，一般需要自己编写具体逻辑并通过守护进程方式运行，Gearman Worker接收到Gearman Client传递的任务内容后，会按顺序处理。</li></ul> 
<p><strong>我们在最开始安装php插件时已经安装了gearman</strong></p> 
<p>下面要编写的mysql触发器，就相当于Gearman的客户端。</p> 
<p>修改表,插入表就相当于直接下发任务。</p> 
<p>通过lib_mysqludf_json UDF库函数将关系数据映射为JSON格式</p> 
<p>再通过gearman-mysql-udf插件将任务加入到Gearman的任务队列中</p> 
<p>最后通过redis_worker.php，也就是Gearman的worker端来完成redis数据库的更新。</p> 
<p> </p> 
<h3>2. 安装lib_mysqludf_json</h3> 
<p>先安装mariadb开发包，否则不支持udf（用户自定义函数）</p> 
<pre><code class="language-bash">yum install -y mariadb-devel</code></pre> 
<p><img alt="" height="274" src="https://images2.imgbox.com/5b/57/QHIM7abw_o.png" width="1055"></p> 
<p>解压lib_mysqludf_json安装包并编译</p> 
<pre><code class="language-bash">gcc $(mysql_config --cflags) -shared -fPIC -o lib_mysqludf_json.so lib_mysqludf_json.c</code></pre> 
<p><img alt="" height="255" src="https://images2.imgbox.com/46/93/FUFkwHNz_o.png" width="1056"></p> 
<p>将编译好的插件复制到mysql插件目录</p> 
<pre><code class="language-bash">cp lib_mysqludf_json.so /usr/lib64/mysql/plugin/</code></pre> 
<p>注册udf函数</p> 
<pre><code class="language-sql">CREATE FUNCTION json_object RETURNS STRING SONAME 'lib_mysqludf_json.so';</code></pre> 
<p><img alt="" height="83" src="https://images2.imgbox.com/07/c9/gE29scKJ_o.png" width="925"></p> 
<h3>3. 安装gearman-mysql-udf</h3> 
<p>获取安装包和相关依赖</p> 
<p><img alt="" height="183" src="https://images2.imgbox.com/ec/3e/zWWIHqcl_o.png" width="1057"></p> 
<pre><code class="language-bash">yum install -y libevent-devel-2.0.21-4.el7.x86_64.rpm libgearman-1.1.12-18.el7.x86_64.rpm libgearman-devel-1.1.12-18.el7.x86_64.rpm
</code></pre> 
<p>解压gearman-mysql-udf</p> 
<pre><code class="language-bash">tar zxf gearman-mysql-udf-0.6.tar.gz </code></pre> 
<p><img alt="" height="112" src="https://images2.imgbox.com/e3/a1/Vfa7PYS7_o.png" width="1024"></p> 
<p>编译</p> 
<pre><code class="language-bash">./configure --with-mysql=/usr/bin/mysql_config --libdir=/usr/lib64/mysql/plugin/</code></pre> 
<p><img alt="" height="365" src="https://images2.imgbox.com/36/68/VoAoPlIy_o.png" width="1059"> <img alt="" height="103" src="https://images2.imgbox.com/f4/c1/A1pp84E0_o.png" width="1059"></p> 
<p>安装</p> 
<pre><code class="language-bash">make &amp;&amp; make install</code></pre> 
<p><img alt="" height="703" src="https://images2.imgbox.com/4b/82/fNRQ8Wl7_o.png" width="1066"></p> 
<p> 注册函数</p> 
<pre><code class="language-sql">CREATE FUNCTION gman_do_background RETURNS STRING SONAME 'libgearman_mysql_udf.so';
CREATE FUNCTION gman_servers_set RETURNS STRING SONAME 'libgearman_mysql_udf.so';</code></pre> 
<p><img alt="" height="270" src="https://images2.imgbox.com/40/38/DqsCCCzd_o.png" width="996"></p> 
<p>注册完成可以查看下mysql的函数</p> 
<pre><code class="language-sql">select * from mysql.func;</code></pre> 
<p><img alt="" height="181" src="https://images2.imgbox.com/d6/2b/yMJeYsHI_o.png" width="750"></p> 
<p>设置gearman的server，我们是在server1安装的gearman，所以这里填写server1的ip（gearman默认端口4730）</p> 
<pre><code class="language-bash">select gman_servers_set('192.168.1.11:4730');
</code></pre> 
<p><img alt="" height="153" src="https://images2.imgbox.com/ff/10/ltGhogTJ_o.png" width="705"></p> 
<p>可以打开server1的gearman，验证下端口</p> 
<p><img alt="" height="232" src="https://images2.imgbox.com/69/cd/WvbHq947_o.png" width="986"></p> 
<p> </p> 
<p>编写mysql触发器</p> 
<pre><code class="language-bash">use testdb
DELIMITER $$
CREATE TRIGGER datatoredis AFTER UPDATE ON test FOR EACH ROW BEGIN
    SET @RECV=gman_do_background('syncToRedis', json_object(NEW.id as `id`, NEW.name as `name`)); 
  END$$
DELIMITER ;</code></pre> 
<p><img alt="" height="236" src="https://images2.imgbox.com/a4/84/0RkWkx96_o.png" width="1057"></p> 
<p>查看定义的触发器</p> 
<pre><code class="language-bash">show triggers from testdb；</code></pre> 
<p><img alt="" height="366" src="https://images2.imgbox.com/7a/1b/v2czPViA_o.png" width="1054"></p> 
<p> </p> 
<p>在server1编写gearman的worker</p> 
<pre><code class="language-bash">vim syncRedis_worker.php</code></pre> 
<p><img alt="" height="375" src="https://images2.imgbox.com/31/29/XwRuPzIH_o.png" width="837"></p> 
<p>运行这个php</p> 
<pre><code class="language-bash">nohup php syncRedis_worker.php &amp;&gt; /dev/null &amp;</code></pre> 
<p><img alt="" height="73" src="https://images2.imgbox.com/62/d6/3E30PBaE_o.png" width="793"></p> 
<p> </p> 
<p><strong>测试：</strong></p> 
<p>原来访问的数据</p> 
<p><img alt="" height="426" src="https://images2.imgbox.com/f7/a2/qnwftyUf_o.png" width="804"></p> 
<p>mysqll端更新数据</p> 
<p><img alt="" height="391" src="https://images2.imgbox.com/e7/c7/Li2kxRzt_o.png" width="816"></p> 
<p>浏览器访问</p> 
<p><img alt="" height="410" src="https://images2.imgbox.com/90/21/wj6SI2ou_o.png" width="718"></p> 
<p>可以看到，数据已经更新</p> 
<p>访问redis，查看数据，已经更新为新数据</p> 
<p><img alt="" height="78" src="https://images2.imgbox.com/35/cf/xzu0RNvP_o.png" width="819"></p> 
<p> </p> 
<p> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/dc1947be21835519fe9a79abc8e0d9db/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">pom下载包问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2224b8030c57b9b4d56ebcdc189dec5a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">redis 介绍及String 、bitmap 使用、key查找</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>