<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【linux kernel】一文总结initramfs的使用 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【linux kernel】一文总结initramfs的使用" />
<meta property="og:description" content="一文总结initramfs的使用 文章目录 一文总结initramfs的使用一、开篇二、定制initramfs（2-1）使用busybox构建rootfs（2-2）完善rootfs（2-3）将rootfs链接进linux内核（2-4）启动测试 三、总结 一、开篇 ​ 在linux内核中，initramfs是一种执行早期用户空间程序的机制。常用于：在挂载真正根文件系统之前加载一些必须的设备驱动程序，也可以作为根文件系统的“跳板”。
​ 在一些实际嵌入式系统应用中，可以通过initramfs执行一些脚本程序切换到对应设备下的文件系统，这一点在实际开发中很是有用，也使动态选择根文件系统成为可能。
二、定制initramfs ​ 关于定制initramfs，有两种方法：
（1）创建一个cpio格式的档案文件，其中包含所需的所有文件。
（2）指定一系列目录和文件。然后将这些目录和文件链接进内核。
​ 本文主要分享第二种方法来定制initramfs
（2-1）使用busybox构建rootfs 如上图所示，对busybox配置操作是：
选择将busybox进行静态构建。设置交叉编译工具链的路径。设置rootfs的安装目录。 当配置完成后，退出busybox图形配置界面，执行make编译构建busybox。然后再使用make install安装rootfs。随后将生成rootfs文件系统目录和busybox的运行本体程序。
（2-2）完善rootfs ​ （2-2-1）在rootfs目录下创建etc、dev、home、mnt、proc、root、sys、tmp、var与linux文件系统相关的目录。完成后如下图所示：
​ （2-2-1）在etc目录下创建inittab文件，文件内容如下：
#/etc/inittab ::sysinit:/etc/init.d/rcS console::askfirst:-/bin/sh ::restart:/sbin/init ::ctrlaltdel:/sbin/reboot ::shutdown:/bin/umount -a -r ::shutdown:/sbin/swapoff -a ​ （2-2-2）在etc目录下创建fstab文件，文件内容如下：
proc /proc proc defaults 0 0 sysfs /sys sysfs defaults 0 0 none	/dev/pts	devpts	default 0 0 tmpfs	/dev/shm	tmpfs	defaults 0 0 ​ （2-2-3）在etc目录下创建子目录init.d并在该目录下创建rcS文件，文件内容如下：
#!/bin/sh LD_PRELOAD= PATH=/sbin:/bin:/usr/sbin:/usr/bin runlevel=S prevlevel=N umask 022 export PATH LD_PRELOAD runlevel prevlevel [ -d &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/24038509841f38d8294d71b248cd2b9a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-28T08:35:16+08:00" />
<meta property="article:modified_time" content="2022-03-28T08:35:16+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【linux kernel】一文总结initramfs的使用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h5><a id="initramfs_0"></a>一文总结initramfs的使用</h5> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><ul><li><ul><li><a href="#initramfs_0" rel="nofollow">一文总结initramfs的使用</a></li><li><a href="#_5" rel="nofollow">一、开篇</a></li><li><a href="#initramfs_13" rel="nofollow">二、定制initramfs</a></li><li><ul><li><a href="#21busyboxrootfs_27" rel="nofollow">（2-1）使用busybox构建rootfs</a></li><li><a href="#22rootfs_39" rel="nofollow">（2-2）完善rootfs</a></li><li><a href="#23rootfslinux_89" rel="nofollow">（2-3）将rootfs链接进linux内核</a></li><li><a href="#24_102" rel="nofollow">（2-4）启动测试</a></li></ul> 
     </li><li><a href="#_114" rel="nofollow">三、总结</a></li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<hr> 
<h5><a id="_5"></a>一、开篇</h5> 
<p>​ 在linux内核中，<code>initramfs</code>是一种执行早期用户空间程序的机制。常用于：在挂载真正根文件系统之前加载一些必须的设备驱动程序，也可以作为根文件系统的“跳板”。</p> 
<p>​ 在一些实际嵌入式系统应用中，可以通过initramfs执行一些脚本程序切换到对应设备下的文件系统，这一点在实际开发中很是有用，也使动态选择根文件系统成为可能。</p> 
<h5><a id="initramfs_13"></a>二、定制initramfs</h5> 
<p>​ 关于定制initramfs，有两种方法：</p> 
<p>（1）创建一个cpio格式的档案文件，其中包含所需的所有文件。</p> 
<p>（2）指定一系列目录和文件。然后将这些目录和文件链接进内核。</p> 
<p>​ 本文主要分享第二种方法来定制initramfs</p> 
<h6><a id="21busyboxrootfs_27"></a>（2-1）使用busybox构建rootfs</h6> 
<p><img src="https://images2.imgbox.com/49/2a/fqd9rCm0_o.png" alt="在这里插入图片描述"><br> 如上图所示，对busybox配置操作是：</p> 
<ul><li>选择将busybox进行静态构建。</li><li>设置交叉编译工具链的路径。</li><li>设置rootfs的安装目录。</li></ul> 
<p>当配置完成后，退出busybox图形配置界面，执行<code>make</code>编译构建busybox。然后再使用<code>make install</code>安装rootfs。随后将生成rootfs文件系统目录和busybox的运行本体程序。</p> 
<h6><a id="22rootfs_39"></a>（2-2）完善rootfs</h6> 
<p>​ （2-2-1）在rootfs目录下创建etc、dev、home、mnt、proc、root、sys、tmp、var与linux文件系统相关的目录。完成后如下图所示：</p> 
<p><img src="https://images2.imgbox.com/f9/1b/YXQNjPW3_o.png" alt="在这里插入图片描述"></p> 
<p>​ （2-2-1）在etc目录下创建<code>inittab</code>文件，文件内容如下：</p> 
<pre><code>#/etc/inittab

::sysinit:/etc/init.d/rcS
console::askfirst:-/bin/sh
::restart:/sbin/init
::ctrlaltdel:/sbin/reboot
::shutdown:/bin/umount -a -r
::shutdown:/sbin/swapoff -a
</code></pre> 
<p>​ （2-2-2）在etc目录下创建<code>fstab</code>文件，文件内容如下：</p> 
<pre><code>proc                 /proc                proc       defaults              0  0
sysfs 				/sys 				  sysfs 	 defaults 			   0  0
none				/dev/pts			devpts		default               0  0
tmpfs				/dev/shm			tmpfs		defaults               0  0
</code></pre> 
<p>​ （2-2-3）在etc目录下创建子目录init.d并在该目录下创建<code>rcS</code>文件，文件内容如下：</p> 
<pre><code class="prism language-bash"><span class="token shebang important">#!/bin/sh</span>

LD_PRELOAD<span class="token operator">=</span>
PATH<span class="token operator">=</span>/sbin:/bin:/usr/sbin:/usr/bin
runlevel<span class="token operator">=</span>S
prevlevel<span class="token operator">=</span>N
<span class="token function">umask</span> 022
<span class="token function">export</span> PATH LD_PRELOAD runlevel prevlevel

<span class="token punctuation">[</span> -d <span class="token string">"/proc/1"</span> <span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token function">mount</span> /proc
</code></pre> 
<p>​ 注，以上文件目录和目录中放置的文件与常规busybox构建出的文件系统一样，与大多数linux桌面发行版的目录结构大体相同，大小约1.5M左右。这是在没有填充其他软件共享库的情况下。</p> 
<h6><a id="23rootfslinux_89"></a>（2-3）将rootfs链接进linux内核</h6> 
<p>​ 这一步很关键，很多时候在开发中常常使用nfs方式挂载放于宿主机上的文件系统。在本文中，我们将构建出的rootfs链接进linux内核，这样就不用使用nfs方式挂载文件系统就可以得到一个linux命令行，而且可以在命令行下搞些有趣的事情，哈哈。如果项目没有过多依赖于动态库（例如Qt软件库、ffmpeg库等等），完全可以以这种方式组织和部署linux运行环境。</p> 
<p>​ 实现的关键步骤就是：在构建linux内核时开启内核<code>Initial RAM filesystem and RAM disk(initramfs/initrd) support</code>特性并设置<code>Initramfs source file(s)</code>参数：</p> 
<p><img src="https://images2.imgbox.com/f4/bc/fLaLHPuQ_o.png" alt="在这里插入图片描述"></p> 
<p>​ 然后编译构建linux内核zimage镜像即可将rootfs链接进zImage中。</p> 
<h6><a id="24_102"></a>（2-4）启动测试</h6> 
<p>​ 设置linux启动参数为：</p> 
<pre><code class="prism language-bash">setenv bootargs <span class="token string">'console=tty1 console=ttymxc0,115200 rdinit=/linuxrc'</span>
</code></pre> 
<p>​ 注意：这里需要使用<code>rdinit=/linuxrc</code>命令指定rdinit代表的程序。</p> 
<h5><a id="_114"></a>三、总结</h5> 
<p>​ 通过initramfs方式集成linux运行环境，不需要通过nfs、ntfs方式挂载根文件系统即可进入linux命令行，这时候可以再编写脚本挂载其他设备上的文件系统，那么initramfs就作为了一个“中间跳板”。但是由于文件系统存在于RAM中，在initramfs文件系统中创建、删除文件等操作不是长久的，在下一次系统重新上电运行将还原rootfs的最初状态，所以我们在构建rootfs文件系统时，需要预先定义好脚本、需要的linux命令操作以及相关rootfs文件系统资源等。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/82342eb353d384e0582b185bc31b96e3/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Vue 源码之Vue 响应式原理【完整版】</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2ea0134e152380892f20fef6ac233314/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Rust-Sqlx极简教程</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>