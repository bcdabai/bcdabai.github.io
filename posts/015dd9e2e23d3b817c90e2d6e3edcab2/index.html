<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>OpenFeign的理解和使用 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="OpenFeign的理解和使用" />
<meta property="og:description" content="一、概述 openFeign是要声明式的web服务客户端，或叫做声明式REST客户端，它让编写web服务客户端变得简单。
使用它的步骤：创建一个接口并注解它。它支持spring MVC的注解，spring cloud openFeign整合了hystrix，同时，可以和Eureka和ribbon配合使用，可以实现负载均衡的http客户端。
可以理解为是请求转发（RPC调度）的入口。本章讲述的是2.2.10.RELEASE版本。
二、使用步骤 1、引入spring-cloud-starter-openfeign 依赖。
2、启动类上加上@EnableFeignClients开启Feign的客户端服务
3、定义一个接口，并加上@FeignClient注解，同时，使用REST风格的接口请求服务。
例如：
@FeignClient(value = &#34;provider&#34;) public interface OpenFeignService { @RequestMapping(&#34;/open&#34;) public String getName(); @FeignClient(“provider”)中的value值表示的是这个Feign客户端需要请求的微服务名称。这个名称代表了一个微服务或一个微服务组，其实就是spring.application.name的值。Feign客户端通过这个别名去EurekaServer服务端去找到这个别名对应的微服务。
如果你在项目中还使用了ribbon做负载均衡且结合了Eureka，那么，ribbon将去Eureka的服务注册中心拉取注册表，并缓存到本地，并结合负载均衡算法，选取一个物理主机作为服务端。
三、openFeign的使用 1、如果你不喜欢Feign默认的配置，可以使用FeignClientsConfiguration ，这个类能够让我们全面的控制Feign客户端。步骤如下：
a、定义一个类，继承FeignClientsConfiguration 。
b、重写方法。
c、在@FeignClient 中通过configuration属性引入自定义类。
注意：这个配置类不能注册进spring容器，即不需要使用@Component注解。当然，如果重写Feign的配置不想用自定义类，也可以使用配置文件。如果你既使用了配置类，又使用了配置文件，则配置文件生效。
2、如果你想定义多个Feign客户端，想区分他们，可以使用contextId属性。
@FeignClient（name = &#39;provider&#39;,contextId = &#34;AClient&#34;,configuration = &#34;FeignConfig.class&#34;） 3、熔断机制
OpenFeign 整合了hystrix做熔断处理，包括超时和异常熔断。其中对于超时，OpenFeign提供了两个参数：connectTimeout和readTimeout
connectTimeout：防止由于服务器处理时间过长而阻塞调用者
readTimeout：从建立连接时开始应用，并在返回响应时间过长时触发。
处理方式为：返回错误信息或fallback 其实就是hystrix的那一套机制。
实现步骤：
a、设置开启feign的熔断：feign.hystrix.enable=true
b、创建一个实现feign客户端类的fallback类，并重写方法，重写的方法其实就是针对这个方法的一个fallback处理。
c、在feign客户端类上的@FeignClient注解中用fallback属性引用
上面步骤仅仅针对学习或项目比较小，如果项目比较大，单独为每个feign客户端配置一个fallback类不合理，我们可以将微服务调用方法集中进行统一的fallback控制，这就涉及到工厂模式，使用工厂类。步骤如下：
a、创建工厂类，需要实现FallbackFactory
b、在feign客户端类上的@FeignClient注解中用fallbackFactory属性引用
4、创建客户端
创建客户端，有两种方式：注解和编码
通常我们一般使用注解的方式，即@FeignClient。我们也可以使用编码的方式手动创建Feign的客户端。这涉及到Feign的builder的使用，属于建造者模式。例如：
@Import(FeignClientsConfiguration.class) class FooController { private FooClient fooClient; private FooClient adminClient; @Autowired public FooController(Client client, Encoder encoder, Decoder decoder, Contract contract, MicrometerCapability micrometerCapability) { this." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/015dd9e2e23d3b817c90e2d6e3edcab2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-08T09:17:16+08:00" />
<meta property="article:modified_time" content="2022-07-08T09:17:16+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">OpenFeign的理解和使用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h4><a id="_0"></a>一、概述</h4> 
<p>openFeign是要声明式的web服务客户端，或叫做声明式REST客户端，它让编写web服务客户端变得简单。<br> 使用它的步骤：创建一个接口并注解它。它支持spring MVC的注解，spring cloud openFeign<strong>整合了hystrix，同时，可以和Eureka和ribbon配合使用</strong>，可以实现负载均衡的http客户端。<br> 可以理解为是请求转发（RPC调度）的入口。本章讲述的是2.2.10.RELEASE版本。</p> 
<h4><a id="_5"></a>二、使用步骤</h4> 
<p>1、引入spring-cloud-starter-openfeign 依赖。</p> 
<p>2、启动类上加上@EnableFeignClients开启Feign的客户端服务</p> 
<p>3、定义一个接口，并加上@FeignClient注解，同时，使用REST风格的接口请求服务。<br> 例如：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"provider"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OpenFeignService</span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/open"</span><span class="token punctuation">)</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>@FeignClient(“provider”)中的value值表示的是这个Feign客户端需要请求的微服务名称。这个名称代表了一个微服务或一个微服务组，其实就是<strong>spring.application.name</strong>的值。Feign客户端通过这个别名去EurekaServer服务端去找到这个别名对应的微服务。</p> 
<p>如果你在项目中还使用了ribbon做负载均衡且结合了Eureka，那么，ribbon将去Eureka的服务注册中心拉取注册表，并缓存到本地，并结合负载均衡算法，选取一个物理主机作为服务端。</p> 
<h4><a id="openFeign_24"></a>三、openFeign的使用</h4> 
<p>1、如果你不喜欢Feign默认的配置，可以使用FeignClientsConfiguration ，这个类能够让我们全面的控制Feign客户端。步骤如下：<br> a、定义一个类，继承FeignClientsConfiguration 。</p> 
<p>b、重写方法。</p> 
<p>c、在@FeignClient 中通过configuration属性引入自定义类。<br> 注意：这个配置类不能注册进spring容器，即不需要使用@Component注解。当然，如果重写Feign的配置不想用自定义类，也可以使用配置文件。如果你既使用了配置类，又使用了配置文件，则配置文件生效。</p> 
<p>2、如果你想定义多个Feign客户端，想区分他们，可以使用contextId属性。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@FeignClient</span>（name <span class="token operator">=</span> 'provider'<span class="token punctuation">,</span>contextId <span class="token operator">=</span> <span class="token string">"AClient"</span><span class="token punctuation">,</span>configuration <span class="token operator">=</span> <span class="token string">"FeignConfig.class"</span>）
</code></pre> 
<p>3、<strong>熔断机制</strong><br> OpenFeign 整合了hystrix做熔断处理，包括超时和异常熔断。其中对于超时，OpenFeign提供了两个参数：connectTimeout和readTimeout<br> connectTimeout：防止由于服务器处理时间过长而阻塞调用者<br> readTimeout：从建立连接时开始应用，并在返回响应时间过长时触发。<br> 处理方式为：返回错误信息或fallback 其实就是hystrix的那一套机制。<br> 实现步骤：<br> a、设置开启feign的熔断：feign.hystrix.enable=true<br> b、创建一个实现feign客户端类的fallback类，并重写方法，重写的方法其实就是针对这个方法的一个fallback处理。<br> c、在feign客户端类上的@FeignClient注解中用fallback属性引用</p> 
<p>上面步骤仅仅针对学习或项目比较小，如果项目比较大，单独为每个feign客户端配置一个fallback类不合理，我们可以将微服务调用方法集中进行统一的fallback控制，这就涉及到工厂模式，使用工厂类。步骤如下：<br> a、创建工厂类，需要实现FallbackFactory<br> b、在feign客户端类上的@FeignClient注解中用fallbackFactory属性引用</p> 
<p>4、创建客户端<br> 创建客户端，有两种方式：注解和编码<br> 通常我们一般使用注解的方式，即@FeignClient。我们也可以使用编码的方式手动创建Feign的客户端。这涉及到Feign的builder的使用，属于<strong>建造者模式</strong>。例如：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token class-name">FeignClientsConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">FooController</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token class-name">FooClient</span> fooClient<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">FooClient</span> adminClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">public</span> <span class="token class-name">FooController</span><span class="token punctuation">(</span><span class="token class-name">Client</span> client<span class="token punctuation">,</span> <span class="token class-name">Encoder</span> encoder<span class="token punctuation">,</span> <span class="token class-name">Decoder</span> decoder<span class="token punctuation">,</span> <span class="token class-name">Contract</span> contract<span class="token punctuation">,</span> <span class="token class-name">MicrometerCapability</span> micrometerCapability<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fooClient <span class="token operator">=</span> <span class="token class-name">Feign</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">client</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">encoder</span><span class="token punctuation">(</span>encoder<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">decoder</span><span class="token punctuation">(</span>decoder<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">contract</span><span class="token punctuation">(</span>contract<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">addCapability</span><span class="token punctuation">(</span>micrometerCapability<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">requestInterceptor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BasicAuthRequestInterceptor</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"user"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">target</span><span class="token punctuation">(</span><span class="token class-name">FooClient</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">"https://PROD-SVC"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>adminClient <span class="token operator">=</span> <span class="token class-name">Feign</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">client</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">encoder</span><span class="token punctuation">(</span>encoder<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">decoder</span><span class="token punctuation">(</span>decoder<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">contract</span><span class="token punctuation">(</span>contract<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">addCapability</span><span class="token punctuation">(</span>micrometerCapability<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">requestInterceptor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BasicAuthRequestInterceptor</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">,</span> <span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">target</span><span class="token punctuation">(</span><span class="token class-name">FooClient</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">"https://PROD-SVC"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>5、刷新配置@RefreshScope<br> 在项目中，我们的配置信息一般放在<strong>配置中心</strong>中，常见的配置中心有：Apollo、nacos和spring cloud config<br> 如果由于某些原因，导致配置中心中的配置修改了，但是，我们项目不想重启，这时候，就需要动态配置刷新的功能。在openFeign中，我们可以在配置文件中开启刷新功能：feign.client.refresh-enabled: true</p> 
<h4><a id="_89"></a>四、使用-截取重要代码</h4> 
<p>openFeign的配置文件</p> 
<pre><code class="prism language-yaml">
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">serviceUrl</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>8761/eureka/
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> openfeign0<span class="token punctuation">-</span>cheng
    <span class="token key atrule">lease-expiration-duration-in-seconds</span><span class="token punctuation">:</span> <span class="token number">20</span>  <span class="token comment">#租赁维持时间 （存活时间，发送心跳刷新）</span>
    <span class="token key atrule">lease-renewal-interval-in-seconds</span><span class="token punctuation">:</span> <span class="token number">10</span>  <span class="token comment">#租赁续订间隔（发送心跳间隔）</span>

<span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
  <span class="token key atrule">eureka</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

<span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">refresh-enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">httpclient</span><span class="token punctuation">:</span>
    <span class="token key atrule">connection-timeout</span><span class="token punctuation">:</span> <span class="token number">500</span>
</code></pre> 
<p>openFeign的客户端</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token comment">//@FeignClient(value = "provider",url = "http://provider:8002")</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"provider"</span><span class="token punctuation">,</span>fallbackFactory <span class="token operator">=</span> <span class="token class-name">TestFallbackFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OpenFeignService</span> <span class="token punctuation">{<!-- --></span>

        <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/open"</span><span class="token punctuation">)</span>
        <span class="token annotation punctuation">@LoadBalanced</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>openFeign的启动类</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@SpringBootApplication</span><span class="token punctuation">(</span>exclude <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token class-name">DataSourceAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableFeignClients</span>
<span class="token annotation punctuation">@EnableEurekaClient</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OpenfeignApplication</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">OpenfeignApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_145"></a>五、总结</h4> 
<p>1、openFeign是一个<strong>HTTP客户端</strong>，它融合了springmvc的注解，使之可以用REST风格的映射来请求转发。</p> 
<p>2、可以把openFegin理解为是controller层或是service层。可以取代springmvc控制层作为请求映射，亦或是作为service层处理逻辑，只不过这里，openFeign只是做一个请求转发的逻辑操作。</p> 
<p>3、openFeign整合了hystrix做熔断处理，同时，可以和ribbon客户端负载均衡、Eureka注册中心配合使用，实现负载均衡的客户端。</p> 
<p>4、openFeign有一个很重要的功能：fallback，其实它是hystrix的特性</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9b858cd8c5840174b4b92d803d323e51/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">CF804 E-Three Days Grace</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f7c9c5f2e5cc043d90293e489c887ef2/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">个人开发者实现微信扫码登录</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>