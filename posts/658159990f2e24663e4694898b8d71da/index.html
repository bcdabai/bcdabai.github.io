<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SpringBoot 使用 Feign 无废话 All-in-one 指南 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="SpringBoot 使用 Feign 无废话 All-in-one 指南" />
<meta property="og:description" content="开篇 Feign 是声明式、模板化的 HTTP 客户端， 可以帮助我们更快捷、优雅地调用 HTTP API；Spring Cloud 为 Feign 添加了 Spring MVC 的注解支持，并整合了 Ribbon 和 Eureka 来为使用 Feign 时提供负载均衡；在 Spring Cloud 中使用 Feign 是非常容易的。
本篇主要介绍 SpringBoot 中要玩转 Feign 需要掌握的如添加 pom 依赖、客户端注解启用、切换底层 HttpClient、配置数据压缩、调整日志级别、定制配置、配置的优先级机制、增加拦截器以及拦截器的追加机制等知识。
一、使用 Feign 的示例 1.1 添加依赖 &lt;dependencies&gt; &lt;!--openfein的依赖--&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt; &lt;version&gt;2.1.3.RELEASE&lt;/version&gt; &lt;/dependency&gt; &lt;/dependencies&gt; 复制代码 1.2 启用 Feign 在 SpringBoot 的启用类上添加注解@EnableFeignClients，@EnableFeignClients用于开启 Feign，会自动扫描@FeignClient标注的 FeignClient 接口。
@SpringBootApplication @EnableFeignClients @EnableWeb public class FeignApplication { public static void main(String[] args) { SpringApplication." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/658159990f2e24663e4694898b8d71da/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-26T09:52:51+08:00" />
<meta property="article:modified_time" content="2022-11-26T09:52:51+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SpringBoot 使用 Feign 无废话 All-in-one 指南</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h3>开篇</h3> 
<p>Feign 是声明式、模板化的 HTTP 客户端， 可以帮助我们更快捷、优雅地调用 HTTP API；Spring Cloud 为 Feign 添加了 Spring MVC 的注解支持，并整合了 Ribbon 和 Eureka 来为使用 Feign 时提供负载均衡；在 Spring Cloud 中使用 Feign 是非常容易的。</p> 
<p>本篇主要介绍 SpringBoot 中要玩转 Feign 需要掌握的如添加 pom 依赖、客户端注解启用、切换底层 HttpClient、配置数据压缩、调整日志级别、定制配置、配置的优先级机制、增加拦截器以及拦截器的追加机制等知识。</p> 
<h3>一、使用 Feign 的示例</h3> 
<h4>1.1 添加依赖</h4> 
<pre><code>&lt;dependencies&gt;
  &lt;!--openfein的依赖--&gt;
  &lt;dependency&gt;
      &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
      &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;
      &lt;version&gt;2.1.3.RELEASE&lt;/version&gt;
  &lt;/dependency&gt;
&lt;/dependencies&gt;
复制代码</code></pre> 
<h4>1.2 启用 Feign</h4> 
<p>在 SpringBoot 的启用类上添加注解<code>@EnableFeignClients</code>，<code>@EnableFeignClients</code>用于开启 Feign，会自动扫描<code>@FeignClient</code>标注的 FeignClient 接口。</p> 
<pre><code>@SpringBootApplication
@EnableFeignClients
@EnableWeb
public class FeignApplication {
    public static void main(String[] args) {
        SpringApplication.run(FeignApplication.class,args);
    }
}
复制代码</code></pre> 
<h4>1.3 编写 FeignClient 接口</h4> 
<pre><code>@FeignClient(
        name = "demo-service",
        url = "http://localhost:8080/feign/server/",
        configuration = FeignInterceptor.class,
        fallback = TestService.DefaultFallback.class
)
public interface TestService {

    @RequestMapping(value = "/getError/{id}", method = RequestMethod.GET)
    public String getError(@RequestParam("id") Integer id);


    @RequestMapping(value = "/get1", method = RequestMethod.GET)
    public String get1();

    @RequestMapping(value = "/get2/{param}", method = RequestMethod.GET)
    public String get2(@RequestParam("param") String param);

    @RequestMapping(value = "/post1", method = RequestMethod.POST)
    public FeignDemo post1(@RequestBody FeignDemo demo);
复制代码</code></pre> 
<h4>1.4 编写对应的服务端</h4> 
<pre><code>@RestController
@RequestMapping("/feign/server")
public class FeignServerController {

    @GetMapping("/get1")
    public String get1() {
        return "get1";
    }
    @GetMapping("/get2/{para}")
    public String get2(@PathVariable("para") String para){
        return para;
    }
    @PostMapping("/post1")
    public FeignDemo  post1(@RequestBody FeignDemo demo) {
        return demo;
    }
}
复制代码</code></pre> 
<pre><code>public class FeignDemo {
    private String name;
    private Integer age;

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public Integer getAge() {
        return age;
    }

    public void setAge(Integer age) {
        this.age = age;
    }

    @Override
    public String toString() {
        return "FeignDemo{" +
                "name='" + name + ''' +
                ", age=" + age +
                '}';
    }
}
复制代码</code></pre> 
<h4>1.5 调用 FeignClient</h4> 
<pre><code>@RunWith(SpringJUnit4ClassRunner.class)
@SpringBootTest(classes = {FeignApplication.class},webEnvironment = SpringBootTest.WebEnvironment.DEFINED_PORT)
@ActiveProfiles("dev,feign")
public class FeignClientTest {

    @Autowired
    private TestService testService;

    @Test
    public void testFallback(){
        testService.getError(1);
    }
    @Test
    public void testGet1(){
        System.out.println(testService.get1());
        System.out.println(testService.get2("abc"));
        System.out.printf("..");
        FeignDemo feignDemo = new FeignDemo();
        feignDemo.setName("name");
        feignDemo.setAge(1);
        System.out.println(testService.post1(feignDemo));
    }

@Component
    public class DefaultFallback implements TestService {

        @Override
        public String getError(@RequestParam("id") Integer id){
            return "";
        }

        @Override
        public String get1() {
            return null;
        }

        @Override
        public String get2(String param) {
            return null;
        }

        @Override
        public FeignDemo post1(FeignDemo demo) {
            return null;
        }

    }
}
复制代码</code></pre> 
<h3>二、如何切换 Client</h3> 
<p>Feign 中自带的是 HttpURLConnection，这个 client 健壮性差，可替换为成熟的 Apache HttpClient 或 OkHttp 来进行网络请求。</p> 
<h4>2.1 使用 Apache 的 HTTP Client</h4> 
<p>使用 Apache 的 <code>httpclient</code> 替换 Feign 中默认的 client。</p> 
<p>2.1.1 添加依赖</p> 
<pre><code>&lt;!--httpclient的依赖，因为选择了使用httpclient--&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.apache.httpcomponents&lt;/groupId&gt;
    &lt;artifactId&gt;httpclient&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;io.github.openfeign&lt;/groupId&gt;
    &lt;artifactId&gt;feign-httpclient&lt;/artifactId&gt;
    &lt;version&gt;10.4.0&lt;/version&gt;
&lt;/dependency&gt;
复制代码</code></pre> 
<p>2.1.2 配置启用</p> 
<p>配置中添加如下信息，表示启用<code>httpclient</code>。</p> 
<pre><code>feign:
  httpclient:
    enabled: true
复制代码</code></pre> 
<h4>2.2 使用 OkHttp</h4> 
<p>2.2.1 添加依赖</p> 
<p>在 Feign 中使用<code>OkHttp</code>作为网络请求框架，则只需要在 pom 文件中加上<code>feign-okhttp</code>的依赖，代码如下：</p> 
<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;io.github.openfeign&lt;/groupId&gt;
    &lt;artifactId&gt;feign-okhttp&lt;/artifactId&gt;
    &lt;version&gt;10.2.0&lt;/version&gt;
&lt;/dependency&gt;
复制代码</code></pre> 
<p>2.2.2 配置启用</p> 
<pre><code>feign:
  okhttp:
    enabled: true
复制代码</code></pre> 
<h3>三、如何修改日志级别</h3> 
<p>在发送和接收请求的时候，其内部将日志的打印输出定义成了四个等级，对应的详情如下：</p> 
<table><thead><tr><th>级别</th><th>说明</th></tr></thead><tbody><tr><td>NONE</td><td>不做任何记录</td></tr><tr><td>BASIC</td><td>仅记录请求方法和 URL 以及响应状态代码和执行时间</td></tr><tr><td>HEADERS</td><td>记录基本信息以及请求和响应标头</td></tr><tr><td>FULL</td><td>记录请求和响应的标题，正文和元数据</td></tr></tbody></table> 
<h4>3.1 通过配置文件修改日志级别</h4> 
<p>注意需要指定接口的全限定名</p> 
<pre><code>logging:
  level:
    com.zto.titans.test.feign.service.TestService : DEBUG
复制代码</code></pre> 
<h4>3.2 通过配置类修改日志级别</h4> 
<pre><code>@Configuration
public class FooConfiguration {
    @Bean
    Logger.Level feignLoggerLevel() {
        return Logger.Level.FULL;
    }
}
复制代码</code></pre> 
<p>这个一看即懂，不再废话。</p> 
<h3>四、如何实现数据压缩</h3> 
<p>可以分别对 HTTP 通信的<code>request</code>和<code>response</code>设置是否启用 GZIP 压缩，配置方法如下：</p> 
<pre><code>feign:
    compression:
        request:
            enabled: true
            mime-types: text/xml,application/xml,application/json # 配置压缩支持的MIME TYPE
            min-request-size: 2048  # 配置压缩数据大小的下限
        response:
            enabled: true # 配置响应GZIP压缩
复制代码</code></pre> 
<h3>五、FeignClient 的配置以及配置的优先级机制</h3> 
<p>有 2 种途径设置 FeignClient 的配置，通过自定义配置类来设置配置和在配置文件中设置，其中配置文件方式有点特殊，它里边可以指定全局配置对所有 FeignClient 有效，也可以为特定名称的 FeignClient 设置专属的配置。</p> 
<h4>5.1 通过自定义配置类来定制配置</h4> 
<p>实现一个配置类</p> 
<pre><code>public class TestConfiguration {
    @Bean
    Logger.Level feignLoggerLevel() {
        return Logger.Level.FULL;
    }
}
复制代码</code></pre> 
<p>将配置类 <code>TestConfiguration</code> 指定给<code>configuration</code>。</p> 
<pre><code>@FeignClient(
        name = "test-service",
        configuration = {FeignInterceptor2.class,TestConfiguration.class}
)
复制代码</code></pre> 
<h4>5.2 在配置文件中设置全局配置</h4> 
<p>feign.client.config.<strong>default</strong>.xxx ，这个<code>default意为</code>全局的配置属性。</p> 
<pre><code>feign:
  client:
    config:
      default:
        connectTimeout: 5000
        readTimeout: 5000
        loggerLevel: basic
复制代码</code></pre> 
<h4>5.3 在配置文件中设置专属配置</h4> 
<p>feign.client.config.<strong>feignName</strong>.xxx , 给名字为<strong>feignName</strong>的<code>FeignClient</code>指定专属的配置。</p> 
<pre><code>feign:
  client:
    config:
      feignName:
        connectTimeout: 5000
        readTimeout: 5000
        loggerLevel: full
        errorDecoder: com.example.SimpleErrorDecoder
        retryer: com.example.SimpleRetryer
        requestInterceptors:
          - com.example.FooRequestInterceptor
          - com.example.BarRequestInterceptor
        decode404: false
        encoder: com.example.SimpleEncoder
        decoder: com.example.SimpleDecoder
复制代码</code></pre> 
<h4>5.4 理解配置的优先级与拦截器的追加原则</h4> 
<p>从<code>org.springframework.cloud.openfeign.FeignClientFactoryBean#configureFeign</code>中可以确认以上 3 种配置的优先级：</p> 
<pre><code>configureUsingConfiguration(context, builder); // 1
configureUsingProperties(properties.getConfig().get(properties.getDefaultConfig()),builder); //2
configureUsingProperties(properties.getConfig().get(this.contextId),builder);//3
复制代码</code></pre> 
<ol><li>第 1 类为通过自定义配置类来指定配置</li><li>第 2 类为在配置文件中的<code>feign.client.config.default.xxx</code>设置全局配置</li><li>第 3 类为在配置文件中的<code>feign.client.config.feignName.xxx</code>设置专属配置</li></ol> 
<p>5.4.1 优先级的效果</p> 
<p><strong>配置文件里的专属配置</strong> -覆盖-&gt; <strong>配置文件里的全局配置</strong> -覆盖-&gt; <strong>配置类的配置</strong></p> 
<p>5.4.2 追加的原则</p> 
<p><code>RequestInterceptor</code> 是拦截器，可以在发送前做一些处理，比如统一添加<code>header</code>信息。每一类中的<code>requestInterceptors</code>可以存储多个拦截器，拦截器并非覆盖的效果，而是链式追加的效果；从执行顺序来看优先级是：1 &gt; 2 &gt; 3，即先执行 <strong>配置类中指定的拦截器</strong>，然后是 <strong>配置文件中指定的全局拦截器</strong>，最后是<strong>配置文件中指定的专属拦截器</strong>。</p> 
<p>需特别注意：<code>RequestInterceptor</code> 的实现类（例如 RI-A，RI-B）上如果添加了<code>@Component</code>注解，就都会被扫描识别到，并被追加到第一类的<code>requestInterceptors</code>列表中；倘若不小心 RI-A 还在第 2 类中又被指定了，则还会将拦截器 RI-A 追加在第二类的<code>requestInterceptors</code>列表中，结果是会 RI-A 总计会执行 2 次；若也在第三类中指定 RI-A，则 RI-A 也在其列表中追加，结果是 RI-A 总计会执行 3 次。</p> 
<p>5.4.3 拦截器的效果验证</p> 
<p>以一个实例来验证说明效果</p> 
<ul><li>自定义三个 RequestInterceptor</li></ul> 
<pre><code>class FeignInterceptor implements RequestInterceptor {
    @Override
    public void apply(RequestTemplate requestTemplate) {
        requestTemplate.header("user", "myuser1");
        requestTemplate.header("password", "mypassword");
    }
}
复制代码</code></pre> 
<pre><code>class FeignInterceptor1 implements RequestInterceptor {
    @Override
    public void apply(RequestTemplate requestTemplate) {
        requestTemplate.header("user1", "myuser1");
        requestTemplate.header("password1", "mypassword1");
    }
}
复制代码</code></pre> 
<pre><code>class FeignInterceptor2 implements RequestInterceptor {
    @Override
    public void apply(RequestTemplate requestTemplate) {
        requestTemplate.header("user2", "myuser2");
        requestTemplate.header("password2", "mypassword2");
    }
}
复制代码</code></pre> 
<ul><li>@FeignClient 中指定一个</li></ul> 
<pre><code>@FeignClient(
        name = "test-service",
        url = "http://localhost:8080/feign/server/",
        configuration = {FeignInterceptor.class,TestConfiguration.class},
        fallback = TestService.DefaultFallback.class
)
复制代码</code></pre> 
<ul><li>配置中指定 2 个</li></ul> 
<p><code>default</code> 指定了一个，<code>test-service</code>里指定一个</p> 
<pre><code>feign:
  httpclient:
    enabled: true
  okhttp:
    enabled: true
  client:
    config:
      default:
        connectTimeout: 5000
        readTimeout: 5000
        #loggerLevel: none
        requestInterceptors:
          - com.zto.titans.test.feign.service.FeignInterceptor1
      test-service:
        #loggerLevel: basic
        requestInterceptors:
          - com.zto.titans.test.feign.service.FeignInterceptor2
logging:
  level:
    com.zto.titans.test.feign.service.TestService : DEBUG
复制代码</code></pre> 
<p>根据追加逻辑，最终执行的顺序是：</p> 
<ol><li>FeignInterceptor</li><li>FeignInterceptor1</li><li>FeignInterceptor2</li></ol> 
<h3>总结</h3> 
<p>本篇主要介绍 SpringBoot 中要玩转 Feign 需要掌握的如添加 pom 依赖、客户端注解启用、切换底层 HttpClient、配置数据压缩、调整日志级别、定制配置、配置的优先级机制、增加拦截器以及拦截器的追加机制等知识，以实例 + 效果的方式帮读者高效全面并深入的理解它们。</p> 
<h3>最后说一句(请关注，莫错过)</h3> 
<p>如果这篇文章对您有帮助，或者有所启发的话，欢迎关注公众号【 架构染色 】进行交流和学习。您的支持是我坚持写作最大的动力。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c334e0ad68f655f20038b620a56c0de0/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Springboot中常用注解的使用语境、方法以及常用的maven坐标</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c9e5826a6b6544015bd8ab6939cf873a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">C&#43;&#43;版忍者跑酷小游戏（可直接复制程序源代码）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>