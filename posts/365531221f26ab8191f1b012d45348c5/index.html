<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>linux c sqlite 数据库 使用 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="linux c sqlite 数据库 使用" />
<meta property="og:description" content="linux c sqlite 使用
biometric-authenticationd.c
sqlite3 *bio_sto_connect_db() { sqlite3 *db = NULL; int ret = -1; bool need_create = false; ret = access(DB_PATH, F_OK); if (ret != 0) { need_create = true; ret = access(DB_DIR, F_OK); if (ret != 0) { internal_create_dir(DB_DIR); } /* 创建数据库 */ ret = sqlite3_open_v2(DB_PATH, &amp;db, SQLITE_OPEN_READWRITE | SQLITE_OPEN_CREATE, NULL); if (ret != SQLITE_OK) { bio_print_error(_(&#34;sqlite3 prepare err: %s\n&#34;), sqlite3_errmsg(db)); return NULL; } sqlite3_close_v2(db); /* 设置默认权限：0600（只允许root用户读写） */ ret = chmod(DB_PATH, S_IRUSR | S_IWUSR); if (ret !" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/365531221f26ab8191f1b012d45348c5/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-18T10:46:56+08:00" />
<meta property="article:modified_time" content="2022-07-18T10:46:56+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">linux c sqlite 数据库 使用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>linux c sqlite 使用</p> 
<p>biometric-authenticationd.c</p> 
<pre><code class="prism language-c">sqlite3 <span class="token operator">*</span><span class="token function">bio_sto_connect_db</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	sqlite3 <span class="token operator">*</span>db <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	bool need_create <span class="token operator">=</span> false<span class="token punctuation">;</span>

	ret <span class="token operator">=</span> <span class="token function">access</span><span class="token punctuation">(</span>DB_PATH<span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		need_create <span class="token operator">=</span> true<span class="token punctuation">;</span>

		ret <span class="token operator">=</span> <span class="token function">access</span><span class="token punctuation">(</span>DB_DIR<span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">internal_create_dir</span><span class="token punctuation">(</span>DB_DIR<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">/* 创建数据库 */</span>
		ret <span class="token operator">=</span> <span class="token function">sqlite3_open_v2</span><span class="token punctuation">(</span>DB_PATH<span class="token punctuation">,</span> <span class="token operator">&amp;</span>db<span class="token punctuation">,</span>
							  SQLITE_OPEN_READWRITE <span class="token operator">|</span> SQLITE_OPEN_CREATE<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> SQLITE_OK<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">bio_print_error</span><span class="token punctuation">(</span><span class="token function">_</span><span class="token punctuation">(</span><span class="token string">"sqlite3 prepare err: %s\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">sqlite3_errmsg</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">sqlite3_close_v2</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">/* 设置默认权限：0600（只允许root用户读写） */</span>
		ret <span class="token operator">=</span> <span class="token function">chmod</span><span class="token punctuation">(</span>DB_PATH<span class="token punctuation">,</span> S_IRUSR <span class="token operator">|</span> S_IWUSR<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token function">bio_print_error</span><span class="token punctuation">(</span><span class="token function">_</span><span class="token punctuation">(</span><span class="token string">"Unable to set database(%s) permissions. ERROR"</span>
							  <span class="token string">"[%d]: %s\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> DB_PATH<span class="token punctuation">,</span> errno<span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	ret <span class="token operator">=</span> <span class="token function">sqlite3_open_v2</span><span class="token punctuation">(</span>DB_PATH<span class="token punctuation">,</span> <span class="token operator">&amp;</span>db<span class="token punctuation">,</span>
							  SQLITE_OPEN_READWRITE <span class="token operator">|</span> SQLITE_OPEN_CREATE<span class="token punctuation">,</span>
							  <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> SQLITE_OK<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">bio_print_error</span><span class="token punctuation">(</span><span class="token function">_</span><span class="token punctuation">(</span><span class="token string">"sqlite3 prepare err: %s\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">sqlite3_errmsg</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>need_create<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		ret <span class="token operator">=</span> <span class="token function">bio_sto_create_table</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">sqlite3_close_v2</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> db<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>22</p> 
<pre><code class="prism language-c">feature_info <span class="token operator">*</span><span class="token function">bio_sto_get_feature_info</span><span class="token punctuation">(</span>sqlite3 <span class="token operator">*</span>db<span class="token punctuation">,</span>
													   <span class="token keyword">int</span> uid<span class="token punctuation">,</span>
													   <span class="token keyword">int</span> biotype<span class="token punctuation">,</span>
													   <span class="token keyword">char</span> <span class="token operator">*</span>driver<span class="token punctuation">,</span>
													   <span class="token keyword">int</span> index_start<span class="token punctuation">,</span>
													   <span class="token keyword">int</span> index_end<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	feature_info <span class="token operator">*</span>info_list <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	feature_info <span class="token operator">*</span>info <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	feature_sample <span class="token operator">*</span>sample <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

	sqlite3_stmt <span class="token operator">*</span>stmt <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> uuid<span class="token punctuation">[</span>UUID_BUF_LEN<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> user_uuid<span class="token punctuation">[</span>UUID_BUF_LEN<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> l <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token keyword">char</span> old_uuid<span class="token punctuation">[</span>UUID_BUF_LEN<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> old_uid <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> old_bio_type <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>old_driver <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> old_idx <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>


	<span class="token keyword">char</span> <span class="token operator">*</span>base_sql_str <span class="token operator">=</span> <span class="token string">"SELECT ID, UID, UUID, BioType, Driver, EigenIndex, "</span>
						 <span class="token string">"  EigenIndexName, SampleNo, EigenData "</span>
						 <span class="token string">"FROM EIGEN_INFO "</span>
						 <span class="token string">"WHERE EigenIndex &gt;= :index_start"</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>uid_sql_str <span class="token operator">=</span> <span class="token string">" AND UID = :uid "</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>biotype_sql_str <span class="token operator">=</span> <span class="token string">" AND BioType = :biotype "</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>driver_sql_str <span class="token operator">=</span> <span class="token string">" AND Driver = :driver "</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>idx_end_sql_str <span class="token operator">=</span> <span class="token string">" AND EigenIndex &lt;= :index_end "</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>order_sql_str <span class="token operator">=</span> <span class="token string">" ORDER BY UID, UUID, BioType, Driver, EigenIndex, "</span>
						  <span class="token string">"EigenIndexName, SampleNo "</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>all_sql_str <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>


    <span class="token function">bio_print_debug</span> <span class="token punctuation">(</span><span class="token string">"%s start uid = %d\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">,</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>    

	l <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>base_sql_str<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">strlen</span><span class="token punctuation">(</span>uid_sql_str<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">strlen</span><span class="token punctuation">(</span>biotype_sql_str<span class="token punctuation">)</span> <span class="token operator">+</span>
			<span class="token function">strlen</span><span class="token punctuation">(</span>driver_sql_str<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">strlen</span><span class="token punctuation">(</span>idx_end_sql_str<span class="token punctuation">)</span> <span class="token operator">+</span>
			<span class="token function">strlen</span><span class="token punctuation">(</span>order_sql_str<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
	all_sql_str <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>all_sql_str <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">bio_print_error</span><span class="token punctuation">(</span><span class="token function">_</span><span class="token punctuation">(</span><span class="token string">"Unable to allocate memory\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">memset</span><span class="token punctuation">(</span>all_sql_str<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> l<span class="token punctuation">)</span><span class="token punctuation">;</span>

	l <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>all_sql_str<span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> base_sql_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>uid <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
		l <span class="token operator">+=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>all_sql_str <span class="token operator">+</span> l<span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> uid_sql_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>biotype <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
		l <span class="token operator">+=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>all_sql_str <span class="token operator">+</span> l<span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> biotype_sql_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>driver <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
		l <span class="token operator">+=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>all_sql_str <span class="token operator">+</span> l<span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> driver_sql_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>index_end <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
		l <span class="token operator">+=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>all_sql_str <span class="token operator">+</span> l<span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> idx_end_sql_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
	l <span class="token operator">+=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>all_sql_str <span class="token operator">+</span> l<span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> order_sql_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">bio_print_debug</span><span class="token punctuation">(</span><span class="token string">"get sql : %s\n"</span><span class="token punctuation">,</span> all_sql_str<span class="token punctuation">)</span><span class="token punctuation">;</span>

	ret <span class="token operator">=</span> <span class="token function">sqlite3_prepare_v2</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> all_sql_str<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>stmt<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>all_sql_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> SQLITE_OK<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">bio_print_error</span><span class="token punctuation">(</span><span class="token function">_</span><span class="token punctuation">(</span><span class="token string">"sqlite3 prepare err: %s\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">sqlite3_errmsg</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	idx <span class="token operator">=</span> <span class="token function">sqlite3_bind_parameter_index</span><span class="token punctuation">(</span>stmt<span class="token punctuation">,</span> <span class="token string">":uid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sqlite3_bind_int64</span><span class="token punctuation">(</span>stmt<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> uid<span class="token punctuation">)</span><span class="token punctuation">;</span>

	idx <span class="token operator">=</span> <span class="token function">sqlite3_bind_parameter_index</span><span class="token punctuation">(</span>stmt<span class="token punctuation">,</span> <span class="token string">":biotype"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sqlite3_bind_int64</span><span class="token punctuation">(</span>stmt<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> biotype<span class="token punctuation">)</span><span class="token punctuation">;</span>

	idx <span class="token operator">=</span> <span class="token function">sqlite3_bind_parameter_index</span><span class="token punctuation">(</span>stmt<span class="token punctuation">,</span> <span class="token string">":driver"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sqlite3_bind_text</span><span class="token punctuation">(</span>stmt<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> driver<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> SQLITE_TRANSIENT<span class="token punctuation">)</span><span class="token punctuation">;</span>

	idx <span class="token operator">=</span> <span class="token function">sqlite3_bind_parameter_index</span><span class="token punctuation">(</span>stmt<span class="token punctuation">,</span> <span class="token string">":index_start"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sqlite3_bind_int64</span><span class="token punctuation">(</span>stmt<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> index_start<span class="token punctuation">)</span><span class="token punctuation">;</span>

	idx <span class="token operator">=</span> <span class="token function">sqlite3_bind_parameter_index</span><span class="token punctuation">(</span>stmt<span class="token punctuation">,</span> <span class="token string">":index_end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sqlite3_bind_int64</span><span class="token punctuation">(</span>stmt<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> index_end<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* 为了之后处理方便，创建表头空白项 */</span>
	info_list <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>feature_info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>info_list <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">bio_print_error</span><span class="token punctuation">(</span><span class="token function">_</span><span class="token punctuation">(</span><span class="token string">"Unable to allocate memory\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sqlite3_finalize</span><span class="token punctuation">(</span>stmt<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">memset</span><span class="token punctuation">(</span>info_list<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>feature_info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	info <span class="token operator">=</span> info_list<span class="token punctuation">;</span>

	<span class="token keyword">while</span><span class="token punctuation">(</span> <span class="token function">sqlite3_step</span><span class="token punctuation">(</span>stmt<span class="token punctuation">)</span> <span class="token operator">==</span> SQLITE_ROW <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		uid <span class="token operator">=</span> <span class="token function">sqlite3_column_int</span><span class="token punctuation">(</span>stmt<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">strncpy</span><span class="token punctuation">(</span>uuid<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">sqlite3_column_text</span><span class="token punctuation">(</span>stmt<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> UUID_BUF_LEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
		biotype <span class="token operator">=</span> <span class="token function">sqlite3_column_int</span><span class="token punctuation">(</span>stmt<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		driver <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">sqlite3_column_text</span><span class="token punctuation">(</span>stmt<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		idx <span class="token operator">=</span> <span class="token function">sqlite3_column_int</span><span class="token punctuation">(</span>stmt<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">/* 条件判断成功，代表uid、biotype、driver或index任意一个值有变化，
		 * 需要新建表项存储 */</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>old_uid <span class="token operator">&lt;</span> uid<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>old_bio_type <span class="token operator">&lt;</span> biotype<span class="token punctuation">)</span> <span class="token operator">||</span>
			 <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>old_driver<span class="token punctuation">,</span> driver<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>old_idx <span class="token operator">&lt;</span> idx<span class="token punctuation">)</span> <span class="token operator">||</span>
			 <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>old_uuid<span class="token punctuation">,</span> uuid<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>old_uid <span class="token operator">!=</span> uid<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token comment">// UID变化，UUID也需要跟着变化</span>
				<span class="token function">internal_get_uuid_by_uid</span><span class="token punctuation">(</span>uid<span class="token punctuation">,</span> user_uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
				old_uid <span class="token operator">=</span> uid<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token comment">// 检测数据库中的UUID是否与当前UID的UUID匹配，不匹配则弃用该条记录</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>uuid<span class="token punctuation">,</span> user_uuid<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">continue</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			old_uid <span class="token operator">=</span> uid<span class="token punctuation">;</span>
			old_bio_type <span class="token operator">=</span> biotype<span class="token punctuation">;</span>
			old_driver <span class="token operator">=</span> <span class="token function">internal_newstr</span><span class="token punctuation">(</span>driver<span class="token punctuation">)</span><span class="token punctuation">;</span>
			old_idx <span class="token operator">=</span> idx<span class="token punctuation">;</span>
			<span class="token function">strncpy</span><span class="token punctuation">(</span>old_uuid<span class="token punctuation">,</span> uuid<span class="token punctuation">,</span> UUID_BUF_LEN<span class="token punctuation">)</span><span class="token punctuation">;</span>

			info<span class="token operator">-&gt;</span>next <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>feature_info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			info <span class="token operator">=</span> info<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>info <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">/* malloc失败，释放资源 */</span>
				<span class="token function">bio_sto_free_feature_info_list</span><span class="token punctuation">(</span>info_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token function">memset</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>feature_info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			info<span class="token operator">-&gt;</span>uid <span class="token operator">=</span> uid<span class="token punctuation">;</span>
			info<span class="token operator">-&gt;</span>biotype <span class="token operator">=</span> biotype<span class="token punctuation">;</span>
			info<span class="token operator">-&gt;</span>driver <span class="token operator">=</span> old_driver<span class="token punctuation">;</span>
			info<span class="token operator">-&gt;</span>index <span class="token operator">=</span> idx<span class="token punctuation">;</span>
			info<span class="token operator">-&gt;</span>index_name <span class="token operator">=</span> <span class="token function">internal_newstr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">sqlite3_column_text</span><span class="token punctuation">(</span>stmt<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			sample <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>feature_sample<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>sample <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">bio_sto_free_feature_info_list</span><span class="token punctuation">(</span>info_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token function">memset</span><span class="token punctuation">(</span>sample<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>feature_sample<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			info<span class="token operator">-&gt;</span>sample <span class="token operator">=</span> sample<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">/* 检测数据库中的UUID是否与当前UID的UUID匹配 */</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>uuid<span class="token punctuation">,</span> user_uuid<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">continue</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			sample<span class="token operator">-&gt;</span>next <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>feature_sample<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			sample <span class="token operator">=</span> sample<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>sample <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">bio_sto_free_feature_info_list</span><span class="token punctuation">(</span>info_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token function">memset</span><span class="token punctuation">(</span>sample<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>feature_sample<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		sample<span class="token operator">-&gt;</span>dbid <span class="token operator">=</span> <span class="token function">sqlite3_column_int64</span><span class="token punctuation">(</span>stmt<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		sample<span class="token operator">-&gt;</span>no <span class="token operator">=</span> <span class="token function">sqlite3_column_int</span><span class="token punctuation">(</span>stmt<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		sample<span class="token operator">-&gt;</span>data <span class="token operator">=</span> <span class="token function">internal_newstr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">sqlite3_column_text</span><span class="token punctuation">(</span>stmt<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/* 移除表头空白项 */</span>
	info <span class="token operator">=</span> info_list<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>info_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
	info_list <span class="token operator">=</span> info<span class="token punctuation">;</span>

	<span class="token function">sqlite3_finalize</span><span class="token punctuation">(</span>stmt<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> info_list<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b37f3cd69e400dcf797aec0b9d9859dc/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【前端知识之CSS】flex弹性布局和grid网格布局</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/770e59be9e9110f3e577fae7b1c42015/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">CentOS7 安装 Logstash8.3.2</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>