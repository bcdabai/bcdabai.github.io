<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>磁盘类型和相关术语学习笔记 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="磁盘类型和相关术语学习笔记" />
<meta property="og:description" content="磁盘类型和相关术语 在 Linux 中一切皆文件，但是类型不同。例如使用 ls -l 对于设备文件和普通文件有一部分内容是不同的，即普通文件有大小，而设备文件有主设备号和次设备号，没有大小。
# ll 1.txt /dev/sda /dev/sda1 -rw-r--r-- 1 root root 47 Nov 30 21:22 1.txt brw-rw---- 1 root disk 8, 0 Dec 3 10:13 /dev/sda brw-rw---- 1 root disk 8, 1 Dec 3 10:13 /dev/sda1 如果使用 cp -a 复制一个块设备，这时两个文件的主设备号和次设备号相同，但是它们的 inode 不同，类似于文件的软连接。如果挂载复制出来的文件，可以访问到与被复制的设备的内容。
# df /dev/sda1 Filesystem 1K-blocks Used Available Use% Mounted on /dev/sda1 487634 142353 315585 32% /boot # cp -a /dev/sda1 ./sda1.bak # mount sda1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/24e24fd44805ba8995b043a49f7442b4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-10T10:12:46+08:00" />
<meta property="article:modified_time" content="2022-12-10T10:12:46+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">磁盘类型和相关术语学习笔记</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="centercenter_6"></a> 
 <center>
   磁盘类型和相关术语 
 </center></h2> 
<br> 
<p>在 Linux 中一切皆文件，但是类型不同。例如使用 <code>ls -l</code> 对于设备文件和普通文件有一部分内容是不同的，即普通文件有大小，而设备文件有主设备号和次设备号，没有大小。</p> 
<pre><code class="prism language-bash"><span class="token comment"># ll 1.txt /dev/sda /dev/sda1</span>
-rw-r--r-- <span class="token number">1</span> root root   <span class="token number">47</span> Nov <span class="token number">30</span> <span class="token number">21</span>:22 <span class="token number">1</span>.txt
brw-rw---- <span class="token number">1</span> root disk <span class="token number">8</span>, <span class="token number">0</span> Dec  <span class="token number">3</span> <span class="token number">10</span>:13 /dev/sda
brw-rw---- <span class="token number">1</span> root disk <span class="token number">8</span>, <span class="token number">1</span> Dec  <span class="token number">3</span> <span class="token number">10</span>:13 /dev/sda1
</code></pre> 
<p>如果使用 <code>cp -a</code> 复制一个块设备，这时两个文件的主设备号和次设备号相同，但是它们的 inode 不同，类似于文件的软连接。如果挂载复制出来的文件，可以访问到与被复制的设备的内容。</p> 
<pre><code class="prism language-bash"><span class="token comment"># df /dev/sda1</span>
Filesystem     1K-blocks   Used Available Use% Mounted on
/dev/sda1         <span class="token number">487634</span> <span class="token number">142353</span>    <span class="token number">315585</span>  <span class="token number">32</span>% /boot

<span class="token comment"># cp -a /dev/sda1 ./sda1.bak</span>
<span class="token comment"># mount sda1.bak /mnt</span>

<span class="token comment"># df /mnt</span>
Filesystem     1K-blocks   Used Available Use% Mounted on
/root/sda1.bak    <span class="token number">487634</span> <span class="token number">142353</span>    <span class="token number">315585</span>  <span class="token number">32</span>% /mnt

<span class="token comment"># ll -id /mnt /dev/sda1</span>
<span class="token number">15113</span> brw-rw----  <span class="token number">1</span> root disk <span class="token number">8</span>, <span class="token number">1</span> Dec  <span class="token number">3</span> <span class="token number">10</span>:13 /dev/sda1
    <span class="token number">2</span> dr-xr-xr-x. <span class="token number">6</span> root root <span class="token number">1024</span> Nov <span class="token number">13</span> <span class="token number">18</span>:27 /mnt
</code></pre> 
<p>使用专门的命令来创建相同的设备：</p> 
<pre><code class="prism language-bash"><span class="token comment"># mknod /data/sda1 b 8 1</span>
<span class="token comment"># mount /data/sda1 /mnt/</span>

<span class="token comment"># df /mnt</span>
Filesystem     1K-blocks   Used Available Use% Mounted on
/data/sda1        <span class="token number">487634</span> <span class="token number">142353</span>    <span class="token number">315585</span>  <span class="token number">32</span>% /mnt
</code></pre> 
<p>硬盘种类繁多，可能有：</p> 
<pre><code class="prism language-bash">/dev/sd<span class="token punctuation">[</span>a-z<span class="token punctuation">]</span>         <span class="token comment"># SCSI、SATA、SAS、USB 等</span>
/dev/nvme<span class="token punctuation">..</span>.         <span class="token comment"># nvme 协议，例如 固态硬盘</span>
/dev/vd              <span class="token comment"># 虚拟硬盘</span>
/dev/xvd
</code></pre> 
<p>如果在虚拟机上新增了几块硬盘，可以使用以下命令来进行扫描，使系统能够设别出来。</p> 
<pre><code class="prism language-bash">$ <span class="token builtin class-name">echo</span> <span class="token string">'- - -'</span> <span class="token operator">&gt;</span> /sys/class/scsi_host/host0/scan<span class="token punctuation">;</span><span class="token builtin class-name">echo</span> <span class="token string">'- - -'</span> <span class="token operator">&gt;</span> /sys/class/scsi_host/host1/scan<span class="token punctuation">;</span><span class="token builtin class-name">echo</span> <span class="token string">'- - -'</span> <span class="token operator">&gt;</span> /sys/class/scsi_host/host2/scan

<span class="token comment"># 最好设置成别名</span>
<span class="token comment"># alias scandisk="echo '- - -' &gt; /sys/class/scsi_host/host0/scan;echo '- - -' &gt; /sys/class/scsi_host/host1/scan;echo '- - -' &gt; /sys/class/scsi_host/host2/scan"</span>
</code></pre> 
<p>可以使用以下命令判断是否具有旋转特性的存储设备，值是 1 表示是机械硬盘， 值是 0 表示固态硬盘：</p> 
<pre><code class="prism language-bash"><span class="token punctuation">]</span><span class="token comment"># lsblk -d -o NAME,ROTA</span>
NAME ROTA
sda     <span class="token number">1</span>
sr0     <span class="token number">1</span>
</code></pre> 
<p>也可以使用以下命令查看：</p> 
<pre><code class="prism language-bash"><span class="token punctuation">]</span><span class="token comment"># ls /sys/block                     # 列出当前的硬件设备</span>
sda  sr0
<span class="token punctuation">]</span><span class="token comment"># cat /sys/block/sda/queue/rotational</span>
<span class="token number">1</span>
<span class="token punctuation">]</span><span class="token comment"># cat /sys/block/sr0/queue/rotational</span>
<span class="token number">1</span>

<span class="token punctuation">]</span><span class="token comment"># cat /sys/block/*/query/rotational</span>
</code></pre> 
<h3><a id="_89"></a>磁盘分区</h3> 
<h4><a id="_91"></a>分区方式</h4> 
<p>目前有两种分区的方式：MBR、GPT。</p> 
<h5><a id="MBR_95"></a>MBR</h5> 
<p>MBR：Master Boot Record, 1982年，使用 32 位表示扇区数，分区不超过 2T。</p> 
<pre><code class="prism language-bash">$ <span class="token builtin class-name">echo</span> <span class="token number">2</span>^32*512/1024/1024/1024 <span class="token operator">|</span> <span class="token function">bc</span>
<span class="token number">2048</span>
</code></pre> 
<p>CentOS 6 版本开始按照 Sector 划分，而 CentOS 5 及之前采用柱面划分。</p> 
<p>0 磁道 0 扇区：512 bytes<br> 446 bytes --&gt; boot loader<br> 64 bytes --&gt; 分区表，每 16 字节标识一个分区<br> 2 bytes --&gt; 55AA</p> 
<p>因此，MBR 分区的硬盘最多只能有 4 个主分区，或分出其中的分区成为扩展分区。</p> 
<p>可以使用以下命令查看十六进制的分区情况，最后部分是有关分区的数据：</p> 
<pre><code class="prism language-bash"><span class="token comment"># hexdump -C -n 512 /dev/sda1</span>
</code></pre> 
<p>硬盘的分区表数据很重要，如果不小心弄坏了，就不能启动电脑了。我们需要对分区表进行备份(Disk Partition Table)：</p> 
<p>说明：<code>dd</code> 命令中 skip 表示跳过源位置，seek 表示跳过目标位置</p> 
<pre><code class="prism language-bash"><span class="token comment"># 备份分区表</span>
<span class="token punctuation">]</span><span class="token comment"># dd if=/dev/sda of=/data/dpt.img bs=1 count=64 skip=446</span>
<span class="token punctuation">]</span><span class="token comment"># scp dpt.img 10.0.0.200:</span>

<span class="token comment"># 破坏分区表</span>
<span class="token punctuation">]</span><span class="token comment"># dd if=/dev/zero of=/data/sda bs=1 count=64 skip=446</span>
<span class="token comment"># 使用以下命令已经看不到分区表</span>
<span class="token punctuation">]</span><span class="token comment"># fdisk -l</span>
</code></pre> 
<p>如果此时进行 <code>reboot</code> 就无法启动 Linux 了。</p> 
<p>我们需要使用其他启动方式，例如使用光盘启动，进入 ‘rescue mode’，选择第 3 项 ‘skip to shell’。</p> 
<p>先要配置网络，没有网络可能得不到备份文件。</p> 
<pre><code class="prism language-bash"><span class="token punctuation">]</span><span class="token comment"># ifconfig ens33 10.0.0.100/24           # 或使用推荐的命令</span>
<span class="token punctuation">]</span><span class="token comment"># ip addr add 10.0.0.100/24  dev ens33</span>

<span class="token punctuation">]</span><span class="token comment"># scp 10.0.0.200:/root/dpt.img ./</span>

<span class="token comment"># 恢复分区表</span>
<span class="token punctuation">]</span><span class="token comment"># dd if=dpt.img of=/dev/sda bs=1 seek=446</span>
<span class="token punctuation">]</span><span class="token comment"># exit</span>
</code></pre> 
<h5><a id="GPT_150"></a>GPT</h5> 
<p>GPT：GUID (Globals Unique IDentifiers)，支持128个分区表，使用 64 位，支持 8Z 空间（512Byte/block）至 64Z 空间（4096Byte/block）。</p> 
<p>使用 128 位 UUID （Universible Firmware Interface）表示磁盘和分区。该分区表自动在头和尾进行备份，并有 CRC 校验位。</p> 
<p>UEFI（Unified Extensible Firmware Interface）统一可扩展固件接口的硬件支持 GPT 分区。</p> 
<h5><a id="BIOS__UEFI_158"></a>BIOS 和 UEFI</h5> 
<p>BIOS 采用了 16 位汇编语言编写，只能运行在实模式中（内存寻址方式由 16 位段寄存器的内容乘以16 (10H) 当做段基地址，加上 16 位偏移地址形成 20 位的物理地址下，可访问的内存空间为 1MB，只支持字符操作界面。</p> 
<p>UEFI 采用了 32 位或 64 位的 C 语言编写，突破了实模式的限制，可达最大的寻址空间，支持图形界面，使用文件方式保存信息，支持 GPT 分区启动，适合较新的系统和硬件配合使用。</p> 
<h5><a id="_165"></a>管理分区</h5> 
<p>列出块设备的命令是 <code>lsblk</code>。</p> 
<p>创建分区命令：</p> 
<pre><code class="prism language-bash"><span class="token function">fdisk</span>       <span class="token comment"># 管理 MBR 分区，在 CentOS 8 中也支持 GPT 分区</span>
gdisk       <span class="token comment"># 管理 GPT 分区</span>
<span class="token function">parted</span>      <span class="token comment"># 高级分区操作</span>
</code></pre> 
<p>重新设置内存中的内核分区表，使内存中的分区与 <code>fdisk</code> 显示的一样：</p> 
<pre><code class="prism language-bash"><span class="token comment"># 对于 CentOS 5，7, 8 使用</span>
partprobe

<span class="token comment"># 以上命令对于 CentOS 6 没有效果，使用以下命令</span>
partx <span class="token parameter variable">-a</span> /dev/sda
<span class="token comment"># 如果删除了 6，7, 8 三个分区，这时需要使用以下参数</span>
partx <span class="token parameter variable">-d</span> <span class="token parameter variable">--nr</span> <span class="token number">6</span>-8 /dev/sda
</code></pre> 
<p>可以使用以下命令查看分区的情况：</p> 
<pre><code class="prism language-bash"><span class="token function">fdisk</span> l
lsblk
<span class="token function">cat</span> /proc/partitions
</code></pre> 
<h6><a id="parted__197"></a>parted 命令</h6> 
<p>该命令支持可交互或非交互的方式，其操作是实时生效的，要小心使用。其使用格式为：</p> 
<pre><code class="prism language-bash"><span class="token function">parted</span> <span class="token punctuation">[</span>option<span class="token punctuation">]</span><span class="token punctuation">..</span>. <span class="token punctuation">[</span>device <span class="token punctuation">[</span>cmd <span class="token punctuation">[</span>param<span class="token punctuation">]</span><span class="token punctuation">..</span>.<span class="token punctuation">]</span><span class="token punctuation">..</span>.<span class="token punctuation">]</span>
</code></pre> 
<p>示例：</p> 
<pre><code class="prism language-bash"><span class="token function">parted</span> /dev/sdb mklabel gpt<span class="token operator">|</span>msdos       <span class="token comment"># msdos for MBR</span>
<span class="token function">parted</span> /dev/sdb print
<span class="token function">parted</span> /dev/sdb mkpart primary <span class="token number">1</span> <span class="token number">200</span>    <span class="token comment"># 默认单位是 M</span>
<span class="token function">parted</span> /dev/sdb <span class="token function">rm</span> <span class="token number">1</span>                    <span class="token comment"># 1 表示第一个分区数字</span>
<span class="token function">parted</span> <span class="token parameter variable">-l</span>                               <span class="token comment"># 列出所有硬盘分区信息</span>

<span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/zero <span class="token assign-left variable">of</span><span class="token operator">=</span>/dev/sdb <span class="token assign-left variable">bs</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">count</span><span class="token operator">=</span><span class="token number">66</span> <span class="token assign-left variable">seek</span><span class="token operator">=</span><span class="token number">64</span>    <span class="token comment"># 清除分区信息及最后两个字节 '55aa'</span>
<span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/zero <span class="token assign-left variable">of</span><span class="token operator">=</span>/dev/sdb <span class="token assign-left variable">bs</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">count</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">seek</span><span class="token operator">=</span><span class="token number">510</span>    <span class="token comment"># 清除分区表最后两个字节 '55aa'</span>
</code></pre> 
<h6><a id="fdisk_218"></a>fdisk</h6> 
<p>从 CentOS 8 开始也支持 GPT 分区，它是交互式操作的。操作时有对应的提示。不是实时操作的。</p> 
<p>如果只有一块硬盘，需要安装操作系统，必须要设置主分区，如果不安装操作系统，可以创建扩展分区。但是最多只能是一个扩展分区，而主分区最多只能有4个。</p> 
<p>如果有几个扩展的逻辑分区，中途删除一个分区，则后面的分区编号会自动填补空缺，这样说明，使用这样的设备名在编程中可能由于设备名改变造成不正确 <code>/dev/sda5</code>。</p> 
<p>如果想要使用非交互式创建分区</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">'n\np\n\n\n+2G\nw\n'</span> <span class="token operator">|</span> <span class="token function">fdisk</span> /dev/sdc
</code></pre> 
<h4><a id="_232"></a>文件系统</h4> 
<h5><a id="_234"></a>文件系统概念</h5> 
<p>操作系统负责管理和存储文件信息的软件结构称为文件管理系统，简称文件系统。从系统角度看，文件系统是对文件存储设备的空间进行组织和分配，负责文件存储并对存入的文件进行保护和检索的系统。具体地说，负责为用户建立文件，存入、读出、修改、转储文件，控制文件的存取，安全控制，日志，压缩和加密等。</p> 
<p>支持的文件系统：</p> 
<pre><code class="prism language-bash"><span class="token function">ls</span> /lib/modules/<span class="token variable"><span class="token variable">`</span><span class="token function">uname</span> <span class="token parameter variable">-r</span><span class="token variable">`</span></span>/kernel/fs
</code></pre> 
<p>查询帮助</p> 
<pre><code class="prism language-bash"><span class="token function">man</span> <span class="token number">5</span> fs
</code></pre> 
<h5><a id="_250"></a>文件系统类型</h5> 
<p><strong>Linux 常用文件系统</strong></p> 
<ul><li>ext2：Extended file system，适用于分区容量不太大，不频繁更新的分区，例如，/boot 分区</li><li>ext3：是 ext2 的改进版本，支持日志功能，能够帮助系统从非正常关机导致的异常中恢复</li><li>ext4：是 ext 文件系统的最新版。提供了许多新的特性，包括纳秒级时间戳、创建和使用巨型文件（16T），最大 1EB 的文件系统，以及提升速度</li><li>xfs：SGI，支持最大 8EB 的文件大小</li><li>swap：交换</li><li>iso9660：光盘</li><li>btrfs</li><li>reiserfs</li></ul> 
<p><strong>Windsows 常用文件系统</strong></p> 
<ul><li>FAT32</li><li>NTFS</li><li>exFAT</li></ul> 
<p><strong>Unix</strong></p> 
<ul><li>FFS (fast fs)</li><li>UFS (unix fs)</li><li>JFS2</li></ul> 
<p><strong>网络文件系统</strong></p> 
<ul><li>NfS</li><li>CIFS</li></ul> 
<p><strong>集群文件系统</strong></p> 
<ul><li>GFS2</li><li>OCFS2 (oracle)</li></ul> 
<p><strong>分布式文件系统</strong></p> 
<ul><li>fastdfs</li><li>ceph</li><li>moosefs</li><li>mogilefs</li><li>glusterfs</li><li>Lustre</li></ul> 
<h5><a id="_294"></a>创建文件系统</h5> 
<p>创建文件系统的工具：</p> 
<ul><li> <p><code>mkfs 命令</code>：可以使用以下两种形式，<code>-L 'LABEL</code> 表示卷标</p> <pre><code class="prism language-bash">mkfs.FS_TYPE /dev/DEVICE    <span class="token comment"># FS_TYPE 表示文件系统，例如 ext2，ext3，ext4等</span>

<span class="token function">mkfs</span> <span class="token parameter variable">-t</span> FS_TYPE /dev/DEVICE <span class="token comment"># 另一种形式</span>
</code></pre> </li><li> <p><code>mke2fs 命令</code>：ext 系列文件系统专用工具</p> </li></ul> 
<p>以上命令的常用选项：</p> 
<pre><code class="prism language-bash"><span class="token parameter variable">-t</span> <span class="token punctuation">{<!-- --></span>ext2<span class="token operator">|</span>ext3<span class="token operator">|</span>ext4<span class="token punctuation">}</span> <span class="token comment"># 指定文件系统类型</span>
<span class="token parameter variable">-b</span> <span class="token punctuation">{<!-- --></span><span class="token number">1024</span><span class="token operator">|</span><span class="token number">2048</span><span class="token operator">|</span><span class="token number">4096</span><span class="token punctuation">}</span> <span class="token comment"># 指定块大小</span>
<span class="token parameter variable">-L</span> <span class="token string">'LABEL'</span>          <span class="token comment"># 设置卷标</span>
<span class="token parameter variable">-j</span>                  <span class="token comment"># 相当于 '-t ext3', 'mkfs.ext3'</span>
<span class="token parameter variable">-i</span> <span class="token comment">#                # 指定每多少个字节创建一个 inode，不应该小于 block 大小</span>
<span class="token parameter variable">-N</span> <span class="token comment">#                # 指定分区中创建多少个 inode</span>
<span class="token parameter variable">-l</span>                  <span class="token comment"># 一个 inode 记录占用磁盘空间的大小，'128~4096'</span>
<span class="token parameter variable">-m</span> <span class="token comment">#                # 默认 '5%'，为管理人员占用总空间的比例</span>
<span class="token parameter variable">-O</span> FEATURE<span class="token punctuation">[</span>,<span class="token punctuation">..</span>.<span class="token punctuation">]</span>    <span class="token comment"># 启用指定的特性</span>
<span class="token parameter variable">-O</span> ^FEATURE         <span class="token comment"># 关闭指定的特性</span>
    ``<span class="token variable"><span class="token variable">`</span>
对于 <span class="token variable">`</span></span>ext4<span class="token variable"><span class="token variable">`</span> 类型，想要查看块大小需要使用，可以在列出的数据中看到 <span class="token string">'block size:   4096'</span>

<span class="token variable">`</span></span>``bash
tune2fs <span class="token parameter variable">-l</span> /dev/sda1
</code></pre> 
<p>对于 <code>xfs</code> 类型，想要查看块大小需要使用，可以看到 ‘bsize=4096’</p> 
<pre><code class="prism language-bash">xfs-info
</code></pre> 
<pre><code class="prism language-bash"><span class="token function">df</span> /dev/xxx           <span class="token comment"># 用于查看文件系统占用的空间</span>
<span class="token function">du</span> <span class="token parameter variable">-s</span> /dev/xxx        <span class="token comment"># 用于查看文件所占用的空间大小</span>
</code></pre> 
<p>从以上可以看出，创建文件需要占用两种空间，一是 inode 元数据，另一个是文件本身实际占用的空间。如果创建的空文件，文件不占用实际空间，但是要占用 inode 空间。如果创建的文件大小比块大小，如比 4k小，也要占用这个最小空间。因此，一般需要对今后可能的文件有一个规划，如果都是小文件，比 4k 小，则指定更小的块大小。</p> 
<h5><a id="_340"></a>查看和管理分区信息</h5> 
<ol><li> <p><code>blkid</code> 可以查看块设备的属性信息</p> <pre><code class="prism language-bash">blkid <span class="token punctuation">[</span>option<span class="token punctuation">]</span><span class="token punctuation">..</span>.<span class="token punctuation">[</span>device<span class="token punctuation">]</span>
</code></pre> <p>常用选项：</p> 
  <ul><li>-U UUID # 根据指定的 UUID 来查看对应的设备</li><li>-L LABEL # 根据指定的 LABEL 来查看对应的设备</li></ul> </li><li> <p><code>e2label</code>: 管理 ext 系列文件系统的标签</p> <pre><code class="prism language-bash">e2label DEVICE <span class="token punctuation">[</span>LABEL<span class="token punctuation">]</span>
</code></pre> </li><li> <p><code>findfs</code>：查找分区</p> </li></ol> 
<pre><code class="prism language-bash">findfs <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token assign-left variable">LABEL</span><span class="token operator">=</span><span class="token operator">&lt;</span>label<span class="token operator">&gt;</span>
findfs <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token assign-left variable">UUID</span><span class="token operator">=</span><span class="token operator">&lt;</span>uuid<span class="token operator">&gt;</span>
</code></pre> 
<ol start="4"><li> <p>tune2fs: 重新设定 ext 系列文件系统可调整的参数值</p> <p>常用选项：</p> <pre><code class="prism language-bash"><span class="token parameter variable">-l</span>         <span class="token comment"># 查看指定文件系统超级块(super block)信息</span>
<span class="token parameter variable">-L</span> <span class="token string">'LABEL'</span> <span class="token comment"># 修改卷标</span>
<span class="token parameter variable">-m</span> <span class="token comment">#       # 修改预留给管理员的空间百分比</span>
<span class="token parameter variable">-j</span>         <span class="token comment"># 将 ext2 升级为 ext3</span>
<span class="token parameter variable">-O</span>         <span class="token comment"># 文件系统属性启用或禁用，例如，'-O ^has_journal'</span>
<span class="token parameter variable">-o</span>         <span class="token comment"># 调整文件系统的默认挂载选项，例如，'-o ^acl'</span>
<span class="token parameter variable">-U</span> UUID    <span class="token comment"># 修改 UUID 的值</span>
</code></pre> </li><li> <p><code>dumpe2fs</code>：显示 ext 文件系统信息，将磁盘块分组管理</p> <p>常用选项：</p> <p>-h # 查看超级块信息，不显示分组信息</p> </li><li> <p><code>xfs_ifo</code>：显示挂载或已挂载的 xfs 文件系统信息</p> <pre><code class="prism language-bash">xfs_ifo mountpoint <span class="token operator">|</span> devname
</code></pre> </li></ol> 
<p>在 CentOS 6 上默认创建文件系统时，有些特性没有指定，例如，acl 默认没有。</p> 
<h5><a id="_394"></a>文件系统检测和修复</h5> 
<p>文件系统故障常发生于死机或者非正常关机之后，文件系统被标记为 “no clean”。</p> 
<p><strong>注意：一定不要在挂载状态下执行以下命令进行修复。</strong></p> 
<ol><li> <p><code>fsck</code>：File System Check。注意文件类型要与实际的文件系统一致。</p> <pre><code class="prism language-bash">fsck.FS_TYPE
<span class="token function">fsck</span> <span class="token parameter variable">-t</span> FS_TYPE
</code></pre> <p>常用选项：</p> <pre><code class="prism language-bash"><span class="token parameter variable">-a</span>           <span class="token comment"># 自动修复</span>
<span class="token parameter variable">-r</span>           <span class="token comment"># 交互式修复错误</span>
</code></pre> </li><li> <p>e2fsck：ext 系列文件专用的检测修复工具</p> <pre><code class="prism language-bash"><span class="token parameter variable">-y</span>          <span class="token comment"># 自动回答为 yes</span>
<span class="token parameter variable">-f</span>          <span class="token comment"># 强制修复</span>
<span class="token parameter variable">-p</span>          <span class="token comment"># 自动进行安全的修复文件系统问题</span>
</code></pre> </li><li> <p>xfs_repair：xfs 文件系统专用的检测修复工具</p> <pre><code class="prism language-bash"><span class="token parameter variable">-f</span>          <span class="token comment"># 修复文件</span>
<span class="token parameter variable">-n</span>          <span class="token comment"># 只检查</span>
<span class="token parameter variable">-d</span>          <span class="token comment"># 允许修复只读的挂载设备，在单用户下修复 '/' 时使用，然后使用 reboot</span>
</code></pre> <p>单用户说明设备不会有其他人使用。并且根目录 <code>/</code> 不能取消挂载。</p> </li></ol> 
<h3><a id="_431"></a>挂载</h3> 
<p>分区创建文件系统后需要挂载才能访问。与 windows 不一样的是，Linux 只有一个根，因此需要挂载。</p> 
<p>挂载点(mountpoint)就是一个目录，但是如果该目录已有文件在其中，如果进行了挂载，挂载后这些文件就看不到了，只有在取消挂载后才会出现。</p> 
<p>同一个设备可以挂载在不同的目录，好像是一个房间有几个门一样，可以使用 <code>mount</code> 命令可见这两个挂载，在 <code>df, lsblk</code> 中不可见第二个挂载。</p> 
<p>如果一个挂载点挂载了两个设备，则这个挂载点只能访问第二个挂载的设备。虽然在 <code>mount</code> 命令中可以看到两次挂载。此时，如果把第二个挂载取消，这时第一个挂载就能起作用。</p> 
<h4><a id="mount__441"></a>mount 命令</h4> 
<pre><code class="prism language-bash"><span class="token function">mount</span> <span class="token punctuation">[</span>-fnrsvw<span class="token punctuation">]</span> <span class="token punctuation">[</span>-t vfstype<span class="token punctuation">]</span> <span class="token punctuation">[</span>-o options<span class="token punctuation">]</span> device mountpoint
</code></pre> 
<ol><li>device：指明要挂载的设备</li></ol> 
<ul><li>设备文件：例如，<code>/dev/sda5</code></li><li>卷标 ：<code>-L 'LABEL'</code></li><li>UUID ：<code>-U UUID</code></li><li>伪文件系统名称：<code>proc, sysfs, devtmpfs, configfs</code></li></ul> 
<ol><li> <p>mountpoint：挂载点即目录必须事先存在，建议使用空目录</p> </li><li> <p>mount 常用选项</p> </li></ol> 
<pre><code class="prism language-bash"><span class="token parameter variable">-t</span> vsftype      <span class="token comment"># 指定要挂载的设备上的文件系统类型</span>
<span class="token parameter variable">-r</span>              <span class="token comment"># readonly，只读</span>
<span class="token parameter variable">-w</span>              <span class="token comment"># read and write，可读写</span>
<span class="token parameter variable">-n</span>              <span class="token comment"># 不更新 '/etc/mtab'，使用 'mount' 查询时不可见</span>
<span class="token parameter variable">-a</span>              <span class="token comment"># 自动挂载所有支持自动挂载的设备（定义在 '/etc/fstab' 文件中，且指定了 'auto' 功能）</span>
<span class="token parameter variable">-L</span> <span class="token string">'LABEL'</span>      <span class="token comment"># 以指定的便签来挂载</span>
<span class="token parameter variable">-U</span> <span class="token string">'UUID'</span>       <span class="token comment"># 以 'UUID' 指定要挂载的设备</span>
-B, <span class="token parameter variable">--bind</span>      <span class="token comment"># 绑定目录到另一个目录上</span>

<span class="token parameter variable">-o</span> options      <span class="token comment"># 挂载文件系统指定的选项，多个选项之间使用逗号分隔</span>
    async         <span class="token comment"># 异步模式，即内存中的内容改变时，先写入缓存区，再写入磁盘中</span>
    <span class="token function">sync</span>          <span class="token comment"># 同步模式，即内存中的内容改变时，同时写入磁盘中</span>
    atime/noatime <span class="token comment"># 记录访问时间，对目录和文件都有效</span>
    diratime/nodiratime <span class="token comment"># 目录的访问时间戳</span>
    auto/noauto   <span class="token comment"># 是否支持开机自动挂载，是否支持 '-a' 选项</span>
    exec/noexec   <span class="token comment"># 是否支持在文件系统上运行应用程序</span>
    dev/nodev     <span class="token comment"># 是否支持在此文件系统上使用设备文件</span>
    suid/nosuid   <span class="token comment"># 是否支持 'suid' 和 'sgid' 选项设置</span>
    remount       <span class="token comment"># 支持重新挂载</span>
    ro            <span class="token comment"># readonly</span>
    rw            <span class="token comment"># 读写，默认启用</span>
    user/nouser   <span class="token comment"># 是否允许普通用户挂载此设备，'/etc/fstab' 使用</span>
    acl<span class="token operator">|</span>noacl     <span class="token comment"># 启用禁用 acl 功能</span>
    loop          <span class="token comment"># 启用 loop 设备</span>
    _netdev       <span class="token comment"># 当网络可用时才对网络资源进行挂载，例如，NFS 文件系统</span>
    defaults      <span class="token comment"># 相当于 'rw, suid, dev, exec, auto, nouser, async'</span>
</code></pre> 
<p>已经挂载的设备，如果想要修改某些特性，可以使用以下命令格式，不需要取消挂载后重新挂载：</p> 
<pre><code class="prism language-bash"><span class="token function">mount</span> <span class="token parameter variable">-o</span> remount, ro /mnt/device
</code></pre> 
<p>把一个目录挂载到另一个目录，使用：</p> 
<pre><code class="prism language-bash"><span class="token function">mkdir</span> /mnt/etc<span class="token punctuation">;</span> <span class="token function">mount</span> <span class="token parameter variable">--bind</span> /etc/ /mnt/etc
</code></pre> 
<p>这时，这两个目录之间并没有硬链接或软链接。</p> 
<p>loop 设备就是一个文件挂载上去</p> 
<pre><code class="prism language-bash"><span class="token comment"># 生成一个文件</span>
<span class="token punctuation">]</span><span class="token comment"># dd if=/dev/zero of=/data/loop.img bs=1M count=100</span>
<span class="token number">100</span>+0 records <span class="token keyword">in</span>
<span class="token number">100</span>+0 records out
<span class="token number">104857600</span> bytes <span class="token punctuation">(</span><span class="token number">105</span> MB, <span class="token number">100</span> MiB<span class="token punctuation">)</span> copied, <span class="token number">0.902876</span> s, <span class="token number">116</span> MB/s

<span class="token comment"># 创建文件系统</span>
<span class="token punctuation">]</span><span class="token comment"># mkfs.ext4 /data/disk.img</span>
<span class="token function">mke2fs</span> <span class="token number">1.45</span>.6 <span class="token punctuation">(</span><span class="token number">20</span>-Mar-2020<span class="token punctuation">)</span>
Discarding device blocks: <span class="token keyword">done</span>
Creating filesystem with <span class="token number">102400</span> 1k blocks and <span class="token number">25688</span> inodes
Filesystem UUID: <span class="token number">47468748</span>-15f8-4622-9992-f71b030b0142
Superblock backups stored on blocks:
	<span class="token number">8193</span>, <span class="token number">24577</span>, <span class="token number">40961</span>, <span class="token number">57345</span>, <span class="token number">73729</span>

Allocating group tables: <span class="token keyword">done</span>
Writing inode tables: <span class="token keyword">done</span>
Creating journal <span class="token punctuation">(</span><span class="token number">4096</span> blocks<span class="token punctuation">)</span>: <span class="token keyword">done</span>
Writing superblocks and filesystem accounting information: <span class="token keyword">done</span>
<span class="token comment"># 查看</span>
<span class="token punctuation">]</span><span class="token comment"># blkid /data/loop.img</span>
/data/loop.img: <span class="token assign-left variable">UUID</span><span class="token operator">=</span><span class="token string">"47468748-15f8-4622-9992-f71b030b0142"</span> <span class="token assign-left variable">BLOCK_SIZE</span><span class="token operator">=</span><span class="token string">"1024"</span> <span class="token assign-left variable">TYPE</span><span class="token operator">=</span><span class="token string">"ext4"</span>

<span class="token comment"># 挂载此文件</span>
<span class="token punctuation">]</span><span class="token comment"># mkdir /mnt/loop</span>
<span class="token punctuation">]</span><span class="token comment"># mount /data/disk.img /mnt/loop</span>

<span class="token comment"># 查看到以下 /dev/loop0 是新增的</span>
<span class="token comment"># 其过程是新给文件分配一个文件名 /dev/loop0，然后再挂载</span>
<span class="token punctuation">]</span><span class="token comment"># ll /dev/loop*</span>
brw-rw----. <span class="token number">1</span> root disk  <span class="token number">7</span>,   <span class="token number">0</span> Dec  <span class="token number">7</span> <span class="token number">13</span>:57 /dev/loop0
crw-rw----. <span class="token number">1</span> root disk <span class="token number">10</span>, <span class="token number">237</span> Dec  <span class="token number">7</span> <span class="token number">13</span>:57 /dev/loop-control

<span class="token punctuation">]</span><span class="token comment"># df</span>
Filesystem     1K-blocks    Used Available Use% Mounted on
devtmpfs          <span class="token number">980940</span>       <span class="token number">0</span>    <span class="token number">980940</span>   <span class="token number">0</span>% /dev
tmpfs             <span class="token number">998404</span>       <span class="token number">0</span>    <span class="token number">998404</span>   <span class="token number">0</span>% /dev/shm
tmpfs             <span class="token number">998404</span>    <span class="token number">8900</span>    <span class="token number">989504</span>   <span class="token number">1</span>% /run
tmpfs             <span class="token number">998404</span>       <span class="token number">0</span>    <span class="token number">998404</span>   <span class="token number">0</span>% /sys/fs/cgroup
/dev/sda2      <span class="token number">102687672</span> <span class="token number">2103336</span>  <span class="token number">95325072</span>   <span class="token number">3</span>% /
/dev/sda1         <span class="token number">588352</span>  <span class="token number">141492</span>    <span class="token number">403852</span>  <span class="token number">26</span>% /boot
/dev/sda3       <span class="token number">51343840</span>   <span class="token number">57752</span>  <span class="token number">48648264</span>   <span class="token number">1</span>% /data
tmpfs             <span class="token number">199680</span>       <span class="token number">0</span>    <span class="token number">199680</span>   <span class="token number">0</span>% /run/user/0
/dev/loop0         <span class="token number">95054</span>    <span class="token number">1550</span>     <span class="token number">86336</span>   <span class="token number">2</span>% /mnt/loop

<span class="token comment"># 可以看到具体信息</span>
<span class="token punctuation">]</span><span class="token comment"># losetup -l</span>
NAME       SIZELIMIT OFFSET AUTOCLEAR RO BACK-FILE      DIO LOG-SEC
/dev/loop0         <span class="token number">0</span>      <span class="token number">0</span>         <span class="token number">1</span>  <span class="token number">0</span> /data/loop.img   <span class="token number">0</span>     <span class="token number">512</span>

<span class="token comment"># 如果我们在这个分区中，复制或创建文件，然后可以把 '/data/loop.img'</span>
<span class="token comment"># 拷贝到其它电脑，并挂载就可以访问这些文件了。</span>
</code></pre> 
<p>在 CentOS 6 中只有 8 个 loop 设备可挂载。CentOS 7 以后，则没有限制，实时生成，编号自增。</p> 
<h4><a id="umount__560"></a>umount 命令</h4> 
<p>取消挂载时，可使用设备，也可以使用挂载点。注意，如果在对应的设备内部，这时不能取消挂载该设备，需要离开后才能操作。如果自己不在里面，也显示 ‘target is busy’，说明有其它用户在使用。</p> 
<pre><code class="prism language-bash"><span class="token function">umount</span> device<span class="token operator">|</span>mountpoint
</code></pre> 
<h4><a id="_568"></a>查看挂载情况</h4> 
<p>挂载后就可以使用以下命令进行查看</p> 
<pre><code class="prism language-bash"><span class="token comment"># 查看 '/etc/mtab' 文件显示当前已挂载的所有设备</span>
<span class="token function">mount</span>

<span class="token comment"># 查看内核追踪到的已挂载的所有设备</span>
<span class="token function">cat</span> /proc/mounts

<span class="token comment"># 查看文件系统的情况</span>
<span class="token function">df</span> <span class="token parameter variable">-T</span>
</code></pre> 
<p>查看目录是否为挂载点</p> 
<pre><code class="prism language-bash">findmnt mountpoint<span class="token operator">|</span>device
<span class="token builtin class-name">echo</span> <span class="token variable">$?</span>
</code></pre> 
<p>查看正在访问指定文件系统的进程</p> 
<pre><code class="prism language-bash"><span class="token function">lsof</span> mountpoint
<span class="token function">fuser</span> <span class="token parameter variable">-v</span> mountpoint
</code></pre> 
<p>终止所有正在访问指定文件系统的进程</p> 
<pre><code class="prism language-bash"><span class="token function">fuser</span> <span class="token parameter variable">-km</span> mountpoint
</code></pre> 
<h4><a id="_603"></a>持久挂载</h4> 
<p>将需要在开机时进行挂载的配置到 <code>/etc/fstab</code>中，该文件的帮助，可以查询：</p> 
<pre><code class="prism language-bash"><span class="token function">man</span> <span class="token number">5</span> fstab
</code></pre> 
<p>文件中每一行都定义一个要挂载的文件系统，其中包括 6 项内容。</p> 
<ol><li> <p>挂载的设备或伪文件系统</p> <p>设备文件可以使用，便签 <code>LABEL=""</code>，UUID <code>UUID=""</code><br> 伪文件系统名称：<code>proc, sysfs</code></p> </li><li> <p>挂载点：必须事先存在的目录</p> </li><li> <p>文件系统类型：<code>ext4, xfs, iso9660, nfs, none</code></p> </li><li> <p>挂载选项：<code>defaults, acl, bind</code></p> </li><li> <p>转储频率：<code>0</code> 表示不做备份， <code>1</code> 表示每天转储， <code>2</code> 表示隔天转储</p> </li><li> <p>该选项用于 <code>fsck</code> 检查文件系统健康时的顺序：<code>0</code> 表示不自检，<code>1</code> 表示首先自检，一般只有在 ‘rootfs’ 采用， <code>2</code>表示非 ‘rootfs’ 使用</p> </li></ol> 
<p>如果对该文件进行了修改，可以先进行以下命令，一方面使修改起效，也可以检查一下是否有错误。</p> 
<pre><code class="prism language-bash"><span class="token function">mount</span> <span class="token parameter variable">-a</span>
</code></pre> 
<p>这个命令对于已经挂载的分区不起作用，这时可以先进行取消挂载，然后再执行该命令。</p> 
<p>如果无法取消挂载，例如，根目录，可以使用以下选项：</p> 
<pre><code class="prism language-bash"><span class="token function">mount</span> <span class="token parameter variable">-o</span> remount /path/to/mountpoint
</code></pre> 
<p>可以使用以下命令生成新的 <code>UUID</code>：</p> 
<pre><code class="prism language-bash">uuidgen
</code></pre> 
<p>在取消挂载后，可以使用新的 <code>UUID</code> 号。</p> 
<pre><code class="prism language-bash">tune2fs <span class="token parameter variable">-U</span> <span class="token string">"<span class="token variable"><span class="token variable">`</span>uuidgen<span class="token variable">`</span></span>"</span>
</code></pre> 
<p>在 CentOS 7 及以上，这时由于分区的 <code>UUID</code> 进行了修改，而在 <code>fstab</code> 文件中数据没有修改，此时如果重启系统，就会出现一些警告信息。这时可以输入 root 密码进入系统，可以先对文件的相应行进行注释(这时的挂载时可读写的)。然后重启后进行修改。</p> 
<p>在 CentOS 6 中，如果由于 <code>fstab</code> 配置有误，就会造成除了根目录以外的其它目录都不能正常挂载。进入系统后，通过 <code>cat /proc/mounts</code> 才能显示出根目录的挂载选项时只读，因此不能对文件进行修改。此时需要 <code>mount -o remount, rw /</code>，然后才能修改文件，把该分区配置行的最后项设置为 <code>0</code>，或者注释该行，这时重启时就不会开机检查，可以正常开机，但是不能正常挂载此分区。</p> 
<p>可以通过以下命令找出当前的分区 UUID。</p> 
<pre><code class="prism language-bash">blkid
</code></pre> 
<p>注意：对于 <code>loop</code> 设备的挂载的配置，不能使用 <code>UUID</code> 来指明文件，因为文件太多，系统开机时不会去扫描非设备文件。这时只能使用完整路径来指定对应的文件。而分区内记录着该分区的 <code>UUID</code>。</p> 
<pre><code class="prism language-bash"><span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/zero <span class="token assign-left variable">of</span><span class="token operator">=</span>/data/disk.img <span class="token assign-left variable">bs</span><span class="token operator">=</span>1M <span class="token assign-left variable">count</span><span class="token operator">=</span><span class="token number">100</span>
<span class="token function">mkfs</span> <span class="token parameter variable">-t</span> xfs /data/disk.img
<span class="token function">mount</span> /data/disk.img /mnt/disk
</code></pre> 
<p>但是在 CentOS 6 中需要指明选项才能挂载这种 <code>loop</code> 文件。</p> 
<pre><code class="prism language-bash"><span class="token function">mount</span> <span class="token parameter variable">-o</span> loop /data/disk.img /mnt/disk
</code></pre> 
<p>因此，在CentOS 6 中的 <code>fstab</code> 配置文件中需要指明选项 <code>loop</code>。</p> 
<p>在挂载普通目录时，配置文件中的文件系统类型需要指定为 <code>none</code>，选项指定为 <code>bind</code>。</p> 
<p>示例：对于 <code>loop</code> 设备和目录挂载的配置写法。</p> 
<pre><code class="prism language-bash">/disk.img     /data/disk    xfs   defaults       <span class="token number">0</span> <span class="token number">0</span>
/etc          /mnt/etc      none  <span class="token builtin class-name">bind</span>           <span class="token number">0</span> <span class="token number">0</span>

<span class="token comment"># CentOS 6</span>

/disk.img     /data/disk    xfs   defaults,loop  <span class="token number">0</span> <span class="token number">0</span>
</code></pre> 
<h4><a id="_694"></a>处理交换文件和分区</h4> 
<p><code>swap</code> 交换分区是系统 <code>RAM</code> 的补充，<code>swap</code> 分区支持虚拟内存。</p> 
<p>注意：为了优化性能，可以将 <code>swap</code> 分布存放，或者使用高性能磁盘。</p> 
<p>使用以下命令可以查看内存的使用情况，包含 <code>swap</code> 的情况。</p> 
<pre><code class="prism language-bash"><span class="token comment"># CentOS 6</span>
<span class="token function">free</span> <span class="token parameter variable">-h</span>
            total          used        <span class="token function">free</span>        shared       buffers     cached
Mem:         979M          279M        699M          244K           18M       161M
-/+ buffers/cache:          99M        879M
Swap:        <span class="token number">2</span>.0G            0B        <span class="token number">2</span>.0G
</code></pre> 
<p>其中 ‘shared’ 表示共享，‘buffers’ 表示缓冲区，‘cached’ 表示缓存区。缓冲区是内存的一部分，这些空间用于缓冲输入和输出的数据。缓存区主要目的是把一些数据暂时保存起来，以便更快地读取。缓冲区就好像是生活中的各种排队，缓存区就好像是一些经常使用的资料放在手边，便于使用。真正占用的空间只有 ‘99M’。</p> 
<pre><code class="prism language-bash"><span class="token comment"># CentOS 7, 8</span>
<span class="token function">free</span>
                total         used      <span class="token function">free</span>   shared     buff/cache    Available
Mem:           <span class="token number">995748</span>       <span class="token number">124392</span>    <span class="token number">727892</span>     <span class="token number">7776</span>         <span class="token number">143464</span>       <span class="token number">724352</span>
Swap:         <span class="token number">2097148</span>            <span class="token number">0</span>   <span class="token number">2097148</span>
</code></pre> 
<h5><a id="_swap__721"></a>官方推荐的系统 swap 空间大小：</h5> 
<table><thead><tr><th>RAM大小</th><th>推荐 swap 空间</th><th>允许休眠 swap 空间</th></tr></thead><tbody><tr><td>&lt; 2GB</td><td>2倍RAM</td><td>3倍RAM</td></tr><tr><td>2 ~ 8GB</td><td>1倍RAM</td><td>2倍RAM</td></tr><tr><td>8 ~ 64GB</td><td>4GB~0.5倍RAM</td><td>1.5倍RAM</td></tr><tr><td>&gt; 64GB</td><td>独立负载(至少4GB)</td><td>不建议开启休眠</td></tr></tbody></table> 
<h5><a id="_730"></a>交换分区实现原理</h5> 
<ol><li>创建交换分区或者文件</li><li>使用 <code>mkswap</code> 写入特殊的签名</li><li>在 <code>/etc/fstab</code> 文件中添加适当的配置</li><li>使用 <code>swap -</code> 激活交换空间</li></ol> 
<p>启用 <code>swap</code> 分区：</p> 
<pre><code class="prism language-bash"><span class="token function">swapon</span> <span class="token punctuation">[</span>option<span class="token punctuation">]</span><span class="token punctuation">..</span>. <span class="token punctuation">[</span>device<span class="token punctuation">]</span>
</code></pre> 
<p>选项：</p> 
<pre><code class="prism language-bash"><span class="token parameter variable">-a</span>           <span class="token comment"># 激活所有的交换分区</span>
<span class="token parameter variable">-s</span>           <span class="token comment"># 查看当前交换分区的情况</span>
<span class="token parameter variable">-p</span> PRIORITy  <span class="token comment"># 指定优先级，也可以在 '/etc/fstab' 中的第 4 列指定 'pri=value'</span>
</code></pre> 
<p>禁用 swap 分区：</p> 
<pre><code class="prism language-bash">swapoff <span class="token punctuation">[</span>option<span class="token punctuation">]</span><span class="token punctuation">..</span>. <span class="token punctuation">[</span>device<span class="token punctuation">]</span>
</code></pre> 
<p>可以使用以下命令查看交换分区的情况：</p> 
<pre><code class="prism language-bash">lsblk <span class="token parameter variable">-f</span>
</code></pre> 
<p>如果想要增加交换分区空间，可以使用 <code>fdisk /dev/sdc</code> 创建新的分区，调整分区类型为 82，并使用 <code>mkswap</code> 创建对应的分区的文件系统，加入其中即可 <code>swapon -a</code>。想要永久有效，需要在 <code>fstab</code> 中新增一条记录。</p> 
<p>类似于：</p> 
<pre><code class="prism language-bash"><span class="token function">vim</span> /etc/fstab
<span class="token comment"># 修改对应的记录</span>
<span class="token assign-left variable">UUID</span><span class="token operator">=</span><span class="token number">3929929</span>-cd<span class="token punctuation">..</span>.  swap     swap  defaults   <span class="token number">0</span>  <span class="token number">0</span>

<span class="token comment"># 并入新增的交换分区</span>
<span class="token function">swapon</span> <span class="token parameter variable">-a</span>
</code></pre> 
<p>查看交换分区的情况</p> 
<pre><code class="prism language-bash"><span class="token function">swapon</span> <span class="token parameter variable">-s</span>
<span class="token comment"># 等价于</span>
<span class="token function">cat</span> /proc/swaps
</code></pre> 
<p>如果使用的机械硬盘，最好使用新的硬盘的第一个分区，其速度要快点。当然，最好使用固态硬盘。</p> 
<p>也可以使用文件当成交换分区</p> 
<pre><code class="prism language-bash"><span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/zero <span class="token assign-left variable">of</span><span class="token operator">=</span>/data/swap.img <span class="token assign-left variable">bs</span><span class="token operator">=</span>1G <span class="token assign-left variable">count</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token function">chmod</span> <span class="token number">600</span> /data/swap.img
<span class="token function">mkswap</span> /data/swap.img
<span class="token function">swapon</span> <span class="token parameter variable">-a</span>
</code></pre> 
<p>当然，也可以在 <code>/etc/fstab</code> 进行配置，但是第一项需要使用完整文件名。</p> 
<p>使用这种文件当成分区，由于访问时需要进过文件所在的分区，效率比直接使用交换分区慢。</p> 
<h5><a id="swap__796"></a>swap 优先级</h5> 
<p><code>swap</code> 的优先级取值范围为：0 ~ 32767，值越大优先级越高。</p> 
<p>如果用户没有指定优先级，则核心自动给 swap 指定一个优先级，其值从 <code>-1</code> 开始，每增加一个自动分配的优先级的交换分区，其优先级减去 <code>1</code>。</p> 
<p>想要修改已经设置好的优先级，可以修改配置文件，在选项位置进行配置：</p> 
<p>类似于：</p> 
<pre><code class="prism language-bash"><span class="token function">vim</span> /etc/fstab
<span class="token comment"># 修改对应的记录</span>
/dev/sdc1      swap        swap     <span class="token assign-left variable">pri</span><span class="token operator">=</span><span class="token number">10</span>   <span class="token number">0</span> <span class="token number">0</span>

<span class="token comment"># 禁用对应的分区</span>
swapoff /dev/sdc1

<span class="token comment"># 激活所有交换分区</span>
<span class="token function">swapon</span> <span class="token parameter variable">-a</span>
<span class="token comment"># 查看</span>
<span class="token function">swapon</span> <span class="token parameter variable">-s</span>
</code></pre> 
<h5><a id="swap__819"></a>swap 的使用策略</h5> 
<p><code>/proc/sys/swappiness</code> 的值决定了内存被使用了一定的百分比例时，就会启用 swap 分区。</p> 
<p>这个值在不同的版本中可能不一样，在 CentOS 8 中：</p> 
<pre><code class="prism language-bash"><span class="token punctuation">]</span><span class="token comment"># cat /proc/sys/swappiness</span>
<span class="token number">30</span>
</code></pre> 
<p>这个值含义是：使用内存达到 100-30=70% 时候，就开始使用交换分区。如果设置为 0，则会最大限度不使用交换分区，必要时还是要使用的。</p> 
<p>修改的方法是：</p> 
<pre><code class="prism language-bash"><span class="token punctuation">]</span><span class="token comment"># echo 0 &gt; /proc/sys/swappiness</span>
<span class="token number">0</span>
</code></pre> 
<p>一般来说，实际工作中虚拟机上的服务器不使用交换分区。</p> 
<h4><a id="_841"></a>移动介质</h4> 
<p>所有的移动设备都需要经过挂载后才能使用，挂载点通常在 <code>/media</code> 或 <code> /mnt</code> 下，访问前必须要挂载，取出前，必须要卸载。</p> 
<p>按照默认的设置，普通用户只能挂载的设备有：光盘、DVD、软盘、USB等。</p> 
<h5><a id="_847"></a>使用光盘</h5> 
<p>在图形环境中，自动启动挂载于 <code>/run/media/&lt;user&gt;/&lt;label&gt;</code>。</p> 
<p>如果系统中已经安装了 <code>autofs</code> 包，并启用该服务，而光盘已经连接，则访问 <code>/misc/cd</code> 时，会自动挂载光盘，不访问时不挂载。</p> 
<p>手工挂载使用以下命令，不同版本的光盘表示不一样，而 <code>/dev/cdrom</code> 是一个软连接：</p> 
<pre><code class="prism language-bash"><span class="token function">mount</span> <span class="token parameter variable">-r</span> /dev/cdrom /mnt
</code></pre> 
<p>操作光盘：</p> 
<pre><code class="prism language-bash"><span class="token function">eject</span>       <span class="token comment"># 弹出光盘</span>
<span class="token function">eject</span> <span class="token parameter variable">-t</span>    <span class="token comment"># 吸入光盘</span>

<span class="token comment"># 下载的iso镜像，可以挂载后使用</span>
<span class="token function">mount</span> <span class="token parameter variable">-r</span> xxx.iso /mnt        <span class="token comment"># 如果 CentOS 6 需要加 选项 -o loop</span>
</code></pre> 
<p>创建 ISO 文件：</p> 
<pre><code class="prism language-bash"><span class="token function">cp</span> /dev/cdrom /data/CentOS8.iso
<span class="token comment"># 也可以</span>
<span class="token function">mkisofs</span> <span class="token parameter variable">-r</span> <span class="token parameter variable">-o</span> /data/etc.iso /etc
</code></pre> 
<p>刻录光盘：</p> 
<pre><code class="prism language-bash">wodim <span class="token parameter variable">-v</span> <span class="token parameter variable">-eject</span> CentOS8.iso
</code></pre> 
<h5><a id="USB__883"></a>USB 介质</h5> 
<p>查看 USB 设备是否识别，可能需要安装 <code>usbutils</code>：</p> 
<pre><code class="prism language-bash">lsusb
</code></pre> 
<p>内核自动探测 SCSI 设备，一般指定成 <code>/dev/sda#, /dev/sdb#</code> 或类似的设备文件。在图形环境中自动挂载于 <code>/run/media/&lt;user&gt;/&lt;label&gt;</code>。</p> 
<p>手动挂载：</p> 
<pre><code class="prism language-bash"><span class="token function">mount</span> /dev/sdx<span class="token comment"># /mnt</span>
</code></pre> 
<p>如果在 windows 中的虚拟机上的 Linux 设别插入的优盘，可能需要在虚拟机右下角右键点击相应的图标。但是默认 Linux 不能设别 ‘NTFS’ 格式，如果想要通用，可以把优盘格式化为 ‘vfat’，可能需要安装 ‘dosfstools’ 包。</p> 
<p>如果想要取出优盘，可以使用以下命令，确保数据都写入：</p> 
<pre><code class="prism language-bash">dnf <span class="token parameter variable">-y</span> <span class="token function">install</span> dosfstools
mkfs.vfat /dev/sdd1
<span class="token function">mount</span> /dev/sdd1 /mnt

<span class="token comment"># 取出前确保缓存数据写入</span>
<span class="token function">sync</span>
<span class="token function">sync</span>
<span class="token function">umount</span> /mnt
</code></pre> 
<p>硬件使用会留下日志：</p> 
<pre><code class="prism language-bash"><span class="token function">tail</span> <span class="token parameter variable">-f</span> /var/log/messages

<span class="token function">dmesg</span>
</code></pre> 
<h4><a id="_922"></a>磁盘常见工具</h4> 
<h5><a id="_df_924"></a>文件系统空间占用信息的查看工具 <code>df</code></h5> 
<pre><code class="prism language-bash"><span class="token function">df</span> <span class="token punctuation">[</span>option<span class="token punctuation">]</span><span class="token punctuation">..</span>. <span class="token punctuation">[</span>FILE<span class="token punctuation">]</span><span class="token punctuation">..</span>.
</code></pre> 
<p>常见选项：</p> 
<pre><code class="prism language-bash"><span class="token parameter variable">-H</span>      <span class="token comment"># 以 10 为单位</span>
<span class="token parameter variable">-T</span>      <span class="token comment"># 文件系统类型</span>
<span class="token parameter variable">-h</span>      <span class="token comment"># 更友好的大小</span>
<span class="token parameter variable">-i</span>      <span class="token comment"># 显示 inode 信息</span>
<span class="token parameter variable">-p</span>      <span class="token comment"># 以 posix 兼容的格式输出，显示更整齐，特别是有些行比较长时</span>
</code></pre> 
<p>也可以使用</p> 
<pre><code class="prism language-bash">lsblk <span class="token parameter variable">-f</span>
</code></pre> 
<h5><a id="_du_946"></a>查看目录占用空间信息 <code>du</code></h5> 
<pre><code class="prism language-bash"><span class="token function">du</span> <span class="token punctuation">[</span>option<span class="token punctuation">]</span><span class="token punctuation">..</span>. DIR
</code></pre> 
<p>常用选项：</p> 
<pre><code class="prism language-bash"><span class="token parameter variable">-h</span>              <span class="token comment"># 更友好的大小单位</span>
<span class="token parameter variable">-s</span>              <span class="token comment"># 统计值 summary</span>
--max-depth<span class="token operator">=</span>N   <span class="token comment"># 指定最大目录层级N</span>
</code></pre> 
<h5><a id="_dd_960"></a>工具 <code>dd</code></h5> 
<p>格式：</p> 
<pre><code class="prism language-bash"><span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/path/to/SRC <span class="token assign-left variable">of</span><span class="token operator">=</span>/path/to/DEST <span class="token assign-left variable">bs</span><span class="token operator">=</span>N1 <span class="token assign-left variable">count</span><span class="token operator">=</span>N2
</code></pre> 
<p>常用选项：</p> 
<pre><code class="prism language-bash"><span class="token assign-left variable">if</span><span class="token operator">=</span>file         <span class="token comment"># 从 'file' 中读取</span>
<span class="token assign-left variable">of</span><span class="token operator">=</span>file         <span class="token comment"># 数据写到指定的文件中</span>
<span class="token assign-left variable">ibs</span><span class="token operator">=</span>size        <span class="token comment"># 一次性读入 'size' 大小字节</span>
<span class="token assign-left variable">obs</span><span class="token operator">=</span>size        <span class="token comment"># 一次写入 'size' 大小字节</span>
<span class="token assign-left variable">bs</span><span class="token operator">=</span>size         <span class="token comment"># 指定块大小</span>
<span class="token assign-left variable">cbs</span><span class="token operator">=</span>size        <span class="token comment"># 一次转化 'size' 大小字节</span>
<span class="token assign-left variable">skip</span><span class="token operator">=</span>blocks     <span class="token comment"># 源文件中跳过指定额块大小</span>
<span class="token assign-left variable">seek</span><span class="token operator">=</span>blocks     <span class="token comment"># 目标文件中搜索跳过的指定位置</span>
<span class="token assign-left variable">count</span><span class="token operator">=</span>Number    <span class="token comment"># 复制 'Number' 个 'bs'</span>
<span class="token assign-left variable">conv</span><span class="token operator">=</span>conversion<span class="token punctuation">[</span>, conversion<span class="token punctuation">..</span>.<span class="token punctuation">]</span>    <span class="token comment"># 使用指定的参数转换文件</span>

conversion 转换参数：
ascii     转换 EBCDIC 为 ASCII
ebcdic    转换 ASCII 至 EBCDIC
lcase     转换为小写字符
ucase     转换为大写字符
nocreat   不创建输出文件
noerror   出错时不停止
notrunc   不截断输出文件
<span class="token function">sync</span>      把每个输入块填充到 ibs 字节中，不足部分使用空<span class="token punctuation">(</span>NUL<span class="token punctuation">)</span>字符补齐
fdatasync 在写完成前，物理写入输出文件
</code></pre> 
<p>示例：</p> 
<ul><li> <p>备份 sdx 整盘备份到 sdy：</p> <pre><code class="prism language-bash"><span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/sdx <span class="token assign-left variable">of</span><span class="token operator">=</span>/dev/sdy
</code></pre> </li><li> <p>将 sdx 整盘数据备份到指定的文件中：</p> <pre><code class="prism language-bash"><span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/sdx <span class="token assign-left variable">of</span><span class="token operator">=</span>/path/to/image
</code></pre> </li><li> <p>备份并压缩全盘数据</p> <pre><code class="prism language-bash"><span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/sdx <span class="token operator">|</span> <span class="token function">gzip</span> <span class="token operator">&gt;</span> /path/to/image.gz
</code></pre> </li><li> <p>将备份文件恢复到指定磁盘</p> <pre><code class="prism language-bash"><span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/path/to/image <span class="token assign-left variable">of</span><span class="token operator">=</span>/dev/sdx

<span class="token function">gzip</span> <span class="token parameter variable">-dc</span> /path/to/image.gz <span class="token operator">|</span> <span class="token function">dd</span> <span class="token assign-left variable">of</span><span class="token operator">=</span>/dev/sdx
</code></pre> </li><li> <p>拷贝光盘数据至指定的目录下，并保存为 <code>cdrom.iso</code> 文件</p> <pre><code class="prism language-bash"><span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/cdrom <span class="token assign-left variable">of</span><span class="token operator">=</span>/root/cdrom.iso
</code></pre> </li><li> <p>销毁磁盘数据</p> <pre><code class="prism language-bash"><span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/urandom <span class="token assign-left variable">of</span><span class="token operator">=</span>/dev/sda1
<span class="token comment"># 或者</span>
<span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/zero <span class="token assign-left variable">of</span><span class="token operator">=</span>/dev/sda1
</code></pre> </li><li> <p>通过比较执行时间，确定系统最佳的 <code>block size</code> 大小</p> <pre><code class="prism language-bash"><span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/zero <span class="token assign-left variable">of</span><span class="token operator">=</span>/root/1GB.file <span class="token assign-left variable">bs</span><span class="token operator">=</span><span class="token number">1024</span> <span class="token assign-left variable">count</span><span class="token operator">=</span><span class="token number">1000000</span>
<span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/zero <span class="token assign-left variable">of</span><span class="token operator">=</span>/root/1GB.file <span class="token assign-left variable">bs</span><span class="token operator">=</span><span class="token number">2048</span> <span class="token assign-left variable">count</span><span class="token operator">=</span><span class="token number">500000</span>
<span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/zero <span class="token assign-left variable">of</span><span class="token operator">=</span>/root/1GB.file <span class="token assign-left variable">bs</span><span class="token operator">=</span><span class="token number">4096</span> <span class="token assign-left variable">count</span><span class="token operator">=</span><span class="token number">250000</span>
</code></pre> </li><li> <p>测试硬盘写速度</p> <pre><code class="prism language-bash"><span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/zero <span class="token assign-left variable">of</span><span class="token operator">=</span>/root/1GB.file <span class="token assign-left variable">bs</span><span class="token operator">=</span><span class="token number">1024</span> <span class="token assign-left variable">count</span><span class="token operator">=</span><span class="token number">1000000</span>
</code></pre> </li><li> <p>测试硬盘度速度</p> <pre><code class="prism language-bash"><span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/root/1GB.file <span class="token assign-left variable">bs</span><span class="token operator">=</span>64k <span class="token operator">|</span> <span class="token function">dd</span> <span class="token assign-left variable">of</span><span class="token operator">=</span>/dev/null
</code></pre> </li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/73c176029cd2c1f9cbd13162f867839d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">CMT: Convolutional Neural Networks Meet Vision Transformers,CIFAR100数据集复现</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/dca88f8a3c9d384c6c896915d3985f88/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">c&#43;&#43;程序从1加到10（详细讲解版）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>