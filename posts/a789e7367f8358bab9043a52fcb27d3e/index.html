<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>lucene和Elasticsearch - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="lucene和Elasticsearch" />
<meta property="og:description" content="lucene和Elasticsearch 一.全文检索1.什么是全文检索1.1 数据分类1.2 什么是全文检索 二.lucene2.1 如何使用lucene2.2 索引和搜索流程图2.3 使用2.3.1 LuceneDemo2.3.2 分词器 三.Elasticsearch3.1 Elasticsearch3.1.1 安装3.1.2 修改配置文件3.1.3 访问 3.2 Kibana3.2.1 什么是Kibana3.2.2 安装3.2.3 配置运行 3.2 使用kibana对索引库操作3.3 操作索引库3.4 使用kibana对类型及映射操作3.4.1 创建字段映射3.4.2 映射属性详解1）type2）index3）store4）boost 3.5 使用kibana对文档操作3.5.1 新增文档3.5.2 常用命令3.5.3 自定义模板 3.6 查询3.6.1 词条匹配(term)3.6.2 匹配查询（match）3.6.3 查询所有（match_all)3.6.4 模糊查询(fuzzy)3.6.5 范围查询(range)3.6.6 布尔组合（bool) 3.7 分页，过滤，排序，高亮3.7.1 分页3.7.2 排序3.7.3 过滤结果过滤 - 指定includes和excludes过滤(filter) 3.7.4 高亮 3.8 聚合aggregations3.8.1 桶（bucket ) 类似于 group by3.8.2 度量（metrics）相当于聚合的结果 四.Elasticsearch集群4.1 数据分片和数据备份4.2 搭建集群4.3 测试集群中创建索引库 五.Elasticsearch客户端5.1索引数据操作5.1.1 初始化客户端5.1.2 新增文档5.1.3 修改文档5.14 删除文档5.1.5 查看文档5.1.6 批量新增 5.2 操作5.2.1 查询5." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/a789e7367f8358bab9043a52fcb27d3e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-04-07T17:56:00+08:00" />
<meta property="article:modified_time" content="2020-04-07T17:56:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">lucene和Elasticsearch</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>lucene和Elasticsearch</h4> 
 <ul><li><a href="#_1" rel="nofollow">一.全文检索</a></li><li><ul><li><a href="#1_2" rel="nofollow">1.什么是全文检索</a></li><li><ul><li><a href="#11___3" rel="nofollow">1.1 数据分类</a></li><li><a href="#12___6" rel="nofollow">1.2 什么是全文检索</a></li></ul> 
  </li></ul> 
  </li><li><a href="#lucene_8" rel="nofollow">二.lucene</a></li><li><ul><li><a href="#21_lucene_9" rel="nofollow">2.1 如何使用lucene</a></li><li><a href="#22___31" rel="nofollow">2.2 索引和搜索流程图</a></li><li><a href="#23___33" rel="nofollow">2.3 使用</a></li><li><ul><li><a href="#231_LuceneDemo_34" rel="nofollow">2.3.1 LuceneDemo</a></li><li><a href="#232__136" rel="nofollow">2.3.2 分词器</a></li></ul> 
  </li></ul> 
  </li><li><a href="#Elasticsearch_161" rel="nofollow">三.Elasticsearch</a></li><li><ul><li><a href="#31_Elasticsearch_163" rel="nofollow">3.1 Elasticsearch</a></li><li><ul><li><a href="#311__171" rel="nofollow">3.1.1 安装</a></li><li><a href="#312__173" rel="nofollow">3.1.2 修改配置文件</a></li><li><a href="#313__185" rel="nofollow">3.1.3 访问</a></li></ul> 
   </li><li><a href="#32_Kibana_191" rel="nofollow">3.2 Kibana</a></li><li><ul><li><a href="#321_Kibana_192" rel="nofollow">3.2.1 什么是Kibana</a></li><li><a href="#322__197" rel="nofollow">3.2.2 安装</a></li><li><a href="#323__200" rel="nofollow">3.2.3 配置运行</a></li></ul> 
   </li><li><a href="#32_kibana_211" rel="nofollow">3.2 使用kibana对索引库操作</a></li><li><a href="#33__224" rel="nofollow">3.3 操作索引库</a></li><li><a href="#34_kibana_232" rel="nofollow">3.4 使用kibana对类型及映射操作</a></li><li><ul><li><a href="#341__233" rel="nofollow">3.4.1 创建字段映射</a></li><li><a href="#342__306" rel="nofollow">3.4.2 映射属性详解</a></li><li><ul><li><a href="#1type_307" rel="nofollow">1）type</a></li><li><a href="#2index_330" rel="nofollow">2）index</a></li><li><a href="#3store_340" rel="nofollow">3）store</a></li><li><a href="#4boost_351" rel="nofollow">4）boost</a></li></ul> 
   </li></ul> 
   </li><li><a href="#35_kibana_354" rel="nofollow">3.5 使用kibana对文档操作</a></li><li><ul><li><a href="#351__355" rel="nofollow">3.5.1 新增文档</a></li><li><a href="#352__377" rel="nofollow">3.5.2 常用命令</a></li><li><a href="#353__385" rel="nofollow">3.5.3 自定义模板</a></li></ul> 
   </li><li><a href="#36__419" rel="nofollow">3.6 查询</a></li><li><ul><li><a href="#361__term_420" rel="nofollow">3.6.1 词条匹配(term)</a></li><li><a href="#362___match_432" rel="nofollow">3.6.2 匹配查询（match）</a></li><li><a href="#363_match_all_458" rel="nofollow">3.6.3 查询所有（match_all)</a></li><li><a href="#364___fuzzy_526" rel="nofollow">3.6.4 模糊查询(fuzzy)</a></li><li><a href="#365__range_577" rel="nofollow">3.6.5 范围查询(range)</a></li><li><a href="#366__bool_601" rel="nofollow">3.6.6 布尔组合（bool)</a></li></ul> 
   </li><li><a href="#37__628" rel="nofollow">3.7 分页，过滤，排序，高亮</a></li><li><ul><li><a href="#371___629" rel="nofollow">3.7.1 分页</a></li><li><a href="#372___652" rel="nofollow">3.7.2 排序</a></li><li><a href="#373___670" rel="nofollow">3.7.3 过滤</a></li><li><ul><li><a href="#__includesexcludes_671" rel="nofollow">结果过滤 - 指定includes和excludes</a></li><li><a href="#filter_749" rel="nofollow">过滤(filter)</a></li></ul> 
    </li><li><a href="#374___773" rel="nofollow">3.7.4 高亮</a></li></ul> 
   </li><li><a href="#38_aggregations_799" rel="nofollow">3.8 聚合aggregations</a></li><li><ul><li><a href="#381_bucket_______group_by_800" rel="nofollow">3.8.1 桶（bucket ) 类似于 group by</a></li><li><a href="#382_metrics_870" rel="nofollow">3.8.2 度量（metrics）相当于聚合的结果</a></li></ul> 
  </li></ul> 
  </li><li><a href="#Elasticsearch_899" rel="nofollow">四.Elasticsearch集群</a></li><li><ul><li><a href="#41__900" rel="nofollow">4.1 数据分片和数据备份</a></li><li><a href="#42__904" rel="nofollow">4.2 搭建集群</a></li><li><a href="#43__938" rel="nofollow">4.3 测试集群中创建索引库</a></li></ul> 
  </li><li><a href="#Elasticsearch_953" rel="nofollow">五.Elasticsearch客户端</a></li><li><ul><li><a href="#51_954" rel="nofollow">5.1索引数据操作</a></li><li><ul><li><a href="#511__955" rel="nofollow">5.1.1 初始化客户端</a></li><li><a href="#512__983" rel="nofollow">5.1.2 新增文档</a></li><li><a href="#513__1052" rel="nofollow">5.1.3 修改文档</a></li><li><a href="#514__1067" rel="nofollow">5.14 删除文档</a></li><li><a href="#515__1077" rel="nofollow">5.1.5 查看文档</a></li><li><a href="#516__1087" rel="nofollow">5.1.6 批量新增</a></li></ul> 
   </li><li><a href="#52__1110" rel="nofollow">5.2 操作</a></li><li><ul><li><a href="#521__1111" rel="nofollow">5.2.1 查询</a></li><li><a href="#521__1149" rel="nofollow">5.2.1 分页，排序</a></li><li><a href="#522__1190" rel="nofollow">5.2.2 高亮</a></li><li><a href="#523__1250" rel="nofollow">5.2.3 聚合</a></li><li><a href="#524__1279" rel="nofollow">5.2.4 过滤</a></li></ul> 
  </li></ul> 
  </li><li><a href="#SpringDataElasticsearch_1289" rel="nofollow">六.SpringDataElasticsearch</a></li><li><ul><li><a href="#61_SpringDataElasticsearch_1290" rel="nofollow">6.1 什么是SpringDataElasticsearch</a></li><li><a href="#62_SpringDataElasticsearch_1293" rel="nofollow">6.2 配置SpringDataElasticsearch</a></li><li><ul><li><a href="#621_pom_1294" rel="nofollow">6.2.1 pom</a></li><li><a href="#622_yml_1302" rel="nofollow">6.2.2 yml</a></li><li><a href="#623__1311" rel="nofollow">6.2.3 引导类</a></li></ul> 
   </li><li><a href="#63__1325" rel="nofollow">6.3 索引库操作</a></li><li><ul><li><a href="#631__1326" rel="nofollow">6.3.1 在实体类上映射</a></li><li><a href="#632__1362" rel="nofollow">6.3.2 创建索引库</a></li><li><a href="#632_mapping_1378" rel="nofollow">6.3.2 创建mapping</a></li></ul> 
   </li><li><a href="#64_CRUD_1388" rel="nofollow">6.4 索引数据CRUD</a></li><li><ul><li><a href="#641__1389" rel="nofollow">6.4.1 自定义接口</a></li><li><a href="#642__1404" rel="nofollow">6.4.2 数据的增删改</a></li><li><a href="#642__1432" rel="nofollow">6.4.2 查询数据</a></li><li><a href="#643__1496" rel="nofollow">6.4.3 原生查询</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>一.全文检索</h2> 
<h3><a id="1_2"></a>1.什么是全文检索</h3> 
<h4><a id="11___3"></a>1.1 数据分类</h4> 
<p>结构化数据：指具有固定格式或有限长度的数据，如数据库，元数据等。<br> 非结构化数据：指不定长或无固定格式的数据，如邮件，word 文档等磁盘上的文件。</p> 
<h4><a id="12___6"></a>1.2 什么是全文检索</h4> 
<p>这种先建立索引，再对索引进行搜索的过程就叫全文检索(Full-text Search) 。</p> 
<h2><a id="lucene_8"></a>二.lucene</h2> 
<h3><a id="21_lucene_9"></a>2.1 如何使用lucene</h3> 
<p>如何创建索引<br> 第一步：获取原始数据<br> 不同的场景原始数据是不一样的，获取的方式肯定也不一样<br> 搜索引擎：原始数据就是互联网上网页 获取方式就是爬虫程序 java本质 httpClient python<br> 京东商城：原始数据就是mysql的数据 获取方式就是sql语句 重点<br> 百度文库：原始数据就是word pdf excel TXT文件 获取方式就是使用io流<br> 第二步：构建Lucene中的Document对象<br> 把上面获取到原始数据都需要转成Lucene能识别的Document对象<br> 第三步：分词 Lucene中自带一个分词器<br> 举例：北京东进航空科技股份有限公司<br> companyName:北京 是索引库存储的最小单位 term<br> 第四步：保存索引和原始数据的关系<br> 使用的是倒排索引结构<br> 就是能根据一个关键字查询出对应的文档 ，举例：新华字典</p> 
<p><mark>如果在索引上查询</mark><br> 第一步：创建一个搜索接口 就是指输入关键字的位置<br> 第二步：创建查询<br> 第三步：执行查询<br> 第四步：渲染查询结果 （高亮显示）</p> 
<h3><a id="22___31"></a>2.2 索引和搜索流程图</h3> 
<p><img src="https://images2.imgbox.com/b9/29/aAAyjgFN_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="23___33"></a>2.3 使用</h3> 
<h4><a id="231_LuceneDemo_34"></a>2.3.1 LuceneDemo</h4> 
<pre><code class="prism language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>leyou<span class="token punctuation">.</span>lucene<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>leyou<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span>JobInfo<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>leyou<span class="token punctuation">.</span>service<span class="token punctuation">.</span>JobInfoServiceImpl<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>rowset<span class="token punctuation">.</span>JoinRowSetImpl<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>lucene<span class="token punctuation">.</span>analysis<span class="token punctuation">.</span>Analyzer<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>lucene<span class="token punctuation">.</span>analysis<span class="token punctuation">.</span>cjk<span class="token punctuation">.</span>CJKAnalyzer<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>lucene<span class="token punctuation">.</span>analysis<span class="token punctuation">.</span>standard<span class="token punctuation">.</span>StandardAnalyzer<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>lucene<span class="token punctuation">.</span>document<span class="token punctuation">.</span>*<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>lucene<span class="token punctuation">.</span>index<span class="token punctuation">.</span>*<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>lucene<span class="token punctuation">.</span>search<span class="token punctuation">.</span>IndexSearcher<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>lucene<span class="token punctuation">.</span>search<span class="token punctuation">.</span>ScoreDoc<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>lucene<span class="token punctuation">.</span>search<span class="token punctuation">.</span>TermQuery<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>lucene<span class="token punctuation">.</span>search<span class="token punctuation">.</span>TopDocs<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>lucene<span class="token punctuation">.</span>store<span class="token punctuation">.</span>Directory<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>lucene<span class="token punctuation">.</span>store<span class="token punctuation">.</span>FSDirectory<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>lucene<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Version<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>Test<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runner<span class="token punctuation">.</span>RunWith<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Autowired<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>SpringBootTest<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span>SpringRunner<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>wltea<span class="token punctuation">.</span>analyzer<span class="token punctuation">.</span>lucene<span class="token punctuation">.</span>IKAnalyzer<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>File<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span>

<span class="token comment">/**
 * @author cyy
 * @date 2020/4/7 14:47
 */</span>
<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span>SpringRunner<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LuceneDemo</span> <span class="token punctuation">{<!-- --></span>


    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> JobInfoServiceImpl jobInfoService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception<span class="token punctuation">{<!-- --></span>

<span class="token comment">//        Directory d 指定索引库的位置, IndexWriterConfig conf 使用哪种分词器</span>
        Directory directory <span class="token operator">=</span> FSDirectory<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"D:\\index"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        Version matchVersion lucene 的版本, Analyzer analyzer 使用的分词器</span>
<span class="token comment">//        StandardAnalyzer标准分词器</span>
<span class="token comment">//        Analyzer analyzer = new StandardAnalyzer();</span>
<span class="token comment">//        Analyzer analyzer = new CJKAnalyzer();//中日韩分词器</span>
        Analyzer analyzer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IKAnalyzer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ik分词器 第三方的 需要导入相关的jar</span>
        IndexWriterConfig indexWriterConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexWriterConfig</span><span class="token punctuation">(</span>Version<span class="token punctuation">.</span>LATEST<span class="token punctuation">,</span>analyzer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        IndexWriter indexWriter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexWriter</span><span class="token punctuation">(</span>directory<span class="token punctuation">,</span>indexWriterConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>

        indexWriter<span class="token punctuation">.</span><span class="token function">deleteAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        List<span class="token generics function"><span class="token punctuation">&lt;</span>JobInfo<span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> jobInfoService<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>JobInfo jobInfo <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Document document <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Document</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token comment">/* jobInfo.getCompanyName();*/</span>
<span class="token comment">//            name是域的名字 随便写 第二个参数是获取的路径 第三个参数是否存储</span>
            document<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextField</span><span class="token punctuation">(</span><span class="token string">"companyName"</span><span class="token punctuation">,</span>jobInfo<span class="token punctuation">.</span><span class="token function">getCompanyName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Field<span class="token punctuation">.</span>Store<span class="token punctuation">.</span>YES<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            document<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextField</span><span class="token punctuation">(</span><span class="token string">"jobName"</span><span class="token punctuation">,</span>jobInfo<span class="token punctuation">.</span><span class="token function">getJobName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Field<span class="token punctuation">.</span>Store<span class="token punctuation">.</span>YES<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            document<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IntField</span><span class="token punctuation">(</span><span class="token string">"salary"</span><span class="token punctuation">,</span>jobInfo<span class="token punctuation">.</span><span class="token function">getSalary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Field<span class="token punctuation">.</span>Store<span class="token punctuation">.</span>YES<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            document<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringField</span><span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">,</span>jobInfo<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Field<span class="token punctuation">.</span>Store<span class="token punctuation">.</span>YES<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//TextField和StringField 都是放字符串的</span>
<span class="token comment">//            TextField和StringField默认分词 string不会分词</span>
            indexWriter<span class="token punctuation">.</span><span class="token function">addDocument</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>

            indexWriter<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

     <span class="token annotation punctuation">@Test</span>
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">indexTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception<span class="token punctuation">{<!-- --></span>
         Directory directory <span class="token operator">=</span> FSDirectory<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"D:\\index"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         IndexReader indexReader <span class="token operator">=</span> DirectoryReader<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>directory<span class="token punctuation">)</span><span class="token punctuation">;</span>

         IndexSearcher indexSearcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexSearcher</span><span class="token punctuation">(</span>indexReader<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//         Query query 查询方式  int n 最多查询多少条数据</span>


         TopDocs topDocs <span class="token operator">=</span> indexSearcher<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TermQuery</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Term</span><span class="token punctuation">(</span><span class="token string">"companyName"</span><span class="token punctuation">,</span> <span class="token string">"中认环宇"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        符合条件的总数据量</span>
         System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"topDocs.totalHits = "</span> <span class="token operator">+</span> topDocs<span class="token punctuation">.</span>totalHits<span class="token punctuation">)</span><span class="token punctuation">;</span>

         ScoreDoc<span class="token punctuation">[</span><span class="token punctuation">]</span> scoreDocs <span class="token operator">=</span> topDocs<span class="token punctuation">.</span>scoreDocs<span class="token punctuation">;</span>
         <span class="token keyword">for</span> <span class="token punctuation">(</span>ScoreDoc scoreDoc <span class="token operator">:</span> scoreDocs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
             <span class="token keyword">int</span> docId <span class="token operator">=</span> scoreDoc<span class="token punctuation">.</span>doc<span class="token punctuation">;</span>
             Document document <span class="token operator">=</span> indexSearcher<span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>docId<span class="token punctuation">)</span><span class="token punctuation">;</span>
             System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"companyName"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"jobName"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"salary"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">" = ========================== ="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>

     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h4><a id="232__136"></a>2.3.2 分词器</h4> 
<ul><li>自带的分词器不符合中国人的说话方式，使用ik分词器</li></ul> 
<ol><li>导入jar</li></ol> 
<pre><code class="prism language-xml"> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.janeluo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>ikanalyzer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2012_u6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<ol start="2"><li>ik分词器支持自定义 可以自己定义拓展词典和禁用的词典<br> ext.dic和stopword.dic 使用这两个需要ik分词器的配置文件IKAnalyzer.cfg.xml</li></ol> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token doctype">&lt;!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd"&gt;</span>  
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>  
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>comment</span><span class="token punctuation">&gt;</span></span>IK Analyzer 扩展配置<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>comment</span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!--用户可以在这里配置自己的扩展字典 --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ext_dict<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>ext.dic;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>entry</span><span class="token punctuation">&gt;</span></span> 

	<span class="token comment">&lt;!--用户可以在这里配置自己的停止词字典--&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ext_stopwords<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>stopword.dic;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>entry</span><span class="token punctuation">&gt;</span></span> 
	
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h2><a id="Elasticsearch_161"></a>三.Elasticsearch</h2> 
<p>Elastic有一条完整的产品线：Elasticsearch、Kibana、Logstash等，前面说的三个就是大家常说的ELK技术栈。</p> 
<h3><a id="31_Elasticsearch_163"></a>3.1 Elasticsearch</h3> 
<p>Elasticsearch官网：<a href="https://www.elastic.co/cn/products/elasticsearch" rel="nofollow">官网</a></p> 
<p>Elasticsearch具备以下特点：</p> 
<ul><li>分布式，无需人工搭建集群（solr就需要人为配置，使用Zookeeper作为注册中心）</li><li>Restful风格，一切API都遵循Rest原则，容易上手</li><li>近实时搜索，数据更新在Elasticsearch中几乎是完全同步的。</li></ul> 
<h4><a id="311__171"></a>3.1.1 安装</h4> 
<p>下一步</p> 
<h4><a id="312__173"></a>3.1.2 修改配置文件</h4> 
<p>1、修改索引数据和日志数据存储的路径<br> <img src="https://images2.imgbox.com/4b/2a/AZnv0ENU_o.png" alt="在这里插入图片描述"><br> 第33行和37行，修改完记得把注释打开</p> 
<pre><code>path.data: d:\class\es\data
#
# Path to log files:
#
path.logs: d:\class\es\log
</code></pre> 
<h4><a id="313__185"></a>3.1.3 访问</h4> 
<p><img src="https://images2.imgbox.com/3d/9f/LhOssEuy_o.png" alt="在这里插入图片描述"><br> 可以看到绑定了两个端口:<br> 9300：集群节点间通讯接口，接收tcp协议<br> 9200：客户端访问接口，接收Http协议</p> 
<h3><a id="32_Kibana_191"></a>3.2 Kibana</h3> 
<h4><a id="321_Kibana_192"></a>3.2.1 什么是Kibana</h4> 
<p>Kibana是一个基于Node.js的Elasticsearch索引库数据统计工具，可以利用Elasticsearch的聚合功能，生成各种图表，如柱形图，线状图，饼图等。</p> 
<p>而且还提供了操作Elasticsearch索引数据的控制台，并且提供了一定的API提示，非常有利于我们学习Elasticsearch的语法。</p> 
<h4><a id="322__197"></a>3.2.2 安装</h4> 
<p>因为Kibana依赖于node，需要在windows下先安装Node.js。<br> 然后安装kibana，最新版本与elasticsearch保持一致。</p> 
<h4><a id="323__200"></a>3.2.3 配置运行</h4> 
<p>配置<br> 进入安装目录下的config目录，修改kibana.yml文件：<br> 修改elasticsearch服务器的地址：</p> 
<pre><code>elasticsearch.url: "http://127.0.0.1:9200"
</code></pre> 
<p>运行<br> <img src="https://images2.imgbox.com/92/4d/j2BMMDQ0_o.png" alt="在这里插入图片描述"><br> 访问：http://127.0.0.1:5601</p> 
<h3><a id="32_kibana_211"></a>3.2 使用kibana对索引库操作</h3> 
<pre><code>索引库（indices）---------------------------------Database 数据库

    类型（type）----------------------------------Table 数据表

 文档（Document）---------------------------------Row 行

     字段（Field）--------------------------------Columns 列 
     
映射配置（mappings）-------------------------------每个列的约束（类型、长度）   
</code></pre> 
<h3><a id="33__224"></a>3.3 操作索引库</h3> 
<pre><code>PUT/索引库名 --创建
GET /索引库名 --获取
DELETE/索引库名 --删除

</code></pre> 
<h3><a id="34_kibana_232"></a>3.4 使用kibana对类型及映射操作</h3> 
<h4><a id="341__233"></a>3.4.1 创建字段映射</h4> 
<p>语法</p> 
<pre><code>PUT /索引库名/_mapping/类型名称
{
  "properties": {
    "字段名": {
      "type": "类型",
      "index": true，
      "store": true，
      "analyzer": "分词器"
    }
  }
}
</code></pre> 
<ul><li>类型名称：就是前面将的type的概念，类似于数据库中的表<br> 字段名：任意填写，下面指定许多属性，例如：</li><li>type：类型，可以是text、long、short、date、integer、object等</li><li>index：是否索引，默认为true</li><li>store：是否存储，默认为false</li><li>analyzer：分词器，这里的<code>ik_max_word</code>即使用ik分词器<br> <mark>keyword相当于string 默认是不分词</mark></li></ul> 
<p>测试：</p> 
<pre><code>PUT heima/_mapping/goods
{
  "properties": {
    "goodName":{
      "type": "text",
      "analyzer": "ik_max_word",
      "store": true,
      "index": true
    },
    "price":{
      "type": "double",
      "store": true,
      "index": true
    },
      "image":{
      "type": "keyword",
      "store": true
    }
  }
}
</code></pre> 
<p><img src="https://images2.imgbox.com/ae/45/1AglubLz_o.png" alt="在这里插入图片描述"><br> <mark>一次性创建索引库和映射</mark></p> 
<pre><code>PUT /heima2
{
  
    "mappings": {
      "goods":{
        "properties": {
      "goodName":{
        "type": "text",
        "analyzer": "ik_max_word",
        "index": true,
        "store": true
      },
      "price":{
        "type": "keyword",
        "index": true,
        "store": true
      }
    }
      }
    }
}
</code></pre> 
<h4><a id="342__306"></a>3.4.2 映射属性详解</h4> 
<h5><a id="1type_307"></a>1）type</h5> 
<ul><li> <p>String类型，又分两种：</p> 
  <ul><li>text：可分词，不可参与聚合</li><li>keyword：不可分词，数据会作为完整字段进行匹配，可以参与聚合</li></ul> </li><li> <p>Numerical：数值类型，分两类</p> 
  <ul><li>基本数据类型：long、interger、short、byte、double、float、half_float</li><li>浮点数的高精度类型：scaled_float 
    <ul><li>需要指定一个精度因子，比如10或100。elasticsearch会把真实值乘以这个因子后存储，取出时再还原。</li></ul> </li></ul> </li><li> <p>Date：日期类型</p> <p>elasticsearch可以对日期格式化为字符串存储，但是建议我们存储为毫秒值，存储为long，节省空间。</p> </li><li> <p>Array：数组类型</p> 
  <ul><li>进行匹配时，任意一个元素满足，都认为满足</li><li>排序时，如果升序则用数组中的最小值来排序，如果降序则用数组中的最大值来排序</li></ul> </li><li> <p>Object：对象</p> </li></ul> 
<h5><a id="2index_330"></a>2）index</h5> 
<p>index影响字段的索引情况。</p> 
<ul><li>true：字段会被索引，则可以用来进行搜索过滤。默认值就是true</li><li>false：字段不会被索引，不能用来搜索</li></ul> 
<p>index的默认值就是true，也就是说你不进行任何配置，所有字段都会被索引。</p> 
<p>但是有些字段是我们不希望被索引的，比如商品的图片信息，就需要手动设置index为false。</p> 
<h5><a id="3store_340"></a>3）store</h5> 
<p>是否将数据进行额外存储。</p> 
<p>在学习lucene时，我们知道如果一个字段的store设置为false，那么在文档列表中就不会有这个字段的值，用户的搜索结果中不会显示出来。</p> 
<p>但是在Elasticsearch中，即便store设置为false，也可以搜索到结果。</p> 
<p>原因是Elasticsearch在创建文档索引时，会将文档中的原始数据备份，保存到一个叫做<code>_source</code>的属性中。而且我们可以通过过滤<code>_source</code>来选择哪些要显示，哪些不显示。</p> 
<p>而如果设置store为true，就会在<code>_source</code>以外额外存储一份数据，多余，因此一般我们都会将store设置为false，事实上，<strong>store的默认值就是false。</strong></p> 
<h5><a id="4boost_351"></a>4）boost</h5> 
<p>权重，新增数据时，可以指定该数据的权重，权重越高，得分越高，排名越靠前。</p> 
<h3><a id="35_kibana_354"></a>3.5 使用kibana对文档操作</h3> 
<h4><a id="351__355"></a>3.5.1 新增文档</h4> 
<p><mark>不指定id新增</mark></p> 
<pre><code>post heima/goods
{
  "goodName":"huawei",
  "pricce":1111,
  "image":"http://sdsa.jpg"
}
</code></pre> 
<p><mark>指定id新增</mark><br> 在索引库后面写id的值就可以了</p> 
<pre><code>POST heima/goods/2
{
  "goodsName":"ipone",
  "price":1111,
  "img":"sada.jpg"
}
</code></pre> 
<h4><a id="352__377"></a>3.5.2 常用命令</h4> 
<pre><code>GET  获取
POST 新增
PUT  修改
DELETE 删除
</code></pre> 
<h4><a id="353__385"></a>3.5.3 自定义模板</h4> 
<p>动态模板的语法：<br> <img src="https://images2.imgbox.com/1b/07/XmbWvQiJ_o.png" alt="在这里插入图片描述"><br> 1）模板名称，随便起</p> 
<p>2）匹配条件，凡是符合条件的未定义字段，都会按照这个规则来映射</p> 
<p>3）映射规则，匹配成功后的映射规则</p> 
<pre><code>PUT heima3
{
  "mappings": {
    "goods": {
      "properties": {
        "title": {
          "type": "text",
          "analyzer": "ik_max_word"
        }
      },
      "dynamic_templates": [
        {
          "strings": {
            "match_mapping_type": "string",
            "mapping": {
              "type": "keyword"
            }
          }
        }
      ]
    }
  }
}
</code></pre> 
<h3><a id="36__419"></a>3.6 查询</h3> 
<h4><a id="361__term_420"></a>3.6.1 词条匹配(term)</h4> 
<p><mark>注意_search</mark></p> 
<pre><code>GET /heima/_search
{
    "query":{
        "term":{
            "price":2699.00
        }
    }
}
</code></pre> 
<h4><a id="362___match_432"></a>3.6.2 匹配查询（match）</h4> 
<p><mark>会把关键字分词 or关系</mark></p> 
<pre><code>GET /heima/_search
{
    "query":{
        "match":{
            "title":"小米电视"
        }
    }
}
</code></pre> 
<p>更改为and关系</p> 
<pre><code>GET /goods/_search
{
    "query":{
        "match":{
            "title":{"query":"小米电视","operator":"and"}
        }
    }
}
</code></pre> 
<h4><a id="363_match_all_458"></a>3.6.3 查询所有（match_all)</h4> 
<pre><code>GET /heima/_search
{
    "query":{
        "match_all": {}
    }
}
</code></pre> 
<ul><li><code>query</code>：代表查询对象</li><li><code>match_all</code>：代表查询所有<br> 结果：</li></ul> 
<pre><code>{
  "took": 2,
  "timed_out": false,
  "_shards": {
    "total": 3,
    "successful": 3,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 2,
    "max_score": 1,
    "hits": [
      {
        "_index": "heima",
        "_type": "goods",
        "_id": "2",
        "_score": 1,
        "_source": {
          "title": "大米手机",
          "images": "http://image.leyou.com/12479122.jpg",
          "price": 2899
        }
      },
      {
        "_index": "heima",
        "_type": "goods",
        "_id": "r9c1KGMBIhaxtY5rlRKv",
        "_score": 1,
        "_source": {
          "title": "小米手机",
          "images": "http://image.leyou.com/12479122.jpg",
          "price": 2699
        }
      }
    ]
  }
}
</code></pre> 
<ul><li>took：查询花费时间，单位是毫秒</li><li>time_out：是否超时</li><li>_shards：分片信息</li><li>hits：搜索结果总览对象 
  <ul><li>total：搜索到的总条数</li><li>max_score：所有结果中文档得分的最高分</li><li>hits：搜索结果的文档对象数组，每个元素是一条搜索到的文档信息 
    <ul><li>_index：索引库</li><li>_type：文档类型</li><li>_id：文档id</li><li>_score：文档得分</li><li>_source：文档的源数据</li></ul> </li></ul> </li></ul> 
<h4><a id="364___fuzzy_526"></a>3.6.4 模糊查询(fuzzy)</h4> 
<p><code>fuzzy</code> 查询是 <code>term</code> 查询的模糊等价。它允许用户搜索词条与实际词条的拼写出现偏差，但是偏差的编辑距离不得超过2：</p> 
<p><code>fuzziness</code>偏离度 不得超过2</p> 
<p><mark>搜索ipona的时候可以查出ipone</mark></p> 
<pre><code>GET heima/goods/_search
{
"query":{
  "fuzzy": {
    "goodsName": {
      "value": "手环",
      "fuzziness": 1
    }
  }
}
}
</code></pre> 
<p>结果：</p> 
<pre><code>{
  "took": 19,
  "timed_out": false,
  "_shards": {
    "total": 5,
    "successful": 5,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 1,
    "max_score": 0.23014566,
    "hits": [
      {
        "_index": "heima",
        "_type": "goods",
        "_id": "3",
        "_score": 0.23014566,
        "_source": {
          "goodsName": "ipone 2",
          "price": 11111,
          "image": "sad.jpg"
        }
      }
    ]
  }
}
</code></pre> 
<h4><a id="365__range_577"></a>3.6.5 范围查询(range)</h4> 
<pre><code>GET heima/goods/_search
{
"query":{
  "range": {
    "price": {
      "gte": 10000,
      "lte": 12000
    }
  }
}
}
</code></pre> 
<p><code>range</code>查询允许以下字符：</p> 
<table><thead><tr><th align="center">操作符</th><th align="center">说明</th></tr></thead><tbody><tr><td align="center">gt</td><td align="center">大于</td></tr><tr><td align="center">gte</td><td align="center">大于等于</td></tr><tr><td align="center">lt</td><td align="center">小于</td></tr><tr><td align="center">lte</td><td align="center">小于等于</td></tr></tbody></table> 
<h4><a id="366__bool_601"></a>3.6.6 布尔组合（bool)</h4> 
<p><code>bool</code>把各种其它查询通过<code>must</code>（与）、<code>must_not</code>（非）、<code>should</code>（或）的方式进行组合</p> 
<pre><code>商品名称带有手机并且价格在10000-20000之间的
GET heima/goods/_search
{
"query":{
  "bool": {
    "must": [
      {"term": {
        "goodsName": {
          "value": "手机"
        }
      }},{
        "range": {
          "price": {
            "gte": 10000,
            "lte": 20000
          }
        }
      }
    ]
  }
}
}
</code></pre> 
<h3><a id="37__628"></a>3.7 分页，过滤，排序，高亮</h3> 
<h4><a id="371___629"></a>3.7.1 分页</h4> 
<p>elasticsearch的分页与mysql数据库非常相似，都是指定两个值：</p> 
<ul><li>from：开始位置</li><li>size：每页大小</li></ul> 
<pre><code>GET /heima/_search
{
  "query": {
    "match_all": {}
  },
  "sort": [
    {
      "price": {
        "order": "asc"
      }
    }
  ],
  "from": 3,
  "size": 3
}
</code></pre> 
<h4><a id="372___652"></a>3.7.2 排序</h4> 
<pre><code>GET heima/goods/_search
{
"query":{
  "match_all": {}
},"sort": [
  {
    "price": {
      "order": "desc"
    }
  }
], 
"from": 0,
"size": 2
}
</code></pre> 
<h4><a id="373___670"></a>3.7.3 过滤</h4> 
<h5><a id="__includesexcludes_671"></a>结果过滤 - 指定includes和excludes</h5> 
<ul><li>includes：来指定想要显示的字段</li><li>excludes：来指定不想要显示的字段</li></ul> 
<pre><code>GET heima/goods/_search
{
  "query": {
    "match": {
      "goodsName": "手机"
    }
  },
  "_source": {
    "includes": ["goodsName","price"]
  
  }
}
</code></pre> 
<p>结果：</p> 
<pre><code>{
  "took": 2,
  "timed_out": false,
  "_shards": {
    "total": 5,
    "successful": 5,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 4,
    "max_score": 0.6099695,
    "hits": [
      {
        "_index": "heima",
        "_type": "goods",
        "_id": "7",
        "_score": 0.6099695,
        "_source": {
          "price": 12345,
          "goodsName": "手机2"
        }
      },
      {
        "_index": "heima",
        "_type": "goods",
        "_id": "4",
        "_score": 0.5619608,
        "_source": {
          "price": 12345,
          "goodsName": "手机"
        }
      },
      {
        "_index": "heima",
        "_type": "goods",
        "_id": "6",
        "_score": 0.43445712,
        "_source": {
          "price": 12345,
          "goodsName": "手机1"
        }
      },
      {
        "_index": "heima",
        "_type": "goods",
        "_id": "8",
        "_score": 0.2876821,
        "_source": {
          "price": 12345,
          "goodsName": "手机3"
        }
      }
    ]
  }
}
</code></pre> 
<h5><a id="filter_749"></a>过滤(filter)</h5> 
<p><strong>条件查询中进行过滤</strong></p> 
<p>所有的查询都会影响到文档的评分及排名。如果我们需要在查询结果中进行过滤，并且不希望过滤条件影响评分，那么就不要把过滤条件作为查询条件来用。而是使用<code>filter</code>方式：</p> 
<pre><code>GET heima/goods/_search
{
  "query": {
    "bool": {
      "must": [
        {"match": {
          "goodsName": "手机"
        }}
      ],
      "filter": {"range": {
        "price": {
          "gte": 10000,
          "lte": 20000
        }
      }}
    }
  }
}
</code></pre> 
<h4><a id="374___773"></a>3.7.4 高亮</h4> 
<p>在使用match查询的同时，加上一个highlight属性：</p> 
<ul><li>pre_tags：前置标签</li><li>post_tags：后置标签</li><li>fields：需要高亮的字段 
  <ul><li>title：这里声明title字段需要高亮，后面可以为这个字段设置特有配置，也可以空</li></ul> </li></ul> 
<pre><code>GET heima/goods/_search
{
  "query": {
    "term": {
      "goodsName": {
        "value": "手机"
      }
    }
  },
  "highlight": {
    "fields": {"goodsName": {}},
    "pre_tags": "&lt;span style='color:red'&gt;",
    "post_tags": "/&lt;span&gt;"
  }
}
</code></pre> 
<h3><a id="38_aggregations_799"></a>3.8 聚合aggregations</h3> 
<h4><a id="381_bucket_______group_by_800"></a>3.8.1 桶（bucket ) 类似于 group by</h4> 
<p>根据车辆的颜色分类</p> 
<pre><code>GET car/orders/_search
{
  "size": 0, 
  "aggs": {
    "color": {
      "terms": {
        "field": "color",
        "size": 10
      }
    }
  }
}
</code></pre> 
<ul><li>size： 查询条数，这里设置为0，因为我们不关心搜索到的数据，只关心聚合结果，提高效率</li><li>aggs：声明这是一个聚合查询，是aggregations的缩写 
  <ul><li>popular_colors：给这次聚合起一个名字，可任意指定。 
    <ul><li>terms：聚合的类型，这里选择terms，是根据词条内容（这里是颜色）划分 
      <ul><li>field：划分桶时依赖的字段</li></ul> </li></ul> </li></ul> </li></ul> 
<p><strong>结果</strong></p> 
<pre><code>{
  "took": 19,
  "timed_out": false,
  "_shards": {
    "total": 5,
    "successful": 5,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 8,
    "max_score": 0,
    "hits": []
  },
  "aggregations": {
    "color": {
      "doc_count_error_upper_bound": 0,
      "sum_other_doc_count": 0,
      "buckets": [
        {
          "key": "红",
          "doc_count": 4
        },
        {
          "key": "绿",
          "doc_count": 2
        },
        {
          "key": "蓝",
          "doc_count": 2
        }
      ]
    }
  }
}
</code></pre> 
<ul><li>hits：查询结果为空，因为我们设置了size为0</li><li>aggregations：聚合的结果</li><li>popular_colors：我们定义的聚合名称</li><li>buckets：查找到的桶，每个不同的color字段值都会形成一个桶 
  <ul><li>key：这个桶对应的color字段的值</li><li>doc_count：这个桶中的文档数量</li></ul> </li></ul> 
<h4><a id="382_metrics_870"></a>3.8.2 度量（metrics）相当于聚合的结果</h4> 
<p>分类后每个颜色的平均价格</p> 
<p><mark>求平均值写在aggs里面的 和terms 并列</mark></p> 
<pre><code>GET car/orders/_search
{
  "size": 0, 
  "aggs": {
    "color": {
      "terms": {
        "field": "color",
        "size": 10
      },
    "aggs": {
    "avg_price": {
      "avg": {
        "field": "price"
      }
    }
  }
    }
  }
}
</code></pre> 
<ul><li>aggs：我们在上一个aggs(popular_colors)中添加新的aggs。可见度量也是一个聚合</li><li>avg_price：聚合的名称</li><li>avg：度量的类型，这里是求平均值</li><li>field：度量运算的字段</li></ul> 
<h2><a id="Elasticsearch_899"></a>四.Elasticsearch集群</h2> 
<h3><a id="41__900"></a>4.1 数据分片和数据备份</h3> 
<p><img src="https://images2.imgbox.com/d8/7a/eZq3xtPv_o.png" alt="在这里插入图片描述"><br> 分布式 把一个项目分成几部分，集群是和它本身相同的。</p> 
<h3><a id="42__904"></a>4.2 搭建集群</h3> 
<p>第一步：把昨天安装的ES软件中的data文件夹的数据删除<br> <img src="https://images2.imgbox.com/ab/38/kl2uhcJ9_o.png" alt="在这里插入图片描述"><br> 第二步：修改每一个节点的配置文件,下面已第一份配置文件为例</p> 
<pre><code>#允许跨域名访问
http.cors.enabled: true
http.cors.allow-origin: "*"
network.host: 127.0.0.1
# 集群的名称
cluster.name: leyou-elastic
#当前节点名称 每个节点不一样
node.name: node-01
#数据的存放路径 每个节点不一样
path.data: d:\class\sorfware\elasticsearch-9201\data
#日志的存放路径 每个节点不一样
path.logs: d:\class\sorfware\elasticsearch-9201\logs
# http协议的对外端口 每个节点不一样
http.port: 9201
# TCP协议对外端口 每个节点不一样
transport.tcp.port: 9301
#三个节点相互发现
discovery.zen.ping.unicast.hosts: ["127.0.0.1:9301","127.0.0.1:9302","127.0.0.1:9303"]
#声明大于几个的投票主节点有效，请设置为（nodes / 2） + 1
discovery.zen.minimum_master_nodes: 2
# 是否为主节点
node.master: true

</code></pre> 
<p>第三步：启动集群<br> 把三个节点分别启动,启动时不要着急，要一个一个地启动<br> 使用head插件查看<br> <img src="https://images2.imgbox.com/e7/22/81fgAcgu_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="43__938"></a>4.3 测试集群中创建索引库</h3> 
<pre><code>PUT heima
{
  "settings": {
    "number_of_shards": 3,
    "number_of_replicas": 1
  }
}
</code></pre> 
<ul><li>settings：就是索引库设置，其中可以定义索引库的各种属性</li><li>number_of_shards：分片数量，这里设置为3</li><li>number_of_replicas：副本数量，这里设置为1，每个分片一个备份，一个原始数据，共2份。<br> <img src="https://images2.imgbox.com/a9/63/MWJE8Bkt_o.png" alt="在这里插入图片描述"></li></ul> 
<h2><a id="Elasticsearch_953"></a>五.Elasticsearch客户端</h2> 
<h3><a id="51_954"></a>5.1索引数据操作</h3> 
<h4><a id="511__955"></a>5.1.1 初始化客户端</h4> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ElasticSearchTest</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> RestHighLevelClient client<span class="token punctuation">;</span>
	<span class="token comment">// Json工具</span>
    <span class="token keyword">private</span> Gson gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Gson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Before</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 初始化HighLevel客户端</span>
        client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestHighLevelClient</span><span class="token punctuation">(</span>
                RestClient<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>
                        HttpHost<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"http://127.0.0.1:9201"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        HttpHost<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"http://127.0.0.1:9202"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        HttpHost<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"http://127.0.0.1:9203"</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@After</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 关闭客户端</span>
        client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="512__983"></a>5.1.2 新增文档</h4> 
<p>gson 将string 转为json字符串 直接new一个gson使用就可以</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>leyou<span class="token punctuation">.</span>rest<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>gson<span class="token punctuation">.</span>Gson<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>leyou<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span>Item<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>HttpHost<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>action<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>create<span class="token punctuation">.</span>CreateIndexRequest<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>action<span class="token punctuation">.</span>index<span class="token punctuation">.</span>IndexRequest<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>action<span class="token punctuation">.</span>index<span class="token punctuation">.</span>IndexResponse<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>client<span class="token punctuation">.</span>RequestOptions<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>client<span class="token punctuation">.</span>RestClient<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>client<span class="token punctuation">.</span>RestHighLevelClient<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>common<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>Settings<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>common<span class="token punctuation">.</span>xcontent<span class="token punctuation">.</span>XContentType<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>After<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>Before<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>Test<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>h2<span class="token punctuation">.</span>H2ConsoleProperties<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException<span class="token punctuation">;</span>

<span class="token comment">/**
 * @author cyy
 * @date 2020/4/9 14:01
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RestDemo</span> <span class="token punctuation">{<!-- --></span>
    RestHighLevelClient client <span class="token operator">=</span>null<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Before</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 初始化HighLevel客户端</span>
        client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestHighLevelClient</span><span class="token punctuation">(</span>
                RestClient<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>
                        HttpHost<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"http://127.0.0.1:9201"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        HttpHost<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"http://127.0.0.1:9202"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        HttpHost<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"http://127.0.0.1:9203"</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@After</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">colse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{<!-- --></span>
        client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
     <span class="token annotation punctuation">@Test</span>
<span class="token comment">//     创建索引库</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception<span class="token punctuation">{<!-- --></span>

    <span class="token punctuation">}</span>

    Gson gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Gson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Test</span>
<span class="token comment">//     添加文档</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception<span class="token punctuation">{<!-- --></span>
       Item item <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Item</span><span class="token punctuation">(</span><span class="token number">1</span>L<span class="token punctuation">,</span><span class="token string">"小米6"</span><span class="token punctuation">,</span><span class="token string">"手机"</span><span class="token punctuation">,</span><span class="token string">"小米"</span><span class="token punctuation">,</span><span class="token number">2000d</span><span class="token punctuation">,</span><span class="token string">"ada.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       String json <span class="token operator">=</span> gson<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
       IndexRequest request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span><span class="token string">"item"</span><span class="token punctuation">,</span><span class="token string">"docs"</span><span class="token punctuation">,</span>item<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span>XContentType<span class="token punctuation">.</span>JSON<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">//执行</span>
        IndexResponse indexResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> RequestOptions<span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"indexResponse.toString() = "</span> <span class="token operator">+</span> indexResponse<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre> 
<h4><a id="513__1052"></a>5.1.3 修改文档</h4> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception<span class="token punctuation">{<!-- --></span>

         Item item <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Item</span><span class="token punctuation">(</span><span class="token number">1</span>L<span class="token punctuation">,</span><span class="token string">"小米7"</span><span class="token punctuation">,</span><span class="token string">"手机"</span><span class="token punctuation">,</span><span class="token string">"小米"</span><span class="token punctuation">,</span><span class="token number">2000d</span><span class="token punctuation">,</span><span class="token string">"ada.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         String json <span class="token operator">=</span> gson<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
         UpdateRequest request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UpdateRequest</span><span class="token punctuation">(</span><span class="token string">"item"</span><span class="token punctuation">,</span><span class="token string">"docs"</span><span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         request<span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span>XContentType<span class="token punctuation">.</span>JSON<span class="token punctuation">)</span><span class="token punctuation">;</span>

         UpdateResponse updateResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> RequestOptions<span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="514__1067"></a>5.14 删除文档</h4> 
<p><strong>根据id删除</strong></p> 
<pre><code class="prism language-java"> <span class="token annotation punctuation">@Test</span>
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteByID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception<span class="token punctuation">{<!-- --></span>
         DeleteRequest request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeleteRequest</span><span class="token punctuation">(</span><span class="token string">"item"</span><span class="token punctuation">,</span><span class="token string">"docs"</span><span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         DeleteResponse deleteResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> RequestOptions<span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="515__1077"></a>5.1.5 查看文档</h4> 
<pre><code class="prism language-java">   <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getdecument</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception<span class="token punctuation">{<!-- --></span>
        GetRequest request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetRequest</span><span class="token punctuation">(</span><span class="token string">"item"</span><span class="token punctuation">,</span><span class="token string">"docs"</span><span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        GetResponse getResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> RequestOptions<span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>getResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="516__1087"></a>5.1.6 批量新增</h4> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@Test</span>
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testBulkIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception<span class="token punctuation">{<!-- --></span>
         BulkRequest request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BulkRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         List<span class="token generics function"><span class="token punctuation">&lt;</span>Item<span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Item</span><span class="token punctuation">(</span><span class="token number">1</span>L<span class="token punctuation">,</span> <span class="token string">"小米手机7"</span><span class="token punctuation">,</span> <span class="token string">"手机"</span><span class="token punctuation">,</span> <span class="token string">"小米"</span><span class="token punctuation">,</span> <span class="token number">3299.00</span><span class="token punctuation">,</span> <span class="token string">"http://image.leyou.com/13123.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Item</span><span class="token punctuation">(</span><span class="token number">2</span>L<span class="token punctuation">,</span> <span class="token string">"坚果手机R1"</span><span class="token punctuation">,</span> <span class="token string">"手机"</span><span class="token punctuation">,</span> <span class="token string">"锤子"</span><span class="token punctuation">,</span> <span class="token number">3699.00</span><span class="token punctuation">,</span> <span class="token string">"http://image.leyou.com/13123.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Item</span><span class="token punctuation">(</span><span class="token number">3</span>L<span class="token punctuation">,</span> <span class="token string">"华为META10"</span><span class="token punctuation">,</span> <span class="token string">"手机"</span><span class="token punctuation">,</span> <span class="token string">"华为"</span><span class="token punctuation">,</span> <span class="token number">4499.00</span><span class="token punctuation">,</span> <span class="token string">"http://image.leyou.com/13123.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Item</span><span class="token punctuation">(</span><span class="token number">4</span>L<span class="token punctuation">,</span> <span class="token string">"小米Mix2S"</span><span class="token punctuation">,</span> <span class="token string">"手机"</span><span class="token punctuation">,</span> <span class="token string">"小米"</span><span class="token punctuation">,</span> <span class="token number">4299.00</span><span class="token punctuation">,</span> <span class="token string">"http://image.leyou.com/13123.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Item</span><span class="token punctuation">(</span><span class="token number">5</span>L<span class="token punctuation">,</span> <span class="token string">"荣耀V10"</span><span class="token punctuation">,</span> <span class="token string">"手机"</span><span class="token punctuation">,</span> <span class="token string">"华为"</span><span class="token punctuation">,</span> <span class="token number">2799.00</span><span class="token punctuation">,</span> <span class="token string">"http://image.leyou.com/13123.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token keyword">for</span> <span class="token punctuation">(</span>Item item <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
             String json <span class="token operator">=</span>gson<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
             request<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span><span class="token string">"item"</span><span class="token punctuation">,</span><span class="token string">"docs"</span><span class="token punctuation">,</span>item<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span>XContentType<span class="token punctuation">.</span>JSON<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         BulkResponse itemResponses <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">bulk</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> RequestOptions<span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
         System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>itemResponses<span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="52__1110"></a>5.2 操作</h3> 
<h4><a id="521__1111"></a>5.2.1 查询</h4> 
<pre><code class="prism language-java"> <span class="token annotation punctuation">@Test</span>
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception<span class="token punctuation">{<!-- --></span>

         <span class="token comment">//指定索引库和类型</span>
         SearchRequest searchRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"item"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         searchRequest<span class="token punctuation">.</span><span class="token function">types</span><span class="token punctuation">(</span><span class="token string">"docs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//         构建查询</span>
         SearchSourceBuilder searchSourceBuilder  <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//         matchall</span>
         searchSourceBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>QueryBuilders<span class="token punctuation">.</span><span class="token function">matchAllQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 模糊查询</span>
         <span class="token comment">//searchSourceBuilder.query(QueryBuilders.fuzzyQuery("title","大米").fuzziness(Fuzziness.ONE));</span>
         <span class="token comment">//组合查询</span>
         <span class="token comment">//searchSourceBuilder.query(QueryBuilders.boolQuery().must(QueryBuilders.matchQuery("title", "手机")).must(QueryBuilders.rangeQuery("price").gte(2000d).lte(4000d)));</span>

         <span class="token comment">//价格区间查询</span>
         <span class="token comment">// searchSourceBuilder.query(QueryBuilders.rangeQuery("price").gte(2000d).lte(4000));</span>
         searchRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>searchSourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//         执行</span>
         SearchResponse searchResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">,</span> RequestOptions<span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>

         SearchHits hits <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">long</span> totalHits <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"总条数："</span><span class="token operator">+</span>totalHits<span class="token punctuation">)</span><span class="token punctuation">;</span>

         SearchHit<span class="token punctuation">[</span><span class="token punctuation">]</span> searchHits <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">for</span> <span class="token punctuation">(</span>SearchHit searchHit <span class="token operator">:</span> searchHits<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
             String jsonStr <span class="token operator">=</span> searchHit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             Item item <span class="token operator">=</span> gson<span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>jsonStr<span class="token punctuation">,</span> Item<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"item = "</span> <span class="token operator">+</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="521__1149"></a>5.2.1 分页，排序</h4> 
<pre><code>//分页
		searchSourceBuilder.from(0);
        searchSourceBuilder.size(2);
//排序
         searchSourceBuilder.sort("price", SortOrder.DESC);
</code></pre> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">searchPageAndSort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>

        <span class="token comment">//指定索引库和类型</span>
        SearchRequest searchRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"item"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        searchRequest<span class="token punctuation">.</span><span class="token function">types</span><span class="token punctuation">(</span><span class="token string">"docs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//         构建查询</span>
        SearchSourceBuilder searchSourceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//         matchall</span>
         searchSourceBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>QueryBuilders<span class="token punctuation">.</span><span class="token function">matchAllQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         searchSourceBuilder<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         searchSourceBuilder<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         searchSourceBuilder<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token string">"price"</span><span class="token punctuation">,</span> SortOrder<span class="token punctuation">.</span>DESC<span class="token punctuation">)</span><span class="token punctuation">;</span>
         searchRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>searchSourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//         执行</span>
        SearchResponse searchResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">,</span> RequestOptions<span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>

        SearchHits hits <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> totalHits <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"总条数："</span> <span class="token operator">+</span> totalHits<span class="token punctuation">)</span><span class="token punctuation">;</span>

        SearchHit<span class="token punctuation">[</span><span class="token punctuation">]</span> searchHits <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>SearchHit searchHit <span class="token operator">:</span> searchHits<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            String jsonStr <span class="token operator">=</span> searchHit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Item item <span class="token operator">=</span> gson<span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>jsonStr<span class="token punctuation">,</span> Item<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"item = "</span> <span class="token operator">+</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="522__1190"></a>5.2.2 高亮</h4> 
<pre><code>//设置高亮
		HighlightBuilder highlightBuilder = new HighlightBuilder();
        highlightBuilder.field("title");
        highlightBuilder.preTags("&lt;span style ='color:red'&gt;" );
        highlightBuilder.postTags("/&lt;span&gt;");
        searchSourceBuilder.highlighter(highlightBuilder);
//在item set标题
			Map&lt;String, HighlightField&gt; highlightFields = searchHit.getHighlightFields();
            HighlightField highlightField = highlightFields.get("title");
            Text[] fragments = highlightField.getFragments();
            String title = fragments[0].toString();
            String jsonStr = searchHit.getSourceAsString();
            Item item = gson.fromJson(jsonStr, Item.class);
            item.setTitle(title);
            System.out.println("item = " + item);
</code></pre> 
<pre><code> @Test
    public void testHighlight() throws Exception {

        //指定索引库和类型
        SearchRequest searchRequest = new SearchRequest("item");
        searchRequest.types("docs");
//         构建查询
        SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();
//         matchall
        searchSourceBuilder.query(QueryBuilders.termQuery("title","手机"));
        HighlightBuilder highlightBuilder = new HighlightBuilder();
        highlightBuilder.field("title");
        highlightBuilder.preTags("&lt;span style ='color:red'&gt;" );
        highlightBuilder.postTags("/&lt;span&gt;");
        searchSourceBuilder.highlighter(highlightBuilder);
        searchRequest.source(searchSourceBuilder);
//         执行
        SearchResponse searchResponse = client.search(searchRequest, RequestOptions.DEFAULT);

        SearchHits hits = searchResponse.getHits();
        long totalHits = hits.getTotalHits();
        System.out.println("总条数：" + totalHits);

        SearchHit[] searchHits = hits.getHits();
        for (SearchHit searchHit : searchHits) {
            Map&lt;String, HighlightField&gt; highlightFields = searchHit.getHighlightFields();
            HighlightField highlightField = highlightFields.get("title");
            Text[] fragments = highlightField.getFragments();
            String title = fragments[0].toString();



            String jsonStr = searchHit.getSourceAsString();
            Item item = gson.fromJson(jsonStr, Item.class);
            item.setTitle(title);
            System.out.println("item = " + item);
        }
    }
</code></pre> 
<h4><a id="523__1250"></a>5.2.3 聚合</h4> 
<pre><code class="prism language-java"> <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testAggregation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>

        <span class="token comment">//指定索引库和类型</span>
        SearchRequest searchRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"item"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        searchRequest<span class="token punctuation">.</span><span class="token function">types</span><span class="token punctuation">(</span><span class="token string">"docs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//         构建查询</span>
        SearchSourceBuilder searchSourceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        TermsAggregationBuilder agg <span class="token operator">=</span> AggregationBuilders<span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">"brand_agg"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"brand"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        searchSourceBuilder<span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span>agg<span class="token punctuation">)</span><span class="token punctuation">;</span>

        searchRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>searchSourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//         执行</span>
        SearchResponse searchResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">,</span> RequestOptions<span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>

        Aggregations aggregations <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Terms terms <span class="token operator">=</span>aggregations<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"brand_agg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        List<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Terms<span class="token punctuation">.</span>Bucket</span><span class="token operator">&gt;</span> buckets <span class="token operator">=</span> terms<span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>Terms<span class="token punctuation">.</span>Bucket bucket <span class="token operator">:</span> buckets<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"bucket.getKeyAsString()+bucket.getDocCount() = "</span> <span class="token operator">+</span> bucket<span class="token punctuation">.</span><span class="token function">getKeyAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> bucket<span class="token punctuation">.</span><span class="token function">getDocCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
        <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="524__1279"></a>5.2.4 过滤</h4> 
<pre><code class="prism language-java">  searchSourceBuilder<span class="token punctuation">.</span><span class="token function">fetchSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span><span class="token string">"id"</span><span class="token punctuation">,</span><span class="token string">"title"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-java">    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>QueryBuilders<span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span>QueryBuilders<span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">"title"</span><span class="token punctuation">,</span><span class="token string">"手机"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>QueryBuilders<span class="token punctuation">.</span><span class="token function">rangeQuery</span><span class="token punctuation">(</span><span class="token string">"price"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gte</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lte</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<h2><a id="SpringDataElasticsearch_1289"></a>六.SpringDataElasticsearch</h2> 
<h3><a id="61_SpringDataElasticsearch_1290"></a>6.1 什么是SpringDataElasticsearch</h3> 
<p>SpringDataElasticsearch（以后简称SDE）是Spring Data项目下的一个子模块。<br> Spring Data 的使命是给各种数据访问提供统一的编程接口，不管是关系型数据库（如MySQL），还是非关系数据库（如Redis），或者类似Elasticsearch这样的索引数据库。从而简化开发人员的代码，提高开发效率。</p> 
<h3><a id="62_SpringDataElasticsearch_1293"></a>6.2 配置SpringDataElasticsearch</h3> 
<h4><a id="621_pom_1294"></a>6.2.1 pom</h4> 
<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-data-elasticsearch&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre> 
<h4><a id="622_yml_1302"></a>6.2.2 yml</h4> 
<pre><code class="prism language-yml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">data</span><span class="token punctuation">:</span>
    <span class="token key atrule">elasticsearch</span><span class="token punctuation">:</span>
      <span class="token key atrule">cluster-name</span><span class="token punctuation">:</span> leyou<span class="token punctuation">-</span>elastic
      <span class="token key atrule">cluster-nodes</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">9301</span><span class="token punctuation">,</span>127.0.0.1<span class="token punctuation">:</span><span class="token number">9302</span><span class="token punctuation">,</span>127.0.0.1<span class="token punctuation">:</span><span class="token number">9303</span>
</code></pre> 
<h4><a id="623__1311"></a>6.2.3 引导类</h4> 
<pre><code class="prism language-java">
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>SpringApplication<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>SpringBootApplication<span class="token punctuation">;</span>

<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EsApplication</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        SpringApplication<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>EsApplication<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h3><a id="63__1325"></a>6.3 索引库操作</h3> 
<h4><a id="631__1326"></a>6.3.1 在实体类上映射</h4> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@Document</span><span class="token punctuation">(</span>indexName <span class="token operator">=</span> <span class="token string">"leyou"</span><span class="token punctuation">,</span>type <span class="token operator">=</span> <span class="token string">"goods"</span><span class="token punctuation">,</span>shards <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Goods</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token keyword">private</span> Long id<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Field</span><span class="token punctuation">(</span>type <span class="token operator">=</span> FieldType<span class="token punctuation">.</span>Text<span class="token punctuation">,</span>analyzer <span class="token operator">=</span> <span class="token string">"ik_max_word"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> String title<span class="token punctuation">;</span> <span class="token comment">//标题</span>
    <span class="token annotation punctuation">@Field</span><span class="token punctuation">(</span>type <span class="token operator">=</span> FieldType<span class="token punctuation">.</span>Keyword<span class="token punctuation">)</span>
    <span class="token keyword">private</span> String category<span class="token punctuation">;</span><span class="token comment">// 分类</span>
    <span class="token annotation punctuation">@Field</span><span class="token punctuation">(</span>type <span class="token operator">=</span> FieldType<span class="token punctuation">.</span>Keyword<span class="token punctuation">)</span>
    <span class="token keyword">private</span> String brand<span class="token punctuation">;</span> <span class="token comment">// 品牌</span>
    <span class="token annotation punctuation">@Field</span><span class="token punctuation">(</span>type <span class="token operator">=</span> FieldType<span class="token punctuation">.</span>Double<span class="token punctuation">)</span>
    <span class="token keyword">private</span> Double price<span class="token punctuation">;</span> <span class="token comment">// 价格</span>
    <span class="token annotation punctuation">@Field</span><span class="token punctuation">(</span>type <span class="token operator">=</span> FieldType<span class="token punctuation">.</span>Keyword<span class="token punctuation">,</span>index <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> String images<span class="token punctuation">;</span> <span class="token comment">// 图片地址</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>几个用到的注解：</p> 
<ul><li>@Document：声明索引库配置 
  <ul><li>indexName：索引库名称</li><li>type：类型名称，默认是“docs”</li><li>shards：分片数量，默认5</li><li>replicas：副本数量，默认1</li></ul> </li><li>@Id：声明实体类的id</li><li>@Field：声明字段属性 
  <ul><li>type：字段的数据类型</li><li>analyzer：指定分词器类型</li><li>index：是否创建索引</li></ul> </li></ul> 
<h4><a id="632__1362"></a>6.3.2 创建索引库</h4> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span>SpringRunner<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SDEManageDemo</span> <span class="token punctuation">{<!-- --></span>
	<span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> ElasticsearchTemplate elasticsearchTemplate<span class="token punctuation">;</span>

     <span class="token annotation punctuation">@Test</span>
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception<span class="token punctuation">{<!-- --></span>

         elasticsearchTemplate<span class="token punctuation">.</span><span class="token function">createIndex</span><span class="token punctuation">(</span>Goods<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="632_mapping_1378"></a>6.3.2 创建mapping</h4> 
<pre><code class="prism language-java"> <span class="token annotation punctuation">@Test</span>
      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">creatMapping</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception<span class="token punctuation">{<!-- --></span>

         elasticsearchTemplate<span class="token punctuation">.</span><span class="token function">putMapping</span><span class="token punctuation">(</span>Goods<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/22/b5/6cct5E6g_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="64_CRUD_1388"></a>6.4 索引数据CRUD</h3> 
<h4><a id="641__1389"></a>6.4.1 自定义接口</h4> 
<p>我们需要自定义接口，继承ElasticsearchRepository：</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>leyou<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>leyou<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span>Goods<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>ElasticsearchRepository<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">GoodsRepostroty</span> <span class="token keyword">extends</span> <span class="token class-name">ElasticsearchRepository</span><span class="token generics function"><span class="token punctuation">&lt;</span>Goods<span class="token punctuation">,</span>Long<span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>



<span class="token punctuation">}</span>

</code></pre> 
<h4><a id="642__1404"></a>6.4.2 数据的增删改</h4> 
<p>update和save 是一样的</p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@Autowired</span>
     <span class="token keyword">private</span> GoodsRepostroty goodsRepostroty<span class="token punctuation">;</span>
     <span class="token annotation punctuation">@Test</span>
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
         Goods goods <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Goods</span><span class="token punctuation">(</span><span class="token number">1</span>L<span class="token punctuation">,</span> <span class="token string">"小米手机9"</span><span class="token punctuation">,</span> <span class="token string">" 手机"</span><span class="token punctuation">,</span>
                 <span class="token string">"小米"</span><span class="token punctuation">,</span> <span class="token number">3499.00</span><span class="token punctuation">,</span> <span class="token string">"http://image.leyou.com/13123.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         goodsRepostroty<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>goods<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
</code></pre> 
<p><strong>批量新增</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">bulkAddDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        List<span class="token generics function"><span class="token punctuation">&lt;</span>Goods<span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Goods</span><span class="token punctuation">(</span><span class="token number">1</span>L<span class="token punctuation">,</span> <span class="token string">"小米手机7"</span><span class="token punctuation">,</span> <span class="token string">"手机"</span><span class="token punctuation">,</span> <span class="token string">"小米"</span><span class="token punctuation">,</span> <span class="token number">3299.00</span><span class="token punctuation">,</span> <span class="token string">"http://image.leyou.com/13123.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Goods</span><span class="token punctuation">(</span><span class="token number">2</span>L<span class="token punctuation">,</span> <span class="token string">"坚果手机R1"</span><span class="token punctuation">,</span> <span class="token string">"手机"</span><span class="token punctuation">,</span> <span class="token string">"锤子"</span><span class="token punctuation">,</span> <span class="token number">3699.00</span><span class="token punctuation">,</span> <span class="token string">"http://image.leyou.com/13123.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Goods</span><span class="token punctuation">(</span><span class="token number">3</span>L<span class="token punctuation">,</span> <span class="token string">"华为META10"</span><span class="token punctuation">,</span> <span class="token string">"手机"</span><span class="token punctuation">,</span> <span class="token string">"华为"</span><span class="token punctuation">,</span> <span class="token number">4499.00</span><span class="token punctuation">,</span> <span class="token string">"http://image.leyou.com/13123.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Goods</span><span class="token punctuation">(</span><span class="token number">4</span>L<span class="token punctuation">,</span> <span class="token string">"小米Mix2S"</span><span class="token punctuation">,</span> <span class="token string">"手机"</span><span class="token punctuation">,</span> <span class="token string">"小米"</span><span class="token punctuation">,</span> <span class="token number">4299.00</span><span class="token punctuation">,</span> <span class="token string">"http://image.leyou.com/13123.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Goods</span><span class="token punctuation">(</span><span class="token number">5</span>L<span class="token punctuation">,</span> <span class="token string">"荣耀V10"</span><span class="token punctuation">,</span> <span class="token string">"手机"</span><span class="token punctuation">,</span> <span class="token string">"华为"</span><span class="token punctuation">,</span> <span class="token number">2799.00</span><span class="token punctuation">,</span> <span class="token string">"http://image.leyou.com/13123.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        goodsRepostroty<span class="token punctuation">.</span><span class="token function">saveAll</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="642__1432"></a>6.4.2 查询数据</h4> 
<p><strong>根据id查询</strong></p> 
<pre><code class="prism language-java"> <span class="token annotation punctuation">@Test</span>
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception<span class="token punctuation">{<!-- --></span>
         Optional<span class="token generics function"><span class="token punctuation">&lt;</span>Goods<span class="token punctuation">&gt;</span></span> goods <span class="token operator">=</span> goodsRepostroty<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token number">1</span>L<span class="token punctuation">)</span><span class="token punctuation">;</span>
         Goods goods1 <span class="token operator">=</span> goods<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>goods1<span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token punctuation">}</span>
</code></pre> 
<p><strong>查询所有</strong></p> 
<pre><code class="prism language-java"> <span class="token annotation punctuation">@Test</span>
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception<span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* Optional&lt;Goods&gt; goods = goodsRepostroty.findById(1L);
         Goods goods1 = goods.get();
         System.out.println(goods1);*/</span>

         Iterable<span class="token generics function"><span class="token punctuation">&lt;</span>Goods<span class="token punctuation">&gt;</span></span> all <span class="token operator">=</span> goodsRepostroty<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">for</span> <span class="token punctuation">(</span>Goods goods <span class="token operator">:</span> all<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
             System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>goods<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>

     <span class="token punctuation">}</span>
</code></pre> 
<p><strong>根据条件查询</strong></p> 
<p>标题中带手机的</p> 
<pre><code class="prism language-java"> <span class="token annotation punctuation">@Test</span>
      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">byTitleTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception<span class="token punctuation">{<!-- --></span>
        List<span class="token generics function"><span class="token punctuation">&lt;</span>Goods<span class="token punctuation">&gt;</span></span> goodslist <span class="token operator">=</span>goodsRepostroty<span class="token punctuation">.</span><span class="token function">findByTitle</span><span class="token punctuation">(</span><span class="token string">"手机"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span>Goods goods <span class="token operator">:</span> goodslist<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>goods<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
</code></pre> 
<p>自定义方法 无需写实现，SDE会自动帮我们实现该方法</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>leyou<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>leyou<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span>Goods<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>ElasticsearchRepository<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">GoodsRepostroty</span> <span class="token keyword">extends</span> <span class="token class-name">ElasticsearchRepository</span><span class="token generics function"><span class="token punctuation">&lt;</span>Goods<span class="token punctuation">,</span>Long<span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>


    List<span class="token generics function"><span class="token punctuation">&lt;</span>Goods<span class="token punctuation">&gt;</span></span> <span class="token function">findByTitle</span><span class="token punctuation">(</span>String title<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre> 
<p><mark>自定义方法关键字</mark><br> <img src="https://images2.imgbox.com/d8/65/oaZtYR0L_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/fe/62/44IFa0Y1_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/f3/32/Gxc0yTXJ_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/4c/3c/a6jQagWX_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="643__1496"></a>6.4.3 原生查询</h4> 
<p>查询条件的构建是通过一个名为<code>NativeSearchQueryBuilder</code>的类来完成的</p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@Test</span>
      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">nativeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception<span class="token punctuation">{<!-- --></span>
          NativeSearchQueryBuilder nativeSearchQueryBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NativeSearchQueryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          nativeSearchQueryBuilder<span class="token punctuation">.</span><span class="token function">withQuery</span><span class="token punctuation">(</span>QueryBuilders<span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">"title"</span><span class="token punctuation">,</span><span class="token string">"手机"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          AggregatedPage<span class="token generics function"><span class="token punctuation">&lt;</span>Goods<span class="token punctuation">&gt;</span></span> goods <span class="token operator">=</span> elasticsearchTemplate<span class="token punctuation">.</span><span class="token function">queryForPage</span><span class="token punctuation">(</span>nativeSearchQueryBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Goods<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          List<span class="token generics function"><span class="token punctuation">&lt;</span>Goods<span class="token punctuation">&gt;</span></span> goodsList <span class="token operator">=</span> goods<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span>Goods goods1 <span class="token operator">:</span> goodsList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>goods1<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
</code></pre> 
<p><mark>分页和排序</mark></p> 
<pre><code class="prism language-java"> <span class="token annotation punctuation">@Test</span>
      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">nativeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception<span class="token punctuation">{<!-- --></span>
          NativeSearchQueryBuilder nativeSearchQueryBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NativeSearchQueryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          nativeSearchQueryBuilder<span class="token punctuation">.</span><span class="token function">withQuery</span><span class="token punctuation">(</span>QueryBuilders<span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">"title"</span><span class="token punctuation">,</span><span class="token string">"手机"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//         当前页码是从0开始的</span>
<span class="token comment">//          分页和排序</span>
          nativeSearchQueryBuilder<span class="token punctuation">.</span><span class="token function">withPageable</span><span class="token punctuation">(</span>PageRequest<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span> Sort<span class="token punctuation">.</span><span class="token function">by</span><span class="token punctuation">(</span>Sort<span class="token punctuation">.</span>Direction<span class="token punctuation">.</span>DESC<span class="token punctuation">,</span><span class="token string">"price"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          AggregatedPage<span class="token generics function"><span class="token punctuation">&lt;</span>Goods<span class="token punctuation">&gt;</span></span> goods <span class="token operator">=</span> elasticsearchTemplate<span class="token punctuation">.</span><span class="token function">queryForPage</span><span class="token punctuation">(</span>nativeSearchQueryBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Goods<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          List<span class="token generics function"><span class="token punctuation">&lt;</span>Goods<span class="token punctuation">&gt;</span></span> goodsList <span class="token operator">=</span> goods<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span>Goods goods1 <span class="token operator">:</span> goodsList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>goods1<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
</code></pre> 
<p><mark>聚合</mark></p> 
<pre><code class="prism language-java"> <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">nativeAggQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception<span class="token punctuation">{<!-- --></span>

       NativeSearchQueryBuilder nativeSearchQueryBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NativeSearchQueryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       TermsAggregationBuilder aggregationBuilder <span class="token operator">=</span> AggregationBuilders<span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">"brand_agg"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"brand"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       nativeSearchQueryBuilder<span class="token punctuation">.</span><span class="token function">addAggregation</span><span class="token punctuation">(</span>aggregationBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
       AggregatedPage<span class="token generics function"><span class="token punctuation">&lt;</span>Goods<span class="token punctuation">&gt;</span></span> agg <span class="token operator">=</span> elasticsearchTemplate<span class="token punctuation">.</span><span class="token function">queryForPage</span><span class="token punctuation">(</span>nativeSearchQueryBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Goods<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       Aggregations aggregations <span class="token operator">=</span> agg<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       Aggregation brand_agg <span class="token operator">=</span> aggregations<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"brand_agg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>brand_agg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        List<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Terms<span class="token punctuation">.</span>Bucket</span><span class="token operator">&gt;</span> buckets <span class="token operator">=</span> terms<span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        buckets<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>bucket<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>bucket<span class="token punctuation">.</span><span class="token function">getKeyAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>bucket<span class="token punctuation">.</span><span class="token function">getDocCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
</code></pre> 
<p><mark>高亮</mark></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6e8c60efcf9b18233d55906a9b5fbf52/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">二十三.Python学习笔记.5</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a985877e103be75ef4b84db2ee4aeb3c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Numpy（Python）创建数组方式</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>