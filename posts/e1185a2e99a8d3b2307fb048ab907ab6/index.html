<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>yolov5踩坑记录：标签错位（PIL读取图片方向异常） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="yolov5踩坑记录：标签错位（PIL读取图片方向异常）" />
<meta property="og:description" content="PIL踩坑记录：读取图片方向异常（yolov5标签错位） 奇怪的现象 今天用 YOLOv5 做项目时，对数据集的标记出现了奇怪的现象，在下述测试用例中可明显看到，标记框偏离了物体，故发文阐述原因和解决方法. ——©️ Sylvan Ding 转载需注明出处！
下载了一份数据集UNIMIB2016，使用 PIL 读取其中一张照片并标记 bbox.
from PIL import Image img_name = &#39;20151127_120643.jpg&#39; img = Image.open(img_name) img.show() from PIL import ImageDraw from PIL import ImageFont label_name = &#39;20151127_120643.txt&#39; with open(label_name) as file: items = file.readlines() draw = ImageDraw.Draw(img) for item in items: item = item.split() # convert str to int item[1:] = list(map(int, item[1:])) # draw bbox draw.rectangle([item[1], item[2], item[5], item[6]], outline=&#34;red&#34;, width=20) # add text about order of the points for j, i in enumerate([1, 3, 5, 7]): j = j &#43; 1 draw." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/e1185a2e99a8d3b2307fb048ab907ab6/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-26T14:41:13+08:00" />
<meta property="article:modified_time" content="2022-04-26T14:41:13+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">yolov5踩坑记录：标签错位（PIL读取图片方向异常）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="PILyolov5_0"></a>PIL踩坑记录：读取图片方向异常（yolov5标签错位）</h2> 
<h3><a id="_2"></a>奇怪的现象</h3> 
<p>今天用 <strong>YOLOv5</strong> 做项目时，对数据集的标记出现了奇怪的现象，在下述测试用例中可明显看到，标记框偏离了物体，故发文阐述原因和解决方法. ——©️ <a href="https://blog.csdn.net/IYXUAN">Sylvan Ding</a> <em>转载需注明出处</em>！</p> 
<p><img src="https://images2.imgbox.com/c4/ff/ySmOLawZ_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>下载了一份数据集<code>UNIMIB2016</code>，使用 PIL 读取其中一张照片并标记 bbox.</p> 
</blockquote> 
<pre><code class="prism language-python"><span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image

img_name <span class="token operator">=</span> <span class="token string">'20151127_120643.jpg'</span>
img <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>img_name<span class="token punctuation">)</span>
img<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/bb/e6/ISIDmKRH_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> PIL <span class="token keyword">import</span> ImageDraw
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> ImageFont

label_name <span class="token operator">=</span> <span class="token string">'20151127_120643.txt'</span>
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>label_name<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>
    items <span class="token operator">=</span> <span class="token builtin">file</span><span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
draw <span class="token operator">=</span> ImageDraw<span class="token punctuation">.</span>Draw<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
<span class="token keyword">for</span> item <span class="token keyword">in</span> items<span class="token punctuation">:</span>
  
    item <span class="token operator">=</span> item<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment"># convert str to int</span>
    item<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> item<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token comment"># draw bbox</span>
    draw<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span><span class="token punctuation">[</span>item<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> item<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> item<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> item<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                       outline<span class="token operator">=</span><span class="token string">"red"</span><span class="token punctuation">,</span> width<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span>
    
    <span class="token comment"># add text about order of the points</span>
    <span class="token keyword">for</span> j<span class="token punctuation">,</span> i <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        j <span class="token operator">=</span> j <span class="token operator">+</span> <span class="token number">1</span>
        draw<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">[</span>item<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> item<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">)</span>

img<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
<span class="token comment"># items</span>
<span class="token comment"># ['pane 2008 404 2713 404 2713 915 2008 915\n',</span>
<span class="token comment">#  'pizzoccheri 1502 1104 2500 1104 2500 1984 1502 1984\n',</span>
<span class="token comment">#  'arrosto 634 602 1193 602 1193 1371 634 1371\n',</span>
<span class="token comment">#  'patate/pure 271 539 708 539 708 1408 271 1408\n']</span>

<span class="token comment"># the lash item, whose form is [cls, x1, y1, x2, y2, x3, y3, x4, y4]</span>
<span class="token comment"># ['patate/pure', 271, 539, 708, 539, 708, 1408, 271, 1408]</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/30/81/EbLfAfED_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>bbox 正确，但整张图片好似被旋转了一样。接着使用 cv2 进行相同操作，并观察结果。</p> 
</blockquote> 
<pre><code class="prism language-python"><span class="token keyword">import</span> cv2
<span class="token keyword">from</span> matplotlib <span class="token keyword">import</span> pyplot <span class="token keyword">as</span> plt

img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>img_name<span class="token punctuation">)</span>
img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>img<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2RGB<span class="token punctuation">)</span>

<span class="token keyword">for</span> item <span class="token keyword">in</span> items<span class="token punctuation">:</span>

    item <span class="token operator">=</span> item<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># convert str to int</span>
    item<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> item<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># draw bbox</span>
    cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span> img<span class="token punctuation">,</span>
                  <span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> item<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  <span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> item<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span>

plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/ed/f4/vO0NTX38_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>不难发现，<code>draw bbox</code> 中使用的坐标均为 <code>[x1,y1], [x3, y3]</code>，即对角坐标（left-top、right-bottom），但 <code>PIL</code> 和 <code>cv2</code> 的结果不同。<code>cv2</code> 中 bbox 错位了，而 <code>PIL</code> 中 text 发生了旋转.</p> 
</blockquote> 
<p>😯 为什么会产生这种现象呢？从 EXIT 说起：</p> 
<h3><a id="EXIF_94"></a>什么是EXIF?</h3> 
<p><strong>EXIF</strong>(Exchangeable Image File)是"可交换图像文件"的缩写，当中包含了专门为数码相机的照片而定制的元数据，可以记录数码照片的拍摄参数、缩略图及其他属性信息。Exif 文件实际是JPEG文件的一种，遵从JPEG标准，只是在文件头信息中增加了有关拍摄信息的内容和索引图。</p> 
<p>简单来说，Exif 信息就是由数码相机在拍摄过程中采集一系列的信息，然后把信息放置在我们熟知的 JPEG/TIFF 文件的头部，也就是说 Exif信息是镶嵌在 JPEG/TIFF 图像文件格式内的一组拍摄参数，它就好像是傻瓜相机的日期打印功能一样，只不过 Exif信息所记录的资讯更为详尽和完备。</p> 
<h3><a id="EXIF_Orientation_tag_100"></a>EXIF Orientation tag</h3> 
<p><strong>EXIF Orientation tag</strong>（EXIF方向参数）让你随便照像但都可以看到正确方向的照片而无需手动旋转（前提要图片浏览器支持，Windows 自带的不支持）.</p> 
<p><img src="https://images2.imgbox.com/41/e3/fvET1xHt_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="__107"></a>⭐️ 原因解释</h3> 
<p>造成第一目中“奇怪现象”的原因，我将其归纳为：在标记数据集时，不关注图像的 EXIF Orientation tag，而图像本身是含有 EXIF Orientation tag 的。在 <code>PIL</code> 读取图片时，创建了 <code>Image</code> 对象，其中存有 EXIF Orientation tag，根据该标记，不仅旋转了图像，还旋转了图像的参考系。而 <code>cv2</code> 读取图片时，直接生成 <code>numpy.ndarray</code> 数组，只根据 EXIF Orientation tag 对图像进行了旋转，但并<strong>没有旋转图像的参考系</strong>！</p> 
<h4><a id="PIL_111"></a>PIL</h4> 
<p><img src="https://images2.imgbox.com/61/d5/fyqkitt7_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/28/b1/TL2hpHFV_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="cv2_119"></a>cv2</h4> 
<p><img src="https://images2.imgbox.com/c4/a0/7p9nQTbd_o.png" alt="在这里插入图片描述"></p> 
<p>在绘制矩形框时，二者依赖的参考系不同，导致标记的错位。而 yolov5 使用的正是 cv2，故读取含 EXIF Orientation tag 的图片时，会造成 labels 和 图片的错位。</p> 
<h3><a id="_126"></a>原因证实</h3> 
<blockquote> 
 <p>PIL 的 <code>PIL.ImageOps.exif_transpose(image)</code>方法，可以在读取图片后，清除 <code>Image</code> 对象内的 EXIF Orientation tag，从而让坐标系不受该 tag 的影响.</p> 
</blockquote> 
<pre><code class="prism language-python"><span class="token keyword">from</span> PIL <span class="token keyword">import</span> ImageOps

img <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>img_name<span class="token punctuation">)</span>
img <span class="token operator">=</span> ImageOps<span class="token punctuation">.</span>exif_transpose<span class="token punctuation">(</span>img<span class="token punctuation">)</span>

<span class="token comment"># draw bbox</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/02/fc/BkR2cvlR_o.png" alt="1"></p> 
<p>可见，清除 EXIF 旋转信息后，PIL 所得结果和 cv2 结果一致！</p> 
<h3><a id="__145"></a>⭐️ 解决方法</h3> 
<blockquote> 
 <p>❤️ 当然，如果你有更好的方法欢迎在评论区留言告诉我哦！</p> 
</blockquote> 
<pre><code class="prism language-python"><span class="token keyword">from</span> os <span class="token keyword">import</span> listdir
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

img <span class="token operator">=</span> <span class="token string">'./images/'</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> img_name <span class="token keyword">in</span> listdir<span class="token punctuation">(</span>img_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        img <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>img_path <span class="token operator">+</span> img_name<span class="token punctuation">)</span>
        img_rectified <span class="token operator">=</span> Image<span class="token punctuation">.</span>fromarray<span class="token punctuation">(</span>np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">)</span>
        img_rectified<span class="token punctuation">.</span>save<span class="token punctuation">(</span>img_path <span class="token operator">+</span> img_name<span class="token punctuation">)</span>
</code></pre> 
<blockquote> 
 <p>上述代码对 <code>./images/</code>文件夹下所有图片进行了“修正”，核心是 <code>img_rectified = Image.fromarray(np.asarray(img))</code>，(1). 将 <code>img</code> 转化为 <code>ndarray</code>，(2). 再将该<code>ndarray</code>转化为<code>Image</code>并保存.</p> 
</blockquote> 
<p>(1)、(2) 等同于去除了图片所有的 EXIF 信息，这样图片就不会再发生“自动旋转”的现象了.</p> 
<p><img src="https://images2.imgbox.com/a2/07/OUJ60QWI_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>转载请注明出处：©️ <a href="https://blog.csdn.net/IYXUAN">Sylvan Ding</a></p> 
</blockquote> 
<h3><a id="_171"></a>参考文献</h3> 
<ol><li><a href="https://stackoverflow.com/questions/4228530/pil-thumbnail-is-rotating-my-image" rel="nofollow">PIL thumbnail is rotating my image?</a></li><li><a href="https://zhuanlan.zhihu.com/p/366726838" rel="nofollow">图片元信息Exif，给你详细讲讲</a></li><li><a href="https://blog.csdn.net/happy08god/article/details/11528479">EXIF 方向参数 Orientation</a></li></ol>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/baac1b9795ff975ff8188d36940b526d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Pytorch学习笔记（16）———预训练模型微调</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/aea3e20406e1361111a02ab83bdc6253/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Trie树实现前缀自动补全 &#43; AC自动机实现敏感词过滤</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>