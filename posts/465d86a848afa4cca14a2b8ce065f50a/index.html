<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>架构师必备--高可用高性能分布式数据库Tidb安装部署实践 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="架构师必备--高可用高性能分布式数据库Tidb安装部署实践" />
<meta property="og:description" content="本文针对分布式、高可用的tidb数据库，从搭建实际生产环境的集群服务，介绍下tidb的安装流程、安装前的环境检测和系统优化、服务访问等方面介绍下具体的流程，希望对大家熟悉和了解tidb数据库有所帮助，减少不必要的弯路。
1.概述 Tidb是PingCAP公司自主设计、研发的开源分布式关系型数据库，同时支持在线事务处理与在线分析处理(HTAP)的融合型分布式数据库产品,具备水平扩容或者缩容、金融级高可用。TiDB 适合高可用、强一致要求较高、数据规模较大等各种应用场景。
2.硬件要求 生产环境最低要求如下：
开发及测试最低要求如下：
以上是tidb数据库的常用组件，本文只安装tidb、pd、tikv和监控组件
3.安装前环境检查及系统优化 3.1 磁盘挂载 生产环境部署，建议使用 EXT4 类型文件系统的 NVME 类型的 SSD 磁盘存储 TiKV 数据文件。这个配置方案为最佳实施方案，其可靠性、安全性、稳定性已经在大量线上场景中得到证实。
使用root用户登录目标机器，将部署目标机器数据盘格式化成 ext4 文件系统，挂载时添加nodelalloc和noatime挂载参数。nodelalloc是必选参数，否则 TiUP 安装时检测无法通过；noatime是可选建议参数。
注意
如果你的数据盘已经格式化成 ext4 并挂载了磁盘，可先执行 umount /dev/nvme0n1p1 命令卸载，从编辑 /etc/fstab 文件步骤开始执行，添加挂载参数重新挂载即可。
3.1.1查看数据盘 fdisk -l 3.1.2创建分区 parted -s -a optimal /dev/nvme0n1 mklabel gpt -- mkpart primary ext4 1 -1 注意
使用 lsblk 命令查看分区的设备号：对于 nvme 磁盘，生成的分区设备号一般为 nvme0n1p1；对于普通磁盘（例如 /dev/sdb），生成的分区设备号一般为 sdb1。
3.1.3格式化文件系统 mkfs.ext4 /dev/nvme0n1p1 3.1.4查看数据盘分区 UUID lsblk -f 3.1.5编辑 /etc/fstab 文件 添加 nodelalloc 挂载参数。 执行如下命令进入fstab文件，然后将文本添加到最后一行并保存" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/465d86a848afa4cca14a2b8ce065f50a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-19T12:18:53+08:00" />
<meta property="article:modified_time" content="2023-08-19T12:18:53+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">架构师必备--高可用高性能分布式数据库Tidb安装部署实践</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>本文针对分布式、高可用的tidb数据库，从搭建实际生产环境的集群服务，介绍下tidb的安装流程、安装前的环境检测和系统优化、服务访问等方面介绍下具体的流程，希望对大家熟悉和了解tidb数据库有所帮助，减少不必要的弯路。</p> 
<h2><a id="1_2"></a>1.概述</h2> 
<p>Tidb是PingCAP公司自主设计、研发的开源分布式关系型数据库，同时支持在线事务处理与在线分析处理(HTAP)的融合型分布式数据库产品,具备水平扩容或者缩容、金融级高可用。TiDB 适合高可用、强一致要求较高、数据规模较大等各种应用场景。</p> 
<h2><a id="2_6"></a>2.硬件要求</h2> 
<p>生产环境最低要求如下：<br> <img src="https://images2.imgbox.com/8f/75/gQGxlY4h_o.png" alt="在这里插入图片描述"></p> 
<p>开发及测试最低要求如下：<br> <img src="https://images2.imgbox.com/2f/38/5qBSh9PF_o.png" alt="在这里插入图片描述"><br> 以上是tidb数据库的常用组件，本文只安装tidb、pd、tikv和监控组件</p> 
<h2><a id="3_15"></a>3.安装前环境检查及系统优化</h2> 
<h3><a id="31__16"></a>3.1 磁盘挂载</h3> 
<p>生产环境部署，建议使用 EXT4 类型文件系统的 NVME 类型的 SSD 磁盘存储 TiKV 数据文件。这个配置方案为最佳实施方案，其可靠性、安全性、稳定性已经在大量线上场景中得到证实。</p> 
<p>使用root用户登录目标机器，将部署目标机器数据盘格式化成 ext4 文件系统，挂载时添加nodelalloc和noatime挂载参数。nodelalloc是必选参数，否则 TiUP 安装时检测无法通过；noatime是可选建议参数。</p> 
<p><strong><code>注意</code></strong><br> 如果你的数据盘已经格式化成 ext4 并挂载了磁盘，可先执行 umount /dev/nvme0n1p1 命令卸载，从编辑 /etc/fstab 文件步骤开始执行，添加挂载参数重新挂载即可。</p> 
<h4><a id="311_24"></a>3.1.1查看数据盘</h4> 
<pre><code class="prism language-java">fdisk <span class="token operator">-</span>l
</code></pre> 
<h4><a id="312_29"></a>3.1.2创建分区</h4> 
<pre><code class="prism language-java">parted <span class="token operator">-</span>s <span class="token operator">-</span>a optimal <span class="token operator">/</span>dev<span class="token operator">/</span>nvme0n1 mklabel gpt <span class="token operator">--</span> mkpart primary ext4 <span class="token number">1</span> <span class="token operator">-</span><span class="token number">1</span>
</code></pre> 
<p><strong><code>注意</code></strong></p> 
<p>使用 lsblk 命令查看分区的设备号：对于 nvme 磁盘，生成的分区设备号一般为 nvme0n1p1；对于普通磁盘（例如 /dev/sdb），生成的分区设备号一般为 sdb1。</p> 
<h4><a id="313_37"></a>3.1.3格式化文件系统</h4> 
<pre><code class="prism language-java">mkfs<span class="token punctuation">.</span>ext4 <span class="token operator">/</span>dev<span class="token operator">/</span>nvme0n1p1
</code></pre> 
<h4><a id="314_UUID_43"></a>3.1.4查看数据盘分区 UUID</h4> 
<pre><code class="prism language-java">lsblk <span class="token operator">-</span>f
</code></pre> 
<p><img src="https://images2.imgbox.com/b7/4a/qKYOZCCS_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="315_etcfstab__52"></a>3.1.5编辑 /etc/fstab 文件</h4> 
<p>添加 nodelalloc 挂载参数。 执行如下命令进入fstab文件，然后将文本添加到最后一行并保存</p> 
<pre><code class="prism language-java">vi <span class="token operator">/</span>etc<span class="token operator">/</span>fstab
</code></pre> 
<p>文本内容如下：</p> 
<pre><code class="prism language-java"><span class="token constant">UUID</span><span class="token operator">=</span>c51eb23b<span class="token operator">-</span><span class="token number">195</span>c<span class="token operator">-</span><span class="token number">4061</span><span class="token operator">-</span><span class="token number">92</span>a9<span class="token operator">-</span><span class="token number">3f</span>ad812cc12f <span class="token operator">/</span>data1 ext4 defaults<span class="token punctuation">,</span>nodelalloc<span class="token punctuation">,</span>noatime <span class="token number">0</span> <span class="token number">2</span>
</code></pre> 
<p>上述的uuid要换成3.1.4步骤中机器实际的uuid，/data1换成服务器上实际被挂载的目录</p> 
<h4><a id="316_64"></a>3.1.6挂载数据盘</h4> 
<pre><code class="prism language-java">mount <span class="token operator">-</span>a
</code></pre> 
<h4><a id="317_ext4_nodelalloc_70"></a>3.1.7执行以下命令，如果文件系统为 ext4，并且挂载参数中包含 nodelalloc，则表示已生效。</h4> 
<pre><code class="prism language-java">mount <span class="token operator">-</span>t ext4
</code></pre> 
<h3><a id="32__75"></a>3.2 关闭防火墙</h3> 
<p>关闭命令</p> 
<pre><code class="prism language-java">systemctl stop firewalld<span class="token punctuation">.</span>service
</code></pre> 
<p>关闭防火墙自启动服务</p> 
<pre><code class="prism language-java">systemctl disable firewalld<span class="token punctuation">.</span>service
</code></pre> 
<p>检查防火墙状态</p> 
<pre><code class="prism language-java">systemctl status firewalld<span class="token punctuation">.</span>service
</code></pre> 
<h3><a id="33_swap_93"></a>3.3 检测及关闭系统swap</h3> 
<p>TiDB 运行需要有足够的内存。如果内存不足，不建议使用 swap 作为内存不足的缓冲，因为这会降低性能。建议永久关闭系统 swap。</p> 
<p>执行如下命令关闭：</p> 
<pre><code class="prism language-java">echo <span class="token string">"vm.swappiness = 0"</span><span class="token operator">&gt;&gt;</span> <span class="token operator">/</span>etc<span class="token operator">/</span>sysctl<span class="token punctuation">.</span>conf

swapoff <span class="token operator">-</span>a <span class="token operator">&amp;&amp;</span> swapon <span class="token operator">-</span>a

sysctl <span class="token operator">-</span>p
</code></pre> 
<h3><a id="34_NTP_106"></a>3.4 检测及安装NTP服务</h3> 
<p>TiDB 是一套分布式数据库系统，需要节点间保证时间的同步，从而确保 ACID 模型的事务线性一致性</p> 
<h4><a id="341running_NTP__109"></a>3.4.1执行以下命令，如果输出running表示 NTP 服务正在运行</h4> 
<pre><code class="prism language-java">sudo systemctl status ntpd<span class="token punctuation">.</span>service
</code></pre> 
<p><img src="https://images2.imgbox.com/e7/ab/NkBsfe7J_o.png" alt="在这里插入图片描述"></p> 
<p>若返回报错信息Unit ntpd.service could not be found.，请尝试执行以下命令，以查看与NTP进行时钟同步所使用的系统配置是chronyd还是ntpd：</p> 
<pre><code class="prism language-java">sudo systemctl status chronyd<span class="token punctuation">.</span>service
</code></pre> 
<h4><a id="342__ntpstat__NTP__121"></a>3.4.2 执行 ntpstat 命令检测是否与 NTP 服务器同步</h4> 
<pre><code class="prism language-java">ntpstat
</code></pre> 
<p>如果输出synchronised to NTP server，表示正在与 NTP 服务器正常同步<br> 如果系统使用的是ntpd时间同步服务，可忽略3.4.3步骤</p> 
<h4><a id="343chronyc_tracking_Chrony__NTP__129"></a>3.4.3执行chronyc tracking命令查看 Chrony 服务是否与 NTP 服务器同步。</h4> 
<pre><code class="prism language-java">chronyc tracking
</code></pre> 
<p>注意：该操作仅适用于使用 Chrony 的系统，不适用于使用 NTPd 的系统。<br> 如果该命令返回结果如下，则表示 Chrony 服务未正常运行：需要手动启动该服务<br> 启动chronyd服务并设置自启动:</p> 
<pre><code class="prism language-java">systemctl start chronyd   启动服务
systemctl status chronyd  查看状态
systemctl enable chronyd  设置开机自启
</code></pre> 
<h3><a id="35__146"></a>3.5 操作系统检查及参数优化</h3> 
<p>在生产系统的 TiDB 中，建议对操作系统进行如下的配置优化：</p> 
<ol><li>关闭透明大页（即 Transparent Huge Pages，缩写为 THP）。</li><li>将存储介质的 I/O 调度器设置为 noop。</li><li>为调整 CPU 频率的 cpufreq 模块选用 performance 模式。</li></ol> 
<p><strong>检查流程：</strong></p> 
<h4><a id="351_155"></a>3.5.1执行以下命令查看透明大页的开启状态</h4> 
<pre><code class="prism language-java">cat <span class="token operator">/</span>sys<span class="token operator">/</span>kernel<span class="token operator">/</span>mm<span class="token operator">/</span>transparent_hugepage<span class="token operator">/</span>enabled
</code></pre> 
<p><img src="https://images2.imgbox.com/89/bd/PMIbB2wT_o.png" alt="在这里插入图片描述"></p> 
<p>[always] madvise never表示透明大页处于启用状态，需要关闭。</p> 
<h4><a id="352__IO__164"></a>3.5.2 执行以下命令查看数据目录所在磁盘的 I/O 调度器。</h4> 
<pre><code class="prism language-java">cat <span class="token operator">/</span>sys<span class="token operator">/</span>block<span class="token operator">/</span>sda<span class="token operator">/</span>queue<span class="token operator">/</span>scheduler
</code></pre> 
<p><img src="https://images2.imgbox.com/4f/ff/zyjWhU6y_o.png" alt="在这里插入图片描述"></p> 
<p>noop [deadline] cfq 表示磁盘的I/O 调度器使用deadline，需要进行修改。</p> 
<h4><a id="353__ID_SERIAL_172"></a>3.5.3 执行以下命令查看磁盘的唯一标识 ID_SERIAL。</h4> 
<pre><code class="prism language-java">udevadm info <span class="token operator">--</span>name<span class="token operator">=</span><span class="token operator">/</span>dev<span class="token operator">/</span>sda <span class="token operator">|</span> grep <span class="token constant">ID_SERIAL</span>
</code></pre> 
<p>如果多个磁盘都分配了数据目录，需要多次执行以上命令，记录所有磁盘各自的唯一标识。</p> 
<h4><a id="354__cpufreq__179"></a>3.5.4 执行以下命令查看 cpufreq 模块选用的节能策略。</h4> 
<pre><code class="prism language-java">cpupower frequency<span class="token operator">-</span>info –policy
</code></pre> 
<p><img src="https://images2.imgbox.com/6e/dd/npdYkGNQ_o.png" alt="在这里插入图片描述"></p> 
<p>The governor “powersave” 表示 cpufreq 的节能策略使用 powersave，需要调整为 performance 策略。</p> 
<p><strong>优化流程：</strong></p> 
<p>a、执行 tuned-adm list 命令查看当前操作系统的 tuned 策略。</p> 
<pre><code class="prism language-java">tuned<span class="token operator">-</span>adm list
</code></pre> 
<p>Current active profile: balanced 表示当前操作系统的 tuned 策略使用 balanced，建议在当前策略的基础上添加操作系统优化配置。</p> 
<p>b、创建新的 tuned 策略。(ID_SERIAL要换成检查流程第3步中实际的磁盘唯一标识符)</p> 
<pre><code class="prism language-java">mkdir <span class="token operator">/</span>etc<span class="token operator">/</span>tuned<span class="token operator">/</span>balanced<span class="token operator">-</span>tidb<span class="token operator">-</span>optimal<span class="token operator">/</span>
vi <span class="token operator">/</span>etc<span class="token operator">/</span>tuned<span class="token operator">/</span>balanced<span class="token operator">-</span>tidb<span class="token operator">-</span>optimal<span class="token operator">/</span>tuned<span class="token punctuation">.</span>conf
</code></pre> 
<p>在文件中添加如下配置</p> 
<pre><code class="prism language-java"><span class="token punctuation">[</span>main<span class="token punctuation">]</span>
include<span class="token operator">=</span>balanced

<span class="token punctuation">[</span>cpu<span class="token punctuation">]</span>
governor<span class="token operator">=</span>performance

<span class="token punctuation">[</span>vm<span class="token punctuation">]</span>
transparent_hugepages<span class="token operator">=</span>never

<span class="token punctuation">[</span>disk<span class="token punctuation">]</span>
devices_udev_regex<span class="token operator">=</span><span class="token punctuation">(</span><span class="token constant">ID_SERIAL</span><span class="token operator">=</span><span class="token number">36d</span><span class="token number">0946606d</span><span class="token number">79f</span><span class="token number">90025f</span><span class="token number">3e09</span>a0c1fc035<span class="token punctuation">)</span>
elevator<span class="token operator">=</span>noop
</code></pre> 
<p>c、应用新的 tuned 策略。</p> 
<pre><code class="prism language-java">tuned<span class="token operator">-</span>adm profile balanced<span class="token operator">-</span>tidb<span class="token operator">-</span>optimal
</code></pre> 
<p>d、执行以下命令验证透明大页的状态</p> 
<pre><code class="prism language-java"> cat <span class="token operator">/</span>sys<span class="token operator">/</span>kernel<span class="token operator">/</span>mm<span class="token operator">/</span>transparent_hugepage<span class="token operator">/</span>enabled
</code></pre> 
<p>e、执行以下命令命令验证数据目录所在磁盘的 I/O 调度器。</p> 
<pre><code class="prism language-java">cat <span class="token operator">/</span>sys<span class="token operator">/</span>block<span class="token operator">/</span>sda<span class="token operator">/</span>queue<span class="token operator">/</span>scheduler
</code></pre> 
<p>f、执行以下命令查看查看 cpufreq 模块选用的节能策略。</p> 
<pre><code class="prism language-java">cpupower frequency<span class="token operator">-</span>info –policy
</code></pre> 
<p>g、执行以下命令修改 sysctl 参数。</p> 
<pre><code class="prism language-java">echo <span class="token string">"fs.file-max = 1000000"</span><span class="token operator">&gt;&gt;</span> <span class="token operator">/</span>etc<span class="token operator">/</span>sysctl<span class="token punctuation">.</span>conf
echo <span class="token string">"net.core.somaxconn = 32768"</span><span class="token operator">&gt;&gt;</span> <span class="token operator">/</span>etc<span class="token operator">/</span>sysctl<span class="token punctuation">.</span>conf
echo <span class="token string">"net.ipv4.tcp_tw_recycle = 0"</span><span class="token operator">&gt;&gt;</span> <span class="token operator">/</span>etc<span class="token operator">/</span>sysctl<span class="token punctuation">.</span>conf
echo <span class="token string">"net.ipv4.tcp_syncookies = 0"</span><span class="token operator">&gt;&gt;</span> <span class="token operator">/</span>etc<span class="token operator">/</span>sysctl<span class="token punctuation">.</span>conf
echo <span class="token string">"vm.overcommit_memory = 1"</span><span class="token operator">&gt;&gt;</span> <span class="token operator">/</span>etc<span class="token operator">/</span>sysctl<span class="token punctuation">.</span>conf
sysctl <span class="token operator">-</span>p
</code></pre> 
<p>h、执行以下命令查配置用户的limits.conf文件</p> 
<pre><code class="prism language-java">cat <span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&lt;</span> EOF <span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token operator">/</span>etc<span class="token operator">/</span>security<span class="token operator">/</span>limits<span class="token punctuation">.</span>conf
tidb           soft    nofile          <span class="token number">1000000</span>
tidb           hard    nofile          <span class="token number">1000000</span>
tidb           soft    stack          <span class="token number">32768</span>
tidb           hard    stack          <span class="token number">32768</span>
<span class="token constant">EOF</span>
</code></pre> 
<p>此外，由于集群服务是安装在多台服务器上，所以需要设置机器之间ssh互信和sudo免密访问，但是如果使用tiup组件管理器，可以不用进行此操作，因为tiup可以自动设置互信和免密。至此，安装前的准备工作已完成，接下来就行实际安装流程。</p> 
<h2><a id="4_269"></a>4.搭建集群服务</h2> 
<h3><a id="41_TiUP_271"></a>4.1 下载并安装TiUP</h3> 
<pre><code class="prism language-java">curl <span class="token operator">--</span>proto <span class="token char">'=https'</span> <span class="token operator">--</span>tlsv1<span class="token punctuation">.</span><span class="token number">2</span> <span class="token operator">-</span>sSf https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>tiup<span class="token operator">-</span>mirrors<span class="token punctuation">.</span>pingcap<span class="token punctuation">.</span>com<span class="token operator">/</span>install<span class="token punctuation">.</span>sh <span class="token operator">|</span> sh
</code></pre> 
<p><img src="https://images2.imgbox.com/54/51/yc5T7Rv0_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="42__277"></a>4.2 声明全局环境变量</h3> 
<p>source ${your_shell_profile}<br> <img src="https://images2.imgbox.com/91/36/OeMclcaM_o.png" alt="在这里插入图片描述"><br> TiUP 安装完成后会提示对应 Shell profile 文件的绝对路径。在执行以下 source 命令前，需要将 ${your_shell_profile} 修改为 Shell profile 文件的实际位置</p> 
<h3><a id="43__TiUP__cluster__283"></a>4.3 安装 TiUP 的 cluster 组件</h3> 
<pre><code class="prism language-java">tiup cluster
</code></pre> 
<h3><a id="44__289"></a>4.4 创建并启动集群</h3> 
<p>安装集群前，需要先创建集群的拓扑文件，此处可以直接先在本地创建好，比如topo.yanl，复制以下内容，然后传到服务器即可。文件中路径和ip根据实际情况声明</p> 
<pre><code class="prism language-java"># # <span class="token class-name">Global</span> variables are applied <span class="token keyword">to</span> <span class="token namespace">all</span> deployments and used as the <span class="token keyword">default</span> value of
# # the deployments <span class="token keyword">if</span> a specific deployment value is missing<span class="token punctuation">.</span>
global<span class="token operator">:</span>
  user<span class="token operator">:</span> <span class="token string">"tidb"</span>
  ssh_port<span class="token operator">:</span> <span class="token number">22</span>
  deploy_dir<span class="token operator">:</span> <span class="token string">"/tidb-deploy"</span>  #该路径最好换成磁盘上实际挂载的目录下<span class="token punctuation">,</span>比如<span class="token operator">/</span>xxx<span class="token operator">/</span>tidb<span class="token operator">-</span>deploy
  data_dir<span class="token operator">:</span> <span class="token string">"/tidb-data"</span>      #该路径最好换成磁盘上实际挂载的目录下<span class="token punctuation">,</span>比如<span class="token operator">/</span>xxx<span class="token operator">/</span>tidb<span class="token operator">-</span>data

# # <span class="token class-name">Monitored</span> variables are applied <span class="token keyword">to</span> <span class="token namespace">all</span> the machines<span class="token punctuation">.</span>
monitored<span class="token operator">:</span>
  node_exporter_port<span class="token operator">:</span> <span class="token number">9100</span>
  blackbox_exporter_port<span class="token operator">:</span> <span class="token number">9115</span>

server_configs<span class="token operator">:</span>
  tidb<span class="token operator">:</span>
    log<span class="token punctuation">.</span>slow<span class="token operator">-</span>threshold<span class="token operator">:</span> <span class="token number">1000</span>
  tikv<span class="token operator">:</span>
    readpool<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>use<span class="token operator">-</span>unified<span class="token operator">-</span>pool<span class="token operator">:</span> <span class="token boolean">false</span>
    readpool<span class="token punctuation">.</span>coprocessor<span class="token punctuation">.</span>use<span class="token operator">-</span>unified<span class="token operator">-</span>pool<span class="token operator">:</span> <span class="token boolean">true</span>
  pd<span class="token operator">:</span>
    schedule<span class="token punctuation">.</span>leader<span class="token operator">-</span>schedule<span class="token operator">-</span>limit<span class="token operator">:</span> <span class="token number">4</span>
    schedule<span class="token punctuation">.</span>region<span class="token operator">-</span>schedule<span class="token operator">-</span>limit<span class="token operator">:</span> <span class="token number">2048</span>
    schedule<span class="token punctuation">.</span>replica<span class="token operator">-</span>schedule<span class="token operator">-</span>limit<span class="token operator">:</span> <span class="token number">64</span>

pd_servers<span class="token operator">:</span>
  <span class="token operator">-</span> host<span class="token operator">:</span> <span class="token number">10.0</span><span class="token number">.0</span><span class="token number">.1</span>
  <span class="token operator">-</span> host<span class="token operator">:</span> <span class="token number">10.0</span><span class="token number">.0</span><span class="token number">.1</span>
  <span class="token operator">-</span> host<span class="token operator">:</span> <span class="token number">10.0</span><span class="token number">.0</span><span class="token number">.1</span>

tidb_servers<span class="token operator">:</span>
  <span class="token operator">-</span> host<span class="token operator">:</span> <span class="token number">10.0</span><span class="token number">.0</span><span class="token number">.1</span>
  <span class="token operator">-</span> host<span class="token operator">:</span> <span class="token number">10.0</span><span class="token number">.0</span><span class="token number">.1</span>

tikv_servers<span class="token operator">:</span>
  <span class="token operator">-</span> host<span class="token operator">:</span> <span class="token number">10.0</span><span class="token number">.0</span><span class="token number">.1</span>	
  <span class="token operator">-</span> host<span class="token operator">:</span> <span class="token number">10.0</span><span class="token number">.0</span><span class="token number">.1</span>
  <span class="token operator">-</span> host<span class="token operator">:</span> <span class="token number">10.0</span><span class="token number">.0</span><span class="token number">.1</span>

monitoring_servers<span class="token operator">:</span>
  <span class="token operator">-</span> host<span class="token operator">:</span> <span class="token number">10.0</span><span class="token number">.0</span><span class="token number">.1</span>

grafana_servers<span class="token operator">:</span>
  <span class="token operator">-</span> host<span class="token operator">:</span> <span class="token number">10.0</span><span class="token number">.0</span><span class="token number">.1</span>

alertmanager_servers<span class="token operator">:</span>
  <span class="token operator">-</span> host<span class="token operator">:</span> <span class="token number">10.0</span><span class="token number">.0</span><span class="token number">.1</span>
</code></pre> 
<h3><a id="45_342"></a>4.5执行部署命令前，先检查环境是否满足要求</h3> 
<pre><code class="prism language-java">tiup cluster check  <span class="token punctuation">.</span>/topo<span class="token punctuation">.</span>yaml
</code></pre> 
<p>如果报错：Error：none of ssh password，identity file ，SSH_AUTH_SOCK specified，改成如下命令，</p> 
<pre><code class="prism language-java">tiup cluster check  <span class="token punctuation">.</span>/topo<span class="token punctuation">.</span>yaml <span class="token operator">--</span>user root <span class="token operator">-</span>p
</code></pre> 
<p>然后输入密码即可检查环境。如果环境检查不通过，使用如下命令自行修复</p> 
<pre><code class="prism language-java">tiup cluster check  <span class="token punctuation">.</span>/topo<span class="token punctuation">.</span>yaml <span class="token operator">--</span>apply <span class="token operator">--</span>user root <span class="token operator">-</span>p
</code></pre> 
<p>尽量保证检查的结果result栏为pass状态，如果没有绑核，numa绑核对应的那栏失败可以不用太关心，但是其他栏尽量都通过，最不济是warning状态</p> 
<h3><a id="46__362"></a>4.6 部署</h3> 
<p>命令如下：</p> 
<pre><code class="prism language-java">tiup cluster deploy <span class="token operator">&lt;</span>cluster<span class="token operator">-</span>name<span class="token operator">&gt;</span> <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span> <span class="token punctuation">.</span>/topo<span class="token punctuation">.</span>yaml <span class="token operator">--</span>user root <span class="token operator">-</span>p
</code></pre> 
<h3><a id="47__370"></a>4.7 启动集群</h3> 
<pre><code class="prism language-java">tiup cluster start <span class="token operator">&lt;</span>cluster<span class="token operator">-</span>name<span class="token operator">&gt;</span>
</code></pre> 
<h3><a id="48__375"></a>4.8 访问集群</h3> 
<p>安装 MySQL 客户端。如果已安装 MySQL 客户端则可跳过这一步骤。</p> 
<pre><code class="prism language-java">yum <span class="token operator">-</span>y install mysql
</code></pre> 
<p>访问 TiDB 数据库，密码为空，也可以使用数据库客户端连接</p> 
<pre><code class="prism language-java">mysql <span class="token operator">-</span>h <span class="token number">10.0</span><span class="token number">.1</span><span class="token number">.1</span> <span class="token operator">-</span><span class="token class-name">P</span> <span class="token number">4000</span> <span class="token operator">-</span>u root
</code></pre> 
<p><strong>访问 TiDB 的 Grafana 监控：</strong><br> 通过 http://{grafana-ip}:3000 访问集群 Grafana 监控页面，默认用户名和密码均为 admin。</p> 
<p><strong>访问 TiDB 的 Dashboard：</strong><br> 通过 http://{pd-ip}:2379/dashboard 访问集群 TiDB Dashboard 监控页面，默认用户名为 root，密码为空。<br> 执行以下命令查看集群的拓扑结构和状态：</p> 
<pre><code class="prism language-java">tiup cluster display <span class="token operator">&lt;</span>cluster<span class="token operator">-</span>name<span class="token operator">&gt;</span>
</code></pre> 
<p>到此，集群服务搭建完成，可以正常使用。<br> 以下为集群操作的几个常用命令</p> 
<p><strong>停止组件</strong><br> 例如，下列命令只停止 TiDB 组件：</p> 
<pre><code class="prism language-java">tiup cluster stop $<span class="token punctuation">{<!-- --></span>cluster<span class="token operator">-</span>name<span class="token punctuation">}</span> <span class="token operator">-</span><span class="token class-name">R</span> tidb
</code></pre> 
<p><strong>停止组件中的某一个节点</strong></p> 
<pre><code class="prism language-java">tiup cluster stop $<span class="token punctuation">{<!-- --></span>cluster<span class="token operator">-</span>name<span class="token punctuation">}</span> <span class="token operator">-</span><span class="token class-name">N</span> <span class="token number">10.0</span><span class="token number">.6</span><span class="token number">.194</span><span class="token operator">:</span><span class="token number">9090</span>
</code></pre> 
<p><strong>启动组件中的某一个节点</strong></p> 
<pre><code class="prism language-java">tiup cluster start $<span class="token punctuation">{<!-- --></span>cluster<span class="token operator">-</span>name<span class="token punctuation">}</span> <span class="token operator">-</span><span class="token class-name">N</span> <span class="token number">10.0</span><span class="token number">.6</span><span class="token number">.194</span><span class="token operator">:</span><span class="token number">9090</span>
</code></pre> 
<p><strong>更改组件的配置后，重启组件</strong></p> 
<pre><code class="prism language-java">tiup cluster reload $<span class="token punctuation">{<!-- --></span>cluster<span class="token operator">-</span>name<span class="token punctuation">}</span> <span class="token operator">-</span><span class="token class-name">R</span> 组件名，比如tiup cluster reload tidb<span class="token operator">-</span>pro <span class="token operator">-</span><span class="token class-name">R</span> tidb
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/47c5a7690c352e2152175272720ba49f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">python微信PC端自动化-获取消息发送时间</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0fb627a7c82712c646bc508ff7470b16/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【Oracle客户端】PLSQL Developer 15 (64 bit)最新版安装使用教程（亲测）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>