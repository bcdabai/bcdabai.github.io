<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Java Debug Interface(JDI)介绍和使用JDI调试程序 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Java Debug Interface(JDI)介绍和使用JDI调试程序" />
<meta property="og:description" content="Java Debug Interface(JDI)介绍 An Intro to the Java Debug Interface (JDI) | Baeldung
1. 概述 我们可能会想像IntelliJ IDEA和Eclipse这样大的IDE是如何实现调试特征的。这些工具极大依赖于Java平台调试架构（JPDA）。
在本文中，我们将讨论Java Debug Interface API(JDI)，这种可以在JPDA向下获得的接口。
同时，我们会一步步写一个自定义的调试程序，让我们熟悉JDI接口。
2. 介绍JPDA Java平台调试架构（JPDA）是一组设计得非常好得接口和协议集合，其目的是用于调试Java。
它提供了3种特别设计的接口，用于实现自定义的调试器，该调试器用于在桌面系统中的开发环境。
首先，Java虚拟机工具接口（JVMTI）帮助我们交互和控制应用程序的执行，这些应用程序都运行在JVM上。
然后，Java调试线协议（Java Debug Wire Protocol(JDWP)）定义了在测试（debugggee）和调试器（debugger）之下运行的程序的协议。
最后，Java调试接口(JDI)用于实现调试器应用程序。
3. 什么是JDI? Java调试器接口API是一组由Java提供的接口，其目的是实现调试器的前端。JDK是JPDA的最高层。
一个由JDI构成的调试器能够调试运行在任何JVM上的应用程序，只要这个JVM支持JPDA。同时，我们能够钩在调试的任何一层。
它提供了访问虚拟机的能力，并且它能访问调试器的变量。同时，它允许设置断点，单步调试，观察点和控制线程。
4. 安装 我们分别需要2个程序，一个debuggee和一个debugger，用于理解JDI的实现。
首先，我们要写一个简单的例子作为debuggee。
让我们创建一个JDIExampleDebuggee类，该类有几个string变量和一个println语句：
public class JDIExampleDebuggee { public static void main(String[] args) { String jpda = &#34;Java Platform Debugger Architecture&#34;; System.out.println(&#34;Hi Everyone, Welcome to &#34; &#43; jpda); // add a break point here String jdi = &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/0f5b95a7d7930aeb85b1a5953c043160/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-09-08T10:38:56+08:00" />
<meta property="article:modified_time" content="2021-09-08T10:38:56+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Java Debug Interface(JDI)介绍和使用JDI调试程序</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Java_Debug_InterfaceJDI_0"></a>Java Debug Interface(JDI)介绍</h2> 
<p><a href="https://www.baeldung.com/java-debug-interface" rel="nofollow">An Intro to the Java Debug Interface (JDI) | Baeldung</a></p> 
<h3><a id="1__4"></a>1. 概述</h3> 
<p>我们可能会想像IntelliJ IDEA和Eclipse这样大的IDE是如何实现调试特征的。这些工具极大依赖于Java平台调试架构（JPDA）。</p> 
<p>在本文中，我们将讨论Java Debug Interface API(JDI)，这种可以在JPDA向下获得的接口。</p> 
<p>同时，我们会一步步写一个自定义的调试程序，让我们熟悉JDI接口。</p> 
<h3><a id="2_JPDA_12"></a>2. 介绍JPDA</h3> 
<p>Java平台调试架构（JPDA）是一组设计得非常好得接口和协议集合，其目的是用于调试Java。</p> 
<p>它提供了3种特别设计的接口，用于实现自定义的调试器，该调试器用于在桌面系统中的开发环境。</p> 
<p>首先，Java虚拟机工具接口（JVMTI）帮助我们交互和控制应用程序的执行，这些应用程序都运行在JVM上。</p> 
<p>然后，Java调试线协议（Java Debug Wire Protocol(JDWP)）定义了在测试（debugggee）和调试器（debugger）之下运行的程序的协议。</p> 
<p>最后，Java调试接口(JDI)用于实现调试器应用程序。</p> 
<h3><a id="3_JDI_24"></a>3. 什么是<em>JDI</em>?</h3> 
<p>Java调试器接口API是一组由Java提供的接口，其目的是实现调试器的前端。<strong>JDK是JPDA的最高层</strong>。</p> 
<p>一个由JDI构成的调试器能够调试运行在任何JVM上的应用程序，只要这个JVM支持JPDA。同时，我们能够钩在调试的任何一层。</p> 
<p>它提供了访问虚拟机的能力，并且它能访问调试器的变量。同时，它允许设置断点，单步调试，观察点和控制线程。</p> 
<h3><a id="4__32"></a>4. 安装</h3> 
<p>我们分别需要2个程序，一个debuggee和一个debugger，用于理解JDI的实现。</p> 
<p>首先，我们要写一个简单的例子作为debuggee。</p> 
<p>让我们创建一个JDIExampleDebuggee类，该类有几个string变量和一个println语句：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JDIExampleDebuggee</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> jpda <span class="token operator">=</span> <span class="token string">"Java Platform Debugger Architecture"</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hi Everyone, Welcome to "</span> <span class="token operator">+</span> jpda<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// add a break point here</span>

        <span class="token class-name">String</span> jdi <span class="token operator">=</span> <span class="token string">"Java Debug Interface"</span><span class="token punctuation">;</span> <span class="token comment">// add a break point here and also stepping in here</span>
        <span class="token class-name">String</span> text <span class="token operator">=</span> <span class="token string">"Today, we'll dive into "</span> <span class="token operator">+</span> jdi<span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>然后，我们写调试器程序。</p> 
<p>让我们创建一个<em>JDIExampleDebugger</em>类，这个类有一些属性能够取调试程序（<em>debugClass</em>）并且为断点设置行号（<em>breakPointLines</em>）：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JDIExampleDebugger</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">Class</span> debugClass<span class="token punctuation">;</span> 
    <span class="token keyword">private</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> breakPointLines<span class="token punctuation">;</span>

    <span class="token comment">// getters and setters</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="41_LaunchingConnector_66"></a>4.1. <em>LaunchingConnector</em></h4> 
<p>首先，一个debugger需要一个连接器取建立一个与目标虚拟机之间的连接。</p> 
<p>然后，我们需要设置一个debuggee作为连接器的主参数。最后，连接器会运行VM进行debug。</p> 
<p>为了做这个，JDI提供了一个Bootstrap类，该类提供了一个LaunchingConnector实例。这个LaunchingConnector提供了一个默认参数的映射，在这里面，我们能够设置主参数。</p> 
<p>因此，让我们添加一个connectAndLaunchVM方法到JDIDebuggerExample类：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">VirtualMachine</span> <span class="token function">connectAndLaunchVM</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
 
    <span class="token class-name">LaunchingConnector</span> launchingConnector <span class="token operator">=</span> <span class="token class-name">Bootstrap</span><span class="token punctuation">.</span><span class="token function">virtualMachineManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">defaultConnector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Connector<span class="token punctuation">.</span>Argument</span><span class="token punctuation">&gt;</span></span> arguments <span class="token operator">=</span> launchingConnector<span class="token punctuation">.</span><span class="token function">defaultArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    arguments<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"main"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>debugClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> launchingConnector<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>现在，我们将添加一个<em>main</em>方法到<em>JDIDebubggerExample</em>用于调试<em>JDIExampleDebuggee</em>：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
 
    <span class="token class-name">JDIExampleDebugger</span> debuggerInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JDIExampleDebugger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    debuggerInstance<span class="token punctuation">.</span><span class="token function">setDebugClass</span><span class="token punctuation">(</span><span class="token class-name">JDIExampleDebuggee</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> breakPoints <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    debuggerInstance<span class="token punctuation">.</span><span class="token function">setBreakPointLines</span><span class="token punctuation">(</span>breakPoints<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">VirtualMachine</span> vm <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        vm <span class="token operator">=</span> debuggerInstance<span class="token punctuation">.</span><span class="token function">connectAndLaunchVM</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        vm<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>让我们编译我们的类，JDIExampleDebuggee(debuggee)和JDIExampleDebugger(debugger)：</p> 
<pre><code class="prism language-shell">javac -g -cp <span class="token string">"/Library/Java/JavaVirtualMachines/jdk1.8.0_131.jdk/Contents/Home/lib/tools.jar"</span> 
com/baeldung/jdi/*.java
</code></pre> 
<p>让我们讨论一下<em>javac</em>的细节。</p> 
<p>没有这个选项的话，我们可能看到<em>AbsentInformationException</em>。</p> 
<p><strong>并且 <em>-cp</em>会添加<em>tools.jar</em>在classpath中去编译类。</strong></p> 
<p>**所有的JDI库都能在JDK的<em>tools.jar</em>下获得。**因此，要确保编译和执行的时候都要添加<em>tools.jar</em>在classpath下。</p> 
<p>现在我们准备运行我们自定义的调试器<em>JDIExampleDebugger</em>：</p> 
<pre><code class="prism language-shell">java -cp <span class="token string">"/Library/Java/JavaVirtualMachines/jdk1.8.0_131.jdk/Contents/Home/lib/tools.jar:."</span> 
JDIExampleDebugger
</code></pre> 
<p>注意<em>tools.jar</em>后面的":."。对于当前运行时，这将添加tools.jar在classpath之后（在windows下使用";."）。</p> 
<h4><a id="42_BootstrapClassPrepareRequest_130"></a>4.2. <em>Bootstrap</em>和<em>ClassPrepareRequest</em></h4> 
<p>执行调试器程序不会给你结果因为我们没有准备调试的类并且设置断点。</p> 
<p><em>VirtualMachine</em>类有<em>eventRequestManager</em>方法去创造不同的需求，例如<em>ClassPrepareRequest</em>，<em>BreakpointRequest</em>，和<em>SetEventRequest</em>。</p> 
<p>所以，让我们添加<em>enbaleClassPrepareRerqueset</em>方法到<em>JDIExampleDebugger</em>类。</p> 
<p>这将过滤<em>JDIExampleDebuggee</em>类和使用<em>ClassPrepareRequest</em>：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">enableClassPrepareRequest</span><span class="token punctuation">(</span><span class="token class-name">VirtualMachine</span> vm<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">ClassPrepareRequest</span> classPrepareRequest <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">eventRequestManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createClassPrepareRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    classPrepareRequest<span class="token punctuation">.</span><span class="token function">addClassFilter</span><span class="token punctuation">(</span>debugClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    classPrepareRequest<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="43_ClassPrepareEvent_BreakpointRequest_148"></a>4.3. <em>ClassPrepareEvent</em> 和<em>BreakpointRequest</em></h4> 
<p>一旦，对<em>JDIExampleDebuggee</em>的<em>ClassPrepareReqeust</em>使能后，VM的事件队列将会开始有<em>ClassPrepareEvent</em>的实例。</p> 
<p>使用<em>ClassPrepareEvent</em>，我们能够获得设置断点的位置和创建一个<em>BreakPointRequest</em>。</p> 
<p>为了这样，让我们添加<em>setBreakPoints</em>方法到<em>JDIExampleDebugger</em>类：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setBreakPoints</span><span class="token punctuation">(</span><span class="token class-name">VirtualMachine</span> vm<span class="token punctuation">,</span> <span class="token class-name">ClassPrepareEvent</span> event<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AbsentInformationException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">ClassType</span> classType <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ClassType</span><span class="token punctuation">)</span> event<span class="token punctuation">.</span><span class="token function">referenceType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> lineNumber<span class="token operator">:</span> breakPointLines<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Location</span> location <span class="token operator">=</span> classType<span class="token punctuation">.</span><span class="token function">locationsOfLine</span><span class="token punctuation">(</span>lineNumber<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BreakpointRequest</span> bpReq <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">eventRequestManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createBreakpointRequest</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">;</span>
        bpReq<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="44_BreakPointEvent_StackFrame_167"></a>4.4. <em>BreakPointEvent</em> 和<em>StackFrame</em></h4> 
<p>到目前为止，我们已经为调试准备了类并且设置了断点。现在，我们需要捕获<em>BreakPointEvent</em>并显示变量。</p> 
<p>JDI 提供了StackFrame类，用于获得debuggee.JDI的所有可见变量的列表。</p> 
<p>因此，让我们添加<em>displayVariables</em>方法到<em>JDIExampleDebugger</em>类：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">displayVariables</span><span class="token punctuation">(</span><span class="token class-name">LocatableEvent</span> event<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IncompatibleThreadStateException</span><span class="token punctuation">,</span> 
<span class="token class-name">AbsentInformationException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">StackFrame</span> stackFrame <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">frame</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>stackFrame<span class="token punctuation">.</span><span class="token function">location</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>debugClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LocalVariable</span><span class="token punctuation">,</span> <span class="token class-name">Value</span><span class="token punctuation">&gt;</span></span> visibleVariables <span class="token operator">=</span> stackFrame
          <span class="token punctuation">.</span><span class="token function">getValues</span><span class="token punctuation">(</span>stackFrame<span class="token punctuation">.</span><span class="token function">visibleVariables</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Variables at "</span> <span class="token operator">+</span> stackFrame<span class="token punctuation">.</span><span class="token function">location</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>  <span class="token string">" &gt; "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LocalVariable</span><span class="token punctuation">,</span> <span class="token class-name">Value</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> visibleVariables<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" = "</span> <span class="token operator">+</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="5__190"></a>5. 调试目标</h3> 
<p>在这一步，我们所需要做的是更新JDIExampleDebugger的<em>main</em>方法，使之可以开始调试。</p> 
<p>因此，我们将使用已经说过的方法，例如<em>enableClassPrepareRequest</em>，<em>setBreakPoints</em>和<em>displayVariables</em>：</p> 
<pre><code class="prism language-java"><span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    vm <span class="token operator">=</span> debuggerInstance<span class="token punctuation">.</span><span class="token function">connectAndLaunchVM</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    debuggerInstance<span class="token punctuation">.</span><span class="token function">enableClassPrepareRequest</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">EventSet</span> eventSet <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>eventSet <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">eventQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Event</span> event <span class="token operator">:</span> eventSet<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token keyword">instanceof</span> <span class="token class-name">ClassPrepareEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                debuggerInstance<span class="token punctuation">.</span><span class="token function">setBreakPoints</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">ClassPrepareEvent</span><span class="token punctuation">)</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token keyword">instanceof</span> <span class="token class-name">BreakpointEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                debuggerInstance<span class="token punctuation">.</span><span class="token function">displayVariables</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">BreakpointEvent</span><span class="token punctuation">)</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            vm<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">VMDisconnectedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Virtual Machine is disconnected."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>现在，我们再一次用已经存在的<em>javac</em>命令编译<em>JDIDebuggerExample</em>类</p> 
<p>最后，我们会运行这个调试程序，并且可以看到以下输出：</p> 
<pre><code class="prism language-shell">Variables at com.baeldung.jdi.JDIExampleDebuggee:6 <span class="token operator">&gt;</span> 
args <span class="token operator">=</span> instance of java.lang.String<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">93</span><span class="token punctuation">)</span>
Variables at com.baeldung.jdi.JDIExampleDebuggee:9 <span class="token operator">&gt;</span> 
jpda <span class="token operator">=</span> <span class="token string">"Java Platform Debugger Architecture"</span>
args <span class="token operator">=</span> instance of java.lang.String<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">93</span><span class="token punctuation">)</span>
Virtual Machine is disconnected.
</code></pre> 
<p>耶！我们已经成功地调试了<em>JDIExampleDebuggee</em>类。同时，我们已经显示了在指定断点的位置（行6和行9）的变量的值</p> 
<p>到此为止，我们的自定义debugger已经准备好了。</p> 
<h4><a id="51_StepRequest_236"></a>5.1. <em>StepRequest</em></h4> 
<p>**调试也需要单步功能并且检查变量在下一步的状态。**因此，我们将创建一个在断点的单步调试需求。</p> 
<p>当创建一个<em>StepRequest</em>的实例时，我们必须提供单步的size和深度。我们将分别定义定义STEP_LINE和STEP_OVER。</p> 
<p>我们写一个函数去启用step需求。</p> 
<p>简单来说，我们将开始在最后一个断点开始单步调试（行9）：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">enableStepRequest</span><span class="token punctuation">(</span><span class="token class-name">VirtualMachine</span> vm<span class="token punctuation">,</span> <span class="token class-name">BreakpointEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// enable step request for last break point</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">location</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">contains</span><span class="token punctuation">(</span>debugClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> breakPointLines<span class="token punctuation">[</span>breakPointLines<span class="token punctuation">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">StepRequest</span> stepRequest <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">eventRequestManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">createStepRequest</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StepRequest</span><span class="token punctuation">.</span>STEP_LINE<span class="token punctuation">,</span> <span class="token class-name">StepRequest</span><span class="token punctuation">.</span>STEP_OVER<span class="token punctuation">)</span><span class="token punctuation">;</span>
        stepRequest<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>现在，我们能更新<em>JDIExampleDebugger</em>的<em>main</em>方法了，用于当碰到BreakPointEvent时启动step需求。</p> 
<pre><code class="prism language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token keyword">instanceof</span> <span class="token class-name">BreakpointEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    debuggerInstance<span class="token punctuation">.</span><span class="token function">enableStepRequest</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">BreakpointEvent</span><span class="token punctuation">)</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="52_StepEvent_266"></a>5.2. <em>StepEvent</em></h4> 
<p>与<em>BreakPointEvent</em>类似，我们也能够在<em>StepEvent</em>中看变量。</p> 
<p>让我们更新<em>main</em>函数：</p> 
<pre><code class="prism language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token keyword">instanceof</span> <span class="token class-name">StepEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    debuggerInstance<span class="token punctuation">.</span><span class="token function">displayVariables</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">StepEvent</span><span class="token punctuation">)</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>最后，我们执行这个debugger去看看当代码中有单步调试时变量的状态：</p> 
<pre><code class="prism language-shell">Variables at com.baeldung.jdi.JDIExampleDebuggee:6 <span class="token operator">&gt;</span> 
args <span class="token operator">=</span> instance of java.lang.String<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">93</span><span class="token punctuation">)</span>
Variables at com.baeldung.jdi.JDIExampleDebuggee:9 <span class="token operator">&gt;</span> 
args <span class="token operator">=</span> instance of java.lang.String<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">93</span><span class="token punctuation">)</span>
jpda <span class="token operator">=</span> <span class="token string">"Java Platform Debugger Architecture"</span>
Variables at com.baeldung.jdi.JDIExampleDebuggee:10 <span class="token operator">&gt;</span> 
args <span class="token operator">=</span> instance of java.lang.String<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">93</span><span class="token punctuation">)</span>
jpda <span class="token operator">=</span> <span class="token string">"Java Platform Debugger Architecture"</span>
jdi <span class="token operator">=</span> <span class="token string">"Java Debug Interface"</span>
Variables at com.baeldung.jdi.JDIExampleDebuggee:11 <span class="token operator">&gt;</span> 
args <span class="token operator">=</span> instance of java.lang.String<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">93</span><span class="token punctuation">)</span>
jpda <span class="token operator">=</span> <span class="token string">"Java Platform Debugger Architecture"</span>
jdi <span class="token operator">=</span> <span class="token string">"Java Debug Interface"</span>
text <span class="token operator">=</span> <span class="token string">"Today, we'll dive into Java Debug Interface"</span>
Variables at com.baeldung.jdi.JDIExampleDebuggee:12 <span class="token operator">&gt;</span> 
args <span class="token operator">=</span> instance of java.lang.String<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">93</span><span class="token punctuation">)</span>
jpda <span class="token operator">=</span> <span class="token string">"Java Platform Debugger Architecture"</span>
jdi <span class="token operator">=</span> <span class="token string">"Java Debug Interface"</span>
text <span class="token operator">=</span> <span class="token string">"Today, we'll dive into Java Debug Interface"</span>
Virtual Machine is disconnected.
</code></pre> 
<p>如果我们比较输出，我们将认识到单步调试到行9的debugger并显示所有步骤上的变量。</p> 
<h3><a id="6__305"></a>6. 阅读执行输出</h3> 
<p>我们可能注意到JDIExampleDebuggee类的println语句并没有在debugger中输出。</p> 
<p>如JDK文档所属，如果我们通过<em>LaunchingConnector</em>执行VM，它的输出和错误流必须被进程对象读到。</p> 
<p>因此，让我们在主函数中加上finally语句：</p> 
<pre><code class="prism language-java"><span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">InputStreamReader</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">OutputStreamWriter</span> writer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OutputStreamWriter</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    writer<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>现在，执行debugger程序也会打印JDIExampleDebuggee类中的println输出：</p> 
<pre><code class="prism language-shell">Hi Everyone, Welcome to Java Platform Debugger Architecture
Today, we'll dive into Java Debug Interface
</code></pre> 
<h3><a id="7__331"></a>7. 总结</h3> 
<p>在本文中，我们研究了在the Java Platform Debugger Architecture (JPDA)下的Java Debug Interface(JDI) API。</p> 
<p>同时，我们构建了一个自定义的debugger，该debugger使用了手工编写的基于JDI的接口。同时，我们也为这个debugger添加了单步调试功能。</p> 
<p>作为介绍JDI的文章，推荐大家去看以下其他的在<a href="https://github.com/openjdk-mirror/jdk7u-jdk">JDK API</a>下的接口的实现。</p> 
<p>所有的代码都可以在[Github]((https://github.com/eugenp/tutorials/tree/master/java-jdi)中获得。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fd91732a996e05d78e0df94a5a64d731/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">升级PHP7/8版本后掉进imagettftext的坑里</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6eeb82617dd4a269971b88179045dea0/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">自动化测试平台搭建系列（10）——Django框架中的Bootstrap和继承</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>