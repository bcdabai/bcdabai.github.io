<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SparkSQL读取/写入MySQL/Oracle数据(分区并行读取) - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="SparkSQL读取/写入MySQL/Oracle数据(分区并行读取)" />
<meta property="og:description" content="**
SparkSQL读取MySQL数据 **
一、sparkSQL读取MySQL数据
1、第一种方式
def main(args: Array[String]): Unit = { //获取sparkSession val sparkSession = SparkSession.builder().appName(this.getClass.getSimpleName.filter(!_.equals(&#39;$&#39;))).getOrCreate() //获取sparkContext val sparkContext = sparkSession.sparkContext //设置日志级别 sparkContext.setLogLevel(&#34;WARN&#34;) //读取数据 val properties = new Properties() properties.put(&#34;user&#34;,&#34;qjjc&#34;) properties.put(&#34;password&#34;,&#34;XXX&#34;) val url = &#34;jdbc:mysql://10.213.111.XXX:23306/buf_amr_all&#34; val data: DataFrame = sparkSession.read.jdbc(url,&#34;pdwqy_pms_yx_sbxx&#34;,properties) data.show() //释放资源 sparkContext.stop() sparkSession.stop() } 该方法还可以并发读取数据
指定数据库字段的范围分区: 调用函数:
def jdbc( url: String, table: String, columnName: String, lowerBound: Long, upperBound: Long, numPartitions: Int, connectionProperties: Properties): DataFrame 代码示例:
val lowerBound = 1 val upperBound = 100000 val numPartitions = 5 val properties = new Properties() properties." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/87c408b84d684ea7f6c9147747fdc3d8/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-10-23T16:30:42+08:00" />
<meta property="article:modified_time" content="2019-10-23T16:30:42+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SparkSQL读取/写入MySQL/Oracle数据(分区并行读取)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>**</p> 
<h3><a id="SparkSQLMySQL_2"></a>SparkSQL读取MySQL数据</h3> 
<p>**<br> 一、sparkSQL读取MySQL数据<br> 1、第一种方式</p> 
<pre><code>def main(args: Array[String]): Unit = {

    //获取sparkSession
    val sparkSession = SparkSession.builder().appName(this.getClass.getSimpleName.filter(!_.equals('$'))).getOrCreate()

    //获取sparkContext
    val sparkContext = sparkSession.sparkContext

    //设置日志级别
    sparkContext.setLogLevel("WARN")
	
	//读取数据
    val properties = new Properties()
    properties.put("user","qjjc")
    properties.put("password","XXX")
    val url = "jdbc:mysql://10.213.111.XXX:23306/buf_amr_all"
    val data: DataFrame = sparkSession.read.jdbc(url,"pdwqy_pms_yx_sbxx",properties)

	data.show()

    //释放资源
    sparkContext.stop()
    sparkSession.stop()
  }
</code></pre> 
<p><strong>该方法还可以并发读取数据</strong></p> 
<ol><li>指定数据库字段的范围分区:</li></ol> 
<p>调用函数:</p> 
<pre><code>def jdbc(
    url: String,
    table: String,
    columnName: String,
    lowerBound: Long,
    upperBound: Long,
    numPartitions: Int,
    connectionProperties: Properties): DataFrame
</code></pre> 
<p>代码示例:</p> 
<pre><code>val lowerBound = 1
val upperBound = 100000
val numPartitions = 5
 
val properties = new Properties()
properties.put("user","qjjc")
properties.put("password","XXX")
val url = "jdbc:mysql://10.213.111.XXX:23306/buf_amr_all"

val df = sqlContext.read.jdbc(url, "pdwqy_pms_yx_sbxx", "id", lowerBound, upperBound, numPartitions, prop)
</code></pre> 
<ol start="2"><li>根据任意字段进行分区</li></ol> 
<p>调用函数:</p> 
<pre><code>def jdbc(
    url: String,
    table: String,
    predicates: Array[String],
    connectionProperties: Properties): DataFrame
</code></pre> 
<p>代码示例:</p> 
<pre><code>val predicates = Array[String]("reportDate &lt;= '2014-12-31'", 
    								"reportDate &gt; '2014-12-31' and reportDate &lt;= '2015-12-31'")
 
val properties = new Properties()
properties.put("user","qjjc")
properties.put("password","XXX")
val url = "jdbc:mysql://10.213.111.XXX:23306/buf_amr_all"

val df = sqlContext.read.jdbc(url, "pdwqy_pms_yx_sbxx", predicates, prop)
</code></pre> 
<p>注意Array中的写法格式应为SQL表达式格式，例如：</p> 
<pre><code>xx &lt; xx 或者 xx=xx 或者 xx is null 
</code></pre> 
<p>2、第二种方式</p> 
<pre><code>def main(args: Array[String]): Unit = {

    //创建sparkSession(打包在集群上运行要删除master)
    val sparkConf: SparkConf = new SparkConf().setAppName(this.getClass.getSimpleName.filter(!_.equals('$')))
	
	//获取sparkContext
	val sparkContext = new SparkContext(sparkConf)

    //设置日志级别
    sparkContext.setLogLevel("WARN")

	//获取sqlContext
    val spark: SQLContext = new SQLContext(sparkContext)
	
	//读取数据
	val data: DataFrame = spark.read.format("jdbc")
      .option("url", "jdbc:mysql://10.213.111.XXX:23306/buf_amr_all")
      .option("dbtable", "pdwqy_pms_yx_sbxx")
      .option("user", "qjjc")
      .option("password", "XXX")
      .load()
      
    data.show()
      
    //释放资源
    sparkContext.stop()
    sparkSession.stop()
}
</code></pre> 
<p>二、sparkSQL将数据写入到MySQL<br> 1、第一种方式</p> 
<pre><code>//计算得到DataFrame类型结果
val result: DataFrame = spark.sql("select * from table1")

//将数据保存到MySQL
val properties = new Properties()
properties.setProperty("user","root")
properties.setProperty("password","root")
result.write.mode(SaveMode.Append).jdbc("jdbc:mysql://localhost:3306/gwdsj","pdwqy_pms_yx_sbxx",properties)
</code></pre> 
<p>2、第二种方式</p> 
<pre><code>//计算得到DataFrame类型结果
val result: DataFrame = spark.sql("select * from table1")

//将数据保存到MySQL
YJYP_result.write.mode(SaveMode.Append).format("jdbc")
      .option(JDBCOptions.JDBC_URL,"jdbc:mysql://21.76.120.XXX:3306/us_app?rewriteBatchedStatement=true")
      .option("user","root")
      .option("password","XXX")
      .option(JDBCOptions.JDBC_TABLE_NAME,"tb_pdwqy_ywfz_yjyp")
      .option(JDBCOptions.JDBC_TXN_ISOLATION_LEVEL,"NONE")    //不开启事务
      .option(JDBCOptions.JDBC_BATCH_INSERT_SIZE,500)   //设置批量插入
      .save()
</code></pre> 
<p>**<br> <strong>此外,执行写入操作时,结果数据的字段缺失和字段顺序都不用在意,例如:</strong></p> 
<pre><code>	val result = spark.sql("select TG_ID,`1` I1,`2` I2,`3` I3,DATA_DATE from result_temp")

    val properties = new Properties()
    properties.setProperty("user","root")
    properties.setProperty("password","123")
    result.write.mode(SaveMode.Append).jdbc("jdbc:mysql://localhost:3306/test11","dlzz111",properties)
</code></pre> 
<p>数据可以顺利插入:<br> <img src="https://images2.imgbox.com/c1/34/lidPduwV_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="SparkSQLOracle_168"></a>SparkSQL读取Oracle数据</h3> 
<p>**<br> 整体与MySQL类似,只需要修改URL驱动就可以:</p> 
<pre><code>jdbc:oracle:thin:@//10.212.242.XXX:11521/pmsgs
</code></pre> 
<p><strong>另外,如果是maven项目,需要注意:</strong><br> 由于Oracle授权问题，Maven3不提供oracle JDBC driver，我们也可以在Maven的中心搜索ojdbc驱动包，但是可以看到版本过于陈旧，即使有坐标，也下载不了。<br> <img src="https://images2.imgbox.com/3f/91/yEh6Zsdt_o.png" alt="在这里插入图片描述"><br> 为了可以在使用Maven构建的项目中使用Oracle JDBC driver，我们就必须手动添加Oracle的JDBC驱动依赖到本地仓库中。</p> 
<p><strong>网上下载合适的Oracle依赖包(本人使用的是classes12)</strong><br> <img src="https://images2.imgbox.com/b9/7b/yxmgmkKW_o.png" alt="在这里插入图片描述"><br> <em><strong>将jar包手动添加到maven项目中,参考:</strong></em><br> <a href="https://blog.csdn.net/weixin_44455388/article/details/100926697">maven项目手动导入jar包依赖</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5a98d4b9053491a52faf7e5d886b0229/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">C程序代码规范</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8b4da29f4aebcad62ddca54ab632efa1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">“xxx”的 iPhone has denied the launch request. Internal launch error: proce</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>