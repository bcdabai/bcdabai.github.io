<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>LogStash安装及综合案例 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="LogStash安装及综合案例" />
<meta property="og:description" content="文章目录 14、LogStash介绍及安装1、介绍2 、node01机器安装LogStash3、Input插件1、stdin标准输入和stdout标准输出2、监控日志文件变化 3、jdbc插件第一步：编写脚本第二步：上传mysql连接驱动包到指定路劲第三步：检查配置文件是否可用第四步：启动服务第五步：数据库当中添加数据 4 systlog插件4、filter插件1、grok正则表达式1、收集控制台输入数据，采集日期时间出来2、使用grok收集nginx日志数据第一步：安装grok插件第二步：开发logstash的配置文件第三步：启动logstash第四步：从控制台输入nginx日志文件数据 5、 Output插件1 标准输出到控制台2 将采集数据保存到file文件中第一步：开发logstash的配置文件第二步：检测配置文件并启动logstash服务 3 将采集数据保存到elasticsearch第一步：开发logstash的配置文件第二步：检测配置文件并启动logstash第三步：es当中查看数据 16、logStash&#43;ES综合案例1、采集服务器运行产生的日志1.1、rsyslog的基本介绍1.2、修改rsyslog的配置文件1.3、重启linux服务器的rsyslog服务1.4、开发logstash的配置文件，收集rsyslog日志1.5、启动logstash服务 2、采集服务器用户操作所有历史日志第一步：定义日志格式第二步：开发logstash的配置文件第三步：启动logstash 3、采集nginx日志到es当中第一步：上传日志文件第二步：开发logstash的配置文件第三步：启动logstash并查看es当中的数据 14、LogStash介绍及安装 官网：
https://www.elastic.co/guide/en/logstash/current/index.html
1、介绍 logstash就是一个具备实时数据传输能力的管道，负责将数据信息从管道的输入端传输到管道的输出端；与此同时这根管道还可以让你根据自己的需求在中间加上滤网，Logstash提供里很多功能强大的滤网以满足你的各种应用场景。是一个input | filter | output 的数据流。
2 、node01机器安装LogStash 下载logstache并上传到第一台服务器的/home/es路径下，然后进行解压
#下载安装包—可以直接将已经下载好的安装包上传到/home/es路径下即可
cd /home/es wget https://artifacts.elastic.co/downloads/logstash/logstash-6.7.0.tar.gz #解压 tar -zxf logstash-6.7.0.tar.gz -C /export/servers/es/ 3、Input插件 1、stdin标准输入和stdout标准输出 使用标准的输入与输出组件，实现将我们的数据从控制台输入，从控制台输出
cd /export/servers/es/logstash-6.7.0/ bin/logstash -e &#39;input{stdin{}}output{stdout{codec=&gt;rubydebug}}&#39; { &#34;@version&#34; =&gt; &#34;1&#34;, &#34;host&#34; =&gt; &#34;node01&#34;, &#34;@timestamp&#34; =&gt; 2018-10-13T08:33:13.126Z, &#34;message&#34; =&gt; &#34;hello&#34; } 2、监控日志文件变化 Logstash 使用一个名叫 FileWatch 的 Ruby Gem 库来监听文件变化。这个库支持 glob 展开文件路径，而且会记录一个叫 ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/ddb90db3c9a83a395cba101872a73dc3/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-09-22T10:17:50+08:00" />
<meta property="article:modified_time" content="2019-09-22T10:17:50+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">LogStash安装及综合案例</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#14LogStash_1" rel="nofollow">14、LogStash介绍及安装</a></li><li><ul><li><a href="#1_4" rel="nofollow">1、介绍</a></li><li><a href="#2_node01LogStash_6" rel="nofollow">2 、node01机器安装LogStash</a></li><li><a href="#3Input_15" rel="nofollow">3、Input插件</a></li><li><ul><li><a href="#1stdinstdout_16" rel="nofollow">1、stdin标准输入和stdout标准输出</a></li><li><a href="#2_30" rel="nofollow">2、监控日志文件变化</a></li></ul> 
   </li><li><a href="#3jdbc_80" rel="nofollow">3、jdbc插件</a></li><li><ul><li><a href="#_82" rel="nofollow">第一步：编写脚本</a></li><li><a href="#mysql_111" rel="nofollow">第二步：上传mysql连接驱动包到指定路劲</a></li><li><a href="#_114" rel="nofollow">第三步：检查配置文件是否可用</a></li><li><a href="#_121" rel="nofollow">第四步：启动服务</a></li><li><a href="#_127" rel="nofollow">第五步：数据库当中添加数据</a></li></ul> 
   </li><li><a href="#4_systlog_131" rel="nofollow">4 systlog插件</a></li><li><a href="#4filter_201" rel="nofollow">4、filter插件</a></li><li><ul><li><a href="#1grok_203" rel="nofollow">1、grok正则表达式</a></li><li><ul><li><a href="#1_208" rel="nofollow">1、收集控制台输入数据，采集日期时间出来</a></li><li><a href="#2groknginx_231" rel="nofollow">2、使用grok收集nginx日志数据</a></li><li><ul><li><a href="#grok_241" rel="nofollow">第一步：安装grok插件</a></li><li><a href="#logstash_267" rel="nofollow">第二步：开发logstash的配置文件</a></li><li><a href="#logstash_284" rel="nofollow">第三步：启动logstash</a></li><li><a href="#nginx_290" rel="nofollow">第四步：从控制台输入nginx日志文件数据</a></li></ul> 
    </li></ul> 
   </li></ul> 
   </li><li><a href="#5_Output_299" rel="nofollow">5、 Output插件</a></li><li><ul><li><a href="#1__300" rel="nofollow">1 标准输出到控制台</a></li><li><a href="#2_file_312" rel="nofollow">2 将采集数据保存到file文件中</a></li><li><ul><li><a href="#logstash_314" rel="nofollow">第一步：开发logstash的配置文件</a></li><li><a href="#logstash_330" rel="nofollow">第二步：检测配置文件并启动logstash服务</a></li></ul> 
    </li><li><a href="#3_elasticsearch_348" rel="nofollow">3 将采集数据保存到elasticsearch</a></li><li><ul><li><a href="#logstash_349" rel="nofollow">第一步：开发logstash的配置文件</a></li><li><a href="#logstash_362" rel="nofollow">第二步：检测配置文件并启动logstash</a></li><li><a href="#es_373" rel="nofollow">第三步：es当中查看数据</a></li></ul> 
   </li></ul> 
  </li></ul> 
  </li><li><a href="#16logStashES_387" rel="nofollow">16、logStash+ES综合案例</a></li><li><ul><li><a href="#1_393" rel="nofollow">1、采集服务器运行产生的日志</a></li><li><ul><li><a href="#11rsyslog_394" rel="nofollow">1.1、rsyslog的基本介绍</a></li><li><a href="#12rsyslog_435" rel="nofollow">1.2、修改rsyslog的配置文件</a></li><li><a href="#13linuxrsyslog_447" rel="nofollow">1.3、重启linux服务器的rsyslog服务</a></li><li><a href="#14logstashrsyslog_452" rel="nofollow">1.4、开发logstash的配置文件，收集rsyslog日志</a></li><li><a href="#15logstash_487" rel="nofollow">1.5、启动logstash服务</a></li></ul> 
   </li><li><a href="#2_493" rel="nofollow">2、采集服务器用户操作所有历史日志</a></li><li><ul><li><a href="#_505" rel="nofollow">第一步：定义日志格式</a></li><li><a href="#logstash_524" rel="nofollow">第二步：开发logstash的配置文件</a></li><li><a href="#logstash_546" rel="nofollow">第三步：启动logstash</a></li></ul> 
   </li><li><a href="#3nginxes_555" rel="nofollow">3、采集nginx日志到es当中</a></li><li><ul><li><a href="#_557" rel="nofollow">第一步：上传日志文件</a></li><li><a href="#logstash_563" rel="nofollow">第二步：开发logstash的配置文件</a></li><li><a href="#logstashes_590" rel="nofollow">第三步：启动logstash并查看es当中的数据</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="14LogStash_1"></a>14、LogStash介绍及安装</h2> 
<p>官网：<br> https://www.elastic.co/guide/en/logstash/current/index.html</p> 
<h3><a id="1_4"></a>1、介绍</h3> 
<p>logstash就是一个具备实时数据传输能力的管道，负责将数据信息从管道的输入端传输到管道的输出端；与此同时这根管道还可以让你根据自己的需求在中间加上滤网，Logstash提供里很多功能强大的滤网以满足你的各种应用场景。是一个input | filter | output 的数据流。</p> 
<h3><a id="2_node01LogStash_6"></a>2 、node01机器安装LogStash</h3> 
<p>下载logstache并上传到第一台服务器的/home/es路径下，然后进行解压<br> #下载安装包—可以直接将已经下载好的安装包上传到/home/es路径下即可</p> 
<pre><code class="prism language-sql">cd <span class="token operator">/</span>home<span class="token operator">/</span>es 
wget https:<span class="token comment">//artifacts.elastic.co/downloads/logstash/logstash-6.7.0.tar.gz</span>
<span class="token comment">#解压</span>
tar <span class="token operator">-</span>zxf logstash<span class="token operator">-</span><span class="token number">6.7</span><span class="token number">.0</span><span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz <span class="token operator">-</span>C <span class="token operator">/</span>export<span class="token operator">/</span>servers<span class="token operator">/</span>es<span class="token operator">/</span>
</code></pre> 
<h3><a id="3Input_15"></a>3、Input插件</h3> 
<h4><a id="1stdinstdout_16"></a>1、stdin标准输入和stdout标准输出</h4> 
<p>使用标准的输入与输出组件，实现将我们的数据从控制台输入，从控制台输出</p> 
<pre><code class="prism language-sql">cd <span class="token operator">/</span>export<span class="token operator">/</span>servers<span class="token operator">/</span>es<span class="token operator">/</span>logstash<span class="token operator">-</span><span class="token number">6.7</span><span class="token number">.0</span><span class="token operator">/</span>
bin<span class="token operator">/</span>logstash <span class="token operator">-</span>e <span class="token string">'input{stdin{}}output{stdout{codec=&gt;rubydebug}}'</span>


{
      <span class="token string">"@version"</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"1"</span><span class="token punctuation">,</span>
          <span class="token string">"host"</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"node01"</span><span class="token punctuation">,</span>
    <span class="token string">"@timestamp"</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">2018</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">13</span>T08:<span class="token number">33</span>:<span class="token number">13.126</span>Z<span class="token punctuation">,</span>
       <span class="token string">"message"</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"hello"</span>
}
</code></pre> 
<h4><a id="2_30"></a>2、监控日志文件变化</h4> 
<p>Logstash 使用一个名叫 FileWatch 的 Ruby Gem 库来监听文件变化。这个库支持 glob 展开文件路径，而且会记录一个叫 .sincedb 的数据库文件来跟踪被监听的日志文件的当前读取位置。所以，不要担心 logstash 会漏过你的数据。<br> 编写脚本</p> 
<pre><code class="prism language-shell"><span class="token function">cd</span> /export/servers/es/logstash-6.7.0/config
vim monitor_file.conf
<span class="token comment">#输入一下信息 </span>
input<span class="token punctuation">{<!-- --></span>
    file<span class="token punctuation">{<!-- --></span>
        path <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"/export/servers/es/datas/tomcat.log"</span>
        <span class="token function">type</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"log"</span>
        start_position <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"beginning"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
output<span class="token punctuation">{<!-- --></span>
        stdout<span class="token punctuation">{<!-- --></span>
        codec<span class="token operator">=</span><span class="token operator">&gt;</span>rubydebug
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>检查配置文件是否可用</p> 
<pre><code class="prism language-shell"><span class="token function">cd</span> /export/servers/es/logstash-6.7.0/
bin/logstash -f /export/servers/es/logstash-6.7.0/config/monitor_file.conf -t
</code></pre> 
<p>成功会出现一下信息：<br> Config Validation Result: OK. Exiting Logstash</p> 
<p>启动服务</p> 
<pre><code class="prism language-shell"><span class="token function">cd</span> /export/servers/es/logstash-6.7.0
bin/logstash -f /export/servers/es/logstash-6.7.0/config/monitor_file.conf
</code></pre> 
<p>发送数据<br> 新开xshell窗口通过以下命令发送数据</p> 
<pre><code class="prism language-shell"><span class="token function">mkdir</span> -p /export/servers/es/datas
<span class="token keyword">echo</span> <span class="token string">"hello logstash"</span> <span class="token operator">&gt;&gt;</span> /export/servers/es/datas/tomcat.log
</code></pre> 
<p>其它参数说明<br> Path=&gt;表示监控的文件路径<br> Type=&gt;给类型打标记，用来区分不同的文件类型。<br> Start_postion=&gt;从哪里开始记录文件，默认是从结尾开始标记，要是你从头导入一个文件就把改成”beginning”.<br> discover_interval=&gt;多久去监听path下是否有文件，默认是15s<br> exclude=&gt;排除什么文件<br> close_older=&gt;一个已经监听中的文件，如果超过这个值的时间内没有更新内容，就关闭监听它的文件句柄。默认是3600秒，即一个小时。<br> sincedb_path=&gt;监控库存放位置(默认的读取文件信息记录在哪个文件中)。默认在：/data/plugins/inputs/file。<br> sincedb_write_interval=&gt; logstash 每隔多久写一次 sincedb 文件，默认是 15 秒。<br> stat_interval=&gt;logstash 每隔多久检查一次被监听文件状态（是否有更新），默认是 1 秒。</p> 
<h3><a id="3jdbc_80"></a>3、jdbc插件</h3> 
<p>jdbc插件允许我们采集某张数据库表当中的数据到我们的logstashe当中来</p> 
<h4><a id="_82"></a>第一步：编写脚本</h4> 
<p>开发脚本配置文件</p> 
<pre><code class="prism language-shell"><span class="token function">cd</span> /export/servers/es/logstash-6.7.0/config
vim jdbc.conf
input <span class="token punctuation">{<!-- --></span>
  jdbc <span class="token punctuation">{<!-- --></span>
    jdbc_driver_library <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"/home/es/mysql-connector-java-5.1.38.jar"</span>
    jdbc_driver_class <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"com.mysql.jdbc.Driver"</span>
    jdbc_connection_string <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"jdbc:mysql://192.168.31.82:3306/userdb"</span>
    jdbc_user <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"root"</span>
    jdbc_password <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"admin"</span>

    use_column_value <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">true</span>
    tracking_column <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"create_time"</span>
  <span class="token comment">#  parameters =&gt; { "favorite_artist" =&gt; "Beethoven" }</span>
    schedule <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"* * * * *"</span>
    statement <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"SELECT * from emp where create_time &gt; :sql_last_value ;"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>



output<span class="token punctuation">{<!-- --></span>
        stdout<span class="token punctuation">{<!-- --></span>
        codec<span class="token operator">=</span><span class="token operator">&gt;</span>rubydebug
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="mysql_111"></a>第二步：上传mysql连接驱动包到指定路劲</h4> 
<p>将我们mysql的连接驱动包上传到我们指定的/home/es/路径下</p> 
<h4><a id="_114"></a>第三步：检查配置文件是否可用</h4> 
<pre><code class="prism language-shell"><span class="token function">cd</span> /export/servers/es/logstash-6.7.0/
bin/logstash -f /export/servers/es/logstash-6.7.0/config/jdbc.conf  -t
</code></pre> 
<p>通过之后<br> Config Validation Result: OK. Exiting Logstash</p> 
<h4><a id="_121"></a>第四步：启动服务</h4> 
<p>通过以下命令启动logstash</p> 
<pre><code class="prism language-shell"><span class="token function">cd</span> /export/servers/es/logstash-6.7.0
bin/logstash -f /export/servers/es/logstash-6.7.0/config/jdbc.conf
</code></pre> 
<h4><a id="_127"></a>第五步：数据库当中添加数据</h4> 
<p>在我们的数据库当中手动随便插入数据，发现我们的logstash可以进行收集</p> 
<h3><a id="4_systlog_131"></a>4 systlog插件</h3> 
<p>syslog机制负责记录内核和应用程序产生的日志信息，管理员可以通过查看日志记录，来掌握系统状况<br> 默认系统已经安装了rsyslog.直接启动即可<br> 编写脚本</p> 
<pre><code class="prism language-shell"><span class="token function">cd</span> /export/servers/es/logstash-6.7.0/config
vim syslog.conf
input<span class="token punctuation">{<!-- --></span>
    tcp<span class="token punctuation">{<!-- --></span>
        port<span class="token operator">=</span><span class="token operator">&gt;</span> 6789
        type<span class="token operator">=</span><span class="token operator">&gt;</span> syslog
    <span class="token punctuation">}</span>
    udp<span class="token punctuation">{<!-- --></span>
        port<span class="token operator">=</span><span class="token operator">&gt;</span> 6789
        type<span class="token operator">=</span><span class="token operator">&gt;</span> syslog
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

filter<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"syslog"</span> <span class="token punctuation">{<!-- --></span>
        grok <span class="token punctuation">{<!-- --></span>
                match <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"message"</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"%{SYSLOGTIMESTAMP:syslog_timestamp} %{SYSLOGHOST:syslog_hostname} %{DATA:syslog_program}(?:\[%{POSINT:syslog_pid}\])?: %{GREEDYDATA:syslog_message}"</span> <span class="token punctuation">}</span>
                add_field <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span> <span class="token string">"received_at"</span>, <span class="token string">"%{@timestamp}"</span> <span class="token punctuation">]</span>
                add_field <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span> <span class="token string">"received_from"</span>, <span class="token string">"%{host}"</span> <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
       <span class="token function">date</span> <span class="token punctuation">{<!-- --></span>
             match <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span> <span class="token string">"syslog_timestamp"</span>, <span class="token string">"MMM  d HH:mm:ss"</span>, <span class="token string">"MMM dd HH:mm:ss"</span> <span class="token punctuation">]</span>
           <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

output<span class="token punctuation">{<!-- --></span>
    stdout<span class="token punctuation">{<!-- --></span>
        codec<span class="token operator">=</span><span class="token operator">&gt;</span> rubydebug
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>检查配置文件是否可用</p> 
<pre><code class="prism language-shell"><span class="token function">cd</span> /export/servers/es/logstash-6.7.0
bin/logstash -f /export/servers/es/logstash-6.7.0/config/syslog.conf -t
</code></pre> 
<p>启动服务<br> 执行以下命令启动logstash服务</p> 
<pre><code class="prism language-shell"><span class="token function">cd</span> /export/servers/es/logstash-6.7.0
bin/logstash -f /export/servers/es/logstash-6.7.0/config/syslog.conf
</code></pre> 
<p>发送数据<br> 修改系统日志配置文件</p> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> vim /etc/rsyslog.conf
</code></pre> 
<p>添加一行以下配置<br> <em>.</em> @@node01:6789</p> 
<p>#重启系统日志服务</p> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> /etc/init.d/rsyslog restart
</code></pre> 
<p>其它参数说明<br> 在logstash中的grok是正则表达式，用来解析当前数据<br> 原始数据其实是：</p> 
<pre><code class="prism language-shell">Dec 23 12:11:43 louis postfix/smtpd<span class="token punctuation">[</span>31499<span class="token punctuation">]</span>: connect from unknown<span class="token punctuation">[</span>95.75.93.154<span class="token punctuation">]</span>
Jun 05 08:00:00 louis named<span class="token punctuation">[</span>16000<span class="token punctuation">]</span>: client 199.48.164.7<span class="token comment">#64817: query (cache) 'amsterdamboothuren.com/MX/IN' denied</span>
Jun 05 08:10:00 louis CRON<span class="token punctuation">[</span>620<span class="token punctuation">]</span>: <span class="token punctuation">(</span>www-data<span class="token punctuation">)</span> CMD <span class="token punctuation">(</span>php /usr/share/cacti/site/poller.php <span class="token operator">&gt;</span>/dev/null 2<span class="token operator">&gt;</span>/var/log/cacti/poller-error.log<span class="token punctuation">)</span>
Jun 05 08:05:06 louis rsyslogd: <span class="token punctuation">[</span>origin software<span class="token operator">=</span><span class="token string">"rsyslogd"</span> swVersion<span class="token operator">=</span><span class="token string">"4.2.0"</span> x-pid<span class="token operator">=</span><span class="token string">"2253"</span> x-info<span class="token operator">=</span><span class="token string">"http://www.rsyslog.com"</span><span class="token punctuation">]</span> rsyslogd was HUPed, <span class="token function">type</span> <span class="token string">'lightweight'</span><span class="token keyword">.</span>
</code></pre> 
<h3><a id="4filter_201"></a>4、filter插件</h3> 
<p>Logstash之所以强悍的主要原因是filter插件；通过过滤器的各种组合可以得到我们想要的结构化数据。</p> 
<h4><a id="1grok_203"></a>1、grok正则表达式</h4> 
<p>grok正则表达式是logstash非常重要的一个环节；可以通过grok非常方便的将数据拆分和索引<br> 语法格式：<br> (?pattern)<br> ？表示要取出里面的值，pattern就是正则表达式</p> 
<h5><a id="1_208"></a>1、收集控制台输入数据，采集日期时间出来</h5> 
<p>第一步：开发配置文件</p> 
<pre><code class="prism language-shell"><span class="token function">cd</span> /export/servers/es/logstash-6.7.0/config/
vim filter.conf
input <span class="token punctuation">{<!-- --></span>stdin<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">}</span> filter <span class="token punctuation">{<!-- --></span>
        grok <span class="token punctuation">{<!-- --></span>
                match <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
<span class="token string">"message"</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"(?&lt;date&gt;\d+\.\d+)\s+"</span>
                <span class="token punctuation">}</span>       
        <span class="token punctuation">}</span>       
<span class="token punctuation">}</span>       
output <span class="token punctuation">{<!-- --></span>stdout<span class="token punctuation">{<!-- --></span>codec <span class="token operator">=</span><span class="token operator">&gt;</span> rubydebug<span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> 
<p>第二步：启动logstash服务</p> 
<pre><code class="prism language-shell"><span class="token function">cd</span> /export/servers/es/logstash-6.7.0/
bin/logstash -f /export/servers/es/logstash-6.7.0/config/filter.conf
</code></pre> 
<p>第三步：控制台输入文字<br> 5.20 今天天气还不错ya</p> 
<h5><a id="2groknginx_231"></a>2、使用grok收集nginx日志数据</h5> 
<p>nginx一般打印出来的日志格式如下</p> 
<pre><code class="prism language-shell">36.157.150.1 - - <span class="token punctuation">[</span>05/Nov/2018:12:59:28 +0800<span class="token punctuation">]</span> <span class="token string">"GET /phpmyadmin_8c1019c9c0de7a0f/js/get_scripts.js.php?scripts%5B%5D=jquery/jquery-1.11.1.min.js&amp;scripts%5B%5D=sprintf.js&amp;scripts%5B%5D=ajax.js&amp;scripts%5B%5D=keyhandler.js&amp;scripts%5B%5D=jquery/jquery-ui-1.11.2.min.js&amp;scripts%5B%5D=jquery/jquery.cookie.js&amp;scripts%5B%5D=jquery/jquery.mousewheel.js&amp;scripts%5B%5D=jquery/jquery.event.drag-2.2.js&amp;scripts%5B%5D=jquery/jquery-ui-timepicker-addon.js&amp;scripts%5B%5D=jquery/jquery.ba-hashchange-1.3.js HTTP/1.1"</span> 200 139613 <span class="token string">"-"</span> <span class="token string">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/45.0.2454.101 Safari/537.36"</span>
</code></pre> 
<p>这种日志是非格式化的，通常，我们获取到日志后，还要使用mapreduce 或者spark 做一下清洗操作，<br> 就是将非格式化日志编程格式化日志；<br> 在清洗的时候，如果日志的数据量比较大，那么也是需要花费一定的时间的；<br> 所以可以使用logstash 的grok 功能，将nginx 的非格式化数据采集成格式化数据：</p> 
<h6><a id="grok_241"></a>第一步：安装grok插件</h6> 
<p>第一种方式安装：在线安装（强烈不推荐）<br> 在线安装grok插件</p> 
<pre><code class="prism language-shell"><span class="token function">cd</span> /export/servers/es/logstash-6.7.0/
vim Gemfile
<span class="token comment">#source 'https://rubygems.org'    # 将这个镜像源注释掉</span>
<span class="token function">source</span> https://gems.ruby-china.com/  <span class="token comment"># 配置成中国的这个镜像源</span>
</code></pre> 
<p>准备在线安装</p> 
<pre><code class="prism language-shell"><span class="token function">cd</span> /export/servers/es/logstash-6.7.0/
bin/logstash-plugin  <span class="token function">install</span> logstash-filter-grok
</code></pre> 
<p>第二种安装方式，直接使用我已经下载好的安装包进行本地安装（强烈推荐使用）<br> 上传我们的压缩包logstash-filter-grok-4.0.4.zip上传到/export/servers/es/logstash-6.7.0 这个路径下面<br> 然后准备执行本地安装</p> 
<pre><code class="prism language-shell"><span class="token function">cd</span> /export/servers/es/logstash-6.7.0/
bin/logstash-plugin <span class="token function">install</span> file:///export/servers/es/logstash-6.7.0/logstash-filter-grok-4.0.4.zip
</code></pre> 
<p>安装成功之后查看logstash的插件列表</p> 
<pre><code class="prism language-shell"><span class="token function">cd</span> /export/servers/es/logstash-6.7.0/
bin/logstash-plugin list
</code></pre> 
<h6><a id="logstash_267"></a>第二步：开发logstash的配置文件</h6> 
<p>定义logstash的配置文件如下，我们从控制台输入nginx的日志数据，然后经过filter的过滤，将我们的日志文件转换成为标准的数据格式</p> 
<pre><code class="prism language-shell"><span class="token function">cd</span> /export/servers/es/logstash-6.7.0/config
vim monitor_nginx.conf

input <span class="token punctuation">{<!-- --></span>stdin<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">}</span>
filter <span class="token punctuation">{<!-- --></span>
grok <span class="token punctuation">{<!-- --></span>
match <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
<span class="token string">"message"</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"%{IPORHOST:clientip} \- \- \[%{HTTPDATE:time_local}\] \"(?:%{WORD:method} %{NOTSPACE:request}(?:HTTP/%{NUMBER:httpversion})?|%{DATA:rawrequest})\" %{NUMBER:status} %{NUMBER:body_bytes_sent} %{QS:http_referer} %{QS:agent}"</span>
         <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
output <span class="token punctuation">{<!-- --></span>stdout<span class="token punctuation">{<!-- --></span>codec <span class="token operator">=</span><span class="token operator">&gt;</span> rubydebug<span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> 
<h6><a id="logstash_284"></a>第三步：启动logstash</h6> 
<p>执行以下命令启动logstash</p> 
<pre><code class="prism language-shell"><span class="token function">cd</span> /export/servers/es/logstash-6.7.0
bin/logstash -f /export/servers/es/logstash-6.7.0/config/monitor_nginx.conf
</code></pre> 
<h6><a id="nginx_290"></a>第四步：从控制台输入nginx日志文件数据</h6> 
<p>输入第一条数据</p> 
<pre><code class="prism language-shell">36.157.150.1 - - <span class="token punctuation">[</span>05/Nov/2018:12:59:27 +0800<span class="token punctuation">]</span> <span class="token string">"GET /phpmyadmin_8c1019c9c0de7a0f/js/messages.php?lang=zh_CN&amp;db=&amp;collation_connection=utf8_unicode_ci&amp;token=6a44d72481633c90bffcfd42f11e25a1 HTTP/1.1"</span> 200 8131 <span class="token string">"-"</span> <span class="token string">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/45.0.2454.101 Safari/537.36"</span>
</code></pre> 
<p>输入第二条数据</p> 
<pre><code class="prism language-shell">36.157.150.1 - - <span class="token punctuation">[</span>05/Nov/2018:12:59:28 +0800<span class="token punctuation">]</span> <span class="token string">"GET /phpmyadmin_8c1019c9c0de7a0f/js/get_scripts.js.php?scripts%5B%5D=jquery/jquery-1.11.1.min.js&amp;scripts%5B%5D=sprintf.js&amp;scripts%5B%5D=ajax.js&amp;scripts%5B%5D=keyhandler.js&amp;scripts%5B%5D=jquery/jquery-ui-1.11.2.min.js&amp;scripts%5B%5D=jquery/jquery.cookie.js&amp;scripts%5B%5D=jquery/jquery.mousewheel.js&amp;scripts%5B%5D=jquery/jquery.event.drag-2.2.js&amp;scripts%5B%5D=jquery/jquery-ui-timepicker-addon.js&amp;scripts%5B%5D=jquery/jquery.ba-hashchange-1.3.js HTTP/1.1"</span> 200 139613 <span class="token string">"-"</span> <span class="token string">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/45.0.2454.101 Safari/537.36"</span>
</code></pre> 
<h3><a id="5_Output_299"></a>5、 Output插件</h3> 
<h4><a id="1__300"></a>1 标准输出到控制台</h4> 
<p>将我们收集的数据直接打印到控制台</p> 
<pre><code class="prism language-shell">output <span class="token punctuation">{<!-- --></span>
    stdout <span class="token punctuation">{<!-- --></span>
        codec <span class="token operator">=</span><span class="token operator">&gt;</span> rubydebug
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
bin/logstash -e <span class="token string">'input{stdin{}}output{stdout{codec=&gt;rubydebug}}'</span>
<span class="token punctuation">[</span>es@node01 logstash<span class="token punctuation">]</span>$ bin/logstash -e <span class="token string">'input{stdin{}}output{stdout{codec=&gt;rubydebug}}'</span>
hello
</code></pre> 
<h4><a id="2_file_312"></a>2 将采集数据保存到file文件中</h4> 
<p>logstash也可以将收集到的数据写入到文件当中去永久保存，接下来我们来看看logstash如何配置以实现将数据写入到文件当中</p> 
<h5><a id="logstash_314"></a>第一步：开发logstash的配置文件</h5> 
<pre><code class="prism language-shell"><span class="token function">cd</span> /export/servers/es/logstash-6.7.0/config
vim output_file.conf

input <span class="token punctuation">{<!-- --></span>stdin<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">}</span>
output <span class="token punctuation">{<!-- --></span>
    <span class="token function">file</span> <span class="token punctuation">{<!-- --></span>
        path <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"/export/servers/es/datas/%{+YYYY-MM-dd}-%{host}.txt"</span>
        codec <span class="token operator">=</span><span class="token operator">&gt;</span> line <span class="token punctuation">{<!-- --></span>
            <span class="token function">format</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"%{message}"</span>
        <span class="token punctuation">}</span>
        flush_interval <span class="token operator">=</span><span class="token operator">&gt;</span> 0
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="logstash_330"></a>第二步：检测配置文件并启动logstash服务</h5> 
<pre><code class="prism language-shell"><span class="token function">cd</span> /export/servers/es/logstash-6.7.0
</code></pre> 
<p>检测配置文件是否正确</p> 
<pre><code class="prism language-shell">bin/logstash -f config/output_file.conf -t
</code></pre> 
<p>启动服务，然后从控制台输入一些数据</p> 
<pre><code class="prism language-shell">bin/logstash -f config/output_file.conf
</code></pre> 
<p>查看文件写入的内容</p> 
<pre><code class="prism language-shell"><span class="token function">cd</span> /export/servers/es/datas
<span class="token function">more</span> 2018-11-08-node01.hadoop.com.txt
</code></pre> 
<h4><a id="3_elasticsearch_348"></a>3 将采集数据保存到elasticsearch</h4> 
<h5><a id="logstash_349"></a>第一步：开发logstash的配置文件</h5> 
<pre><code class="prism language-shell"><span class="token function">cd</span> /export/servers/es/logstash-6.7.0/config
vim output_es.conf
input <span class="token punctuation">{<!-- --></span>stdin<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">}</span>
output <span class="token punctuation">{<!-- --></span>
    elasticsearch <span class="token punctuation">{<!-- --></span>
        hosts <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token string">"node01:9200"</span><span class="token punctuation">]</span>
        index <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"logstash-%{+YYYY.MM.dd}"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这个index是保存到elasticsearch上的索引名称，如何命名特别重要，因为我们很可能后续根据某些需求做查询，所以最好带时间，因为我们在中间加上type，就代表不同的业务，这样我们在查询当天数据的时候，就可以根据类型+时间做范围查询</p> 
<h5><a id="logstash_362"></a>第二步：检测配置文件并启动logstash</h5> 
<p>检测配置文件是否正确</p> 
<pre><code class="prism language-shell"><span class="token function">cd</span> /export/servers/es/logstash-6.7.0
bin/logstash -f config/output_es.conf -t 
</code></pre> 
<p>启动logstash</p> 
<pre><code class="prism language-shell">bin/logstash -f config/output_es.conf
</code></pre> 
<h5><a id="es_373"></a>第三步：es当中查看数据</h5> 
<p>访问<br> http://node01:9100/<br> 查看es当中的数据</p> 
<p>注意：<br> 更多的input，filter，output组件参见以下链接<br> https://www.elastic.co/guide/en/logstash/current/index.html</p> 
<h2><a id="16logStashES_387"></a>16、logStash+ES综合案例</h2> 
<p>ELK Stack全量日志查询<br> 在实际工作当中，我们经常会对服务器当中产生的各种日志比较感兴趣，因为产生的日志可以很好的说明我们的服务器的工作状态是否正常，日志的也可以供我们排查各种错误等。所以很多时候我们都会收集各种日志进行汇总，方便我们统一的查看，有了ELK技术栈之后，我们就可以很轻松方便的使用logstash来进行收集我们的日志数据，然后将数据存储到ES当中，然后通过kibana的可视化工具来查看我们的日志数据了</p> 
<h3><a id="1_393"></a>1、采集服务器运行产生的日志</h3> 
<h4><a id="11rsyslog_394"></a>1.1、rsyslog的基本介绍</h4> 
<p>每台linux服务器运行的时候，系统都会产生一些日志出来，我们可以收集这些日志以便于我们查看linux服务器运行的状况等<br> Rsyslog 是CentOS6.X 自带的一款系统日志工具：<br> 具有以下多种特性<br> 1.支持多线程<br> 2.支持TCP,SSL,TLS,RELP 等协议<br> 3.支持将日志写入MySQL, PGSQL, Oracle 等多种关系型数据中<br> 4.拥有强大的过滤器，可实现过滤系统信息中的任意部分<br> 5.可以自定义日志输出格式<br> 接下来我们来看如何通过rsyslog来收集我们的系统日志<br> Rsyslog 配置文件介绍：<br> /etc/rsyslog.conf 文件：</p> 
<pre><code class="prism language-shell">*.info<span class="token punctuation">;</span>mail.none<span class="token punctuation">;</span>authpriv.none<span class="token punctuation">;</span>cron.none	/var/log/messages.	各类型日志存放位置
cron.*	/var/log/cron	具体日志存放的位置
authpriv.*	/var/log/secure	认证授权认证
mail.*	-/var/log/maillog	邮件日志
cron.*	/var/log/cron	任务计划相关日志
kern		内核相关日志
<span class="token function">lpr</span>		打印
mark<span class="token punctuation">(</span>syslog<span class="token punctuation">)</span>		rsyslog 服务内部的信
息,时间标识
news		新闻组
user		用户程序产生的相关信
息
uucp		协议
local 0~7		用户自定义日志级别
</code></pre> 
<p>日志级别：<br> rsyslog 共有7 种日志级别，数字代号从 0~7。具体的意义如下所示：</p> 
<pre><code class="prism language-shell">0 debug –有调式信息的，日志信息最多
1 info 一般信息的日志，最常用
2 notice –最具有重要性的普通条件的信息
3 warning –警告级别
4 err –错误级别，阻止某个功能或者模块不能正常工作的信息
5 crit –严重级别，阻止整个系统或者整个软件不能正常工作的信息
6 alert –需要立刻修改的信息
7 emerg –内核崩溃等严重信息
</code></pre> 
<p>本项目中，将日志级别调整成3，并将日志信息发送至node01服务器的6789这个端口</p> 
<h4><a id="12rsyslog_435"></a>1.2、修改rsyslog的配置文件</h4> 
<p>我们修改node01服务器的rsyslog的配置,</p> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> vim /etc/rsyslog.conf
</code></pre> 
<p>添加以下三行配置</p> 
<pre><code class="prism language-shell">local3.* /var/log/boot.log
*.warning /var/log/warning_Log
*.* @@node01:6789
</code></pre> 
<h4><a id="13linuxrsyslog_447"></a>1.3、重启linux服务器的rsyslog服务</h4> 
<p>执行以下命令重启rsyslog服务</p> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> /etc/init.d/rsyslog restart
</code></pre> 
<h4><a id="14logstashrsyslog_452"></a>1.4、开发logstash的配置文件，收集rsyslog日志</h4> 
<p>切换到logstash的配置文件目录下，开发logstash的配置文件</p> 
<pre><code class="prism language-shell"><span class="token function">cd</span> /export/servers/es/logstash-6.7.0/config
vim rsyslog.conf

input <span class="token punctuation">{<!-- --></span>
    tcp <span class="token punctuation">{<!-- --></span>
    port <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"6789"</span>   <span class="token comment">#监控6789端口</span>
    <span class="token function">type</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"rsyslog"</span>   <span class="token comment">#日志类型是rsyslog</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
filter <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"rsyslog"</span> <span class="token punctuation">{<!-- --></span>   <span class="token comment"># 做一次判断，只要从6789端口过来的rsyslog日志</span>
    grok <span class="token punctuation">{<!-- --></span> <span class="token comment"># 通过正则表达式，取出想要的字段</span>
      match <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"message"</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"%{SYSLOGTIMESTAMP:syslog_timestamp} %{SYSLOGHOST:syslog_hostname} %{DATA:syslog_program}(?:\[%{POSINT:syslog_pid}\])?: %{GREEDYDATA:syslog_message}"</span> <span class="token punctuation">}</span>
      add_field <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span> <span class="token string">"received_at"</span>, <span class="token string">"%{@timestamp}"</span> <span class="token punctuation">]</span>
      add_field <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span> <span class="token string">"received_from"</span>, <span class="token string">"%{host}"</span> <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    <span class="token function">date</span> <span class="token punctuation">{<!-- --></span>
      match <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span> <span class="token string">"syslog_timestamp"</span>, <span class="token string">"MMM  d HH:mm:ss"</span>, <span class="token string">"MMM dd HH:mm:ss"</span> <span class="token punctuation">]</span> <span class="token comment">#将系统的日志格式化成标准国际化时间</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
output<span class="token punctuation">{<!-- --></span>   <span class="token comment">#将日志打入elasticsearch</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"rsyslog"</span><span class="token punctuation">{<!-- --></span>
       stdout<span class="token punctuation">{<!-- --></span>codec<span class="token operator">=</span><span class="token operator">&gt;</span>rubydebug<span class="token punctuation">}</span>
       elasticsearch <span class="token punctuation">{<!-- --></span>
       action <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"index"</span>
       hosts  <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"node01:9200"</span>
       index  <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"logstash-%{type}-%{+yyyy.MM.dd}"</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="15logstash_487"></a>1.5、启动logstash服务</h4> 
<p>执行以下命令启动logstash服务</p> 
<pre><code class="prism language-shell"><span class="token function">cd</span> /export/servers/es/logstash-6.7.0
bin/logstash -f config/rsyslog.conf
</code></pre> 
<h3><a id="2_493"></a>2、采集服务器用户操作所有历史日志</h3> 
<p>用户在命令行环境下的操作日志都会被系统记录下来；比如我们输入history命令，都会展示出每一个用户输入过的命令；<br> .bash_history文件，这个日志格式我们可以定义成我们需要显示的内容，方便我们排查或者做入侵检查的时候；<br> 自定义日志格式：</p> 
<pre><code class="prism language-shell">HISTFILESIZE<span class="token operator">=</span>4000     <span class="token comment">#保存命令的记录总数</span>
HISTSIZE<span class="token operator">=</span>4000         <span class="token comment">#  history 命令输出的记录数</span>
HISTTIMEFORMAT<span class="token operator">=</span><span class="token string">'%F %T'</span>   <span class="token comment">#输出时间格式</span>
<span class="token function">export</span> HISTTIMEFORMAT.  <span class="token comment">#自定义日志输出格式，也就是取出我们想要的字段，以json的形式</span>
HISTTIMEFORMAT修改线上的相关格式
PROMPT_COMMAND实时记录历史命令（一般用在存储history命令道文件中）
</code></pre> 
<h4><a id="_505"></a>第一步：定义日志格式</h4> 
<p>修改/etc/bashrc配置文件，然后添加以下配置</p> 
<pre><code class="prism language-shell"><span class="token function">sudo</span>  vim /etc/bashrc
HISTDIR<span class="token operator">=</span><span class="token string">'/var/log/command.log'</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -f <span class="token variable">$HISTDIR</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
<span class="token function">touch</span> <span class="token variable">$HISTDIR</span>
<span class="token function">chmod</span> 666 <span class="token variable">$HISTDIR</span>
<span class="token keyword">fi</span>
<span class="token function">export</span> HISTTIMEFORMAT<span class="token operator">=</span><span class="token string">"{\"TIME\":\"%F%T\",\"HOSTNAME\":\"<span class="token variable">$HOSTNAME</span>\",\"LI\":\"<span class="token variable"><span class="token variable">$(</span><span class="token function">who</span> am i 2<span class="token operator">&gt;</span>/dev/null<span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print <span class="token variable">$NF</span>}'</span><span class="token operator">|</span><span class="token function">sed</span> -e's/<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token variable">)</span></span>]//g')\",\"LOGIN_USER\":\"<span class="token variable"><span class="token variable">$(</span><span class="token function">who</span> am i<span class="token operator">|</span><span class="token function">awk</span> <span class="token string">'{print<span class="token variable">$1</span>}'</span><span class="token variable">)</span></span>\",\"CHECK_USER\":\"<span class="token variable">${USER}</span>\",\"CMD\":\""</span>

<span class="token function">export</span> PROMPT_COMMAND<span class="token operator">=</span><span class="token string">'history 1|tail -1|sed "s/^[ ]\+[0-9]\+  //"|sed "s/$/\"}/"&gt;&gt;/var/log/command.log'</span>
</code></pre> 
<p>使配置修改立即生效<br> 这个命令必须使用root用户来执行</p> 
<pre><code class="prism language-shell"><span class="token function">export</span> PROMPT_COMMAND<span class="token operator">=</span><span class="token string">'history &gt;&gt; /var/log/command.log'</span>
<span class="token function">source</span> /etc/bashrc
</code></pre> 
<h4><a id="logstash_524"></a>第二步：开发logstash的配置文件</h4> 
<p>继续开发我们logstash的配置文件</p> 
<pre><code class="prism language-shell"><span class="token function">cd</span> /export/servers/es/logstash-6.7.0/config
vim history.conf
input <span class="token punctuation">{<!-- --></span>
    <span class="token function">file</span> <span class="token punctuation">{<!-- --></span>
        path <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token string">"/var/log/command.log"</span><span class="token punctuation">]</span>
        <span class="token function">type</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"command"</span>
        codec <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"json"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
output<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"command"</span><span class="token punctuation">{<!-- --></span>
       stdout<span class="token punctuation">{<!-- --></span>codec<span class="token operator">=</span><span class="token operator">&gt;</span>rubydebug<span class="token punctuation">}</span>
       elasticsearch <span class="token punctuation">{<!-- --></span>
       hosts  <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"node01:9200"</span>
       index  <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"history-%{+yyyy.MM.dd}"</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="logstash_546"></a>第三步：启动logstash</h4> 
<p>启动logstash：</p> 
<pre><code class="prism language-shell"><span class="token function">cd</span> /export/servers/es/logstash-6.7.0
bin/logstash -f config/history.conf
</code></pre> 
<p>执行source，让环境变量立即生效<br> source /etc/bashrc<br> node01服务器任意目录执行任意命令，然后去9100页面，查看是否已经把history日志灌入elasticsearch</p> 
<h3><a id="3nginxes_555"></a>3、采集nginx日志到es当中</h3> 
<h4><a id="_557"></a>第一步：上传日志文件</h4> 
<p>node01机器创建文件夹，将我们的nginx的日志都上传到</p> 
<pre><code class="prism language-shell">/export/servers/es/esdatas
<span class="token function">mkdir</span> -p  /export/servers/es/esdatas 
</code></pre> 
<h4><a id="logstash_563"></a>第二步：开发logstash的配置文件</h4> 
<pre><code class="prism language-shell"><span class="token function">cd</span> /export/servers/es/logstash-6.7.0/config
vim nginxlog.conf
input<span class="token punctuation">{<!-- --></span>
  <span class="token function">file</span> <span class="token punctuation">{<!-- --></span>
	path <span class="token operator">=</span><span class="token operator">&gt;</span>  <span class="token string">"/export/servers/es/esdatas/access.log"</span>
        <span class="token function">type</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"access.log"</span>
 	start_position <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"beginning"</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
filter <span class="token punctuation">{<!-- --></span>  
    grok <span class="token punctuation">{<!-- --></span>
            match <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
           	   <span class="token string">"message"</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"%{IPORHOST:clientip} \- \- \[%{HTTPDATE:time_local}\] \"(?:%{WORD:method} %{NOTSPACE:request}(?:HTTP/%{NUMBER:httpversion})?|%{DATA:rawrequest})\" %{NUMBER:status} %{NUMBER:body_bytes_sent} %{QS:http_referer}"</span>
		 <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
output <span class="token punctuation">{<!-- --></span>
       stdout<span class="token punctuation">{<!-- --></span>codec<span class="token operator">=</span><span class="token operator">&gt;</span>rubydebug<span class="token punctuation">}</span>
       elasticsearch <span class="token punctuation">{<!-- --></span>
                action <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"index"</span>
                hosts <span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">"node01:9200"</span>
                index <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"nginxes"</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="logstashes_590"></a>第三步：启动logstash并查看es当中的数据</h4> 
<p>执行以下命令启动logstash</p> 
<pre><code class="prism language-shell"><span class="token function">cd</span> /export/servers/es/logstash-6.7.0
bin/logstash -f /export/servers/es/logstash-6.7.0/config/nginxlog.conf
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/96f04c85369ee227475f7516c3a2332f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">解决 Navicat 无法导入带外键的json 亲测有效！</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3c601d3b9f47b5c557d106bbc694f4a4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">tcp-full.cc</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>