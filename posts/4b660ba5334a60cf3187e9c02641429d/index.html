<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>视觉拖拽软件平台：使用C&#43;&#43;/opencv/MFC/自研算法 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="视觉拖拽软件平台：使用C&#43;&#43;/opencv/MFC/自研算法" />
<meta property="og:description" content="前言 这个项目萌芽于2021年，期间在主职工作的空闲时间陆陆续续做了一些开发，包括软件框架平台和算法，这里做一下总结。
毕业后做了五年上位机软件，上一份工作离职时，感觉到对上位机的开发技能已经到了瓶颈，寻思着拓宽技能面，思考最终决定选视觉方向。去面试了两家视觉软件公司，结果没过，最终还是在原来的行业里面选择了一家公司。比较巧的是，入职的公司正在开展视觉软件二次开发任务尝试，由于之前工作有opencv的经验，便开始兼任视觉软件二次开发负责人。从视觉二次定制开发的积累，慢慢也发现他的局限性，最终，在参考商用成熟软件平台的基础上，也琢磨出来这款视觉拖拽软件平台。
做二次开发期间接触了多家商用算法库和平台软件，包括创科、凌云、OPT、海康、利珀。分析他们的平台软件，大致分为三层架构：
第一层，基础算子模块：纯算子
第二层，工具模块：调用算子，附带UI，并支持无限扩展
第三层，平台软件：工具模块的整合，支持拖拽、生产界面编辑等实际应用功能；
在支持底层算子二次开发的基础上，他们大多也支持软件平台层面的二次开发，提供工具参数修改以及图像嵌入等支持。
下面着重从几个开发瓶颈点来介绍自研视觉拖拽软件平台的开发历程。
一、可自由缩放的图像显示窗 在体验了商用视觉软件无比丝滑的图像查看窗后，面对opencv自带的图像显示窗体，图像压缩显示，无法像素级别查看等，完全无法忍受，后面就开始寻找自己写一个的方法。
一个偶然的机会，发现了GDI&#43;的CImage类，完美解决问题。用它来绘制图像，支持像素级别查看，GDI&#43;绘制图形、绘制文字的功能也能用上，也解决了图像处理结果准确显示的问题。
二、自定义图像类 图像处理中，图像类贯穿始终，opencv中是Mat,作为数据处理媒介，自研算法一定也要自己开发一个这样的处理类，用在自研算子的传参等场景。
分享两款商用算法的图像类基础定义，自研的图像类也和其类似：
//1 class scImage { public: //图像宽度 long Width() const { return m_lWidth; } //图像高度 long Height() const { return m_lHeight; } /* 略 */ //释放图像数据段，返回初始状态 virtual void Release() = 0; protected: unsigned char* m_pRawStorage;	// 图像数据 long	m_lWidth;	// 图像宽度 long	m_lHeight;	// 图像高度 long	m_lAlignModulus;	// 图像对齐模式 long	m_lWidthPadded;	// 图像实际宽度（由于对齐的需要，可能对图像行数据进行扩展，因此，图像实际宽度 &gt;= 图像宽度） long	m_lPixelSize;	// 图像单像素占用的内存字节数（Gray:8位1字节，RGB:24位3字节） }; //2 /* 图像基本功能类 */ class CPrImage { public: CPrImage(); // 构造&#43;复制 CPrImage( const CPrImage&amp; imgSrc ); // 构造&#43;创建 CPrImage( int nWidth, int nHeight, int nFormat=1 ); // 析构函数 virtual	~CPrImage(); /* 略 */ // 释放 void Release(); protected: int	m_nWidth;	// 宽度 int	m_nHeight;	// 高度 int	m_nFormat;	// 像素格式 int	m_nLineByte;	// 行字节数 UINT	m_nSizeByte;	// 总字节数 BYTE*	m_pDataBits;	// 图像数据 };	// CPrImage 三、自研算子 这一快没多少发言权，底子比较薄，也主要靠一腔热血摸索，磕磕绊绊写出来一些，主要有：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/4b660ba5334a60cf3187e9c02641429d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-11T11:45:57+08:00" />
<meta property="article:modified_time" content="2023-08-11T11:45:57+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">视觉拖拽软件平台：使用C&#43;&#43;/opencv/MFC/自研算法</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h5><a id="_0"></a>前言</h5> 
<p>这个项目萌芽于2021年，期间在主职工作的空闲时间陆陆续续做了一些开发，包括软件框架平台和算法，这里做一下总结。</p> 
<p>毕业后做了五年上位机软件，上一份工作离职时，感觉到对上位机的开发技能已经到了瓶颈，寻思着拓宽技能面，思考最终决定选视觉方向。去面试了两家视觉软件公司，结果没过，最终还是在原来的行业里面选择了一家公司。比较巧的是，入职的公司正在开展视觉软件二次开发任务尝试，由于之前工作有opencv的经验，便开始兼任视觉软件二次开发负责人。从视觉二次定制开发的积累，慢慢也发现他的局限性，最终，在参考商用成熟软件平台的基础上，也琢磨出来这款视觉拖拽软件平台。</p> 
<p>做二次开发期间接触了多家商用算法库和平台软件，包括创科、凌云、OPT、海康、利珀。分析他们的平台软件，大致分为三层架构：<br> 第一层，基础算子模块：纯算子<br> 第二层，工具模块：调用算子，附带UI，并支持无限扩展<br> 第三层，平台软件：工具模块的整合，支持拖拽、生产界面编辑等实际应用功能；<br> 在支持底层算子二次开发的基础上，他们大多也支持软件平台层面的二次开发，提供工具参数修改以及图像嵌入等支持。</p> 
<p>下面着重从几个开发瓶颈点来介绍自研视觉拖拽软件平台的开发历程。</p> 
<h5><a id="_13"></a>一、可自由缩放的图像显示窗</h5> 
<p>在体验了商用视觉软件无比丝滑的图像查看窗后，面对opencv自带的图像显示窗体，图像压缩显示，无法像素级别查看等，完全无法忍受，后面就开始寻找自己写一个的方法。<br> 一个偶然的机会，发现了GDI+的CImage类，完美解决问题。用它来绘制图像，支持像素级别查看，GDI+绘制图形、绘制文字的功能也能用上，也解决了图像处理结果准确显示的问题。</p> 
<h5><a id="_17"></a>二、自定义图像类</h5> 
<p>图像处理中，图像类贯穿始终，opencv中是Mat,作为数据处理媒介，自研算法一定也要自己开发一个这样的处理类，用在自研算子的传参等场景。<br> 分享两款商用算法的图像类基础定义，自研的图像类也和其类似：</p> 
<pre><code class="prism language-cpp"><span class="token comment">//1</span>
<span class="token keyword">class</span> <span class="token class-name">scImage</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token comment">//图像宽度</span>
	<span class="token keyword">long</span> <span class="token function">Width</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> m_lWidth<span class="token punctuation">;</span> <span class="token punctuation">}</span>

	<span class="token comment">//图像高度</span>
	<span class="token keyword">long</span> <span class="token function">Height</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> m_lHeight<span class="token punctuation">;</span> <span class="token punctuation">}</span>
	<span class="token comment">/*
	略
	*/</span>
	<span class="token comment">//释放图像数据段，返回初始状态</span>
	<span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">protected</span><span class="token operator">:</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> m_pRawStorage<span class="token punctuation">;</span>	<span class="token comment">// 图像数据</span>
	<span class="token keyword">long</span>	m_lWidth<span class="token punctuation">;</span>				<span class="token comment">// 图像宽度</span>
	<span class="token keyword">long</span>	m_lHeight<span class="token punctuation">;</span>				<span class="token comment">// 图像高度</span>
	<span class="token keyword">long</span>	m_lAlignModulus<span class="token punctuation">;</span>		<span class="token comment">// 图像对齐模式</span>
	<span class="token keyword">long</span>	m_lWidthPadded<span class="token punctuation">;</span>			<span class="token comment">// 图像实际宽度（由于对齐的需要，可能对图像行数据进行扩展，因此，图像实际宽度 &gt;= 图像宽度）</span>
	<span class="token keyword">long</span>	m_lPixelSize<span class="token punctuation">;</span>			<span class="token comment">// 图像单像素占用的内存字节数（Gray:8位1字节，RGB:24位3字节）</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//2</span>
<span class="token comment">/* 图像基本功能类 */</span>
<span class="token keyword">class</span> <span class="token class-name">CPrImage</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token function">CPrImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 构造+复制</span>
	<span class="token function">CPrImage</span><span class="token punctuation">(</span> <span class="token keyword">const</span> CPrImage<span class="token operator">&amp;</span> imgSrc <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 构造+创建</span>
	<span class="token function">CPrImage</span><span class="token punctuation">(</span> <span class="token keyword">int</span> nWidth<span class="token punctuation">,</span> <span class="token keyword">int</span> nHeight<span class="token punctuation">,</span> <span class="token keyword">int</span> nFormat<span class="token operator">=</span><span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 析构函数</span>
	<span class="token keyword">virtual</span>	<span class="token operator">~</span><span class="token function">CPrImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/*
	略
	*/</span>
	<span class="token comment">// 释放</span>
	<span class="token keyword">void</span> <span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">protected</span><span class="token operator">:</span>
	<span class="token keyword">int</span>		m_nWidth<span class="token punctuation">;</span>		<span class="token comment">// 宽度</span>
	<span class="token keyword">int</span>		m_nHeight<span class="token punctuation">;</span>		<span class="token comment">// 高度</span>
	<span class="token keyword">int</span>		m_nFormat<span class="token punctuation">;</span>		<span class="token comment">// 像素格式</span>
	<span class="token keyword">int</span>		m_nLineByte<span class="token punctuation">;</span>	<span class="token comment">// 行字节数</span>
	UINT	m_nSizeByte<span class="token punctuation">;</span>	<span class="token comment">// 总字节数</span>
	BYTE<span class="token operator">*</span>	m_pDataBits<span class="token punctuation">;</span>	<span class="token comment">// 图像数据</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>	<span class="token comment">// CPrImage</span>
</code></pre> 
<h5><a id="_76"></a>三、自研算子</h5> 
<p>这一快没多少发言权，底子比较薄，也主要靠一腔热血摸索，磕磕绊绊写出来一些，主要有：<br> 【图像匹配】<br> 【相机标定】<br> 【坐标系统】<br> 【搜索直线】【搜索圆】等。<br> <img src="https://images2.imgbox.com/fe/0b/p4GxtNzB_o.gif" alt="图像匹配效果图"><br> <img src="https://images2.imgbox.com/eb/59/D598nUTu_o.gif" alt="图像匹配效果图2"><br> <img src="https://images2.imgbox.com/12/23/itEZEGyR_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_88"></a>四、工具模块设计</h5> 
<p>工具模块是平台软件的基础，需要考虑各种兼容并包情况。<br> 利用C++派生类与继承的面向对象程序设计思想，将基类做强大一点；新增工具直接派生自基类，只需要实现自身专用的功能代码，可以很好的解决工具无限扩展的问题。<br> 基类如何设计，如何做大做强，这个在商用视觉平台中参考较少，其一般不提供自定义工具扩展。个人摸索出来基类设计一般要包含以下模块功能：</p> 
<ol><li>参数接口：提供属性参数、输入参数、输出参数等快捷增加的接口，派生类可快速配置；</li><li>显示功能：拖拽效果自绘制相关内容，派生的工具不再需要管理；</li><li>链接：支持参数变量的相互链接；</li><li>基础调参界面支持：大部分的工具不需要写界面，采用基类提供的标准界面调参即可。</li></ol> 
<p>工具实现类示例：</p> 
<pre><code class="prism language-cpp"><span class="token comment">// 延时 工具快</span>
<span class="token keyword">class</span> <span class="token class-name">CtryControlDelay</span> <span class="token operator">:</span><span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">IToolControl</span></span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token function">CtryControlDelay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">~</span><span class="token function">CtryControlDelay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	IToolBasis<span class="token operator">*</span> <span class="token function">Clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token function">Copy</span><span class="token punctuation">(</span><span class="token keyword">const</span> CtryControlDelay <span class="token operator">*</span>pSrc<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token function">Exchange</span><span class="token punctuation">(</span>trFileStore <span class="token operator">&amp;</span>fs<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token comment">//执行</span>
	<span class="token keyword">int</span> <span class="token function">Execute</span><span class="token punctuation">(</span>IExecuteInOut <span class="token operator">*</span>_p <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token keyword">int</span> m_Time<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 表达式 工具快</span>
<span class="token keyword">class</span> <span class="token class-name">CtryControlExpression</span> <span class="token operator">:</span><span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">IToolControl</span></span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token function">CtryControlExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">~</span><span class="token function">CtryControlExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	IToolBasis<span class="token operator">*</span> <span class="token function">Clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token function">Copy</span><span class="token punctuation">(</span><span class="token keyword">const</span> CtryControlExpression <span class="token operator">*</span>pSrc<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token function">Exchange</span><span class="token punctuation">(</span>trFileStore <span class="token operator">&amp;</span>fs<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token comment">//工具属性界面</span>
	<span class="token keyword">bool</span> <span class="token function">HasPropertyWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
	<span class="token keyword">int</span> <span class="token function">Property</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token comment">//执行</span>
	<span class="token keyword">int</span> <span class="token function">Execute</span><span class="token punctuation">(</span>IExecuteInOut <span class="token operator">*</span>_p <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
	std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>tryData<span class="token operator">&gt;</span> m_Vars<span class="token punctuation">;</span>	
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="_142"></a>五、流程图设计与执行</h5> 
<p>这一模块是软件平台中最影响使用评分的一点，各家实现方式不一：<br> 创科采用列表形式；<br> OPT采用列表+流程图形式；<br> 凌云采用固定流程图；<br> 海康采用自由分层的流程图；</p> 
<p>个人最开始构思时，通过了PPT中的流程图进行模拟，因此选用的方案和凌云比较接近。<br> 效果如下：<br> <img src="https://images2.imgbox.com/c4/2a/gnJIHDVO_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_153"></a>六、自定义生产界面</h5> 
<p>流程图设计对人员要求较高， 有一定上手难度。因此，催生出了更傻瓜式的生产界面，进行启、停、直接调参等操作。<br> 商业软件里 凌云和海康这块做的比较完善，功能页丰富。<br> 个人制作了一版，没充裕时间进行精细优化，以满足基本功能为主。<br> 界面编辑效果：<br> <img src="https://images2.imgbox.com/e5/1b/IlZW5W8U_o.png" alt="界面编辑效果"><br> 一种软件平台独立使用时的生产界面效果：<br> <img src="https://images2.imgbox.com/09/e6/rsfk3yq7_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_164"></a>七、平台软件的嵌入支持</h5> 
<p>自动化设备具备独立的控制软件，与视觉软件配合时形成两个软件来回切换，不便于操作，因此对视觉软件嵌入控制软件提出一些要求:</p> 
<ol><li>基本要求:视觉画面嵌入控制软件中显示——以凌云为例，就支持这种形式，其是通过OCX方式提供支持。</li><li>要求升级1：支持外部启停、提供变量访问操作接口——</li><li>要求升级2：支持方案切换——</li><li>要求升级3：画面支持外部绘图、提供鼠标消息响应——为了实现控制软件点动、显示加工细节等个性化操作；</li></ol> 
<p>对于升级3，各家开放程度不一，因为涉及主体架构，影响整体稳定性。以OPT为例，其2022年底才提供出相对完备的该类功能。</p> 
<p>个人是通过带界面的C++动态库提供上述全部支持，支持多界面嵌入，流程编辑通过弹出窗体方式，控制软件嵌入效果附图：<br> <img src="https://images2.imgbox.com/c5/e6/QcAckve3_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_177"></a>结尾</h5> 
<p>敲文字还是比敲代码慢，中间断断续续多次才完成，算作一次总结。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/85759e39ad9c4747203f06b1f48faad2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">指令集、架构、处理器、内核，芯片之间的关系</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a71a24ee4e5f598a6cd323795a26ed0e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【Hystrix技术指南】（7）故障切换的运作流程原理分析（含源码）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>