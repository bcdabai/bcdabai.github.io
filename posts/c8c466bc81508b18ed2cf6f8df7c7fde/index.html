<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android adj调整 --- computeOomAdjLSP流程详解 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android adj调整 --- computeOomAdjLSP流程详解" />
<meta property="og:description" content="Android adj调整 --- computeOomAdjLSP流程详解 Android adj调整 --- computeOomAdjLSP流程详解1. computeOomAdjLSP的参数2. 是否存在循环计算3. 没有ApplicationThread的时候的调整4. 对ProcessStateRecord进程状态记录的一些初始化5. 设置默认是否允许冻结6. 获取调整之前的一些状态7. system_server或者常驻进程的调整8. 调整之前的一些变量的定义9. top顶端app的调整10. 正在播放远端动画的调整11. instrumentation的调整12. 正在接受广播进程的调整13. 正在运行服务进程的调整14. 系统在休眠时topApp的调整15. 其它app的默认状态初始化16. 更新foregroundActivities和mHasVisibleActivities17. 更新最近使用的activity的状态18. 调整前台服务或者hasOverlayUi的进程19. 调整最近活跃的前台服务进程20. 调整强制提升到用户可感知的进程21. 调整heavy的进程21. 调整桌面应用22. 调整previous上一个使用的应用23. 循环计算时更新procState、adj、schedGroup24. 先更新一下当前计算的值到ProcessStateRecord25. 设置当前adj调整的系列号26. 调整backup备份的应用27. service服务自身和服务依赖关系调整27.1 遍历该进程的服务numberOfRunningServices27.2 根据Services自身的状态进行调整27.3 获取前台服务的能力capabilityFromFGS27.4 遍历每个服务里面的所有链接对象27.5 取出每个服务链接对象27.6 只调整自身是服务，由于客户端的链接的情况27.7 computeClients循环计算时，会先计算客户端的adj27.8 调整前获取客户端的clientAdj和clientProcState27.9 进行没有豁免优先级情况的调整27.9.1 循环计算的时候是否需要先跳过本次计算27.9.2 能力capability初始化27.9.3 低于cached activity的进程状态clientProcState约束27.9.4 如果进程设置了在低内存时托管给系统27.9.5 如果clientAdj大于当前服务的adj，则开始adj依赖关系调整27.9.6 clientProcState依赖关系调整27.9.7 service依赖关系原因的输出 27.10 BIND_WAIVE_PRIORITY == true豁免优先级调整27.11 绑定客户端对象是activity的调整 28. provider依赖关系调整28.1 只有当前是provider内容提供者进程才调整28.2 循环计算computeClients和判断是否需要跳过本次计算shouldSkipDueToCycle28.3 调整前客户端的clientAdj、clientProcState的记录28.4 clientAdj大于provider的adj才进行adj依赖关系调整28.5 clientProcState进程状态依赖调整28.6 客户端分组依赖关系调整28.7 输出provider调整的原因28.8 hasExternalProcessHandles的调整 29. recent-provider最近使用的provider调整30." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/c8c466bc81508b18ed2cf6f8df7c7fde/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-17T10:12:40+08:00" />
<meta property="article:modified_time" content="2023-11-17T10:12:40+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android adj调整 --- computeOomAdjLSP流程详解</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>Android adj调整 --- computeOomAdjLSP流程详解</h4> 
 <ul><li><a href="#Android_adj__computeOomAdjLSP_3" rel="nofollow">Android adj调整 --- computeOomAdjLSP流程详解</a></li><li><ul><li><a href="#1_computeOomAdjLSP_13" rel="nofollow">1. computeOomAdjLSP的参数</a></li><li><a href="#2__46" rel="nofollow">2. 是否存在循环计算</a></li><li><a href="#3_ApplicationThread_78" rel="nofollow">3. 没有ApplicationThread的时候的调整</a></li><li><a href="#4_ProcessStateRecord_160" rel="nofollow">4. 对ProcessStateRecord进程状态记录的一些初始化</a></li><li><a href="#5__189" rel="nofollow">5. 设置默认是否允许冻结</a></li><li><a href="#6__204" rel="nofollow">6. 获取调整之前的一些状态</a></li><li><a href="#7_system_server_228" rel="nofollow">7. system_server或者常驻进程的调整</a></li><li><a href="#8__326" rel="nofollow">8. 调整之前的一些变量的定义</a></li><li><a href="#9_topapp_355" rel="nofollow">9. top顶端app的调整</a></li><li><a href="#10__384" rel="nofollow">10. 正在播放远端动画的调整</a></li><li><a href="#11_instrumentation_402" rel="nofollow">11. instrumentation的调整</a></li><li><a href="#12__421" rel="nofollow">12. 正在接受广播进程的调整</a></li><li><a href="#13__447" rel="nofollow">13. 正在运行服务进程的调整</a></li><li><a href="#14_topApp_470" rel="nofollow">14. 系统在休眠时topApp的调整</a></li><li><a href="#15_app_491" rel="nofollow">15. 其它app的默认状态初始化</a></li><li><a href="#16_foregroundActivitiesmHasVisibleActivities_520" rel="nofollow">16. 更新foregroundActivities和mHasVisibleActivities</a></li><li><a href="#17_activity_564" rel="nofollow">17. 更新最近使用的activity的状态</a></li><li><a href="#18_hasOverlayUi_581" rel="nofollow">18. 调整前台服务或者hasOverlayUi的进程</a></li><li><a href="#19__628" rel="nofollow">19. 调整最近活跃的前台服务进程</a></li><li><a href="#20__650" rel="nofollow">20. 调整强制提升到用户可感知的进程</a></li><li><a href="#21_heavy_685" rel="nofollow">21. 调整heavy的进程</a></li><li><a href="#21__721" rel="nofollow">21. 调整桌面应用</a></li><li><a href="#22_previous_758" rel="nofollow">22. 调整previous上一个使用的应用</a></li><li><a href="#23_procStateadjschedGroup_799" rel="nofollow">23. 循环计算时更新procState、adj、schedGroup</a></li><li><a href="#24_ProcessStateRecord_823" rel="nofollow">24. 先更新一下当前计算的值到ProcessStateRecord</a></li><li><a href="#25_adj_837" rel="nofollow">25. 设置当前adj调整的系列号</a></li><li><a href="#26_backup_845" rel="nofollow">26. 调整backup备份的应用</a></li><li><a href="#27_service_883" rel="nofollow">27. service服务自身和服务依赖关系调整</a></li><li><ul><li><a href="#271_numberOfRunningServices_886" rel="nofollow">27.1 遍历该进程的服务numberOfRunningServices</a></li><li><a href="#272_Services_906" rel="nofollow">27.2 根据Services自身的状态进行调整</a></li><li><a href="#273_capabilityFromFGS_979" rel="nofollow">27.3 获取前台服务的能力capabilityFromFGS</a></li><li><a href="#274__1053" rel="nofollow">27.4 遍历每个服务里面的所有链接对象</a></li><li><a href="#275__1072" rel="nofollow">27.5 取出每个服务链接对象</a></li><li><a href="#276__1089" rel="nofollow">27.6 只调整自身是服务，由于客户端的链接的情况</a></li><li><a href="#277_computeClientsadj_1106" rel="nofollow">27.7 computeClients循环计算时，会先计算客户端的adj</a></li><li><a href="#278_clientAdjclientProcState_1139" rel="nofollow">27.8 调整前获取客户端的clientAdj和clientProcState</a></li><li><a href="#279__1161" rel="nofollow">27.9 进行没有豁免优先级情况的调整</a></li><li><ul><li><a href="#2791__1171" rel="nofollow">27.9.1 循环计算的时候是否需要先跳过本次计算</a></li><li><a href="#2792_capability_1180" rel="nofollow">27.9.2 能力capability初始化</a></li><li><a href="#2793_cached_activityclientProcState_1212" rel="nofollow">27.9.3 低于cached activity的进程状态clientProcState约束</a></li><li><a href="#2794__1226" rel="nofollow">27.9.4 如果进程设置了在低内存时托管给系统</a></li><li><a href="#2795_clientAdjadjadj_1290" rel="nofollow">27.9.5 如果clientAdj大于当前服务的adj，则开始adj依赖关系调整</a></li><li><a href="#2796_clientProcState_1418" rel="nofollow">27.9.6 clientProcState依赖关系调整</a></li><li><a href="#2797_service_1564" rel="nofollow">27.9.7 service依赖关系原因的输出</a></li></ul> 
    </li><li><a href="#2710_BIND_WAIVE_PRIORITY__true_1593" rel="nofollow">27.10 BIND_WAIVE_PRIORITY == true豁免优先级调整</a></li><li><a href="#2711_activity_1615" rel="nofollow">27.11 绑定客户端对象是activity的调整</a></li></ul> 
   </li><li><a href="#28_provider_1676" rel="nofollow">28. provider依赖关系调整</a></li><li><ul><li><a href="#281_provider_1681" rel="nofollow">28.1 只有当前是provider内容提供者进程才调整</a></li><li><a href="#282_computeClientsshouldSkipDueToCycle_1729" rel="nofollow">28.2 循环计算computeClients和判断是否需要跳过本次计算shouldSkipDueToCycle</a></li><li><a href="#283_clientAdjclientProcState_1756" rel="nofollow">28.3 调整前客户端的clientAdj、clientProcState的记录</a></li><li><a href="#284_clientAdjprovideradjadj_1781" rel="nofollow">28.4 clientAdj大于provider的adj才进行adj依赖关系调整</a></li><li><a href="#285_clientProcState_1814" rel="nofollow">28.5 clientProcState进程状态依赖调整</a></li><li><a href="#286__1851" rel="nofollow">28.6 客户端分组依赖关系调整</a></li><li><a href="#287_provider_1863" rel="nofollow">28.7 输出provider调整的原因</a></li><li><a href="#288_hasExternalProcessHandles_1891" rel="nofollow">28.8 hasExternalProcessHandles的调整</a></li></ul> 
   </li><li><a href="#29_recentproviderprovider_1941" rel="nofollow">29. recent-provider最近使用的provider调整</a></li><li><a href="#30_CACHED_1982" rel="nofollow">30. 服务相关缓存进程CACHED的调整</a></li><li><a href="#31_AB_service_2010" rel="nofollow">31. A、B service分布调整</a></li><li><a href="#32_adjmCurRawAdj_2097" rel="nofollow">32. 更新最新的adj到mCurRawAdj中</a></li><li><a href="#33_getMaxAdj_2104" rel="nofollow">33. 如果还有未处理完的getMaxAdj进程的调整</a></li><li><a href="#34_SCHED_GROUP_RESTRICTED_2120" rel="nofollow">34. 非唤醒状态时受限制分组SCHED_GROUP_RESTRICTED调整</a></li><li><a href="#35_capability_2138" rel="nofollow">35. 更新进程的能力capability</a></li><li><a href="#36_ProcessStateRecordadj_2152" rel="nofollow">36. 更新最新的状态到ProcessStateRecord，完成本次adj调整</a></li><li><a href="#37_adj_2180" rel="nofollow">37. 本次adj调整的返回值</a></li><li><a href="#38__2193" rel="nofollow">38. 其它相关代码</a></li><li><ul><li><a href="#381__2196" rel="nofollow">38.1 获取默认的进程能力</a></li><li><a href="#381_shouldSkipDueToCycle_2250" rel="nofollow">38.1 shouldSkipDueToCycle是否需要在计算依赖关系时跳过计算</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="Android_adj__computeOomAdjLSP_3"></a>Android adj调整 — computeOomAdjLSP流程详解</h2> 
<p>这次就先讲OomAdjuster.java中adj调整最为关键的函数computeOomAdjLSP，这个函数几乎占了adj调整代码1/3的代码量，非常重要，建议阅读之前先看一下之前的：<code>Android S进程的adj值</code>、<code>Android adj调整时的各类进程状态</code>。至于OomAdjuster.java里面的其它逻辑，下次有时间再来写吧。希望对大家有帮助</p> 
<p>下面是各个关系对应的表格(以adj为例)<br> <img src="https://images2.imgbox.com/7f/81/BBrtxKvi_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="1_computeOomAdjLSP_13"></a>1. computeOomAdjLSP的参数</h3> 
<p>注意此处上了2把锁<code>mService(ActivityManagerService)</code>, <code>ActivityManagerService的mProcLock</code></p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@GuardedBy</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"mService"</span><span class="token punctuation">,</span> <span class="token string">"mProcLock"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">computeOomAdjLSP</span><span class="token punctuation">(</span><span class="token class-name">ProcessRecord</span> app<span class="token punctuation">,</span> <span class="token keyword">int</span> cachedAdj<span class="token punctuation">,</span>
            <span class="token class-name">ProcessRecord</span> topApp<span class="token punctuation">,</span> <span class="token keyword">boolean</span> doingAll<span class="token punctuation">,</span> <span class="token keyword">long</span> now<span class="token punctuation">,</span> <span class="token keyword">boolean</span> cycleReEval<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> computeClients<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
</code></pre> 
<blockquote> 
 <p>//调整adj的函数（查看这个函数之前先看一下adj各个值的意思和procState各个值的含义,具体可以参考之前的文章）<br> //1. app是需要调整adj的进程<br> //2. cachedAdj是adj调整的时候的默认值(除了一些正在使用的app都是这个默认值)，默认只有一般是oldAdj或则UNKNOWN_ADJ<br> //3. topApp(当前最顶端activity)是从AMS的getTopApp(这个函数有点性能问题)里面拿到的(这里又是从ActivityTaskManagerService获得)<br> //updateTopResumedActivityIfNeeded/mRootWindowContainer.getTopDisplayFocusedRootTask/topRootTask.getResumedActivity(ActivityTaskSupervisor)<br> //-&gt; updateTopApp(ActivityTaskManagerService)，大概是意思是：top的task(writeWmTaskMoved/writeWmTaskToFront)，而且是isTopActivityFocusable和可见shouldBeVisible<br> //注意顶端activity和顶端Window不是一个概念，如在桌面的时候下拉状态栏，此时顶端activity(topApp)是桌面，而focus Window是systemui<br> //4. doingAll在这里主要是用于调整A、B service，在updateOomAdjInnerLSP时fullUpdate或者computeClients为true时才有可能设置为true<br> //而A、B service调整除了doingAll这个参数，还跟cycleReEval有关系，也就是说实际有用到的地方只有fullUpdate为true是才会调整A、B services<br> //5. now是此次调整adj的当前时间<br> //6. cycleReEval只有在设置了setContainsCycle true(如正在计算computeOomAdjLSP的时候还没计算完又跑进来，<br> //如上面的mAdjSeq == state.getAdjSeq()或者(服务/provider的客户端有这种情况的时候))，<br> //在updateOomAdjInnerLSP会让cycleReEval=true(具体可以看上面的updateOomAdjInnerLSP，大概意思是循环计算依赖)<br> //7. computeClients是否需要计算当前进程的时候计算服务、provider提供者对端的adj<br> //8. 它的返回值state.getCurAdj() &lt; prevAppAdj || state.getCurProcState() &lt; prevProcState<br> // || state.getCurCapability() != prevCapability<br> //当满足当前调整的mSetAdj(函数结束的时候)比prevAppAdj(刚进入这里mSetAdj)小的时候，或者mCurProcState有变小；这些都代表优先级提升<br> //或者mCurCapability能力不一样才返回true，其它都是false.<br> //这个返回值目前只在updateOomAdjInnerLSP中的循环计算adj中使用，用于判断是否需要中断循环调整adj，其它场景都未使用<br> //只有true才代表循环调整成功，单个进程false代表忽略，只有全部循环调整的进程都是fasle才会跳过循环调整的重试逻辑</p> 
</blockquote> 
<h3><a id="2__46"></a>2. 是否存在循环计算</h3> 
<p>设置该进程是循环计算<code>setContainsCycle(true)</code>、将循环计算的进程进程放入<code>mProcessesInCycle</code></p> 
<pre><code class="prism language-java">        <span class="token keyword">final</span> <span class="token class-name">ProcessStateRecord</span> state <span class="token operator">=</span> app<span class="token punctuation">.</span>mState<span class="token punctuation">;</span>
        <span class="token comment">//mAdjSeq在updateOomAdjInnerLSP/performUpdateOomAdjLSP有mAdjSeq++,代表是当前oom_adj调整的序列号</span>
        <span class="token comment">//如果mAdjSeq == getAdjSeq(取得的是正在处理的mAdjSeq值)，代表这个进程已经参与过本次调整</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mAdjSeq <span class="token operator">==</span> state<span class="token punctuation">.</span><span class="token function">getAdjSeq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//getCompletedAdjSeq是已经完成的adj值</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span><span class="token function">getAdjSeq</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> state<span class="token punctuation">.</span><span class="token function">getCompletedAdjSeq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// This adjustment has already been computed successfully.</span>
                <span class="token comment">// 如果该进程调整过了，而且已经完成，则直接返回，同时由于是没有调整，则返回值是false</span>
                <span class="token comment">// 只有true才代表循环调整成功，单个进程false代表忽略，</span>
                <span class="token comment">// 只有全部循环调整的进程都是fasle才会跳过循环调整的重试逻辑</span>
                <span class="token comment">// 返回值只有在重复调整的时候使用,具体请查看updateOomAdjInnerLSP的使用</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// The process is being computed, so there is a cycle. We cannot</span>
                <span class="token comment">// rely on this process's state.</span>
                <span class="token comment">//由于该进程之前已经计算过，而且adj还在计算值没有计算完，则设置需要adj循环调整的标记位mContainsCycle为true</span>
                state<span class="token punctuation">.</span><span class="token function">setContainsCycle</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//同时将该进程放入循环计算的list里面mProcessesInCycle，后面如果需要重新计算该进程adj的时候会从此处取回</span>
                mProcessesInCycle<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 返回值只有在重复调整的时候使用,具体请查看updateOomAdjInnerLSP的使用</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="3_ApplicationThread_78"></a>3. 没有ApplicationThread的时候的调整</h3> 
<p>进程app没有<code>ApplicationThread</code>(应用线程)的时候会进入</p> 
<pre><code class="prism language-java">        <span class="token comment">//如果app没有ApplicationThread(应用线程)，那么进入这里</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token function">getThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//设置当前进程的adj任务的序列号为mAdjSeq，代表正在调整该进程</span>
            state<span class="token punctuation">.</span><span class="token function">setAdjSeq</span><span class="token punctuation">(</span>mAdjSeq<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//设置默认cgroup为backgroud</span>
            <span class="token comment">//backgroud分组原生配置了 "HighEnergySaving"(cpuctl或者schedtune), </span>
            <span class="token comment">//"ProcessCapacityLow"(cpuset), "LowIoPriority"(blkio), "TimerSlackHigh"(timerslack_ns)</span>
            state<span class="token punctuation">.</span><span class="token function">setCurrentSchedulingGroup</span><span class="token punctuation">(</span><span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SCHED_GROUP_BACKGROUND</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//设置当前进程状态为PROCESS_STATE_CACHED_EMPTY</span>
            state<span class="token punctuation">.</span><span class="token function">setCurProcState</span><span class="token punctuation">(</span><span class="token constant">PROCESS_STATE_CACHED_EMPTY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//设置mCurAdj为999，这是oom调整的值；</span>
            <span class="token comment">//而mSetAdj是上一次oom设置过的值（一般用的mSetAdj做为oomadj的判断, setSetAdj设置）</span>
            <span class="token comment">//applyOomAdjLSP中会调用state.setSetAdj(state.getCurAdj());</span>
            <span class="token comment">//将正在调整的mCurAdj更新到mSetAdj，同时修改ProcessList.setOomAdj(更新lmkd中的状态值)</span>
            state<span class="token punctuation">.</span><span class="token function">setCurAdj</span><span class="token punctuation">(</span><span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">CACHED_APP_MAX_ADJ</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
//AndroidS\frameworks\base\services\core\java\com\android\server\am\ProcessServiceRecord.java
    int modifyRawOomAdj(int adj) {
        if (mHasAboveClient) {
            // If this process has bound to any services with BIND_ABOVE_CLIENT,
            // then we need to drop its adjustment to be lower than the service's
            // in order to honor the request.  We want to drop it by one adjustment
            // level...  but there is special meaning applied to various levels so
            // we will skip some of them.
            if (adj &lt; ProcessList.FOREGROUND_APP_ADJ) {
                // System process will not get dropped, ever
            } else if (adj &lt; ProcessList.VISIBLE_APP_ADJ) {
                adj = ProcessList.VISIBLE_APP_ADJ;
            } else if (adj &lt; ProcessList.PERCEPTIBLE_APP_ADJ) {
                adj = ProcessList.PERCEPTIBLE_APP_ADJ;
            } else if (adj &lt; ProcessList.PERCEPTIBLE_LOW_APP_ADJ) {
                adj = ProcessList.PERCEPTIBLE_LOW_APP_ADJ;
            } else if (adj &lt; ProcessList.CACHED_APP_MIN_ADJ) {
                adj = ProcessList.CACHED_APP_MIN_ADJ;
            } else if (adj &lt; ProcessList.CACHED_APP_MAX_ADJ) {
                adj++;
            }
        }
        return adj;
    }
    state.setCurRawAdj(curEmptyAdj);//mCurRawAdj是直接设置的
    state.setCurAdj(psr.modifyRawOomAdj(curEmptyAdj));//类似这里就是约束过的adj在复制给mCurAdj，而且一般都是adj调整完成后设置
*/</span>
            <span class="token comment">//mCurRawAdj是未被约束过的adj，mCurAdj可能由于依赖关系被调整过</span>
            <span class="token comment">//mCurAdj当前调整的adj值，进过约束的(如mHasAboveClient进行约束，client app进程优先级会相应降低)</span>
            <span class="token comment">//mCurRawAdj当前调整的adj值，但是未经过约束</span>
            <span class="token comment">//mSetRawAdj上一次applyOomAdjLSP后设置的mCurRawAdj值</span>
            <span class="token comment">//mSetAdj上一次applyOomAdjLSP后设置的mCurAdj值</span>
            state<span class="token punctuation">.</span><span class="token function">setCurRawAdj</span><span class="token punctuation">(</span><span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">CACHED_APP_MAX_ADJ</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//设置已经完成了mCompletedAdjSeq为mAdjSeq（代表这个adj调整任务已经完成）</span>
            state<span class="token punctuation">.</span><span class="token function">setCompletedAdjSeq</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span><span class="token function">getAdjSeq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
    public static final int PROCESS_CAPABILITY_NONE = 0;

    //进程在前台的时候可以访问location 
    public static final int PROCESS_CAPABILITY_FOREGROUND_LOCATION = 1 &lt;&lt; 0;

    //进程在前台的时候可以调用camera 
    public static final int PROCESS_CAPABILITY_FOREGROUND_CAMERA = 1 &lt;&lt; 1;

    //进程在前台的时候可以调用电话 
    public static final int PROCESS_CAPABILITY_FOREGROUND_MICROPHONE = 1 &lt;&lt; 2;

    //即使是功耗优化的限制，这个进程也可以访问网络
    //AndroidS\frameworks\base\core\java\android\net\NetworkPolicyManager.java的
    //isProcStateAllowedWhileIdleOrPowerSaveMode有下面逻辑
    //procState &lt;= FOREGROUND_THRESHOLD_STATE || (capability &amp; ActivityManager.PROCESS_CAPABILITY_NETWORK) != 0
    public static final int PROCESS_CAPABILITY_NETWORK = 1 &lt;&lt; 3;
*/</span>
            <span class="token comment">//由于这个进程连应用线程都没有，设置该进程没有任何能力</span>
            state<span class="token punctuation">.</span><span class="token function">setCurCapability</span><span class="token punctuation">(</span><span class="token constant">PROCESS_CAPABILITY_NONE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//同时返回false，这种场景不需要考虑重复计算adj的逻辑</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="4_ProcessStateRecord_160"></a>4. 对ProcessStateRecord进程状态记录的一些初始化</h3> 
<pre><code class="prism language-java"><span class="token comment">/*
        public static final int REASON_UNKNOWN = 0;

        //这个是在provider依赖关系的时候才调用，代表进程状态改变是由于provider正在使用中导致
        public static final int REASON_PROVIDER_IN_USE = 1;

        //这个是在service依赖关系的时候才调用，代表进程状态改变是由于service正在使用中导致
        public static final int REASON_SERVICE_IN_USE = 2;

*/</span>
        <span class="token comment">//设置adj调整的大概原因，如由于service或者provider的依赖，初始化为未知</span>
        state<span class="token punctuation">.</span><span class="token function">setAdjTypeCode</span><span class="token punctuation">(</span><span class="token class-name">ActivityManager<span class="token punctuation">.</span>RunningAppProcessInfo</span><span class="token punctuation">.</span><span class="token constant">REASON_UNKNOWN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置adj调整时由于客户端clinet或者force-imp时由于什么对象导致进程状态调整</span>
        state<span class="token punctuation">.</span><span class="token function">setAdjSource</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置adj调整的对象名字，如由于service或者provider的依赖关系，那么对端的service/provider的名字会被记录在这里</span>
        state<span class="token punctuation">.</span><span class="token function">setAdjTarget</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//目前只有cch-empty &amp;&amp; PROCESS_STATE_CACHED_EMPTY才会设置setEmptyd的mEmpty为true，代表空进程</span>
        state<span class="token punctuation">.</span><span class="token function">setEmpty</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//这里设置mCached初始化值为false，用isCached取得mCached来判断是否缓存进程</span>
        state<span class="token punctuation">.</span><span class="token function">setCached</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//设置mAllowStartFgsState(getAllowStartFgsState)为PROCESS_STATE_NONEXISTENT进程不存在</span>
        <span class="token comment">//这个目前只有在"top-activity"、常驻进程、"fg-service"、客户端是常驻进程而且设置了BIND_FOREGROUND_SERVICE、客户端是top才会设置</span>
        state<span class="token punctuation">.</span><span class="token function">resetAllowStartFgsState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="5__189"></a>5. 设置默认是否允许冻结</h3> 
<blockquote> 
 <p>//cycleReEval只有在设置了setContainsCycle true(如正在计算computeOomAdjLSP的时候还没计算完又跑进来，<br> //如上面的mAdjSeq == state.getAdjSeq()或者(服务/provider的客户端有这种情况的时候))，<br> //在updateOomAdjInnerLSP会让cycleReEval=true(具体可以看上面的updateOomAdjInnerLSP，大概意思是循环计算依赖)</p> 
</blockquote> 
<pre><code class="prism language-java">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cycleReEval<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//如果是非循环遍历计算，则设置ProcessCachedOptimizerRecord的mShouldNotFreeze，这个用于冻结cached进程，</span>
            <span class="token comment">//在applyOomAdjLSP的updateAppFreezeStateLSP会进行进程冻结，主要有2个操作freezeBinder/setProcessFrozen</span>
            <span class="token comment">// Don't reset this flag when doing cycles re-evaluation.</span>
            app<span class="token punctuation">.</span>mOptRecord<span class="token punctuation">.</span><span class="token function">setShouldNotFreeze</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="6__204"></a>6. 获取调整之前的一些状态</h3> 
<pre><code class="prism language-java">        <span class="token comment">//取得app的uid</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> appUid <span class="token operator">=</span> app<span class="token punctuation">.</span>info<span class="token punctuation">.</span>uid<span class="token punctuation">;</span>
        <span class="token comment">//这个主要是存在OomAdjObserver的时候，发送消息reportOomAdjMessageLocked/onOomAdjMessage，</span>
        <span class="token comment">//如我们需要监控某个应用的adj调整情况，可以使用ActivityManagerShellCommand.java，只是调试功能而已</span>
        <span class="token comment">//adb shell cat /data/system/packages.list可以查看每个进程的uid</span>
        <span class="token comment">//使用方法：adb shell am watch-uids --oom +上面找出的应用的uid</span>
        <span class="token comment">//会输出adj调整日志Slog.d和在终端pw打印相关信息</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> logUid <span class="token operator">=</span> mService<span class="token punctuation">.</span>mCurOomAdjUid<span class="token punctuation">;</span>

        <span class="token comment">//获取调整adj前的mCurAdj(当前调整的adj，进过约束的)，保存成prevAppAdj之前的adj状态</span>
        <span class="token keyword">int</span> prevAppAdj <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">getCurAdj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//将之前的进程状态mCurProcState保存成prevProcState</span>
        <span class="token keyword">int</span> prevProcState <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">getCurProcState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//将之前的能力mCurCapability保存成prevCapability</span>
        <span class="token keyword">int</span> prevCapability <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">getCurCapability</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取ProcessServiceRecord，这个在ActiveServices的realStartServiceLocked会调用ProcessServiceRecord的startService，</span>
        <span class="token comment">//将ServiceRecord加入ProcessServiceRecord的mServices中去，主要保存的是进程服务相关信息</span>
        <span class="token keyword">final</span> <span class="token class-name">ProcessServiceRecord</span> psr <span class="token operator">=</span> app<span class="token punctuation">.</span>mServices<span class="token punctuation">;</span>
</code></pre> 
<h3><a id="7_system_server_228"></a>7. system_server或者常驻进程的调整</h3> 
<blockquote> 
 <p>//getMaxAdj拿到的是mMaxAdj，一般只有系统system_server、常驻进程PERSISTENT或者isolated的app才会设置该值<br> //而小于等于前台的adj，那么就只有系统system_server、常驻进程PERSISTENT、常驻服务PERSISTENT_SERVICE才会进来<br> //目前除了测试用例，系统默认的setMaxAdj都是会进来这里的</p> 
</blockquote> 
<pre><code class="prism language-java">        <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span><span class="token function">getMaxAdj</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">FOREGROUND_APP_ADJ</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// The max adjustment doesn't allow this app to be anything</span>
            <span class="token comment">// below foreground, so it is not worth doing work for it.</span>
            <span class="token comment">// 可以看到oom的日志一般需要打开DEBUG_OOM_ADJ_REASON或者跟上面调试的logUid一致才会输出</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_OOM_ADJ_REASON</span> <span class="token operator">||</span> logUid <span class="token operator">==</span> appUid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">reportOomAdjMessageLocked</span><span class="token punctuation">(</span><span class="token constant">TAG_OOM_ADJ</span><span class="token punctuation">,</span> <span class="token string">"Making fixed: "</span> <span class="token operator">+</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//设置adj类型为fixed，类似dumpsys activity p中输出的，下面括号部分打印的就是adj类型</span>
            <span class="token comment">//PERS #46: sys    F/ /PER  LCMN  t: 0 1239:system/1000 (fixed)</span>
            state<span class="token punctuation">.</span><span class="token function">setAdjType</span><span class="token punctuation">(</span><span class="token string">"fixed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//在app中设置当前调整的adj系列为setAdjSeq</span>
            state<span class="token punctuation">.</span><span class="token function">setAdjSeq</span><span class="token punctuation">(</span>mAdjSeq<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//设置指定的mCurRawAdj(未被约束过的adj)为当前最大的adj</span>
            state<span class="token punctuation">.</span><span class="token function">setCurRawAdj</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span><span class="token function">getMaxAdj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//暂时初始化，先标定没有前台activity</span>
            state<span class="token punctuation">.</span><span class="token function">setHasForegroundActivities</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//设置当前的cgroup调度分组为SCHED_GROUP_DEFAULT默认，</span>
            <span class="token comment">//对应cgroup分组的SCHED_SP_DEFAULT(task_profiles.json), android默认只在这个分组设置了TimerSlackNormal</span>
            <span class="token comment">//TimerSlackNormal会将/proc/(pid)/timerslack_ns设置成50000ns(0.05ms,内核中断定时器最大的超时时间，</span>
            <span class="token comment">//定时器会在定时时间到超时直接范围内执行,主要为了避免频繁中断引起的性能损耗，类似于对齐)；</span>
            <span class="token comment">//于之对应的设置是TimerSlackHigh，这个android默认设置的是40000000ns=40ms，</span>
            <span class="token comment">//这个时间就很大(对于实际执行的内容会可能wait等待时间较长,导致性能问题)；</span>
            <span class="token comment">//至于其它cgroup分组节点就是默认上一次行为，本次不移动节点(只操作了timerslack_ns)</span>
            <span class="token comment">//cgroup对性能也很重要，但是不是本次重点，先带过</span>
            state<span class="token punctuation">.</span><span class="token function">setCurrentSchedulingGroup</span><span class="token punctuation">(</span><span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SCHED_GROUP_DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//设置该进程拥有所有能力(只有系统system_server、常驻进程PERSISTENT才会进来，所以相对安全)</span>
            state<span class="token punctuation">.</span><span class="token function">setCurCapability</span><span class="token punctuation">(</span><span class="token constant">PROCESS_CAPABILITY_ALL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//设置当前进程的状态为PROCESS_STATE_PERSISTENT，字符串转换是"PER "</span>
            state<span class="token punctuation">.</span><span class="token function">setCurProcState</span><span class="token punctuation">(</span><span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token constant">PROCESS_STATE_PERSISTENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// System processes can do UI, and when they do we want to have</span>
            <span class="token comment">// them trim their memory after the user leaves the UI.  To</span>
            <span class="token comment">// facilitate this, here we need to determine whether or not it</span>
            <span class="token comment">// is currently showing UI.</span>
            <span class="token comment">//初始化设定当前系统进程没有ui界面</span>
            state<span class="token punctuation">.</span><span class="token function">setSystemNoUi</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//如果调整的是当前应用是最顶端的activity</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>app <span class="token operator">==</span> topApp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//设置这类应用是带有界面的</span>
                state<span class="token punctuation">.</span><span class="token function">setSystemNoUi</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//cgroup分组标记成top app(用户后面分组切换到类似*** cgroup的分组，cpuset的分组如：/dev/cpuset/top-app)</span>
                state<span class="token punctuation">.</span><span class="token function">setCurrentSchedulingGroup</span><span class="token punctuation">(</span><span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SCHED_GROUP_TOP_APP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//adj类型标记成pers-top-activity</span>
                state<span class="token punctuation">.</span><span class="token function">setAdjType</span><span class="token punctuation">(</span><span class="token string">"pers-top-activity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//是否有top ui，目前只有systemui才会设置setHasTopUi(通过AMS设置)，如下拉状态栏、灭屏幕时</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span><span class="token function">hasTopUi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// sched group/proc state adjustment is below</span>
                <span class="token comment">//设置这类应用是带有界面的</span>
                state<span class="token punctuation">.</span><span class="token function">setSystemNoUi</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//设置这类应用的类型是"pers-top-ui"</span>
                state<span class="token punctuation">.</span><span class="token function">setAdjType</span><span class="token punctuation">(</span><span class="token string">"pers-top-ui"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//如果是有可见的activity的话</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span><span class="token function">getCachedHasVisibleActivities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//设置这类应用是带有界面的</span>
                state<span class="token punctuation">.</span><span class="token function">setSystemNoUi</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//只有带有界面的常驻进程才会进入这里面(如systemui会灭屏幕进入；phone进程灭屏由于isSystemNoUi是true所以不进入)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>state<span class="token punctuation">.</span><span class="token function">isSystemNoUi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//mWakefulness获取的是当前是否唤醒状态，如亮屏是唤醒状态则是PowerManagerInternal.WAKEFULNESS_AWAKE</span>
                <span class="token comment">//isRunningRemoteAnimation代表是否播放远端动画,如锁屏动画这个也是true</span>
                <span class="token comment">//(如在WAKEFULNESS_DOZING的状态的时候，systemui的isRunningRemoteAnimation也可能是true)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mWakefulness<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">PowerManagerInternal</span><span class="token punctuation">.</span><span class="token constant">WAKEFULNESS_AWAKE</span>
                        <span class="token operator">||</span> state<span class="token punctuation">.</span><span class="token function">isRunningRemoteAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// screen on or animating, promote UI</span>
                    <span class="token comment">//进程状态还是设置成PROCESS_STATE_PERSISTENT_UI ("PERU")</span>
                    state<span class="token punctuation">.</span><span class="token function">setCurProcState</span><span class="token punctuation">(</span><span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token constant">PROCESS_STATE_PERSISTENT_UI</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//cgroup分组标记成top app</span>
                    state<span class="token punctuation">.</span><span class="token function">setCurrentSchedulingGroup</span><span class="token punctuation">(</span><span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SCHED_GROUP_TOP_APP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// screen off, restrict UI scheduling</span>
                    <span class="token comment">//灭屏没有播放动画才进入这里，如systemui进程状态会从"PERU"切换到"BFGS"</span>
                    state<span class="token punctuation">.</span><span class="token function">setCurProcState</span><span class="token punctuation">(</span><span class="token constant">PROCESS_STATE_BOUND_FOREGROUND_SERVICE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//cgroup分组标记成限制的分组，systemui也会进入这里</span>
                    state<span class="token punctuation">.</span><span class="token function">setCurrentSchedulingGroup</span><span class="token punctuation">(</span><span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SCHED_GROUP_RESTRICTED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//设置mCurRawProcState为当前计算的mCurProcState的值，这个值一般都是用于计算client的mCurRawProcState状态</span>
            <span class="token comment">//相当于依赖调整后的状态</span>
            state<span class="token punctuation">.</span><span class="token function">setCurRawProcState</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span><span class="token function">getCurProcState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//这种进程(系统system_server、常驻进程PERSISTENT)不需要调整adj，直接设置的是传入的max adj</span>
            state<span class="token punctuation">.</span><span class="token function">setCurAdj</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span><span class="token function">getMaxAdj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//设置当前进程完成调整的adj为mAdjSeq，代表本次adj调整完成</span>
            state<span class="token punctuation">.</span><span class="token function">setCompletedAdjSeq</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span><span class="token function">getAdjSeq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//更新mAllowStartFgsState，代表是否允许启动前台服务，进程状态需要不比PROCESS_STATE_BOUND_FOREGROUND_SERVICE优先级低</span>
            state<span class="token punctuation">.</span><span class="token function">bumpAllowStartFgsState</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span><span class="token function">getCurProcState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// if curAdj is less than prevAppAdj, then this process was promoted</span>
            <span class="token comment">//如果当前的adj比上一次调整的adj小、或者当前的进程状态比上一次的优先，则返回true(有效调整)，其它则返回false</span>
            <span class="token keyword">return</span> state<span class="token punctuation">.</span><span class="token function">getCurAdj</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> prevAppAdj <span class="token operator">||</span> state<span class="token punctuation">.</span><span class="token function">getCurProcState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> prevProcState<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="8__326"></a>8. 调整之前的一些变量的定义</h3> 
<pre><code class="prism language-java">        <span class="token comment">//其它的进程先预设拥有界面，初始值</span>
        state<span class="token punctuation">.</span><span class="token function">setSystemNoUi</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//如果当前唤醒状态的话，getTopProcessState返回的是PROCESS_STATE_TOP，否者是PROCESS_STATE_TOP_SLEEPING</span>
        <span class="token comment">//PROCESS_STATE_CUR_TOP定义成final，代表初始化之后就不能改了，仅当次调整有效</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">PROCESS_STATE_CUR_TOP</span> <span class="token operator">=</span> mService<span class="token punctuation">.</span>mAtmInternal<span class="token punctuation">.</span><span class="token function">getTopProcessState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Determine the importance of the process, starting with most</span>
        <span class="token comment">// important to least, and assign an appropriate OOM adjustment.</span>
        <span class="token comment">//adj是准备进行调整计算进程优先级的临时变量</span>
        <span class="token keyword">int</span> adj<span class="token punctuation">;</span>
        <span class="token comment">//schedGroup是准备进行调整计算进程cgrup的临时变量</span>
        <span class="token keyword">int</span> schedGroup<span class="token punctuation">;</span>
        <span class="token comment">//procState是准备进行调整计算进程状态的临时变量</span>
        <span class="token keyword">int</span> procState<span class="token punctuation">;</span>
        <span class="token comment">//cachedAdjSeq是准备进行调整计算cached adj的临时变量(旧的代码，这个在这里完全没有用到，是个bug，可以提交给google)</span>
        <span class="token keyword">int</span> cachedAdjSeq<span class="token punctuation">;</span>
        <span class="token comment">//capability是准备进行调整计算进程能力的临时变量</span>
        <span class="token keyword">int</span> capability <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment">//foregroundActivities(是否有前台的activity)默认设定为false</span>
        <span class="token keyword">boolean</span> foregroundActivities <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">//hasVisibleActivities(是否有可见的activity)默认设定为false</span>
        <span class="token keyword">boolean</span> hasVisibleActivities <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="9_topapp_355"></a>9. top顶端app的调整</h3> 
<blockquote> 
 <p>//如果当前是唤醒状态(如亮屏)，而且本次调整的进程是topApp(顶端的activity)</p> 
</blockquote> 
<pre><code class="prism language-java">        <span class="token comment">//当前是唤醒状态(如亮屏),PROCESS_STATE_CUR_TOP才会是PROCESS_STATE_TOP</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">PROCESS_STATE_CUR_TOP</span> <span class="token operator">==</span> <span class="token constant">PROCESS_STATE_TOP</span> <span class="token operator">&amp;&amp;</span> app <span class="token operator">==</span> topApp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// The last app on the list is the foreground app.</span>
            <span class="token comment">//设置adj是0（FOREGROUND_APP_ADJ），一般代表正在运行</span>
            adj <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">FOREGROUND_APP_ADJ</span><span class="token punctuation">;</span>
            <span class="token comment">//进程分组是top app</span>
            schedGroup <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SCHED_GROUP_TOP_APP</span><span class="token punctuation">;</span>
            <span class="token comment">//进程状态是"top-activity"</span>
            state<span class="token punctuation">.</span><span class="token function">setAdjType</span><span class="token punctuation">(</span><span class="token string">"top-activity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//拥有前台活动对象</span>
            foregroundActivities <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token comment">//拥有可见的activity</span>
            hasVisibleActivities <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token comment">//当前进程状态是PROCESS_STATE_TOP</span>
            procState <span class="token operator">=</span> <span class="token constant">PROCESS_STATE_CUR_TOP</span><span class="token punctuation">;</span>
            <span class="token comment">//将是否允许启动forground service的状态设置成PROCESS_STATE_TOP</span>
            <span class="token comment">//进程状态不低于PROCESS_STATE_BOUND_FOREGROUND_SERVICE即可启动前台服务</span>
            state<span class="token punctuation">.</span><span class="token function">bumpAllowStartFgsState</span><span class="token punctuation">(</span><span class="token constant">PROCESS_STATE_TOP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//打印日志或者在终端中监控某个app的时候会进去</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_OOM_ADJ_REASON</span> <span class="token operator">||</span> logUid <span class="token operator">==</span> appUid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">reportOomAdjMessageLocked</span><span class="token punctuation">(</span><span class="token constant">TAG_OOM_ADJ</span><span class="token punctuation">,</span> <span class="token string">"Making top: "</span> <span class="token operator">+</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="10__384"></a>10. 正在播放远端动画的调整</h3> 
<pre><code class="prism language-java">        <span class="token comment">//如果正在播放远端动画</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span><span class="token function">isRunningRemoteAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//设置adj为100(VISIBLE_APP_ADJ)</span>
            adj <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">VISIBLE_APP_ADJ</span><span class="token punctuation">;</span>
            <span class="token comment">//进程分组是top app</span>
            schedGroup <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SCHED_GROUP_TOP_APP</span><span class="token punctuation">;</span>
            <span class="token comment">//进程状态是"running-remote-anim"</span>
            state<span class="token punctuation">.</span><span class="token function">setAdjType</span><span class="token punctuation">(</span><span class="token string">"running-remote-anim"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//当前进程状态是PROCESS_STATE_TOP(设备唤醒时)/PROCESS_STATE_TOP_SLEEPING(休眠时)</span>
            procState <span class="token operator">=</span> <span class="token constant">PROCESS_STATE_CUR_TOP</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_OOM_ADJ_REASON</span> <span class="token operator">||</span> logUid <span class="token operator">==</span> appUid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">reportOomAdjMessageLocked</span><span class="token punctuation">(</span><span class="token constant">TAG_OOM_ADJ</span><span class="token punctuation">,</span> <span class="token string">"Making running remote anim: "</span> <span class="token operator">+</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="11_instrumentation_402"></a>11. instrumentation的调整</h3> 
<pre><code class="prism language-java">        <span class="token comment">//如果拥有活跃的instrumentation的时候(如自动化测试，或者qq downloader也会使用类似形式活跃在后台)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token function">getActiveInstrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Don't want to kill running instrumentation.</span>
            <span class="token comment">//设置adj是0（FOREGROUND_APP_ADJ），这种类型也认为是当前运行的进程</span>
            adj <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">FOREGROUND_APP_ADJ</span><span class="token punctuation">;</span>
            <span class="token comment">//进程分组是default默认</span>
            schedGroup <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SCHED_GROUP_DEFAULT</span><span class="token punctuation">;</span>
            <span class="token comment">//adj类型是"instrumentation");</span>
            state<span class="token punctuation">.</span><span class="token function">setAdjType</span><span class="token punctuation">(</span><span class="token string">"instrumentation"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//进程状态是forground service</span>
            procState <span class="token operator">=</span> <span class="token constant">PROCESS_STATE_FOREGROUND_SERVICE</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_OOM_ADJ_REASON</span> <span class="token operator">||</span> logUid <span class="token operator">==</span> appUid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">reportOomAdjMessageLocked</span><span class="token punctuation">(</span><span class="token constant">TAG_OOM_ADJ</span><span class="token punctuation">,</span> <span class="token string">"Making instrumentation: "</span> <span class="token operator">+</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="12__421"></a>12. 正在接受广播进程的调整</h3> 
<blockquote> 
 <p>//如果正在接受广播<code>(getCurReceiverAt)</code>或者广播挂起<code>(mPendingBroadcast)</code>马上会接收时<br> //可以看到广播adj设置优先于服务adj设置</p> 
</blockquote> 
<pre><code class="prism language-java">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span><span class="token function">getCachedIsReceivingBroadcast</span><span class="token punctuation">(</span>mTmpBroadcastQueue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// An app that is currently receiving a broadcast also</span>
            <span class="token comment">// counts as being in the foreground for OOM killer purposes.</span>
            <span class="token comment">// It's placed in a sched group based on the nature of the</span>
            <span class="token comment">// broadcast as reflected by which queue it's active in.</span>
            <span class="token comment">// adj = 0，代表正在前台运行中的进程</span>
            adj <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">FOREGROUND_APP_ADJ</span><span class="token punctuation">;</span>
            <span class="token comment">//如果接收的是前台广播队列mFgBroadcastQueue，则分组设置成SCHED_GROUP_DEFAULT，</span>
            <span class="token comment">//否者cgroup分组设置成后台SCHED_GROUP_BACKGROUND</span>
            schedGroup <span class="token operator">=</span> <span class="token punctuation">(</span>mTmpBroadcastQueue<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mFgBroadcastQueue<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token operator">?</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SCHED_GROUP_DEFAULT</span> <span class="token operator">:</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SCHED_GROUP_BACKGROUND</span><span class="token punctuation">;</span>
            <span class="token comment">//设置adj类型为广播"broadcast"</span>
            state<span class="token punctuation">.</span><span class="token function">setAdjType</span><span class="token punctuation">(</span><span class="token string">"broadcast"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//设置当前进程状态是PROCESS_STATE_RECEIVER</span>
            procState <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token constant">PROCESS_STATE_RECEIVER</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_OOM_ADJ_REASON</span> <span class="token operator">||</span> logUid <span class="token operator">==</span> appUid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">reportOomAdjMessageLocked</span><span class="token punctuation">(</span><span class="token constant">TAG_OOM_ADJ</span><span class="token punctuation">,</span> <span class="token string">"Making broadcast: "</span> <span class="token operator">+</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="13__447"></a>13. 正在运行服务进程的调整</h3> 
<blockquote> 
 <p>//如果正在运行服务bumpServiceExecutingLocked(startExecutingService加入运行服务，stopExecutingService移除)</p> 
</blockquote> 
<pre><code class="prism language-java">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>psr<span class="token punctuation">.</span><span class="token function">numberOfExecutingServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// An app that is currently executing a service callback also</span>
            <span class="token comment">// counts as being in the foreground.</span>
            <span class="token comment">// adj = 0，代表正在前台运行中的进程</span>
            adj <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">FOREGROUND_APP_ADJ</span><span class="token punctuation">;</span>
            <span class="token comment">//如果运行的是前台服务，则分组设置成SCHED_GROUP_DEFAULT，</span>
            <span class="token comment">//否者cgroup分组设置成后台SCHED_GROUP_BACKGROUND</span>
            schedGroup <span class="token operator">=</span> psr<span class="token punctuation">.</span><span class="token function">shouldExecServicesFg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">?</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SCHED_GROUP_DEFAULT</span> <span class="token operator">:</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SCHED_GROUP_BACKGROUND</span><span class="token punctuation">;</span>
            <span class="token comment">//设置adj类型为正在运行的服务"exec-service"</span>
            state<span class="token punctuation">.</span><span class="token function">setAdjType</span><span class="token punctuation">(</span><span class="token string">"exec-service"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//设置当前进程状态是PROCESS_STATE_SERVICE</span>
            procState <span class="token operator">=</span> <span class="token constant">PROCESS_STATE_SERVICE</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_OOM_ADJ_REASON</span> <span class="token operator">||</span> logUid <span class="token operator">==</span> appUid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">reportOomAdjMessageLocked</span><span class="token punctuation">(</span><span class="token constant">TAG_OOM_ADJ</span><span class="token punctuation">,</span> <span class="token string">"Making exec-service: "</span> <span class="token operator">+</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="14_topApp_470"></a>14. 系统在休眠时topApp的调整</h3> 
<blockquote> 
 <p>//如果调整的是topApp，但是在休眠的时候</p> 
</blockquote> 
<pre><code class="prism language-java">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>app <span class="token operator">==</span> topApp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//adj也是调整成0</span>
            adj <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">FOREGROUND_APP_ADJ</span><span class="token punctuation">;</span>
            <span class="token comment">//只是cgroup分组设置成后台SCHED_GROUP_BACKGROUND</span>
            schedGroup <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SCHED_GROUP_BACKGROUND</span><span class="token punctuation">;</span>
            <span class="token comment">//设置adj类型为顶端，而且休眠状态"top-sleeping"</span>
            state<span class="token punctuation">.</span><span class="token function">setAdjType</span><span class="token punctuation">(</span><span class="token string">"top-sleeping"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//拥有前台活动对象foregroundActivities设置成yrue, 注意此时拥有可见的activity(hasVisibleActivities)并未设置成ture</span>
            foregroundActivities <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token comment">//进程状态设置成PROCESS_STATE_TOP_SLEEPING</span>
            procState <span class="token operator">=</span> <span class="token constant">PROCESS_STATE_CUR_TOP</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_OOM_ADJ_REASON</span> <span class="token operator">||</span> logUid <span class="token operator">==</span> appUid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">reportOomAdjMessageLocked</span><span class="token punctuation">(</span><span class="token constant">TAG_OOM_ADJ</span><span class="token punctuation">,</span> <span class="token string">"Making top (sleeping): "</span> <span class="token operator">+</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="15_app_491"></a>15. 其它app的默认状态初始化</h3> 
<pre><code class="prism language-java">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// As far as we know the process is empty.  We may change our mind later.</span>
            <span class="token comment">//cgroup分组设置成后台SCHED_GROUP_BACKGROUND</span>
            schedGroup <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SCHED_GROUP_BACKGROUND</span><span class="token punctuation">;</span>
            <span class="token comment">// At this point we don't actually know the adjustment.  Use the cached adj</span>
            <span class="token comment">// value that the caller wants us to.</span>
            <span class="token comment">// 其它情况，先设置成cachedAdj(oldAdj或则UNKNOWN_ADJ)，</span>
            <span class="token comment">// 初始化为是空进程adj或者上一次调整的adj值，一会在进行adj调整</span>
            adj <span class="token operator">=</span> cachedAdj<span class="token punctuation">;</span>
            <span class="token comment">//进程状态设置成空的缓存进程PROCESS_STATE_CACHED_EMPTY</span>
            procState <span class="token operator">=</span> <span class="token constant">PROCESS_STATE_CACHED_EMPTY</span><span class="token punctuation">;</span>
            <span class="token comment">//如果不是循环计算，才进入里面</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>state<span class="token punctuation">.</span><span class="token function">containsCycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//设置成cached缓存进程</span>
                state<span class="token punctuation">.</span><span class="token function">setCached</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//设置成empty空进程</span>
                state<span class="token punctuation">.</span><span class="token function">setEmpty</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//adj类型是空的缓存进程"cch-empty"</span>
                state<span class="token punctuation">.</span><span class="token function">setAdjType</span><span class="token punctuation">(</span><span class="token string">"cch-empty"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_OOM_ADJ_REASON</span> <span class="token operator">||</span> logUid <span class="token operator">==</span> appUid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">reportOomAdjMessageLocked</span><span class="token punctuation">(</span><span class="token constant">TAG_OOM_ADJ</span><span class="token punctuation">,</span> <span class="token string">"Making empty: "</span> <span class="token operator">+</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="16_foregroundActivitiesmHasVisibleActivities_520"></a>16. 更新foregroundActivities和mHasVisibleActivities</h3> 
<pre><code class="prism language-java">        <span class="token comment">// Examine all activities if not already foreground.</span>
        <span class="token comment">//foregroundActivities目前只有top app才是true，除了了top它的值都是false</span>
        <span class="token comment">//只要进程有activity(getCachedHasActivities其实是hasActivities)，则getCachedHasActivities返回true</span>
        <span class="token comment">//如realStartActivityLocked(ActivityTaskSupervisor)通过setProcess(ActivityRecord)/addActivityIfNeeded(WindowProcessController)</span>
        <span class="token comment">//将ActivityRecord add进入mActivities，而移除也就是从mActivities移除, </span>
        <span class="token comment">//其中的一种移除情况如：ActivityRecord在destroyImmediately(events出现wm_destroy_activity的时候)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>foregroundActivities <span class="token operator">&amp;&amp;</span> state<span class="token punctuation">.</span><span class="token function">getCachedHasActivities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//通过activity不同的状态计算其adj，</span>
            <span class="token comment">//PROCESS_STATE_CUR_TOP的值是PROCESS_STATE_TOP(设备唤醒时)/PROCESS_STATE_TOP_SLEEPING(休眠时)</span>
            <span class="token comment">//一般情况procState进程状态越小越优先，adj越小越优先，cgroup分组schedGroup一般越大越优先</span>
            <span class="token comment">//1.如visable可见的activity则会通过onVisibleActivity设置adj最低是VISIBLE_APP_ADJ(其adj通过minLayer/mLayerRank会约束到100-199)</span>
            <span class="token comment">//foregroundActivities和mHasVisibleActivities都是true，procState进程状态设置成小于等于PROCESS_STATE_CUR_TOP</span>
            <span class="token comment">//cgroup分组schedGroup设置成大于等于SCHED_GROUP_DEFAULT()</span>
            <span class="token comment">//2.pausing正在暂停的activity则会通过onPausedActivity设置adj最低是PERCEPTIBLE_APP_ADJ</span>
            <span class="token comment">//foregroundActivities = true和mHasVisibleActivities是false，procState进程状态设置成小于等于PROCESS_STATE_CUR_TOP</span>
            <span class="token comment">//cgroup分组schedGroup设置成大于等于SCHED_GROUP_DEFAULT</span>
            <span class="token comment">//3.stopping正在停止的activity则会通过onStoppingActivity设置adj最低是PERCEPTIBLE_APP_ADJ</span>
            <span class="token comment">//foregroundActivities = true和mHasVisibleActivities是false，</span>
            <span class="token comment">//如果所有activity正在STOPPING都是finishing状态(如wm_finish_activity/wm_destroy_activity)，</span>
            <span class="token comment">//procState进程状态设置成小于等于PROCESS_STATE_LAST_ACTIVITY，schedGroup不变更</span>
            <span class="token comment">//4.其它状态的activity则会通过onOtherActivity，adj不更改</span>
            <span class="token comment">//foregroundActivities不变(默认foregroundActivities是false才会进来)和mHasVisibleActivities是false</span>
            <span class="token comment">//procState进程状态设置成小于等于PROCESS_STATE_CACHED_ACTIVITY,代表缓存的activity</span>
            state<span class="token punctuation">.</span><span class="token function">computeOomAdjFromActivitiesIfNecessary</span><span class="token punctuation">(</span>mTmpComputeOomAdjWindowCallback<span class="token punctuation">,</span>
                    adj<span class="token punctuation">,</span> foregroundActivities<span class="token punctuation">,</span> hasVisibleActivities<span class="token punctuation">,</span> procState<span class="token punctuation">,</span> schedGroup<span class="token punctuation">,</span>
                    appUid<span class="token punctuation">,</span> logUid<span class="token punctuation">,</span> <span class="token constant">PROCESS_STATE_CUR_TOP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//将上面获取的mCachedAdj设置成当前adj</span>
            adj <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">getCachedAdj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//将上面改变ProcessStateRecord的foregroundActivities复制给当前的foregroundActivities变量</span>
            foregroundActivities <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">getCachedForegroundActivities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//将上面改变ProcessStateRecord的mHasVisibleActivities复制给当前的hasVisibleActivities变量</span>
            hasVisibleActivities <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">getCachedHasVisibleActivities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//将上面的procState进程状态保存在当前的procState变量</span>
            procState <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">getCachedProcState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//将上面的cgroup分组schedGroup状态保存在当前的schedGroup变量</span>
            schedGroup <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">getCachedSchedGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="17_activity_564"></a>17. 更新最近使用的activity的状态</h3> 
<pre><code class="prism language-java">        <span class="token comment">//有activity在最近任务mRecentTasks,代表最近启动的activity，进程状态设置成小于等于PROCESS_STATE_CACHED_RECENT</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>procState <span class="token operator">&gt;</span> <span class="token constant">PROCESS_STATE_CACHED_RECENT</span> <span class="token operator">&amp;&amp;</span> state<span class="token punctuation">.</span><span class="token function">getCachedHasRecentTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//进程状态最大就是PROCESS_STATE_CACHED_RECENT</span>
            procState <span class="token operator">=</span> <span class="token constant">PROCESS_STATE_CACHED_RECENT</span><span class="token punctuation">;</span>
            <span class="token comment">//adj类型是cch-rec，缓存的最近任务</span>
            state<span class="token punctuation">.</span><span class="token function">setAdjType</span><span class="token punctuation">(</span><span class="token string">"cch-rec"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_OOM_ADJ_REASON</span> <span class="token operator">||</span> logUid <span class="token operator">==</span> appUid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">reportOomAdjMessageLocked</span><span class="token punctuation">(</span><span class="token constant">TAG_OOM_ADJ</span><span class="token punctuation">,</span> <span class="token string">"Raise procstate to cached recent: "</span> <span class="token operator">+</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="18_hasOverlayUi_581"></a>18. 调整前台服务或者hasOverlayUi的进程</h3> 
<blockquote> 
 <p>//如果当前adj大于200(PERCEPTIBLE_APP_ADJ用户可感知的进程)<br> //或者当前进程状态大于PROCESS_STATE_FOREGROUND_SERVICE(前台运行的服务)</p> 
</blockquote> 
<pre><code class="prism language-java">        <span class="token keyword">if</span> <span class="token punctuation">(</span>adj <span class="token operator">&gt;</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">PERCEPTIBLE_APP_ADJ</span>
                <span class="token operator">||</span> procState <span class="token operator">&gt;</span> <span class="token constant">PROCESS_STATE_FOREGROUND_SERVICE</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//如果其拥有前台服务(通过AMS的updateProcessForegroundLocked设置，</span>
            <span class="token comment">//目前只有updateServiceForegroundLocked(ActiveServices)才可能设置true)</span>
            <span class="token comment">// 一般前台服务带有通知</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>psr<span class="token punctuation">.</span><span class="token function">hasForegroundServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 将设置成200(PERCEPTIBLE_APP_ADJ)用户可感知的级别</span>
                adj <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">PERCEPTIBLE_APP_ADJ</span><span class="token punctuation">;</span>
                <span class="token comment">// 将进程状态设置成前台服务</span>
                procState <span class="token operator">=</span> <span class="token constant">PROCESS_STATE_FOREGROUND_SERVICE</span><span class="token punctuation">;</span>
                <span class="token comment">// 设置是否允许启动前台服务，这里是允许的(只要小于等于PROCESS_STATE_BOUND_FOREGROUND_SERVICE都是允许)</span>
                state<span class="token punctuation">.</span><span class="token function">bumpAllowStartFgsState</span><span class="token punctuation">(</span><span class="token constant">PROCESS_STATE_FOREGROUND_SERVICE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// adj类型是"fg-service"前台服务</span>
                state<span class="token punctuation">.</span><span class="token function">setAdjType</span><span class="token punctuation">(</span><span class="token string">"fg-service"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 设置成非cached的进程</span>
                state<span class="token punctuation">.</span><span class="token function">setCached</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//此时设置cgroup的分组为默认</span>
                schedGroup <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SCHED_GROUP_DEFAULT</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_OOM_ADJ_REASON</span> <span class="token operator">||</span> logUid <span class="token operator">==</span> appUid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">reportOomAdjMessageLocked</span><span class="token punctuation">(</span><span class="token constant">TAG_OOM_ADJ</span><span class="token punctuation">,</span> <span class="token string">"Raise to "</span> <span class="token operator">+</span> state<span class="token punctuation">.</span><span class="token function">getAdjType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">": "</span>
                            <span class="token operator">+</span> app <span class="token operator">+</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token comment">// hasOverlayUi是true的时候(需要设置TYPE_APPLICATION_OVERLAY，有覆盖之上的界面，类似悬浮窗)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span><span class="token function">hasOverlayUi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// adj设置成用户可感知的优先级200</span>
                adj <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">PERCEPTIBLE_APP_ADJ</span><span class="token punctuation">;</span>
                <span class="token comment">// 将进程状态设置成重要的前台进程</span>
                procState <span class="token operator">=</span> <span class="token constant">PROCESS_STATE_IMPORTANT_FOREGROUND</span><span class="token punctuation">;</span>
                <span class="token comment">// 设置成非cached的进程</span>
                state<span class="token punctuation">.</span><span class="token function">setCached</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// adj类型是"has-overlay-ui"拥有覆盖界面的进程</span>
                state<span class="token punctuation">.</span><span class="token function">setAdjType</span><span class="token punctuation">(</span><span class="token string">"has-overlay-ui"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//此时设置cgroup的分组为默认</span>
                schedGroup <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SCHED_GROUP_DEFAULT</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_OOM_ADJ_REASON</span> <span class="token operator">||</span> logUid <span class="token operator">==</span> appUid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">reportOomAdjMessageLocked</span><span class="token punctuation">(</span><span class="token constant">TAG_OOM_ADJ</span><span class="token punctuation">,</span> <span class="token string">"Raise to overlay ui: "</span> <span class="token operator">+</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="19__628"></a>19. 调整最近活跃的前台服务进程</h3> 
<pre><code class="prism language-java">        <span class="token comment">// If the app was recently in the foreground and moved to a foreground service status,</span>
        <span class="token comment">// allow it to get a higher rank in memory for some time, compared to other foreground</span>
        <span class="token comment">// services so that it can finish performing any persistence/processing of in-memory state.</span>
        <span class="token comment">//如果有前台服务，而且adj比50(PERCEPTIBLE_RECENT_FOREGROUND_APP_ADJ最近使用的前台进程)大；</span>
        <span class="token comment">//而且是最近15s内在top级别(最前台)，或者当前进程状态起码是top</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>psr<span class="token punctuation">.</span><span class="token function">hasForegroundServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> adj <span class="token operator">&gt;</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">PERCEPTIBLE_RECENT_FOREGROUND_APP_ADJ</span>
                <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span><span class="token function">getLastTopTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> mConstants<span class="token punctuation">.</span><span class="token constant">TOP_TO_FGS_GRACE_DURATION</span> <span class="token operator">&gt;</span> now
                <span class="token operator">||</span> state<span class="token punctuation">.</span><span class="token function">getSetProcState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token constant">PROCESS_STATE_TOP</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//将adj设定成50(PERCEPTIBLE_RECENT_FOREGROUND_APP_ADJ)，</span>
            <span class="token comment">//代表最近使用过的前台应用(hasForegroundServices最低是200，最近使用过的前台服务最低是50)</span>
            adj <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">PERCEPTIBLE_RECENT_FOREGROUND_APP_ADJ</span><span class="token punctuation">;</span>
            <span class="token comment">//设置adj类型为前台服务最近活跃</span>
            state<span class="token punctuation">.</span><span class="token function">setAdjType</span><span class="token punctuation">(</span><span class="token string">"fg-service-act"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_OOM_ADJ_REASON</span> <span class="token operator">||</span> logUid <span class="token operator">==</span> appUid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">reportOomAdjMessageLocked</span><span class="token punctuation">(</span><span class="token constant">TAG_OOM_ADJ</span><span class="token punctuation">,</span> <span class="token string">"Raise to recent fg: "</span> <span class="token operator">+</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="20__650"></a>20. 调整强制提升到用户可感知的进程</h3> 
<p>调整通过<code>setProcessImportant</code>来提升优先级的应用</p> 
<pre><code class="prism language-java">        <span class="token comment">// adj大于200(PERCEPTIBLE_APP_ADJ用户可感知的进程)，或者进程状态大于8(PROCESS_STATE_TRANSIENT_BACKGROUND后台临时状态)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>adj <span class="token operator">&gt;</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">PERCEPTIBLE_APP_ADJ</span>
                <span class="token operator">||</span> procState <span class="token operator">&gt;</span> <span class="token constant">PROCESS_STATE_TRANSIENT_BACKGROUND</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//如果设置了getForcingToImportant不为null（调用AMS的setProcessImportant设置），</span>
            <span class="token comment">//而且adj是用户可感知的PERCEPTIBLE_APP_ADJ，例如toasts是这种情况(NotificationManagerService中调用setProcessImportant)</span>
            <span class="token comment">//如果不想要通知又想提升优先级，setProcessImportant是个不错的选择</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span><span class="token function">getForcingToImportant</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// This is currently used for toasts...  they are not interactive, and</span>
                <span class="token comment">// we don't want them to cause the app to become fully foreground (and</span>
                <span class="token comment">// thus out of background check), so we yes the best background level we can.</span>
                <span class="token comment">// adj设置成200</span>
                adj <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">PERCEPTIBLE_APP_ADJ</span><span class="token punctuation">;</span>
                <span class="token comment">// 进程状态设置成后台临时状态(PROCESS_STATE_TRANSIENT_BACKGROUND)</span>
                procState <span class="token operator">=</span> <span class="token constant">PROCESS_STATE_TRANSIENT_BACKGROUND</span><span class="token punctuation">;</span>
                <span class="token comment">// 设置成非cached的进程</span>
                state<span class="token punctuation">.</span><span class="token function">setCached</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// adj类型是"force-imp"强制设置的重要应用</span>
                state<span class="token punctuation">.</span><span class="token function">setAdjType</span><span class="token punctuation">(</span><span class="token string">"force-imp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// adj改变的原因是ImportanceToken(pid, token, reason)对象，包括提升优先级进程的pid、传递的IBinder对象token，还有原因reason</span>
                state<span class="token punctuation">.</span><span class="token function">setAdjSource</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span><span class="token function">getForcingToImportant</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//此时设置cgroup的分组为默认</span>
                schedGroup <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SCHED_GROUP_DEFAULT</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_OOM_ADJ_REASON</span> <span class="token operator">||</span> logUid <span class="token operator">==</span> appUid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">reportOomAdjMessageLocked</span><span class="token punctuation">(</span><span class="token constant">TAG_OOM_ADJ</span><span class="token punctuation">,</span> <span class="token string">"Raise to force imp: "</span> <span class="token operator">+</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="21_heavy_685"></a>21. 调整heavy的进程</h3> 
<pre><code class="prism language-java">        <span class="token comment">//当app无法保存状态，如AndroidManifest.xml设置了"android:cantSaveState="true""，</span>
        <span class="token comment">//同时系统配置了&lt;feature name="android.software.cant_save_state" /&gt;这个feature</span>
        <span class="token comment">//由于其无法保存状态，故尽量不要杀死, 一般只有一个，adj类型是"heavy"</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span><span class="token function">getCachedIsHeavyWeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//如果adj大于400(HEAVY_WEIGHT_APP_ADJ重要app的优先级)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>adj <span class="token operator">&gt;</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">HEAVY_WEIGHT_APP_ADJ</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// We don't want to kill the current heavy-weight process.</span>
                <span class="token comment">//将adj设置成400</span>
                adj <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">HEAVY_WEIGHT_APP_ADJ</span><span class="token punctuation">;</span>
                <span class="token comment">//不过将cgroup分组设置成后台的</span>
                schedGroup <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SCHED_GROUP_BACKGROUND</span><span class="token punctuation">;</span>
                <span class="token comment">// 设置成非cached的进程</span>
                state<span class="token punctuation">.</span><span class="token function">setCached</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// adj类型是"heavy"(由于adj改变设置)</span>
                state<span class="token punctuation">.</span><span class="token function">setAdjType</span><span class="token punctuation">(</span><span class="token string">"heavy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_OOM_ADJ_REASON</span> <span class="token operator">||</span> logUid <span class="token operator">==</span> appUid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">reportOomAdjMessageLocked</span><span class="token punctuation">(</span><span class="token constant">TAG_OOM_ADJ</span><span class="token punctuation">,</span> <span class="token string">"Raise adj to heavy: "</span> <span class="token operator">+</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//如果进程状态大于PROCESS_STATE_HEAVY_WEIGHT(重要应用)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>procState <span class="token operator">&gt;</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token constant">PROCESS_STATE_HEAVY_WEIGHT</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//将进程状态设置成PROCESS_STATE_HEAVY_WEIGHT(起码是这个进程状态级别，mHeavyWeightProcess的级别不会比这个低)</span>
                procState <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token constant">PROCESS_STATE_HEAVY_WEIGHT</span><span class="token punctuation">;</span>
                <span class="token comment">// adj类型是"heavy"(由于进程状态改变设置)</span>
                state<span class="token punctuation">.</span><span class="token function">setAdjType</span><span class="token punctuation">(</span><span class="token string">"heavy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_OOM_ADJ_REASON</span> <span class="token operator">||</span> logUid <span class="token operator">==</span> appUid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">reportOomAdjMessageLocked</span><span class="token punctuation">(</span><span class="token constant">TAG_OOM_ADJ</span><span class="token punctuation">,</span> <span class="token string">"Raise procstate to heavy: "</span> <span class="token operator">+</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="21__721"></a>21. 调整桌面应用</h3> 
<pre><code class="prism language-java">        <span class="token comment">//如果是桌面应用mHomeProcess</span>
        <span class="token comment">//在ActivityRecord的completeResumeLocked中会将ACTIVITY_TYPE_HOME类型的应用设置成mHomeProcess桌面应用</span>
        <span class="token comment">//(具体ACTIVITY_TYPE_HOME的设置在ActivityRecord的setActivityType)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span><span class="token function">getCachedIsHomeProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//桌面应用的adj不能小于600(HOME_APP_ADJ)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>adj <span class="token operator">&gt;</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">HOME_APP_ADJ</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// This process is hosting what we currently consider to be the</span>
                <span class="token comment">// home app, so we don't want to let it go into the background.</span>
                <span class="token comment">//adj设置成600，桌面应用有点特殊，经常会返回使用，放在A、B service中间，比上一个应用稍微优先一点</span>
                adj <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">HOME_APP_ADJ</span><span class="token punctuation">;</span>
                <span class="token comment">//将cgroup分组设置成后台的</span>
                schedGroup <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SCHED_GROUP_BACKGROUND</span><span class="token punctuation">;</span>
                <span class="token comment">// 设置成非cached的进程</span>
                state<span class="token punctuation">.</span><span class="token function">setCached</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// adj类型是"home"</span>
                state<span class="token punctuation">.</span><span class="token function">setAdjType</span><span class="token punctuation">(</span><span class="token string">"home"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_OOM_ADJ_REASON</span> <span class="token operator">||</span> logUid <span class="token operator">==</span> appUid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">reportOomAdjMessageLocked</span><span class="token punctuation">(</span><span class="token constant">TAG_OOM_ADJ</span><span class="token punctuation">,</span> <span class="token string">"Raise adj to home: "</span> <span class="token operator">+</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//桌面应用的进程状态不能低于PROCESS_STATE_HOME(14)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>procState <span class="token operator">&gt;</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token constant">PROCESS_STATE_HOME</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//桌面应用的进程状态设置成PROCESS_STATE_HOME(14)</span>
                procState <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token constant">PROCESS_STATE_HOME</span><span class="token punctuation">;</span>
                <span class="token comment">// adj类型是"home"</span>
                state<span class="token punctuation">.</span><span class="token function">setAdjType</span><span class="token punctuation">(</span><span class="token string">"home"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_OOM_ADJ_REASON</span> <span class="token operator">||</span> logUid <span class="token operator">==</span> appUid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">reportOomAdjMessageLocked</span><span class="token punctuation">(</span><span class="token constant">TAG_OOM_ADJ</span><span class="token punctuation">,</span> <span class="token string">"Raise procstate to home: "</span> <span class="token operator">+</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="22_previous_758"></a>22. 调整previous上一个使用的应用</h3> 
<pre><code class="prism language-java">        <span class="token comment">//1. getCachedIsPreviousProcess: 在上一个前台进程activity stop的时候，则会将进程ActivityRecord的app(WindowProcessController)加入到mPreviousProcess，做为上一个进程</span>
        <span class="token comment">//2. getCachedHasActivities:在realStartActivityLocked()的时候将activity add进来，在detachFromProcess或者destroyImmediately()的时候移除activity，</span>
        <span class="token comment">//也就是说是否有启动过但是未destory的activity</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span><span class="token function">getCachedIsPreviousProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> state<span class="token punctuation">.</span><span class="token function">getCachedHasActivities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//如果是上一个应用，而且activity没有销毁，那么adj最少设置成700(PREVIOUS_APP_ADJ)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>adj <span class="token operator">&gt;</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">PREVIOUS_APP_ADJ</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// This was the previous process that showed UI to the user.</span>
                <span class="token comment">// We want to try to keep it around more aggressively, to give</span>
                <span class="token comment">// a good experience around switching between two apps.</span>
                <span class="token comment">// adj设置成700</span>
                adj <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">PREVIOUS_APP_ADJ</span><span class="token punctuation">;</span>
                <span class="token comment">//设置cgroup的分组为默认</span>
                schedGroup <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SCHED_GROUP_BACKGROUND</span><span class="token punctuation">;</span>
                <span class="token comment">// 设置成非cached的进程</span>
                state<span class="token punctuation">.</span><span class="token function">setCached</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 设置adj类型为"previous"上一个应用</span>
                state<span class="token punctuation">.</span><span class="token function">setAdjType</span><span class="token punctuation">(</span><span class="token string">"previous"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_OOM_ADJ_REASON</span> <span class="token operator">||</span> logUid <span class="token operator">==</span> appUid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">reportOomAdjMessageLocked</span><span class="token punctuation">(</span><span class="token constant">TAG_OOM_ADJ</span><span class="token punctuation">,</span> <span class="token string">"Raise adj to prev: "</span> <span class="token operator">+</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//进程状态最少设置成PROCESS_STATE_LAST_ACTIVITY(15)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>procState <span class="token operator">&gt;</span> <span class="token constant">PROCESS_STATE_LAST_ACTIVITY</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//进程状态设置成PROCESS_STATE_LAST_ACTIVITY(15)</span>
                procState <span class="token operator">=</span> <span class="token constant">PROCESS_STATE_LAST_ACTIVITY</span><span class="token punctuation">;</span>
                <span class="token comment">// 设置adj类型为"previous"上一个应用</span>
                state<span class="token punctuation">.</span><span class="token function">setAdjType</span><span class="token punctuation">(</span><span class="token string">"previous"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_OOM_ADJ_REASON</span> <span class="token operator">||</span> logUid <span class="token operator">==</span> appUid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">reportOomAdjMessageLocked</span><span class="token punctuation">(</span><span class="token constant">TAG_OOM_ADJ</span><span class="token punctuation">,</span> <span class="token string">"Raise procstate to prev: "</span> <span class="token operator">+</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"OOM "</span> <span class="token operator">+</span> app <span class="token operator">+</span> <span class="token string">": initial adj="</span> <span class="token operator">+</span> adj
                <span class="token operator">+</span> <span class="token string">" reason="</span> <span class="token operator">+</span> state<span class="token punctuation">.</span><span class="token function">getAdjType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="23_procStateadjschedGroup_799"></a>23. 循环计算时更新procState、adj、schedGroup</h3> 
<p>循环计算时更新进程状态procState、进程优先级adj、进程分组cgroup信息schedGroup</p> 
<pre><code class="prism language-java">        <span class="token comment">// By default, we use the computed adjustment.  It may be changed if</span>
        <span class="token comment">// there are applications dependent on our services or providers, but</span>
        <span class="token comment">// this gives us a baseline and makes sure we don't get into an</span>
        <span class="token comment">// infinite recursion. If we're re-evaluating due to cycles, use the previously computed</span>
        <span class="token comment">// values.</span>
        <span class="token comment">//cycleReEval只有在设置了setContainsCycle true(如正在计算computeOomAdjLSP的时候还没计算完又跑进来，</span>
        <span class="token comment">//如上面的mAdjSeq == state.getAdjSeq()或者(服务/provider的客户端有这种情况的时候))，</span>
        <span class="token comment">//在updateOomAdjInnerLSP会让cycleReEval=true(具体可以看上面的updateOomAdjInnerLSP，大概意思是循环计算依赖)</span>
        <span class="token comment">//如果是循环计算的话</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cycleReEval<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//取之前的进程状态getCurRawProcState和上面计算出来的进程状态procState的最小值，也就是去优先级大的</span>
            procState <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>procState<span class="token punctuation">,</span> state<span class="token punctuation">.</span><span class="token function">getCurRawProcState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//取之前的进程adj(getCurRawAdj)和上面计算出来的adj的最小值，也就是去优先级大的</span>
            adj <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>adj<span class="token punctuation">,</span> state<span class="token punctuation">.</span><span class="token function">getCurRawAdj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//cgroup分组也是取小的值</span>
            schedGroup <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>schedGroup<span class="token punctuation">,</span> state<span class="token punctuation">.</span><span class="token function">getCurrentSchedulingGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="24_ProcessStateRecord_823"></a>24. 先更新一下当前计算的值到ProcessStateRecord</h3> 
<p>先更新一下当前计算的值到<code>ProcessStateRecord</code>(进程状态信息记录)</p> 
<pre><code class="prism language-java">        <span class="token comment">//将当前adj更新到mCurRawAdj</span>
        state<span class="token punctuation">.</span><span class="token function">setCurRawAdj</span><span class="token punctuation">(</span>adj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//将当前进程状态procState更新到mCurRawProcState</span>
        state<span class="token punctuation">.</span><span class="token function">setCurRawProcState</span><span class="token punctuation">(</span>procState<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//先默认该进程没有启动的服务，给初始化值</span>
        state<span class="token punctuation">.</span><span class="token function">setHasStartedServices</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="25_adj_837"></a>25. 设置当前adj调整的系列号</h3> 
<pre><code class="prism language-java">        <span class="token comment">//到这里我们开始调整adj的值，设置当前进程adj调整的序列是mAdjSeq</span>
        state<span class="token punctuation">.</span><span class="token function">setAdjSeq</span><span class="token punctuation">(</span>mAdjSeq<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="26_backup_845"></a>26. 调整backup备份的应用</h3> 
<pre><code class="prism language-java">        <span class="token comment">//获取backup的目标</span>
        <span class="token keyword">final</span> <span class="token class-name">BackupRecord</span> backupTarget <span class="token operator">=</span> mService<span class="token punctuation">.</span>mBackupTargets<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//如果backup app就是当前调整的app</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>backupTarget <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> app <span class="token operator">==</span> backupTarget<span class="token punctuation">.</span>app<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// If possible we want to avoid killing apps while they're being backed up</span>
            <span class="token comment">//那么adj最小不低于300(BACKUP_APP_ADJ)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>adj <span class="token operator">&gt;</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">BACKUP_APP_ADJ</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_BACKUP</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG_BACKUP</span><span class="token punctuation">,</span> <span class="token string">"oom BACKUP_APP_ADJ for "</span> <span class="token operator">+</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//那么adj设置成300(BACKUP_APP_ADJ)</span>
                adj <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">BACKUP_APP_ADJ</span><span class="token punctuation">;</span>
                <span class="token comment">//调整adj值之后，进程状态最低不低于8(TRANSIENT_BACKGROUND)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>procState <span class="token operator">&gt;</span> <span class="token constant">PROCESS_STATE_TRANSIENT_BACKGROUND</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    procState <span class="token operator">=</span> <span class="token constant">PROCESS_STATE_TRANSIENT_BACKGROUND</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//adj的类型是"backup"</span>
                state<span class="token punctuation">.</span><span class="token function">setAdjType</span><span class="token punctuation">(</span><span class="token string">"backup"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_OOM_ADJ_REASON</span> <span class="token operator">||</span> logUid <span class="token operator">==</span> appUid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">reportOomAdjMessageLocked</span><span class="token punctuation">(</span><span class="token constant">TAG_OOM_ADJ</span><span class="token punctuation">,</span> <span class="token string">"Raise adj to backup: "</span> <span class="token operator">+</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 设置成非cached的进程</span>
                state<span class="token punctuation">.</span><span class="token function">setCached</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//进程状态最低不低于9(BACKUP)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>procState <span class="token operator">&gt;</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token constant">PROCESS_STATE_BACKUP</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//设置进程状态为9(BACKUP)</span>
                procState <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token constant">PROCESS_STATE_BACKUP</span><span class="token punctuation">;</span>
                <span class="token comment">//adj的类型是"backup"</span>
                state<span class="token punctuation">.</span><span class="token function">setAdjType</span><span class="token punctuation">(</span><span class="token string">"backup"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_OOM_ADJ_REASON</span> <span class="token operator">||</span> logUid <span class="token operator">==</span> appUid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">reportOomAdjMessageLocked</span><span class="token punctuation">(</span><span class="token constant">TAG_OOM_ADJ</span><span class="token punctuation">,</span> <span class="token string">"Raise procstate to backup: "</span> <span class="token operator">+</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="27_service_883"></a>27. service服务自身和服务依赖关系调整</h3> 
<h4><a id="271_numberOfRunningServices_886"></a>27.1 遍历该进程的服务numberOfRunningServices</h4> 
<pre><code class="prism language-java">        <span class="token comment">//用于计算前台服务都拥有哪些能力</span>
        <span class="token keyword">int</span> capabilityFromFGS <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// capability from foreground service.</span>
        <span class="token comment">//用来用来判断分组是否需要将分组设置成top</span>
        <span class="token keyword">boolean</span> scheduleLikeTopApp <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">//numberOfRunningServices是查看还有多少正在运行的服务(只要startService了就会放入ProcessServiceRecord的mServices中，</span>
        <span class="token comment">//stopService或者kill会从mServices移除)</span>
        <span class="token comment">//而且满足其中之一才会进来：adj需要大于0的才调整，如果是0前台或者常驻进程adj是负数，或者分组是后台，或者进程状态状态大于top</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> is <span class="token operator">=</span> psr<span class="token punctuation">.</span><span class="token function">numberOfRunningServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
                is <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>adj <span class="token operator">&gt;</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">FOREGROUND_APP_ADJ</span>
                        <span class="token operator">||</span> schedGroup <span class="token operator">==</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SCHED_GROUP_BACKGROUND</span>
                        <span class="token operator">||</span> procState <span class="token operator">&gt;</span> <span class="token constant">PROCESS_STATE_TOP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                is<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//取得保存服务的对象ServiceRecord</span>
            <span class="token class-name">ServiceRecord</span> s <span class="token operator">=</span> psr<span class="token punctuation">.</span><span class="token function">getRunningServiceAt</span><span class="token punctuation">(</span>is<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="272_Services_906"></a>27.2 根据Services自身的状态进行调整</h4> 
<pre><code class="prism language-java">
<span class="token comment">/*
realStartServiceLocked:, ActiveServices (com.android.server.am) //psr.startService将ServiceRecord放入mServices
bringUpServiceLocked:, ActiveServices (com.android.server.am)
startServiceInnerLocked:, ActiveServices (com.android.server.am)//设置startRequested = true
startServiceLocked:, ActiveServices (com.android.server.am)
startService:, ActivityManagerService (com.android.server.am)
*/</span>
            <span class="token comment">//startRequested是在startServiceInnerLocked中设置，在realStartServiceLocked(会将service放入mServices)之前</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span>startRequested<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//设置有启动的服务</span>
                state<span class="token punctuation">.</span><span class="token function">setHasStartedServices</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//没有stop的服务的进程，最低进程状态就是10(SERVICE)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>procState <span class="token operator">&gt;</span> <span class="token constant">PROCESS_STATE_SERVICE</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    procState <span class="token operator">=</span> <span class="token constant">PROCESS_STATE_SERVICE</span><span class="token punctuation">;</span>
                    <span class="token comment">//adj类型是"started-services"</span>
                    state<span class="token punctuation">.</span><span class="token function">setAdjType</span><span class="token punctuation">(</span><span class="token string">"started-services"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_OOM_ADJ_REASON</span> <span class="token operator">||</span> logUid <span class="token operator">==</span> appUid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token function">reportOomAdjMessageLocked</span><span class="token punctuation">(</span><span class="token constant">TAG_OOM_ADJ</span><span class="token punctuation">,</span>
                                <span class="token string">"Raise procstate to started service: "</span> <span class="token operator">+</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//如果不是config_keep_warming_services(目前这个是空的，也就是mKeepWarming是false)的服务，</span>
                <span class="token comment">//而且hasShownUi是true，且不是桌面</span>
                <span class="token comment">//hasShownUi只要该进程有onStartActivity的操作，就会设置成true，不管activity是否destroy，只要进程还在都是true</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s<span class="token punctuation">.</span>mKeepWarming <span class="token operator">&amp;&amp;</span> state<span class="token punctuation">.</span><span class="token function">hasShownUi</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>state<span class="token punctuation">.</span><span class="token function">getCachedIsHomeProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// If this process has shown some UI, let it immediately</span>
                    <span class="token comment">// go to the LRU list because it may be pretty heavy with</span>
                    <span class="token comment">// UI stuff.  We'll tag it with a label just to help</span>
                    <span class="token comment">// debug and understand what is going on.</span>
                    <span class="token comment">//如果adj比500(SERVICE_ADJ)大(adj越大优先级越低)，SERVICE_ADJ是A services</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>adj <span class="token operator">&gt;</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SERVICE_ADJ</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//则将adj类型设置成"cch-started-ui-services缓存的启动了ui的服务</span>
                        state<span class="token punctuation">.</span><span class="token function">setAdjType</span><span class="token punctuation">(</span><span class="token string">"cch-started-ui-services"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//mKeepWarming都是false，而且lastActivity服务启动或者bind时间是30分钟以内</span>
                    <span class="token comment">//ServiceRecord的lastActivity代表的是上一次该服务</span>
                    <span class="token comment">//startServiceInnerLocked/bindServiceLocked/realStartServiceLocked的时间</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span>mKeepWarming
                            <span class="token operator">||</span> now <span class="token operator">&lt;</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span>lastActivity <span class="token operator">+</span> mConstants<span class="token punctuation">.</span><span class="token constant">MAX_SERVICE_INACTIVITY</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// This service has seen some activity within</span>
                        <span class="token comment">// recent memory, so we will keep its process ahead</span>
                        <span class="token comment">// of the background processes.</span>
                        <span class="token comment">//如果adj比500(SERVICE_ADJ)大</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>adj <span class="token operator">&gt;</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SERVICE_ADJ</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">//则将adj设置成500</span>
                            adj <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SERVICE_ADJ</span><span class="token punctuation">;</span>
                            <span class="token comment">//adj类型也是设置成"started-services"</span>
                            state<span class="token punctuation">.</span><span class="token function">setAdjType</span><span class="token punctuation">(</span><span class="token string">"started-services"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_OOM_ADJ_REASON</span> <span class="token operator">||</span> logUid <span class="token operator">==</span> appUid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token function">reportOomAdjMessageLocked</span><span class="token punctuation">(</span><span class="token constant">TAG_OOM_ADJ</span><span class="token punctuation">,</span>
                                        <span class="token string">"Raise adj to started service: "</span> <span class="token operator">+</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token comment">// 设置成非cached的进程</span>
                            state<span class="token punctuation">.</span><span class="token function">setCached</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// If we have let the service slide into the background</span>
                    <span class="token comment">// state, still have some text describing what it is doing</span>
                    <span class="token comment">// even though the service no longer has an impact.</span>
                    <span class="token comment">//其它情况不调整adj，将adj类型设置成"cch-started-services"</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>adj <span class="token operator">&gt;</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SERVICE_ADJ</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        state<span class="token punctuation">.</span><span class="token function">setAdjType</span><span class="token punctuation">(</span><span class="token string">"cch-started-services"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="273_capabilityFromFGS_979"></a>27.3 获取前台服务的能力capabilityFromFGS</h4> 
<pre><code class="prism language-java">
            <span class="token comment">//启动的是前台服务的时候isForeground这个值才是true</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span>isForeground<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//foregroundServiceType一般是AndroidManifest中设置，也可以在startForeground的时候传入</span>
                <span class="token comment">//frameworks/base/core/res/res/values/attrs_manifest.xml的foregroundServiceType有各个类型定义</span>
                <span class="token comment">//例如下面前台服务的时候拥有dataSync、mediaPlayback、phoneCall、location、connectedDevice的(mediaProjection/camera/microphone)</span>
                <span class="token comment">//&lt;service android:name="SchedulerService"</span>
                <span class="token comment">//     android:foregroundServiceType="dataSync|mediaPlayback|phoneCall|location|connectedDevice"&gt;</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> fgsType <span class="token operator">=</span> s<span class="token punctuation">.</span>foregroundServiceType<span class="token punctuation">;</span>
                <span class="token comment">//mAllowWhileInUsePermissionInFgs用于是否允许前台服务使用一些权限</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span>mAllowWhileInUsePermissionInFgs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//此时location的权限是否允许取决于foregroundServiceType是否有location权限(GPS、地图、导航)</span>
                    capabilityFromFGS <span class="token operator">|=</span>
                            <span class="token punctuation">(</span>fgsType <span class="token operator">&amp;</span> <span class="token constant">FOREGROUND_SERVICE_TYPE_LOCATION</span><span class="token punctuation">)</span>
                                    <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token constant">PROCESS_CAPABILITY_FOREGROUND_LOCATION</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>

                    <span class="token keyword">boolean</span> enabled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">/*
    boolean isEnabled(ApplicationInfo app, AndroidBuildClassifier buildClassifier) {
        if (app == null) {
            return defaultValue();
        }
        if (mEvaluatedOverrides.containsKey(app.packageName)) {
            return mEvaluatedOverrides.get(app.packageName);
        }
        if (getDisabled()) {
            return false;
        }
        if (getEnableSinceTargetSdk() != -1) {
            // If the change is gated by a platform version newer than the one currently installed
            // on the device, disregard the app's target sdk version.
            //Google这里的代码也有有点奇怪，app.targetSdkVersion是app的targetSdkVersion，而platformTargetSdk是
            //看注释是取最小的做为compareSdk 
            int compareSdk = Math.min(app.targetSdkVersion, buildClassifier.platformTargetSdk());
            //但是这里不等于targetSdkVersion有赋值成targetSdkVersion，那其实是一个意思
            if (compareSdk != app.targetSdkVersion) {
                compareSdk = app.targetSdkVersion;
            }
            return compareSdk &gt;= getEnableSinceTargetSdk();
        }
        return true;
    }
*/</span>
                        <span class="token comment">//ChangeId(136219221; name=CAMERA_MICROPHONE_CAPABILITY_CHANGE_ID; enableSinceTargetSdk=30)</span>
                        <span class="token comment">//获取camera，具体配置是读取/system/etc/compatconfig/services-platform-compat-config.xml进行初始话，这个是在30(android R)之后支持</span>
                        <span class="token comment">//isChangeEnabled其实最终调用的是CompatChange的isEnabled，目前只是用apk的targetSdkVersion进行判断，主要大于30就返回true</span>
                        enabled <span class="token operator">=</span> <span class="token function">getPlatformCompatCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isChangeEnabled</span><span class="token punctuation">(</span>
                                <span class="token constant">CAMERA_MICROPHONE_CAPABILITY_CHANGE_ID</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>appInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token punctuation">}</span>

                    <span class="token comment">//Android S中，如果apk是针对S做的，一般enabled都是true</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>enabled<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//判断foregroundServiceType是否有"camera"标签，有的话赋予访问camera的权限</span>
                        capabilityFromFGS <span class="token operator">|=</span>
                                <span class="token punctuation">(</span>fgsType <span class="token operator">&amp;</span> <span class="token constant">FOREGROUND_SERVICE_TYPE_CAMERA</span><span class="token punctuation">)</span>
                                        <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token constant">PROCESS_CAPABILITY_FOREGROUND_CAMERA</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
                        <span class="token comment">//判断foregroundServiceType是否有"microphone"标签，有的话赋予访问听筒的权限</span>
                        capabilityFromFGS <span class="token operator">|=</span>
                                <span class="token punctuation">(</span>fgsType <span class="token operator">&amp;</span> <span class="token constant">FOREGROUND_SERVICE_TYPE_MICROPHONE</span><span class="token punctuation">)</span>
                                        <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token constant">PROCESS_CAPABILITY_FOREGROUND_MICROPHONE</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//如果是版本过低，这默认将camera、听筒的权限赋值给前台服务</span>
                        capabilityFromFGS <span class="token operator">|=</span> <span class="token constant">PROCESS_CAPABILITY_FOREGROUND_CAMERA</span>
                                <span class="token operator">|</span> <span class="token constant">PROCESS_CAPABILITY_FOREGROUND_MICROPHONE</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="274__1053"></a>27.4 遍历每个服务里面的所有链接对象</h4> 
<pre><code class="prism language-java">
            <span class="token comment">//bindService就会往connections add相关的链接对象，key是IServiceConnection对象</span>
            <span class="token comment">//unbindService移除链接</span>
            <span class="token class-name">ArrayMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IBinder</span><span class="token punctuation">,</span> <span class="token class-name">ArrayList</span><span class="token punctuation">&lt;</span><span class="token class-name">ConnectionRecord</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> serviceConnections <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">getConnections</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//遍历所有的服务，ArrayMap是按照key的hashCode/identityHashCode进行排序的，不是按照add进去的时间进行排序</span>
            <span class="token comment">//这里是从serviceConnections尾部向头部遍历(反过来其实也是一样的，可能是考虑add/remove修改数组大小的时候的健壮性才从尾部开始遍历)</span>
            <span class="token comment">//如果当前进程的adj &gt; 0或者进程分组schedGroup是后台或者进程状态 &gt; top，才进行调整(高优先级的不进行依赖调整，减少调整次数)</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> conni <span class="token operator">=</span> serviceConnections<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
                    conni <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>adj <span class="token operator">&gt;</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">FOREGROUND_APP_ADJ</span>
                            <span class="token operator">||</span> schedGroup <span class="token operator">==</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SCHED_GROUP_BACKGROUND</span>
                            <span class="token operator">||</span> procState <span class="token operator">&gt;</span> <span class="token constant">PROCESS_STATE_TOP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    conni<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//取出服务连接对象</span>
                <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConnectionRecord</span><span class="token punctuation">&gt;</span></span> clist <span class="token operator">=</span> serviceConnections<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>conni<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="275__1072"></a>27.5 取出每个服务链接对象</h4> 
<pre><code class="prism language-java">
                <span class="token comment">//取出每次链接的对象，只要（当前进程的adj &gt; 0或者进程分组schedGroup是后台或者进程状态 &gt; top）是非前台的都进行调整</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                        i <span class="token operator">&lt;</span> clist<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>adj <span class="token operator">&gt;</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">FOREGROUND_APP_ADJ</span>
                                <span class="token operator">||</span> schedGroup <span class="token operator">==</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SCHED_GROUP_BACKGROUND</span>
                                <span class="token operator">||</span> procState <span class="token operator">&gt;</span> <span class="token constant">PROCESS_STATE_TOP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// XXX should compute this based on the max of</span>
                    <span class="token comment">// all connected clients.</span>
                    <span class="token comment">//取出每一个ConnectionRecord对象</span>
                    <span class="token class-name">ConnectionRecord</span> cr <span class="token operator">=</span> clist<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="276__1089"></a>27.6 只调整自身是服务，由于客户端的链接的情况</h4> 
<p><code>只有服务端的adj，才会由于客户端的adj提升而得到相应的提升</code></p> 
<p><code>这里就是服务依赖关系调整的开始</code></p> 
<pre><code class="prism language-java">
                    <span class="token comment">//如果服务链接的客户端是当前app，则跳过，客户端的adj不会由于服务端的adj提升而升高</span>
                    <span class="token comment">//只有服务端的adj，才会由于客户端的adj提升而得到相应的提升（不然会出现客户端在使用的时候服务端由于优先级低给回收掉了）</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>cr<span class="token punctuation">.</span>binding<span class="token punctuation">.</span>client <span class="token operator">==</span> app<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// Binding to oneself is not interesting.</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="277_computeClientsadj_1106"></a>27.7 computeClients循环计算时，会先计算客户端的adj</h4> 
<pre><code class="prism language-java">
                    <span class="token comment">//通过mProcessStats.mTrackingAssociations.add(this);将其放入记录ProcessState列表中</span>
                    <span class="token comment">//在updateOomAdjInnerLSP的updateTrackingAssociationsLocked会去更新这些add进去的进程状态</span>
                    <span class="token comment">//data/system/procstats里面有保存相关数据</span>
                    <span class="token keyword">boolean</span> trackedProcState <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

                    <span class="token comment">//服务链接中获取绑定的客户端进程</span>
                    <span class="token class-name">ProcessRecord</span> client <span class="token operator">=</span> cr<span class="token punctuation">.</span>binding<span class="token punctuation">.</span>client<span class="token punctuation">;</span>
                    <span class="token comment">//客户端的进程状态</span>
                    <span class="token keyword">final</span> <span class="token class-name">ProcessStateRecord</span> cstate <span class="token operator">=</span> client<span class="token punctuation">.</span>mState<span class="token punctuation">;</span>
                    <span class="token comment">//computeClients是否需要计算当前进程的时候计算服务、provider提供者对端client的adj</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>computeClients<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//调整之前先计算client的adj，将client按照当前传递计算app的重新计算一次，此处就有可能循环计算，mAdjSeq目前都是一个</span>
                        <span class="token function">computeOomAdjLSP</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> cachedAdj<span class="token punctuation">,</span> topApp<span class="token punctuation">,</span> doingAll<span class="token punctuation">,</span> now<span class="token punctuation">,</span>
                                cycleReEval<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//如果不需要计算客户端的优先级，那么setCurRawAdj先将客户端当前调整的mCurAdj更新到mCurRawAdj中</span>
                        <span class="token comment">//mCurAdj当前调整的adj值，进过约束的(如mHasAboveClient进行约束，client app进程优先级会相应降低)</span>
                        <span class="token comment">//mCurRawAdj当前调整的adj值，但是未经过约束</span>
                        <span class="token comment">//mSetRawAdj上一次applyOomAdjLSP后设置的mCurRawAdj值</span>
                        <span class="token comment">//mSetAdj上一次applyOomAdjLSP后设置的mCurAdj值</span>
                        cstate<span class="token punctuation">.</span><span class="token function">setCurRawAdj</span><span class="token punctuation">(</span>cstate<span class="token punctuation">.</span><span class="token function">getCurAdj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//mCurProcState是跑完一次computeOomAdjLSP的出的进程状态结果</span>
                        <span class="token comment">//而mCurRawProcState是当前的进程状态，是在计算中的临时结果</span>
                        <span class="token comment">//setCurRawProcState将上一次计算的进程状态mCurProcState赋值给mCurRawProcState(临时计算值)</span>
                        cstate<span class="token punctuation">.</span><span class="token function">setCurRawProcState</span><span class="token punctuation">(</span>cstate<span class="token punctuation">.</span><span class="token function">getCurProcState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="278_clientAdjclientProcState_1139"></a>27.8 调整前获取客户端的clientAdj和clientProcState</h4> 
<p>获取客户端的<code>clientAdj(客户端的adj)</code>和<code>clientProcState(客户端的进程状态procState)</code></p> 
<pre><code class="prism language-java">
                    <span class="token comment">//取得客户端的mCurRawAdj当前调整的adj值(未经过约束)</span>
                    <span class="token keyword">int</span> clientAdj <span class="token operator">=</span> cstate<span class="token punctuation">.</span><span class="token function">getCurRawAdj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//取得客户端的临时计算的最新进程状态值mCurRawProcState</span>
                    <span class="token keyword">int</span> clientProcState <span class="token operator">=</span> cstate<span class="token punctuation">.</span><span class="token function">getCurRawProcState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">//如果进程状态比top还小，代表是起码是常驻进程，clientIsSystem标记为true</span>
                    <span class="token keyword">final</span> <span class="token keyword">boolean</span> clientIsSystem <span class="token operator">=</span> clientProcState <span class="token operator">&lt;</span> <span class="token constant">PROCESS_STATE_TOP</span><span class="token punctuation">;</span>

                    <span class="token comment">//如果客户端mShouldNotFreeze是true，则服务端也被设置不允许冻结。</span>
                    <span class="token comment">//（原生冻结有2个条件，一个是adj大于等于900，而且mShouldNotFreeze=false）</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>client<span class="token punctuation">.</span>mOptRecord<span class="token punctuation">.</span><span class="token function">shouldNotFreeze</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// Propagate the shouldNotFreeze flag down the bindings.</span>
                        app<span class="token punctuation">.</span>mOptRecord<span class="token punctuation">.</span><span class="token function">setShouldNotFreeze</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="279__1161"></a>27.9 进行没有豁免优先级情况的调整</h4> 
<pre><code class="prism language-java">                    <span class="token comment">//如果当前没有设置豁免绑定的优先级调整，一般没有设置</span>
                    <span class="token comment">//则会进入根据客户端的adj去调整服务端的adj</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cr<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> <span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">BIND_WAIVE_PRIORITY</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
</code></pre> 
<h5><a id="2791__1171"></a>27.9.1 循环计算的时候是否需要先跳过本次计算</h5> 
<pre><code class="prism language-java">                        <span class="token comment">//判断是是否客户端adj没有计算完成，是否需要跳过本次依赖关系的计算，具体请看shouldSkipDueToCycle的解释</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldSkipDueToCycle</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> cstate<span class="token punctuation">,</span> procState<span class="token punctuation">,</span> adj<span class="token punctuation">,</span> cycleReEval<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
</code></pre> 
<h5><a id="2792_capability_1180"></a>27.9.2 能力capability初始化</h5> 
<pre><code class="prism language-java">                        <span class="token comment">//如果包含BIND_INCLUDE_CAPABILITIES，则会将客户端的能力全部赋值给服务端</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>cr<span class="token punctuation">.</span><span class="token function">hasFlag</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">BIND_INCLUDE_CAPABILITIES</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            capability <span class="token operator">|=</span> cstate<span class="token punctuation">.</span><span class="token function">getCurCapability</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token comment">// If an app has network capability by default</span>
                        <span class="token comment">// (by having procstate &lt;= BFGS), then the apps it binds to will get</span>
                        <span class="token comment">// elevated to a high enough procstate anyway to get network unless they</span>
                        <span class="token comment">// request otherwise, so don't propagate the network capability by default</span>
                        <span class="token comment">// in this case unless they explicitly request it.</span>
                        <span class="token comment">//如果客户端有网络相关的能力</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cstate<span class="token punctuation">.</span><span class="token function">getCurCapability</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token constant">PROCESS_CAPABILITY_NETWORK</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">//客户端的状态小于等于PROCESS_STATE_BOUND_FOREGROUND_SERVICE</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>clientProcState <span class="token operator">&lt;=</span> <span class="token constant">PROCESS_STATE_BOUND_FOREGROUND_SERVICE</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token comment">//只有设置了BIND_BYPASS_POWER_NETWORK_RESTRICTIONS(power相关限制都不会阻止服务获取网络权限)</span>
                                <span class="token comment">//才会给当前进程(是服务)赋予网络相关的能力</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cr<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> <span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">BIND_BYPASS_POWER_NETWORK_RESTRICTIONS</span><span class="token punctuation">)</span>
                                        <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                    capability <span class="token operator">|=</span> <span class="token constant">PROCESS_CAPABILITY_NETWORK</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token comment">//如果客户端优先级大于等于PROCESS_STATE_FOREGROUND_SERVICE</span>
                                <span class="token comment">//则直接赋予当前进程(是服务)网络相关能力</span>
                                capability <span class="token operator">|=</span> <span class="token constant">PROCESS_CAPABILITY_NETWORK</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
</code></pre> 
<h5><a id="2793_cached_activityclientProcState_1212"></a>27.9.3 低于cached activity的进程状态clientProcState约束</h5> 
<pre><code class="prism language-java">
                        <span class="token comment">//客户端的进程状态优先级低于cached activity</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>clientProcState <span class="token operator">&gt;=</span> <span class="token constant">PROCESS_STATE_CACHED_ACTIVITY</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">// If the other app is cached for any reason, for purposes here</span>
                            <span class="token comment">// we are going to consider it empty.  The specific cached state</span>
                            <span class="token comment">// doesn't propagate except under certain conditions.</span>
                            <span class="token comment">//客户端的进程状态优先级低于全部归类为cached empty的进程</span>
                            clientProcState <span class="token operator">=</span> <span class="token constant">PROCESS_STATE_CACHED_EMPTY</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
</code></pre> 
<h5><a id="2794__1226"></a>27.9.4 如果进程设置了在低内存时托管给系统</h5> 
<p>如果进程设置了在低内存时托管给系统，就可以减少很多进程依赖关系的调整，<br> 不过目前大部分应用没有使用，而且这里规则也不是很细致</p> 
<pre><code class="prism language-java">
                        <span class="token comment">// adjType先初始化为null</span>
                        <span class="token class-name">String</span> adjType <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                        <span class="token comment">// 如果服务连接记录设置了BIND_ALLOW_OOM_MANAGEMENT</span>
                        <span class="token comment">//这个标记位的意思是允许系统在低内存的时候会删除这个进程，或者服务长时间运行会被杀死和重启</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cr<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">BIND_ALLOW_OOM_MANAGEMENT</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">// Similar to BIND_WAIVE_PRIORITY, keep it unfrozen.</span>
                            <span class="token comment">//如果绑定服务的客户端的adj(clientAdj)，小于900，则服务也不会进行冻结</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>clientAdj <span class="token operator">&lt;</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">CACHED_APP_MIN_ADJ</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                app<span class="token punctuation">.</span>mOptRecord<span class="token punctuation">.</span><span class="token function">setShouldNotFreeze</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token comment">// Not doing bind OOM management, so treat</span>
                            <span class="token comment">// this guy more like a started service.</span>
                            <span class="token comment">//如果当前调整的进程拥有界面(hasShownUi只要该进程有onStartActivity的操作，就会设置成true，不管activity是否destroy，只要进程还在都是true)</span>
                            <span class="token comment">//而且不是桌面的情况下</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span><span class="token function">hasShownUi</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>state<span class="token punctuation">.</span><span class="token function">getCachedIsHomeProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token comment">// If this process has shown some UI, let it immediately</span>
                                <span class="token comment">// go to the LRU list because it may be pretty heavy with</span>
                                <span class="token comment">// UI stuff.  We'll tag it with a label just to help</span>
                                <span class="token comment">// debug and understand what is going on.</span>
                                <span class="token comment">//如果服务端的adj大于客户端clientAdj，则将adj类型设置成"cch-bound-ui-services"(缓存的拥有ui、被绑定的服务)</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>adj <span class="token operator">&gt;</span> clientAdj<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                    adjType <span class="token operator">=</span> <span class="token string">"cch-bound-ui-services"</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                                <span class="token comment">//设置cached为fasle，代表这个不是cached进程</span>
                                state<span class="token punctuation">.</span><span class="token function">setCached</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token comment">//将服务的adj赋值给clientAdj，注意一下这里的clientAdj只是用来调整服务端的adj，</span>
                                <span class="token comment">//这里的意思是此时将不根据客户端的优先级调整服务端的优先级</span>
                                <span class="token comment">//这样可以有效的避免互相依赖关系，这个功能还不错，只是目前大多数服务绑定时没有设置这个TAG</span>
                                <span class="token comment">//而且目前该逻辑也相对简单，不太适合统一打开，需要更精细控制</span>
                                clientAdj <span class="token operator">=</span> adj<span class="token punctuation">;</span>
                                <span class="token comment">//将服务的进程状态procState赋值给clientProcState ，跟上面是一个意思，调整adj时忽略客户端的进程状态</span>
                                clientProcState <span class="token operator">=</span> procState<span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token comment">//针对没有界面服务，或者是桌面</span>
                                <span class="token comment">//则看一下s.lastActivity(服务启动或者绑定的时候会设置该时间)</span>
                                <span class="token comment">//是否上一次服务启动或者绑定的时间已经超过MAX_SERVICE_INACTIVITY(默认30分钟）</span>
                                <span class="token comment">//30分钟以内的话不进入这里，还是会根据客户端的优先级来调整服务端的优先级，</span>
                                <span class="token comment">//30分钟以内，相当于没有设置BIND_ALLOW_OOM_MANAGEMENT一样的逻辑</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">&gt;=</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span>lastActivity
                                        <span class="token operator">+</span> mConstants<span class="token punctuation">.</span><span class="token constant">MAX_SERVICE_INACTIVITY</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                    <span class="token comment">// This service has not seen activity within</span>
                                    <span class="token comment">// recent memory, so allow it to drop to the</span>
                                    <span class="token comment">// LRU list if there is no other reason to keep</span>
                                    <span class="token comment">// it around.  We'll also tag it with a label just</span>
                                    <span class="token comment">// to help debug and undertand what is going on.</span>
                                    <span class="token comment">//如果是的话，当前服务端的adj小于clientAdj，也就是服务adj优先级没有客户端高</span>
                                    <span class="token keyword">if</span> <span class="token punctuation">(</span>adj <span class="token operator">&gt;</span> clientAdj<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                        <span class="token comment">//那么将adj类型设置成"cch-bound-services"（缓存的绑定服务），代表不通过客户端来调整服务端的adj</span>
                                        adjType <span class="token operator">=</span> <span class="token string">"cch-bound-services"</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span>
                                    <span class="token comment">//忽略客户端adj，不管客户端adj的大小，将服务的adj赋值给clientAdj后，都将忽略clientAdj</span>
                                    clientAdj <span class="token operator">=</span> adj<span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
</code></pre> 
<h5><a id="2795_clientAdjadjadj_1290"></a>27.9.5 如果clientAdj大于当前服务的adj，则开始adj依赖关系调整</h5> 
<pre><code class="prism language-java">
                        <span class="token comment">//如果客户端的clientAdj小于当前服务的adj，</span>
                        <span class="token comment">//那么将会根据客户端的clientAdj进行服务的优先级调整，我们认为这是依赖关系调整即可</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>adj <span class="token operator">&gt;</span> clientAdj<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">// If this process has recently shown UI, and</span>
                            <span class="token comment">// the process that is binding to it is less</span>
                            <span class="token comment">// important than being visible, then we don't</span>
                            <span class="token comment">// care about the binding as much as we care</span>
                            <span class="token comment">// about letting this process get into the LRU</span>
                            <span class="token comment">// list to be killed and restarted if needed for</span>
                            <span class="token comment">// memory.</span>
                            <span class="token comment">//如果当前调整的进程拥有界面(hasShownUi只要该进程有onStartActivity的操作，就会设置成true，不管activity是否destroy，只要进程还在都是true)</span>
                            <span class="token comment">//而且不是桌面的情况下，这里逻辑跟上面一样，不过多了一个clientAdj如果是大于用户可感知的200才会进来</span>
                            <span class="token comment">//如果clientAdj小于等于200(优先级大于等于用户可感知级别的话)，那就不会进来</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span><span class="token function">hasShownUi</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>state<span class="token punctuation">.</span><span class="token function">getCachedIsHomeProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                    <span class="token operator">&amp;&amp;</span> clientAdj <span class="token operator">&gt;</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">PERCEPTIBLE_APP_ADJ</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token comment">//注意就算是进来，也只进行了一个操作，就是当前进程的adj如果大于等于900</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>adj <span class="token operator">&gt;=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">CACHED_APP_MIN_ADJ</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                    <span class="token comment">//则将当前进程的adj类型设置成"cch-bound-ui-services"</span>
                                    adjType <span class="token operator">=</span> <span class="token string">"cch-bound-ui-services"</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                                <span class="token comment">//这里少了对比上面少了state.setCached(false);clientAdj = adj;clientProcState = procState;</span>
                                <span class="token comment">//isCached没有直接设置成false，isCached用的地方比较少，主要用在performUpdateOomAdjLSP</span>
                                <span class="token comment">//state.setCached(false);</span>
                                <span class="token comment">//这个确实没有作用了，目前已经跑完了if (adj &gt; clientAdj)的逻辑，没有用到clientAdj的地方了，</span>
                                <span class="token comment">//起码adj暂时不会由于clientAdj去调整</span>
                                <span class="token comment">//clientAdj = adj;</span>
                                <span class="token comment">//这个不设置是由于后面还需要用到，还会由于客户端的进程状态调整当前进程的进程状态</span>
                                <span class="token comment">//clientProcState = procState;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token comment">//其它情况会根据客户端的clientAdj，看情况调整当前进程的adj</span>
                                <span class="token keyword">int</span> newAdj<span class="token punctuation">;</span>

                                <span class="token comment">//如果服务链接里面包含BIND_ABOVE_CLIENT或者BIND_IMPORTANT的时候</span>
                                <span class="token comment">//BIND_ABOVE_CLIENT: 代表服务的优先级需要比客户端client的高</span>
                                <span class="token comment">//BIND_IMPORTANT: 正常情况是就客户端是前台，服务端最多也只是visable，不过设置了这个，</span>
                                <span class="token comment">//adj可以到0(fg)或者-700(PERSISTENT_SERVICE)</span>
                                <span class="token comment">//StorageUserConnection里面bindServiceAsUser就有设置BIND_IMPORTANT</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cr<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">BIND_ABOVE_CLIENT</span>
                                        <span class="token operator">|</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">BIND_IMPORTANT</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                    <span class="token comment">//如果客户端的adj大于等于-700，直接将客户端的clientAdj赋值给当前进程的newAdj</span>
                                    <span class="token keyword">if</span> <span class="token punctuation">(</span>clientAdj <span class="token operator">&gt;=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">PERSISTENT_SERVICE_ADJ</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                        newAdj <span class="token operator">=</span> clientAdj<span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                                        <span class="token comment">//如果客户端的adj是常驻进程(-800)或者系统(-900)</span>
                                        <span class="token comment">// make this service persistent</span>
                                        <span class="token comment">// 直接赋值newAdj为PERSISTENT_SERVICE_ADJ(常驻服务)级别，</span>
                                        <span class="token comment">//这类进程和常驻进程有区别，不需要开机之前启动，可以动态设置和关闭</span>
                                        newAdj <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">PERSISTENT_SERVICE_ADJ</span><span class="token punctuation">;</span>
                                        <span class="token comment">//cgroup分组设置成default，具体之前有解释</span>
                                        schedGroup <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SCHED_GROUP_DEFAULT</span><span class="token punctuation">;</span>
                                        <span class="token comment">//进程状态设置成PROCESS_STATE_PERSISTENT</span>
                                        procState <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token constant">PROCESS_STATE_PERSISTENT</span><span class="token punctuation">;</span>
                                        <span class="token comment">//将关联关系记录的信息保存在AssociationState.SourceState中，主要是进程状态，当前调整的序列号和调整时间</span>
                                        cr<span class="token punctuation">.</span><span class="token function">trackProcState</span><span class="token punctuation">(</span>procState<span class="token punctuation">,</span> mAdjSeq<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        <span class="token comment">//标记已经记录过进程状态信息trackedProcState了，后面就不需要再做一次了</span>
                                        trackedProcState <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span>
                                <span class="token comment">//如果服务链接里面包含BIND_NOT_PERCEPTIBLE(服务进程的优先级提升不会高于250)</span>
                                <span class="token comment">//clientAdj优先级比200高(或等于PERCEPTIBLE_APP_ADJ),而且当前进程优先级小于250(PERCEPTIBLE_LOW_APP_ADJ)</span>
                                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cr<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> <span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">BIND_NOT_PERCEPTIBLE</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
                                        <span class="token operator">&amp;&amp;</span> clientAdj <span class="token operator">&lt;=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">PERCEPTIBLE_APP_ADJ</span>
                                        <span class="token operator">&amp;&amp;</span> adj <span class="token operator">&gt;=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">PERCEPTIBLE_LOW_APP_ADJ</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                    <span class="token comment">//则会设置成250(PERCEPTIBLE_LOW_APP_ADJ)</span>
                                    newAdj <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">PERCEPTIBLE_LOW_APP_ADJ</span><span class="token punctuation">;</span>
                                <span class="token comment">//如果设置了BIND_ALMOST_PERCEPTIBLE(接近是perceptible)</span>
                                <span class="token comment">//而且客户端clientAdj小于200（优先级大于PERCEPTIBLE_APP_ADJ）</span>
                                <span class="token comment">//而且当前进程adj大于等于225（优先级小于等于PERCEPTIBLE_MEDIUM_APP_ADJ 250）</span>
                                <span class="token comment">//看逻辑貌似adj == 225的不需要将newAdj赋值成225(没用到)，这里等于还有一个含义，就是进入此处的else，不进行别的else判断</span>
                                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cr<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> <span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">BIND_ALMOST_PERCEPTIBLE</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
                                        <span class="token operator">&amp;&amp;</span> clientAdj <span class="token operator">&lt;</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">PERCEPTIBLE_APP_ADJ</span>
                                        <span class="token operator">&amp;&amp;</span> adj <span class="token operator">&gt;=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">PERCEPTIBLE_MEDIUM_APP_ADJ</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                    <span class="token comment">//newAdj设置成225(PERCEPTIBLE_MEDIUM_APP_ADJ)</span>
                                    newAdj <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">PERCEPTIBLE_MEDIUM_APP_ADJ</span><span class="token punctuation">;</span>
                                <span class="token comment">//如果设置了BIND_NOT_VISIBLE(不要绑定成为visible 100进程)</span>
                                <span class="token comment">//而且客户端clientAdj小于200（优先级大于PERCEPTIBLE_APP_ADJ）</span>
                                <span class="token comment">//而且当前进程adj大于等于200（优先级小于等于PERCEPTIBLE_APP_ADJ）</span>
                                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cr<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">BIND_NOT_VISIBLE</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
                                        <span class="token operator">&amp;&amp;</span> clientAdj <span class="token operator">&lt;</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">PERCEPTIBLE_APP_ADJ</span>
                                        <span class="token operator">&amp;&amp;</span> adj <span class="token operator">&gt;=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">PERCEPTIBLE_APP_ADJ</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                    <span class="token comment">//newAdj设置成200(PERCEPTIBLE_APP_ADJ)</span>
                                    newAdj <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">PERCEPTIBLE_APP_ADJ</span><span class="token punctuation">;</span>
                                <span class="token comment">//而且客户端clientAdj大于等于200（优先级小于等于PERCEPTIBLE_APP_ADJ）</span>
                                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>clientAdj <span class="token operator">&gt;=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">PERCEPTIBLE_APP_ADJ</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                    <span class="token comment">//newAdj设置成客户端的优先级clientAdj</span>
                                    newAdj <span class="token operator">=</span> clientAdj<span class="token punctuation">;</span>
                                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                                    <span class="token comment">//假设你什么都没有设置，而且客户端clientAdj优先级大于200</span>
                                    <span class="token comment">//（那么客户端就是visible/fg/persistent/system的应用）</span>
                                    <span class="token comment">//如果应用进程adj优先级小于100(VISIBLE_APP_ADJ)</span>
                                    <span class="token keyword">if</span> <span class="token punctuation">(</span>adj <span class="token operator">&gt;</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">VISIBLE_APP_ADJ</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                        <span class="token comment">// TODO: Is this too limiting for apps bound from TOP?</span>
                                        <span class="token comment">//则新的adj由于依赖关系，最多设置成visiable级别(100)，此处是[100, 200)</span>
                                        newAdj <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>clientAdj<span class="token punctuation">,</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">VISIBLE_APP_ADJ</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                                        <span class="token comment">//如果应用进程adj优先级本来就很高，如adj小于等于100，则将当前进程adj赋值给newAdj，不做adj改变</span>
                                        newAdj <span class="token operator">=</span> adj<span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span>
                                <span class="token punctuation">}</span>
                                <span class="token comment">//只要是客户端不是cached process缓存进程</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cstate<span class="token punctuation">.</span><span class="token function">isCached</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                    <span class="token comment">//那么服务端也会设置成非缓存进程</span>
                                    state<span class="token punctuation">.</span><span class="token function">setCached</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>

                                <span class="token comment">//只要当前adj大于新的newAdj(新的adj优先级大于当前adj的优先级)</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>adj <span class="token operator">&gt;</span>  newAdj<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                    <span class="token comment">//将新的优先级newAdj，赋值给当前进程的adj</span>
                                    adj <span class="token operator">=</span> newAdj<span class="token punctuation">;</span>
                                    <span class="token comment">//将adj保存在未经过约束的mCurRawAdj中，这里保存的是比较新的值</span>
                                    state<span class="token punctuation">.</span><span class="token function">setCurRawAdj</span><span class="token punctuation">(</span>adj<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_OOM_ADJ_REASON</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                        <span class="token comment">//打开DEBUG_OOM_ADJ_REASON会输出adj调整的日志，此处的nowActivityTime表示是否上一次start/bind到现在超过30分钟</span>
                                        <span class="token keyword">boolean</span> nowActivityTime <span class="token operator">=</span> <span class="token punctuation">(</span>now <span class="token operator">&gt;</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span>lastActivity <span class="token operator">+</span> mConstants<span class="token punctuation">.</span><span class="token constant">MAX_SERVICE_INACTIVITY</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"newAdjservice: "</span> <span class="token operator">+</span> app <span class="token operator">+</span> <span class="token string">", adj = "</span> <span class="token operator">+</span> adj <span class="token operator">+</span> <span class="token string">", client = "</span> <span class="token operator">+</span> client <span class="token operator">+</span> <span class="token string">", client.uid = "</span> <span class="token operator">+</span> client<span class="token punctuation">.</span>uid
                                            <span class="token operator">+</span><span class="token string">", nowActivityTime = "</span> <span class="token operator">+</span> nowActivityTime <span class="token operator">+</span> <span class="token string">", state.hasShownUi = "</span> <span class="token operator">+</span> state<span class="token punctuation">.</span><span class="token function">hasShownUi</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                            <span class="token operator">+</span> <span class="token string">", clientProcState ="</span> <span class="token operator">+</span> clientProcState <span class="token operator">+</span> <span class="token string">", cr = "</span> <span class="token operator">+</span> cr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span>
                                    <span class="token comment">//将adj类型设置成服务</span>
                                    adjType <span class="token operator">=</span> <span class="token string">"service"</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
</code></pre> 
<h5><a id="2796_clientProcState_1418"></a>27.9.6 clientProcState依赖关系调整</h5> 
<pre><code class="prism language-java">
                        <span class="token comment">//如果没有设置BIND_NOT_FOREGROUND(非前台绑定)和BIND_IMPORTANT_BACKGROUND(绑定重要后台)的时候</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cr<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">BIND_NOT_FOREGROUND</span>
                                <span class="token operator">|</span> <span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">BIND_IMPORTANT_BACKGROUND</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">// This will treat important bound services identically to</span>
                            <span class="token comment">// the top app, which may behave differently than generic</span>
                            <span class="token comment">// foreground work.</span>
                            <span class="token comment">//获取客户端cgroup设置的分组信息赋值给curSchedGroup</span>
                            <span class="token keyword">final</span> <span class="token keyword">int</span> curSchedGroup <span class="token operator">=</span> cstate<span class="token punctuation">.</span><span class="token function">getCurrentSchedulingGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">//如果当前curSchedGroup(客户端分组优先级)大于schedGroup(当前进程分组优先级)</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>curSchedGroup <span class="token operator">&gt;</span> schedGroup<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token comment">//如果设置了BIND_IMPORTANT(重要的绑定)</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cr<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">BIND_IMPORTANT</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                    <span class="token comment">//则将客户端的cgroup分组优先级设置给当前进程的分组信息</span>
                                    schedGroup <span class="token operator">=</span> curSchedGroup<span class="token punctuation">;</span>
                                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                                    <span class="token comment">//如果没有设置，则默认的分组先设置成defalut</span>
                                    schedGroup <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SCHED_GROUP_DEFAULT</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                            <span class="token comment">//如果客户端进程状态小于top(2)，也就是说客户端是常驻进程</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>clientProcState <span class="token operator">&lt;</span> <span class="token constant">PROCESS_STATE_TOP</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token comment">// Special handling for above-top states (persistent</span>
                                <span class="token comment">// processes).  These should not bring the current process</span>
                                <span class="token comment">// into the top state, since they are not on top.  Instead</span>
                                <span class="token comment">// give them the best bound state after that.</span>
                                <span class="token comment">//如有拥有BIND_FOREGROUND_SERVICE(绑定前台服务，一般来自系统的绑定)</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>cr<span class="token punctuation">.</span><span class="token function">hasFlag</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">BIND_FOREGROUND_SERVICE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                    <span class="token comment">//客户端的进程状态clientProcState设置成PROCESS_STATE_BOUND_FOREGROUND_SERVICE(5)(绑定了前台进程的服务)</span>
                                    <span class="token comment">//此处修改clientProcState不会直接修改客户端的进程状态，只是为了后面去修改服务端的进程状态使用</span>
                                    clientProcState <span class="token operator">=</span> <span class="token constant">PROCESS_STATE_BOUND_FOREGROUND_SERVICE</span><span class="token punctuation">;</span>
                                    <span class="token comment">//更新mAllowStartFgsState，最小设置成PROCESS_STATE_BOUND_FOREGROUND_SERVICE</span>
                                    <span class="token comment">//只要mAllowStartFgsState &lt;= PROCESS_STATE_BOUND_FOREGROUND_SERVICE则有前台服务启动的权限</span>
                                    state<span class="token punctuation">.</span><span class="token function">bumpAllowStartFgsState</span><span class="token punctuation">(</span>
                                            <span class="token constant">PROCESS_STATE_BOUND_FOREGROUND_SERVICE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token comment">//其它情况，mWakefulness是唤醒状态</span>
                                <span class="token comment">//而且包含BIND_FOREGROUND_SERVICE_WHILE_AWAKE(在唤醒时绑定前台服务)</span>
                                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mWakefulness<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                        <span class="token operator">==</span> <span class="token class-name">PowerManagerInternal</span><span class="token punctuation">.</span><span class="token constant">WAKEFULNESS_AWAKE</span>
                                        <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>cr<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> <span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">BIND_FOREGROUND_SERVICE_WHILE_AWAKE</span><span class="token punctuation">)</span>
                                                <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                    <span class="token comment">//将clientProcState设置成PROCESS_STATE_BOUND_FOREGROUND_SERVICE(5)(绑定了前台进程的服务)</span>
                                    clientProcState <span class="token operator">=</span> <span class="token constant">PROCESS_STATE_BOUND_FOREGROUND_SERVICE</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                                    <span class="token comment">//将clientProcState设置成PROCESS_STATE_IMPORTANT_FOREGROUND(6)(重要的前台，这个进程状态级别不能启动前台服务)</span>
                                    clientProcState <span class="token operator">=</span>
                                            <span class="token constant">PROCESS_STATE_IMPORTANT_FOREGROUND</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token comment">//如果clientProcState是PROCESS_STATE_TOP(2)，当前顶端的Activity(非睡眠状态才会是这个级别)</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>clientProcState <span class="token operator">==</span> <span class="token constant">PROCESS_STATE_TOP</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token comment">// Go at most to BOUND_TOP, unless requested to elevate</span>
                                <span class="token comment">// to client's state.</span>
                                <span class="token comment">//后面用来调整当前进程的进程状态的clientProcState设置成PROCESS_STATE_BOUND_TOP(3)(绑定了前台进程)</span>
                                clientProcState <span class="token operator">=</span> <span class="token constant">PROCESS_STATE_BOUND_TOP</span><span class="token punctuation">;</span>
                                <span class="token comment">//更新是否运行启动前台服务的进程状态信息mAllowStartFgsState，允许启动前台服务</span>
                                state<span class="token punctuation">.</span><span class="token function">bumpAllowStartFgsState</span><span class="token punctuation">(</span><span class="token constant">PROCESS_STATE_BOUND_TOP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">boolean</span> enabled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                                    <span class="token comment">//" enableAfterTargetSdk="29" id="136274596" name="PROCESS_CAPABILITY_CHANGE_ID",代表mEnableSinceTargetSdk=20</span>
                                    <span class="token comment">//具体配置是读取/system/etc/compatconfig/services-platform-compat-config.xml进行初始话，这个是在30(android R)之后支持</span>
                                    <span class="token comment">//isChangeEnabled其实最终调用的是CompatChange的isEnabled，目前只是用apk的targetSdkVersion进行判断，主要大于30就返回true</span>
                                    enabled <span class="token operator">=</span> <span class="token function">getPlatformCompatCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isChangeEnabled</span><span class="token punctuation">(</span>
                                            <span class="token constant">PROCESS_CAPABILITY_CHANGE_ID</span><span class="token punctuation">,</span> client<span class="token punctuation">.</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token punctuation">}</span>

                                <span class="token comment">//如果sdk版本支持PROCESS_CAPABILITY_CHANGE_ID(30(android R)之后支持)</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>enabled<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                    <span class="token comment">//如果包含BIND_INCLUDE_CAPABILITIES，则会将客户端的能力全部赋值给服务端</span>
                                    <span class="token keyword">if</span> <span class="token punctuation">(</span>cr<span class="token punctuation">.</span><span class="token function">hasFlag</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">BIND_INCLUDE_CAPABILITIES</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                        <span class="token comment">// TOP process passes all capabilities to the service.</span>
                                        capability <span class="token operator">|=</span> cstate<span class="token punctuation">.</span><span class="token function">getCurCapability</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                                        <span class="token comment">//否者不更改进程能力</span>
                                        <span class="token comment">// TOP process passes no capability to the service.</span>
                                    <span class="token punctuation">}</span>
                                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                                    <span class="token comment">// TOP process passes all capabilities to the service.</span>
                                    <span class="token comment">//如果是旧版本sdk的apk，则将客户端的能力直接赋给服务端(也就是旧版本不约束)</span>
                                    capability <span class="token operator">|=</span> cstate<span class="token punctuation">.</span><span class="token function">getCurCapability</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                        <span class="token comment">//如果设置了BIND_NOT_FOREGROUND(非前台绑定)，而且没有设置BIND_IMPORTANT_BACKGROUND(绑定重要后台)的时候</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cr<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> <span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">BIND_IMPORTANT_BACKGROUND</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">//客户端进程状态clientProcState如果优先级大于PROCESS_STATE_TRANSIENT_BACKGROUND(8)</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>clientProcState <span class="token operator">&lt;</span>
                                    <span class="token constant">PROCESS_STATE_TRANSIENT_BACKGROUND</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token comment">//将clientProcState设置成PROCESS_STATE_TRANSIENT_BACKGROUND(8)</span>
                                clientProcState <span class="token operator">=</span>
                                        <span class="token constant">PROCESS_STATE_TRANSIENT_BACKGROUND</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">//如果设置了BIND_IMPORTANT_BACKGROUND(绑定重要后台)的时候</span>
                            <span class="token comment">//客户端进程状态小于PROCESS_STATE_IMPORTANT_BACKGROUND(7),也就是起码是IMPORTANT_FOREGROUND(6)</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>clientProcState <span class="token operator">&lt;</span>
                                    <span class="token constant">PROCESS_STATE_IMPORTANT_BACKGROUND</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token comment">//将clientProcState设置成PROCESS_STATE_IMPORTANT_BACKGROUND(7)</span>
                                clientProcState <span class="token operator">=</span>
                                        <span class="token constant">PROCESS_STATE_IMPORTANT_BACKGROUND</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>

                        <span class="token comment">//如果cgroup分组小于top(default/resticted/background)</span>
                        <span class="token comment">//而且flag包含了BIND_SCHEDULE_LIKE_TOP_APP(分组就像是top一样)，如IMEs输入法在有界面的情况下</span>
                        <span class="token comment">//而且客户端是系统或者常驻进程clientIsSystem=true</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>schedGroup <span class="token operator">&lt;</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SCHED_GROUP_TOP_APP</span>
                                <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>cr<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> <span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">BIND_SCHEDULE_LIKE_TOP_APP</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
                                <span class="token operator">&amp;&amp;</span> clientIsSystem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">//将分组信息设置成top app</span>
                            schedGroup <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SCHED_GROUP_TOP_APP</span><span class="token punctuation">;</span>
                            <span class="token comment">//标记这种app为scheduleLikeTopApp=true</span>
                            scheduleLikeTopApp <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token comment">//如果之前没有设置过trackedProcState=true(目前只有persistent service才有设置)</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>trackedProcState<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">//则将关联关系记录的信息保存在AssociationState.SourceState中，主要是进程状态，当前调整的序列号和调整时间</span>
                            cr<span class="token punctuation">.</span><span class="token function">trackProcState</span><span class="token punctuation">(</span>clientProcState<span class="token punctuation">,</span> mAdjSeq<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token comment">//如果当前进程状态procState大于clientProcState(就是没有(准备根据客户端调整的进程状态)clientProcState优先级高)</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>procState <span class="token operator">&gt;</span> clientProcState<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">//更新当前进程的进程状态procState </span>
                            procState <span class="token operator">=</span> clientProcState<span class="token punctuation">;</span>
                            <span class="token comment">//将procState赋值给mCurRawProcState(临时计算值)</span>
                            state<span class="token punctuation">.</span><span class="token function">setCurRawProcState</span><span class="token punctuation">(</span>procState<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">//如果adj类型为空，则赋值adj类型为服务</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>adjType <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                adjType <span class="token operator">=</span> <span class="token string">"service"</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>

                        <span class="token comment">//如果进程状态procState小于PROCESS_STATE_IMPORTANT_BACKGROUND(7)，</span>
                        <span class="token comment">//而且带有BIND_SHOWING_UI的标签</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>procState <span class="token operator">&lt;</span> <span class="token constant">PROCESS_STATE_IMPORTANT_BACKGROUND</span>
                                <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>cr<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> <span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">BIND_SHOWING_UI</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">//而且带有BIND_SHOWING_UI的标签，则设置ProcessProfileRecord的mPendingUiClean为true</span>
                            <span class="token comment">//mPendingUiClean会在更新内存等级的时候会使用，用户触发thread.scheduleTrimMemory进行应用不同级别的内存回收</span>
                            app<span class="token punctuation">.</span><span class="token function">setPendingUiClean</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
</code></pre> 
<h5><a id="2797_service_1564"></a>27.9.7 service依赖关系原因的输出</h5> 
<pre><code class="prism language-java">
                        <span class="token comment">//如果adjType不等与null，则把设置客户端setAdjSource和当前进程setAdjTarget</span>
                        <span class="token comment">//如果看到只有"service"没有连接对象，其中一种情况：可能是刚进入computeOomAdjLSP调整清空了之前的对象</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>adjType <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">//设置adj类型</span>
                            state<span class="token punctuation">.</span><span class="token function">setAdjType</span><span class="token punctuation">(</span>adjType<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">//设置adj类型的代码mAdjTypeCode，和importanceReasonCode类似，就是优先级的原因，此处是service正在使用中</span>
                            <span class="token comment">//客户端的进程在importanceReasonPid(getAdjSource)，服务端的进程在importanceReasonComponent(getAdjTarget)</span>
                            state<span class="token punctuation">.</span><span class="token function">setAdjTypeCode</span><span class="token punctuation">(</span><span class="token class-name">ActivityManager<span class="token punctuation">.</span>RunningAppProcessInfo</span>
                                    <span class="token punctuation">.</span><span class="token constant">REASON_SERVICE_IN_USE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">//cr.binding.client(AppBindRecord)这里是ProcessRecord，setAdjSource设置此次调整的来源：客户端ProcessRecord</span>
                            state<span class="token punctuation">.</span><span class="token function">setAdjSource</span><span class="token punctuation">(</span>cr<span class="token punctuation">.</span>binding<span class="token punctuation">.</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">//setAdjSourceProcState设置此次调整的进程状态来源：客户端约束后的clientProcState(不高于改值)</span>
                            state<span class="token punctuation">.</span><span class="token function">setAdjSourceProcState</span><span class="token punctuation">(</span>clientProcState<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">//setAdjTarget设置调整的原因的服务组件是instanceName(服务组件的实例)</span>
                            state<span class="token punctuation">.</span><span class="token function">setAdjTarget</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>instanceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_OOM_ADJ_REASON</span> <span class="token operator">||</span> logUid <span class="token operator">==</span> appUid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token function">reportOomAdjMessageLocked</span><span class="token punctuation">(</span><span class="token constant">TAG_OOM_ADJ</span><span class="token punctuation">,</span> <span class="token string">"Raise to "</span> <span class="token operator">+</span> adjType
                                        <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> app <span class="token operator">+</span> <span class="token string">", due to "</span> <span class="token operator">+</span> cr<span class="token punctuation">.</span>binding<span class="token punctuation">.</span>client
                                        <span class="token operator">+</span> <span class="token string">" adj="</span> <span class="token operator">+</span> adj <span class="token operator">+</span> <span class="token string">" procState="</span>
                                        <span class="token operator">+</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token function">makeProcStateString</span><span class="token punctuation">(</span>procState<span class="token punctuation">)</span><span class="token operator">+</span> <span class="token string">", client="</span> <span class="token operator">+</span> client
                                        <span class="token operator">+</span> <span class="token string">", cr="</span> <span class="token operator">+</span> cr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="2710_BIND_WAIVE_PRIORITY__true_1593"></a>27.10 BIND_WAIVE_PRIORITY == true豁免优先级调整</h4> 
<pre><code class="prism language-java">
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// 如果设置了BIND_WAIVE_PRIORITY == true，一般没有跑，此处会豁免adj优先级的调整</span>
                        <span class="token comment">// BIND_WAIVE_PRIORITY bindings are special when it comes to the</span>
                        <span class="token comment">// freezer. Processes bound via WPRI are expected to be running,</span>
                        <span class="token comment">// but they are not promoted in the LRU list to keep them out of</span>
                        <span class="token comment">// cached. As a result, they can freeze based on oom_adj alone.</span>
                        <span class="token comment">// Normally, bindToDeath would fire when a cached app would die</span>
                        <span class="token comment">// in the background, but nothing will fire when a running process</span>
                        <span class="token comment">// pings a frozen process. Accordingly, any cached app that is</span>
                        <span class="token comment">// bound by an unfrozen app via a WPRI binding has to remain</span>
                        <span class="token comment">// unfrozen.</span>
                        <span class="token comment">//如果客户端是非cached进程，则当前的服务进程不能被冻结</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>clientAdj <span class="token operator">&lt;</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">CACHED_APP_MIN_ADJ</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            app<span class="token punctuation">.</span>mOptRecord<span class="token punctuation">.</span><span class="token function">setShouldNotFreeze</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="2711_activity_1615"></a>27.11 绑定客户端对象是activity的调整</h4> 
<pre><code class="prism language-java">                    <span class="token comment">//链接记录对象cr是ConnectionRecord cr = clist.get(i);如果该链接设置了BIND_TREAT_LIKE_ACTIVITY</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cr<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">BIND_TREAT_LIKE_ACTIVITY</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//服务端psr则设置setTreatLikeActivity的标记位，需要像对待activity一样对待该服务进程</span>
                        psr<span class="token punctuation">.</span><span class="token function">setTreatLikeActivity</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token comment">//获取绑定客户端对象的activity(只有客户端是activity的时候才有这个对象)</span>
                    <span class="token keyword">final</span> <span class="token class-name">ActivityServiceConnectionsHolder</span> a <span class="token operator">=</span> cr<span class="token punctuation">.</span>activity<span class="token punctuation">;</span>
                    <span class="token comment">//如果ConnectionRecord设置了BIND_ADJUST_WITH_ACTIVITY：可以根据客户端activity是否可见来调整优先级</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cr<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">BIND_ADJUST_WITH_ACTIVITY</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//如果客户端activity不为null，而且当前服务adj大于0(FOREGROUND_APP_ADJ),</span>
                        <span class="token comment">//而且客户端activity是可见的</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> adj <span class="token operator">&gt;</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">FOREGROUND_APP_ADJ</span>
                                <span class="token operator">&amp;&amp;</span> a<span class="token punctuation">.</span><span class="token function">isActivityVisible</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">//则直接设置服务端adj为0(FOREGROUND_APP_ADJ)</span>
                            adj <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">FOREGROUND_APP_ADJ</span><span class="token punctuation">;</span>
                            <span class="token comment">//将adj保存在未经过约束的mCurRawAdj中</span>
                            state<span class="token punctuation">.</span><span class="token function">setCurRawAdj</span><span class="token punctuation">(</span>adj<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">//如果标签不包含BIND_NOT_FOREGROUND(非前台绑定,不允许上升到前台分组)</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cr<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">BIND_NOT_FOREGROUND</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token comment">//包含重要绑定BIND_IMPORTANT(对客户端来说非常重要，需要提升到前台)</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cr<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">BIND_IMPORTANT</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                    <span class="token comment">//则分组cgroup直接设置成top app</span>
                                    schedGroup <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SCHED_GROUP_TOP_APP_BOUND</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                                    <span class="token comment">//否则分组cgroup设置成默认</span>
                                    schedGroup <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SCHED_GROUP_DEFAULT</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                            <span class="token comment">//设置成非cached进程</span>
                            state<span class="token punctuation">.</span><span class="token function">setCached</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">//adj类型为服务"service"</span>
                            state<span class="token punctuation">.</span><span class="token function">setAdjType</span><span class="token punctuation">(</span><span class="token string">"service"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">//设置adj类型的代码mAdjTypeCode(和importanceReasonCode类似，就是优先级的原因)为service正在使用中</span>
                            state<span class="token punctuation">.</span><span class="token function">setAdjTypeCode</span><span class="token punctuation">(</span><span class="token class-name">ActivityManager<span class="token punctuation">.</span>RunningAppProcessInfo</span>
                                    <span class="token punctuation">.</span><span class="token constant">REASON_SERVICE_IN_USE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">//setAdjSource设置此次调整的来源：客户端ActivityServiceConnectionsHolder</span>
                            state<span class="token punctuation">.</span><span class="token function">setAdjSource</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">//setAdjSourceProcState设置此次调整的进程状态来源：procState(这里已经是调整后的进程状态值)</span>
                            state<span class="token punctuation">.</span><span class="token function">setAdjSourceProcState</span><span class="token punctuation">(</span>procState<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">//setAdjTarget设置调整的原因的服务组件是instanceName(服务组件的实例)</span>
                            state<span class="token punctuation">.</span><span class="token function">setAdjTarget</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>instanceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">//如果打开DEBUG_OOM_ADJ_REASON、或者设置了logUid，则会打印日志</span>
                            <span class="token comment">//logUid可以通过直接介绍的adb shell am watch-uids --oom + ***来设置</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_OOM_ADJ_REASON</span> <span class="token operator">||</span> logUid <span class="token operator">==</span> appUid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token comment">//adj调整的原因是activity</span>
                                <span class="token function">reportOomAdjMessageLocked</span><span class="token punctuation">(</span><span class="token constant">TAG_OOM_ADJ</span><span class="token punctuation">,</span>
                                        <span class="token string">"Raise to service w/activity: "</span> <span class="token operator">+</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p><code>到这里就结束了服务依赖调整：当前是服务进程，由于客户端进程的adj和进程状态，进行服务进程的adj和进程状态调整</code></p> 
<h3><a id="28_provider_1676"></a>28. provider依赖关系调整</h3> 
<p><code>provider依赖关系调整：当前是provider内容提供者进程，由于客户端进程的adj和进程状态，进行provider进程的adj和进程状态调整</code></p> 
<h4><a id="281_provider_1681"></a>28.1 只有当前是provider内容提供者进程才调整</h4> 
<pre><code class="prism language-java">        <span class="token comment">//接下去就是当前进程的mProviders(provider对象保存信息)的调整，这里逻辑相对少一点</span>
        <span class="token keyword">final</span> <span class="token class-name">ProcessProviderRecord</span> ppr <span class="token operator">=</span> app<span class="token punctuation">.</span>mProviders<span class="token punctuation">;</span>
        <span class="token comment">//一样是倒叙遍历每一个ContentProviderRecord(单个provider连接信息)</span>
        <span class="token comment">//如果adj大于0(非前台进程)或者分组cgroup是后台(0)或者进程状态小于PROCESS_STATE_TOP(2)满足一个才会进来</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> provi <span class="token operator">=</span> ppr<span class="token punctuation">.</span><span class="token function">numberOfProviders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
                provi <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>adj <span class="token operator">&gt;</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">FOREGROUND_APP_ADJ</span>
                        <span class="token operator">||</span> schedGroup <span class="token operator">==</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SCHED_GROUP_BACKGROUND</span>
                        <span class="token operator">||</span> procState <span class="token operator">&gt;</span> <span class="token constant">PROCESS_STATE_TOP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                provi<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

            <span class="token comment">//取出每个保存provider连接信息的ContentProviderRecord对象</span>
            <span class="token comment">//每个包含ActivityManagerService _service（AMS对象）</span>
            <span class="token comment">//ProviderInfo _info(通过PMS的resolveContentProvider获得，provider的info信息)</span>
            <span class="token comment">//ApplicationInfo ai(provider(内容提供者)的Application的信息)</span>
            <span class="token comment">//ComponentName _name(ProviderInfo构建的组件名字)</span>
            <span class="token comment">//boolean _singleton(provider是否singleton单例模式)</span>
            <span class="token class-name">ContentProviderRecord</span> cpr <span class="token operator">=</span> ppr<span class="token punctuation">.</span><span class="token function">getProviderAt</span><span class="token punctuation">(</span>provi<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//每一次provider访问调用incProviderCountLocked的时候，</span>
            <span class="token comment">//都会将ContentProviderConnection add到connections里去(cpr.connections.add(conn))</span>
            <span class="token comment">//这里还是和上面一样adj大于0(非前台进程)或者分组cgroup是后台(0)或者进程状态小于PROCESS_STATE_TOP(2)有一个满足才会进来</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> cpr<span class="token punctuation">.</span>connections<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
                    i <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>adj <span class="token operator">&gt;</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">FOREGROUND_APP_ADJ</span>
                            <span class="token operator">||</span> schedGroup <span class="token operator">==</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SCHED_GROUP_BACKGROUND</span>
                            <span class="token operator">||</span> procState <span class="token operator">&gt;</span> <span class="token constant">PROCESS_STATE_TOP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//获取ContentProviderConnection，其在ContentProviderHelper创建的时候的变量有</span>
                <span class="token comment">//provider当前provider的ContentProviderRecord</span>
                <span class="token comment">//client客户端调用者的ProcessRecord</span>
                <span class="token comment">//clientPackage调用者的包名(getContentProvider传入的callingPackage)</span>
                <span class="token comment">//mExpectedUserId(默认是调用者的UserId；如果uir的auth有制定uid则用auth的(getUserIdFromAuthority))</span>
                <span class="token comment">//createTime创建new ContentProviderConnection的时间</span>
                <span class="token class-name">ContentProviderConnection</span> conn <span class="token operator">=</span> cpr<span class="token punctuation">.</span>connections<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//client客户端调用者的ProcessRecord</span>
                <span class="token class-name">ProcessRecord</span> client <span class="token operator">=</span> conn<span class="token punctuation">.</span>client<span class="token punctuation">;</span>
                <span class="token comment">//cstate是客户端进程状态记录信息ProcessStateRecord</span>
                <span class="token keyword">final</span> <span class="token class-name">ProcessStateRecord</span> cstate <span class="token operator">=</span> client<span class="token punctuation">.</span>mState<span class="token punctuation">;</span>

                <span class="token comment">//如果客户端(查询者)就是当前app，则直接返回。我们只关注提供内容的provider端(内容提供者)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>client <span class="token operator">==</span> app<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// Being our own client is not interesting.</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="282_computeClientsshouldSkipDueToCycle_1729"></a>28.2 循环计算computeClients和判断是否需要跳过本次计算shouldSkipDueToCycle</h4> 
<pre><code class="prism language-java">                <span class="token comment">//computeClients是否需要计算当前进程的时候计算服务、provider提供者对端client的adj。和上面服务端计算依赖关系是一样的</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>computeClients<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//调整之前先计算client的adj，将client按照当前传递计算app的重新计算一次，此处就有可能循环计算，mAdjSeq目前都是一个</span>
                    <span class="token function">computeOomAdjLSP</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> cachedAdj<span class="token punctuation">,</span> topApp<span class="token punctuation">,</span> doingAll<span class="token punctuation">,</span> now<span class="token punctuation">,</span> cycleReEval<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//如果不需要计算客户端的优先级，那么setCurRawAdj先将客户端当前调整的mCurAdj更新到mCurRawAdj中</span>
                    <span class="token comment">//mCurAdj当前调整的adj值，进过约束的(如mHasAboveClient进行约束，client app进程优先级会相应降低)</span>
                    <span class="token comment">//mCurRawAdj当前调整的adj值，但是未经过约束</span>
                    <span class="token comment">//mSetRawAdj上一次applyOomAdjLSP后设置的mCurRawAdj值</span>
                    <span class="token comment">//mSetAdj上一次applyOomAdjLSP后设置的mCurAdj值</span>
                    cstate<span class="token punctuation">.</span><span class="token function">setCurRawAdj</span><span class="token punctuation">(</span>cstate<span class="token punctuation">.</span><span class="token function">getCurAdj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">//mCurProcState是跑完一次computeOomAdjLSP的出的进程状态结果</span>
                    <span class="token comment">//而mCurRawProcState是当前的进程状态，是在计算中的临时结果</span>
                    <span class="token comment">//setCurRawProcState将上一次计算的进程状态mCurProcState赋值给mCurRawProcState(临时计算值)</span>
                    cstate<span class="token punctuation">.</span><span class="token function">setCurRawProcState</span><span class="token punctuation">(</span>cstate<span class="token punctuation">.</span><span class="token function">getCurProcState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">//判断是是否客户端adj没有计算完成，是否需要跳过本次依赖关系的计算，具体请看shouldSkipDueToCycle的解释</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldSkipDueToCycle</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> cstate<span class="token punctuation">,</span> procState<span class="token punctuation">,</span> adj<span class="token punctuation">,</span> cycleReEval<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="283_clientAdjclientProcState_1756"></a>28.3 调整前客户端的clientAdj、clientProcState的记录</h4> 
<pre><code class="prism language-java">                <span class="token comment">//取得客户端的mCurRawAdj当前调整的adj值(未经过约束)</span>
                <span class="token keyword">int</span> clientAdj <span class="token operator">=</span> cstate<span class="token punctuation">.</span><span class="token function">getCurRawAdj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//取得客户端的临时计算的最新进程状态值mCurRawProcState</span>
                <span class="token keyword">int</span> clientProcState <span class="token operator">=</span> cstate<span class="token punctuation">.</span><span class="token function">getCurRawProcState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//客户端的进程状态优先级低于cached activity</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>clientProcState <span class="token operator">&gt;=</span> <span class="token constant">PROCESS_STATE_CACHED_ACTIVITY</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// If the other app is cached for any reason, for purposes here</span>
                    <span class="token comment">// we are going to consider it empty.</span>
                    <span class="token comment">//客户端的进程状态优先级低于全部归类为cached empty的进程</span>
                    clientProcState <span class="token operator">=</span> <span class="token constant">PROCESS_STATE_CACHED_EMPTY</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">//如果客户端mShouldNotFreeze是true，则服务端也被设置不允许冻结。</span>
                <span class="token comment">//（原生冻结有2个条件，一个是adj大于等于900，而且mShouldNotFreeze=false）</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>client<span class="token punctuation">.</span>mOptRecord<span class="token punctuation">.</span><span class="token function">shouldNotFreeze</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// Propagate the shouldNotFreeze flag down the bindings.</span>
                    app<span class="token punctuation">.</span>mOptRecord<span class="token punctuation">.</span><span class="token function">setShouldNotFreeze</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="284_clientAdjprovideradjadj_1781"></a>28.4 clientAdj大于provider的adj才进行adj依赖关系调整</h4> 
<pre><code class="prism language-java">
                <span class="token comment">//新建adjType(adj类型)，初始值是null</span>
                <span class="token class-name">String</span> adjType <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

                <span class="token comment">//如果客户端的clientAdj小于provider的adj</span>
                <span class="token comment">//开始针对provider端的进程优先级adj进行依赖调整（主要依据是客户端clientAdj的情况）</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>adj <span class="token operator">&gt;</span> clientAdj<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//如果该进程有界面的，而且不是桌面，而且客户端clientAdj大于200，这类不调整adj大小，只设置adj类型</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span><span class="token function">hasShownUi</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>state<span class="token punctuation">.</span><span class="token function">getCachedIsHomeProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token operator">&amp;&amp;</span> clientAdj <span class="token operator">&gt;</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">PERCEPTIBLE_APP_ADJ</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//则将adj类型设置成"cch-ui-provider"(缓存的带有ui的provider)</span>
                        adjType <span class="token operator">=</span> <span class="token string">"cch-ui-provider"</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//其它情况，如当前进程没有带界面的、桌面、或者客户端clientAdj小于等于200(PERCEPTIBLE_APP_ADJ用户可感知级别)</span>
                        <span class="token comment">//clientAdj如果是大于0(FOREGROUND_APP_ADJ前台adj)，则直接将clientAdj赋值给provider端</span>
                        <span class="token comment">//clientAdj如果是小于等于0，则provider端的adj都会设置成0(FOREGROUND_APP_ADJ)</span>
                        <span class="token comment">//provider由于依赖关系最高优先级调整到0</span>
                        adj <span class="token operator">=</span> clientAdj <span class="token operator">&gt;</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">FOREGROUND_APP_ADJ</span>
                                <span class="token operator">?</span> clientAdj <span class="token operator">:</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">FOREGROUND_APP_ADJ</span><span class="token punctuation">;</span>
                        <span class="token comment">//将adj更新到mCurRawAdj中(mCurRawAdj一般是调整过程中最新的adj值)</span>
                        state<span class="token punctuation">.</span><span class="token function">setCurRawAdj</span><span class="token punctuation">(</span>adj<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//则将adj类型设置成"provider"</span>
                        adjType <span class="token operator">=</span> <span class="token string">"provider"</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">//只有客户端和provider都是cached的时候才设置当前进程为mCached = true，其它情况都是mCached = false</span>
                    state<span class="token punctuation">.</span><span class="token function">setCached</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span><span class="token function">isCached</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> cstate<span class="token punctuation">.</span><span class="token function">isCached</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="285_clientProcState_1814"></a>28.5 clientProcState进程状态依赖调整</h4> 
<pre><code class="prism language-java">
                <span class="token comment">//开始针对provider端的进程状态procState进行依赖调整（主要依据是客户端clientProcState的情况）</span>
                <span class="token comment">//只有进程状态clientProcState小于等于PROCESS_STATE_FOREGROUND_SERVICE(4)的时候才进来</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>clientProcState <span class="token operator">&lt;=</span> <span class="token constant">PROCESS_STATE_FOREGROUND_SERVICE</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//只有adj类型是空的时候才进行设置</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>adjType <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//只有adj类型设置成"provider"</span>
                        adjType <span class="token operator">=</span> <span class="token string">"provider"</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">//客户端的进程状态clientProcState如果是top app(2)</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>clientProcState <span class="token operator">==</span> <span class="token constant">PROCESS_STATE_TOP</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//重新约束clientProcState到PROCESS_STATE_BOUND_TOP(3)</span>
                        clientProcState <span class="token operator">=</span> <span class="token constant">PROCESS_STATE_BOUND_TOP</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//重新约束clientProcState到PROCESS_STATE_BOUND_FOREGROUND_SERVICE(5)，这个状态刚好是可以启动前台服务的状态</span>
                        clientProcState <span class="token operator">=</span> <span class="token constant">PROCESS_STATE_BOUND_FOREGROUND_SERVICE</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token comment">//调整之前，先保存关联关系记录的信息在AssociationState.SourceState中</span>
                <span class="token comment">//主要是进程状态，当前调整的序列号和调整时间</span>
                conn<span class="token punctuation">.</span><span class="token function">trackProcState</span><span class="token punctuation">(</span>clientProcState<span class="token punctuation">,</span> mAdjSeq<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//只有当前进程的进程状态procState大于约束后的客户端clientProcState的进程状态时</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>procState <span class="token operator">&gt;</span> clientProcState<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//才将约束后的客户端clientProcState赋值给当前进程的进程状态procState</span>
                    procState <span class="token operator">=</span> clientProcState<span class="token punctuation">;</span>
                    <span class="token comment">//setCurRawProcState将procState赋值给mCurRawProcState(最新的计算值，可能不是最终的值)</span>
                    state<span class="token punctuation">.</span><span class="token function">setCurRawProcState</span><span class="token punctuation">(</span>procState<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="286__1851"></a>28.6 客户端分组依赖关系调整</h4> 
<pre><code class="prism language-java">
                <span class="token comment">//如果客户端的分组大于当前进程的schedGroup(computeOomAdjLSP默认初始化之后最低是SCHED_GROUP_BACKGROUND(1))</span>
                <span class="token comment">//也就是客户端分组起码是SCHED_GROUP_DEFAULT(2)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cstate<span class="token punctuation">.</span><span class="token function">getCurrentSchedulingGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> schedGroup<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//设置当前分组schedGroup为SCHED_GROUP_DEFAULT</span>
                    schedGroup <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SCHED_GROUP_DEFAULT</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="287_provider_1863"></a>28.7 输出provider调整的原因</h4> 
<pre><code class="prism language-java">                <span class="token comment">//如果adj类型不为空，那么代表根据客户端，当前进程调整过adj或者进程状态procState</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>adjType <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//设置adj类型</span>
                    state<span class="token punctuation">.</span><span class="token function">setAdjType</span><span class="token punctuation">(</span>adjType<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//设置adj类型的代码mAdjTypeCode(和importanceReasonCode类似，就是优先级的原因)为provider正在使用中</span>
                    state<span class="token punctuation">.</span><span class="token function">setAdjTypeCode</span><span class="token punctuation">(</span><span class="token class-name">ActivityManager<span class="token punctuation">.</span>RunningAppProcessInfo</span>
                            <span class="token punctuation">.</span><span class="token constant">REASON_PROVIDER_IN_USE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//setAdjSource设置此次调整的来源：客户端ProcessRecord</span>
                    state<span class="token punctuation">.</span><span class="token function">setAdjSource</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//setAdjSourceProcState设置此次调整的进程状态来源：客户端约束后的clientProcState(不高于改值)</span>
                    state<span class="token punctuation">.</span><span class="token function">setAdjSourceProcState</span><span class="token punctuation">(</span>clientProcState<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//setAdjTarget设置调整的原因的provider组件是ComponentName name(ProviderInfo构建的组件名字)</span>
                    state<span class="token punctuation">.</span><span class="token function">setAdjTarget</span><span class="token punctuation">(</span>cpr<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//打印日志由于什么原因去调整该进程的adj或者进程状态</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_OOM_ADJ_REASON</span> <span class="token operator">||</span> logUid <span class="token operator">==</span> appUid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token function">reportOomAdjMessageLocked</span><span class="token punctuation">(</span><span class="token constant">TAG_OOM_ADJ</span><span class="token punctuation">,</span> <span class="token string">"Raise to "</span> <span class="token operator">+</span> adjType
                                <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> app <span class="token operator">+</span> <span class="token string">", due to "</span> <span class="token operator">+</span> client
                                <span class="token operator">+</span> <span class="token string">" adj="</span> <span class="token operator">+</span> adj <span class="token operator">+</span> <span class="token string">" procState="</span>
                                <span class="token operator">+</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token function">makeProcStateString</span><span class="token punctuation">(</span>procState<span class="token punctuation">)</span>
                                <span class="token operator">+</span> <span class="token string">", target="</span> <span class="token operator">+</span> cpr<span class="token punctuation">.</span>name <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="288_hasExternalProcessHandles_1891"></a>28.8 hasExternalProcessHandles的调整</h4> 
<pre><code class="prism language-java">            <span class="token comment">// If the provider has external (non-framework) process</span>
            <span class="token comment">// dependencies, ensure that its adjustment is at least</span>
            <span class="token comment">// FOREGROUND_APP_ADJ.</span>
            <span class="token comment">//cpr.hasExternalProcessHandles为true时，adj类型是"ext-provider"</span>
            <span class="token comment">//通过调用getContentProviderExternalUnchecked/getContentProviderExternal来设置hasExternalProcessHandles</span>
            <span class="token comment">//具体流程getContentProviderExternal-&gt;getContentProviderExternalUnchecked-&gt;getContentProviderImpl(caller == null)</span>
            <span class="token comment">//-&gt;incProviderCountLocked(r == null)-&gt;addExternalProcessHandleLocked-&gt;externalProcessTokenToHandle</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cpr<span class="token punctuation">.</span><span class="token function">hasExternalProcessHandles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//如果当前adj大于0前台，则设置成0</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>adj <span class="token operator">&gt;</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">FOREGROUND_APP_ADJ</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//adj设置成0(FOREGROUND_APP_ADJ),这种优先级比较高</span>
                    <span class="token comment">//一般用在cmd、uiautomator</span>
                    adj <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">FOREGROUND_APP_ADJ</span><span class="token punctuation">;</span>
                    <span class="token comment">//更新adj到mCurRawAdj中</span>
                    state<span class="token punctuation">.</span><span class="token function">setCurRawAdj</span><span class="token punctuation">(</span>adj<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//分组设置成默认</span>
                    schedGroup <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SCHED_GROUP_DEFAULT</span><span class="token punctuation">;</span>
                    <span class="token comment">//非cached进程</span>
                    state<span class="token punctuation">.</span><span class="token function">setCached</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//adj类型是"ext-provider"</span>
                    state<span class="token punctuation">.</span><span class="token function">setAdjType</span><span class="token punctuation">(</span><span class="token string">"ext-provider"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//setAdjTarget设置调整的原因的provider组件是ComponentName name(ProviderInfo构建的组件名字)</span>
                    state<span class="token punctuation">.</span><span class="token function">setAdjTarget</span><span class="token punctuation">(</span>cpr<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//打印日志，调整adj的原因是由于external provider</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_OOM_ADJ_REASON</span> <span class="token operator">||</span> logUid <span class="token operator">==</span> appUid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token function">reportOomAdjMessageLocked</span><span class="token punctuation">(</span><span class="token constant">TAG_OOM_ADJ</span><span class="token punctuation">,</span>
                                <span class="token string">"Raise adj to external provider: "</span> <span class="token operator">+</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//如果当前进程状态procState大于PROCESS_STATE_IMPORTANT_FOREGROUND(6)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>procState <span class="token operator">&gt;</span> <span class="token constant">PROCESS_STATE_IMPORTANT_FOREGROUND</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//则将进程状态procState设置成PROCESS_STATE_IMPORTANT_FOREGROUND(这个级别不能启动前台服务)</span>
                    procState <span class="token operator">=</span> <span class="token constant">PROCESS_STATE_IMPORTANT_FOREGROUND</span><span class="token punctuation">;</span>
                    <span class="token comment">//更新进程状态procState到mCurRawProcState</span>
                    state<span class="token punctuation">.</span><span class="token function">setCurRawProcState</span><span class="token punctuation">(</span>procState<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//打印日志，调整进程状态procState的原因是由于external provider</span>
                    <span class="token comment">//(这里adj和进程状态的调整都有输出日志，看起来比上面的adjType会更清晰一点，</span>
                    <span class="token comment">//如果需要修改类似日志，建议参考这里adj和procState单独输出)</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_OOM_ADJ_REASON</span> <span class="token operator">||</span> logUid <span class="token operator">==</span> appUid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token function">reportOomAdjMessageLocked</span><span class="token punctuation">(</span><span class="token constant">TAG_OOM_ADJ</span><span class="token punctuation">,</span>
                                <span class="token string">"Raise procstate to external provider: "</span> <span class="token operator">+</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="29_recentproviderprovider_1941"></a>29. recent-provider最近使用的provider调整</h3> 
<pre><code class="prism language-java">        <span class="token comment">//getLastProviderTime(mLastProviderTime)在removeContentProvider/decProviderCountLocked/handleProviderRemoval</span>
        <span class="token comment">//当客户端释放provider而且客户端进程状态比PROCESS_STATE_LAST_ACTIVITY(15)小，则会设置mLastProviderTime</span>
        <span class="token comment">//大概意思是provider上一次使用的时间，设置了这个时间的话provider会延迟一小会释放，</span>
        <span class="token comment">//一般只在比last activity重要的进程状态(客户端的)时设置</span>
        <span class="token comment">//CONTENT_PROVIDER_RETAIN_TIME是20s，上一次使用在20s以内会进来这里，避免低内存状态下频繁启动回收provider进程</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ppr<span class="token punctuation">.</span><span class="token function">getLastProviderTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span>
                <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ppr<span class="token punctuation">.</span><span class="token function">getLastProviderTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> mConstants<span class="token punctuation">.</span><span class="token constant">CONTENT_PROVIDER_RETAIN_TIME</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> now<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//如果adj大于700(PREVIOUS_APP_ADJ上一个应用)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>adj <span class="token operator">&gt;</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">PREVIOUS_APP_ADJ</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//则将adj设置成700(就是dumpsys meminfo里面的Previous应用)</span>
                adj <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">PREVIOUS_APP_ADJ</span><span class="token punctuation">;</span>
                <span class="token comment">//设置分组为后台，这里是后台，不是前台和default</span>
                schedGroup <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SCHED_GROUP_BACKGROUND</span><span class="token punctuation">;</span>
                <span class="token comment">//非cached进程</span>
                state<span class="token punctuation">.</span><span class="token function">setCached</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//adj类型是"recent-provider"最近使用的provider</span>
                state<span class="token punctuation">.</span><span class="token function">setAdjType</span><span class="token punctuation">(</span><span class="token string">"recent-provider"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//输出调整adj的原因</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_OOM_ADJ_REASON</span> <span class="token operator">||</span> logUid <span class="token operator">==</span> appUid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">reportOomAdjMessageLocked</span><span class="token punctuation">(</span><span class="token constant">TAG_OOM_ADJ</span><span class="token punctuation">,</span>
                            <span class="token string">"Raise adj to recent provider: "</span> <span class="token operator">+</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//进程状态procState如果大于PROCESS_STATE_LAST_ACTIVITY(15)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>procState <span class="token operator">&gt;</span> <span class="token constant">PROCESS_STATE_LAST_ACTIVITY</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//则将procState设置成PROCESS_STATE_LAST_ACTIVITY(15)</span>
                procState <span class="token operator">=</span> <span class="token constant">PROCESS_STATE_LAST_ACTIVITY</span><span class="token punctuation">;</span>
                <span class="token comment">//将adj类型设置成"recent-provider"，注意只要有adj或者procState的提升都会重新设置adj类型为"recent-provider"</span>
                state<span class="token punctuation">.</span><span class="token function">setAdjType</span><span class="token punctuation">(</span><span class="token string">"recent-provider"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//输出调整procstate的原因</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_OOM_ADJ_REASON</span> <span class="token operator">||</span> logUid <span class="token operator">==</span> appUid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">reportOomAdjMessageLocked</span><span class="token punctuation">(</span><span class="token constant">TAG_OOM_ADJ</span><span class="token punctuation">,</span>
                            <span class="token string">"Raise procstate to recent provider: "</span> <span class="token operator">+</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="30_CACHED_1982"></a>30. 服务相关缓存进程CACHED的调整</h3> 
<pre><code class="prism language-java">        <span class="token comment">//如果进程状态procState大于等于PROCESS_STATE_CACHED_EMPTY(19,这个优先级比较低)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>procState <span class="token operator">&gt;=</span> <span class="token constant">PROCESS_STATE_CACHED_EMPTY</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//看一下客户端是否有activity</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>psr<span class="token punctuation">.</span><span class="token function">hasClientActivities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// This is a cached process, but with client activities.  Mark it so.</span>
                <span class="token comment">//看一下客户端是否有activity，如果有，则稍微提升一下进程状态的级别到PROCESS_STATE_CACHED_ACTIVITY_CLIENT(17)</span>
                procState <span class="token operator">=</span> <span class="token constant">PROCESS_STATE_CACHED_ACTIVITY_CLIENT</span><span class="token punctuation">;</span>
                <span class="token comment">//设置adj类型是"cch-client-act"</span>
                state<span class="token punctuation">.</span><span class="token function">setAdjType</span><span class="token punctuation">(</span><span class="token string">"cch-client-act"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//服务端psr是ProcessServiceRecord进程的服务信息记录对象app.mServices</span>
            <span class="token comment">//如果设置了mTreatLikeActivity为true(setTreatLikeActivity设置)，则就像对待activity一样对待这个进程</span>
            <span class="token comment">//adj类型设置成"cch-as-act"(as "cch-act")</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>psr<span class="token punctuation">.</span><span class="token function">isTreatedLikeActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// This is a cached process, but somebody wants us to treat it like it has</span>
                <span class="token comment">// an activity, okay!</span>
                <span class="token comment">//也是稍微提升一下进程状态的级别到PROCESS_STATE_CACHED_ACTIVITY(16)</span>
                <span class="token comment">//注意这里的优先级(值越低优先级越高)比上面17还高，但是是放在else里面，貌似不太合理，一般都是优先级高的在前面，</span>
                <span class="token comment">//不然如果同时满足hasClientActivities和isTreatedLikeActivity，那么就只能设置成17，而不是16</span>
                procState <span class="token operator">=</span> <span class="token constant">PROCESS_STATE_CACHED_ACTIVITY</span><span class="token punctuation">;</span>
                <span class="token comment">//adj类型设置成"cch-as-act"(</span>
                state<span class="token punctuation">.</span><span class="token function">setAdjType</span><span class="token punctuation">(</span><span class="token string">"cch-as-act"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="31_AB_service_2010"></a>31. A、B service分布调整</h3> 
<pre><code class="prism language-java">        <span class="token comment">//如果adj是SERVICE_ADJ(500),具体可以看上面adj = ProcessList.SERVICE_ADJ;的逻辑</span>
        <span class="token comment">//只有上一次lastActivity服务启动或者bind时间是30分钟以内的才会设置成SERVICE_ADJ级别</span>
        <span class="token comment">//这段逻辑一直都没有变化，那么为啥Android O以前的版本那么多A、B services扎堆？现在S不见了</span>
        <span class="token comment">//其实不是这段逻辑有变化，而是google限制了后台进程启动服务的权限，没有启动服务的权限，那么服务就少了</span>
        <span class="token comment">//google针对后台乱象随着OS的升级逐渐砍，不够道高一尺魔高一丈，还是有很多办法绕过去的不是吗？</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>adj <span class="token operator">==</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SERVICE_ADJ</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//在doingAll为true，而且cycleReEval循环计算为false，代表需要更新A/B services</span>
            <span class="token comment">//目前满足这个条件的只有updateOomAdjInnerLSP中fullUpdate为true的时候进来时</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>doingAll <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>cycleReEval<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//如果mNewNumAServiceProcs(A services的个数，一会下面会设置)个数大于mNumServiceProcs(上一次fullUpdate后总的服务个数)/3</span>
                <span class="token comment">//则将mServiceB设置为true，代表这个是b services</span>
                <span class="token comment">//也就是1/3的服务会被设置成B services</span>
                <span class="token comment">//从这里也可以看到其实服务的优先级还跟mLruProcesses中进程的位置index有关系，这个后面另外的文章来写吧</span>
                state<span class="token punctuation">.</span><span class="token function">setServiceB</span><span class="token punctuation">(</span>mNewNumAServiceProcs <span class="token operator">&gt;</span> <span class="token punctuation">(</span>mNumServiceProcs <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//mNewNumServiceProcs(fullUpdate更新所有进程中service的个数，调整完成后，会更新到mNumServiceProcs中)</span>
                mNewNumServiceProcs<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token comment">//如果排在1/3之前的服务，也就是可能会调整成A services的进程</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>state<span class="token punctuation">.</span><span class="token function">isServiceB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// This service isn't far enough down on the LRU list to</span>
                    <span class="token comment">// normally be a B service, but if we are low on RAM and it</span>
                    <span class="token comment">// is large we want to force it down since we would prefer to</span>
                    <span class="token comment">// keep launcher over it.</span>
                    <span class="token comment">//isLastMemoryLevelNormal获取是内存压力级别，目前用的是psi，psi不太准确，下次有时间讲到AppProfiler时再来讲</span>
                    <span class="token comment">//mLastMemoryLevel只要不是(ADJ_MEM_FACTOR_NOTHING刚初始化，还没内存压力时；或者ADJ_MEM_FACTOR_NORMAL内存压力正常)</span>
                    <span class="token comment">//则isLastMemoryLevelNormal返回false，代表此时有内存压力</span>
                    <span class="token comment">//getLastPss获取的是AppProfiler中recordPssSampleLPf-&gt;setLastPss设置进去的mLastPss,</span>
                    <span class="token comment">//android本身有一个pss收集的进程在，</span>
                    <span class="token comment">//getCachedRestoreThresholdKb，如果是32bit是184320/3 = 60M, 64bit是322560/3=105M，具体逻辑在ProcessList.java中</span>
                    <span class="token comment">//也就是进程的mLastPss大于60M(32bit)/105M(64bit),</span>
                    <span class="token comment">//而且是有内存压力的时候会将这类服务标记成高内存用量，而且回落到B services</span>
<span class="token comment">/*
//ProcessList.java
    private final int[] mOomMinFreeLow = new int[] {
            12288, 18432, 24576,
            36864, 43008, 49152
    };

    private final int[] mOomMinFreeHigh = new int[] {
            73728, 92160, 110592,
            129024, 147456, 184320
    };
        for (int i = 0; i &lt; mOomAdj.length; i++) {
            int low = mOomMinFreeLow[i];//12288, 18432, 24576, 36864, 43008, 49152
            int high = mOomMinFreeHigh[i];//73728, 92160, 110592,129024, 147456, 184320
            if (is64bit) {
                // Increase the high min-free levels for cached processes for 64-bit
                if (i == 4) high = (high * 3) / 2;//221184
                else if (i == 5) high = (high * 7) / 4;//322560
            }
            mOomMinFree[i] = (int)(low + ((high - low) * scale));//high，目前S上由于RAM大于1G，scale都是1
        }

*/</span>
                    <span class="token comment">//mLastPss值的更新，一般在亮灭屏: 如果是内存状态有变小，是5分钟更新，没有变小是20分钟更新</span>
                    <span class="token comment">//其它场景如开机、更新全部的procStats(3个小时以上)时也会触发mLastPss的更新</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mService<span class="token punctuation">.</span>mAppProfiler<span class="token punctuation">.</span><span class="token function">isLastMemoryLevelNormal</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token operator">&amp;&amp;</span> app<span class="token punctuation">.</span>mProfile<span class="token punctuation">.</span><span class="token function">getLastPss</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token operator">&gt;=</span> mProcessList<span class="token punctuation">.</span><span class="token function">getCachedRestoreThresholdKb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//设置该服务为高内存用量的服务，mServiceHighRam=true，isServiceHighRam提供给外部用，</span>
                        <span class="token comment">//不够目前S都没有用到，Android这里也有另一个缺陷(高内存用量的进程没有单独划分出来)，</span>
                        <span class="token comment">//这个功能其实挺好的，不过竟然没有大批量用起来！</span>
                        state<span class="token punctuation">.</span><span class="token function">setServiceHighRam</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//回落到B service级别</span>
                        state<span class="token punctuation">.</span><span class="token function">setServiceB</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//这个注释其实没有必要注掉，可以用DEBUG_PSS、DEBUG_OOM_ADJ_REASON都是可以的</span>
                        <span class="token comment">//Slog.i(TAG, "ADJ " + app + " high ram!");</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//回落到B service级别</span>
                        mNewNumAServiceProcs<span class="token operator">++</span><span class="token punctuation">;</span>
                        <span class="token comment">//Slog.i(TAG, "ADJ " + app + " not high ram!");</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//其它情况下(b services)都认为不是高内存的服务(这个逻辑不敢恭维，牛头不对马尾)</span>
                    state<span class="token punctuation">.</span><span class="token function">setServiceHighRam</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//如果是b services的话</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span><span class="token function">isServiceB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//则将adj设置成SERVICE_B_ADJ(800)</span>
                adj <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SERVICE_B_ADJ</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="32_adjmCurRawAdj_2097"></a>32. 更新最新的adj到mCurRawAdj中</h3> 
<pre><code class="prism language-java">        <span class="token comment">//更新最新的adj到mCurRawAdj中</span>
        state<span class="token punctuation">.</span><span class="token function">setCurRawAdj</span><span class="token punctuation">(</span>adj<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="33_getMaxAdj_2104"></a>33. 如果还有未处理完的getMaxAdj进程的调整</h3> 
<pre><code class="prism language-java">        <span class="token comment">//如果当前adj大于setMaxAdj中设置的值(除了测试用例才会进来，Android S这段代码专门为测试用例留的？)</span>
        <span class="token comment">//注意了这里是没有调用setCurRawAdj更新mCurRawAdj，故进入这里的话mCurRawAdj可能不是最新调整的状态，看起来属于一个漏洞？</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>adj <span class="token operator">&gt;</span> state<span class="token punctuation">.</span><span class="token function">getMaxAdj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//adj则更新成setMaxAdj中设置的值</span>
            adj <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">getMaxAdj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//如果adj小于等于250(PERCEPTIBLE_LOW_APP_ADJ用户可感知的最低级别)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>adj <span class="token operator">&lt;=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">PERCEPTIBLE_LOW_APP_ADJ</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//则分组cgroup更新成默认分组</span>
                schedGroup <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SCHED_GROUP_DEFAULT</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="34_SCHED_GROUP_RESTRICTED_2120"></a>34. 非唤醒状态时受限制分组SCHED_GROUP_RESTRICTED调整</h3> 
<pre><code class="prism language-java">        <span class="token comment">// Put bound foreground services in a special sched group for additional</span>
        <span class="token comment">// restrictions on screen off</span>
        <span class="token comment">//如果进程状态procState大于等于PROCESS_STATE_BOUND_FOREGROUND_SERVICE(5)</span>
        <span class="token comment">//而且在灭屏状态，而且scheduleLikeTopApp(设定像对待前台一样对待该app，类似IMEs有界面时)是false</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>procState <span class="token operator">&gt;=</span> <span class="token constant">PROCESS_STATE_BOUND_FOREGROUND_SERVICE</span>
                <span class="token operator">&amp;&amp;</span> mService<span class="token punctuation">.</span>mWakefulness<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">PowerManagerInternal</span><span class="token punctuation">.</span><span class="token constant">WAKEFULNESS_AWAKE</span>
                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>scheduleLikeTopApp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//分组cgroup状态大于SCHED_GROUP_RESTRICTED(1)，那就是default、top的时候</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>schedGroup <span class="token operator">&gt;</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SCHED_GROUP_RESTRICTED</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//设置他们的分组状态都是SCHED_GROUP_RESTRICTED受限制分组</span>
                schedGroup <span class="token operator">=</span> <span class="token class-name">ProcessList</span><span class="token punctuation">.</span><span class="token constant">SCHED_GROUP_RESTRICTED</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="35_capability_2138"></a>35. 更新进程的能力capability</h3> 
<pre><code class="prism language-java">        <span class="token comment">// apply capability from FGS.</span>
        <span class="token comment">//如果有前台服务(ContextImpl启动前台服务或者service启动时设置服务是前台的)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>psr<span class="token punctuation">.</span><span class="token function">hasForegroundServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//则将当前进程的能力capability设置成前台服务的能力capabilityFromFGS(具体请查看之前的介绍)</span>
            capability <span class="token operator">|=</span> capabilityFromFGS<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//通过进程的服务记录psr和进程状态procState得到默认的能力</span>
        capability <span class="token operator">|=</span> <span class="token function">getDefaultCapability</span><span class="token punctuation">(</span>psr<span class="token punctuation">,</span> procState<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="36_ProcessStateRecordadj_2152"></a>36. 更新最新的状态到ProcessStateRecord，完成本次adj调整</h3> 
<pre><code class="prism language-java">        <span class="token comment">// Do final modification to adj.  Everything we do between here and applying</span>
        <span class="token comment">// the final setAdj must be done in this function, because we will also use</span>
        <span class="token comment">// it when computing the final cached adj later.  Note that we don't need to</span>
        <span class="token comment">// worry about this for max adj above, since max adj will always be used to</span>
        <span class="token comment">// keep it out of the cached vaues.</span>
        <span class="token comment">//本次adj调整即将完成，将计算的adj复制给mCurAdj</span>
        state<span class="token punctuation">.</span><span class="token function">setCurAdj</span><span class="token punctuation">(</span>psr<span class="token punctuation">.</span><span class="token function">modifyRawOomAdj</span><span class="token punctuation">(</span>adj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//本次adj调整即将完成，将计算的能力capability复制给mCurCapability</span>
        state<span class="token punctuation">.</span><span class="token function">setCurCapability</span><span class="token punctuation">(</span>capability<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//本次adj调整即将完成，将计算的分组信息schedGroup复制给mCurSchedGroup</span>
        state<span class="token punctuation">.</span><span class="token function">setCurrentSchedulingGroup</span><span class="token punctuation">(</span>schedGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//本次adj调整即将完成，将计算的进程状态procState复制给mCurProcState</span>
        state<span class="token punctuation">.</span><span class="token function">setCurProcState</span><span class="token punctuation">(</span>procState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//本次adj调整即将完成，将计算的进程状态procState复制给mCurRawProcState</span>
        state<span class="token punctuation">.</span><span class="token function">setCurRawProcState</span><span class="token punctuation">(</span>procState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//通过hasVisibleActivities更新mLastInvisibleTime，如果mHasVisibleActivities从true变成false，</span>
        <span class="token comment">//则记录这个时候的时间，相当于当进程从可见到不可见的时间</span>
        <span class="token comment">//主要用在是否允许启动前台服务里面，这个时间目前是mFgToBgFgsGraceDuration(5秒钟以内还是允许的)</span>
        state<span class="token punctuation">.</span><span class="token function">updateLastInvisibleTime</span><span class="token punctuation">(</span>hasVisibleActivities<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//更新mHasForegroundActivities是否拥有前台activity</span>
        state<span class="token punctuation">.</span><span class="token function">setHasForegroundActivities</span><span class="token punctuation">(</span>foregroundActivities<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置mCompletedAdjSeq(当前进程完成adj调整的系列号) = mAdjSeq(当前调整的adj系列号)</span>
        state<span class="token punctuation">.</span><span class="token function">setCompletedAdjSeq</span><span class="token punctuation">(</span>mAdjSeq<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="37_adj_2180"></a>37. 本次adj调整的返回值</h3> 
<pre><code class="prism language-java">        <span class="token comment">// 如果当前的adj(mCurAdj)有相对于之前优先级有提升</span>
        <span class="token comment">// 或者当前的进程状态mCurProcState有相对于之前优先级有提升</span>
        <span class="token comment">// 或者当前进程的能力mCurCapability有相对于之前有改变</span>
        <span class="token comment">// 则返回true，否则返回false</span>
        <span class="token comment">// if curAdj or curProcState improved, then this process was promoted</span>
        <span class="token keyword">return</span> state<span class="token punctuation">.</span><span class="token function">getCurAdj</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> prevAppAdj <span class="token operator">||</span> state<span class="token punctuation">.</span><span class="token function">getCurProcState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> prevProcState
                <span class="token operator">||</span> state<span class="token punctuation">.</span><span class="token function">getCurCapability</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> prevCapability<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="38__2193"></a>38. 其它相关代码</h3> 
<h4><a id="381__2196"></a>38.1 获取默认的进程能力</h4> 
<pre><code class="prism language-java">    <span class="token comment">//通过进程的服务记录psr和进程状态procState得到默认的能力</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">getDefaultCapability</span><span class="token punctuation">(</span><span class="token class-name">ProcessServiceRecord</span> psr<span class="token punctuation">,</span> <span class="token keyword">int</span> procState<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>procState<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> <span class="token constant">PROCESS_STATE_PERSISTENT</span><span class="token operator">:</span>
            <span class="token keyword">case</span> <span class="token constant">PROCESS_STATE_PERSISTENT_UI</span><span class="token operator">:</span>
            <span class="token keyword">case</span> <span class="token constant">PROCESS_STATE_TOP</span><span class="token operator">:</span>
                <span class="token comment">//如果是top app或者是常驻进程的进程会有所有的能力</span>
                <span class="token comment">//包括定位、camera、电话、听筒的能力</span>
<span class="token comment">/*
    public static final int PROCESS_CAPABILITY_ALL = PROCESS_CAPABILITY_FOREGROUND_LOCATION
            | PROCESS_CAPABILITY_FOREGROUND_CAMERA
            | PROCESS_CAPABILITY_FOREGROUND_MICROPHONE
            | PROCESS_CAPABILITY_NETWORK;
*/</span>
                <span class="token keyword">return</span> <span class="token constant">PROCESS_CAPABILITY_ALL</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">PROCESS_STATE_BOUND_TOP</span><span class="token operator">:</span>
                <span class="token comment">//如果当前进程是service、provider，被前台(client)绑定的话，则当前进程拥有网络能力</span>
                <span class="token keyword">return</span> <span class="token constant">PROCESS_CAPABILITY_NETWORK</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">PROCESS_STATE_FOREGROUND_SERVICE</span><span class="token operator">:</span>
                <span class="token comment">//当前进程的进程状态是PROCESS_STATE_FOREGROUND_SERVICE(4)前台服务级别(instrumentation/hasForegroundServices)</span>
                <span class="token comment">//如果带有是前台服务(hasForegroundServices == true)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>psr<span class="token punctuation">.</span><span class="token function">hasForegroundServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// Capability from FGS are conditional depending on foreground service type in</span>
                    <span class="token comment">// manifest file and the mAllowWhileInUsePermissionInFgs flag.</span>
                    <span class="token comment">// 则拥有网络能力</span>
                    <span class="token keyword">return</span> <span class="token constant">PROCESS_CAPABILITY_NETWORK</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//其它情况，如instrumentation</span>
                    <span class="token comment">//还有service、provider依赖关系貌似不会直接设置PROCESS_STATE_FOREGROUND_SERVICE</span>
                    <span class="token comment">//拥有camera、听筒、网络能力</span>
<span class="token comment">/*
    public static final int PROCESS_CAPABILITY_ALL_IMPLICIT = PROCESS_CAPABILITY_FOREGROUND_CAMERA
            | PROCESS_CAPABILITY_FOREGROUND_MICROPHONE;
*/</span>
                    <span class="token comment">// process has no FGS, the PROCESS_STATE_FOREGROUND_SERVICE is from client.</span>
                    <span class="token comment">// the implicit capability could be removed in the future, client should use</span>
                    <span class="token comment">// BIND_INCLUDE_CAPABILITY flag.</span>
                    <span class="token keyword">return</span> <span class="token constant">PROCESS_CAPABILITY_ALL_IMPLICIT</span> <span class="token operator">|</span> <span class="token constant">PROCESS_CAPABILITY_NETWORK</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token keyword">case</span> <span class="token constant">PROCESS_STATE_BOUND_FOREGROUND_SERVICE</span><span class="token operator">:</span>
                <span class="token comment">//当前进程的进程状态是PROCESS_STATE_BOUND_FOREGROUND_SERVICE(5)绑定前台服务</span>
                <span class="token comment">//则拥有网络能力</span>
                <span class="token keyword">return</span> <span class="token constant">PROCESS_CAPABILITY_NETWORK</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token comment">//其它情况不赋予相关能力</span>
                <span class="token keyword">return</span> <span class="token constant">PROCESS_CAPABILITY_NONE</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="381_shouldSkipDueToCycle_2250"></a>38.1 shouldSkipDueToCycle是否需要在计算依赖关系时跳过计算</h4> 
<pre><code class="prism language-java">    <span class="token comment">//app: 当前需要调整的进程</span>
    <span class="token comment">//client: 客户端的进程状态记录</span>
    <span class="token comment">//procState: 当前进程的进程状态</span>
    <span class="token comment">//adj: 当前进程的adj值</span>
    <span class="token comment">//cycleReEval: 是否处于循环计算模式，只有在updateOomAdjInnerLSP会让cycleReEval=true</span>
    <span class="token comment">//(条件是设置了setContainsCycle true，如正在计算computeOomAdjLSP的时候还没计算完又跑进来)</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">shouldSkipDueToCycle</span><span class="token punctuation">(</span><span class="token class-name">ProcessRecord</span> app<span class="token punctuation">,</span> <span class="token class-name">ProcessStateRecord</span> client<span class="token punctuation">,</span>
            <span class="token keyword">int</span> procState<span class="token punctuation">,</span> <span class="token keyword">int</span> adj<span class="token punctuation">,</span> <span class="token keyword">boolean</span> cycleReEval<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//如果客户端设置了setContainsCycle = true，也即是客户端未调整完毕又进入了computeOomAdjLSP</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">containsCycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// We've detected a cycle. We should retry computeOomAdjLSP later in</span>
            <span class="token comment">// case a later-checked connection from a client  would raise its</span>
            <span class="token comment">// priority legitimately.</span>
            <span class="token comment">//这里计算依赖关系的时候，将当前的进程app，设置成包括循环，需要在后面重新计算</span>
            app<span class="token punctuation">.</span>mState<span class="token punctuation">.</span><span class="token function">setContainsCycle</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//同时将该进程放入循环计算的list里面mProcessesInCycle，后面如果需要重新计算该进程adj的时候会从此处取回</span>
            mProcessesInCycle<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// If the client has not been completely evaluated, check if it's worth</span>
            <span class="token comment">// using the partial values.</span>
            <span class="token comment">//客户端已经完成的adj调整序列号mCompletedAdjSeq，小于mAdjSeq，代表是之前的调整，本次还未更新</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">getCompletedAdjSeq</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> mAdjSeq<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//如果是循环计算进来此处</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cycleReEval<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// If the partial values are no better, skip until the next</span>
                    <span class="token comment">// attempt</span>
                    <span class="token comment">//如果客户端的进程状态大于当前app进程的进程状态</span>
                    <span class="token comment">//而且客户端的mCurRawAdj(当前调整的未约束过的adj)，大于当前进程的adj</span>
                    <span class="token comment">//代表客户端的优先级比较低，需要等客户端计算完成再来，所以本次依赖关系计算先跳过</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">getCurRawProcState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> procState
                            <span class="token operator">&amp;&amp;</span> client<span class="token punctuation">.</span><span class="token function">getCurRawAdj</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> adj<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// Else use the client's partial procstate and adj to adjust the</span>
                    <span class="token comment">// effect of the binding</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//如果是非循环计算进来此处，由于客户端还没有计算完成，那就等客户端计算完成，先跳过</span>
                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c1441a4ce6be211dbdcf6339771d2f5a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">vue-组件生命周期&#43;网络请求</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e61dbbc3cd2f4b0720c116e6c42e07ac/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Flex布局实战</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>