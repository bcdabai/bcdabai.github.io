<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>perf进阶-event实践 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="perf进阶-event实践" />
<meta property="og:description" content="perf进阶event实践 先导 perf list可以看当前软硬件环境支持的性能事件，由于性能事件过多，当程序运行异常或耗时过长时，往往不清楚查找哪一种事件。下面给出一种选择性能事件的方案：
perf list List of pre-defined events (to be used in -e): branch-misses [Hardware event] bus-cycles [Hardware event] cache-misses [Hardware event] cache-references [Hardware event] cpu-cycles OR cycles [Hardware event] instructions [Hardware event] stalled-cycles-backend OR idle-cycles-backend [Hardware event] stalled-cycles-frontend OR idle-cycles-frontend [Hardware event] alignment-faults [Software event] bpf-output [Software event] context-switches OR cs [Software event] cpu-clock [Software event] cpu-migrations OR migrations [Software event] dummy [Software event] emulation-faults [Software event] major-faults [Software event] minor-faults [Software event] page-faults OR faults [Software event] task-clock [Software event] duration_time [Tool event] L1-dcache-load-misses [Hardware cache event] 示例程序 #include&lt;iostream&gt; #include&lt;cmath&gt; #include&lt;vector&gt; #include&lt;cstdlib&gt; #include&lt;omp." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/52c61dfea61d574e780895a28223055f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-12T22:14:09+08:00" />
<meta property="article:modified_time" content="2022-07-12T22:14:09+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">perf进阶-event实践</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="perfevent_0"></a>perf进阶event实践</h3> 
<h3><a id="_1"></a>先导</h3> 
<p>perf list可以看当前软硬件环境支持的性能事件，由于性能事件过多，当程序运行异常或耗时过长时，往往不清楚查找哪一种事件。下面给出一种选择性能事件的方案：</p> 
<pre><code class="prism language-bash">perf list
List of pre-defined events <span class="token punctuation">(</span>to be used <span class="token keyword">in</span> -e<span class="token punctuation">)</span>:

  branch-misses                                      <span class="token punctuation">[</span>Hardware event<span class="token punctuation">]</span>
  bus-cycles                                         <span class="token punctuation">[</span>Hardware event<span class="token punctuation">]</span>
  cache-misses                                       <span class="token punctuation">[</span>Hardware event<span class="token punctuation">]</span>
  cache-references                                   <span class="token punctuation">[</span>Hardware event<span class="token punctuation">]</span>
  cpu-cycles OR cycles                               <span class="token punctuation">[</span>Hardware event<span class="token punctuation">]</span>
  instructions                                       <span class="token punctuation">[</span>Hardware event<span class="token punctuation">]</span>
  stalled-cycles-backend OR idle-cycles-backend      <span class="token punctuation">[</span>Hardware event<span class="token punctuation">]</span>
  stalled-cycles-frontend OR idle-cycles-frontend    <span class="token punctuation">[</span>Hardware event<span class="token punctuation">]</span>

  alignment-faults                                   <span class="token punctuation">[</span>Software event<span class="token punctuation">]</span>
  bpf-output                                         <span class="token punctuation">[</span>Software event<span class="token punctuation">]</span>
  context-switches OR cs                             <span class="token punctuation">[</span>Software event<span class="token punctuation">]</span>
  cpu-clock                                          <span class="token punctuation">[</span>Software event<span class="token punctuation">]</span>
  cpu-migrations OR migrations                       <span class="token punctuation">[</span>Software event<span class="token punctuation">]</span>
  dummy                                              <span class="token punctuation">[</span>Software event<span class="token punctuation">]</span>
  emulation-faults                                   <span class="token punctuation">[</span>Software event<span class="token punctuation">]</span>
  major-faults                                       <span class="token punctuation">[</span>Software event<span class="token punctuation">]</span>
  minor-faults                                       <span class="token punctuation">[</span>Software event<span class="token punctuation">]</span>
  page-faults OR faults                              <span class="token punctuation">[</span>Software event<span class="token punctuation">]</span>
  task-clock                                         <span class="token punctuation">[</span>Software event<span class="token punctuation">]</span>

  duration_time                                      <span class="token punctuation">[</span>Tool event<span class="token punctuation">]</span>

  L1-dcache-load-misses                              <span class="token punctuation">[</span>Hardware cache event<span class="token punctuation">]</span>
</code></pre> 
<h3><a id="_33"></a>示例程序</h3> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;cmath&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;vector&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;cstdlib&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;omp.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">calcu</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        sum <span class="token operator">+=</span> <span class="token function">sin</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span> RAND_MAX<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> sum<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span> seed <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token function">res</span><span class="token punctuation">(</span><span class="token number">800</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">srand</span><span class="token punctuation">(</span>seed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">timeval</span> t1<span class="token punctuation">,</span>t2<span class="token punctuation">;</span>
    <span class="token keyword">double</span> timeuse<span class="token punctuation">;</span>
    <span class="token function">gettimeofday</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">omp parallel <span class="token keyword">for</span> <span class="token function">schedule</span><span class="token punctuation">(</span>dynamic<span class="token punctuation">)</span></span></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> jobid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> jobid <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> jobid<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            res<span class="token punctuation">[</span>jobid <span class="token operator">*</span> <span class="token number">100</span> <span class="token operator">+</span> i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">calcu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">gettimeofday</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    timeuse <span class="token operator">=</span> <span class="token punctuation">(</span>t2<span class="token punctuation">.</span>tv_sec <span class="token operator">-</span> t1<span class="token punctuation">.</span>tv_sec<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token punctuation">(</span>t2<span class="token punctuation">.</span>tv_usec <span class="token operator">-</span> t1<span class="token punctuation">.</span>tv_usec<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1000000.0</span><span class="token punctuation">;</span>
    cout<span class="token operator">&lt;&lt;</span><span class="token string">"time = "</span><span class="token operator">&lt;&lt;</span>timeuse<span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>编译运行</p> 
<pre><code class="prism language-bash">g++ -fopenmp main.cpp -o m -lm
numactl -C <span class="token number">0</span>-7 ./m
</code></pre> 
<h3><a id="top_78"></a>top查看异常</h3> 
<pre><code class="prism language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> <span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># top</span>
<span class="token function">top</span> - 09:39:57 up <span class="token number">88</span> days,  <span class="token number">5</span>:33,  <span class="token number">3</span> users,  load average: <span class="token number">2.74</span>, <span class="token number">1.13</span>, <span class="token number">0.95</span>
Tasks: <span class="token number">973</span> total,   <span class="token number">2</span> running, <span class="token number">489</span> sleeping,   <span class="token number">2</span> stopped,   <span class="token number">0</span> zombie
%Node0 <span class="token builtin class-name">:</span>  <span class="token number">6.3</span> us, <span class="token number">24.2</span> sy,  <span class="token number">0.0</span> ni, <span class="token number">69.5</span> id,  <span class="token number">0.0</span> wa,  <span class="token number">0.0</span> hi,  <span class="token number">0.0</span> si,  <span class="token number">0.0</span> st
%Cpu0  <span class="token builtin class-name">:</span> <span class="token number">18.1</span> us, <span class="token number">75.3</span> sy,  <span class="token number">0.0</span> ni,  <span class="token number">6.6</span> id,  <span class="token number">0.0</span> wa,  <span class="token number">0.0</span> hi,  <span class="token number">0.0</span> si,  <span class="token number">0.0</span> st
%Cpu1  <span class="token builtin class-name">:</span> <span class="token number">16.3</span> us, <span class="token number">77.0</span> sy,  <span class="token number">0.0</span> ni,  <span class="token number">6.7</span> id,  <span class="token number">0.0</span> wa,  <span class="token number">0.0</span> hi,  <span class="token number">0.0</span> si,  <span class="token number">0.0</span> st
%Cpu2  <span class="token builtin class-name">:</span> <span class="token number">19.2</span> us, <span class="token number">74.0</span> sy,  <span class="token number">0.0</span> ni,  <span class="token number">6.8</span> id,  <span class="token number">0.0</span> wa,  <span class="token number">0.0</span> hi,  <span class="token number">0.0</span> si,  <span class="token number">0.0</span> st
%Cpu3  <span class="token builtin class-name">:</span> <span class="token number">22.5</span> us, <span class="token number">70.8</span> sy,  <span class="token number">0.0</span> ni,  <span class="token number">6.7</span> id,  <span class="token number">0.0</span> wa,  <span class="token number">0.0</span> hi,  <span class="token number">0.0</span> si,  <span class="token number">0.0</span> st
%Cpu4  <span class="token builtin class-name">:</span> <span class="token number">20.8</span> us, <span class="token number">72.3</span> sy,  <span class="token number">0.0</span> ni,  <span class="token number">6.9</span> id,  <span class="token number">0.0</span> wa,  <span class="token number">0.0</span> hi,  <span class="token number">0.0</span> si,  <span class="token number">0.0</span> st
%Cpu5  <span class="token builtin class-name">:</span> <span class="token number">19.1</span> us, <span class="token number">74.6</span> sy,  <span class="token number">0.0</span> ni,  <span class="token number">6.4</span> id,  <span class="token number">0.0</span> wa,  <span class="token number">0.0</span> hi,  <span class="token number">0.0</span> si,  <span class="token number">0.0</span> st
%Cpu6  <span class="token builtin class-name">:</span> <span class="token number">20.9</span> us, <span class="token number">72.7</span> sy,  <span class="token number">0.0</span> ni,  <span class="token number">6.4</span> id,  <span class="token number">0.0</span> wa,  <span class="token number">0.0</span> hi,  <span class="token number">0.0</span> si,  <span class="token number">0.0</span> st
%Cpu7  <span class="token builtin class-name">:</span> <span class="token number">18.4</span> us, <span class="token number">74.9</span> sy,  <span class="token number">0.0</span> ni,  <span class="token number">6.7</span> id,  <span class="token number">0.0</span> wa,  <span class="token number">0.0</span> hi,  <span class="token number">0.0</span> si,  <span class="token number">0.0</span> st
</code></pre> 
<p>top中us表示用户态耗时，sy表示内核空间耗时，可以看到内核态sy耗时占比过高，但内核态可能是io事件，缺页事件，线程切换事件等等，</p> 
<h3><a id="vmstat_95"></a>vmstat查看具体异常</h3> 
<pre><code class="prism language-bash"><span class="token function">vmstat</span> <span class="token number">1</span>
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   <span class="token function">free</span>   buff  cache   si   so    bi    bo   <span class="token keyword">in</span>   cs us sy <span class="token function">id</span> wa st
 <span class="token number">0</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039850624</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span>  <span class="token number">159</span>  <span class="token number">155</span>  <span class="token number">0</span>  <span class="token number">0</span> <span class="token number">100</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">0</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039850624</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span>  <span class="token number">155</span>  <span class="token number">142</span>  <span class="token number">0</span>  <span class="token number">0</span> <span class="token number">100</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">0</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039850624</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span>  <span class="token number">206</span>  <span class="token number">276</span>  <span class="token number">0</span>  <span class="token number">0</span> <span class="token number">100</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">0</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039850624</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span>  <span class="token number">142</span>  <span class="token number">168</span>  <span class="token number">0</span>  <span class="token number">0</span> <span class="token number">100</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">0</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039850624</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span>   <span class="token number">99</span>   <span class="token number">98</span>  <span class="token number">0</span>  <span class="token number">0</span> <span class="token number">100</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">0</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039850624</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span>  <span class="token number">117</span>  <span class="token number">112</span>  <span class="token number">0</span>  <span class="token number">0</span> <span class="token number">100</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">0</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039850624</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span>  <span class="token number">197</span>  <span class="token number">258</span>  <span class="token number">0</span>  <span class="token number">0</span> <span class="token number">100</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">0</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039850624</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span>  <span class="token number">111</span>  <span class="token number">139</span>  <span class="token number">0</span>  <span class="token number">0</span> <span class="token number">100</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">0</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039850624</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span>  <span class="token number">114</span>  <span class="token number">108</span>  <span class="token number">0</span>  <span class="token number">0</span> <span class="token number">100</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">0</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039850624</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span>  <span class="token number">106</span>  <span class="token number">106</span>  <span class="token number">0</span>  <span class="token number">0</span> <span class="token number">100</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">0</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039850624</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span>  <span class="token number">167</span>  <span class="token number">227</span>  <span class="token number">0</span>  <span class="token number">0</span> <span class="token number">100</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">0</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039850624</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span>  <span class="token number">146</span>  <span class="token number">168</span>  <span class="token number">0</span>  <span class="token number">0</span> <span class="token number">100</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">0</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039850624</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span>  <span class="token number">149</span>  <span class="token number">150</span>  <span class="token number">0</span>  <span class="token number">0</span> <span class="token number">100</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">0</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039850624</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span>  <span class="token number">128</span>  <span class="token number">124</span>  <span class="token number">0</span>  <span class="token number">0</span> <span class="token number">100</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">0</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039850624</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span>  <span class="token number">198</span>  <span class="token number">261</span>  <span class="token number">0</span>  <span class="token number">0</span> <span class="token number">100</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">0</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039850624</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span>  <span class="token number">175</span>  <span class="token number">186</span>  <span class="token number">0</span>  <span class="token number">0</span> <span class="token number">100</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">0</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039850624</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span>   <span class="token number">98</span>   <span class="token number">98</span>  <span class="token number">0</span>  <span class="token number">0</span> <span class="token number">100</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token comment">#此处运行实例程序</span>
 <span class="token number">8</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039847616</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span> <span class="token number">263186</span> <span class="token number">524562</span>  <span class="token number">1</span>  <span class="token number">6</span> <span class="token number">92</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">8</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039847616</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span> <span class="token number">263039</span> <span class="token number">524333</span>  <span class="token number">1</span>  <span class="token number">6</span> <span class="token number">92</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">8</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039847616</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span> <span class="token number">263137</span> <span class="token number">524484</span>  <span class="token number">2</span>  <span class="token number">6</span> <span class="token number">92</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">8</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039847808</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span> <span class="token number">263492</span> <span class="token number">525213</span>  <span class="token number">1</span>  <span class="token number">6</span> <span class="token number">92</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">8</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039847808</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span> <span class="token number">263466</span> <span class="token number">525086</span>  <span class="token number">2</span>  <span class="token number">6</span> <span class="token number">92</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">8</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039847808</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span> <span class="token number">263313</span> <span class="token number">524761</span>  <span class="token number">2</span>  <span class="token number">6</span> <span class="token number">92</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">7</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039847808</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span> <span class="token number">263365</span> <span class="token number">524910</span>  <span class="token number">1</span>  <span class="token number">7</span> <span class="token number">92</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">8</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039847808</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span> <span class="token number">263534</span> <span class="token number">525192</span>  <span class="token number">1</span>  <span class="token number">6</span> <span class="token number">92</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">8</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039847808</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span> <span class="token number">264147</span> <span class="token number">526475</span>  <span class="token number">1</span>  <span class="token number">6</span> <span class="token number">92</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">8</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039847808</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span> <span class="token number">263072</span> <span class="token number">524299</span>  <span class="token number">1</span>  <span class="token number">6</span> <span class="token number">92</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">8</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039847808</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span> <span class="token number">263856</span> <span class="token number">525886</span>  <span class="token number">1</span>  <span class="token number">6</span> <span class="token number">92</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">7</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039847808</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span> <span class="token number">263943</span> <span class="token number">526185</span>  <span class="token number">2</span>  <span class="token number">6</span> <span class="token number">92</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">8</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039847808</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span> <span class="token number">263606</span> <span class="token number">525400</span>  <span class="token number">1</span>  <span class="token number">6</span> <span class="token number">92</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">7</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039847808</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span> <span class="token number">263725</span> <span class="token number">525615</span>  <span class="token number">1</span>  <span class="token number">6</span> <span class="token number">92</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">8</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039847808</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span> <span class="token number">263397</span> <span class="token number">524954</span>  <span class="token number">1</span>  <span class="token number">6</span> <span class="token number">92</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">8</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039847808</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span> <span class="token number">263737</span> <span class="token number">525656</span>  <span class="token number">1</span>  <span class="token number">6</span> <span class="token number">92</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">8</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039847808</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span> <span class="token number">263283</span> <span class="token number">524787</span>  <span class="token number">1</span>  <span class="token number">6</span> <span class="token number">92</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">8</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039847616</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span> <span class="token number">264191</span> <span class="token number">526448</span>  <span class="token number">1</span>  <span class="token number">7</span> <span class="token number">92</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">8</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039847616</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span> <span class="token number">263084</span> <span class="token number">524249</span>  <span class="token number">1</span>  <span class="token number">6</span> <span class="token number">92</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">6</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039847616</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span> <span class="token number">264028</span> <span class="token number">526191</span>  <span class="token number">1</span>  <span class="token number">7</span> <span class="token number">92</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">8</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039847616</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span> <span class="token number">263550</span> <span class="token number">525169</span>  <span class="token number">1</span>  <span class="token number">6</span> <span class="token number">92</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">7</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039847808</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>    <span class="token number">17</span> <span class="token number">263382</span> <span class="token number">524900</span>  <span class="token number">1</span>  <span class="token number">6</span> <span class="token number">92</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">8</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039847808</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span> <span class="token number">263891</span> <span class="token number">525919</span>  <span class="token number">1</span>  <span class="token number">6</span> <span class="token number">92</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">7</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039847808</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span> <span class="token number">264202</span> <span class="token number">526549</span>  <span class="token number">2</span>  <span class="token number">6</span> <span class="token number">92</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">8</span>  <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">1039847808</span>   <span class="token number">8000</span> <span class="token number">27598912</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span> <span class="token number">264129</span> <span class="token number">526399</span>  <span class="token number">2</span>  <span class="token number">6</span> <span class="token number">92</span>  <span class="token number">0</span>  <span class="token number">0</span>
</code></pre> 
<p>其中in与cs与运行前相比异常：<br> -in：每秒被中断的进程次数。<br> -cs：每秒进行的事件切换次数。<br> 这两个数越大，代表系统与接口设备的通信越繁忙。<br> cs切换肯定会导致in，先查找cs比较合理。</p> 
<h3><a id="perf_150"></a>perf追踪性能事件</h3> 
<p>查找perf是否支持cs事件</p> 
<pre><code class="prism language-bash">perf list <span class="token operator">|</span> <span class="token function">grep</span> cs
  context-switches OR cs                             <span class="token punctuation">[</span>Software event<span class="token punctuation">]</span>
  scsi:scsi_dispatch_cmd_done                        <span class="token punctuation">[</span>Tracepoint event<span class="token punctuation">]</span>
  scsi:scsi_dispatch_cmd_error                       <span class="token punctuation">[</span>Tracepoint event<span class="token punctuation">]</span>
  scsi:scsi_dispatch_cmd_start                       <span class="token punctuation">[</span>Tracepoint event<span class="token punctuation">]</span>
  scsi:scsi_dispatch_cmd_timeout                     <span class="token punctuation">[</span>Tracepoint event<span class="token punctuation">]</span>
  scsi:scsi_eh_wakeup                                <span class="token punctuation">[</span>Tracepoint event<span class="token punctuation">]</span>
  ucsi:ucsi_connector_change                         <span class="token punctuation">[</span>Tracepoint event<span class="token punctuation">]</span>
  ucsi:ucsi_register_altmode                         <span class="token punctuation">[</span>Tracepoint event<span class="token punctuation">]</span>
  ucsi:ucsi_register_port                            <span class="token punctuation">[</span>Tracepoint event<span class="token punctuation">]</span>
  ucsi:ucsi_reset_ppm                                <span class="token punctuation">[</span>Tracepoint event<span class="token punctuation">]</span>
  ucsi:ucsi_run_command                              <span class="token punctuation">[</span>Tracepoint event<span class="token punctuation">]</span>
</code></pre> 
<p>第一行发现支持。<br> 执行perf 查看cs事件，</p> 
<pre><code class="prism language-bash">numactl -C <span class="token number">0</span>-7 perf record -g -e cs ./m
perf report
</code></pre> 
<p><img src="https://images2.imgbox.com/a4/9f/3mp8upze_o.png" alt="在这里插入图片描述"><br> 通过展开main可以发现在调用rand()时，函数内部会使用do_futex（对线程上锁）导致线程频繁切换至就绪队列等待(futex_wait/futex_wait_queue_me)，使得程序耗时在多线程切换中。<br> 得出结论，影响多线程性能的代码为rand()。</p> 
<h3><a id="_177"></a>一种解决方案</h3> 
<p>调用c++标准库中的随机数生成函数，default_random_engine dre;<br> 代码如下：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">calcu</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    default_random_engine dre<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        sum <span class="token operator">+=</span> <span class="token function">sin</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token function">dre</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span> RAND_MAX<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> sum<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>查看top是否会频繁陷入内核态。</p> 
<pre><code class="prism language-bash"><span class="token function">top</span> - <span class="token number">10</span>:11:01 up <span class="token number">88</span> days,  <span class="token number">6</span>:04,  <span class="token number">3</span> users,  load average: <span class="token number">0.01</span>, <span class="token number">0.38</span>, <span class="token number">1.20</span>
Tasks: <span class="token number">969</span> total,   <span class="token number">3</span> running, <span class="token number">488</span> sleeping,   <span class="token number">4</span> stopped,   <span class="token number">0</span> zombie
%Node0 <span class="token builtin class-name">:</span> <span class="token number">24.6</span> us,  <span class="token number">0.0</span> sy,  <span class="token number">0.0</span> ni, <span class="token number">75.4</span> id,  <span class="token number">0.0</span> wa,  <span class="token number">0.0</span> hi,  <span class="token number">0.0</span> si,  <span class="token number">0.0</span> st
%Cpu0  <span class="token builtin class-name">:</span> <span class="token number">74.1</span> us,  <span class="token number">0.0</span> sy,  <span class="token number">0.0</span> ni, <span class="token number">25.9</span> id,  <span class="token number">0.0</span> wa,  <span class="token number">0.0</span> hi,  <span class="token number">0.0</span> si,  <span class="token number">0.0</span> st
%Cpu1  <span class="token builtin class-name">:</span> <span class="token number">74.1</span> us,  <span class="token number">0.0</span> sy,  <span class="token number">0.0</span> ni, <span class="token number">25.9</span> id,  <span class="token number">0.0</span> wa,  <span class="token number">0.0</span> hi,  <span class="token number">0.0</span> si,  <span class="token number">0.0</span> st
%Cpu2  <span class="token builtin class-name">:</span> <span class="token number">73.8</span> us,  <span class="token number">0.0</span> sy,  <span class="token number">0.0</span> ni, <span class="token number">26.2</span> id,  <span class="token number">0.0</span> wa,  <span class="token number">0.0</span> hi,  <span class="token number">0.0</span> si,  <span class="token number">0.0</span> st
%Cpu3  <span class="token builtin class-name">:</span> <span class="token number">73.8</span> us,  <span class="token number">0.0</span> sy,  <span class="token number">0.0</span> ni, <span class="token number">26.2</span> id,  <span class="token number">0.0</span> wa,  <span class="token number">0.0</span> hi,  <span class="token number">0.0</span> si,  <span class="token number">0.0</span> st
%Cpu4  <span class="token builtin class-name">:</span> <span class="token number">73.8</span> us,  <span class="token number">0.0</span> sy,  <span class="token number">0.0</span> ni, <span class="token number">26.2</span> id,  <span class="token number">0.0</span> wa,  <span class="token number">0.0</span> hi,  <span class="token number">0.0</span> si,  <span class="token number">0.0</span> st
%Cpu5  <span class="token builtin class-name">:</span> <span class="token number">73.8</span> us,  <span class="token number">0.0</span> sy,  <span class="token number">0.0</span> ni, <span class="token number">26.2</span> id,  <span class="token number">0.0</span> wa,  <span class="token number">0.0</span> hi,  <span class="token number">0.0</span> si,  <span class="token number">0.0</span> st
%Cpu6  <span class="token builtin class-name">:</span> <span class="token number">73.8</span> us,  <span class="token number">0.0</span> sy,  <span class="token number">0.0</span> ni, <span class="token number">26.2</span> id,  <span class="token number">0.0</span> wa,  <span class="token number">0.0</span> hi,  <span class="token number">0.0</span> si,  <span class="token number">0.0</span> st
%Cpu7  <span class="token builtin class-name">:</span> <span class="token number">74.1</span> us,  <span class="token number">0.0</span> sy,  <span class="token number">0.0</span> ni, <span class="token number">25.9</span> id,  <span class="token number">0.0</span> wa,  <span class="token number">0.0</span> hi,  <span class="token number">0.0</span> si,  <span class="token number">0.0</span> st
</code></pre> 
<p>耗时比较：</p> 
<pre><code class="prism language-bash"><span class="token comment">#rand()随机数</span>
<span class="token punctuation">]</span>$ numactl -C <span class="token number">0</span>-7 ./m
<span class="token function">time</span> <span class="token operator">=</span> <span class="token number">171.978</span>
<span class="token comment">#default_random_engine生成随机数</span>
<span class="token punctuation">]</span>$ g++ -fopenmp main.cpp -o m -lm
<span class="token punctuation">]</span>$ numactl -C <span class="token number">0</span>-7 ./m
<span class="token function">time</span> <span class="token operator">=</span> <span class="token number">4.83206</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6188d4cad0be2a292f2a5e782f24a680/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Mysql-- 批量插入(检测重复)返回ID</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6abfa045ce3623ecd1828f5354447015/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">神经网络是通过类比什么得到的数学模型</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>