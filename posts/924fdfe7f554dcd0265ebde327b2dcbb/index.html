<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>基于2D特征的运动估计 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="基于2D特征的运动估计" />
<meta property="og:description" content="基于2D特征的运动估计 基于2D特征的运动估计是从两个或多个匹配的2D点的集合中估计运动的问题。它涉及以下技术点：
特征的提取和匹配运动估计 特征提取和匹配 这个过程主要包括三个步骤，即：
特征提取光流法追踪匹配的点筛选有效的特征点 根据这个路线，一种经典的代码构成如下：
#include &lt;iostream&gt; #include &lt;opencv2/opencv.hpp&gt; using namespace std; using namespace cv; void main() { VideoCapture cap(&#34;xxx.mp4&#34;); if (!cap.isOpened()) return -1; // Get frame count int n_frames = int(cap.get(CAP_PROP_FRAME_COUNT)); // Get width and height of video stream int w = int(cap.get(CAP_PROP_FRAME_WIDTH)); int h = int(cap.get(CAP_PROP_FRAME_HEIGHT)); // Get frames per second (fps) double fps = cap.get(cv::CAP_PROP_FPS); Mat curr, curr_gray; Mat prev, prev_gray; for (int i = 1; i &lt; n_frames - 1; i&#43;&#43;) { // Vector from previous and current feature points vector &lt;Point2f&gt; prev_pts, curr_pts; // Detect features in previous frame goodFeaturesToTrack(prev_gray, prev_pts, 200, 0." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/924fdfe7f554dcd0265ebde327b2dcbb/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-08-29T17:20:35+08:00" />
<meta property="article:modified_time" content="2021-08-29T17:20:35+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">基于2D特征的运动估计</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="2D_0"></a>基于2D特征的运动估计</h2> 
<p>基于2D特征的运动估计是从两个或多个匹配的2D点的集合中估计运动的问题。它涉及以下技术点：</p> 
<ul><li>特征的提取和匹配</li><li>运动估计</li></ul> 
<h3><a id="_9"></a>特征提取和匹配</h3> 
<p>这个过程主要包括三个步骤，即：</p> 
<ol><li>特征提取</li><li>光流法追踪匹配的点</li><li>筛选有效的特征点</li></ol> 
<p>根据这个路线，一种经典的代码构成如下：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/opencv.hpp&gt;</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> cv<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    VideoCapture <span class="token function">cap</span><span class="token punctuation">(</span><span class="token string">"xxx.mp4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cap<span class="token punctuation">.</span><span class="token function">isOpened</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment">// Get frame count</span>
    <span class="token keyword">int</span> n_frames <span class="token operator">=</span> <span class="token keyword">int</span><span class="token punctuation">(</span>cap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>CAP_PROP_FRAME_COUNT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Get width and height of video stream</span>
    <span class="token keyword">int</span> w <span class="token operator">=</span> <span class="token keyword">int</span><span class="token punctuation">(</span>cap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>CAP_PROP_FRAME_WIDTH<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> h <span class="token operator">=</span> <span class="token keyword">int</span><span class="token punctuation">(</span>cap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>CAP_PROP_FRAME_HEIGHT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Get frames per second (fps)</span>
    <span class="token keyword">double</span> fps <span class="token operator">=</span> cap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cv<span class="token operator">::</span>CAP_PROP_FPS<span class="token punctuation">)</span><span class="token punctuation">;</span>

    Mat curr<span class="token punctuation">,</span> curr_gray<span class="token punctuation">;</span>
    Mat prev<span class="token punctuation">,</span> prev_gray<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n_frames <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Vector from previous and current feature points</span>
        vector <span class="token operator">&lt;</span>Point2f<span class="token operator">&gt;</span> prev_pts<span class="token punctuation">,</span> curr_pts<span class="token punctuation">;</span>

        <span class="token comment">// Detect features in previous frame</span>
        <span class="token function">goodFeaturesToTrack</span><span class="token punctuation">(</span>prev_gray<span class="token punctuation">,</span> prev_pts<span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">0.01</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Read next frame </span>
        <span class="token keyword">bool</span> success <span class="token operator">=</span> cap<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>curr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token comment">// Convert to grayscale</span>
        <span class="token function">cvtColor</span><span class="token punctuation">(</span>curr<span class="token punctuation">,</span> curr_gray<span class="token punctuation">,</span> COLOR_BGR2GRAY<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Calculate optical flow (i.e. track feature points)</span>
        vector <span class="token operator">&lt;</span>uchar<span class="token operator">&gt;</span> status<span class="token punctuation">;</span>
        vector <span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span> err<span class="token punctuation">;</span>
        <span class="token function">calcOpticalFlowPyrLK</span><span class="token punctuation">(</span>prev_gray<span class="token punctuation">,</span> curr_gray<span class="token punctuation">,</span> prev_pts<span class="token punctuation">,</span> curr_pts<span class="token punctuation">,</span> status<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Filter only valid points</span>
        <span class="token keyword">auto</span> prev_it <span class="token operator">=</span> prev_pts<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> curr_it <span class="token operator">=</span> curr_pts<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> status<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                prev_it<span class="token operator">++</span><span class="token punctuation">;</span>
                curr_it<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{<!-- --></span>
                prev_it <span class="token operator">=</span> prev_pts<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>prev_it<span class="token punctuation">)</span><span class="token punctuation">;</span>
                curr_it <span class="token operator">=</span> curr_pts<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>curr_it<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>利用<code>goodFeaturesToTrack()</code>和<code>calcOpticalFlowPyrLK()</code>，这一套组合拳下来，很容实现特征的提取和匹配。然而，这背后涉及了很多算法及大佬们的思想，后续通过阅读opencv的源码，学习大佬们的精髓。</p> 
<h3><a id="_89"></a>运动估计</h3> 
<p>2D运动估计的原理就是计算2D变换。2D变换根据自由度的不同可以分为旋转、平移、相似变换、仿射变换以及投影变换（透视变换）等变换。</p> 
<blockquote> 
 <p>2D坐标变换中，旋转、相似都属于线性变换，平移则不属于线性变换。但在齐次坐标系下，平移也变成了线性，上述所有变换将可以由一个变换矩阵来表示，即单应性矩阵。<a href="https://en.wikipedia.org/wiki/Transformation_matrix#Affine_transformations" rel="nofollow">原因是</a>，在透视空间中，平移被看作是一个剪切变换。因此，在2D或3D欧几里空间中，平移是一个非线性变换，但在3D或4D齐次坐标下，就变成了一个线性变换。</p> 
</blockquote> 
<p>根据场景的不同，合理选择不同的变换方式。如，在Video Stabilization中，一般选择仿射变换，当然也可以选择投影变换。但是由于在相机运动估计过程中，假设投影中心并未改变，因此选择仿射变换足够。</p> 
<h4><a id="RANSAChttpsblogcsdnnetmppcascarticledetails119766230_101"></a><a href="https://blog.csdn.net/mppcasc/article/details/119766230">RANSAC</a></h4> 
<p>我们对匹配的特征点，利用最小二乘进行运动估计时，如果存在外点的话（几乎总是有的），得到的结果将会受外点的干扰而不够鲁棒。因此，在进行运动估计时，首先要对外点进行筛选。常用的方法有RANSAC和最小中位方差（LMS）。</p> 
<h5><a id="RANSAChttpsenwikipediaorgwikiRandom_sample_consensus_106"></a><a href="https://en.wikipedia.org/wiki/Random_sample_consensus" rel="nofollow">RANSAC算法伪代码</a>：</h5> 
<pre><code>Given:
    data – A set of observations.
    model – A model to explain observed data points.
    n – Minimum number of data points required to estimate model parameters.
    k – Maximum number of iterations allowed in the algorithm.
    t – Threshold value to determine data points that are fit well by model.
    d – Number of close data points required to assert that a model fits well to data.

Return:
    bestFit – model parameters which best fit the data (or null if no good model is found)

iterations = 0
bestFit = null
bestErr = something really large

while iterations &lt; k do
    maybeInliers := n randomly selected values from data
    maybeModel := model parameters fitted to maybeInliers
    alsoInliers := empty set
    for every point in data not in maybeInliers do
        if point fits maybeModel with an error smaller than t
             add point to alsoInliers
    end for
    if the number of elements in alsoInliers is &gt; d then
        // This implies that we may have found a good model
        // now test how good it is.
        betterModel := model parameters fitted to all points in maybeInliers and alsoInliers
        thisErr := a measure of how well betterModel fits these points
        if thisErr &lt; bestErr then
            bestFit := betterModel
            bestErr := thisErr
        end if
    end if
    increment iterations
end while

return bestFit
</code></pre> 
<p>对于我们运动估计而言，RANSAC算法中对应变量的含义：</p> 
<table><thead><tr><th align="center">Given Var</th><th align="center">in code(as follow)</th><th align="center">comment</th></tr></thead><tbody><tr><td align="center">data</td><td align="center">points0，points1</td><td align="center">在特征提取和匹配阶段得到的一系列坐标点(x0, y0)和(x1,y1)</td></tr><tr><td align="center">model</td><td align="center">M</td><td align="center">仿射变换（下文将会讲解如何求解）.</td></tr><tr><td align="center">n</td><td align="center">params.size</td><td align="center">即求解仿射变换至少要提供三个坐标点，才能够求解，否则无法提供足够约束求解6个变量</td></tr><tr><td align="center">k</td><td align="center">niters</td><td align="center">最大迭代次数，通过公式可以估计出.</td></tr><tr><td align="center">t</td><td align="center">params.thresh</td><td align="center">确定是否为内点的阈值</td></tr><tr><td align="center">d</td><td align="center">ninliersMax</td><td align="center">记录拟合最多内点个数</td></tr></tbody></table> 
<h5><a id="_163"></a>代码</h5> 
<pre><code class="prism language-cpp"><span class="token keyword">enum</span> <span class="token class-name">MotionModel</span>
<span class="token punctuation">{<!-- --></span>
    MM_TRANSLATION <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    MM_TRANSLATION_AND_SCALE <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
    MM_ROTATION <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
    MM_RIGID <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span>
    MM_SIMILARITY <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span>
    MM_AFFINE <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
    MM_HOMOGRAPHY <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">,</span>
    MM_UNKNOWN <span class="token operator">=</span> <span class="token number">7</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-cpp"><span class="token keyword">struct</span> <span class="token class-name">RansacParams</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> size<span class="token punctuation">;</span> <span class="token comment">//!&lt; subset size</span>
    <span class="token keyword">float</span> thresh<span class="token punctuation">;</span> <span class="token comment">//!&lt; max error to classify as inlier</span>
    <span class="token keyword">float</span> eps<span class="token punctuation">;</span> <span class="token comment">//!&lt; max outliers ratio</span>
    <span class="token keyword">float</span> prob<span class="token punctuation">;</span> <span class="token comment">//!&lt; probability of success</span>

    <span class="token function">RansacParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">thresh</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">eps</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">prob</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token comment">/** @brief Constructor
    @param size Subset size.
    @param thresh Maximum re-projection error value to classify as inlier.
    @param eps Maximum ratio of incorrect correspondences.
    @param prob Required success probability.
     */</span>
    <span class="token function">RansacParams</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">,</span> <span class="token keyword">float</span> thresh<span class="token punctuation">,</span> <span class="token keyword">float</span> eps<span class="token punctuation">,</span> <span class="token keyword">float</span> prob<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
    @return Number of iterations that'll be performed by RANSAC method.
    */</span>
    <span class="token keyword">int</span> <span class="token function">niters</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
                std<span class="token operator">::</span><span class="token function">ceil</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> prob<span class="token punctuation">)</span> <span class="token operator">/</span> std<span class="token operator">::</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> std<span class="token operator">::</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> eps<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
    @param model Motion model. 
    @return Default RANSAC method parameters for the given motion model.
    */</span>
    <span class="token keyword">static</span> RansacParams <span class="token function">default2dMotion</span><span class="token punctuation">(</span>MotionModel model<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">CV_Assert</span><span class="token punctuation">(</span>model <span class="token operator">&lt;</span> MM_UNKNOWN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>model <span class="token operator">==</span> MM_TRANSLATION<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token function">RansacParams</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token number">0.99f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>model <span class="token operator">==</span> MM_TRANSLATION_AND_SCALE<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token function">RansacParams</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token number">0.99f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>model <span class="token operator">==</span> MM_ROTATION<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token function">RansacParams</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token number">0.99f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>model <span class="token operator">==</span> MM_RIGID<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token function">RansacParams</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token number">0.99f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>model <span class="token operator">==</span> MM_SIMILARITY<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token function">RansacParams</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token number">0.99f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>model <span class="token operator">==</span> MM_AFFINE<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token function">RansacParams</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token number">0.99f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">RansacParams</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token number">0.99f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> 
<pre><code class="prism language-cpp">Mat <span class="token function">estimateGlobalMotionRansac</span><span class="token punctuation">(</span>
        InputArray points0<span class="token punctuation">,</span> InputArray points1<span class="token punctuation">,</span> <span class="token keyword">int</span> model<span class="token punctuation">,</span> <span class="token keyword">const</span> RansacParams <span class="token operator">&amp;</span>params<span class="token punctuation">,</span>
        <span class="token keyword">float</span> <span class="token operator">*</span>rmse<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>ninliers<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">CV_Assert</span><span class="token punctuation">(</span>model <span class="token operator">&lt;=</span> MM_AFFINE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CV_Assert</span><span class="token punctuation">(</span>points0<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> points1<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> npoints <span class="token operator">=</span> points0<span class="token punctuation">.</span><span class="token function">getMat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">checkVector</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CV_Assert</span><span class="token punctuation">(</span>points1<span class="token punctuation">.</span><span class="token function">getMat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">checkVector</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">==</span> npoints<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>npoints <span class="token operator">&lt;</span> params<span class="token punctuation">.</span>size<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token class-name">Mat</span><span class="token operator">::</span><span class="token function">eye</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> CV_32F<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> Point2f <span class="token operator">*</span>points0_ <span class="token operator">=</span> points0<span class="token punctuation">.</span><span class="token function">getMat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ptr<span class="token operator">&lt;</span>Point2f<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> Point2f <span class="token operator">*</span>points1_ <span class="token operator">=</span> points1<span class="token punctuation">.</span><span class="token function">getMat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ptr<span class="token operator">&lt;</span>Point2f<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> niters <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">niters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 估算推导出的迭代数</span>

    <span class="token comment">// current hypothesis</span>
    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token function">indices</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>Point2f<span class="token operator">&gt;</span> <span class="token function">subset0</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>Point2f<span class="token operator">&gt;</span> <span class="token function">subset1</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// best hypothesis</span>
    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token function">bestIndices</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    Mat_<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span> bestM<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ninliersMax <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    RNG <span class="token function">rng</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Point2f p0<span class="token punctuation">,</span> p1<span class="token punctuation">;</span>
    <span class="token keyword">float</span> x<span class="token punctuation">,</span> y<span class="token punctuation">;</span>

    <span class="token comment">// 1 use the minimum number of data points required to estimate model parameters to cal model, then record the model corresponding to the max nums of maybeInliers</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> iter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> iter <span class="token operator">&lt;</span> niters<span class="token punctuation">;</span> <span class="token operator">++</span>iter<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1.1 randomly select values</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> params<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">bool</span> ok <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>ok<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                ok <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                indices<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">unsigned</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>rng<span class="token punctuation">)</span> <span class="token operator">%</span> npoints<span class="token punctuation">;</span> 
                <span class="token comment">// The randomly selected data cannot be the same as the previous data. Otherwise, random selection fails</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> i<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> 
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>indices<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> indices<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span>
                        <span class="token punctuation">{<!-- --></span> ok <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">// if fails, continue to randomly select</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// based the above index, extract the data used to fit the models</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> params<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            subset0<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> points0_<span class="token punctuation">[</span>indices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            subset1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> points1_<span class="token punctuation">[</span>indices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 1.2 cal models</span>
        Mat_<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span> M <span class="token operator">=</span> <span class="token function">estimateGlobalMotionLeastSquares</span><span class="token punctuation">(</span>subset0<span class="token punctuation">,</span> subset1<span class="token punctuation">,</span> model<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 1.3 evaluate every points based the above model</span>
        <span class="token comment">// put all the data into the model above, then cal the nums of maybeInliers</span>
        <span class="token keyword">int</span> numinliers <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> npoints<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            p0 <span class="token operator">=</span> points0_<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            p1 <span class="token operator">=</span> points1_<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            x <span class="token operator">=</span> <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span>p0<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>p0<span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            y <span class="token operator">=</span> <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span>p0<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>p0<span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sqr</span><span class="token punctuation">(</span>x <span class="token operator">-</span> p1<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">sqr</span><span class="token punctuation">(</span>y <span class="token operator">-</span> p1<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">&lt;</span> params<span class="token punctuation">.</span>thresh <span class="token operator">*</span> params<span class="token punctuation">.</span>thresh<span class="token punctuation">)</span>
                numinliers<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 1.4 record the model corresponding to the max nums of maybeInliers</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>numinliers <span class="token operator">&gt;=</span> ninliersMax<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            bestM <span class="token operator">=</span> M<span class="token punctuation">;</span>
            ninliersMax <span class="token operator">=</span> numinliers<span class="token punctuation">;</span>
            bestIndices<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>indices<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 2 after iters, use the bestM to filter maybeInliers from all points, then cal model</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ninliersMax <span class="token operator">&lt;</span> params<span class="token punctuation">.</span>size<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// compute RMSE</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> params<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            subset0<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> points0_<span class="token punctuation">[</span>bestIndices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            subset1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> points1_<span class="token punctuation">[</span>bestIndices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        bestM <span class="token operator">=</span> <span class="token function">estimateGlobalMotionLeastSquares</span><span class="token punctuation">(</span>subset0<span class="token punctuation">,</span> subset1<span class="token punctuation">,</span> model<span class="token punctuation">,</span> rmse<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        subset0<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>ninliersMax<span class="token punctuation">)</span><span class="token punctuation">;</span>
        subset1<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>ninliersMax<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// select maybeInliers from all points</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> npoints <span class="token operator">&amp;&amp;</span> j <span class="token operator">&lt;</span> ninliersMax <span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            p0 <span class="token operator">=</span> points0_<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            p1 <span class="token operator">=</span> points1_<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            x <span class="token operator">=</span> <span class="token function">bestM</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span>p0<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token function">bestM</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>p0<span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token function">bestM</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            y <span class="token operator">=</span> <span class="token function">bestM</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span>p0<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token function">bestM</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>p0<span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token function">bestM</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sqr</span><span class="token punctuation">(</span>x <span class="token operator">-</span> p1<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">sqr</span><span class="token punctuation">(</span>y <span class="token operator">-</span> p1<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">&lt;</span> params<span class="token punctuation">.</span>thresh <span class="token operator">*</span> params<span class="token punctuation">.</span>thresh<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                subset0<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> p0<span class="token punctuation">;</span>
                subset1<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> p1<span class="token punctuation">;</span>
                j<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// based maybeInliers, cal model</span>
        bestM <span class="token operator">=</span> <span class="token function">estimateGlobalMotionLeastSquares</span><span class="token punctuation">(</span>subset0<span class="token punctuation">,</span> subset1<span class="token punctuation">,</span> model<span class="token punctuation">,</span> rmse<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ninliers<span class="token punctuation">)</span>
        <span class="token operator">*</span>ninliers <span class="token operator">=</span> ninliersMax<span class="token punctuation">;</span>

    <span class="token keyword">return</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>bestM<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_356"></a>最小二乘估计</h4> 
<p>通过RANSAC过滤掉可能的外点，然后基于剩余的”内点“，进行运动估计。</p> 
<p>基于最小二乘的2D运动估计主要步骤如下：</p> 
<ol><li>对2D坐标进行<strong>各向同性归一化</strong>，即<code>normalizePoints()</code>。</li><li>构建求解方程（正规方程）</li><li>求解正规方程</li><li>反归一化</li></ol> 
<h5><a id="Isotropic_scaling_369"></a>各向同性归一化（<strong>Isotropic scaling</strong>）</h5> 
<p>用于2D运动估计的稀疏点集来自于不同的图像。因此，在接下来变换矩阵求解前，对坐标点进行性归一化非常重要。</p> 
<blockquote> 
 <p>对于DLT，基本矩阵求解时，归一化非常重要。</p> 
</blockquote> 
<p><a href="https://stackoverflow.com/questions/52940822/what-is-the-correct-way-to-normalize-corresponding-points-before-estimation-of-f" rel="nofollow">主要步骤如下</a>：</p> 
<ol><li>The points are translated so that their centroid is at the origin.</li><li>The points are then scaled so that the average distance from the origin is equal to √2.( <em>for points(x, y), This means that the “average” point is equal to (1, 1)</em> )</li><li>This transformation is applied to each of the two images independently.</li></ol> 
<p>对应代码如下：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">inline</span> <span class="token keyword">float</span> <span class="token function">sqr</span><span class="token punctuation">(</span><span class="token keyword">float</span> x<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> x <span class="token operator">*</span> x<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">static</span> Mat <span class="token function">normalizePoints</span><span class="token punctuation">(</span><span class="token keyword">int</span> npoints<span class="token punctuation">,</span> Point2f<span class="token operator">*</span> points<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">float</span> cx <span class="token operator">=</span> <span class="token number">0.f</span><span class="token punctuation">,</span> cy <span class="token operator">=</span> <span class="token number">0.f</span><span class="token punctuation">;</span> <span class="token comment">// centroid of points</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> npoints<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        cx <span class="token operator">+=</span> points<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
        cy <span class="token operator">+=</span> points<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    cx <span class="token operator">/=</span> npoints<span class="token punctuation">;</span>
    cy <span class="token operator">/=</span> npoints<span class="token punctuation">;</span>

    <span class="token keyword">float</span> d <span class="token operator">=</span> <span class="token number">0.f</span><span class="token punctuation">;</span> <span class="token comment">// average distance</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> npoints<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        points<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">-=</span> cx<span class="token punctuation">;</span>
        points<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">-=</span> cy<span class="token punctuation">;</span>
        d <span class="token operator">+=</span> std<span class="token operator">::</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token function">sqr</span><span class="token punctuation">(</span>points<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">sqr</span><span class="token punctuation">(</span>points<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    d <span class="token operator">/=</span> npoints<span class="token punctuation">;</span>

    <span class="token keyword">float</span> s <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token number">2.f</span><span class="token punctuation">)</span> <span class="token operator">/</span> d<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> npoints<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        points<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">*=</span> s<span class="token punctuation">;</span>
        points<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">*=</span> s<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// T matrix for normalization</span>
    Mat_<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span> T <span class="token operator">=</span> <span class="token class-name">Mat</span><span class="token operator">::</span><span class="token function">eye</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> CV_32F<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">T</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">T</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> s<span class="token punctuation">;</span>
    <span class="token function">T</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span>cx <span class="token operator">*</span> s<span class="token punctuation">;</span>
    <span class="token function">T</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span>cy <span class="token operator">*</span> s<span class="token punctuation">;</span>
    <span class="token keyword">return</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_423"></a>构建求解方程</h5> 
<p>对于仿射变换有：<br> <img src="https://images2.imgbox.com/c5/38/gBfR0HvS_o.png" alt="在这里插入图片描述"></p> 
<p>展开上述式子，将系数a提取出来，即，<br> <img src="https://images2.imgbox.com/d4/e8/XAY3BrG8_o.png" alt="在这里插入图片描述"></p> 
<p>除了6个未知数，其他都是来自坐标点。因此，只要提供3组及以上的坐标点，就可以求解上述方程</p> 
<pre><code class="prism language-cpp"><span class="token comment">// A*x = b</span>
Mat_<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span> <span class="token function">A</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> npoints<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> npoints<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">float</span><span class="token operator">*</span> a0<span class="token punctuation">,</span> <span class="token operator">*</span> a1<span class="token punctuation">;</span>
Point2f p0<span class="token punctuation">,</span> p1<span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> npoints<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    a0 <span class="token operator">=</span> A<span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">*</span> i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    a1 <span class="token operator">=</span> A<span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    p0 <span class="token operator">=</span> points0<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    p1 <span class="token operator">=</span> points1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    a0<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> p0<span class="token punctuation">.</span>x<span class="token punctuation">;</span> a0<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> a0<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    a1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> p0<span class="token punctuation">.</span>y<span class="token punctuation">;</span> a1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> a1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">b</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> p1<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    <span class="token function">b</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> p1<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_458"></a>求解正规方程</h5> 
<pre><code class="prism language-cpp"> Mat_<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span> sol<span class="token punctuation">;</span>
<span class="token function">solve</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> b<span class="token punctuation">,</span> sol<span class="token punctuation">,</span> DECOMP_NORMAL <span class="token operator">|</span> DECOMP_LU<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>rmse<span class="token punctuation">)</span>
    <span class="token operator">*</span>rmse <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token function">norm</span><span class="token punctuation">(</span>A <span class="token operator">*</span> sol<span class="token punctuation">,</span> b<span class="token punctuation">,</span> NORM_L2<span class="token punctuation">)</span> <span class="token operator">/</span> std<span class="token operator">::</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>npoints<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Mat_<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span> M <span class="token operator">=</span> <span class="token class-name">Mat</span><span class="token operator">::</span><span class="token function">eye</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> CV_32F<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">,</span> <span class="token operator">++</span>k<span class="token punctuation">)</span>
        <span class="token function">M</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">sol</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="_475"></a>反归一化</h5> 
<p>由于求解上述变换矩阵，是在归一化的坐标上进行的，不能直接对像素坐标进行变换。因此，需要反归一化，得到对像素坐标进行变换的变换矩阵。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">return</span> T1<span class="token punctuation">.</span><span class="token function">inv</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> M <span class="token operator">*</span> T0<span class="token punctuation">;</span>
</code></pre> 
<h5><a id="_485"></a>代码</h5> 
<p>整个仿射变换求解的代码如下：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> Mat <span class="token function">estimateGlobMotionLeastSquaresAffine</span><span class="token punctuation">(</span>
    <span class="token keyword">int</span> npoints<span class="token punctuation">,</span> Point2f<span class="token operator">*</span> points0<span class="token punctuation">,</span> Point2f<span class="token operator">*</span> points1<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">*</span> rmse<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    Mat_<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span> T0 <span class="token operator">=</span> <span class="token function">normalizePoints</span><span class="token punctuation">(</span>npoints<span class="token punctuation">,</span> points0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Mat_<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span> T1 <span class="token operator">=</span> <span class="token function">normalizePoints</span><span class="token punctuation">(</span>npoints<span class="token punctuation">,</span> points1<span class="token punctuation">)</span><span class="token punctuation">;</span>

    Mat_<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span> <span class="token function">A</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> npoints<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> npoints<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span><span class="token operator">*</span> a0<span class="token punctuation">,</span> <span class="token operator">*</span> a1<span class="token punctuation">;</span>
    Point2f p0<span class="token punctuation">,</span> p1<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> npoints<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        a0 <span class="token operator">=</span> A<span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">*</span> i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        a1 <span class="token operator">=</span> A<span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        p0 <span class="token operator">=</span> points0<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        p1 <span class="token operator">=</span> points1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

        a0<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> p0<span class="token punctuation">.</span>x<span class="token punctuation">;</span> a0<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> p0<span class="token punctuation">.</span>y<span class="token punctuation">;</span> a0<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> a0<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> a0<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> a0<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        a1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> a1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> a1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> a1<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> p0<span class="token punctuation">.</span>x<span class="token punctuation">;</span> a1<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> p0<span class="token punctuation">.</span>y<span class="token punctuation">;</span> a1<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token function">b</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> p1<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
        <span class="token function">b</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> p1<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    Mat_<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span> sol<span class="token punctuation">;</span>
    <span class="token function">solve</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> b<span class="token punctuation">,</span> sol<span class="token punctuation">,</span> DECOMP_NORMAL <span class="token operator">|</span> DECOMP_LU<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>rmse<span class="token punctuation">)</span>
        <span class="token operator">*</span>rmse <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token function">norm</span><span class="token punctuation">(</span>A <span class="token operator">*</span> sol<span class="token punctuation">,</span> b<span class="token punctuation">,</span> NORM_L2<span class="token punctuation">)</span> <span class="token operator">/</span> std<span class="token operator">::</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>npoints<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Mat_<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span> M <span class="token operator">=</span> <span class="token class-name">Mat</span><span class="token operator">::</span><span class="token function">eye</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> CV_32F<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">,</span> <span class="token operator">++</span>k<span class="token punctuation">)</span>
            <span class="token function">M</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">sol</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> T1<span class="token punctuation">.</span><span class="token function">inv</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> M <span class="token operator">*</span> T0<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>同理，其他变换的求解方式类似。</p> 
<h2><a id="_535"></a>最后</h2> 
<p>运动估计内容来自opencv中的<strong>Video Stabilization</strong>模块，该模块主要用于视频的稳像、防抖处理。该模块位于<a href="https://github.com/opencv/opencv_contrib">opencv_contrib</a>。</p> 
<p>基于2D特征进行运动估计，整体思路简单，值得注意的是，在进行变换矩阵求解前，需要对坐标点进行归一化。</p> 
<p>将整个过程的源码进行模块化分解、学习并记录，每一块都有可能在以后的工作中用到，这里就相当于小小的积累吧。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ac15e8968ffe0cfebe0cb6cb154715fe/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">使用redis进行分页</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/dad364989c1a33f8d2980297360d1e51/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">[C&#43;&#43;] 哈希详解</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>