<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>vSphere通 python API接口创建虚拟机及修改配置 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="vSphere通 python API接口创建虚拟机及修改配置" />
<meta property="og:description" content="背景：跟OA流程打通，自动化创建虚拟机，减少系统工程师重复工作时间，通过vSphere 提供的接口创建虚拟机，笔者通过 vsphere-automation-sdk-python 创建虚拟机，pyvmomi 给VM添加磁盘，打开VM电源，获取虚拟机IP地址 笔者系统环境：windows python版本：python3.8 完整代码如下： import urllib3 import requests import time import calendar from com.vmware.vcenter.ovf_client import LibraryItem, DiskProvisioningType, ImportFlag from com.vmware.vcenter_client import Folder, ResourcePool, Cluster, Network, Datastore from vmware.vapi.vsphere.client import create_vsphere_client from com.vmware.content_client import Library, LibraryModel, LocalLibrary, SubscribedLibrary from com.vmware.content.library_client import Item, ItemModel, StorageBacking, SubscribedItem from pyVim.connect import SmartConnectNoSSL from pyVmomi import vim def create_vm(user, ip, password, network_name, cluster_name,datastore_name, folder_name, content_library_name, template_name, vm_name, annotation): &#34;&#34;&#34; 通过 vsphere-automation-sdk-python 从模板库复制虚拟机 &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/6ac1eba9818d0090df53d3a6d2e88748/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-14T17:33:40+08:00" />
<meta property="article:modified_time" content="2022-04-14T17:33:40+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">vSphere通 python API接口创建虚拟机及修改配置</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h4><a id="OAvSphere__vsphereautomationsdkpython_pyvmomi_VMVMIP_0"></a>背景：跟OA流程打通，自动化创建虚拟机，减少系统工程师重复工作时间，通过vSphere 提供的接口创建虚拟机，笔者通过 vsphere-automation-sdk-python 创建虚拟机，pyvmomi 给VM添加磁盘，打开VM电源，获取虚拟机IP地址</h4> 
<h4><a id="windows_2"></a>笔者系统环境：windows</h4> 
<h4><a id="pythonpython38_4"></a>python版本：python3.8</h4> 
<p><img src="https://images2.imgbox.com/3e/84/1CpWOEpJ_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_7"></a>完整代码如下：</h5> 
<pre><code class="prism language-python"><span class="token keyword">import</span> urllib3
<span class="token keyword">import</span> requests
<span class="token keyword">import</span> time
<span class="token keyword">import</span> calendar
<span class="token keyword">from</span> com<span class="token punctuation">.</span>vmware<span class="token punctuation">.</span>vcenter<span class="token punctuation">.</span>ovf_client <span class="token keyword">import</span> LibraryItem<span class="token punctuation">,</span> DiskProvisioningType<span class="token punctuation">,</span> ImportFlag
<span class="token keyword">from</span> com<span class="token punctuation">.</span>vmware<span class="token punctuation">.</span>vcenter_client <span class="token keyword">import</span> Folder<span class="token punctuation">,</span> ResourcePool<span class="token punctuation">,</span> Cluster<span class="token punctuation">,</span> Network<span class="token punctuation">,</span> Datastore
<span class="token keyword">from</span> vmware<span class="token punctuation">.</span>vapi<span class="token punctuation">.</span>vsphere<span class="token punctuation">.</span>client <span class="token keyword">import</span> create_vsphere_client
<span class="token keyword">from</span> com<span class="token punctuation">.</span>vmware<span class="token punctuation">.</span>content_client <span class="token keyword">import</span> Library<span class="token punctuation">,</span> LibraryModel<span class="token punctuation">,</span> LocalLibrary<span class="token punctuation">,</span> SubscribedLibrary
<span class="token keyword">from</span> com<span class="token punctuation">.</span>vmware<span class="token punctuation">.</span>content<span class="token punctuation">.</span>library_client <span class="token keyword">import</span> Item<span class="token punctuation">,</span> ItemModel<span class="token punctuation">,</span> StorageBacking<span class="token punctuation">,</span> SubscribedItem
<span class="token keyword">from</span> pyVim<span class="token punctuation">.</span>connect <span class="token keyword">import</span> SmartConnectNoSSL
<span class="token keyword">from</span> pyVmomi <span class="token keyword">import</span> vim


<span class="token keyword">def</span> <span class="token function">create_vm</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> ip<span class="token punctuation">,</span> password<span class="token punctuation">,</span> network_name<span class="token punctuation">,</span> cluster_name<span class="token punctuation">,</span>datastore_name<span class="token punctuation">,</span> folder_name<span class="token punctuation">,</span> content_library_name<span class="token punctuation">,</span>
              template_name<span class="token punctuation">,</span> vm_name<span class="token punctuation">,</span> annotation<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">""" 通过 vsphere-automation-sdk-python 从模板库复制虚拟机 """</span>
    session <span class="token operator">=</span> requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span>
    session<span class="token punctuation">.</span>verify <span class="token operator">=</span> <span class="token boolean">False</span>
    urllib3<span class="token punctuation">.</span>disable_warnings<span class="token punctuation">(</span>urllib3<span class="token punctuation">.</span>exceptions<span class="token punctuation">.</span>InsecureRequestWarning<span class="token punctuation">)</span>
    client <span class="token operator">=</span> create_vsphere_client<span class="token punctuation">(</span>server<span class="token operator">=</span>ip<span class="token punctuation">,</span> username<span class="token operator">=</span>user<span class="token punctuation">,</span> password<span class="token operator">=</span>password<span class="token punctuation">,</span> session<span class="token operator">=</span>session<span class="token punctuation">)</span>

    stub_config <span class="token operator">=</span> client<span class="token punctuation">.</span>_stub_config

    library_item <span class="token operator">=</span> LibraryItem<span class="token punctuation">(</span>stub_config<span class="token punctuation">)</span>
    network_id <span class="token operator">=</span> client<span class="token punctuation">.</span>vcenter<span class="token punctuation">.</span>Network<span class="token punctuation">.</span><span class="token builtin">list</span><span class="token punctuation">(</span>
        Network<span class="token punctuation">.</span>FilterSpec<span class="token punctuation">(</span>names<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>network_name<span class="token punctuation">}</span><span class="token punctuation">,</span>
                           types<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>Network<span class="token punctuation">.</span>Type<span class="token punctuation">.</span>DISTRIBUTED_PORTGROUP<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>network

    cluster_id <span class="token operator">=</span> client<span class="token punctuation">.</span>vcenter<span class="token punctuation">.</span>Cluster<span class="token punctuation">.</span><span class="token builtin">list</span><span class="token punctuation">(</span>Cluster<span class="token punctuation">.</span>FilterSpec<span class="token punctuation">(</span>names<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>cluster_name<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cluster
    resource_pool_id <span class="token operator">=</span> client<span class="token punctuation">.</span>vcenter<span class="token punctuation">.</span>ResourcePool<span class="token punctuation">.</span><span class="token builtin">list</span><span class="token punctuation">(</span>ResourcePool<span class="token punctuation">.</span>FilterSpec<span class="token punctuation">(</span>clusters<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>cluster_id<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span>
        <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>resource_pool

    datastore_id <span class="token operator">=</span> client<span class="token punctuation">.</span>vcenter<span class="token punctuation">.</span>Datastore<span class="token punctuation">.</span><span class="token builtin">list</span><span class="token punctuation">(</span>Datastore<span class="token punctuation">.</span>FilterSpec<span class="token punctuation">(</span>names<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>datastore_name<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>datastore

    library_service <span class="token operator">=</span> Library<span class="token punctuation">(</span>stub_config<span class="token punctuation">)</span>
    library_id <span class="token operator">=</span> library_service<span class="token punctuation">.</span>find<span class="token punctuation">(</span>Library<span class="token punctuation">.</span>FindSpec<span class="token punctuation">(</span>name<span class="token operator">=</span>content_library_name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

    library_item_service <span class="token operator">=</span> Item<span class="token punctuation">(</span>stub_config<span class="token punctuation">)</span>
    library_item_id <span class="token operator">=</span> library_item_service<span class="token punctuation">.</span>find<span class="token punctuation">(</span>Item<span class="token punctuation">.</span>FindSpec<span class="token punctuation">(</span>name<span class="token operator">=</span>template_name<span class="token punctuation">,</span> library_id<span class="token operator">=</span>library_id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

    ovf_lib_item_service <span class="token operator">=</span> LibraryItem<span class="token punctuation">(</span>stub_config<span class="token punctuation">)</span>
    folder_id <span class="token operator">=</span> client<span class="token punctuation">.</span>vcenter<span class="token punctuation">.</span>Folder<span class="token punctuation">.</span><span class="token builtin">list</span><span class="token punctuation">(</span>Folder<span class="token punctuation">.</span>FilterSpec<span class="token punctuation">(</span>names<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>folder_name<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>folder

    deployment_target <span class="token operator">=</span> library_item<span class="token punctuation">.</span>DeploymentTarget<span class="token punctuation">(</span>resource_pool_id<span class="token operator">=</span>resource_pool_id<span class="token punctuation">,</span> folder_id<span class="token operator">=</span>folder_id<span class="token punctuation">)</span>
    <span class="token comment"># ovf_lib_item_service.filter(library_item_id, deployment_target)</span>

    storage_group_mapping <span class="token operator">=</span> ovf_lib_item_service<span class="token punctuation">.</span>StorageGroupMapping<span class="token punctuation">(</span>
        <span class="token builtin">type</span><span class="token operator">=</span>ovf_lib_item_service<span class="token punctuation">.</span>StorageGroupMapping<span class="token punctuation">.</span>Type<span class="token punctuation">(</span><span class="token string">'DATASTORE'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        datastore_id<span class="token operator">=</span>datastore_id<span class="token punctuation">,</span>
        provisioning<span class="token operator">=</span>DiskProvisioningType<span class="token punctuation">(</span><span class="token string">'thin'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    deployment_spec <span class="token operator">=</span> library_item<span class="token punctuation">.</span>ResourcePoolDeploymentSpec<span class="token punctuation">(</span>
        name<span class="token operator">=</span>vm_name<span class="token punctuation">,</span>
        annotation<span class="token operator">=</span>annotation<span class="token punctuation">,</span>
        accept_all_eula<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
        network_mappings<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"Your configuration"</span><span class="token punctuation">:</span> network_id<span class="token punctuation">}</span><span class="token punctuation">,</span>
        storage_mappings<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"Your configuration"</span><span class="token punctuation">:</span> storage_group_mapping<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token comment"># Execute this statement and start deploying. It will last for about 2 minutes and you can see the specific progress on VMware.</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"开始从内容库复制虚拟机,请稍等......"</span><span class="token punctuation">)</span>
    result <span class="token operator">=</span> library_item<span class="token punctuation">.</span>deploy<span class="token punctuation">(</span>library_item_id<span class="token punctuation">,</span> deployment_target<span class="token punctuation">,</span> deployment_spec<span class="token punctuation">)</span>
    <span class="token keyword">return</span> result


<span class="token keyword">def</span> <span class="token function">get_vm_state</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> ip<span class="token punctuation">,</span> password<span class="token punctuation">,</span> vm_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    session <span class="token operator">=</span> requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span>
    session<span class="token punctuation">.</span>verify <span class="token operator">=</span> <span class="token boolean">False</span>
    urllib3<span class="token punctuation">.</span>disable_warnings<span class="token punctuation">(</span>urllib3<span class="token punctuation">.</span>exceptions<span class="token punctuation">.</span>InsecureRequestWarning<span class="token punctuation">)</span>
    client <span class="token operator">=</span> create_vsphere_client<span class="token punctuation">(</span>server<span class="token operator">=</span>ip<span class="token punctuation">,</span> username<span class="token operator">=</span>user<span class="token punctuation">,</span> password<span class="token operator">=</span>password<span class="token punctuation">,</span> session<span class="token operator">=</span>session<span class="token punctuation">)</span>
    vm <span class="token operator">=</span> client<span class="token punctuation">.</span>vcenter<span class="token punctuation">.</span>VM<span class="token punctuation">.</span><span class="token builtin">list</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span>vcenter<span class="token punctuation">.</span>VM<span class="token punctuation">.</span>FilterSpec<span class="token punctuation">(</span>names<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>vm_name<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    vm_state <span class="token operator">=</span> client<span class="token punctuation">.</span>vcenter<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>Power<span class="token punctuation">.</span>get<span class="token punctuation">(</span>vm<span class="token punctuation">.</span>vm<span class="token punctuation">)</span><span class="token punctuation">.</span>state
    <span class="token keyword">if</span> vm_state <span class="token operator">==</span> <span class="token string">'POWERED_OFF'</span><span class="token punctuation">:</span>
        client<span class="token punctuation">.</span>vcenter<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>Power<span class="token punctuation">.</span>start<span class="token punctuation">(</span>vm<span class="token punctuation">.</span>vm<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'虚拟机 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>vm_name<span class="token punctuation">}</span></span><span class="token string"> 现在启动'</span></span><span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>vm_name<span class="token punctuation">}</span></span><span class="token string"> 现在启动'</span></span>
    <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>vm_name<span class="token punctuation">}</span></span><span class="token string"> 电源状态已开启'</span></span>


<span class="token keyword">def</span> <span class="token function">get_vm_network</span><span class="token punctuation">(</span>network_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">""" 获取指定网段， vlan-22-10.0.22.* 为分布式交换机VLAN名称 """</span>
    network_name <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span>network_name<span class="token punctuation">)</span>
    <span class="token keyword">if</span>  network_name <span class="token operator">==</span> <span class="token string">"10.0.22.0/24"</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"vlan-22-10.0.22.*"</span>
    <span class="token keyword">if</span>  network_name <span class="token operator">==</span> <span class="token string">"10.0.23.0/24"</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"VLAN-10"</span>
    <span class="token keyword">return</span> <span class="token string">"子网不存在,请先创建子网掩码"</span>


<span class="token keyword">def</span> <span class="token function">get_vm_cluster_name</span><span class="token punctuation">(</span>cluster_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">""" 获取数据中心位置，目前只有一个方便后期扩容 """</span>
    cluster_name <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span>cluster_name<span class="token punctuation">)</span>
    <span class="token keyword">if</span> cluster_name <span class="token operator">==</span> <span class="token string">"shenzhen"</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"shenzhen"</span>
    <span class="token keyword">return</span> <span class="token string">"集群名称不存在，请先创建集群"</span>


<span class="token keyword">def</span> <span class="token function">get_vm_datastore_name</span><span class="token punctuation">(</span>datastore_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">""" 获取存储位置，目前只有一个方便后期扩容 """</span>
    datastore_name <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span>datastore_name<span class="token punctuation">)</span>
    <span class="token keyword">if</span> datastore_name <span class="token operator">==</span> <span class="token string">"datastore1"</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"datastore1"</span>
    <span class="token keyword">return</span> <span class="token string">"存储池不存在，请先创建存储池"</span>


<span class="token keyword">def</span> <span class="token function">get_vm_folder_name</span><span class="token punctuation">(</span>folder_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">""" 获取虚拟机存放位置，目前只有一个方便后期扩容 """</span>
    folder_name <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>folder_name<span class="token punctuation">)</span>
    <span class="token keyword">if</span> folder_name <span class="token operator">==</span> <span class="token string">"EID"</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"EID"</span>
    <span class="token keyword">return</span> <span class="token string">"虚拟机文件不存在，请先创建虚拟机文件"</span>


<span class="token keyword">def</span> <span class="token function">get_vm_template_name</span><span class="token punctuation">(</span>template_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">""" 获取数据库模板，返回模板名称及模板账户密码 """</span>
    template_name <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span>template_name<span class="token punctuation">)</span>
    <span class="token keyword">if</span> template_name <span class="token operator">==</span> <span class="token string">"centos"</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token string">'system'</span><span class="token punctuation">:</span> <span class="token string">"contos7-01-temp"</span><span class="token punctuation">,</span>
                <span class="token string">'system_user'</span><span class="token punctuation">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
                <span class="token string">'system_pwd'</span><span class="token punctuation">:</span> <span class="token string">'123.com'</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span>
    <span class="token keyword">if</span> template_name <span class="token operator">==</span> <span class="token string">"ubuntu"</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token string">'system'</span><span class="token punctuation">:</span> <span class="token string">"Ubuntu-temp"</span><span class="token punctuation">,</span>
                <span class="token string">'system_user'</span><span class="token punctuation">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
                <span class="token string">'system_pwd'</span><span class="token punctuation">:</span> <span class="token string">'123@com'</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span>
    <span class="token keyword">if</span> template_name <span class="token operator">==</span> <span class="token string">"windows"</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token string">'system'</span><span class="token punctuation">:</span> <span class="token string">"windows-temp"</span><span class="token punctuation">,</span>
                <span class="token string">'system_user'</span><span class="token punctuation">:</span> <span class="token string">'administrator'</span><span class="token punctuation">,</span>
                <span class="token string">'system_pwd'</span><span class="token punctuation">:</span> <span class="token string">'123#com'</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token string">"系统模板不存在，请先创建模板"</span>


<span class="token keyword">class</span> <span class="token class-name">VmManage</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> host<span class="token punctuation">,</span> user<span class="token punctuation">,</span> password<span class="token punctuation">,</span> port<span class="token punctuation">,</span> ssl<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>config <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>host <span class="token operator">=</span> host
        self<span class="token punctuation">.</span>user <span class="token operator">=</span> user
        self<span class="token punctuation">.</span>pwd <span class="token operator">=</span> password
        self<span class="token punctuation">.</span>port <span class="token operator">=</span> port
        self<span class="token punctuation">.</span>sslContext <span class="token operator">=</span> ssl
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>client <span class="token operator">=</span> SmartConnectNoSSL<span class="token punctuation">(</span>host<span class="token operator">=</span>host<span class="token punctuation">,</span>
                                            user<span class="token operator">=</span>user<span class="token punctuation">,</span>
                                            pwd<span class="token operator">=</span>password<span class="token punctuation">,</span>
                                            port<span class="token operator">=</span><span class="token number">443</span>
                                            <span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>content <span class="token operator">=</span> self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>RetrieveContent<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token boolean">True</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>result <span class="token operator">=</span> e

    <span class="token keyword">def</span> <span class="token function">wait_for_task</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">""" wait for a vCenter task to finish """</span>
        task_done <span class="token operator">=</span> <span class="token boolean">False</span>

        <span class="token keyword">while</span> <span class="token keyword">not</span> task_done<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"task.....%s "</span> <span class="token operator">%</span> task<span class="token punctuation">.</span>info<span class="token punctuation">.</span>state<span class="token punctuation">)</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> task<span class="token punctuation">.</span>info<span class="token punctuation">.</span>state <span class="token operator">==</span> <span class="token string">'success'</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token string">u'执行成功'</span><span class="token punctuation">,</span> <span class="token string">'status'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span>

            <span class="token keyword">if</span> task<span class="token punctuation">.</span>info<span class="token punctuation">.</span>state <span class="token operator">==</span> <span class="token string">'error'</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"there was an error"</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'message:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>task<span class="token punctuation">.</span>info<span class="token punctuation">.</span>error<span class="token punctuation">.</span>msg<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

                <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token string">'message'</span><span class="token punctuation">:</span> task<span class="token punctuation">.</span>info<span class="token punctuation">.</span>error<span class="token punctuation">.</span>msg<span class="token punctuation">,</span> <span class="token string">'status'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span>

    <span class="token keyword">def</span> <span class="token function">_get_all_objs</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obj_type<span class="token punctuation">,</span> folder<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        根据对象类型获取这一类型的所有对象
        """</span>
        <span class="token keyword">if</span> folder <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            container <span class="token operator">=</span> self<span class="token punctuation">.</span>content<span class="token punctuation">.</span>viewManager<span class="token punctuation">.</span>CreateContainerView<span class="token punctuation">(</span>self<span class="token punctuation">.</span>content<span class="token punctuation">.</span>rootFolder<span class="token punctuation">,</span> obj_type<span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            container <span class="token operator">=</span> self<span class="token punctuation">.</span>content<span class="token punctuation">.</span>viewManager<span class="token punctuation">.</span>CreateContainerView<span class="token punctuation">(</span>folder<span class="token punctuation">,</span> obj_type<span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> container<span class="token punctuation">.</span>view

    <span class="token keyword">def</span> <span class="token function">_get_obj</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obj_type<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        根据对象类型和名称来获取具体对象
        """</span>
        obj <span class="token operator">=</span> <span class="token boolean">None</span>
        content <span class="token operator">=</span> self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>RetrieveContent<span class="token punctuation">(</span><span class="token punctuation">)</span>
        container <span class="token operator">=</span> content<span class="token punctuation">.</span>viewManager<span class="token punctuation">.</span>CreateContainerView<span class="token punctuation">(</span>content<span class="token punctuation">.</span>rootFolder<span class="token punctuation">,</span> obj_type<span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> c <span class="token keyword">in</span> container<span class="token punctuation">.</span>view<span class="token punctuation">:</span>
            <span class="token keyword">if</span> c<span class="token punctuation">.</span>name <span class="token operator">==</span> name<span class="token punctuation">:</span>
                obj <span class="token operator">=</span> c
                <span class="token keyword">break</span>
        <span class="token keyword">return</span> obj

    <span class="token keyword">def</span> <span class="token function">add_disk</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> vm_obj<span class="token punctuation">,</span> capacity<span class="token punctuation">)</span><span class="token punctuation">:</span>
        spec <span class="token operator">=</span> vim<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>ConfigSpec<span class="token punctuation">(</span><span class="token punctuation">)</span>
        dev_changes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment"># capacity 为 存储盘容量将单位改为 G</span>
        new_disk_kb <span class="token operator">=</span> capacity <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span>
        unit_number <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token comment"># 遍历所有的硬件设备，找合适的位置添加</span>
        <span class="token keyword">for</span> dev <span class="token keyword">in</span> vm_obj<span class="token punctuation">.</span>config<span class="token punctuation">.</span>hardware<span class="token punctuation">.</span>device<span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>dev<span class="token punctuation">.</span>backing<span class="token punctuation">,</span> <span class="token string">'fileName'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                unit_number <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>dev<span class="token punctuation">.</span>unitNumber<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>
                <span class="token comment"># unit_number 7 reserved for scsi controller</span>
                <span class="token keyword">if</span> unit_number <span class="token operator">==</span> <span class="token number">7</span><span class="token punctuation">:</span>
                    unit_number <span class="token operator">+=</span> <span class="token number">1</span>
                <span class="token keyword">if</span> unit_number <span class="token operator">&gt;=</span> <span class="token number">16</span><span class="token punctuation">:</span>
                    logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'we don\'t support this many disks'</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> vim<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>device<span class="token punctuation">.</span>VirtualSCSIController<span class="token punctuation">)</span><span class="token punctuation">:</span>
                controller <span class="token operator">=</span> dev

        disk_spec <span class="token operator">=</span> vim<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>device<span class="token punctuation">.</span>VirtualDeviceSpec<span class="token punctuation">(</span><span class="token punctuation">)</span>
        disk_spec<span class="token punctuation">.</span>fileOperation <span class="token operator">=</span> <span class="token string">"create"</span>
        disk_spec<span class="token punctuation">.</span>operation <span class="token operator">=</span> vim<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>device<span class="token punctuation">.</span>VirtualDeviceSpec<span class="token punctuation">.</span>Operation<span class="token punctuation">.</span>add
        disk_spec<span class="token punctuation">.</span>device <span class="token operator">=</span> vim<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>device<span class="token punctuation">.</span>VirtualDisk<span class="token punctuation">(</span><span class="token punctuation">)</span>
        disk_spec<span class="token punctuation">.</span>device<span class="token punctuation">.</span>backing <span class="token operator">=</span> vim<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>device<span class="token punctuation">.</span>VirtualDisk<span class="token punctuation">.</span>FlatVer2BackingInfo<span class="token punctuation">(</span><span class="token punctuation">)</span>
        disk_spec<span class="token punctuation">.</span>device<span class="token punctuation">.</span>backing<span class="token punctuation">.</span>thinProvisioned <span class="token operator">=</span> <span class="token boolean">True</span>
        disk_spec<span class="token punctuation">.</span>device<span class="token punctuation">.</span>backing<span class="token punctuation">.</span>diskMode <span class="token operator">=</span> <span class="token string">'persistent'</span>

        disk_spec<span class="token punctuation">.</span>device<span class="token punctuation">.</span>unitNumber <span class="token operator">=</span> unit_number
        disk_spec<span class="token punctuation">.</span>device<span class="token punctuation">.</span>capacityInKB <span class="token operator">=</span> new_disk_kb
        disk_spec<span class="token punctuation">.</span>device<span class="token punctuation">.</span>controllerKey <span class="token operator">=</span> controller<span class="token punctuation">.</span>key
        dev_changes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>disk_spec<span class="token punctuation">)</span>
        spec<span class="token punctuation">.</span>deviceChange <span class="token operator">=</span> dev_changes
        task <span class="token operator">=</span> vm_obj<span class="token punctuation">.</span>ReconfigVM_Task<span class="token punctuation">(</span>spec<span class="token operator">=</span>spec<span class="token punctuation">)</span>
        result1 <span class="token operator">=</span> self<span class="token punctuation">.</span>wait_for_task<span class="token punctuation">(</span>task<span class="token punctuation">)</span>
        <span class="token keyword">if</span> result1<span class="token punctuation">[</span><span class="token string">'status'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token string">u'硬盘添加成功'</span><span class="token punctuation">,</span> <span class="token string">'result'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token string">u'硬盘添加失败: %s'</span> <span class="token operator">%</span> result1<span class="token punctuation">[</span><span class="token string">'message'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'result'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">}</span>
        <span class="token keyword">return</span> data

    <span class="token keyword">def</span> <span class="token function">change_vm_cpu_and_memory</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> vm_obj<span class="token punctuation">,</span> cpu<span class="token punctuation">,</span> memory <span class="token punctuation">)</span><span class="token punctuation">:</span>
        cspec <span class="token operator">=</span> vim<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>ConfigSpec<span class="token punctuation">(</span><span class="token punctuation">)</span>
        cspec<span class="token punctuation">.</span>numCPUs <span class="token operator">=</span> cpu
        <span class="token comment"># 将 4 核心分配在两个插槽，一个插槽两核心</span>
        <span class="token comment"># cspec.numCoresPerSocket = int(cspec.numCPUs / 2)</span>
        <span class="token comment"># 8G</span>
        cspec<span class="token punctuation">.</span>memoryMB <span class="token operator">=</span> <span class="token number">1024</span> <span class="token operator">*</span> memory
        <span class="token comment"># 启动 cpu 热添加</span>
        cspec<span class="token punctuation">.</span>cpuHotAddEnabled <span class="token operator">=</span> <span class="token boolean">True</span>
        <span class="token comment"># 启动内存在线扩缩</span>
        cspec<span class="token punctuation">.</span>memoryHotAddEnabled <span class="token operator">=</span> <span class="token boolean">True</span>
        task <span class="token operator">=</span> vm_obj<span class="token punctuation">.</span>Reconfigure<span class="token punctuation">(</span>cspec<span class="token punctuation">)</span>
        result1 <span class="token operator">=</span> self<span class="token punctuation">.</span>wait_for_task<span class="token punctuation">(</span>task<span class="token punctuation">)</span>
        <span class="token keyword">if</span> result1<span class="token punctuation">[</span><span class="token string">'status'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token string">u'cpu 和 内存变更成功'</span><span class="token punctuation">,</span> <span class="token string">'result'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token string">u'cpu 和 内存变更添加失败: %s'</span> <span class="token operator">%</span> result1<span class="token punctuation">[</span><span class="token string">'message'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'result'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">}</span>
        <span class="token keyword">return</span> data

    <span class="token keyword">def</span> <span class="token function">get_vm_ip</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> vm_obj <span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">""" 获取 VM 所有 IP 地址 """</span>
        ips <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> vm_obj<span class="token punctuation">.</span>guest<span class="token punctuation">.</span>net<span class="token punctuation">:</span>
            <span class="token keyword">if</span> i<span class="token punctuation">.</span>network<span class="token punctuation">:</span>
                <span class="token keyword">for</span> b <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> i<span class="token punctuation">.</span>ipAddress<span class="token punctuation">:</span>
                        ips<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>i<span class="token punctuation">.</span>ipAddress<span class="token punctuation">)</span>
                        <span class="token keyword">return</span> ips
                    <span class="token keyword">else</span><span class="token punctuation">:</span>
                        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"VM 没有获取到IP地址等待10秒"</span><span class="token punctuation">)</span>
                        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'VM 未配置网卡'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token string">'VM 未获取到IP地址,请检测网络状态或者 DHCP 服务器'</span>


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>cluster_name<span class="token punctuation">,</span> network_name<span class="token punctuation">,</span> template_name<span class="token punctuation">,</span> capacity<span class="token punctuation">,</span> cpu<span class="token punctuation">,</span>memory<span class="token punctuation">,</span> annotation<span class="token punctuation">,</span> datastore_name<span class="token punctuation">,</span> folder_name<span class="token punctuation">,</span>
         content_library_name<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token triple-quoted-string string">""" user为vSphere账户，password为密码， ip为登录地址， port为端口号 """</span>
    user <span class="token operator">=</span> <span class="token string">'Administrator@TEST-VSPHERE.COM'</span>
    ip <span class="token operator">=</span> <span class="token string">'192.168.3.100'</span>
    password <span class="token operator">=</span> <span class="token string">'123.com'</span>
    port <span class="token operator">=</span> <span class="token number">443</span>
    <span class="token comment"># 虚拟机名称为 vm- 加上 时间戳</span>
    vm_name <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"vm-</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>calendar<span class="token punctuation">.</span>timegm<span class="token punctuation">(</span>time<span class="token punctuation">.</span>gmtime<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>

    network_name <span class="token operator">=</span> get_vm_network<span class="token punctuation">(</span>network_name<span class="token punctuation">)</span>
    cluster_name <span class="token operator">=</span> get_vm_cluster_name<span class="token punctuation">(</span>cluster_name<span class="token punctuation">)</span>
    datastore_name <span class="token operator">=</span> get_vm_datastore_name<span class="token punctuation">(</span>datastore_name<span class="token punctuation">)</span>
    folder_name <span class="token operator">=</span> get_vm_folder_name<span class="token punctuation">(</span>folder_name<span class="token punctuation">)</span>
    template_name <span class="token operator">=</span> get_vm_template_name<span class="token punctuation">(</span>template_name<span class="token punctuation">)</span>

    vm_info <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"子网段"</span><span class="token punctuation">:</span> network_name<span class="token punctuation">,</span>
                <span class="token string">"集群名称"</span><span class="token punctuation">:</span> cluster_name<span class="token punctuation">,</span>
                <span class="token string">"datastore_name"</span><span class="token punctuation">:</span> datastore_name<span class="token punctuation">,</span>
                <span class="token string">"folder_name"</span><span class="token punctuation">:</span> folder_name<span class="token punctuation">,</span>
                <span class="token string">"template_name"</span><span class="token punctuation">:</span> template_name<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">"template_user"</span><span class="token punctuation">:</span> template_name<span class="token punctuation">[</span><span class="token string">'system_user'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">"template_pwd"</span><span class="token punctuation">:</span> template_name<span class="token punctuation">[</span><span class="token string">'system_pwd'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">"annotation"</span><span class="token punctuation">:</span> annotation<span class="token punctuation">,</span>
                <span class="token punctuation">}</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>vm_info<span class="token punctuation">)</span>


    <span class="token comment"># 记录当前时间</span>
    now <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># 通过 vsphere-automation-sdk 开始从内容库复制虚拟机</span>
        create_vm_01 <span class="token operator">=</span> create_vm<span class="token punctuation">(</span>user<span class="token punctuation">,</span> ip<span class="token punctuation">,</span> password<span class="token punctuation">,</span> network_name<span class="token punctuation">,</span> cluster_name<span class="token punctuation">,</span> datastore_name<span class="token punctuation">,</span> folder_name<span class="token punctuation">,</span>
                                content_library_name<span class="token punctuation">,</span> template_name<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> vm_name<span class="token punctuation">,</span> annotation<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>create_vm_01<span class="token punctuation">)</span>

        <span class="token comment"># pyvmomi 登录设备</span>
        vm <span class="token operator">=</span> VmManage<span class="token punctuation">(</span>host<span class="token operator">=</span>ip<span class="token punctuation">,</span>
                      user<span class="token operator">=</span>user<span class="token punctuation">,</span>
                      password<span class="token operator">=</span>password<span class="token punctuation">,</span>
                      port<span class="token operator">=</span>port<span class="token punctuation">,</span> ssl<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>

        vm_obj <span class="token operator">=</span> vm<span class="token punctuation">.</span>_get_obj<span class="token punctuation">(</span><span class="token punctuation">[</span>vim<span class="token punctuation">.</span>VirtualMachine<span class="token punctuation">]</span><span class="token punctuation">,</span> vm_name<span class="token punctuation">)</span>

        <span class="token comment"># 虚拟机添加硬盘</span>
        vm_obj_add_disk <span class="token operator">=</span> vm<span class="token punctuation">.</span>add_disk<span class="token punctuation">(</span>vm_obj<span class="token punctuation">,</span> capacity<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>vm_obj_add_disk<span class="token punctuation">)</span>

        <span class="token comment"># 改变虚拟机 cpu 和 内存</span>
        vm_obj_cpu_memory <span class="token operator">=</span> vm<span class="token punctuation">.</span>change_vm_cpu_and_memory<span class="token punctuation">(</span>vm_obj<span class="token punctuation">,</span> cpu<span class="token punctuation">,</span> memory<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>vm_obj_cpu_memory<span class="token punctuation">)</span>

        <span class="token comment"># 虚拟机开机,等待60秒,待虚拟机开机启动获取IP地址</span>
        task <span class="token operator">=</span> vm_obj<span class="token punctuation">.</span>PowerOn<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"启动 VM 电源"</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>wait_for_task<span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span>

        <span class="token comment"># 获取IP地址</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"开始获取 VM IP地址"</span><span class="token punctuation">)</span>
        vm_obj_ip <span class="token operator">=</span> vm<span class="token punctuation">.</span>get_vm_ip<span class="token punctuation">(</span>vm_obj<span class="token punctuation">)</span>
        <span class="token comment"># print(vm_obj_ip)</span>

        vm_uid <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>vm_obj<span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\''</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>

        results <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"errcode"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token string">"errmsg"</span><span class="token punctuation">:</span> <span class="token string">"ok"</span><span class="token punctuation">,</span>
            <span class="token string">'vm_id'</span><span class="token punctuation">:</span> vm_uid<span class="token punctuation">,</span>
            <span class="token string">'vm_name'</span><span class="token punctuation">:</span> vm_name<span class="token punctuation">,</span>
            <span class="token string">'ip_add'</span><span class="token punctuation">:</span> vm_obj_ip<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">'vm_user'</span><span class="token punctuation">:</span> template_name<span class="token punctuation">[</span><span class="token string">'system_user'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">'vm_password'</span><span class="token punctuation">:</span> template_name<span class="token punctuation">[</span><span class="token string">'system_pwd'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>

        <span class="token comment"># 计算虚拟机创建消耗时间</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> now<span class="token punctuation">)</span>

    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> err<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> err

    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token comment"># save_log(results)</span>
        <span class="token keyword">return</span> results



</code></pre> 
<h4><a id="_git_370"></a>安装依赖， 需要先安装git</h4> 
<pre><code class="prism language-python"><span class="token triple-quoted-string string">""" 安装依赖 """</span>
pip install requests
pip install urllib3
pip install chinesecalendar
pip install pyvmomi

<span class="token comment"># 安装SDK</span>
pip install <span class="token operator">-</span><span class="token operator">-</span>upgrade setuptools<span class="token operator">==</span><span class="token number">60.10</span><span class="token number">.0</span>
pip install <span class="token operator">-</span><span class="token operator">-</span>upgrade git<span class="token operator">+</span>https<span class="token punctuation">:</span><span class="token operator">//</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>vmware<span class="token operator">/</span>vsphere<span class="token operator">-</span>automation<span class="token operator">-</span>sdk<span class="token operator">-</span>python<span class="token punctuation">.</span>git
</code></pre> 
<p>笔者发现一个问题，通过pyvmomi修改虚拟机的IP地址后脚本没有问题，但是虚拟机IP地址未修改且网卡切换至未连接状态，研究了几天没有解决相关问题，只能妥协使用DHCP服务下发地址，如有大佬有相关解决方案可以给笔者一些建议跟思路。</p> 
<p>笔者脚本能力有限写的不好望大佬勿喷。</p> 
<p>参考：<br> https://github.com/vmware/pyvmomi-community-samples<br> https://github.com/vmware/vsphere-automation-sdk-python<br> https://juejin.cn/post/6844903870561271822</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/cae3453504ea8bb7057ac8496c217f6f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Atlassian应对CVE-2022-22963，CVE-2022-22965的常见问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ba501f7c98b5116fb54704a388509d5f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">JavaWeb14.购物车案例（上）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>