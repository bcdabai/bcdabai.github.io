<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>skynet设计原理和使用 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="skynet设计原理和使用" />
<meta property="og:description" content="skynet设计原理 一、多核并发编程方式二、skynet2.1、skynet简介2.2、环境准备2.3、编译安装2.4、Actor 模型2.5、消息队列2.6、actor公平调度 三、skynet的使用3.1、第一个skynet程序3.2、skynet网络消息3.3、skynet定时消息3.4、skynet actor间消息 四、vscode调试skynet总结 一、多核并发编程方式 （1）多线程。
在一个进程中开启多线程，为了充分利用多核，一般设置工作线程的个数为 cpu 的核心数。memcached 就是采用这种方式。
多线程在一个进程当中，所以数据共享来自进程当中的虚拟内存；这里会涉及到很多临界资源的访问，所以需要考虑加锁。
（2）多进程。
在一台机器当中，开启多个进程充分利用多核，一般设置工作进程的个数为 cpu 的核心数。nginx 就是采用这种方式，nginx 当中的 worker 进程，通过共享内存来进行共享数据；也需要考虑使用锁。
（3）CSP。
以 go 语言为代表，并发实体是协程（用户态线程、轻量级线程）；内部也是采用多少个核心开启多少个线程来充分利用多核。
（4）Actor。
erlang 从语言层面支持 actor 并发模型，并发实体是 actor（在skynet 中称之为服务）；skynet 采用 c &#43; lua来实现 actor 并发模型；底层也是通过采用多少个核心开启多少个内核线程来充分利用多核。
二、skynet 2.1、skynet简介 它是一个轻量级游戏服务器框架，但也不仅仅用于游戏。
轻量级体现在：
实现了 actor 模型，以及相关的脚手架（工具集）：actor 间数据共享机制以及c 服务扩展机制。实现了服务器框架的基础组件。实现了 reactor 并发网络库；并提供了大量连接的接入方案；基于自身网络库，实现了常用的数据库驱动（异步连接方案），并融合了 lua 数据结构；实现了网关服务；时间轮用于处理定时消息。 skynet抽象了actor并发模型，用户层抽象进程；sknet通过消息的方式共享内存；通过消息驱动actor运行。
skynet的actor模型使用lua虚拟，lua虚拟机非常小（只有几十kb），代价不高；每个actor对应一个lua虚拟机；系统中不能启动过多的进程就是因为资源受限，lua虚拟机占用的资源很少，可以开启很多个，这就能抽象出很多个用户层的进程。lua虚拟机可以共享一些数据，比如常量，达到资源复用。
抽象进程而不抽象线程的原因在于进程有独立的工作空间，隔离的运行环境。
sknet的所有actor都是对等的，通过公平调度实现。
2.2、环境准备 ubuntu：
sudo apt-get install git build-essential readline-dev autoconf # 或者 sudo apt-get install git build-essential libreadline-dev autoconf centos：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/08ff3fa7a3d57dc56eb52458a1cffe67/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-01T23:13:20+08:00" />
<meta property="article:modified_time" content="2023-02-01T23:13:20+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">skynet设计原理和使用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>skynet设计原理</h4> 
 <ul><li><a href="#_1" rel="nofollow">一、多核并发编程方式</a></li><li><a href="#skynet_14" rel="nofollow">二、skynet</a></li><li><ul><li><a href="#21skynet_15" rel="nofollow">2.1、skynet简介</a></li><li><a href="#22_28" rel="nofollow">2.2、环境准备</a></li><li><a href="#23_48" rel="nofollow">2.3、编译安装</a></li><li><a href="#24Actor__58" rel="nofollow">2.4、Actor 模型</a></li><li><a href="#25_70" rel="nofollow">2.5、消息队列</a></li><li><a href="#26actor_75" rel="nofollow">2.6、actor公平调度</a></li></ul> 
  </li><li><a href="#skynet_96" rel="nofollow">三、skynet的使用</a></li><li><ul><li><a href="#31skynet_98" rel="nofollow">3.1、第一个skynet程序</a></li><li><a href="#32skynet_174" rel="nofollow">3.2、skynet网络消息</a></li><li><a href="#33skynet_214" rel="nofollow">3.3、skynet定时消息</a></li><li><a href="#34skynet_actor_235" rel="nofollow">3.4、skynet actor间消息</a></li></ul> 
  </li><li><a href="#vscodeskynet_289" rel="nofollow">四、vscode调试skynet</a></li><li><a href="#_373" rel="nofollow">总结</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>一、多核并发编程方式</h2> 
<p>（1）多线程。<br> 在一个进程中开启多线程，为了充分利用多核，一般设置工作线程的个数为 cpu 的核心数。memcached 就是采用这种方式。<br> 多线程在一个进程当中，所以数据共享来自进程当中的虚拟内存；这里会涉及到很多临界资源的访问，所以需要考虑加锁。</p> 
<p>（2）多进程。<br> 在一台机器当中，开启多个进程充分利用多核，一般设置工作进程的个数为 cpu 的核心数。nginx 就是采用这种方式，nginx 当中的 worker 进程，通过共享内存来进行共享数据；也需要考虑使用锁。</p> 
<p>（3）CSP。<br> 以 go 语言为代表，并发实体是协程（用户态线程、轻量级线程）；内部也是采用多少个核心开启多少个线程来充分利用多核。</p> 
<p>（4）Actor。<br> erlang 从语言层面支持 actor 并发模型，并发实体是 actor（在skynet 中称之为服务）；skynet 采用 c + lua来实现 actor 并发模型；底层也是通过采用多少个核心开启多少个内核线程来充分利用多核。</p> 
<h2><a id="skynet_14"></a>二、skynet</h2> 
<h3><a id="21skynet_15"></a>2.1、skynet简介</h3> 
<p>它是一个轻量级游戏服务器框架，但也不仅仅用于游戏。<br> 轻量级体现在：</p> 
<ol><li>实现了 actor 模型，以及相关的脚手架（工具集）：actor 间数据共享机制以及c 服务扩展机制。</li><li>实现了服务器框架的基础组件。实现了 reactor 并发网络库；并提供了大量连接的接入方案；基于自身网络库，实现了常用的数据库驱动（异步连接方案），并融合了 lua 数据结构；实现了网关服务；时间轮用于处理定时消息。</li></ol> 
<p>skynet抽象了actor并发模型，用户层抽象进程；sknet通过消息的方式共享内存；通过消息驱动actor运行。</p> 
<p>skynet的actor模型使用lua虚拟，lua虚拟机非常小（只有几十kb），代价不高；每个actor对应一个lua虚拟机；系统中不能启动过多的进程就是因为资源受限，lua虚拟机占用的资源很少，可以开启很多个，这就能抽象出很多个用户层的进程。lua虚拟机可以共享一些数据，比如常量，达到资源复用。</p> 
<p>抽象进程而不抽象线程的原因在于进程有独立的工作空间，隔离的运行环境。</p> 
<p>sknet的所有actor都是对等的，通过公平调度实现。</p> 
<h3><a id="22_28"></a>2.2、环境准备</h3> 
<p>ubuntu：</p> 
<pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> <span class="token function">git</span> build-essential readline-dev autoconf
<span class="token comment"># 或者</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> <span class="token function">git</span> build-essential libreadline-dev autoconf
</code></pre> 
<p>centos：</p> 
<pre><code class="prism language-bash">yum <span class="token function">install</span> <span class="token parameter variable">-y</span> <span class="token function">git</span> gcc readline-devel autoconf
</code></pre> 
<p>mac：</p> 
<pre><code class="prism language-bash">yum <span class="token function">install</span> <span class="token parameter variable">-y</span> <span class="token function">git</span> gcc readline-devel autoconf
</code></pre> 
<h3><a id="23_48"></a>2.3、编译安装</h3> 
<pre><code class="prism language-bash"><span class="token function">git</span> clone https://github.com/cloudwu/skynet.git
<span class="token builtin class-name">cd</span> skynet
<span class="token comment"># centos or ubuntu</span>
<span class="token function">make</span> linux
<span class="token comment"># mac</span>
<span class="token function">make</span> macosx
</code></pre> 
<h3><a id="24Actor__58"></a>2.4、Actor 模型</h3> 
<p>有消息的 actor 为活跃的 actor，没有消息为非活跃的 actor。<br> <strong>定义：</strong></p> 
<ol><li>用于并行计算；</li><li>Actor 是最基本的计算单元；</li><li>基于消息计算；</li><li>Actor 通过消息进行沟通。</li></ol> 
<p><strong>组成：</strong></p> 
<ol><li>隔离的环境。主要通过 lua 虚拟机来实现。</li><li>消息队列。用来存放有序（先后到达）的消息。</li><li>回调函数。用来运行 Actor；从 Actor 的消息队列中取出消息，并作为该回调函数的参数来运行 Actor。</li></ol> 
<h3><a id="25_70"></a>2.5、消息队列</h3> 
<p>Actor 模型基于消息计算，在 skynet 框架中，消息包含 Actor（之间）消息、网络消息以及定时消息。</p> 
<p>生产者生产消息，消息放入消息队列中，由线程池去消费消息。</p> 
<h3><a id="26actor_75"></a>2.6、actor公平调度</h3> 
<p>所有的actor都是对等的，每个actor都有自己的消息队列；skynet的并发实体是actor，因此需要公平的调度actor。</p> 
<p>skynet会有非常的actor，公平调度就非常重要；采用两级队列。<br> 首先，查找活跃的消息队列（有消息的消息队列）；<br> 然后，通过队列组织所有活跃的消息队列；<br> 最后，调度队列。<br> <img src="https://images2.imgbox.com/0a/13/G4ha39ho_o.png" alt="actor_shc"><br> 线程池从一级队列取出一个消息，消费消息，消费完消息后如果还有消息，则添加到一级队列的末尾。</p> 
<p>因为用户问题造成消息不均匀，在应用上不一定公平；skynet在工作线程赋予权重来解决这个问题。</p> 
<pre><code class="prism language-c"><span class="token comment">// 工作线程权重图   32个核心</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> weight<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token comment">// 1/2</span>
    <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span>  <span class="token comment">// 1/4</span>
    <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 1/8</span>
</code></pre> 
<p>当工作线程的权重为 -1 时，该工作线程每次只 pop 一条消息；当工作线程的权重为 0 时，该工作线程每次消费完所有的消息；当工作线程的权重为 1 时，每次消费消息队列中二分之一的消息；当工作线程的权重为 2 时，每次消费消息队列中四分之一 的消息；以此类推；通过这种方式，完成消息队列梯度消费，从而不至于让某些队列过长。</p> 
<h2><a id="skynet_96"></a>三、skynet的使用</h2> 
<p>github 上打开 skynet 点击 <a href="https://github.com/cloudwu/skynet/wiki">wiki</a> 里面有所有函数的详细说明。</p> 
<h3><a id="31skynet_98"></a>3.1、第一个skynet程序</h3> 
<p>（1）在sknet源码的父目录下创建一个config文件，用于定制skynet的行为。<br> 内容可参考如下：</p> 
<pre><code class="prism language-bash"><span class="token assign-left variable">thread</span><span class="token operator">=</span><span class="token number">4</span>
<span class="token assign-left variable">logger</span><span class="token operator">=</span>nil
<span class="token assign-left variable">harbor</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token assign-left variable">start</span><span class="token operator">=</span><span class="token string">"main"</span>
<span class="token assign-left variable">lua_path</span><span class="token operator">=</span><span class="token string">"./skynet/lualib/?.lua;./skynet/lualib/?/init.lua;"</span>
<span class="token assign-left variable">luaservice</span><span class="token operator">=</span><span class="token string">"./skynet/service/?.lua;./app/?.lua"</span>
<span class="token assign-left variable">lualoader</span><span class="token operator">=</span><span class="token string">"./skynet/lualib/loader.lua"</span>
<span class="token assign-left variable">cpath</span><span class="token operator">=</span><span class="token string">"./skynet/cservice/?.so"</span>
<span class="token assign-left variable">lua_cpath</span><span class="token operator">=</span><span class="token string">"./skynet/luaclib/?.so"</span>
</code></pre> 
<p>参数说明：</p> 
<table><thead><tr><th>参数</th><th>作用</th></tr></thead><tbody><tr><td>thread</td><td>指定skynet开启的工作线程数量，一般为CPU的核心数</td></tr><tr><td>logger</td><td>log配置，指定为nil表示打印到控制台，指定文件名则写日志到指定文件</td></tr><tr><td>logpath</td><td>指定日志路径</td></tr><tr><td>harbor</td><td>集群相关的设置，设为0表示不使用集群</td></tr><tr><td>start</td><td>指定服务启动的抽象进程</td></tr><tr><td>lua_path</td><td>指定读取的lua路径</td></tr><tr><td>luaservice</td><td>lua抽象的进程，指定启动的lua路径</td></tr><tr><td>lualoader</td><td>lua加载的路径</td></tr><tr><td>cpath，lua_cpath</td><td>c语言写的进程路径</td></tr></tbody></table> 
<p>（2）在app文件下面创建main.lua。每次启动时都是从skynet.start(…)中运行，相当于入口函数。</p> 
<pre><code class="prism language-lua"><span class="token keyword">local</span> skynet <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"skynet"</span><span class="token punctuation">)</span>

skynet<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">-- body</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"hello skynet"</span><span class="token punctuation">)</span>
<span class="token keyword">end</span><span class="token punctuation">)</span>

</code></pre> 
<p>（3）编写一个自己项目的makefile。首先编译skynet的源码，如果有自己的c代码直接加入makefile文件。</p> 
<pre><code class="prism language-bash">SKYNET_PATH?<span class="token operator">=</span>./skynet

all:
	<span class="token builtin class-name">cd</span> <span class="token variable"><span class="token variable">$(</span>SKYNET_PATH<span class="token variable">)</span></span> <span class="token operator">&amp;&amp;</span> <span class="token variable"><span class="token variable">$(</span>MAKE<span class="token variable">)</span></span> <span class="token assign-left variable">PLAT</span><span class="token operator">=</span><span class="token string">'linux'</span>

clean:
	<span class="token builtin class-name">cd</span> <span class="token variable"><span class="token variable">$(</span>SKYNET_PATH<span class="token variable">)</span></span> <span class="token operator">&amp;&amp;</span> <span class="token variable"><span class="token variable">$(</span>MAKE<span class="token variable">)</span></span> clean
</code></pre> 
<p>（4）编译，执行自己的makefile。</p> 
<pre><code class="prism language-bash"><span class="token function">make</span>
</code></pre> 
<p>（5）执行skynet，指定config。</p> 
<pre><code class="prism language-bash">./skynet/skynet config
</code></pre> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>:00000002<span class="token punctuation">]</span> LAUNCH snlua bootstrap
<span class="token punctuation">[</span>:00000003<span class="token punctuation">]</span> LAUNCH snlua launcher
<span class="token punctuation">[</span>:00000004<span class="token punctuation">]</span> LAUNCH snlua cdummy
<span class="token punctuation">[</span>:00000005<span class="token punctuation">]</span> LAUNCH harbor <span class="token number">0</span> <span class="token number">4</span>
<span class="token punctuation">[</span>:00000006<span class="token punctuation">]</span> LAUNCH snlua datacenterd
<span class="token punctuation">[</span>:00000007<span class="token punctuation">]</span> LAUNCH snlua service_mgr
<span class="token punctuation">[</span>:00000008<span class="token punctuation">]</span> LAUNCH snlua main
hello skynet
<span class="token punctuation">[</span>:00000002<span class="token punctuation">]</span> KILL self

</code></pre> 
<p>可以看到打印了hello skynet。</p> 
<h3><a id="32skynet_174"></a>3.2、skynet网络消息</h3> 
<p>skynet 当中采用一个 socket 线程来处理网络信息；skynet 基于 reactor 网络模型。</p> 
<p>网络消息驱动actor运行。需要skynet.socket模块。<br> 首先绑定一个监听 listenfd，然后调用socket.start(listenfd, function)绑定fd到进程函数function中处理。</p> 
<p>示例：<br> main.lua</p> 
<pre><code class="prism language-lua"><span class="token keyword">local</span> skynet <span class="token operator">=</span> require <span class="token string">"skynet"</span>
<span class="token keyword">local</span> socket<span class="token operator">=</span>require <span class="token string">"skynet.socket"</span>


skynet<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">-- body</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"hello skynet"</span><span class="token punctuation">)</span>

    <span class="token keyword">local</span> listenfd<span class="token operator">=</span>socket<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span><span class="token number">8888</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    socket<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>clientfd<span class="token punctuation">,</span>addr<span class="token punctuation">)</span>
        <span class="token comment">-- body</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"receive a client: "</span><span class="token punctuation">,</span>clientfd<span class="token punctuation">,</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">end</span><span class="token punctuation">)</span>

<span class="token keyword">end</span><span class="token punctuation">)</span>

</code></pre> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>:00000002<span class="token punctuation">]</span> LAUNCH snlua bootstrap
<span class="token punctuation">[</span>:00000003<span class="token punctuation">]</span> LAUNCH snlua launcher
<span class="token punctuation">[</span>:00000004<span class="token punctuation">]</span> LAUNCH snlua cdummy
<span class="token punctuation">[</span>:00000005<span class="token punctuation">]</span> LAUNCH harbor <span class="token number">0</span> <span class="token number">4</span>
<span class="token punctuation">[</span>:00000006<span class="token punctuation">]</span> LAUNCH snlua datacenterd
<span class="token punctuation">[</span>:00000007<span class="token punctuation">]</span> LAUNCH snlua service_mgr
<span class="token punctuation">[</span>:00000008<span class="token punctuation">]</span> LAUNCH snlua main
hello skynet
<span class="token punctuation">[</span>:00000002<span class="token punctuation">]</span> KILL self
receive a client: 	<span class="token number">2</span>	<span class="token number">192.168</span>.0.105:50024

</code></pre> 
<h3><a id="33skynet_214"></a>3.3、skynet定时消息</h3> 
<p>定时任务推送给定时线程，定时线程检测完时间后往消息队列推送一个消息，然后actor开始执行callback函数。</p> 
<p>使用示例：<br> main.lua</p> 
<pre><code class="prism language-lua"><span class="token keyword">local</span> skynet <span class="token operator">=</span> require <span class="token string">"skynet"</span>


skynet<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">-- body</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"hello skynet"</span><span class="token punctuation">)</span>
    skynet<span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">-- body</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"timer 1s"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">end</span><span class="token punctuation">)</span>

<span class="token keyword">end</span><span class="token punctuation">)</span>

</code></pre> 
<h3><a id="34skynet_actor_235"></a>3.4、skynet actor间消息</h3> 
<p>所有的服务都是通过消息来交换数据。actor间消息通信通过将消息放到对方的消息队列实现。</p> 
<p>示例，创建两个lua文件。<br> main发送“ping”给slave，协程挂起；slave回复“pong”给main，协程唤醒。整个过程使用协程实现异步操作，消除异步中的回调。<br> main.lua</p> 
<pre><code class="prism language-lua"><span class="token keyword">local</span> skynet <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"skynet"</span><span class="token punctuation">)</span>

skynet<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">-- body</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"hello skynet"</span><span class="token punctuation">)</span>

    <span class="token keyword">local</span> slave<span class="token operator">=</span>skynet<span class="token punctuation">.</span><span class="token function">newservice</span><span class="token punctuation">(</span><span class="token string">"slave"</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span> response<span class="token operator">=</span>skynet<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>slave<span class="token punctuation">,</span><span class="token string">"lua"</span><span class="token punctuation">,</span><span class="token string">"ping"</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"main "</span><span class="token punctuation">,</span>response<span class="token punctuation">)</span>
<span class="token keyword">end</span><span class="token punctuation">)</span>
</code></pre> 
<p>slave.lua</p> 
<pre><code class="prism language-lua"><span class="token keyword">local</span> skynet <span class="token operator">=</span> require <span class="token string">"skynet"</span>

<span class="token keyword">local</span> CMD<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

<span class="token keyword">function</span> CMD<span class="token punctuation">.</span><span class="token function">ping</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">-- body</span>
    skynet<span class="token punctuation">.</span><span class="token function">retpack</span><span class="token punctuation">(</span><span class="token string">"pong"</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

skynet<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    skynet<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">"lua"</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span>source<span class="token punctuation">,</span>cmd<span class="token punctuation">,</span><span class="token punctuation">...</span><span class="token punctuation">)</span>
        <span class="token keyword">local</span> func<span class="token operator">=</span><span class="token function">assert</span><span class="token punctuation">(</span>CMD<span class="token punctuation">[</span>cmd<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">...</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span><span class="token punctuation">)</span>
<span class="token keyword">end</span><span class="token punctuation">)</span>
</code></pre> 
<p>执行效果：</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>:00000002<span class="token punctuation">]</span> LAUNCH snlua bootstrap
<span class="token punctuation">[</span>:00000003<span class="token punctuation">]</span> LAUNCH snlua launcher
<span class="token punctuation">[</span>:00000004<span class="token punctuation">]</span> LAUNCH snlua cdummy
<span class="token punctuation">[</span>:00000005<span class="token punctuation">]</span> LAUNCH harbor <span class="token number">0</span> <span class="token number">4</span>
<span class="token punctuation">[</span>:00000006<span class="token punctuation">]</span> LAUNCH snlua datacenterd
<span class="token punctuation">[</span>:00000007<span class="token punctuation">]</span> LAUNCH snlua service_mgr
<span class="token punctuation">[</span>:00000008<span class="token punctuation">]</span> LAUNCH snlua main
hello skynet
<span class="token punctuation">[</span>:00000009<span class="token punctuation">]</span> LAUNCH snlua slave
main    pong
<span class="token punctuation">[</span>:00000002<span class="token punctuation">]</span> KILL self
</code></pre> 
<h2><a id="vscodeskynet_289"></a>四、vscode调试skynet</h2> 
<p>首先要知道整个系统/框架 是怎么应用的。skynet会自己产生一个skynet执行程序，需要指定配置文件来启动服务。</p> 
<p>项目下的.vscode文件夹需要如下三个文件。</p> 
<p>launch.json</p> 
<pre><code class="prism language-bash"><span class="token punctuation">{<!-- --></span>
    <span class="token string">"version"</span><span class="token builtin class-name">:</span> <span class="token string">"0.2.0"</span>,
    <span class="token string">"configurations"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"启动 app"</span>,
            <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"cppdbg"</span>,
            <span class="token string">"request"</span><span class="token builtin class-name">:</span> <span class="token string">"launch"</span>,
            <span class="token string">"program"</span><span class="token builtin class-name">:</span> <span class="token string">"<span class="token variable">${workspaceFolder}</span>/skynet/skynet"</span>,
            <span class="token string">"args"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"config"</span><span class="token punctuation">]</span>,
            <span class="token string">"stopAtEntry"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"cwd"</span><span class="token builtin class-name">:</span> <span class="token string">"<span class="token variable">${workspaceFolder}</span>"</span>,
            <span class="token string">"environment"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>,
            <span class="token string">"externalConsole"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"MIMode"</span><span class="token builtin class-name">:</span> <span class="token string">"gdb"</span>,
            <span class="token string">"setupCommands"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token string">"description"</span><span class="token builtin class-name">:</span> <span class="token string">"为 gdb 启用整齐打印"</span>,
                    <span class="token string">"text"</span><span class="token builtin class-name">:</span> <span class="token string">"-enable-pretty-printing"</span>,
                    <span class="token string">"ignoreFailures"</span><span class="token builtin class-name">:</span> <span class="token boolean">true</span>
                <span class="token punctuation">}</span>,
                <span class="token punctuation">{<!-- --></span>
                    <span class="token string">"description"</span><span class="token builtin class-name">:</span> <span class="token string">"将反汇编风格设置为 Intel"</span>,
                    <span class="token string">"text"</span><span class="token builtin class-name">:</span> <span class="token string">"-gdb-set disassembly-flavor intel"</span>,
                    <span class="token string">"ignoreFailures"</span><span class="token builtin class-name">:</span> <span class="token boolean">true</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>,
            <span class="token string">"preLaunchTask"</span><span class="token builtin class-name">:</span> <span class="token string">"build-skynet"</span>,
            <span class="token string">"miDebuggerPath"</span><span class="token builtin class-name">:</span> <span class="token string">"/usr/bin/gdb"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>settings.json</p> 
<pre><code class="prism language-bash"><span class="token punctuation">{<!-- --></span>
    <span class="token string">"C_Cpp.default.configurationProvider"</span><span class="token builtin class-name">:</span> <span class="token string">"ms-vscode.makefile-tools"</span>,
    <span class="token string">"files.associations"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"string.h"</span><span class="token builtin class-name">:</span> <span class="token string">"c"</span>,
        <span class="token string">"stdlib.h"</span><span class="token builtin class-name">:</span> <span class="token string">"c"</span>,
        <span class="token string">"pthread.h"</span><span class="token builtin class-name">:</span> <span class="token string">"c"</span>
    <span class="token punctuation">}</span>,
<span class="token punctuation">}</span>
</code></pre> 
<p>tasks.json</p> 
<pre><code class="prism language-bash"><span class="token punctuation">{<!-- --></span>
    <span class="token string">"tasks"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"cppbuild"</span>,
            <span class="token string">"label"</span><span class="token builtin class-name">:</span> <span class="token string">"build-skynet"</span>,
            <span class="token string">"command"</span><span class="token builtin class-name">:</span> <span class="token string">"/usr/bin/make"</span>,
            <span class="token string">"args"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>,
            <span class="token string">"options"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"cwd"</span><span class="token builtin class-name">:</span> <span class="token string">"<span class="token variable">${workspaceFolder}</span>"</span>
            <span class="token punctuation">}</span>,
            <span class="token string">"problemMatcher"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token string">"<span class="token variable">$gcc</span>"</span>
            <span class="token punctuation">]</span>,
            <span class="token string">"group"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"kind"</span><span class="token builtin class-name">:</span> <span class="token string">"build"</span>,
                <span class="token string">"isDefault"</span><span class="token builtin class-name">:</span> <span class="token boolean">true</span>
            <span class="token punctuation">}</span>,
            <span class="token string">"detail"</span><span class="token builtin class-name">:</span> <span class="token string">"..."</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>,
    <span class="token string">"version"</span><span class="token builtin class-name">:</span> <span class="token string">"2.0.0"</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>实现这三个文件就可以开始调试了。<br> skynet是一个网络服务，需要处理网络连接，需要知道数据是怎么流向，理解框架的运行机制（多线程并发）；所有的actor的运行都是由线程池来驱动，actor的运行又是由消息队列的消息驱动（网络消息、定时消息、actor间消息）。</p> 
<p>线程池从消息队列中取出消息，找到回调函数，驱动actor运行。</p> 
<h2><a id="_373"></a>总结</h2> 
<ol><li> <p>不要通过共享内存来通信，而应该通过通信来共享内存。CSP 和 Actor 都符合这一哲学；通过通信来共享数据，其实是一种解耦合的过程。并lua发实体之间可以分别开发并单独优化，而它们唯一的耦合在于消息；这能让我们快速地进行开发；同时也符合我们开发的思路，将一个大的问题拆分成若干个小问题。</p> </li><li> <p>actor模型是在用户层抽象了进程。</p> </li><li> <p>actor调度：将活跃的 actor 通过全局队列组织起来；actor 当中的消息队列有消息就是活跃的 actor； 线程池去全局队列中取出 actor 的消息队列，接着运行actor。</p> </li></ol>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e0eaefa3bcca56c5e256689e576c22fe/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">capabilities 字段字段：V4L2设备具备的能力</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/60853d349bfee5e7a1aa392e4c9c8359/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">CentOS 7上进行gitlab的搭建</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>