<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>java byte数组异或校验时出现负数问题 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="java byte数组异或校验时出现负数问题" />
<meta property="og:description" content="简介 最近由于需要对接校园的刷卡机支付，协议需要用到异或校验。参照校验的流程对相邻数组进行异或，得出的结果却与示例的不一样，而且还是负数。 起先以为自己的算法或者数据有问题，但是检查了一遍后还是一样。
分析原因 由于协议中有字段表示的数值大于127，如协议中该字段16进制为0XA2，本来数值应该是162，结果转变成byte时变成了-94，异或校验后该字段的数值变为了负数，导致异或校验的结果不正确，这是因为java中的byte是有符号位的byte，这点和c&#43;&#43;不一样，因此可表示的数据为-127~127（最高位为符号位）。知道了原因，剩下的就是问题的解决了。
解决方法 既然是数值太大导致byte溢出了，那么只要解决溢出的问题就好了。在这里我们只关心校验的结果，因此把byte用int类型来表示就能解决数值的问题了。 可以将异或的结果使用int类型表示（这是为了防止结果出现负数）,在异或的过程中，将溢出的byte数据（即数值超出127的）通过&amp;0xff将符号为变成正数，同时由于byte保存不了变为正数的数据，需要分配一个临时变量来保存并参与运算。
以下为解决的代码：
/** 获取指令异或值 * @param datas * @return */ private int getXOR(byte[] datas) { int temp = datas[1]; // 此处首位取1是因为本协议中第一个数据不参数异或校验，转为int防止结果出现溢出变成负数 for (int i = 2; i &lt; datas.length; i&#43;&#43;) { int preTemp = temp; int iData; if (datas[i] &lt; 0) { iData = datas[i] &amp; 0xff; // 变为正数计算 } else { iData = datas[i]; } if (temp &lt; 0) { temp = temp &amp; 0xff; // 变为正数 } temp ^= iData; System." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/7fbcd3f97819d5b1b2c3803857aac0a4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-08-27T19:06:14+08:00" />
<meta property="article:modified_time" content="2018-08-27T19:06:14+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">java byte数组异或校验时出现负数问题</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3 id="简介">简介</h3> 
<p>最近由于需要对接校园的刷卡机支付，协议需要用到异或校验。参照校验的流程对相邻数组进行异或，得出的结果却与示例的不一样，而且还是负数。 <br> 起先以为自己的算法或者数据有问题，但是检查了一遍后还是一样。</p> 
<h3 id="分析原因">分析原因</h3> 
<p>由于协议中有字段表示的数值大于127，如协议中该字段16进制为0XA2，本来数值应该是162，结果转变成byte时变成了-94，异或校验后该字段的数值变为了负数，导致异或校验的结果不正确，<strong>这是因为java中的byte是有符号位的byte，这点和c++不一样，因此可表示的数据为-127~127（最高位为符号位）。知道了原因，剩下的就是问题的解决了。</strong></p> 
<h3 id="解决方法">解决方法</h3> 
<p>既然是数值太大导致byte溢出了，那么只要解决溢出的问题就好了。在这里我们只关心校验的结果，因此把byte用int类型来表示就能解决数值的问题了。 <br> 可以将异或的结果使用int类型表示（这是为了防止结果出现负数）,在异或的过程中，将溢出的byte数据（即数值超出127的）通过&amp;0xff将符号为变成正数，同时由于byte保存不了变为正数的数据，需要分配一个临时变量来保存并参与运算。</p> 
<p>以下为解决的代码：</p> 
<pre class="prettyprint"><code class=" hljs java"><span class="hljs-javadoc">/** 获取指令异或值
     *<span class="hljs-javadoctag"> @param</span> datas
     *<span class="hljs-javadoctag"> @return</span>
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getXOR</span>(<span class="hljs-keyword">byte</span>[] datas) {
        <span class="hljs-keyword">int</span> temp = datas[<span class="hljs-number">1</span>];              <span class="hljs-comment">// 此处首位取1是因为本协议中第一个数据不参数异或校验，转为int防止结果出现溢出变成负数</span>

        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">2</span>; i &lt; datas.length; i++) {
            <span class="hljs-keyword">int</span> preTemp = temp;
            <span class="hljs-keyword">int</span> iData;
            <span class="hljs-keyword">if</span> (datas[i] &lt; <span class="hljs-number">0</span>) {
                iData = datas[i] &amp; <span class="hljs-number">0xff</span>;      <span class="hljs-comment">// 变为正数计算</span>
            } <span class="hljs-keyword">else</span> {
                iData = datas[i];
            }
            <span class="hljs-keyword">if</span> (temp &lt; <span class="hljs-number">0</span>) {
                temp = temp &amp; <span class="hljs-number">0xff</span>;          <span class="hljs-comment">// 变为正数</span>
            }
            temp ^= iData;

            System.out.println(preTemp + <span class="hljs-string">"异或"</span> + iData + <span class="hljs-string">"="</span> + temp);
        }

        <span class="hljs-keyword">return</span> temp;
    }</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/df475e3f884f19f393c26cf1edfef193/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">vue 在使用element-ui时import &#39;element-ui/lib/theme-chalk/index.css‘时一直报错</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/27de7027074d7cca733ab8ae2290a3f4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">pdf.js详细解析</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>