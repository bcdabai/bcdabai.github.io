<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>CMU 15445 数据库设计 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="CMU 15445 数据库设计" />
<meta property="og:description" content="hash 扩容的过程就是针对每一个哈希值重新对第一维数组容量取余。
假设容量从8增加到16，那么原来3号槽位(011)保存的哈希值3(0x0011)和11(0x1011)被各自分配到3号和11号槽位。
特性： 如果采用高位进位的顺序遍历槽位，假设当前遍历到 110 这个槽位，这时从容量8扩容到容量16后，110槽位上所有的元素对应的新槽位是 0110 或1110，是相邻的，并且0110前的所有槽位在容量8时已经遍历完了
取余也可以理解为对二进制哈希值进行截取，比如截取i位作为槽位，导致多个哈希值对应一个槽位。另外可以让多个槽位对应一个桶，做法是继续对槽位进行截取，假设截取位数为 i j i_j ij​，那么最多有 2 ( i − i j ) 2^(i-i_j) 2(i−ij​)个槽位对应一个桶j。
插入导致桶j超过容量后，如果i= i j i_j ij​, 说明一个槽位对应一个桶，这时必须把第一位数组的容量翻倍，并且使i=i&#43;1;
当 i&gt; i j i_j ij​ 说明此时桶j对应多个槽位，此时不需要更新整个一位数组，只需要把桶j分成两个桶j和z, 且新 i j i_j ij​和 i z i_z iz​等于旧 i j i_j ij​&#43;1。
判断元素是否存在与hash表中，一个思路是使用bloom 过滤器，但是其不支持删除操作，因为(位图中一个bit位被多个元素公用，且不能确定被删除的元素是否在位图中)
C&#43;&#43;实现
void ExtendibleHash&lt;K, V&gt;::Insert(const K &amp;key, const V &amp;value) { _mtx.try_lock(); Node&lt;K,V&gt;* newNode=new Node&lt;K,V&gt;(key,value); size_t h=HashKey(key); // std::cout&lt;&lt;&#34;insert&#34;&lt;&lt;h&lt;&lt;&#34; &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/f744f485f17d0255621def3e754c94f3/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-06-09T09:59:05+08:00" />
<meta property="article:modified_time" content="2021-06-09T09:59:05+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">CMU 15445 数据库设计</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="hash_1"></a>hash</h2> 
<p>扩容的过程就是针对每一个哈希值重新对第一维数组容量取余。<br> 假设容量从8增加到16，那么原来3号槽位(011)保存的哈希值3(0x0011)和11(0x1011)被各自分配到3号和11号槽位。<br> 特性： 如果采用高位进位的顺序遍历槽位，假设当前遍历到 110 这个槽位，这时从容量8扩容到容量16后，110槽位上所有的元素对应的新槽位是 0110 或1110，是相邻的，并且0110前的所有槽位在容量8时已经遍历完了</p> 
<p><img src="https://images2.imgbox.com/3e/c0/WHIegxyL_o.png" alt="在这里插入图片描述"><br> 取余也可以理解为对二进制哈希值进行截取，比如截取i位作为槽位，导致多个哈希值对应一个槽位。另外可以让多个槽位对应一个桶，做法是继续对槽位进行截取，假设截取位数为<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          i 
         
        
          j 
         
        
       
      
        i_j 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.945628em; vertical-align: -0.286108em;"></span><span class="mord"><span class="mord mathdefault">i</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span style="margin-right: 0.05724em;" class="mord mathdefault mtight">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.286108em;"><span class=""></span></span></span></span></span></span></span></span></span></span>，那么最多有<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          2 
         
        
          ( 
         
        
       
         i 
        
       
         − 
        
        
        
          i 
         
        
          j 
         
        
       
         ) 
        
       
      
        2^(i-i_j) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.97133em; vertical-align: -0.08333em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.888em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mopen mtight">(</span></span></span></span></span></span></span></span><span class="mord mathdefault">i</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1.03611em; vertical-align: -0.286108em;"></span><span class="mord"><span class="mord mathdefault">i</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span style="margin-right: 0.05724em;" class="mord mathdefault mtight">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.286108em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>个槽位对应一个桶j。</p> 
<p>插入导致桶j超过容量后，如果i=<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          i 
         
        
          j 
         
        
       
      
        i_j 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.945628em; vertical-align: -0.286108em;"></span><span class="mord"><span class="mord mathdefault">i</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span style="margin-right: 0.05724em;" class="mord mathdefault mtight">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.286108em;"><span class=""></span></span></span></span></span></span></span></span></span></span>, 说明一个槽位对应一个桶，这时必须把第一位数组的容量翻倍，并且使i=i+1;</p> 
<p>当 i&gt;<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          i 
         
        
          j 
         
        
       
      
        i_j 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.945628em; vertical-align: -0.286108em;"></span><span class="mord"><span class="mord mathdefault">i</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span style="margin-right: 0.05724em;" class="mord mathdefault mtight">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.286108em;"><span class=""></span></span></span></span></span></span></span></span></span></span> 说明此时桶j对应多个槽位，此时不需要更新整个一位数组，只需要把桶j分成两个桶j和z, 且新<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          i 
         
        
          j 
         
        
       
      
        i_j 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.945628em; vertical-align: -0.286108em;"></span><span class="mord"><span class="mord mathdefault">i</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span style="margin-right: 0.05724em;" class="mord mathdefault mtight">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.286108em;"><span class=""></span></span></span></span></span></span></span></span></span></span>和<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          i 
         
        
          z 
         
        
       
      
        i_z 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.80952em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault">i</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span style="margin-right: 0.04398em;" class="mord mathdefault mtight">z</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>等于旧<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          i 
         
        
          j 
         
        
       
      
        i_j 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.945628em; vertical-align: -0.286108em;"></span><span class="mord"><span class="mord mathdefault">i</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span style="margin-right: 0.05724em;" class="mord mathdefault mtight">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.286108em;"><span class=""></span></span></span></span></span></span></span></span></span></span>+1。</p> 
<ul><li> <p>判断元素是否存在与hash表中，一个思路是使用bloom 过滤器，但是其不支持删除操作，因为(位图中一个bit位被多个元素公用，且不能确定被删除的元素是否在位图中)</p> </li><li> <p>C++实现</p> <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">ExtendibleHash</span><span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">&gt;</span><span class="token operator">::</span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token keyword">const</span> K <span class="token operator">&amp;</span>key<span class="token punctuation">,</span> <span class="token keyword">const</span> V <span class="token operator">&amp;</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        _mtx<span class="token punctuation">.</span><span class="token function">try_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">&gt;</span><span class="token operator">*</span> newNode<span class="token operator">=</span><span class="token keyword">new</span> Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">&gt;</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        size_t h<span class="token operator">=</span><span class="token function">HashKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        std::cout&lt;&lt;"insert"&lt;&lt;h&lt;&lt;" "&lt;&lt;std::endl;</span>
        size_t cutH<span class="token operator">=</span><span class="token function">CutBits</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span>_numBits<span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>BucketList<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">&gt;&gt;</span> sharedBucket<span class="token operator">=</span>_table<span class="token punctuation">[</span>cutH<span class="token punctuation">]</span><span class="token punctuation">;</span>
        BucketList<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">&gt;</span><span class="token operator">*</span> bucket <span class="token operator">=</span> sharedBucket<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">&gt;</span><span class="token operator">&amp;</span> result<span class="token operator">=</span>bucket<span class="token operator">-&gt;</span><span class="token function">_Find</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>next<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            result<span class="token punctuation">.</span>pre<span class="token operator">-&gt;</span>next<span class="token operator">=</span>newNode<span class="token punctuation">;</span>
            result<span class="token punctuation">.</span>next<span class="token operator">-&gt;</span>pre<span class="token operator">=</span>newNode<span class="token punctuation">;</span>
            newNode<span class="token operator">-&gt;</span>pre<span class="token operator">=</span>result<span class="token punctuation">.</span>pre<span class="token punctuation">;</span>
            newNode<span class="token operator">-&gt;</span>next<span class="token operator">=</span>result<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
            <span class="token keyword">delete</span> <span class="token operator">&amp;</span>result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            bucket<span class="token operator">-&gt;</span><span class="token function">PushBuck</span><span class="token punctuation">(</span><span class="token operator">*</span>newNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span><span class="token punctuation">(</span>bucket<span class="token operator">-&gt;</span>_count<span class="token operator">&gt;</span>bucket<span class="token operator">-&gt;</span>_capacity<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>bucket<span class="token operator">-&gt;</span>_numBits<span class="token operator">==</span>_numBits<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token function">DoubleSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">SplitBucket</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                    <span class="token function">SplitBucket</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
</code></pre> <pre><code class="prism language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">V</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token class-name">ExtendibleHash</span><span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">&gt;</span><span class="token operator">::</span><span class="token function">DoubleSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>BucketList<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">&gt;&gt;</span><span class="token operator">*</span> newTable<span class="token operator">=</span><span class="token keyword">new</span> std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>BucketList<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">&gt;&gt;</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span>_numBits<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span>_numBits<span class="token punctuation">)</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
       newTable<span class="token punctuation">[</span>i<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
       newTable<span class="token punctuation">[</span><span class="token punctuation">(</span>i<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   _numBits<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token comment">//    std::cout&lt;&lt;"double"&lt;&lt;" ";</span>
   <span class="token keyword">delete</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> _table<span class="token punctuation">;</span>
   _table<span class="token operator">=</span>newTable<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">V</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token class-name">ExtendibleHash</span><span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">&gt;</span><span class="token operator">::</span><span class="token function">SplitBucket</span><span class="token punctuation">(</span>BucketList<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">&gt;</span> <span class="token operator">*</span>bucket<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">//    std::cout&lt;&lt;"split"&lt;&lt;" ";</span>
   <span class="token keyword">int</span> oldBits<span class="token operator">=</span>bucket<span class="token operator">-&gt;</span>_numBits<span class="token punctuation">;</span>
   size_t  oldIndex<span class="token operator">=</span>bucket<span class="token operator">-&gt;</span>_tableIndex<span class="token punctuation">;</span>
   BucketList<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">&gt;</span><span class="token operator">*</span> newBucket<span class="token operator">=</span><span class="token keyword">new</span> BucketList<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">&gt;</span><span class="token punctuation">(</span>oldBits<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">(</span>oldIndex<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>BUCKET_LEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
   bucket<span class="token operator">-&gt;</span>_numBits<span class="token operator">=</span>oldBits<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
   bucket<span class="token operator">-&gt;</span>_tableIndex<span class="token operator">=</span>oldIndex<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">;</span>
   <span class="token keyword">for</span><span class="token punctuation">(</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">&gt;</span><span class="token operator">*</span> cur<span class="token operator">=</span>bucket<span class="token operator">-&gt;</span>head<span class="token punctuation">.</span>next<span class="token punctuation">;</span>cur<span class="token operator">-&gt;</span>next<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
       size_t h<span class="token operator">=</span><span class="token function">HashKey</span><span class="token punctuation">(</span>cur<span class="token operator">-&gt;</span>_key<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">auto</span> next<span class="token operator">=</span>cur<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
       <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">EndWithOne</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span>oldBits<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
           bucket<span class="token operator">-&gt;</span><span class="token function">UnLink</span><span class="token punctuation">(</span><span class="token operator">*</span>cur<span class="token punctuation">)</span><span class="token punctuation">;</span>
           newBucket<span class="token operator">-&gt;</span><span class="token function">PushBuck</span><span class="token punctuation">(</span><span class="token operator">*</span>cur<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//            std::cout&lt;&lt;"Trans"&lt;&lt;cur-&gt;_key&lt;&lt;" "&lt;&lt;std::endl;</span>
       <span class="token punctuation">}</span>
       cur<span class="token operator">=</span>next<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">int</span> sub<span class="token operator">=</span>_numBits<span class="token operator">-</span>oldBits<span class="token punctuation">;</span>
   std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>BucketList<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">&gt;&gt;</span> newShared_ptr<span class="token operator">=</span>std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>BucketList<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span>newBucket<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">for</span><span class="token punctuation">(</span>size_t i<span class="token operator">=</span>oldIndex<span class="token operator">&lt;&lt;</span>sub<span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">(</span>oldIndex<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>sub<span class="token punctuation">)</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
       <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span>sub<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
           _table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>newShared_ptr<span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> <span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <p>DoubleSize用于将一位数组的容量翻倍，SplitBucket用于将某一个桶分裂。<br> 实现过程需要注意遍历链表时对链表元素进行删除的情况，会导致找不到下一个元素。</p> </li></ul> 
<h2><a id="_94"></a>储存和索引</h2> 
<ul><li> <p>LRU (least recently used )<br> 维护一个链表，假设链表节点node储存的值为v, 以v为key，node为value创建一个hash表。删除链表首节点的同时删除hash表对应的元素。如果要删除任意v值，首先通过hash表找到对应的节点，然后从链表中删除。</p> </li><li> <p>bufferPool</p> <pre><code class="prism language-cpp">Page <span class="token operator">*</span><span class="token class-name">BufferPoolManager</span><span class="token operator">::</span><span class="token function">FetchPage</span><span class="token punctuation">(</span>page_id_t page_id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   Page<span class="token operator">*</span> result<span class="token punctuation">;</span>
   <span class="token keyword">bool</span> flag<span class="token operator">=</span>page_table_<span class="token operator">-&gt;</span><span class="token function">Find</span><span class="token punctuation">(</span>page_id<span class="token punctuation">,</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
       result<span class="token operator">-&gt;</span>pin_count_<span class="token operator">++</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> result<span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
       <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>free_list_<span class="token operator">-&gt;</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
           result<span class="token operator">=</span>free_list_<span class="token operator">-&gt;</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           free_list_<span class="token operator">-&gt;</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           disk_manager_<span class="token operator">-&gt;</span><span class="token function">ReadPage</span><span class="token punctuation">(</span>page_id<span class="token punctuation">,</span>result<span class="token operator">-&gt;</span><span class="token function">GetData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           result<span class="token operator">-&gt;</span>pin_count_<span class="token operator">++</span><span class="token punctuation">;</span>
           result<span class="token operator">-&gt;</span>page_id_<span class="token operator">=</span>page_id<span class="token punctuation">;</span>
           page_table_<span class="token operator">-&gt;</span><span class="token function">Insert</span><span class="token punctuation">(</span>page_id<span class="token punctuation">,</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">return</span> result<span class="token punctuation">;</span>
       <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
           <span class="token keyword">if</span><span class="token punctuation">(</span>replacer_<span class="token operator">-&gt;</span><span class="token function">Victim</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
               <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token operator">-&gt;</span>is_dirty_<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                   disk_manager_<span class="token operator">-&gt;</span><span class="token function">WritePage</span><span class="token punctuation">(</span>result<span class="token operator">-&gt;</span>page_id_<span class="token punctuation">,</span>result<span class="token operator">-&gt;</span><span class="token function">GetData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                   page_table_<span class="token operator">-&gt;</span><span class="token function">Remove</span><span class="token punctuation">(</span>result<span class="token operator">-&gt;</span><span class="token function">GetPageIvcd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                   disk_manager_<span class="token operator">-&gt;</span><span class="token function">ReadPage</span><span class="token punctuation">(</span>page_id<span class="token punctuation">,</span>result<span class="token operator">-&gt;</span><span class="token function">GetData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                   result<span class="token operator">-&gt;</span>pin_count_<span class="token operator">++</span><span class="token punctuation">;</span>
                   result<span class="token operator">-&gt;</span>page_id_<span class="token operator">=</span>page_id<span class="token punctuation">;</span>
                   page_table_<span class="token operator">-&gt;</span><span class="token function">Insert</span><span class="token punctuation">(</span>page_id<span class="token punctuation">,</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                   <span class="token keyword">return</span> result<span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <p>以page单位管理内存到磁盘的映射。磁盘中的每个page有一个page_id。 给一定数量的磁盘page分配了内存Page。 用户想访问某个id对应的磁盘page时，可以转而访问对应的内存Page。两者的映射保存在HashTable&lt;page_id_t, Page *&gt;。 freelist中保存的是尚未分配的内存Page，Replacer&lt;Page *&gt; 保存的是hashtable中标记次数为0的内存page(有点类似于引用计数)。如果freelist不够的时候就从replacer中按照LRU选出一个内存page，把它写回磁盘(s_dirty标记决定是否写回)后分配给新的磁盘page。</p> </li><li> <p>使用列式储存的好处，方便cpu进行缓存，提高压缩效率，减少i/o次数，因为可以不用取回不需要的列，方便cpu进行向量化处理。</p> </li><li> <p>行式储存中，一条记录存在一个tuple中，各个列的值value被拼接在一起。对于变长的value，例如字符串，在value前面保存它的长度。首先用变长value在tuple中的偏移量替代它们并把它们和固定长度的value拼接在一起，然后紧接着保存变长value的具体值。</p> </li><li> <p>tuple在一个page中的储存形式：首先保存元信息，比如page_id，next_page_id,pre_page_id，tuple数量以及空闲空间起始偏移位置，之后是各个tuple的偏移以及长度。然后从后往前保存各个tuple的数据。每个tuple在插入到page的时候分配了一个固定的rid，由page_id和slot_num组成，可以用slot_num来检索元信息。删除某个tuple时，需要将偏移量在它之前的所有tuple往后移以填补它的空缺，保留其slot_num，但是需要将其在元信息中的偏移和长度置零。在下次插入的时候，可以重复利用这个slot_num, 然后在空闲空间分配新的空间。也就是说，slot_num的顺序并不代表tuple在空间上的顺序。</p> </li><li> <p>table_heap负责管理和连接page, 当往当前cur_page插入一个tuple时，如果空间不够，table_heap会访问cur_page中记录的下一个page，直到找到一个拥有足够空间的。如果此时cur_page没有next_page记录，table_heap会从buffer_pool中new一个给它。插入一个tuple，page的引用计数会加1，反之会减1。初始的cur_page对应table_heap中的first_page_id。table_heap还负责把这些用于储存page的table_page用pre_page_id和next_page_id连接起来。</p> </li><li> <p>table_iterator 负责遍历table_heap管理的所有page里的tuple.</p> </li><li> <p>b+树的每个page中用一个array来保存key/value对，internal_page中array[0]的key是没用的，而leaf_page中array[0]的key是有用的。</p> </li><li> <p>insert实现<br> b+树中每一个节点占用一个page，由于叶子节点储存的value是RID类型，内部节点储存的value是pafe_id类型,所以需要分开实现两个类。然后用一个tree类型来管理这些节点（申请和使用page），并实现插入操作。直接把键值对插入叶子节点，和因上溢把键值插入内部节点所引发的后续操作不同，对此在tree类型中分别实现两个成员函数InsertIntoLeaf和InsertToParentWithIndex。每次insert操作，先调用InsertIntoLeaf, 其内部如果发生上溢会调用InsertToParentWithIndex，如果内部节点也发生了上溢，会递归的调用InsertToParentWithIndex。<br> 坑点：对于内部节点，分裂后转移到新节点上的子节点，需要修改他们的父节点为新节点。 对于叶子节点，分裂后需要分别更新老节点和新节点的next_page_id属性。内部节点的键值对数量必须大于等于2，叶子节点的键值对数量必须大于等于1，这样才能保证按键值检索的正确性。节点包含键值对数量的最大值应该考虑，插入时溢出，但是还未进行分裂的情况，所以需要预留一个空位。</p> </li><li> <p>delete 实现<br> 当节点内键值对数量大于等于最大容量的1/2时，称其满足填充因子。在删除过程中，一层内只可能有一个节点不满足填充因子，所以不满足填充因子的节点一定可以从其邻居节点借一个节点从而满足，或者和邻居节点合并。没有邻居节点的节点一定是根节点。坑点：合并节点的时候使用MoveAllTo函数把当前节点的剩余键值对全部移到左邻居或右邻居。和分裂时使用的MoveHalfTo不同，这里不是把关键值移到一个新节点，而是插入已经有关键值存在的左右邻居。所以针对左右邻居，需要考虑从末尾插入和从开头插入的不同。删除根节点后，除了更新树的根节点外，还需要更新其子节点的父节点为INVALID_PAGE_ID。通过一个unpin(page_id)函数来通知buffer_pool把第page_id页加入LRU队列。除了手工调用unpin之外，还可以通过shared_ptr在page退出作用域是自动调用unpin。做法是初始化shared_ptr时同时传入一个deleter对象：</p> <pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">Deleter</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">explicit</span> <span class="token function">Deleter</span><span class="token punctuation">(</span>BufferPoolManager <span class="token operator">*</span> buffer_pool_manager<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        buffer_pool_manager_<span class="token operator">=</span>buffer_pool_manager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token keyword">operator</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>BPlusTreePage<span class="token operator">*</span> page<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        std<span class="token operator">::</span>cout<span class="token operator">&lt;&lt;</span><span class="token string">"unpin__"</span><span class="token operator">&lt;&lt;</span>page<span class="token operator">-&gt;</span><span class="token function">GetPageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
        buffer_pool_manager_<span class="token operator">-&gt;</span><span class="token function">UnpinPage</span><span class="token punctuation">(</span>page<span class="token operator">-&gt;</span><span class="token function">GetPageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    BufferPoolManager <span class="token operator">*</span>buffer_pool_manager_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <p>从buffer_pool中申请新page之后，一定要清空里面的data.</p> </li><li> <p>LRUreplacer<br> LRUreplacer是buffer_pool的成员，其负责LRU算法的实现，其内部维护一个链表，pre和next等指针全部是智能指针，为了防止析构时发生死锁，先正序遍历一次把next指针清空，然后倒序把pre指针清空。</p> </li></ul> 
<h2><a id="_168"></a>并发控制</h2> 
<ul><li> <p>b+树并发<br> 按照课程提供的文件，每个page有两个锁，writer_entered_属性记录当前页上是否有写锁，reader_count_记录page上读锁的数量。读锁有一个最大数量。在申请写锁时，必须满足writer_entered_为false和reader_count_==0两个条件，并且分别用while语句包围起来，一但不满足其中的一个就会利用条件变量进入阻塞状态。<br> 有以下几种情况需要唤醒等待的信号量，释放读锁时，当读锁数量为0时唤醒一个申请写锁的线程，当读锁数量为最大值减1时唤醒一个申请读锁的线程，释放写锁时，唤醒所有申请读锁和写锁的进程。 除开第一种情况，其它情况共用一个信号量。</p> <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">WLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   std<span class="token operator">::</span>unique_lock<span class="token operator">&lt;</span>mutex_t<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">while</span> <span class="token punctuation">(</span>writer_entered_ <span class="token operator">||</span> reader_count_ <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">||</span> crab_entered_<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
       <span class="token keyword">if</span><span class="token punctuation">(</span>writer_entered_ <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
           writer_release_<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>

       <span class="token keyword">if</span><span class="token punctuation">(</span>crab_entered_<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
           crab_release_<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">if</span><span class="token punctuation">(</span>reader_count_ <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
           reader_to_zero_<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>

   <span class="token punctuation">}</span>
   writer_entered_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

 <span class="token keyword">void</span> <span class="token function">WUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

   std<span class="token operator">::</span>lock_guard<span class="token operator">&lt;</span>mutex_t<span class="token operator">&gt;</span> <span class="token function">guard</span><span class="token punctuation">(</span>mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//      static long lock_count=0;</span>
<span class="token comment">//      std::cout&lt;&lt;std::this_thread::get_id()&lt;&lt;" "&lt;&lt;lock_count++&lt;&lt;std::endl;</span>
   <span class="token function">assert</span><span class="token punctuation">(</span> writer_entered_ <span class="token punctuation">)</span><span class="token punctuation">;</span>
   writer_entered_ <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
   writer_release_<span class="token punctuation">.</span><span class="token function">notify_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

 <span class="token keyword">void</span> <span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   std<span class="token operator">::</span>unique_lock<span class="token operator">&lt;</span>mutex_t<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">while</span> <span class="token punctuation">(</span>writer_entered_ <span class="token operator">||</span> reader_count_ <span class="token operator">==</span> max_readers_<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
       <span class="token keyword">if</span><span class="token punctuation">(</span>writer_entered_<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
           writer_release_<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">if</span><span class="token punctuation">(</span>reader_count_ <span class="token operator">==</span> max_readers_<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
           reader_to_max_sub_1<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   reader_count_<span class="token operator">++</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

 <span class="token keyword">void</span> <span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   std<span class="token operator">::</span>lock_guard<span class="token operator">&lt;</span>mutex_t<span class="token operator">&gt;</span> <span class="token function">guard</span><span class="token punctuation">(</span>mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">assert</span><span class="token punctuation">(</span>reader_count_<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   reader_count_<span class="token operator">--</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>reader_count_ <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       reader_to_zero_<span class="token punctuation">.</span><span class="token function">notify_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>reader_count_ <span class="token operator">==</span> max_readers_ <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
       reader_to_max_sub_1<span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

 <span class="token punctuation">}</span>

   <span class="token keyword">void</span> <span class="token function">CLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       std<span class="token operator">::</span>unique_lock<span class="token operator">&lt;</span>mutex_t<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token keyword">while</span> <span class="token punctuation">(</span>writer_entered_ <span class="token operator">||</span> crab_entered_<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
           <span class="token keyword">if</span><span class="token punctuation">(</span>writer_entered_ <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
               writer_release_<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
           <span class="token keyword">if</span><span class="token punctuation">(</span>crab_entered_<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
              crab_release_<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
       crab_entered_<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">void</span> <span class="token function">CUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       std<span class="token operator">::</span>lock_guard<span class="token operator">&lt;</span>mutex_t<span class="token operator">&gt;</span> <span class="token function">guard</span><span class="token punctuation">(</span>mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">assert</span><span class="token punctuation">(</span>crab_entered_<span class="token punctuation">)</span><span class="token punctuation">;</span>
       crab_entered_<span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
       crab_release_<span class="token punctuation">.</span><span class="token function">notify_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">void</span> <span class="token function">TransCrab</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
       std<span class="token operator">::</span>unique_lock<span class="token operator">&lt;</span>mutex_t<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">assert</span><span class="token punctuation">(</span>crab_entered_ <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>writer_entered_<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">while</span><span class="token punctuation">(</span>reader_count_<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
           reader_to_zero_<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       writer_entered_<span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
       crab_entered_<span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
       crab_release_<span class="token punctuation">.</span><span class="token function">notify_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">bool</span> <span class="token function">CheckFree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
     <span class="token keyword">return</span> <span class="token operator">!</span>crab_entered_ <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>writer_entered_ <span class="token operator">&amp;&amp;</span> reader_count_ <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre> <p>当使用蟹行锁后，需要增加一个可变锁，它和读锁相容但和自身以及写锁不相容，所以可变锁释放时需要唤醒申请写锁和其它可变锁的线程。所有需要唤醒的情况使用各自单独的信号量，为了防止等待第二个条件的时候，本来已经满足的第一条件又被其它线程修改，所以把所有条件判断语句写在一个while里。使用自带的header_page当做根节点的前哨节点，要读取或修改根节点时必须先获取前哨节点的锁，这样做可以把根节点和其它内部以及叶节点的操作统一起来。当前线程获得某一节点的写锁后，马上把这个节点压入线程对应的transaction中的队列里，等到当前线程的插入或删除操作完成后再按压入顺序的相反顺序释放锁。</p> <p>当插入一颗空树时，为了避免直接加锁降低并发性，先检查树是否为空，之后再获取全局锁。 获取锁之后，再检查一次树是否为空，如果不为空就直接返回，否则修改根节点。</p> <pre><code class="prism language-cpp"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    rootLatch_<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        rootLatch_<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">auto</span> page <span class="token operator">=</span> buffer_pool_manager_<span class="token operator">-&gt;</span><span class="token function">FetchPage</span><span class="token punctuation">(</span>HEADER_PAGE_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
        page<span class="token operator">-&gt;</span><span class="token function">WLatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">StartNewTree</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>value<span class="token punctuation">,</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
        page<span class="token operator">-&gt;</span><span class="token function">WUnlatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        buffer_pool_manager_<span class="token operator">-&gt;</span><span class="token function">UnpinPage</span><span class="token punctuation">(</span>HEADER_PAGE_ID<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rootLatch_<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <p>坑点： 锁释放的时候使用notify_all()更加保险，确保所有需要唤醒的线程能够接收到信号，否则陷入死锁。REMOVE函数中对某一节点的deletepage操作需要留到该节点的写锁释放后再进行。为了防止写锁释放后又有其它线程获得锁，保留transaction队列中的第一个元素(所有获得写锁节点中高度最高的)，等到所有deletepage操作完成之后在释放该节点的写锁：</p> <pre><code class="prism language-cpp">    page_id_t predecessor<span class="token punctuation">;</span>
<span class="token keyword">int</span> PageSetSize<span class="token operator">=</span>transaction<span class="token operator">-&gt;</span><span class="token function">GetPageSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>PageSetSize<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    predecessor<span class="token operator">=</span>transaction<span class="token operator">-&gt;</span><span class="token function">GetPageSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">GetPageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    transaction<span class="token operator">-&gt;</span><span class="token function">GetPageSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">WUnlatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    transaction<span class="token operator">-&gt;</span><span class="token function">GetPageSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">pop_back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    buffer_pool_manager_<span class="token operator">-&gt;</span><span class="token function">UnpinPage</span><span class="token punctuation">(</span>predecessor<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">auto</span> it<span class="token operator">=</span>transaction<span class="token operator">-&gt;</span><span class="token function">GetDeletedPageSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    it<span class="token operator">!=</span>transaction<span class="token operator">-&gt;</span><span class="token function">GetDeletedPageSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>it<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    buffer_pool_manager_<span class="token operator">-&gt;</span><span class="token function">DeletePage</span><span class="token punctuation">(</span><span class="token operator">*</span>it<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">assert</span><span class="token punctuation">(</span>transaction<span class="token operator">-&gt;</span><span class="token function">GetPageSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
predecessor<span class="token operator">=</span>transaction<span class="token operator">-&gt;</span><span class="token function">GetPageSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">GetPageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
transaction<span class="token operator">-&gt;</span><span class="token function">GetPageSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">WUnlatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
transaction<span class="token operator">-&gt;</span><span class="token function">GetPageSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">pop_back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">assert</span><span class="token punctuation">(</span>transaction<span class="token operator">-&gt;</span><span class="token function">GetPageSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
buffer_pool_manager_<span class="token operator">-&gt;</span><span class="token function">UnpinPage</span><span class="token punctuation">(</span>predecessor<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <p>remove函数中，第一次判断树不为空的结果可能其他线程修改，要等到真正拿到哨兵节点的锁后再判断一次。调用delete删除某页时，该页可能正好处在被其它线程释放锁，但是没有unpin的状态。</p> </li></ul> 
<h2><a id="_311"></a>锁管理</h2> 
<p>lock_manager负责处理每个事务的共享锁申请，排他锁申请，锁升级和解锁操作。使用的方法是每个事务所在的线程，调用lock_manager的函数，并且传入事务指针以及元组的索引对象rid。 lock_manager内部维护一个把rid映射到事务队列的map，在每个队列中既有等待锁的事务，也有已经申请到锁的事务。每个队列中第一个事务一定是已近申请到锁的事务，如果第一个事务申请的是共享锁，那么从它开始到第一个申请排他锁的事务之前，所有的事务都是已经申请到锁的。 为了区分每个事务对应某个rid到底申请的是共享还是排他锁，在transaction头文件中定义两个集合，分别表示该事务申请的排它锁和共享锁对应的rid的集合。为了方便单独阻塞和唤醒每个等待锁的事务，在transaction头文件中定义条件变量。为了满足2PL二段锁协议，申请锁时事务应处在growing状态，否则abort当前事务。在锁升级时如果当前事务已经拥有或在等待排他锁，也会引发abort。 在abort之前，需要释放改transaction拥有和等待的所有锁，并且唤醒等待这些锁的其它事务。</p> 
<p>注意：必须通过引用的方式从map中拿到事务队列。在升级锁时，只有当前事务在队首，并且第二个事务申请的是排它锁或者没有第二个事务时，才能在原地将当前事务的锁升级为排它锁，否则需要将事务移到第一个申请排它锁的事务之前。</p> 
<ul><li> <p>unlock 函数：</p> <pre><code class="prism language-cpp"><span class="token keyword">bool</span> <span class="token class-name">LockManager</span><span class="token operator">::</span><span class="token function">Unlock</span><span class="token punctuation">(</span>Transaction <span class="token operator">*</span>txn<span class="token punctuation">,</span> <span class="token keyword">const</span> RID <span class="token operator">&amp;</span>rid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token operator">::</span>unique_lock<span class="token operator">&lt;</span>mutex_t<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>strict_2PL_<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>txn<span class="token operator">-&gt;</span><span class="token function">GetState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span>TransactionState<span class="token operator">::</span>COMMITTED<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">Release</span><span class="token punctuation">(</span>txn<span class="token punctuation">)</span><span class="token punctuation">;</span>
            txn<span class="token operator">-&gt;</span><span class="token function">SetState</span><span class="token punctuation">(</span>TransactionState<span class="token operator">::</span>ABORTED<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>txn<span class="token operator">-&gt;</span><span class="token function">GetState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span>TransactionState<span class="token operator">::</span>GROWING<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            txn<span class="token operator">-&gt;</span><span class="token function">SetState</span><span class="token punctuation">(</span>TransactionState<span class="token operator">::</span>SHRINKING<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>txn<span class="token operator">-&gt;</span><span class="token function">GetState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span>TransactionState<span class="token operator">::</span>SHRINKING <span class="token operator">&amp;&amp;</span>
           txn<span class="token operator">-&gt;</span><span class="token function">GetState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span>TransactionState<span class="token operator">::</span>COMMITTED <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">Release</span><span class="token punctuation">(</span>txn<span class="token punctuation">)</span><span class="token punctuation">;</span>
            txn<span class="token operator">-&gt;</span><span class="token function">SetState</span><span class="token punctuation">(</span>TransactionState<span class="token operator">::</span>ABORTED<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">auto</span> it<span class="token operator">=</span>rid_to_queue<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>rid<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>it<span class="token operator">!=</span>rid_to_queue<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        std<span class="token operator">::</span>list<span class="token operator">&lt;</span>Transaction <span class="token operator">*</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> wait_queue<span class="token operator">=</span>it<span class="token operator">-&gt;</span>second<span class="token punctuation">;</span>
        <span class="token keyword">auto</span> queue_it<span class="token operator">=</span>wait_queue<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> first<span class="token operator">=</span><span class="token operator">*</span>queue_it<span class="token punctuation">;</span>
        <span class="token keyword">auto</span> second<span class="token operator">=</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">++</span>queue_it<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>txn<span class="token operator">-&gt;</span><span class="token function">GetExclusiveLockSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">find</span><span class="token punctuation">(</span>rid<span class="token punctuation">)</span><span class="token operator">!=</span>txn<span class="token operator">-&gt;</span><span class="token function">GetExclusiveLockSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">// exclusive lock  which ready to unlock  must  be the first element in the queue</span>
            <span class="token function">assert</span><span class="token punctuation">(</span>first<span class="token operator">==</span>txn<span class="token punctuation">)</span><span class="token punctuation">;</span>
            txn<span class="token operator">-&gt;</span><span class="token function">GetExclusiveLockSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">erase</span><span class="token punctuation">(</span>rid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            wait_queue<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span>queue_it<span class="token operator">!=</span>wait_queue<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>queue_it<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">auto</span> cur<span class="token operator">=</span><span class="token operator">*</span>queue_it<span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>cur<span class="token operator">-&gt;</span><span class="token function">GetExclusiveLockSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">find</span><span class="token punctuation">(</span>rid<span class="token punctuation">)</span><span class="token operator">!=</span>cur<span class="token operator">-&gt;</span><span class="token function">GetExclusiveLockSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    cur<span class="token operator">-&gt;</span>lock_available_<span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                    cur<span class="token operator">-&gt;</span>lock_available_<span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>txn<span class="token operator">==</span>first <span class="token operator">&amp;&amp;</span> wait_queue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>second<span class="token operator">-&gt;</span><span class="token function">GetExclusiveLockSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">find</span><span class="token punctuation">(</span>rid<span class="token punctuation">)</span>
                                                       <span class="token operator">!=</span>second<span class="token operator">-&gt;</span><span class="token function">GetExclusiveLockSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                txn<span class="token operator">-&gt;</span><span class="token function">GetSharedLockSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">erase</span><span class="token punctuation">(</span>rid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                wait_queue<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                second<span class="token operator">-&gt;</span>lock_available_<span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                txn<span class="token operator">-&gt;</span><span class="token function">GetSharedLockSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">erase</span><span class="token punctuation">(</span>rid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                wait_queue<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>txn<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <p>调用unlock时，如果当前是非严格两段s锁，如果当前状态是growing, 需要修改为shrinking，这样线程在之后申请其它锁时会触发abort。 如果当前是严格两段式锁，则当前状态必须是committed。</p> </li><li> <p>deadlock prevention</p> <p>使用wait-die 协议防止死锁发生， 按照每个事务的id确定优先级，越早开始的事务优先级越高，只能优先级高的事务去抢占优先级低的事务，否则引起abort。<br> 坑点： 原本的想法是只和wait_queue中已经申请到锁的事务进行优先级对比，这样做的后果是队列中下一个事务获得锁后可能会违反wait-die协议， 待加入队列的阻塞事务必须比队列中的所有事务有更高的优先级。</p> </li></ul> 
<h2><a id="logManager_382"></a>logManager</h2> 
<pre><code class="prism language-cpp"><span class="token class-name">TablePage</span><span class="token operator">::</span><span class="token function">UpdateTuple</span><span class="token punctuation">(</span><span class="token keyword">const</span> Tuple <span class="token operator">&amp;</span>new_tuple<span class="token punctuation">,</span> Tuple <span class="token operator">&amp;</span>old_tuple<span class="token punctuation">,</span>
                            <span class="token keyword">const</span> RID <span class="token operator">&amp;</span>rid<span class="token punctuation">,</span> Transaction <span class="token operator">*</span>txn<span class="token punctuation">,</span>
                            LockManager <span class="token operator">*</span>lock_manager<span class="token punctuation">,</span>
                            LogManager <span class="token operator">*</span>log_manager<span class="token punctuation">)</span>
</code></pre> 
<p>这个函数负责真正将新的tuple更新到page中去。 首先把page中保存的旧tuple的内容复制到old_tuple对象中，然后把新tuple的内容写到旧tuple对应的位置上，因为两者大小可能不同，所以要移动所有旧tuple之前的tuple,并更新他们的tuple_offset.</p> 
<p>TablePage::MarkDelete 不会真正移除rid对应的tuple，而是把它的tuple_size字段设为负数。<br> TablePage::RollbackDelete 重新把tuple的size设置为正数<br> TablePage::ApplyDelete 真正删除rid对应的tuple，把它的tuplesize设置为0.。 并移动它之前的所有tuple. 只有在commit时，或者回滚insert操作时才会调用。<br> TablePage::InsertTuple: 先找到一个对应tuple_size为0的slot_num，如果找不到就把新tuple的slot_num设置为TupleCount的值。但是不管给新tuple分配的slot_num是多少，新tuple的储存位置还是在该page的freespace里。<br> 使用applydelete和markdelete的原因是可以把删除操作变成是幂等(idempotent)的。</p> 
<p>只有在TransactionManager::Commit时才会调用TablePage::ApplyDelete。</p> 
<p>logmanager利用后台线程，每隔LOG_TIMEOUT就把log fush到磁盘。它会维护一个persistentLSN,表示已经写入磁盘的最新LSN。<br> 有两种情况会强制flush, 第一种情况是当buffer pool回收某一个page时，比较page上的pageLSN和persistentLSN， 如果pageLSN更大的话就需要强制flush。 第二种是当txnManager调用Abort或者Commit时。第三种情况是追加log时发现logbuffer已满。<br> 这里的强制flush指的是等待log_timeout或着通过信号量触发logManager的写入磁盘操作。</p> 
<p>每个事务自己会维护一个队列write_set，保存执行的所有写操作。 当事务自己调用abort时，会回滚队列中的所有操作。这些回滚操作，除了applyDelete和rollbackDelte都会和正常操作一样保存到write set，所以在abort过程中相同的delete操作不会多次执行，delete也不会引起多次相同的insert操作（但实际上abort执行过程中不会嵌套执行abort，并且在redo中通过pageLSN也可以防止重入现象）<br> <s>在undo操作中，遇到applyDelete应该视情况回滚，如果此时对应tuple在page_table中的size为0，说明applydelete已经执行成功，这时应该在old_rid上执行insert。 如果size不为0，那直接跳过这条record.</s> 不能要求insert操作一定要发生在原来的槽位上，假设事务T1删除了槽位3上的item， 然后事务T2利用空的槽位3插入了一条新的item，并且commit。 在undo阶段时，由于t2已经提交所以不用回滚，而T1需要回滚，此时已经不可能再插入到槽位3。</p> 
<p>每个record 根据操作的不同长度也会不同，比如update对应的record要保存两个tuple，所以在保存record时，在开头保存当前record的长度。LSN记录的是record的序列号，从LSN到record在log文件中偏移的映射，需要在redo的过程中建立。</p> 
<p>纯数据形式的tuple保存在table_page, tuple类型提供了SerializeTo和DeserializeFrom方便向recod中写入和读取tuple。</p> 
<p>由于使用的是严格两段式锁，所以undo时直接按照各个txn执行即可。</p> 
<p>newpage操作同样也要利用record记录，在redo时如果record的LSN大于对应磁盘上的pageLSN，则需要利用FetchPage拿到这一页，然后重新设置它的pre_page_id和next_page_id。disk_manager中没有实现page的回收，只是用地增量next_page_id指示下一个空闲页的位置。 first_page_id是table_heap的一个属性，表示table_heap中的第一个page的id，insert操作首先会在这个page上搜索空闲槽。 系统崩溃恢复table_heap是必须提供first_page_id.</p> 
<p>在redo阶段碰到一条newPage对应的record，如果此时diskmanager中不存在此page(因为diskmanager可以在db文件的任何位置读写，所以这种情况不存在)则使用bufferManager的newpage进行申请,进而更新bufferManager的next_page_id属性。 如果diskManager中存在此page就直接++next_page_id。因为不使用checkpoint，所以redo后会保证buffermanager的next_page_id和系统崩溃前保持一致。 最好的方式是newpage对应的record记录当前申请页的page_id和pre_page_id。</p> 
<p>在往log中append一条record时，先判断log_buffer会不会溢出，如果会就交换log_buffer和flush_buffer，并强制flush。</p> 
<ul><li>log_manager 实现</li></ul> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">LogManager</span><span class="token operator">::</span><span class="token function">RunFlushThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ENABLE_LOGGING<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        ENABLE_LOGGING<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
        flush_thread_<span class="token operator">=</span><span class="token keyword">new</span> std<span class="token operator">::</span><span class="token function">thread</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
            std<span class="token operator">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token operator">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>latch_<span class="token punctuation">,</span>std<span class="token operator">::</span>defer_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span><span class="token punctuation">(</span>ENABLE_LOGGING<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                cv_<span class="token punctuation">.</span><span class="token function">wait_for</span><span class="token punctuation">(</span>lock<span class="token punctuation">,</span>LOG_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                std<span class="token operator">::</span><span class="token function">swap</span><span class="token punctuation">(</span>log_buffer_<span class="token punctuation">,</span>flush_buffer_<span class="token punctuation">)</span><span class="token punctuation">;</span>
                std<span class="token operator">::</span><span class="token function">swap</span><span class="token punctuation">(</span>buffer_offset_<span class="token punctuation">,</span>flush_offset_<span class="token punctuation">)</span><span class="token punctuation">;</span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                append_cv_<span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                disk_manager_<span class="token operator">-&gt;</span><span class="token function">WriteLog</span><span class="token punctuation">(</span>flush_buffer_<span class="token punctuation">,</span>flush_offset_<span class="token punctuation">)</span><span class="token punctuation">;</span>
                flush_offset_<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
                persistent_lsn_<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span>last_append_lsn_<span class="token punctuation">)</span><span class="token punctuation">;</span>
                commit_cv_<span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
<span class="token comment">/*
 * Stop and join the flush thread, set ENABLE_LOGGING = false
 */</span>
<span class="token keyword">void</span> <span class="token class-name">LogManager</span><span class="token operator">::</span><span class="token function">StopFlushThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token operator">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token operator">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>latch_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ENABLE_LOGGING<span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    cv_<span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    commit_cv_<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    flush_thread_<span class="token operator">-&gt;</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">delete</span> flush_thread_<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

lsn_t <span class="token class-name">LogManager</span><span class="token operator">::</span><span class="token function">AppendLogRecord</span><span class="token punctuation">(</span>LogRecord <span class="token operator">&amp;</span>log_record<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token operator">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token operator">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>latch_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    log_record<span class="token punctuation">.</span>lsn_<span class="token operator">=</span>next_lsn_<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>log_record<span class="token punctuation">.</span><span class="token function">GetSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>buffer_offset_<span class="token operator">&gt;</span>LOG_BUFFER_SIZE<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        cv_<span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        append_cv_<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>log_buffer_ <span class="token operator">+</span> buffer_offset_<span class="token punctuation">,</span> <span class="token operator">&amp;</span>log_record<span class="token punctuation">,</span> LogRecord<span class="token operator">::</span>HEADER_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> pos<span class="token operator">=</span>buffer_offset_<span class="token operator">+</span>LogRecord<span class="token operator">::</span>HEADER_SIZE<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>log_record<span class="token punctuation">.</span>log_record_type_<span class="token operator">==</span>LogRecordType<span class="token operator">::</span>INSERT<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>log_buffer_<span class="token operator">+</span>pos<span class="token punctuation">,</span><span class="token operator">&amp;</span>log_record<span class="token punctuation">.</span>insert_rid_<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>RID<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pos<span class="token operator">+=</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>RID<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log_record<span class="token punctuation">.</span>insert_tuple_<span class="token punctuation">.</span><span class="token function">SerializeTo</span><span class="token punctuation">(</span>log_buffer_<span class="token operator">+</span>pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>log_record<span class="token punctuation">.</span>log_record_type_<span class="token operator">==</span>LogRecordType<span class="token operator">::</span>APPLYDELETE<span class="token operator">||</span>
            log_record<span class="token punctuation">.</span>log_record_type_<span class="token operator">==</span>LogRecordType<span class="token operator">::</span>ROLLBACKDELETE <span class="token operator">||</span>
            log_record<span class="token punctuation">.</span>log_record_type_<span class="token operator">==</span>LogRecordType<span class="token operator">::</span>MARKDELETE<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>log_buffer_<span class="token operator">+</span>pos<span class="token punctuation">,</span><span class="token operator">&amp;</span>log_record<span class="token punctuation">.</span>delete_rid_<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>RID<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pos<span class="token operator">+=</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>RID<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log_record<span class="token punctuation">.</span>delete_tuple_<span class="token punctuation">.</span><span class="token function">SerializeTo</span><span class="token punctuation">(</span>log_buffer_<span class="token operator">+</span>pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>log_record<span class="token punctuation">.</span>log_record_type_<span class="token operator">==</span>LogRecordType<span class="token operator">::</span>UPDATE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>log_buffer_ <span class="token operator">+</span> pos<span class="token punctuation">,</span> <span class="token operator">&amp;</span>log_record<span class="token punctuation">.</span>update_rid_<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>RID<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pos <span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>RID<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log_record<span class="token punctuation">.</span>old_tuple_<span class="token punctuation">.</span><span class="token function">SerializeTo</span><span class="token punctuation">(</span>log_buffer_ <span class="token operator">+</span> pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pos <span class="token operator">+=</span> log_record<span class="token punctuation">.</span>old_tuple_<span class="token punctuation">.</span><span class="token function">GetLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log_record<span class="token punctuation">.</span>new_tuple_<span class="token punctuation">.</span><span class="token function">SerializeTo</span><span class="token punctuation">(</span>log_buffer_ <span class="token operator">+</span> pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>log_record<span class="token punctuation">.</span>log_record_type_<span class="token operator">==</span>LogRecordType<span class="token operator">::</span>NEWPAGE<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>log_buffer_<span class="token operator">+</span>pos<span class="token punctuation">,</span><span class="token operator">&amp;</span>log_record<span class="token punctuation">.</span>prev_page_id_<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>page_id_t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    buffer_offset_<span class="token operator">+=</span>log_record<span class="token punctuation">.</span><span class="token function">GetSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    last_append_lsn_<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span>log_record<span class="token punctuation">.</span><span class="token function">GetLSN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> log_record<span class="token punctuation">.</span><span class="token function">GetLSN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<p>logmanager 利用单独的线程在后台将通过:AppendLogRecord添加的record写入磁盘，有两种方式可以唤醒线程并进行一次写入，分别是通过通过通知条件变量cv_和经过固定的log_timeout时间。使用双缓冲log_buffer和flush_buffer的好处是，只要swap操作完成，不用等到log真正落盘就可以通过append_cv_通知条用AppendLogRecord的其它线程继续运行。 等真正落盘后再更新log_manager的persistent_LSN, 并通过commit_LSN通知调用commit或abort操作的其它线程。虽然log不一定会填满整个log_buffer，但落盘时log之间是不会有间隙的。</p> 
<p>坑点：为了实现双缓冲，必须同时实现buffer_offset和flush_offset，用来记录buffer中从开头到何处需要写入磁盘。</p> 
<ul><li>redo/undo 实现</li></ul> 
<pre><code class="prism language-cpp"><span class="token keyword">bool</span> <span class="token class-name">LogRecovery</span><span class="token operator">::</span><span class="token function">DeserializeLogRecord</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span>
                                             LogRecord <span class="token operator">&amp;</span>log_record<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    size_t cur_offset<span class="token operator">=</span>data<span class="token operator">-</span>log_buffer_<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>data<span class="token operator">+</span>LogRecord<span class="token operator">::</span>HEADER_SIZE<span class="token operator">&gt;</span>LOG_BUFFER_SIZE<span class="token operator">+</span>log_buffer_<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>log_record<span class="token punctuation">,</span>data<span class="token punctuation">,</span>LogRecord<span class="token operator">::</span>HEADER_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>data<span class="token operator">+</span>log_record<span class="token punctuation">.</span>size_<span class="token operator">&gt;</span>LOG_BUFFER_SIZE<span class="token operator">+</span>log_buffer_
    <span class="token operator">||</span> log_record<span class="token punctuation">.</span>size_<span class="token operator">&lt;</span>LogRecord<span class="token operator">::</span>HEADER_SIZE<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    data<span class="token operator">+=</span>LogRecord<span class="token operator">::</span>HEADER_SIZE<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>log_record<span class="token punctuation">.</span>log_record_type_<span class="token operator">==</span>LogRecordType<span class="token operator">::</span>INSERT<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>log_record<span class="token punctuation">.</span>insert_rid_<span class="token punctuation">)</span><span class="token punctuation">,</span>data<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>RID<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        data<span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>RID<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log_record<span class="token punctuation">.</span>insert_tuple_<span class="token punctuation">.</span><span class="token function">DeserializeFrom</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>log_record<span class="token punctuation">.</span>log_record_type_<span class="token operator">==</span>LogRecordType<span class="token operator">::</span>APPLYDELETE<span class="token operator">||</span>
             log_record<span class="token punctuation">.</span>log_record_type_<span class="token operator">==</span>LogRecordType<span class="token operator">::</span>ROLLBACKDELETE <span class="token operator">||</span>
             log_record<span class="token punctuation">.</span>log_record_type_<span class="token operator">==</span>LogRecordType<span class="token operator">::</span>MARKDELETE<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>log_record<span class="token punctuation">.</span>delete_rid_<span class="token punctuation">)</span><span class="token punctuation">,</span>data<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>RID<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        data<span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>RID<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log_record<span class="token punctuation">.</span>delete_tuple_<span class="token punctuation">.</span><span class="token function">DeserializeFrom</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>log_record<span class="token punctuation">.</span>log_record_type_<span class="token operator">==</span>LogRecordType<span class="token operator">::</span>UPDATE<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>log_record<span class="token punctuation">.</span>update_rid_<span class="token punctuation">)</span><span class="token punctuation">,</span>data<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>RID<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        data<span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>RID<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log_record<span class="token punctuation">.</span>old_tuple_<span class="token punctuation">.</span><span class="token function">DeserializeFrom</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        data<span class="token operator">+=</span>log_record<span class="token punctuation">.</span>old_tuple_<span class="token punctuation">.</span><span class="token function">GetLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int32_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log_record<span class="token punctuation">.</span>new_tuple_<span class="token punctuation">.</span><span class="token function">DeserializeFrom</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>log_record<span class="token punctuation">.</span>log_record_type_<span class="token operator">==</span>LogRecordType<span class="token operator">::</span>NEWPAGE<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        log_record<span class="token punctuation">.</span>prev_page_id_ <span class="token operator">=</span> <span class="token operator">*</span><span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">const</span> page_id_t <span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log_record<span class="token punctuation">.</span>cur_page_id<span class="token operator">=</span> <span class="token operator">*</span><span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">const</span> page_id_t <span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>data <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>page_id_t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    log_record<span class="token punctuation">.</span><span class="token function">UpdateSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 *redo phase on TABLE PAGE level(table/table_page.h)
 *read log file from the beginning to end (you must prefetch log records into
 *log buffer to reduce unnecessary I/O operations), remember to compare page's
 *LSN with log_record's sequence number, and also build active_txn_ table &amp;
 *lsn_mapping_ table
 */</span>
<span class="token keyword">void</span> <span class="token class-name">LogRecovery</span><span class="token operator">::</span><span class="token function">Redo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    global_offset_<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    buffer_offset_<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>disk_manager_<span class="token operator">-&gt;</span><span class="token function">ReadLog</span><span class="token punctuation">(</span>log_buffer_<span class="token punctuation">,</span>LOG_BUFFER_SIZE<span class="token punctuation">,</span>
                                 global_offset_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            LogRecord log<span class="token punctuation">;</span>
            <span class="token keyword">bool</span> isPageModified <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            TablePage <span class="token operator">*</span>page<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">DeserializeLogRecord</span><span class="token punctuation">(</span>log_buffer_ <span class="token operator">+</span> buffer_offset_<span class="token punctuation">,</span> log<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                active_txn_<span class="token punctuation">[</span>log<span class="token punctuation">.</span><span class="token function">GetTxnId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> log<span class="token punctuation">.</span><span class="token function">GetLSN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                lsn_mapping_<span class="token punctuation">[</span>log<span class="token punctuation">.</span><span class="token function">GetLSN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">make_pair</span><span class="token punctuation">(</span>global_offset_ <span class="token operator">+</span> buffer_offset_<span class="token punctuation">,</span> log<span class="token punctuation">.</span>size_<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span>log_record_type_ <span class="token operator">==</span> LogRecordType<span class="token operator">::</span>INSERT<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">auto</span> rid <span class="token operator">=</span> log<span class="token punctuation">.</span>insert_rid_<span class="token punctuation">;</span>
                    page <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>TablePage <span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
                            buffer_pool_manager_<span class="token operator">-&gt;</span><span class="token function">FetchPage</span><span class="token punctuation">(</span>rid<span class="token punctuation">.</span><span class="token function">GetPageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">assert</span><span class="token punctuation">(</span>page <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">GetLSN</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> page<span class="token operator">-&gt;</span><span class="token function">GetLSN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        RID tmp_rid<span class="token punctuation">;</span>
                        page<span class="token operator">-&gt;</span><span class="token function">InsertTuple</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>insert_tuple_<span class="token punctuation">,</span> tmp_rid<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        isPageModified <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span>log_record_type_ <span class="token operator">==</span> LogRecordType<span class="token operator">::</span>APPLYDELETE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">auto</span> rid <span class="token operator">=</span> log<span class="token punctuation">.</span>delete_rid_<span class="token punctuation">;</span>
                    page <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>TablePage <span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
                            buffer_pool_manager_<span class="token operator">-&gt;</span><span class="token function">FetchPage</span><span class="token punctuation">(</span>rid<span class="token punctuation">.</span><span class="token function">GetPageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">assert</span><span class="token punctuation">(</span>page <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">GetLSN</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> page<span class="token operator">-&gt;</span><span class="token function">GetLSN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        RID tmp_rid<span class="token punctuation">;</span>
                        page<span class="token operator">-&gt;</span><span class="token function">ApplyDelete</span><span class="token punctuation">(</span>rid<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        isPageModified <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span>log_record_type_ <span class="token operator">==</span> LogRecordType<span class="token operator">::</span>MARKDELETE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">auto</span> rid <span class="token operator">=</span> log<span class="token punctuation">.</span>delete_rid_<span class="token punctuation">;</span>
                    page <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>TablePage <span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
                            buffer_pool_manager_<span class="token operator">-&gt;</span><span class="token function">FetchPage</span><span class="token punctuation">(</span>rid<span class="token punctuation">.</span><span class="token function">GetPageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">assert</span><span class="token punctuation">(</span>page <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">GetLSN</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> page<span class="token operator">-&gt;</span><span class="token function">GetLSN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        RID tmp_rid<span class="token punctuation">;</span>
                        page<span class="token operator">-&gt;</span><span class="token function">MarkDelete</span><span class="token punctuation">(</span>rid<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        isPageModified <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span>log_record_type_ <span class="token operator">==</span> LogRecordType<span class="token operator">::</span>ROLLBACKDELETE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">auto</span> rid <span class="token operator">=</span> log<span class="token punctuation">.</span>delete_rid_<span class="token punctuation">;</span>
                    page <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>TablePage <span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
                            buffer_pool_manager_<span class="token operator">-&gt;</span><span class="token function">FetchPage</span><span class="token punctuation">(</span>rid<span class="token punctuation">.</span><span class="token function">GetPageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">assert</span><span class="token punctuation">(</span>page <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">GetLSN</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> page<span class="token operator">-&gt;</span><span class="token function">GetLSN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        RID tmp_rid<span class="token punctuation">;</span>
                        page<span class="token operator">-&gt;</span><span class="token function">RollbackDelete</span><span class="token punctuation">(</span>rid<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        isPageModified <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span>log_record_type_ <span class="token operator">==</span> LogRecordType<span class="token operator">::</span>UPDATE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">auto</span> rid <span class="token operator">=</span> log<span class="token punctuation">.</span>update_rid_<span class="token punctuation">;</span>
                    page <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>TablePage <span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
                            buffer_pool_manager_<span class="token operator">-&gt;</span><span class="token function">FetchPage</span><span class="token punctuation">(</span>rid<span class="token punctuation">.</span><span class="token function">GetPageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">assert</span><span class="token punctuation">(</span>page <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">GetLSN</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> page<span class="token operator">-&gt;</span><span class="token function">GetLSN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        RID tmp_rid<span class="token punctuation">;</span>
                        page<span class="token operator">-&gt;</span><span class="token function">UpdateTuple</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>new_tuple_<span class="token punctuation">,</span>
                                          log<span class="token punctuation">.</span>old_tuple_<span class="token punctuation">,</span> rid<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        isPageModified <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span>log_record_type_ <span class="token operator">==</span> LogRecordType<span class="token operator">::</span>NEWPAGE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    page <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>TablePage <span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
                            buffer_pool_manager_<span class="token operator">-&gt;</span><span class="token function">FetchPage</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>cur_page_id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">assert</span><span class="token punctuation">(</span>page <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">GetLSN</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> page<span class="token operator">-&gt;</span><span class="token function">GetLSN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        page<span class="token operator">-&gt;</span><span class="token function">Init</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>cur_page_id<span class="token punctuation">,</span> PAGE_SIZE<span class="token punctuation">,</span> log<span class="token punctuation">.</span>prev_page_id_<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span>prev_page_id_ <span class="token operator">!=</span> INVALID_PAGE_ID<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">auto</span> pre_page <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>TablePage <span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
                                    buffer_pool_manager_<span class="token operator">-&gt;</span><span class="token function">FetchPage</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>prev_page_id_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            pre_page<span class="token operator">-&gt;</span><span class="token function">SetNextPageId</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>cur_page_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            buffer_pool_manager_<span class="token operator">-&gt;</span><span class="token function">UnpinPage</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>prev_page_id_<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        isPageModified <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>log_record_type_ <span class="token operator">==</span> LogRecordType<span class="token operator">::</span>COMMIT <span class="token operator">||</span>
                           log<span class="token punctuation">.</span>log_record_type_ <span class="token operator">==</span> LogRecordType<span class="token operator">::</span>ABORT<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    active_txn_<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">GetTxnId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span>log_record_type_ <span class="token operator">!=</span> LogRecordType<span class="token operator">::</span>BEGIN <span class="token operator">&amp;&amp;</span>
                    log<span class="token punctuation">.</span>log_record_type_ <span class="token operator">!=</span> LogRecordType<span class="token operator">::</span>COMMIT <span class="token operator">&amp;&amp;</span>
                    log<span class="token punctuation">.</span>log_record_type_ <span class="token operator">!=</span> LogRecordType<span class="token operator">::</span>ABORT<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>isPageModified<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                        page<span class="token operator">-&gt;</span><span class="token function">SetLSN</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">GetLSN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    buffer_pool_manager_<span class="token operator">-&gt;</span><span class="token function">UnpinPage</span><span class="token punctuation">(</span>page<span class="token operator">-&gt;</span><span class="token function">GetPageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> isPageModified<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                buffer_offset_<span class="token operator">+=</span>log<span class="token punctuation">.</span>size_<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>buffer_offset_<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                global_offset_ <span class="token operator">+=</span> buffer_offset_<span class="token punctuation">;</span>
                buffer_offset_ <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 *undo phase on TABLE PAGE level(table/table_page.h)
 *iterate through active txn map and undo each operation
 */</span>
<span class="token keyword">void</span> <span class="token class-name">LogRecovery</span><span class="token operator">::</span><span class="token function">Undo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> num_record<span class="token operator">=</span>active_txn_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> tmp_buffer<span class="token punctuation">[</span>LOG_BUFFER_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">auto</span> it<span class="token operator">=</span>active_txn_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>it<span class="token operator">!=</span>active_txn_<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>it<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        lsn_t lsn<span class="token operator">=</span>it<span class="token operator">-&gt;</span>second<span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> global_offset<span class="token operator">=</span>lsn_mapping_<span class="token punctuation">[</span>lsn<span class="token punctuation">]</span><span class="token punctuation">.</span>first<span class="token punctuation">;</span>
            <span class="token keyword">int</span> log_size<span class="token operator">=</span>lsn_mapping_<span class="token punctuation">[</span>lsn<span class="token punctuation">]</span><span class="token punctuation">.</span>second<span class="token punctuation">;</span>
            TablePage<span class="token operator">*</span> page<span class="token punctuation">;</span>
            LogRecord log<span class="token punctuation">;</span>
            disk_manager_<span class="token operator">-&gt;</span><span class="token function">ReadLog</span><span class="token punctuation">(</span>log_buffer_<span class="token punctuation">,</span>log_size<span class="token punctuation">,</span>global_offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">DeserializeLogRecord</span><span class="token punctuation">(</span>log_buffer_<span class="token punctuation">,</span>log<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>log_record_type_<span class="token operator">==</span>LogRecordType<span class="token operator">::</span>BEGIN<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>log_record_type_<span class="token operator">==</span>LogRecordType<span class="token operator">::</span>INSERT<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">auto</span> rid<span class="token operator">=</span>log<span class="token punctuation">.</span>insert_rid_<span class="token punctuation">;</span>
                page <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>TablePage <span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
                        buffer_pool_manager_<span class="token operator">-&gt;</span><span class="token function">FetchPage</span><span class="token punctuation">(</span>rid<span class="token punctuation">.</span><span class="token function">GetPageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                page<span class="token operator">-&gt;</span><span class="token function">ApplyDelete</span><span class="token punctuation">(</span>rid<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>log_record_type_<span class="token operator">==</span>LogRecordType<span class="token operator">::</span>APPLYDELETE<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">auto</span> rid<span class="token operator">=</span><span class="token function">RID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                page <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>TablePage <span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
                        buffer_pool_manager_<span class="token operator">-&gt;</span><span class="token function">FetchPage</span><span class="token punctuation">(</span>rid<span class="token punctuation">.</span><span class="token function">GetPageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                page<span class="token operator">-&gt;</span><span class="token function">InsertTuple</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>delete_tuple_<span class="token punctuation">,</span>rid<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>log_record_type_<span class="token operator">==</span>LogRecordType<span class="token operator">::</span>MARKDELETE<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">auto</span> rid<span class="token operator">=</span>log<span class="token punctuation">.</span>delete_rid_<span class="token punctuation">;</span>
                page <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>TablePage <span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
                        buffer_pool_manager_<span class="token operator">-&gt;</span><span class="token function">FetchPage</span><span class="token punctuation">(</span>rid<span class="token punctuation">.</span><span class="token function">GetPageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                page<span class="token operator">-&gt;</span><span class="token function">RollbackDelete</span><span class="token punctuation">(</span>rid<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>log_record_type_<span class="token operator">==</span>LogRecordType<span class="token operator">::</span>ROLLBACKDELETE<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">auto</span> rid<span class="token operator">=</span>log<span class="token punctuation">.</span>delete_rid_<span class="token punctuation">;</span>
                page <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>TablePage <span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
                        buffer_pool_manager_<span class="token operator">-&gt;</span><span class="token function">FetchPage</span><span class="token punctuation">(</span>rid<span class="token punctuation">.</span><span class="token function">GetPageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                page<span class="token operator">-&gt;</span><span class="token function">MarkDelete</span><span class="token punctuation">(</span>rid<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>log_record_type_<span class="token operator">==</span>LogRecordType<span class="token operator">::</span>UPDATE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">auto</span> rid<span class="token operator">=</span>log<span class="token punctuation">.</span>update_rid_<span class="token punctuation">;</span>
                page <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>TablePage <span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
                        buffer_pool_manager_<span class="token operator">-&gt;</span><span class="token function">FetchPage</span><span class="token punctuation">(</span>rid<span class="token punctuation">.</span><span class="token function">GetPageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                page<span class="token operator">-&gt;</span><span class="token function">UpdateTuple</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>old_tuple_<span class="token punctuation">,</span>
                                  log<span class="token punctuation">.</span>new_tuple_<span class="token punctuation">,</span> rid<span class="token punctuation">,</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>log_record_type_<span class="token operator">==</span>LogRecordType<span class="token operator">::</span>NEWPAGE<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                page <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>TablePage <span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
                        buffer_pool_manager_<span class="token operator">-&gt;</span><span class="token function">FetchPage</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>cur_page_id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                buffer_pool_manager_<span class="token operator">-&gt;</span><span class="token function">DeletePage</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>cur_page_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>prev_page_id_<span class="token operator">!=</span>INVALID_PAGE_ID<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">auto</span> pre_page<span class="token operator">=</span><span class="token keyword">static_cast</span><span class="token operator">&lt;</span>TablePage <span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
                            buffer_pool_manager_<span class="token operator">-&gt;</span><span class="token function">FetchPage</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>prev_page_id_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    pre_page<span class="token operator">-&gt;</span><span class="token function">SetNextPageId</span><span class="token punctuation">(</span>INVALID_PAGE_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    buffer_pool_manager_<span class="token operator">-&gt;</span><span class="token function">UnpinPage</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>prev_page_id_<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>log_record_type_<span class="token operator">!=</span>LogRecordType<span class="token operator">::</span>BEGIN <span class="token operator">&amp;&amp;</span>
               log<span class="token punctuation">.</span>log_record_type_<span class="token operator">!=</span>LogRecordType<span class="token operator">::</span>COMMIT <span class="token operator">&amp;&amp;</span>
               log<span class="token punctuation">.</span>log_record_type_<span class="token operator">!=</span>LogRecordType<span class="token operator">::</span>ABORT<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                buffer_pool_manager_<span class="token operator">-&gt;</span><span class="token function">UnpinPage</span><span class="token punctuation">(</span>page<span class="token operator">-&gt;</span><span class="token function">GetPageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            lsn<span class="token operator">=</span>log<span class="token punctuation">.</span><span class="token function">GetPrevLSN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>其中DeserializeLogRecord负责从log_buffer的指定位置读取一个log_record。首先看是否能读取一个header， 如果可以就利用header中保存的size加上当前的偏移量，如果大于log_buffer_size说明这个log_buffer中已经不能读取一个完整的buffer。<br> redo每次从log文件中读取log_buffer_size长度的数据到log_buffer，然后利用DeserializeLogRecord从log_buffer中读取log。 如果DeserializeLogRecord返回false，则从当前的log文件偏移量开始，又读取log_buffer_size长度的数据到log_buffer。如果当前的log_buffer中读取不到任何log， redo过程停止。redo过程中负责记录所有active table，以及表中所有事务对应的LSN最大的一条record， 同时构建lsn到record在log文件中的偏移地址以及record长度的映射。</p> 
<p>undo 负责根据active table 分别对表中的事务进行回滚，利用pre_lsn找到当前record所属事务中的上一条record。 redo 和undo中的所有操作(insert,update…) 都是直接在record指向的table_page上进行, 而不是利用table_heap执行。</p> 
<p>table_heap中在执行某个操作之前，会先获取这个操作涉及page的写锁，令人困惑的地方是当table_heap把操作权转交给table_page时，table_page内部又会利用lock_manager获取rid的写锁， 这会给人一种重复加锁的错觉。实际上，page上的锁在操作完成后会马上释放，而rid上的锁会一直保持到事务commit或abort。insert操作中，虽然对于当前事务来说, rid是全新的，但是这个rid可能是其它事务进行applyDelete操作后留下的空位，所以可能造成rid锁的争用。table_page在insert操作中如果争用rid锁失败(可能因为deadlock prevention 协议)，需要返回false，并把当前事务的状态设置为aborted。 不能指望利用abort操作来回滚因获取锁而失败的insert操作，因为回滚时的delete操作同样也获取不到锁，所以只能在返回false之前手动取消insert。</p> 
<ul><li> <p>测试<br> 在debug模式下通过sqlite3 加载动态库的方式运行内核</p> <pre><code class="prism language-cpp">rc <span class="token operator">=</span> <span class="token function">sqlite3_open</span><span class="token punctuation">(</span>db_file<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">EXPECT_EQ</span><span class="token punctuation">(</span>rc<span class="token punctuation">,</span> SQLITE_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>

  rc <span class="token operator">=</span> <span class="token function">sqlite3_enable_load_extension</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">EXPECT_EQ</span><span class="token punctuation">(</span>rc<span class="token punctuation">,</span> SQLITE_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>zFile <span class="token operator">=</span> <span class="token string">"../lib/libvtable.so"</span><span class="token punctuation">;</span> <span class="token comment">// shared library name</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>zProc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>           <span class="token comment">// entry point within library</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>zErrMsg <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  rc <span class="token operator">=</span> <span class="token function">sqlite3_load_extension</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> zFile<span class="token punctuation">,</span> zProc<span class="token punctuation">,</span> <span class="token operator">&amp;</span>zErrMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">EXPECT_EQ</span><span class="token punctuation">(</span>rc<span class="token punctuation">,</span> SQLITE_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">EXPECT_TRUE</span><span class="token punctuation">(</span><span class="token function">ExecSQL</span><span class="token punctuation">(</span>
      db<span class="token punctuation">,</span> <span class="token string">"CREATE VIRTUAL TABLE foo1 USING vtable ('a INT, b "</span>
          <span class="token string">"int, c smallint, d varchar, e bigint, f bool', 'foo1_pk b')"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">EXPECT_TRUE</span><span class="token punctuation">(</span><span class="token function">ExecSQL</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">"INSERT INTO foo1 VALUES(1, 2, 3, 'hello', 2,1)"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">EXPECT_TRUE</span><span class="token punctuation">(</span><span class="token function">ExecSQL</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">"INSERT INTO foo1 VALUES(3, 4, 5, 'Nihao',4, 1)"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">EXPECT_TRUE</span><span class="token punctuation">(</span><span class="token function">ExecSQL</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">"INSERT INTO foo1 VALUES(2, 3, 4, 'world',3, 1)"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">EXPECT_TRUE</span><span class="token punctuation">(</span><span class="token function">ExecSQL</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">"SELECT * FROM foo1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">EXPECT_TRUE</span><span class="token punctuation">(</span><span class="token function">ExecSQL</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">"DELETE FROM foo1 WHERE b = 2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">EXPECT_TRUE</span><span class="token punctuation">(</span><span class="token function">ExecSQL</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">"SELECT * FROM foo1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">EXPECT_TRUE</span><span class="token punctuation">(</span><span class="token function">ExecSQL</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">"DROP TABLE foo1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> </li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/75d9a5a089729ee52ddd46e2956504ff/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">C语言新建文件写入数据</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b540f9199a7f64c827d67d91b83e4eff/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">下载网页 TS视频并自动合成视频</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>