<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>国标28181：实时视频播放 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="国标28181：实时视频播放" />
<meta property="og:description" content="流程 一个流媒体平台主要分为一些几个部分
主要用途：对接监控摄像头、视频直播、多对多视频聊天器
系统架构由三个部分组成：
接口服务器（HTTP服务器）主要用于响应客户端的请求信令服务器（SIP服务器）主要用于和流媒体服务器和视频设备交互，主要功能是管理摄像头之类的设备以及控制摄像头将视频流转发给流媒体服务器的哪个端口流媒体服务器主要用于处理视频流的接收、转发和分发 接口服务器和信令服务器可以整合为一个服务器。
流媒体服务器最好单独部署，避免流媒体服务器压力过大，可以用ZLMediaKit代替。我们要开发的就是接口服务器和信令服务器。
实时码流点播采用SPI协议中的INVITE方法实现会话连接，采用RTP/RTCP协议实现媒体传输。
整个播放过程如下：
其通信流程如下：
视频流是怎么推流的
SIP视频流的获取是指解码器（ZLMediaKit）通过SIP协议向GB28181服务器获取视频流的过程
GB28181服务器（也就是SIP服务器）会像摄像头发送一些信令，主要是请求播放实时视频。 开启SIP服务器，服务器将会监听某个端口，可以从这个端口收到SDP信息摄像机端发送Register消息后，然后服务端应答注册消息代码SIP服务端响应注册命令后，发送Invite请求，请求catalog信息，也就是设备基本信息摄像机端收到消息发送其自身的catalog消息，将会服务具体的具体的catalog消息。SIP服务取都摄像机的信息后就可以发送请求视频信息到摄像头。下面看下SDP信息怎么写 static string createSDP(MediaContext&amp; mediaContext) { char str[500] = { 0 }; pj_ansi_snprintf(str, 500, &#34;v=0\n&#34; &#34;o=%s 0 0 IN IP4 %s\n&#34; &#34;s=Play\n&#34; &#34;c=IN IP4 %s\n&#34; &#34;t=0 0\n&#34; &#34;m=video %d RTP/AVP 96 98 97\n&#34; &#34;a=recvonly\n&#34; &#34;a=rtpmap:96 PS/90000\n&#34; &#34;a=rtpmap:98 H264/90000\n&#34; &#34;a=rtpmap:97 MPEG4/90000\n&#34; &#34;y=0100000001\n&#34;, mediaContext.GetDeviceId().c_str(), mediaContext.GetRecvAddress().c_str(), mediaContext.GetRecvAddress().c_str(), mediaContext.GetRecvPort() ); return str; } 信令交互成功之后，摄像头(媒体流发送者)会将视频数据以rtp的方式推送到指定的端口 （端口在上面的invite消息指定）流到媒体服务器媒体服务器(GB28181服务器)在指定的端口接收视频流媒体服务器(GB28181服务器)将视频流转发给流媒体接收者(比如ZLMediaKit) 具体流程如下：
视频流格式 GB28181要求传输的视频流格式为PS流，或者H264流，或者MP4格式。
可以用wireshark抓包，数据报类型是RTP的PS流
国标流媒体服务器其实就是负责将GB28181设备或者平台推送的PS流转成ES流，然后提供RTSP、RTMP、FLV、HLS等格式进⾏分发。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/4f296640c21bb9f8c3c4540399a4b4f4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-02T15:48:23+08:00" />
<meta property="article:modified_time" content="2022-09-02T15:48:23+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">国标28181：实时视频播放</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>流程</h2> 
<blockquote> 
 <p>一个流媒体平台主要分为一些几个部分</p> 
</blockquote> 
<p>主要用途：对接监控摄像头、视频直播、多对多视频聊天器</p> 
<p>系统架构由三个部分组成：</p> 
<ul><li>接口服务器（HTTP服务器）主要用于响应客户端的请求</li><li>信令服务器（SIP服务器）主要用于和流媒体服务器和视频设备交互，主要功能是<strong>管理摄像头之类的设备</strong>以及<strong>控制摄像头将视频流转发给流媒体服务器的哪个端口</strong></li><li>流媒体服务器主要用于处理视频流的接收、转发和分发</li></ul> 
<p>接口服务器和信令服务器可以整合为一个服务器。</p> 
<p>流媒体服务器最好单独部署，避免流媒体服务器压力过大，可以用ZLMediaKit代替。我们要开发的就是接口服务器和信令服务器。</p> 
<p>实时码流点播采用SPI协议中的INVITE方法实现会话连接，采用RTP/RTCP协议实现媒体传输。</p> 
<blockquote> 
 <p>整个播放过程如下：</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/94/b2/XJyyNLb0_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>其通信流程如下：</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/8d/b7/MJW9i1GY_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>视频流是怎么推流的</p> 
</blockquote> 
<p>SIP视频流的获取是指解码器（ZLMediaKit）通过SIP协议向GB28181服务器获取视频流的过程</p> 
<ul><li>GB28181服务器（也就是SIP服务器）会像摄像头发送一些信令，主要是请求播放实时视频。 
  <ul><li>开启SIP服务器，服务器将会监听某个端口，可以从这个端口收到SDP信息</li><li>摄像机端发送Register消息后，然后服务端应答注册消息代码</li><li>SIP服务端响应注册命令后，发送Invite请求，请求catalog信息，也就是设备基本信息</li><li>摄像机端收到消息发送其自身的catalog消息，将会服务具体的具体的catalog消息。</li><li>SIP服务取都摄像机的信息后就可以发送请求视频信息到摄像头。下面看下SDP信息怎么写</li></ul> </li></ul> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> string <span class="token function">createSDP</span><span class="token punctuation">(</span>MediaContext<span class="token operator">&amp;</span> mediaContext<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span> str<span class="token punctuation">[</span><span class="token number">500</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token function">pj_ansi_snprintf</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span>
	<span class="token string">"v=0\n"</span>
	<span class="token string">"o=%s 0 0 IN IP4 %s\n"</span>
	<span class="token string">"s=Play\n"</span>
	<span class="token string">"c=IN IP4 %s\n"</span>
	<span class="token string">"t=0 0\n"</span>
	<span class="token string">"m=video %d RTP/AVP 96 98 97\n"</span>
	<span class="token string">"a=recvonly\n"</span>
	<span class="token string">"a=rtpmap:96 PS/90000\n"</span>
	<span class="token string">"a=rtpmap:98 H264/90000\n"</span>
	<span class="token string">"a=rtpmap:97 MPEG4/90000\n"</span>
	<span class="token string">"y=0100000001\n"</span><span class="token punctuation">,</span>
	mediaContext<span class="token punctuation">.</span><span class="token function">GetDeviceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	mediaContext<span class="token punctuation">.</span><span class="token function">GetRecvAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	mediaContext<span class="token punctuation">.</span><span class="token function">GetRecvAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	mediaContext<span class="token punctuation">.</span><span class="token function">GetRecvPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> str<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>信令交互成功之后，摄像头(媒体流发送者)会将视频数据以rtp的方式<strong>推送</strong>到指定的端口 （端口在上面的invite消息指定）流到<strong>媒体服务器</strong></li><li><strong>媒体服务器</strong>(GB28181服务器)在指定的端口接收视频流</li><li><strong>媒体服务器</strong>(GB28181服务器)将视频流<strong>转发</strong>给流媒体接收者(比如ZLMediaKit)</li></ul> 
<p><img src="https://images2.imgbox.com/59/b7/VGV5GBO5_o.png" alt="在这里插入图片描述"></p> 
<p>具体流程如下：<br> <img src="https://images2.imgbox.com/1d/58/tlWFBaAD_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_73"></a>视频流格式</h3> 
<p>GB28181要求传输的视频流格式为PS流，或者H264流，或者MP4格式。</p> 
<p>可以用wireshark抓包，数据报类型是RTP的PS流</p> 
<p>国标流媒体服务器其实就是负责将GB28181设备或者平台推送的PS流转成ES流，然后提供RTSP、RTMP、FLV、HLS等格式进⾏分发。</p> 
<blockquote> 
 <p>PS流和ES流的区别</p> 
</blockquote> 
<p>IP数据报有⾸部和数据两部分组成的，⾸部的前⼀部<br> 分是固定长度20字节，是所有IP数据报必须具有的。⾸部包括：总长度、标识、MF、DF、⽚偏移。<br> 数字信号实际传送的是数据流，⼀般数据流包括以下三种：</p> 
<ul><li>ES流(Elementary Stream)：也叫基本码流，包含视频、⾳频或数据的连续码流。</li><li>PES流(Packet Elementary Stream)：也叫打包的基本码流，是将基本的码流ES流根据需要分成长度不等的数据<br> 包，并加上包头就形成了打包的基本码流PES流。</li><li>TS流：也叫传输流，是由固定长度为188字节的包组成，含有独⽴时基的⼀个或多个program, ⼀个program⼜可以包含多个视频、⾳频、和⽂字信息的ES流; 每个ES流会有不同的PID标⽰，为了可以分析这些ES流, TS有⼀些固定的PID⽤来间隔发送program和ES流信息的表格: PAT和PMT表。适⽤于误码较多的环境</li></ul> 
<p>ES 是直接从编码器出来的数据流，可以是编码过的视频数据流，⾳频数据流，或其他编码数据流的统称。 ES 流经过PES 打包器之后，被转换成 PES 包，再通过RTSP、RTMP、FLV、HLS格式分发出去，实现WEB、⼿机、PC、微信等多终端的播放</p> 
<h3><a id="_93"></a>传播方式</h3> 
<p>GBT28181协议规定码流使用RTP包负载，推荐为PS流，也可以是ES流，对于媒体流的传输在原有UDP传输的基础中，增加了主动tcp和被动tcp的方式。</p> 
<p>(1)UDP被动</p> 
<ul><li>这个是普遍的传输方式。 
  <ul><li>GB28181流媒体服务器监听单个UDP端口，然后发送一个SIP信令(INVITE)，其携带的SDP中包含了接收媒体的端口</li><li>设备端收到信令后，解析该端口，然后<strong>设备主动</strong>通过UDP向流媒体服务端监听的那个端口上发送视频流</li></ul> </li></ul> 
<p>（2）TCP被动</p> 
<ul><li>有两种，一种是主动，一种是被动</li><li>对于主动： 设备端告知服务端自己的媒体流tcp端口，服务端主动去连接设备端的该端口，获取数据。。这种场景应用较少，可以忽略</li><li>对于被动：流媒体服务器监听单个TCP端口，然后通过SIP信令(INVITE)告诉设备端口，<strong>设备主动</strong>向当前流媒体服务端发送视频流，基本等同于UDP流</li></ul> 
<h2><a id="_115"></a>实时视频</h2> 
<h3><a id="_119"></a>流程</h3> 
<p>前提：注册成功&gt;&gt;&gt;&gt;&gt;&gt;心跳成功&gt;&gt;&gt;&gt;&gt;&gt;设备目录查询&gt;&gt;&gt;&gt;&gt;实时视频观看<br> <img src="https://images2.imgbox.com/8c/a2/9PwfxKiN_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_123"></a>服务端步骤</h3> 
<p>不管是TCP方式看，还是UDP方式看，其步骤都为：<br> （1）打开视频端口<br> （2）发送实时视频请求<br> （3）等待设备回复200OK<br> （4）发送ACK<br> （5）播放码流<br> （6）停止视频请求<br> （7）关闭视频端口<br> （8）普通等待</p> 
<h3><a id="_134"></a>抓包分析</h3> 
<p>测试设备IP：192.168.0.107<br> 服务端IP：192.168.0.60</p> 
<h4><a id="_UDP_139"></a>实时视频建立_UDP</h4> 
<h5><a id="_141"></a>第零步：【服务端】打开视频端口</h5> 
<h5><a id="_142"></a>第一步：【服务端&gt;&gt;客户端】请求播放视频</h5> 
<pre><code class="prism language-cpp">INVITE sip<span class="token operator">:</span><span class="token number">34020000001310000002</span>@<span class="token number">4401020049</span> SIP<span class="token operator">/</span><span class="token number">2.0</span>
Call<span class="token operator">-</span>ID<span class="token operator">:</span> helloVideo
CSeq<span class="token operator">:</span> <span class="token number">1</span> INVITE
From<span class="token operator">:</span> <span class="token operator">&lt;</span>sip<span class="token operator">:</span><span class="token number">44010200492000000001</span>@<span class="token number">4401020049</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>tag<span class="token operator">=</span>bccedfd0111
To<span class="token operator">:</span> <span class="token operator">&lt;</span>sip<span class="token operator">:</span><span class="token number">34020000001110000001</span>@<span class="token number">4401020049</span><span class="token operator">&gt;</span>
Max<span class="token operator">-</span>Forwards<span class="token operator">:</span> <span class="token number">70</span>
Contact<span class="token operator">:</span> <span class="token operator">&lt;</span>sip<span class="token operator">:</span><span class="token number">34020000001310000002</span>@<span class="token number">4401020049</span><span class="token operator">&gt;</span>
Via<span class="token operator">:</span> SIP<span class="token operator">/</span><span class="token number">2.0</span><span class="token operator">/</span>UDP <span class="token number">192.168</span><span class="token punctuation">.</span><span class="token number">0.107</span><span class="token operator">:</span><span class="token number">5060</span><span class="token punctuation">;</span>branch<span class="token operator">=</span>z9hG4bKee5c5d98<span class="token operator">-</span>bff9<span class="token operator">-</span><span class="token number">4f</span>3000002
Content<span class="token operator">-</span>Type<span class="token operator">:</span> application<span class="token operator">/</span>sdp
Content<span class="token operator">-</span>Length<span class="token operator">:</span> <span class="token number">225</span>

v<span class="token operator">=</span><span class="token number">0</span>
o<span class="token operator">=</span><span class="token number">34020000001310000002</span> <span class="token number">0</span> <span class="token number">0</span> IN IP4 <span class="token number">192.168</span><span class="token punctuation">.</span><span class="token number">0.60</span>
s<span class="token operator">=</span>Play
c<span class="token operator">=</span>IN IP4 <span class="token number">192.168</span><span class="token punctuation">.</span><span class="token number">0.60</span>
t<span class="token operator">=</span><span class="token number">0</span> <span class="token number">0</span>
m<span class="token operator">=</span>video <span class="token number">6000</span> RTP<span class="token operator">/</span>AVP <span class="token number">96</span> <span class="token number">98</span> <span class="token number">97</span>
a<span class="token operator">=</span>recvonly
a<span class="token operator">=</span>rtpmap<span class="token operator">:</span><span class="token number">96</span> PS<span class="token operator">/</span><span class="token number">90000</span>
a<span class="token operator">=</span>rtpmap<span class="token operator">:</span><span class="token number">98</span> H264<span class="token operator">/</span><span class="token number">90000</span>
a<span class="token operator">=</span>rtpmap<span class="token operator">:</span><span class="token number">97</span> MPEG4<span class="token operator">/</span><span class="token number">90000</span>
y<span class="token operator">=</span><span class="token number">0100000001</span>
f<span class="token operator">=</span>
</code></pre> 
<h5><a id="_170"></a>第二步：【客户端&gt;&gt;服务端】</h5> 
<h6><a id="101_171"></a>先回复101</h6> 
<pre><code class="prism language-cpp">SIP<span class="token operator">/</span><span class="token number">2.0</span> <span class="token number">100</span> Trying
Via<span class="token operator">:</span> SIP<span class="token operator">/</span><span class="token number">2.0</span><span class="token operator">/</span>UDP <span class="token number">192.168</span><span class="token punctuation">.</span><span class="token number">0.107</span><span class="token operator">:</span><span class="token number">5060</span><span class="token punctuation">;</span>branch<span class="token operator">=</span>z9hG4bKee5c5d98<span class="token operator">-</span>bff9<span class="token operator">-</span><span class="token number">4f</span>3000002
From<span class="token operator">:</span> <span class="token operator">&lt;</span>sip<span class="token operator">:</span><span class="token number">44010200492000000001</span>@<span class="token number">4401020049</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>tag<span class="token operator">=</span>bccedfd0111
To<span class="token operator">:</span> <span class="token operator">&lt;</span>sip<span class="token operator">:</span><span class="token number">34020000001110000001</span>@<span class="token number">4401020049</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>tag<span class="token operator">=</span><span class="token number">5f</span>906952
Call<span class="token operator">-</span>ID<span class="token operator">:</span> helloVideo
CSeq<span class="token operator">:</span> <span class="token number">1</span> INVITE
Server<span class="token operator">:</span> Happytime Agent Ver <span class="token number">1.0</span>
Content<span class="token operator">-</span>Length<span class="token operator">:</span> <span class="token number">0</span>
</code></pre> 
<h6><a id="200_182"></a>再回复200</h6> 
<pre><code class="prism language-cpp">SIP<span class="token operator">/</span><span class="token number">2.0</span> <span class="token number">200</span> OK
Via<span class="token operator">:</span> SIP<span class="token operator">/</span><span class="token number">2.0</span><span class="token operator">/</span>UDP <span class="token number">192.168</span><span class="token punctuation">.</span><span class="token number">0.107</span><span class="token operator">:</span><span class="token number">5060</span><span class="token punctuation">;</span>branch<span class="token operator">=</span>z9hG4bKee5c5d98<span class="token operator">-</span>bff9<span class="token operator">-</span><span class="token number">4f</span>3000002
From<span class="token operator">:</span> <span class="token operator">&lt;</span>sip<span class="token operator">:</span><span class="token number">44010200492000000001</span>@<span class="token number">4401020049</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>tag<span class="token operator">=</span>bccedfd0111
To<span class="token operator">:</span> <span class="token operator">&lt;</span>sip<span class="token operator">:</span><span class="token number">34020000001110000001</span>@<span class="token number">4401020049</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>tag<span class="token operator">=</span><span class="token number">5f</span>906952
Contact<span class="token operator">:</span> <span class="token operator">&lt;</span>sip<span class="token operator">:</span><span class="token number">34020000001110000001</span>@<span class="token number">4401020049</span><span class="token operator">&gt;</span>
Call<span class="token operator">-</span>ID<span class="token operator">:</span> helloVideo
CSeq<span class="token operator">:</span> <span class="token number">1</span> INVITE
Max<span class="token operator">-</span>Forwards<span class="token operator">:</span> <span class="token number">70</span>
Allow<span class="token operator">:</span> ACK<span class="token punctuation">,</span>BYE<span class="token punctuation">,</span>CANCEL<span class="token punctuation">,</span>INVITE<span class="token punctuation">,</span>NOTIFY<span class="token punctuation">,</span>REFER<span class="token punctuation">,</span>UPDATE<span class="token punctuation">,</span>INFO
Supported<span class="token operator">:</span> timer
Session<span class="token operator">-</span>Expires<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">;</span>refresher<span class="token operator">=</span>uac
Server<span class="token operator">:</span> Happytime Agent Ver <span class="token number">1.0</span>
Content<span class="token operator">-</span>Type<span class="token operator">:</span> application<span class="token operator">/</span>sdp
Content<span class="token operator">-</span>Length<span class="token operator">:</span> <span class="token number">153</span>

v<span class="token operator">=</span><span class="token number">0</span>
o<span class="token operator">=</span><span class="token number">34020000001110000001</span> <span class="token number">0</span> <span class="token number">0</span> IN IP4 <span class="token number">192.168</span><span class="token punctuation">.</span><span class="token number">0.107</span>
s<span class="token operator">=</span>Play
c<span class="token operator">=</span>IN IP4 <span class="token number">192.168</span><span class="token punctuation">.</span><span class="token number">0.107</span>
t<span class="token operator">=</span><span class="token number">0</span> <span class="token number">0</span>
m<span class="token operator">=</span>video <span class="token number">19002</span> RTP<span class="token operator">/</span>AVP <span class="token number">96</span>
a<span class="token operator">=</span>rtpmap<span class="token operator">:</span><span class="token number">96</span> PS<span class="token operator">/</span><span class="token number">90000</span>
a<span class="token operator">=</span>sendonly

</code></pre> 
<h5><a id="ACK_210"></a>第三步：【服务端&gt;&gt;客户端】回复ACK</h5> 
<pre><code class="prism language-cpp">ACK sip<span class="token operator">:</span><span class="token number">34020000001310000002</span>@<span class="token number">4401020049</span> SIP<span class="token operator">/</span><span class="token number">2.0</span>
Call<span class="token operator">-</span>ID<span class="token operator">:</span> helloVideo
CSeq<span class="token operator">:</span> <span class="token number">1</span> ACK
From<span class="token operator">:</span> <span class="token operator">&lt;</span>sip<span class="token operator">:</span><span class="token number">44010200492000000001</span>@<span class="token number">4401020049</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>tag<span class="token operator">=</span>bccedfd0111
To<span class="token operator">:</span> <span class="token operator">&lt;</span>sip<span class="token operator">:</span><span class="token number">34020000001110000001</span>@<span class="token number">4401020049</span><span class="token operator">&gt;</span>
Max<span class="token operator">-</span>Forwards<span class="token operator">:</span> <span class="token number">70</span>
Via<span class="token operator">:</span> SIP<span class="token operator">/</span><span class="token number">2.0</span><span class="token operator">/</span>UDP <span class="token number">192.168</span><span class="token punctuation">.</span><span class="token number">0.107</span><span class="token operator">:</span><span class="token number">5060</span><span class="token punctuation">;</span>branch<span class="token operator">=</span>z9hG4bKee5c5d98<span class="token operator">-</span><span class="token number">00003</span>
Content<span class="token operator">-</span>Length<span class="token operator">:</span> <span class="token number">0</span>
</code></pre> 
<h5><a id="_222"></a>第四步：播放码流</h5> 
<h5><a id="_224"></a>第五步：【服务端&gt;&gt;客户端】停止视频请求</h5> 
<pre><code class="prism language-cpp">BYE sip<span class="token operator">:</span><span class="token number">34020000001310000002</span>@<span class="token number">4401020049</span> SIP<span class="token operator">/</span><span class="token number">2.0</span>
From<span class="token operator">:</span> <span class="token operator">&lt;</span>sip<span class="token operator">:</span><span class="token number">44010200492000000001</span>@<span class="token number">4401020049</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>tag<span class="token operator">=</span>bccedfd0111
To<span class="token operator">:</span> sip<span class="token operator">:</span><span class="token number">34020000001110000001</span>@<span class="token number">4401020049</span><span class="token punctuation">;</span>tag<span class="token operator">=</span><span class="token number">5f</span>906952
CSeq<span class="token operator">:</span> <span class="token number">2</span> BYE
Call<span class="token operator">-</span>ID<span class="token operator">:</span> helloVideo
Via<span class="token operator">:</span> SIP<span class="token operator">/</span><span class="token number">2.0</span><span class="token operator">/</span>UDP <span class="token number">192.168</span><span class="token punctuation">.</span><span class="token number">0.107</span><span class="token operator">:</span><span class="token number">5060</span><span class="token punctuation">;</span>branch<span class="token operator">=</span>z9hG4bKee5c5d98<span class="token operator">-</span><span class="token number">00004</span>
Max<span class="token operator">-</span>Forwards<span class="token operator">:</span> <span class="token number">70</span>
Content<span class="token operator">-</span>Length<span class="token operator">:</span> <span class="token number">0</span>



</code></pre> 
<h5><a id="200_238"></a>第六步：【客户端】回应200</h5> 
<pre><code class="prism language-cpp">SIP<span class="token operator">/</span><span class="token number">2.0</span> <span class="token number">200</span> OK
Via<span class="token operator">:</span> SIP<span class="token operator">/</span><span class="token number">2.0</span><span class="token operator">/</span>UDP <span class="token number">192.168</span><span class="token punctuation">.</span><span class="token number">0.107</span><span class="token operator">:</span><span class="token number">5060</span><span class="token punctuation">;</span>branch<span class="token operator">=</span>z9hG4bKee5c5d98<span class="token operator">-</span><span class="token number">00004</span>
From<span class="token operator">:</span> <span class="token operator">&lt;</span>sip<span class="token operator">:</span><span class="token number">44010200492000000001</span>@<span class="token number">4401020049</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>tag<span class="token operator">=</span>bccedfd0111
To<span class="token operator">:</span> sip<span class="token operator">:</span><span class="token number">34020000001110000001</span>@<span class="token number">4401020049</span><span class="token punctuation">;</span>tag<span class="token operator">=</span><span class="token number">5f</span>906952
Call<span class="token operator">-</span>ID<span class="token operator">:</span> helloVideo
CSeq<span class="token operator">:</span> <span class="token number">2</span> BYE
Server<span class="token operator">:</span> Happytime Agent Ver <span class="token number">1.0</span>
Content<span class="token operator">-</span>Length<span class="token operator">:</span> <span class="token number">0</span>


</code></pre> 
<h5><a id="_252"></a>第七步：【服务端】关闭视频端口</h5> 
<h4><a id="_TCP_258"></a>实时视频建立_TCP</h4> 
<hr> 
<h2><a id="_271"></a>基本要求</h2> 
<h2><a id="_279"></a>信令流程</h2> 
<p>实时视频流点播的信令流程有两种：</p> 
<ul><li>客户端主动发起</li><li>第三方呼叫控制</li></ul> 
<p>联网系统可选择其中一种或两种结合的实现方式，第三方呼叫控制的第三方控制者宜采用背靠背用户代理实现</p> 
<h3><a id="_285"></a>客户端主动发起实时音视频点播流程</h3> 
<h4><a id="_287"></a>流程</h4> 
<p><img src="https://images2.imgbox.com/aa/c0/u3OzMc2T_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/fb/cc/meUwa44L_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/44/2a/wpQzQGm9_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_295"></a>消息示范</h4> 
<p><img src="https://images2.imgbox.com/57/a7/vQdUCKf4_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/39/bd/2LZbJGdO_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/74/e9/9Fy6Ut4V_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/d0/8d/267RNX57_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/d9/c2/BdI2OUV0_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/e3/9b/oDHuh71Q_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/54/80/KjZ9EAue_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/4d/8f/6DnVpOJu_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/cf/b9/7jCZJ1W7_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/43/d9/kftCs1dA_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/ad/cb/FiX8zvNQ_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/fa/47/Ky2kYAKF_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/56/a0/qPEbBsya_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_315"></a>抓包分析</h3> 
<p>【上级平台】订阅完所有的通道之后，就可以向【下级平台】发送Invite请求流了</p> 
<pre><code class="prism language-cpp">INVITE sip<span class="token operator">:</span><span class="token number">33072752001320080039</span>@<span class="token number">10.45</span><span class="token punctuation">.</span><span class="token number">255.10</span><span class="token operator">:</span><span class="token number">5060</span> SIP<span class="token operator">/</span><span class="token number">2.0</span>
Via<span class="token operator">:</span> SIP<span class="token operator">/</span><span class="token number">2.0</span><span class="token operator">/</span>UDP <span class="token number">10.45</span><span class="token punctuation">.</span><span class="token number">255.11</span><span class="token operator">:</span><span class="token number">5060</span><span class="token punctuation">;</span>rport<span class="token punctuation">;</span>branch<span class="token operator">=</span>z9hG4bK<span class="token operator">-</span><span class="token number">469</span>C18DE<span class="token operator">-</span><span class="token number">28</span>C36C5<span class="token operator">-</span>T07h4NhO
From<span class="token operator">:</span> <span class="token operator">&lt;</span>sip<span class="token operator">:</span><span class="token number">33072700232000002456</span>@<span class="token number">3307270023</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>tag<span class="token operator">=</span><span class="token number">573748381</span>
To<span class="token operator">:</span> <span class="token operator">&lt;</span>sip<span class="token operator">:</span><span class="token number">33072752001320080039</span>@<span class="token number">10.45</span><span class="token punctuation">.</span><span class="token number">255.10</span><span class="token operator">:</span><span class="token number">5060</span><span class="token operator">&gt;</span>
Call<span class="token operator">-</span>ID<span class="token operator">:</span> <span class="token number">743791906</span>
CSeq<span class="token operator">:</span> <span class="token number">20</span> INVITE
Contact<span class="token operator">:</span> <span class="token operator">&lt;</span>sip<span class="token operator">:</span><span class="token number">33072700232000002456</span>@<span class="token number">10.45</span><span class="token punctuation">.</span><span class="token number">255.11</span><span class="token operator">:</span><span class="token number">5060</span><span class="token operator">&gt;</span>
Content<span class="token operator">-</span>Type<span class="token operator">:</span> application<span class="token operator">/</span>sdp
Max<span class="token operator">-</span>Forwards<span class="token operator">:</span> <span class="token number">70</span>
User<span class="token operator">-</span>Agent<span class="token operator">:</span> videosvr <span class="token number">1.0</span>
Subject<span class="token operator">:</span> <span class="token number">33072752001320080039</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">33072700232000002456</span><span class="token operator">:</span><span class="token number">1</span>
Content<span class="token operator">-</span>Length<span class="token operator">:</span>   <span class="token number">220</span>

v<span class="token operator">=</span><span class="token number">0</span>
o<span class="token operator">=</span><span class="token number">33072752001320080039</span> <span class="token number">0</span> <span class="token number">0</span> IN IP4 <span class="token number">10.45</span><span class="token punctuation">.</span><span class="token number">255.11</span>
s<span class="token operator">=</span>Play   <span class="token comment">// play表示播放</span>
c<span class="token operator">=</span>IN IP4 <span class="token number">10.45</span><span class="token punctuation">.</span><span class="token number">255.11</span>
t<span class="token operator">=</span><span class="token number">0</span> <span class="token number">0</span>
m<span class="token operator">=</span>video <span class="token number">31000</span> RTP<span class="token operator">/</span>AVP <span class="token number">96</span> <span class="token number">98</span> <span class="token number">97</span>
a<span class="token operator">=</span>recvonly
a<span class="token operator">=</span>rtpmap<span class="token operator">:</span><span class="token number">96</span> PS<span class="token operator">/</span><span class="token number">90000</span>
a<span class="token operator">=</span>rtpmap<span class="token operator">:</span><span class="token number">98</span> H264<span class="token operator">/</span><span class="token number">90000</span>
a<span class="token operator">=</span>rtpmap<span class="token operator">:</span><span class="token number">97</span> MPEG4<span class="token operator">/</span><span class="token number">90000</span>
y<span class="token operator">=</span><span class="token number">0727000001</span>

</code></pre> 
<p>【下级平台也就是（信令服务器）】回应如下：</p> 
<pre><code class="prism language-cpp">SIP<span class="token operator">/</span><span class="token number">2.0</span> <span class="token number">181</span> Call is being forwarded  <span class="token comment">// 181表示我已经将请求转发给下级了</span>
CSeq<span class="token operator">:</span> <span class="token number">20</span> INVITE
Call<span class="token operator">-</span>ID<span class="token operator">:</span> <span class="token number">743791906</span>
From<span class="token operator">:</span> <span class="token operator">&lt;</span>sip<span class="token operator">:</span><span class="token number">33072700232000002456</span>@<span class="token number">3307270023</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>tag<span class="token operator">=</span><span class="token number">573748381</span>
To<span class="token operator">:</span> <span class="token operator">&lt;</span>sip<span class="token operator">:</span><span class="token number">33072752001320080039</span>@<span class="token number">10.45</span><span class="token punctuation">.</span><span class="token number">255.10</span><span class="token operator">:</span><span class="token number">5060</span><span class="token operator">&gt;</span>
Via<span class="token operator">:</span> SIP<span class="token operator">/</span><span class="token number">2.0</span><span class="token operator">/</span>UDP <span class="token number">10.45</span><span class="token punctuation">.</span><span class="token number">255.11</span><span class="token operator">:</span><span class="token number">5060</span><span class="token punctuation">;</span>rport<span class="token operator">=</span><span class="token number">5060</span><span class="token punctuation">;</span>branch<span class="token operator">=</span>z9hG4bK<span class="token operator">-</span><span class="token number">469</span>C18DE<span class="token operator">-</span><span class="token number">28</span>C36C5<span class="token operator">-</span>T07h4NhO<span class="token punctuation">;</span>received<span class="token operator">=</span><span class="token number">10.45</span><span class="token punctuation">.</span><span class="token number">255.11</span>
Content<span class="token operator">-</span>Length<span class="token operator">:</span> <span class="token number">0</span>
</code></pre> 
<h2><a id="_356"></a>如何点播</h2> 
<blockquote> 
 <p>点播的基本流程</p> 
</blockquote> 
<ul><li>HTTP端—&gt;GB28181信令服务器，发起点播请求</li><li>GB28181信令服务器—&gt;设备，发起Invite(携带SDP消息体)的请求</li><li>设备—&gt;GB28181信令服务器，回复200OK (携带SDP消息体)</li><li>GB28181信令服务器—&gt;设备，发送ACK，成功建立一个会话</li><li>设备—&gt; 流媒体服务器，发送实时流</li><li>流媒体服务器—&gt;GB28181服务器，流改变事件</li><li>GB28181服务器—&gt;设备，告知流播放地址</li><li>流媒体服务器—&gt;GB28181服务器，无人观看事件</li><li>GB28181服务器—&gt;设备，发送Bye消息</li><li>设备—&gt;GB28181服务器，回复200OK</li></ul> 
<blockquote> 
 <p>点播时可能的错误</p> 
</blockquote> 
<p>（1）400错误</p> 
<p>其流程如下：</p> 
<ul><li>HTTP端—&gt;GB28181信令服务器，发起点播请求</li><li>GB28181信令服务器—&gt;设备，发起Invite(携带SDP消息体)的请求</li><li>设备—&gt;GB28181信令服务器，回复400OK (携带SDP消息体)</li></ul> 
<p>什么原因：</p> 
<ul><li>设备认为信令服务器发送了错误的消息给它，可能是消息不全或者错误，因此直接返回400</li></ul> 
<p>怎么解决：</p> 
<ul><li>抓包</li><li>直接联系设备/平台客服寻求解决</li></ul> 
<p>（2）500错误</p> 
<p>什么原因：</p> 
<ul><li>500&lt;= code &lt;= 600的错误码，一般是设备内部出了问题</li></ul> 
<p>怎么解决：</p> 
<p>怎么解决：</p> 
<ul><li>抓包</li><li>直接联系设备/平台客服寻求解决</li></ul> 
<blockquote> 
 <p>点播时超时</p> 
</blockquote> 
<p>点播超时的原因大致分为两种：点播超时和收流超时。</p> 
<p>（1）点播超时</p> 
<p>发生在哪里？</p> 
<ul><li>点播超时一般是因为信令超时，可能出现在“设备—&gt;GB28181信令服务器，回复200OK (携带SDP消息体)”这一步，即我们发送了点播消息，但是设备没有回复。</li></ul> 
<p>可能的原因：</p> 
<ul><li>设备内部错误，没能回复消息</li><li>网络原因消息未到达设备</li></ul> 
<p>（2）收流超时</p> 
<p>发生在哪里？</p> 
<ul><li>设备—&gt; 流媒体服务器，发送实时流</li><li>流媒体服务器—&gt;GB28181服务器，流改变事件</li></ul> 
<p>可能的原因：</p> 
<ul><li> <p>消息发送了但是发送到来错误的IP和端口上</p> </li><li> <p>设备内部错误未能发送流</p> </li><li> <p>设备发送了流，但是流无法识别，可能存在流不规范和网络很差的情况下</p> </li><li> <p>设备发送了流，流媒体服务器也收到了，但是它没法通过hook通知wvp，可能是因为网络连不上</p> </li><li> <p>设备发送了流，但是开启了SSRC校验，设备的流不够规范采用错误的SSRC，导致流媒体服务器选择丢弃</p> </li><li> <p><a href="https://blog.csdn.net/Upgrade_Yang/article/details/90769701">GB28181协议常见几种信令流程</a></p> </li><li> <p><a href="https://blog.csdn.net/jisuanji111111/article/details/122627514">GB28181协议–实时视音频点播（预览）</a></p> </li><li> <p><a href="https://blog.csdn.net/songxiao1988918/article/details/119681672">视频监控安防平台(企业级)-国标28181平台</a></p> </li><li> <p><a href="http://t.zoukankan.com/wanggang123-p-5724257.html" rel="nofollow">gb28181协议</a></p> </li><li> <p><a href="https://blog.csdn.net/VOlsenBerg/article/details/119328328?spm=1001.2101.3001.665%E3%80%816">文档解读</a></p> </li><li> <p><a href="https://blog.csdn.net/aflyeaglenku/article/details/51096401">实时流点播流程</a></p> </li><li> <p><a href="https://blog.csdn.net/weixin_30881367/article/details/95273026">发送流程</a></p> </li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/43e5ea973e1261eeee89417526769b60/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">满足echarts动态数据轮询，</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c91580ce9fa5804d9ed3fdac59bec4c3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">ubuntu18.04通过apt安装python3.7.7与pip3.7最新版本（python3.8同理）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>