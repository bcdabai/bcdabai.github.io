<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>机器学习实战 | emojify 使用Python创建自己的表情符号（深度学习初级） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="机器学习实战 | emojify 使用Python创建自己的表情符号（深度学习初级）" />
<meta property="og:description" content="目录 简介技术流程1. 加载依赖包2. 初始化训练和验证生成器3. 建立网络结构4. 编译和训练模型5. 保存模型权重6. 输出预测结果 完整程序1. train.py程序2. gui.py程序 简介 准备写个系列博客介绍机器学习实战中的部分公开项目。首先从初级项目开始。
本文主要介绍机器学习项目实战之训练和创建自己的表情符号。项目原网址为：Emojify – Create your own emoji with Deep Learning。
这个外文网址中的一些链接打不开，因此这里给出程序中用到的相关文件并且给出部分程序分析，希望能够帮大家从0构建深度学习项目。
技术流程 Emojify – Create your own emoji with Deep Learning，
该机器学习项目的目的是对人的面部表情进行分类并将其映射为表情符号。
程序中将建立一个卷积神经网络来识别面部表情，然后将使用相应的表情符号或头像来映射这些情感。
以下图为例，左侧摄像头实时拍摄到人脸照片，右侧显示检测结果“surprised”，并将其映射为表情符号。
1. 加载依赖包 import numpy as np import cv2 from keras.models import Sequential from keras.layers import Dense, Dropout, Flatten from keras.layers import Conv2D from keras.optimizers import Adam from keras.layers import MaxPooling2D from keras.preprocessing.image import ImageDataGenerator 解析：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/8f58f4dbe09923b1f1aa1cf2b9c6fd11/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-10T14:45:37+08:00" />
<meta property="article:modified_time" content="2023-07-10T14:45:37+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">机器学习实战 | emojify 使用Python创建自己的表情符号（深度学习初级）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#_2" rel="nofollow">简介</a></li><li><a href="#_9" rel="nofollow">技术流程</a></li><li><ul><li><a href="#1__19" rel="nofollow">1. 加载依赖包</a></li><li><a href="#2__47" rel="nofollow">2. 初始化训练和验证生成器</a></li><li><a href="#3__78" rel="nofollow">3. 建立网络结构</a></li><li><a href="#4__103" rel="nofollow">4. 编译和训练模型</a></li><li><a href="#5__117" rel="nofollow">5. 保存模型权重</a></li><li><a href="#6__125" rel="nofollow">6. 输出预测结果</a></li></ul> 
  </li><li><a href="#_167" rel="nofollow">完整程序</a></li><li><ul><li><a href="#1_trainpy_173" rel="nofollow">1. train.py程序</a></li><li><a href="#2_guipy_293" rel="nofollow">2. gui.py程序</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_2"></a>简介</h2> 
<p>准备写个系列博客介绍机器学习实战中的部分公开项目。首先从初级项目开始。</p> 
<hr> 
<p>本文主要介绍机器学习项目实战之<strong>训练和创建自己的表情符号</strong>。项目原网址为：<a href="https://data-flair.training/blogs/create-emoji-with-deep-learning/" rel="nofollow">Emojify – Create your own emoji with Deep Learning</a>。</p> 
<p>这个外文网址中的一些链接打不开，因此这里给出<strong>程序中用到的相关文件</strong>并且<strong>给出部分程序分析</strong>，希望能够帮大家从0构建深度学习项目。</p> 
<h2><a id="_9"></a>技术流程</h2> 
<p>Emojify – Create your own emoji with Deep Learning，<br> 该机器学习项目的目的是对人的面部表情进行分类并将其映射为表情符号。<br> 程序中将建立一个<strong>卷积神经网络</strong>来识别面部表情，然后将使用相应的表情符号或头像来映射这些情感。</p> 
<p><strong>以下图为例</strong>，左侧摄像头实时拍摄到人脸照片，右侧显示检测结果“surprised”，并将其映射为表情符号。<br> <img src="https://images2.imgbox.com/da/90/mU97JRe9_o.png" alt="在这里插入图片描述" width="400" height="300"></p> 
<h3><a id="1__19"></a>1. 加载依赖包</h3> 
<pre><code class="prism language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> cv2
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>models <span class="token keyword">import</span> Sequential
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>layers <span class="token keyword">import</span> Dense<span class="token punctuation">,</span> Dropout<span class="token punctuation">,</span> Flatten
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>layers <span class="token keyword">import</span> Conv2D
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>optimizers <span class="token keyword">import</span> Adam
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>layers <span class="token keyword">import</span> MaxPooling2D
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>preprocessing<span class="token punctuation">.</span>image <span class="token keyword">import</span> ImageDataGenerator
</code></pre> 
<p><strong>解析：</strong></p> 
<p>这个项目的深度学习网络调用了<code>keras</code>包，因此需要提前在电脑里安装<code>keras</code>和<code>TensorFlow</code>， 我配置成功的包版本为：</p> 
<blockquote> 
 <p>keras 2.10.0<br> tensorflow 2.10.0</p> 
</blockquote> 
<p>命令行安装命令为：</p> 
<pre><code class="prism language-python">pip install keras<span class="token operator">==</span><span class="token number">2.10</span><span class="token number">.0</span>
pip install TensorFlow<span class="token operator">==</span><span class="token number">2.10</span><span class="token number">.0</span>
</code></pre> 
<p>除此之外其他安装包如有需要，也就是说运行程序提示<code>缺少**包</code>，就相应安装什么包。</p> 
<h3><a id="2__47"></a>2. 初始化训练和验证生成器</h3> 
<pre><code class="prism language-python">train_dir <span class="token operator">=</span> <span class="token string">'data/train'</span>
val_dir <span class="token operator">=</span> <span class="token string">'data/test'</span>
train_datagen <span class="token operator">=</span> ImageDataGenerator<span class="token punctuation">(</span>rescale<span class="token operator">=</span><span class="token number">1.</span><span class="token operator">/</span><span class="token number">255</span><span class="token punctuation">)</span>
val_datagen <span class="token operator">=</span> ImageDataGenerator<span class="token punctuation">(</span>rescale<span class="token operator">=</span><span class="token number">1.</span><span class="token operator">/</span><span class="token number">255</span><span class="token punctuation">)</span>

train_generator <span class="token operator">=</span> train_datagen<span class="token punctuation">.</span>flow_from_directory<span class="token punctuation">(</span>
        train_dir<span class="token punctuation">,</span>
        target_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">48</span><span class="token punctuation">,</span> <span class="token number">48</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        batch_size<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span>
        color_mode<span class="token operator">=</span><span class="token string">"grayscale"</span><span class="token punctuation">,</span>
        class_mode<span class="token operator">=</span><span class="token string">'categorical'</span><span class="token punctuation">)</span>

validation_generator <span class="token operator">=</span> val_datagen<span class="token punctuation">.</span>flow_from_directory<span class="token punctuation">(</span>
        val_dir<span class="token punctuation">,</span>
        target_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        batch_size<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span>
        color_mode<span class="token operator">=</span><span class="token string">"grayscale"</span><span class="token punctuation">,</span>
        class_mode<span class="token operator">=</span><span class="token string">'categorical'</span><span class="token punctuation">)</span>
</code></pre> 
<p>解析：</p> 
<ul><li>ImageDataGenerator：from keras.preprocessing.image import ImageDataGenerator， 对图片进行批量预处理</li><li>flow_from_directory：以文件夹路径为参数，生成经过数据提升/归一化后的数据，参数包括目录名val_dir、批尺寸batch_size等。</li></ul> 
<blockquote> 
 <p><code>batch_size</code> 表示一次迭代所需要的样本量，batch_size=total即梯度下降法，bach_size=1即随机梯度下降法SGD；<br> <code>iteration</code> 表示迭代次数，跑完一个batch更新参数；<br> <code>epoch</code> 表示所有样本训练一遍。</p> 
</blockquote> 
<h3><a id="3__78"></a>3. 建立网络结构</h3> 
<pre><code class="prism language-python">emotion_model <span class="token operator">=</span> Sequential<span class="token punctuation">(</span><span class="token punctuation">)</span>

emotion_model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Conv2D<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">,</span> input_shape<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
emotion_model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Conv2D<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
emotion_model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>MaxPooling2D<span class="token punctuation">(</span>pool_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
emotion_model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Dropout<span class="token punctuation">(</span><span class="token number">0.25</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

emotion_model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Conv2D<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
emotion_model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>MaxPooling2D<span class="token punctuation">(</span>pool_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
emotion_model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Conv2D<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
emotion_model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>MaxPooling2D<span class="token punctuation">(</span>pool_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
emotion_model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Dropout<span class="token punctuation">(</span><span class="token number">0.25</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

emotion_model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
emotion_model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Dense<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
emotion_model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Dropout<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
emotion_model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Dense<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'softmax'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li>Sequential(): 序贯模型，与函数式模型对立。from keras.models import Sequential， 序贯模型通过一层层神经网络连接构建深度神经网络。</li><li>add(): 叠加网络层，参数可为conv2D卷积神经网络层，MaxPooling2D二维最大池化层，Dropout随机失活层（防止过拟合），Dense密集层（全连接FC层，在Keras层中FC层被写作Dense层）。</li></ul> 
<blockquote> 
 <p>函数式模型：Model()， 调用已经训练好的模型，比如VGG、Inception等神经网络结构，多输入、多输出模型。</p> 
</blockquote> 
<h3><a id="4__103"></a>4. 编译和训练模型</h3> 
<pre><code class="prism language-python">emotion_model<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span>loss<span class="token operator">=</span><span class="token string">'categorical_crossentropy'</span><span class="token punctuation">,</span>optimizer<span class="token operator">=</span>Adam<span class="token punctuation">(</span>lr<span class="token operator">=</span><span class="token number">0.0001</span><span class="token punctuation">,</span> decay<span class="token operator">=</span><span class="token number">1e-6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>metrics<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'accuracy'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
emotion_model_info <span class="token operator">=</span> emotion_model<span class="token punctuation">.</span>fit_generator<span class="token punctuation">(</span>
        train_generator<span class="token punctuation">,</span>
        steps_per_epoch<span class="token operator">=</span><span class="token number">28709</span> <span class="token operator">//</span> <span class="token number">64</span><span class="token punctuation">,</span>
        epochs<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span>
        validation_data<span class="token operator">=</span>validation_generator<span class="token punctuation">,</span>
        validation_steps<span class="token operator">=</span><span class="token number">7178</span> <span class="token operator">//</span> <span class="token number">64</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li>compile(): 编译神经网络结构，参数包括：loss，字符串结构，指定损失函数；optimizer，表示优化方式；metrics，列表，用来衡量模型指标。</li><li>fit_generator: 在搭建完成后，将数据送入模型进行训练，返回一个history对象，记录训练过程中的损失和评估值。参数包括：generator，生成器函数，steps_per_epoch: 每个epoch中生成器执行生成数据的次数；epochs，迭代次数；valdation_data: 数据集验证。</li></ul> 
<h3><a id="5__117"></a>5. 保存模型权重</h3> 
<pre><code class="prism language-python">emotion_model<span class="token punctuation">.</span>save_weights<span class="token punctuation">(</span><span class="token string">'emotion_model.h5'</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li>save_weights: 保存模型权重</li></ul> 
<h3><a id="6__125"></a>6. 输出预测结果</h3> 
<pre><code class="prism language-python">cv2<span class="token punctuation">.</span>ocl<span class="token punctuation">.</span>setUseOpenCL<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
emotion_dict <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">"Angry"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span> <span class="token string">"Disgusted"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span> <span class="token string">"Fearful"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">:</span> <span class="token string">"Happy"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">:</span> <span class="token string">"Neutral"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span> <span class="token string">"Sad"</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">:</span> <span class="token string">"Surprised"</span><span class="token punctuation">}</span>

<span class="token comment"># start the webcam feed</span>
cap <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoCapture<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    <span class="token comment"># Find haar cascade to draw bounding box around face</span>
    ret<span class="token punctuation">,</span> frame <span class="token operator">=</span> cap<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    frame <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token keyword">not</span> ret<span class="token punctuation">:</span>
        <span class="token keyword">break</span>

    bounding_box <span class="token operator">=</span> cv2<span class="token punctuation">.</span>CascadeClassifier<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>data<span class="token punctuation">.</span>haarcascades <span class="token operator">+</span> <span class="token string">'haarcascade_frontalface_default.xml'</span><span class="token punctuation">)</span>

    gray_frame <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2GRAY<span class="token punctuation">)</span>
    num_faces <span class="token operator">=</span> bounding_box<span class="token punctuation">.</span>detectMultiScale<span class="token punctuation">(</span>gray_frame<span class="token punctuation">,</span> scaleFactor<span class="token operator">=</span><span class="token number">1.3</span><span class="token punctuation">,</span> minNeighbors<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">)</span> <span class="token keyword">in</span> num_faces<span class="token punctuation">:</span>
        cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token operator">-</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token operator">+</span>w<span class="token punctuation">,</span> y<span class="token operator">+</span>h<span class="token operator">+</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
        roi_gray_frame <span class="token operator">=</span> gray_frame<span class="token punctuation">[</span>y<span class="token punctuation">:</span>y <span class="token operator">+</span> h<span class="token punctuation">,</span> x<span class="token punctuation">:</span>x <span class="token operator">+</span> w<span class="token punctuation">]</span>
        cropped_img <span class="token operator">=</span> np<span class="token punctuation">.</span>expand_dims<span class="token punctuation">(</span>np<span class="token punctuation">.</span>expand_dims<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>roi_gray_frame<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">48</span><span class="token punctuation">,</span> <span class="token number">48</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        emotion_prediction <span class="token operator">=</span> emotion_model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>cropped_img<span class="token punctuation">)</span>
        maxindex <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>emotion_prediction<span class="token punctuation">)</span><span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> emotion_dict<span class="token punctuation">[</span>maxindex<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token operator">+</span><span class="token number">20</span><span class="token punctuation">,</span> y<span class="token operator">-</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>FONT_HERSHEY_SIMPLEX<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>LINE_AA<span class="token punctuation">)</span>

    cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">'Video'</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>frame<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">,</span> interpolation<span class="token operator">=</span>cv2<span class="token punctuation">.</span>INTER_CUBIC<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span> <span class="token operator">==</span> <span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">'q'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">break</span>

cap<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
cv2<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>使用openCV中<code>haarcascade. xml</code>检测网络摄像头中人脸的边界框，并预测情绪.</p> 
<ul><li>cv2.ocl.setUseOpenCL(False)：关闭OpenGL加速。</li><li>cv2.VideoCapture( )：输入参数为0时表示调用/打开笔记本的内置摄像头；参数为文件路径名时表示打开指定视频文件。</li><li>cv2.CascadeClassifier()：加载人脸harr级联分类器。该步骤容易包括，安装的OpenCV包中可能不包含该文件，为了方便大家调试，将该文件压缩上传到：<a href="https://download.csdn.net/download/lovetaozibaby/87971972?spm=1001.2014.3001.5501">人脸harr级联分类器保存的.xml文件</a>，下载完后解压保存在cv2.data.haarcascades默认路径下，cv2.data.haarcascades表示输出cv2.data的路径，默认地址为：<code>**\anaconda3\lib\site-packages\cv2\data</code>。</li><li>detectMultiScale：输入参数包括：minNeighbors，每一个目标至少被检测到的次数；minSize，目标最小尺寸；maxSize：目标最大尺寸等。通过灵活调节这三个参数可以用来排除干扰项。</li></ul> 
<h2><a id="_167"></a>完整程序</h2> 
<p><code>train.py</code> : 人脸情绪训练代码。此外，将第4节训练过程备注，增加调用程序，可以用来实时测试结果。</p> 
<p><code>gui.py</code>: GUI窗口，输出可互动的界面。</p> 
<h3><a id="1_trainpy_173"></a>1. train.py程序</h3> 
<pre><code class="prism language-python"><span class="token triple-quoted-string string">"""
Emojify--create your own emoji with deep learning
"""</span>

<span class="token triple-quoted-string string">"""
1. Imports
"""</span>
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> cv2
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>models <span class="token keyword">import</span> Sequential
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>layers <span class="token keyword">import</span> Dense<span class="token punctuation">,</span> Dropout<span class="token punctuation">,</span> Flatten
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>layers <span class="token keyword">import</span> Conv2D
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>optimizers <span class="token keyword">import</span> Adam
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>layers <span class="token keyword">import</span> MaxPooling2D
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>preprocessing<span class="token punctuation">.</span>image <span class="token keyword">import</span> ImageDataGenerator

<span class="token triple-quoted-string string">"""
2. Initialize the training and validation generators
"""</span>
train_dir <span class="token operator">=</span> <span class="token string">'data/train'</span>
val_dir <span class="token operator">=</span> <span class="token string">'data/test'</span>
train_datagen <span class="token operator">=</span> ImageDataGenerator<span class="token punctuation">(</span>rescale<span class="token operator">=</span><span class="token number">1.</span><span class="token operator">/</span><span class="token number">255</span><span class="token punctuation">)</span>
val_datagen <span class="token operator">=</span> ImageDataGenerator<span class="token punctuation">(</span>rescale<span class="token operator">=</span><span class="token number">1.</span><span class="token operator">/</span><span class="token number">255</span><span class="token punctuation">)</span>

train_generator <span class="token operator">=</span> train_datagen<span class="token punctuation">.</span>flow_from_directory<span class="token punctuation">(</span>
        train_dir<span class="token punctuation">,</span>
        target_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">48</span><span class="token punctuation">,</span> <span class="token number">48</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        batch_size<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span>
        color_mode<span class="token operator">=</span><span class="token string">"grayscale"</span><span class="token punctuation">,</span>
        class_mode<span class="token operator">=</span><span class="token string">'categorical'</span><span class="token punctuation">)</span>

validation_generator <span class="token operator">=</span> val_datagen<span class="token punctuation">.</span>flow_from_directory<span class="token punctuation">(</span>
        val_dir<span class="token punctuation">,</span>
        target_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        batch_size<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span>
        color_mode<span class="token operator">=</span><span class="token string">"grayscale"</span><span class="token punctuation">,</span>
        class_mode<span class="token operator">=</span><span class="token string">'categorical'</span><span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
3. Build convolution network architecture 
"""</span>
emotion_model <span class="token operator">=</span> Sequential<span class="token punctuation">(</span><span class="token punctuation">)</span>

emotion_model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Conv2D<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">,</span> input_shape<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
emotion_model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Conv2D<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
emotion_model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>MaxPooling2D<span class="token punctuation">(</span>pool_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
emotion_model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Dropout<span class="token punctuation">(</span><span class="token number">0.25</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

emotion_model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Conv2D<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
emotion_model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>MaxPooling2D<span class="token punctuation">(</span>pool_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
emotion_model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Conv2D<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
emotion_model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>MaxPooling2D<span class="token punctuation">(</span>pool_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
emotion_model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Dropout<span class="token punctuation">(</span><span class="token number">0.25</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

emotion_model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
emotion_model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Dense<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
emotion_model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Dropout<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
emotion_model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Dense<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'softmax'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token triple-quoted-string string">"""
4. Compile and train the model
"""</span>
<span class="token comment"># emotion_model.compile(loss='categorical_crossentropy',optimizer=Adam(lr=0.0001, decay=1e-6),metrics=['accuracy'])</span>
<span class="token comment"># emotion_model_info = emotion_model.fit_generator(</span>
<span class="token comment">#         train_generator,</span>
<span class="token comment">#         steps_per_epoch=28709 // 64,</span>
<span class="token comment">#         epochs=50,</span>
<span class="token comment">#         validation_data=validation_generator,</span>
<span class="token comment">#         validation_steps=7178 // 64)</span>
<span class="token comment">#</span>
<span class="token comment"># """</span>
<span class="token comment"># 5. Save the model weights</span>
<span class="token comment"># """</span>
<span class="token comment"># emotion_model.save_weights('emotion_model.h5')</span>

<span class="token triple-quoted-string string">"""
6. Using openCV haarcascade xml detect the bounding boxes of face in the webcam and predict the emotions
"""</span>

<span class="token comment"># 加载已经训练好的表情识别权重</span>
emotion_model<span class="token punctuation">.</span>load_weights<span class="token punctuation">(</span><span class="token string">'emotion_model.h5'</span><span class="token punctuation">)</span>

cv2<span class="token punctuation">.</span>ocl<span class="token punctuation">.</span>setUseOpenCL<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
emotion_dict <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">"Angry"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span> <span class="token string">"Disgusted"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span> <span class="token string">"Fearful"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">:</span> <span class="token string">"Happy"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">:</span> <span class="token string">"Neutral"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span> <span class="token string">"Sad"</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">:</span> <span class="token string">"Surprised"</span><span class="token punctuation">}</span>

<span class="token comment"># start the webcam feed</span>
cap <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoCapture<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    <span class="token comment"># Find haar cascade to draw bounding box around face</span>
    ret<span class="token punctuation">,</span> frame <span class="token operator">=</span> cap<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    frame <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token keyword">not</span> ret<span class="token punctuation">:</span>
        <span class="token keyword">break</span>

    bounding_box <span class="token operator">=</span> cv2<span class="token punctuation">.</span>CascadeClassifier<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>data<span class="token punctuation">.</span>haarcascades <span class="token operator">+</span> <span class="token string">'haarcascade_frontalface_default.xml'</span><span class="token punctuation">)</span>

    gray_frame <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2GRAY<span class="token punctuation">)</span>
    num_faces <span class="token operator">=</span> bounding_box<span class="token punctuation">.</span>detectMultiScale<span class="token punctuation">(</span>gray_frame<span class="token punctuation">,</span> scaleFactor<span class="token operator">=</span><span class="token number">1.3</span><span class="token punctuation">,</span> minNeighbors<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">)</span> <span class="token keyword">in</span> num_faces<span class="token punctuation">:</span>
        cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token operator">-</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token operator">+</span>w<span class="token punctuation">,</span> y<span class="token operator">+</span>h<span class="token operator">+</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
        roi_gray_frame <span class="token operator">=</span> gray_frame<span class="token punctuation">[</span>y<span class="token punctuation">:</span>y <span class="token operator">+</span> h<span class="token punctuation">,</span> x<span class="token punctuation">:</span>x <span class="token operator">+</span> w<span class="token punctuation">]</span>
        cropped_img <span class="token operator">=</span> np<span class="token punctuation">.</span>expand_dims<span class="token punctuation">(</span>np<span class="token punctuation">.</span>expand_dims<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>roi_gray_frame<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">48</span><span class="token punctuation">,</span> <span class="token number">48</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        emotion_prediction <span class="token operator">=</span> emotion_model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>cropped_img<span class="token punctuation">)</span>
        maxindex <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>emotion_prediction<span class="token punctuation">)</span><span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> emotion_dict<span class="token punctuation">[</span>maxindex<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token operator">+</span><span class="token number">20</span><span class="token punctuation">,</span> y<span class="token operator">-</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>FONT_HERSHEY_SIMPLEX<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>LINE_AA<span class="token punctuation">)</span>

    cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">'Video'</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>frame<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">,</span> interpolation<span class="token operator">=</span>cv2<span class="token punctuation">.</span>INTER_CUBIC<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span> <span class="token operator">==</span> <span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">'q'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">break</span>

cap<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
cv2<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="2_guipy_293"></a>2. gui.py程序</h3> 
<pre><code class="prism language-python">
<span class="token triple-quoted-string string">"""
Code for GUI and mapping with emojis
"""</span>

<span class="token keyword">import</span> tkinter <span class="token keyword">as</span> tk
<span class="token keyword">from</span> tkinter <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> cv2
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image<span class="token punctuation">,</span> ImageTk
<span class="token keyword">import</span> os
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> cv2
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>models <span class="token keyword">import</span> Sequential
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>layers <span class="token keyword">import</span> Dense<span class="token punctuation">,</span> Dropout<span class="token punctuation">,</span> Flatten
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>layers <span class="token keyword">import</span> Conv2D
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>optimizers <span class="token keyword">import</span> Adam
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>layers <span class="token keyword">import</span> MaxPooling2D
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>preprocessing<span class="token punctuation">.</span>image <span class="token keyword">import</span> ImageDataGenerator

emotion_model <span class="token operator">=</span> Sequential<span class="token punctuation">(</span><span class="token punctuation">)</span>

emotion_model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Conv2D<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">,</span> input_shape<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
emotion_model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Conv2D<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
emotion_model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>MaxPooling2D<span class="token punctuation">(</span>pool_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
emotion_model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Dropout<span class="token punctuation">(</span><span class="token number">0.25</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

emotion_model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Conv2D<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
emotion_model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>MaxPooling2D<span class="token punctuation">(</span>pool_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
emotion_model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Conv2D<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
emotion_model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>MaxPooling2D<span class="token punctuation">(</span>pool_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
emotion_model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Dropout<span class="token punctuation">(</span><span class="token number">0.25</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

emotion_model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
emotion_model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Dense<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
emotion_model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Dropout<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
emotion_model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Dense<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'softmax'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
emotion_model<span class="token punctuation">.</span>load_weights<span class="token punctuation">(</span><span class="token string">'emotion_model.h5'</span><span class="token punctuation">)</span>

cv2<span class="token punctuation">.</span>ocl<span class="token punctuation">.</span>setUseOpenCL<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>

emotion_dict <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">"   Angry   "</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span> <span class="token string">"Disgusted"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span> <span class="token string">"  Fearful  "</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">:</span> <span class="token string">"   Happy   "</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">:</span> <span class="token string">"  Neutral  "</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span> <span class="token string">"    Sad    "</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">:</span> <span class="token string">"Surprised"</span><span class="token punctuation">}</span>


emoji_dist<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">:</span><span class="token string">"./emojis/angry.png"</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token string">"./emojis/disgusted.png"</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token string">"./emojis/fearful.png"</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token string">"./emojis/happy.png"</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token string">"./emojis/neutral.png"</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token string">"./emojis/sad.png"</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token string">"./emojis/surpriced.png"</span><span class="token punctuation">}</span>

<span class="token keyword">global</span> last_frame1                                    
last_frame1 <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">480</span><span class="token punctuation">,</span> <span class="token number">640</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
<span class="token keyword">global</span> cap1
show_text<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token keyword">def</span> <span class="token function">show_vid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>      
    cap1 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoCapture<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                                 
    <span class="token keyword">if</span> <span class="token keyword">not</span> cap1<span class="token punctuation">.</span>isOpened<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                             
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"cant open the camera1"</span><span class="token punctuation">)</span>
    flag1<span class="token punctuation">,</span> frame1 <span class="token operator">=</span> cap1<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    frame1 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>frame1<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">600</span><span class="token punctuation">,</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    bounding_box <span class="token operator">=</span> cv2<span class="token punctuation">.</span>CascadeClassifier<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>data<span class="token punctuation">.</span>haarcascades <span class="token operator">+</span> <span class="token string">'haarcascade_frontalface_default.xml'</span><span class="token punctuation">)</span>
    gray_frame <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>frame1<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2GRAY<span class="token punctuation">)</span>
    num_faces <span class="token operator">=</span> bounding_box<span class="token punctuation">.</span>detectMultiScale<span class="token punctuation">(</span>gray_frame<span class="token punctuation">,</span>scaleFactor<span class="token operator">=</span><span class="token number">1.3</span><span class="token punctuation">,</span> minNeighbors<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">)</span> <span class="token keyword">in</span> num_faces<span class="token punctuation">:</span>
        cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>frame1<span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token operator">-</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token operator">+</span>w<span class="token punctuation">,</span> y<span class="token operator">+</span>h<span class="token operator">+</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
        roi_gray_frame <span class="token operator">=</span> gray_frame<span class="token punctuation">[</span>y<span class="token punctuation">:</span>y <span class="token operator">+</span> h<span class="token punctuation">,</span> x<span class="token punctuation">:</span>x <span class="token operator">+</span> w<span class="token punctuation">]</span>
        cropped_img <span class="token operator">=</span> np<span class="token punctuation">.</span>expand_dims<span class="token punctuation">(</span>np<span class="token punctuation">.</span>expand_dims<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>roi_gray_frame<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">48</span><span class="token punctuation">,</span> <span class="token number">48</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        prediction <span class="token operator">=</span> emotion_model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>cropped_img<span class="token punctuation">)</span>
        
        maxindex <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>prediction<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># cv2.putText(frame1, emotion_dict[maxindex], (x+20, y-60), cv2.FONT_HERSHEY_SIMPLEX, 1, (255, 255, 255), 2, cv2.LINE_AA)</span>
        show_text<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>maxindex
    <span class="token keyword">if</span> flag1 <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">"Major error!"</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> flag1<span class="token punctuation">:</span>
        <span class="token keyword">global</span> last_frame1
        last_frame1 <span class="token operator">=</span> frame1<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
        pic <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>last_frame1<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2RGB<span class="token punctuation">)</span>     
        img <span class="token operator">=</span> Image<span class="token punctuation">.</span>fromarray<span class="token punctuation">(</span>pic<span class="token punctuation">)</span>
        imgtk <span class="token operator">=</span> ImageTk<span class="token punctuation">.</span>PhotoImage<span class="token punctuation">(</span>image<span class="token operator">=</span>img<span class="token punctuation">)</span>
        lmain<span class="token punctuation">.</span>imgtk <span class="token operator">=</span> imgtk
        lmain<span class="token punctuation">.</span>configure<span class="token punctuation">(</span>image<span class="token operator">=</span>imgtk<span class="token punctuation">)</span>
        <span class="token comment"># lmain.after(10, show_vid)</span>
    <span class="token keyword">if</span> cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span> <span class="token operator">==</span> <span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">'q'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        exit<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">show_vid2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    frame2<span class="token operator">=</span>cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>emoji_dist<span class="token punctuation">[</span>show_text<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    pic2<span class="token operator">=</span>cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>frame2<span class="token punctuation">,</span>cv2<span class="token punctuation">.</span>COLOR_BGR2RGB<span class="token punctuation">)</span>
    img2<span class="token operator">=</span>Image<span class="token punctuation">.</span>fromarray<span class="token punctuation">(</span>frame2<span class="token punctuation">)</span>
    imgtk2<span class="token operator">=</span>ImageTk<span class="token punctuation">.</span>PhotoImage<span class="token punctuation">(</span>image<span class="token operator">=</span>img2<span class="token punctuation">)</span>
    lmain2<span class="token punctuation">.</span>imgtk2<span class="token operator">=</span>imgtk2
    lmain3<span class="token punctuation">.</span>configure<span class="token punctuation">(</span>text<span class="token operator">=</span>emotion_dict<span class="token punctuation">[</span>show_text<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>font<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">'arial'</span><span class="token punctuation">,</span><span class="token number">45</span><span class="token punctuation">,</span><span class="token string">'bold'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    lmain2<span class="token punctuation">.</span>configure<span class="token punctuation">(</span>image<span class="token operator">=</span>imgtk2<span class="token punctuation">)</span>
    <span class="token comment"># lmain2.after(10, show_vid2)</span>
<span class="token comment">#</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    root<span class="token operator">=</span>tk<span class="token punctuation">.</span>Tk<span class="token punctuation">(</span><span class="token punctuation">)</span>   
    img <span class="token operator">=</span> ImageTk<span class="token punctuation">.</span>PhotoImage<span class="token punctuation">(</span>Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"logo.png"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    heading <span class="token operator">=</span> Label<span class="token punctuation">(</span>root<span class="token punctuation">,</span>image<span class="token operator">=</span>img<span class="token punctuation">,</span>bg<span class="token operator">=</span><span class="token string">'black'</span><span class="token punctuation">)</span>
    
    heading<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token punctuation">)</span> 
    heading2<span class="token operator">=</span>Label<span class="token punctuation">(</span>root<span class="token punctuation">,</span>text<span class="token operator">=</span><span class="token string">"Photo to Emoji"</span><span class="token punctuation">,</span>pady<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> font<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">'arial'</span><span class="token punctuation">,</span><span class="token number">45</span><span class="token punctuation">,</span><span class="token string">'bold'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>bg<span class="token operator">=</span><span class="token string">'black'</span><span class="token punctuation">,</span>fg<span class="token operator">=</span><span class="token string">'#CDCDCD'</span><span class="token punctuation">)</span>                                 
    
    heading2<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token punctuation">)</span>
    lmain <span class="token operator">=</span> tk<span class="token punctuation">.</span>Label<span class="token punctuation">(</span>master<span class="token operator">=</span>root<span class="token punctuation">,</span>padx<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span>bd<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
    lmain2 <span class="token operator">=</span> tk<span class="token punctuation">.</span>Label<span class="token punctuation">(</span>master<span class="token operator">=</span>root<span class="token punctuation">,</span>bd<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>

    lmain3<span class="token operator">=</span>tk<span class="token punctuation">.</span>Label<span class="token punctuation">(</span>master<span class="token operator">=</span>root<span class="token punctuation">,</span>bd<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>fg<span class="token operator">=</span><span class="token string">"#CDCDCD"</span><span class="token punctuation">,</span>bg<span class="token operator">=</span><span class="token string">'black'</span><span class="token punctuation">)</span>
    lmain<span class="token punctuation">.</span>pack<span class="token punctuation">(</span>side<span class="token operator">=</span>LEFT<span class="token punctuation">)</span>
    lmain<span class="token punctuation">.</span>place<span class="token punctuation">(</span>x<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span>y<span class="token operator">=</span><span class="token number">250</span><span class="token punctuation">)</span>
    lmain3<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token punctuation">)</span>
    lmain3<span class="token punctuation">.</span>place<span class="token punctuation">(</span>x<span class="token operator">=</span><span class="token number">960</span><span class="token punctuation">,</span>y<span class="token operator">=</span><span class="token number">250</span><span class="token punctuation">)</span>
    lmain2<span class="token punctuation">.</span>pack<span class="token punctuation">(</span>side<span class="token operator">=</span>RIGHT<span class="token punctuation">)</span>
    lmain2<span class="token punctuation">.</span>place<span class="token punctuation">(</span>x<span class="token operator">=</span><span class="token number">900</span><span class="token punctuation">,</span>y<span class="token operator">=</span><span class="token number">350</span><span class="token punctuation">)</span>
    


    root<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"Photo To Emoji"</span><span class="token punctuation">)</span>            
    root<span class="token punctuation">.</span>geometry<span class="token punctuation">(</span><span class="token string">"1400x900+100+10"</span><span class="token punctuation">)</span> 
    root<span class="token punctuation">[</span><span class="token string">'bg'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'black'</span>
    exitbutton <span class="token operator">=</span> Button<span class="token punctuation">(</span>root<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">'Quit'</span><span class="token punctuation">,</span>fg<span class="token operator">=</span><span class="token string">"red"</span><span class="token punctuation">,</span>command<span class="token operator">=</span>root<span class="token punctuation">.</span>destroy<span class="token punctuation">,</span>font<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">'arial'</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token string">'bold'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>pack<span class="token punctuation">(</span>side <span class="token operator">=</span> BOTTOM<span class="token punctuation">)</span>
    show_vid<span class="token punctuation">(</span><span class="token punctuation">)</span>
    show_vid2<span class="token punctuation">(</span><span class="token punctuation">)</span>
    root<span class="token punctuation">.</span>mainloop<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>gui.py输出结果：<br> <img src="https://images2.imgbox.com/cf/4f/pg1n8zDB_o.png" alt="在这里插入图片描述" width="400" height="270"></p> 
<hr> 
<p>如有问题，欢迎指出和讨论。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/84319dcf35cb35dd19990cf31cd78de9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">整数区间----贪心2 (爱思创)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/56192e5cd8486705d0051535e44c120c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">oracle和kingbase的sql语法区别</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>