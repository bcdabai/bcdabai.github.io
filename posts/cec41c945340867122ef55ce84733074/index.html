<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>H264编解码SPS、PPS参数说明 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="H264编解码SPS、PPS参数说明" />
<meta property="og:description" content="H264编解码参数说明 一、H264码流分层1、NAL层①、如何判断帧类型（是图像参考帧还是I、P帧等）？②、 帧格式③、 [SPS格式解析代码分析 ParseAndRewriteSps方法 ](https://github.com/chensongpoixs/cwebrtc/blob/chensong/common_video/h264/sps_vui_rewriter.cc) 2、 VCL层3、 码流基本概念①、 SODB（String Of Data Bits）②、 RBSP（Raw Byte Sequence Payload）③、 NALU 单元④ SPS/PPS/Slice Header⑤ [webrtc中对应RBSP的代码 段 方法SpsVuiRewriter::ParseAndRewriteSps](https://github.com/chensongpoixs/cwebrtc/blob/chensong/common_video/h264/sps_vui_rewriter.cc) 二, SPS中两个重要的参数分别是 Profile 与 Level1、 H264 Profile2、 H264 Level3、 分辨率4、 帧相关的①、 帧数 log2_max_frame_num_minus4②、 参考帧数 max_num_ref_frames③、 显示帧序号 pic_order_cnt_type 5、 帧率的计算 三、 PPS与 Slice Header6、Slice Header①、 帧类型②、 GOP中解码帧序号③、 预测权重④、 滤波 音视频基础学习实验地址：https://github.com/chensongpoixs/caudio_video
一、H264码流分层 1、NAL层 Network Abstraction Layer,视频数据网络抽样层。
①、如何判断帧类型（是图像参考帧还是I、P帧等）？ NALU类型是我们判断帧类型的利器，从官方文档中得出如下图：
我们还是接着看最上面图的码流对应的数据来层层分析，以00 00 00 01分割之后的下一个字节就是NALU类型，将其转为二进制数据后，解读顺序为从左往右算，如下:
（1）第1位禁止位，值为1表示语法出错
（2）第2~3位为参考级别
（3）第4~8为是nal单元类型
例如上面00000001后有67,68以及65
其中0x67的二进制码为：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/cec41c945340867122ef55ce84733074/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-04T19:35:11+08:00" />
<meta property="article:modified_time" content="2022-04-04T19:35:11+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">H264编解码SPS、PPS参数说明</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>H264编解码参数说明</h4> 
 <ul><li><a href="#H264_10" rel="nofollow">一、H264码流分层</a></li><li><ul><li><a href="#1NAL_12" rel="nofollow">1、NAL层</a></li><li><ul><li><a href="#IP_16" rel="nofollow">①、如何判断帧类型（是图像参考帧还是I、P帧等）？</a></li><li><a href="#__49" rel="nofollow">②、 帧格式</a></li><li><a href="#_font_colorredSPS_ParseAndRewriteSpsfont_httpsgithubcomchensongpoixscwebrtcblobchensongcommon_videoh264sps_vui_rewritercc_93" rel="nofollow">③、 [<font color="red">SPS格式解析代码分析 ParseAndRewriteSps方法</font> ](https://github.com/chensongpoixs/cwebrtc/blob/chensong/common_video/h264/sps_vui_rewriter.cc)</a></li></ul> 
   </li><li><a href="#2_VCL_96" rel="nofollow">2、 VCL层</a></li><li><a href="#3__100" rel="nofollow">3、 码流基本概念</a></li><li><ul><li><a href="#_SODBString_Of_Data_Bits_102" rel="nofollow">①、 SODB（String Of Data Bits）</a></li><li><a href="#_RBSPRaw_Byte_Sequence_Payload_106" rel="nofollow">②、 RBSP（Raw Byte Sequence Payload）</a></li><li><a href="#_NALU__115" rel="nofollow">③、 NALU 单元</a></li><li><a href="#_SPSPPSSlice_Header_132" rel="nofollow">④ SPS/PPS/Slice Header</a></li><li><a href="#_font_colorredwebrtcRBSP__SpsVuiRewriterParseAndRewriteSpsfonthttpsgithubcomchensongpoixscwebrtcblobchensongcommon_videoh264sps_vui_rewritercc_139" rel="nofollow">⑤ [<font color="red">webrtc中对应RBSP的代码 段 方法SpsVuiRewriter::ParseAndRewriteSps</font>](https://github.com/chensongpoixs/cwebrtc/blob/chensong/common_video/h264/sps_vui_rewriter.cc)</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_SPS_Profile__Level_143" rel="nofollow">二, SPS中两个重要的参数分别是 Profile 与 Level</a></li><li><ul><li><a href="#1_H264_Profile_150" rel="nofollow">1、 H264 Profile</a></li><li><a href="#2_H264_Level_161" rel="nofollow">2、 H264 Level</a></li><li><a href="#3__169" rel="nofollow">3、 分辨率</a></li><li><a href="#4__182" rel="nofollow">4、 帧相关的</a></li><li><ul><li><a href="#__log2_max_frame_num_minus4_184" rel="nofollow">①、 帧数 log2_max_frame_num_minus4</a></li><li><a href="#__max_num_ref_frames_186" rel="nofollow">②、 参考帧数 max_num_ref_frames</a></li><li><a href="#__pic_order_cnt_type_190" rel="nofollow">③、 显示帧序号 pic_order_cnt_type</a></li></ul> 
   </li><li><a href="#5__194" rel="nofollow">5、 帧率的计算</a></li></ul> 
  </li><li><a href="#_PPS_Slice_Header_202" rel="nofollow">三、 PPS与 Slice Header</a></li><li><ul><li><a href="#6Slice_Header_218" rel="nofollow">6、Slice Header</a></li><li><ul><li><a href="#__221" rel="nofollow">①、 帧类型</a></li><li><a href="#_GOP_223" rel="nofollow">②、 GOP中解码帧序号</a></li><li><a href="#__225" rel="nofollow">③、 预测权重</a></li><li><a href="#__227" rel="nofollow">④、 滤波</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<hr color="#000000" size='1"'> 
<p><a href="https://github.com/chensongpoixs/caudio_video">音视频基础学习实验地址：https://github.com/chensongpoixs/caudio_video</a></p> 
<h2><a id="H264_10"></a>一、H264码流分层</h2> 
<h3><a id="1NAL_12"></a>1、NAL层</h3> 
<p>Network Abstraction Layer,视频数据网络抽样层。</p> 
<h4><a id="IP_16"></a>①、如何判断帧类型（是图像参考帧还是I、P帧等）？</h4> 
<p>NALU类型是我们判断帧类型的利器，从官方文档中得出如下图：</p> 
<p><font color="red">我们还是接着看最上面图的码流对应的数据来层层分析，以00 00 00 01分割之后的下一个字节就是NALU类型，将其转为二进制数据后，解读顺序为从左往右算，如下:<br> （1）第1位禁止位，值为1表示语法出错<br> （2）第2~3位为参考级别<br> （3）第4~8为是nal单元类型<br> </font></p> 
<p>例如上面00000001后有67,68以及65</p> 
<p>其中0x67的二进制码为：<br> 0110 0111<br> 4-8为00111，转为十进制7，参考第二幅图：7对应序列参数集SPS</p> 
<p>其中0x68的二进制码为：<br> 0110 1000<br> 4-8为01000，转为十进制8，参考第二幅图：8对应图像参数集PPS</p> 
<p>其中0x65的二进制码为：<br> 0110 0101<br> 4-8为00101，转为十进制5，参考第二幅图：5对应IDR图像中的片(I帧)</p> 
<p>所以判断是否为I帧的算法为： （NALU类型 &amp; 0001 1111） = 5 即 NALU类型 &amp; 31 = 5</p> 
<p>比如0x65 &amp; 31 = 5</p> 
<h4><a id="__49"></a>②、 帧格式</h4> 
<p>H264帧由NALU头和NALU主体组成。<br> NALU头由一个字节组成,它的语法如下:</p> 
<p>±--------------+<br> |0|1|2|3|4|5|6|7|<br> ±±±±±±±±+<br> |F|NRI| Type |<br> ±--------------+</p> 
<p>F: 1个比特.<br> forbidden_zero_bit. 在 H.264 规范中规定了这一位必须为 0.</p> 
<p>NRI: 2个比特.<br> nal_ref_idc. 取00~11,似乎指示这个NALU的重要性,如00的NALU解码器可以丢弃它而不影响图像的回放,0～3，取值越大，表示当前NAL越重要，需要优先受到保护。如果当前NAL是属于参考帧的片，或是序列参数集，或是图像参数集这些重要的单位时，本句法元素必需大于0。</p> 
<p>Type: 5个比特.<br> nal_unit_type. 这个NALU单元的类型,1～12由H.264使用，24～31由H.264以外的应用使用,简述如下:</p> 
<p>0：未规定<br> 1：非IDR图像中不采用数据划分的片段<br> 2：非IDR图像中A类数据划分片段<br> 3：非IDR图像中B类数据划分片段<br> 4：非IDR图像中C类数据划分片段<br> 5：IDR图像的片段<br> 6：补充增强信息（SEI）<br> 7：序列参数集（SPS）<br> 8：图像参数集（PPS）<br> 9：分割符<br> 10：序列结束符<br> 11：流结束符<br> 12：填充数据<br> 13：序列参数集扩展<br> 14：带前缀的NAL单元<br> 15：子序列参数集<br> 16 – 18：保留<br> 19：不采用数据划分的辅助编码图像片段<br> 20：编码片段扩展<br> 21 – 23：保留<br> 24 – 31：未规定<br> NAL的头占用了一个字节，按照比特自高至低排列可以表示如下：</p> 
<h4><a id="_font_colorredSPS_ParseAndRewriteSpsfont_httpsgithubcomchensongpoixscwebrtcblobchensongcommon_videoh264sps_vui_rewritercc_93"></a>③、 <a href="https://github.com/chensongpoixs/cwebrtc/blob/chensong/common_video/h264/sps_vui_rewriter.cc"><font color="red">SPS格式解析代码分析 ParseAndRewriteSps方法</font> </a></h4> 
<h3><a id="2_VCL_96"></a>2、 VCL层</h3> 
<p>VIdeo Coding Layer, 视频数据编码层。</p> 
<h3><a id="3__100"></a>3、 码流基本概念</h3> 
<h4><a id="_SODBString_Of_Data_Bits_102"></a>①、 SODB（String Of Data Bits）</h4> 
<p>原始数据比特流，长度不一定是8的倍数，故需要补齐。它是由VCL层产生的。</p> 
<h4><a id="_RBSPRaw_Byte_Sequence_Payload_106"></a>②、 RBSP（Raw Byte Sequence Payload）</h4> 
<p>SODB+trailing bits</p> 
<p>算法是如果SODB最后一个字节不对齐，则补1和多个0.</p> 
<h4><a id="_NALU__115"></a>③、 NALU 单元</h4> 
<p>NAL Header(1byte) + RBSP</p> 
<p>NALUnit.png<br> <img src="https://images2.imgbox.com/6f/62/b322f4Jp_o.png" alt="在这里插入图片描述"></p> 
<p>h264_slice_block.png<br> <img src="https://images2.imgbox.com/2b/be/8YKgg8H8_o.png" alt="在这里插入图片描述"></p> 
<p>h264_slice.png<br> <img src="https://images2.imgbox.com/73/09/GAloOhzD_o.png" alt="在这里插入图片描述"></p> 
<p>h264_rtp_annexb.png<br> <img src="https://images2.imgbox.com/28/9e/hTgIcFlG_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_SPSPPSSlice_Header_132"></a>④ SPS/PPS/Slice Header</h4> 
<p><img src="https://images2.imgbox.com/4c/7d/ZJPiuRkx_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_font_colorredwebrtcRBSP__SpsVuiRewriterParseAndRewriteSpsfonthttpsgithubcomchensongpoixscwebrtcblobchensongcommon_videoh264sps_vui_rewritercc_139"></a>⑤ <a href="https://github.com/chensongpoixs/cwebrtc/blob/chensong/common_video/h264/sps_vui_rewriter.cc"><font color="red">webrtc中对应RBSP的代码 段 方法SpsVuiRewriter::ParseAndRewriteSps</font></a></h4> 
<h2><a id="_SPS_Profile__Level_143"></a>二, SPS中两个重要的参数分别是 Profile 与 Level</h2> 
<p><img src="https://images2.imgbox.com/9f/d0/JDhdjwlp_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="1_H264_Profile_150"></a>1、 H264 Profile</h3> 
<p>h264_profile.png<br> <img src="https://images2.imgbox.com/b9/54/2faiDdp1_o.png" alt="在这里插入图片描述"></p> 
<p>h264_profile_main_high.png<br> <img src="https://images2.imgbox.com/6f/dc/QgiXZ0E9_o.png" alt="在这里插入图片描述"></p> 
<p>对视频压缩特性的描述，Profile越高，就说明采用了越高级的压缩特性</p> 
<h3><a id="2_H264_Level_161"></a>2、 H264 Level</h3> 
<p>h264_level.png<br> <img src="https://images2.imgbox.com/1c/a2/0hUdehQV_o.png" alt="在这里插入图片描述"></p> 
<p>Level是对视频的描述，Level越高，视频的码率、分辨率、fps越高</p> 
<h3><a id="3__169"></a>3、 分辨率</h3> 
<table><thead><tr><th align="center"></th><th align="center"></th></tr></thead><tbody><tr><td align="center">pic_width_in_mbs_minues1</td><td align="center">图像宽度包括的宏块个数-1</td></tr><tr><td align="center">pic_heigh_in_mbs_minus1</td><td align="center">图像高度包括的宏块个数-1</td></tr><tr><td align="center">frame_mbs_only_flag</td><td align="center">帧编码还是场编码 （场是隔行扫描、产生两张图）</td></tr><tr><td align="center">frame_cropping_flag</td><td align="center">图像算法需要裁剪</td></tr><tr><td align="center">frame_crop_left_offset</td><td align="center">减去左侧的偏移量</td></tr><tr><td align="center">frame_crop_right_offset</td><td align="center">减去右侧的偏移量</td></tr><tr><td align="center">frame_crop_top_offset</td><td align="center">减去顶部的偏移量</td></tr><tr><td align="center">frame_crop_bottom_offset</td><td align="center">减去底部的偏移量</td></tr></tbody></table> 
<h3><a id="4__182"></a>4、 帧相关的</h3> 
<h4><a id="__log2_max_frame_num_minus4_184"></a>①、 帧数 log2_max_frame_num_minus4</h4> 
<h4><a id="__max_num_ref_frames_186"></a>②、 参考帧数 max_num_ref_frames</h4> 
<p>解码设置缓冲区大小的</p> 
<h4><a id="__pic_order_cnt_type_190"></a>③、 显示帧序号 pic_order_cnt_type</h4> 
<p>解码</p> 
<h3><a id="5__194"></a>5、 帧率的计算</h3> 
<pre><code>framerate = (float)(sps-&gt;vui.vui_time_scale)/(float)(sps-&gt;vui.vui_num_units_in_tick)/2;
</code></pre> 
<h2><a id="_PPS_Slice_Header_202"></a>三、 PPS与 Slice Header</h2> 
<p><img src="https://images2.imgbox.com/f1/f5/mp4470df_o.png" alt="在这里插入图片描述"></p> 
<table><thead><tr><th align="center"></th><th align="center"></th></tr></thead><tbody><tr><td align="center">entropy_coding_mode_flag</td><td align="center">熵编码，1表示使用CABAC编码</td></tr><tr><td align="center">num_slice_groups_minus1</td><td align="center">分片数量</td></tr><tr><td align="center">weighted_pred_flag</td><td align="center">在P/SP Slice中开启权重预测</td></tr><tr><td align="center">weighted_bipred_idc</td><td align="center">在B Slice中加权预测的方法</td></tr><tr><td align="center">pic_init_qp_minus26/pic_init_qs_minus26</td><td align="center">初始化量参数,实际参数在Slice header</td></tr><tr><td align="center">chroma_qp_index_offset</td><td align="center">用于计算色度分量的量化参数</td></tr><tr><td align="center">deblocking_filter_control_present_flag</td><td align="center">表示Slice header中是否存在用于去块滤波器控制的信息</td></tr><tr><td align="center">constrainged_intra_pred_flag</td><td align="center">若该标识为1，表示I宏块在进行帧内预测时只能使用来自I和SI类型宏块的信息</td></tr><tr><td align="center">redundant_pic_cnt_preset_flag</td><td align="center">用于表示Slice Header中是否存在redundant_pic_cnt语法元素</td></tr></tbody></table> 
<h3><a id="6Slice_Header_218"></a>6、Slice Header</h3> 
<p><img src="https://images2.imgbox.com/50/5d/tVdnAq9u_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="__221"></a>①、 帧类型</h4> 
<h4><a id="_GOP_223"></a>②、 GOP中解码帧序号</h4> 
<h4><a id="__225"></a>③、 预测权重</h4> 
<h4><a id="__227"></a>④、 滤波</h4>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4256e6e3c6f5aefb67aa50a2b7c91eb5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">哈夫曼树 构造，编码 完整代码</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/400a4d86c33204cf99c9e7a447459108/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">ubuntu 安装 php5.6</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>