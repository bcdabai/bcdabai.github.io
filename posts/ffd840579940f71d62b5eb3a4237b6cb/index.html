<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>lsyncd搭建和使用(含rsync配置) - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="lsyncd搭建和使用(含rsync配置)" />
<meta property="og:description" content="官方文档 https://axkibe.github.io/lsyncd/
https://github.com/axkibe/lsyncd
lsyncd简介 Lsyncd使用lua语言对inotify和rsync进行封装，使用文件系统事件接口（inotify或fsevents）来监视对本地文件和目录的更改，Lsyncd将这些事件整理几秒钟，然后生成一个或多个进程以将更改同步到远程文件系统，默认同步方法是rsync。是一种轻量级的实时镜像解决方案，不需要新的文件系统或块设备，Lysncd不会妨碍本地文件系统性能
可以通过配置文件实现细粒度的自定义。自定义操作配置甚至可以从头开始编写，从shell脚本到用Lua语言编写的代码
Lsyncd 2.2.1在所有源计算机和目标计算机上都需要rsync&gt; = 3.1。
安装 在ubuntu和debian，lsyncd已经收入到其官方镜像源中，直接使用apt-get安装即可
apt-get install rsyncd
lsyncd配置 lsyncd的配置是用lua语言编写，一般为/etc/lsyncd.conf，常用的主要是两部分：
setting部分
里面是全局变量，–后面的表示注释，常见配置如下：
settings { logfile = &#34;/var/log/lsyncd/lsyncd.log&#34;, --日志文件 pidfile = &#34;/var/run/lsyncd.pid&#34;, --记录进程ID的文件，可以不用配置 statusFile = &#34;/var/log/lsyncd/lsyncd.status&#34;, --运行状态文件，包括记录一些监控目录的变更信息 statusInterval = 5, --将lsyncd的状态写入上面的statusFile的间隔，默认10秒 nodaemon = true, --表示不启用守护模式，默认 inotifyMode = &#34;CloseWrite&#34;, --指定inotify监控的事件，默认是CloseWrite，还可以是Modify或CloseWrite or Modify maxProcesses = 5, --同步进程的最大个数。假如同时有10个文件需要同步，而maxProcesses=5，则最大能看到有5个rysnc进程 maxDelays = 1, --累计到多少所监控的事件激活一次同步，即使后面的delay延迟时间还未到 inist = ture, --keep running at startup although one or more targets failed due to not being reachable." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/ffd840579940f71d62b5eb3a4237b6cb/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-07-04T15:54:35+08:00" />
<meta property="article:modified_time" content="2020-07-04T15:54:35+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">lsyncd搭建和使用(含rsync配置)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>官方文档</h3> 
<p>https://axkibe.github.io/lsyncd/<br> https://github.com/axkibe/lsyncd</p> 
<h3><a id="lsyncd_5"></a>lsyncd简介</h3> 
<p>Lsyncd使用lua语言对inotify和rsync进行封装，使用文件系统事件接口（inotify或fsevents）来监视对本地文件和目录的更改，Lsyncd将这些事件整理几秒钟，然后生成一个或多个进程以将更改同步到远程文件系统，默认同步方法是rsync。是一种轻量级的实时镜像解决方案，不需要新的文件系统或块设备，Lysncd不会妨碍本地文件系统性能</p> 
<p>可以通过配置文件实现细粒度的自定义。自定义操作配置甚至可以从头开始编写，从shell脚本到用Lua语言编写的代码</p> 
<p>Lsyncd 2.2.1在所有源计算机和目标计算机上都需要rsync&gt; = 3.1。</p> 
<h3><a id="_13"></a>安装</h3> 
<p>在ubuntu和debian，lsyncd已经收入到其官方镜像源中，直接使用apt-get安装即可<br> apt-get install rsyncd</p> 
<h3><a id="lsyncd_17"></a>lsyncd配置</h3> 
<p>lsyncd的配置是用lua语言编写，一般为/etc/lsyncd.conf，常用的主要是两部分：</p> 
<p><strong>setting部分</strong><br> 里面是全局变量，–后面的表示注释，常见配置如下：</p> 
<pre><code class="prism language-bash">settings <span class="token punctuation">{<!-- --></span>
logfile <span class="token operator">=</span> <span class="token string">"/var/log/lsyncd/lsyncd.log"</span>,   --日志文件
pidfile <span class="token operator">=</span> <span class="token string">"/var/run/lsyncd.pid"</span>,   --记录进程ID的文件，可以不用配置
statusFile <span class="token operator">=</span> <span class="token string">"/var/log/lsyncd/lsyncd.status"</span>,   --运行状态文件，包括记录一些监控目录的变更信息
statusInterval <span class="token operator">=</span> 5,  --将lsyncd的状态写入上面的statusFile的间隔，默认10秒
nodaemon <span class="token operator">=</span> true, --表示不启用守护模式，默认
inotifyMode <span class="token operator">=</span> <span class="token string">"CloseWrite"</span>,  --指定inotify监控的事件，默认是CloseWrite，还可以是Modify或CloseWrite or Modify
maxProcesses <span class="token operator">=</span> 5,   --同步进程的最大个数。假如同时有10个文件需要同步，而maxProcesses<span class="token operator">=</span>5，则最大能看到有5个rysnc进程
maxDelays <span class="token operator">=</span> 1,   --累计到多少所监控的事件激活一次同步，即使后面的delay延迟时间还未到
inist <span class="token operator">=</span> ture, --keep running at startup although one or <span class="token function">more</span> targets failed due to not being reachable.  一般不用配置
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>sync部分</strong><br> 主要用来定义同步时的一些设置,可以同时同步多个目录,只需要在该代码块中事先定义好多个sync即可。一般第一个参数指定lsyncd以什么模式运行，主要有rsync、rsyncssh、direct三种模式：</p> 
<p><strong>default.rsync</strong> ：默认的rsync配置会将事件聚合到delay秒或1000个独立的不可折叠事件，这些事件首先发生。然后它会产生一个Rsync，并带有所有已更改文件的过滤器。过滤器列表通过管道传输到Rsync，可以进行本地或远程的文件同步，常见配置如下</p> 
<pre><code class="prism language-bash"><span class="token function">sync</span> <span class="token punctuation">{<!-- --></span>
    default.rsync,
    <span class="token function">source</span> <span class="token operator">=</span> <span class="token string">"/tmp/src"</span>,      --同步原目录
    target <span class="token operator">=</span> <span class="token string">"rsync_user@172.16.1.41::backup"</span>,   --同步目的地址
    delete <span class="token operator">=</span> <span class="token string">"running"</span>,   --目标目录和源目录不同时的删除方式，四种，详解见下面
    exclude <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"*.txt"</span>, <span class="token string">".tmp"</span> <span class="token punctuation">}</span>,   --排除同步的文件，可以用rsync的正则
    delay <span class="token operator">=</span> 3,         --累计事件，等待delay秒后进行rsync同步，默认15秒（最大累计到1000个不可合并的事件）。也就是15s内监控目录下发生的改动，会累积到一次rsync同步，避免过于频繁的同步。（可合并的意思是，15s内两次修改了同一文件，最后只同步最新的文件）
    init <span class="token operator">=</span> false,    --只同步进程启动以后发生改动事件的文件，原有的目录即使有差异也不会同步。默认是true
	<span class="token function">rsync</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>      --这里是rsync的同步配置
	    binary <span class="token operator">=</span> <span class="token string">"/usr/bin/rsync"</span>,     
	    archive <span class="token operator">=</span> true,
	    compress <span class="token operator">=</span> true,       
	    verbose <span class="token operator">=</span> true,     --同步详细模式输出
	    password_file <span class="token operator">=</span> <span class="token string">"/etc/rsync.pwd"</span>,
	    _extra <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"--bwlimit=200"</span><span class="token punctuation">}</span>,    其他的一些配置，这里表示限速，单位kb/s
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>补充</p> 
<pre><code class="prism language-bash">上面配置文件中的delete各值解释：
delete	<span class="token operator">=</span>	<span class="token boolean">true</span>       <span class="token comment">#在目标上删除源中没有的内容。在启动时以及在正常操作期间删除的内容</span>
delete	<span class="token operator">=</span>	<span class="token boolean">false</span>      <span class="token comment">#不会删除目标上的任何文件。不在启动时也不在正常操作上</span>
delete	<span class="token operator">=</span>	<span class="token string">'startup'</span>  <span class="token comment"># Lsyncd将在启动时删除目标上的文件，但不会在正常操作时删除</span>
delete	<span class="token operator">=</span>	<span class="token string">'running'</span>  <span class="token comment"># Lsyncd在启动时不会删除目标上的文件，但会删除正常操作期间删除的文件</span>

排除：可以指定两个附加参数来同步：
excludeFrom	<span class="token operator">=</span>	FILENAME	loads exclusion rules from this file, on rule per line
exclude	<span class="token operator">=</span>	LIST	loads exclusion rules from this list of strings
排除规则在rsync的排除模式之后建模，但稍微简单一些。Lsyncd支持这些功能：
通常，如果某个事件的路径名的任何部分（参见第3层以下）与文本匹配，则将其排除。例如文件“/ bin / foo / bar”匹配规则“foo”。
如果规则以斜杠开始，则只会在路径名的开头匹配
如果规则以斜线结尾，则只会在路径名的末尾匹配
？匹配不是斜杠的任何字符。
* 匹配零个或多个不是斜线的字符
** 匹配零个或多个字符，这可以是斜杠。

delete 和 exclude 本来是rsync的配置选项
</code></pre> 
<p><strong>default.direct</strong> ：Default.direct可以用来保持两个本地目录同步，比使用default.rsync更好的性能。Default.direct在启动时使用（就像default.rsync一样）rsync来初始化目标目录与源目录的同步。但是，在正常操作期间，default.direct使用/ bin / cp，/ bin / rm和/ bin / mv来保持同步。所有参数就像default.rsync一样</p> 
<pre><code class="prism language-bash"><span class="token function">sync</span> <span class="token punctuation">{<!-- --></span>
    default.direct,
    <span class="token function">source</span>  <span class="token operator">=</span> <span class="token string">"/home/user/src/"</span>,
    target  <span class="token operator">=</span> <span class="token string">"/home/user/trg/"</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>default.rsyncssh</strong> ：同步到远程主机目录，rsync的ssh模式，需要使用key来认证。此配置不同于标准rsync配置，因为它使用ssh命令在目标主机本地移动文件或目录，而不是再次删除和传输。这种配置产生了类似于default.rsync的Rsync进程，但是会产生/usr/bin/ssh HOST mv ORIGIN DESTINATION命令。</p> 
<p>与default.rsync不同，它不需要统一的target参数，但需要host并targetdir分开。<br> Rsync的选项可以通过rsync上面所描述的default.rsync中的参数进行更改<br> Rsync的选项可以通过rsync上面所描述的default.rsync中的参数进行更改。</p> 
<p>除此之外，可以通过ssh参数配置ssh 。</p> 
<pre><code class="prism language-bash">binary <span class="token operator">=</span> FILENAME	<span class="token comment">#Lsyncd calls this binary as ssh (default: /usr/bin/ssh)</span>
identityFile <span class="token operator">=</span> FILE	<span class="token comment">#Uses this file to identify for public key authentication.</span>
options	<span class="token operator">=</span> TABLE	    <span class="token comment">#A table of addition extended options to pass to ssh's -o option.</span>
port <span class="token operator">=</span> PORT	        <span class="token comment">#Adds --port=PORT to the ssh call.</span>
_extra <span class="token operator">=</span> STRING TABLE	<span class="token comment">#Similar to rsync._extra this can be used as quick workaround if absolutely needed.</span>
</code></pre> 
<pre><code class="prism language-bash">settings <span class="token punctuation">{<!-- --></span>
    logfile <span class="token operator">=</span> <span class="token string">"/var/log/lsyncd.log"</span>,
    statusFile <span class="token operator">=</span> <span class="token string">"/var/log/lsyncd-status.log"</span>,
    statusInterval <span class="token operator">=</span> 20
<span class="token punctuation">}</span>

<span class="token function">sync</span> <span class="token punctuation">{<!-- --></span>
   default.rsyncssh,
   source<span class="token operator">=</span><span class="token string">"/srcdir"</span>,
   host<span class="token operator">=</span><span class="token string">"remotehost"</span>,
   excludeFrom<span class="token operator">=</span><span class="token string">"/etc/lsyncd.exclude"</span>,
   targetdir<span class="token operator">=</span><span class="token string">"/dstdir"</span>,
   <span class="token function">rsync</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
     archive <span class="token operator">=</span> true,
     compress <span class="token operator">=</span> false,
     whole_file <span class="token operator">=</span> <span class="token boolean">false</span>
   <span class="token punctuation">}</span>,
   <span class="token function">ssh</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
     port <span class="token operator">=</span> 1234
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="lsyncd_130"></a>启动lsyncd</h3> 
<p>lsyncdd所有日志消息按类别排序。默认情况下，Lsyncd缺少日志消息。通过指定，您可以将Lsyncd转换为motormouth -log all。</p> 
<blockquote> 
 <p>lsyncd -log all CONFIGFILE</p> 
</blockquote> 
<p>这可能很容易变得太多。一个特别有用的类别是“Exec”，它将记录Lsyncd产生的所有进程的命令行。</p> 
<blockquote> 
 <p>lsyncd -log Exec CONFIGFILE</p> 
</blockquote> 
<p>测试Lsyncd配置时-nodaemon是一个非常方便的标志。使用此选项，Lsyncd不会分离，并且不会成为守护进程。所有日志消息都是在控制台上打印的配置日志记录工具（stdout和stderr）之外的。</p> 
<blockquote> 
 <p>lsyncd -nodaemon CONFIGFILE</p> 
</blockquote> 
<p>当没有配置文件时，可以直接在命令中指定，如下：</p> 
<blockquote> 
 <p>lsyncd -rsync /home/USER/src remotehost:dst lsyncd -rsyncssh<br> /home/USER/src REMOTEHOST TARGETDIR</p> 
</blockquote> 
<p>当默认初始启动同步失败时，Lsyncd将以错误消息终止。它是这样设计的，所以配置故障可见地报告给可能的初始用户。但是，在生产过程中可能会完成远程目标，但是您希望Lsyncd始终启动并不断尝试同步到远程目标，直到它启动。</p> 
<blockquote> 
 <p>lsyncd -insist -rsync /home/USER/src remotehost:dst</p> 
</blockquote> 
<p>在生产模式下，建议坚持。它也可以在配置文件中的settings {}命令中指定。</p> 
<h3><a id="rsync_154"></a>rsync安装与配置</h3> 
<p><strong>安装</strong><br> 在ubuntu或者debian下，直接 apt-get install rsync 即可</p> 
<p><strong>配置</strong><br> /etc/rsyncd.conf</p> 
<pre><code class="prism language-bash">uid <span class="token operator">=</span> root     <span class="token comment"># 表示同步的文件所属用户</span>
gid <span class="token operator">=</span> root     <span class="token comment"># 表示同步的文件所属用户组</span>
use <span class="token function">chroot</span> <span class="token operator">=</span> <span class="token function">yes</span>      <span class="token comment"># 安全相关，表示在同步时，是否将同步目录转为根目录</span>
max connections<span class="token operator">=</span>0     <span class="token comment"># 允许客户端的最大连接数，0表示不限制</span>
log file<span class="token operator">=</span>/var/log/rsyncd/rsyncd.log
pid file<span class="token operator">=</span>/var/run/rsyncd.pid
lock file<span class="token operator">=</span>/var/run/rsyncd.lock
 
<span class="token punctuation">[</span>backup<span class="token punctuation">]</span>
path <span class="token operator">=</span> /var/tmp/
<span class="token function">read</span> only <span class="token operator">=</span> no
list <span class="token operator">=</span> <span class="token function">yes</span>
auth <span class="token function">users</span> <span class="token operator">=</span> rsyncuser
secrets <span class="token function">file</span> <span class="token operator">=</span> /etc/rsync.pas
</code></pre> 
<p>/etc/images.pas 密码文件</p> 
<blockquote> 
 <p>rsyncuser:123456<br> chmod 600 /etc/images.pas # rsync的密码文件权限必须是600 /usr/bin/rsync<br> –daemon config=/etc/rsyncd # 启动</p> 
</blockquote> 
<h3><a id="_184"></a>问题</h3> 
<p>1、在rsync中，他的密码文件包括用户名和密码两部分，用“:”隔开，但是在lsyncd中，配置里的密码文件只写密码就行，不要写用户名，要不rsync会同步不成功</p> 
<h3><a id="_187"></a>扩展</h3> 
<p>lsyncd不仅仅可以用来同步，还可以自己写各种action，监控指定目录的文件，根据触发的事件执行自己定义的命令，这个没有实践，可以参考 https://www.cnblogs.com/sunsky303/p/8976445.html</p> 
<p>本文参考原文：<br> https://www.cnblogs.com/sunsky303/p/8976445.html<br> https://segmentfault.com/a/1190000002737213</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4312e1b7126ad20728b98c51980b4684/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Chrome浏览器检查更新时出错无法启动怎么办</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/dd7edabb4feb4382ff0e4024ccd30225/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">vivado ILA在线逻辑仪使用</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>