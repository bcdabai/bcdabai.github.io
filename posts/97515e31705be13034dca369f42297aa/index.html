<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>外网业务访问故障，ping时通时断，显示有请求超时time out处理过程 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="外网业务访问故障，ping时通时断，显示有请求超时time out处理过程" />
<meta property="og:description" content="类似问题参考：
ip地址冲突导致ping时通时断显示超时问题处理过程_wj31932的博客-CSDN博客
无法上网故障排查过程及复现过程系ip冲突造成_wj31932的博客-CSDN博客_arp获取不到网关mac地址
一天，同事在群里反馈，外网访问困难，无法打开北京总部的oa系统，让排查一下。
看到问题以为到北京的vpn断了，登录路由器看一下出局的线路情况，发现路由器地址很难登录。打开客户端，半天没反应。
ping一下北京oa地址，显示有time out后面有导通显示。如下：
发现有time out现象，而且两包回的延时较大。正常时的ping是这样的：
总之，ping有时通，有时断。可能的原因：
1、前向源ip广播域或者后向目的ip广播域环境有设备冒充网关，导致有时ping的request发给错误的mac地址，而不是正确的网关设备，目的ip没有收到request而没有回reply，源设备等待超时。还有可能是源ip或目的ip设备的路由指向问题，比如双默认路由，也可能造成ping的部分request或reply去了另一个mac地址，而终结在这个设备上造成丢包。
2、目的ip环境存在ip冲突，目的网关把部分request消息发给错误的mac地址，导致真正的目的ip没有收到，而没有回reply，源设备等待超时。
3、源ip设备环境中存在ip冲突，导致网关把部分ping的reply消息发给错误的mac地址，源ip等待超时。
4、经过的中间节点网络拥塞或者目的设备处理能力拥塞，导致丢失部分前向request或者后向reply消息，或者目的设备未响应request消息，导致源设备等待超时。
ping出现稳定time out的可能性原因：
1、防火墙拦截的ping的request消息，导致高层无法收到，所以不回ping的reply消息。
2、跨网段环境中存在ip冲突或一设备多网卡，接在同一交换机下，回答了访问的arp请求，把错误的mac给了源主机，导致网关把ping的request消息发给其他mac地址。
3、也与目的主机的路由相关，没有回程路由，如同网段可能掩码错误，没有配置网关的话。
4、回程路由指向其他ip地址，导致源ip没有收到ping的reply消息。
5、ping消息的入接口和回程出接口不是设备的同一接口等等原因造成。
6、环境中传输有问题，误码过高或者带宽被占用，导致节点压包，丢包。
考虑内网访问路由器都很难登录，判断问题应该出在路由器和核心交换机的接口间。
如图：根据以往故障经验，可能是测试环境中有打流之类的操作，路由错误，送到核心交换机转发给路由器了。测试仪打流，正常时，不会发出到核心交换机。 登录交换机，登录很慢，登上后查看路由器和交换机的lan1口情况：
想去看一下是具体哪些访问的ip导致带宽被占，但路由器客户端自动退出，估计是心跳收不到，自动断开了。
看路由器的处理wan2-pppoe流量不大，判断是这个占带宽的包被防火墙拦截了，drop掉了。
结合以往经验，群里询问是否有用测试仪打流的，是否路由设置不对，导致打流送出到路由器了？有同事说他们在打流，让停一下检查一下路由？
一会反馈目的方服务器关机了，没有落地路由，导致网络节点送到默认路由走到出口路由器去了，已经停掉打流。这是登录路由器，很快登录上去，查看lan1口流量：
流量明显回落，ping总部oa也正常了。网络恢复。
问题分析：
询问他的打流组网流程，大概如下图：用测试仪的一个接口想给agw打流，agw转换后发给测试仪的另一接口。打流的目的ip是agw设备的一个ip地址，agw和交换机的一个接口19用10G光纤直连。
图中是 示意图，他打流的目的在agw上，ip是192.19.0.0/24网段的，这个ip是做在圈中交换机的19接口上上直连路由发出，当图中agw关机时，对应的圈中的接口19是down的，对应直连路由没有了，所以打流就从默认路由出去了。如下图路由关系：
正常时，三层交换机的路由关系：
因为交换机的接口19添加了有一个ip地址，直连agw，正常时，目的ip通过这个ip生成的直连路由发给agw设备， 当agw关机时，19接口down，导致直连路由消失，交换机把打流包送到默认路由的上级交换机，依次转发到路由器。上级交换机的路由。
核心交换机的路由如下：
结论：接口down导致直连路由消失，若是svi生成的直连路由，只要有一个接口，无论是access还是trunk只要使用了这个vlan，直连路由都不会down，这时，三层交换机回给源ip发destination host unreachable的icmp消息，终止这个打流消息的继续转发。
带宽被抢占，导致正常访问的包，无法发出，积压丢包，延时被发出，导致回包延时。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/97515e31705be13034dca369f42297aa/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-15T09:57:59+08:00" />
<meta property="article:modified_time" content="2022-11-15T09:57:59+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">外网业务访问故障，ping时通时断，显示有请求超时time out处理过程</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>类似问题参考：</p> 
<p><a href="https://blog.csdn.net/wj31932/article/details/127818195?spm=1001.2014.3001.5501" title="ip地址冲突导致ping时通时断显示超时问题处理过程_wj31932的博客-CSDN博客">ip地址冲突导致ping时通时断显示超时问题处理过程_wj31932的博客-CSDN博客</a></p> 
<p><a href="https://blog.csdn.net/wj31932/article/details/120547262?spm=1001.2014.3001.5502" title="无法上网故障排查过程及复现过程系ip冲突造成_wj31932的博客-CSDN博客_arp获取不到网关mac地址">无法上网故障排查过程及复现过程系ip冲突造成_wj31932的博客-CSDN博客_arp获取不到网关mac地址</a></p> 
<p>  一天，同事在群里反馈，外网访问困难，无法打开北京总部的oa系统，让排查一下。</p> 
<p>      看到问题以为到北京的vpn断了，登录路由器看一下出局的线路情况，发现路由器地址很难登录。打开客户端，半天没反应。</p> 
<p>      ping一下北京oa地址，显示有time out后面有导通显示。如下：</p> 
<p><img alt="" height="321" src="https://images2.imgbox.com/e0/3a/MClhh0Hv_o.png" width="713"></p> 
<p><img alt="" height="202" src="https://images2.imgbox.com/d3/ad/vCGyT9zK_o.png" width="790"></p> 
<p>   发现有time out现象，而且两包回的延时较大。正常时的ping是这样的：</p> 
<p><img alt="" height="307" src="https://images2.imgbox.com/b4/2a/wSZ0ah8n_o.png" width="622"></p> 
<p> 总之，ping有时通，有时断。可能的原因：</p> 
<p><span style="color:#fe2c24;">1</span><strong><span style="color:#fe2c24;">、前向源ip广播域或者后向目的ip广播域环境有设备冒充网关，导致有时ping的request发给错误的mac地址，而不是正确的网关设备，目的ip没有收到request而没有回reply，源设备等待超时。还有可能是源ip或目的ip设备的路由指向问题，比如双默认路由，也可能造成ping的部分request或reply去了另一个mac地址，而终结在这个设备上造成丢包。</span></strong></p> 
<p><span style="color:#fe2c24;"><strong>2、目的ip环境存在ip冲突，目的网关把部分request消息发给错误的mac地址，导致真正的目的ip没有收到，而没有回reply，源设备等待超时。</strong></span></p> 
<p><span style="color:#fe2c24;"><strong>3、源ip设备环境中存在ip冲突，导致网关把部分ping的reply消息发给错误的mac地址，源ip等待超时。<br> 4、经过的中间节点网络拥塞或者目的设备处理能力拥塞，导致丢失部分前向request或者后向reply消息，或者目的设备未响应request消息，导致源设备等待超时。</strong></span><br>  </p> 
<p> <span style="color:#fe2c24;"><strong>ping出现稳定time out的可能性原因：</strong></span></p> 
<p><span style="color:#fe2c24;"><strong>1、防火墙拦截的ping的request消息，导致高层无法收到，所以不回ping的reply消息。</strong></span></p> 
<p><span style="color:#fe2c24;"><strong> 2、跨网段环境中存在ip冲突或一设备多网卡，接在同一交换机下，回答了访问的arp请求，把错误的mac给了源主机，导致网关把ping的request消息发给其他mac地址。</strong></span></p> 
<p><span style="color:#fe2c24;"><strong>3、也与目的主机的路由相关，没有回程路由，如同网段可能掩码错误，没有配置网关的话。</strong></span></p> 
<p><span style="color:#fe2c24;"><strong>4、回程路由指向其他ip地址，导致源ip没有收到ping的reply消息。</strong></span></p> 
<p><span style="color:#fe2c24;"><strong>5、ping消息的入接口和回程出接口不是设备的同一接口等等原因造成。<br> 6、环境中传输有问题，误码过高或者带宽被占用，导致节点压包，丢包。</strong></span></p> 
<p>    考虑内网访问路由器都很难登录，判断问题应该出在路由器和核心交换机的接口间。</p> 
<p><img alt="" height="446" src="https://images2.imgbox.com/4b/22/PUq4XRFT_o.png" width="827">      <strong><span style="color:#fe2c24;">如图：根据以往故障经验，可能是测试环境中有打流之类的操作，路由错误，送到核心交换机转发给路由器了。测试仪打流，正常时，不会发出到核心交换机。</span></strong> </p> 
<p>     登录交换机，登录很慢，登上后查看路由器和交换机的lan1口情况：</p> 
<p><img alt="" height="372" src="https://images2.imgbox.com/4d/d4/5vXGMJFb_o.png" width="1200">      想去看一下是具体哪些访问的ip导致带宽被占，但路由器客户端自动退出，估计是心跳收不到，自动断开了。</p> 
<p>     看路由器的处理wan2-pppoe流量不大，判断是这个占带宽的包被防火墙拦截了，drop掉了。</p> 
<p>      结合以往经验，群里询问是否有用测试仪打流的，是否路由设置不对，导致打流送出到路由器了？有同事说他们在打流，让停一下检查一下路由？</p> 
<p>     一会反馈目的方服务器关机了，没有落地路由，导致网络节点送到默认路由走到出口路由器去了，已经停掉打流。这是登录路由器，很快登录上去，查看lan1口流量：</p> 
<p><img alt="" height="295" src="https://images2.imgbox.com/59/87/DQ7fC40Y_o.png" width="1200"></p> 
<p>    流量明显回落，ping总部oa也正常了。网络恢复。</p> 
<p>问题分析：</p> 
<p>询问他的打流组网流程，大概如下图：用测试仪的一个接口想给agw打流，agw转换后发给测试仪的另一接口。打流的目的ip是agw设备的一个ip地址，agw和交换机的一个接口19用10G光纤直连。</p> 
<p><img alt="" height="753" src="https://images2.imgbox.com/8b/d1/CCka1wOb_o.png" width="1200"></p> 
<p></p> 
<p>  图中是 示意图，他打流的目的在agw上，ip是192.19.0.0/24网段的，这个ip是做在圈中交换机的19接口上上直连路由发出，当图中agw关机时，对应的圈中的接口19是down的，对应直连路由没有了，所以打流就从默认路由出去了。如下图路由关系：</p> 
<p></p> 
<p>正常时，三层交换机的路由关系：</p> 
<p> <img alt="" height="519" src="https://images2.imgbox.com/48/53/SNB1H5gk_o.png" width="1083"></p> 
<p>       因为交换机的接口19添加了有一个ip地址，直连agw，正常时，目的ip通过这个ip生成的直连路由发给agw设备， 当agw关机时，19接口down，导致直连路由消失，交换机把打流包送到默认路由的上级交换机，依次转发到路由器。上级交换机的路由。</p> 
<p><img alt="" height="150" src="https://images2.imgbox.com/7b/ec/Fb3xJFbU_o.png" width="1157"></p> 
<p></p> 
<p><img alt="" height="434" src="https://images2.imgbox.com/96/99/0D8i54Tq_o.png" width="1082"></p> 
<p>  核心交换机的路由如下：</p> 
<p><img alt="" height="272" src="https://images2.imgbox.com/08/22/JkwJcat3_o.png" width="916"></p> 
<p>结论：接口down导致直连路由消失，若是svi生成的直连路由，只要有一个接口，无论是access还是trunk只要使用了这个vlan，直连路由都不会down，这时，三层交换机回给源ip发destination </p> 
<p>host unreachable的icmp消息，终止这个打流消息的继续转发。</p> 
<p>     带宽被抢占，导致正常访问的包，无法发出，积压丢包，延时被发出，导致回包延时。</p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f5c5d76e94a8a54d5dfcbc989b31818f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Springboot快速开发-书本信息管理系统（项目源码）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ae32ae426be3a9546de9b98635a0e2d6/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">GET请求Map作为请求入参,参数接收不到?</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>