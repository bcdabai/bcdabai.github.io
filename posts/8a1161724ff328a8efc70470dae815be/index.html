<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【k8s】三、k8s集群的初始化 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【k8s】三、k8s集群的初始化" />
<meta property="og:description" content="目录
前言
环境规划
kubeadm kubelet kubectl
安装kubeadm
master节点初始化
node节点初始化加入集群
集群网络初始化之flannel
报错
kubeadm init 报错
kubectl get nodes报错
总结
写在后面
前言 通过前面两篇文章的铺垫，
【k8s】一、基础实验环境准备
【k8s】二、containerd的安装
我们已经把搭建k8s集群所需的基础环境都构建好了，接下来，我们来对k8s进行部署，初始化一个属于我们自己的k8s集群。我们此次安装的k8s版本是1.24.3。
k8s的安装有多种方式，本次教程我们采用其中最简单的一种方式，通过kubeadm来进行安装。
环境规划 在【k8s】一、基础实验环境准备中已经将本次实验所有节点的网络规划好了
机器
IP地址
物理机
192.168.137.99
k8s-master
192.168.137.200
k8s-node1
192.168.137.201
k8s-node2
192.168.137.202
kubeadm kubelet kubectl kubeadm是一个Kubernetes的部署工具，负责执行构建一个最小化的可用集群以及将其启动等的必要基本步骤。提供kubeadm init 和 kubeadm join两个操作命令，可以让我们快速部署一个Kubernetes集群。
kubeadm是Kubernetes集群全生命周期的管理工具，可用于实现集群的部署、升级、降级及拆除。kubeadm部署Kubernetes集群是将大部分资源以pod的方式运行，例如（kube-proxy、kube-controller-manager、kube-scheduler、kube-apiserver、flannel)都是以pod方式运行。
kubectl是Kubernetes集群的命令行工具，通过kubectl能够对集群本身进行管理，并能够在集群上进行容器化应用的安装和部署。接下来我们会经常与kubectl命令打交道的
安装kubeadm master节点和所有node节点都需要执行本步骤安装。其中kubectl可以在node节点上面不安装，但是初学者的话，都安装也无妨。
1. 添加k8s的阿里云yum源
cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; EOF [kubernetes] name=Kubernetes baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64 enabled=1 gpgcheck=0 repo_gpgcheck=0 gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg EOF 2. yum安装kubeadm kubelet kubectl" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/8a1161724ff328a8efc70470dae815be/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-15T07:49:30+08:00" />
<meta property="article:modified_time" content="2022-09-15T07:49:30+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【k8s】三、k8s集群的初始化</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="%E5%89%8D%E8%A8%80-toc"><a href="#%E5%89%8D%E8%A8%80" rel="nofollow">前言</a></p> 
<p id="%E7%8E%AF%E5%A2%83%E8%A7%84%E5%88%92-toc"><a href="#%E7%8E%AF%E5%A2%83%E8%A7%84%E5%88%92" rel="nofollow">环境规划</a></p> 
<p id="kubeadm%20kubelet%20kubectl-toc"><a href="#kubeadm%20kubelet%20kubectl" rel="nofollow">kubeadm kubelet kubectl</a></p> 
<p id="%E5%AE%89%E8%A3%85kubeadm-toc"><a href="#%E5%AE%89%E8%A3%85kubeadm" rel="nofollow">安装kubeadm</a></p> 
<p id="master%E8%8A%82%E7%82%B9%E5%88%9D%E5%A7%8B%E5%8C%96-toc"><a href="#master%E8%8A%82%E7%82%B9%E5%88%9D%E5%A7%8B%E5%8C%96" rel="nofollow">master节点初始化</a></p> 
<p id="node%E8%8A%82%E7%82%B9%E5%88%9D%E5%A7%8B%E5%8C%96%E5%8A%A0%E5%85%A5%E9%9B%86%E7%BE%A4-toc"><a href="#node%E8%8A%82%E7%82%B9%E5%88%9D%E5%A7%8B%E5%8C%96%E5%8A%A0%E5%85%A5%E9%9B%86%E7%BE%A4" rel="nofollow">node节点初始化加入集群</a></p> 
<p id="%E9%9B%86%E7%BE%A4%E7%BD%91%E7%BB%9C%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B9%8Bflannel-toc"><a href="#%E9%9B%86%E7%BE%A4%E7%BD%91%E7%BB%9C%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B9%8Bflannel" rel="nofollow">集群网络初始化之flannel</a></p> 
<p id="%E6%8A%A5%E9%94%99-toc"><a href="#%E6%8A%A5%E9%94%99" rel="nofollow">报错</a></p> 
<p id="kubeadm%20init%20%E6%8A%A5%E9%94%99-toc"><a href="#kubeadm%20init%20%E6%8A%A5%E9%94%99" rel="nofollow">kubeadm init 报错</a></p> 
<p id="kubectl%20get%20nodes%E6%8A%A5%E9%94%99-toc"><a href="#kubectl%20get%20nodes%E6%8A%A5%E9%94%99" rel="nofollow">kubectl get nodes报错</a></p> 
<p id="%E6%80%BB%E7%BB%93-toc"><a href="#%E6%80%BB%E7%BB%93" rel="nofollow">总结</a></p> 
<p id="%E5%86%99%E5%9C%A8%E5%90%8E%E9%9D%A2-toc"><a href="#%E5%86%99%E5%9C%A8%E5%90%8E%E9%9D%A2" rel="nofollow">写在后面</a></p> 
<hr id="hr-toc"> 
<h2>前言</h2> 
<p>通过前面两篇文章的铺垫，</p> 
<p><a href="https://blog.csdn.net/zhh763984017/article/details/126714327" title="【k8s】一、基础实验环境准备">【k8s】一、基础实验环境准备</a></p> 
<p><a href="https://blog.csdn.net/zhh763984017/article/details/126714567" title="【k8s】二、containerd的安装">【k8s】二、containerd的安装</a></p> 
<p>我们已经把搭建k8s集群所需的基础环境都构建好了，接下来，我们来对k8s进行部署，初始化一个属于我们自己的k8s集群。我们此次安装的k8s版本是<code>1.24.3</code>。</p> 
<p>k8s的安装有多种方式，本次教程我们采用其中最简单的一种方式，通过kubeadm来进行安装。</p> 
<h2 id="%E7%8E%AF%E5%A2%83%E8%A7%84%E5%88%92">环境规划</h2> 
<p>在<a href="https://blog.csdn.net/zhh763984017/article/details/126714327" title="【k8s】一、基础实验环境准备">【k8s】一、基础实验环境准备</a>中已经将本次实验所有节点的网络规划好了</p> 
<table><tbody><tr><td colspan="1" rowspan="1"> <p>机器</p> </td><td colspan="1" rowspan="1"> <p>IP地址</p> </td></tr><tr><td colspan="1" rowspan="1"> <p>物理机</p> </td><td colspan="1" rowspan="1"> <p>192.168.137.99</p> </td></tr><tr><td colspan="1" rowspan="1"> <p>k8s-master</p> </td><td colspan="1" rowspan="1"> <p>192.168.137.200</p> </td></tr><tr><td colspan="1" rowspan="1"> <p>k8s-node1</p> </td><td colspan="1" rowspan="1"> <p>192.168.137.201</p> </td></tr><tr><td colspan="1" rowspan="1"> <p>k8s-node2</p> </td><td colspan="1" rowspan="1"> <p>192.168.137.202</p> </td></tr></tbody></table> 
<h2 id="kubeadm%20kubelet%20kubectl">kubeadm kubelet kubectl</h2> 
<p><code>kubeadm</code>是一个<code>Kubernetes</code>的部署工具，负责执行构建一个最小化的可用集群以及将其启动等的必要基本步骤。提供<code>kubeadm init</code> 和 <code>kubeadm join</code>两个操作命令，可以让我们快速部署一个Kubernetes集群。</p> 
<p><code>kubeadm</code>是<code>Kubernetes</code>集群全生命周期的管理工具，可用于实现集群的部署、升级、降级及拆除。<code>kubeadm</code>部署<code>Kubernetes</code>集群是将大部分资源以<code>pod</code>的方式运行，例如（<code>kube-proxy</code>、<code>kube-controller-manager</code>、<code>kube-scheduler</code>、<code>kube-apiserver</code>、<code>flannel</code>)都是以<code>pod</code>方式运行。</p> 
<p><code>kubectl</code>是Kubernetes集群的命令行工具，通过<code>kubectl</code>能够对集群本身进行管理，并能够在集群上进行容器化应用的安装和部署。接下来我们会经常与<code>kubectl</code>命令打交道的</p> 
<h2 id="%E5%AE%89%E8%A3%85kubeadm">安装kubeadm</h2> 
<p><strong>master节点和所有node节点都需要执行本步骤安装。其中kubectl可以在node节点上面不安装，但是初学者的话，都安装也无妨。</strong></p> 
<p>1. 添加k8s的阿里云yum源</p> 
<pre><code class="language-bash">cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; EOF
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF</code></pre> 
<p></p> 
<p><img alt="" height="161" src="https://images2.imgbox.com/a9/6c/CBTC582N_o.png" width="886"></p> 
<p>2. yum安装<strong><code>kubeadm</code> <code>kubelet</code> <code>kubectl</code></strong></p> 
<p>k8s部署工具的版本要跟我们要搭建的k8s集群的版本要相对应，此次我们安装的是1.24.3版本的，因此<strong><code>kubeadm</code>、<code>kubelet</code>、<code>kubectl</code></strong>的版本都要对应</p> 
<pre><code class="language-bash">yum install kubelet-1.24.3 kubeadm-1.24.3 kubectl-1.24.3 -y</code></pre> 
<p><img alt="" height="403" src="https://images2.imgbox.com/2f/18/BMtwhQDf_o.png" width="886"></p> 
<p> 启动kubelet</p> 
<pre><code class="language-bash">systemctl enable kubelet.service</code></pre> 
<h2 id="master%E8%8A%82%E7%82%B9%E5%88%9D%E5%A7%8B%E5%8C%96">master节点初始化</h2> 
<p>通过<strong><code>kubeadm init</code></strong>命令，我们可以快速对master节点进行初始化。</p> 
<p>执行如下命令：</p> 
<pre><code class="language-bash">kubeadm init --apiserver-advertise-address=192.168.137.200 --image-repository registry.aliyuncs.com/google_containers --kubernetes-version v1.24.3 --service-cidr=10.96.0.0/12 --pod-network-cidr=10.244.0.0/16 </code></pre> 
<p>这个过程有点久，请耐心等候。等候的时候，我们来一起看一下上面的命令参数代表了什么意思。</p> 
<p>参数解析：</p> 
<ul><li>apiserver-advertise-address API 服务器所在的地址，这里就是master节点的IP</li><li>image-repository 配置拉取k8s镜像的容器仓库，我们配置的是阿里的一个镜像仓库</li><li>kubernetes-version 指定k8s的版本。</li><li>service-cidr 服务的虚拟 IP 地址另外指定 IP 地址段</li><li>pod-network-cidr pod节点网络可以使用的 IP 地址段</li></ul> 
<p><code>service-cidr</code>和<code>pod-network-cidr</code>的IP地址段设置是依据你service和pod的容量决定的。</p> 
<p>咱们可以通过IP计算机算出网段的容量</p> 
<p>https://tool.520101.com/wangluo/ipjisuan/</p> 
<p>service网段的容量如下图所示：</p> 
<p><img alt="" height="280" src="https://images2.imgbox.com/da/8c/ug3yVsQ2_o.png" width="594"></p> 
<p>Pod网段如下图所示：</p> 
<p><img alt="" height="276" src="https://images2.imgbox.com/c6/0f/ompYkBoQ_o.png" width="567"></p> 
<p>经过一段时间之后，k8s的控制平面就已经安装完成。如下图所示：</p> 
<p><img alt="" height="874" src="https://images2.imgbox.com/d7/7f/PTztlA1O_o.png" width="1200"></p> 
<p>根据输出提示，</p> 
<p>接下来我们配置一下master节点</p> 
<pre><code class="language-bash">mkdir -p $HOME/.kube &amp;&amp; \
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config &amp;&amp; \
sudo chown $(id -u):$(id -g) $HOME/.kube/config </code></pre> 
<p>同样的根据 <strong><code>kubeadm init</code></strong> 之后的提示，我们知道Node节点加入集群的命令如下：</p> 
<pre><code class="language-bash">kubeadm join 192.168.137.200:6443 --token fm17us.mptry3ijamo9avr2 \
        --discovery-token-ca-cert-hash sha256:b87cda5b45265db24b29260060fe8e537abb5547604d865a957dc7a026eb36a6</code></pre> 
<h2 id="node%E8%8A%82%E7%82%B9%E5%88%9D%E5%A7%8B%E5%8C%96%E5%8A%A0%E5%85%A5%E9%9B%86%E7%BE%A4">node节点初始化加入集群</h2> 
<p>node1节点输入上面命令，加入集群</p> 
<p><img alt="" height="285" src="https://images2.imgbox.com/e9/c0/8wyM0PIq_o.png" width="1200"></p> 
<p>node2节点输入上面命令，加入集群</p> 
<p><img alt="" height="285" src="https://images2.imgbox.com/ee/e3/aSOK8tZd_o.png" width="1200"></p> 
<p>回到master节点，输入<strong>kubectl get nodes</strong>命令，此时我们可以看到有三个节点，</p> 
<p><img alt="" height="127" src="https://images2.imgbox.com/38/b0/ZLp7ruZw_o.png" width="542"></p> 
<p>细心的同学可能会发现，我们节点是有了，但是节点的状态都是NotReady。这是因为集群的网络还没有配好，问题不大，我们接着走。</p> 
<h2 id="%E9%9B%86%E7%BE%A4%E7%BD%91%E7%BB%9C%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B9%8Bflannel">集群网络初始化之flannel</h2> 
<p>初始化我们的集群网络，在master节点执行如下命令</p> 
<pre><code class="language-bash">curl -O https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml &amp;&amp; \
kubectl apply -f kube-flannel.yml</code></pre> 
<p>上面的命令，第一个是下载flannel的配置文件，第二个命令是通过kubectl进行安装</p> 
<p><img alt="" height="172" src="https://images2.imgbox.com/0f/3e/SQSes7ye_o.png" width="1200"></p> 
<p>接着静静等待即可，我们可以通过命令<strong><code>kubectl get pod -n kube-flannel</code></strong>查看flannel的Pod启动情况，等到flannel的pod的状态变为Running时，这时，我们用<code>kubeclt get nodes</code>命令就会发现，所有节点的状态都变为<code>Ready</code>了。</p> 
<p><img alt="" height="297" src="https://images2.imgbox.com/7b/2b/xsF2doth_o.png" width="886"></p> 
<h2 id="%E6%8A%A5%E9%94%99">报错</h2> 
<h3 id="kubeadm%20init%20%E6%8A%A5%E9%94%99">kubeadm init 报错</h3> 
<p><code>kubeadm init</code>时报错如下，</p> 
<pre><code class="language-bash">[kubelet-check] Initial timeout of 40s passed.

Unfortunately, an error has occurred:
        timed out waiting for the condition

This error is likely caused by:
        - The kubelet is not running
        - The kubelet is unhealthy due to a misconfiguration of the node in some way (required cgroups disabled)

If you are on a systemd-powered system, you can try to troubleshoot the error with the following commands:
        - 'systemctl status kubelet'
        - 'journalctl -xeu kubelet'

Additionally, a control plane component may have crashed or exited when started by the container runtime.
To troubleshoot, list all containers using your preferred container runtimes CLI.
Here is one example how you may list all running Kubernetes containers by using crictl:
        - 'crictl --runtime-endpoint unix:///var/run/containerd/containerd.sock ps -a | grep kube | grep -v pause'
        Once you have found the failing container, you can inspect its logs with:
        - 'crictl --runtime-endpoint unix:///var/run/containerd/containerd.sock logs CONTAINERID'
error execution phase wait-control-plane: couldn't initialize a Kubernetes cluster
To see the stack trace of this error execute with --v=5 or higher</code></pre> 
<p> <img alt="" height="467" src="https://images2.imgbox.com/b9/f6/jplI9w8I_o.png" width="886"></p> 
<p> 原因排查如下：</p> 
<p>1. 可能是因为你的kubelet只在master节点上面安装。</p> 
<p>通过<code>systemctl status kubelet</code>查看可以发现kubelet报错，当你只有一个节点的时候，就会报错。各位同学想复现此问题的话，可以就只在一台机子上安装<code>kubelet</code></p> 
<p><img alt="" height="178" src="https://images2.imgbox.com/e9/52/hggXzBzz_o.png" width="886"></p> 
<p> 2. 引起上面的报错还会有另外一种可能，就是kubeadm拉不到镜像，此时我们要检查我们的containerd是否能够拉取到我们的k8s控制平面的镜像。检查我们的<code>/etc/containerd/config.toml</code>文件是否配置正确。</p> 
<h3 id="kubectl%20get%20nodes%E6%8A%A5%E9%94%99">kubectl get nodes报错</h3> 
<p>使用kubectl命令时报错如下</p> 
<pre><code class="language-bash">The connection to the server localhost:8080 was refused - did you specify the right host or port?</code></pre> 
<p>这是因为在kubeadm init之后，没有正确配置master节点</p> 
<h2 id="%E6%80%BB%E7%BB%93">总结</h2> 
<p>基于前面两篇文章的环境铺垫，本文介绍了如何通过kubeadm进行k8s集群的部署。先是简单介绍了kubeadm、kubelet、kubectl的安装。接着就是master节点和node节点的安装以及初始化，经过这三篇文章，一个属于我们自己的k8s集群就已经完全搭建起来了。接下来咱们就可以开心的进行k8s的操作实验了。</p> 
<p>题外话，这篇文章鸽了有点久，本来是想一口气写完的，结果还是拖拖拖了。</p> 
<p>在我计划写这个教程的时候，<code>1.24.3</code>是最新的版本。今天整理完这篇博客时，上去官网一看，发现已经更新到了<code>1.25</code>版本了。不过也是一样的。</p> 
<h2 id="%E5%86%99%E5%9C%A8%E5%90%8E%E9%9D%A2">写在后面</h2> 
<p>如果觉得有用的话，麻烦<strong>一键三连</strong>支持一下<strong>攻城狮白玉</strong>，并把本文分享给更多的小伙伴。你的简单支持，我的无限创作动力</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/42fef2b9efc3768678a85253322b18f4/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Tomcat任意文件上传漏洞（CVE-2017-12615）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/92c7b06f4a7a047e56c228e3107faf84/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Trie字典树及内存占用优化</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>