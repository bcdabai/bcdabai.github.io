<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>nginx实现https与http共存方案 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="nginx实现https与http共存方案" />
<meta property="og:description" content="nginx实现https与http共存方案 前言nginx配置nginx安装对应模块配置文件修改server模块分别配置http和httpssteam模块中的配置完整配置文件 重启nginx并测试 总结 前言 在日常开发中，到正式上线的时候大部分需要使用https来保证链路传输的安全性，这块相信大家都了解了，但有些特殊场景下可能需要http和https共存，并且端口都是同一个端口，只是协议不同，那这块我们就借助nginx来配置了。
nginx配置 nginx安装对应模块 通过configure安装共存需要的模块stream、with-stream_ssl_preread_module、http_ssl_module。如果自身nginx配置了其他模块，记得把原来的模块的内容添加进去。 ./configure --with-stream --with-stream_ssl_preread_module --with-http_ssl_module 编译安装的模块，使用make命令,等待编译完成 make 编译完成后复制新的nginx文件替换到原来的nginx启动文件。记得先备份原来的nginx文件 mv /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.bak //备份原有文件 cp -r /usr/local/nginx-1.22.0/objs/nginx /usr/local/nginx/sbin/ //复制新的nginx // 到nginx的目录检验是否安装好 cd /usr/local/nginx/sbin/ ./nginx -V 检查版本信息以及安装的模块是否正确，版本信息和模块都没问题的话就ok了。
配置文件修改 server模块分别配置http和https 添加http的server监听 server { listen 8083; ##监听端口 server_name localhost; location { proxy_pass http://127.0.0.1:8001; ##应用服务地址，如tomcat对应地址 } } 添加https的server监听 #Https请求 server { listen 8082 ssl; #使用不同的端口监听 server_name localhost; ssl_certificate /usr/local/nginx/conf/cert/xxxx.pem; #证书放到 nginx的/conf/cert/文件夹内 ssl_certificate_key /usr/local/nginx/conf/cert/xxxx.key; #证书放到 nginx的/conf/cert/文件夹内 ssl_protocols TLSv1.2; ssl_ciphers ECDHE-RSA-AES256-SHA384:AES256-SHA256:RC4:HIGH:!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/9ecbb67672170878f3db19464b6cb348/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-29T11:13:47+08:00" />
<meta property="article:modified_time" content="2022-09-29T11:13:47+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">nginx实现https与http共存方案</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>nginx实现https与http共存方案</h4> 
 <ul><li><a href="#_2" rel="nofollow">前言</a></li><li><a href="#nginx_5" rel="nofollow">nginx配置</a></li><li><ul><li><a href="#nginx_6" rel="nofollow">nginx安装对应模块</a></li><li><a href="#_26" rel="nofollow">配置文件修改</a></li><li><ul><li><a href="#serverhttphttps_27" rel="nofollow">server模块分别配置http和https</a></li><li><a href="#steam_63" rel="nofollow">steam模块中的配置</a></li><li><a href="#_106" rel="nofollow">完整配置文件</a></li></ul> 
   </li><li><a href="#nginx_211" rel="nofollow">重启nginx并测试</a></li></ul> 
  </li><li><a href="#_239" rel="nofollow">总结</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_2"></a>前言</h2> 
<p>在日常开发中，到正式上线的时候大部分需要使用https来保证链路传输的安全性，这块相信大家都了解了，但有些特殊场景下可能需要http和https共存，并且端口都是同一个端口，只是协议不同，那这块我们就借助nginx来配置了。</p> 
<h2><a id="nginx_5"></a>nginx配置</h2> 
<h3><a id="nginx_6"></a>nginx安装对应模块</h3> 
<ul><li>通过configure安装共存需要的模块stream、with-stream_ssl_preread_module、http_ssl_module。<em>如果自身nginx配置了其他模块，记得把原来的模块的内容添加进去。</em></li></ul> 
<pre><code class="prism language-javascript"><span class="token punctuation">.</span><span class="token operator">/</span>configure <span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>stream <span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>stream_ssl_preread_module <span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>http_ssl_module
</code></pre> 
<ul><li>编译安装的模块，使用make命令,等待编译完成</li></ul> 
<pre><code class="prism language-javascript">make
</code></pre> 
<ul><li>编译完成后复制新的nginx文件替换到原来的nginx启动文件。记得先备份原来的nginx文件</li></ul> 
<pre><code class="prism language-javascript">mv <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>nginx<span class="token operator">/</span>sbin<span class="token operator">/</span>nginx <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>nginx<span class="token operator">/</span>sbin<span class="token operator">/</span>nginx<span class="token punctuation">.</span>bak   <span class="token comment">//备份原有文件</span>
cp <span class="token operator">-</span>r <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>nginx<span class="token operator">-</span><span class="token number">1.22</span><span class="token number">.0</span><span class="token operator">/</span>objs<span class="token operator">/</span>nginx <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>nginx<span class="token operator">/</span>sbin<span class="token operator">/</span>   <span class="token comment">//复制新的nginx</span>
<span class="token comment">// 到nginx的目录检验是否安装好</span>
cd <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>nginx<span class="token operator">/</span>sbin<span class="token operator">/</span>
<span class="token punctuation">.</span><span class="token operator">/</span>nginx <span class="token operator">-</span><span class="token constant">V</span>
</code></pre> 
<ul><li>检查版本信息以及安装的模块是否正确，版本信息和模块都没问题的话就ok了。<br> <img src="https://images2.imgbox.com/9d/c0/VefUYfM3_o.png" alt="检查nginx配置"></li></ul> 
<h3><a id="_26"></a>配置文件修改</h3> 
<h4><a id="serverhttphttps_27"></a>server模块分别配置http和https</h4> 
<ul><li>添加http的server监听</li></ul> 
<pre><code class="prism language-powershell">    server <span class="token punctuation">{<!-- --></span>
		listen       8083<span class="token punctuation">;</span>   <span class="token comment">##监听端口</span>
        server_name  localhost<span class="token punctuation">;</span>

		location <span class="token punctuation">{<!-- --></span>
			proxy_pass   http:<span class="token operator">/</span><span class="token operator">/</span>127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:8001<span class="token punctuation">;</span> <span class="token comment">##应用服务地址，如tomcat对应地址</span>
		<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<ul><li>添加https的server监听</li></ul> 
<pre><code class="prism language-powershell">      <span class="token comment">#Https请求</span>
    server <span class="token punctuation">{<!-- --></span>
        listen 8082 ssl<span class="token punctuation">;</span> <span class="token comment">#使用不同的端口监听</span>
        server_name localhost<span class="token punctuation">;</span>
		
        ssl_certificate <span class="token operator">/</span>usr/local/nginx/conf/cert/xxxx<span class="token punctuation">.</span>pem<span class="token punctuation">;</span> <span class="token comment">#证书放到 nginx的/conf/cert/文件夹内</span>
        ssl_certificate_key <span class="token operator">/</span>usr/local/nginx/conf/cert/xxxx<span class="token punctuation">.</span>key<span class="token punctuation">;</span> <span class="token comment">#证书放到 nginx的/conf/cert/文件夹内</span>

        ssl_protocols TLSv1<span class="token punctuation">.</span>2<span class="token punctuation">;</span>
        ssl_ciphers ECDHE-RSA-AES256-SHA384:AES256-SHA256:RC4:HIGH:<span class="token operator">!</span>MD5:<span class="token operator">!</span>aNULL:<span class="token operator">!</span>eNULL:<span class="token operator">!</span>NULL:<span class="token operator">!</span>DH:<span class="token operator">!</span>EDH:<span class="token operator">!</span>AESGCM<span class="token punctuation">;</span>
        ssl_prefer_server_ciphers on<span class="token punctuation">;</span>
        ssl_session_cache shared:SSL:10m<span class="token punctuation">;</span>
        ssl_session_timeout 10m<span class="token punctuation">;</span>

        location <span class="token operator">/</span> <span class="token punctuation">{<!-- --></span>  
	    	proxy_pass   http:<span class="token operator">/</span><span class="token operator">/</span>127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:8083<span class="token punctuation">;</span>   <span class="token comment">#转发到http的请求中去</span>
        <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="steam_63"></a>steam模块中的配置</h4> 
<ul><li>steam是与http模块统一个级别的，需要先添加steam模块的配置。</li></ul> 
<pre><code class="prism language-powershell">stream<span class="token punctuation">{<!-- --></span>

    log_format proxy <span class="token string">'$remote_addr [$time_local] '</span>
                 <span class="token string">'$protocol $status $bytes_sent $bytes_received '</span>
                 <span class="token string">'$session_time "$upstream_addr" '</span>
                 <span class="token string">'"$upstream_bytes_sent" "$upstream_bytes_received" "$upstream_connect_time"'</span><span class="token punctuation">;</span>

      access_log <span class="token operator">/</span>usr/local/nginx/logs/tcp_access<span class="token punctuation">.</span>log proxy<span class="token punctuation">;</span>
      error_log <span class="token operator">/</span>usr/local/nginx/logs/tcp_error<span class="token punctuation">.</span>log error<span class="token punctuation">;</span>
      open_log_file_cache off<span class="token punctuation">;</span>
	
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>在steam模块中分别配置http和https的监听</li></ul> 
<pre><code class="prism language-powershell">
	server <span class="token punctuation">{<!-- --></span>
    	  listen 8084<span class="token punctuation">;</span><span class="token comment">#nginx侦听端口,统一对外端口，不能与下面已有的端口使用同一个</span>
    	  ssl_preread on<span class="token punctuation">;</span>
    	  proxy_pass <span class="token variable">$upstream</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

 	<span class="token comment"># 根据不同的协议走不同的upstream</span>
       map <span class="token variable">$ssl_preread_protocol</span> <span class="token variable">$upstream</span> <span class="token punctuation">{<!-- --></span>  
    	 default http_gateway<span class="token punctuation">;</span>
   		<span class="token string">"TLSv1.2"</span> https_gateway<span class="token punctuation">;</span>
    	<span class="token string">"TLSv1.3"</span> https_gateway<span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
	<span class="token comment">#http请求</span>
		upstream http_gateway <span class="token punctuation">{<!-- --></span>
   	    	server  127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:8083<span class="token punctuation">;</span> 
        <span class="token punctuation">}</span>
	<span class="token comment">#https请求</span>
        upstream https_gateway <span class="token punctuation">{<!-- --></span>
            server  127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:8082<span class="token punctuation">;</span> 
        <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_106"></a>完整配置文件</h4> 
<pre><code class="prism language-powershell">
<span class="token comment">#user  nobody;</span>
user root<span class="token punctuation">;</span>
worker_processes  1<span class="token punctuation">;</span>

<span class="token comment">#error_log  logs/error.log;</span>
<span class="token comment">#error_log  logs/error.log  notice;</span>
<span class="token comment">#error_log  logs/error.log  info;</span>

<span class="token comment">#pid        logs/nginx.pid;</span>


events <span class="token punctuation">{<!-- --></span>
    worker_connections  1024<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


stream<span class="token punctuation">{<!-- --></span>

    log_format proxy <span class="token string">'$remote_addr [$time_local] '</span>
                 <span class="token string">'$protocol $status $bytes_sent $bytes_received '</span>
                 <span class="token string">'$session_time "$upstream_addr" '</span>
                 <span class="token string">'"$upstream_bytes_sent" "$upstream_bytes_received" "$upstream_connect_time"'</span><span class="token punctuation">;</span>

      access_log <span class="token operator">/</span>usr/local/nginx/logs/tcp_access<span class="token punctuation">.</span>log proxy<span class="token punctuation">;</span>
      error_log <span class="token operator">/</span>usr/local/nginx/logs/tcp_error<span class="token punctuation">.</span>log error<span class="token punctuation">;</span>
      open_log_file_cache off<span class="token punctuation">;</span>

	
	  <span class="token comment"># 根据不同的协议走不同的upstream</span>
       map <span class="token variable">$ssl_preread_protocol</span> <span class="token variable">$upstream</span> <span class="token punctuation">{<!-- --></span>  
    	 default http_gateway<span class="token punctuation">;</span>
		<span class="token string">"TLSv1.2"</span> https_gateway<span class="token punctuation">;</span>
    	<span class="token string">"TLSv1.3"</span> https_gateway<span class="token punctuation">;</span>
       <span class="token punctuation">}</span>

       server <span class="token punctuation">{<!-- --></span>
    	  listen 8084<span class="token punctuation">;</span><span class="token comment">#nginx侦听端口</span>
    	  ssl_preread on<span class="token punctuation">;</span>
    	  proxy_pass <span class="token variable">$upstream</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		
		<span class="token comment">#http请求</span>
		upstream http_gateway <span class="token punctuation">{<!-- --></span>
			server  127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:8083<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token comment">#https请求</span>
        upstream https_gateway <span class="token punctuation">{<!-- --></span>
            server  127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:8082<span class="token punctuation">;</span> 
        <span class="token punctuation">}</span>

<span class="token punctuation">}</span>


http <span class="token punctuation">{<!-- --></span>
    include       mime<span class="token punctuation">.</span>types<span class="token punctuation">;</span>
    default_type  application/octet-stream<span class="token punctuation">;</span>

    sendfile        on<span class="token punctuation">;</span>
    <span class="token comment">#tcp_nopush     on;</span>

    <span class="token comment">#keepalive_timeout  0;</span>
    keepalive_timeout  65<span class="token punctuation">;</span>

    <span class="token comment">#gzip  on;</span>


    
    server <span class="token punctuation">{<!-- --></span>
		listen       8083<span class="token punctuation">;</span>
        server_name  localhost<span class="token punctuation">;</span>
		
		location <span class="token punctuation">{<!-- --></span>
			proxy_pass   http:<span class="token operator">/</span><span class="token operator">/</span>127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:8001<span class="token punctuation">;</span> <span class="token comment">##应用服务地址，如tomcat对应地址</span>
		<span class="token punctuation">}</span>

    <span class="token punctuation">}</span>


   <span class="token comment">#Https请求</span>
    server <span class="token punctuation">{<!-- --></span>
        listen 8082 ssl<span class="token punctuation">;</span>
        server_name localhost<span class="token punctuation">;</span>

        ssl_certificate <span class="token operator">/</span>usr/local/nginx/conf/cert/xxxx<span class="token punctuation">.</span>pem<span class="token punctuation">;</span> <span class="token comment">#证书放到 nginx的/conf/cert/文件夹内</span>
        ssl_certificate_key <span class="token operator">/</span>usr/local/nginx/conf/cert/xxxx<span class="token punctuation">.</span>key<span class="token punctuation">;</span> <span class="token comment">#证书放到 nginx的/conf/cert/文件夹内</span>

        ssl_protocols TLSv1<span class="token punctuation">.</span>2<span class="token punctuation">;</span>
        ssl_ciphers ECDHE-RSA-AES256-SHA384:AES256-SHA256:RC4:HIGH:<span class="token operator">!</span>MD5:<span class="token operator">!</span>aNULL:<span class="token operator">!</span>eNULL:<span class="token operator">!</span>NULL:<span class="token operator">!</span>DH:<span class="token operator">!</span>EDH:<span class="token operator">!</span>AESGCM<span class="token punctuation">;</span>
        ssl_prefer_server_ciphers on<span class="token punctuation">;</span>
        ssl_session_cache shared:SSL:10m<span class="token punctuation">;</span>
        ssl_session_timeout 10m<span class="token punctuation">;</span>

        location <span class="token operator">/</span> <span class="token punctuation">{<!-- --></span>
	    proxy_pass   http:<span class="token operator">/</span><span class="token operator">/</span>127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:8083<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre> 
<h3><a id="nginx_211"></a>重启nginx并测试</h3> 
<ul><li>测试nginx配置文件是否有问题。</li></ul> 
<pre><code class="prism language-javascript"><span class="token comment">//到对应目录，检验配置文件是否有错误</span>
<span class="token punctuation">.</span><span class="token operator">/</span>nginx <span class="token operator">-</span> t
</code></pre> 
<p><img src="https://images2.imgbox.com/1a/b3/qHQAcWrU_o.png" alt="检验配置文件"></p> 
<ul><li>没有相关错误即可重启nginx</li></ul> 
<pre><code class="prism language-javascript"><span class="token punctuation">.</span><span class="token operator">/</span>nginx <span class="token operator">-</span> s reload
</code></pre> 
<ul><li>reload命令在安装了模块后有可能不生效，可以使用kill的方式停止nginx后重新启动</li></ul> 
<pre><code class="prism language-powershell"><span class="token function">ps</span> <span class="token operator">-</span>ef<span class="token punctuation">|</span>grep nginx   <span class="token comment">##查看nginx对应的进程</span>
<span class="token function">kill</span> <span class="token operator">-</span>TERM pid   <span class="token comment">##kill掉查看出来的进程id</span>
<span class="token punctuation">.</span><span class="token operator">/</span>nginx <span class="token operator">-</span>c <span class="token operator">/</span>usr/local/nginx/conf/nginx<span class="token punctuation">.</span>conf   <span class="token comment">##指定配置文件重新启动</span>
</code></pre> 
<ul><li>使用对应的地址进行测试。按上面配置则可以访问<br> http://ip:8084/<br> https://ip:8084/<br> 两个地址都能访问则代表配置成功。</li></ul> 
<h2><a id="_239"></a>总结</h2> 
<p>以上呢就是http和https共存的基本配置了，大家可以尽情发挥了，可以跟着这块去延续其他的各种配置，比如请求http的时候默认跳转到https等等。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d982757865ce857b2778ab12d14eb323/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">MAC地址格式详解</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0aa1ac13c81b55fafb875d1ac9f03c11/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">VMLogin 主帐号和子账号的功能介绍</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>