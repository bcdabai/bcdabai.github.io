<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>亲手创建一台Ubuntu&#43;PHP5&#43;MySQL5&#43;Nginx&#43;openSSL&#43;sshFtp(sftp)的微信小程序云服务器 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="亲手创建一台Ubuntu&#43;PHP5&#43;MySQL5&#43;Nginx&#43;openSSL&#43;sshFtp(sftp)的微信小程序云服务器" />
<meta property="og:description" content="亲手创建一台Ubuntu&#43;PHP5&#43;MySQL5&#43;Nginx&#43;openSSL&#43;sshFtp的微信小程序云服务器 小程序要求Request必须SSL连接，一般虚拟主机不支持SSL，自己有云服务器最佳。
系统可以选Ubuntu14 64位 //更新apt-get
sudo apt-get update //安装nginx
sudo apt-get install nginx //选择Y安装 //安装PHP5-fpm
sudo apt-get install php5-fpm //安装MySQL5
sudo apt-get install mysql-server mysql-client //过程中输入两次root的密码。 //安装php的各种模块支持
apt-get install php5-mysql php5-curl php5-gd php5-intl php-pear php5-imagick php5-imap php5-mcrypt php5-memcache php5-ming php5-ps php5-pspell php5-recode php5-snmp php5-sqlite php5-tidy php5-xmlrpc php5-xsl //直接Y，全安装 //设置 php.ini
sudo vi /etc/php5/fpm/php.ini //使用VI，按i进入insert插入模式。 //找到 #cgi.fix_pathinfo=1 //改成 cgi.fix_pathinfo=0 //记得去掉前面的注释。 //按大写的Q，输入w保存，输入q退出。 //接下来修改nginx配置。直接添加一个配置即可。
sudo vi /etc/nginx/conf.d/my.conf //生成一个 xxxx.conf ，无所谓文件名，扩展名是conf就会被引用。 //输入下面的内容：
server { listen 80; listen 443 ssl; root /我的www目录; ssl on; ssl_certificate /etc/ssl/private/1_api." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/8f22bf44baab0e152ba3ed10570a83d7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2017-05-16T23:01:53+08:00" />
<meta property="article:modified_time" content="2017-05-16T23:01:53+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">亲手创建一台Ubuntu&#43;PHP5&#43;MySQL5&#43;Nginx&#43;openSSL&#43;sshFtp(sftp)的微信小程序云服务器</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2 id="亲手创建一台ubuntuphp5mysql5nginxopensslsshftp的微信小程序云服务器">亲手创建一台Ubuntu+PHP5+MySQL5+Nginx+openSSL+sshFtp的微信小程序云服务器</h2> 
<p>小程序要求Request必须SSL连接，一般虚拟主机不支持SSL，自己有云服务器最佳。</p> 
<p>系统可以选Ubuntu14 64位 <br> //更新apt-get</p> 
<pre class="prettyprint"><code class=" hljs bash"><span class="hljs-built_in">sudo</span>  apt-get update</code></pre> 
<p>//安装nginx</p> 
<pre class="prettyprint"><code class=" hljs bash"><span class="hljs-built_in">sudo</span> apt-get install nginx</code></pre> 
<p>//选择Y安装 <br> //安装PHP5-fpm</p> 
<pre class="prettyprint"><code class=" hljs lasso">sudo apt<span class="hljs-attribute">-get</span> install php5<span class="hljs-attribute">-fpm</span></code></pre> 
<p>//安装MySQL5</p> 
<pre class="prettyprint"><code class=" hljs lasso">sudo apt<span class="hljs-attribute">-get</span> install mysql<span class="hljs-attribute">-server</span> mysql<span class="hljs-attribute">-client</span></code></pre> 
<p>//过程中输入两次root的密码。 <br> //安装php的各种模块支持</p> 
<pre class="prettyprint"><code class=" hljs lasso">apt<span class="hljs-attribute">-get</span> install php5<span class="hljs-attribute">-mysql</span> php5<span class="hljs-attribute">-curl</span> php5<span class="hljs-attribute">-gd</span> php5<span class="hljs-attribute">-intl</span> php<span class="hljs-attribute">-pear</span> php5<span class="hljs-attribute">-imagick</span> php5<span class="hljs-attribute">-imap</span> php5<span class="hljs-attribute">-mcrypt</span> php5<span class="hljs-attribute">-memcache</span> php5<span class="hljs-attribute">-ming</span> php5<span class="hljs-attribute">-ps</span> php5<span class="hljs-attribute">-pspell</span> php5<span class="hljs-attribute">-recode</span> php5<span class="hljs-attribute">-snmp</span> php5<span class="hljs-attribute">-sqlite</span> php5<span class="hljs-attribute">-tidy</span> php5<span class="hljs-attribute">-xmlrpc</span> php5<span class="hljs-attribute">-xsl</span></code></pre> 
<p>//直接Y，全安装 <br> //设置 php.ini</p> 
<pre class="prettyprint"><code class=" hljs bash"><span class="hljs-built_in">sudo</span> vi /etc/php5/fpm/php.ini</code></pre> 
<p>//使用VI，按i进入insert插入模式。 <br> //找到 <code>#cgi.fix_pathinfo=1</code> <br> //改成 <code>cgi.fix_pathinfo=0</code> <br> //记得去掉前面的注释。 <br> //按大写的Q，输入w保存，输入q退出。 <br> //接下来修改nginx配置。直接添加一个配置即可。</p> 
<pre class="prettyprint"><code class=" hljs avrasm">sudo vi /etc/nginx/conf<span class="hljs-preprocessor">.d</span>/my<span class="hljs-preprocessor">.conf</span></code></pre> 
<p>//生成一个 xxxx.conf ，无所谓文件名，扩展名是conf就会被引用。 <br> //输入下面的内容：</p> 
<pre class="prettyprint"><code class=" hljs avrasm">server {
    listen <span class="hljs-number">80</span><span class="hljs-comment">;</span>
    listen <span class="hljs-number">443</span> ssl<span class="hljs-comment">;</span>
    root /我的www目录<span class="hljs-comment">;</span>
    ssl on<span class="hljs-comment">;</span>
    ssl_certificate /etc/ssl/private/<span class="hljs-number">1</span>_api.我的域名<span class="hljs-preprocessor">.com</span>_bundle<span class="hljs-preprocessor">.crt</span><span class="hljs-comment">;</span>
    ssl_certificate_key /etc/ssl/private/<span class="hljs-number">2</span>_api.我的域名<span class="hljs-preprocessor">.com</span><span class="hljs-preprocessor">.key</span><span class="hljs-comment">;</span>

    index index<span class="hljs-preprocessor">.php</span> index<span class="hljs-preprocessor">.html</span><span class="hljs-comment">;</span>
    server_name api.我的域名<span class="hljs-preprocessor">.com</span><span class="hljs-comment">;</span>
    error_log /var/log/nginx/error<span class="hljs-preprocessor">.log</span><span class="hljs-comment">;</span>
    location ~ \<span class="hljs-preprocessor">.php</span>$ {
            <span class="hljs-preprocessor">#fastcgi_pass 127.0.0.1:9000;</span>
            <span class="hljs-preprocessor"># With php5-fpm:</span>
            fastcgi_pass unix:/var/run/php5-fpm<span class="hljs-preprocessor">.sock</span><span class="hljs-comment">;</span>
            fastcgi_index index<span class="hljs-preprocessor">.php</span><span class="hljs-comment">;</span>
            include fastcgi_params<span class="hljs-comment">;</span>
    }
}</code></pre> 
<p>//里面中文的部分自己修改成自己的，暂时没有证书文件，别急，等下告诉你怎么弄。 <br> //PHP基本不需要修改啥，但是常规的话呢，建议修改一下上传文件的大小，默认2M，可以修改为20M以上，现在的图片都大，网络也好啊。 <br> //nginx配置好了，PHP好了，mysql好了，就差重启了，但是还缺少 SSL <br> //如果输入ssl指令，出现错误，就说明没有安装过ssl，没有的话装一个SSL</p> 
<pre class="prettyprint"><code class=" hljs bash"><span class="hljs-built_in">sudo</span> apt-get install openssl</code></pre> 
<p>//然后，配置证书。必须要颁布的合法证书，自己建立的没有认可的没用的。推荐百度或腾讯云， <br> //这里使用腾讯云，毕竟都是一家的， <br> //登录<code>www.qcloud.com</code> ，SSL证书管理功能，你的域名必须已经备案过了，不然依然没有鸟用。 <br> //建立证书时应该输入具体域名，诸如 <code>api.你的域名.com</code>，建立后，可以采用手动DNS验证法，在域名的DNS里建立一个TXT的域名，内容就填写证书要求填写的认证码，比如：</p> 
<pre class="prettyprint"><code class=" hljs ">201705031627285aw1fem9slsqalbz55bs2dw055lo4t5aeltehraob4krr2kc94</code></pre> 
<p>//然后保存DNS解析，随后5分钟刷新证书，就会查看到证书已经颁发了。 <br> //下载证书，会得到一个你的域名的压缩包，解压后里面有三个操作系统的证书，使用Nginx里面的两个文件，你会惊喜的发现，这两个文件的文件名，和你上面Nginx配置信息里的两个证书名字一毛一样。 <br> //现在的问题就是：如何把证书上传上去了，因为我们没有FTP，我也不会其他方法…… <br> //那我们早晚要传文件，我就建立一个FTP吧，安全点，就建立SFTP，基于SSH的FTP文件传输。 <br> //安装一个sshftp server</p> 
<pre class="prettyprint"><code class=" hljs vbscript">sudo apt-<span class="hljs-keyword">get</span> install openssh-<span class="hljs-built_in">server</span></code></pre> 
<p>//安装完服务，我们进行用户建立。</p> 
<pre class="prettyprint"><code class=" hljs bash"><span class="hljs-built_in">sudo</span> useradd -m 我的用户名 <span class="hljs-operator">-s</span> /usr/sbin/nologin
<span class="hljs-built_in">sudo</span> passwd 我的用户名</code></pre> 
<p>//建立好用户，我们要让用户不能登录ssh，于是编辑/etc/shells</p> 
<pre class="prettyprint"><code class=" hljs bash"><span class="hljs-built_in">sudo</span> vi /etc/shells</code></pre> 
<p>//然后在shells末尾添加： </p> 
<pre class="prettyprint"><code class=" hljs ">/usr/sbin/nologin</code></pre> 
<p>//按大写Q，w，q，保存退出。 <br> //建立一个ftp的专用组</p> 
<pre class="prettyprint"><code class=" hljs bash"><span class="hljs-built_in">sudo</span> groupadd ftpaccess</code></pre> 
<p>//然后注销sshd_config里面的一行：如下</p> 
<pre class="prettyprint"><code class=" hljs lasso">sudo vi /etc/ssh/sshd_config
<span class="hljs-comment">//注销掉：  Subsystem sftp /usr/lib/openssh/sftp-server</span>
<span class="hljs-comment">//并在文件末尾添加：</span>
Subsystem sftp internal<span class="hljs-attribute">-sftp</span>
<span class="hljs-keyword">Match</span> <span class="hljs-keyword">group</span> ftpaccess
ChrootDirectory <span class="hljs-subst">%</span>h
X11Forwarding no
AllowTcpForwarding no
ForceCommand internal<span class="hljs-attribute">-sftp</span>
<span class="hljs-comment">//然后保存退出。</span></code></pre> 
<p>//下面我们要把用户放到我们设计好的组里。</p> 
<pre class="prettyprint"><code class=" hljs bash"><span class="hljs-built_in">sudo</span> usermod -m 我的用户名 -g ftpaccess <span class="hljs-operator">-s</span> /usr/sbin/nologin
//再建个你自己的目录，记得有权限啊。
<span class="hljs-built_in">sudo</span> mkdir /我的www目录
<span class="hljs-built_in">sudo</span> chown 我的用户名:ftpaccess /我的www目录
很重要：因为设置为 ChrootDirectory %h ， 所以，如果登录失败，则是因为 “主目录”的权限问题，要求 %h 必须是所在组为root</code></pre> 
<p>//ftp没问题了。重启一下服务器吧：</p> 
<pre class="prettyprint"><code class=" hljs bash"><span class="hljs-built_in">sudo</span> reboot now</code></pre> 
<p>//再启动起来时，FTP是可以使用的。于是连接FTP，使用SFTP登录，进入目录 <br> //上传证书压缩包里的Nginx里的两个证书文件到服务器，然后复制到指定目录：</p> 
<pre class="prettyprint"><code class=" hljs bash"><span class="hljs-built_in">sudo</span> cp 证书文件  /etc/ssl/private</code></pre> 
<p>//重启一切：</p> 
<pre class="prettyprint"><code class=" hljs bash"><span class="hljs-built_in">sudo</span> service nginx restart
<span class="hljs-built_in">sudo</span> service php5-fpm restart
<span class="hljs-built_in">sudo</span> service mysql restart</code></pre> 
<p>现在你可以访问你的服务器了</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f835be02df68314f6c03c76e7e3db0ec/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Jenkins执行shell脚本，提示“未找到命令”</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6edc3549be58035dbe683f085e75c6c5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">php&#43;mysql&#43;apache 环境搭建</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>