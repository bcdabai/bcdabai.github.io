<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>04--Redis的高级特性 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="04--Redis的高级特性" />
<meta property="og:description" content="1. Redis主从复制 1.1 概述 单个Redis支持的读写能力是有限的,此时我们可以使用多个redis来提高redis的并发处理能力,这些redis如何协同,就需要有一定的架构设计,这里我们首先从主从(Master/Slave)架构进行分析和实现。
1.2 架构图 其中，master负责读写，并将数据同步到slave，从节点负责读操作。
1.3 快速入门 基于redis，设计一个主从架构,一个Master,两个Slave,其中Master负责Redis读写操作,并将数据同步到Slave,Slave只负责读.,其步骤如下:
第一步：将redis01拷贝两份。
cp -r redis01/ redis02 cp -r redis01/ redis03 第二步：假如已有redis服务，先将原先所有的redis服务停止（docker rm -f redis 容器名），并启动新的redis容器。
创建第一个redis服务：
docker run -p 6379:6379 --name redis6379 \ -v /usr/local/docker/redis01/data:/data \ -v /usr/local/docker/redis01/conf/redis.conf:/etc/redis/redis.conf \ -d redis redis-server /etc/redis/redis.conf \ --appendonly yes 创建第二个redis服务：
docker run -p 6380:6379 --name redis6380 \ -v /usr/local/docker/redis02/data:/data \ -v /usr/local/docker/redis02/conf/redis.conf:/etc/redis/redis.conf \ -d redis redis-server /etc/redis/redis.conf \ --appendonly yes 创建第三个redis服务：
docker run -p 6381:6379 --name redis6381 \ -v /usr/local/docker/redis03/data:/data \ -v /usr/local/docker/redis03/conf/redis." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/a494b54ea179641f5e7aa125a7c15911/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-14T15:59:10+08:00" />
<meta property="article:modified_time" content="2023-02-14T15:59:10+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">04--Redis的高级特性</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="1_Redis_0"></a>1. Redis主从复制</h2> 
<h3><a id="11__1"></a>1.1 概述</h3> 
<p>单个Redis支持的读写能力是有限的,此时我们可以使用多个redis来提高redis的并发处理能力,这些redis如何协同,就需要有一定的架构设计,这里我们首先从主从(Master/Slave)架构进行分析和实现。</p> 
<h3><a id="12__3"></a>1.2 架构图</h3> 
<p>其中，master负责读写，并将数据同步到slave，从节点负责读操作。<br> <img src="https://images2.imgbox.com/5b/74/boVbMhwZ_o.png" alt=""></p> 
<h3><a id="13__6"></a>1.3 快速入门</h3> 
<p>基于redis，设计一个主从架构,一个Master,两个Slave,其中Master负责Redis读写操作,并将数据同步到Slave,Slave只负责读.,其步骤如下:<br> 第一步：将redis01拷贝两份。</p> 
<pre><code class="prism language-go">cp <span class="token operator">-</span>r redis01<span class="token operator">/</span> redis02
cp <span class="token operator">-</span>r redis01<span class="token operator">/</span> redis03
</code></pre> 
<p>第二步：假如已有redis服务，先将原先所有的redis服务停止（docker rm -f redis 容器名），并启动新的redis容器。<br> 创建第一个redis服务：</p> 
<pre><code class="prism language-go">docker run <span class="token operator">-</span>p <span class="token number">6379</span><span class="token punctuation">:</span><span class="token number">6379</span> <span class="token operator">--</span>name redis6379 \
<span class="token operator">-</span>v <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>docker<span class="token operator">/</span>redis01<span class="token operator">/</span>data<span class="token punctuation">:</span><span class="token operator">/</span>data \
<span class="token operator">-</span>v <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>docker<span class="token operator">/</span>redis01<span class="token operator">/</span>conf<span class="token operator">/</span>redis<span class="token punctuation">.</span>conf<span class="token punctuation">:</span><span class="token operator">/</span>etc<span class="token operator">/</span>redis<span class="token operator">/</span>redis<span class="token punctuation">.</span>conf \
<span class="token operator">-</span>d redis redis<span class="token operator">-</span>server <span class="token operator">/</span>etc<span class="token operator">/</span>redis<span class="token operator">/</span>redis<span class="token punctuation">.</span>conf \
<span class="token operator">--</span>appendonly yes
</code></pre> 
<p>创建第二个redis服务：</p> 
<pre><code class="prism language-go">docker run <span class="token operator">-</span>p <span class="token number">6380</span><span class="token punctuation">:</span><span class="token number">6379</span> <span class="token operator">--</span>name redis6380 \
<span class="token operator">-</span>v <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>docker<span class="token operator">/</span>redis02<span class="token operator">/</span>data<span class="token punctuation">:</span><span class="token operator">/</span>data \
<span class="token operator">-</span>v <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>docker<span class="token operator">/</span>redis02<span class="token operator">/</span>conf<span class="token operator">/</span>redis<span class="token punctuation">.</span>conf<span class="token punctuation">:</span><span class="token operator">/</span>etc<span class="token operator">/</span>redis<span class="token operator">/</span>redis<span class="token punctuation">.</span>conf \
<span class="token operator">-</span>d redis redis<span class="token operator">-</span>server <span class="token operator">/</span>etc<span class="token operator">/</span>redis<span class="token operator">/</span>redis<span class="token punctuation">.</span>conf \
<span class="token operator">--</span>appendonly yes
</code></pre> 
<p>创建第三个redis服务：</p> 
<pre><code class="prism language-go">docker run <span class="token operator">-</span>p <span class="token number">6381</span><span class="token punctuation">:</span><span class="token number">6379</span> <span class="token operator">--</span>name redis6381 \
<span class="token operator">-</span>v <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>docker<span class="token operator">/</span>redis03<span class="token operator">/</span>data<span class="token punctuation">:</span><span class="token operator">/</span>data \
<span class="token operator">-</span>v <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>docker<span class="token operator">/</span>redis03<span class="token operator">/</span>conf<span class="token operator">/</span>redis<span class="token punctuation">.</span>conf<span class="token punctuation">:</span><span class="token operator">/</span>etc<span class="token operator">/</span>redis<span class="token operator">/</span>redis<span class="token punctuation">.</span>conf \
<span class="token operator">-</span>d redis redis<span class="token operator">-</span>server <span class="token operator">/</span>etc<span class="token operator">/</span>redis<span class="token operator">/</span>redis<span class="token punctuation">.</span>conf \
<span class="token operator">--</span>appendonly yes
</code></pre> 
<p>第三步：检测redis服务角色<br> 启动三个客户端redis服务，分别登陆三台redis容器服务，通过<code>info replication</code>指令查看角色，默认新启动的三个redis服务角色都为master。</p> 
<pre><code class="prism language-go"><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">6379</span><span class="token operator">&gt;</span> info replication
</code></pre> 
<pre><code class="prism language-go">\# Replication
role<span class="token punctuation">:</span>master
connected_slaves<span class="token punctuation">:</span><span class="token number">0</span>
master_repl_offset<span class="token punctuation">:</span><span class="token number">3860</span>
repl_backlog_active<span class="token punctuation">:</span><span class="token number">1</span>
repl_backlog_size<span class="token punctuation">:</span><span class="token number">1048576</span>
repl_backlog_first_byte_offset<span class="token punctuation">:</span><span class="token number">2</span>
repl_backlog_histlen<span class="token punctuation">:</span><span class="token number">3859</span>
</code></pre> 
<p>第四步：检测redis6379的IP设置</p> 
<pre><code class="prism language-go">docker inspect redis6379
</code></pre> 
<pre><code class="prism language-go"><span class="token string">"Networks"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"bridge"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string">"IPAMConfig"</span><span class="token punctuation">:</span> null<span class="token punctuation">,</span>
                    <span class="token string">"Links"</span><span class="token punctuation">:</span> null<span class="token punctuation">,</span>
                    <span class="token string">"Aliases"</span><span class="token punctuation">:</span> null<span class="token punctuation">,</span>
                    <span class="token string">"NetworkID"</span><span class="token punctuation">:</span> <span class="token string">"c33071765cb48acb1efed6611615c767b04b98e6e298caa0dc845420e6112b73"</span><span class="token punctuation">,</span>
                    <span class="token string">"EndpointID"</span><span class="token punctuation">:</span> <span class="token string">"4c77e3f458ea64b7fc45062c5b2b3481fa32005153b7afc211117d0f7603e154"</span><span class="token punctuation">,</span>
                    <span class="token string">"Gateway"</span><span class="token punctuation">:</span> <span class="token string">"172.17.0.1"</span><span class="token punctuation">,</span>
                    <span class="token string">"IPAddress"</span><span class="token punctuation">:</span> <span class="token string">"172.17.0.2"</span><span class="token punctuation">,</span>
                    <span class="token string">"IPPrefixLen"</span><span class="token punctuation">:</span> <span class="token number">16</span><span class="token punctuation">,</span>
                    <span class="token string">"IPv6Gateway"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
                    <span class="token string">"GlobalIPv6Address"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
                    <span class="token string">"GlobalIPv6PrefixLen"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    <span class="token string">"MacAddress"</span><span class="token punctuation">:</span> <span class="token string">"02:42:ac:11:00:02"</span><span class="token punctuation">,</span>
                    <span class="token string">"DriverOpts"</span><span class="token punctuation">:</span> null
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
</code></pre> 
<p>第五步：设置Master/Slave架构<br> 分别登陆redis6380/redis6381，然后执行如下语句。<br> 假如master有密码,需要在slave的redis.conf配置文件中添加"masterauth 你的密码"这条语句,然后重启redis再执行slaveof 指令操作.</p> 
<pre><code class="prism language-go">slaveof <span class="token number">172.17</span><span class="token number">.0</span><span class="token number">.2</span> <span class="token number">6379</span> 
</code></pre> 
<p>第六步：再次登录redis6379，然后检测info。</p> 
<pre><code class="prism language-go"><span class="token punctuation">[</span>root@centos7964 ~<span class="token punctuation">]</span># docker exec <span class="token operator">-</span>it redis6379 redis<span class="token operator">-</span>cli
<span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">6379</span><span class="token operator">&gt;</span> info replication
</code></pre> 
<pre><code class="prism language-go">\# Replication
role<span class="token punctuation">:</span>master
connected_slaves<span class="token punctuation">:</span><span class="token number">2</span>
slave0<span class="token punctuation">:</span>ip<span class="token operator">=</span><span class="token number">172.17</span><span class="token number">.0</span><span class="token number">.3</span><span class="token punctuation">,</span>port<span class="token operator">=</span><span class="token number">6379</span><span class="token punctuation">,</span>state<span class="token operator">=</span>online<span class="token punctuation">,</span>offset<span class="token operator">=</span><span class="token number">2004</span><span class="token punctuation">,</span>lag<span class="token operator">=</span><span class="token number">1</span>
slave1<span class="token punctuation">:</span>ip<span class="token operator">=</span><span class="token number">172.17</span><span class="token number">.0</span><span class="token number">.4</span><span class="token punctuation">,</span>port<span class="token operator">=</span><span class="token number">6379</span><span class="token punctuation">,</span>state<span class="token operator">=</span>online<span class="token punctuation">,</span>offset<span class="token operator">=</span><span class="token number">2004</span><span class="token punctuation">,</span>lag<span class="token operator">=</span><span class="token number">1</span>
master_failover_state<span class="token punctuation">:</span>no<span class="token operator">-</span>failover
master_replid<span class="token punctuation">:</span>5baf174fd40e97663998abf5d8e89a51f7458488
master_replid2<span class="token punctuation">:</span><span class="token number">0000000000000000000000000000000000000000</span>
master_repl_offset<span class="token punctuation">:</span><span class="token number">2004</span>
second_repl_offset<span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span>
repl_backlog_active<span class="token punctuation">:</span><span class="token number">1</span>
repl_backlog_size<span class="token punctuation">:</span><span class="token number">1048576</span>
repl_backlog_first_byte_offset<span class="token punctuation">:</span><span class="token number">1</span>
repl_backlog_histlen<span class="token punctuation">:</span><span class="token number">2004</span>
</code></pre> 
<p>第七步：登录redis6379测试，master读写都可以。</p> 
<pre><code class="prism language-go"><span class="token punctuation">[</span>root@centos7964 ~<span class="token punctuation">]</span># docker exec <span class="token operator">-</span>it redis6379 redis<span class="token operator">-</span>cli
<span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">6379</span><span class="token operator">&gt;</span> set role master6379
OK
<span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">6379</span><span class="token operator">&gt;</span> get role
<span class="token string">"master6379"</span>
</code></pre> 
<p>第八步：登录redis6380测试，slave只能读。</p> 
<pre><code class="prism language-go"><span class="token punctuation">[</span>root@centos7964 ~<span class="token punctuation">]</span># docker exec <span class="token operator">-</span>it redis6380 redis<span class="token operator">-</span>cli
<span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">6379</span><span class="token operator">&gt;</span> get role
<span class="token string">"master6379"</span>
<span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">6379</span><span class="token operator">&gt;</span> set role slave6380
<span class="token punctuation">(</span><span class="token builtin">error</span><span class="token punctuation">)</span> READONLY You can't write against a read only replica<span class="token punctuation">.</span>
<span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">6379</span><span class="token operator">&gt;</span>
</code></pre> 
<p>Java中的读写测试分析，代码如下：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MasterSlaveTests</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">testMasterReadWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token comment">//配置文件端口为6379</span>
        <span class="token class-name">ValueOperations</span> valueOperations <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        valueOperations<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"role"</span><span class="token punctuation">,</span> <span class="token string">"master6379"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> role <span class="token operator">=</span> valueOperations<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"role"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>role<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">testSlaveRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token comment">//配置文件端口为6380</span>
        <span class="token class-name">ValueOperations</span> valueOperations <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> role <span class="token operator">=</span> valueOperations<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"role"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>role<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h3><a id="14__144"></a>1.4 主从同步原理分析</h3> 
<p>Redis的主从结构可以采用一主多从结构，Redis主从复制可以根据是否是全量分为全量同步和增量同步。</p> 
<h4><a id="141_Redis_147"></a>1.4.1 Redis全量同步：</h4> 
<p>Redis全量复制一般发生在Slave初始化阶段，这时Slave需要将Master上的所有数据都复制一份。具体步骤如下：<br> 1）从服务器连接主服务器，发送SYNC命令；<br> 2）主服务器接收到SYNC命令后，开始执行BGSAVE命令生成RDB文件并使用缓冲区记录此后执行的所有写命令；<br> 3）主服务器BGSAVE执行完后，向所有从服务器发送快照文件，并在发送期间继续记录被执行的写命令；<br> 4）从服务器收到快照文件后丢弃所有旧数据，载入收到的快照；<br> 5）主服务器快照发送完毕后开始向从服务器发送缓冲区中的写命令；<br> 6）从服务器完成对快照的载入，开始接收命令请求，并执行来自主服务器缓冲区的写命令；</p> 
<h4><a id="142_Redis_156"></a>1.4.2 Redis增量同步</h4> 
<p>Redis增量复制是指Slave初始化后，开始正常工作时主服务器发生的写操作同步到从服务器的过程。 增量复制的过程主要是主服务器每执行一个写命令就会向从服务器发送相同的写命令，从服务器接收并执行收到的写命令。</p> 
<h3><a id="_159"></a>小结分析</h3> 
<ul><li> <p>如果redis要支持10万+的的并发你会怎么做？<br> 单机的redis几乎不太可能说QPS超过10万+，除非一些特殊情况，比如你的机器性能特别好，配置特别高，物理机，维护做的特别好，而且你的整体的操作不是太复杂，一般的单机也就在几万。真正实现redis的高并发，需要读写分离。对缓存而言，一般都是用来支撑读高并发的，写的请求是比较少的，可能写请求也就一秒钟几千。读的请求相对就会比较多,例如,一秒钟二十万次读。所以redis的高并发可以基于主从架构与读写分离机制进行实现。</p> </li><li> <p>Redis的replication机制是怎样的？<br> （1）redis采用异步方式复制数据到slave节点。<br> （2）一个master node是可以配置多个slave node的。<br> （3）slave node也可以连接其他的slave node。<br> （4）slave node做复制的时候，是不会block master node的正常工作的。<br> （5）slave node在做复制的时候，也不会block对自己的查询操作，它会用旧的数据集来提供服务; 但是复制完成的时候，需要删除旧数据集，加载新数据集，这个时候就会暂停对外服务了。<br> （6）slave node主要用来进行横向扩容，做读写分离，扩容的slave node可以提高读的吞吐量。</p> </li></ul> 
<h2><a id="2_Redis_171"></a>2. Redis哨兵模式</h2> 
<h3><a id="21__172"></a>2.1 概述</h3> 
<p>哨兵（Sentinel）是Redis的主从架构模式下，实现高可用性（high availability）的一种机制。<br> 由一个或多个Sentinel实例（instance）组成的Sentinel系统（system）可以监视任意多个主服务器，以及这些主服务器属下的所有从服务器，并在被监视的主服务器进入下线状态时，自动将下线主服务器属下的某个从服务器升级为新的主服务器，然后由新的主服务器代替已下线的主服务器继续处理命令请求。</p> 
<h3><a id="22__176"></a>2.2 架构</h3> 
<p><img src="https://images2.imgbox.com/0f/4b/wkPkZ0D8_o.png" alt=""></p> 
<h3><a id="23__178"></a>2.3 哨兵快速入门</h3> 
<p>第一步：分别进入3台redis容器内部进行配置，在容器指定目录/etc/redis创建sentinel.conf文件,文件内容为：</p> 
<pre><code class="prism language-go">sentinel monitor redis6379 <span class="token number">172.17</span><span class="token number">.0</span><span class="token number">.2</span> <span class="token number">6379</span> <span class="token number">1</span>
</code></pre> 
<p>其中, 如上指令表示要的监控的master, redis6379为服务名, 172.17.0.2和6379为master的ip和端口,1表示多少个sentinel认为一个master失效时，master才算真正失效。</p> 
<p>假如，这里如果出现 bash: vi: command not found，可依次执行如下两个指令：</p> 
<pre><code class="prism language-go"><span class="token number">1</span>、apt<span class="token operator">-</span>get update 
<span class="token number">2</span>、apt<span class="token operator">-</span>get install vim
</code></pre> 
<p>第二步：在每个redis容器内部的/etc/redis目录下执行如下指令（最好是在多个客户端窗口执行），启动哨兵服务</p> 
<pre><code class="prism language-go">redis<span class="token operator">-</span>sentinel sentinel<span class="token punctuation">.</span>conf
</code></pre> 
<p>第三步：打开一个新的客户端连接窗口，关闭redis6379服务（这个服务是master服务）</p> 
<pre><code class="prism language-go">docker stop redis6379
</code></pre> 
<p>第四步：登陆ip为172.17.0.4对应的服务进行info检测，例如：</p> 
<pre><code class="prism language-go"><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">6379</span><span class="token operator">&gt;</span> info replication
</code></pre> 
<pre><code class="prism language-go">\# Replication
role<span class="token punctuation">:</span>master
connected_slaves<span class="token punctuation">:</span><span class="token number">1</span>
slave0<span class="token punctuation">:</span>ip<span class="token operator">=</span><span class="token number">172.17</span><span class="token number">.0</span><span class="token number">.3</span><span class="token punctuation">,</span>port<span class="token operator">=</span><span class="token number">6379</span><span class="token punctuation">,</span>state<span class="token operator">=</span>online<span class="token punctuation">,</span>offset<span class="token operator">=</span><span class="token number">222807</span><span class="token punctuation">,</span>lag<span class="token operator">=</span><span class="token number">0</span>
master_failover_state<span class="token punctuation">:</span>no<span class="token operator">-</span>failover
master_replid<span class="token punctuation">:</span>3d63e8474dd7bcb282ff38027d4a78c413cede53
master_replid2<span class="token punctuation">:</span>5baf174fd40e97663998abf5d8e89a51f7458488
master_repl_offset<span class="token punctuation">:</span><span class="token number">222807</span>
second_repl_offset<span class="token punctuation">:</span><span class="token number">110197</span>
repl_backlog_active<span class="token punctuation">:</span><span class="token number">1</span>
repl_backlog_size<span class="token punctuation">:</span><span class="token number">1048576</span>
repl_backlog_first_byte_offset<span class="token punctuation">:</span><span class="token number">29</span>
repl_backlog_histlen<span class="token punctuation">:</span><span class="token number">222779</span>
<span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">6379</span><span class="token operator">&gt;</span>
</code></pre> 
<p>从上面的信息输出发现,redis6381服务现在已经变为master。</p> 
<h3><a id="24_sentinel__221"></a>2.4 sentinel 进阶配置</h3> 
<p>对于sentinel.conf文件中的内容,我们还可以基于实际需求,进行增强配置,例如:</p> 
<pre><code class="prism language-go">sentinel monitor redis6379 <span class="token number">172.17</span><span class="token number">.0</span><span class="token number">.2</span> <span class="token number">6379</span> <span class="token number">1</span> 
daemonize yes #后台运行
logfile <span class="token string">"/var/log/sentinel_log.log"</span> #运行日志
sentinel down<span class="token operator">-</span>after<span class="token operator">-</span>milliseconds redis6379 <span class="token number">30000</span> #默认<span class="token number">30</span>秒

</code></pre> 
<p>其中:<br> 1)daemonize yes表示后台运行(默认为no)<br> 2)logfile 用于指定日志文件位置以及名字<br> 3)sentinel down-after-milliseconds 表示master失效了多长时间才认为失效</p> 
<h3><a id="25__236"></a>2.5 哨兵工作原理分析</h3> 
<p>1)：每个Sentinel以每秒钟一次的频率向它所知的Master，Slave以及其他 Sentinel 实例发送一个 PING 命令。<br> 2)：如果一个实例（instance）距离最后一次有效回复 PING 命令的时间超过 down-after-milliseconds 选项所指定的值(这个配置项指定了需要多少失效时间，一个master才会被这个sentinel主观地认为是不可用的。 单位是毫秒，默认为30秒)， 则这个实例会被 Sentinel 标记为主观下线。<br> 3)：如果一个Master被标记为主观下线，则正在监视这个Master的所有 Sentinel 要以每秒一次的频率确认Master的确进入了主观下线状态。<br> 4)：当有足够数量的 Sentinel（大于等于配置文件指定的值）在指定的时间范围内确认Master的确进入了主观下线状态， 则Master会被标记为客观下线 。<br> 5)：在一般情况下， 每个 Sentinel 会以每 10 秒一次的频率向它已知的所有Master，Slave发送 INFO 命令 。<br> 6)：当Master被 Sentinel 标记为客观下线时，Sentinel 向下线的 Master 的所有 Slave 发送 INFO 命令的频率会从 10 秒一次改为每秒一次<br> 7)：若没有足够数量的 Sentinel 同意 Master 已经下线， Master 的客观下线状态就会被移除。<br> 8): 若 Master 重新向 Sentinel 的 PING 命令返回有效回复， Master 的主观下线状态就会被移除。</p> 
<h2><a id="3_Redis_246"></a>3. Redis集群高可用</h2> 
<h3><a id="31__247"></a>3.1 概述</h3> 
<p>Redis单机模式可靠性保证不是很好，容易出现单点故障，同时其性能也受限于CPU的处理能力，实际开发中Redis必然是高可用的，所以单机模式并不是我们的终点，我们需要对目前redis的架构模式进行升级。<br> Sentinel模式做到了高可用，但是实质还是只有一个master在提供服务(读写分离的情况本质也是master在提供服务)，当master节点所在的机器内存不足以支撑系统的数据时，就需要考虑集群了。<br> Redis集群架构实现了对redis的水平扩容，即启动N个redis节点，将整个数据分布存储在这N个redis节点中，每个节点存储总数据的1/N。redis集群通过分区提供一定程度的可用性，即使集群中有一部分节点失效或无法进行通讯，集群也可以继续处理命令请求。</p> 
<h3><a id="32__252"></a>3.2 基本架构</h3> 
<p>对于redis集群(Cluster),一般最少设置为6个节点,3个master,3个slave,其简易架构如下:<br> <img src="https://images2.imgbox.com/99/be/hqV1ysmo_o.png" alt=""></p> 
<h3><a id="33_redis_255"></a>3.3 搭建redis集群</h3> 
<p>第一步：准备网络环境<br> 创建虚拟网卡，主要是用于redis-cluster能于外界进行网络通信，一般常用桥接模式。</p> 
<pre><code class="prism language-go">docker network create redis<span class="token operator">-</span>net
</code></pre> 
<p>查看docker的网卡信息，可使用如下指令</p> 
<pre><code class="prism language-go">docker network ls
</code></pre> 
<p>查看docker网络详细信息，可使用命令`</p> 
<pre><code class="prism language-go">docker network inspect redis<span class="token operator">-</span>net
</code></pre> 
<p>第二步：准备redis配置模板</p> 
<pre><code class="prism language-go">mkdir <span class="token operator">-</span>p <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>docker<span class="token operator">/</span>redis<span class="token operator">-</span>cluster
</code></pre> 
<pre><code class="prism language-go">cd <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>docker<span class="token operator">/</span>redis<span class="token operator">-</span>cluster
</code></pre> 
<pre><code class="prism language-go">vim redis<span class="token operator">-</span>cluster<span class="token punctuation">.</span>tmpl
</code></pre> 
<p>在redis-cluster.tmpl中输入以下内容</p> 
<pre><code class="prism language-go">port $<span class="token punctuation">{<!-- --></span>PORT<span class="token punctuation">}</span>
cluster<span class="token operator">-</span>enabled yes
cluster<span class="token operator">-</span>config<span class="token operator">-</span>file nodes<span class="token punctuation">.</span>conf
cluster<span class="token operator">-</span>node<span class="token operator">-</span>timeout <span class="token number">5000</span>
cluster<span class="token operator">-</span>announce<span class="token operator">-</span>ip <span class="token number">192.168</span><span class="token number">.227</span><span class="token number">.131</span>
cluster<span class="token operator">-</span>announce<span class="token operator">-</span>port $<span class="token punctuation">{<!-- --></span>PORT<span class="token punctuation">}</span>
cluster<span class="token operator">-</span>announce<span class="token operator">-</span>bus<span class="token operator">-</span>port <span class="token number">1</span>$<span class="token punctuation">{<!-- --></span>PORT<span class="token punctuation">}</span>
appendonly yes
</code></pre> 
<p>其中：</p> 
<p>各节点解释如下所示：</p> 
<p>port：节点端口，即对外提供通信的端口<br> cluster-enabled：是否启用集群<br> cluster-config-file：集群配置文件<br> cluster-node-timeout：连接超时时间<br> cluster-announce-ip：宿主机ip<br> cluster-announce-port：集群节点映射端口<br> cluster-announce-bus-port：集群总线端口<br> appendonly：持久化模式</p> 
<p>第三步：创建节点配置文件<br> 在redis-cluser中执行以下命令</p> 
<pre><code class="prism language-go"><span class="token keyword">for</span> port in $<span class="token punctuation">(</span>seq <span class="token number">8010</span> <span class="token number">8015</span><span class="token punctuation">)</span><span class="token punctuation">;</span> \
do \
  mkdir <span class="token operator">-</span>p <span class="token punctuation">.</span><span class="token operator">/</span>$<span class="token punctuation">{<!-- --></span>port<span class="token punctuation">}</span><span class="token operator">/</span>conf  \
  <span class="token operator">&amp;&amp;</span> PORT<span class="token operator">=</span>$<span class="token punctuation">{<!-- --></span>port<span class="token punctuation">}</span> envsubst <span class="token operator">&lt;</span> <span class="token punctuation">.</span><span class="token operator">/</span>redis<span class="token operator">-</span>cluster<span class="token punctuation">.</span>tmpl <span class="token operator">&gt;</span> <span class="token punctuation">.</span><span class="token operator">/</span>$<span class="token punctuation">{<!-- --></span>port<span class="token punctuation">}</span><span class="token operator">/</span>conf<span class="token operator">/</span>redis<span class="token punctuation">.</span>conf \
  <span class="token operator">&amp;&amp;</span> mkdir <span class="token operator">-</span>p <span class="token punctuation">.</span><span class="token operator">/</span>$<span class="token punctuation">{<!-- --></span>port<span class="token punctuation">}</span><span class="token operator">/</span>data<span class="token punctuation">;</span> \
done
</code></pre> 
<p>其中：</p> 
<p>for 变量 in $(seq var1 var2);do …; done为linux中的一种shell 循环脚本, 例如：</p> 
<pre><code class="prism language-go"><span class="token punctuation">[</span>root@centos7964 ~<span class="token punctuation">]</span># <span class="token keyword">for</span> i in $<span class="token punctuation">(</span>seq <span class="token number">1</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&gt;</span> do echo $i<span class="token punctuation">;</span>
<span class="token operator">&gt;</span> done<span class="token punctuation">;</span>
<span class="token number">1</span>
<span class="token number">2</span>
<span class="token number">3</span>
<span class="token number">4</span>
<span class="token number">5</span>
<span class="token punctuation">[</span>root@centos7964 ~<span class="token punctuation">]</span>#

</code></pre> 
<p>指令envsubst &lt;源文件&gt;目标文件,用于将源文件内容更新到目标文件中。<br> 通过cat指令查看配置文件内容</p> 
<pre><code class="prism language-go">cat <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>docker<span class="token operator">/</span>redis<span class="token operator">-</span>cluster<span class="token operator">/</span><span class="token number">801</span><span class="token punctuation">{<!-- --></span><span class="token number">0.</span><span class="token number">.5</span><span class="token punctuation">}</span><span class="token operator">/</span>conf<span class="token operator">/</span>redis<span class="token punctuation">.</span>conf
</code></pre> 
<p>第四步：创建集群中的redis节点容器</p> 
<pre><code class="prism language-go"><span class="token keyword">for</span> port in $<span class="token punctuation">(</span>seq <span class="token number">8010</span> <span class="token number">8015</span><span class="token punctuation">)</span><span class="token punctuation">;</span> \
do \
   docker run <span class="token operator">-</span>it <span class="token operator">-</span>d <span class="token operator">-</span>p $<span class="token punctuation">{<!-- --></span>port<span class="token punctuation">}</span><span class="token punctuation">:</span>$<span class="token punctuation">{<!-- --></span>port<span class="token punctuation">}</span> <span class="token operator">-</span>p <span class="token number">1</span>$<span class="token punctuation">{<!-- --></span>port<span class="token punctuation">}</span><span class="token punctuation">:</span><span class="token number">1</span>$<span class="token punctuation">{<!-- --></span>port<span class="token punctuation">}</span> \
  <span class="token operator">--</span>privileged<span class="token operator">=</span><span class="token boolean">true</span> <span class="token operator">-</span>v <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>docker<span class="token operator">/</span>redis<span class="token operator">-</span>cluster<span class="token operator">/</span>$<span class="token punctuation">{<!-- --></span>port<span class="token punctuation">}</span><span class="token operator">/</span>conf<span class="token operator">/</span>redis<span class="token punctuation">.</span>conf<span class="token punctuation">:</span><span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>etc<span class="token operator">/</span>redis<span class="token operator">/</span>redis<span class="token punctuation">.</span>conf \
  <span class="token operator">--</span>privileged<span class="token operator">=</span><span class="token boolean">true</span> <span class="token operator">-</span>v <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>docker<span class="token operator">/</span>redis<span class="token operator">-</span>cluster<span class="token operator">/</span>$<span class="token punctuation">{<!-- --></span>port<span class="token punctuation">}</span><span class="token operator">/</span>data<span class="token punctuation">:</span><span class="token operator">/</span>data \
  <span class="token operator">--</span>restart always <span class="token operator">--</span>name redis<span class="token operator">-</span>$<span class="token punctuation">{<!-- --></span>port<span class="token punctuation">}</span> <span class="token operator">--</span>net redis<span class="token operator">-</span>net \
  <span class="token operator">--</span>sysctl net<span class="token punctuation">.</span>core<span class="token punctuation">.</span>somaxconn<span class="token operator">=</span><span class="token number">1024</span> redis redis<span class="token operator">-</span>server <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>etc<span class="token operator">/</span>redis<span class="token operator">/</span>redis<span class="token punctuation">.</span>conf<span class="token punctuation">;</span> \
done

</code></pre> 
<p>其中, --privileged=true表示让启动的容器用户具备真正root权限, --sysctl net.core.somaxconn=1024 这是一个linux的内核参数,用于设置请求队列大小,默认为128,后续启动redis的启动指令需要先放到这个请求队列中,然后依次启动.<br> 创建成功以后，通过docker ps指令查看节点内容。</p> 
<p>第五步：创建redis-cluster集群配置</p> 
<pre><code class="prism language-go">docker exec <span class="token operator">-</span>it redis<span class="token operator">-</span><span class="token number">8010</span> bash
</code></pre> 
<pre><code class="prism language-go">redis<span class="token operator">-</span>cli <span class="token operator">--</span>cluster create <span class="token number">192.168</span><span class="token number">.227</span><span class="token number">.131</span><span class="token punctuation">:</span><span class="token number">8010</span> <span class="token number">192.168</span><span class="token number">.227</span><span class="token number">.131</span><span class="token punctuation">:</span><span class="token number">8011</span> <span class="token number">192.168</span><span class="token number">.227</span><span class="token number">.131</span><span class="token punctuation">:</span><span class="token number">8012</span> <span class="token number">192.168</span><span class="token number">.227</span><span class="token number">.131</span><span class="token punctuation">:</span><span class="token number">8013</span> <span class="token number">192.168</span><span class="token number">.227</span><span class="token number">.131</span><span class="token punctuation">:</span><span class="token number">8014</span> <span class="token number">192.168</span><span class="token number">.227</span><span class="token number">.131</span><span class="token punctuation">:</span><span class="token number">8015</span> <span class="token operator">--</span>cluster<span class="token operator">-</span>replicas <span class="token number">1</span>
</code></pre> 
<p>如上指令要尽量放在一行执行，其中最后的1表示主从比例，当出现选择提示信息时，输入yes即可。<br> 第六步：连接redis-cluster，并添加数据到redis</p> 
<pre><code class="prism language-go">redis<span class="token operator">-</span>cli <span class="token operator">-</span>c <span class="token operator">-</span>h <span class="token number">192.168</span><span class="token number">.227</span><span class="token number">.131</span> <span class="token operator">-</span>p <span class="token number">8010</span>
</code></pre> 
<p>其它：<br> 在搭建过程，可能在出现问题后，需要停止或直接删除docker容器，可以使用以下参考命令<br> 批量停止docker 容器：</p> 
<pre><code class="prism language-go">docker ps <span class="token operator">-</span>a <span class="token operator">|</span> grep <span class="token operator">-</span>i <span class="token string">"redis-801*"</span> <span class="token operator">|</span> awk <span class="token char">'{print $1}'</span> <span class="token operator">|</span> xargs docker stop
</code></pre> 
<p>批量删除docker 容器：</p> 
<pre><code class="prism language-go">docker ps <span class="token operator">-</span>a <span class="token operator">|</span> grep <span class="token operator">-</span>i <span class="token string">"redis-801*"</span> <span class="token operator">|</span> awk <span class="token char">'{print $1}'</span> <span class="token operator">|</span> xargs docker rm <span class="token operator">-</span>f
</code></pre> 
<p>批量删除文件</p> 
<pre><code class="prism language-go">rm <span class="token operator">-</span>rf <span class="token number">801</span><span class="token punctuation">{<!-- --></span><span class="token number">0.</span><span class="token number">.5</span><span class="token punctuation">}</span><span class="token operator">/</span>conf<span class="token operator">/</span>redis<span class="token punctuation">.</span>conf
</code></pre> 
<h3><a id="34_Jedis_385"></a>3.4 Jedis读写数据测试</h3> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testJedisCluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{<!-- --></span>
      <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HostAndPort</span><span class="token punctuation">&gt;</span></span> nodes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      nodes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HostAndPort</span><span class="token punctuation">(</span><span class="token string">"192.168.227.131"</span><span class="token punctuation">,</span><span class="token number">8010</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      nodes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HostAndPort</span><span class="token punctuation">(</span><span class="token string">"192.168.227.131"</span><span class="token punctuation">,</span><span class="token number">8011</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      nodes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HostAndPort</span><span class="token punctuation">(</span><span class="token string">"192.168.227.131"</span><span class="token punctuation">,</span><span class="token number">8012</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      nodes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HostAndPort</span><span class="token punctuation">(</span><span class="token string">"192.168.227.131"</span><span class="token punctuation">,</span><span class="token number">8013</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      nodes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HostAndPort</span><span class="token punctuation">(</span><span class="token string">"192.168.227.131"</span><span class="token punctuation">,</span><span class="token number">8014</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      nodes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HostAndPort</span><span class="token punctuation">(</span><span class="token string">"192.168.227.131"</span><span class="token punctuation">,</span><span class="token number">8015</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">JedisCluster</span> jedisCluster <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JedisCluster</span><span class="token punctuation">(</span>nodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//使用jedisCluster操作redis</span>
      jedisCluster<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">,</span> <span class="token string">"cluster"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">String</span> str <span class="token operator">=</span> jedisCluster<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//关闭连接池</span>
      jedisCluster<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

</code></pre> 
<h3><a id="35_RedisTemplate_407"></a>3.5 RedisTemplate读写数据测试</h3> 
<p>第一步：配置application.yml,例如：</p> 
<pre><code class="prism language-java">spring<span class="token operator">:</span>
  redis<span class="token operator">:</span>
    cluster<span class="token operator">:</span> #redis 集群配置
      nodes<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.126</span><span class="token number">.128</span><span class="token operator">:</span><span class="token number">8010</span><span class="token punctuation">,</span><span class="token number">192.168</span><span class="token number">.126</span><span class="token number">.128</span><span class="token operator">:</span><span class="token number">8011</span><span class="token punctuation">,</span><span class="token number">192.168</span><span class="token number">.126</span><span class="token number">.128</span><span class="token operator">:</span><span class="token number">8012</span><span class="token punctuation">,</span><span class="token number">192.168</span><span class="token number">.126</span><span class="token number">.128</span><span class="token operator">:</span><span class="token number">8013</span><span class="token punctuation">,</span><span class="token number">192.168</span><span class="token number">.126</span><span class="token number">.128</span><span class="token operator">:</span><span class="token number">8014</span><span class="token punctuation">,</span><span class="token number">192.168</span><span class="token number">.126</span><span class="token number">.128</span><span class="token operator">:</span><span class="token number">8015</span>
      max<span class="token operator">-</span>redirects<span class="token operator">:</span> <span class="token number">3</span> #最大跳转次数
    timeout<span class="token operator">:</span> <span class="token number">5000</span> #超时时间
    database<span class="token operator">:</span> <span class="token number">0</span>
    jedis<span class="token operator">:</span> #连接池
      pool<span class="token operator">:</span>
        max<span class="token operator">-</span>idle<span class="token operator">:</span> <span class="token number">8</span>
        max<span class="token operator">-</span>wait<span class="token operator">:</span> <span class="token number">0</span>
</code></pre> 
<p>第二步：编写单元测试类，代码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>cy<span class="token punctuation">.</span>redis</span><span class="token punctuation">;</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisClusterTests</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">testMasterReadWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">//1.获取数据操作对象</span>
        <span class="token class-name">ValueOperations</span> valueOperations <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2.读写数据</span>
        valueOperations<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"city"</span><span class="token punctuation">,</span><span class="token string">"beijing"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> city<span class="token operator">=</span>valueOperations<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"city"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>city<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h3><a id="_442"></a>小结分析</h3> 
<p>Redis的高并发跟整个系统的高并发是什么关系？<br> 第一:Redis你要搞高并发的话，不可避免，要把底层的缓存搞得很好。例如，mysql的高并发，是通过一系列复杂的分库分表，订单系统，事务要求的，QPS到几万，比较高了。<br> 第二：要做一些电商的商品详情页，真正的超高并发，QPS上十万，甚至是百万，一秒钟百万的请求量，只有redis是不够的，但是redis是整个大型的缓存架构中，支撑高并发的架构里面，非常重要的一个环节。<br> 第三：你的底层的缓存中间件，缓存系统，必须能够支撑的起我们说的那种高并发，其次，再经过良好的整体的缓存架构的设计（多级缓存架构、热点缓存），支撑真正的上十万，甚至上百万的高并发。</p> 
<p>上面从redis高性能，高可靠性的角度对redis的主从架构，读写分离、哨兵机制、集群方式做了分析实践。这部分内容也是中大型项目中redis常用的一些架构设计方式。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ea46a9915374be89e79baca34200681b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">如何解决c&#43;&#43;中[Error] no matching function for call to &#39;std::basic_ifstream&lt;char&gt;::basic_ifstream(std::str...</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/dc96a298fca51baba054d1c8e55dc998/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">2023软考纸质证书领取通知来了！</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>