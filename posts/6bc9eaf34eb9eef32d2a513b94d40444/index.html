<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Exception in thread “main“ java.lang.UnsatisfiedLinkError: org.apache.hadoop.io.nativeio.NativeIO$ - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Exception in thread “main“ java.lang.UnsatisfiedLinkError: org.apache.hadoop.io.nativeio.NativeIO$" />
<meta property="og:description" content="在windows 环境下运行Hadoop例子，不打jar包，报错
Exception in thread “main” java.lang.UnsatisfiedLinkError: org.apache.hadoop.io.nativeio.NativeIO$Windows.access0
报错原因：本地的hadoop版本与lib文件中替换的编译hadoop.dll版本不对应。
先安装好Hadoop，并配置好环境变量。
解决办法有两个：
方法一：（推荐使用）
下载winutils，解压对应的hadoop版本，将bin目录下的hadoop.dll系统文件拷贝到C盘的C:\Windows\System32目录下
下载地址：https://github.com/kontext-tech/winutils
方法二：
1、在项目中创建一个包名为org.apache.hadoop.io.nativeio的包
2.在这个包下创建一个名为NativeIO.java的类
3.加入以下代码
/** * Licensed to the Apache Software Foundation (ASF) under one * or more contributor license agreements. See the NOTICE file * distributed with this work for additional information * regarding copyright ownership. The ASF licenses this file * to you under the Apache License, Version 2.0 (the * &#34;License&#34;); you may not use this file except in compliance * with the License." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/6bc9eaf34eb9eef32d2a513b94d40444/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-15T17:24:48+08:00" />
<meta property="article:modified_time" content="2023-03-15T17:24:48+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Exception in thread “main“ java.lang.UnsatisfiedLinkError: org.apache.hadoop.io.nativeio.NativeIO$</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>在windows 环境下运行Hadoop例子，不打jar包，报错<br> Exception in thread “main” java.lang.UnsatisfiedLinkError: org.apache.hadoop.io.nativeio.NativeIO$Windows.access0<br> <img src="https://images2.imgbox.com/e6/b2/geL25V5B_o.png" alt="在这里插入图片描述"><br> 报错原因：本地的hadoop版本与lib文件中替换的编译hadoop.dll版本不对应。</p> 
<p>先安装好Hadoop，并配置好环境变量。<br> 解决办法有两个：</p> 
<p>方法一：（推荐使用）<br> 下载winutils，解压对应的hadoop版本，将bin目录下的hadoop.dll系统文件拷贝到C盘的C:\Windows\System32目录下<br> 下载地址：https://github.com/kontext-tech/winutils</p> 
<p>方法二：<br> 1、在项目中创建一个包名为org.apache.hadoop.io.nativeio的包<br> 2.在这个包下创建一个名为NativeIO.java的类<br> 3.加入以下代码</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>
<span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>io<span class="token punctuation">.</span>nativeio</span><span class="token punctuation">;</span>
 
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">File</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileDescriptor</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileInputStream</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileOutputStream</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">RandomAccessFile</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Field</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span></span><span class="token class-name">ByteBuffer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span></span><span class="token class-name">MappedByteBuffer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>channels<span class="token punctuation">.</span></span><span class="token class-name">FileChannel</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ConcurrentHashMap</span><span class="token punctuation">;</span>
 
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>classification<span class="token punctuation">.</span></span><span class="token class-name">InterfaceAudience</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>classification<span class="token punctuation">.</span></span><span class="token class-name">InterfaceStability</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>conf<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>fs<span class="token punctuation">.</span></span><span class="token class-name">CommonConfigurationKeys</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>fs<span class="token punctuation">.</span></span><span class="token class-name">HardLink</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOUtils</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">SecureIOUtils<span class="token punctuation">.</span>AlreadyExistsException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">NativeCodeLoader</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Shell</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">PerformanceAdvisory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>logging<span class="token punctuation">.</span></span><span class="token class-name">Log</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>logging<span class="token punctuation">.</span></span><span class="token class-name">LogFactory</span><span class="token punctuation">;</span>
 
<span class="token keyword">import</span> <span class="token namespace">sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span></span><span class="token class-name">Unsafe</span><span class="token punctuation">;</span>
 
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">VisibleForTesting</span><span class="token punctuation">;</span>
 
<span class="token comment">/**
 * JNI wrappers for various native IO-related calls not available in Java. These
 * functions should generally be used alongside a fallback to another more
 * portable mechanism.
 */</span>
<span class="token annotation punctuation">@InterfaceAudience.Private</span>
<span class="token annotation punctuation">@InterfaceStability.Unstable</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NativeIO</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> POSIX <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// Flags for open() call from bits/fcntl.h</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> O_RDONLY <span class="token operator">=</span> <span class="token number">00</span><span class="token punctuation">;</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> O_WRONLY <span class="token operator">=</span> <span class="token number">01</span><span class="token punctuation">;</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> O_RDWR <span class="token operator">=</span> <span class="token number">02</span><span class="token punctuation">;</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> O_CREAT <span class="token operator">=</span> <span class="token number">0100</span><span class="token punctuation">;</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> O_EXCL <span class="token operator">=</span> <span class="token number">0200</span><span class="token punctuation">;</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> O_NOCTTY <span class="token operator">=</span> <span class="token number">0400</span><span class="token punctuation">;</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> O_TRUNC <span class="token operator">=</span> <span class="token number">01000</span><span class="token punctuation">;</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> O_APPEND <span class="token operator">=</span> <span class="token number">02000</span><span class="token punctuation">;</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> O_NONBLOCK <span class="token operator">=</span> <span class="token number">04000</span><span class="token punctuation">;</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> O_SYNC <span class="token operator">=</span> <span class="token number">010000</span><span class="token punctuation">;</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> O_ASYNC <span class="token operator">=</span> <span class="token number">020000</span><span class="token punctuation">;</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> O_FSYNC <span class="token operator">=</span> O_SYNC<span class="token punctuation">;</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> O_NDELAY <span class="token operator">=</span> O_NONBLOCK<span class="token punctuation">;</span>
 
		<span class="token comment">// Flags for posix_fadvise() from bits/fcntl.h</span>
		<span class="token comment">/* No further special treatment. */</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> POSIX_FADV_NORMAL <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token comment">/* Expect random page references. */</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> POSIX_FADV_RANDOM <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token comment">/* Expect sequential page references. */</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> POSIX_FADV_SEQUENTIAL <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
		<span class="token comment">/* Will need these pages. */</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> POSIX_FADV_WILLNEED <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
		<span class="token comment">/* Don't need these pages. */</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> POSIX_FADV_DONTNEED <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
		<span class="token comment">/* Data will be accessed once. */</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> POSIX_FADV_NOREUSE <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
 
		<span class="token comment">/*
		 * Wait upon writeout of all pages in the range before performing the write.
		 */</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SYNC_FILE_RANGE_WAIT_BEFORE <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token comment">/*
		 * Initiate writeout of all those dirty pages in the range which are not
		 * presently under writeback.
		 */</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SYNC_FILE_RANGE_WRITE <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
 
		<span class="token comment">/*
		 * Wait upon writeout of all pages in the range after performing the write.
		 */</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SYNC_FILE_RANGE_WAIT_AFTER <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
 
		<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Log</span> LOG <span class="token operator">=</span> <span class="token class-name">LogFactory</span><span class="token punctuation">.</span><span class="token function">getLog</span><span class="token punctuation">(</span><span class="token class-name">NativeIO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
		<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> nativeLoaded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> fadvisePossible <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> syncFileRangePossible <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
 
		<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> WORKAROUND_NON_THREADSAFE_CALLS_KEY <span class="token operator">=</span> <span class="token string">"hadoop.workaround.non.threadsafe.getpwuid"</span><span class="token punctuation">;</span>
		<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> WORKAROUND_NON_THREADSAFE_CALLS_DEFAULT <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
 
		<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">long</span> cacheTimeout <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
 
		<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">CacheManipulator</span> cacheManipulator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CacheManipulator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">CacheManipulator</span> <span class="token function">getCacheManipulator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> cacheManipulator<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
 
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setCacheManipulator</span><span class="token punctuation">(</span><span class="token class-name">CacheManipulator</span> cacheManipulator<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			POSIX<span class="token punctuation">.</span>cacheManipulator <span class="token operator">=</span> cacheManipulator<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
 
		<span class="token comment">/**
		 * Used to manipulate the operating system cache.
		 */</span>
		<span class="token annotation punctuation">@VisibleForTesting</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">CacheManipulator</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">mlock</span><span class="token punctuation">(</span><span class="token class-name">String</span> identifier<span class="token punctuation">,</span> <span class="token class-name">ByteBuffer</span> buffer<span class="token punctuation">,</span> <span class="token keyword">long</span> len<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
				POSIX<span class="token punctuation">.</span><span class="token function">mlock</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
 
			<span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getMemlockLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">return</span> <span class="token class-name">NativeIO</span><span class="token punctuation">.</span><span class="token function">getMemlockLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
 
			<span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getOperatingSystemPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">return</span> <span class="token class-name">NativeIO</span><span class="token punctuation">.</span><span class="token function">getOperatingSystemPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
 
			<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">posixFadviseIfPossible</span><span class="token punctuation">(</span><span class="token class-name">String</span> identifier<span class="token punctuation">,</span> <span class="token class-name">FileDescriptor</span> fd<span class="token punctuation">,</span> <span class="token keyword">long</span> offset<span class="token punctuation">,</span> <span class="token keyword">long</span> len<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
					<span class="token keyword">throws</span> <span class="token class-name">NativeIOException</span> <span class="token punctuation">{<!-- --></span>
				<span class="token class-name">NativeIO</span><span class="token punctuation">.</span>POSIX<span class="token punctuation">.</span><span class="token function">posixFadviseIfPossible</span><span class="token punctuation">(</span>identifier<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> len<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
 
			<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">verifyCanMlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">return</span> <span class="token class-name">NativeIO</span><span class="token punctuation">.</span><span class="token function">isAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
 
		<span class="token comment">/**
		 * A CacheManipulator used for testing which does not actually call mlock. This
		 * allows many tests to be run even when the operating system does not allow
		 * mlock, or only allows limited mlocking.
		 */</span>
		<span class="token annotation punctuation">@VisibleForTesting</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">NoMlockCacheManipulator</span> <span class="token keyword">extends</span> <span class="token class-name">CacheManipulator</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">mlock</span><span class="token punctuation">(</span><span class="token class-name">String</span> identifier<span class="token punctuation">,</span> <span class="token class-name">ByteBuffer</span> buffer<span class="token punctuation">,</span> <span class="token keyword">long</span> len<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
				LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"mlocking "</span> <span class="token operator">+</span> identifier<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
 
			<span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getMemlockLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">return</span> <span class="token number">1125899906842624L</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
 
			<span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getOperatingSystemPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">return</span> <span class="token number">4096</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
 
			<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">verifyCanMlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
 
		<span class="token keyword">static</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">NativeCodeLoader</span><span class="token punctuation">.</span><span class="token function">isNativeCodeLoaded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
					<span class="token class-name">Configuration</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					workaroundNonThreadSafePasswdCalls <span class="token operator">=</span> conf<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>WORKAROUND_NON_THREADSAFE_CALLS_KEY<span class="token punctuation">,</span>
							WORKAROUND_NON_THREADSAFE_CALLS_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
					<span class="token function">initNative</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					nativeLoaded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
 
					cacheTimeout <span class="token operator">=</span> conf<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token class-name">CommonConfigurationKeys</span><span class="token punctuation">.</span>HADOOP_SECURITY_UID_NAME_CACHE_TIMEOUT_KEY<span class="token punctuation">,</span>
							<span class="token class-name">CommonConfigurationKeys</span><span class="token punctuation">.</span>HADOOP_SECURITY_UID_NAME_CACHE_TIMEOUT_DEFAULT<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
					LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Initialized cache for IDs to User/Group mapping with a "</span> <span class="token operator">+</span> <span class="token string">" cache timeout of "</span>
							<span class="token operator">+</span> cacheTimeout <span class="token operator">/</span> <span class="token number">1000</span> <span class="token operator">+</span> <span class="token string">" seconds."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
				<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token comment">// This can happen if the user has an older version of libhadoop.so</span>
					<span class="token comment">// installed - in this case we can continue without native IO</span>
					<span class="token comment">// after warning</span>
					<span class="token class-name">PerformanceAdvisory</span><span class="token punctuation">.</span>LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Unable to initialize NativeIO libraries"</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
 
		<span class="token comment">/**
		 * Return true if the JNI-based native IO extensions are available.
		 */</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">isAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token class-name">NativeCodeLoader</span><span class="token punctuation">.</span><span class="token function">isNativeCodeLoaded</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> nativeLoaded<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
 
		<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">assertCodeLoaded</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"NativeIO was not loaded"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
 
		<span class="token comment">/** Wrapper around open(2) */</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token class-name">FileDescriptor</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>
 
		<span class="token comment">/** Wrapper around fstat(2) */</span>
		<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token class-name">Stat</span> <span class="token function">fstat</span><span class="token punctuation">(</span><span class="token class-name">FileDescriptor</span> fd<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>
 
		<span class="token comment">/** Native chmod implementation. On UNIX, it is a wrapper around chmod(2) */</span>
		<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">chmodImpl</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>
 
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">chmod</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Shell</span><span class="token punctuation">.</span>WINDOWS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">chmodImpl</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
					<span class="token function">chmodImpl</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NativeIOException</span> nioe<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>nioe<span class="token punctuation">.</span><span class="token function">getErrorCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
						<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NativeIOException</span><span class="token punctuation">(</span><span class="token string">"No such file or directory"</span><span class="token punctuation">,</span> <span class="token class-name">Errno</span><span class="token punctuation">.</span>ENOENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
						LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>
								<span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"NativeIO.chmod error (%d): %s"</span><span class="token punctuation">,</span> nioe<span class="token punctuation">.</span><span class="token function">getErrorCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nioe<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NativeIOException</span><span class="token punctuation">(</span><span class="token string">"Unknown error"</span><span class="token punctuation">,</span> <span class="token class-name">Errno</span><span class="token punctuation">.</span>UNKNOWN<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
 
		<span class="token comment">/** Wrapper around posix_fadvise(2) */</span>
		<span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">posix_fadvise</span><span class="token punctuation">(</span><span class="token class-name">FileDescriptor</span> fd<span class="token punctuation">,</span> <span class="token keyword">long</span> offset<span class="token punctuation">,</span> <span class="token keyword">long</span> len<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NativeIOException</span><span class="token punctuation">;</span>
 
		<span class="token comment">/** Wrapper around sync_file_range(2) */</span>
		<span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">sync_file_range</span><span class="token punctuation">(</span><span class="token class-name">FileDescriptor</span> fd<span class="token punctuation">,</span> <span class="token keyword">long</span> offset<span class="token punctuation">,</span> <span class="token keyword">long</span> nbytes<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
				<span class="token keyword">throws</span> <span class="token class-name">NativeIOException</span><span class="token punctuation">;</span>
 
		<span class="token comment">/**
		 * Call posix_fadvise on the given file descriptor. See the manpage for this
		 * syscall for more information. On systems where this call is not available,
		 * does nothing.
		 *
		 * @throws NativeIOException
		 *             if there is an error with the syscall
		 */</span>
		<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">posixFadviseIfPossible</span><span class="token punctuation">(</span><span class="token class-name">String</span> identifier<span class="token punctuation">,</span> <span class="token class-name">FileDescriptor</span> fd<span class="token punctuation">,</span> <span class="token keyword">long</span> offset<span class="token punctuation">,</span> <span class="token keyword">long</span> len<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
				<span class="token keyword">throws</span> <span class="token class-name">NativeIOException</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>nativeLoaded <span class="token operator">&amp;&amp;</span> fadvisePossible<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
					<span class="token function">posix_fadvise</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> len<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnsupportedOperationException</span> uoe<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					fadvisePossible <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnsatisfiedLinkError</span> ule<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					fadvisePossible <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
 
		<span class="token comment">/**
		 * Call sync_file_range on the given file descriptor. See the manpage for this
		 * syscall for more information. On systems where this call is not available,
		 * does nothing.
		 *
		 * @throws NativeIOException
		 *             if there is an error with the syscall
		 */</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">syncFileRangeIfPossible</span><span class="token punctuation">(</span><span class="token class-name">FileDescriptor</span> fd<span class="token punctuation">,</span> <span class="token keyword">long</span> offset<span class="token punctuation">,</span> <span class="token keyword">long</span> nbytes<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
				<span class="token keyword">throws</span> <span class="token class-name">NativeIOException</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>nativeLoaded <span class="token operator">&amp;&amp;</span> syncFileRangePossible<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
					<span class="token function">sync_file_range</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> nbytes<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnsupportedOperationException</span> uoe<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					syncFileRangePossible <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnsatisfiedLinkError</span> ule<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					syncFileRangePossible <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
 
		<span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">mlock_native</span><span class="token punctuation">(</span><span class="token class-name">ByteBuffer</span> buffer<span class="token punctuation">,</span> <span class="token keyword">long</span> len<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NativeIOException</span><span class="token punctuation">;</span>
 
		<span class="token comment">/**
		 * Locks the provided direct ByteBuffer into memory, preventing it from swapping
		 * out. After a buffer is locked, future accesses will not incur a page fault.
		 * 
		 * See the mlock(2) man page for more information.
		 * 
		 * @throws NativeIOException
		 */</span>
		<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">mlock</span><span class="token punctuation">(</span><span class="token class-name">ByteBuffer</span> buffer<span class="token punctuation">,</span> <span class="token keyword">long</span> len<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">assertCodeLoaded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>buffer<span class="token punctuation">.</span><span class="token function">isDirect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"Cannot mlock a non-direct ByteBuffer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token function">mlock_native</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
 
		<span class="token comment">/**
		 * Unmaps the block from memory. See munmap(2).
		 *
		 * There isn't any portable way to unmap a memory region in Java. So we use the
		 * sun.nio method here. Note that unmapping a memory region could cause crashes
		 * if code continues to reference the unmapped code. However, if we don't
		 * manually unmap the memory, we are dependent on the finalizer to do it, and we
		 * have no idea when the finalizer will run.
		 *
		 * @param buffer
		 *            The buffer to unmap.
		 */</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">munmap</span><span class="token punctuation">(</span><span class="token class-name">MappedByteBuffer</span> buffer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>buffer <span class="token keyword">instanceof</span> <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>ch<span class="token punctuation">.</span></span>DirectBuffer</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span></span>Cleaner</span> cleaner <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>ch<span class="token punctuation">.</span></span>DirectBuffer</span><span class="token punctuation">)</span> buffer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cleaner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				cleaner<span class="token punctuation">.</span><span class="token function">clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
 
		<span class="token comment">/** Linux only methods used for getOwner() implementation */</span>
		<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token keyword">long</span> <span class="token function">getUIDforFDOwnerforOwner</span><span class="token punctuation">(</span><span class="token class-name">FileDescriptor</span> fd<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>
 
		<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token class-name">String</span> <span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token keyword">long</span> uid<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>
 
		<span class="token comment">/**
		 * Result type of the fstat call
		 */</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Stat</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">private</span> <span class="token keyword">int</span> ownerId<span class="token punctuation">,</span> groupId<span class="token punctuation">;</span>
			<span class="token keyword">private</span> <span class="token class-name">String</span> owner<span class="token punctuation">,</span> group<span class="token punctuation">;</span>
			<span class="token keyword">private</span> <span class="token keyword">int</span> mode<span class="token punctuation">;</span>
 
			<span class="token comment">// Mode constants</span>
			<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> S_IFMT <span class="token operator">=</span> <span class="token number">0170000</span><span class="token punctuation">;</span> <span class="token comment">/* type of file */</span>
			<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> S_IFIFO <span class="token operator">=</span> <span class="token number">0010000</span><span class="token punctuation">;</span> <span class="token comment">/* named pipe (fifo) */</span>
			<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> S_IFCHR <span class="token operator">=</span> <span class="token number">0020000</span><span class="token punctuation">;</span> <span class="token comment">/* character special */</span>
			<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> S_IFDIR <span class="token operator">=</span> <span class="token number">0040000</span><span class="token punctuation">;</span> <span class="token comment">/* directory */</span>
			<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> S_IFBLK <span class="token operator">=</span> <span class="token number">0060000</span><span class="token punctuation">;</span> <span class="token comment">/* block special */</span>
			<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> S_IFREG <span class="token operator">=</span> <span class="token number">0100000</span><span class="token punctuation">;</span> <span class="token comment">/* regular */</span>
			<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> S_IFLNK <span class="token operator">=</span> <span class="token number">0120000</span><span class="token punctuation">;</span> <span class="token comment">/* symbolic link */</span>
			<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> S_IFSOCK <span class="token operator">=</span> <span class="token number">0140000</span><span class="token punctuation">;</span> <span class="token comment">/* socket */</span>
			<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> S_IFWHT <span class="token operator">=</span> <span class="token number">0160000</span><span class="token punctuation">;</span> <span class="token comment">/* whiteout */</span>
			<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> S_ISUID <span class="token operator">=</span> <span class="token number">0004000</span><span class="token punctuation">;</span> <span class="token comment">/* set user id on execution */</span>
			<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> S_ISGID <span class="token operator">=</span> <span class="token number">0002000</span><span class="token punctuation">;</span> <span class="token comment">/* set group id on execution */</span>
			<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> S_ISVTX <span class="token operator">=</span> <span class="token number">0001000</span><span class="token punctuation">;</span> <span class="token comment">/* save swapped text even after use */</span>
			<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> S_IRUSR <span class="token operator">=</span> <span class="token number">0000400</span><span class="token punctuation">;</span> <span class="token comment">/* read permission, owner */</span>
			<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> S_IWUSR <span class="token operator">=</span> <span class="token number">0000200</span><span class="token punctuation">;</span> <span class="token comment">/* write permission, owner */</span>
			<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> S_IXUSR <span class="token operator">=</span> <span class="token number">0000100</span><span class="token punctuation">;</span> <span class="token comment">/* execute/search permission, owner */</span>
 
			<span class="token class-name">Stat</span><span class="token punctuation">(</span><span class="token keyword">int</span> ownerId<span class="token punctuation">,</span> <span class="token keyword">int</span> groupId<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>ownerId <span class="token operator">=</span> ownerId<span class="token punctuation">;</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>groupId <span class="token operator">=</span> groupId<span class="token punctuation">;</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>mode <span class="token operator">=</span> mode<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
 
			<span class="token class-name">Stat</span><span class="token punctuation">(</span><span class="token class-name">String</span> owner<span class="token punctuation">,</span> <span class="token class-name">String</span> group<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Shell</span><span class="token punctuation">.</span>WINDOWS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token keyword">this</span><span class="token punctuation">.</span>owner <span class="token operator">=</span> owner<span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
					<span class="token keyword">this</span><span class="token punctuation">.</span>owner <span class="token operator">=</span> <span class="token function">stripDomain</span><span class="token punctuation">(</span>owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Shell</span><span class="token punctuation">.</span>WINDOWS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token keyword">this</span><span class="token punctuation">.</span>group <span class="token operator">=</span> group<span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
					<span class="token keyword">this</span><span class="token punctuation">.</span>group <span class="token operator">=</span> <span class="token function">stripDomain</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>mode <span class="token operator">=</span> mode<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
 
			<span class="token annotation punctuation">@Override</span>
			<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">return</span> <span class="token string">"Stat(owner='"</span> <span class="token operator">+</span> owner <span class="token operator">+</span> <span class="token string">"', group='"</span> <span class="token operator">+</span> group <span class="token operator">+</span> <span class="token string">"'"</span> <span class="token operator">+</span> <span class="token string">", mode="</span> <span class="token operator">+</span> mode <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
 
			<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getOwner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">return</span> owner<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
 
			<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">return</span> group<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
 
			<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">return</span> mode<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
 
		<span class="token comment">/**
		 * Returns the file stat for a file descriptor.
		 *
		 * @param fd
		 *            file descriptor.
		 * @return the file descriptor file stat.
		 * @throws IOException
		 *             thrown if there was an IO error while obtaining the file stat.
		 */</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Stat</span> <span class="token function">getFstat</span><span class="token punctuation">(</span><span class="token class-name">FileDescriptor</span> fd<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
			<span class="token class-name">Stat</span> stat <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Shell</span><span class="token punctuation">.</span>WINDOWS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				stat <span class="token operator">=</span> <span class="token function">fstat</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
				stat<span class="token punctuation">.</span>owner <span class="token operator">=</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token class-name">IdCache</span><span class="token punctuation">.</span>USER<span class="token punctuation">,</span> stat<span class="token punctuation">.</span>ownerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
				stat<span class="token punctuation">.</span>group <span class="token operator">=</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token class-name">IdCache</span><span class="token punctuation">.</span>GROUP<span class="token punctuation">,</span> stat<span class="token punctuation">.</span>groupId<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
					stat <span class="token operator">=</span> <span class="token function">fstat</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NativeIOException</span> nioe<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>nioe<span class="token punctuation">.</span><span class="token function">getErrorCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
						<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NativeIOException</span><span class="token punctuation">(</span><span class="token string">"The handle is invalid."</span><span class="token punctuation">,</span> <span class="token class-name">Errno</span><span class="token punctuation">.</span>EBADF<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
						LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"NativeIO.getFstat error (%d): %s"</span><span class="token punctuation">,</span> nioe<span class="token punctuation">.</span><span class="token function">getErrorCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
								nioe<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NativeIOException</span><span class="token punctuation">(</span><span class="token string">"Unknown error"</span><span class="token punctuation">,</span> <span class="token class-name">Errno</span><span class="token punctuation">.</span>UNKNOWN<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> stat<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
 
		<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token class-name">IdCache</span> domain<span class="token punctuation">,</span> <span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
			<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">CachedName</span><span class="token punctuation">&gt;</span></span> idNameCache <span class="token operator">=</span> <span class="token punctuation">(</span>domain <span class="token operator">==</span> <span class="token class-name">IdCache</span><span class="token punctuation">.</span>USER<span class="token punctuation">)</span> <span class="token operator">?</span> USER_ID_NAME_CACHE <span class="token operator">:</span> GROUP_ID_NAME_CACHE<span class="token punctuation">;</span>
			<span class="token class-name">String</span> name<span class="token punctuation">;</span>
			<span class="token class-name">CachedName</span> cachedName <span class="token operator">=</span> idNameCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>cachedName <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>cachedName<span class="token punctuation">.</span>timestamp <span class="token operator">+</span> cacheTimeout<span class="token punctuation">)</span> <span class="token operator">&gt;</span> now<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				name <span class="token operator">=</span> cachedName<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
				name <span class="token operator">=</span> <span class="token punctuation">(</span>domain <span class="token operator">==</span> <span class="token class-name">IdCache</span><span class="token punctuation">.</span>USER<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">getUserName</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">getGroupName</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>LOG<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token class-name">String</span> type <span class="token operator">=</span> <span class="token punctuation">(</span>domain <span class="token operator">==</span> <span class="token class-name">IdCache</span><span class="token punctuation">.</span>USER<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"UserName"</span> <span class="token operator">:</span> <span class="token string">"GroupName"</span><span class="token punctuation">;</span>
					LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Got "</span> <span class="token operator">+</span> type <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">" for ID "</span> <span class="token operator">+</span> id <span class="token operator">+</span> <span class="token string">" from the native implementation"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				cachedName <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CachedName</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
				idNameCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> cachedName<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> name<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
 
		<span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token class-name">String</span> <span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token keyword">int</span> uid<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>
 
		<span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token class-name">String</span> <span class="token function">getGroupName</span><span class="token punctuation">(</span><span class="token keyword">int</span> uid<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>
 
		<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">CachedName</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">final</span> <span class="token keyword">long</span> timestamp<span class="token punctuation">;</span>
			<span class="token keyword">final</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
 
			<span class="token keyword">public</span> <span class="token class-name">CachedName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">long</span> timestamp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>timestamp <span class="token operator">=</span> timestamp<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
 
		<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">CachedName</span><span class="token punctuation">&gt;</span></span> USER_ID_NAME_CACHE <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">CachedName</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
		<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">CachedName</span><span class="token punctuation">&gt;</span></span> GROUP_ID_NAME_CACHE <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">CachedName</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
		<span class="token keyword">private</span> <span class="token keyword">enum</span> <span class="token class-name">IdCache</span> <span class="token punctuation">{<!-- --></span>
			USER<span class="token punctuation">,</span> GROUP
		<span class="token punctuation">}</span>
 
		<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">int</span> MMAP_PROT_READ <span class="token operator">=</span> <span class="token number">0x1</span><span class="token punctuation">;</span>
		<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">int</span> MMAP_PROT_WRITE <span class="token operator">=</span> <span class="token number">0x2</span><span class="token punctuation">;</span>
		<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">int</span> MMAP_PROT_EXEC <span class="token operator">=</span> <span class="token number">0x4</span><span class="token punctuation">;</span>
 
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token keyword">long</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token class-name">FileDescriptor</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> prot<span class="token punctuation">,</span> <span class="token keyword">boolean</span> shared<span class="token punctuation">,</span> <span class="token keyword">long</span> length<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>
 
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">munmap</span><span class="token punctuation">(</span><span class="token keyword">long</span> addr<span class="token punctuation">,</span> <span class="token keyword">long</span> length<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
 
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> workaroundNonThreadSafePasswdCalls <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
 
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Windows</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// Flags for CreateFile() call on Windows</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> GENERIC_READ <span class="token operator">=</span> <span class="token number">0</span>x80000000L<span class="token punctuation">;</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> GENERIC_WRITE <span class="token operator">=</span> <span class="token number">0</span>x40000000L<span class="token punctuation">;</span>
 
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> FILE_SHARE_READ <span class="token operator">=</span> <span class="token number">0</span>x00000001L<span class="token punctuation">;</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> FILE_SHARE_WRITE <span class="token operator">=</span> <span class="token number">0</span>x00000002L<span class="token punctuation">;</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> FILE_SHARE_DELETE <span class="token operator">=</span> <span class="token number">0</span>x00000004L<span class="token punctuation">;</span>
 
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> CREATE_NEW <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> CREATE_ALWAYS <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> OPEN_EXISTING <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> OPEN_ALWAYS <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> TRUNCATE_EXISTING <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
 
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> FILE_BEGIN <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> FILE_CURRENT <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> FILE_END <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
 
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> FILE_ATTRIBUTE_NORMAL <span class="token operator">=</span> <span class="token number">0</span>x00000080L<span class="token punctuation">;</span>
 
		<span class="token comment">/**
		 * Create a directory with permissions set to the specified mode. By setting
		 * permissions at creation time, we avoid issues related to the user lacking
		 * WRITE_DAC rights on subsequent chmod calls. One example where this can occur
		 * is writing to an SMB share where the user does not have Full Control rights,
		 * and therefore WRITE_DAC is denied.
		 *
		 * @param path
		 *            directory to create
		 * @param mode
		 *            permissions of new directory
		 * @throws IOException
		 *             if there is an I/O error
		 */</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">createDirectoryWithMode</span><span class="token punctuation">(</span><span class="token class-name">File</span> path<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">createDirectoryWithMode0</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
 
		<span class="token comment">/** Wrapper around CreateDirectory() on Windows */</span>
		<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">createDirectoryWithMode0</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NativeIOException</span><span class="token punctuation">;</span>
 
		<span class="token comment">/** Wrapper around CreateFile() on Windows */</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token class-name">FileDescriptor</span> <span class="token function">createFile</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token keyword">long</span> desiredAccess<span class="token punctuation">,</span> <span class="token keyword">long</span> shareMode<span class="token punctuation">,</span>
				<span class="token keyword">long</span> creationDisposition<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>
 
		<span class="token comment">/**
		 * Create a file for write with permissions set to the specified mode. By
		 * setting permissions at creation time, we avoid issues related to the user
		 * lacking WRITE_DAC rights on subsequent chmod calls. One example where this
		 * can occur is writing to an SMB share where the user does not have Full
		 * Control rights, and therefore WRITE_DAC is denied.
		 *
		 * This method mimics the semantics implemented by the JDK in
		 * {@link java.io.FileOutputStream}. The file is opened for truncate or append,
		 * the sharing mode allows other readers and writers, and paths longer than
		 * MAX_PATH are supported. (See io_util_md.c in the JDK.)
		 *
		 * @param path
		 *            file to create
		 * @param append
		 *            if true, then open file for append
		 * @param mode
		 *            permissions of new directory
		 * @return FileOutputStream of opened file
		 * @throws IOException
		 *             if there is an I/O error
		 */</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">FileOutputStream</span> <span class="token function">createFileOutputStreamWithMode</span><span class="token punctuation">(</span><span class="token class-name">File</span> path<span class="token punctuation">,</span> <span class="token keyword">boolean</span> append<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">)</span>
				<span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">long</span> desiredAccess <span class="token operator">=</span> GENERIC_WRITE<span class="token punctuation">;</span>
			<span class="token keyword">long</span> shareMode <span class="token operator">=</span> FILE_SHARE_READ <span class="token operator">|</span> FILE_SHARE_WRITE<span class="token punctuation">;</span>
			<span class="token keyword">long</span> creationDisposition <span class="token operator">=</span> append <span class="token operator">?</span> OPEN_ALWAYS <span class="token operator">:</span> CREATE_ALWAYS<span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>
					<span class="token function">createFileWithMode0</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> desiredAccess<span class="token punctuation">,</span> shareMode<span class="token punctuation">,</span> creationDisposition<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
 
		<span class="token comment">/** Wrapper around CreateFile() with security descriptor on Windows */</span>
		<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token class-name">FileDescriptor</span> <span class="token function">createFileWithMode0</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token keyword">long</span> desiredAccess<span class="token punctuation">,</span> <span class="token keyword">long</span> shareMode<span class="token punctuation">,</span>
				<span class="token keyword">long</span> creationDisposition<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NativeIOException</span><span class="token punctuation">;</span>
 
		<span class="token comment">/** Wrapper around SetFilePointer() on Windows */</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token keyword">long</span> <span class="token function">setFilePointer</span><span class="token punctuation">(</span><span class="token class-name">FileDescriptor</span> fd<span class="token punctuation">,</span> <span class="token keyword">long</span> distanceToMove<span class="token punctuation">,</span> <span class="token keyword">long</span> moveMethod<span class="token punctuation">)</span>
				<span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>
 
		<span class="token comment">/** Windows only methods used for getOwner() implementation */</span>
		<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token class-name">String</span> <span class="token function">getOwner</span><span class="token punctuation">(</span><span class="token class-name">FileDescriptor</span> fd<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>
 
		<span class="token comment">/** Supported list of Windows access right flags */</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">enum</span> <span class="token class-name">AccessRight</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">ACCESS_READ</span><span class="token punctuation">(</span><span class="token number">0x0001</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// FILE_READ_DATA</span>
			<span class="token function">ACCESS_WRITE</span><span class="token punctuation">(</span><span class="token number">0x0002</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// FILE_WRITE_DATA</span>
			<span class="token function">ACCESS_EXECUTE</span><span class="token punctuation">(</span><span class="token number">0x0020</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// FILE_EXECUTE</span>
 
			<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> accessRight<span class="token punctuation">;</span>
 
			<span class="token class-name">AccessRight</span><span class="token punctuation">(</span><span class="token keyword">int</span> access<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				accessRight <span class="token operator">=</span> access<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
 
			<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">accessRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">return</span> accessRight<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
 
		<span class="token comment">/**
		 * Windows only method used to check if the current process has requested access
		 * rights on the given path.
		 */</span>
		<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token keyword">boolean</span> <span class="token function">access0</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token keyword">int</span> requestedAccess<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
		<span class="token comment">/**
		 * Checks whether the current process has desired access rights on the given
		 * path.
		 * 
		 * Longer term this native function can be substituted with JDK7 function
		 * Files#isReadable, isWritable, isExecutable.
		 *
		 * @param path
		 *            input path
		 * @param desiredAccess
		 *            ACCESS_READ, ACCESS_WRITE or ACCESS_EXECUTE
		 * @return true if access is allowed
		 * @throws IOException
		 *             I/O exception on error
		 */</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token class-name">AccessRight</span> desiredAccess<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
			<span class="token comment">// return access0(path, desiredAccess.accessRight());</span>
		<span class="token punctuation">}</span>
 
		<span class="token comment">/**
		 * Extends both the minimum and maximum working set size of the current process.
		 * This method gets the current minimum and maximum working set size, adds the
		 * requested amount to each and then sets the minimum and maximum working set
		 * size to the new values. Controlling the working set size of the process also
		 * controls the amount of memory it can lock.
		 *
		 * @param delta
		 *            amount to increment minimum and maximum working set size
		 * @throws IOException
		 *             for any error
		 * @see POSIX#mlock(ByteBuffer, long)
		 */</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">extendWorkingSetSize</span><span class="token punctuation">(</span><span class="token keyword">long</span> delta<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>
 
		<span class="token keyword">static</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">NativeCodeLoader</span><span class="token punctuation">.</span><span class="token function">isNativeCodeLoaded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
					<span class="token function">initNative</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					nativeLoaded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token comment">// This can happen if the user has an older version of libhadoop.so</span>
					<span class="token comment">// installed - in this case we can continue without native IO</span>
					<span class="token comment">// after warning</span>
					<span class="token class-name">PerformanceAdvisory</span><span class="token punctuation">.</span>LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Unable to initialize NativeIO libraries"</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
 
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Log</span> LOG <span class="token operator">=</span> <span class="token class-name">LogFactory</span><span class="token punctuation">.</span><span class="token function">getLog</span><span class="token punctuation">(</span><span class="token class-name">NativeIO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> nativeLoaded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
 
	<span class="token keyword">static</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">NativeCodeLoader</span><span class="token punctuation">.</span><span class="token function">isNativeCodeLoaded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">initNative</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				nativeLoaded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">// This can happen if the user has an older version of libhadoop.so</span>
				<span class="token comment">// installed - in this case we can continue without native IO</span>
				<span class="token comment">// after warning</span>
				<span class="token class-name">PerformanceAdvisory</span><span class="token punctuation">.</span>LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Unable to initialize NativeIO libraries"</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
 
	<span class="token comment">/**
	 * Return true if the JNI-based native IO extensions are available.
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">isAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token class-name">NativeCodeLoader</span><span class="token punctuation">.</span><span class="token function">isNativeCodeLoaded</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> nativeLoaded<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
 
	<span class="token comment">/** Initialize the JNI method ID and class ID cache */</span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">initNative</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
	<span class="token comment">/**
	 * Get the maximum number of bytes that can be locked into memory at any given
	 * point.
	 *
	 * @return 0 if no bytes can be locked into memory; Long.MAX_VALUE if there is
	 *         no limit; The number of bytes that can be locked into memory
	 *         otherwise.
	 */</span>
	<span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">getMemlockLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token function">isAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">getMemlockLimit0</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
 
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token keyword">long</span> <span class="token function">getMemlockLimit0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
	<span class="token comment">/**
	 * @return the operating system's page size.
	 */</span>
	<span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">getOperatingSystemPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
			<span class="token class-name">Field</span> f <span class="token operator">=</span> <span class="token class-name">Unsafe</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"theUnsafe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			f<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">Unsafe</span> unsafe <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Unsafe</span><span class="token punctuation">)</span> f<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> unsafe<span class="token punctuation">.</span><span class="token function">pageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Unable to get operating system page size.  Guessing 4096."</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token number">4096</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
 
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">CachedUid</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">final</span> <span class="token keyword">long</span> timestamp<span class="token punctuation">;</span>
		<span class="token keyword">final</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>
 
		<span class="token keyword">public</span> <span class="token class-name">CachedUid</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token keyword">long</span> timestamp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>timestamp <span class="token operator">=</span> timestamp<span class="token punctuation">;</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>username <span class="token operator">=</span> username<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
 
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">CachedUid</span><span class="token punctuation">&gt;</span></span> uidCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">CachedUid</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">long</span> cacheTimeout<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> initialized <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
 
	<span class="token comment">/**
	 * The Windows logon name has two part, NetBIOS domain name and user account
	 * name, of the format DOMAIN\UserName. This method will remove the domain part
	 * of the full logon name.
	 *
	 * @param Fthe
	 *            full principal name containing the domain
	 * @return name with domain removed
	 */</span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">stripDomain</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">int</span> i <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token char">'\\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
			name <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> name<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
 
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getOwner</span><span class="token punctuation">(</span><span class="token class-name">FileDescriptor</span> fd<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">ensureInitialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Shell</span><span class="token punctuation">.</span>WINDOWS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token class-name">String</span> owner <span class="token operator">=</span> <span class="token class-name">Windows</span><span class="token punctuation">.</span><span class="token function">getOwner</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
			owner <span class="token operator">=</span> <span class="token function">stripDomain</span><span class="token punctuation">(</span>owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> owner<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">long</span> uid <span class="token operator">=</span> POSIX<span class="token punctuation">.</span><span class="token function">getUIDforFDOwnerforOwner</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">CachedUid</span> cUid <span class="token operator">=</span> uidCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>cUid <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>cUid<span class="token punctuation">.</span>timestamp <span class="token operator">+</span> cacheTimeout<span class="token punctuation">)</span> <span class="token operator">&gt;</span> now<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">return</span> cUid<span class="token punctuation">.</span>username<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token class-name">String</span> user <span class="token operator">=</span> POSIX<span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
			LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Got UserName "</span> <span class="token operator">+</span> user <span class="token operator">+</span> <span class="token string">" for UID "</span> <span class="token operator">+</span> uid <span class="token operator">+</span> <span class="token string">" from the native implementation"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			cUid <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CachedUid</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
			uidCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>uid<span class="token punctuation">,</span> cUid<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> user<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
 
	<span class="token comment">/**
	 * Create a FileInputStream that shares delete permission on the file opened,
	 * i.e. other process can delete the file the FileInputStream is reading. Only
	 * Windows implementation uses the native interface.
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">FileInputStream</span> <span class="token function">getShareDeleteFileInputStream</span><span class="token punctuation">(</span><span class="token class-name">File</span> f<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Shell</span><span class="token punctuation">.</span>WINDOWS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// On Linux the default FileInputStream shares delete permission</span>
			<span class="token comment">// on the file opened.</span>
			<span class="token comment">//</span>
			<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// Use Windows native interface to create a FileInputStream that</span>
			<span class="token comment">// shares delete permission on the file opened.</span>
			<span class="token comment">//</span>
			<span class="token class-name">FileDescriptor</span> fd <span class="token operator">=</span> <span class="token class-name">Windows</span><span class="token punctuation">.</span><span class="token function">createFile</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Windows</span><span class="token punctuation">.</span>GENERIC_READ<span class="token punctuation">,</span>
					<span class="token class-name">Windows</span><span class="token punctuation">.</span>FILE_SHARE_READ <span class="token operator">|</span> <span class="token class-name">Windows</span><span class="token punctuation">.</span>FILE_SHARE_WRITE <span class="token operator">|</span> <span class="token class-name">Windows</span><span class="token punctuation">.</span>FILE_SHARE_DELETE<span class="token punctuation">,</span>
					<span class="token class-name">Windows</span><span class="token punctuation">.</span>OPEN_EXISTING<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
 
	<span class="token comment">/**
	 * Create a FileInputStream that shares delete permission on the file opened at
	 * a given offset, i.e. other process can delete the file the FileInputStream is
	 * reading. Only Windows implementation uses the native interface.
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">FileInputStream</span> <span class="token function">getShareDeleteFileInputStream</span><span class="token punctuation">(</span><span class="token class-name">File</span> f<span class="token punctuation">,</span> <span class="token keyword">long</span> seekOffset<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Shell</span><span class="token punctuation">.</span>WINDOWS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token class-name">RandomAccessFile</span> rf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>seekOffset <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				rf<span class="token punctuation">.</span><span class="token function">seek</span><span class="token punctuation">(</span>seekOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span><span class="token function">getFD</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// Use Windows native interface to create a FileInputStream that</span>
			<span class="token comment">// shares delete permission on the file opened, and set it to the</span>
			<span class="token comment">// given offset.</span>
			<span class="token comment">//</span>
			<span class="token class-name">FileDescriptor</span> fd <span class="token operator">=</span> <span class="token class-name">NativeIO<span class="token punctuation">.</span>Windows</span><span class="token punctuation">.</span><span class="token function">createFile</span><span class="token punctuation">(</span>
					f<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">NativeIO<span class="token punctuation">.</span>Windows</span><span class="token punctuation">.</span>GENERIC_READ<span class="token punctuation">,</span> <span class="token class-name">NativeIO<span class="token punctuation">.</span>Windows</span><span class="token punctuation">.</span>FILE_SHARE_READ
							<span class="token operator">|</span> <span class="token class-name">NativeIO<span class="token punctuation">.</span>Windows</span><span class="token punctuation">.</span>FILE_SHARE_WRITE <span class="token operator">|</span> <span class="token class-name">NativeIO<span class="token punctuation">.</span>Windows</span><span class="token punctuation">.</span>FILE_SHARE_DELETE<span class="token punctuation">,</span>
					<span class="token class-name">NativeIO<span class="token punctuation">.</span>Windows</span><span class="token punctuation">.</span>OPEN_EXISTING<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>seekOffset <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
				<span class="token class-name">NativeIO<span class="token punctuation">.</span>Windows</span><span class="token punctuation">.</span><span class="token function">setFilePointer</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> seekOffset<span class="token punctuation">,</span> <span class="token class-name">NativeIO<span class="token punctuation">.</span>Windows</span><span class="token punctuation">.</span>FILE_BEGIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
 
	<span class="token comment">/**
	 * Create the specified File for write access, ensuring that it does not exist.
	 * 
	 * @param f
	 *            the file that we want to create
	 * @param permissions
	 *            we want to have on the file (if security is enabled)
	 *
	 * @throws AlreadyExistsException
	 *             if the file already exists
	 * @throws IOException
	 *             if any other error occurred
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">FileOutputStream</span> <span class="token function">getCreateForWriteFileOutputStream</span><span class="token punctuation">(</span><span class="token class-name">File</span> f<span class="token punctuation">,</span> <span class="token keyword">int</span> permissions<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Shell</span><span class="token punctuation">.</span>WINDOWS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// Use the native wrapper around open(2)</span>
			<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
				<span class="token class-name">FileDescriptor</span> fd <span class="token operator">=</span> <span class="token class-name">NativeIO</span><span class="token punctuation">.</span>POSIX<span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
						<span class="token class-name">NativeIO</span><span class="token punctuation">.</span>POSIX<span class="token punctuation">.</span>O_WRONLY <span class="token operator">|</span> <span class="token class-name">NativeIO</span><span class="token punctuation">.</span>POSIX<span class="token punctuation">.</span>O_CREAT <span class="token operator">|</span> <span class="token class-name">NativeIO</span><span class="token punctuation">.</span>POSIX<span class="token punctuation">.</span>O_EXCL<span class="token punctuation">,</span> permissions<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NativeIOException</span> nioe<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>nioe<span class="token punctuation">.</span><span class="token function">getErrno</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Errno</span><span class="token punctuation">.</span>EEXIST<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AlreadyExistsException</span><span class="token punctuation">(</span>nioe<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">throw</span> nioe<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// Use the Windows native APIs to create equivalent FileOutputStream</span>
			<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
				<span class="token class-name">FileDescriptor</span> fd <span class="token operator">=</span> <span class="token class-name">NativeIO<span class="token punctuation">.</span>Windows</span><span class="token punctuation">.</span><span class="token function">createFile</span><span class="token punctuation">(</span>
						f<span class="token punctuation">.</span><span class="token function">getCanonicalPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">NativeIO<span class="token punctuation">.</span>Windows</span><span class="token punctuation">.</span>GENERIC_WRITE<span class="token punctuation">,</span> <span class="token class-name">NativeIO<span class="token punctuation">.</span>Windows</span><span class="token punctuation">.</span>FILE_SHARE_DELETE
								<span class="token operator">|</span> <span class="token class-name">NativeIO<span class="token punctuation">.</span>Windows</span><span class="token punctuation">.</span>FILE_SHARE_READ <span class="token operator">|</span> <span class="token class-name">NativeIO<span class="token punctuation">.</span>Windows</span><span class="token punctuation">.</span>FILE_SHARE_WRITE<span class="token punctuation">,</span>
						<span class="token class-name">NativeIO<span class="token punctuation">.</span>Windows</span><span class="token punctuation">.</span>CREATE_NEW<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">NativeIO</span><span class="token punctuation">.</span>POSIX<span class="token punctuation">.</span><span class="token function">chmod</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">getCanonicalPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> permissions<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NativeIOException</span> nioe<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>nioe<span class="token punctuation">.</span><span class="token function">getErrorCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">80</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token comment">// ERROR_FILE_EXISTS</span>
					<span class="token comment">// 80 (0x50)</span>
					<span class="token comment">// The file exists</span>
					<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AlreadyExistsException</span><span class="token punctuation">(</span>nioe<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">throw</span> nioe<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
 
	<span class="token keyword">private</span> <span class="token keyword">synchronized</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ensureInitialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>initialized<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			cacheTimeout <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token string">"hadoop.security.uid.cache.secs"</span><span class="token punctuation">,</span> <span class="token number">4</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
			LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Initialized cache for UID to User mapping with a cache"</span> <span class="token operator">+</span> <span class="token string">" timeout of "</span> <span class="token operator">+</span> cacheTimeout <span class="token operator">/</span> <span class="token number">1000</span>
					<span class="token operator">+</span> <span class="token string">" seconds."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			initialized <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
 
	<span class="token comment">/**
	 * A version of renameTo that throws a descriptive exception when it fails.
	 *
	 * @param src
	 *            The source path
	 * @param dst
	 *            The destination path
	 * 
	 * @throws NativeIOException
	 *             On failure.
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">renameTo</span><span class="token punctuation">(</span><span class="token class-name">File</span> src<span class="token punctuation">,</span> <span class="token class-name">File</span> dst<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nativeLoaded<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>src<span class="token punctuation">.</span><span class="token function">renameTo</span><span class="token punctuation">(</span>dst<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"renameTo(src="</span> <span class="token operator">+</span> src <span class="token operator">+</span> <span class="token string">", dst="</span> <span class="token operator">+</span> dst <span class="token operator">+</span> <span class="token string">") failed."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">renameTo0</span><span class="token punctuation">(</span>src<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dst<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
 
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">link</span><span class="token punctuation">(</span><span class="token class-name">File</span> src<span class="token punctuation">,</span> <span class="token class-name">File</span> dst<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nativeLoaded<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token class-name">HardLink</span><span class="token punctuation">.</span><span class="token function">createHardLink</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> dst<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">link0</span><span class="token punctuation">(</span>src<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dst<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
 
	<span class="token comment">/**
	 * A version of renameTo that throws a descriptive exception when it fails.
	 *
	 * @param src
	 *            The source path
	 * @param dst
	 *            The destination path
	 * 
	 * @throws NativeIOException
	 *             On failure.
	 */</span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">renameTo0</span><span class="token punctuation">(</span><span class="token class-name">String</span> src<span class="token punctuation">,</span> <span class="token class-name">String</span> dst<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NativeIOException</span><span class="token punctuation">;</span>
 
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">link0</span><span class="token punctuation">(</span><span class="token class-name">String</span> src<span class="token punctuation">,</span> <span class="token class-name">String</span> dst<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NativeIOException</span><span class="token punctuation">;</span>
 
	<span class="token comment">/**
	 * Unbuffered file copy from src to dst without tainting OS buffer cache
	 *
	 * In POSIX platform: It uses FileChannel#transferTo() which internally attempts
	 * unbuffered IO on OS with native sendfile64() support and falls back to
	 * buffered IO otherwise.
	 *
	 * It minimizes the number of FileChannel#transferTo call by passing the the src
	 * file size directly instead of a smaller size as the 3rd parameter. This saves
	 * the number of sendfile64() system call when native sendfile64() is supported.
	 * In the two fall back cases where sendfile is not supported,
	 * FileChannle#transferTo already has its own batching of size 8 MB and 8 KB,
	 * respectively.
	 *
	 * In Windows Platform: It uses its own native wrapper of CopyFileEx with
	 * COPY_FILE_NO_BUFFERING flag, which is supported on Windows Server 2008 and
	 * above.
	 *
	 * Ideally, we should use FileChannel#transferTo() across both POSIX and Windows
	 * platform. Unfortunately, the
	 * wrapper(Java_sun_nio_ch_FileChannelImpl_transferTo0) used by
	 * FileChannel#transferTo for unbuffered IO is not implemented on Windows. Based
	 * on OpenJDK 6/7/8 source code, Java_sun_nio_ch_FileChannelImpl_transferTo0 on
	 * Windows simply returns IOS_UNSUPPORTED.
	 *
	 * Note: This simple native wrapper does minimal parameter checking before copy
	 * and consistency check (e.g., size) after copy. It is recommended to use
	 * wrapper function like the Storage#nativeCopyFileUnbuffered() function in
	 * hadoop-hdfs with pre/post copy checks.
	 *
	 * @param src
	 *            The source path
	 * @param dst
	 *            The destination path
	 * @throws IOException
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">copyFileUnbuffered</span><span class="token punctuation">(</span><span class="token class-name">File</span> src<span class="token punctuation">,</span> <span class="token class-name">File</span> dst<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>nativeLoaded <span class="token operator">&amp;&amp;</span> <span class="token class-name">Shell</span><span class="token punctuation">.</span>WINDOWS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">copyFileUnbuffered0</span><span class="token punctuation">(</span>src<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dst<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			<span class="token class-name">FileInputStream</span> fis <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
			<span class="token class-name">FileOutputStream</span> fos <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
			<span class="token class-name">FileChannel</span> input <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
			<span class="token class-name">FileChannel</span> output <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
			<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
				fis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>
				fos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>dst<span class="token punctuation">)</span><span class="token punctuation">;</span>
				input <span class="token operator">=</span> fis<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				output <span class="token operator">=</span> fos<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">long</span> remaining <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">long</span> position <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
				<span class="token keyword">long</span> transferred <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
				<span class="token keyword">while</span> <span class="token punctuation">(</span>remaining <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					transferred <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">transferTo</span><span class="token punctuation">(</span>position<span class="token punctuation">,</span> remaining<span class="token punctuation">,</span> output<span class="token punctuation">)</span><span class="token punctuation">;</span>
					remaining <span class="token operator">-=</span> transferred<span class="token punctuation">;</span>
					position <span class="token operator">+=</span> transferred<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
				<span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">cleanup</span><span class="token punctuation">(</span>LOG<span class="token punctuation">,</span> output<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">cleanup</span><span class="token punctuation">(</span>LOG<span class="token punctuation">,</span> fos<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">cleanup</span><span class="token punctuation">(</span>LOG<span class="token punctuation">,</span> input<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">cleanup</span><span class="token punctuation">(</span>LOG<span class="token punctuation">,</span> fis<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
 
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">copyFileUnbuffered0</span><span class="token punctuation">(</span><span class="token class-name">String</span> src<span class="token punctuation">,</span> <span class="token class-name">String</span> dst<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NativeIOException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6ab270b922ae59b9a6b8675f0e16821c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">JSON.parse(JSON.stringify())实现深拷贝的缺点</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/385647e98791ede9a320f9d357ee8fa7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">在MAC上彻底删除IntelliJ系列软件残留</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>