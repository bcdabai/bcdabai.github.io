<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【转】Qt4移植Qt5总结 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【转】Qt4移植Qt5总结" />
<meta property="og:description" content="如果想把Qt4.x上面开发的软件在Qt5上面正常运行，如果什么都不做的话估计会出现各做各样的错误，笔者也是经历过这种迷茫痛，后面才发现官方已有系统发文一一提及到诸多迁移会遇到的问题以及解决办法。附上官网地址，以供参考http://qt-project.org/wiki/Transition_from_Qt_4.x_to_Qt5
为了提高开发者的开发效率，我对这个文档大致做一个翻译，也算为大家提供中文版的解决方案吧，如有异议，请参考原文。
1. QtWidgets 是一个独立的模块
例如，编译出现如下错误
error: QMainWindow: No such file or directory
error: QToolButton: No such file or directory
error: QWidget: No such file or directory
解决方法：
在工程的 *.pro文件中添加下面内容：
QT &#43;= widgets
同时把头文件
#include &lt;QtGui&gt;
更改为
#include &lt;QtWidgets&gt;
这样代码就可以正常运行了，不过有时候需要添加更详细的头文件，例如
#include &lt;QtWidgets/QtoolButton&gt;
2.QtWebKitWidgets也是一个独立的模块
例如，编译的时候出现如下错误:
error: invalid use of incomplete type &#39;class QWebFrame&#39;
error: forward declaration of &#39;class QWebFrame&#39;
解决方法：
在工程的 *.pro 文件中添加：
QT &#43;= webkitwidgets
备注：当已经有QT &#43;= webkitwidgets ，就不需要添加 QT &#43;= widgets" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/0ce2e062a18f05a83fa5b58087efc969/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-28T20:46:11+08:00" />
<meta property="article:modified_time" content="2023-05-28T20:46:11+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【转】Qt4移植Qt5总结</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>如果想把Qt4.x上面开发的软件在Qt5上面正常运行，如果什么都不做的话估计会出现各做各样的错误，笔者也是经历过这种迷茫痛，后面才发现官方已有系统发文一一提及到诸多迁移会遇到的问题以及解决办法。附上官网地址，以供参考http://qt-project.org/wiki/Transition_from_Qt_4.x_to_Qt5</p> 
<p>为了提高开发者的开发效率，我对这个文档大致做一个翻译，也算为大家提供中文版的解决方案吧，如有异议，请参考原文。</p> 
<p>1. QtWidgets 是一个独立的模块</p> 
<p>例如，编译出现如下错误</p> 
<p>    error: QMainWindow: No such file or directory</p> 
<p>    error: QToolButton: No such file or directory</p> 
<p>    error: QWidget: No such file or directory</p> 
<p>解决方法：</p> 
<p>在工程的 *.pro文件中添加下面内容：</p> 
<p>    QT += widgets</p> 
<p>同时把头文件</p> 
<p>    #include &lt;QtGui&gt;</p> 
<p>更改为</p> 
<p>    #include &lt;QtWidgets&gt;</p> 
<p>这样代码就可以正常运行了，不过有时候需要添加更详细的头文件，例如</p> 
<p>    #include &lt;QtWidgets/QtoolButton&gt;</p> 
<p>2.QtWebKitWidgets也是一个独立的模块</p> 
<p>例如，编译的时候出现如下错误:</p> 
<p>    error: invalid use of incomplete type 'class QWebFrame'</p> 
<p>    error: forward declaration of 'class QWebFrame'</p> 
<p>解决方法：</p> 
<p>在工程的 *.pro 文件中添加：</p> 
<p>    QT += webkitwidgets</p> 
<p>备注：当已经有QT += webkitwidgets ，就不需要添加 QT += widgets</p> 
<p>同时把工程文件里面添加的所有</p> 
<p>    #include &lt;QtWebKit&gt;</p> 
<p>更改为</p> 
<p>    #include &lt;QtWebKitWidgets&gt;</p> 
<p>3.QPrinter 不起作用</p> 
<p>如果你已经添加了如下两行</p> 
<p>    #include &lt;QPrinter&gt;</p> 
<p>    #include &lt;QPrintDialog&gt;</p> 
<p>在工程的 *.pro 文件中添加：</p> 
<p>    QT += printsupport</p> 
<p>如果还是不能工作，把添加的</p> 
<p>    #include &lt;QPrinter&gt;</p> 
<p>    #include &lt;QprintDialog&gt;</p> 
<p>更改为</p> 
<p>    #include &lt;QtPrintSupport/QPrinter&gt;</p> 
<p>    #include &lt;QtPrintSupport/QPrintDialog&gt;</p> 
<p>4.没有toAscii() 和 fromAscii()方法</p> 
<p>把</p> 
<p>    fromAscii()</p> 
<p>    toAscii()</p> 
<p>替换成</p> 
<p>    fromLatin1()</p> 
<p>    toLatin1()</p> 
<p>例如，在 Qt 4 上的代码</p> 
<p>    QByteArray configfileti = TMP_Config.toAscii();</p> 
<p>更改成</p> 
<p>    QByteArray configfileti = TMP_Config.toLatin1();</p> 
<p>5.去掉了QCoreApplication::UnicodeUTF8 </p> 
<p>因为Qt5都是采用 UnicodeUTF8的编码方式，所以 UnicodeUTF8这个枚举类型就显得有点多此一举了，所以删掉了所有的关于QCoreApplication::UnicodeUTF8参数的传递。</p> 
<p>例如：</p> 
<p>    Href_Gui-&gt;setWindowTitle(QApplication::translate("Href_Gui", "Url / www", 0, QApplication::UnicodeUTF8));</p> 
<p>    label-&gt;setText(QApplication::translate("Href_Gui", "Text:", 0, QApplication::UnicodeUTF8));</p> 
<p>    label_2-&gt;setText(QApplication::translate("Href_Gui", "Url:", 0, QApplication::UnicodeUTF8));</p> 
<p>    label_3-&gt;setText(QApplication::translate("Href_Gui", "Target / Name:", 0, QApplication::UnicodeUTF8));</p> 
<p>更改为：</p> 
<p>    Href_Gui-&gt;setWindowTitle(QApplication::translate("Href_Gui", "Url / www", 0));</p> 
<p>    label-&gt;setText(QApplication::translate("Href_Gui", "Text:", 0));</p> 
<p>    label_2-&gt;setText(QApplication::translate("Href_Gui", "Url:", 0));</p> 
<p>    label_3-&gt;setText(QApplication::translate("Href_Gui", "Target / Name:", 0));</p> 
<p>6.去掉了QWorkspace类</p> 
<p>在Qt4.3中，这个类就已经被 QMdiArea类替换掉了，在Qt5中把QWorkspace类正式删除掉了。QMdiArea类和QWorkspace类有类似的API接口，只是需要更改下一些方法，信号和槽的接口名字即可。</p> 
<p>替换</p> 
<p>    #include &lt;QWorkspace&gt;</p> 
<p>为</p> 
<p>    #include &lt;QMdiArea&gt;</p> 
<p>7.QDrag类问题</p> 
<p>应用的拖拽功能或许需要一些微调，例如</p> 
<p>    QDrag *drag = new QDrag(event-&gt;widget());</p> 
<p>在 Qt 5 会有如下错误</p> 
<p>    error: no matching function for call to 'QDrag::QDrag(QWidget*)'</p> 
<p>加上如下头文件或许可以解决如上错误</p> 
<p>    #include &lt;QWidget&gt;</p> 
<p>8.删掉了qFindChildren</p> 
<p>如果遇到如下错误</p> 
<p>    error: 'qFindChildren' was not declared in this scope</p> 
<p>解决办法</p> 
<p>用findChildren 方法替代qFindChildren ，需要注意的是，调用方法的方式略有改变。参考如下例子：</p> 
<p>    toString(const QObject* obj, int indentLevel) const {<!-- --></p> 
<p>    [...]</p> 
<p>        /* Query over QObjects */</p> 
<p>        if (m_children) {<!-- --></p> 
<p>            QList&lt;QObject*&gt; childlist = qFindChildren&lt;QObject*&gt;(obj, QString());</p> 
<p>    [...]</p> 
<p>把上述例子中的如下代码</p> 
<p>    QList&lt;QObject*&gt; childlist = qFindChildren&lt;QObject*&gt;(obj, QString());</p> 
<p>替换成如下代码</p> 
<p>    QList&lt;QObject*&gt; childlist = obj-&gt;findChildren&lt;QObject*&gt;(QString());</p> 
<p>9.删掉了qVariantValue </p> 
<p>编译时报如下错误</p> 
<p>    error: 'qVariantValue' was not declared in this scope</p> 
<p>这个函数等同于QVariant::value&lt;T&gt;(value)。因此可以把如下代码</p> 
<p>    QTime t = qVariantValue&lt;QTime&gt;(val);</p> 
<p>更改为</p> 
<p>    QTime t = val.value&lt;QTime&gt;();</p> 
<p>This QTime enclosed in the angled brackets lets the compiler know what QVariant will return. However, if the variable is not a QVariable the type enclosed in the angled brackets should not be used(doing so will result in a vague compile time error). So given that m_color is of type QColor you will rewrite</p> 
<p>    s.setValue("color/favorite", qVariantValue&lt;QColor&gt;(m_color));</p> 
<p>to</p> 
<p>    s.setValue("color/favorite", m_color.value());</p> 
<p>10.删除了qVariantCanConvert</p> 
<p>替换</p> 
<p>    Q_ASSERT(qVariantCanConvert&lt;QString&gt;(variant));</p> 
<p>    Q_ASSERT(qVariantCanConvert&lt;QSize&gt;(variant));</p> 
<p>    Q_ASSERT(qVariantCanConvert&lt;QFont&gt;(fontVariant));</p> 
<p>为</p> 
<p>    Q_ASSERT(variant.canConvert(QMetaType::QString));</p> 
<p>    Q_ASSERT(variant.canConvert(QMetaType::QSize));</p> 
<p>    Q_ASSERT(fontVariant.canConvert(QMetaType::QFont));</p> 
<p>11.删掉了Qt::escape </p> 
<p>    error: 'escape' is not a member of 'Qt'</p> 
<p>So you would change the following block:</p> 
<p>        if (result == QString())</p> 
<p>            result = Qt::escape(val.toString());</p> 
<p>        else</p> 
<p>            result = Qt::escape(result);</p> 
<p>        return result;</p> 
<p>to</p> 
<p>        if (result == QString())</p> 
<p>            result = QString(val.toString()).toHtmlEscaped();</p> 
<p>        else</p> 
<p>            result = QString(result).toHtmlEscaped();</p> 
<p>        return result;</p> 
<p>12.删掉了QDesktopServices::storageLocation </p> 
<p>    error: 'storageLocation' is not a member of 'QDesktopServices'</p> 
<p>    error: 'DataLocation' is not a member of 'QDesktopServices'</p> 
<p>用 QStandardPaths::StandardLocation代替，把如下</p> 
<p>    QString path = s.value("db.path", QDesktopServices::storageLocation(QDesktopServices::DataLocation)).toString();</p> 
<p>替换为</p> 
<p>    QString path = s.value("db.path", QStandardPaths::standardLocations(QStandardPaths::DataLocation)).toString();</p> 
<p>13.删掉了CONFIG+=qtestlib </p> 
<p>If you have the above line in your project file the compiler will warn you in the compile window, nonetheless the code will still run as usual:</p> 
<p>如果在工程文件中有上面这一行，编译器将在编译窗口中产生警告：</p> 
<p>    Project WARNING: CONFIG+=qtestlib is deprecated. Use QT+=testlib instead.</p> 
<p>14.QWeakPointer quirks</p> 
<p>A code block like</p> 
<p>    quint64 decodedPointer = line.toULongLong();</p> 
<p>    MetaData* md = reinterpret_cast&lt;MetaData*&gt;(decodedPointer);</p> 
<p>    QWeakPointer&lt;MetaData&gt; wp(md);</p> 
<p>results in</p> 
<p>    error: no matching function for call to 'QWeakPointer&lt;MetaData&gt;::QWeakPointer(MetaData*&amp;)'</p> 
<p>To fix this add to the project file:</p> 
<p>    DEFINES += QT_DISABLE_DEPRECATED_BEFORE=0</p> 
<p>15.QtConcurrent Library is Missing?</p> 
<p>    C:\Qt\Qt5.0.2\5.0.2\mingw47_32\include\QtConcurrent\qtconcurrentthreadengine.h:133: error: undefined reference to `_imp___ZN12QtConcurrent16ThreadEngineBaseD2Ev'</p> 
<p>In Qt 4, QtConcurrent was part of QtCore, so there was no need to include specific headers. This is no longer the case with Qt 5. If your source code have lines like</p> 
<p>    m_current = QtConcurrent::blockingMappedReduced(slices, functor, stitchReduce, QtConcurrent::UnorderedReduce );</p> 
<p>You will need to include the header:</p> 
<p>    #include &lt;QtConcurrent/QtConcurrent&gt;</p> 
<p>and add the following line to your project file:</p> 
<p>    LIBS += -lQt5Concurrent</p> 
<p>16.Fixing #include&lt;&gt; Headers</p> 
<p>A Perl script “fixqt4headers.pl” exists in qtbase/bin/. that should be run on source code using Qt that corrects the #include&lt;&gt; directives for Qt components to also consider the module name.</p> 
<p>17.Plugin loading</p> 
<p>The Q_EXPORT_PLUGIN,Q_EXPORT_PLUGIN2 macros have been deprecated in favor of the new Q_PLUGIN_METADATA macro. The advantage of the new system is that it allows Qt to query the metadata for the plugin without actually dlopen’ing it. This greatly improves performance and reliability of the plugin system.</p> 
<p>The new Q_PLUGIN_METADATA macro is included next to the Q_OBJECT macro in the QObject derived class that is returned when loading the plugin. It contains the plugins IID and a filename pointing to a json file containing the metadata for the plugin. The json file is compiled into the plugin and does not need to be installed.</p> 
<p>An example on how to change your plugins can be found by looking at the patch that changes the Gif p_w_picpath format plugin, see http://qt.gitorious.org/qt/qtbase/commit/963b4c1647299fd023ddbe7c4a25ac404e303c5d .</p> 
<p>18.Deploying to systems without C++11</p> 
<p>When Qt is built from source code on a system with C++11 installed, the Qt libraries/frameworks are linked against the system’s C++11 library (libc++). This means that the Qt libraries/frameworks are not deployable to systems without C++11 installed (such as out-of-the-box Mac OS X 10.6). To be able to deploy to systems that only support the older C++ standard (libstdc++), build Qt from source code with the -no-c++11 configure option.</p> 
<p>19.QTimer is no longer accurate to the millisecond by default</p> 
<p>QTimer has now 3 accuracy types, with a new default behaviour:</p> 
<p>    The new default type is Qt::CoarseTimer which, to reduce power/CPU consumption, allow 5% difference between requested time and actual one, and even allow the timer to fire before the requested time.</p> 
<p>    The former one is Qt::PreciseTimer (to the millisecond, never before the requested time).</p> 
<p>    A third one is Qt::VeryCoarseTimer and allow a 1 second difference</p> 
<p>20.QUrl addQueryItem moved to QUrlQuery</p> 
<p>If you have:</p> 
<p>    QUrl url;</p> 
<p>    // ...</p> 
<p>    url.addQueryItem(key, value);</p> 
<p>You will want to change it to</p> 
<p>    QUrl url;</p> 
<p>    QUrlQuery urlQuery;</p> 
<p>    // ...</p> 
<p>    urlQuery.addQueryItem(key, value);</p> 
<p>     </p> 
<p>    url.setUrlQuery(urlQuery);</p> 
<p>21.QAbstractItemModel changes</p> 
<p>    void reset()</p> 
<p>    void setRoleNames(const QHash&lt;int, QByteArray&gt; &amp; roleNames)</p> 
<p>both have changed and are now protected.</p> 
<p>See Compatibility Members for QAbstractItemModel [qt-project.org]</p> 
<p>Recommended Reading</p> 
<p>    C++ API Changes [qt-project.org]</p> 
<p>    The porting guide [qt-project.org]</p> 
<p>    Porting Desktop Applications from Qt 4 to Qt 5 [blog.ics.com]</p> 
<p>    Porting from Qt 4 to Qt 5 [kdab.com]</p> 
<p>    Automated porting from Qt 4 to Qt 5 [kdab.com]</p> 
<p>Categories:</p> 
<p>    Developing_Qt</p> 
<p>    Developing_with_Qt<br>  </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/29355d646543b612bf807956e365cbf4/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">现控报告-- 分析倒立摆系统稳定性、能控性及能观性分析，设计PID控制方案（附matlab）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f13fdc68fae569ded503b5a68198ec34/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">负反馈放大电路（附Multisim）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>