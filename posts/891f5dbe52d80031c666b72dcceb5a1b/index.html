<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Single Image Haze Removal Using Dark Channel Prior(暗通道先验) - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Single Image Haze Removal Using Dark Channel Prior(暗通道先验)" />
<meta property="og:description" content="去雾算法都会依赖于很强的先验以及假设，并结合相应的物理模型，完成去雾过程。本文作者何凯明及其团队通过大量的无雾图像和有雾图像，归纳总结出无雾图像在其对应的暗通道图像上具有极低的强度值（趋近于0），并结合如下公式：
求出透射率参数以及全球大气光值，进而轻松的求取无雾图像J。
1、暗通道先验是什么？ 暗通道先验是基于户外的的无雾图像总结归纳的，发现的一个普遍存在的现象就是：在大多数的非天空的图像块中，至少有一个图像通道的一些像素值是非常低且接近于0的。作者使用J_dark来表示暗通道图像，具体的计算公式如下所示：
上述公式可以知道，对于无雾图像y，求取其三通道对应像素为的最小值，并使用一个固定大小（15*15）的块去取其中最小的值即为当前像素的暗通道值。
下图很明显的展示了有雾与无雾图像的暗通道图像的差异：对于有雾图像（不考虑天空），暗通道图像偏白，也就是其强度值比较高，而对于无雾图像，暗通道图像整体偏黑，也就是其强度值比较低。
按照暗通道的定义就可以很清楚的知道：
上述公式就是本文的精髓暗通道先验，就是这么一个普普通通的经验总结，但是没有人想到。
作者在发现这个先验以后，还去做了很多的验证工作，其中就包括：
（1）随机选取5000张landscape&#43;cityscape场景的数据，在剪裁掉天空部分后，resize到最长边为500的图像，使用15*15的核区域去计算暗通道图像，统计其强度概率分布图、累积概率强度分布图、图像的强度分布图
得出的结论是：
1、We can see that about 75 percent of the pixels in the dark channels have zero values, and the intensity of 90 percent of the pixels is below 25
2、most dark channels have very low average intensity, showing that only a small portion of outdoor haze-free images deviate from our prior
2、使用暗通道先验进行去雾 2.1 估计透射参数t 假设全球大气光值A是一个常量，利用公式（1）进行归一化操作可得：
接着假设t在一个固定大小的块中是恒定值，并且在公式（7）的两边同时求取暗通道值：
对于无雾图像来说J趋近于0的：
因此可以得出：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/891f5dbe52d80031c666b72dcceb5a1b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-06T23:00:26+08:00" />
<meta property="article:modified_time" content="2023-11-06T23:00:26+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Single Image Haze Removal Using Dark Channel Prior(暗通道先验)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>去雾算法都会依赖于很强的先验以及假设，并结合相应的物理模型，完成去雾过程。本文作者何凯明及其团队通过大量的无雾图像和有雾图像，归纳总结出无雾图像在其对应的暗通道图像上具有极低的强度值（趋近于0），并结合如下公式：<br> <img src="https://images2.imgbox.com/21/62/DxYM2qvG_o.png" alt="在这里插入图片描述"><br> 求出透射率参数以及全球大气光值，进而轻松的求取无雾图像J。</p> 
<h3><a id="1_4"></a>1、暗通道先验是什么？</h3> 
<p>暗通道先验是基于户外的的无雾图像总结归纳的，发现的一个普遍存在的现象就是：在大多数的非天空的图像块中，至少有一个图像通道的一些像素值是非常低且接近于0的。作者使用J_dark来表示暗通道图像，具体的计算公式如下所示：<br> <img src="https://images2.imgbox.com/8e/27/d7NlRtaa_o.png" alt="在这里插入图片描述"><br> 上述公式可以知道，对于无雾图像y，求取其三通道对应像素为的最小值，并使用一个固定大小（15*15）的块去取其中最小的值即为当前像素的暗通道值。</p> 
<p>下图很明显的展示了有雾与无雾图像的暗通道图像的差异：对于有雾图像（不考虑天空），暗通道图像偏白，也就是其强度值比较高，而对于无雾图像，暗通道图像整体偏黑，也就是其强度值比较低。</p> 
<p><img src="https://images2.imgbox.com/57/02/xnwwyUcg_o.png" alt="在这里插入图片描述"><br> 按照暗通道的定义就可以很清楚的知道：<br> <img src="https://images2.imgbox.com/61/e8/2WWFZ5kd_o.png" alt="在这里插入图片描述"><br> 上述公式就是本文的<strong>精髓暗通道先验</strong>，就是这么一个普普通通的经验总结，但是没有人想到。<br> 作者在发现这个先验以后，还去做了很多的验证工作，其中就包括：<br> （1）随机选取5000张landscape+cityscape场景的数据，在剪裁掉天空部分后，resize到最长边为500的图像，使用15*15的核区域去计算暗通道图像，统计其强度概率分布图、累积概率强度分布图、图像的强度分布图</p> 
<p><img src="https://images2.imgbox.com/c0/ea/a87KZTe4_o.png" alt="在这里插入图片描述"><br> <strong>得出的结论是：</strong><br> 1、We can see that about 75 percent of the pixels in the dark channels have zero values, and the intensity of 90 percent of the pixels is below 25<br> 2、most dark channels have very low average intensity, showing that only a small portion of outdoor haze-free images deviate from our prior</p> 
<h3><a id="2_23"></a>2、使用暗通道先验进行去雾</h3> 
<h4><a id="21_t_24"></a>2.1 估计透射参数t</h4> 
<p>假设全球大气光值A是一个常量，利用公式（1）进行归一化操作可得：<br> <img src="https://images2.imgbox.com/c3/a7/ypaKHztR_o.png" alt="在这里插入图片描述"><br> 接着假设t在一个固定大小的块中是恒定值，并且在公式（7）的两边同时求取暗通道值：<br> <img src="https://images2.imgbox.com/fe/ef/BVVWvWmG_o.png" alt="在这里插入图片描述"><br> 对于无雾图像来说J趋近于0的：<br> <img src="https://images2.imgbox.com/5a/42/aNcIu9lQ_o.png" alt="在这里插入图片描述"><br> 因此可以得出：<br> <img src="https://images2.imgbox.com/c9/4c/LGfPFsqi_o.png" alt="在这里插入图片描述"><br> 通过上述几个公式联合求解可得：<br> <img src="https://images2.imgbox.com/bd/17/SAYFHKR1_o.png" alt="在这里插入图片描述"><br> 这里有一个特殊的点是：作者之前在讲解暗通道先验的时候排除了天空的干扰问题，但是通过公式（11）可以知道，对于有雾的天空而言，I和大气光参数A基本一致，因此：<br> <img src="https://images2.imgbox.com/19/52/qxSOQXh1_o.png" alt="在这里插入图片描述"><br> 对于天空来说t-&gt;0,说明对于天空来说，因为距离无限远，反射率基本等于0是完全合理的。因此作者很优雅的处理了暗通道中的非天空数据，不用特意将天空数据裁剪完成后方才进行暗通道计算。</p> 
<p>实际环境下，无论天气如何晴朗，都会存在一些颗粒和雾气，这种现象称为aerial perspective，如果我们直接移除雾气，会让去雾后的图像看起来非常不自然，因此需要保留一定的雾气，而这就导致反射率需要加一些补偿值：<br> <img src="https://images2.imgbox.com/cd/7e/JvlyECui_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="22_A_41"></a>2.2 估计大气光值A</h4> 
<p>作者依托于Tan的理论：有雾图像中最亮的像素点是最不透明的，这主要针对是阴霾而没有阳光的天气，在这种情况下，大气光是照明的唯一来源，因此每个通道的颜色场景亮度为：<br> <img src="https://images2.imgbox.com/b8/6b/Ff7rngNu_o.png" alt="在这里插入图片描述"><br> 同时公式（1）可以改写为：<br> <img src="https://images2.imgbox.com/8c/f9/cfBXUGTw_o.png" alt="在这里插入图片描述">当图像中的像素处于无线远的位置时，最亮点的像素时最haze-opaque的，可近似为A。但是实际经验告诉我们不能忽略阳光，因此在考虑阳光照射的情况下，公式（18），（19）就需要改写为：<br> <img src="https://images2.imgbox.com/a7/21/aYQXuXCk_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/40/9d/Mf9h1LYY_o.png" alt="在这里插入图片描述"><br> 因此，图像中最亮的像素点可以比大气光值A大，可能会出现在白色的小汽车或者白色建筑物上<br> <img src="https://images2.imgbox.com/50/b9/TaooJzRc_o.png" alt="在这里插入图片描述">依据暗通道先验，有雾图像的暗通道图表征其雾浓度，因此可以通过有雾图像的暗通道图来检测物浓度最大的区域，进而去提升大气光值的估计。<br> <strong>最终的方法是</strong>：首先获取图像的暗通道图，接着获取暗通道图中top 0.1%的的最亮像素点，然后选取暗通道图最亮像素点所对应的原始图像强度值最大的值作为大气光值。</p> 
<h4><a id="23__51"></a>2.3 图像重建</h4> 
<p>在得到大气光值A以及相应的透射率参数t以后，可以利用22式进行求解并获取相应的无雾图像。<br> <img src="https://images2.imgbox.com/91/8f/rPjOdmsf_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="24__54"></a>2.4 番外篇</h4> 
<p>由于透射参数t的求解比较粗暴，导致得到的t图比较粗糙，为了进行细腻处理，作者使用soft matting进行图像的refine，下图是对比：<br> <img src="https://images2.imgbox.com/0c/ec/uCRWf2CW_o.png" alt="在这里插入图片描述"><br> Soft matting的效果明显比直接求出的t值好很多，但是有一个致命的缺点是速度比较慢，因此在2010年何凯明使用引导滤波（guided filter）进行加速。</p> 
<h3><a id="3__59"></a>3 代码实现</h3> 
<h4><a id="31_60"></a>3.1暗通道图求解</h4> 
<p>暗通道图就是对图像的RGB三通道求取最小值，然后在用一个核去取最小值，当然简便的方法是构造一个核，直接使用腐蚀操作进行实现。</p> 
<pre><code class="prism language-python">	<span class="token keyword">def</span> <span class="token function">cal_Dark_Channel</span><span class="token punctuation">(</span>im<span class="token punctuation">,</span> width <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	    im_dark <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>im<span class="token punctuation">,</span> axis <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span>
	    border <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>width <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
	    im_dark_1 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>copyMakeBorder<span class="token punctuation">(</span>im_dark<span class="token punctuation">,</span> border<span class="token punctuation">,</span> border<span class="token punctuation">,</span> border<span class="token punctuation">,</span> border<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>BORDER_DEFAULT<span class="token punctuation">)</span>
	    res <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>np<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>im_dark<span class="token punctuation">)</span><span class="token punctuation">)</span>
	    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	            res<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>im_dark_1<span class="token punctuation">[</span>i<span class="token punctuation">:</span> i <span class="token operator">+</span> width<span class="token punctuation">,</span> j<span class="token punctuation">:</span> j <span class="token operator">+</span> width<span class="token punctuation">]</span><span class="token punctuation">)</span> 
    	<span class="token keyword">return</span> res
</code></pre> 
<h4><a id="32_A_75"></a>3.2 求解大气光值A</h4> 
<pre><code class="prism language-python">	<span class="token comment">#计算A参数, im为暗通道图像, img为原图</span>
	<span class="token keyword">def</span> <span class="token function">cal_Light_A</span><span class="token punctuation">(</span>im<span class="token punctuation">,</span> img<span class="token punctuation">)</span><span class="token punctuation">:</span>
	    
	    s_dict <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
	    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>im<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>im<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	            s_dict<span class="token punctuation">[</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> im<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span>
	        
	    s_dict <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>s_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>   
	    
	    A <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>
	    num <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>im<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> im<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">0.001</span><span class="token punctuation">)</span>
	    
	    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>s_dict<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>s_dict<span class="token punctuation">)</span> <span class="token operator">-</span> num <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	        
	        X_Y <span class="token operator">=</span> s_dict<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
	        A <span class="token operator">=</span> np<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span>A<span class="token punctuation">,</span> img<span class="token punctuation">[</span>X_Y<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> X_Y<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	
	    <span class="token keyword">return</span> A

</code></pre> 
<h4><a id="33_t_99"></a>3.3 反射率参数t</h4> 
<pre><code class="prism language-python">	<span class="token keyword">def</span> <span class="token function">cal_trans</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> img<span class="token punctuation">,</span> w <span class="token operator">=</span> <span class="token number">0.95</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	    
	    dark <span class="token operator">=</span> cal_Dark_Channel<span class="token punctuation">(</span>img <span class="token operator">/</span> A<span class="token punctuation">)</span>
	    t <span class="token operator">=</span> np<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> w <span class="token operator">*</span> dark<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	    
    <span class="token keyword">return</span> t
</code></pre> 
<h4><a id="34_t_109"></a>3.4 使用引导滤波进行优化t</h4> 
<pre><code class="prism language-python">	<span class="token keyword">def</span> <span class="token function">Guided_filtering</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> img_gray<span class="token punctuation">,</span> width<span class="token punctuation">,</span> sigma <span class="token operator">=</span> <span class="token number">0.0001</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	    
	    mean_I <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>np<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>img_gray<span class="token punctuation">)</span><span class="token punctuation">)</span>
	    cv2<span class="token punctuation">.</span>boxFilter<span class="token punctuation">(</span>img_gray<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>width<span class="token punctuation">,</span> width<span class="token punctuation">)</span><span class="token punctuation">,</span> mean_I<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>BORDER_DEFAULT<span class="token punctuation">)</span>
	    mean_t <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>np<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span>
	    cv2<span class="token punctuation">.</span>boxFilter<span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>width<span class="token punctuation">,</span> width<span class="token punctuation">)</span><span class="token punctuation">,</span> mean_t<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>BORDER_DEFAULT<span class="token punctuation">)</span>
	    corr_I <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>np<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>img_gray<span class="token punctuation">)</span><span class="token punctuation">)</span>
	    cv2<span class="token punctuation">.</span>boxFilter<span class="token punctuation">(</span>img_gray <span class="token operator">*</span> img_gray<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>width<span class="token punctuation">,</span> width<span class="token punctuation">)</span><span class="token punctuation">,</span> corr_I<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>BORDER_DEFAULT<span class="token punctuation">)</span>
	    corr_IT <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>np<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span>
	    cv2<span class="token punctuation">.</span>boxFilter<span class="token punctuation">(</span>img_gray <span class="token operator">*</span> t<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>width<span class="token punctuation">,</span> width<span class="token punctuation">)</span><span class="token punctuation">,</span> corr_IT<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>BORDER_DEFAULT<span class="token punctuation">)</span>
	    
	    var_I <span class="token operator">=</span> corr_I <span class="token operator">-</span> mean_I <span class="token operator">*</span> mean_I
	    cov_IT <span class="token operator">=</span> corr_IT <span class="token operator">-</span> mean_I <span class="token operator">*</span> mean_t
	
	    a <span class="token operator">=</span> cov_IT <span class="token operator">/</span> <span class="token punctuation">(</span>var_I <span class="token operator">+</span> sigma<span class="token punctuation">)</span>    
	    b <span class="token operator">=</span> mean_t <span class="token operator">-</span> a <span class="token operator">*</span> mean_I
	    
	    mean_a <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>np<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>
	    mean_b <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>np<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span>
	    cv2<span class="token punctuation">.</span>boxFilter<span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>width<span class="token punctuation">,</span> width<span class="token punctuation">)</span><span class="token punctuation">,</span> mean_a<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>BORDER_DEFAULT<span class="token punctuation">)</span>
	    cv2<span class="token punctuation">.</span>boxFilter<span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>width<span class="token punctuation">,</span> width<span class="token punctuation">)</span><span class="token punctuation">,</span> mean_b<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>BORDER_DEFAULT<span class="token punctuation">)</span>
	    
	    <span class="token keyword">return</span> mean_a <span class="token operator">*</span> img_gray <span class="token operator">+</span> mean_b
	

</code></pre> 
<h4><a id="35__138"></a>3.5 图像恢复</h4> 
<pre><code class="prism language-python">	<span class="token keyword">def</span> <span class="token function">harz_Rec</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> img<span class="token punctuation">,</span> t<span class="token punctuation">,</span> t0 <span class="token operator">=</span> <span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	    
	    img_o <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>np<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">)</span>
	    
	    img_o<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>img<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> A<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>np<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span>t<span class="token punctuation">,</span> t0<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> A<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
	    img_o<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>img<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> A<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>np<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span>t<span class="token punctuation">,</span> t0<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> A<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
	    img_o<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>img<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> A<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>np<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span>t<span class="token punctuation">,</span> t0<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> A<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
	
    <span class="token keyword">return</span> img_o
</code></pre> 
<h3><a id="_152"></a>参考文献</h3> 
<p><a href="https://www.guyuehome.com/39850" rel="nofollow">走出寂静岭！暗通道先验的python实现</a><br> <a href="https://github.com/vaeahc/Dark_Channel_Prior/blob/master/Dark_Channel_Prior.py">https://github.com/vaeahc/Dark_Channel_Prior/blob/master/Dark_Channel_Prior.py</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d96b71501f455c3861c6bf5e2596e315/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">《现代C&#43;&#43;语言核心特性解析》笔记（一）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/73d3f97bffe03061a222561d6b0b4de7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Ubuntu16.03配置、安装及运行ORB-SLAM3(含遇到的坑与注意事项)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>