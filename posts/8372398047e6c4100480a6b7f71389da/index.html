<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>DeepLabV3&#43;模型训练全过程 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="DeepLabV3&#43;模型训练全过程" />
<meta property="og:description" content="一、DeepLabV3&#43;介绍 Deeplabv3&#43;模型是由谷歌在2021年提出来的一个用于语义分割的模型，它可以进行多分类语义分割也可以进行实例分割，在公共数据集PASCAL VOC 2012和Cityscapes上达到了89.0%及82.1%的精度，同时也是一个较为轻便的模型，因此Deeplabv3&#43;是一个兼具了速度和精度的模型。此次，我选用了resnet101为主干模型的DeeplapV3&#43;。
二、数据集制作： 1）首先把图片和json文件分开，自己编写代码。
# coding:utf-8 import os import random import argparse import shutil &#39;&#39;&#39; 把一个文件夹中的图片和json文件按照比例分为训练集和测试集 &#39;&#39;&#39; def split1(path,trainPath,testPath): trainval_percent = 1.0 train_percent = 0.8 total_path = os.listdir(path) num = len(total_path) list_index = range(num) tv = int(num * trainval_percent) tr = int(tv * train_percent) trainval = random.sample(list_index, tv) train = random.sample(trainval, tr) print(&#34;训练集数量：&#34;,len(train)) print(&#34;测试集数量：&#34;,len(total_path)- len(train)) for i in list_index: old_jpg_path = path &#43; total_path[i] name = total_path[i].split(&#34;.&#34;)[0] old_json_path = path &#43; name &#43; &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/8372398047e6c4100480a6b7f71389da/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-29T16:11:53+08:00" />
<meta property="article:modified_time" content="2023-08-29T16:11:53+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">DeepLabV3&#43;模型训练全过程</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h3 style="text-align:left;"><strong><strong><strong>一、DeepLabV3+介绍</strong></strong></strong></h3> 
<p style="margin-left:.0001pt;text-align:left;">Deeplabv3+模型是由谷歌在2021年提出来的一个用于语义分割的模型，它可以进行多分类语义分割也可以进行实例分割，在公共数据集PASCAL VOC 2012和Cityscapes上达到了89.0%及82.1%的精度，同时也是一个较为轻便的模型，因此Deeplabv3+是一个兼具了速度和精度的模型。此次，我选用了resnet101为主干模型的DeeplapV3+。</p> 
<h3 style="text-align:left;"><strong><strong><strong>二、</strong></strong><strong><strong>数据集制作：</strong></strong></strong></h3> 
<p style="text-align:left;">1）首先把图片和json文件分开，自己编写代码。</p> 
<pre><code class="hljs"># coding:utf-8
import os
import random
import argparse
import shutil
'''
把一个文件夹中的图片和json文件按照比例分为训练集和测试集
'''

def split1(path,trainPath,testPath):
    trainval_percent = 1.0
    train_percent = 0.8

    total_path = os.listdir(path)
    num = len(total_path)
    list_index = range(num)
    tv = int(num * trainval_percent)
    tr = int(tv * train_percent)
    trainval = random.sample(list_index, tv)
    train = random.sample(trainval, tr)
    print("训练集数量：",len(train))
    print("测试集数量：",len(total_path)- len(train))

    for i in list_index:
        old_jpg_path = path + total_path[i]
        name = total_path[i].split(".")[0]
        old_json_path = path + name + ".json"
        if i in train:
            new_jpg_path = trainPath + total_path[i]
            new_json_path = trainPath + name + ".json"
            print("___",old_jpg_path,old_json_path,"----",new_jpg_path,new_json_path)
            
        else:
            new_jpg_path = testPath + total_path[i]
            new_json_path = testPath + name + ".json"
            print(old_jpg_path,old_json_path,"----",new_jpg_path,new_json_path)
        shutil.copyfile(old_jpg_path, new_jpg_path)
        shutil.copyfile(old_json_path, new_json_path)
            

if __name__ == "__main__":

   split1(r"F:\xinda\datasets\stone\22\JPEGImages\\",r"F:\xinda\datasets\stone\22\coco\train2014\\",r"F:\xinda\datasets\stone\22\coco\val2014\\")
</code></pre> 
<p style="margin-left:.0001pt;text-align:left;">2）将json文件转成PNG图</p> 
<p style="margin-left:.0001pt;text-align:left;">参考：<a href="https://blog.csdn.net/qq_42930154/article/details/123121779" title="labelme批量json转png数据集教程_this script is aimed to demonstrate how to convert_脱发小白龙的博客-CSDN博客">labelme批量json转png数据集教程_this script is aimed to demonstrate how to convert_脱发小白龙的博客-CSDN博客</a></p> 
<p style="margin-left:.0001pt;text-align:left;">转成功以后，每个图是在不同的文件夹，如下图。所以需要把所有的图放到同一个文件夹下，自己编写代码。</p> 
<p style="margin-left:.0001pt;text-align:left;"><img alt="" height="130" src="https://images2.imgbox.com/6e/5e/0bvm0fNx_o.png" width="456"> </p> 
<pre><code class="hljs">import cv2
import shutil
import os
'''
把生成的每个掩模图放到同一个文件夹中
'''

def leave(path,imagesPath):
    imgList = os.listdir(path)
    for i in imgList:
        imageName= i.split("_json")[0]
        old_path = path + i + "\\label.png"
        new_path = imagesPath + imageName + ".png"
        print(old_path)
        shutil.copyfile(old_path, new_path) # 复制图片


if __name__ == "__main__":
    path1 = "F:\\xinda\\datasets\\stone\\22\\json1\\json_data\\"
    leave(path1,"F:\\xinda\\datasets\\stone\\22\\json1\\mask\\")</code></pre> 
<p style="margin-left:.0001pt;text-align:left;"></p> 
<p style="margin-left:.0001pt;text-align:left;">3）将待训练的所有jpg图片全部放入JPEGImages文件夹中，将所有png图片全部放入SegmentationClass文件夹中。</p> 
<p style="margin-left:.0001pt;text-align:left;">4）在ImageSets文件夹中新建Segmentation文件夹，在Segmentatin文件夹中新建train.txt ，val.txt 和 trainval.txt。然后将要数据集中的图片，按照一定的比例分为训练集和验证集，将训练集和验证集的图片的名字写入对应的txt文件中就可以了。具体形式如下图：</p> 
<p style="margin-left:.0001pt;text-align:left;"><img alt="" height="126" src="https://images2.imgbox.com/2d/52/Rx6IW5Fr_o.png" width="344"> </p> 
<p style="margin-left:.0001pt;text-align:left;"></p> 
<ul><li style="text-align:left;"><strong><strong><strong>环境配置</strong></strong></strong></li></ul> 
<p style="margin-left:.0001pt;text-align:justify;">硬件环境：RTX3090</p> 
<p style="margin-left:.0001pt;text-align:justify;">所需包如下：torch==2.0.1</p> 
<p style="margin-left:.0001pt;text-align:justify;">Torchvision==0.15.2</p> 
<p style="margin-left:.0001pt;text-align:justify;">Numpy==1.24.3</p> 
<p style="margin-left:.0001pt;text-align:justify;">Pillow==9.2.0</p> 
<p style="margin-left:.0001pt;text-align:justify;">scikit-learn==1.3.0</p> 
<p style="margin-left:.0001pt;text-align:justify;">Tqdm==4.65.0</p> 
<p style="margin-left:.0001pt;text-align:justify;">Matplotlib==3.2.2</p> 
<p style="margin-left:.0001pt;text-align:justify;">Visdom==0.2.4</p> 
<ul><li style="text-align:left;"><strong><strong><strong>模型</strong></strong><strong><strong>训练</strong></strong></strong></li></ul> 
<p style="margin-left:.0001pt;text-align:left;"><strong><strong>代码地址：</strong></strong></p> 
<p style="margin-left:.0001pt;text-align:left;"><u><span style="color:#0000ff;"><u>https://github.com/VainF/DeepLabV3Plus-Pytorch</u></span></u></p> 
<p style="margin-left:.0001pt;text-align:left;">参考博客：</p> 
<p style="margin-left:.0001pt;text-align:left;"><a href="https://blog.csdn.net/weixin_46118817/article/details/125121751" title="【图像语义分割】DeepLabv3+(Pytorch版) 源码复现—Kitti数据集_kitti语义分割数据集_Duuu7的博客-CSDN博客">【图像语义分割】DeepLabv3+(Pytorch版) 源码复现—Kitti数据集_kitti语义分割数据集_Duuu7的博客-CSDN博客</a></p> 
<p style="margin-left:.0001pt;text-align:left;"><a href="https://blog.csdn.net/persist_ence/article/details/130643419" title="多分类影像分割（语义分割）模型 DeepLabV3_plus pytorch版本 深度学习模型复现 网络配置及训练自己的数据集_persist_ence的博客-CSDN博客">多分类影像分割（语义分割）模型 DeepLabV3_plus pytorch版本 深度学习模型复现 网络配置及训练自己的数据集_persist_ence的博客-CSDN博客</a></p> 
<p style="margin-left:.0001pt;text-align:left;"><strong><strong>官方权重进行</strong></strong><strong><strong>测试：</strong></strong></p> 
<p style="margin-left:.0001pt;text-align:left;">命令行：</p> 
<pre><code class="hljs">python predict.py --input testImg11 --dataset voc --model deeplabv3plus_resnet101 --ckpt checkpoints/best_deeplabv3plus_resnet101_voc_os16.pth --save_val_results_to test_results</code></pre> 
<p style="margin-left:.0001pt;text-align:left;">注意：不同的预训练权重对应不同的数据集和模型，一定要对应好，否则会报错。下面这条语句对应的数据集是voc，模型是deeplabv3plus_resnet101。</p> 
<p style="margin-left:.0001pt;text-align:left;"><strong>训练的命令行：</strong></p> 
<pre><code class="hljs">python main.py --model deeplabv3plus_resnet101 --gpu_id 0 --year 2012 --crop_val --lr 0.01 --crop_size 513 --batch_size 16 --output_stride 16</code></pre> 
<p style="margin-left:.0001pt;text-align:left;"><strong><strong>步骤</strong></strong><strong><strong>：</strong></strong></p> 
<p style="margin-left:.0001pt;text-align:left;">1）可视化在服务器上实现不了，数据集格式要和给的格式一样，例如：</p> 
<p style="margin-left:.0001pt;text-align:left;"><img alt="" height="126" src="https://images2.imgbox.com/79/39/EpaUN6nN_o.png" width="344"></p> 
<p style="margin-left:.0001pt;text-align:left;"></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">2）然后修改main.py 里面的data_root为下载的数据集的路径，这里我用的相对路径“./datasets/data”。</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><img alt="" height="68" src="https://images2.imgbox.com/9c/51/61PFXYnv_o.png" width="629"> </p> 
<p style="margin-left:.0001pt;text-align:left;"></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">3）</span></span><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">设置好输入数据之后就可以点击运行main.py了。如果有报错的话，可以试试是不是需要</span></span><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">去掉</span></span>--enable_vis --vis_port 28333<span style="background-color:#ffffff;"><span style="color:#4d4d4d;">。</span></span><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">加了以后报错，无法使用port 28333，换成其他的port也不行，所以不加这两条。</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">4）加预训练模型或者模型中断之后接着训练。</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">如果模型中断，需要接着上面的继续训练或者添加别人训练好的预训练模型，需要修改“ckpt”，将其修改为你存储模型的那个路径，我这里是用的相对路径“./checkpoints/best_deeplabv3plus_xception_voc_os16.pth”，然后修改“continue_training”为“True”。然后运行main.py就可以了。</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><img alt="" height="149" src="https://images2.imgbox.com/49/0a/OOVmMqvp_o.png" width="1200"></p> 
<p style="margin-left:.0001pt;text-align:left;"><strong><strong>训练效果如下：</strong></strong></p> 
<p style="margin-left:.0001pt;text-align:left;"><img alt="" height="321" src="https://images2.imgbox.com/dd/35/HvulKmsd_o.png" width="594"> </p> 
<p style="margin-left:.0001pt;text-align:left;"></p> 
<p style="margin-left:.0001pt;text-align:left;"></p> 
<h3 style="text-align:left;"><strong><strong><strong>四、</strong></strong><strong><strong>模型推理：</strong></strong></strong></h3> 
<p style="margin-left:.0001pt;text-align:left;">命令行：</p> 
<pre><code class="hljs">python predict.py --input testImg --dataset voc --model deeplabv3plus_resnet101 --ckpt best_deeplabv3plus_resnet101_voc_os16.pth --save_val_results_to test_results</code></pre> 
<p style="margin-left:.0001pt;text-align:left;">模型推理或者模型预测用到的是predict.py。</p> 
<p style="margin-left:.0001pt;text-align:left;">需要修改以下几个参数：</p> 
<p style="margin-left:.0001pt;text-align:left;">"input"修改为自己的要预测的数据的路径；</p> 
<p style="margin-left:.0001pt;text-align:left;">"save_val_results_to"修改为自己要存放的预测结果的路径；默认保存在test_results文件夹中了。</p> 
<p style="margin-left:.0001pt;text-align:left;">"ckpt"修改为自己训练好的模型的路径。</p> 
<p style="margin-left:.0001pt;text-align:left;"></p> 
<p style="margin-left:.0001pt;text-align:left;"></p> 
<p style="margin-left:.0001pt;text-align:left;"></p> 
<p style="margin-left:.0001pt;text-align:left;"><strong><strong>推理效果如下：</strong></strong></p> 
<p style="margin-left:.0001pt;text-align:left;"><img alt="" height="310" src="https://images2.imgbox.com/cc/38/O9Fxxxnj_o.png" width="554"> </p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><strong><strong>遇到的问题及解决措施：</strong></strong></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<ol><li style="text-align:justify;">刚开始找了一个版本的deeplabV3+的代码，但是推理和训练都出现报错，无法解决，所以找了另一个版本的代码。</li><li style="text-align:justify;">把json文件转成PNG图片时，转换失败。</li></ol> 
<p style="margin-left:.0001pt;text-align:justify;">解决办法：把labelme包中的<span style="background-color:#ffffff;"><span style="color:#4d4d4d;">labelme_json_to_dataset</span></span><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">.</span></span><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">p</span></span><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">y</span></span>替换掉，再执行另一段代码。</p> 
<p style="margin-left:.0001pt;text-align:justify;">参考：<a href="https://blog.csdn.net/qq_42930154/article/details/123121779" title="labelme批量json转png数据集教程_this script is aimed to demonstrate how to convert_脱发小白龙的博客-CSDN博客">labelme批量json转png数据集教程_this script is aimed to demonstrate how to convert_脱发小白龙的博客-CSDN博客</a></p> 
<ol><li style="text-align:justify;">转换后的PNG图片分别在不同的文件夹中</li></ol> 
<p style="margin-left:.0001pt;text-align:justify;">解决办法：自己编写一段代码，把图片复制到同一个文件夹中。</p> 
<ol><li style="text-align:justify;">进行官方推理时，权重和模型没有对应上，导致推理失败。经过修改模型参数，就能执行成功了。</li><li style="text-align:justify;">训练时，串口无法使用。</li></ol> 
<p style="margin-left:.0001pt;text-align:justify;">解决措施：不采用可视化。</p> 
<ol><li style="text-align:justify;">推理时，生成的是掩模图，不是掩模图和原图的结合。</li></ol> 
<p style="margin-left:.0001pt;text-align:justify;">解决措施：使用cv2.addWeighted()函数，将二者相加，生成结合后的图。</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/efeac9dbf2f7833c732ef56388ddb402/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">windows系统下载配置mysql免安装版</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/49250b26ca8798762ad813a5c379ba0a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">NetCore下WebApi的后台服务BackgroundService</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>