<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Kafka/Spark消费topic到写出到topic - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Kafka/Spark消费topic到写出到topic" />
<meta property="og:description" content="1 Kafka的工具类 1.1 从kafka消费数据的方法 消费者代码 def getKafkaDStream(ssc : StreamingContext , topic: String , groupId:String ) ={ consumerConfigs.put(ConsumerConfig.GROUP_ID_CONFIG , groupId) val kafkaDStream: InputDStream[ConsumerRecord[String, String]] = KafkaUtils.createDirectStream(ssc, LocationStrategies.PreferConsistent, ConsumerStrategies.Subscribe[String, String](Array(topic), consumerConfigs)) kafkaDStream } 注意点 consumerConfigs是定义的可变的map的类型的，具体如下 private val consumerConfigs: mutable.Map[String, Object] = mutable.Map[String,Object]( // kafka集群位置 ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG -&gt; MyPropsUtils(MyConfig.KAFKA_BOOTSTRAP_SERVERS), // kv反序列化器 ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG -&gt; &#34;org.apache.kafka.common.serialization.StringDeserializer&#34;, ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG -&gt; &#34;org.apache.kafka.common.serialization.StringDeserializer&#34;, // groupId // offset提交 自动 手动 ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG -&gt; &#34;true&#34;, //自动提交的时间间隔 //ConsumerConfig.AUTO_COMMIT_INTERVAL_MS_CONFIG // offset重置 &#34;latest&#34; &#34;earliest&#34; ConsumerConfig.AUTO_OFFSET_RESET_CONFIG -&gt; &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/80caa91764709b1067061709380c898f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-17T22:44:46+08:00" />
<meta property="article:modified_time" content="2023-09-17T22:44:46+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Kafka/Spark消费topic到写出到topic</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="1_Kafka_0"></a>1 Kafka的工具类</h2> 
<h3><a id="11_kafka_2"></a>1.1 从kafka消费数据的方法</h3> 
<ol><li>消费者代码</li></ol> 
<pre><code class="prism language-scala">  <span class="token keyword">def</span> getKafkaDStream<span class="token punctuation">(</span>ssc <span class="token operator">:</span> StreamingContext <span class="token punctuation">,</span> topic<span class="token operator">:</span> <span class="token builtin">String</span>  <span class="token punctuation">,</span> groupId<span class="token operator">:</span><span class="token builtin">String</span>  <span class="token punctuation">)</span> <span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
    consumerConfigs<span class="token punctuation">.</span>put<span class="token punctuation">(</span>ConsumerConfig<span class="token punctuation">.</span>GROUP_ID_CONFIG <span class="token punctuation">,</span> groupId<span class="token punctuation">)</span>

    <span class="token keyword">val</span> kafkaDStream<span class="token operator">:</span> InputDStream<span class="token punctuation">[</span>ConsumerRecord<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> KafkaUtils<span class="token punctuation">.</span>createDirectStream<span class="token punctuation">(</span>ssc<span class="token punctuation">,</span>
      LocationStrategies<span class="token punctuation">.</span>PreferConsistent<span class="token punctuation">,</span>
      ConsumerStrategies<span class="token punctuation">.</span>Subscribe<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>Array<span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">,</span> consumerConfigs<span class="token punctuation">)</span><span class="token punctuation">)</span>
    kafkaDStream
  <span class="token punctuation">}</span>
</code></pre> 
<ol start="2"><li>注意点</li></ol> 
<ul><li>consumerConfigs是定义的可变的map的类型的，具体如下</li></ul> 
<pre><code class="prism language-scala"><span class="token keyword">private</span> <span class="token keyword">val</span> consumerConfigs<span class="token operator">:</span> mutable<span class="token punctuation">.</span>Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> Object<span class="token punctuation">]</span> <span class="token operator">=</span> mutable<span class="token punctuation">.</span>Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span>Object<span class="token punctuation">]</span><span class="token punctuation">(</span>
    <span class="token comment">// kafka集群位置</span>

    ConsumerConfig<span class="token punctuation">.</span>BOOTSTRAP_SERVERS_CONFIG <span class="token operator">-&gt;</span> MyPropsUtils<span class="token punctuation">(</span>MyConfig<span class="token punctuation">.</span>KAFKA_BOOTSTRAP_SERVERS<span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">// kv反序列化器</span>
    ConsumerConfig<span class="token punctuation">.</span>KEY_DESERIALIZER_CLASS_CONFIG <span class="token operator">-&gt;</span> <span class="token string">"org.apache.kafka.common.serialization.StringDeserializer"</span><span class="token punctuation">,</span>
    ConsumerConfig<span class="token punctuation">.</span>VALUE_DESERIALIZER_CLASS_CONFIG <span class="token operator">-&gt;</span> <span class="token string">"org.apache.kafka.common.serialization.StringDeserializer"</span><span class="token punctuation">,</span>
    <span class="token comment">// groupId</span>
    <span class="token comment">// offset提交  自动 手动</span>
    ConsumerConfig<span class="token punctuation">.</span>ENABLE_AUTO_COMMIT_CONFIG <span class="token operator">-&gt;</span> <span class="token string">"true"</span><span class="token punctuation">,</span>
    <span class="token comment">//自动提交的时间间隔</span>
    <span class="token comment">//ConsumerConfig.AUTO_COMMIT_INTERVAL_MS_CONFIG</span>
    <span class="token comment">// offset重置  "latest"  "earliest"</span>
    ConsumerConfig<span class="token punctuation">.</span>AUTO_OFFSET_RESET_CONFIG <span class="token operator">-&gt;</span> <span class="token string">"latest"</span>
    <span class="token comment">// .....</span>
  <span class="token punctuation">)</span>
</code></pre> 
<ul><li> <p>consumerConfigs.put(ConsumerConfig.GROUP_ID_CONFIG , groupId)是为了不限制groupId特意写的传参</p> </li><li> <p>是使用自带的kafka工具类createDirectStream方法去消费kafak 的数据，详细参数解释如下</p> </li></ul> 
<pre><code class="prism language-scala">在`KafkaUtils<span class="token punctuation">.</span>createDirectStream`方法中，后续传递的参数的含义如下：

<span class="token number">1.</span> `ssc`：这是一个`StreamingContext`对象，用于指定Spark Streaming的上下文。
<span class="token number">2.</span> `LocationStrategies<span class="token punctuation">.</span>PreferConsistent`：这是一个位置策略，用于指定Kafka消费者的位置策略。`PreferConsistent`表示优先选择分区分布均匀的消费者。
<span class="token number">3.</span> `ConsumerStrategies<span class="token punctuation">.</span>Subscribe<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span>`：这是一个消费者策略，用于指定Kafka消费者的订阅策略。`Subscribe<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span>`表示按照指定的泛型主题字符串数组订阅消息，键和值的类型都为`<span class="token builtin">String</span>`。
<span class="token number">4.</span> `Array<span class="token punctuation">(</span>topic<span class="token punctuation">)</span>`：这是一个字符串数组，用于指定要订阅的Kafka主题。
<span class="token number">5.</span> `consumerConfigs`：这是一个`java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Properties`类型的对象，其中配置了一些Kafka消费者的属性。

总之，在`KafkaUtils<span class="token punctuation">.</span>createDirectStream`方法中，这些参数组合被用于创建一个Kafka直连流（Direct Stream），该流可以直接从Kafka主题中消费消息，并将其转换为`InputDStream<span class="token punctuation">[</span>ConsumerRecord<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">]</span>`类型的DStream。

</code></pre> 
<p><img src="https://images2.imgbox.com/2f/75/zMtXqHAs_o.png" alt="在这里插入图片描述"></p> 
<ul><li>Subscribe传参需要指定泛型，这边指定string，表示指定主题的键和值的类型，即Array(topic), consumerConfigs传参是string</li></ul> 
<p><img src="https://images2.imgbox.com/9e/65/BKT2qkoL_o.png" alt="在这里插入图片描述"></p> 
<ul><li>最后方法返回一个kafkaDStream</li></ul> 
<h3><a id="12_kafka_68"></a>1.2 kafka的生产数据的方法</h3> 
<ol><li>生产者代码</li></ol> 
<ul><li>创建与配置</li></ul> 
<pre><code class="prism language-scala"><span class="token comment">/**
    * 生产者对象
    */</span>
  <span class="token keyword">val</span> producer <span class="token operator">:</span> KafkaProducer<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> createProducer<span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment">/**
    * 创建生产者对象
    */</span>
  <span class="token keyword">def</span> createProducer<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>KafkaProducer<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">val</span> producerConfigs<span class="token operator">:</span> util<span class="token punctuation">.</span>HashMap<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">AnyRef</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> util<span class="token punctuation">.</span>HashMap<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">AnyRef</span><span class="token punctuation">]</span>
    <span class="token comment">//生产者配置类 ProducerConfig</span>
    <span class="token comment">//kafka集群位置</span>
    <span class="token comment">//producerConfigs.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG,"hadoop102:9092,hadoop103:9092,hadoop104:9092")</span>
    <span class="token comment">//producerConfigs.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG,MyPropsUtils("kafka.bootstrap-servers"))</span>
    producerConfigs<span class="token punctuation">.</span>put<span class="token punctuation">(</span>ProducerConfig<span class="token punctuation">.</span>BOOTSTRAP_SERVERS_CONFIG<span class="token punctuation">,</span>MyPropsUtils<span class="token punctuation">(</span>MyConfig<span class="token punctuation">.</span>KAFKA_BOOTSTRAP_SERVERS<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//kv序列化器</span>
    producerConfigs<span class="token punctuation">.</span>put<span class="token punctuation">(</span>ProducerConfig<span class="token punctuation">.</span>KEY_SERIALIZER_CLASS_CONFIG <span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringSerializer"</span><span class="token punctuation">)</span>
    producerConfigs<span class="token punctuation">.</span>put<span class="token punctuation">(</span>ProducerConfig<span class="token punctuation">.</span>VALUE_SERIALIZER_CLASS_CONFIG <span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringSerializer"</span><span class="token punctuation">)</span>
    <span class="token comment">//acks</span>
    producerConfigs<span class="token punctuation">.</span>put<span class="token punctuation">(</span>ProducerConfig<span class="token punctuation">.</span>ACKS_CONFIG <span class="token punctuation">,</span> <span class="token string">"all"</span><span class="token punctuation">)</span>
    <span class="token comment">//batch.size  16kb</span>
    <span class="token comment">//linger.ms   0</span>
    <span class="token comment">//retries</span>
    <span class="token comment">//幂等配置</span>
    producerConfigs<span class="token punctuation">.</span>put<span class="token punctuation">(</span>ProducerConfig<span class="token punctuation">.</span>ENABLE_IDEMPOTENCE_CONFIG <span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span>

    <span class="token keyword">val</span> producer<span class="token operator">:</span> KafkaProducer<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> KafkaProducer<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>producerConfigs<span class="token punctuation">)</span>
    producer
  <span class="token punctuation">}</span>
</code></pre> 
<ul><li>生产方法</li></ul> 
<pre><code class="prism language-scala">  <span class="token comment">/**
    * 生产（按照默认的黏性分区策略）
    */</span>
  <span class="token keyword">def</span> send<span class="token punctuation">(</span>topic <span class="token operator">:</span> <span class="token builtin">String</span>  <span class="token punctuation">,</span> msg <span class="token operator">:</span> <span class="token builtin">String</span> <span class="token punctuation">)</span><span class="token operator">:</span><span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    producer<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token keyword">new</span> ProducerRecord<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>topic <span class="token punctuation">,</span> msg <span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**或者！
    * 生产（按照key进行分区）
    */</span>
  <span class="token keyword">def</span> send<span class="token punctuation">(</span>topic <span class="token operator">:</span> <span class="token builtin">String</span>  <span class="token punctuation">,</span> key <span class="token operator">:</span> <span class="token builtin">String</span> <span class="token punctuation">,</span>  msg <span class="token operator">:</span> <span class="token builtin">String</span> <span class="token punctuation">)</span><span class="token operator">:</span><span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    producer<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token keyword">new</span> ProducerRecord<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>topic <span class="token punctuation">,</span> key <span class="token punctuation">,</span>  msg <span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre> 
<ul><li>关闭生产</li></ul> 
<pre><code class="prism language-scala"><span class="token comment">/**
    * 关闭生产者对象
    */</span>
  <span class="token keyword">def</span> close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>producer <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token punctuation">)</span> producer<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
    * 刷写 ，将缓冲区的数据刷写到磁盘
    *
    */</span>
  <span class="token keyword">def</span> flush<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
    producer<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre> 
<h2><a id="2__143"></a>2 消费数据</h2> 
<h3><a id="21__145"></a>2.1 消费到数据</h3> 
<p>单纯的使用返回的ConsumerRecord不支持序列化，没有实现序列化接口</p> 
<p><img src="https://images2.imgbox.com/95/33/hfXItNHM_o.png" alt="在这里插入图片描述"></p> 
<p>因此需要转换成通用的jsonobject对象</p> 
<pre><code class="prism language-scala"><span class="token comment">//3. 处理数据</span>
    <span class="token comment">//3.1 转换数据结构</span>
    <span class="token keyword">val</span> jsonObjDStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span>JSONObject<span class="token punctuation">]</span> <span class="token operator">=</span> offsetRangesDStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>
      consumerRecord <span class="token keyword">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//获取ConsumerRecord中的value,value就是日志数据</span>
        <span class="token keyword">val</span> log<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> consumerRecord<span class="token punctuation">.</span>value<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">//转换成Json对象</span>
        <span class="token keyword">val</span> jsonObj<span class="token operator">:</span> JSONObject <span class="token operator">=</span> JSON<span class="token punctuation">.</span>parseObject<span class="token punctuation">(</span>log<span class="token punctuation">)</span>
        <span class="token comment">//返回</span>
        jsonObj
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
</code></pre> 
<h3><a id="22_topic_171"></a>2.2 数据分流发送到对应topic</h3> 
<ol><li>提取错误数据并发送到对应的topic中</li></ol> 
<pre><code class="prism language-scala">jsonObjDStream<span class="token punctuation">.</span>foreachRDD<span class="token punctuation">(</span>
      rdd <span class="token keyword">=&gt;</span> <span class="token punctuation">{<!-- --></span>

        rdd<span class="token punctuation">.</span>foreachPartition<span class="token punctuation">(</span>
          jsonObjIter <span class="token keyword">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>jsonObj <span class="token keyword">&lt;-</span> jsonObjIter<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token comment">//分流过程</span>
              <span class="token comment">//分流错误数据</span>
              <span class="token keyword">val</span> errObj<span class="token operator">:</span> JSONObject <span class="token operator">=</span> jsonObj<span class="token punctuation">.</span>getJSONObject<span class="token punctuation">(</span><span class="token string">"err"</span><span class="token punctuation">)</span>
              <span class="token keyword">if</span><span class="token punctuation">(</span>errObj <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token comment">//将错误数据发送到 DWD_ERROR_LOG_TOPIC</span>
                MyKafkaUtils<span class="token punctuation">.</span>send<span class="token punctuation">(</span>DWD_ERROR_LOG_TOPIC <span class="token punctuation">,</span>  jsonObj<span class="token punctuation">.</span>toJSONString <span class="token punctuation">)</span>
              <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                  
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>	
</code></pre> 
<ol start="2"><li>将公共字段和页面数据发送到DWD_PAGE_DISPLAY_TOPIC<br> <img src="https://images2.imgbox.com/88/ab/m3PG5X6n_o.png" alt="在这里插入图片描述"></li></ol> 
<pre><code class="prism language-scala"><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 提取公共字段</span>
                <span class="token keyword">val</span> commonObj<span class="token operator">:</span> JSONObject <span class="token operator">=</span> jsonObj<span class="token punctuation">.</span>getJSONObject<span class="token punctuation">(</span><span class="token string">"common"</span><span class="token punctuation">)</span>
                <span class="token keyword">val</span> ar<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> commonObj<span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token string">"ar"</span><span class="token punctuation">)</span>
                <span class="token keyword">val</span> uid<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> commonObj<span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token string">"uid"</span><span class="token punctuation">)</span>
                <span class="token keyword">val</span> os<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> commonObj<span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token string">"os"</span><span class="token punctuation">)</span>
                <span class="token keyword">val</span> ch<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> commonObj<span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token string">"ch"</span><span class="token punctuation">)</span>
                <span class="token keyword">val</span> isNew<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> commonObj<span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token string">"is_new"</span><span class="token punctuation">)</span>
                <span class="token keyword">val</span> md<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> commonObj<span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token string">"md"</span><span class="token punctuation">)</span>
                <span class="token keyword">val</span> mid<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> commonObj<span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token string">"mid"</span><span class="token punctuation">)</span>
                <span class="token keyword">val</span> vc<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> commonObj<span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token string">"vc"</span><span class="token punctuation">)</span>
                <span class="token keyword">val</span> ba<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> commonObj<span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token string">"ba"</span><span class="token punctuation">)</span>
                <span class="token comment">//提取时间戳</span>
                <span class="token keyword">val</span> ts<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> jsonObj<span class="token punctuation">.</span>getLong<span class="token punctuation">(</span><span class="token string">"ts"</span><span class="token punctuation">)</span>
                <span class="token comment">// 页面数据</span>
                <span class="token keyword">val</span> pageObj<span class="token operator">:</span> JSONObject <span class="token operator">=</span> jsonObj<span class="token punctuation">.</span>getJSONObject<span class="token punctuation">(</span><span class="token string">"page"</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>pageObj <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                  <span class="token comment">//提取page字段</span>
                  <span class="token keyword">val</span> pageId<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> pageObj<span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token string">"page_id"</span><span class="token punctuation">)</span>
                  <span class="token keyword">val</span> pageItem<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> pageObj<span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token string">"item"</span><span class="token punctuation">)</span>
                  <span class="token keyword">val</span> pageItemType<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> pageObj<span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token string">"item_type"</span><span class="token punctuation">)</span>
                  <span class="token keyword">val</span> duringTime<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> pageObj<span class="token punctuation">.</span>getLong<span class="token punctuation">(</span><span class="token string">"during_time"</span><span class="token punctuation">)</span>
                  <span class="token keyword">val</span> lastPageId<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> pageObj<span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token string">"last_page_id"</span><span class="token punctuation">)</span>
                  <span class="token keyword">val</span> sourceType<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> pageObj<span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token string">"source_type"</span><span class="token punctuation">)</span>

                  <span class="token comment">//封装成PageLog,这边还写了bean实体类去接收</span>
                  <span class="token keyword">var</span> pageLog <span class="token operator">=</span>
                    PageLog<span class="token punctuation">(</span>mid<span class="token punctuation">,</span>uid<span class="token punctuation">,</span>ar<span class="token punctuation">,</span>ch<span class="token punctuation">,</span>isNew<span class="token punctuation">,</span>md<span class="token punctuation">,</span>os<span class="token punctuation">,</span>vc<span class="token punctuation">,</span>ba<span class="token punctuation">,</span>pageId<span class="token punctuation">,</span>lastPageId<span class="token punctuation">,</span>pageItem<span class="token punctuation">,</span>pageItemType<span class="token punctuation">,</span>duringTime<span class="token punctuation">,</span>sourceType<span class="token punctuation">,</span>ts<span class="token punctuation">)</span>
                  <span class="token comment">//发送到DWD_PAGE_LOG_TOPIC</span>
                  MyKafkaUtils<span class="token punctuation">.</span>send<span class="token punctuation">(</span>DWD_PAGE_LOG_TOPIC <span class="token punctuation">,</span> JSON<span class="token punctuation">.</span>toJSONString<span class="token punctuation">(</span>pageLog <span class="token punctuation">,</span> <span class="token keyword">new</span> SerializeConfig<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//scala中bean没有set和get方法，这边是直接操作字段</span>
                <span class="token punctuation">}</span>

</code></pre> 
<ol start="3"><li>其他曝光、事件、启动数据如下</li></ol> 
<pre><code class="prism language-scala">                  <span class="token comment">//提取曝光数据</span>
                  <span class="token keyword">val</span> displaysJsonArr<span class="token operator">:</span> JSONArray <span class="token operator">=</span> jsonObj<span class="token punctuation">.</span>getJSONArray<span class="token punctuation">(</span><span class="token string">"displays"</span><span class="token punctuation">)</span>
                  <span class="token keyword">if</span><span class="token punctuation">(</span>displaysJsonArr <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> displaysJsonArr<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token keyword">&lt;-</span> <span class="token number">0</span> until displaysJsonArr<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                      <span class="token comment">//循环拿到每个曝光</span>
                      <span class="token keyword">val</span> displayObj<span class="token operator">:</span> JSONObject <span class="token operator">=</span> displaysJsonArr<span class="token punctuation">.</span>getJSONObject<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
                      <span class="token comment">//提取曝光字段</span>
                      <span class="token keyword">val</span> displayType<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> displayObj<span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token string">"display_type"</span><span class="token punctuation">)</span>
                      <span class="token keyword">val</span> displayItem<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> displayObj<span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token string">"item"</span><span class="token punctuation">)</span>
                      <span class="token keyword">val</span> displayItemType<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> displayObj<span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token string">"item_type"</span><span class="token punctuation">)</span>
                      <span class="token keyword">val</span> posId<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> displayObj<span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token string">"pos_id"</span><span class="token punctuation">)</span>
                      <span class="token keyword">val</span> order<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> displayObj<span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token string">"order"</span><span class="token punctuation">)</span>

                      <span class="token comment">//封装成PageDisplayLog</span>
                      <span class="token keyword">val</span> pageDisplayLog <span class="token operator">=</span>
                        PageDisplayLog<span class="token punctuation">(</span>mid<span class="token punctuation">,</span>uid<span class="token punctuation">,</span>ar<span class="token punctuation">,</span>ch<span class="token punctuation">,</span>isNew<span class="token punctuation">,</span>md<span class="token punctuation">,</span>os<span class="token punctuation">,</span>vc<span class="token punctuation">,</span>ba<span class="token punctuation">,</span>pageId<span class="token punctuation">,</span>lastPageId<span class="token punctuation">,</span>pageItem<span class="token punctuation">,</span>pageItemType<span class="token punctuation">,</span>duringTime<span class="token punctuation">,</span>sourceType<span class="token punctuation">,</span>displayType<span class="token punctuation">,</span>displayItem<span class="token punctuation">,</span>displayItemType<span class="token punctuation">,</span>order<span class="token punctuation">,</span>posId<span class="token punctuation">,</span>ts<span class="token punctuation">)</span>
                      <span class="token comment">// 写到 DWD_PAGE_DISPLAY_TOPIC</span>
                      MyKafkaUtils<span class="token punctuation">.</span>send<span class="token punctuation">(</span>DWD_PAGE_DISPLAY_TOPIC <span class="token punctuation">,</span> JSON<span class="token punctuation">.</span>toJSONString<span class="token punctuation">(</span>pageDisplayLog <span class="token punctuation">,</span> <span class="token keyword">new</span> SerializeConfig<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                  <span class="token punctuation">}</span>
                  <span class="token comment">//提取事件数据（课下完成）</span>
                  <span class="token keyword">val</span> actionJsonArr<span class="token operator">:</span> JSONArray <span class="token operator">=</span> jsonObj<span class="token punctuation">.</span>getJSONArray<span class="token punctuation">(</span><span class="token string">"actions"</span><span class="token punctuation">)</span>
                  <span class="token keyword">if</span><span class="token punctuation">(</span>actionJsonArr <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> actionJsonArr<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token keyword">&lt;-</span> <span class="token number">0</span> until actionJsonArr<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                      <span class="token keyword">val</span> actionObj<span class="token operator">:</span> JSONObject <span class="token operator">=</span> actionJsonArr<span class="token punctuation">.</span>getJSONObject<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
                      <span class="token comment">//提取字段</span>
                      <span class="token keyword">val</span> actionId<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> actionObj<span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token string">"action_id"</span><span class="token punctuation">)</span>
                      <span class="token keyword">val</span> actionItem<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> actionObj<span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token string">"item"</span><span class="token punctuation">)</span>
                      <span class="token keyword">val</span> actionItemType<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> actionObj<span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token string">"item_type"</span><span class="token punctuation">)</span>
                      <span class="token keyword">val</span> actionTs<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> actionObj<span class="token punctuation">.</span>getLong<span class="token punctuation">(</span><span class="token string">"ts"</span><span class="token punctuation">)</span>

                      <span class="token comment">//封装PageActionLog</span>
                      <span class="token keyword">var</span> pageActionLog <span class="token operator">=</span>
                        PageActionLog<span class="token punctuation">(</span>mid<span class="token punctuation">,</span>uid<span class="token punctuation">,</span>ar<span class="token punctuation">,</span>ch<span class="token punctuation">,</span>isNew<span class="token punctuation">,</span>md<span class="token punctuation">,</span>os<span class="token punctuation">,</span>vc<span class="token punctuation">,</span>ba<span class="token punctuation">,</span>pageId<span class="token punctuation">,</span>lastPageId<span class="token punctuation">,</span>pageItem<span class="token punctuation">,</span>pageItemType<span class="token punctuation">,</span>duringTime<span class="token punctuation">,</span>sourceType<span class="token punctuation">,</span>actionId<span class="token punctuation">,</span>actionItem<span class="token punctuation">,</span>actionItemType<span class="token punctuation">,</span>actionTs<span class="token punctuation">,</span>ts<span class="token punctuation">)</span>
                      <span class="token comment">//写出到DWD_PAGE_ACTION_TOPIC</span>
                      MyKafkaUtils<span class="token punctuation">.</span>send<span class="token punctuation">(</span>DWD_PAGE_ACTION_TOPIC <span class="token punctuation">,</span> JSON<span class="token punctuation">.</span>toJSONString<span class="token punctuation">(</span>pageActionLog <span class="token punctuation">,</span> <span class="token keyword">new</span> SerializeConfig<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                  <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 启动数据（课下完成）</span>
                <span class="token keyword">val</span> startJsonObj<span class="token operator">:</span> JSONObject <span class="token operator">=</span> jsonObj<span class="token punctuation">.</span>getJSONObject<span class="token punctuation">(</span><span class="token string">"start"</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>startJsonObj <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                  <span class="token comment">//提取字段</span>
                  <span class="token keyword">val</span> entry<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> startJsonObj<span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token string">"entry"</span><span class="token punctuation">)</span>
                  <span class="token keyword">val</span> loadingTime<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> startJsonObj<span class="token punctuation">.</span>getLong<span class="token punctuation">(</span><span class="token string">"loading_time"</span><span class="token punctuation">)</span>
                  <span class="token keyword">val</span> openAdId<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> startJsonObj<span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token string">"open_ad_id"</span><span class="token punctuation">)</span>
                  <span class="token keyword">val</span> openAdMs<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> startJsonObj<span class="token punctuation">.</span>getLong<span class="token punctuation">(</span><span class="token string">"open_ad_ms"</span><span class="token punctuation">)</span>
                  <span class="token keyword">val</span> openAdSkipMs<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> startJsonObj<span class="token punctuation">.</span>getLong<span class="token punctuation">(</span><span class="token string">"open_ad_skip_ms"</span><span class="token punctuation">)</span>

                  <span class="token comment">//封装StartLog</span>
                  <span class="token keyword">var</span> startLog <span class="token operator">=</span>
                    StartLog<span class="token punctuation">(</span>mid<span class="token punctuation">,</span>uid<span class="token punctuation">,</span>ar<span class="token punctuation">,</span>ch<span class="token punctuation">,</span>isNew<span class="token punctuation">,</span>md<span class="token punctuation">,</span>os<span class="token punctuation">,</span>vc<span class="token punctuation">,</span>ba<span class="token punctuation">,</span>entry<span class="token punctuation">,</span>openAdId<span class="token punctuation">,</span>loadingTime<span class="token punctuation">,</span>openAdMs<span class="token punctuation">,</span>openAdSkipMs<span class="token punctuation">,</span>ts<span class="token punctuation">)</span>
                  <span class="token comment">//写出DWD_START_LOG_TOPIC</span>
                  MyKafkaUtils<span class="token punctuation">.</span>send<span class="token punctuation">(</span>DWD_START_LOG_TOPIC <span class="token punctuation">,</span> JSON<span class="token punctuation">.</span>toJSONString<span class="token punctuation">(</span>startLog <span class="token punctuation">,</span><span class="token keyword">new</span> SerializeConfig<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre> 
<h3><a id="23__296"></a>2.3 精确一次消费</h3> 
<ol><li>背景</li></ol> 
<p>发送kafka的是自动提交，如果提交有误，会出现漏消费或者重复消费</p> 
<ol start="2"><li>相关语义</li></ol> 
<ul><li>至少一次消费：数据不会丢失，但存在数据重复</li><li>最多一次消费：数据不会重复，但可能丢失数据</li><li>精确一次消费：不多不少一次消费</li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/db5ea157088df8bef1802641a232a8ea/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">基于Android Studio的日记App课程设计</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/bbc46e51f4a9950a7f892cd52ab00d5a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">基于Unity的VR迷宫游戏项目技术分享</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>