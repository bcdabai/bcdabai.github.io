<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>FlinkSql的窗口使用以及运用案例 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="FlinkSql的窗口使用以及运用案例" />
<meta property="og:description" content="1 flinkSQL窗口概述 1.1 窗口定义: 可理解为时间轴，可将无界流切分成有界流
1.2 窗口分类： TimeWindow：通过时间切割窗口，但是不知道窗口有多少数据 滑动窗口
滚动窗口
会话窗口
CountWindow：按照数据量来切割窗口 滑动窗口滚动窗口会话窗口 自定义窗口 1.3 TimeWindow分类 滚动窗口：有固定的窗口长度往前进行滚动，数据不重复计算
滑动窗口：由固定的窗口长度和滑动间隔组成，数据可以重复
会话窗口：由一系列事件指定事件长度间隙组成，类比wed应用的session
group windows
键控window：keyvalue非键控window 2 flinkSQL窗口使用 2.1 窗口函数类型 flinkSQL中通过Groupby Windows函数来定义分组窗口
TUMBLE(time_attr,interval)：定义滚动窗口HOP(time_attr,interval,interval)：定义滑动窗口，第二个参数表示滑动步长，第三个参数表示窗口大小SESSION(time_attr,interval)：定义会话窗口 2.2 滚动窗口案例 数据 data_time,price,product_id,buyername 1666620609,44,1,白天磊 1666620610,45,1,陈智渊 1666620611,46,1,崔钰轩 1666620612,47,1,吴鹏飞 1666620613,48,1,毛明辉 1666620614,49,1,侯弘文 1666620615,50,1,曾伟祺 1666620616,51,1,郝瑞霖 1666620617,52,1,陆熠彤 1666620618,53,1,余弘文 1666620619,54,1,石哲瀚 1666620620,55,1,任擎苍 1666620621,56,1,卢文轩 1666620622,57,1,吕晋鹏 1666620623,58,1,罗晟睿 1666620624,59,1,周建辉 1666620625,60,1,卢皓轩 1666620626,61,1,沈煜城 1666620627,62,1,万鑫鹏 1666620628,63,1,沈思远 需求 上表是product_id为1的商品被不同的用户在不同的时间下单以及金额数据，使用flinkSQL当中当中的滚动窗口计算：每隔2秒钟的金额的最大值 代码实现 定义Userproduct类定义字段 //使用插件生成有无参构造器以及重写一些方法 @Data//完成了Getter,Setter,equals,hasCode,toString 等方法 @Builder//省去写很多构造函数的麻烦 @NoArgsConstructor//自动添加一个无参构造函数 @AllArgsConstructor//为自动添加一个构造函数 public class Userproduct { private Integer product_id; private String buyer_name; private Long date_time; private Double price; } 构造执行环境 StreamExecutionEnvironment senv = StreamExecutionEnvironment." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/60019c623d584d8b1f8cf2fa6ca2d21d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-03T18:03:13+08:00" />
<meta property="article:modified_time" content="2022-11-03T18:03:13+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">FlinkSql的窗口使用以及运用案例</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="1__flinkSQL_0"></a>1 flinkSQL窗口概述</h3> 
<h4><a id="11__2"></a>1.1 窗口定义:</h4> 
<p>可理解为时间轴，可将无界流切分成有界流</p> 
<h4><a id="12__6"></a>1.2 窗口分类：</h4> 
<ol><li>TimeWindow：通过时间切割窗口，但是不知道窗口有多少数据</li></ol> 
<ul><li> <p>滑动窗口</p> </li><li> <p>滚动窗口</p> </li><li> <p>会话窗口</p> </li></ul> 
<ol start="2"><li>CountWindow：按照数据量来切割窗口</li></ol> 
<ul><li>滑动窗口</li><li>滚动窗口</li><li>会话窗口</li></ul> 
<ol start="3"><li>自定义窗口</li></ol> 
<h4><a id="13_TimeWindow_24"></a>1.3 TimeWindow分类</h4> 
<ul><li> <p>滚动窗口：有固定的窗口长度往前进行滚动，数据不重复计算</p> </li><li> <p>滑动窗口：由固定的窗口长度和滑动间隔组成，数据可以重复<br> <img src="https://images2.imgbox.com/c9/c6/0JJbs8yB_o.png" alt="image.png"></p> </li></ul> 
<p><img src="https://images2.imgbox.com/15/9e/URTbOtyz_o.png" alt="image.png"></p> 
<ul><li> <p>会话窗口：由一系列事件指定事件长度间隙组成，类比wed应用的session</p> </li><li> <p>group windows</p> 
  <ul><li>键控window：keyvalue</li><li>非键控window</li></ul> </li></ul> 
<h3><a id="2_flinkSQL_38"></a>2 flinkSQL窗口使用</h3> 
<h4><a id="21__40"></a>2.1 窗口函数类型</h4> 
<p>flinkSQL中通过Groupby Windows函数来定义分组窗口</p> 
<ul><li>TUMBLE(time_attr,interval)：定义滚动窗口</li><li>HOP(time_attr,interval,interval)：定义滑动窗口，第二个参数表示滑动步长，第三个参数表示窗口大小</li><li>SESSION(time_attr,interval)：定义会话窗口</li></ul> 
<h4><a id="22__48"></a>2.2 滚动窗口案例</h4> 
<ol><li>数据</li></ol> 
<pre><code class="prism language-test">data_time,price,product_id,buyername
1666620609,44,1,白天磊
1666620610,45,1,陈智渊
1666620611,46,1,崔钰轩
1666620612,47,1,吴鹏飞
1666620613,48,1,毛明辉
1666620614,49,1,侯弘文
1666620615,50,1,曾伟祺
1666620616,51,1,郝瑞霖
1666620617,52,1,陆熠彤
1666620618,53,1,余弘文
1666620619,54,1,石哲瀚
1666620620,55,1,任擎苍
1666620621,56,1,卢文轩
1666620622,57,1,吕晋鹏
1666620623,58,1,罗晟睿
1666620624,59,1,周建辉
1666620625,60,1,卢皓轩
1666620626,61,1,沈煜城
1666620627,62,1,万鑫鹏
1666620628,63,1,沈思远
</code></pre> 
<ol start="2"><li>需求</li></ol> 
<ul><li>上表是product_id为1的商品被不同的用户在不同的时间下单以及金额数据，使用flinkSQL当中当中的滚动窗口计算：每隔2秒钟的金额的最大值</li></ul> 
<ol start="3"><li>代码实现</li></ol> 
<ul><li>定义Userproduct类定义字段</li></ul> 
<pre><code class="prism language-java"><span class="token comment">//使用插件生成有无参构造器以及重写一些方法</span>
<span class="token annotation punctuation">@Data</span><span class="token comment">//完成了Getter,Setter,equals,hasCode,toString 等方法</span>
<span class="token annotation punctuation">@Builder</span><span class="token comment">//省去写很多构造函数的麻烦</span>
<span class="token annotation punctuation">@NoArgsConstructor</span><span class="token comment">//自动添加一个无参构造函数</span>
<span class="token annotation punctuation">@AllArgsConstructor</span><span class="token comment">//为自动添加一个构造函数</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Userproduct</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> product_id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> buyer_name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> date_time<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Double</span> price<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>构造执行环境</li></ul> 
<pre><code class="prism language-java">        <span class="token class-name">StreamExecutionEnvironment</span> senv <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        senv<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置并行度</span>


        <span class="token class-name">StreamTableEnvironment</span> tEnv <span class="token operator">=</span> <span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>senv<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>定义一个水位线</li></ul> 
<pre><code class="prism language-java">        <span class="token comment">//泛型指定为Userproduct对象</span>
        <span class="token comment">//指定乱序时间两秒</span>
        <span class="token comment">//复写方法extractTimestamp</span>
        <span class="token class-name">WatermarkStrategy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Userproduct</span><span class="token punctuation">&gt;</span></span> watermarkStrategy <span class="token operator">=</span> <span class="token class-name">WatermarkStrategy</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Userproduct</span><span class="token punctuation">&gt;</span></span><span class="token function">forBoundedOutOfOrderness</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withTimestampAssigner</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SerializableTimestampAssigner</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Userproduct</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extractTimestamp</span><span class="token punctuation">(</span><span class="token class-name">Userproduct</span> userproduct<span class="token punctuation">,</span> <span class="token keyword">long</span> l<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">return</span> userproduct<span class="token punctuation">.</span><span class="token function">getDate_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span><span class="token comment">//需要得到毫秒值</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>从socket获取数据,并且把水位线丢进去</li></ul> 
<pre><code class="prism language-sql">        <span class="token comment">//从socket读取数据，指定水位线</span>
        DataStream<span class="token operator">&lt;</span>Userproduct<span class="token operator">&gt;</span> userProductDataStream <span class="token operator">=</span> senv<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">"hadoop1"</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>map<span class="token punctuation">(</span>event <span class="token operator">-</span><span class="token operator">&gt;</span> {
                    String<span class="token punctuation">[</span><span class="token punctuation">]</span> arr <span class="token operator">=</span> event<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    Userproduct userproduct <span class="token operator">=</span> Userproduct<span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span>product_id<span class="token punctuation">(</span><span class="token keyword">Integer</span><span class="token punctuation">.</span>parseInt<span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span>buyer_name<span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span>date_time<span class="token punctuation">(</span>Long<span class="token punctuation">.</span>valueOf<span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span>price<span class="token punctuation">(</span><span class="token keyword">Double</span><span class="token punctuation">.</span>valueOf<span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span>build<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> userproduct<span class="token punctuation">;</span>
                }<span class="token punctuation">)</span><span class="token punctuation">.</span>assignTimestampsAndWatermarks<span class="token punctuation">(</span>watermarkStrategy<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>将流式数据给转换成为动态表</li></ul> 
<pre><code class="prism language-sql">        <span class="token keyword">Table</span> <span class="token keyword">table</span> <span class="token operator">=</span> tEnv<span class="token punctuation">.</span>fromDataStream<span class="token punctuation">(</span>userProductDataStream<span class="token punctuation">,</span>
                $<span class="token punctuation">(</span><span class="token string">"product_id"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//跟上字段</span>
                $<span class="token punctuation">(</span><span class="token string">"buyer_name"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                $<span class="token punctuation">(</span><span class="token string">"price"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                $<span class="token punctuation">(</span><span class="token string">"date_time"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rowtime<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//通过调用rowtime来指定event_time为准</span>
</code></pre> 
<ul><li>执行flinkSQL的窗口函数</li></ul> 
<p>这边TUMBLE指的是定义滚动窗口，select后面的窗口字段要在groupby也要出现</p> 
<pre><code class="prism language-java">        <span class="token class-name">Table</span> resultTable <span class="token operator">=</span> tEnv<span class="token punctuation">.</span><span class="token function">sqlQuery</span><span class="token punctuation">(</span>
                <span class="token string">"select product_id,max(price),TUMBLE_START(date_time,INTERVAL '5' second)  as winstart   "</span> <span class="token operator">+</span>
                   <span class="token string">"from  "</span> <span class="token operator">+</span> table <span class="token operator">+</span>
                   <span class="token string">" GROUP BY product_id , TUMBLE(date_time, INTERVAL '5' second)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//间隔5秒</span>
</code></pre> 
<ul><li>完整代码</li></ul> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FlinkSQLTumbEvtWindowTime</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token comment">//构建表执行环境</span>
        <span class="token class-name">StreamExecutionEnvironment</span> senv <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        senv<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">StreamTableEnvironment</span> tEnv <span class="token operator">=</span> <span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>senv<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//定义一个水位线</span>

        <span class="token comment">//泛型指定为Userproduct对象</span>
        <span class="token comment">//指定乱序时间两秒</span>
        <span class="token comment">//复写方法extractTimestamp</span>
        <span class="token class-name">WatermarkStrategy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Userproduct</span><span class="token punctuation">&gt;</span></span> watermarkStrategy <span class="token operator">=</span> <span class="token class-name">WatermarkStrategy</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Userproduct</span><span class="token punctuation">&gt;</span></span><span class="token function">forBoundedOutOfOrderness</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withTimestampAssigner</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SerializableTimestampAssigner</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Userproduct</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extractTimestamp</span><span class="token punctuation">(</span><span class="token class-name">Userproduct</span> userproduct<span class="token punctuation">,</span> <span class="token keyword">long</span> l<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">return</span> userproduct<span class="token punctuation">.</span><span class="token function">getDate_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span><span class="token comment">//需要得到毫秒值</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">//从socket读取数据，指定水位线</span>
        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Userproduct</span><span class="token punctuation">&gt;</span></span> userProductDataStream <span class="token operator">=</span> senv<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"hadoop1"</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>event <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Userproduct</span> userproduct <span class="token operator">=</span> <span class="token class-name">Userproduct</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">product_id</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">buyer_name</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">date_time</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">price</span><span class="token punctuation">(</span><span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> userproduct<span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span>watermarkStrategy<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//将流式数据给转换成为动态表</span>
        <span class="token class-name">Table</span> table <span class="token operator">=</span> tEnv<span class="token punctuation">.</span><span class="token function">fromDataStream</span><span class="token punctuation">(</span>userProductDataStream<span class="token punctuation">,</span>
                $<span class="token punctuation">(</span><span class="token string">"product_id"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//跟上字段</span>
                $<span class="token punctuation">(</span><span class="token string">"buyer_name"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                $<span class="token punctuation">(</span><span class="token string">"price"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                $<span class="token punctuation">(</span><span class="token string">"date_time"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rowtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//通过调用rowtime来指定event_time为准</span>


        <span class="token comment">//执行flink的sql程序</span>
        <span class="token class-name">Table</span> resultTable <span class="token operator">=</span> tEnv<span class="token punctuation">.</span><span class="token function">sqlQuery</span><span class="token punctuation">(</span>
                <span class="token string">"select product_id,max(price),TUMBLE_START(date_time,INTERVAL '5' second)  as winstart   "</span> <span class="token operator">+</span>
                   <span class="token string">"from  "</span> <span class="token operator">+</span> table <span class="token operator">+</span>
                   <span class="token string">" GROUP BY product_id , TUMBLE(date_time, INTERVAL '5' second)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        resultTable<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>最后打印看看</li></ul> 
<pre><code class="prism language-java">       resultTable<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>看下结果:每隔5秒是一个窗口，每个两秒往前滚动一次</li></ul> 
<p><img src="https://images2.imgbox.com/2e/e6/7hFkUtGK_o.png" alt="image.png"></p> 
<h4><a id="23_sql_229"></a>2.3 滑动窗口sql</h4> 
<pre><code class="prism language-java">        <span class="token comment">//使用HOP，滑动大小2秒，窗口大小4秒</span>
        <span class="token class-name">Table</span> resultTable <span class="token operator">=</span> tEnv<span class="token punctuation">.</span><span class="token function">sqlQuery</span><span class="token punctuation">(</span><span class="token string">"select product_id,max(price),HOP_START(date_time,INTERVAL '2' second,INTERVAL '4' second) as winstart  "</span> <span class="token operator">+</span>
                       <span class="token string">"from "</span> <span class="token operator">+</span> table <span class="token operator">+</span>
                       <span class="token string">" group by product_id ,HOP(date_time,INTERVAL '2' second,INTERVAL '4' second)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="24_sql_238"></a>2.4 会话窗口sql</h4> 
<pre><code class="prism language-java">        <span class="token class-name">Table</span> resultTable <span class="token operator">=</span> tEnv<span class="token punctuation">.</span><span class="token function">sqlQuery</span><span class="token punctuation">(</span><span class="token string">"select product_id,max(price) , SESSION_START(date_time,INTERVAL '5' second ) as winstart  "</span> <span class="token operator">+</span>
                        <span class="token string">"from "</span> <span class="token operator">+</span> table <span class="token operator">+</span> 
                        <span class="token string">" group by product_id ,SESSION(date_time,INTERVAL '5' second)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="3_over_246"></a>3 over窗口的使用</h3> 
<h4><a id="31__248"></a>3.1 语法</h4> 
<pre><code class="prism language-java">select 分析函数 over <span class="token punctuation">(</span>partitionBy 字段 orderby 字段 <span class="token operator">&lt;</span>开窗范围<span class="token operator">&gt;</span> <span class="token punctuation">)</span> from group by 
</code></pre> 
<ul><li>开窗范围</li></ul> 
<pre><code class="prism language-sql"><span class="token comment">--范围间隔,例如开窗范围选择当前行之前 1 小时的数据</span>
RANGE <span class="token operator">BETWEEN</span> <span class="token keyword">INTERVAL</span> <span class="token string">'1'</span> <span class="token keyword">HOUR</span> <span class="token keyword">PRECEDING</span> <span class="token operator">AND</span> <span class="token keyword">CURRENT</span> <span class="token keyword">ROW</span>	
<span class="token comment">--行间隔，例如开窗范围选择当前行之前的 5 行数据(含当前行6行数据)</span>
<span class="token keyword">ROWS</span> <span class="token operator">BETWEEN</span> <span class="token number">5</span> <span class="token keyword">PRECEDING</span> <span class="token operator">AND</span> <span class="token keyword">CURRENT</span> <span class="token keyword">ROW</span>
</code></pre> 
<h4><a id="32__263"></a>3.2 案例</h4> 
<ol><li>数据</li></ol> 
<pre><code class="prism language-java"><span class="token number">1666620609</span><span class="token punctuation">,</span><span class="token number">44</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>白天磊
<span class="token number">1666620610</span><span class="token punctuation">,</span><span class="token number">45</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>陈智渊
<span class="token number">1666620611</span><span class="token punctuation">,</span><span class="token number">46</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>崔钰轩
<span class="token number">1666620612</span><span class="token punctuation">,</span><span class="token number">47</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>吴鹏飞
<span class="token number">1666620613</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>毛明辉
<span class="token number">1666620614</span><span class="token punctuation">,</span><span class="token number">49</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>侯弘文
<span class="token number">1666620615</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>曾伟祺
<span class="token number">1666620616</span><span class="token punctuation">,</span><span class="token number">51</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>郝瑞霖
<span class="token number">1666620617</span><span class="token punctuation">,</span><span class="token number">52</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>陆熠彤
<span class="token number">1666620618</span><span class="token punctuation">,</span><span class="token number">53</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>余弘文
<span class="token number">1666620619</span><span class="token punctuation">,</span><span class="token number">54</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>石哲瀚
<span class="token number">1666620620</span><span class="token punctuation">,</span><span class="token number">55</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>任擎苍
<span class="token number">1666620621</span><span class="token punctuation">,</span><span class="token number">56</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>卢文轩
<span class="token number">1666620622</span><span class="token punctuation">,</span><span class="token number">57</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>吕晋鹏
<span class="token number">1666620623</span><span class="token punctuation">,</span><span class="token number">58</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>罗晟睿
<span class="token number">1666620624</span><span class="token punctuation">,</span><span class="token number">59</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>周建辉
<span class="token number">1666620625</span><span class="token punctuation">,</span><span class="token number">60</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>卢皓轩
<span class="token number">1666620626</span><span class="token punctuation">,</span><span class="token number">61</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>沈煜城
<span class="token number">1666620627</span><span class="token punctuation">,</span><span class="token number">62</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>万鑫鹏
<span class="token number">1666620628</span><span class="token punctuation">,</span><span class="token number">63</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>沈思远
</code></pre> 
<ol start="2"><li>需求与实现</li></ol> 
<ul><li>使用Over窗口按event-time排序有界向前5s开窗，求取最大值以及平均金额</li></ul> 
<pre><code class="prism language-java">        <span class="token class-name">Table</span> resultTable <span class="token operator">=</span> tEnv<span class="token punctuation">.</span><span class="token function">sqlQuery</span><span class="token punctuation">(</span>
            	"select product_id<span class="token punctuation">,</span>
                 <span class="token function">max</span><span class="token punctuation">(</span>price<span class="token punctuation">)</span> <span class="token string">" + "</span>OVER w <span class="token class-name">AS</span> max_price<span class="token punctuation">,</span> " <span class="token operator">+</span>
                <span class="token string">"avg(price) OVER w AS avg_price   "</span> <span class="token operator">+</span>
                <span class="token string">"from "</span> <span class="token operator">+</span> table <span class="token operator">+</span>
                <span class="token string">" WINDOW w AS ( PARTITION BY product_id ORDER BY date_time RANGE BETWEEN INTERVAL '5' second PRECEDING AND CURRENT ROW) "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>当然也可以这么写</p> 
<pre><code class="prism language-java">        <span class="token class-name">Table</span> resultTable <span class="token operator">=</span> tEnv<span class="token punctuation">.</span><span class="token function">sqlQuery</span><span class="token punctuation">(</span>
            	"select product_id<span class="token punctuation">,</span>
                 <span class="token function">max</span><span class="token punctuation">(</span>price<span class="token punctuation">)</span> <span class="token string">" + "</span>OVER <span class="token punctuation">(</span> PARTITION BY product_id ORDER BY date_time RANGE BETWEEN INTERVAL <span class="token char">'5'</span> second PRECEDING AND <span class="token class-name">CURRENT</span> ROW<span class="token punctuation">)</span> <span class="token class-name">AS</span> max_price<span class="token punctuation">,</span> " <span class="token operator">+</span>
                <span class="token string">"avg(price) OVER ( PARTITION BY product_id ORDER BY date_time RANGE BETWEEN INTERVAL '5' second PRECEDING AND CURRENT ROW) AS avg_price   "</span> <span class="token operator">+</span>
                <span class="token string">"from "</span> <span class="token operator">+</span> table   
</code></pre> 
<ul><li>使用Over窗口按event-time排序有界向前3条数据，求最大金额以及平均金额</li></ul> 
<pre><code class="prism language-java">        <span class="token class-name">Table</span> resultTable <span class="token operator">=</span> tEnv<span class="token punctuation">.</span><span class="token function">sqlQuery</span><span class="token punctuation">(</span><span class="token string">"select product_id,max(price) "</span> <span class="token operator">+</span>
                <span class="token string">"OVER w AS max_price, avg(price) OVER w AS avg_price  "</span> <span class="token operator">+</span>
                <span class="token string">" from "</span>
                <span class="token operator">+</span> table 
                <span class="token operator">+</span> <span class="token string">" WINDOW w AS ( PARTITION BY product_id ORDER BY date_time ROWS BETWEEN  3 PRECEDING AND CURRENT ROW) "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f93a0795ab4f717f7d8ea8c9ab3f18ac/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">高校实验室设备预约管理系统</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7205ed0f498f0264f6d56df808296d3b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">vue11Vuex解说&#43;子父传参详细使用</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>