<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>JUC（一） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="JUC（一）" />
<meta property="og:description" content="一、JUC JUC是java.util.conccurent包的简称，juc提供了很多关于线程安全的集合实现，以及各种锁的实现。
juc视频教程
二、多线程相关知识 1.并发 同一台处理器上 “同时” 处理多个任务，为什么同时需要打引号呢？因为实际上同一时刻实际上只有一个事件在发生。处理器是通过不断切换占用cpu时间片的任务来实现同时处理多个任务的。
2.并行 多台处理器同时处理多个任务，同一时刻，每个处理器都在处理不同的任务。
3.进程 是并发执行的程序在执行过程中系统分配和管理资源的基本单位
4.线程 包含在进程中，是cpu调用的最小单元，也称轻量级进程
5.管程 实际上指的是锁（monitor），管程只会允许一个线程进入去获取共享资源
6.进程VS线程 内存空间及系统资源
进程之间拥有独立的空间、系统资源，同一个进程中的线程则是共享进程的内存空间、系统资源健壮性
一个进程崩溃之后不会影响其它进程，同一个进程中的线程崩溃后会导致进程中的其它线程受到影响。 7.用户线程 一般情况下不做特殊说明，线程默认都是用户线程
8.守护线程 守护线程是一个服务线程，他服务于用户线程，如果用户线程结束了，守护线程也就结束了。
在java中，jvm的gc垃圾回收线程就是守护线程，当主线城结束后，垃圾回收线程也会结束。
下面用一个例子来演示守护线程：
创建一个线程类，在其中执行打印操作1-100
/** * @author Watching * * @date 2023/4/29 * * Describe: */ public class MyThread extends Thread{ @Override public void run() { for(int i = 1;i&lt;= 100;i&#43;&#43;){ System.out.println(getName()&#43;&#34; helloWord &#34; &#43; i); } } } main方法，创建两个线程，一个女神线程，一个舔狗线程，女神先开始打印，1s后舔狗开始打印
/** * @author Watching * * @date 2023/4/29 * * Describe: */ public class ThreadDemo { public static void main(String[] args) throws InterruptedException { MyThread myThread1 = new MyThread(); MyThread myThread2 = new MyThread(); myThread1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/35845fab16dbaf2d0f89df257ad07808/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-19T09:45:59+08:00" />
<meta property="article:modified_time" content="2023-09-19T09:45:59+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">JUC（一）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="JUC_0"></a>一、JUC</h2> 
<p>JUC是java.util.conccurent包的简称，juc提供了很多关于线程安全的集合实现，以及各种锁的实现。<br> <a href="https://www.bilibili.com/video/BV1ar4y1x727/?p=6&amp;spm_id_from=pageDriver&amp;vd_source=c65783de24b29a9ebf3715c97a2c22e3" rel="nofollow">juc视频教程</a></p> 
<h2><a id="_3"></a>二、多线程相关知识</h2> 
<h3><a id="1_4"></a>1.并发</h3> 
<p>同一台处理器上 “同时” 处理多个任务，为什么同时需要打引号呢？因为实际上同一时刻实际上只有一个事件在发生。处理器是通过不断切换占用cpu时间片的任务来实现同时处理多个任务的。<br> <img src="https://images2.imgbox.com/ae/a5/sVIwMU0n_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="2_8"></a>2.并行</h3> 
<p>多台处理器同时处理多个任务，同一时刻，每个处理器都在处理不同的任务。<br> <img src="https://images2.imgbox.com/d2/aa/PDdvik2f_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3_12"></a>3.进程</h3> 
<p>是并发执行的程序在执行过程中系统分配和管理资源的基本单位</p> 
<h3><a id="4_14"></a>4.线程</h3> 
<p>包含在进程中，是cpu调用的最小单元，也称轻量级进程</p> 
<h3><a id="5_16"></a>5.管程</h3> 
<p>实际上指的是锁（monitor），管程只会允许一个线程进入去获取共享资源</p> 
<h3><a id="6VS_18"></a>6.进程VS线程</h3> 
<ul><li><strong>内存空间及系统资源</strong><br> 进程之间拥有独立的空间、系统资源，同一个进程中的线程则是共享进程的内存空间、系统资源</li><li><strong>健壮性</strong><br> 一个进程崩溃之后不会影响其它进程，同一个进程中的线程崩溃后会导致进程中的其它线程受到影响。</li></ul> 
<h3><a id="7_23"></a>7.用户线程</h3> 
<p>一般情况下不做特殊说明，线程默认都是用户线程</p> 
<h3><a id="8_25"></a>8.守护线程</h3> 
<p>守护线程是一个服务线程，他服务于用户线程，如果用户线程结束了，守护线程也就结束了。<br> 在java中，jvm的gc垃圾回收线程就是守护线程，当主线城结束后，垃圾回收线程也会结束。<br> <strong>下面用一个例子来演示守护线程</strong>：<br> 创建一个线程类，在其中执行打印操作1-100</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @author Watching
 * * @date 2023/4/29
 * * Describe:
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span><span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" helloWord "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>main方法，创建两个线程，一个女神线程，一个舔狗线程，女神先开始打印，1s后舔狗开始打印</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @author Watching
 * * @date 2023/4/29
 * * Describe:
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadDemo</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">MyThread</span> myThread1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MyThread</span> myThread2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        myThread1<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"女神"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        myThread2<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"舔狗"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        myThread2<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        myThread1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//女神开始打印</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        myThread2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//舔狗开始打印</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>查看结果</strong>：发现舔狗没有打印完100次就结束了，因为他打印17次之后发现女神线程结束了，所以舔狗线程也就结束了。<br> <img src="https://images2.imgbox.com/d2/87/DiwDSMWZ_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="CompletableFuture_67"></a>三、CompletableFuture</h2> 
<p>可以查看我另外一篇文章<br> <a href="https://blog.csdn.net/qq_47155894/article/details/128415054?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522169502349216800184172203%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&amp;request_id=169502349216800184172203&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-1-128415054-null-null.nonecase&amp;utm_term=completablefuture&amp;spm=1018.2226.3001.4450">CompletableFuture</a></p> 
<h2><a id="_70"></a>四、锁</h2> 
<h3><a id="1VS_71"></a>1.悲观锁VS乐观锁</h3> 
<ul><li><strong>悲观锁</strong><br> 认为自己在使用数据的时候一定有别的线程来修改数据，因此在获取数据的时候会先加锁，确保数据不会被别的线程修改。synchronized和lock接口都是悲观锁，适合用于写多的操作。</li><li><strong>乐观锁</strong><br> 认为自己在使用数据的时候不会有其它线程修改数据，所以不会添加锁，只有在更新数据的时候才会去判断，这个数据相比于自己查到的时候有没有被修改。<br> 如果数据相比于自己查到的时候没有被修改，则将数据修改为自己线程的数据。<br> 反之，可以选择放弃修改数据，或者自旋重新尝试修改数据。<br> 通常会采用<strong>版本号机制</strong>和<strong>cas算法</strong><br> 适合用于读多的操作。</li></ul> 
<h3><a id="2synchronized16_80"></a>2.synchronized(1.6)</h3> 
<p>sychronized是java提供的一个关键字，在<strong>jdk1.6</strong>之前它是一把<strong>重量级锁</strong>。<br> 第一个线程获取锁之后（在底层获取<strong>monitor</strong>这把锁），然后其他未获取到锁的线程会被添加到一个就绪队列中（其中还存在一个等待队列，线程处于阻塞状态时会被放入等待队列，等待被唤醒之后放入就绪队列），等待锁被释放后再次去竞争这把锁。</p> 
<p>由于涉及到线程的状态切换，比较耗费系统资源，所以synchronized这把锁的代价很大。<br> <img src="https://images2.imgbox.com/f5/1c/3Uv3JVCe_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="20monitor_87"></a>2.0、管程（monitor）（待完善）</h4> 
<p>下面就来详细讲一下synchronized在底层是如何获取monitor这把锁的</p> 
<h4><a id="21synchronized_89"></a>2.1、synchronized作用在代码块时</h4> 
<p>它的底层是通过<strong>monitorenter</strong>、<strong>monitorexit</strong>指令来实现的。</p> 
<h5><a id="monitorenter_91"></a>monitorenter：</h5> 
<p>每个对象都是一个监视器锁（monitor），当monitor被占用时就会处于锁定状态，线程执行<br> monitorenter指令时尝试获取monitor的所有权，过程如下：</p> 
<p>如果monitor的进入数为0，则该线程进入monitor，然后将进入数设置为1，该线程即为monitor<br> 的所有者。如果线程已经占有该monitor，只是重新进入，则进入monitor的进入数加1。如果其<br> 他线程已经占用了monitor，则该线程进入阻塞状态，直到monitor的进入数为0，再重新尝试获<br> 取monitor的所有权。</p> 
<h5><a id="monitorexit_99"></a>monitorexit：</h5> 
<p>执行monitorexit的线程必须是objectref所对应的monitor持有者。<br> 指令执行时，monitor的进入数减1，如果减1后进入数为0，那线程退出monitor，不再是这个monitor的所有者。其他被这个monitor阻塞的线程可以尝试去获取这个monitor的所有权。<br> monitorexit指令出现了两次，第1次为同步正常退出释放锁，第2次为发生异常退出释放锁。</p> 
<h4><a id="22_103"></a>2.2、方法的同步</h4> 
<p>并没有通过 monitorenter 和 monitorexit 指令来完成，不过相对于普通方法，其常量<br> 池中多了 <strong>ACC_SYNCHRONIZED</strong> 标示符。JVM就是根据该标示符来实现方法的同步的：<br> 当方法调用时，调用指令将会检查方法的 ACC_SYNCHRONIZED 访问标志是否被设置，如果设置了，执行线程将先获取monitor，获取成功之后才能执行方法体，方法执行完后再释放monitor。在方法执行期间，其他任何线程都无法再获得同一个monitor对象。</p> 
<h4><a id="23_107"></a>2.3、总结</h4> 
<p>两种同步方式本质上没有区别，只是方法的同步是一种隐式的方式来实现，无需通过字节码来完成。两个指令的执行是JVM通过调用操作系统的<strong>互斥原语mutex</strong>来实现，被阻塞的线程会被挂起、等待重新调度，会导致“用户态和内核态”两个态之间来回切换，对性能有较大影响。</p> 
<h4><a id="24javap_v_109"></a>2.4、javap -v</h4> 
<p>为了更直观的看见monitorenter、monitorexit、ACC_SYNCHRONIZED这些指令和标识，我们可以使用java提供的javap -v指令将字节码文件反编译。<br> 这里是包含同步代码块、同步方法、静态同步方法的类：</p> 
<pre><code class="prism language-java"><span class="token comment">//</span>
<span class="token comment">// Source code recreated from a .class file by IntelliJ IDEA</span>
<span class="token comment">// (powered by FernFlower decompiler)</span>
<span class="token comment">//</span>

<span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>bilibili<span class="token punctuation">.</span>juc<span class="token punctuation">.</span>locks</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LockSyncDemo</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Object</span> object <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">LockSyncDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

<span class="token comment">//同步代码块</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">m1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>object<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"----hello synchronized code block"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"-----exp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token comment">//同步方法</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">m2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"----hello synchronized m2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token comment">//静态同步类</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">m3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"----hello static synchronized m3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>将其字解码反编译：<br> <img src="https://images2.imgbox.com/56/53/4km7LZl3_o.png" alt="在这里插入图片描述"></p> 
<p>m1<br> <img src="https://images2.imgbox.com/ab/85/xOJvlld4_o.png" alt="在这里插入图片描述"><br> m2、m3<br> <img src="https://images2.imgbox.com/a0/56/9hJhS5sj_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3Vs_158"></a>3.公平锁Vs非公平锁</h3> 
<h4><a id="31_159"></a>3.1公平锁</h4> 
<p>公平锁是指几个线程共同竞争锁，如果竞争到了锁，则占有，没有竞争到锁的线程会被依次存放在一个FIFO的双向链表中，等占有锁的线程执行完任务释放锁之后，排在双向链表头结点后一个的线程被唤醒再来获取锁。如此反复。</p> 
<p>双向链表图：<br> head处存的是站有锁的线程的信息<br> <img src="https://images2.imgbox.com/9b/fd/4q1DEeEW_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="32_165"></a>3.2非公平锁</h4> 
<p>非公平锁是指几个线程共同竞争锁，如果锁已经被一个线程占用了，后续的线程不会像公平锁一样直接依次存放在FIFO的双向链表中，而是每次来一个线程都要尝试获取锁，如果没获取到则依次存入双向链表，如果获取到了那就直接占有锁，尽管双向链表中还有线程在等待，可以理解为插队了。</p> 
<p>在java锁的实现如synchronized和ReentrantLock中，synchronized是非公平锁，而ReentrantLock默认是非公平锁。<br> <strong>为什么都要优先使用非公平锁呢？</strong><br> 因为这涉及到一个效率问题，公平锁中如果锁当前被占用，后续的线程会在双向队列中阻塞等待，锁被释放后，再从双向队列中唤醒下一个线程，这就涉及到了上下文切换，核心态到用户态的切换，效率更低。<br> 而非公平锁，在当前锁被占用的情况下，后续线程来了会直接尝试获取锁，如果恰好锁被释放了，后续线程就可以直接获取锁执行操作，避免了上下文切换。</p> 
<h3><a id="4_172"></a>4.重入锁</h3> 
<p>重入锁是指线程已经获取了锁，这个线程再次获取这把锁不会阻塞。</p> 
<h4><a id="41synchronized__174"></a>4.1synchronized （隐式重入</h4> 
<p>java中的sychronized和Lock都是重入锁实现。<br> 示例：<br> 在方法reEntryM1()中使用同一个线程嵌套使用Synchronized，结果正常执行</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>bilibili<span class="token punctuation">.</span>juc<span class="token punctuation">.</span>locks</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * @auther zzyy
 * @create 2022-01-18 18:09
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReEntryLockDemo</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">reEntryM1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">reEntryM1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token class-name">Object</span> object <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>object<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t ----外层调用"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>object<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t ----中层调用"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>object<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t ----内层调用"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"t1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/5f/0a/pVJiVYW2_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="42__206"></a>4.2 实现原理</h4> 
<p>在前面讲synchronized关键字的时候我们提到了monitor这个底层的锁，其实在底层的ObjectMonitor.hpp（锁对象monitor）中有很多属性，其中有几个关键属性列在下面表格中。</p> 
<p><img src="https://images2.imgbox.com/d2/1b/AYOIsAix_o.png" alt="在这里插入图片描述"><br> 注意看到有一个属性叫 <strong>_recursions</strong>,当同一个线程获取已经被该线程获取到的锁时，该锁对象会调用monitorenter并且_recursions+1，当释放锁时，调用monitorexit并且_recursions-1。如果recursions=0了，则当前锁已经完全被释放了。<br> 注意：<br> 但是在判断当前锁是否已经被线程占用了不是用_recursions字段，而是判断_count字段是否尾0，monitorenter，_count++; monitorexit，_count–;<br> 现在我们按照这个思路来解释一下上面的代码：<br> <img src="https://images2.imgbox.com/2c/72/ZVgdTocw_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="43_Lock__215"></a>4.3 Lock （显示重入</h4> 
<p>lock接口需要手动释放锁，为了避免死锁，每次lock()之后最好在finally中unlock()</p> 
<pre><code class="prism language-java">    <span class="token keyword">static</span> <span class="token class-name">Lock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ReEntryLockDemo</span> reEntryLockDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReEntryLockDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t ----come in外层调用"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t ----come in内层调用"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 由于加锁次数和释放次数不一样，第二个线程始终无法获取到锁，导致一直在等待。</span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 正常情况，加锁几次就要解锁几次</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"t1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>加锁和解锁需要一一对应<br> <img src="https://images2.imgbox.com/3b/c9/jDaaeKol_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="44__241"></a>4.4 死锁产生的原因以及排查手法</h4> 
<p>死锁产生的原因可以用一句话概括：我占用着你需要的资源，你占用着我需要的资源，并且彼此都需要两个资源才能完成任务。<br> <strong>代码演示：</strong><br> 线程A此时需要锁对象objectB，但是锁对象objectB被B线程占用着。<br> 线程B此时需要锁对象objectA，但是锁对象objectA被A线程占用着。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeadLockDemo</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token class-name">Object</span> objectA <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">Object</span> objectB <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>objectA<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"\t 自己持有A锁，希望获得B锁"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>objectB<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"\t 成功获得B锁"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>objectB<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"\t 自己持有B锁，希望获得A锁"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>objectA<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"\t 成功获得A锁"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"B"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>运行结果：<br> 死锁了。<img src="https://images2.imgbox.com/21/e6/bESbKXMu_o.png" alt="在这里插入图片描述"><br> 那么在开发中遇到死锁我们该如何排查呢？<br> <strong>方式一：命令终端</strong><br> ①jps -l<br> 找到当前运行的进程编号 15108<br> <img src="https://images2.imgbox.com/cf/d7/8KVakK5J_o.png" alt="在这里插入图片描述"><br> ②jstack 15108<br> 找到对应信息<br> <img src="https://images2.imgbox.com/57/ca/PIvDQEdp_o.png" alt="在这里插入图片描述"><br> 在信息的最下面还会告诉存在几个死锁<br> <img src="https://images2.imgbox.com/3c/bf/nPPUjmnj_o.png" alt="在这里插入图片描述"><br> <strong>方式二：图形化</strong><br> ①jconsole打开java监管图形化界面<br> <img src="https://images2.imgbox.com/dd/76/b8Kdg0Ai_o.png" alt="在这里插入图片描述"><br> ②找到进程<br> <img src="https://images2.imgbox.com/e5/c2/6bcj9E54_o.png" alt="在这里插入图片描述"><br> 找到以下模块，可以看见死锁的线程。<br> <img src="https://images2.imgbox.com/2d/aa/lZekz5zq_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="5synchronized_295"></a>5.synchronized加锁解锁流程图</h3> 
<p>解锁步骤recursions应该是- -,写错了<br> <img src="https://images2.imgbox.com/42/dc/ySmm6D3t_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4b9aaa76d173d023d27e69fde584f49c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">nacos的各个客户端的功能</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/43eaef6b754b160c434363584dfcfd92/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">解决报错：npm ERR! code 1</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>