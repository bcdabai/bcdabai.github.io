<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>手写RPC框架(一)服务端与消息编码 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="手写RPC框架(一)服务端与消息编码" />
<meta property="og:description" content="本文章是在按照《极客兔兔》的教程完成GEERPC框架时的笔记以及一些自己的理解与看法
原文连接
消息编码 使用 encoding/gob 实现消息的编解码(序列化与反序列化)
将请求和响应中的参数和返回值抽象为body
将服务信息如服务名，方法名等其他信息存放在Header中
type Header struct { ServiceMethod string Seq uint64 //requse ID Error string } ServiceMethod是服务名和方法名，通常与 Go 语言中的结构体和方法相映射。Seq是请求的序号，也可以认为是某个请求的 ID，用来区分不同的请求。Error是错误信息，客户端置为空，服务端如果如果发生错误，将错误信息置于 Error 中 消息的decode和encode的方式有很多，例如json,xml,protobuf 包括go特有的gob,所要实现的框架需要可以做到让用户自主选择编码方式。
为了实现不同的Codec实例，先对消息体编解码的接口进行抽象，抽象出Codec
type Codec interface { io.Closer ReadHeader(*Header) error ReadBody(interface{})error Write(*Header,interface{}) error } 将编码类型枚举出来，（此处只列出了god和josn）
//编码类型 type Type string const ( GobType Type =&#34;application/god&#34; JsonType Type =&#34;application/json&#34; //未实现 ) 因为不同的编码类型对应的函数方法也是不同的，为了方便管理，拿go中的map进行管理，在init函数中为不同编码类型注册对应的方法
var NewCodecFuncMap map[Type]NewCodecFunc func init(){ NewCodecFuncMap=make(map[Type]NewCodecFunc) NewCodecFuncMap[GobType]=NewGobCodec //为对应类型注册方法 } 具体实现 因为不同类型的编码方式，写法大致相同，所以在文章中只实现了gob一种
首先需要定义出GobCodec实例" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/06a76d42a3a4a37b1027930f49f35b8f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-25T21:41:02+08:00" />
<meta property="article:modified_time" content="2022-12-25T21:41:02+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">手写RPC框架(一)服务端与消息编码</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>本文章是在按照《极客兔兔》的教程完成GEERPC框架时的笔记以及一些自己的理解与看法<br> <a href="https://geektutu.com/post/geerpc-day1.html" rel="nofollow">原文连接</a></p> 
<h2><a id="_3"></a>消息编码</h2> 
<p>使用 encoding/gob 实现消息的编解码(序列化与反序列化)</p> 
<p>将请求和响应中的参数和返回值抽象为body<br> 将服务信息如服务名，方法名等其他信息存放在Header中</p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> Header <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	ServiceMethod <span class="token builtin">string</span>
	Seq           <span class="token builtin">uint64</span>  <span class="token comment">//requse ID</span>
	Error         <span class="token builtin">string</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li><code>ServiceMethod</code>是服务名和方法名，通常与 Go 语言中的结构体和方法相映射。</li><li><code>Seq</code>是请求的序号，也可以认为是某个请求的 ID，用来区分不同的请求。</li><li><code>Error</code>是错误信息，客户端置为空，服务端如果如果发生错误，将错误信息置于 Error 中</li></ul> 
<p>消息的decode和encode的方式有很多，例如json,xml,protobuf 包括go特有的gob,所要实现的框架需要可以做到让用户自主选择编码方式。<br> 为了实现不同的Codec实例，先对消息体编解码的接口进行抽象，抽象出Codec</p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> Codec <span class="token keyword">interface</span> <span class="token punctuation">{<!-- --></span>
	io<span class="token punctuation">.</span>Closer
	<span class="token function">ReadHeader</span><span class="token punctuation">(</span><span class="token operator">*</span>Header<span class="token punctuation">)</span> <span class="token builtin">error</span>                          
	<span class="token function">ReadBody</span><span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token builtin">error</span>
	<span class="token function">Write</span><span class="token punctuation">(</span><span class="token operator">*</span>Header<span class="token punctuation">,</span><span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>将编码类型枚举出来，（此处只列出了god和josn）</p> 
<pre><code class="prism language-go"><span class="token comment">//编码类型</span>
<span class="token keyword">type</span> Type <span class="token builtin">string</span> 

<span class="token keyword">const</span> <span class="token punctuation">(</span>
	GobType Type <span class="token operator">=</span><span class="token string">"application/god"</span>
	JsonType Type <span class="token operator">=</span><span class="token string">"application/json"</span> <span class="token comment">//未实现</span>
<span class="token punctuation">)</span>
</code></pre> 
<p>因为不同的编码类型对应的函数方法也是不同的，为了方便管理，拿go中的map进行管理，在init函数中为不同编码类型注册对应的方法</p> 
<pre><code class="prism language-go"><span class="token keyword">var</span> NewCodecFuncMap <span class="token keyword">map</span><span class="token punctuation">[</span>Type<span class="token punctuation">]</span>NewCodecFunc

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	NewCodecFuncMap<span class="token operator">=</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>Type<span class="token punctuation">]</span>NewCodecFunc<span class="token punctuation">)</span>
	NewCodecFuncMap<span class="token punctuation">[</span>GobType<span class="token punctuation">]</span><span class="token operator">=</span>NewGobCodec <span class="token comment">//为对应类型注册方法</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="_55"></a>具体实现</h2> 
<p>因为不同类型的编码方式，写法大致相同，所以在文章中只实现了gob一种</p> 
<p>首先需要定义出GobCodec实例</p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> GobCodec <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	conn io<span class="token punctuation">.</span>ReadWriteCloser
	buf  <span class="token operator">*</span>bufio<span class="token punctuation">.</span>Writer
	dec  <span class="token operator">*</span>gob<span class="token punctuation">.</span>Decoder
	enc  <span class="token operator">*</span>gob<span class="token punctuation">.</span>Encoder
<span class="token punctuation">}</span>

<span class="token keyword">var</span> <span class="token boolean">_</span> Codec <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>GobCodec<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">NewGobCodec</span><span class="token punctuation">(</span>conn io<span class="token punctuation">.</span>ReadWriteCloser<span class="token punctuation">)</span> Codec <span class="token punctuation">{<!-- --></span>
	buf <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewWriter</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>GobCodec<span class="token punctuation">{<!-- --></span>
		conn<span class="token punctuation">:</span> conn<span class="token punctuation">,</span>
		buf<span class="token punctuation">:</span>  buf<span class="token punctuation">,</span>
		dec<span class="token punctuation">:</span>  gob<span class="token punctuation">.</span><span class="token function">NewDecoder</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">,</span>
		enc<span class="token punctuation">:</span>  gob<span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>conn 通常是通过TCP建立socket时得到的连接实例，由构建函数传入</li><li>buf 一个带缓冲的Writer,防止阻塞</li><li>dec gob的Decoder实例，将从conn中读取的信息进行解码</li><li>enc gob的Encoder实例，将信息进行编码，写到conn中<br> (此处笔者其实有一个疑问，为什么只加入写缓冲，不加入读缓冲，加入读缓冲是否也能带来性能的提升)</li></ul> 
<p>var _ Codec = (*GobCodec)(nil) 作用其实就是检查GobCodec是否将Codec中的方法都全部实现</p> 
<p>接下来就是Codec中方法的具体实现</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>GobCodec<span class="token punctuation">)</span> <span class="token function">ReadHeader</span><span class="token punctuation">(</span>h <span class="token operator">*</span>Header<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> c<span class="token punctuation">.</span>dec<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>GobCodec<span class="token punctuation">)</span> <span class="token function">ReadBody</span><span class="token punctuation">(</span>body <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> c<span class="token punctuation">.</span>dec<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c<span class="token operator">*</span>GobCodec<span class="token punctuation">)</span><span class="token function">Write</span><span class="token punctuation">(</span>h<span class="token operator">*</span>Header<span class="token punctuation">,</span>body <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token boolean">_</span><span class="token operator">=</span>c<span class="token punctuation">.</span>buf<span class="token punctuation">.</span><span class="token function">Flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//刷新写缓冲区</span>
		<span class="token keyword">if</span> err<span class="token operator">!=</span><span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			<span class="token boolean">_</span><span class="token operator">=</span>c<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> err<span class="token operator">:=</span>c<span class="token punctuation">.</span>enc<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>err<span class="token operator">!=</span><span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"rpc codec:gob error edcoding header:"</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err<span class="token operator">:=</span>c<span class="token punctuation">.</span>enc<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>err<span class="token operator">!=</span><span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Panicln</span><span class="token punctuation">(</span><span class="token string">"rpc codec:god error encoding body:"</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>



<span class="token keyword">func</span> <span class="token punctuation">(</span>c<span class="token operator">*</span>GobCodec<span class="token punctuation">)</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> c<span class="token punctuation">.</span>conn<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="server_128"></a>server部分</h2> 
<p>客户端与服务端的通信需要协商一些内容，例如 HTTP 报文，分为 header 和 body 2 部分，body 的格式和长度通过 header 中的 Content-Type 和 Content-Length 指定，服务端通过解析 header 就能够知道如何从 body 中读取需要的信息。对于 RPC 协议来说，这部分协商是需要自主设计的。为了提升性能，一般在报文的最开始会规划固定的字节，来协商相关的信息。比如第1个字节用来表示序列化方式，第2个字节表示压缩方式，第3-6字节表示 header 的长度，7-10 字节表示 body 的长度。</p> 
<p>对于 GeeRPC 来说，目前需要协商的唯一一项内容是消息的编解码方式。我们将这部分信息，放到结构体 Option 中承载。</p> 
<pre><code class="prism language-go"><span class="token keyword">const</span> MagicNumber <span class="token operator">=</span> <span class="token number">0x3bef5c</span> <span class="token comment">//3927900</span>

<span class="token keyword">type</span> Option <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	MagicNumber <span class="token builtin">int</span>
	CodcType    codec<span class="token punctuation">.</span>Type <span class="token comment">//客户端可以选择</span>
<span class="token punctuation">}</span>

<span class="token comment">// 默认选项</span>
<span class="token keyword">var</span> DefaultOption <span class="token operator">=</span> <span class="token operator">&amp;</span>Option<span class="token punctuation">{<!-- --></span>
	MagicNumber<span class="token punctuation">:</span> MagicNumber<span class="token punctuation">,</span>
	CodcType<span class="token punctuation">:</span>    codec<span class="token punctuation">.</span>GobType<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>为了简单，GeeRPC实现中，option固定采用json形式进行编码，后续的header和body的编码方式有option中的CodeType指定</p> 
<pre><code>| Option{MagicNumber: xxx, CodecType: xxx} | Header{ServiceMethod ...} | Body interface{} |
| &lt;------      固定 JSON 编码      ------&gt;  | &lt;-------   编码方式由 CodeType 决定   -------&gt;|
</code></pre> 
<h2><a id="_156"></a>服务端具体实现</h2> 
<pre><code class="prism language-go"><span class="token comment">// rpc server</span>
<span class="token keyword">type</span> Server <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

<span class="token comment">// return a new Server</span>
<span class="token keyword">func</span> <span class="token function">NewServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Server <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>Server<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 默认server实例</span>
<span class="token keyword">var</span> DefaultServer <span class="token operator">=</span> <span class="token function">NewServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 在监听器上接受连接并为请求提供服务</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>server <span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token function">Accept</span><span class="token punctuation">(</span>lis net<span class="token punctuation">.</span>Listener<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
		conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> lis<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"rpc server: accept error"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">go</span> server<span class="token punctuation">.</span><span class="token function">ServerCon</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Accept</span><span class="token punctuation">(</span>lis net<span class="token punctuation">.</span>Listener<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> DefaultServer<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span>lis<span class="token punctuation">)</span> <span class="token punctuation">}</span>
</code></pre> 
<p>for循环等待连接建立，将建立好的连接交给子协程处理，处理过程在ServerConn<br> 先用json解码获取option,然后个根据opt.CodcType，解码后续的header和body</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>srever <span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token function">ServerCon</span><span class="token punctuation">(</span>conn io<span class="token punctuation">.</span>ReadWriteCloser<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token boolean">_</span> <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">var</span> opt Option

	<span class="token keyword">if</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">NewDecoder</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>opt<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"rpc server: option error:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> opt<span class="token punctuation">.</span>MagicNumber <span class="token operator">!=</span> MagicNumber <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"rpc server:invalid magic number %x"</span><span class="token punctuation">,</span> opt<span class="token punctuation">.</span>MagicNumber<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//根据编码累类型获取相应函数</span>
	f <span class="token operator">:=</span> codec<span class="token punctuation">.</span>NewCodecFuncMap<span class="token punctuation">[</span>opt<span class="token punctuation">.</span>CodcType<span class="token punctuation">]</span>
	<span class="token keyword">if</span> f <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"rpc server:invaild codec type %s"</span><span class="token punctuation">,</span> opt<span class="token punctuation">.</span>CodcType<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	srever<span class="token punctuation">.</span><span class="token function">serverCodec</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>serveCodec 的过程非常简单。主要包含三个阶段</p> 
<ul><li>读取请求 readRequest</li><li>处理请求 handleRequest</li><li>回复请求 sendResponse<br> 之前提到过，在一次连接中，允许接收多个请求，即多个 request header 和 request body，因此这里使用了 for 无限制地等待请求的到来，直到发生错误（例如连接被关闭，接收到的报文有问题等），这里需要注意的点有三个：</li></ul> 
<p>handleRequest 使用了协程并发执行请求。<br> 处理请求是并发的，但是回复请求的报文必须是逐个发送的，并发容易导致多个回复报文交织在一起，客户端无法解析。在这里使用锁(sending)保证。<br> 尽力而为，只有在 header 解析失败时，才终止循环。</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>server <span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token function">serverCodec</span><span class="token punctuation">(</span>cc codec<span class="token punctuation">.</span>Codec<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	sending <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>sync<span class="token punctuation">.</span>Mutex<span class="token punctuation">)</span> <span class="token comment">//回复响应时并行回复</span>
	wg <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>sync<span class="token punctuation">.</span>WaitGroup<span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">//读取请求</span>
		req<span class="token punctuation">,</span> err <span class="token operator">:=</span> server<span class="token punctuation">.</span><span class="token function">readRequest</span><span class="token punctuation">(</span>cc<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> req <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">break</span> <span class="token comment">//无法恢复，关闭连接</span>
			<span class="token punctuation">}</span>
			req<span class="token punctuation">.</span>h<span class="token punctuation">.</span>Error <span class="token operator">=</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token comment">//回复请求</span>
			server<span class="token punctuation">.</span><span class="token function">sendResponse</span><span class="token punctuation">(</span>cc<span class="token punctuation">,</span> req<span class="token punctuation">.</span>h<span class="token punctuation">,</span> invalidRequest<span class="token punctuation">,</span> sending<span class="token punctuation">)</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token comment">//处理请求</span>
		<span class="token keyword">go</span> server<span class="token punctuation">.</span><span class="token function">handleRequest</span><span class="token punctuation">(</span>cc<span class="token punctuation">,</span> req<span class="token punctuation">,</span> sending<span class="token punctuation">,</span> wg<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//等待所有request处理完成才close</span>
	<span class="token boolean">_</span> <span class="token operator">=</span> cc<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>存放一次请求的所有信息</p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> request <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	h            <span class="token operator">*</span>codec<span class="token punctuation">.</span>Header
	argv<span class="token punctuation">,</span> replyv reflect<span class="token punctuation">.</span>Value
<span class="token punctuation">}</span>
</code></pre> 
<p>readRequest</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>server<span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token function">readRequestHeader</span><span class="token punctuation">(</span>cc codec<span class="token punctuation">.</span>Codec<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span>codec<span class="token punctuation">.</span>Header<span class="token punctuation">,</span><span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">var</span> h codec<span class="token punctuation">.</span>Header
	<span class="token keyword">if</span> err<span class="token operator">:=</span>cc<span class="token punctuation">.</span><span class="token function">ReadHeader</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>err<span class="token operator">!=</span><span class="token boolean">nil</span><span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> err<span class="token operator">!=</span>io<span class="token punctuation">.</span>EOF <span class="token operator">&amp;&amp;</span>err<span class="token operator">!=</span>io<span class="token punctuation">.</span>ErrUnexpectedEOF<span class="token punctuation">{<!-- --></span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"rpc serve:read header error:"</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span> <span class="token punctuation">,</span>err
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>h<span class="token punctuation">,</span><span class="token boolean">nil</span>
<span class="token punctuation">}</span>


<span class="token keyword">func</span> <span class="token punctuation">(</span>servre<span class="token operator">*</span>Server<span class="token punctuation">)</span><span class="token function">readRequest</span><span class="token punctuation">(</span>cc codec<span class="token punctuation">.</span>Codec<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>request<span class="token punctuation">,</span><span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	h<span class="token punctuation">,</span>err<span class="token operator">:=</span>servre<span class="token punctuation">.</span><span class="token function">readRequestHeader</span><span class="token punctuation">(</span>cc<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err<span class="token operator">!=</span><span class="token boolean">nil</span><span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span>err
	<span class="token punctuation">}</span>
	req<span class="token operator">:=</span><span class="token operator">&amp;</span>request<span class="token punctuation">{<!-- --></span>h<span class="token punctuation">:</span>h<span class="token punctuation">}</span>

	<span class="token comment">//通过反射机制创建实际类型</span>
	req<span class="token punctuation">.</span>argv<span class="token operator">=</span>reflect<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> err<span class="token operator">=</span>cc<span class="token punctuation">.</span><span class="token function">ReadBody</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">Interface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>err<span class="token operator">!=</span><span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"rpc server: read argv err:"</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> req<span class="token punctuation">,</span><span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>sendResponse</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>server<span class="token operator">*</span>Server<span class="token punctuation">)</span><span class="token function">sendResponse</span><span class="token punctuation">(</span>cc codec<span class="token punctuation">.</span>Codec<span class="token punctuation">,</span>h<span class="token operator">*</span>codec<span class="token punctuation">.</span>Header<span class="token punctuation">,</span>body <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>sending<span class="token operator">*</span>sync<span class="token punctuation">.</span>Mutex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">//因为客户端只是一个，为了防止客户端数据接收混乱，所以需要加锁</span>
	sending<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> sending<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err<span class="token operator">:=</span>cc<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>err<span class="token operator">!=</span><span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"rpc server:write response error:"</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>handleRequest</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span><span class="token punctuation">(</span>server<span class="token operator">*</span>Server<span class="token punctuation">)</span><span class="token function">handleRequest</span><span class="token punctuation">(</span>cc codec<span class="token punctuation">.</span>Codec<span class="token punctuation">,</span>req<span class="token operator">*</span>request<span class="token punctuation">,</span>sending<span class="token operator">*</span>sync<span class="token punctuation">.</span>Mutex<span class="token punctuation">,</span>wg<span class="token operator">*</span>sync<span class="token punctuation">.</span>WaitGroup<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	<span class="token comment">//应根据请求类型执行相应的Rpc方法（目前暂未实现服务注册，打印一句话来代替）</span>

	<span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>h<span class="token punctuation">,</span>req<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	req<span class="token punctuation">.</span>replyv<span class="token operator">=</span>reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"geerpc resp %d"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>req<span class="token punctuation">.</span>h<span class="token punctuation">.</span>Seq<span class="token punctuation">)</span><span class="token punctuation">)</span>
	server<span class="token punctuation">.</span><span class="token function">sendResponse</span><span class="token punctuation">(</span>cc<span class="token punctuation">,</span>req<span class="token punctuation">.</span>h<span class="token punctuation">,</span>req<span class="token punctuation">.</span>replyv<span class="token punctuation">.</span><span class="token function">Interface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>sending<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/69530acc7f6608ed96c3c1d757890231/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">insmod 驱动报错，sysfs: cannot create duplicate filename ‘/class/xxx‘</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/906d8fc304cce5830509240afc489b22/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">device_create() 创建设备节点，device_del()删除设备节点</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>