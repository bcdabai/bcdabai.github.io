<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>openGL兔兔大作业-面的鼠标拾取 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="openGL兔兔大作业-面的鼠标拾取" />
<meta property="og:description" content="好久没写过GL了，正好来发发教程
要求 给出兔兔的顶点坐标与三角面索引，需要实现：
绘制模型，冯氏光照模型及视角移动鼠标点选高亮某三角面 总体思路 &amp; 坑点 ​ For 可以自己实现OpenGL编写的朋友
导入模型 ：给出的数据为顶点坐标，没有法线信息，需要求解法线，在我的实现中对每一三角面根据三点坐标求解了法线，没有进行法线插值，这会使得兔兔表面不够圆润，并且需要 NumFace * 3 大小的VBO，较浪费空间。按道理可以对每一点求解法线，使用该点与邻接点的向量进行加权平均，具体可以参考链接 Weighted Vertex Normals
光照模型：没什么特别的，Blinn-Phong或者Phong的Shader
模型及视角移动：也没什么特别的，取下帧间鼠标Δ值和键盘按键变model view矩阵就行了
点选高亮：这个还蛮有趣的，想了个办法，应该不是最优解，用一个drawcall绘制一张每个面颜色都是该面索引值 / 总面数的RT，然后readBack一下鼠标位置的颜色，拿到高亮面的顶点，这里我直接再加了一个drawcall画这三角，应该是多余了。
实现细节 For 不怎么熟悉OpenGL的朋友
配置OpenGL环境 使用GLFW初始化窗口 GLFW is a lightweight utility library for use with OpenGL. GLFW stands for Graphics Library Framework. It provides programmers with the ability to create and manage windows and OpenGL contexts, as well as handle joystick, keyboard and mouse input. 一般使用GLFW作为跨平台的窗口工具，在本例中就作为创建OpenGL绘制窗口，处理鼠标键盘事件的API。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/df7261ec7cece607fd71cd7184de27e3/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-12-23T02:33:17+08:00" />
<meta property="article:modified_time" content="2020-12-23T02:33:17+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">openGL兔兔大作业-面的鼠标拾取</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>好久没写过GL了，正好来发发教程</p> 
<h3><a id="_2"></a>要求</h3> 
<p>给出兔兔的顶点坐标与三角面索引，需要实现：</p> 
<ol><li>绘制模型，冯氏光照</li><li>模型及视角移动</li><li>鼠标点选高亮某三角面</li></ol> 
<h3><a id="___12"></a>总体思路 &amp; 坑点</h3> 
<p>​ <em>For 可以自己实现OpenGL编写的朋友</em></p> 
<ul><li> <p>导入模型 ：给出的数据为顶点坐标，没有法线信息，需要求解法线，在我的实现中对每一三角面根据三点坐标求解了法线，没有进行法线插值，这会使得兔兔表面不够圆润，并且需要 NumFace * 3 大小的VBO，较浪费空间。按道理可以对每一点求解法线，使用该点与邻接点的向量进行加权平均，具体可以参考链接 <a href="http://www.bytehazard.com/articles/vertnorm.html" rel="nofollow">Weighted Vertex Normals</a></p> </li><li> <p>光照模型：没什么特别的，Blinn-Phong或者Phong的Shader</p> </li><li> <p>模型及视角移动：也没什么特别的，取下帧间鼠标Δ值和键盘按键变model view矩阵就行了</p> </li><li> <p>点选高亮：这个还蛮有趣的，想了个办法，应该不是最优解，用一个drawcall绘制一张每个面颜色都是该面索引值 / 总面数的RT，然后readBack一下鼠标位置的颜色，拿到高亮面的顶点，这里我直接再加了一个drawcall画这三角，应该是多余了。</p> </li></ul> 
<h3><a id="_26"></a>实现细节</h3> 
<p><em>For 不怎么熟悉OpenGL的朋友</em></p> 
<h5><a id="OpenGL_32"></a>配置OpenGL环境</h5> 
<ul><li>使用GLFW初始化窗口</li></ul> 
<pre><code>GLFW is a lightweight utility library for use with OpenGL. GLFW stands for Graphics Library Framework. It provides programmers with the ability to create and manage windows and OpenGL contexts, as well as handle joystick, keyboard and mouse input.
</code></pre> 
<p>一般使用GLFW作为跨平台的窗口工具，在本例中就作为创建OpenGL<strong>绘制窗口，处理鼠标键盘事件</strong>的API。</p> 
<ul><li>使用GLAD链接OpenGL API</li></ul> 
<p>可以简单认为，虽然各个平台都支持OpenGL绘制，但一般都仅仅是提供了按<strong>OpenGL标准</strong>所实现的二进制链接库，如WIndows下默认静态链接库会有opengl32.lib，但仍然需要一个第三方库去在运行时加载这一dll，提供一个符合标准的c++头文件，并且<strong>将二进制库中的实现加载</strong>到对应的函数API上。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> Application<span class="token operator">::</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//Initialize GLFW Window</span>
    <span class="token function">glfwInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glfwWindowHint</span><span class="token punctuation">(</span>GLFW_CONTEXT_VERSION_MAJOR<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glfwWindowHint</span><span class="token punctuation">(</span>GLFW_CONTEXT_VERSION_MINOR<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glfwWindowHint</span><span class="token punctuation">(</span>GLFW_OPENGL_PROFILE<span class="token punctuation">,</span> GLFW_OPENGL_CORE_PROFILE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glfwWindowHint</span><span class="token punctuation">(</span>GLFW_OPENGL_FORWARD_COMPAT<span class="token punctuation">,</span> GL_TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    window <span class="token operator">=</span> <span class="token function">glfwCreateWindow</span><span class="token punctuation">(</span><span class="token number">800</span><span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">,</span> <span class="token string">"Bunny"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>window <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to create GLFW window"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
        <span class="token function">glfwTerminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">glfwMakeContextCurrent</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//Initialize GLAD</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">gladLoadGLLoader</span><span class="token punctuation">(</span><span class="token punctuation">(</span>GLADloadproc<span class="token punctuation">)</span>glfwGetProcAddress<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to initialize GLAD"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">glfwSetFramebufferSizeCallback</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> framebuffer_size_callback<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//Read Data From File &amp; Initialize VAOs FBOs</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">glfwWindowShouldClose</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">Render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//Main Render Function</span>
        <span class="token function">glfwSwapBuffers</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">glfwPollEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">glfwTerminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_82"></a>处理输入</h5> 
<ul><li>将所有点与索引输入，按面顺序排序，每个点有7个float的长度： 
  <ul><li>位置：vec3</li><li>法线：vec3</li><li>面编号（归一化）：float</li></ul> </li></ul> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> Application<span class="token operator">::</span><span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//Read From File</span>
    std<span class="token operator">::</span>ifstream <span class="token function">fin</span><span class="token punctuation">(</span><span class="token string">"bunny_iH.ply2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fin<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">assert</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    numVertices <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    fin <span class="token operator">&gt;&gt;</span> numVertices<span class="token punctuation">;</span>
    fin <span class="token operator">&gt;&gt;</span> numFaces<span class="token punctuation">;</span>
    vertices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">(</span>size_t<span class="token punctuation">)</span>numVertices <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    sortedVertices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">(</span>size_t<span class="token punctuation">)</span>numFaces <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">*</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numVertices<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        fin <span class="token operator">&gt;&gt;</span> vertices<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">&gt;&gt;</span> vertices<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&gt;&gt;</span> vertices<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numFaces<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">;</span>
        fin <span class="token operator">&gt;&gt;</span> a <span class="token operator">&gt;&gt;</span> b <span class="token operator">&gt;&gt;</span> c <span class="token operator">&gt;&gt;</span> d<span class="token punctuation">;</span>    <span class="token comment">// a always equals to 3</span>

        <span class="token keyword">int</span> v1 <span class="token operator">=</span> i <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> v2 <span class="token operator">=</span> i <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> v3 <span class="token operator">=</span> i <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>

        <span class="token comment">// position : vec3      [v*7, v*7+2]</span>
        <span class="token comment">// normal : vec3        [v*7+3, v*7+5]</span>
        <span class="token comment">// faceIndex : float    [v*7+6, v*7+6]</span>

        sortedVertices<span class="token punctuation">[</span>v1 <span class="token operator">*</span> <span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> vertices<span class="token punctuation">[</span>b <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        sortedVertices<span class="token punctuation">[</span>v1 <span class="token operator">*</span> <span class="token number">7</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> vertices<span class="token punctuation">[</span>b <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        sortedVertices<span class="token punctuation">[</span>v1 <span class="token operator">*</span> <span class="token number">7</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> vertices<span class="token punctuation">[</span>b <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        sortedVertices<span class="token punctuation">[</span>v2 <span class="token operator">*</span> <span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> vertices<span class="token punctuation">[</span>c <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        sortedVertices<span class="token punctuation">[</span>v2 <span class="token operator">*</span> <span class="token number">7</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> vertices<span class="token punctuation">[</span>c <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        sortedVertices<span class="token punctuation">[</span>v2 <span class="token operator">*</span> <span class="token number">7</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> vertices<span class="token punctuation">[</span>c <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        sortedVertices<span class="token punctuation">[</span>v3 <span class="token operator">*</span> <span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> vertices<span class="token punctuation">[</span>d <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        sortedVertices<span class="token punctuation">[</span>v3 <span class="token operator">*</span> <span class="token number">7</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> vertices<span class="token punctuation">[</span>d <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        sortedVertices<span class="token punctuation">[</span>v3 <span class="token operator">*</span> <span class="token number">7</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> vertices<span class="token punctuation">[</span>d <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">float</span><span class="token operator">*</span> normal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">calcNormal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sortedVertices<span class="token punctuation">[</span>v1 <span class="token operator">*</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>sortedVertices<span class="token punctuation">[</span>v2 <span class="token operator">*</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>sortedVertices<span class="token punctuation">[</span>v3 <span class="token operator">*</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span> normal<span class="token punctuation">)</span><span class="token punctuation">;</span>

        sortedVertices<span class="token punctuation">[</span>v1 <span class="token operator">*</span> <span class="token number">7</span> <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> normal<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        sortedVertices<span class="token punctuation">[</span>v1 <span class="token operator">*</span> <span class="token number">7</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> normal<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        sortedVertices<span class="token punctuation">[</span>v1 <span class="token operator">*</span> <span class="token number">7</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> normal<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        sortedVertices<span class="token punctuation">[</span>v1 <span class="token operator">*</span> <span class="token number">7</span> <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>i <span class="token operator">/</span> numFaces<span class="token punctuation">;</span>

        sortedVertices<span class="token punctuation">[</span>v2 <span class="token operator">*</span> <span class="token number">7</span> <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> normal<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        sortedVertices<span class="token punctuation">[</span>v2 <span class="token operator">*</span> <span class="token number">7</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> normal<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        sortedVertices<span class="token punctuation">[</span>v2 <span class="token operator">*</span> <span class="token number">7</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> normal<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        sortedVertices<span class="token punctuation">[</span>v2 <span class="token operator">*</span> <span class="token number">7</span> <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>i <span class="token operator">/</span> numFaces<span class="token punctuation">;</span>

        sortedVertices<span class="token punctuation">[</span>v3 <span class="token operator">*</span> <span class="token number">7</span> <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> normal<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        sortedVertices<span class="token punctuation">[</span>v3 <span class="token operator">*</span> <span class="token number">7</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> normal<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        sortedVertices<span class="token punctuation">[</span>v3 <span class="token operator">*</span> <span class="token number">7</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> normal<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        sortedVertices<span class="token punctuation">[</span>v3 <span class="token operator">*</span> <span class="token number">7</span> <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>i <span class="token operator">/</span> numFaces<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    fin<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>求面法线：求两向量叉积，实现为化简过后的过程。</li></ul> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">calcNormal</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token operator">*</span> v1<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">*</span> v2<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">*</span> v3<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">*</span> nor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">float</span> na <span class="token operator">=</span> <span class="token punctuation">(</span>v2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> v1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>v3<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> v1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>v2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> v1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>v3<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> v1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> nb <span class="token operator">=</span> <span class="token punctuation">(</span>v2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> v1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>v3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> v1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>v2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> v1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>v3<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> v1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> nc <span class="token operator">=</span> <span class="token punctuation">(</span>v2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> v1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>v3<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> v1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>v2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> v1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>v3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> v1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    nor<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> na<span class="token punctuation">;</span>
    nor<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> nb<span class="token punctuation">;</span>
    nor<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> nc<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="Shader_166"></a>初始化Shader</h5> 
<ul><li> <p>本实现中使用了三个Shader，分别用于绘制面索引，光照模型，高亮三角</p> <pre><code class="prism language-cpp"><span class="token keyword">void</span> Application<span class="token operator">::</span><span class="token function">InitShader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>   
    mShaders<span class="token punctuation">[</span><span class="token string">"BlinnPhong"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Shader</span><span class="token punctuation">(</span><span class="token string">"BlinnPhong"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mShaders<span class="token punctuation">[</span><span class="token string">"FaceIndex"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Shader</span><span class="token punctuation">(</span><span class="token string">"FaceIndex"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mShaders<span class="token punctuation">[</span><span class="token string">"postprocess"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Shader</span><span class="token punctuation">(</span><span class="token string">"postprocess"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p>从文件读入Shader代码（这里有个bug，在文件尾会读入几个乱码字符，这里在shader最后<strong>手动加换行</strong>暂时删掉了乱码）</p> <pre><code class="prism language-cpp">Shader<span class="token operator">::</span><span class="token function">Shader</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> shaderName<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> std<span class="token operator">::</span>string vertShaderName <span class="token operator">=</span> shaderName <span class="token operator">+</span> <span class="token string">".vert"</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> std<span class="token operator">::</span>string fragShaderName <span class="token operator">=</span> shaderName <span class="token operator">+</span> <span class="token string">".frag"</span><span class="token punctuation">;</span>
    std<span class="token operator">::</span>ifstream <span class="token function">vertFile</span><span class="token punctuation">(</span>vertShaderName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token operator">::</span>ifstream <span class="token function">fragFile</span><span class="token punctuation">(</span>fragShaderName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>vertFile <span class="token operator">||</span> <span class="token operator">!</span>fragFile<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">assert</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    vertFile<span class="token punctuation">.</span><span class="token function">seekg</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> std<span class="token operator">::</span>ios<span class="token operator">::</span>end<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> length <span class="token operator">=</span> vertFile<span class="token punctuation">.</span><span class="token function">tellg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    GLchar<span class="token operator">*</span> vertexShaderCode <span class="token operator">=</span> <span class="token keyword">new</span> GLchar<span class="token punctuation">[</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
    vertFile<span class="token punctuation">.</span><span class="token function">seekg</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> std<span class="token operator">::</span>ios<span class="token operator">::</span>beg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    vertFile<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>vertexShaderCode<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>vertexShaderCode<span class="token punctuation">[</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'\n'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>	<span class="token comment">//TODO</span>
        vertexShaderCode<span class="token punctuation">[</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        length<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    fragFile<span class="token punctuation">.</span><span class="token function">seekg</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> std<span class="token operator">::</span>ios<span class="token operator">::</span>end<span class="token punctuation">)</span><span class="token punctuation">;</span>
    length <span class="token operator">=</span> fragFile<span class="token punctuation">.</span><span class="token function">tellg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    GLchar<span class="token operator">*</span> fragmentShaderCode <span class="token operator">=</span> <span class="token keyword">new</span> GLchar<span class="token punctuation">[</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
    fragFile<span class="token punctuation">.</span><span class="token function">seekg</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> std<span class="token operator">::</span>ios<span class="token operator">::</span>beg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    fragFile<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>fragmentShaderCode<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>fragmentShaderCode<span class="token punctuation">[</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'\n'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//TODO</span>
        fragmentShaderCode<span class="token punctuation">[</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        length<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre> </li><li> <p>编译Shader代码</p> </li></ul> 
<pre><code class="prism language-cpp">    GLuint VertexShader <span class="token operator">=</span> <span class="token function">glCreateShader</span><span class="token punctuation">(</span>GL_VERTEX_SHADER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glShaderSource</span><span class="token punctuation">(</span>VertexShader<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>vertexShaderCode<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glCompileShader</span><span class="token punctuation">(</span>VertexShader<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GLuint FragmentShader <span class="token operator">=</span> <span class="token function">glCreateShader</span><span class="token punctuation">(</span>GL_FRAGMENT_SHADER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glShaderSource</span><span class="token punctuation">(</span>FragmentShader<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>fragmentShaderCode<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glCompileShader</span><span class="token punctuation">(</span>FragmentShader<span class="token punctuation">)</span><span class="token punctuation">;</span>


    mProgramID <span class="token operator">=</span> <span class="token function">glCreateProgram</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glAttachShader</span><span class="token punctuation">(</span>mProgramID<span class="token punctuation">,</span> VertexShader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glAttachShader</span><span class="token punctuation">(</span>mProgramID<span class="token punctuation">,</span> FragmentShader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glLinkProgram</span><span class="token punctuation">(</span>mProgramID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glUseProgram</span><span class="token punctuation">(</span>mProgramID<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GLint success<span class="token punctuation">;</span>
    <span class="token function">glGetProgramiv</span><span class="token punctuation">(</span>mProgramID<span class="token punctuation">,</span> GL_LINK_STATUS<span class="token punctuation">,</span> <span class="token operator">&amp;</span>success<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        GLchar infoLog<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">glGetProgramInfoLog</span><span class="token punctuation">(</span>mProgramID<span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> infoLog<span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> infoLog <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">glDeleteShader</span><span class="token punctuation">(</span>VertexShader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glDeleteShader</span><span class="token punctuation">(</span>FragmentShader<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>传入uniform 以及 绑定program</li></ul> 
<pre><code class="prism language-cpp"><span class="token comment">// Check location</span>
<span class="token macro property">#<span class="token directive keyword">define</span> CHECK_LOC(loc) \
    if(loc == -1){  \
        assert(false);\
    }</span>

<span class="token keyword">void</span> Shader<span class="token operator">::</span><span class="token function">SetMat</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> <span class="token keyword">const</span> glm<span class="token operator">::</span>mat4<span class="token operator">&amp;</span> mat<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    GLint loc <span class="token operator">=</span> <span class="token function">glGetUniformLocation</span><span class="token punctuation">(</span>mProgramID<span class="token punctuation">,</span> name<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CHECK_LOC</span><span class="token punctuation">(</span>loc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glUniformMatrix4fv</span><span class="token punctuation">(</span>loc<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> GL_FALSE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//setVec.......</span>
<span class="token comment">//setFloat.....</span>
<span class="token comment">//setInt.......</span>

<span class="token keyword">void</span> Shader<span class="token operator">::</span><span class="token function">Bind</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">glUseProgram</span><span class="token punctuation">(</span>mProgramID<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_270"></a>初始化顶点缓冲</h5> 
<ul><li>主顶点缓冲，包含所有顶点信息</li></ul> 
<pre><code class="prism language-cpp">
    <span class="token function">InitShader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">glGenVertexArrays</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>vao<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//Vertex Array Buffer</span>
    <span class="token function">glBindVertexArray</span><span class="token punctuation">(</span>vao<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GLuint vbo<span class="token punctuation">;</span>
    <span class="token function">glGenBuffers</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>vbo<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//Vertex Buffer Object</span>
    <span class="token function">glBindBuffer</span><span class="token punctuation">(</span>GL_ARRAY_BUFFER<span class="token punctuation">,</span> vbo<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//Total size : Face Number * 3 * sizeof(Per Vertex) </span>
    <span class="token function">glBufferData</span><span class="token punctuation">(</span>GL_ARRAY_BUFFER<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> <span class="token operator">*</span> numFaces <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">*</span> <span class="token number">7</span><span class="token punctuation">,</span> sortedVertices<span class="token punctuation">,</span> GL_STATIC_DRAW<span class="token punctuation">)</span><span class="token punctuation">;</span> 

	<span class="token comment">//Set Per Vertex Data Format</span>
    <span class="token function">glVertexAttribPointer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> GL_FLOAT<span class="token punctuation">,</span> GL_FALSE<span class="token punctuation">,</span> <span class="token number">7</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>					<span class="token comment">//position</span>
    <span class="token function">glVertexAttribPointer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> GL_FLOAT<span class="token punctuation">,</span> GL_FALSE<span class="token punctuation">,</span> <span class="token number">7</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//normal</span>
    <span class="token function">glVertexAttribPointer</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> GL_FLOAT<span class="token punctuation">,</span> GL_FALSE<span class="token punctuation">,</span> <span class="token number">7</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//FaceIndex</span>

    <span class="token function">glEnableVertexAttribArray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glEnableVertexAttribArray</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glEnableVertexAttribArray</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>高亮三角缓冲，仅三个点，使用<strong>Dynamic Draw</strong>声明该数据会实时变化，令GPU对数据存储进行优化</li></ul> 
<pre><code class="prism language-cpp">	<span class="token function">glGenVertexArrays</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>CoveredVAO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glBindVertexArray</span><span class="token punctuation">(</span>CoveredVAO<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">glGenBuffers</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>CoveredVBO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glBindBuffer</span><span class="token punctuation">(</span>GL_ARRAY_BUFFER<span class="token punctuation">,</span> CoveredVBO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glBufferData</span><span class="token punctuation">(</span>GL_ARRAY_BUFFER<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> GL_DYNAMIC_DRAW<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// A hint for GPU to optimize VBO</span>

    <span class="token function">glVertexAttribPointer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> GL_FLOAT<span class="token punctuation">,</span> GL_FALSE<span class="token punctuation">,</span> <span class="token number">3</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glEnableVertexAttribArray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<h5><a id="FrameBuffers_314"></a>初始化FrameBuffers</h5> 
<ul><li>一个FrameBuffer表示一组Render Target（可以理解为绘制到的一张窗口大小的图片）的集合，包含若干color attachment以及一个depth-stencil attachment，本例中为了绘制FaceIndex使用一个R32F的纹理作为RT绑定。</li></ul> 
<pre><code class="prism language-cpp">    <span class="token function">glGenFramebuffers</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>FaceIndexFBO<span class="token punctuation">)</span><span class="token punctuation">;</span>							<span class="token comment">// generate frame buffer</span>
    <span class="token function">glBindFramebuffer</span><span class="token punctuation">(</span>GL_FRAMEBUFFER<span class="token punctuation">,</span> FaceIndexFBO<span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">// bind frame buffer</span>
    <span class="token function">glGenTextures</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>FaceIndexTex<span class="token punctuation">)</span><span class="token punctuation">;</span>								<span class="token comment">// generate the texture to storage FaceIndex</span>
    <span class="token function">glBindTexture</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> FaceIndexTex<span class="token punctuation">)</span><span class="token punctuation">;</span>						<span class="token comment">// bind texture</span>
    <span class="token function">glTexImage2D</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GL_R32F<span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GL_RED<span class="token punctuation">,</span> GL_FLOAT<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// Set texture Format to R32F</span>
    <span class="token function">glFramebufferTexture2D</span><span class="token punctuation">(</span>GL_FRAMEBUFFER<span class="token punctuation">,</span> GL_COLOR_ATTACHMENT0<span class="token punctuation">,</span> GL_TEXTURE_2D<span class="token punctuation">,</span> FaceIndexTex<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// Bind as Color Attachment 0 of the FrameBuffer</span>
</code></pre> 
<h5><a id="_329"></a>主绘制流程</h5> 
<ul><li>处理鼠标输入</li></ul> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> Application<span class="token operator">::</span><span class="token function">HandleMouse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">glfwGetCursorPos</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> <span class="token operator">&amp;</span>MouseX<span class="token punctuation">,</span> <span class="token operator">&amp;</span>MouseY<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// Use GLFW API to get current Mouse Postion</span>
    <span class="token keyword">auto</span> MouseDelta <span class="token operator">=</span> glm<span class="token operator">::</span><span class="token function">vec2</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">// Delta Vector between last and current</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>LastMouseX <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> LastMouseY <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>		<span class="token comment">// if last pos is legal (in the window)</span>
        MouseDelta <span class="token operator">=</span> glm<span class="token operator">::</span><span class="token function">vec2</span><span class="token punctuation">(</span>MouseX <span class="token operator">-</span> LastMouseX<span class="token punctuation">,</span> MouseY <span class="token operator">-</span> LastMouseY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">auto</span> state <span class="token operator">=</span> <span class="token function">glfwGetMouseButton</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> GLFW_MOUSE_BUTTON_LEFT<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// Get current left button state</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> GLFW_PRESS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>	<span class="token comment">// if left buttton is pressed</span>
        <span class="token comment">// rotate viewDir around vertical axis (Up)</span>
        viewDir <span class="token operator">=</span> glm<span class="token operator">::</span><span class="token function">mat3</span><span class="token punctuation">(</span>glm<span class="token operator">::</span><span class="token function">rotate</span><span class="token punctuation">(</span>MouseDelta<span class="token punctuation">.</span>x <span class="token operator">*</span> <span class="token number">0.0015f</span><span class="token punctuation">,</span> viewUp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> viewDir<span class="token punctuation">;</span>
        <span class="token comment">// rotate viewDir around horizontal axis (ViewUp x ViewDir)</span>
        viewDir <span class="token operator">=</span> glm<span class="token operator">::</span><span class="token function">mat3</span><span class="token punctuation">(</span>glm<span class="token operator">::</span><span class="token function">rotate</span><span class="token punctuation">(</span><span class="token operator">-</span>MouseDelta<span class="token punctuation">.</span>y <span class="token operator">*</span> <span class="token number">0.003f</span><span class="token punctuation">,</span> glm<span class="token operator">::</span><span class="token function">cross</span><span class="token punctuation">(</span>viewUp<span class="token punctuation">,</span> viewDir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> viewDir<span class="token punctuation">;</span>

        LastMouseX <span class="token operator">=</span> MouseX<span class="token punctuation">;</span>
        LastMouseY <span class="token operator">=</span> MouseY<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        LastMouseX <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1.0f</span><span class="token punctuation">;</span>
        LastMouseX <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1.0f</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<ul><li> <p>绘制顶点索引</p> <pre><code class="prism language-cpp"><span class="token keyword">void</span> Application<span class="token operator">::</span><span class="token function">Render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">HandleMouse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glEnable</span><span class="token punctuation">(</span>GL_CULL_FACE<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// NOTICE : Must Enable Cull Face to ensure NOT rendering back face of the BUNNY !!!</span>
    <span class="token function">glEnable</span><span class="token punctuation">(</span>GL_DEPTH_TEST<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glBindVertexArray</span><span class="token punctuation">(</span>vao<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glClear</span><span class="token punctuation">(</span>GL_COLOR_BUFFER_BIT <span class="token operator">|</span> GL_DEPTH_BUFFER_BIT<span class="token punctuation">)</span><span class="token punctuation">;</span>

    glm<span class="token operator">::</span>mat4 projection <span class="token operator">=</span> glm<span class="token operator">::</span><span class="token function">perspective</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>glm<span class="token operator">::</span><span class="token function">radians</span><span class="token punctuation">(</span><span class="token number">45.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">800.0f</span> <span class="token operator">/</span> <span class="token number">600.0f</span><span class="token punctuation">,</span> <span class="token number">0.1f</span><span class="token punctuation">,</span> <span class="token number">100.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    glm<span class="token operator">::</span>mat4 model <span class="token operator">=</span> glm<span class="token operator">::</span><span class="token function">scale</span><span class="token punctuation">(</span>glm<span class="token operator">::</span><span class="token function">mat4</span><span class="token punctuation">(</span><span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">,</span> glm<span class="token operator">::</span><span class="token function">vec3</span><span class="token punctuation">(</span><span class="token number">5.0f</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    glm<span class="token operator">::</span>mat4 view <span class="token operator">=</span> glm<span class="token operator">::</span><span class="token function">lookAt</span><span class="token punctuation">(</span>viewPos<span class="token punctuation">,</span> viewPos <span class="token operator">+</span> viewDir<span class="token punctuation">,</span> viewUp<span class="token punctuation">)</span><span class="token punctuation">;</span>

    mShaders<span class="token punctuation">[</span><span class="token string">"FaceIndex"</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Bind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// set Uniforms</span>
    mShaders<span class="token punctuation">[</span><span class="token string">"FaceIndex"</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">SetMat</span><span class="token punctuation">(</span><span class="token string">"projection"</span><span class="token punctuation">,</span> projection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mShaders<span class="token punctuation">[</span><span class="token string">"FaceIndex"</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">SetMat</span><span class="token punctuation">(</span><span class="token string">"model"</span><span class="token punctuation">,</span> model<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mShaders<span class="token punctuation">[</span><span class="token string">"FaceIndex"</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">SetMat</span><span class="token punctuation">(</span><span class="token string">"view"</span><span class="token punctuation">,</span> view<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">glBindFramebuffer</span><span class="token punctuation">(</span>GL_FRAMEBUFFER<span class="token punctuation">,</span> FaceIndexFBO<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">glDrawArrays</span><span class="token punctuation">(</span>GL_TRIANGLES<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> numFaces <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
  <ul><li> <p>顶点索引 Shader 代码</p> <pre><code class="prism language-glsl">//FaceIndex.vert

#version 330 core
layout(location = 0) in vec3 in_position;
layout(location = 1) in vec3 in_normal;
layout(location = 2) in float in_index;

uniform mat4 model;
uniform mat4 view;
uniform mat4 projection;

out vec3 thePosition;
out vec3 theNormal;
flat out float theIndex;	// NOTICE: Index should NOT be interpolated

void main() {
    vec4 v = vec4(in_position,1.0);
    gl_Position = projection * view * model * v;

    thePosition = vec3(model * v);
    theNormal = normalize(vec3(model * vec4(in_normal,0)));
    theIndex = in_index;
}

</code></pre> <pre><code class="prism language-glsl">//FaceIndex.frag

#version 430

out vec4 daColor;

in vec3 thePosition;
in vec3 theNormal;
flat in float theIndex;

void main()
{
    daColor = vec4(theIndex,0,0,0);
}

</code></pre> </li></ul> </li><li> <p>回读鼠标位置的颜色(索引值)</p> <pre><code class="prism language-cpp"> <span class="token keyword">float</span> res<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    GLint viewport<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">glGetIntegerv</span><span class="token punctuation">(</span>GL_VIEWPORT<span class="token punctuation">,</span> viewport<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">glReadPixels</span><span class="token punctuation">(</span><span class="token punctuation">(</span>GLint<span class="token punctuation">)</span>MouseX<span class="token punctuation">,</span> viewport<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> MouseY<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> GL_RED<span class="token punctuation">,</span> GL_FLOAT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token comment">// y is flipped in OpenGL screen coordinate system</span>
	<span class="token comment">// res[0] is the face index picked by mouse</span>
</code></pre> </li><li> <p>绘制冯氏光照模型</p> <pre><code class="prism language-cpp">    mShaders<span class="token punctuation">[</span><span class="token string">"BlinnPhong"</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Bind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mShaders<span class="token punctuation">[</span><span class="token string">"BlinnPhong"</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">SetMat</span><span class="token punctuation">(</span><span class="token string">"projection"</span><span class="token punctuation">,</span> projection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mShaders<span class="token punctuation">[</span><span class="token string">"BlinnPhong"</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">SetMat</span><span class="token punctuation">(</span><span class="token string">"model"</span><span class="token punctuation">,</span> model<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mShaders<span class="token punctuation">[</span><span class="token string">"BlinnPhong"</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">SetMat</span><span class="token punctuation">(</span><span class="token string">"view"</span><span class="token punctuation">,</span> view<span class="token punctuation">)</span><span class="token punctuation">;</span>

    mShaders<span class="token punctuation">[</span><span class="token string">"BlinnPhong"</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">SetVec</span><span class="token punctuation">(</span><span class="token string">"CameraPosition"</span><span class="token punctuation">,</span> glm<span class="token operator">::</span><span class="token function">vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">20.0f</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mShaders<span class="token punctuation">[</span><span class="token string">"BlinnPhong"</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">SetVec</span><span class="token punctuation">(</span><span class="token string">"LightPosition"</span><span class="token punctuation">,</span> glm<span class="token operator">::</span><span class="token function">vec3</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">50.0f</span><span class="token punctuation">,</span> <span class="token number">10.0f</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">20.0f</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glBindFramebuffer</span><span class="token punctuation">(</span>GL_FRAMEBUFFER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// Bind the default framebuffer (render to screen)</span>
    <span class="token function">glClear</span><span class="token punctuation">(</span>GL_COLOR_BUFFER_BIT <span class="token operator">|</span> GL_DEPTH_BUFFER_BIT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glDrawArrays</span><span class="token punctuation">(</span>GL_TRIANGLES<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> numFaces <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
  <ul><li> <p>冯氏光照Shader</p> <pre><code class="prism language-glsl">//BlinnPhong.vert

#version 330 core
layout(location = 0) in vec3 in_position;
layout(location = 1) in vec3 in_normal;
layout(location = 2) in float in_index;

uniform mat4 model;
uniform mat4 view;
uniform mat4 projection;

out vec3 thePosition;
out vec3 theNormal;

void main() {
    vec4 v = vec4(in_position,1.0);
    gl_Position = projection * view * model * v;

    thePosition = vec3(model * v);
    theNormal = normalize(vec3(model * vec4(in_normal,0)));
}

</code></pre> <pre><code class="prism language-glsl">#version 430

out vec4 daColor;

in vec3 thePosition;
in vec3 theNormal;

uniform vec3 CameraPosition;
uniform vec3 LightPosition;

void main()
{
	float finalBrightness = 0.0;

    float ambient = 0.05;
    //diiffuse
    vec3 lightDir = normalize(LightPosition - thePosition);
    float diff = max(dot(lightDir,theNormal),0.0);
        
    //specular
    vec3 viewDir = normalize(CameraPosition - thePosition);
    vec3 reflectDir = reflect(-lightDir,theNormal);
    float spec = 0.0;
    vec3 halfwayDir = normalize(lightDir + viewDir);
    spec = pow(max(dot(theNormal,halfwayDir),0.0),32.0);
	float specular = 0.3 * spec;
    finalBrightness = ambient + diff + specular;
	
	vec3 f = vec3(finalBrightness);
	vec3 test =  min(f,vec3(1.0));
	daColor = vec4(test, 1.0);
}

</code></pre> </li></ul> </li><li> <p>绘制高亮三角形</p> 
  <ul><li> <p>高亮面的编号为 res[0] * numFaces</p> <pre><code class="prism language-cpp">    <span class="token function">DrawCoverVertices</span><span class="token punctuation">(</span>res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> numFaces<span class="token punctuation">,</span> projection<span class="token punctuation">,</span> model<span class="token punctuation">,</span> view<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> </li><li> <p>获取高亮面的三个点坐标</p> <pre><code class="prism language-cpp"><span class="token keyword">void</span> Application<span class="token operator">::</span><span class="token function">DrawCoverVertices</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">,</span> glm<span class="token operator">::</span>mat4<span class="token operator">&amp;</span> projection<span class="token punctuation">,</span> glm<span class="token operator">::</span>mat4<span class="token operator">&amp;</span> model<span class="token punctuation">,</span> glm<span class="token operator">::</span>mat4<span class="token operator">&amp;</span> view<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> index <span class="token operator">&gt;=</span> numFaces<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> a <span class="token operator">=</span> index <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> b <span class="token operator">=</span> index <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> c <span class="token operator">=</span> index <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>
    CoveredVertices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> sortedVertices<span class="token punctuation">[</span>a <span class="token operator">*</span> <span class="token number">7</span> <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    CoveredVertices<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> sortedVertices<span class="token punctuation">[</span>a <span class="token operator">*</span> <span class="token number">7</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    CoveredVertices<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> sortedVertices<span class="token punctuation">[</span>a <span class="token operator">*</span> <span class="token number">7</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    CoveredVertices<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> sortedVertices<span class="token punctuation">[</span>b <span class="token operator">*</span> <span class="token number">7</span> <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    CoveredVertices<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> sortedVertices<span class="token punctuation">[</span>b <span class="token operator">*</span> <span class="token number">7</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    CoveredVertices<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> sortedVertices<span class="token punctuation">[</span>b <span class="token operator">*</span> <span class="token number">7</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    CoveredVertices<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> sortedVertices<span class="token punctuation">[</span>c <span class="token operator">*</span> <span class="token number">7</span> <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    CoveredVertices<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> sortedVertices<span class="token punctuation">[</span>c <span class="token operator">*</span> <span class="token number">7</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    CoveredVertices<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> sortedVertices<span class="token punctuation">[</span>c <span class="token operator">*</span> <span class="token number">7</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> </li><li> <p>绘制高亮面 (关闭depth test 从而与之前的有光照的兔兔叠加)</p> <pre><code class="prism language-cpp">    <span class="token function">glDisable</span><span class="token punctuation">(</span>GL_DEPTH_TEST<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// NOTICE: Disable depth test to cover last result</span>
    <span class="token function">glDisable</span><span class="token punctuation">(</span>GL_CULL_FACE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glBindVertexArray</span><span class="token punctuation">(</span>CoveredVAO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glBufferSubData</span><span class="token punctuation">(</span>GL_ARRAY_BUFFER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">9</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">,</span> CoveredVertices<span class="token punctuation">)</span><span class="token punctuation">;</span>

    mShaders<span class="token punctuation">[</span><span class="token string">"postprocess"</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Bind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mShaders<span class="token punctuation">[</span><span class="token string">"postprocess"</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">SetMat</span><span class="token punctuation">(</span><span class="token string">"projection"</span><span class="token punctuation">,</span> projection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mShaders<span class="token punctuation">[</span><span class="token string">"postprocess"</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">SetMat</span><span class="token punctuation">(</span><span class="token string">"model"</span><span class="token punctuation">,</span> model<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mShaders<span class="token punctuation">[</span><span class="token string">"postprocess"</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">SetMat</span><span class="token punctuation">(</span><span class="token string">"view"</span><span class="token punctuation">,</span> view<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glBindVertexArray</span><span class="token punctuation">(</span>CoveredVAO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glDrawArrays</span><span class="token punctuation">(</span>GL_TRIANGLES<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
    <ul><li> <p>绘制高亮面Shader</p> <pre><code class="prism language-glsl">//postprocess.vert
#version 330 core
layout(location = 0) in vec3 in_position;

uniform mat4 model;
uniform mat4 view;
uniform mat4 projection;

void main() {
    vec4 v = vec4(in_position,1.0);
    gl_Position = projection * view * model * v;
}

</code></pre> <pre><code class="prism language-glsl">//postprocess.frag
#version 430

out vec4 daColor;

void main()
{
    daColor = vec4(1.0,0,0,1.0);
}

</code></pre> </li></ul> </li></ul> </li><li> <p>加一个简单延迟，锁定在三十帧左右（也可以直接用glfw的垂直同步）</p> </li></ul> 
<pre><code class="prism language-cpp">    <span class="token function">DrawCoverVertices</span><span class="token punctuation">(</span>res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> numFaces<span class="token punctuation">,</span> projection<span class="token punctuation">,</span> model<span class="token punctuation">,</span> view<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>附上一个Application与Shader的声明</li></ul> 
<pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token keyword">void</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
	<span class="token keyword">void</span> <span class="token function">InitShader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token function">Render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token function">HandleMouse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token function">DrawCoverVertices</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">,</span> glm<span class="token operator">::</span>mat4<span class="token operator">&amp;</span> projection<span class="token punctuation">,</span> glm<span class="token operator">::</span>mat4<span class="token operator">&amp;</span> model<span class="token punctuation">,</span> glm<span class="token operator">::</span>mat4<span class="token operator">&amp;</span> view<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span><span class="token operator">:</span>
	<span class="token keyword">using</span> ShaderLibrary <span class="token operator">=</span> std<span class="token operator">::</span>unordered_map<span class="token operator">&lt;</span>std<span class="token operator">::</span>string<span class="token punctuation">,</span>Shader<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
	ShaderLibrary mShaders<span class="token punctuation">;</span>

	<span class="token keyword">float</span><span class="token operator">*</span> vertices<span class="token punctuation">;</span>
	<span class="token keyword">float</span><span class="token operator">*</span> sortedVertices<span class="token punctuation">;</span>
	<span class="token keyword">int</span> numFaces<span class="token punctuation">;</span>
	<span class="token keyword">int</span> numVertices<span class="token punctuation">;</span>
	GLuint vao<span class="token punctuation">;</span>

	GLuint FaceIndexTex<span class="token punctuation">;</span>
	GLuint FaceIndexFBO<span class="token punctuation">;</span>

	<span class="token keyword">double</span> MouseX<span class="token punctuation">,</span> MouseY<span class="token punctuation">;</span>
	<span class="token keyword">double</span> LastMouseX<span class="token punctuation">,</span> LastMouseY<span class="token punctuation">;</span>
	GLFWwindow<span class="token operator">*</span> window<span class="token punctuation">;</span>

	<span class="token keyword">float</span> CoveredVertices<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	GLuint CoveredVAO<span class="token punctuation">;</span>
	GLuint CoveredVBO<span class="token punctuation">;</span>

	glm<span class="token operator">::</span>vec3 viewDir <span class="token operator">=</span> glm<span class="token operator">::</span><span class="token function">vec3</span><span class="token punctuation">(</span><span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">20.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	glm<span class="token operator">::</span>vec3 viewPos <span class="token operator">=</span> glm<span class="token operator">::</span><span class="token function">vec3</span><span class="token punctuation">(</span><span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	glm<span class="token operator">::</span>vec3 viewUp <span class="token operator">=</span> glm<span class="token operator">::</span><span class="token function">vec3</span><span class="token punctuation">(</span><span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">float</span> CoverVertices<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">Shader</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token function">Shader</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> shaderName<span class="token punctuation">)</span><span class="token punctuation">;</span>

	GLuint <span class="token function">GetProgramID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> mProgramID<span class="token punctuation">;</span> <span class="token punctuation">}</span>
	<span class="token keyword">void</span> <span class="token function">SetMat</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> <span class="token keyword">const</span> glm<span class="token operator">::</span>mat4<span class="token operator">&amp;</span> mat<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token function">SetMat</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> <span class="token keyword">const</span> glm<span class="token operator">::</span>mat3<span class="token operator">&amp;</span> mat<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token function">SetVec</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> <span class="token keyword">const</span> glm<span class="token operator">::</span>vec3<span class="token operator">&amp;</span> vec<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token function">SetVec</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> <span class="token keyword">const</span> glm<span class="token operator">::</span>vec4<span class="token operator">&amp;</span> vec<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token function">SetInt</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> <span class="token keyword">int</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token function">SetFloat</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> <span class="token keyword">float</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token function">Bind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span><span class="token operator">:</span>
	GLuint mProgramID<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="_672"></a></h5> 
<h5><a id="_674"></a>实现效果</h5> 
<p><img src="https://images2.imgbox.com/1b/d2/fmPKevGT_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/9b/17/cL3q1Rwg_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_679"></a>碎碎念</h5> 
<p>主要难点的地方还是实现拾取，这里用了三个drawcall显然应该是多余的，可优化的地方还很多</p> 
<p>给别人讲图形学是真的非常难，概念冗杂不说，还一环套一环，必须全部搞懂才能实现一个非常简单的东西</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3e695be33c8e199d2c7a43ff22e426d6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">iptv全球直播_IPTV回看属于信网权还是广播权？</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1bad7b1ea4ce22eb5646463254c25fad/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">cad一键卸载工具叫什么_CAD卸载清理工具</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>