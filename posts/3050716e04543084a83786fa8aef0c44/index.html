<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android 系统启动过程纪要（基于Android 10） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android 系统启动过程纪要（基于Android 10）" />
<meta property="og:description" content="前言 看过源码的都知道，Launcher系统启动都会经过这三个进程 init -&gt;zygote -&gt; system_server。今天我们就来讲解一下这三个进程以及Launcher系统启动。
init进程 准备Android虚拟机环境：创建和挂载系统文件目录；初始化属性服务；设置子进程信号处理函数（防止init的子进程出现僵尸进程，在子进程暂停和结束是接受信号并进行处理）； 僵尸进程：父进程使用fork创建子进程，如果子进程终止，但父进程并不知道已经终止。虽然此时子进程已经退出，但是还是保留了他的信息（进程号。退出状态。运行时间等）。这样，系统进程表就会被无端耗用如果耗尽之后，系统可能就无法再创建新的进程。
启动属性服务，并为其分配内存用来存储属性：使用一个键值对（注册表）记录用户\软件的一些使用信息（确保系统或者软件重启之后能根据注册表中的信息进行初始化的工作）解析init.rc配置文件。 解析init.zygote脚本文件，启动zygote进程 总的来说做了三件事：
创建和挂在系统启动所需要的文件目录；初始化和启动属性服务；解析init.rc配置文件并启动zygote进程。 zygote进程 init通过调用app_main.cpp的main函数中的start方法来启动zygote进程。
DVM，ART，应用程序进程以及SystemServer进程都是有zygote创建。通过fork自身（从zygote进程）来创建新的应用进程。因此，zygote进程和它的子进程都会运行main函数。main函数里会通过标记查看main函数是运行在zygote进程还是子进程。如果实在zygote进程里，那么就会调用AppRuntime的start函数。在start函数里，会创建Java虚拟机以及做一些其他的准备工作。最后通过JNI调用ZygoteInit.java里的mian方法，进入Java框架层。
main方法主要做下面几件事情：
创建一个Server端的Socket，用来等待AMS请求创建新的应用进程；预加载类和资源；启动SystemServer进程；等待AMS请求创建新的应用程序进程（通过无限循环while(true)等待AMS的请求）。 SystemServer（zygote第一个启动的进程） SystemServer主要用来创建系统服务，例如AMS，WMS都是有他创建的。Zygote进程通过forkSystemServetr方法复制Zygote进程的地址空间，并关闭SystemServer不需要的Socket进程。然后通过handleSystemServerProcess方法启动进程。
//ZygoteInit.java private static Runnable forkSystemServer(String abiList, String socketName, ZygoteServer zygoteServer) { String[] args = { &#34;--setuid=1000&#34;, &#34;--setgid=1000&#34;, &#34;--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1023,&#34; &#43; &#34;1024,1032,1065,3001,3002,3003,3006,3007,3009,3010,3011,3012&#34;, &#34;--capabilities=&#34; &#43; capabilities &#43; &#34;,&#34; &#43; capabilities, &#34;--nice-name=system_server&#34;, &#34;--runtime-args&#34;, &#34;--target-sdk-version=&#34; &#43; VMRuntime.SDK_VERSION_CUR_DEVELOPMENT, &#34;com.android.server.SystemServer&#34;, }; ZygoteArguments parsedArgs; try { ZygoteCommandBuffer commandBuffer = new ZygoteCommandBuffer(args); try { parsedArgs = ZygoteArguments.getInstance(commandBuffer); } catch (EOFException e) { throw new AssertionError(&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/3050716e04543084a83786fa8aef0c44/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-16T09:34:42+08:00" />
<meta property="article:modified_time" content="2024-01-16T09:34:42+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android 系统启动过程纪要（基于Android 10）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a><strong>前言</strong></h3> 
<p>看过源码的都知道，Launcher系统启动都会经过这三个进程 init -&gt;zygote -&gt; system_server。今天我们就来讲解一下这三个进程以及Launcher系统启动。</p> 
<h3><a id="init_3"></a><strong>init进程</strong></h3> 
<ol><li>准备Android虚拟机环境：创建和挂载系统文件目录；</li><li>初始化属性服务；</li><li>设置子进程信号处理函数（防止init的子进程出现僵尸进程，在子进程暂停和结束是接受信号并进行处理）；</li></ol> 
<blockquote> 
 <p>僵尸进程：父进程使用fork创建子进程，如果子进程终止，但父进程并不知道已经终止。虽然此时子进程已经退出，但是还是保留了他的信息（进程号。退出状态。运行时间等）。这样，系统进程表就会被无端耗用如果耗尽之后，系统可能就无法再创建新的进程。</p> 
</blockquote> 
<ol start="4"><li>启动属性服务，并为其分配内存用来存储属性：使用一个键值对（注册表）记录用户\软件的一些使用信息（确保系统或者软件重启之后能根据注册表中的信息进行初始化的工作）</li><li>解析init.rc配置文件。 解析init.zygote脚本文件，启动zygote进程</li></ol> 
<p>总的来说做了三件事：</p> 
<ol><li>创建和挂在系统启动所需要的文件目录；</li><li>初始化和启动属性服务；</li><li>解析init.rc配置文件并启动zygote进程。</li></ol> 
<h3><a id="zygote_21"></a><strong>zygote进程</strong></h3> 
<p>init通过调用app_main.cpp的main函数中的start方法来启动zygote进程。<br> <img src="https://images2.imgbox.com/4a/2e/Fc0Fc6VE_o.png" alt="在这里插入图片描述"><br> DVM，ART，应用程序进程以及SystemServer进程都是有zygote创建。通过fork自身（从zygote进程）来创建新的应用进程。因此，zygote进程和它的子进程都会运行main函数。main函数里会通过标记查看main函数是运行在zygote进程还是子进程。如果实在zygote进程里，那么就会调用AppRuntime的start函数。在start函数里，会创建Java虚拟机以及做一些其他的准备工作。最后通过JNI调用ZygoteInit.java里的mian方法，进入Java框架层。</p> 
<p>main方法主要做下面几件事情：</p> 
<ol><li>创建一个Server端的Socket，用来等待AMS请求创建新的应用进程；</li><li>预加载类和资源；</li><li>启动SystemServer进程；</li><li>等待AMS请求创建新的应用程序进程（通过无限循环while(true)等待AMS的请求）。</li></ol> 
<h3><a id="SystemServerzygote_34"></a><strong>SystemServer（zygote第一个启动的进程）</strong></h3> 
<p>SystemServer主要用来创建系统服务，例如AMS，WMS都是有他创建的。Zygote进程通过forkSystemServetr方法复制Zygote进程的地址空间，并关闭SystemServer不需要的Socket进程。然后通过handleSystemServerProcess方法启动进程。</p> 
<pre><code class="prism language-java"><span class="token comment">//ZygoteInit.java</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Runnable</span> <span class="token function">forkSystemServer</span><span class="token punctuation">(</span><span class="token class-name">String</span> abiList<span class="token punctuation">,</span> <span class="token class-name">String</span> socketName<span class="token punctuation">,</span>
            <span class="token class-name">ZygoteServer</span> zygoteServer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            
 		<span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"--setuid=1000"</span><span class="token punctuation">,</span>
                <span class="token string">"--setgid=1000"</span><span class="token punctuation">,</span>
                <span class="token string">"--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1023,"</span>
                        <span class="token operator">+</span> <span class="token string">"1024,1032,1065,3001,3002,3003,3006,3007,3009,3010,3011,3012"</span><span class="token punctuation">,</span>
                <span class="token string">"--capabilities="</span> <span class="token operator">+</span> capabilities <span class="token operator">+</span> <span class="token string">","</span> <span class="token operator">+</span> capabilities<span class="token punctuation">,</span>
                <span class="token string">"--nice-name=system_server"</span><span class="token punctuation">,</span>
                <span class="token string">"--runtime-args"</span><span class="token punctuation">,</span>
                <span class="token string">"--target-sdk-version="</span> <span class="token operator">+</span> <span class="token class-name">VMRuntime</span><span class="token punctuation">.</span><span class="token constant">SDK_VERSION_CUR_DEVELOPMENT</span><span class="token punctuation">,</span>
                <span class="token string">"com.android.server.SystemServer"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        
        <span class="token class-name">ZygoteArguments</span> parsedArgs<span class="token punctuation">;</span>
 		<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">ZygoteCommandBuffer</span> commandBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZygoteCommandBuffer</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                parsedArgs <span class="token operator">=</span> <span class="token class-name">ZygoteArguments</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>commandBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">EOFException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AssertionError</span><span class="token punctuation">(</span><span class="token string">"Unexpected argument error for forking system server"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
     		<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalArgumentException</span>  e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              
            <span class="token punctuation">}</span>       

        <span class="token keyword">int</span> pid<span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//...</span>
            <span class="token comment">/* Request to fork the system server process */</span>
            pid <span class="token operator">=</span> <span class="token class-name">Zygote</span><span class="token punctuation">.</span><span class="token function">forkSystemServer</span><span class="token punctuation">(</span>
                    parsedArgs<span class="token punctuation">.</span>mUid<span class="token punctuation">,</span> parsedArgs<span class="token punctuation">.</span>mGid<span class="token punctuation">,</span>
                    parsedArgs<span class="token punctuation">.</span>mGids<span class="token punctuation">,</span>
                    parsedArgs<span class="token punctuation">.</span>mRuntimeFlags<span class="token punctuation">,</span>
                    <span class="token keyword">null</span><span class="token punctuation">,</span>
                    parsedArgs<span class="token punctuation">.</span>mPermittedCapabilities<span class="token punctuation">,</span>
                    parsedArgs<span class="token punctuation">.</span>mEffectiveCapabilities<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalArgumentException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

       
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasSecondZygote</span><span class="token punctuation">(</span>abiList<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">waitForSecondaryZygote</span><span class="token punctuation">(</span>socketName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//关闭Zygote进程创建的Socket</span>
            zygoteServer<span class="token punctuation">.</span><span class="token function">closeServerSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">handleSystemServerProcess</span><span class="token punctuation">(</span>parsedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre> 
<p>在handleSystemServerProcess方法中，会启动Binder线程池，这样SystemServer就可以使用Binder和其他应用进程进程通讯。</p> 
<pre><code class="prism language-java"><span class="token comment">//ZygoteInit.java</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Runnable</span> <span class="token function">handleSystemServerProcess</span><span class="token punctuation">(</span><span class="token class-name">ZygoteArguments</span> parsedArgs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
     <span class="token comment">///</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parsedArgs<span class="token punctuation">.</span>mInvokeWith <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">ZygoteInit</span><span class="token punctuation">.</span><span class="token function">zygoteInit</span><span class="token punctuation">(</span>parsedArgs<span class="token punctuation">.</span>mTargetSdkVersion<span class="token punctuation">,</span>
                    parsedArgs<span class="token punctuation">.</span>mDisabledCompatChanges<span class="token punctuation">,</span>
                    parsedArgs<span class="token punctuation">.</span>mRemainingArgs<span class="token punctuation">,</span> cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

</code></pre> 
<pre><code class="prism language-java"><span class="token comment">//ZygoteInit.java</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Runnable</span> <span class="token function">handleSystemServerProcess</span><span class="token punctuation">(</span><span class="token class-name">ZygoteArguments</span> parsedArgs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
     <span class="token comment">///</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parsedArgs<span class="token punctuation">.</span>mInvokeWith <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">ZygoteInit</span><span class="token punctuation">.</span><span class="token function">zygoteInit</span><span class="token punctuation">(</span>parsedArgs<span class="token punctuation">.</span>mTargetSdkVersion<span class="token punctuation">,</span>
                    parsedArgs<span class="token punctuation">.</span>mDisabledCompatChanges<span class="token punctuation">,</span>
                    parsedArgs<span class="token punctuation">.</span>mRemainingArgs<span class="token punctuation">,</span> cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

</code></pre> 
<p>启动Binder线程池之后，会调用RuntimeInit.applicationInit：</p> 
<pre><code class="prism language-java"><span class="token comment">//RuntimeInit.java</span>
  <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token class-name">Runnable</span> <span class="token function">applicationInit</span><span class="token punctuation">(</span><span class="token keyword">int</span> targetSdkVersion<span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> disabledCompatChanges<span class="token punctuation">,</span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       
        <span class="token comment">//</span>
        <span class="token keyword">final</span> <span class="token class-name">Arguments</span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Arguments</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">findStaticMain</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>startClass<span class="token punctuation">,</span> args<span class="token punctuation">.</span>startArgs<span class="token punctuation">,</span> classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre> 
<p>然后调用findStaticMain 方法：</p> 
<pre><code class="prism language-java">	<span class="token comment">RuntimeInit.java</span>
      <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token class-name">Runnable</span> <span class="token function">findStaticMain</span><span class="token punctuation">(</span><span class="token class-name">String</span> className<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">,</span>
            <span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> cl<span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//使用反射创建SystemServer。</span>
            cl <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                    <span class="token string">"Missing class when invoking static main "</span> <span class="token operator">+</span> className<span class="token punctuation">,</span>
                    ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Method</span> m<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//找到ServerServer的main方法</span>
            m <span class="token operator">=</span> cl<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"main"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                    <span class="token string">"Missing static main on "</span> <span class="token operator">+</span> className<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SecurityException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                    <span class="token string">"Problem getting static main on "</span> <span class="token operator">+</span> className<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">int</span> modifiers <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token punctuation">(</span><span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">isStatic</span><span class="token punctuation">(</span>modifiers<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">isPublic</span><span class="token punctuation">(</span>modifiers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                    <span class="token string">"Main method is not public and static on "</span> <span class="token operator">+</span> className<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

  	 <span class="token comment">//通过MethodAndArgsCaller调用SystemServer的main方法</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MethodAndArgsCaller</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>可以看到，这里使用反射的方式创建了Systemserver，其中的className实在ZygoteInit.java类中forkSystemServer 方法的变量arg中初始化的。然后通过MethodAndArgsCaller来调用Systemserver的main方法，主要是为了能让ZygoteInit.mian能捕获异常（因为SystemServer的main方法在调用之前SystemServer进程已经做了很多准备工作，而如果慧姐抛出异常，则会清理掉所有的堆栈信帧，使得SystemServer的main看起来就不是SystemServer的入口方法了），MethodAndArgsCaller代码也很简单：</p> 
<pre><code class="prism language-java"><span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MethodAndArgsCaller</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/** method to call */</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Method</span> mMethod<span class="token punctuation">;</span>

        <span class="token comment">/** argument array */</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> mArgs<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">MethodAndArgsCaller</span><span class="token punctuation">(</span><span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mMethod <span class="token operator">=</span> method<span class="token punctuation">;</span>
            mArgs <span class="token operator">=</span> args<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                mMethod<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span> mArgs <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvocationTargetException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Throwable</span> cause <span class="token operator">=</span> ex<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cause <span class="token keyword">instanceof</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span><span class="token punctuation">)</span> cause<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cause <span class="token keyword">instanceof</span> <span class="token class-name">Error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token class-name">Error</span><span class="token punctuation">)</span> cause<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

</code></pre> 
<p>而在ZygoteInit的main方法中，有该异常的捕获的try语句。</p> 
<p>在SystemServer中，main方法的关键操作如下：</p> 
<pre><code class="prism language-java">
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">new</span> <span class="token class-name">SystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">prepareMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSlowLogThresholdMs</span><span class="token punctuation">(</span>
                    <span class="token constant">SLOW_DISPATCH_THRESHOLD_MS</span><span class="token punctuation">,</span> <span class="token constant">SLOW_DELIVERY_THRESHOLD_MS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">"android_servers"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       
            <span class="token function">createSystemContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        
        <span class="token punctuation">}</span>
        <span class="token comment">//</span>
        <span class="token comment">// Start services.</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            t<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token string">"StartServices"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">startBootstrapServices</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//启动引导服务</span>
            <span class="token function">startCoreServices</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//启动核心服务</span>
            <span class="token function">startOtherServices</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//启动其他服务</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            t<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// StartServices</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>SystemServer会创建消息Looper，加载库文件，并创建系统的Context。然后创建和启动各种系统服务：</p> 
<ol><li>引导服务：Installer、AMS、PMS等</li><li>核心服务：DropBoxManagerService、BatteryService等</li><li>其他服务：CameraService、WMS等</li></ol> 
<p>以PowerStatsService为例，通过SystemServiceManager的startService方法启动：mSystemServiceManager.startService(PowerStatsService.class);</p> 
<p><strong>SystemServiceManager:Manages creating, starting, and other lifecycle events of SystemService system services</strong></p> 
<pre><code class="prism language-java">   <span class="token comment">//SystemServiceManager.java</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SystemService</span><span class="token punctuation">&gt;</span></span> mServices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SystemService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   
   <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">SystemService</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">startService</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> serviceClass<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token class-name">String</span> name <span class="token operator">=</span> serviceClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token class-name">T</span> service<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> constructor <span class="token operator">=</span> serviceClass<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                service <span class="token operator">=</span> constructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>mContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvocationTargetException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Failed to create service "</span> <span class="token operator">+</span> name
                        <span class="token operator">+</span> <span class="token string">": service constructor threw an exception"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token function">startService</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> service<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_SYSTEM_SERVER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startService</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token keyword">final</span> <span class="token class-name">SystemService</span> service<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Register it.</span>
        mServices<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Start it.</span>
        <span class="token keyword">long</span> time <span class="token operator">=</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">elapsedRealtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            service<span class="token punctuation">.</span><span class="token function">onStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Failed to start service "</span> <span class="token operator">+</span> service<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">+</span> <span class="token string">": onStart threw an exception"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">warnIfTooLong</span><span class="token punctuation">(</span><span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">elapsedRealtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> time<span class="token punctuation">,</span> service<span class="token punctuation">,</span> <span class="token string">"onStart"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre> 
<p>通过创建service，然后将service添加到一个ArrayList中，这样就完成了注册工作。最后调用service的start方法启动。</p> 
<p>SystemServer进程被创建后做了一下工作：</p> 
<ol><li>启动Binder线程池，用于和其他进程通讯；</li><li>创建SystemServerManager，用于系统服务的创建、启动和管理；</li><li>使用SystemServerManager启动各种服务。</li></ol> 
<p>负责拉起AMS等80多个服务</p> 
<pre><code class="prism language-java">     <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">traceBeginAndSlog</span><span class="token punctuation">(</span><span class="token string">"StartServices"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">startBootstrapServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">startCoreServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">startOtherServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">SystemServerInitThreadPool</span><span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"System"</span><span class="token punctuation">,</span> <span class="token string">"******************************************"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"System"</span><span class="token punctuation">,</span> <span class="token string">"************ Failure starting system services"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

</code></pre> 
<p><img src="https://images2.imgbox.com/97/57/x85eqK1R_o.jpg" alt="在这里插入图片描述"></p> 
<p>finishBooting负责发送系统启动完成广播</p> 
<p>为什么应用启动时要从zygote进程中fork： 若从init fork需要准备虚拟机，预加载类文件；若从system_server App进程不需要大量的服务（AMS WMS PMS等80多种服务）</p> 
<h3><a id="Launcher_332"></a><strong>Launcher启动</strong></h3> 
<p>系统启动的最后一步是启动一个用来显示系统中已安装应用的应用程序——Launcher。通俗的讲，它就是Android的系统桌面，主要有以下两个特点：</p> 
<ol><li>作为Android系统的启动器，用于启动应用程序；</li><li>作为Android系统的桌面，用于显示和管理应用程序的快捷图标或者其他桌面组件。</li></ol> 
<p>在SystemServer启动过程中，由它启动的Ams（ActivityManagerService.）会将Launcher启动。Launcher的启动入口在SystemServer的startOtherServices方法中：</p> 
<pre><code class="prism language-java"><span class="token comment">//SystemServer.java</span>
<span class="token comment">// We now tell the activity manager it is okay to run third party</span>
<span class="token comment">// code.  It will call back into us once it has gotten to the state</span>
<span class="token comment">// where third party code can really run (but before it has actually</span>
<span class="token comment">// started launching the initial applications), for us to complete our</span>
<span class="token comment">// initialization.</span>
 mActivityManagerService<span class="token punctuation">.</span><span class="token function">systemReady</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
      mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startBootPhase</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token class-name">SystemService</span><span class="token punctuation">.</span><span class="token constant">PHASE_ACTIVITY_MANAGER_READY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>根据官方注释，我们可以看出，在这里系统服务已经就绪，到这里系统就算启动完成，可以跑第三方的代码了。此时，会调用AMS的systemReady方法，让AMS去启动Launcher。下面是ActivityManagerService.java中systemReady方法启动Launcher的关键代码：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">ActivityTaskManagerInternal</span> mAtmInternal<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">systemReady</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Runnable</span> goingCallback<span class="token punctuation">,</span> <span class="token class-name">TimingsTraceLog</span> traceLog<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	 <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	 	mAtmInternal<span class="token punctuation">.</span><span class="token function">startHomeOnAllDisplays</span><span class="token punctuation">(</span>currentUserId<span class="token punctuation">,</span> <span class="token string">"systemReady"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>	
</code></pre> 
<p>其中，mAtmInternal 的具体实现是：ActivityTaskManagerService.LocalService。是在ActivityTaskManagerService里的一个内部类。ActivityTaskManagerService.LocalService.startHomeOnAllDisplays代码如下：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">startHomeOnAllDisplays</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> reason<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mGlobalLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> mRootActivityContainer<span class="token punctuation">.</span><span class="token function">startHomeOnAllDisplays</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>RootActivityContainer.startHomeOnAllDisplays的代码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">boolean</span> <span class="token function">startHomeOnAllDisplays</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> reason<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	 <span class="token keyword">boolean</span> homeStarted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	 <span class="token comment">// 由于Android系统支持多用户和多显示，调用startHomeOnAllDisplays启动每个display上的Home Activity</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> mActivityDisplays<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> displayId <span class="token operator">=</span> mActivityDisplays<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>mDisplayId<span class="token punctuation">;</span>
            homeStarted <span class="token operator">|=</span> <span class="token function">startHomeOnDisplay</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> reason<span class="token punctuation">,</span> displayId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> homeStarted<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>继续追踪startHomeOnDisplay方法：</p> 
<pre><code class="prism language-java">

<span class="token keyword">boolean</span> <span class="token function">startHomeOnDisplay</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> reason<span class="token punctuation">,</span> <span class="token keyword">int</span> displayId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">startHomeOnDisplay</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> reason<span class="token punctuation">,</span> displayId<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* allowInstrumenting */</span><span class="token punctuation">,</span>
        <span class="token boolean">false</span> <span class="token comment">/* fromHomeKey */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

    
<span class="token keyword">boolean</span> <span class="token function">startHomeOnDisplay</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> reason<span class="token punctuation">,</span> <span class="token keyword">int</span> displayId<span class="token punctuation">,</span> <span class="token keyword">boolean</span> allowInstrumenting<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> fromHomeKey<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>displayId <span class="token operator">==</span> <span class="token constant">INVALID_DISPLAY</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            displayId <span class="token operator">=</span> <span class="token function">getTopDisplayFocusedStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mDisplayId<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Intent</span> homeIntent <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">ActivityInfo</span> aInfo <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>displayId <span class="token operator">==</span> <span class="token constant">DEFAULT_DISPLAY</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">//第一步：获取Intent</span>
        	<span class="token comment">//这里的mService就是ActivityTaskManagerService</span>
            homeIntent <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">getHomeIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            aInfo <span class="token operator">=</span> <span class="token function">resolveHomeActivity</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> homeIntent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldPlaceSecondaryHomeOnDisplay</span><span class="token punctuation">(</span>displayId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Pair</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ActivityInfo</span><span class="token punctuation">,</span> <span class="token class-name">Intent</span><span class="token punctuation">&gt;</span></span> info <span class="token operator">=</span> <span class="token function">resolveSecondaryHomeActivity</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> displayId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            aInfo <span class="token operator">=</span> info<span class="token punctuation">.</span>first<span class="token punctuation">;</span>
            homeIntent <span class="token operator">=</span> info<span class="token punctuation">.</span>second<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>aInfo <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> homeIntent <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">canStartHomeOnDisplay</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">,</span> displayId<span class="token punctuation">,</span> allowInstrumenting<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        homeIntent<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> aInfo<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        homeIntent<span class="token punctuation">.</span><span class="token function">setFlags</span><span class="token punctuation">(</span>homeIntent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token constant">FLAG_ACTIVITY_NEW_TASK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fromHomeKey<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            homeIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span><span class="token class-name">WindowManagerPolicy</span><span class="token punctuation">.</span><span class="token constant">EXTRA_FROM_HOME_KEY</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">final</span> <span class="token class-name">String</span> myReason <span class="token operator">=</span> reason <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> userId <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> <span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span>
                aInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> displayId<span class="token punctuation">;</span>
         <span class="token comment">//  第二步：启动    </span>
        mService<span class="token punctuation">.</span><span class="token function">getActivityStartController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startHomeActivity</span><span class="token punctuation">(</span>homeIntent<span class="token punctuation">,</span> aInfo<span class="token punctuation">,</span> myReason<span class="token punctuation">,</span>
                displayId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>其中，第一步获取Intent的getHomeIntent方法在ActivityTaskManagerService中，代码如下：就是给Intent添加了Intent.CATEGORY_HOME属性</p> 
<pre><code class="prism language-java"><span class="token class-name">String</span> mTopAction <span class="token operator">=</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">ACTION_MAIN</span><span class="token punctuation">;</span>

<span class="token class-name">Intent</span> <span class="token function">getHomeIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Intent</span> intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>mTopAction<span class="token punctuation">,</span> mTopData <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token class-name">Uri</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>mTopData<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        intent<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span>mTopComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        intent<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">FLAG_DEBUG_TRIAGED_MISSING</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mFactoryTest <span class="token operator">!=</span> <span class="token class-name">FactoryTest</span><span class="token punctuation">.</span><span class="token constant">FACTORY_TEST_LOW_LEVEL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">//返回一个Category为Intent.CATEGORY_HOME的Intent</span>
            intent<span class="token punctuation">.</span><span class="token function">addCategory</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">CATEGORY_HOME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> intent<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre> 
<p>接下来第二步，startHomeActivity方法在ActivityStartController中，关键代码入下：</p> 
<pre><code class="prism language-java"><span class="token keyword">void</span> <span class="token function">startHomeActivity</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">ActivityInfo</span> aInfo<span class="token punctuation">,</span> <span class="token class-name">String</span> reason<span class="token punctuation">,</span> <span class="token keyword">int</span> displayId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token class-name">ActivityOptions</span> options <span class="token operator">=</span> <span class="token class-name">ActivityOptions</span><span class="token punctuation">.</span><span class="token function">makeBasic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        options<span class="token punctuation">.</span><span class="token function">setLaunchWindowingMode</span><span class="token punctuation">(</span><span class="token constant">WINDOWING_MODE_FULLSCREEN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">ActivityRecord</span><span class="token punctuation">.</span><span class="token function">isResolverActivity</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
            options<span class="token punctuation">.</span><span class="token function">setLaunchActivityType</span><span class="token punctuation">(</span><span class="token constant">ACTIVITY_TYPE_HOME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        options<span class="token punctuation">.</span><span class="token function">setLaunchDisplayId</span><span class="token punctuation">(</span>displayId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mLastHomeActivityStartResult <span class="token operator">=</span> <span class="token function">obtainStarter</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> <span class="token string">"startHomeActivity: "</span> <span class="token operator">+</span> reason<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setOutActivity</span><span class="token punctuation">(</span>tmpOutRecord<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setCallingUid</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setActivityInfo</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setActivityOptions</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span><span class="token function">toBundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//启动</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>其中，最后的execute最终是执行的ActivityStarter的execute代码：</p> 
<pre><code class="prism language-java"> <span class="token comment">/**
     * Starts an activity based on the request parameters provided earlier.
     * @return The starter result.
     */</span>
    <span class="token keyword">int</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// TODO(b/64750076): Look into passing request directly to these methods to allow</span>
            <span class="token comment">// for transactional diffs and preprocessing.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mRequest<span class="token punctuation">.</span>mayWait<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token function">startActivityMayWait</span><span class="token punctuation">(</span>mRequest<span class="token punctuation">.</span>caller<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>callingUid<span class="token punctuation">,</span>
                        mRequest<span class="token punctuation">.</span>callingPackage<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>realCallingPid<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>realCallingUid<span class="token punctuation">,</span>
                        mRequest<span class="token punctuation">.</span>intent<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>resolvedType<span class="token punctuation">,</span>
                        mRequest<span class="token punctuation">.</span>voiceSession<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>voiceInteractor<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>resultTo<span class="token punctuation">,</span>
                        mRequest<span class="token punctuation">.</span>resultWho<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>requestCode<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>startFlags<span class="token punctuation">,</span>
                        mRequest<span class="token punctuation">.</span>profilerInfo<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>waitResult<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>globalConfig<span class="token punctuation">,</span>
                        mRequest<span class="token punctuation">.</span>activityOptions<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>ignoreTargetSecurity<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>userId<span class="token punctuation">,</span>
                        mRequest<span class="token punctuation">.</span>inTask<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>reason<span class="token punctuation">,</span>
                        mRequest<span class="token punctuation">.</span>allowPendingRemoteAnimationRegistryLookup<span class="token punctuation">,</span>
                        mRequest<span class="token punctuation">.</span>originatingPendingIntent<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>allowBackgroundActivityStart<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token function">startActivity</span><span class="token punctuation">(</span>mRequest<span class="token punctuation">.</span>caller<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>intent<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>ephemeralIntent<span class="token punctuation">,</span>
                        mRequest<span class="token punctuation">.</span>resolvedType<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>activityInfo<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>resolveInfo<span class="token punctuation">,</span>
                        mRequest<span class="token punctuation">.</span>voiceSession<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>voiceInteractor<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>resultTo<span class="token punctuation">,</span>
                        mRequest<span class="token punctuation">.</span>resultWho<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>requestCode<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>callingPid<span class="token punctuation">,</span>
                        mRequest<span class="token punctuation">.</span>callingUid<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>callingPackage<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>realCallingPid<span class="token punctuation">,</span>
                        mRequest<span class="token punctuation">.</span>realCallingUid<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>startFlags<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>activityOptions<span class="token punctuation">,</span>
                        mRequest<span class="token punctuation">.</span>ignoreTargetSecurity<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>componentSpecified<span class="token punctuation">,</span>
                        mRequest<span class="token punctuation">.</span>outActivity<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>inTask<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>reason<span class="token punctuation">,</span>
                        mRequest<span class="token punctuation">.</span>allowPendingRemoteAnimationRegistryLookup<span class="token punctuation">,</span>
                        mRequest<span class="token punctuation">.</span>originatingPendingIntent<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>allowBackgroundActivityStart<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">onExecutionComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>其中，startActivity有三个的重载方法，经过不断的调用，最后会调用：startActivity(final ActivityRecord r, ActivityRecord sourceRecord, IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor, int startFlags, boolean doResume, ActivityOptions options, TaskRecord inTask, ActivityRecord[] outActivity, boolean restrictedBgActivity) 方法：</p> 
<pre><code class="prism language-java"> <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">startActivity</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ActivityRecord</span> r<span class="token punctuation">,</span> <span class="token class-name">ActivityRecord</span> sourceRecord<span class="token punctuation">,</span>
                <span class="token class-name">IVoiceInteractionSession</span> voiceSession<span class="token punctuation">,</span> <span class="token class-name">IVoiceInteractor</span> voiceInteractor<span class="token punctuation">,</span>
                <span class="token keyword">int</span> startFlags<span class="token punctuation">,</span> <span class="token keyword">boolean</span> doResume<span class="token punctuation">,</span> <span class="token class-name">ActivityOptions</span> options<span class="token punctuation">,</span> <span class="token class-name">TaskRecord</span> inTask<span class="token punctuation">,</span>
                <span class="token class-name">ActivityRecord</span><span class="token punctuation">[</span><span class="token punctuation">]</span> outActivity<span class="token punctuation">,</span> <span class="token keyword">boolean</span> restrictedBgActivity<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
     <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
         mService<span class="token punctuation">.</span>mWindowManager<span class="token punctuation">.</span><span class="token function">deferSurfaceLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result <span class="token operator">=</span> <span class="token function">startActivityUnchecked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> sourceRecord<span class="token punctuation">,</span> voiceSession<span class="token punctuation">,</span> voiceInteractor<span class="token punctuation">,</span>
                    startFlags<span class="token punctuation">,</span> doResume<span class="token punctuation">,</span> options<span class="token punctuation">,</span> inTask<span class="token punctuation">,</span> outActivity<span class="token punctuation">,</span> restrictedBgActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span> 
 <span class="token punctuation">}</span>
</code></pre> 
<p>大致的流程图如下：<br> <img src="https://images2.imgbox.com/8c/70/w6Ql71OL_o.png" alt="在这里插入图片描述"></p> 
<p>接下来就是Launcher进程和Activity的创建了，这个过程和普通的应用启动就没什么区别了，详情查看<a href="https://blog.csdn.net/ljx1400052550/article/details/134957534">Android Activity的创建流程</a>。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8c6eca8595e8ec551da980790b0cba5b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">ROS操作系统</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d1e2c42faf2592a83b14ba9596377c28/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Java和人工智能哪个好？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>